# é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ - åç«¯å®Œå–„å»ºè®®æ¸…å•

> **åŸºäºæ·±åº¦ä»£ç åˆ†æçš„å…¨é¢å®Œå–„æ–¹æ¡ˆ**

## ğŸš¨ ä¸€ã€ç´§æ€¥ä¿®å¤ï¼ˆ1-3å¤©ï¼‰

### 1.1 æ¢å¤ç¼ºå¤±åŠŸèƒ½
- [ ] **åˆ›å»ºæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬** `scripts/init-db.js`
- [ ] **åˆ›å»ºæ•°æ®åº“æµ‹è¯•è„šæœ¬** `scripts/test-db.js`  
- [ ] **åˆ›å»ºAPIæµ‹è¯•è„šæœ¬** `scripts/test-apis.js`
- [ ] **å¯ç”¨æ‹ç…§ä¸Šä¼ è·¯ç”±** å–æ¶ˆ `app.js` ä¸­çš„æ³¨é‡Š
- [ ] **å¯ç”¨å•†å®¶ç®¡ç†è·¯ç”±** å–æ¶ˆ `app.js` ä¸­çš„æ³¨é‡Š

### 1.2 å®‰å…¨é£é™©ä¿®å¤
- [ ] **å¼ºåˆ¶ç”Ÿäº§ç¯å¢ƒJWTå¯†é’¥æ£€æŸ¥**
- [ ] **åŠ å¼ºè¾“å…¥éªŒè¯**ï¼ˆä½¿ç”¨joiæˆ–express-validatorï¼‰
- [ ] **SQLæ³¨å…¥é˜²æŠ¤æ£€æŸ¥**
- [ ] **æ•æ„Ÿæ•°æ®æ—¥å¿—è¿‡æ»¤**

### 1.3 Sealoså¯¹è±¡å­˜å‚¨é…ç½® âœ… å·²å®Œæˆ
- [x] **é…ç½®çœŸå®Sealoså‚æ•°** å·²ä½¿ç”¨ç”¨æˆ·æä¾›çš„é…ç½®
  - æ¡¶åï¼štiangong
  - Access Keyï¼šbr0za7uc
  - Secret Keyï¼šskxg8mk5gqfhf9xz
  - å†…ç½‘ç«¯ç‚¹ï¼šobject-storage.objectstorage-system.svc.cluster.local
  - å¤–ç½‘ç«¯ç‚¹ï¼šobjectstorageapi.bja.sealos.run
- [x] **åˆ›å»ºSealoså­˜å‚¨æœåŠ¡** `services/sealosStorage.js`
- [x] **åˆ›å»ºå­˜å‚¨è¿æ¥æµ‹è¯•** `test-sealos.js`
- [x] **æ›´æ–°ç¯å¢ƒå˜é‡é…ç½®** `config.example`
- [x] **æ·»åŠ AWS SDKä¾èµ–** `package.json`

---

## âš¡ äºŒã€é«˜ä¼˜å…ˆçº§å®Œå–„ï¼ˆ1-2å‘¨ï¼‰

### 2.1 æ ¸å¿ƒåŠŸèƒ½å®ç°

#### ğŸ“¸ æ‹ç…§ä¸Šä¼ ç³»ç»Ÿå®Œæ•´å®ç° ğŸ”„ è¿›è¡Œä¸­
```javascript
// ğŸ“ åˆ›å»º routes/photo.js
// ğŸ”´ å®ç°åŠŸèƒ½ï¼š
// âœ… å›¾ç‰‡ä¸Šä¼ åˆ°Sealoså¯¹è±¡å­˜å‚¨ï¼ˆå·²å®Œæˆé…ç½®ï¼‰
// âœ… OCRè¯†åˆ«é›†æˆï¼ˆç™¾åº¦/è…¾è®¯/é˜¿é‡Œäº‘ï¼‰
// âœ… è‡ªåŠ¨ç§¯åˆ†è®¡ç®—å’Œå¥–åŠ±
// âœ… å®¡æ ¸å·¥ä½œæµ
// âœ… WebSocketå®¡æ ¸ç»“æœæ¨é€
```

#### ğŸ‘¨â€ğŸ’¼ å•†å®¶ç®¡ç†ç³»ç»Ÿå®Œæ•´å®ç°  
```javascript
// ğŸ“ åˆ›å»º routes/merchant.js
// ğŸ”´ å®ç°åŠŸèƒ½ï¼š
// âœ… å•†å®¶æƒé™ç”³è¯·API
// âœ… æ‹ç…§å®¡æ ¸ç®¡ç†API
// âœ… æ‰¹é‡å®¡æ ¸åŠŸèƒ½
// âœ… å®¡æ ¸ç»Ÿè®¡æ•°æ®API
// âœ… å•†å®¶æƒé™éªŒè¯ä¸­é—´ä»¶
```

#### ğŸ—„ï¸ æ•°æ®åº“ä¼˜åŒ–
```sql
-- ğŸ”´ éœ€è¦ä¼˜åŒ–ï¼š
-- âœ… åˆ›å»ºç¼ºå¤±çš„è¾…åŠ©è¡¨ï¼ˆmerchant_applicationsç­‰ï¼‰
-- âœ… æ·»åŠ å¤åˆç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
-- âœ… åˆ›å»ºç»Ÿè®¡è§†å›¾åŠ é€ŸæŠ¥è¡¨æŸ¥è¯¢
-- âœ… å®ç°å­˜å‚¨è¿‡ç¨‹ä¿è¯äº‹åŠ¡åŸå­æ€§
-- âœ… è®¾ç½®æ•°æ®æ¸…ç†ç­–ç•¥
```

### 2.2 æ¶æ„å®Œå–„

#### ç»Ÿä¸€é”™è¯¯å¤„ç†
```javascript
// ğŸ“ middleware/errorHandler.js
const errorHandler = (err, req, res, next) => {
  const errorCode = err.code || 1000;
  const errorMessage = err.message || 'ç³»ç»Ÿå¼‚å¸¸';
  
  // è®°å½•é”™è¯¯æ—¥å¿—
  logger.error('API Error:', {
    error: err.message,
    stack: err.stack,
    url: req.url,
    method: req.method,
    userAgent: req.headers['user-agent'],
    userId: req.user?.user_id
  });
  
  res.json({
    code: errorCode,
    msg: errorMessage,
    data: null
  });
};
```

#### ä¸šåŠ¡é€»è¾‘åˆ†ç¦»
```javascript
// ğŸ“ services/lotteryService.js
class LotteryService {
  // æŠ½å¥–ç®—æ³•æ ¸å¿ƒé€»è¾‘
  static async performDraw(userId, drawType) {
    // å¤æ‚çš„æŠ½å¥–é€»è¾‘å®ç°
  }
  
  static async calculateProbability(prizes) {
    // æ¦‚ç‡è®¡ç®—é€»è¾‘
  }
}

// ğŸ“ services/pointsService.js  
class PointsService {
  // ç§¯åˆ†è®¡ç®—å’Œæ“ä½œé€»è¾‘
  static async updateUserPoints(userId, points, reason, transaction) {
    // åŸå­æ€§ç§¯åˆ†æ“ä½œ
  }
}
```

### 2.3 ç¼“å­˜ç³»ç»Ÿå®ç°

#### Redisç¼“å­˜ç­–ç•¥
```javascript
// ğŸ“ services/cacheService.js
class CacheService {
  // ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ï¼ˆ30åˆ†é’Ÿï¼‰
  static async getUserInfo(userId) {
    const cacheKey = `user:${userId}`;
    let userInfo = await redis.get(cacheKey);
    
    if (!userInfo) {
      userInfo = await User.findByPk(userId);
      await redis.setex(cacheKey, 1800, JSON.stringify(userInfo));
    }
    
    return userInfo;
  }
  
  // æŠ½å¥–é…ç½®ç¼“å­˜ï¼ˆ1å°æ—¶ï¼‰
  static async getLotteryConfig() {
    const cacheKey = 'lottery:config';
    let config = await redis.get(cacheKey);
    
    if (!config) {
      config = await LotterySetting.getFrontendConfig();
      await redis.setex(cacheKey, 3600, JSON.stringify(config));
    }
    
    return config;
  }
  
  // å•†å“åˆ—è¡¨ç¼“å­˜ï¼ˆ5åˆ†é’Ÿï¼‰
  static async getProductList(filters) {
    const cacheKey = `products:${JSON.stringify(filters)}`;
    let products = await redis.get(cacheKey);
    
    if (!products) {
      products = await CommodityPool.getProductsForFrontend(filters);
      await redis.setex(cacheKey, 300, JSON.stringify(products));
    }
    
    return products;
  }
}
```

---

## ğŸ”§ ä¸‰ã€ä¸­ä¼˜å…ˆçº§å®Œå–„ï¼ˆ2-4å‘¨ï¼‰

### 3.1 ç›‘æ§ç³»ç»Ÿå»ºè®¾

#### å¥åº·æ£€æŸ¥æ¥å£
```javascript
// ğŸ“ routes/health.js
router.get('/health', async (req, res) => {
  const healthStatus = {
    status: 'ok',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    memory: process.memoryUsage(),
    environment: process.env.NODE_ENV,
    checks: {
      database: await checkDatabaseConnection(),
      redis: await checkRedisConnection(),
      disk: await checkDiskSpace(),
      websocket: await checkWebSocketService()
    }
  };
  
  const overallStatus = Object.values(healthStatus.checks).every(check => check.status === 'ok');
  res.status(overallStatus ? 200 : 503).json(healthStatus);
});

// è¯¦ç»†å¥åº·æ£€æŸ¥
router.get('/health/detailed', async (req, res) => {
  const detailedHealth = {
    ...basicHealth,
    database: {
      connectionPool: await getDatabasePoolStatus(),
      slowQueries: await getSlowQueryCount(),
      tableStatus: await getTableStatusInfo()
    },
    business: {
      activeUsers: await getActiveUserCount(),
      pendingReviews: await getPendingReviewCount(),
      systemLoad: await getSystemLoadInfo()
    }
  };
  
  res.json(detailedHealth);
});
```

#### æ€§èƒ½ç›‘æ§ä¸­é—´ä»¶
```javascript
// ğŸ“ middleware/performanceMonitor.js
const performanceMonitor = (req, res, next) => {
  const startTime = Date.now();
  
  res.on('finish', () => {
    const endTime = Date.now();
    const responseTime = endTime - startTime;
    
    // è®°å½•æ€§èƒ½æŒ‡æ ‡
    logger.info('API Performance:', {
      method: req.method,
      url: req.url,
      statusCode: res.statusCode,
      responseTime: `${responseTime}ms`,
      userAgent: req.headers['user-agent'],
      userId: req.user?.user_id
    });
    
    // æ…¢æŸ¥è¯¢é¢„è­¦
    if (responseTime > 1000) {
      logger.warn('Slow API Response:', {
        url: req.url,
        responseTime: `${responseTime}ms`
      });
    }
  });
  
  next();
};
```

### 3.2 æ—¥å¿—ç³»ç»Ÿå®Œå–„

#### ç»“æ„åŒ–æ—¥å¿—
```javascript
// ğŸ“ config/logger.js
const winston = require('winston');

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json(),
    winston.format.prettyPrint()
  ),
  defaultMeta: { service: 'restaurant-points-api' },
  transports: [
    // é”™è¯¯æ—¥å¿—
    new winston.transports.File({ 
      filename: 'logs/error.log', 
      level: 'error',
      maxsize: 10485760, // 10MB
      maxFiles: 5
    }),
    
    // åº”ç”¨æ—¥å¿—
    new winston.transports.File({ 
      filename: 'logs/app.log',
      maxsize: 10485760,
      maxFiles: 10 
    }),
    
    // ä¸šåŠ¡æ—¥å¿—
    new winston.transports.File({
      filename: 'logs/business.log',
      level: 'info',
      format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.json()
      )
    })
  ]
});

// å¼€å‘ç¯å¢ƒæ§åˆ¶å°è¾“å‡º
if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.simple()
  }));
}

module.exports = logger;
```

#### ä¸šåŠ¡æ—¥å¿—è®°å½•
```javascript
// ğŸ“ utils/businessLogger.js
class BusinessLogger {
  // ç”¨æˆ·æ“ä½œæ—¥å¿—
  static logUserAction(userId, action, details = {}) {
    logger.info('User Action:', {
      userId,
      action,
      details,
      timestamp: new Date().toISOString()
    });
  }
  
  // æŠ½å¥–è®°å½•æ—¥å¿—
  static logLotteryDraw(userId, drawType, results, pointsCost) {
    logger.info('Lottery Draw:', {
      userId,
      drawType,
      results: results.length,
      pointsCost,
      timestamp: new Date().toISOString()
    });
  }
  
  // å•†å“å…‘æ¢æ—¥å¿—
  static logExchange(userId, productId, quantity, pointsCost) {
    logger.info('Product Exchange:', {
      userId,
      productId,
      quantity,
      pointsCost,
      timestamp: new Date().toISOString()
    });
  }
  
  // å®¡æ ¸æ“ä½œæ—¥å¿—
  static logReview(reviewerId, uploadId, action, reason) {
    logger.info('Photo Review:', {
      reviewerId,
      uploadId,
      action,
      reason,
      timestamp: new Date().toISOString()
    });
  }
}
```

### 3.3 å®‰å…¨æœºåˆ¶åŠ å¼º

#### JWTå¢å¼ºå®‰å…¨
```javascript
// ğŸ“ middleware/enhancedAuth.js
class EnhancedAuth {
  // JWTå¯†é’¥å¼ºåº¦éªŒè¯
  static validateJWTSecret() {
    const secret = process.env.JWT_SECRET;
    
    if (!secret || secret === 'your_jwt_secret_key_change_in_production') {
      throw new Error('ğŸ”´ ç”Ÿäº§ç¯å¢ƒå¿…é¡»è®¾ç½®å¼ºJWTå¯†é’¥');
    }
    
    if (secret.length < 32) {
      throw new Error('ğŸ”´ JWTå¯†é’¥é•¿åº¦è‡³å°‘32ä¸ªå­—ç¬¦');
    }
  }
  
  // Tokené»‘åå•æœºåˆ¶
  static async addToBlacklist(token) {
    const decoded = jwt.decode(token);
    const ttl = decoded.exp - Math.floor(Date.now() / 1000);
    await redis.setex(`blacklist:${token}`, ttl, '1');
  }
  
  static async isBlacklisted(token) {
    return await redis.exists(`blacklist:${token}`);
  }
  
  // è®¾å¤‡æŒ‡çº¹éªŒè¯
  static generateDeviceFingerprint(req) {
    const ua = req.headers['user-agent'];
    const ip = req.ip;
    const acceptLanguage = req.headers['accept-language'];
    
    return crypto.createHash('sha256')
      .update(`${ua}${ip}${acceptLanguage}`)
      .digest('hex');
  }
}
```

#### è¾“å…¥éªŒè¯å¢å¼º
```javascript
// ğŸ“ middleware/validation.js
const Joi = require('joi');

const validationSchemas = {
  // ç”¨æˆ·ç™»å½•éªŒè¯
  login: Joi.object({
    phone: Joi.string().pattern(/^1[3-9]\d{9}$/).required(),
    code: Joi.string().length(6).pattern(/^\d+$/).required()
  }),
  
  // æŠ½å¥–è¯·æ±‚éªŒè¯
  lotteryDraw: Joi.object({
    draw_type: Joi.string().valid('single', 'triple', 'quintuple', 'decade').required(),
    count: Joi.number().integer().min(1).max(10).required()
  }),
  
  // å•†å“å…‘æ¢éªŒè¯
  exchange: Joi.object({
    commodity_id: Joi.number().integer().positive().required(),
    quantity: Joi.number().integer().min(1).max(10).required(),
    delivery_info: Joi.object({
      name: Joi.string().min(2).max(20).required(),
      phone: Joi.string().pattern(/^1[3-9]\d{9}$/).required(),
      address: Joi.string().min(10).max(200).required()
    }).required()
  }),
  
  // å›¾ç‰‡ä¸Šä¼ éªŒè¯
  photoUpload: Joi.object({
    amount: Joi.number().precision(2).min(0.01).max(10000).required()
  })
};

const validateInput = (schema) => {
  return (req, res, next) => {
    const { error, value } = schema.validate(req.body);
    
    if (error) {
      return res.json({
        code: 1001,
        msg: `å‚æ•°éªŒè¯å¤±è´¥: ${error.details[0].message}`,
        data: null
      });
    }
    
    req.validatedBody = value;
    next();
  };
};

module.exports = { validationSchemas, validateInput };
```

---

## ğŸ§ª å››ã€æµ‹è¯•ç³»ç»Ÿå»ºè®¾ï¼ˆ1-2å‘¨ï¼‰

### 4.1 å•å…ƒæµ‹è¯•
```javascript
// ğŸ“ tests/unit/services/lotteryService.test.js
const LotteryService = require('../../../services/lotteryService');

describe('LotteryService', () => {
  describe('performDraw', () => {
    test('åº”è¯¥æ ¹æ®æ¦‚ç‡æ­£ç¡®è¿”å›å¥–å“', async () => {
      const result = await LotteryService.performDraw(1, 'single');
      expect(result).toHaveProperty('prize_id');
      expect(result).toHaveProperty('angle');
    });
    
    test('åº”è¯¥å¤„ç†æ— æ•ˆç”¨æˆ·ID', async () => {
      await expect(LotteryService.performDraw(null, 'single'))
        .rejects.toThrow('ç”¨æˆ·IDä¸èƒ½ä¸ºç©º');
    });
  });
});

// ğŸ“ tests/unit/models/user.test.js  
const User = require('../../../models/User');

describe('User Model', () => {
  test('åº”è¯¥æ­£ç¡®è„±æ•æ‰‹æœºå·', () => {
    const user = new User({ mobile: '13800138000' });
    expect(user.getMaskedMobile()).toBe('138****8000');
  });
  
  test('åº”è¯¥è¿”å›å®‰å…¨çš„ç”¨æˆ·ä¿¡æ¯', () => {
    const user = new User({
      user_id: 1,
      mobile: '13800138000',
      total_points: 1000
    });
    
    const safeInfo = user.getSafeUserInfo();
    expect(safeInfo).not.toHaveProperty('password');
    expect(safeInfo.mobile).toBe('138****8000');
  });
});
```

### 4.2 é›†æˆæµ‹è¯•
```javascript
// ğŸ“ tests/integration/auth.test.js
const request = require('supertest');
const app = require('../../app');

describe('Authentication API', () => {
  test('POST /api/auth/login - æˆåŠŸç™»å½•', async () => {
    const response = await request(app)
      .post('/api/auth/login')
      .send({
        phone: '13800138000',
        code: '123456'
      });
      
    expect(response.status).toBe(200);
    expect(response.body.code).toBe(0);
    expect(response.body.data).toHaveProperty('access_token');
  });
  
  test('POST /api/auth/login - æ‰‹æœºå·æ ¼å¼é”™è¯¯', async () => {
    const response = await request(app)
      .post('/api/auth/login')
      .send({
        phone: '138001380',
        code: '123456'
      });
      
    expect(response.body.code).toBe(1001);
  });
});
```

### 4.3 APIè‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
```javascript
// ğŸ“ scripts/test-apis.js
const axios = require('axios');

class APITester {
  constructor(baseURL) {
    this.baseURL = baseURL;
    this.token = null;
  }
  
  async runAllTests() {
    console.log('ğŸ§ª å¼€å§‹APIè‡ªåŠ¨åŒ–æµ‹è¯•...');
    
    try {
      await this.testAuth();
      await this.testLottery();
      await this.testExchange();
      await this.testUser();
      
      console.log('âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡');
    } catch (error) {
      console.error('âŒ æµ‹è¯•å¤±è´¥:', error.message);
      process.exit(1);
    }
  }
  
  async testAuth() {
    console.log('æµ‹è¯•è®¤è¯åŠŸèƒ½...');
    
    // æµ‹è¯•ç™»å½•
    const loginRes = await axios.post(`${this.baseURL}/api/auth/login`, {
      phone: '13800138000',
      code: '123456'
    });
    
    if (loginRes.data.code !== 0) {
      throw new Error('ç™»å½•æµ‹è¯•å¤±è´¥');
    }
    
    this.token = loginRes.data.data.access_token;
    console.log('âœ… è®¤è¯æµ‹è¯•é€šè¿‡');
  }
  
  async testLottery() {
    console.log('æµ‹è¯•æŠ½å¥–åŠŸèƒ½...');
    
    // æµ‹è¯•è·å–é…ç½®
    const configRes = await axios.get(`${this.baseURL}/api/lottery/config`, {
      headers: { Authorization: `Bearer ${this.token}` }
    });
    
    if (configRes.data.code !== 0) {
      throw new Error('æŠ½å¥–é…ç½®æµ‹è¯•å¤±è´¥');
    }
    
    console.log('âœ… æŠ½å¥–æµ‹è¯•é€šè¿‡');
  }
}

// è¿è¡Œæµ‹è¯•
const tester = new APITester('http://localhost:3000');
tester.runAllTests();
```

---

## ğŸš€ äº”ã€éƒ¨ç½²å’Œè¿ç»´ä¼˜åŒ–ï¼ˆ1å‘¨ï¼‰

### 5.1 Dockerä¼˜åŒ–
```dockerfile
# ğŸ“ Dockerfile.optimized
# å¤šé˜¶æ®µæ„å»ºå‡å°é•œåƒå¤§å°
FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production && npm cache clean --force

FROM node:18-alpine AS runtime

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodeuser -u 1001

WORKDIR /app

# å¤åˆ¶ä¾èµ–å’Œä»£ç 
COPY --from=builder /app/node_modules ./node_modules
COPY --chown=nodeuser:nodejs . .

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD node healthcheck.js

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER nodeuser

EXPOSE 3000 8080

CMD ["node", "app.js"]
```

### 5.2 ç¯å¢ƒå˜é‡éªŒè¯
```javascript
// ğŸ“ config/envValidator.js
const requiredEnvVars = {
  development: ['DB_HOST', 'DB_USER', 'DB_PASSWORD', 'JWT_SECRET'],
  production: [
    'DB_HOST', 'DB_USER', 'DB_PASSWORD', 'DB_NAME',
    'JWT_SECRET', 'JWT_REFRESH_SECRET', 'ENCRYPTION_KEY',
    'REDIS_HOST', 'SEALOS_ACCESS_KEY', 'SEALOS_SECRET_KEY'
  ]
};

function validateEnvironment() {
  const env = process.env.NODE_ENV || 'development';
  const required = requiredEnvVars[env] || requiredEnvVars.development;
  
  const missing = required.filter(varName => !process.env[varName]);
  
  if (missing.length > 0) {
    console.error('ğŸ”´ ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡:', missing.join(', '));
    process.exit(1);
  }
  
  // éªŒè¯JWTå¯†é’¥å¼ºåº¦
  if (env === 'production') {
    const jwtSecret = process.env.JWT_SECRET;
    if (jwtSecret.length < 32) {
      console.error('ğŸ”´ ç”Ÿäº§ç¯å¢ƒJWTå¯†é’¥é•¿åº¦è‡³å°‘32ä¸ªå­—ç¬¦');
      process.exit(1);
    }
  }
  
  console.log('âœ… ç¯å¢ƒå˜é‡éªŒè¯é€šè¿‡');
}

module.exports = { validateEnvironment };
```

### 5.3 CI/CDæµæ°´çº¿
```yaml
# ğŸ“ .github/workflows/deploy.yml
name: Deploy Restaurant Points Backend

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpass
          MYSQL_DATABASE: test_db
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linting
      run: npm run lint
    
    - name: Run tests
      run: npm test
      env:
        DB_HOST: localhost
        DB_USER: root
        DB_PASSWORD: testpass
        DB_NAME: test_db
        JWT_SECRET: test_jwt_secret_for_testing_only
    
    - name: Run security audit
      run: npm audit --audit-level moderate
  
  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Build Docker image
      run: |
        docker build -t restaurant-points-backend:${{ github.sha }} .
        docker tag restaurant-points-backend:${{ github.sha }} restaurant-points-backend:latest
    
    - name: Deploy to staging
      run: |
        # éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
        echo "éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ"
    
    - name: Health check
      run: |
        # å¥åº·æ£€æŸ¥
        curl -f http://staging-api/health || exit 1
```

---

## ğŸ“Š å…­ã€ç›‘æ§å‘Šè­¦ç³»ç»Ÿï¼ˆ1å‘¨ï¼‰

### 6.1 ä¸šåŠ¡ç›‘æ§æŒ‡æ ‡
```javascript
// ğŸ“ services/metricsService.js
class MetricsService {
  // æŠ½å¥–ä¸šåŠ¡æŒ‡æ ‡
  static async recordLotteryMetrics(userId, drawType, result) {
    await Promise.all([
      // æŠ½å¥–æ¬¡æ•°ç»Ÿè®¡
      redis.incr('metrics:lottery:total'),
      redis.incr(`metrics:lottery:${drawType}`),
      
      // ä¸­å¥–ç‡ç»Ÿè®¡
      result.is_winning && redis.incr('metrics:lottery:winning'),
      
      // ç”¨æˆ·æŠ½å¥–ç»Ÿè®¡
      redis.incr(`metrics:user:${userId}:lottery`)
    ]);
  }
  
  // å…‘æ¢ä¸šåŠ¡æŒ‡æ ‡
  static async recordExchangeMetrics(userId, productId, pointsCost) {
    await Promise.all([
      // å…‘æ¢æ¬¡æ•°ç»Ÿè®¡
      redis.incr('metrics:exchange:total'),
      redis.incr(`metrics:product:${productId}:exchange`),
      
      // ç§¯åˆ†æ¶ˆè´¹ç»Ÿè®¡
      redis.incrby('metrics:points:consumed', pointsCost),
      
      // ç”¨æˆ·å…‘æ¢ç»Ÿè®¡
      redis.incr(`metrics:user:${userId}:exchange`)
    ]);
  }
  
  // è·å–å®æ—¶ä¸šåŠ¡æŒ‡æ ‡
  static async getBusinessMetrics() {
    const [
      totalLottery,
      totalExchange,
      totalPointsConsumed,
      winningCount
    ] = await Promise.all([
      redis.get('metrics:lottery:total'),
      redis.get('metrics:exchange:total'),
      redis.get('metrics:points:consumed'),
      redis.get('metrics:lottery:winning')
    ]);
    
    return {
      lottery: {
        total: parseInt(totalLottery) || 0,
        winning: parseInt(winningCount) || 0,
        winningRate: totalLottery ? (winningCount / totalLottery * 100).toFixed(2) : 0
      },
      exchange: {
        total: parseInt(totalExchange) || 0,
        pointsConsumed: parseInt(totalPointsConsumed) || 0,
        averagePointsPerExchange: totalExchange ? 
          Math.round(totalPointsConsumed / totalExchange) : 0
      }
    };
  }
}
```

### 6.2 å‘Šè­¦ç³»ç»Ÿ
```javascript
// ğŸ“ services/alertService.js
class AlertService {
  // é”™è¯¯ç‡å‘Šè­¦
  static async checkErrorRate() {
    const errorCount = await redis.get('metrics:errors:count') || 0;
    const totalRequests = await redis.get('metrics:requests:total') || 0;
    
    if (totalRequests > 100) {
      const errorRate = errorCount / totalRequests;
      if (errorRate > 0.05) { // é”™è¯¯ç‡è¶…è¿‡5%
        await this.sendAlert('ERROR_RATE_HIGH', {
          errorRate: (errorRate * 100).toFixed(2),
          errorCount,
          totalRequests
        });
      }
    }
  }
  
  // å“åº”æ—¶é—´å‘Šè­¦
  static async checkResponseTime() {
    const avgResponseTime = await redis.get('metrics:response_time:avg') || 0;
    
    if (avgResponseTime > 1000) { // å¹³å‡å“åº”æ—¶é—´è¶…è¿‡1ç§’
      await this.sendAlert('RESPONSE_TIME_HIGH', {
        avgResponseTime: `${avgResponseTime}ms`
      });
    }
  }
  
  // æ•°æ®åº“è¿æ¥å‘Šè­¦
  static async checkDatabaseHealth() {
    try {
      await sequelize.authenticate();
    } catch (error) {
      await this.sendAlert('DATABASE_CONNECTION_FAILED', {
        error: error.message
      });
    }
  }
  
  // å‘é€å‘Šè­¦
  static async sendAlert(type, data) {
    const alert = {
      type,
      data,
      timestamp: new Date().toISOString(),
      severity: this.getAlertSeverity(type)
    };
    
    // è®°å½•å‘Šè­¦æ—¥å¿—
    logger.error('System Alert:', alert);
    
    // å‘é€åˆ°å‘Šè­¦ç³»ç»Ÿï¼ˆå¦‚é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ç­‰ï¼‰
    if (process.env.WEBHOOK_URL) {
      await this.sendWebhookAlert(alert);
    }
  }
  
  static getAlertSeverity(type) {
    const severityMap = {
      'ERROR_RATE_HIGH': 'high',
      'RESPONSE_TIME_HIGH': 'medium',
      'DATABASE_CONNECTION_FAILED': 'critical'
    };
    return severityMap[type] || 'low';
  }
}
```

---

## ğŸ“‹ ä¸ƒã€å®æ–½è®¡åˆ’å»ºè®®

### ç¬¬ä¸€å‘¨ï¼šç´§æ€¥ä¿®å¤
- [ ] æ¢å¤æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
- [ ] å¯ç”¨æ‹ç…§ä¸Šä¼ å’Œå•†å®¶ç®¡ç†è·¯ç”±
- [ ] åŠ å¼ºè¾“å…¥éªŒè¯å’Œå®‰å…¨æ£€æŸ¥
- [ ] å®ç°åŸºç¡€é”™è¯¯å¤„ç†

### ç¬¬äºŒå‘¨ï¼šæ ¸å¿ƒåŠŸèƒ½
- [ ] å®Œæ•´å®ç°æ‹ç…§ä¸Šä¼ ç³»ç»Ÿ
- [ ] å®Œæ•´å®ç°å•†å®¶ç®¡ç†ç³»ç»Ÿ  
- [ ] é›†æˆçœŸå®çš„OCRæœåŠ¡
- [ ] å®ç°Sealoså¯¹è±¡å­˜å‚¨

### ç¬¬ä¸‰å‘¨ï¼šæ¶æ„ä¼˜åŒ–
- [ ] å®ç°Redisç¼“å­˜ç³»ç»Ÿ
- [ ] é‡æ„ä¸šåŠ¡é€»è¾‘åˆ†ç¦»
- [ ] å»ºè®¾ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ
- [ ] åˆ›å»ºå¥åº·æ£€æŸ¥æ¥å£

### ç¬¬å››å‘¨ï¼šæµ‹è¯•å’Œéƒ¨ç½²
- [ ] å»ºè®¾è‡ªåŠ¨åŒ–æµ‹è¯•
- [ ] ä¼˜åŒ–Dockeré…ç½®
- [ ] å»ºè®¾CI/CDæµæ°´çº¿
- [ ] æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–

---

## ğŸ¯ å…«ã€æˆåŠŸæŒ‡æ ‡

### æŠ€æœ¯æŒ‡æ ‡
- [ ] APIå¹³å‡å“åº”æ—¶é—´ < 200ms
- [ ] é”™è¯¯ç‡ < 1%
- [ ] æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ < 50ms
- [ ] WebSocketè¿æ¥æˆåŠŸç‡ > 99%
- [ ] ç³»ç»Ÿå¯ç”¨æ€§ > 99.9%

### ä¸šåŠ¡æŒ‡æ ‡  
- [ ] ç”¨æˆ·æ³¨å†Œè½¬åŒ–ç‡ > 80%
- [ ] æŠ½å¥–åŠŸèƒ½ä½¿ç”¨ç‡ > 60%
- [ ] å•†å“å…‘æ¢æˆåŠŸç‡ > 95%
- [ ] æ‹ç…§å®¡æ ¸å¤„ç†æ—¶é—´ < 2å°æ—¶
- [ ] ç”¨æˆ·æŠ•è¯‰ç‡ < 0.1%

### å¼€å‘æ•ˆç‡æŒ‡æ ‡
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] é›†æˆæµ‹è¯•è¦†ç›–ç‡ > 70%
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡ç‡ > 95%
- [ ] éƒ¨ç½²æˆåŠŸç‡ > 99%
- [ ] å›æ»šæ—¶é—´ < 5åˆ†é’Ÿ

---

> **ğŸš€ æ€»ç»“**: é€šè¿‡ä»¥ä¸Šå®Œå–„æªæ–½ï¼Œå¯ä»¥å°†é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿä»å½“å‰çš„åŸºç¡€å®ç°æå‡ä¸ºç”Ÿäº§çº§åˆ«çš„é«˜è´¨é‡ç³»ç»Ÿï¼Œå…·å¤‡å®Œæ•´çš„åŠŸèƒ½ã€å¯é çš„æ€§èƒ½ã€å¼ºå¤§çš„å®‰å…¨æ€§å’Œè‰¯å¥½çš„å¯ç»´æŠ¤æ€§ã€‚å»ºè®®æŒ‰ç…§ä¼˜å…ˆçº§åˆ†é˜¶æ®µå®æ–½ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œçš„åŒæ—¶é€æ­¥å®Œå–„å„é¡¹åŠŸèƒ½ã€‚ 