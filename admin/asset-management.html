<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '资产管理中心', 
    pageStyle: '[x-cloak] { display: none !important; }' 
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen">
  
  <!-- 导航栏 -->
  <nav class="themed-bg-primary text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="hover:text-blue-200">← 返回工作台</a>
        <span class="text-lg font-semibold">💎 资产管理中心</span>
      </div>
    </div>
  </nav>

  <!-- 页面主体 -->
  <div class="container mx-auto px-4 py-6" x-data="assetManagement()" x-init="init()">
    
    <!-- 子页面导航 -->
    <div class="themed-card rounded-lg shadow mb-6">
      <div class="flex border-b overflow-x-auto">
        <template x-for="page in subPages" :key="page.id">
          <button 
            @click="switchPage(page.id)"
            :class="current_page === page.id ? 'border-b-2 themed-border-primary themed-text-primary themed-bg-primary-light' : 'themed-text-muted themed-hover-bg'"
            class="px-6 py-3 font-medium whitespace-nowrap transition-colors"
            x-text="page.icon + ' ' + page.name"
          ></button>
        </template>
      </div>
    </div>

    <!-- 资产类型管理 -->
    <div x-show="current_page === 'material-types'" x-cloak>
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold">资产类型列表</h5>
          <button @click="openAddMaterialTypeModal()" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary">
            ➕ 新增资产类型
          </button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="themed-bg-base">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">资产代码</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">资产名称</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">类别</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">状态</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <!-- 骨架屏加载状态 -->
              <template x-if="loading">
                <template x-for="i in 4" :key="'skeleton-asset-' + i">
                  <tr class="animate-pulse">
                    <td class="px-4 py-3"><div class="skeleton-text w-24"></div></td>
                    <td class="px-4 py-3"><div class="skeleton-text w-32"></div></td>
                    <td class="px-4 py-3"><div class="skeleton-text w-20"></div></td>
                    <td class="px-4 py-3"><div class="skeleton-button-sm w-12"></div></td>
                    <td class="px-4 py-3"><div class="flex space-x-2"><div class="skeleton-text-xs w-8"></div><div class="skeleton-text-xs w-8"></div></div></td>
                  </tr>
                </template>
              </template>
              <!-- 空状态 -->

                <tr x-show="!loading && materialTypes.length === 0">
                  <td colspan="5" class="px-4 py-12">
                    <div class="flex flex-col items-center justify-center text-center">
                      <div class="text-6xl mb-4">📦</div>
                      <h3 class="text-lg font-medium themed-text mb-2">暂无资产类型</h3>
                      <p class="themed-text-muted text-sm mb-4">点击上方按钮添加资产类型</p>
                    </div>
                  </td>
                </tr>

              <!-- 数据列表 -->
              <template x-for="asset in materialTypes" :key="asset.asset_code">
                <tr class="themed-hover-bg transition-colors">
                  <td class="px-4 py-3 text-sm font-mono" x-text="asset.asset_code"></td>
                  <td class="px-4 py-3 text-sm" x-text="asset.display_name"></td>
                  <td class="px-4 py-3 text-sm" x-text="asset.group_code"></td>
                  <td class="px-4 py-3">
                    <span 
                      :class="asset.is_enabled ? 'bg-green-100 themed-text-success' : 'themed-bg-subtle themed-text-secondary'"
                      class="px-2 py-1 text-xs rounded"
                      x-text="asset.is_enabled ? '启用' : '禁用'"
                    ></span>
                  </td>
                  <td class="px-4 py-3">
                    <div class="flex space-x-2">
                      <button @click="editMaterialType(asset)" class="text-green-500 hover:text-green-700 text-sm">编辑</button>
                      <button @click="toggleMaterialTypeStatus(asset.asset_code, asset.is_enabled)" class="text-yellow-500 hover:text-yellow-700 text-sm" x-text="asset.is_enabled ? '禁用' : '启用'"></button>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 用户资产查询 -->
    <div x-show="current_page === 'material-accounts'" x-cloak>
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">用户资产查询</h5>
        </div>
        <div class="p-4 border-b themed-bg-base">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <input type="text" x-model="materialAccountFilters.mobile" placeholder="手机号" maxlength="11" class="px-3 py-2 border rounded">
            <select x-model="materialAccountFilters.asset_code" class="px-3 py-2 border rounded">
              <option value="">全部资产类型</option>
              <template x-for="asset in materialTypes" :key="asset.asset_code">
                <option :value="asset.asset_code" x-text="asset.display_name"></option>
              </template>
            </select>
            <button @click="loadMaterialAccounts()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">🔍 搜索</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="themed-bg-base">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">用户ID</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">资产类型</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">余额</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">更新时间</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <!-- 骨架屏加载状态 -->
              <template x-if="loading">
                <template x-for="i in 3" :key="'skeleton-account-' + i">
                  <tr class="animate-pulse">
                    <td class="px-4 py-3"><div class="skeleton-text w-12"></div></td>
                    <td class="px-4 py-3"><div class="skeleton-text w-24"></div></td>
                    <td class="px-4 py-3"><div class="skeleton-text w-16"></div></td>
                    <td class="px-4 py-3"><div class="skeleton-text w-32"></div></td>
                    <td class="px-4 py-3"><div class="skeleton-text-xs w-12"></div></td>
                  </tr>
                </template>
              </template>
              <!-- 空状态/引导状态 -->
              <tr x-show="!loading && materialAccounts.length === 0">
                <td colspan="5" class="px-4 py-12">
                  <div class="flex flex-col items-center justify-center text-center">
                    <div class="text-5xl mb-4" x-text="!materialAccountFilters.mobile ? '🔍' : '📭'"></div>
                    <h3 class="text-lg font-medium themed-text mb-2" x-text="!materialAccountFilters.mobile ? '请输入手机号' : '暂无数据'"></h3>
                    <p class="themed-text-muted text-sm" x-text="!materialAccountFilters.mobile ? '输入手机号后点击搜索查看资产信息' : '该用户暂无资产记录'"></p>
                  </div>
                </td>
              </tr>
              <!-- 数据列表 -->
              <template x-for="(ua, index) in materialAccounts" :key="ua.asset_code + '_' + (ua.campaign_id || index)">
                <tr class="themed-hover-bg">
                  <td class="px-4 py-3 text-sm" x-text="ua.user_id"></td>
                  <td class="px-4 py-3 text-sm" x-text="ua.display_name"></td>
                  <td class="px-4 py-3 text-sm font-mono" x-text="ua.balance"></td>
                  <td class="px-4 py-3 text-sm themed-text-muted" x-text="formatDate(ua.updated_at)"></td>
                  <td class="px-4 py-3">
                    <a href="asset-adjustment.html" class="themed-text-primary hover:text-blue-700 text-sm">调整</a>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 资产流水 -->
    <div x-show="current_page === 'material-transactions'" x-cloak>
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">资产流水记录</h5>
        </div>
        <div class="p-4 border-b themed-bg-base">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <input type="text" x-model="logFilters.mobile" placeholder="手机号" maxlength="11" class="px-3 py-2 border rounded">
            <select x-model="logFilters.asset_code" class="px-3 py-2 border rounded">
              <option value="">全部资产类型</option>
              <template x-for="asset in materialTypes" :key="asset.asset_code">
                <option :value="asset.asset_code" x-text="asset.display_name"></option>
              </template>
            </select>
            <input type="date" x-model="logFilters.start_date" class="px-3 py-2 border rounded">
            <button @click="loadMaterialTransactions()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">🔍 搜索</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="themed-bg-base">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">流水ID</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">用户ID</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">资产类型</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">变动类型</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">变动金额</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">变动后余额</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">时间</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <tr x-show="materialTransactions.length === 0">
                <td colspan="7" class="px-4 py-8 text-center themed-text-muted">
                  <div x-show="!logFilters.mobile">💡 请输入手机号后点击搜索</div>
                  <div x-show="logFilters.mobile">暂无数据</div>
                </td>
              </tr>
              <template x-for="log in materialTransactions" :key="log.asset_transaction_id">
                <tr class="themed-hover-bg">
                  <td class="px-4 py-3 text-sm" x-text="log.asset_transaction_id"></td>
                  <td class="px-4 py-3 text-sm" x-text="log.user_id || '-'"></td>
                  <td class="px-4 py-3 text-sm" x-text="log.asset_name"></td>
                  <td class="px-4 py-3 text-sm" x-text="log.tx_type"></td>
                  <td class="px-4 py-3 text-sm" :class="log.amount > 0 ? 'text-green-600' : 'text-red-600'" x-text="(log.amount > 0 ? '+' : '') + log.amount"></td>
                  <td class="px-4 py-3 text-sm font-mono" x-text="log.balance_after"></td>
                  <td class="px-4 py-3 text-sm themed-text-muted" x-text="formatDate(log.created_at)"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 物品实例 -->
    <div x-show="current_page === 'item-instances'" x-cloak>
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">🎁 物品模板管理</h5>
        </div>
        <div class="p-4 border-b themed-bg-base">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <select x-model="itemInstanceFilters.template_code" class="px-3 py-2 border rounded">
              <option value="">全部物品类型</option>
              <option value="voucher">优惠券</option>
              <option value="physical">实物商品</option>
              <option value="collectible">收藏品</option>
            </select>
            <select x-model="itemInstanceFilters.status" class="px-3 py-2 border rounded">
              <option value="">全部状态</option>
              <option value="enabled">启用</option>
              <option value="disabled">禁用</option>
            </select>
            <button @click="loadItemInstances()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">🔍 搜索</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="themed-bg-base">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">模板ID</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">模板代码</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">物品名称</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">类型</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">稀有度</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">状态</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <tr x-show="itemInstances.length === 0">
                <td colspan="6" class="px-4 py-8 text-center themed-text-muted">暂无物品模板数据</td>
              </tr>
              <template x-for="item in itemInstances" :key="item.item_template_id">
                <tr class="themed-hover-bg">
                  <td class="px-4 py-3 text-sm" x-text="item.item_template_id"></td>
                  <td class="px-4 py-3 text-sm font-mono" x-text="item.template_code"></td>
                  <td class="px-4 py-3 text-sm" x-text="item.display_name"></td>
                  <td class="px-4 py-3 text-sm" x-text="item.item_type"></td>
                  <td class="px-4 py-3 text-sm" x-text="item.rarity?.display_name || item.rarity_code"></td>
                  <td class="px-4 py-3">
                    <span 
                      :class="item.is_enabled ? 'bg-green-100 themed-text-success' : 'themed-bg-subtle themed-text-secondary'"
                      class="px-2 py-1 text-xs rounded"
                      x-text="item.is_enabled ? '启用' : '禁用'"
                    ></span>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 虚拟账户 -->
    <div x-show="current_page === 'virtual-accounts'" x-cloak>
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">💎 虚拟账户查询</h5>
        </div>
        <div class="p-4 border-b themed-bg-base">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <input type="text" x-model="virtualAccountFilters.mobile" placeholder="手机号" maxlength="11" class="px-3 py-2 border rounded">
            <select x-model="virtualAccountFilters.account_type" class="px-3 py-2 border rounded">
              <option value="">全部账户类型</option>
              <option value="DIAMOND">钻石</option>
              <option value="POINTS">积分</option>
              <option value="CREDITS">信用点</option>
            </select>
            <button @click="loadVirtualAccounts()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">🔍 搜索</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="themed-bg-base">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">用户ID</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">账户类型</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">可用余额</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">冻结余额</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">总额</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <tr x-show="virtualAccounts.length === 0">
                <td colspan="5" class="px-4 py-8 text-center themed-text-muted">
                  <div x-show="!virtualAccountFilters.mobile">💡 请输入手机号后点击搜索</div>
                  <div x-show="virtualAccountFilters.mobile">暂无数据</div>
                </td>
              </tr>
              <template x-for="va in virtualAccounts" :key="va.asset_code">
                <tr class="themed-hover-bg">
                  <td class="px-4 py-3 text-sm" x-text="resolvedUser?.user_id || '-'"></td>
                  <td class="px-4 py-3 text-sm" x-text="va.asset_code"></td>
                  <td class="px-4 py-3 text-sm font-mono text-green-600" x-text="va.available_amount"></td>
                  <td class="px-4 py-3 text-sm font-mono text-orange-600" x-text="va.frozen_amount"></td>
                  <td class="px-4 py-3 text-sm font-mono" x-text="va.total"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 虚拟交易 -->
    <div x-show="current_page === 'virtual-transactions'" x-cloak>
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">📊 虚拟交易记录</h5>
        </div>
        <div class="p-4 border-b themed-bg-base">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <input type="text" x-model="virtualTxFilters.mobile" placeholder="手机号（必填）" maxlength="11" class="px-3 py-2 border rounded">
            <select x-model="virtualTxFilters.account_type" class="px-3 py-2 border rounded">
              <option value="">全部账户类型</option>
              <option value="DIAMOND">钻石</option>
              <option value="POINTS">积分</option>
              <option value="CREDITS">信用点</option>
            </select>
            <select x-model="virtualTxFilters.direction" class="px-3 py-2 border rounded">
              <option value="">全部方向</option>
              <option value="in">收入</option>
              <option value="out">支出</option>
            </select>
            <button @click="loadVirtualTransactions()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">🔍 搜索</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="themed-bg-base">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">交易ID</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">账户类型</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">业务类型</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">变动金额</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">变动后余额</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">时间</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <tr x-show="virtualTransactions.length === 0">
                <td colspan="6" class="px-4 py-8 text-center themed-text-muted">
                  <div x-show="!virtualTxFilters.mobile">💡 请输入手机号后点击搜索</div>
                  <div x-show="virtualTxFilters.mobile">暂无数据</div>
                </td>
              </tr>
              <template x-for="tx in virtualTransactions" :key="tx.asset_transaction_id">
                <tr class="themed-hover-bg">
                  <td class="px-4 py-3 text-sm" x-text="tx.asset_transaction_id"></td>
                  <td class="px-4 py-3 text-sm" x-text="tx.asset_code"></td>
                  <td class="px-4 py-3 text-sm" x-text="tx.tx_type"></td>
                  <td class="px-4 py-3 text-sm" :class="tx.amount > 0 ? 'text-green-600' : 'text-red-600'" x-text="(tx.amount > 0 ? '+' : '') + tx.amount"></td>
                  <td class="px-4 py-3 text-sm font-mono" x-text="tx.balance_after"></td>
                  <td class="px-4 py-3 text-sm themed-text-muted" x-text="formatDate(tx.created_at)"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 资产统计 -->
    <div x-show="current_page === 'asset-stats'" x-cloak>
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">📈 资产统计概览</h5>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="themed-bg-primary-light rounded-lg p-6 text-center overflow-hidden">
              <div class="text-3xl font-bold themed-text-primary truncate" x-text="(assetStats.totalMaterialValue || 0).toLocaleString()" :title="String(assetStats.totalMaterialValue || 0)"></div>
              <div class="themed-text-muted mt-2">材料流通总量</div>
            </div>
            <div class="bg-purple-50 rounded-lg p-6 text-center overflow-hidden">
              <div class="text-3xl font-bold text-purple-600 truncate" x-text="(assetStats.totalVirtualValue || 0).toLocaleString()" :title="String(assetStats.totalVirtualValue || 0)"></div>
              <div class="themed-text-muted mt-2">虚拟资产流通量</div>
            </div>
            <div class="bg-green-50 rounded-lg p-6 text-center overflow-hidden">
              <div class="text-3xl font-bold text-green-600 truncate" x-text="assetStats.totalAssetTypes || 0"></div>
              <div class="themed-text-muted mt-2">资产类型数</div>
            </div>
            <div class="bg-orange-50 rounded-lg p-6 text-center overflow-hidden">
              <div class="text-3xl font-bold text-orange-600 truncate" x-text="assetStats.totalHolders || 0"></div>
              <div class="themed-text-muted mt-2">持有者数量</div>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
            <div class="themed-bg-base rounded-lg p-6 text-center overflow-hidden">
              <div class="text-3xl font-bold themed-text-secondary truncate" x-text="(assetStats.totalCirculation || 0).toLocaleString()" :title="String(assetStats.totalCirculation || 0)"></div>
              <div class="themed-text-muted mt-2">总流通量</div>
            </div>
            <div class="bg-red-50 rounded-lg p-6 text-center overflow-hidden">
              <div class="text-3xl font-bold text-red-600 truncate" x-text="(assetStats.totalFrozen || 0).toLocaleString()" :title="String(assetStats.totalFrozen || 0)"></div>
              <div class="themed-text-muted mt-2">总冻结量</div>
            </div>
          </div>
          <div class="mt-6 text-center">
            <button @click="loadAssetStats()" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary inline-flex items-center" :disabled="loading">
              <span x-show="loading" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>
              <span x-text="loading ? '刷新中...' : '🔄 刷新统计'"></span>
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- ==================== Modal 组件区域 ==================== -->

  <!-- 1. 添加材料资产类型 Modal -->
  <div x-ref="addMaterialTypeModal"
       x-show="isModalOpen('addMaterialTypeModal')"
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center"
       style="display: none;">
    <div class="fixed inset-0 bg-black/50" @click="hideModal('addMaterialTypeModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-2xl mx-4 z-10 max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center sticky top-0 themed-card">
        <h5 class="font-semibold">➕ 添加资产类型</h5>
        <button @click="hideModal('addMaterialTypeModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
      </div>
      <form @submit.prevent="submitAddMaterialType()">
        <div class="p-6 space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">资产代码 <span class="text-red-500">*</span></label>
              <input type="text" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" x-model="materialTypeAddForm.asset_code" required placeholder="如: red_shard">
              <p class="text-xs themed-text-muted mt-1">唯一标识，建议使用小写字母和下划线</p>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">显示名称 <span class="text-red-500">*</span></label>
              <input type="text" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" x-model="materialTypeAddForm.display_name" required placeholder="如: 碎红水晶">
            </div>
          </div>
          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">材料组 <span class="text-red-500">*</span></label>
              <input type="text" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" x-model="materialTypeAddForm.group_code" required placeholder="如: red">
              <p class="text-xs themed-text-muted mt-1">用于分组，如: red, orange, purple</p>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">形态 <span class="text-red-500">*</span></label>
              <select class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" x-model="materialTypeAddForm.form" required>
                <option value="">请选择</option>
                <option value="shard">碎片（shard）</option>
                <option value="crystal">水晶（crystal）</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">层级 <span class="text-red-500">*</span></label>
              <input type="number" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" x-model="materialTypeAddForm.tier" required min="1" placeholder="如: 1">
              <p class="text-xs themed-text-muted mt-1">层级越高价值越大</p>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">可见价值（积分） <span class="text-red-500">*</span></label>
              <input type="number" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" x-model="materialTypeAddForm.visible_value_points" required min="0" placeholder="如: 10">
              <p class="text-xs themed-text-muted mt-1">用于用户展示和说明</p>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">预算价值（积分） <span class="text-red-500">*</span></label>
              <input type="number" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" x-model="materialTypeAddForm.budget_value_points" required min="0" placeholder="如: 10">
              <p class="text-xs themed-text-muted mt-1">用于系统成本控制</p>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">排序权重</label>
              <input type="number" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" x-model="materialTypeAddForm.sort_order" value="0">
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">启用状态</label>
              <select class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" x-model="materialTypeAddForm.is_enabled">
                <option value="1">启用</option>
                <option value="0">禁用</option>
              </select>
            </div>
          </div>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-3">
          <button type="button" @click="hideModal('addMaterialTypeModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded-lg hover:bg-gray-300">取消</button>
          <button type="submit" class="px-4 py-2 themed-bg-primary text-white rounded-lg themed-hover-primary disabled:opacity-50" :disabled="materialTypeSubmitting">
            <span x-show="materialTypeSubmitting" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>
            确认添加
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 2. 编辑材料资产类型 Modal -->
  <div x-ref="editMaterialTypeModal"
       x-show="isModalOpen('editMaterialTypeModal')"
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center"
       style="display: none;">
    <div class="fixed inset-0 bg-black/50" @click="hideModal('editMaterialTypeModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-2xl mx-4 z-10 max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center sticky top-0 themed-card">
        <h5 class="font-semibold">✏️ 编辑资产类型</h5>
        <button @click="hideModal('editMaterialTypeModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
      </div>
      <form @submit.prevent="submitEditMaterialType()">
        <div class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">资产代码</label>
            <input type="text" class="w-full px-3 py-2 border rounded-lg themed-bg-subtle" x-model="materialTypeEditForm.asset_code" disabled>
            <p class="text-xs themed-text-muted mt-1">资产代码不可修改</p>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">显示名称 <span class="text-red-500">*</span></label>
              <input type="text" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" x-model="materialTypeEditForm.display_name" required>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">材料组</label>
              <input type="text" class="w-full px-3 py-2 border rounded-lg themed-bg-subtle" x-model="materialTypeEditForm.group_code" disabled>
              <p class="text-xs themed-text-muted mt-1">材料组不可修改</p>
            </div>
          </div>
          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">形态</label>
              <input type="text" class="w-full px-3 py-2 border rounded-lg themed-bg-subtle" :value="getFormLabel(materialTypeEditForm.form)" disabled>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">层级</label>
              <input type="number" class="w-full px-3 py-2 border rounded-lg themed-bg-subtle" x-model="materialTypeEditForm.tier" disabled>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">排序权重</label>
              <input type="number" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" x-model="materialTypeEditForm.sort_order">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">可见价值（积分） <span class="text-red-500">*</span></label>
              <input type="number" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" x-model="materialTypeEditForm.visible_value_points" required min="0">
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">预算价值（积分） <span class="text-red-500">*</span></label>
              <input type="number" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" x-model="materialTypeEditForm.budget_value_points" required min="0">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">启用状态</label>
            <select class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" x-model="materialTypeEditForm.is_enabled">
              <option value="1">启用</option>
              <option value="0">禁用</option>
            </select>
          </div>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-3">
          <button type="button" @click="hideModal('editMaterialTypeModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded-lg hover:bg-gray-300">取消</button>
          <button type="submit" class="px-4 py-2 themed-bg-primary text-white rounded-lg themed-hover-primary disabled:opacity-50" :disabled="materialTypeSubmitting">
            <span x-show="materialTypeSubmitting" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>
            保存更新
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 3. 物品实例详情 Modal -->
  <div x-ref="instanceDetailModal"
       x-show="isModalOpen('instanceDetailModal')"
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center"
       style="display: none;">
    <div class="fixed inset-0 bg-black/50" @click="hideModal('instanceDetailModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-2xl mx-4 z-10 max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center sticky top-0 themed-card">
        <h5 class="font-semibold">📦 物品实例详情</h5>
        <button @click="hideModal('instanceDetailModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
      </div>
      <div class="p-6" x-show="instanceDetail">
        <!-- 基本信息 -->
        <div class="mb-6">
          <h6 class="font-medium themed-text-secondary border-b pb-2 mb-3">ℹ️ 基本信息</h6>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs themed-text-muted mb-1">实例ID</label>
              <div class="font-mono text-sm themed-bg-subtle px-2 py-1 rounded" x-text="instanceDetail?.instance_id"></div>
            </div>
            <div>
              <label class="block text-xs themed-text-muted mb-1">物品名称</label>
              <div class="font-medium" x-text="instanceDetail?.item_name || instanceDetail?.template_id || '-'"></div>
            </div>
            <div>
              <label class="block text-xs themed-text-muted mb-1">模板ID</label>
              <div class="font-mono text-sm" x-text="instanceDetail?.template_id || '-'"></div>
            </div>
            <div>
              <label class="block text-xs themed-text-muted mb-1">状态</label>
              <span class="px-2 py-1 text-xs rounded" :class="getInstanceStatusClass(instanceDetail?.status)" x-text="getInstanceStatusText(instanceDetail?.status)"></span>
            </div>
          </div>
        </div>
        <!-- 所有者信息 -->
        <div class="mb-6">
          <h6 class="font-medium themed-text-secondary border-b pb-2 mb-3">👤 所有者信息</h6>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs themed-text-muted mb-1">用户ID</label>
              <div x-text="instanceDetail?.owner_user_id || '-'"></div>
            </div>
            <div>
              <label class="block text-xs themed-text-muted mb-1">用户昵称</label>
              <div x-text="instanceDetail?.owner_nickname || '-'"></div>
            </div>
          </div>
        </div>
        <!-- 来源和时间 -->
        <div class="mb-6">
          <h6 class="font-medium themed-text-secondary border-b pb-2 mb-3">🕐 来源和时间</h6>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs themed-text-muted mb-1">来源</label>
              <div x-text="instanceDetail?.source || '-'"></div>
            </div>
            <div>
              <label class="block text-xs themed-text-muted mb-1">来源说明</label>
              <div x-text="instanceDetail?.source_detail || '-'"></div>
            </div>
            <div>
              <label class="block text-xs themed-text-muted mb-1">创建时间</label>
              <div x-text="formatDate(instanceDetail?.created_at)"></div>
            </div>
            <div>
              <label class="block text-xs themed-text-muted mb-1">更新时间</label>
              <div x-text="formatDate(instanceDetail?.updated_at)"></div>
            </div>
          </div>
        </div>
        <!-- 扩展信息 -->
        <template x-if="instanceDetail?.metadata && Object.keys(instanceDetail.metadata).length > 0">
          <div>
            <h6 class="font-medium themed-text-secondary border-b pb-2 mb-3">📋 扩展信息</h6>
            <pre class="themed-bg-subtle p-3 rounded text-xs overflow-x-auto" x-text="JSON.stringify(instanceDetail.metadata, null, 2)"></pre>
          </div>
        </template>
      </div>
      <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end">
        <button @click="hideModal('instanceDetailModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded-lg hover:bg-gray-300">关闭</button>
      </div>
    </div>
  </div>

  <!-- 页面专属逻辑 -->
  <%- include('partials/footer') %>

  <script type="module" src="./src/modules/asset/pages/asset-management.js"></script>
</body>
</html>
