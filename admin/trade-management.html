<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '交易管理', 
    pageStyle: '[x-cloak] { display: none !important; }' 
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen" x-data="tradeManagementPage()" x-init="init()" x-cloak>
  
  <!-- 导航栏 -->
  <nav class="themed-bg-primary text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="hover:text-blue-200">← 返回工作台</a>
        <span class="text-lg font-semibold">💱 交易管理</span>
      </div>
      <div class="flex items-center space-x-4">
        <span x-text="'欢迎，' + (current_user?.nickname || '管理员')"></span>
        <button @click="logout()" class="px-3 py-1 border border-white/50 rounded hover:bg-white/10">退出登录</button>
      </div>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-6">
    <!-- Tab导航 -->
    <div class="themed-card rounded-lg shadow mb-6">
      <div class="flex border-b overflow-x-auto">
        <template x-for="page in subPages" :key="page.id">
          <button
            @click="switchPage(page.id)"
            :class="current_page === page.id ? 'border-b-2 themed-border-primary themed-text-primary themed-bg-primary-light' : 'themed-text-muted themed-hover-bg'"
            class="px-6 py-3 font-medium whitespace-nowrap transition-colors"
            x-text="page.icon + ' ' + page.name"
          ></button>
        </template>
      </div>
    </div>

    <!-- ==================== C2C交易订单 Tab ==================== -->
    <div x-show="current_page === 'trade-orders'">

    <!-- 统计卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="themed-card rounded-lg shadow p-4 text-center">
        <div class="text-4xl text-blue-400 mb-2">📋</div>
        <h4 class="text-2xl font-bold themed-text-primary" x-text="stats.totalTrades">0</h4>
        <p class="themed-text-muted text-sm">总交易数</p>
      </div>
      <div class="themed-card rounded-lg shadow p-4 text-center">
        <div class="text-4xl text-green-400 mb-2">✅</div>
        <h4 class="text-2xl font-bold text-green-600" x-text="stats.completedTrades">0</h4>
        <p class="themed-text-muted text-sm">已完成</p>
      </div>
      <div class="themed-card rounded-lg shadow p-4 text-center">
        <div class="text-4xl text-yellow-400 mb-2">⏳</div>
        <h4 class="text-2xl font-bold text-yellow-600" x-text="stats.pendingTrades">0</h4>
        <p class="themed-text-muted text-sm">待处理</p>
      </div>
      <div class="themed-card rounded-lg shadow p-4 text-center">
        <div class="text-4xl text-orange-400 mb-2">💰</div>
        <h4 class="text-2xl font-bold text-orange-600" x-text="formatNumber(stats.totalVolume)">0</h4>
        <p class="themed-text-muted text-sm">总成交额</p>
      </div>
    </div>

    <!-- 筛选栏 -->
    <div class="themed-card rounded-lg shadow mb-6">
      <div class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">交易状态</label>
            <select x-model="tradeFilters.status" class="w-full px-3 py-2 border rounded-lg">
              <option value="">全部状态</option>
              <option value="pending">待处理</option>
              <option value="processing">进行中</option>
              <option value="completed">已完成</option>
              <option value="cancelled">已取消</option>
              <option value="disputed">争议中</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">买家ID</label>
            <input type="text" x-model="tradeFilters.buyer_user_id" placeholder="买家ID" class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">卖家ID</label>
            <input type="text" x-model="tradeFilters.seller_user_id" placeholder="卖家ID" class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div>
            <button @click="loadTradeOrders()" class="w-full px-4 py-2 themed-btn-primary rounded-lg">
              🔍 搜索
            </button>
          </div>
          <div>
            <button @click="tradeFilters = { status: '', buyer_user_id: '', seller_user_id: '', listing_id: '' }; loadTradeOrders()" class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
              🔄 重置
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 交易列表 -->
    <div class="themed-card rounded-lg shadow">
      <div class="p-4 border-b">
        <h5 class="font-semibold">交易记录</h5>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="themed-bg-base">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">交易ID</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">买家</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">卖家</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">商品</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">成交价</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">状态</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">时间</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
            </tr>
          </thead>
          <tbody class="divide-y">
            <template x-if="tradeOrders.length === 0">
              <tr><td colspan="8" class="px-4 py-8 text-center themed-text-muted">暂无交易记录</td></tr>
            </template>
            <template x-for="trade in tradeOrders" :key="trade.trade_order_id">
              <tr class="themed-hover-bg">
                <td class="px-4 py-3 text-sm font-mono" x-text="trade.trade_order_id"></td>
                <td class="px-4 py-3 text-sm" x-text="trade.buyer?.nickname || trade.buyer_user_id"></td>
                <td class="px-4 py-3 text-sm" x-text="trade.seller?.nickname || trade.seller_user_id"></td>
                <td class="px-4 py-3 text-sm" x-text="trade.listing?.offer_asset_code || trade.asset_code || '-'"></td>
                <td class="px-4 py-3 text-sm font-mono text-green-600" x-text="formatNumber(trade.gross_amount || trade.price_amount)"></td>
                <td class="px-4 py-3">
                  <span :class="{
                    'bg-yellow-100 text-yellow-700': trade.status === 'pending',
                    'themed-bg-primary-light themed-text-primary': trade.status === 'processing',
                    'bg-green-100 themed-text-success': trade.status === 'completed',
                    'bg-red-100 text-red-700': trade.status === 'cancelled',
                    'bg-orange-100 text-orange-700': trade.status === 'disputed'
                  }" class="px-2 py-1 text-xs rounded" x-text="getStatusText(trade.status)"></span>
                </td>
                <td class="px-4 py-3 text-sm themed-text-muted" x-text="formatDate(trade.created_at)"></td>
                <td class="px-4 py-3">
                  <div class="flex space-x-2">
                    <button @click="viewTradeOrderDetail(trade)" class="themed-text-primary hover:text-blue-700 text-sm">详情</button>
                  </div>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
      
      <!-- 分页 -->
      <div class="p-4 border-t flex justify-between items-center">
        <span class="text-sm themed-text-muted" x-text="'共 ' + (tradePagination?.total || 0) + ' 条记录'"></span>
        <div class="flex space-x-2">
          <button @click="changeTradePage(tradeCurrentPage - 1)" :disabled="tradeCurrentPage <= 1" class="px-3 py-1 border rounded disabled:opacity-50">上一页</button>
          <span class="px-3 py-1" x-text="tradeCurrentPage + ' / ' + (tradePagination?.total_pages || 1)"></span>
          <button @click="changeTradePage(tradeCurrentPage + 1)" :disabled="tradeCurrentPage >= (tradePagination?.total_pages || 1)" class="px-3 py-1 border rounded disabled:opacity-50">下一页</button>
        </div>
      </div>
    </div>

    </div><!-- End of C2C交易订单 Tab -->

    <!-- ==================== 上架统计 Tab ==================== -->
    <div x-show="current_page === 'marketplace-stats'">
      
      <!-- 上架统计摘要卡片 -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <div class="text-4xl text-blue-400 mb-2">👥</div>
          <h4 class="text-2xl font-bold themed-text-primary" x-text="marketplaceSummary.total_users_with_listings || 0">0</h4>
          <p class="themed-text-muted text-sm">有上架商品的用户数</p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <div class="text-4xl text-yellow-400 mb-2">⚠️</div>
          <h4 class="text-2xl font-bold text-yellow-600" x-text="marketplaceSummary.users_near_limit || 0">0</h4>
          <p class="themed-text-muted text-sm">接近上架上限</p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <div class="text-4xl text-red-400 mb-2">🚫</div>
          <h4 class="text-2xl font-bold text-red-600" x-text="marketplaceSummary.users_at_limit || 0">0</h4>
          <p class="themed-text-muted text-sm">已达上架上限</p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <div class="text-4xl text-green-400 mb-2">📦</div>
          <h4 class="text-2xl font-bold text-green-600" x-text="maxListings">10</h4>
          <p class="themed-text-muted text-sm">最大上架数限制</p>
        </div>
      </div>

      <!-- 筛选栏 -->
      <div class="themed-card rounded-lg shadow mb-6">
        <div class="p-4">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">上架状态</label>
              <select x-model="marketplaceFilters.status" class="w-full px-3 py-2 border rounded-lg">
                <option value="all">全部状态</option>
                <option value="normal">正常</option>
                <option value="near_limit">接近上限</option>
                <option value="at_limit">已达上限</option>
              </select>
            </div>
            <div>
              <button @click="loadMarketplaceStats()" class="w-full px-4 py-2 themed-btn-primary rounded-lg">
                🔍 查询
              </button>
            </div>
            <div>
              <button @click="marketplaceFilters.status = 'all'; loadMarketplaceStats()" class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                🔄 重置
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 上架统计列表 -->
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">📊 用户上架统计</h5>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="themed-bg-base">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">用户ID</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">用户昵称</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">当前上架数</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">上架上限</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">使用率</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">状态</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <template x-if="marketplaceStats.length === 0">
                <tr><td colspan="6" class="px-4 py-8 text-center themed-text-muted">暂无上架统计数据</td></tr>
              </template>
              <template x-for="stat in marketplaceStats" :key="stat.user_id">
                <tr class="themed-hover-bg">
                  <td class="px-4 py-3 text-sm font-mono" x-text="stat.user_id"></td>
                  <td class="px-4 py-3 text-sm" x-text="stat.nickname || stat.user?.nickname || '-'"></td>
                  <td class="px-4 py-3 text-sm font-mono themed-text-primary" x-text="stat.listing_count || stat.active_listings || 0"></td>
                  <td class="px-4 py-3 text-sm font-mono" x-text="stat.max_listings || maxListings"></td>
                  <td class="px-4 py-3">
                    <div class="flex items-center gap-2">
                      <div class="w-24 bg-gray-200 rounded-full h-2">
                        <div class="h-2 rounded-full" 
                             :class="{
                               'bg-green-500': (stat.listing_count || 0) / (stat.max_listings || maxListings) < 0.7,
                               'bg-yellow-500': (stat.listing_count || 0) / (stat.max_listings || maxListings) >= 0.7 && (stat.listing_count || 0) / (stat.max_listings || maxListings) < 1,
                               'bg-red-500': (stat.listing_count || 0) >= (stat.max_listings || maxListings)
                             }"
                             :style="'width: ' + Math.min(100, ((stat.listing_count || 0) / (stat.max_listings || maxListings) * 100)) + '%'">
                        </div>
                      </div>
                      <span class="text-sm" x-text="Math.round((stat.listing_count || 0) / (stat.max_listings || maxListings) * 100) + '%'"></span>
                    </div>
                  </td>
                  <td class="px-4 py-3">
                    <span :class="{
                      'bg-green-100 themed-text-success': (stat.listing_count || 0) < (stat.max_listings || maxListings) * 0.7,
                      'bg-yellow-100 text-yellow-700': (stat.listing_count || 0) >= (stat.max_listings || maxListings) * 0.7 && (stat.listing_count || 0) < (stat.max_listings || maxListings),
                      'bg-red-100 text-red-700': (stat.listing_count || 0) >= (stat.max_listings || maxListings)
                    }" class="px-2 py-1 text-xs rounded" x-text="
                      (stat.listing_count || 0) >= (stat.max_listings || maxListings) ? '已达上限' :
                      (stat.listing_count || 0) >= (stat.max_listings || maxListings) * 0.7 ? '接近上限' : '正常'
                    "></span>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        
        <!-- 分页 -->
        <div class="p-4 border-t flex justify-between items-center">
          <span class="text-sm themed-text-muted" x-text="'共 ' + (marketplacePagination?.total || 0) + ' 条记录'"></span>
          <div class="flex space-x-2">
            <button @click="changeMarketplacePage(marketplaceCurrentPage - 1)" :disabled="marketplaceCurrentPage <= 1" class="px-3 py-1 border rounded disabled:opacity-50">上一页</button>
            <span class="px-3 py-1" x-text="marketplaceCurrentPage + ' / ' + (marketplacePagination?.total_pages || 1)"></span>
            <button @click="changeMarketplacePage(marketplaceCurrentPage + 1)" :disabled="marketplaceCurrentPage >= (marketplacePagination?.total_pages || 1)" class="px-3 py-1 border rounded disabled:opacity-50">下一页</button>
          </div>
        </div>
      </div>

    </div><!-- End of 上架统计 Tab -->

  </div>

  <!-- C2C交易订单详情 Modal (新架构) -->
  <div x-ref="tradeDetailModal" 
       x-show="isModalOpen('tradeDetailModal')" 
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center"
       style="display: none;">
    <div class="fixed inset-0 bg-black/50" @click="hideModal('tradeDetailModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-lg mx-4 z-10">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">📋 C2C交易订单详情</h5>
        <button @click="hideModal('tradeDetailModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
      </div>
      <div class="p-6 space-y-3" x-show="selectedTradeOrder">
        <div class="flex justify-between border-b pb-2"><span class="themed-text-muted">订单ID:</span><span class="font-mono" x-text="selectedTradeOrder?.trade_order_id"></span></div>
        <div class="flex justify-between border-b pb-2"><span class="themed-text-muted">业务ID:</span><span class="font-mono text-xs" x-text="selectedTradeOrder?.business_id || '-'"></span></div>
        <div class="flex justify-between border-b pb-2"><span class="themed-text-muted">买家:</span><span x-text="selectedTradeOrder?.buyer?.nickname || selectedTradeOrder?.buyer_user_id"></span></div>
        <div class="flex justify-between border-b pb-2"><span class="themed-text-muted">卖家:</span><span x-text="selectedTradeOrder?.seller?.nickname || selectedTradeOrder?.seller_user_id"></span></div>
        <div class="flex justify-between border-b pb-2"><span class="themed-text-muted">结算资产:</span><span x-text="selectedTradeOrder?.asset_code || '-'"></span></div>
        <div class="flex justify-between border-b pb-2"><span class="themed-text-muted">总金额:</span><span class="font-mono text-green-600" x-text="formatNumber(selectedTradeOrder?.gross_amount)"></span></div>
        <div class="flex justify-between border-b pb-2"><span class="themed-text-muted">手续费:</span><span class="font-mono text-orange-500" x-text="formatNumber(selectedTradeOrder?.fee_amount || 0)"></span></div>
        <div class="flex justify-between border-b pb-2"><span class="themed-text-muted">净金额:</span><span class="font-mono themed-text-primary" x-text="formatNumber(selectedTradeOrder?.net_amount)"></span></div>
        <div class="flex justify-between border-b pb-2">
          <span class="themed-text-muted">状态:</span>
          <span class="px-2 py-1 text-xs rounded" :class="{
            'bg-yellow-100 text-yellow-700': selectedTradeOrder?.status === 'created',
            'themed-bg-primary-light themed-text-primary': selectedTradeOrder?.status === 'frozen',
            'bg-green-100 themed-text-success': selectedTradeOrder?.status === 'completed',
            'bg-red-100 text-red-700': selectedTradeOrder?.status === 'cancelled'
          }" x-text="getTradeOrderStatusText(selectedTradeOrder?.status)"></span>
        </div>
        <div class="flex justify-between border-b pb-2"><span class="themed-text-muted">创建时间:</span><span x-text="formatDate(selectedTradeOrder?.created_at)"></span></div>
        <div class="flex justify-between" x-show="selectedTradeOrder?.completed_at"><span class="themed-text-muted">完成时间:</span><span x-text="formatDate(selectedTradeOrder?.completed_at)"></span></div>
      </div>
      <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end">
        <button @click="hideModal('tradeDetailModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">关闭</button>
      </div>
    </div>
  </div>

  <%- include('partials/footer') %>



  <script type="module" src="./src/modules/market/pages/trade-management.js"></script>
</body>
</html>
