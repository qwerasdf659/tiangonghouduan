<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '交易管理', 
    pageStyle: '[x-cloak] { display: none !important; }' 
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen" x-data="tradeManagementPage()" x-init="init()" x-cloak>
  
  <!-- 导航栏（深色渐变风格） -->
  <nav class="page-navbar">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="text-blue-200 hover:text-white transition-colors">← 返回工作台</a>
        <span class="text-lg font-semibold">💱 交易管理</span>
      </div>
      <div class="flex items-center space-x-4">
        <span x-text="'欢迎，' + (current_user?.nickname || '管理员')"></span>
        <button @click="logout()" class="px-3 py-1 border border-white/30 rounded hover:bg-white/10 transition-colors">退出登录</button>
      </div>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-6">
    <!-- 页面横幅 -->
    <div class="page-banner mb-6">
      <h1>💱 交易管理</h1>
      <p>交易市场订单监控、市场上架管理、核销记录追溯</p>
    </div>

    <!-- Tab导航（增强样式） -->
    <div class="enhanced-tabs">
      <template x-for="page in subPages" :key="page.id">
        <button
          @click="switchPage(page.id)"
          :class="current_page === page.id ? 'active' : ''"
          class="tab-item"
          x-text="page.icon + ' ' + page.name"
        ></button>
      </template>
    </div>

    <!-- ==================== 交易市场订单 Tab ==================== -->
    <div x-show="current_page === 'trade-orders'">

    <!-- 统计卡片（渐变样式） -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="gradient-stat-card gradient-stat-blue">
        <div class="stat-icon">📋</div>
        <div class="stat-value" x-text="stats.totalTrades">0</div>
        <div class="stat-label">总交易数</div>
      </div>
      <div class="gradient-stat-card gradient-stat-green">
        <div class="stat-icon">✅</div>
        <div class="stat-value" x-text="stats.completedTrades">0</div>
        <div class="stat-label">已完成</div>
      </div>
      <div class="gradient-stat-card gradient-stat-orange">
        <div class="stat-icon">⏳</div>
        <div class="stat-value" x-text="stats.pendingTrades">0</div>
        <div class="stat-label">待处理</div>
      </div>
      <div class="gradient-stat-card gradient-stat-rose">
        <div class="stat-icon">💰</div>
        <div class="stat-value" x-text="formatNumber(stats.totalVolume)">0</div>
        <div class="stat-label">总成交额</div>
      </div>
    </div>

    <!-- 筛选栏 -->
    <div class="themed-card rounded-lg shadow mb-6">
      <div class="p-4">
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4 items-end">
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">交易状态</label>
            <select x-model="tradeFilters.status" class="w-full px-3 py-2 border rounded-lg">
              <option value="">全部状态</option>
              <option value="pending">待处理</option>
              <option value="processing">进行中</option>
              <option value="completed">已完成</option>
              <option value="cancelled">已取消</option>
              <option value="disputed">争议中</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">商家筛选</label>
            <select x-model="tradeOrderMerchantFilter" class="w-full px-3 py-2 border rounded-lg">
              <option value="">全部商家</option>
              <template x-for="m in merchantOptions" :key="m.merchant_id">
                <option :value="m.merchant_id" x-text="m.merchant_name"></option>
              </template>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">买家手机号</label>
            <input type="text" x-model="tradeFilters.buyer_mobile" maxlength="11" placeholder="买家手机号" class="w-full px-3 py-2 border rounded-lg">
            <div x-show="resolvedBuyer" class="mt-1 text-xs text-green-600">✅ <span x-text="resolvedBuyer?.nickname"></span></div>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">卖家手机号</label>
            <input type="text" x-model="tradeFilters.seller_mobile" maxlength="11" placeholder="卖家手机号" class="w-full px-3 py-2 border rounded-lg">
            <div x-show="resolvedSeller" class="mt-1 text-xs text-green-600">✅ <span x-text="resolvedSeller?.nickname"></span></div>
          </div>
          <div>
            <button @click="loadTradeOrders()" class="w-full px-4 py-2 themed-btn-primary rounded-lg">
              🔍 搜索
            </button>
          </div>
          <div>
            <button @click="tradeFilters = { status: '', buyer_mobile: '', seller_mobile: '', listing_id: '' }; tradeOrderMerchantFilter = ''; resolvedBuyer = null; resolvedSeller = null; loadTradeOrders()" class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
              🔄 重置
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 交易列表（data-table） -->
    <div class="themed-card rounded-lg shadow" @table-action="handleTradeOrderTableAction($event.detail)">
      <div class="p-4 border-b">
        <h5 class="font-semibold">交易记录</h5>
      </div>
      <div x-data="dataTable({
        columns: tradeOrderTableColumns,
        dataSource: fetchTradeOrderTableData,
        primaryKey: 'trade_order_id',
        sortable: true,
        selectable: false,
        exportable: false,
        page_size: 20,
        emptyText: '暂无交易订单数据'
      })" x-init="init()" @dt-trade-refresh.window="refresh()">
        <%- include('components/data-table') %>
      </div>
    </div>

    </div><!-- End of 交易市场订单 Tab -->

    <!-- ==================== 上架统计 Tab ==================== -->
    <div x-show="current_page === 'marketplace-stats'">
      
      <!-- 上架统计摘要卡片 -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <div class="text-4xl text-blue-400 mb-2">👥</div>
          <h4 class="text-2xl font-bold themed-text-primary" x-text="marketplaceSummary.total_users_with_listings || 0">0</h4>
          <p class="themed-text-muted text-sm">有上架商品的用户数</p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <div class="text-4xl text-yellow-400 mb-2">⚠️</div>
          <h4 class="text-2xl font-bold text-yellow-600" x-text="marketplaceSummary.users_near_limit || 0">0</h4>
          <p class="themed-text-muted text-sm">接近上架上限</p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <div class="text-4xl text-red-400 mb-2">🚫</div>
          <h4 class="text-2xl font-bold text-red-600" x-text="marketplaceSummary.users_at_limit || 0">0</h4>
          <p class="themed-text-muted text-sm">已达上架上限</p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <div class="text-4xl text-green-400 mb-2">📦</div>
          <h4 class="text-2xl font-bold text-green-600" x-text="maxListings">10</h4>
          <p class="themed-text-muted text-sm">最大上架数限制</p>
        </div>
      </div>

      <!-- 筛选栏 -->
      <div class="themed-card rounded-lg shadow mb-6">
        <div class="p-4">
          <div class="grid grid-cols-2 md:grid-cols-6 gap-4 items-end">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">手机号搜索</label>
              <input type="text" x-model="marketplaceFilters.mobile" placeholder="输入手机号搜索"
                     class="w-full px-3 py-2 border rounded-lg"
                     @keydown.enter="loadMarketplaceStats()">
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">上架状态</label>
              <select x-model="marketplaceFilters.status" class="w-full px-3 py-2 border rounded-lg">
                <option value="all">全部状态</option>
                <option value="near_limit">接近上限</option>
                <option value="at_limit">已达上限</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">商家筛选</label>
              <select x-model="marketplaceFilters.merchant_id" class="w-full px-3 py-2 border rounded-lg">
                <option value="">全部商家</option>
                <template x-for="m in merchantOptions" :key="m.merchant_id">
                  <option :value="m.merchant_id" x-text="m.merchant_name"></option>
                </template>
              </select>
            </div>
            <div>
              <button @click="loadMarketplaceStats()" class="w-full px-4 py-2 themed-btn-primary rounded-lg">
                🔍 查询
              </button>
            </div>
            <div>
              <button @click="marketplaceFilters = { status: 'all', mobile: '', merchant_id: '' }; loadMarketplaceStats()" class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                🔄 重置
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 上架统计列表 -->
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold">📊 用户上架统计</h5>
          <span class="text-sm themed-text-muted">共 <span x-text="marketplacePagination.total"></span> 条</span>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="themed-bg-base">
              <tr>
                <th class="px-4 py-3 text-left font-medium themed-text-secondary">用户ID</th>
                <th class="px-4 py-3 text-left font-medium themed-text-secondary">手机号</th>
                <th class="px-4 py-3 text-left font-medium themed-text-secondary">用户昵称</th>
                <th class="px-4 py-3 text-center font-medium themed-text-secondary">当前上架数</th>
                <th class="px-4 py-3 text-center font-medium themed-text-secondary">上架上限</th>
                <th class="px-4 py-3 text-center font-medium themed-text-secondary">剩余配额</th>
                <th class="px-4 py-3 text-center font-medium themed-text-secondary">状态</th>
                <th class="px-4 py-3 text-center font-medium themed-text-secondary">操作</th>
              </tr>
            </thead>
            <tbody>
              <tr x-show="marketplaceStats.length === 0">
                <td colspan="8" class="px-4 py-8 text-center themed-text-muted">暂无市场统计数据</td>
              </tr>
              <template x-for="row in marketplaceStats" :key="row.user_id">
                <tr class="border-b hover:themed-bg-base transition-colors">
                  <td class="px-4 py-3 font-mono" x-text="row.user_id"></td>
                  <td class="px-4 py-3 font-mono" x-text="row.mobile"></td>
                  <td class="px-4 py-3" x-text="row.nickname || '-'"></td>
                  <td class="px-4 py-3 text-center font-bold" x-text="row.listing_count"></td>
                  <td class="px-4 py-3 text-center">
                    <span class="font-mono" x-text="row.max_active_listings"></span>
                    <span x-show="row.is_custom_limit" class="text-xs text-purple-600 ml-1">自定义</span>
                  </td>
                  <td class="px-4 py-3 text-center" x-text="row.remaining_quota"></td>
                  <td class="px-4 py-3 text-center">
                    <span x-show="row.is_at_limit" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">已达上限</span>
                    <span x-show="!row.is_at_limit" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">正常</span>
                  </td>
                  <td class="px-4 py-3 text-center">
                    <div class="flex gap-1 justify-center">
                      <button @click="viewUserListings(row)" class="px-2 py-1 text-xs themed-btn-primary rounded">查看上架</button>
                      <button @click="openAdjustLimit(row)" class="px-2 py-1 text-xs bg-purple-500 text-white rounded hover:bg-purple-600">调整限制</button>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <!-- 分页 -->
        <div class="p-4 border-t flex justify-between items-center" x-show="marketplacePagination.total_pages > 1">
          <span class="text-sm themed-text-muted">第 <span x-text="marketplaceCurrentPage"></span>/<span x-text="marketplacePagination.total_pages"></span> 页</span>
          <div class="flex gap-1">
            <button @click="marketplaceCurrentPage = Math.max(1, marketplaceCurrentPage - 1); loadMarketplaceStats()"
                    :disabled="marketplaceCurrentPage <= 1"
                    class="px-3 py-1 text-sm border rounded disabled:opacity-50">上一页</button>
            <button @click="marketplaceCurrentPage = Math.min(marketplacePagination.total_pages, marketplaceCurrentPage + 1); loadMarketplaceStats()"
                    :disabled="marketplaceCurrentPage >= marketplacePagination.total_pages"
                    class="px-3 py-1 text-sm border rounded disabled:opacity-50">下一页</button>
          </div>
        </div>
      </div>

    </div><!-- End of 上架统计 Tab -->

    <!-- ==================== 市场概览 Tab ==================== -->
    <div x-show="current_page === 'market-overview'">

      <!-- 加载状态 -->
      <div x-show="marketOverviewLoading" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
        <p class="mt-2 themed-text-muted">加载市场概览数据...</p>
      </div>

      <div x-show="!marketOverviewLoading">
        <!-- 核心指标卡片 -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
          <div class="gradient-stat-card gradient-stat-blue">
            <div class="stat-icon">📊</div>
            <div class="stat-value" x-text="marketOverview.total_orders">0</div>
            <div class="stat-label">近7天成交笔数</div>
          </div>
          <div class="gradient-stat-card gradient-stat-green">
            <div class="stat-icon">✅</div>
            <div class="stat-value" x-text="marketOverview.completed_orders">0</div>
            <div class="stat-label">已完成订单</div>
          </div>
          <div class="gradient-stat-card gradient-stat-orange">
            <div class="stat-icon">💰</div>
            <div class="stat-value" x-text="formatNumber(marketOverview.total_volume)">0</div>
            <div class="stat-label">总成交额(钻石)</div>
          </div>
          <div class="gradient-stat-card gradient-stat-rose">
            <div class="stat-icon">💎</div>
            <div class="stat-value" x-text="formatNumber(marketOverview.total_fees)">0</div>
            <div class="stat-label">总手续费</div>
          </div>
          <div class="gradient-stat-card" style="background: linear-gradient(135deg, #06b6d4 0%, #22d3ee 100%); color: white;">
            <div class="stat-icon">🛒</div>
            <div class="stat-value" x-text="marketOverview.unique_buyers || 0">0</div>
            <div class="stat-label">活跃买家(近7天)</div>
          </div>
          <div class="gradient-stat-card" style="background: linear-gradient(135deg, #7C3AED 0%, #A855F7 100%); color: white;">
            <div class="stat-icon">👥</div>
            <div class="stat-value" x-text="marketOverview.unique_sellers || 0">0</div>
            <div class="stat-label">活跃卖家(近7天)</div>
          </div>
        </div>

        <!-- 订单状态分布 -->
        <div class="themed-card rounded-lg shadow mb-6">
          <div class="p-4 border-b">
            <h5 class="font-semibold">📈 订单状态分布</h5>
          </div>
          <div class="p-6">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4"
                 x-show="Object.keys(marketOverview.by_status).length > 0">
              <template x-for="[status, info] in Object.entries(marketOverview.by_status)" :key="status">
                <div class="text-center p-4 themed-bg-base rounded-lg">
                  <div class="text-2xl font-bold themed-text-primary" x-text="info.count || 0"></div>
                  <div class="text-sm themed-text-muted mt-1" x-text="info.display_name || status"></div>
                </div>
              </template>
            </div>
            <div x-show="Object.keys(marketOverview.by_status).length === 0"
                 class="text-center py-8 themed-text-muted">
              暂无订单状态数据
            </div>
          </div>
        </div>

        <!-- ECharts 图表区域（MarketAnalyticsService 数据可视化） -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <!-- 资产成交量排行图表 -->
          <div class="themed-card rounded-lg shadow">
            <div class="p-4 border-b">
              <h5 class="font-semibold">📊 近7天各资产成交量排行</h5>
            </div>
            <div class="p-4">
              <div id="asset-ranking-chart" style="width: 100%; height: 320px;"></div>
              <div x-show="marketOverview.asset_ranking.length === 0"
                   class="text-center py-12 themed-text-muted">
                暂无资产成交数据
              </div>
            </div>
          </div>

          <!-- 当前在售资产分布饼图 -->
          <div class="themed-card rounded-lg shadow">
            <div class="p-4 border-b">
              <h5 class="font-semibold">🥧 当前在售资产分布</h5>
            </div>
            <div class="p-4">
              <div id="on-sale-chart" style="width: 100%; height: 320px;"></div>
              <div x-show="marketOverview.on_sale_summary.length === 0"
                   class="text-center py-12 themed-text-muted">
                暂无在售资产数据
              </div>
            </div>
          </div>
        </div>

        <!-- 资产成交量明细表格 -->
        <div class="themed-card rounded-lg shadow mb-6"
             x-show="marketOverview.asset_ranking.length > 0">
          <div class="p-4 border-b">
            <h5 class="font-semibold">📋 资产成交量明细</h5>
          </div>
          <div class="p-4 overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b themed-text-muted">
                  <th class="py-2 text-left">资产代码</th>
                  <th class="py-2 text-left">挂牌类型</th>
                  <th class="py-2 text-right">成交笔数</th>
                  <th class="py-2 text-right">成交总量(钻石)</th>
                  <th class="py-2 text-right">均价</th>
                  <th class="py-2 text-right">最低价</th>
                  <th class="py-2 text-right">最高价</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="item in marketOverview.asset_ranking" :key="item.asset_code + item.listing_kind">
                  <tr class="border-b hover:bg-gray-50">
                    <td class="py-2 font-medium" x-text="item.asset_code"></td>
                    <td class="py-2">
                      <span class="px-2 py-0.5 rounded text-xs"
                            :class="item.listing_kind === 'item' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'"
                            x-text="item.listing_kind === 'item' ? '物品' : '可叠加资产'"></span>
                    </td>
                    <td class="py-2 text-right font-bold" x-text="Number(item.trade_count || 0).toLocaleString()"></td>
                    <td class="py-2 text-right" x-text="Number(item.total_diamond_volume || 0).toLocaleString()"></td>
                    <td class="py-2 text-right" x-text="Number(item.avg_price || 0).toLocaleString()"></td>
                    <td class="py-2 text-right" x-text="Number(item.min_price || 0).toLocaleString()"></td>
                    <td class="py-2 text-right" x-text="Number(item.max_price || 0).toLocaleString()"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 市场健康指标 -->
        <div class="themed-card rounded-lg shadow mb-6">
          <div class="p-4 border-b">
            <h5 class="font-semibold">🏥 市场健康指标</h5>
          </div>
          <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
              <div class="p-4 themed-bg-base rounded-lg">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-medium themed-text-secondary">成交转化率</span>
                  <span class="text-lg font-bold themed-text-primary"
                        x-text="marketOverview.total_orders > 0
                          ? (marketOverview.completed_orders / marketOverview.total_orders * 100).toFixed(1) + '%'
                          : '0%'">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div class="bg-green-500 h-2 rounded-full transition-all"
                       :style="'width:' + (marketOverview.total_orders > 0 ? (marketOverview.completed_orders / marketOverview.total_orders * 100) : 0) + '%'"></div>
                </div>
              </div>
              <div class="p-4 themed-bg-base rounded-lg">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-medium themed-text-secondary">平均订单金额</span>
                  <span class="text-lg font-bold themed-text-primary"
                        x-text="marketOverview.completed_orders > 0
                          ? formatNumber(Math.round(marketOverview.total_volume / marketOverview.completed_orders))
                          : '0'">0</span>
                </div>
                <p class="text-xs themed-text-muted">基于已完成订单计算</p>
              </div>
              <div class="p-4 themed-bg-base rounded-lg">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-medium themed-text-secondary">平均手续费率</span>
                  <span class="text-lg font-bold themed-text-primary"
                        x-text="marketOverview.total_volume > 0
                          ? (marketOverview.total_fees / marketOverview.total_volume * 100).toFixed(2) + '%'
                          : '0%'">0%</span>
                </div>
                <p class="text-xs themed-text-muted">手续费 / 总成交额</p>
              </div>
              <div class="p-4 themed-bg-base rounded-lg">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-medium themed-text-secondary">活跃参与者</span>
                  <span class="text-lg font-bold themed-text-primary"
                        x-text="(marketOverview.unique_buyers || 0) + ' / ' + (marketOverview.unique_sellers || 0)"></span>
                </div>
                <p class="text-xs themed-text-muted">买家 / 卖家（近7天）</p>
              </div>
            </div>
          </div>
        </div>

        <!-- 操作区 -->
        <div class="mt-4 text-right">
          <button @click="loadMarketOverview()" class="px-4 py-2 themed-btn-primary rounded-lg text-sm">
            🔄 刷新数据
          </button>
        </div>
      </div>

    </div><!-- End of 市场概览 Tab -->

  </div>

  <!-- 交易市场订单详情 Modal (新架构) -->
  <div x-ref="tradeDetailModal" 
       x-show="isModalOpen('tradeDetailModal')" 
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center"
       style="display: none;">
    <div class="fixed inset-0 bg-black/50" @click="hideModal('tradeDetailModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-lg mx-4 z-10">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">📋 交易市场订单详情</h5>
        <button @click="hideModal('tradeDetailModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
      </div>
      <div class="p-6 space-y-3" x-show="selectedTradeOrder">
        <div class="flex justify-between border-b pb-2"><span class="themed-text-muted">订单ID:</span><span class="font-mono" x-text="selectedTradeOrder?.trade_order_id"></span></div>
        <div class="flex justify-between border-b pb-2"><span class="themed-text-muted">业务ID:</span><span class="font-mono text-xs" x-text="selectedTradeOrder?.business_id || '-'"></span></div>
        <div class="flex justify-between border-b pb-2"><span class="themed-text-muted">买家:</span><span x-text="selectedTradeOrder?.buyer?.nickname || selectedTradeOrder?.buyer_user_id"></span></div>
        <div class="flex justify-between border-b pb-2"><span class="themed-text-muted">卖家:</span><span x-text="selectedTradeOrder?.seller?.nickname || selectedTradeOrder?.seller_user_id"></span></div>
        <div class="flex justify-between border-b pb-2"><span class="themed-text-muted">结算资产:</span><span x-text="selectedTradeOrder?.asset_code || '-'"></span></div>
        <div class="flex justify-between border-b pb-2"><span class="themed-text-muted">总金额:</span><span class="font-mono text-green-600" x-text="formatNumber(selectedTradeOrder?.gross_amount)"></span></div>
        <div class="flex justify-between border-b pb-2"><span class="themed-text-muted">手续费:</span><span class="font-mono text-orange-500" x-text="formatNumber(selectedTradeOrder?.fee_amount || 0)"></span></div>
        <div class="flex justify-between border-b pb-2"><span class="themed-text-muted">净金额:</span><span class="font-mono themed-text-primary" x-text="formatNumber(selectedTradeOrder?.net_amount)"></span></div>
        <div class="flex justify-between border-b pb-2">
          <span class="themed-text-muted">状态:</span>
          <span class="px-2 py-1 text-xs rounded" :class="{
            'bg-yellow-100 text-yellow-700': selectedTradeOrder?.status === 'created',
            'themed-bg-primary-light themed-text-primary': selectedTradeOrder?.status === 'frozen',
            'bg-green-100 themed-text-success': selectedTradeOrder?.status === 'completed',
            'bg-red-100 text-red-700': selectedTradeOrder?.status === 'cancelled'
          }" x-text="selectedTradeOrder?.status_display || selectedTradeOrder?.status"></span>
        </div>
        <div class="flex justify-between border-b pb-2"><span class="themed-text-muted">创建时间:</span><span x-text="formatDate(selectedTradeOrder?.created_at)"></span></div>
        <div class="flex justify-between" x-show="selectedTradeOrder?.completed_at"><span class="themed-text-muted">完成时间:</span><span x-text="formatDate(selectedTradeOrder?.completed_at)"></span></div>
      </div>
      <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end">
        <button @click="hideModal('tradeDetailModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">关闭</button>
      </div>
    </div>
  </div>

  <!-- 用户上架商品列表 Modal -->
  <div x-ref="userListingsModal"
       x-show="isModalOpen('userListingsModal')"
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center"
       style="display: none;">
    <div class="fixed inset-0 bg-black/50" @click="hideModal('userListingsModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-4xl mx-4 z-10 max-h-[85vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center sticky top-0 themed-card z-10">
        <h5 class="font-semibold">📋 用户上架商品列表</h5>
        <button @click="hideModal('userListingsModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
      </div>

      <!-- 用户信息摘要 -->
      <div class="p-4 border-b themed-bg-base" x-show="userListingsInfo.user">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
          <div><span class="themed-text-muted">用户ID：</span><span class="font-mono" x-text="userListingsInfo.user?.user_id"></span></div>
          <div><span class="themed-text-muted">手机号：</span><span class="font-mono" x-text="userListingsInfo.user?.mobile"></span></div>
          <div><span class="themed-text-muted">昵称：</span><span x-text="userListingsInfo.user?.nickname || '-'"></span></div>
          <div>
            <span class="themed-text-muted">上架额度：</span>
            <span class="font-bold" x-text="userListingsInfo.user?.active_listing_count + '/' + userListingsInfo.user?.max_active_listings"></span>
            <span class="text-xs themed-text-muted" x-show="userListingsInfo.user?.is_custom_limit">（自定义）</span>
          </div>
        </div>
      </div>

      <!-- 状态筛选 -->
      <div class="p-4 border-b flex gap-2 items-center flex-wrap">
        <span class="text-sm themed-text-muted">筛选状态：</span>
        <template x-for="s in [{value:'',label:'全部'},{value:'on_sale',label:'在售'},{value:'locked',label:'锁定中'},{value:'sold',label:'已售'},{value:'withdrawn',label:'已撤回'},{value:'admin_withdrawn',label:'管理员下架'}]" :key="s.value">
          <button @click="userListingsFilter.status = s.value; loadUserListings(userListingsInfo.user?.user_id)"
                  :class="userListingsFilter.status === s.value ? 'themed-btn-primary' : 'themed-bg-muted themed-text-secondary'"
                  class="px-3 py-1 text-xs rounded-full" x-text="s.label"></button>
        </template>
      </div>

      <!-- 商品列表 -->
      <div class="p-4">
        <div x-show="userListingsInfo.listings.length === 0" class="text-center py-8 themed-text-muted">
          暂无上架商品
        </div>
        <div class="space-y-3" x-show="userListingsInfo.listings.length > 0">
          <template x-for="listing in userListingsInfo.listings" :key="listing.market_listing_id">
            <div class="border rounded-lg p-3 hover:shadow-md transition-shadow">
              <div class="flex justify-between items-start">
                <div class="flex-1 space-y-1">
                  <div class="flex items-center gap-2">
                    <span class="font-mono text-xs themed-text-muted">#<span x-text="listing.market_listing_id"></span></span>
                    <span class="px-2 py-0.5 text-xs rounded-full"
                          :class="{
                            'bg-green-100 text-green-700': listing.status === 'on_sale',
                            'bg-yellow-100 text-yellow-700': listing.status === 'locked',
                            'bg-blue-100 text-blue-700': listing.status === 'sold',
                            'bg-gray-100 text-gray-600': listing.status === 'withdrawn',
                            'bg-red-100 text-red-700': listing.status === 'admin_withdrawn'
                          }"
                          x-text="getListingStatusText(listing.status)"></span>
                    <span class="text-xs themed-text-muted" x-text="listing.listing_kind === 'fungible_asset' ? '材料资产' : '物品实例'"></span>
                  </div>
                  <div class="text-sm">
                    <span class="themed-text-muted">出售：</span>
                    <span x-text="listing.offer_item_display_name || listing.offer_asset_code || '-'"></span>
                    <span x-show="listing.offer_amount" class="text-xs themed-text-muted">×<span x-text="listing.offer_amount"></span></span>
                  </div>
                  <div class="text-sm">
                    <span class="themed-text-muted">售价：</span>
                    <span class="font-bold text-green-600" x-text="listing.price_amount"></span>
                    <span class="text-xs" x-text="listing.price_asset_code"></span>
                  </div>
                  <div class="text-xs themed-text-muted" x-text="'上架时间：' + formatDate(listing.created_at)"></div>
                </div>
                <div class="flex-shrink-0 ml-3" x-show="listing.status === 'on_sale' || listing.status === 'locked'">
                  <button @click="confirmForceWithdraw(listing)"
                          class="px-3 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600">
                    强制下架
                  </button>
                </div>
              </div>
            </div>
          </template>
        </div>

        <!-- 分页 -->
        <div class="mt-4 flex justify-between items-center" x-show="userListingsPagination.total_pages > 1">
          <span class="text-sm themed-text-muted">共 <span x-text="userListingsPagination.total"></span> 条</span>
          <div class="flex gap-1">
            <button @click="changeUserListingsPage(userListingsCurrentPage - 1)" :disabled="userListingsCurrentPage <= 1"
                    class="px-3 py-1 text-sm border rounded disabled:opacity-50">上一页</button>
            <span class="px-3 py-1 text-sm" x-text="userListingsCurrentPage + '/' + userListingsPagination.total_pages"></span>
            <button @click="changeUserListingsPage(userListingsCurrentPage + 1)" :disabled="userListingsCurrentPage >= userListingsPagination.total_pages"
                    class="px-3 py-1 text-sm border rounded disabled:opacity-50">下一页</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 调整上架限制 Modal -->
  <div x-ref="adjustLimitModal"
       x-show="isModalOpen('adjustLimitModal')"
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center"
       style="display: none;">
    <div class="fixed inset-0 bg-black/50" @click="hideModal('adjustLimitModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-md mx-4 z-10">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">⚙️ 调整上架数量限制</h5>
        <button @click="hideModal('adjustLimitModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
      </div>
      <div class="p-6 space-y-4">
        <div class="text-sm space-y-1">
          <div><span class="themed-text-muted">用户：</span><span x-text="adjustLimitForm.mobile"></span> (<span x-text="adjustLimitForm.nickname || '-'"></span>)</div>
          <div><span class="themed-text-muted">当前限制：</span><span class="font-bold" x-text="adjustLimitForm.current_limit"></span>
            <span class="text-xs themed-text-muted" x-text="adjustLimitForm.is_custom ? '（自定义）' : '（全局默认）'"></span>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium themed-text-secondary mb-1">新的上架限制</label>
          <input type="number" x-model.number="adjustLimitForm.new_limit" min="0" max="1000"
                 class="w-full px-3 py-2 border rounded-lg" placeholder="输入新上限，留空恢复全局默认">
        </div>
        <div class="flex items-center gap-2">
          <input type="checkbox" x-model="adjustLimitForm.use_global" id="useGlobal" class="rounded">
          <label for="useGlobal" class="text-sm themed-text-secondary">恢复使用全局默认值</label>
        </div>
        <div>
          <label class="block text-sm font-medium themed-text-secondary mb-1">调整原因</label>
          <textarea x-model="adjustLimitForm.reason" rows="2"
                    class="w-full px-3 py-2 border rounded-lg" placeholder="请填写调整原因（选填）"></textarea>
        </div>
      </div>
      <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end gap-2">
        <button @click="hideModal('adjustLimitModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">取消</button>
        <button @click="submitAdjustLimit()" :disabled="saving"
                class="px-4 py-2 themed-btn-primary rounded disabled:opacity-50">
          <span x-show="!saving">确认调整</span>
          <span x-show="saving">调整中...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- 强制下架确认 Modal -->
  <div x-ref="forceWithdrawModal"
       x-show="isModalOpen('forceWithdrawModal')"
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center"
       style="display: none;">
    <div class="fixed inset-0 bg-black/50" @click="hideModal('forceWithdrawModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-md mx-4 z-10">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold text-red-600">⚠️ 确认强制下架</h5>
        <button @click="hideModal('forceWithdrawModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
      </div>
      <div class="p-6 space-y-4">
        <div class="text-sm space-y-1">
          <div><span class="themed-text-muted">挂牌ID：</span><span class="font-mono" x-text="forceWithdrawForm.market_listing_id"></span></div>
          <div><span class="themed-text-muted">当前状态：</span><span x-text="getListingStatusText(forceWithdrawForm.status)"></span></div>
        </div>
        <div class="bg-red-50 border border-red-200 rounded p-3 text-sm text-red-700">
          强制下架操作将不可逆，卖家的冻结资产/物品将被解冻退还。
        </div>
        <div>
          <label class="block text-sm font-medium themed-text-secondary mb-1">下架原因（必填）</label>
          <textarea x-model="forceWithdrawForm.reason" rows="2"
                    class="w-full px-3 py-2 border rounded-lg border-red-300" placeholder="请填写下架原因"></textarea>
        </div>
      </div>
      <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end gap-2">
        <button @click="hideModal('forceWithdrawModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">取消</button>
        <button @click="submitForceWithdraw()" :disabled="saving || !forceWithdrawForm.reason?.trim()"
                class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 disabled:opacity-50">
          <span x-show="!saving">确认下架</span>
          <span x-show="saving">处理中...</span>
        </button>
      </div>
    </div>
  </div>

  <%- include('partials/footer') %>

  <script type="module" src="./src/modules/market/pages/trade-management.js"></script>
</body>
</html>
