<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '客服管理', 
    pageStyle: '[x-cloak] { display: none !important; } .load-bar { height: 8px; border-radius: 4px; transition: width 0.6s cubic-bezier(.4,0,.2,1); } .tab-pill { transition: all 0.25s ease; } .agent-row { transition: background-color 0.15s; } .pulse-dot { animation: pulse-ring 1.5s infinite; } @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(16,185,129,0.4); } 70% { box-shadow: 0 0 0 6px rgba(16,185,129,0); } 100% { box-shadow: 0 0 0 0 rgba(16,185,129,0); } } .user-preview { animation: fadeSlide 0.2s ease; } @keyframes fadeSlide { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }' 
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen">
  
  <!-- 导航栏 -->
  <nav class="themed-bg-primary text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="hover:opacity-80 flex items-center gap-1 text-sm">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
          返回工作台
        </a>
        <span class="text-lg font-semibold">👩‍💼 客服管理</span>
      </div>
      <div class="flex items-center space-x-4 text-sm">
        <span class="text-white/60" x-data="{ t: '' }" x-init="setInterval(() => t = new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', hour: '2-digit', minute: '2-digit', second: '2-digit' }), 1000)" x-text="t"></span>
      </div>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-6" x-data="csAgentManagementPage()" x-init="init()" x-cloak>

    <!-- ====== 页面说明引导 ====== -->
    <div class="rounded-xl shadow-sm mb-6 overflow-hidden">
      <div class="px-5 py-5 flex items-start gap-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center text-2xl flex-shrink-0">🎯</div>
        <div class="flex-1">
          <h2 class="text-lg font-bold mb-1.5">客服座席管理中心</h2>
          <p class="text-sm text-white/80 leading-relaxed">管理客服团队成员、分配用户到专属客服、监控工作负载。用户发起咨询时，系统会优先路由到已分配的客服，未分配的用户按优先级自动分配给空闲座席。</p>
          <div class="flex flex-wrap gap-4 mt-3 text-xs text-white/70">
            <span class="flex items-center gap-1">👩‍💼 <strong class="text-white">座席管理</strong> — 添加/编辑客服人员</span>
            <span class="flex items-center gap-1">📊 <strong class="text-white">工作负载</strong> — 实时查看繁忙程度</span>
            <span class="flex items-center gap-1">🔗 <strong class="text-white">用户分配</strong> — 指定用户的专属客服</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ====== Tab 切换 ====== -->
    <div class="flex space-x-1 mb-6 p-1 rounded-xl" style="background: linear-gradient(135deg, #e8ecf5 0%, #f0f3fa 100%);">
      <button @click="activeTab = 'agents'; loadAgents()"
        :class="activeTab === 'agents' ? 'bg-white text-indigo-700 shadow-md font-semibold' : 'text-gray-500 hover:text-gray-700 hover:bg-white/50'"
        class="tab-pill flex-1 px-5 py-2.5 rounded-lg text-sm flex items-center justify-center gap-2 transition-all">
        👩‍💼 座席管理
      </button>
      <button @click="activeTab = 'workload'; loadWorkload()"
        :class="activeTab === 'workload' ? 'bg-white text-indigo-700 shadow-md font-semibold' : 'text-gray-500 hover:text-gray-700 hover:bg-white/50'"
        class="tab-pill flex-1 px-5 py-2.5 rounded-lg text-sm flex items-center justify-center gap-2 transition-all">
        📊 工作负载
      </button>
      <button @click="activeTab = 'assignments'; loadAssignments(); loadAgents()"
        :class="activeTab === 'assignments' ? 'bg-white text-indigo-700 shadow-md font-semibold' : 'text-gray-500 hover:text-gray-700 hover:bg-white/50'"
        class="tab-pill flex-1 px-5 py-2.5 rounded-lg text-sm flex items-center justify-center gap-2 transition-all">
        🔗 用户分配
      </button>
    </div>

    <!-- ============================================================ -->
    <!-- Tab: 座席管理                                                 -->
    <!-- ============================================================ -->
    <div x-show="activeTab === 'agents'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0">

      <!-- 筛选工具栏 -->
      <div class="themed-card rounded-xl shadow-sm p-4 mb-4 border-l-4 border-indigo-400">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="flex flex-wrap items-center gap-3">
            <div class="relative">
              <select x-model="agentFilter.status" @change="filterAgents()" class="pl-3 pr-8 py-2 border themed-border-light rounded-lg text-sm themed-bg themed-text appearance-none cursor-pointer">
                <option value="">全部状态</option>
                <option value="active">🟢 在岗</option>
                <option value="inactive">⚪ 离线</option>
                <option value="on_break">🟡 休息中</option>
              </select>
            </div>
            <div class="flex items-center">
              <div class="relative">
                <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input x-model="agentFilter.search" @keyup.enter="filterAgents()" placeholder="搜索手机号 / 昵称…" class="pl-9 pr-4 py-2 border themed-border-light rounded-l-lg text-sm themed-bg themed-text w-52" />
              </div>
              <button @click="filterAgents()" class="px-4 py-2 rounded-r-lg text-sm font-medium flex items-center gap-1.5 whitespace-nowrap bg-indigo-500 text-white hover:bg-indigo-600 transition-colors border border-indigo-500">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                搜索
              </button>
              <button x-show="agentFilter.search || agentFilter.status" @click="agentFilter.search = ''; agentFilter.status = ''; filterAgents()" class="ml-2 px-3 py-2 rounded-lg text-sm text-gray-500 hover:text-red-500 hover:bg-red-50 transition-colors" title="清除筛选">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
          </div>
          <button @click="openCreateAgent()" class="themed-btn-primary px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-1.5 shadow-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            注册新座席
          </button>
        </div>
        <div class="mt-3 p-2.5 rounded-lg bg-indigo-50/60 border border-indigo-100">
          <p class="text-xs text-indigo-600 flex items-start gap-1.5">
            <span class="flex-shrink-0 mt-0.5">💡</span>
            <span><strong>操作指南：</strong>输入客服的手机号或昵称点击「搜索」查找。点击「注册新座席」将系统用户添加为客服——输入用户ID、设置显示名称和并发上限即可。</span>
          </p>
        </div>
      </div>

      <!-- 座席表格 -->
      <div class="themed-card rounded-xl shadow-sm overflow-hidden">
        <div class="px-5 py-3 flex justify-between items-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <h3 class="text-white font-medium text-sm flex items-center gap-2">👩‍💼 客服座席列表</h3>
          <span class="text-white/70 text-xs" x-text="'共 ' + agentPagination.total + ' 位座席'"></span>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr style="background: linear-gradient(135deg, #f0f3fa 0%, #e8ecf5 100%);">
                <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 tracking-wider">客服信息</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 tracking-wider">状态</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 tracking-wider">会话上限</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 tracking-wider">当前会话</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 tracking-wider">分配用户</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 tracking-wider">累计处理</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 tracking-wider">满意度</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 tracking-wider">优先级</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 tracking-wider">操作</th>
              </tr>
            </thead>
            <tbody class="divide-y themed-divide">
              <template x-if="agentsLoading">
                <tr><td colspan="9" class="px-5 py-12 text-center">
                  <div class="animate-spin inline-block w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full mb-2"></div>
                  <p class="themed-text-muted text-sm">加载中…</p>
                </td></tr>
              </template>
              <template x-if="!agentsLoading && agents.length === 0">
                <tr><td colspan="9" class="px-5 py-16 text-center">
                  <div class="text-5xl mb-3 opacity-40">👩‍💼</div>
                  <p class="themed-text-muted font-medium mb-1">暂无客服座席</p>
                  <p class="text-xs themed-text-muted mb-4">客服座席是处理用户咨询的工作人员，需要先注册才能分配工作</p>
                  <button @click="openCreateAgent()" class="themed-btn-primary px-4 py-2 rounded-lg text-sm font-medium inline-flex items-center gap-1.5 shadow-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    注册第一个座席
                  </button>
                </td></tr>
              </template>
              <template x-for="agent in agents" :key="agent.customer_service_agent_id">
                <tr class="agent-row hover:themed-bg-base">
                  <td class="px-5 py-3.5">
                    <div class="flex items-center gap-3">
                      <div class="w-9 h-9 rounded-full flex items-center justify-center text-white text-sm font-bold" style="background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);" x-text="(agent.display_name || '?')[0]"></div>
                      <div>
                        <div class="font-medium" x-text="agent.display_name"></div>
                        <div class="text-xs themed-text-muted flex items-center gap-2">
                          <span x-text="agent.user?.nickname || '-'"></span>
                          <span class="text-gray-300">|</span>
                          <span class="font-mono" x-text="agent.user?.mobile || ''"></span>
                        </div>
                      </div>
                    </div>
                  </td>
                  <td class="px-4 py-3.5 text-center">
                    <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium"
                      :class="agent.status === 'active' ? 'bg-green-50 text-green-700 border border-green-200' : agent.status === 'on_break' ? 'bg-yellow-50 text-yellow-700 border border-yellow-200' : 'bg-gray-100 text-gray-500 border border-gray-200'">
                      <span x-show="agent.status === 'active'" class="w-2 h-2 rounded-full bg-green-500 pulse-dot"></span>
                      <span x-show="agent.status === 'on_break'" class="w-2 h-2 rounded-full bg-yellow-500"></span>
                      <span x-show="agent.status === 'inactive'" class="w-2 h-2 rounded-full bg-gray-400"></span>
                      <span x-text="agentStatusText(agent.status)"></span>
                    </span>
                  </td>
                  <td class="px-4 py-3.5 text-center font-mono text-sm" x-text="agent.max_concurrent_sessions"></td>
                  <td class="px-4 py-3.5 text-center">
                    <span class="font-mono text-sm" :class="agent.current_session_count >= agent.max_concurrent_sessions ? 'text-red-600 font-bold' : ''" x-text="agent.current_session_count"></span>
                  </td>
                  <td class="px-4 py-3.5 text-center font-mono text-sm" x-text="agent.active_assignment_count || 0"></td>
                  <td class="px-4 py-3.5 text-center font-mono text-sm" x-text="agent.total_sessions_handled"></td>
                  <td class="px-4 py-3.5 text-center">
                    <span class="font-mono text-sm" :class="agent.average_satisfaction_score >= 4 ? 'text-green-600' : agent.average_satisfaction_score >= 3 ? 'text-yellow-600' : 'themed-text-muted'" x-text="agent.average_satisfaction_score > 0 ? '⭐ ' + agent.average_satisfaction_score.toFixed(1) : '-'"></span>
                  </td>
                  <td class="px-4 py-3.5 text-center">
                    <span class="inline-flex items-center justify-center w-7 h-7 rounded-full text-xs font-bold" :class="agent.priority >= 5 ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'" x-text="agent.priority"></span>
                  </td>
                  <td class="px-4 py-3.5 text-center">
                    <div class="flex items-center justify-center gap-1">
                      <button @click="viewAgentDetail(agent.customer_service_agent_id)" class="p-1.5 rounded hover:bg-blue-50 text-blue-500" title="查看详情">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                      </button>
                      <button @click="openEditAgent(agent)" class="p-1.5 rounded hover:bg-indigo-50 text-indigo-500" title="编辑配置">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                      </button>
                      <button @click="deleteAgent(agent)" class="p-1.5 rounded hover:bg-red-50 text-red-400 hover:text-red-600" title="删除座席">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                      </button>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <!-- 分页 -->
        <div class="px-5 py-3 border-t themed-border-light flex justify-between items-center text-sm themed-text-muted" x-show="agentPagination.total_pages > 1">
          <span>共 <span x-text="agentPagination.total" class="font-medium"></span> 条</span>
          <div class="flex items-center gap-1">
            <button @click="agentGoToPage(agentPagination.current_page - 1)" :disabled="agentPagination.current_page <= 1" class="px-3 py-1.5 border themed-border-light rounded-lg hover:themed-bg-base disabled:opacity-40 disabled:cursor-not-allowed">上一页</button>
            <span class="px-3 py-1.5 text-sm font-medium" x-text="agentPagination.current_page + ' / ' + agentPagination.total_pages"></span>
            <button @click="agentGoToPage(agentPagination.current_page + 1)" :disabled="agentPagination.current_page >= agentPagination.total_pages" class="px-3 py-1.5 border themed-border-light rounded-lg hover:themed-bg-base disabled:opacity-40 disabled:cursor-not-allowed">下一页</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================================ -->
    <!-- Tab: 工作负载                                                 -->
    <!-- ============================================================ -->
    <div x-show="activeTab === 'workload'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0">

      <template x-if="workloadLoading">
        <div class="text-center py-16">
          <div class="animate-spin inline-block w-8 h-8 border-3 border-blue-500 border-t-transparent rounded-full mb-3"></div>
          <p class="themed-text-muted">加载工作负载数据…</p>
        </div>
      </template>

      <template x-if="!workloadLoading && workload">
        <div>
          <!-- 概览统计卡片 -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="rounded-xl shadow-sm p-5 text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
              <p class="text-xs text-white/70 mb-1 font-semibold">总座席数</p>
              <p class="text-3xl font-bold" x-text="workload.summary.total_agents"></p>
            </div>
            <div class="rounded-xl shadow-sm p-5 text-white" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
              <p class="text-xs text-white/70 mb-1 font-semibold">在岗座席</p>
              <p class="text-3xl font-bold" x-text="workload.summary.active_agents"></p>
              <p class="text-xs text-white/60 mt-1" x-show="workload.summary.inactive_agents > 0" x-text="workload.summary.inactive_agents + ' 人离线'"></p>
            </div>
            <div class="rounded-xl shadow-sm p-5 text-white" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
              <p class="text-xs text-white/70 mb-1 font-semibold">当前负载 / 总容量</p>
              <p class="text-3xl font-bold">
                <span x-text="workload.summary.total_load"></span>
                <span class="text-lg text-white/60 font-normal"> / <span x-text="workload.summary.total_capacity"></span></span>
              </p>
            </div>
            <div class="rounded-xl shadow-sm p-5 text-white" :style="workload.summary.overall_load_percentage >= 80 ? 'background: linear-gradient(135deg, #f5576c 0%, #ff6a88 100%)' : workload.summary.overall_load_percentage >= 50 ? 'background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' : 'background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'">
              <p class="text-xs text-white/70 mb-1 font-semibold">总体负载率</p>
              <p class="text-3xl font-bold" x-text="workload.summary.overall_load_percentage + '%'"></p>
              <div class="mt-2 w-full bg-white/20 rounded-full load-bar">
                <div class="load-bar rounded-full bg-white/80" :style="'width: ' + Math.min(workload.summary.overall_load_percentage, 100) + '%'"></div>
              </div>
            </div>
          </div>

          <!-- 各座席负载详情 -->
          <div class="themed-card rounded-xl shadow-sm overflow-hidden">
            <div class="px-5 py-3 flex justify-between items-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
              <h3 class="text-white font-medium text-sm flex items-center gap-2">📊 各座席工作负载</h3>
              <button @click="loadWorkload()" class="px-3 py-1.5 rounded-lg text-xs bg-white/20 text-white hover:bg-white/30 transition-colors" :disabled="workloadLoading">🔄 刷新</button>
            </div>
            <div class="p-5">
              <div class="space-y-3">
                <template x-for="a in workload.agents" :key="a.customer_service_agent_id">
                  <div class="flex items-center gap-4 p-4 rounded-xl border themed-border-light hover:shadow-sm transition-shadow" :class="a.status !== 'active' ? 'opacity-60' : ''">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-bold flex-shrink-0" style="background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);" x-text="(a.display_name || '?')[0]"></div>
                    <div class="w-32 flex-shrink-0">
                      <div class="font-medium text-sm" x-text="a.display_name"></div>
                      <div class="flex items-center gap-1 mt-0.5">
                        <span class="w-2 h-2 rounded-full" :class="a.status === 'active' ? 'bg-green-500 pulse-dot' : a.status === 'on_break' ? 'bg-yellow-500' : 'bg-gray-400'"></span>
                        <span class="text-xs themed-text-muted" x-text="agentStatusText(a.status)"></span>
                      </div>
                    </div>
                    <div class="flex-1">
                      <div class="flex justify-between text-xs themed-text-muted mb-1.5">
                        <span>活跃会话: <span class="font-medium" x-text="a.real_active_sessions"></span> / <span x-text="a.max_concurrent_sessions"></span></span>
                        <span class="font-semibold" :class="a.load_percentage >= 80 ? 'text-red-600' : a.load_percentage >= 50 ? 'text-yellow-600' : 'text-green-600'" x-text="a.load_percentage + '%'"></span>
                      </div>
                      <div class="w-full bg-gray-200 rounded-full load-bar">
                        <div class="load-bar rounded-full" :class="loadBarClass(a.load_percentage)" :style="'width: ' + Math.min(a.load_percentage, 100) + '%'"></div>
                      </div>
                    </div>
                    <div class="text-right text-xs themed-text-muted w-24 flex-shrink-0 space-y-0.5">
                      <div>累计 <span class="font-medium themed-text" x-text="a.total_sessions_handled"></span></div>
                      <div>满意度 <span class="font-medium" :class="a.average_satisfaction_score >= 4 ? 'text-green-600' : ''" x-text="a.average_satisfaction_score > 0 ? a.average_satisfaction_score.toFixed(1) : '-'"></span></div>
                    </div>
                  </div>
                </template>
                <template x-if="workload.agents.length === 0">
                  <div class="text-center py-12 themed-text-muted">暂无座席数据</div>
                </template>
              </div>
            </div>
          </div>
        </div>
      </template>
    </div>

    <!-- ============================================================ -->
    <!-- Tab: 用户分配                                                 -->
    <!-- ============================================================ -->
    <div x-show="activeTab === 'assignments'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0">

      <!-- 筛选工具栏 -->
      <div class="themed-card rounded-xl shadow-sm p-4 mb-4 border-l-4 border-indigo-400">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="flex flex-wrap items-center gap-3">
            <select x-model="assignmentFilter.agent_id" @change="filterAssignments()" class="px-3 py-2 border themed-border-light rounded-lg text-sm themed-bg themed-text">
              <option value="">全部座席</option>
              <template x-for="agent in agents" :key="agent.customer_service_agent_id">
                <option :value="agent.customer_service_agent_id" x-text="agent.display_name"></option>
              </template>
            </select>
            <select x-model="assignmentFilter.status" @change="filterAssignments()" class="px-3 py-2 border themed-border-light rounded-lg text-sm themed-bg themed-text">
              <option value="">全部状态</option>
              <option value="active">🟢 生效中</option>
              <option value="expired">⚪ 已过期</option>
              <option value="transferred">🔄 已转移</option>
            </select>
            <div class="flex items-center">
              <div class="relative">
                <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input x-model="assignmentFilter.search" @keyup.enter="filterAssignments()" placeholder="搜索手机号 / 用户昵称…" class="pl-9 pr-4 py-2 border themed-border-light rounded-l-lg text-sm themed-bg themed-text w-52" />
              </div>
              <button @click="filterAssignments()" class="px-4 py-2 rounded-r-lg text-sm font-medium flex items-center gap-1.5 whitespace-nowrap bg-indigo-500 text-white hover:bg-indigo-600 transition-colors border border-indigo-500">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                搜索
              </button>
              <button x-show="assignmentFilter.search || assignmentFilter.agent_id || assignmentFilter.status" @click="assignmentFilter.search = ''; assignmentFilter.agent_id = ''; assignmentFilter.status = 'active'; filterAssignments()" class="ml-2 px-3 py-2 rounded-lg text-sm text-gray-500 hover:text-red-500 hover:bg-red-50 transition-colors" title="清除筛选">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
          </div>
          <div class="flex gap-2">
            <button @click="openAssignUser()" class="themed-btn-primary px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-1.5 shadow-sm">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
              分配用户
            </button>
            <button @click="openBatchAssign()" class="px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-1.5 border themed-border-light hover:themed-bg-base themed-text-secondary">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
              批量分配
            </button>
          </div>
        </div>
        <div class="mt-3 p-2.5 rounded-lg bg-indigo-50/60 border border-indigo-100">
          <p class="text-xs text-indigo-600 flex items-start gap-1.5">
            <span class="flex-shrink-0 mt-0.5">💡</span>
            <span><strong>操作指南：</strong>输入用户手机号或昵称点击「搜索」查找分配记录。点击「分配用户」将用户绑定到客服座席——重新分配会自动将旧分配标记为「已转移」。</span>
          </p>
        </div>
      </div>

      <!-- 分配表格 -->
      <div class="themed-card rounded-xl shadow-sm overflow-hidden">
        <div class="px-5 py-3 flex justify-between items-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <h3 class="text-white font-medium text-sm flex items-center gap-2">🔗 用户分配记录</h3>
          <span class="text-white/70 text-xs" x-text="'共 ' + assignmentPagination.total + ' 条记录'"></span>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr style="background: linear-gradient(135deg, #f0f3fa 0%, #e8ecf5 100%);">
                <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 tracking-wider">用户</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 tracking-wider">分配到客服</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 tracking-wider">状态</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 tracking-wider">分配人</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 tracking-wider">备注</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 tracking-wider">分配时间</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 tracking-wider">操作</th>
              </tr>
            </thead>
            <tbody class="divide-y themed-divide">
              <template x-if="assignmentsLoading">
                <tr><td colspan="7" class="px-5 py-12 text-center">
                  <div class="animate-spin inline-block w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full mb-2"></div>
                  <p class="themed-text-muted text-sm">加载中…</p>
                </td></tr>
              </template>
              <template x-if="!assignmentsLoading && assignments.length === 0">
                <tr><td colspan="7" class="px-5 py-16 text-center">
                  <div class="text-5xl mb-3 opacity-40">🔗</div>
                  <p class="themed-text-muted font-medium mb-1">暂无用户分配记录</p>
                  <p class="text-xs themed-text-muted mb-4">将用户分配到客服后，该用户咨询时会自动路由到指定客服</p>
                  <button @click="openAssignUser()" class="themed-btn-primary px-4 py-2 rounded-lg text-sm font-medium inline-flex items-center gap-1.5 shadow-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                    分配第一个用户
                  </button>
                </td></tr>
              </template>
              <template x-for="a in assignments" :key="a.customer_service_user_assignment_id">
                <tr class="agent-row hover:themed-bg-base">
                  <td class="px-5 py-3.5">
                    <div class="font-medium" x-text="a.user?.nickname || '-'"></div>
                    <div class="text-xs themed-text-muted font-mono" x-text="a.user?.mobile || ''"></div>
                  </td>
                  <td class="px-4 py-3.5">
                    <div class="flex items-center gap-2">
                      <div class="w-7 h-7 rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" x-text="(a.agent?.display_name || '?')[0]"></div>
                      <span class="font-medium text-sm" x-text="a.agent?.display_name || '-'"></span>
                    </div>
                  </td>
                  <td class="px-4 py-3.5 text-center">
                    <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium"
                      :class="a.status === 'active' ? 'bg-green-50 text-green-700 border border-green-200' : a.status === 'transferred' ? 'bg-blue-50 text-blue-700 border border-blue-200' : 'bg-gray-100 text-gray-500 border border-gray-200'"
                      x-text="assignmentStatusText(a.status)"></span>
                  </td>
                  <td class="px-4 py-3.5 text-xs themed-text-muted" x-text="a.assigner?.nickname || '-'"></td>
                  <td class="px-4 py-3.5 text-xs themed-text-muted max-w-[200px] truncate" x-text="a.notes || '-'" :title="a.notes || ''"></td>
                  <td class="px-4 py-3.5 text-xs themed-text-muted" x-text="formatDate(a.created_at)"></td>
                  <td class="px-4 py-3.5 text-center">
                    <button x-show="a.status === 'active'" @click="removeAssignment(a)" class="p-1.5 rounded hover:bg-red-50 text-red-400 hover:text-red-600" title="解除分配">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6"/></svg>
                    </button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <!-- 分页 -->
        <div class="px-5 py-3 border-t themed-border-light flex justify-between items-center text-sm themed-text-muted" x-show="assignmentPagination.total_pages > 1">
          <span>共 <span x-text="assignmentPagination.total" class="font-medium"></span> 条</span>
          <div class="flex items-center gap-1">
            <button @click="assignmentGoToPage(assignmentPagination.current_page - 1)" :disabled="assignmentPagination.current_page <= 1" class="px-3 py-1.5 border themed-border-light rounded-lg hover:themed-bg-base disabled:opacity-40 disabled:cursor-not-allowed">上一页</button>
            <span class="px-3 py-1.5 text-sm font-medium" x-text="assignmentPagination.current_page + ' / ' + assignmentPagination.total_pages"></span>
            <button @click="assignmentGoToPage(assignmentPagination.current_page + 1)" :disabled="assignmentPagination.current_page >= assignmentPagination.total_pages" class="px-3 py-1.5 border themed-border-light rounded-lg hover:themed-bg-base disabled:opacity-40 disabled:cursor-not-allowed">下一页</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================================ -->
    <!-- Modal: 座席新建/编辑                                          -->
    <!-- ============================================================ -->
    <div x-show="showAgentModal" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showAgentModal = false">
      <div class="themed-card rounded-2xl w-full max-w-md shadow-xl" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" @click.stop>
        <div class="px-6 py-4 border-b themed-border-light" style="background: linear-gradient(135deg, #eef2fb 0%, #e8ecf5 60%, #f5f7fb 100%); border-radius: 1rem 1rem 0 0;">
          <h3 class="text-lg font-semibold" x-text="agentModalMode === 'create' ? '📝 注册客服座席' : '✏️ 编辑座席配置'"></h3>
          <p class="text-xs themed-text-muted mt-0.5" x-text="agentModalMode === 'create' ? '输入手机号查找用户，将其注册为客服座席' : '修改客服座席的配置参数'"></p>
        </div>
        <div class="p-6 space-y-4">
          <!-- 手机号查找用户（仅新建） -->
          <div x-show="agentModalMode === 'create'">
            <label class="block text-sm font-medium themed-text mb-1.5">手机号码 <span class="text-red-500">*</span></label>
            <div class="relative">
              <input x-model="agentForm.mobile" type="tel" maxlength="11"
                @blur="lookupUserForAgent()" @keyup.enter="lookupUserForAgent()"
                class="w-full pl-10 pr-4 py-2.5 border themed-border-light rounded-lg text-sm themed-bg themed-text focus:ring-2 focus:ring-blue-300 focus:border-blue-400 outline-none font-mono tracking-wider"
                placeholder="输入用户手机号，如 13612227930" />
              <svg class="w-4 h-4 absolute left-3.5 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
            </div>
            <!-- 查找中状态 -->
            <div x-show="lookupLoading" class="mt-2 text-xs text-blue-500 flex items-center gap-1">
              <div class="animate-spin w-3 h-3 border border-blue-500 border-t-transparent rounded-full"></div>
              正在查找用户…
            </div>
            <!-- 找到用户预览 -->
            <div x-show="lookedUpUser && !lookupLoading" class="mt-2 user-preview">
              <div class="flex items-center gap-3 p-3 rounded-lg border" :class="lookedUpUser?.is_already_agent ? 'border-yellow-300 bg-yellow-50' : 'border-green-300 bg-green-50'">
                <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0" style="background: linear-gradient(135deg, #3b82f6, #8b5cf6);" x-text="(lookedUpUser?.nickname || '?')[0]"></div>
                <div class="flex-1 min-w-0">
                  <div class="text-sm font-medium" x-text="lookedUpUser?.nickname"></div>
                  <div class="text-xs text-gray-500 font-mono" x-text="lookedUpUser?.mobile"></div>
                </div>
                <span x-show="!lookedUpUser?.is_already_agent" class="text-xs text-green-600 font-medium flex-shrink-0">✅ 可注册</span>
                <span x-show="lookedUpUser?.is_already_agent" class="text-xs text-yellow-600 font-medium flex-shrink-0">⚠️ 已是座席</span>
              </div>
            </div>
            <!-- 查找失败 -->
            <div x-show="lookupError && !lookupLoading" class="mt-2 text-xs text-red-500" x-text="lookupError"></div>
          </div>
          <!-- 编辑模式显示用户信息 -->
          <div x-show="agentModalMode === 'edit' && lookedUpUser" class="flex items-center gap-3 p-3 rounded-lg bg-gray-50 border themed-border-light">
            <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold" style="background: linear-gradient(135deg, #3b82f6, #8b5cf6);" x-text="(lookedUpUser?.nickname || '?')[0]"></div>
            <div>
              <div class="text-sm font-medium" x-text="lookedUpUser?.nickname"></div>
              <div class="text-xs text-gray-500 font-mono" x-text="lookedUpUser?.mobile || agentForm.mobile"></div>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text mb-1.5">显示名称 <span class="text-red-500">*</span></label>
            <input x-model="agentForm.display_name" class="w-full px-3.5 py-2.5 border themed-border-light rounded-lg text-sm themed-bg themed-text focus:ring-2 focus:ring-blue-300 focus:border-blue-400 outline-none" placeholder="客服在工作台和用户端的显示名称" />
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium themed-text mb-1.5">最大并发会话</label>
              <input x-model="agentForm.max_concurrent_sessions" type="number" min="1" max="50" class="w-full px-3.5 py-2.5 border themed-border-light rounded-lg text-sm themed-bg themed-text focus:ring-2 focus:ring-blue-300 focus:border-blue-400 outline-none" />
            </div>
            <div>
              <label class="block text-sm font-medium themed-text mb-1.5">优先级</label>
              <input x-model="agentForm.priority" type="number" min="0" class="w-full px-3.5 py-2.5 border themed-border-light rounded-lg text-sm themed-bg themed-text focus:ring-2 focus:ring-blue-300 focus:border-blue-400 outline-none" />
              <p class="text-xs themed-text-muted mt-1">数值越大越优先分配</p>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text mb-1.5">擅长领域</label>
            <input x-model="agentForm.specialty" class="w-full px-3.5 py-2.5 border themed-border-light rounded-lg text-sm themed-bg themed-text focus:ring-2 focus:ring-blue-300 focus:border-blue-400 outline-none" placeholder="逗号分隔，例：售前咨询,技术支持" />
          </div>
          <div x-show="agentModalMode === 'edit'">
            <label class="block text-sm font-medium themed-text mb-1.5">状态</label>
            <select x-model="agentForm.status" class="w-full px-3.5 py-2.5 border themed-border-light rounded-lg text-sm themed-bg themed-text focus:ring-2 focus:ring-blue-300 focus:border-blue-400 outline-none">
              <option value="active">🟢 在岗</option>
              <option value="inactive">⚪ 离线</option>
              <option value="on_break">🟡 休息中</option>
            </select>
          </div>
          <label class="flex items-center gap-2.5 cursor-pointer">
            <input x-model="agentForm.is_auto_assign_enabled" type="checkbox" class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
            <span class="text-sm themed-text">参与自动分配（关闭后只能手动将会话分配给该客服）</span>
          </label>
        </div>
        <div class="px-6 py-4 border-t themed-border-light flex justify-end gap-3" style="background: linear-gradient(to right, #f5f7fb, #edf0f8); border-radius: 0 0 1rem 1rem;">
          <button @click="showAgentModal = false" class="px-4 py-2.5 border themed-border-light rounded-lg text-sm hover:themed-bg-base themed-text-secondary">取消</button>
          <button @click="submitAgentForm()" :disabled="agentFormSubmitting || (agentModalMode === 'create' && (!lookedUpUser || lookedUpUser.is_already_agent))" class="themed-btn-primary px-5 py-2.5 rounded-lg text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed">
            <span x-text="agentFormSubmitting ? '提交中…' : (agentModalMode === 'create' ? '确认注册' : '保存修改')"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- ============================================================ -->
    <!-- Modal: 单个用户分配                                           -->
    <!-- ============================================================ -->
    <div x-show="showAssignModal" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showAssignModal = false">
      <div class="themed-card rounded-2xl w-full max-w-md shadow-xl" @click.stop>
        <div class="px-6 py-4 border-b themed-border-light" style="background: linear-gradient(135deg, #eef2fb 0%, #e8ecf5 60%, #f5f7fb 100%); border-radius: 1rem 1rem 0 0;">
          <h3 class="text-lg font-semibold">🔗 分配用户到客服</h3>
          <p class="text-xs themed-text-muted mt-0.5">输入用户手机号，选择客服座席，完成绑定</p>
        </div>
        <div class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium themed-text mb-1.5">用户手机号 <span class="text-red-500">*</span></label>
            <div class="relative">
              <input x-model="assignForm.mobile" type="tel" maxlength="11"
                @blur="lookupUserForAssign()" @keyup.enter="lookupUserForAssign()"
                class="w-full pl-10 pr-4 py-2.5 border themed-border-light rounded-lg text-sm themed-bg themed-text focus:ring-2 focus:ring-blue-300 focus:border-blue-400 outline-none font-mono tracking-wider"
                placeholder="输入要分配的用户手机号" />
              <svg class="w-4 h-4 absolute left-3.5 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
            </div>
            <div x-show="assignLookupLoading" class="mt-2 text-xs text-blue-500 flex items-center gap-1">
              <div class="animate-spin w-3 h-3 border border-blue-500 border-t-transparent rounded-full"></div>
              正在查找用户…
            </div>
            <div x-show="assignLookedUpUser && !assignLookupLoading" class="mt-2 user-preview">
              <div class="flex items-center gap-3 p-3 rounded-lg border border-green-300 bg-green-50">
                <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0" style="background: linear-gradient(135deg, #3b82f6, #8b5cf6);" x-text="(assignLookedUpUser?.nickname || '?')[0]"></div>
                <div>
                  <div class="text-sm font-medium" x-text="assignLookedUpUser?.nickname"></div>
                  <div class="text-xs text-gray-500 font-mono" x-text="assignLookedUpUser?.mobile"></div>
                </div>
              </div>
            </div>
            <div x-show="assignLookupError && !assignLookupLoading" class="mt-2 text-xs text-red-500" x-text="assignLookupError"></div>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text mb-1.5">分配到客服座席 <span class="text-red-500">*</span></label>
            <select x-model="assignForm.agent_id" class="w-full px-3.5 py-2.5 border themed-border-light rounded-lg text-sm themed-bg themed-text focus:ring-2 focus:ring-blue-300 focus:border-blue-400 outline-none">
              <option value="">请选择座席</option>
              <template x-for="agent in agents" :key="agent.customer_service_agent_id">
                <option :value="agent.customer_service_agent_id" x-text="agent.display_name + ' (' + agentStatusText(agent.status) + ')'"></option>
              </template>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text mb-1.5">备注</label>
            <textarea x-model="assignForm.notes" class="w-full px-3.5 py-2.5 border themed-border-light rounded-lg text-sm themed-bg themed-text focus:ring-2 focus:ring-blue-300 focus:border-blue-400 outline-none resize-none" rows="2" placeholder="可选，说明分配原因"></textarea>
          </div>
        </div>
        <div class="px-6 py-4 border-t themed-border-light flex justify-end gap-3" style="background: linear-gradient(to right, #f5f7fb, #edf0f8); border-radius: 0 0 1rem 1rem;">
          <button @click="showAssignModal = false" class="px-4 py-2.5 border themed-border-light rounded-lg text-sm hover:themed-bg-base themed-text-secondary">取消</button>
          <button @click="submitAssignment()" :disabled="assignFormSubmitting" class="themed-btn-primary px-5 py-2.5 rounded-lg text-sm font-medium disabled:opacity-50">
            <span x-text="assignFormSubmitting ? '提交中…' : '确认分配'"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- ============================================================ -->
    <!-- Modal: 批量分配                                               -->
    <!-- ============================================================ -->
    <div x-show="showBatchAssignModal" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showBatchAssignModal = false">
      <div class="themed-card rounded-2xl w-full max-w-md shadow-xl" @click.stop>
        <div class="px-6 py-4 border-b themed-border-light" style="background: linear-gradient(135deg, #eef2fb 0%, #e8ecf5 60%, #f5f7fb 100%); border-radius: 1rem 1rem 0 0;">
          <h3 class="text-lg font-semibold">👥 批量分配用户</h3>
          <p class="text-xs themed-text-muted mt-0.5">输入多个手机号，一次性分配到同一个客服座席</p>
        </div>
        <div class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium themed-text mb-1.5">用户手机号列表 <span class="text-red-500">*</span></label>
            <textarea x-model="batchAssignForm.mobiles_text" class="w-full px-3.5 py-2.5 border themed-border-light rounded-lg text-sm themed-bg themed-text focus:ring-2 focus:ring-blue-300 focus:border-blue-400 outline-none font-mono resize-none" rows="5" placeholder="每行一个手机号，或用逗号分隔&#10;例：&#10;13612227930&#10;13800138000&#10;13900139000"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text mb-1.5">分配到客服座席 <span class="text-red-500">*</span></label>
            <select x-model="batchAssignForm.agent_id" class="w-full px-3.5 py-2.5 border themed-border-light rounded-lg text-sm themed-bg themed-text focus:ring-2 focus:ring-blue-300 focus:border-blue-400 outline-none">
              <option value="">请选择座席</option>
              <template x-for="agent in agents" :key="agent.customer_service_agent_id">
                <option :value="agent.customer_service_agent_id" x-text="agent.display_name"></option>
              </template>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text mb-1.5">备注</label>
            <textarea x-model="batchAssignForm.notes" class="w-full px-3.5 py-2.5 border themed-border-light rounded-lg text-sm themed-bg themed-text focus:ring-2 focus:ring-blue-300 focus:border-blue-400 outline-none resize-none" rows="2" placeholder="可选"></textarea>
          </div>
        </div>
        <div class="px-6 py-4 border-t themed-border-light flex justify-end gap-3" style="background: linear-gradient(to right, #f5f7fb, #edf0f8); border-radius: 0 0 1rem 1rem;">
          <button @click="showBatchAssignModal = false" class="px-4 py-2.5 border themed-border-light rounded-lg text-sm hover:themed-bg-base themed-text-secondary">取消</button>
          <button @click="submitBatchAssignment()" :disabled="batchAssignSubmitting" class="themed-btn-primary px-5 py-2.5 rounded-lg text-sm font-medium disabled:opacity-50">
            <span x-text="batchAssignSubmitting ? '提交中…' : '确认批量分配'"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- ============================================================ -->
    <!-- Modal: 座席详情                                               -->
    <!-- ============================================================ -->
    <div x-show="showAgentDetailModal" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showAgentDetailModal = false">
      <div class="themed-card rounded-2xl w-full max-w-lg shadow-xl max-h-[85vh] flex flex-col" @click.stop>
        <div class="px-6 py-4 border-b themed-border-light flex-shrink-0" style="background: linear-gradient(135deg, #eef2fb 0%, #e8ecf5 60%, #f5f7fb 100%); border-radius: 1rem 1rem 0 0;">
          <h3 class="text-lg font-semibold">📋 座席详情</h3>
        </div>
        <div class="p-6 overflow-y-auto flex-1">
          <template x-if="agentDetailLoading">
            <div class="text-center py-8">
              <div class="animate-spin inline-block w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full"></div>
            </div>
          </template>
          <template x-if="!agentDetailLoading && agentDetail">
            <div class="space-y-5">
              <!-- 基本信息卡片 -->
              <div class="flex items-center gap-4 p-4 rounded-xl" style="background: linear-gradient(135deg, #f0f3fa 0%, #e8ecf5 100%);">
                <div class="w-14 h-14 rounded-full flex items-center justify-center text-white text-xl font-bold" style="background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);" x-text="(agentDetail.display_name || '?')[0]"></div>
                <div>
                  <div class="text-lg font-semibold" x-text="agentDetail.display_name"></div>
                  <div class="text-sm themed-text-muted" x-text="(agentDetail.user?.nickname || '') + (agentDetail.user?.mobile ? ' · ' + agentDetail.user.mobile : '')"></div>
                </div>
              </div>
              <!-- 数据指标 -->
              <div class="grid grid-cols-3 gap-3">
                <div class="text-center p-3 rounded-lg border themed-border-light">
                  <p class="text-xs themed-text-muted mb-1">状态</p>
                  <span class="inline-flex items-center gap-1 text-sm font-medium">
                    <span class="w-2 h-2 rounded-full" :class="agentDetail.status === 'active' ? 'bg-green-500' : agentDetail.status === 'on_break' ? 'bg-yellow-500' : 'bg-gray-400'"></span>
                    <span x-text="agentStatusText(agentDetail.status)"></span>
                  </span>
                </div>
                <div class="text-center p-3 rounded-lg border themed-border-light">
                  <p class="text-xs themed-text-muted mb-1">并发上限</p>
                  <p class="text-lg font-bold themed-text-primary" x-text="agentDetail.max_concurrent_sessions"></p>
                </div>
                <div class="text-center p-3 rounded-lg border themed-border-light">
                  <p class="text-xs themed-text-muted mb-1">优先级</p>
                  <p class="text-lg font-bold themed-text-primary" x-text="agentDetail.priority"></p>
                </div>
                <div class="text-center p-3 rounded-lg border themed-border-light">
                  <p class="text-xs themed-text-muted mb-1">当前会话</p>
                  <p class="text-lg font-bold" x-text="agentDetail.current_session_count"></p>
                </div>
                <div class="text-center p-3 rounded-lg border themed-border-light">
                  <p class="text-xs themed-text-muted mb-1">累计处理</p>
                  <p class="text-lg font-bold" x-text="agentDetail.total_sessions_handled"></p>
                </div>
                <div class="text-center p-3 rounded-lg border themed-border-light">
                  <p class="text-xs themed-text-muted mb-1">满意度</p>
                  <p class="text-lg font-bold" :class="agentDetail.average_satisfaction_score >= 4 ? 'text-green-600' : ''" x-text="agentDetail.average_satisfaction_score > 0 ? '⭐ ' + agentDetail.average_satisfaction_score.toFixed(1) : '-'"></p>
                </div>
              </div>
              <!-- 配置信息 -->
              <div class="rounded-lg p-4 themed-bg-base space-y-2 text-sm">
                <div class="flex justify-between"><span class="themed-text-muted">自动分配</span><span class="font-medium" :class="agentDetail.is_auto_assign_enabled ? 'text-green-600' : 'text-gray-500'" x-text="agentDetail.is_auto_assign_enabled ? '✅ 已开启' : '❌ 已关闭'"></span></div>
                <div class="flex justify-between"><span class="themed-text-muted">擅长领域</span><span class="font-medium" x-text="Array.isArray(agentDetail.specialty) && agentDetail.specialty.length > 0 ? agentDetail.specialty.join('、') : '未设置'"></span></div>
              </div>
              <!-- 分配用户列表 -->
              <div x-show="agentDetail.active_assignments && agentDetail.active_assignments.length > 0">
                <h4 class="font-medium text-sm mb-2">已分配用户（<span x-text="agentDetail.active_assignments.length"></span>）</h4>
                <div class="max-h-40 overflow-y-auto rounded-lg border themed-border-light">
                  <table class="w-full text-xs">
                    <thead class="themed-bg-base sticky top-0"><tr><th class="px-3 py-2 text-left">昵称</th><th class="px-3 py-2 text-left">手机号</th></tr></thead>
                    <tbody class="divide-y themed-divide">
                      <template x-for="a in agentDetail.active_assignments" :key="a.customer_service_user_assignment_id">
                        <tr class="hover:themed-bg-base"><td class="px-3 py-2" x-text="a.user?.nickname || '-'"></td><td class="px-3 py-2 font-mono" x-text="a.user?.mobile || '-'"></td></tr>
                      </template>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </template>
        </div>
        <div class="px-6 py-4 border-t themed-border-light flex justify-end flex-shrink-0" style="background: linear-gradient(to right, #f5f7fb, #edf0f8); border-radius: 0 0 1rem 1rem;">
          <button @click="showAgentDetailModal = false" class="px-4 py-2.5 border themed-border-light rounded-lg text-sm hover:themed-bg-base themed-text-secondary">关闭</button>
        </div>
      </div>
    </div>

  </div>

  <script type="module" src="./src/modules/content/pages/cs-agent-management.js"></script>
</body>
</html>
