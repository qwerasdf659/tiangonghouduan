<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '操作审计', 
    pageStyle: '[x-cloak] { display: none !important; } .log-row { transition: all 0.2s ease; } .log-row:hover { background-color: #f8fafc; } .action-create { background-color: #dcfce7; color: #166534; } .action-update { background-color: #dbeafe; color: #1e40af; } .action-delete { background-color: #fee2e2; color: #991b1b; } .action-login { background-color: #e0e7ff; color: #3730a3; } .action-logout { background-color: #f3f4f6; color: #374151; }' 
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen">
  
  <!-- 导航栏 -->
  <nav class="page-navbar">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="text-white/70 hover:text-white transition-colors">← 返回工作台</a>
        <span class="text-lg font-semibold">📋 操作审计</span>
      </div>
      <div class="flex items-center space-x-4">
        <span x-data x-text="Alpine.store('auth')?.user_info?.nickname ? `欢迎，${Alpine.store('auth').user_info.nickname}` : '欢迎，管理员'"></span>
      </div>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-6" x-data="auditLogsPage()" x-init="init()" x-cloak>
    
    <!-- 页面标题和操作 -->
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-2xl font-bold themed-text-primary">📋 操作审计</h1>
        <p class="text-sm themed-text-muted mt-1">查看系统操作记录和审计报告</p>
      </div>
      <div class="flex items-center gap-3">
        <template x-if="activeTab === 'logs'">
          <button 
            @click="exportAuditLogs()"
            class="flex items-center gap-2 px-4 py-2 border themed-border rounded-lg text-sm themed-text-secondary hover:themed-bg-base transition"
          >
            📤 导出日志
          </button>
        </template>
        <button 
          @click="activeTab === 'logs' ? loadAuditLogs() : refreshReport()"
          :disabled="loading || reportLoading"
          class="flex items-center gap-2 px-4 py-2 themed-bg-primary text-white rounded-lg text-sm font-medium themed-hover-primary transition"
        >
          <span :class="(loading || reportLoading) && 'animate-spin'">🔄</span>
          刷新
        </button>
      </div>
    </div>

    <!-- Tab 切换栏 -->
    <div class="flex border-b themed-border mb-6">
      <button
        @click="switchTab('logs')"
        :class="activeTab === 'logs' ? 'border-b-2 border-blue-500 text-blue-600 font-medium' : 'themed-text-muted hover:themed-text-secondary'"
        class="px-6 py-3 text-sm transition"
      >
        📋 日志列表
      </button>
      <button
        @click="switchTab('report')"
        :class="activeTab === 'report' ? 'border-b-2 border-blue-500 text-blue-600 font-medium' : 'themed-text-muted hover:themed-text-secondary'"
        class="px-6 py-3 text-sm transition"
      >
        📊 审计报告
      </button>
    </div>

    <!-- ==================== 日志列表 Tab ==================== -->
    <template x-if="activeTab === 'logs'">
      <div>
    <!-- 统计卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
      <div class="gradient-stat-card gradient-stat-blue">
        <div class="stat-icon">📊</div>
        <div class="stat-value" x-text="logPagination.total || 0"></div>
        <div class="stat-label">总日志数</div>
      </div>
      <div class="gradient-stat-card gradient-stat-green">
        <div class="stat-icon">➕</div>
        <div class="stat-value" x-text="stats.create || 0"></div>
        <div class="stat-label">创建操作</div>
      </div>
      <div class="gradient-stat-card gradient-stat-cyan">
        <div class="stat-icon">✏️</div>
        <div class="stat-value" x-text="stats.update || 0"></div>
        <div class="stat-label">更新操作</div>
      </div>
      <div class="gradient-stat-card gradient-stat-rose">
        <div class="stat-icon">🗑️</div>
        <div class="stat-value" x-text="stats.delete || 0"></div>
        <div class="stat-label">删除操作</div>
      </div>
      <div class="gradient-stat-card gradient-stat-purple">
        <div class="stat-icon">🔐</div>
        <div class="stat-value" x-text="stats.login || 0"></div>
        <div class="stat-label">登录操作</div>
      </div>
    </div>

    <!-- 图表区域 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <!-- 操作趋势图 -->
      <div class="chart-wrapper">
        <div class="chart-wrapper-header">
          <span>📈 操作趋势</span>
          <div class="flex gap-2">
            <button 
              @click="changeTrendDays(7)"
              :class="trendDays === 7 ? 'themed-bg-primary text-white' : 'border themed-border themed-text-secondary hover:themed-bg-base'"
              class="px-3 py-1 text-xs rounded-lg transition"
            >
              7天
            </button>
            <button 
              @click="changeTrendDays(14)"
              :class="trendDays === 14 ? 'themed-bg-primary text-white' : 'border themed-border themed-text-secondary hover:themed-bg-base'"
              class="px-3 py-1 text-xs rounded-lg transition"
            >
              14天
            </button>
            <button 
              @click="changeTrendDays(30)"
              :class="trendDays === 30 ? 'themed-bg-primary text-white' : 'border themed-border themed-text-secondary hover:themed-bg-base'"
              class="px-3 py-1 text-xs rounded-lg transition"
            >
              30天
            </button>
          </div>
        </div>
        <div class="chart-wrapper-body">
        <!-- 趋势图容器 -->
        <div id="trendChart" class="w-full h-64"></div>
        <!-- 趋势统计摘要 -->
        <div class="mt-4 grid grid-cols-3 gap-4 text-center text-sm" x-show="trendStats.total > 0">
          <div>
            <div class="themed-text-muted">总操作数</div>
            <div class="font-medium themed-text-primary" x-text="trendStats.total"></div>
          </div>
          <div>
            <div class="themed-text-muted">日均操作</div>
            <div class="font-medium themed-text-primary" x-text="trendStats.average_per_day"></div>
          </div>
          <div>
            <div class="themed-text-muted">峰值日期</div>
            <div class="font-medium themed-text-primary" x-text="trendStats.max_day?.date?.substring(5) || '-'"></div>
          </div>
        </div>
        <!-- 加载状态 -->
        <div x-show="chartsLoading" class="flex items-center justify-center h-64">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 themed-border-primary"></div>
        </div>
        <!-- 空状态 -->
        <div x-show="!chartsLoading && trendStats.items.length === 0" class="flex items-center justify-center h-64 text-gray-400">
          暂无趋势数据
        </div>
        </div>
      </div>

      <!-- 目标类型分布图 -->
      <div class="chart-wrapper">
        <div class="chart-wrapper-header">
          <span>🎯 目标类型分布</span>
          <button 
            @click="refreshCharts()"
            class="text-xs text-gray-400 hover:text-gray-600 transition"
          >
            🔄 刷新
          </button>
        </div>
        <div class="chart-wrapper-body">
        <!-- 目标类型图容器 -->
        <div id="targetTypeChart" class="w-full h-64"></div>
        <!-- 目标类型列表 -->
        <div class="mt-4 space-y-2" x-show="targetTypeStats.items.length > 0">
          <template x-for="item in targetTypeStats.items.slice(0, 5)" :key="item.target_type">
            <div class="flex justify-between items-center text-sm">
              <span class="themed-text-secondary" x-text="item.target_type_display || item.target_type || '-'"></span>
              <div class="flex items-center gap-2">
                <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div 
                    class="h-full bg-blue-500 rounded-full"
                    :style="`width: ${item.percentage}%`"
                  ></div>
                </div>
                <span class="w-16 text-right font-medium themed-text-primary" x-text="`${item.count} (${item.percentage}%)`"></span>
              </div>
            </div>
          </template>
        </div>
        <!-- 加载状态 -->
        <div x-show="chartsLoading" class="flex items-center justify-center h-64">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 themed-border-primary"></div>
        </div>
        <!-- 空状态 -->
        <div x-show="!chartsLoading && targetTypeStats.items.length === 0" class="flex items-center justify-center h-64 text-gray-400">
          暂无类型数据
        </div>
        </div>
      </div>
    </div>

    <!-- 筛选栏 -->
    <div class="filter-toolbar">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
        <div>
          <label class="block text-sm font-medium themed-text-secondary mb-1">操作人ID</label>
          <input 
            type="text" 
            class="w-full border rounded-lg px-3 py-2" 
            x-model="logFilters.operator_id" 
            placeholder="输入操作人ID..."
          >
        </div>
        <div>
          <label class="block text-sm font-medium themed-text-secondary mb-1">操作类型</label>
          <select class="w-full border rounded-lg px-3 py-2" x-model="logFilters.operation_type">
            <option value="">全部类型</option>
            <template x-for="type in actionTypes" :key="type.value">
              <option :value="type.value" x-text="type.label"></option>
            </template>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium themed-text-secondary mb-1">操作目标</label>
          <input 
            type="text" 
            class="w-full border rounded-lg px-3 py-2" 
            x-model="logFilters.target_type" 
            placeholder="如: User, LotteryPool..."
          >
        </div>
        <div>
          <label class="block text-sm font-medium themed-text-secondary mb-1">开始日期</label>
          <input 
            type="date" 
            class="w-full border rounded-lg px-3 py-2" 
            x-model="logFilters.start_date"
          >
        </div>
        <div>
          <label class="block text-sm font-medium themed-text-secondary mb-1">结束日期</label>
          <input 
            type="date" 
            class="w-full border rounded-lg px-3 py-2" 
            x-model="logFilters.end_date"
          >
        </div>
        <div class="flex gap-2">
          <button 
            class="flex-1 px-4 py-2 themed-bg-primary text-white rounded-lg themed-hover-primary" 
            @click="searchAuditLogs()"
          >
            🔍 搜索
          </button>
          <button 
            class="px-4 py-2 border themed-border rounded-lg themed-text-secondary hover:themed-bg-base" 
            @click="resetLogFilters()"
          >
            重置
          </button>
        </div>
      </div>
    </div>

    <!-- 加载状态 -->
    <div x-show="loading" class="text-center py-10">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 themed-border-primary mx-auto"></div>
      <p class="mt-4 themed-text-muted">正在加载审计日志...</p>
    </div>

    <!-- 日志列表（data-table） -->
    <div class="themed-card rounded-lg shadow" x-show="!loading" @table-action="handleAuditTableAction($event.detail)">
      <div x-data="dataTable({
        columns: auditTableColumns,
        dataSource: fetchAuditTableData,
        primaryKey: 'admin_operation_log_id',
        sortable: true,
        selectable: false,
        exportable: true,
        serverSort: true,
        page_size: 20,
        emptyText: '暂无审计日志'
      })" x-init="init()" @dt-audit-refresh.window="refresh()">
        <%- include('components/data-table') %>
      </div>
    </div>

      </div>
    </template>

    <!-- ==================== 审计报告 Tab ==================== -->
    <template x-if="activeTab === 'report'">
      <div :class="reportLoading ? 'opacity-50 pointer-events-none' : ''">
        
        <!-- 报告筛选 -->
        <div class="themed-card rounded-lg shadow mb-6 p-4">
          <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">时间范围</label>
              <select class="w-full border rounded-lg px-3 py-2" x-model="reportTimeRange" @change="changeReportTimeRange($event.target.value)">
                <option value="7d">近 7 天</option>
                <option value="30d">近 30 天</option>
                <option value="90d">近 90 天</option>
                <option value="custom">自定义</option>
              </select>
            </div>
            <div x-show="reportTimeRange === 'custom'">
              <label class="block text-sm font-medium themed-text-secondary mb-1">开始日期</label>
              <input type="date" class="w-full border rounded-lg px-3 py-2" x-model="reportStartDate">
            </div>
            <div x-show="reportTimeRange === 'custom'">
              <label class="block text-sm font-medium themed-text-secondary mb-1">结束日期</label>
              <input type="date" class="w-full border rounded-lg px-3 py-2" x-model="reportEndDate">
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">操作员（可选）</label>
              <select class="w-full border rounded-lg px-3 py-2" x-model.number="reportOperatorId">
                <option :value="null">全部操作员</option>
                <template x-for="op in operatorOptions" :key="op.operator_id">
                  <option :value="op.operator_id" x-text="`${op.operator_name} (${op.count}次操作)`"></option>
                </template>
              </select>
              <p class="text-xs themed-text-muted mt-1" x-show="operatorOptions.length === 0">加载报告后显示操作员列表</p>
            </div>
            <div x-show="reportTimeRange === 'custom'">
              <button @click="generateCustomReport()" class="w-full px-4 py-2 themed-bg-primary text-white rounded-lg themed-hover-primary">
                生成报告
              </button>
            </div>
          </div>
        </div>

        <!-- 报告加载状态 -->
        <template x-if="reportLoading">
          <div class="text-center py-10">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 themed-border-primary mx-auto"></div>
            <p class="mt-4 themed-text-muted">正在生成审计报告...</p>
          </div>
        </template>

        <!-- 报告汇总统计 -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6" x-show="!reportLoading">
          <div class="themed-card rounded-lg shadow p-4 text-center">
            <div class="text-3xl text-blue-500 mb-2">📊</div>
            <div class="text-2xl font-bold themed-text-primary" x-text="reportData.summary?.total_operations || 0"></div>
            <div class="text-sm themed-text-muted">总操作数</div>
          </div>
          <div class="themed-card rounded-lg shadow p-4 text-center">
            <div class="text-3xl text-red-500 mb-2">🚨</div>
            <div class="text-2xl font-bold text-red-600" x-text="reportData.summary?.high_risk_count || 0"></div>
            <div class="text-sm themed-text-muted">高风险操作</div>
          </div>
          <div class="themed-card rounded-lg shadow p-4 text-center">
            <div class="text-3xl text-orange-500 mb-2">↩️</div>
            <div class="text-2xl font-bold text-orange-600" x-text="reportData.summary?.rollback_count || 0"></div>
            <div class="text-sm themed-text-muted">可回滚操作</div>
          </div>
          <div class="themed-card rounded-lg shadow p-4 text-center">
            <div class="text-3xl text-purple-500 mb-2">👤</div>
            <div class="text-2xl font-bold text-purple-600" x-text="reportData.summary?.unique_operators || 0"></div>
            <div class="text-sm themed-text-muted">独立操作员</div>
          </div>
          <div class="themed-card rounded-lg shadow p-4 text-center">
            <div class="text-3xl text-green-500 mb-2">👥</div>
            <div class="text-2xl font-bold text-green-600" x-text="reportData.summary?.affected_users_total || 0"></div>
            <div class="text-sm themed-text-muted">影响用户数</div>
          </div>
          <div class="themed-card rounded-lg shadow p-4 text-center">
            <div class="text-3xl text-yellow-500 mb-2">💰</div>
            <div class="text-2xl font-bold text-yellow-600" x-text="reportData.summary?.affected_amount_total || 0"></div>
            <div class="text-sm themed-text-muted">影响金额</div>
          </div>
        </div>

        <!-- 报告图表 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6" x-show="!reportLoading">
          <!-- 操作类型分布 -->
          <div class="themed-card rounded-lg shadow p-4">
            <h3 class="text-base font-medium themed-text-primary mb-4">📊 操作类型分布</h3>
            <div id="reportOperationChart" class="w-full h-64"></div>
            <div x-show="!reportData.by_operation_type?.length" class="flex items-center justify-center h-64 text-gray-400">
              暂无操作类型数据
            </div>
          </div>

          <!-- 目标类型分布 -->
          <div class="themed-card rounded-lg shadow p-4">
            <h3 class="text-base font-medium themed-text-primary mb-4">🎯 目标类型分布</h3>
            <div id="reportTargetChart" class="w-full h-64"></div>
            <div x-show="!reportData.by_target_type?.length" class="flex items-center justify-center h-64 text-gray-400">
              暂无目标类型数据
            </div>
          </div>

          <!-- 风险级别分布 -->
          <div class="themed-card rounded-lg shadow p-4">
            <h3 class="text-base font-medium themed-text-primary mb-4">⚠️ 风险级别分布</h3>
            <div id="reportRiskLevelChart" class="w-full h-64"></div>
            <!-- 风险级别列表 -->
            <div class="mt-4 space-y-2" x-show="reportData.by_risk_level?.length">
              <template x-for="item in reportData.by_risk_level" :key="item.risk_level">
                <div class="flex justify-between items-center text-sm">
                  <span 
                    class="px-2 py-1 rounded text-xs font-medium"
                    :class="{
                      'bg-red-100 text-red-800': item.risk_level === 'high',
                      'bg-yellow-100 text-yellow-800': item.risk_level === 'medium',
                      'bg-green-100 text-green-800': item.risk_level === 'low'
                    }"
                    x-text="item.risk_level === 'high' ? '高风险' : item.risk_level === 'medium' ? '中风险' : '低风险'"
                  ></span>
                  <span class="font-medium themed-text-primary" x-text="`${item.count} 次`"></span>
                </div>
              </template>
            </div>
            <div x-show="!reportData.by_risk_level?.length" class="flex items-center justify-center h-64 text-gray-400">
              暂无风险级别数据
            </div>
          </div>
        </div>

        <!-- 操作趋势图 -->
        <div class="themed-card rounded-lg shadow p-4 mb-6" x-show="!reportLoading">
          <h3 class="text-base font-medium themed-text-primary mb-4">📈 操作数量趋势</h3>
          <div id="reportTrendChart" class="w-full h-64"></div>
          <div x-show="!reportData.trend?.length" class="flex items-center justify-center h-64 text-gray-400">
            暂无趋势数据
          </div>
        </div>

        <!-- 报告元数据 -->
        <div class="themed-card rounded-lg shadow p-4 text-sm themed-text-muted" x-show="!reportLoading && reportData.report_meta?.generated_at">
          <div class="flex justify-between">
            <span>报告生成时间：<span x-text="formatDateTime(reportData.report_meta?.generated_at)"></span></span>
            <span>报告时间范围：<span x-text="reportData.report_meta?.start_date"></span> 至 <span x-text="reportData.report_meta?.end_date"></span></span>
          </div>
        </div>

      </div>
    </template>

    <!-- 日志详情模态框 -->
    <div 
      x-show="selectedLog" 
      x-cloak
      class="fixed inset-0 z-50 overflow-y-auto"
      @keydown.escape.window="selectedLog = null"
    >
      <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" @click="selectedLog = null"></div>
        <div class="inline-block w-full max-w-2xl my-8 overflow-hidden text-left align-middle transition-all transform themed-card shadow-xl rounded-lg">
          <!-- 模态框头部 -->
          <div class="px-6 py-4 border-b flex justify-between items-center">
            <h3 class="text-lg font-semibold">📋 日志详情</h3>
            <button @click="selectedLog = null" class="text-gray-400 hover:text-gray-600">&times;</button>
          </div>
          
          <!-- 模态框内容 -->
          <div class="px-6 py-4" x-show="selectedLog">
            <div class="grid grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block text-sm font-medium themed-text-muted">日志ID</label>
                <p class="mt-1 text-sm" x-text="selectedLog?.log_id || selectedLog?.id || '-'"></p>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-muted">操作时间</label>
                <p class="mt-1 text-sm" x-text="formatDateTime(selectedLog?.created_at)"></p>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-muted">操作人</label>
                <p class="mt-1 text-sm" x-text="(selectedLog?.operator_name || selectedLog?.operator_id || '-') + (selectedLog?.operator_id ? ` (ID: ${selectedLog.operator_id})` : '')"></p>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-muted">操作类型</label>
                <span 
                  class="inline-block mt-1 px-2 py-1 text-xs rounded"
                  :class="getOperationTypeClass(selectedLog || {})"
                  x-text="selectedLog?.operation_type_display || selectedLog?.operation_type"
                ></span>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-muted">操作目标</label>
                <p class="mt-1 text-sm" x-text="selectedLog?.target || '-'"></p>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-muted">IP地址</label>
                <p class="mt-1 text-sm font-mono" x-text="selectedLog?.ip_address || '-'"></p>
              </div>
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium themed-text-muted">操作描述</label>
              <p class="mt-1 text-sm" x-text="selectedLog?.description || '-'"></p>
            </div>
            
            <div>
              <label class="block text-sm font-medium themed-text-muted">操作详情</label>
              <pre class="mt-1 text-xs bg-gray-50 rounded p-3 overflow-x-auto max-h-60" x-text="formatLogDetails(selectedLog?.details)"></pre>
            </div>
          </div>
          
          <!-- 模态框底部 -->
          <div class="px-6 py-4 border-t flex justify-end">
            <button 
              @click="selectedLog = null"
              class="px-4 py-2 themed-bg-primary text-white rounded-lg themed-hover-primary"
            >
              关闭
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- 脚本 -->
  <script type="module" src="/src/modules/system/pages/audit-logs.js"></script>
</body>
</html>
