<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '配置工具', 
    pageStyle: '[x-cloak] { display: none !important; }' 
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen">
  
  <!-- 导航栏 -->
  <nav class="themed-bg-primary text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="hover:text-slate-200">← 返回工作台</a>
        <span class="text-lg font-semibold">🔧 配置工具</span>
      </div>
      <div class="flex items-center space-x-4">
        <span x-text="'欢迎，' + (current_user?.nickname || '管理员')"></span>
        <button @click="logout()" class="px-3 py-1 border border-white/50 rounded hover:bg-white/10">退出登录</button>
      </div>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-6" x-data="configToolsPage()">
    <!-- 工具卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <!-- 注意：缓存管理已移除，后端不支持 /api/v4/console/config/cache/clear -->
      
      <div class="themed-card rounded-lg shadow p-6">
        <div class="text-4xl text-green-400 mb-4">📊</div>
        <h3 class="text-lg font-semibold mb-2">数据统计重算</h3>
        <p class="themed-text-muted text-sm mb-4">重新计算系统统计数据</p>
        <button @click="recalculateStats()" :disabled="recalculating" class="w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50">
          <span x-show="!recalculating">开始重算</span>
          <span x-show="recalculating">计算中...</span>
        </button>
      </div>
      
      <div class="themed-card rounded-lg shadow p-6">
        <div class="text-4xl text-orange-400 mb-4">🔍</div>
        <h3 class="text-lg font-semibold mb-2">系统诊断</h3>
        <p class="themed-text-muted text-sm mb-4">检查系统健康状态</p>
        <button @click="runDiagnostics()" :disabled="diagnosing" class="w-full px-4 py-2 themed-btn-primary rounded disabled:opacity-50">
          <span x-show="!diagnosing">开始诊断</span>
          <span x-show="diagnosing">诊断中...</span>
        </button>
      </div>
    </div>

    <!-- 数据字典管理 -->
    <div class="themed-card rounded-lg shadow mb-6">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">📖 数据字典管理</h5>
        <button @click="openAddDictModal()" class="px-4 py-2 themed-btn-primary rounded text-sm">
          ➕ 新增字典
        </button>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="themed-bg-base">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">字典代码</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">字典名称</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">字典值</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">排序</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">状态</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
            </tr>
          </thead>
          <tbody class="divide-y">
            <tr x-show="!dictionaries || dictionaries.length === 0">
              <td colspan="6" class="px-4 py-8 text-center themed-text-muted">暂无数据字典</td>
            </tr>
            <template x-for="dict in (dictionaries || [])" :key="dict.dict_id">
              <tr class="themed-hover-bg">
                <td class="px-4 py-3 text-sm font-mono" x-text="dict.dict_code"></td>
                <td class="px-4 py-3 text-sm" x-text="dict.dict_name"></td>
                <td class="px-4 py-3 text-sm" x-text="dict.dict_value"></td>
                <td class="px-4 py-3 text-sm" x-text="dict.sort_order"></td>
                <td class="px-4 py-3">
                  <span :class="dict.status === 'active' ? 'bg-green-100 themed-text-success' : 'themed-bg-subtle themed-text-secondary'" class="px-2 py-1 text-xs rounded" x-text="dict.status === 'active' ? '启用' : '禁用'"></span>
                </td>
                <td class="px-4 py-3">
                  <div class="flex space-x-2">
                    <button @click="editDict(dict)" class="themed-text-primary hover:text-blue-700 text-sm">编辑</button>
                    <button @click="deleteDict(dict)" class="text-red-500 hover:text-red-700 text-sm">删除</button>
                  </div>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>

    <!-- 系统日志 -->
    <div class="themed-card rounded-lg shadow">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">📝 最近操作日志</h5>
        <button @click="loadLogs()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 text-sm">
          🔄 刷新
        </button>
      </div>
      <div class="overflow-x-auto max-h-64">
        <table class="w-full">
          <thead class="themed-bg-base sticky top-0">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">时间</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作人</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作类型</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">描述</th>
            </tr>
          </thead>
          <tbody class="divide-y">
            <tr x-show="!logs || logs.length === 0">
              <td colspan="4" class="px-4 py-8 text-center themed-text-muted">暂无日志记录</td>
            </tr>
            <template x-for="log in (logs || [])" :key="log.admin_operation_log_id">
              <tr class="themed-hover-bg">
                <td class="px-4 py-3 text-sm themed-text-muted" x-text="formatDate(log.created_at)"></td>
                <td class="px-4 py-3 text-sm" x-text="log.operator?.nickname || log.operator_id"></td>
                <td class="px-4 py-3 text-sm" x-text="log.operation_type_display || log.operation_type"></td>
                <td class="px-4 py-3 text-sm" x-text="log.action || log.reason || '-'"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>

    <!-- 诊断结果 -->
    <div x-show="diagnosticResult" class="mt-6 themed-card rounded-lg shadow">
      <div class="p-4 border-b">
        <h5 class="font-semibold">🔍 诊断结果</h5>
      </div>
      <div class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <template x-for="(result, key) in diagnosticResult" :key="key">
            <div class="p-3 rounded border" :class="result.status === 'ok' ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'">
              <div class="flex justify-between items-center">
                <span class="font-medium" x-text="key"></span>
                <span :class="result.status === 'ok' ? 'text-green-600' : 'text-red-600'" x-text="result.status === 'ok' ? '✓ 正常' : '✗ 异常'"></span>
              </div>
              <p class="text-sm themed-text-muted mt-1" x-text="result.message"></p>
            </div>
          </template>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== Modal 组件区域 ==================== -->

  <!-- 注意：缓存管理 Modal 已移除，后端不支持 /api/v4/console/config/cache/clear -->

  <!-- 功能开关 Modal -->
  <div x-ref="featureFlagsModal"
       x-show="isModalOpen('featureFlagsModal')"
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center"
       style="display: none;">
    <div class="fixed inset-0 bg-black/50" @click="hideModal('featureFlagsModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-lg mx-4 z-10 max-h-[80vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center sticky top-0 themed-card">
        <h5 class="font-semibold">🎛️ 功能开关</h5>
        <button @click="hideModal('featureFlagsModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
      </div>
      <div class="p-6 space-y-4">
        <template x-for="flag in featureFlags" :key="flag.key">
          <div class="flex items-center justify-between p-3 themed-bg-base rounded-lg">
            <div>
              <div class="font-medium" x-text="flag.name"></div>
              <div class="text-sm themed-text-muted" x-text="flag.description"></div>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" x-model="flag.enabled" @change="toggleFeatureFlag(flag)" class="sr-only peer">
              <div class="w-11 h-6 themed-bg-muted peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:themed-bg-primary"></div>
            </label>
          </div>
        </template>
      </div>
      <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end">
        <button @click="hideModal('featureFlagsModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded-lg hover:bg-gray-300">关闭</button>
      </div>
    </div>
  </div>

  <!-- 4. 维护模式 Modal -->
  <div x-ref="maintenanceModal"
       x-show="isModalOpen('maintenanceModal')"
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center"
       style="display: none;">
    <div class="fixed inset-0 bg-black/50" @click="hideModal('maintenanceModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-md mx-4 z-10">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">🔧 维护模式</h5>
        <button @click="hideModal('maintenanceModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
      </div>
      <form @submit.prevent="toggleMaintenanceMode()">
        <div class="p-6 space-y-4">
          <div class="text-center mb-4">
            <div class="text-6xl mb-3" x-text="maintenanceMode ? '🔓' : '🔒'"></div>
            <p class="font-medium" x-text="maintenanceMode ? '系统当前处于维护模式' : '系统当前正常运行'"></p>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">维护提示信息</label>
            <textarea x-model="maintenanceForm.message" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-slate-500" rows="3" placeholder="系统正在维护中，请稍后再试..."></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">预计恢复时间</label>
            <input type="datetime-local" x-model="maintenanceForm.end_time" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-slate-500">
          </div>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-3">
          <button type="button" @click="hideModal('maintenanceModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded-lg hover:bg-gray-300">取消</button>
          <button type="submit" class="px-4 py-2 text-white rounded-lg disabled:opacity-50" :class="maintenanceMode ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'" :disabled="submitting">
            <span x-text="maintenanceMode ? '关闭维护' : '开启维护'"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 5. 添加配置 Modal -->
  <!-- 添加/编辑字典模态框 -->
  <div x-ref="addDictModal"
       x-show="isModalOpen('addDictModal')"
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center"
       style="display: none;">
    <div class="fixed inset-0 bg-black/50" @click="hideModal('addDictModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-md mx-4 z-10">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold" x-text="editingDictId ? '✏️ 编辑字典' : '➕ 新增字典'"></h5>
        <button @click="hideModal('addDictModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
      </div>
      <form @submit.prevent="submitDict()">
        <div class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">字典代码 <span class="text-red-500">*</span></label>
            <input type="text" x-model="dictForm.dict_code" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-slate-500" required placeholder="dict_code" :disabled="!!editingDictId">
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">字典名称 <span class="text-red-500">*</span></label>
            <input type="text" x-model="dictForm.dict_name" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-slate-500" required placeholder="字典名称">
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">字典值</label>
            <textarea x-model="dictForm.dict_value" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-slate-500" rows="2" placeholder="字典值/描述"></textarea>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">排序</label>
              <input type="number" x-model="dictForm.sort_order" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-slate-500" placeholder="0">
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">字典类型</label>
              <select x-model="dictForm.dict_type" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-slate-500">
                <option value="category">分类</option>
                <option value="rarity">稀有度</option>
                <option value="asset_group">资产组</option>
              </select>
            </div>
          </div>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-3">
          <button type="button" @click="hideModal('addDictModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded-lg hover:bg-gray-300">取消</button>
          <button type="submit" class="px-4 py-2 themed-btn-primary rounded-lg disabled:opacity-50" :disabled="submitting">
            <span x-text="editingDictId ? '保存修改' : '新增字典'"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 添加配置模态框 -->
  <div x-ref="addConfigModal"
       x-show="isModalOpen('addConfigModal')"
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center"
       style="display: none;">
    <div class="fixed inset-0 bg-black/50" @click="hideModal('addConfigModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-md mx-4 z-10">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">➕ 添加配置</h5>
        <button @click="hideModal('addConfigModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
      </div>
      <form @submit.prevent="submitAddConfig()">
        <div class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">配置键 <span class="text-red-500">*</span></label>
            <input type="text" x-model="configForm.key" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-slate-500" required placeholder="config_key">
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">配置值 <span class="text-red-500">*</span></label>
            <textarea x-model="configForm.value" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-slate-500" rows="3" required></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">配置说明</label>
            <input type="text" x-model="configForm.description" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-slate-500" placeholder="配置项说明...">
          </div>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-3">
          <button type="button" @click="hideModal('addConfigModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded-lg hover:bg-gray-300">取消</button>
          <button type="submit" class="px-4 py-2 themed-btn-primary rounded-lg disabled:opacity-50" :disabled="submitting">保存配置</button>
        </div>
      </form>
    </div>
  </div>

  <%- include('partials/footer') %>



  <script type="module" src="./src/modules/system/pages/config-tools.js"></script>
</body>
</html>
