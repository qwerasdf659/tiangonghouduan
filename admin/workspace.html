<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†åå° - æŠ½å¥–ç³»ç»Ÿå·¥ä½œå°</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/admin/favicon.svg">
  
  <!-- æ³¨æ„ï¼šæ ·å¼é€šè¿‡ JS æ¨¡å—å¯¼å…¥ï¼Œæ— éœ€å¤–éƒ¨é“¾æ¥ -->
  
  <!-- è‡ªå®šä¹‰æ ·å¼ - ç¡®ä¿å¸ƒå±€å˜é‡å¯ç”¨ -->
  <style>
    /* å¸ƒå±€å˜é‡ï¼ˆä» variables.css å¤åˆ¶ä»¥ç¡®ä¿å…¼å®¹æ€§ï¼‰ */
    :root {
      --sidebar-width: 260px;
      --sidebar-collapsed-width: 72px;
      --header-height: 56px;
      --tab-bar-height: 40px;
    }
    
    /* åŠ è½½ä¸­çŠ¶æ€ */
    .workspace-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: var(--content-bg, #f3f4f6);
    }
    
    .workspace-loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e2e8f0;
      border-top-color: var(--primary, #3b82f6);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* éšè—æœªåˆå§‹åŒ–çš„ Alpine å…ƒç´  */
    [x-cloak] { display: none !important; }
  </style>
  
  <!-- é˜²æ­¢ workspace è¢«åµŒå¥—åœ¨ iframe ä¸­å¯¼è‡´é‡å¤ä¾§è¾¹æ  -->
  <script>
    (function() {
      // æ£€æµ‹æ˜¯å¦åœ¨ iframe ä¸­
      if (window.self !== window.top) {
        console.warn('[Workspace] æ£€æµ‹åˆ°è¢«åµŒå¥—åœ¨ iframe ä¸­ï¼Œè·³å‡ºåˆ°é¡¶å±‚çª—å£');
        // è·³å‡º iframeï¼Œåœ¨é¡¶å±‚çª—å£åŠ è½½
        window.top.location.href = window.location.href;
      }
      
      // æ¸…ç†å¯èƒ½å¯¼è‡´é—®é¢˜çš„æ—§çŠ¶æ€
      // å¦‚æœ URL åŒ…å«ç‰¹æ®Šæ ‡è®°ï¼Œè¯´æ˜æ˜¯é‡æ–°ç™»å½•åçš„è·³è½¬
      if (window.location.search.includes('fresh=1')) {
        console.log('[Workspace] æ£€æµ‹åˆ°æ–°ç™»å½•ï¼Œæ¸…ç†æ—§çŠ¶æ€');
        // æ¸…ç† Tab çŠ¶æ€ï¼Œé¿å…åŠ è½½æ—§çš„åµŒå¥—é¡µé¢
        try {
          const savedTabs = localStorage.getItem('workspace_tabs');
          if (savedTabs) {
            const state = JSON.parse(savedTabs);
            // æ£€æŸ¥æ˜¯å¦æœ‰æŒ‡å‘ workspace.html çš„ Tabï¼ˆä¼šå¯¼è‡´åµŒå¥—ï¼‰
            const hasNestedWorkspace = state.tabs && state.tabs.some(tab => 
              tab.url && tab.url.includes('workspace.html')
            );
            if (hasNestedWorkspace) {
              console.warn('[Workspace] æ£€æµ‹åˆ°å¯èƒ½å¯¼è‡´åµŒå¥—çš„ Tabï¼Œæ¸…ç†çŠ¶æ€');
              localStorage.removeItem('workspace_tabs');
            }
          }
        } catch (e) {
          console.warn('[Workspace] æ¸…ç†çŠ¶æ€æ—¶å‡ºé”™:', e);
        }
        // ç§»é™¤ URL ä¸­çš„ fresh å‚æ•°
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
      }
    })();
  </script>
</head>
<body class="themed-bg-subtle">
  <!-- åŠ è½½ä¸­çŠ¶æ€ -->
  <div id="loading-screen" class="workspace-loading">
    <div class="workspace-loading-spinner"></div>
  </div>

  <!-- å·¥ä½œå°ä¸»å®¹å™¨ -->
  <div 
    class="admin-layout" 
    x-data="workspaceTabs()" 
    x-cloak
    @toggle-mobile-menu.window="$refs.sidebar && ($refs.sidebar.mobileOpen = !$refs.sidebar.mobileOpen)"
    @keydown.ctrl.k.prevent="$store.shortcuts?.trigger('openSearch')"
    @keydown.escape="$store.shortcuts?.trigger('closeModal')"
    @keydown.ctrl.s.prevent="$store.shortcuts?.trigger('save')"
  >
    <!-- ä¾§è¾¹æ  -->
    <aside 
      class="admin-sidebar"
      x-data="sidebarNav()"
      x-ref="sidebar"
      :class="{ 'collapsed': collapsed, 'mobile-open': mobileOpen }"
    >
      <!-- Logo åŒºåŸŸ -->
      <div class="sidebar-logo">
        <span class="logo-icon">ğŸ°</span>
        <span class="logo-text">æŠ½å¥–ç®¡ç†åå°</span>
      </div>

      <!-- å¯¼èˆªèœå• -->
      <nav class="sidebar-nav scrollbar-thin">
        <template x-for="group in navGroups" :key="group.id">
          <div>
            <!-- å•é¡¹èœå•ï¼ˆå¦‚å·¥ä½œå°ï¼‰ -->
            <template x-if="group.type === 'single'">
              <a 
                class="nav-single"
                :class="{ 'active': isItemActive(group.url) }"
                @click.prevent="navigateTo(group.url, group.id, group.name, group.icon)"
                href="javascript:;"
              >
                <span class="nav-icon" x-text="group.icon"></span>
                <span class="nav-text" x-text="group.name"></span>
              </a>
            </template>

            <!-- åˆ†ç»„èœå• -->
            <template x-if="group.type !== 'single' && group.items">
              <div 
                class="nav-group"
                :class="{ 'expanded': isGroupExpanded(group.id) }"
              >
                <!-- åˆ†ç»„æ ‡é¢˜ -->
                <div 
                  class="nav-group-title"
                  @click="toggleGroup(group.id)"
                >
                  <span class="nav-icon" x-text="group.icon"></span>
                  <span class="nav-text" x-text="group.name"></span>
                  <span class="toggle-icon">â–¼</span>
                </div>

                <!-- åˆ†ç»„å­é¡¹ -->
                <div class="nav-group-items">
                  <template x-for="item in group.items" :key="item.id">
                    <a 
                      class="nav-item"
                      :class="{ 'active': isItemActive(item.url) }"
                      @click.prevent="navigateTo(item.url, item.id, item.name, group.icon)"
                      href="javascript:;"
                    >
                      <span x-text="item.name"></span>
                      <template x-if="item.badge">
                        <span class="ml-auto w-2 h-2 bg-red-500 rounded-full"></span>
                      </template>
                    </a>
                  </template>
                </div>
              </div>
            </template>
          </div>
        </template>
      </nav>

      <!-- ä¾§è¾¹æ åº•éƒ¨ -->
      <div class="sidebar-footer">
        <button 
          class="collapse-btn"
          @click="toggleCollapse()"
          :title="collapsed ? 'å±•å¼€èœå•' : 'æŠ˜å èœå•'"
        >
          <span x-show="!collapsed">â—€ æŠ˜å èœå•</span>
          <span x-show="collapsed">â–¶</span>
        </button>
      </div>
    </aside>
    
    <!-- ä¸»å†…å®¹åŒº -->
    <main class="admin-main">
      <!-- é¡¶éƒ¨æ  -->
      <header class="workspace-header">
        <div class="header-left">
          <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
          <button 
            class="mobile-menu-btn"
            @click="$dispatch('toggle-mobile-menu')"
            title="èœå•"
          >
            â˜°
          </button>

          <!-- é¢åŒ…å±‘å¯¼èˆª -->
          <nav class="breadcrumb-nav">
            <span>ç®¡ç†åå°</span>
            <span>/</span>
            <span x-text="getActiveTab()?.title || 'å·¥ä½œå°'"></span>
          </nav>
        </div>

        <div class="header-right">
          <!-- å…¨å±€æœç´¢ -->
          <div class="global-search">
            <span class="global-search-icon">ğŸ”</span>
            <input 
              type="text" 
              placeholder="æœç´¢åŠŸèƒ½..." 
              @keyup.enter="handleGlobalSearch($event.target.value)"
            />
          </div>

          <!-- åˆ·æ–°æŒ‰é’® -->
          <button 
            class="header-btn" 
            title="åˆ·æ–°å½“å‰é¡µé¢"
            @click="refreshCurrentTab()"
          >
            ğŸ”„
          </button>

          <!-- é€šçŸ¥æŒ‰é’® -->
          <button class="header-btn" title="æ¶ˆæ¯é€šçŸ¥">
            ğŸ””
            <span class="notification-dot"></span>
          </button>

          <!-- ä¸»é¢˜åˆ‡æ¢ - æ”¯æŒ26ç§é…è‰²æ–¹æ¡ˆ -->
          <div class="theme-switcher" x-data="themeSwitcher()" @click.away="closeDropdown()">
            <button 
              class="theme-btn"
              @click="toggleDropdown()"
              :title="'å½“å‰ä¸»é¢˜: ' + getCurrentThemeInfo().name"
            >
              <span x-text="getCurrentThemeInfo().icon">ğŸ’™</span>
            </button>

            <!-- ä¸»é¢˜ä¸‹æ‹‰èœå• - åˆ†ç»„æ˜¾ç¤º -->
            <div 
              class="theme-dropdown"
              x-show="isOpen"
              x-transition:enter="transition ease-out duration-200"
              x-transition:enter-start="opacity-0 transform scale-95"
              x-transition:enter-end="opacity-100 transform scale-100"
              x-transition:leave="transition ease-in duration-150"
              x-transition:leave-start="opacity-100 transform scale-100"
              x-transition:leave-end="opacity-0 transform scale-95"
              style="display: none;"
            >
              <!-- å¤´éƒ¨ -->
              <div class="theme-dropdown-header">
                <div class="theme-dropdown-title">ğŸ¨ é€‰æ‹©ä¸»é¢˜é£æ ¼</div>
                <!-- åˆ†ç±»åˆ‡æ¢ -->
                <div class="theme-category-tabs">
                  <button 
                    class="theme-category-tab"
                    :class="{ 'active': activeCategory === 'all' }"
                    @click="activeCategory = 'all'"
                  >å…¨éƒ¨ (26)</button>
                  <button 
                    class="theme-category-tab"
                    :class="{ 'active': activeCategory === 'dark-sidebar' }"
                    @click="activeCategory = 'dark-sidebar'"
                  >æ·±è‰²ä¾§æ </button>
                  <button 
                    class="theme-category-tab"
                    :class="{ 'active': activeCategory === 'light-sidebar' }"
                    @click="activeCategory = 'light-sidebar'"
                  >æµ…è‰²ä¾§æ </button>
                </div>
              </div>

              <!-- ä¸»é¢˜åˆ—è¡¨ -->
              <div class="theme-dropdown-body">
                <!-- æ·±è‰²ä¾§è¾¹æ ä¸»é¢˜ -->
                <template x-if="activeCategory === 'all' || activeCategory === 'dark-sidebar'">
                  <div>
                    <div class="theme-group-title" x-show="activeCategory === 'all'">ğŸŒ™ æ·±è‰²ä¾§è¾¹æ </div>
                    <template x-for="theme in getDarkSidebarThemes()" :key="theme.id">
                      <button 
                        class="theme-option"
                        :class="{ 'active': currentTheme === theme.id }"
                        @click="setTheme(theme.id)"
                      >
                        <span class="theme-icon" x-text="theme.icon"></span>
                        <div class="theme-info">
                          <span class="theme-name" x-text="theme.name"></span>
                          <span class="theme-scene" x-text="theme.scene"></span>
                        </div>
                        <div class="theme-preview">
                          <template x-for="(color, i) in theme.colors" :key="i">
                            <span class="theme-preview-color" :style="{ backgroundColor: color }"></span>
                          </template>
                        </div>
                        <span class="theme-check" x-show="currentTheme === theme.id">âœ“</span>
                      </button>
                    </template>
                  </div>
                </template>

                <!-- æµ…è‰²ä¾§è¾¹æ ä¸»é¢˜ -->
                <template x-if="activeCategory === 'all' || activeCategory === 'light-sidebar'">
                  <div>
                    <div class="theme-group-title" x-show="activeCategory === 'all'">â˜€ï¸ æµ…è‰²ä¾§è¾¹æ </div>
                    <template x-for="theme in getLightSidebarThemes()" :key="theme.id">
                      <button 
                        class="theme-option"
                        :class="{ 'active': currentTheme === theme.id }"
                        @click="setTheme(theme.id)"
                      >
                        <span class="theme-icon" x-text="theme.icon"></span>
                        <div class="theme-info">
                          <span class="theme-name" x-text="theme.name"></span>
                          <span class="theme-scene" x-text="theme.scene"></span>
                        </div>
                        <div class="theme-preview">
                          <template x-for="(color, i) in theme.colors" :key="i">
                            <span class="theme-preview-color" :style="{ backgroundColor: color }"></span>
                          </template>
                        </div>
                        <span class="theme-check" x-show="currentTheme === theme.id">âœ“</span>
                      </button>
                    </template>
                  </div>
                </template>
              </div>

              <!-- åº•éƒ¨å¿«é€Ÿæ“ä½œ -->
              <div class="theme-dropdown-footer">
                <button 
                  class="theme-quick-switch"
                  @click="toggleDarkMode()"
                >
                  <span class="theme-icon">ğŸŒ“</span>
                  <span>å¿«é€Ÿåˆ‡æ¢ æ·±è‰²/æµ…è‰²</span>
                </button>
              </div>
            </div>
          </div>

          <!-- ç”¨æˆ·ä¸‹æ‹‰èœå• -->
          <div class="user-dropdown relative" x-data="{ open: false }" @click.away="open = false">
            <div @click="open = !open" class="flex items-center gap-2 cursor-pointer">
              <span class="user-avatar">A</span>
              <span class="user-name">ç®¡ç†å‘˜</span>
              <span class="text-xs text-gray-400">â–¼</span>
            </div>
            
            <!-- ä¸‹æ‹‰èœå• -->
            <div 
              x-show="open"
              x-transition
              class="absolute right-0 top-full mt-2 w-48 themed-card rounded-lg shadow-lg border themed-border py-2 z-50"
              style="display: none;"
            >
              <a href="/admin/profile.html" class="block px-4 py-2 text-sm themed-text-secondary themed-hover-bg">
                ğŸ‘¤ ä¸ªäººè®¾ç½®
              </a>
              <a href="/admin/system-settings.html" class="block px-4 py-2 text-sm themed-text-secondary themed-hover-bg">
                âš™ï¸ ç³»ç»Ÿè®¾ç½®
              </a>
              <div class="border-t themed-border my-1"></div>
              <button 
                @click="handleLogout()"
                class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50"
              >
                ğŸšª é€€å‡ºç™»å½•
              </button>
            </div>
          </div>
        </div>
      </header>
      
      <!-- Tab å·¥ä½œå° -->
      <div class="workspace-tab-bar">
        <!-- Tab åˆ—è¡¨ -->
        <template x-for="tab in tabs" :key="tab.id">
          <button 
            class="workspace-tab"
            :class="{ 'active': isActiveTab(tab.id) }"
            @click="switchTab(tab.id)"
            @contextmenu="showContextMenu(tab.id, $event)"
            :title="tab.title"
          >
            <span class="tab-icon" x-text="tab.icon"></span>
            <span class="tab-title" x-text="tab.title"></span>
            <span 
              class="tab-close-btn"
              @click.stop="closeTab(tab.id)"
              title="å…³é—­æ­¤æ ‡ç­¾"
              x-show="tabs.length > 1"
              style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; margin-left: 6px; border-radius: 50%; background: rgba(0,0,0,0.1); color: #666; font-size: 12px; cursor: pointer; transition: all 0.2s;"
              onmouseover="this.style.background='#ef4444'; this.style.color='white';"
              onmouseout="this.style.background='rgba(0,0,0,0.1)'; this.style.color='#666';"
            >âœ•</span>
          </button>
        </template>

        <!-- Tab æ“ä½œæŒ‰é’® -->
        <button 
          class="workspace-tab tab-add"
          @click="closeAllTabs()"
          title="å…³é—­æ‰€æœ‰å¹¶è¿”å›å·¥ä½œå°"
          x-show="tabs.length > 1"
        >
          âœ• å…³é—­æ‰€æœ‰
        </button>
      </div>

      <!-- Tab å†…å®¹åŒºåŸŸ -->
      <div class="workspace-content">
        <template x-for="tab in tabs" :key="tab.id">
          <div 
            class="tab-panel"
            :class="{ 'active': isActiveTab(tab.id) }"
            :data-tab-id="tab.id"
          >
            <!-- ä½¿ç”¨ iframe åŠ è½½é¡µé¢å†…å®¹ -->
            <iframe 
              :src="tab.url"
              :name="'tab-' + tab.id"
              title="é¡µé¢å†…å®¹"
              loading="lazy"
            ></iframe>
          </div>
        </template>

        <!-- ç©ºçŠ¶æ€ -->
        <div 
          class="empty-state"
          x-show="tabs.length === 0"
          style="height: 100%;"
        >
          <div class="empty-state-icon">ğŸ“‹</div>
          <div class="empty-state-text">æš‚æ— æ‰“å¼€çš„é¡µé¢</div>
          <div class="empty-state-description">ä»å·¦ä¾§èœå•é€‰æ‹©åŠŸèƒ½å¼€å§‹ä½¿ç”¨</div>
        </div>
      </div>
    </main>
  </div>

  <!-- JavaScript -->
  <script type="module">
    // å¯¼å…¥æ ·å¼
    import './src/styles/index.css'
    
    // å¯¼å…¥å¹¶åˆå§‹åŒ– Alpine.js
    import { initAlpine } from './src/alpine/index.js'
    
    // åˆå§‹åŒ– Alpine.js
    initAlpine()
    
    // éšè—åŠ è½½çŠ¶æ€
    setTimeout(() => {
      const loadingScreen = document.getElementById('loading-screen')
      if (loadingScreen) {
        loadingScreen.style.opacity = '0'
        loadingScreen.style.transition = 'opacity 0.3s'
        setTimeout(() => loadingScreen.remove(), 300)
      }
    }, 100)
    
    // å…¨å±€æœç´¢å¤„ç†
    window.handleGlobalSearch = function(keyword) {
      console.log('æœç´¢:', keyword)
      // å¯æ‰©å±•ï¼šå®ç°å…¨å±€æœç´¢é€»è¾‘
    }
    
    // é€€å‡ºç™»å½•å¤„ç†
    window.handleLogout = async function() {
      if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) return
      
      try {
        const response = await fetch('/api/v4/auth/logout', {
          method: 'POST',
          credentials: 'include'
        })
        
        // æ— è®ºAPIç»“æœå¦‚ä½•ï¼Œéƒ½æ¸…ç†æœ¬åœ°çŠ¶æ€
        clearAllLocalState()
        
        if (response.ok || response.status === 401) {
          // ç¡®ä¿åœ¨é¡¶å±‚çª—å£è·³è½¬
          if (window.self !== window.top) {
            window.top.location.href = '/admin/login.html'
          } else {
            window.location.href = '/admin/login.html'
          }
        }
      } catch (error) {
        console.error('é€€å‡ºç™»å½•å¤±è´¥:', error)
        // å³ä½¿APIå¤±è´¥ä¹Ÿæ¸…ç†æœ¬åœ°çŠ¶æ€å¹¶è·³è½¬
        clearAllLocalState()
        if (window.self !== window.top) {
          window.top.location.href = '/admin/login.html'
        } else {
          window.location.href = '/admin/login.html'
        }
      }
    }
    
    // å½»åº•æ¸…ç†æ‰€æœ‰æœ¬åœ°çŠ¶æ€
    function clearAllLocalState() {
      // æ¸…ç†è®¤è¯ç›¸å…³
      localStorage.removeItem('admin_token')
      localStorage.removeItem('admin_user_info')
      sessionStorage.removeItem('admin_token')
      sessionStorage.removeItem('admin_user_info')
      
      // æ¸…ç†å·¥ä½œåŒºçŠ¶æ€
      localStorage.removeItem('workspace_tabs')
      localStorage.removeItem('sidebar_collapsed')
      localStorage.removeItem('sidebar_expanded_groups')
      
      // æ¸…ç†æµè§ˆå™¨ä¼šè¯æ ‡è®°
      sessionStorage.removeItem('browser_session_id')
      
      console.log('[Workspace] å·²æ¸…ç†æ‰€æœ‰æœ¬åœ°çŠ¶æ€')
    }
    
    console.log('ğŸ° æŠ½å¥–ç®¡ç†åå°å·¥ä½œå°å·²åŠ è½½ - æ·±è“ç§‘æŠ€é£')
    
    // ç›‘å¬å­ iframe å‘é€çš„è®¤è¯è¿‡æœŸæ¶ˆæ¯
    window.addEventListener('message', function(event) {
      // å®‰å…¨æ£€æŸ¥ï¼šåªå¤„ç†è®¤è¯ç›¸å…³çš„æ¶ˆæ¯
      if (event.data && event.data.type === 'AUTH_EXPIRED') {
        console.log('[Workspace] æ”¶åˆ°è®¤è¯è¿‡æœŸæ¶ˆæ¯ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ');
        // æ¸…ç†æ‰€æœ‰æœ¬åœ°çŠ¶æ€
        clearAllLocalState();
        // è·³è½¬åˆ°ç™»å½•é¡µ
        window.location.href = event.data.redirect || '/admin/login.html';
      }
    });
  </script>
</body>
</html>

