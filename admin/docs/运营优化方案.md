# 餐厅积分抽奖系统管理后台 — 运营优化方案

> 生成日期：2026-02-17  
> 基于：实际代码状态 + 真实数据库数据（79张表、37个HTML页面、54个Service文件）

---

## 一、项目现状全景

### 1.1 技术框架

| 层次 | 技术栈 |
|------|--------|
| 前端 | Vite + Alpine.js + Tailwind CSS + ECharts + Socket.IO-client |
| 后端 | Node.js 20 + Express + Sequelize ORM |
| 数据库 | MySQL (79张表) + Redis |
| 认证 | JWT + RBAC (11种角色，最高 admin role_level=100) |

### 1.2 真实数据概况

| 模块 | 数据量 | 关键状态 |
|------|--------|----------|
| 用户 | 60人 (全部 active, 全部 normal 等级) | 月活仅 9 人 |
| 门店 | 5家 (全部 active) | — |
| 抽奖活动 | 4个 (1 活跃, 1 暂停, 2 结束) | — |
| 抽奖记录 | 2,189次 | 日均 150+ 次，但仅 1 个 unique_user |
| 资产交易 | 24,998笔 | — |
| 兑换订单 | 1,184笔 | 🔴 616 待处理 + 564 已过期 |
| 市场挂单 | 275笔 | 231 撤回 / 27 在售 / 15 成交 |
| C2C 交易 | 118笔 | 98 取消 / 16 完成 |
| 客服会话 | 16次 | — |
| 反馈 | 153条 | 🔴 无前端管理入口 |
| 操作日志 | 5,540条 | — |
| 功能开关 | 7个 (全部抽奖策略相关) | — |

**资产余额分布**：

| 资产类型 | 可用总量 | 冻结总量 | 账户数 |
|----------|----------|----------|--------|
| POINTS | 810,343 | 4,640 | 14 |
| DIAMOND | 728,572 | 22,660 | 22 |
| red_shard | 182,767 | 2,740 | 3 |
| BUDGET_POINTS | 5,187 | 0 | 2 |
| MATERIAL_001 | 100 | 0 | 1 |

### 1.3 当前侧边栏结构 (7组)

```
1. 🔔 待处理中心 → 消费审核、客服工作台、风控告警、抽奖告警
2. 📊 运营仪表盘 → 数据驾驶舱 (单页)
3. 🎰 抽奖运营 → 数据看板、活动运营、策略管理、批量工具、抽奖干预
4. 💎 资产交易 → 资产管理、资产调整、孤儿冻结、兑换市场、C2C交易、竞价管理
5. 👥 用户门店 → 用户管理、用户层级、门店管理
6. 📈 数据分析 → 统计报表、运营分析
7. ⚙️ 系统设置 → 奖品配置、运营规则、系统维护
```

侧边栏定义位置：`admin/src/alpine/components/sidebar-nav.js` → `navGroups` 数组

---

## 二、发现的核心问题（按运营影响排序）

### 问题① 616 笔兑换订单卡在 pending 状态 — 没有核销管理入口

- `redemption_orders` 表：616 笔 pending、564 笔 expired，仅 3 笔 fulfilled
- 后端 `RedemptionService.js` 已有核销、取消、查询逻辑
- **侧边栏没有兑换核销管理页面，运营人员无法处理**

### 问题② 10+ 页面已开发但不在侧边栏

| 文件 | 功能 | 后端 Service | 数据量 |
|------|------|-------------|--------|
| `content-management.html` | 公告/弹窗管理 | AnnouncementService + PopupBannerService | 73 公告 + 2 弹窗 |
| `message-center.html` | 消息通知中心 | NotificationService | 有 WebSocket 推送 |
| `feature-flags.html` | 功能开关 | FeatureFlagService | 7 个开关 |
| `audit-logs.html` | 操作审计(独立页) | AuditLogService | 5,540 条 |
| `sessions.html` | 在线会话管理 | SessionManagementService | 26 条 |
| `dict-management.html` | 数据字典 | DictionaryService | 369 条 |
| `config-tools.html` | 配置工具 | SystemConfigService | — |
| `item-templates.html` | 物品模板 | ItemTemplateService | 16 个模板 |
| `assets-portfolio.html` | 资产组合视图 | Asset Service | 42 笔余额 |
| `material-conversion-rules.html` | 材料转换规则 | MaterialManagementService | 1 条规则 |
| `pricing-config.html` | 定价配置 | LotteryCampaignPricingConfigService | 13 条 |
| `reminder-rules.html` | 提醒规则(独立页) | ReminderEngineService | 3 条规则 |

### 问题③ 反馈管理无前端入口

- `feedbacks` 表有 153 条用户反馈
- 后端 `FeedbackService.js` 已实现
- 前端没有反馈管理页面

### 问题④ 用户行为追踪已采集但无分析视图

- `user_behavior_tracks` 表有数据
- `UserBehaviorTrackService.js` 已实现
- 前端无可视化分析

### 问题⑤ 市场健康度极差但无专项监控

- 挂单成交率仅 5.5% (15/275)
- C2C 交易完成率仅 13.6% (16/118)
- `system_settings` 已有监控阈值配置（`monitor_price_low_threshold=0.1`，`monitor_alert_enabled=true`）
- 前端无专项市场健康看板

### 问题⑥ 预算管理数据异常

- 唯一活跃的"餐厅积分抽奖"活动，`remaining_prize_pool` 始终等于 `total_prize_pool` (10000)
- `lottery_daily_metrics` 全部是 B3 级别（最低预算层）
- 实际出奖价值日均 2 万+

---

## 三、侧边栏调整方案

### 核心原则

> 运营人员最重要的三件事：  
> **看待办** — 有什么需要立即处理的  
> **看大盘** — 整体业务是否健康  
> **深入分析** — 发现问题后快速定位

### 调整后的侧边栏结构 (8组)

```
1. 🔔 待处理中心（补充项）
   ├── 消费记录审核         ✅ 已有
   ├── 兑换核销管理         🆕 新增（616笔pending亟待处理）
   ├── 客服工作台           ✅ 已有
   ├── 风控告警             ✅ 已有
   ├── 抽奖告警             ✅ 已有
   └── 用户反馈处理         🆕 新增（153条无入口）

2. 📊 运营仪表盘（增强）
   └── 数据驾驶舱           ✅ 已有，需增强（见第四章）

3. 🎰 抽奖运营（不变）
   ├── 📊 数据看板          ✅ 已有
   ├── 🎁 活动运营          ✅ 已有
   ├── ⚙️ 策略管理          ✅ 已有
   ├── ⚡ 批量工具          ✅ 已有
   └── 🎯 抽奖干预管理      ✅ 已有

4. 💎 资产交易（内部调整）
   ├── 资产管理             ✅ 已有
   ├── 资产调整             ✅ 已有
   ├── 兑换市场             ✅ 已有
   ├── C2C交易              ✅ 已有
   ├── 竞价管理             ✅ 已有
   └── 孤儿冻结清理         ✅ 已有（移到末尾，低频操作）

5. 👥 用户门店（不变）
   ├── 用户管理             ✅ 已有
   ├── 用户层级             ✅ 已有
   └── 门店管理             ✅ 已有

6. 📢 内容运营（🆕 新增分组）
   ├── 公告弹窗管理         已有html，挂载到侧边栏
   └── 消息中心             已有html，挂载到侧边栏

7. 📈 数据分析（不变）
   ├── 统计报表             ✅ 已有
   └── 运营分析             ✅ 已有

8. ⚙️ 系统设置（内部重新整合）
   ├── 奖品配置             ✅ 已有
   ├── 运营规则             ✅ 已有
   ├── 功能开关             已有html → 挂载
   ├── 物品模板             已有html → 挂载
   ├── 数据字典             已有html → 挂载
   └── 系统维护             ✅ 已有
```

### 变更清单

| 变更类型 | 菜单项 | 说明 |
|----------|--------|------|
| 新增菜单项 | 兑换核销管理 | 待处理中心新增，对接已有 RedemptionService |
| 新增菜单项 | 用户反馈处理 | 待处理中心新增，对接已有 FeedbackService |
| 新增分组 | 📢 内容运营 | 将 content-management.html 和 message-center.html 挂载 |
| 挂载已有页 | 功能开关 | feature-flags.html 已存在，挂载到系统设置 |
| 挂载已有页 | 物品模板 | item-templates.html 已存在，挂载到系统设置 |
| 挂载已有页 | 数据字典 | dict-management.html 已存在，挂载到系统设置 |
| 位置调整 | 孤儿冻结清理 | 从资产交易第3位移到末尾（极低频操作） |

**修改位置**：`admin/src/alpine/components/sidebar-nav.js` 的 `navGroups` 数组

---

## 四、现有页面功能增强方案

### 4.1 数据驾驶舱 (`dashboard-panel.html`) — 增强为运营指挥中心

**当前功能**：时间范围筛选、核心指标卡片、ECharts 图表、预警面板、桑基图/漏斗图

| 优先级 | 增强项 | 具体内容 | 后端依赖 |
|--------|--------|----------|----------|
| 🔴 P0 | 待办摘要卡片 | 驾驶舱顶部新增"今日待办"横幅：pending 消费审核数、pending 兑换数、未处理告警数、待回复客服会话数。点击跳转到对应待处理页 | 复用 `nav/badges` API |
| 🔴 P0 | 兑换履约率 | 增加"兑换履约率"指标：fulfilled/(pending+fulfilled+expired)，当前仅 0.25%，应醒目预警 | 新增聚合查询，复用 RedemptionService |
| 🟡 P1 | 市场健康指标 | 增加"市场活跃度"：在售挂单数、日成交量、平均成交时间。当前成交率仅 5.5% | 复用 market 相关 Service |
| 🟡 P1 | 用户留存率 | 增加"日活/周活/月活"指标卡，当前月活 9/60=15%，需要醒目展示 | 复用 users 表 last_active_at 字段 |
| 🟢 P2 | 预算消耗进度条 | 在活动卡片中加入预算消耗进度条。当前预算数据异常(B3全量)应红色标记 | 复用 lottery_campaigns 预算字段 |

**可复用代码**：
- `dashboard-panel.html` 已有 `stat-card` 组件和 `alert-critical/warning/info` 样式类
- 后端 `routes/v4/console/dashboard.js` 和 `services/dashboard/` 目录已有汇总 API

### 4.2 待处理中心 (`pending-center.html`) — 增强为运营 SOP 入口

**当前功能**：汇总各类型待处理事项、自动刷新、类型/紧急度筛选

| 优先级 | 增强项 | 说明 | 复用 |
|--------|--------|------|------|
| 🔴 P0 | 接入兑换订单 | 当前筛选器只有：消耗审核、客服会话、抽奖告警、风控告警、退款。缺少兑换核销，但这是最大待办(616笔) | 新增 filter 类型 `redemption`，后端 `pending` 路由扩展 |
| 🔴 P0 | 接入用户反馈 | 153 条反馈无人处理 | 新增 filter 类型 `feedback` |
| 🟡 P1 | 待办超时预警 | 对超过 SLA 时间的待办标红（消费审核>24h、兑换核销>48h） | 前端计算，复用已有 `timeout-warning` / `timeout-critical` CSS 类 |
| 🟡 P1 | 一键批量处理 | 对同类型待办支持批量操作（全选→批量审核通过/拒绝） | 复用 `BatchOperationService.js` |

### 4.3 抽奖管理中心 (`lottery-management.html`) — 运营日报增强

**当前功能**：4714 行代码，含实时监控、运营日报、风控面板、系统垫付、活动管理、奖品管理、预算管理、策略配置、配额管理、定价配置、策略效果、批量操作、核销码管理

| 优先级 | 增强项 | 说明 | 后端依赖 |
|--------|--------|------|----------|
| 🔴 P0 | 单用户高频预警 | daily_metrics 显示每日仅 1 个 unique_user 做 150+ 次抽奖，应有风控提示 | 复用 `lottery_daily_metrics.unique_users` 和 `MerchantRiskControlService` |
| 🟡 P1 | 预算健康度可视化 | 当前所有日报都是 B3（最低预算层），需要显著标记。加入 B0/B1/B2/B3 分布饼图 | 复用 `lottery_daily_metrics.b0_count~b3_count` |
| 🟡 P1 | 策略触发热力图 | 7 个 feature_flag 全部启用，可视化各策略触发频率（pity/anti_empty/luck_debt 等） | 复用 `lottery_daily_metrics` 中各 trigger_count 字段 |
| 🟢 P2 | 奖品库存预警 | 物理奖品（甜品、青菜、生腌拼盘、精品首饰）需要库存预警 | 复用 `lottery_prizes.stock_quantity` |

### 4.4 用户管理 (`user-management.html`) — 增强用户画像

**当前功能**：10 个子页面 — 用户列表、用户画像、角色管理、权限管理、角色分配、高级状态、风控配置、角色变更历史、状态变更历史、用户统计

| 优先级 | 增强项 | 说明 | 后端依赖 |
|--------|--------|------|----------|
| 🟡 P1 | 用户活跃度看板 | 当前 60 人全部 normal 等级，月活仅 9 人。在用户统计子页增加活跃度分层(日活/周活/月活/沉默) | 复用 `users.last_active_at` |
| 🟡 P1 | 用户价值分层 | 按消费金额/抽奖次数/充值金额进行 RFM 分层 | 复用 `UserBehaviorTrackService` + `user_behavior_tracks` 表 |
| 🟢 P2 | 用户生命周期标签 | 新注册/活跃/衰退/流失/召回 | 前端计算，基于 last_active_at 和 created_at |

### 4.5 财务管理中心 (`finance-management.html`) — 补充资产视角

**当前子页**：消费记录、钻石账户、商户积分、债务管理、活动预算、商户日志

| 优先级 | 增强项 | 说明 | 后端依赖 |
|--------|--------|------|----------|
| 🟡 P1 | 资产总览仪表盘 | 在钻石账户页增加全平台资产概览：POINTS 总量 810,343 / DIAMOND 总量 728,572(冻结 22,660) / red_shard 总量 182,767 / BUDGET_POINTS 5,187 | 复用 `account_asset_balances` 聚合 |
| 🟡 P1 | 资产异常检测 | 单用户持有量/交易频率异常检测 | 可扩展 `MerchantRiskControlService` |

### 4.6 兑换市场 (`exchange-market.html`) — 增强履约追踪

| 优先级 | 增强项 | 说明 |
|--------|--------|------|
| 🔴 P0 | 兑换完成率大数字 | 页面顶部增加：待发货数、已发货数、完成率。当前只有 3 笔 fulfilled |
| 🟡 P1 | 过期订单处理 | 564 笔 expired 需要有批量清理/退积分功能 |

### 4.7 风控告警 (`risk-alerts.html`) — 增加市场风控

**当前**：仅 9 条风控告警

**需增强**：系统已有 market 监控阈值配置（`monitor_price_low_threshold=0.1`，`monitor_price_high_threshold=3.0`），但无前端展示。将市场价格异常纳入风控面板。

---

## 五、需新增的页面/功能

### 5.1 🆕 兑换核销管理页（最高优先级）

**理由**：616 笔 pending 兑换订单是当前最大运营堵点

**功能设计**：
- 待核销列表（筛选：状态/用户/商品/时间）
- 批量核销、批量拒绝
- 核销码扫描验证
- 过期订单批量处理（退积分/标记关闭）
- 核销统计看板

**后端可复用**：
- `services/RedemptionService.js` — 完整的 CRUD + 状态流转
- `routes/v4/console/item-instances.js` — 物品实例相关
- `models/RedemptionOrder.js` — 完整模型
- `services/BatchOperationService.js` — 批量操作框架

**前端可复用**：
- `pending-center.html` 的列表/筛选/分页组件模式
- `finance-management.html` 的审核通过/拒绝弹窗模式
- `lottery-management.html` 的批量操作 Tab 模式

### 5.2 🆕 用户反馈管理页

**理由**：153 条反馈无处处理

**功能设计**：
- 反馈列表（状态：待处理/处理中/已解决/关闭）
- 反馈详情（含用户信息关联）
- 回复/处理功能
- 反馈分类统计图表

**后端可复用**：
- `services/FeedbackService.js` — 已实现
- `models/Feedback.js` — 完整模型

**前端可复用**：
- `customer-service.html` 的会话式交互模式

### 5.3 🆕 运营早报/日报自动推送

**理由**：降低运营"每天打开后台先看什么"的思考成本

**功能设计**：
- 每日定时生成运营快报（今日待办汇总 + 昨日核心指标 + 异常告警）
- 推送到消息中心
- 支持配置关注指标

**后端可复用**：
- `services/reporting/` 目录已有报表服务
- `models/ReportTemplate.js` — 已有 2 个报表模板
- `services/NotificationService.js` — 通知推送
- `services/LotteryMetricsCollector.js` — 指标采集
- `services/ReminderEngineService.js` — 定时提醒引擎

---

## 六、可复用/可扩展资产清单

### 6.1 前端可复用模式

| 模式 | 来源页面 | 可用于 |
|------|----------|--------|
| DataTable 组件模式 | 所有列表页 (Alpine.data + 分页 + 筛选) | 新增的兑换核销、反馈管理 |
| 统计卡片 4 宫格 | dashboard-panel、lottery-management | 任何需要顶部概览的页面 |
| Tab 导航 + Alpine.store | lottery-management、finance-management | 已成熟可复制 |
| 审核弹窗模式 | finance-management (approve/reject) | 兑换核销、反馈处理 |
| 批量操作框架 | lottery-management batch-operations | 兑换批量核销、反馈批量处理 |
| ECharts 图表封装 | dashboard-panel、statistics | 所有需要图表的地方 |
| WebSocket 实时推送 | customer-service (Socket.IO) | 消息中心、告警实时推送 |
| 权限过滤框架 | `permission-rules.js` + `sidebar-nav.js` | 新菜单项自动继承权限体系 |

### 6.2 后端可复用 Service

| Service | 当前使用状态 | 可扩展方向 |
|---------|-------------|-----------|
| `RedemptionService` | 有 API 但前端无管理入口 | 兑换核销管理页 |
| `FeedbackService` | 有 API 但前端无入口 | 反馈管理页 |
| `BatchOperationService` | lottery-management 使用 | 扩展到兑换/反馈批量处理 |
| `UserBehaviorTrackService` | 后端采集、前端无展示 | 用户行为分析视图 |
| `ReminderEngineService` | 3 条规则，前端埋在系统设置 | 运营自动提醒配置 |
| `CustomReportService` | 2 个模板 | 运营日报自动生成 |
| `ContentAuditEngine` | 内容审核引擎 | 扩展到反馈/评论审核 |
| `NotificationService` | 消息推送 | 运营告警推送 |
| `MerchantRiskControlService` | 风控 | 扩展市场价格风控 |

### 6.3 后端可扩展表

| 表 | 当前数据量 | 扩展方向 |
|----|-----------|----------|
| `lottery_daily_metrics` | 11 条 | 增加：用户留存指标、兑换转化率指标 |
| `lottery_hourly_metrics` | 65 条 | 增加：实时 dashboard 数据源 |
| `report_templates` | 2 条 | 增加：运营日报模板、周报模板 |
| `reminder_rules` | 3 条 | 增加：兑换超时提醒、库存不足提醒、用户流失提醒 |
| `user_behavior_tracks` | 有数据 | 增加：行为漏斗分析视图 |

---

## 七、优先级与实施路线

### P0 — 立即处理（解决运营堵点）

| # | 任务 | 工作量 | 类型 |
|---|------|--------|------|
| 1 | 侧边栏挂载已有页面（content-management, message-center, feature-flags, item-templates, dict-management） | **小** — 只改 `sidebar-nav.js` navGroups 配置 | 配置 |
| 2 | 新增"兑换核销管理"页面 | **中** — 复用 DataTable + 审核弹窗 + 批量操作模式 | 新页面 |
| 3 | 待处理中心接入兑换订单和反馈类型 | **小** — 扩展 pending-center 的 filter.type 和后端聚合 | 增强 |
| 4 | 驾驶舱增加"今日待办摘要" | **小** — 复用 nav/badges API 数据 | 增强 |

### P1 — 一周内（补全运营视角）

| # | 任务 | 工作量 | 类型 |
|---|------|--------|------|
| 5 | 新增"用户反馈管理"页面 | **中** — 复用客服工作台交互模式 | 新页面 |
| 6 | 驾驶舱增加兑换履约率、市场活跃度、用户留存指标 | **中** | 增强 |
| 7 | 抽奖日报增加单用户高频预警 + 预算健康度可视化 | **小** — 数据已在 daily_metrics 中 | 增强 |
| 8 | 兑换市场增加履约追踪看板 | **小** | 增强 |

### P2 — 两周内（深度分析能力）

| # | 任务 | 工作量 | 类型 |
|---|------|--------|------|
| 9 | 用户管理增加活跃度分层 + RFM 价值分析 | **中** | 增强 |
| 10 | 运营日报自动生成与推送 | **中** — 复用 ReportTemplate + ReminderEngine | 新功能 |
| 11 | 风控面板接入市场价格异常监控 | **小** — 阈值配置已在 system_settings | 增强 |
| 12 | 策略触发热力图（pity/anti_empty/luck_debt 等） | **小** — 数据已在 daily_metrics | 增强 |

---

## 八、总结

### 核心结论

1. **最紧急**：616 笔兑换订单堵在 pending 无人处理 → 必须立即新增核销管理入口
2. **最浪费**：10+ 个已开发的 HTML 页面没挂在侧边栏 → 只需改 `sidebar-nav.js` 一个文件的配置
3. **最大杠杆**：驾驶舱增加"今日待办摘要"一行代码 → 运营打开后台第一眼就知道该做什么
4. **数据异常需关注**：预算管理数据不对(B3 全量)、单用户每日 150+ 次抽奖、市场成交率仅 5.5%

### 架构优势 — 新增成本低

- **前端**：Alpine.js composable 模式 + DataTable 统一封装 → 新页面可直接复制模式
- **后端**：Service 层完整（54 个 Service 文件）→ 绝大多数新前端功能有现成后端
- **权限**：RBAC + `permission-rules.js` → 新菜单自动继承权限控制
- **实时推送**：Socket.IO 已集成 → 消息中心和告警推送零成本

