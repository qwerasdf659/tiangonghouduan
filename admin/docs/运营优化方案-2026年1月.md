# 🎯 Admin后台运营优化方案 - 前端开发任务书

> **文档版本**: v1.5  
> **创建日期**: 2026年1月30日  
> **最后更新**: 2026年2月1日（细化前端任务清单）  
> **文档类型**: 🎨 **前端开发专用**  
> **目标**: 为运营团队提供更深入的数据洞察和风险控制能力  
> **🔴 核心原则**: 以后端数据库项目实现为准，前端适配后端

---

## 📋 前端开发任务总览（Quick Start）

> **🔴 重要提醒**：后端 API 已全部完成，前端直接使用后端返回的 `snake_case` 字段名，禁止做任何字段映射或数据转换。

### 工作量汇总

| 优先级 | 任务数 | 工作量 | 交付周期 |
|-------|-------|--------|---------|
| **P0 紧急** | 22 项 | 5 天 | 第 1-2 周 |
| **P1 重要** | 21 项 | 7 天 | 第 3-4 周 |
| **P2 优化** | 21 项 | 8 天 | 第 5-8 周 |
| **合计** | **64 项** | **20 天** | **8 周** |

### 涉及文件清单

| 文件路径 | 改动类型 | 说明 |
|---------|---------|------|
| `admin/src/alpine/components/sidebar-nav.js` | 🔧 修改 | 导航结构调整、徽标显示 |
| `admin/src/alpine/components/workspace-tabs.js` | 🔧 修改 | 新增仪表盘和待处理中心 Tab |
| `admin/workspace.html` | 🔧 修改 | 新增 2 个内置 Tab 页面 |
| `admin/finance-management.html` | 🔧 修改 | 批量操作、异常标记 |
| `admin/lottery-alerts.html` | 🔧 修改 | 健康度分析 Tab |
| `admin/user-management.html` | 🔧 修改 | 用户画像弹窗 |
| `admin/statistics.html` | 🔧 修改 | 多维度分析 |
| `admin/src/alpine/components/pending-center.js` | 🆕 新增 | 待处理中心组件 |
| `admin/src/alpine/components/dashboard-panel.js` | 🆕 新增 | 运营仪表盘组件 |
| `admin/src/alpine/components/health-dashboard.js` | 🆕 新增 | 健康度分析组件 |
| `admin/src/api/pending.js` | 🆕 新增 | 待处理中心 API 模块 |
| `admin/src/api/dashboard.js` | 🆕 新增 | 仪表盘 API 模块 |

### 📍 快速导航

| 章节 | 说明 | 跳转 |
|-----|------|------|
| **P0 紧急任务** | 侧边栏调整、仪表盘、待处理中心、批量操作 | [→ 查看](#-p0-紧急任务第-1-2-周5-天) |
| **P1 重要任务** | 健康度分析、用户画像、多维度统计 | [→ 查看](#-p1-重要任务第-3-4-周7-天) |
| **P2 优化任务** | 实时提醒、自定义报表、操作审计 | [→ 查看](#-p2-优化任务第-5-8-周8-天) |
| **新增文件模板** | 组件和 API 模块代码模板 | [→ 查看](#-新增文件模板) |
| **开发检查清单** | 开发前/中/后检查项 | [→ 查看](#-开发检查清单) |
| **后端 API 参考** | 已完成的后端 API 列表 | [→ 查看](#-后端-api-字段规范参考前端必读) |

---

## 🔴 P0 紧急任务（第 1-2 周，5 天）

### P0-1️⃣ 侧边栏结构调整（1 天）

**目标**：调整侧边栏导航结构，实现待处理中心置顶、分组合并、菜单移动

**文件**：`admin/src/alpine/components/sidebar-nav.js`

| 子任务 | 具体内容 | 工作量 |
|-------|---------|--------|
| F-8 | 将 `navGroups` 数组中「待处理中心」置于第 1 位 | 0.5h |
| F-20 | 将「运营仪表盘」置于第 2 位 | 0.5h |
| F-20 | 新增「风控中心」分组，包含风控告警 + 抽奖告警 | 1h |
| F-20 | 合并「资产中心」+「市场交易」为「资产交易」 | 1h |
| F-20 | 从「日常运营」移除：物品模板、字典管理、定价配置、功能开关 | 1h |
| F-20 | 将上述 4 项移入「系统设置」分组 | 0.5h |
| F-21 | 为「待处理中心」设置图标 🔔，「运营仪表盘」设置图标 📊 | 0.5h |
| F-21 | 为「风控中心」设置图标 🚨 | 0.25h |
| F-22 | 新增 `totalPendingCount`、`consumptionPendingCount` 等徽标属性 | 1h |
| F-22b | 新增 `fetchAllBadgeCounts()` 方法，调用 `GET /api/v4/console/nav/badges` | 1h |
| F-22b | 在 `init()` 中调用徽标获取，并设置 5 分钟轮询 | 0.5h |

**后端 API**：
```
GET /api/v4/console/nav/badges
返回：{ badges: { consumption, customer_service, risk_alert, lottery_alert }, total, updated_at }
```

**代码示例**：
```javascript
// sidebar-nav.js 中新增徽标获取
async fetchAllBadgeCounts() {
  const response = await fetch('/api/v4/console/nav/badges', { headers: { Authorization: `Bearer ${token}` } })
  const data = await response.json()
  // 直接使用后端字段名
  this.totalPendingCount = data.data.total
  this.consumptionPendingCount = data.data.badges.consumption
  this.customerPendingCount = data.data.badges.customer_service
  this.pendingAlertCount = data.data.badges.risk_alert
  this.lotteryAlertCount = data.data.badges.lottery_alert
}
```

---

### P0-2️⃣ 运营仪表盘 Tab（1.5 天）

**目标**：在工作台中新增运营仪表盘 Tab，展示核心 KPI 和预警信息

**文件**：
- `admin/workspace.html`（修改）
- `admin/src/alpine/components/dashboard-panel.js`（新增）
- `admin/src/api/dashboard.js`（新增）

| 子任务 | 具体内容 | 工作量 |
|-------|---------|--------|
| F-1 | 在 `workspace.html` 中新增仪表盘 Tab 容器 | 1h |
| F-1 | 创建 `dashboard-panel.js` Alpine 组件 | 1h |
| F-2 | **顶部指标卡片**：今日抽奖次数、中奖率、预算消耗、活跃用户、待处理事项 | 2h |
| F-3 | **趋势图表**：7 天抽奖趋势折线图（ECharts） | 2h |
| F-4 | **预警列表**：显示最新 5 条预警，红/黄/蓝颜色区分 | 1h |
| F-5 | **快捷操作按钮组**：跳转到待处理、消费审核、告警页面 | 1h |
| F-6 | **时间范围切换器**：今日/本周/本月切换 | 1h |
| F-7 | **数据自动刷新**：5 分钟定时刷新 | 0.5h |

**后端 API**：
```
GET /api/v4/console/analytics/stats/today              → 今日统计
GET /api/v4/console/analytics/decisions/analytics      → 趋势数据
GET /api/v4/console/lottery-monitoring/realtime-alerts → 预警列表
GET /api/v4/console/campaign-budget/batch-status       → 预算状态
GET /api/v4/console/dashboard/pending-summary          → 待处理汇总
```

**UI 结构**：
```
┌─────────────────────────────────────────────────────────────┐
│  [今日] [本周] [本月]                        🔄 5分钟自动刷新  │
├─────────────────────────────────────────────────────────────┤
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐                    │
│  │抽奖数│ │中奖率│ │预算 │ │活跃 │ │待处理│  ← 5 个指标卡片    │
│  │12,345│ │32.5%│ │67% │ │2,341│ │ 18  │                    │
│  └─────┘ └─────┘ └─────┘ └─────┘ └─────┘                    │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────┐  ┌─────────────────────┐          │
│  │   7天趋势折线图      │  │   预警列表（5条）    │          │
│  │   (ECharts)         │  │   🔴 高档位超限      │          │
│  │                     │  │   🟡 预算消耗80%    │          │
│  └─────────────────────┘  └─────────────────────┘          │
├─────────────────────────────────────────────────────────────┤
│  [待处理中心] [消费审核] [风控告警]  ← 快捷操作按钮           │
└─────────────────────────────────────────────────────────────┘
```

---

### P0-3️⃣ 待处理中心 Tab（1.5 天）

**目标**：在工作台中新增待处理中心 Tab（默认激活），聚合所有待处理事项

**文件**：
- `admin/workspace.html`（修改）
- `admin/src/alpine/components/pending-center.js`（新增）
- `admin/src/api/pending.js`（新增）

| 子任务 | 具体内容 | 工作量 |
|-------|---------|--------|
| F-9 | 在 `workspace.html` 中新增待处理中心 Tab 容器（默认激活） | 1h |
| F-9 | 创建 `pending-center.js` Alpine 组件 | 1h |
| F-10 | **汇总统计卡片**：消费审核、客服会话、风控告警、抽奖告警、总计 | 1.5h |
| F-11 | **紧急事项区域**：红色高亮显示超时事项 | 1h |
| F-12 | **统一待处理列表**：混合类型列表，可排序可筛选 | 2h |
| F-13 | **快捷处理弹窗**：不同类型事项的快捷处理（复用 `modal.js`） | 2h |
| F-14 | **超时计时器**：实时计算并显示等待时长 | 1h |
| F-15 | **类型筛选器**：按事项类型筛选（复用 `filter-bar.js`） | 1h |

**后端 API**：
```
GET /api/v4/console/pending/summary  → 汇总统计
GET /api/v4/console/pending/list     → 待处理列表（支持 category, priority, page, page_size）
```

**响应字段（前端直接使用）**：
```javascript
// /pending/summary 响应
{
  segments: [
    { category: 'consumption', category_name: '消费记录审核', count: 5, urgent_count: 2 },
    { category: 'customer_service', category_name: '客服会话', count: 3, urgent_count: 1 },
    // ...
  ],
  total: { total_count: 11, urgent_count: 4 },
  updated_at: '2026-01-31T14:30:00.000+08:00'
}

// /pending/list 响应
{
  items: [
    {
      id: 'pending_xxx',
      category: 'consumption',
      category_name: '消费记录审核',
      title: '用户张三消费记录待审核',
      priority: 'urgent',
      created_at: '...',
      waiting_minutes: 180,
      action_url: '/admin/finance-management.html?id=xxx'
    }
  ],
  pagination: { page: 1, page_size: 20, total: 100, total_pages: 5 }
}
```

**UI 结构**：
```
┌─────────────────────────────────────────────────────────────┐
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐                    │
│  │消费审│ │客服 │ │风控 │ │抽奖 │ │总计 │  ← 5 个统计卡片    │
│  │ 5(2)│ │ 3(1)│ │ 1(0)│ │ 2(1)│ │11(4)│  括号=紧急数      │
│  └─────┘ └─────┘ └─────┘ └─────┘ └─────┘                    │
├─────────────────────────────────────────────────────────────┤
│  🔴 紧急事项（4 项）                                         │
│  ├─ 消费审核超时 3h - 用户张三消费记录 [立即处理]            │
│  ├─ 客服等待超时 45min - 用户李四咨询 [立即处理]            │
│  └─ ...                                                     │
├─────────────────────────────────────────────────────────────┤
│  [全部] [消费审核] [客服会话] [风控] [抽奖]  ← 类型筛选      │
├─────────────────────────────────────────────────────────────┤
│  待处理列表（分页）                                          │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ 类型 │ 标题 │ 优先级 │ 等待时间 │ 操作 │               │  │
│  │ 消费 │ ... │ 🔴紧急 │ 3小时   │ [处理] │              │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

### P0-4️⃣ 消费审核批量操作（1 天）

**目标**：为消费审核页面增加批量选择和批量操作功能

**文件**：`admin/finance-management.html`

| 子任务 | 具体内容 | 工作量 |
|-------|---------|--------|
| F-16 | 表格新增多选列（checkbox），绑定 `selectedIds` 数组 | 1h |
| F-16 | 新增全选/取消全选功能 | 0.5h |
| F-17 | 批量操作工具栏：批量通过、批量拒绝按钮 | 1h |
| F-17 | 工具栏仅在选中项 > 0 时显示 | 0.5h |
| F-18 | 显示已选中数量：「已选择 X 项」 | 0.5h |
| F-19 | 批量操作结果提示：成功 X 项，失败 Y 项 | 1h |
| F-19 | 失败项列表展示（复用 Toast 组件） | 0.5h |

**后端 API**：
```
POST /api/v4/console/batch-operations/consumption-review
请求：{ record_ids: [1, 2, 3], action: 'approve' | 'reject', reason: '...' }
返回：{ success_count, failed_count, failed_items: [{ id, error }] }
```

**代码示例**：
```javascript
// finance-management.html 中新增
selectedIds: [],
isAllSelected: false,

toggleSelectAll() {
  if (this.isAllSelected) {
    this.selectedIds = this.consumptions.map(r => r.record_id)
  } else {
    this.selectedIds = []
  }
},

async batchApprove() {
  const response = await fetch('/api/v4/console/batch-operations/consumption-review', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
    body: JSON.stringify({ record_ids: this.selectedIds, action: 'approve' })
  })
  const data = await response.json()
  // 直接使用后端字段名
  this.$store.toast.show(`成功 ${data.data.success_count} 项，失败 ${data.data.failed_count} 项`)
  this.selectedIds = []
  this.loadConsumptions()
}
```

---

## 🟡 P1 重要任务（第 3-4 周，7 天）

### P1-1️⃣ 抽奖健康度分析（2.5 天）

**目标**：在抽奖告警页面新增健康度分析 Tab

**文件**：`admin/lottery-alerts.html`

| 子任务 | 具体内容 | 工作量 |
|-------|---------|--------|
| F-23 | 页面顶部新增 Tab 切换：[告警列表] [健康度分析] | 1h |
| F-24 | **健康度仪表盘**：圆形仪表盘显示整体健康度分数 | 3h |
| F-25 | **档位分布图**：饼图显示奖品档位分布 | 2h |
| F-26 | **问题诊断列表**：列出检测到的问题和建议 | 2h |
| F-27 | **健康度趋势图**：7 天健康度趋势折线图 | 2h |
| F-28 | **预算健康度**：预算消耗进度条和剩余天数 | 1.5h |

**后端 API**：
```
GET /api/v4/console/lottery-health/report?campaign_id=xxx       → 健康度报告
GET /api/v4/console/lottery-health/tier-distribution?...        → 档位分布
GET /api/v4/console/lottery-health/diagnosis?campaign_id=xxx    → 问题诊断
GET /api/v4/console/lottery-health/budget-consumption?...       → 预算消耗
```

---

### P1-2️⃣ 用户画像分析（2.5 天）

**目标**：在用户管理页面新增用户画像分析功能

**文件**：`admin/user-management.html`

| 子任务 | 具体内容 | 工作量 |
|-------|---------|--------|
| F-29 | 页面新增「用户画像」Tab 或弹窗入口 | 1h |
| F-30 | **用户分层饼图**：高频/中频/低频/流失用户占比 | 3h |
| F-31 | **分层用户列表**：点击饼图查看对应分层用户列表 | 3h |
| F-32 | **活跃时段热力图**：24h × 7天热力图 | 3h |
| F-33 | **兑换偏好分析**：柱状图显示热门兑换商品 | 2h |
| F-34 | **用户行为漏斗图**：访问→抽奖→中奖→兑换 | 3h |

**后端 API**：
```
GET /api/v4/console/user-segments/segments         → 用户分层统计
GET /api/v4/console/user-segments/users?segment=   → 分层用户列表
GET /api/v4/console/user-segments/heatmap          → 活跃时段热力图
GET /api/v4/console/user-segments/preferences      → 兑换偏好
GET /api/v4/console/user-segments/funnel           → 行为漏斗
```

---

### P1-3️⃣ 多维度统计分析（2 天）

**目标**：增强统计报表页面，支持多维度数据分析

**文件**：`admin/statistics.html`

| 子任务 | 具体内容 | 工作量 |
|-------|---------|--------|
| F-35 | **维度选择器**：门店/活动/时间/用户层级维度选择 | 2h |
| F-36 | **多维度表格**：支持动态列的数据表格 | 3h |
| F-37 | **同比/环比显示**：数据对比显示 ↑12% ↓5% | 2h |
| F-38 | **数据下钻功能**：点击汇总行展开明细 | 3h |
| F-39 | **图表联动**：点击图表区域联动更新表格 | 2h |

**后端 API**：
```
POST /api/v4/console/multi-dimension-stats/aggregate   → 多维度聚合
POST /api/v4/console/multi-dimension-stats/drill-down  → 下钻详情
```

---

## 🟢 P2 优化任务（第 5-8 周，8 天）

### P2-1️⃣ 实时提醒系统（2 天）

| 子任务 | 具体内容 | 工作量 |
|-------|---------|--------|
| F-44 | 页面右上角提醒图标 + 下拉列表 | 3h |
| F-45 | 声音提醒功能（Audio API） | 2h |
| F-48 | WebSocket 集成（Socket.io-client） | 2h |

### P2-2️⃣ 提醒规则配置（2 天）

| 子任务 | 具体内容 | 工作量 |
|-------|---------|--------|
| F-46 | 新增 `reminder-rules.html` 页面 | 4h |
| F-47 | 消息中心页面 | 4h |

### P2-3️⃣ 自定义报表（3 天）

| 子任务 | 具体内容 | 工作量 |
|-------|---------|--------|
| F-49 | 报表配置向导组件 | 4h |
| F-50 | 指标选择器 | 2h |
| F-51 | 维度/时间配置 | 2h |
| F-52 | 报表预览 | 3h |
| F-53 | 我的报表列表 | 2h |
| F-54 | 定时推送配置 | 2h |

### P2-4️⃣ 操作审计增强（1 天）

| 子任务 | 具体内容 | 工作量 |
|-------|---------|--------|
| F-55 | 影响范围展示 | 2h |
| F-56 | 风险级别标记 | 1h |
| F-57 | 回滚按钮 | 2h |
| F-58 | 二次确认弹窗 | 1.5h |
| F-59 | 操作审计报告页面 | 3h |

---

## 📁 新增文件模板

### `admin/src/alpine/components/pending-center.js`

```javascript
/**
 * 待处理中心组件
 * @description 聚合展示所有待处理事项
 */
export function pendingCenter() {
  return {
    loading: false,
    summary: null,      // 汇总统计
    items: [],          // 待处理列表
    filters: {
      category: '',     // 筛选类型：consumption/customer_service/risk_alert/lottery_alert
      priority: '',     // 筛选优先级：urgent/normal
      page: 1,
      page_size: 20
    },
    pagination: null,

    async init() {
      await Promise.all([this.loadSummary(), this.loadItems()])
    },

    async loadSummary() {
      const response = await fetch('/api/v4/console/pending/summary', {
        headers: { Authorization: `Bearer ${localStorage.getItem('admin_token')}` }
      })
      const data = await response.json()
      // 直接使用后端字段名
      this.summary = data.data
    },

    async loadItems() {
      this.loading = true
      const params = new URLSearchParams(this.filters)
      const response = await fetch(`/api/v4/console/pending/list?${params}`, {
        headers: { Authorization: `Bearer ${localStorage.getItem('admin_token')}` }
      })
      const data = await response.json()
      // 直接使用后端字段名
      this.items = data.data.items
      this.pagination = data.data.pagination
      this.loading = false
    },

    // 格式化等待时间
    formatWaitingTime(minutes) {
      if (minutes < 60) return `${minutes}分钟`
      const hours = Math.floor(minutes / 60)
      const mins = minutes % 60
      return mins > 0 ? `${hours}小时${mins}分钟` : `${hours}小时`
    },

    // 跳转到处理页面
    handleItem(item) {
      window.location.href = item.action_url
    }
  }
}
```

### `admin/src/api/pending.js`

```javascript
/**
 * 待处理中心 API
 */
const BASE_URL = '/api/v4/console/pending'

export const pendingApi = {
  // 获取汇总统计
  async getSummary() {
    const response = await fetch(`${BASE_URL}/summary`, {
      headers: { Authorization: `Bearer ${localStorage.getItem('admin_token')}` }
    })
    return response.json()
  },

  // 获取待处理列表
  async getList(params = {}) {
    const query = new URLSearchParams(params).toString()
    const response = await fetch(`${BASE_URL}/list?${query}`, {
      headers: { Authorization: `Bearer ${localStorage.getItem('admin_token')}` }
    })
    return response.json()
  }
}
```

---

## ✅ 开发检查清单

### 开发前检查

- [ ] 查阅后端路由文件确认 API 路径
- [ ] 查阅后端响应格式确认字段名
- [ ] 确认复用的组件在 `admin/src/alpine/components/` 存在

### 开发中检查

- [ ] 使用后端返回的 `snake_case` 字段名
- [ ] 不做字段映射或数据转换
- [ ] 分页使用 `page` + `page_size` 参数

### 开发后检查

- [ ] 调用真实后端 API 测试
- [ ] 检查响应数据展示正确
- [ ] 检查错误处理和加载状态

---

> **📌 后续章节为需求背景和详细说明，前端开发可直接按上述任务清单执行。**

---

### ✅ 技术栈验证声明

本文档所有方案均已通过以下验证，确保与项目实际技术框架完全对齐：

| 验证项 | 验证方式 | 验证结果 |
|--------|---------|---------|
| **前端技术栈** | 检查 `admin/package.json` | Vite 6.4 + Alpine.js 3.15 + ECharts 6.0 + Tailwind 3.4 ✅ |
| **后端技术栈** | 检查 `package.json` | Express 4.18 + Sequelize 6.35 + MySQL2 3.6 + ioRedis 5.7 ✅ |
| **数据库表结构** | Node.js 连接真实数据库 `DESCRIBE` 查询 | 73个表，字段和索引结构已验证 ✅ |
| **现有组件** | 代码审查 `admin/src/alpine/components/` | 23个组件，功能完善可复用 ✅ |
| **后端服务** | 代码审查 `services/` | 50+ 服务类，方法签名已验证 ✅ |
| **API 路由** | 代码审查 `routes/v4/console/` | 45+ 路由模块，接口完整 ✅ |

### 🔴 技术实现原则（强制遵守）

> **核心原则：以后端数据库项目实现为准，前端适配后端**
> 
> **适用范围**：字段命名、数据结构、返回数据、数据类型、枚举值、默认值、业务逻辑——所有技术层面均以后端实现为唯一权威源。

| 原则 | 说明 | 执行标准 |
|------|------|---------|
| **字段命名权威源** | 后端 API 响应的字段名为唯一标准 | 前端直接使用后端返回的字段名，禁止前端自行映射或重命名 |
| **数据结构权威源** | 后端返回的 JSON 结构为唯一标准 | 前端按后端返回的嵌套结构直接解析，禁止前端做结构转换 |
| **返回数据权威源** | 后端返回的数据值为唯一标准 | 前端直接展示后端返回的数据，禁止前端自行计算或转换 |
| **数据类型权威源** | 后端定义的数据类型为唯一标准 | `number` 就是数字，`string` 就是字符串，前端禁止自行转换类型 |
| **枚举值权威源** | 后端定义的枚举值为唯一标准 | 前端使用后端返回的枚举值，禁止前端自行定义或映射枚举 |
| **默认值权威源** | 后端定义的默认值为唯一标准 | 前端不得假设默认值，以后端实际返回为准 |
| **业务逻辑权威源** | 后端实现的业务逻辑为唯一标准 | 计算、统计、判断逻辑以后端代码为准，前端仅做展示 |
| **API 路径权威源** | 后端路由定义的路径为唯一标准 | 前端调用时使用后端实际路径，禁止前端假设或硬编码路径 |
| **分页参数规范** | 使用 `page` + `page_size` | 禁止使用 `pageNum`、`pageSize`、`limit`、`offset` 等变体 |
| **时间格式规范** | 北京时间 ISO8601 格式 `+08:00` 后缀 | 禁止使用 UTC 或无时区字符串 |
| **金额格式规范** | 后端返回的金额单位为唯一标准 | 后端返回分/元，前端直接使用，禁止前端自行换算 |
| **状态码规范** | 后端定义的状态码为唯一标准 | 前端使用后端返回的状态码和状态描述 |

**禁止行为**：
- ❌ 前端创建字段映射层（如 `userId → user_id`）
- ❌ 前端创建数据结构转换层
- ❌ 前端创建数据类型转换层
- ❌ 前端自行计算统计数据（应由后端计算返回）
- ❌ 前端自行定义枚举值或状态码
- ❌ 前端假设默认值或业务规则
- ❌ 前端使用与后端不同的字段命名风格
- ❌ 前端假设 API 路径而不查阅后端代码
- ❌ 兼容旧 web 端管理平台前端的非标准实现

**正确做法**：
- ✅ 前端开发前先查阅后端路由文件（`routes/v4/console/*.js`）
- ✅ 前端开发前先查阅后端服务文件（`services/*.js`）了解业务逻辑
- ✅ 前端直接使用后端返回的 `snake_case` 字段名
- ✅ 前端直接展示后端返回的数据值，不做二次计算
- ✅ 前端按后端 API 文档示例结构编写代码
- ✅ 发现字段/数据/类型不符时，直接修改前端代码适配后端
- ✅ 需要新增字段或修改返回数据时，先修改后端再更新前端

### 📋 关键决策记录

| 决策项 | 决策结果 | 决策日期 | 说明 |
|--------|---------|---------|------|
| **技术实现原则** | ✅ 以后端为准，前端适配 | 2026-02-01 | 字段命名、数据结构、API路径全部以后端实现为权威源 |
| **页面实现方案** | ✅ 工作台 Tab 模式 | 2026-02-01 | 仪表盘和待处理中心作为 workspace Tab，保持工作流连续性 |
| **首页入口** | ✅ 待处理中心（默认激活） | 2026-02-01 | 登录后默认打开两个 Tab，待处理中心为默认激活 Tab |
| **风控告警合并** | ✅ 合并为「风控中心」 | 2026-02-01 | 风控告警+抽奖告警统一入口，不遗漏告警 |
| **资产交易合并** | ✅ 合并为「资产交易」 | 2026-02-01 | 原资产中心+市场交易合并，一站式管理 |
| **低频功能整合** | ✅ 全部整合 | 2026-02-01 | 孤儿清理/物料转换/会话管理→配置工具，资产组合→资产管理Tab |
| **日常运营瘦身** | ✅ 全部移动 | 2026-02-01 | 物品模板/字典/定价/功能开关→系统设置 |
| **优先级划分** | ✅ P0/P1/P2全部实施 | 2026-01-31 | 三个优先级都需要实现，按顺序推进 |
| **预警阈值** | ✅ 采用建议值 | 2026-01-31 | 高档位40%、消费审核24h、客服响应30min、告警处理4h |
| **索引创建时机** | ✅ P0阶段一并创建 | 2026-01-31 | 3个关键索引随P0阶段上线，无需等待P2 |
| **P2数据库变更** | ✅ 无需提前评估 | 2026-01-31 | P2阶段数据库变更到时再评估即可 |

### 🔄 后端代码升级说明（2026-01-31 验证）

| 变更项 | 变更前 | 变更后 | 影响范围 |
|--------|--------|--------|---------|
| **ReportingService 重构** | `services/ReportingService.js` (单文件) | `services/reporting/StatsService.js` + `services/reporting/AnalyticsService.js` | API端点不变，方法签名兼容 |
| **ConsumptionService 模块化** | 根目录服务 | `services/consumption/` 目录下模块化 | 功能不变 |
| **CustomerService 模块化** | 根目录服务 | `services/customer-service/` 目录下模块化 | 功能不变 |

> **兼容性说明**：以上重构均保持 API 端点和方法签名兼容，前端无需修改调用方式。

### 📐 后端 API 字段规范参考（前端必读）

> **🔴 重要**：以下为后端已实现的 API 响应格式，前端开发时必须：
> - **直接使用这些字段名**（禁止映射或重命名）
> - **直接使用返回的数据值**（禁止前端自行计算或转换）
> - **遵循返回的数据类型**（`number` 就是数字，`string` 就是字符串）
> - **使用后端定义的枚举值**（如 `category: "consumption"`）

#### 1. 待处理中心 - 分类汇总接口

**后端路径**: `GET /api/v4/console/pending/summary`

**后端实际响应结构**:
```json
{
  "success": true,
  "data": {
    "segments": [
      { "category": "consumption", "category_name": "消费记录审核", "count": 5, "urgent_count": 2 },
      { "category": "customer_service", "category_name": "客服会话", "count": 3, "urgent_count": 1 },
      { "category": "risk_alert", "category_name": "风控告警", "count": 1, "urgent_count": 0 },
      { "category": "lottery_alert", "category_name": "抽奖告警", "count": 2, "urgent_count": 1 }
    ],
    "total": { "total_count": 11, "urgent_count": 4 },
    "updated_at": "2026-01-31T14:30:00.000+08:00"
  },
  "message": "获取成功"
}
```

**前端使用示例**:
```javascript
// ✅ 正确：直接使用后端字段名
const response = await api.get('/api/v4/console/pending/summary')
const { segments, total, updated_at } = response.data
segments.forEach(seg => {
  console.log(seg.category, seg.category_name, seg.count, seg.urgent_count)
})

// ❌ 错误：禁止做字段映射
// const mappedData = {
//   categoryList: response.data.segments.map(s => ({ type: s.category, name: s.category_name }))
// }
```

#### 2. 待处理中心 - 统一列表接口

**后端路径**: `GET /api/v4/console/pending/list`

**后端实际响应结构**:
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 123,
        "category": "consumption",
        "category_name": "消费记录审核",
        "title": "消费金额 ¥128.00",
        "description": "待审核消费记录",
        "user_id": 1001,
        "user_info": { "nickname": "张三", "mobile": "138****1234" },
        "created_at": "2026-01-31 10:30:00",
        "waiting_time": "4小时30分钟",
        "waiting_minutes": 270,
        "is_urgent": true,
        "action_url": "/admin/consumption/review/123"
      }
    ],
    "pagination": { "page": 1, "page_size": 20, "total": 5, "total_pages": 1 },
    "filter": { "category": "consumption", "urgent_only": true },
    "updated_at": "2026-01-31T14:30:00.000+08:00"
  },
  "message": "获取成功"
}
```

#### 3. 运营看板 - 待处理聚合接口

**后端路径**: `GET /api/v4/console/dashboard/pending-summary`

**后端实际响应结构**:
```json
{
  "success": true,
  "data": {
    "consumption_pending": { "count": 5, "urgent_count": 2, "oldest_minutes": 180 },
    "customer_service_pending": { "count": 3, "urgent_count": 1, "oldest_minutes": 45 },
    "risk_alerts": { "count": 1, "urgent_count": 0 },
    "lottery_alerts": { "count": 2, "urgent_count": 1 },
    "total": { "total_count": 11, "urgent_count": 4 },
    "updated_at": "2026-01-31T14:30:00.000+08:00"
  },
  "message": "获取成功"
}
```

#### 4. 导航徽标接口

**后端路径**: `GET /api/v4/console/nav/badges`

**后端实际响应结构**:
```json
{
  "success": true,
  "data": {
    "badges": {
      "consumption": 5,
      "customer_service": 3,
      "risk_alert": 1,
      "lottery_alert": 2
    },
    "total": 11,
    "updated_at": "2026-01-31T14:30:00.000+08:00"
  },
  "message": "获取成功"
}
```

#### 5. 批量操作通用响应结构

**后端路径**: `POST /api/v4/console/batch-operations/*`

**后端实际响应结构**:
```json
{
  "success": true,
  "data": {
    "batch_log_id": 12345,
    "status": "completed",
    "total_count": 10,
    "success_count": 8,
    "fail_count": 2,
    "success_rate": 80.0,
    "result_details": {
      "success_items": [
        { "user_id": 1001, "result": "success" }
      ],
      "failed_items": [
        { "user_id": 1002, "error": "用户不存在", "error_code": "USER_NOT_FOUND" }
      ]
    }
  },
  "message": "批量操作完成"
}
```

#### 6. 用户分层接口

**后端路径**: `GET /api/v4/console/user-segments/segments`

**分层类型枚举（后端定义）**:
- `high_value` - 高价值用户
- `active` - 活跃用户
- `silent` - 沉默用户
- `churned` - 流失用户

#### 7. 通用分页参数规范

| 参数名 | 类型 | 说明 | 后端默认值 |
|--------|------|------|-----------|
| `page` | number | 页码（从1开始） | 1 |
| `page_size` | number | 每页数量 | 20 |

**禁止使用的变体**：`pageNum`、`pageSize`、`limit`、`offset`、`currentPage`

#### 8. 通用响应格式

所有 API 统一返回格式：
```json
{
  "success": true,
  "data": { ... },
  "message": "操作描述"
}
```

错误响应格式：
```json
{
  "success": false,
  "code": "ERROR_CODE",
  "message": "错误描述",
  "data": null
}
```

---

## 📊 一、业务现状分析

### 1.1 核心数据概览

基于实际数据库数据（查询时间：2026-01-31，通过 Node.js + Sequelize 连接验证）：

| 指标 | 当前值 | 状态 | 说明 |
|------|--------|------|------|
| 用户总数 | 52 | 🟢 正常 | 全部活跃状态 |
| 抽奖活动 | 4个 | 🟡 关注 | 仅1个活动在运行 |
| 抽奖次数 | 712次 | 🟢 正常 | 累计抽奖数据 |
| 门店数量 | 5家 | 🟢 正常 | 全部活跃 |
| 待审核消费 | **8条** | 🔴 待处理 | 需及时处理 |
| 活跃客服会话 | **10个** | 🔴 待处理 | 需关注响应 |
| 物品实例 | 5170个 | 🟢 正常 | 2906个可用 |
| 兑换商品 | 35个 | 🟡 关注 | **0个上架中（全部已下架）** |
| 风控告警 | 9个 | 🟢 正常 | 0个待处理 |

### 1.2 抽奖档位分布分析

> 基于 712 次抽奖记录统计（2026-01-31 验证）

| 档位 | 次数 | 占比 | 健康度评估 |
|------|------|------|------------|
| high（高档位） | 325 | 45.6% | ⚠️ 偏高 |
| mid（中档位） | 41 | 5.8% | 🟡 偏低 |
| fallback（保底档） | 267 | 37.5% | 🟢 正常 |
| 其他/空奖 | 79 | 11.1% | 🟢 正常 |

**预警**：高档位奖品发放占比45.6%，超过建议阈值（40%），可能导致：
- 预算消耗过快
- 奖品库存紧张
- 用户期望值过高

### 1.3 用户角色分布

| 角色 | 数量 | 说明 |
|------|------|------|
| admin | 4 | 系统管理员 |
| user | 34 | 普通用户 |
| campaign_2 | 2 | 活动角色 |
| ops | 1 | 运营人员 |
| business_manager | 1 | 业务经理 |
| merchant_manager | 1 | 商家管理员 |
| system_job | 1 | 系统任务账号 |

### 1.4 用户层级结构

| 层级 | 数量 |
|------|------|
| regional_manager（区域经理） | 1 |
| business_manager（业务经理） | 1 |
| sales_staff（业务员） | 4 |

### 1.5 材料资产类型

| 资产代码 | 名称 | 可交易 | 状态 |
|---------|------|--------|------|
| DIAMOND | 钻石 | ✅ 是 | 启用 |
| red_shard | 红色碎片 | ✅ 是 | 启用 |
| BUDGET_POINTS | 预算积分 | ❌ 否 | 启用 |
| POINTS | 普通积分 | ❌ 否 | 禁用 |

---

## 🚀 二、页面位置调整建议

### 2.1 当前侧边栏结构问题分析

**现状**：
```
🏠 工作台（直接跳转统计页面）
📋 日常运营（8个子项，功能分散）
🎰 抽奖运营
💎 资产中心
🏪 市场交易
👥 用户门店
📊 数据分析
⚙️ 系统设置
```

**问题**：
1. 「工作台」直接跳转统计页面，缺乏业务概览仪表盘
2. 「日常运营」包含8个子项，功能过于分散，重点不突出
3. 「数据分析」权重过低，不利于数据驱动决策
4. 待处理事项分散在多个页面，运营需要频繁切换

### 2.2 最终侧边栏方案（已决策 ✅）

> **决策原则**：运营人员最重要的三件事 - 看待办、看大盘、深入分析

```
🔔 待处理中心（P0 新增，置顶最高优先级）  ← 运营每天第一眼看这里
   ├─ 消费审核（显示红点：待审核数量）
   ├─ 客服会话（显示红点：活跃会话数）
   ├─ 风控告警（显示红点：待处理数）
   └─ 抽奖告警（显示红点：待处理数）

📊 运营仪表盘（P0 新增，原工作台改造）    ← 一屏看清核心KPI
   └─ 业务概览/数据看板

🎰 抽奖运营（保持，位置上移）              ← 高频操作区
   ├─ 实时监控
   ├─ 活动管理
   ├─ 奖品配置
   ├─ 预算控制
   ├─ 策略配置
   └─ 干预预设

📦 资产交易（合并原「资产中心」和「市场交易」）
   ├─ 资产总览（P1 新增Tab）
   ├─ 钻石账户
   ├─ 物品管理
   ├─ 兑换市场
   └─ C2C交易

👥 用户门店（保持）
   ├─ 用户管理
   ├─ 用户画像（P1 新增Tab）
   ├─ 用户层级
   └─ 门店管理

⚙️ 系统配置（保持，低频使用放最后）
   ├─ 内容管理
   ├─ 字典管理
   ├─ 功能开关
   ├─ 系统设置
   └─ 会话管理
```

### 2.3 调整对比（调整前 vs 调整后）

| 方面 | 调整前 | 调整后 | 收益 |
|-----|--------|--------|------|
| **待办入口** | 分散在多个页面 | 聚合在顶部，红点提醒 | 避免遗漏，提效30% |
| **工作台** | 直接跳统计页面 | 运营仪表盘，核心KPI一屏展示 | 减少页面切换50% |
| **导航层级** | 8个一级分组 | 6个一级分组 | 导航更清晰 |
| **访问路径** | 审核消费：3次点击 | 审核消费：1次点击 | 缩短访问路径 |
| **日常运营** | 8个子项混在一起 | 拆散到各自归属分组 | 功能归类更合理 |

### 2.4 原「日常运营」分组拆分说明

| 原子项 | 新归属 | 说明 |
|--------|--------|------|
| 消费管理 | 🔔 待处理中心 → 消费审核 | 待审核事项优先展示 |
| 客服中心 | 🔔 待处理中心 → 客服会话 | 活跃会话需及时处理 |
| 风控告警 | 🔔 待处理中心 → 风控告警 | 告警需及时响应 |
| 抽奖告警 | 🔔 待处理中心 → 抽奖告警 | 抽奖异常需关注 |
| 数据分析 | 📊 运营仪表盘 | 整合到仪表盘 |
| 其他低频功能 | ⚙️ 系统配置 | 归入系统配置 |

---

## 📈 三、新增关键页面建议

### 3.1 🏠 运营仪表盘（Dashboard）

**优先级**: P0（立即实施）  
**目的**: 一屏展示核心运营指标，支持快速决策

#### 页面布局设计

```
┌─────────────────────────────────────────────────────────────────┐
│ 📊 实时运营概览                             [今日] [本周] [本月] │
├──────────┬──────────┬──────────┬──────────┬──────────────────────┤
│ 📈 今日抽奖 │ 🎁 中奖率   │ 💰 预算消耗 │ 👥 活跃用户   │ 🔔 待处理事项    │
│   383次   │  57.8%   │  65%    │   28人   │     18项        │
│   ↑22%    │  ↓3.2%   │         │  ↑12%    │ 消费8/客服10    │
├─────────────────────────────────────────────────────────────────┤
│ 📉 关键指标趋势图（最近7天）                                      │
│   [抽奖次数] [中奖率] [用户增长] [交易量]                          │
├─────────────────────────────────────────────────────────────────┤
│ ⚠️ 运营预警                                                     │
│ • 高档位奖品占比51%，建议调整概率配置                              │
│ • 8条消费记录待审核超过24小时                                     │
│ • 活动「餐厅积分抽奖」预算消耗达65%                                │
├─────────────────────────────────────────────────────────────────┤
│ 🎯 快捷操作                                                     │
│ [审核消费] [处理客服] [查看告警] [调整配置]                        │
└─────────────────────────────────────────────────────────────────┘
```

#### 数据指标定义

| 指标名称 | 计算方式 | 数据来源 | 刷新频率 |
|---------|---------|---------|---------|
| 今日抽奖次数 | COUNT(lottery_draws) WHERE DATE(created_at) = TODAY | lottery_draws | 5分钟 |
| 中奖率 | 非空奖次数 / 总抽奖次数 × 100% | lottery_draws | 5分钟 |
| 预算消耗 | 已用预算 / 总预算 × 100% | lottery_campaigns | 5分钟 |
| 活跃用户 | DISTINCT user_id FROM lottery_draws WHERE DATE = TODAY | lottery_draws | 5分钟 |
| 待处理事项 | 待审核消费 + 活跃客服会话 + 待处理告警 | 多表 | 实时 |

### 3.2 📋 待处理中心

**优先级**: P0（立即实施）  
**目的**: 聚合所有需要运营处理的事项，提高处理效率

#### 功能设计

| 待处理类型 | 数据来源 | 优先级规则 | 超时预警阈值 |
|-----------|---------|-----------|-------------|
| 消费记录审核 | consumption_records WHERE status='pending' | 提交时间正序 | 24小时 |
| 客服会话 | customer_service_sessions WHERE status IN ('waiting','active') | waiting优先 | 30分钟 |
| 风控告警 | risk_alerts WHERE status='pending' | severity倒序 | 4小时 |
| 抽奖告警 | lottery_alerts WHERE status='pending' | severity倒序 | 4小时 |
| 预设审批 | lottery_presets WHERE approval_status='pending' | 创建时间正序 | 8小时 |

#### 界面布局

```
┌─────────────────────────────────────────────────────────────────┐
│ 📋 待处理中心                                    [刷新] [导出]  │
├─────────────────────────────────────────────────────────────────┤
│ 📊 汇总统计                                                     │
│ ┌──────────┬──────────┬──────────┬──────────┬──────────┐       │
│ │ 消费审核  │ 客服会话  │ 风控告警  │ 抽奖告警  │ 预设审批  │       │
│ │   8 🔴   │   10 🔴  │   0 🟢   │   0 🟢   │   0 🟢   │       │
│ │ 3条超时  │ 5条等待  │          │          │          │       │
│ └──────────┴──────────┴──────────┴──────────┴──────────┘       │
├─────────────────────────────────────────────────────────────────┤
│ 🔥 紧急事项（超时预警）                                          │
│ ├─ 🔴 消费记录 #1234 - 用户张三 - ¥125.00 - 等待48小时           │
│ ├─ 🔴 消费记录 #1235 - 用户李四 - ¥89.00 - 等待36小时            │
│ └─ 🟡 客服会话 #5678 - 用户王五 - 等待45分钟                     │
├─────────────────────────────────────────────────────────────────┤
│ 📝 全部待处理列表                              [筛选] [排序]     │
│ ┌────┬──────┬────────┬────────┬────────┬────────┐              │
│ │类型│ ID   │ 相关用户 │ 金额/描述│ 等待时间 │ 操作   │              │
│ ├────┼──────┼────────┼────────┼────────┼────────┤              │
│ │消费│ 1234 │ 张三    │ ¥125.00│ 48小时  │ [处理] │              │
│ │消费│ 1235 │ 李四    │ ¥89.00 │ 36小时  │ [处理] │              │
│ │客服│ 5678 │ 王五    │ 咨询奖品│ 45分钟  │ [接入] │              │
│ └────┴──────┴────────┴────────┴────────┴────────┘              │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 📊 抽奖健康度分析

**优先级**: P1（短期实施）  
**目的**: 监控抽奖系统健康状态，预防问题

#### 核心指标

1. **档位分布健康度**

| 档位 | 当前占比 | 建议范围 | 健康度 |
|------|---------|---------|--------|
| high | 51.3% | 30-40% | ⚠️ 偏高 |
| mid | 6.5% | 15-25% | ⚠️ 偏低 |
| fallback | 42.2% | 40-50% | 🟢 正常 |

2. **用户体验指标**

| 指标 | 当前值 | 健康阈值 | 说明 |
|------|--------|---------|------|
| 空奖连续次数（P90） | 需统计 | ≤5次 | 超过5次连续空奖影响体验 |
| 保底触发率 | 需统计 | 5-15% | 过低说明配置合理，过高说明空奖过多 |
| 用户复抽率 | 需统计 | ≥60% | 衡量用户粘性 |

3. **预算健康度**

| 指标 | 计算方式 | 预警阈值 |
|------|---------|---------|
| 预算消耗速度 | 今日消耗 / 今日抽奖次数 | 超过均值30%预警 |
| 预算剩余天数 | 剩余预算 / 日均消耗 | ≤3天预警 |
| 高价值奖品发放率 | 高价值发放数 / 总发放数 | ≥10%预警 |

### 3.4 👥 用户画像分析

**优先级**: P1（短期实施）  
**目的**: 深入了解用户行为，支持精准运营

#### 用户分层模型

1. **按活跃度分层**

| 分层 | 定义 | 运营策略 |
|------|------|---------|
| 高活跃 | 7天内抽奖≥10次 | 维护留存，提供专属福利 |
| 中活跃 | 7天内抽奖3-9次 | 提升频次，推送活动提醒 |
| 低活跃 | 7天内抽奖1-2次 | 召回激活，发送优惠券 |
| 沉默 | 7天内无抽奖 | 流失预警，短信/推送召回 |

2. **按价值分层**

| 分层 | 定义 | 占比（估算） |
|------|------|-------------|
| 高价值 | 累计消费≥¥1000 或 资产≥10万钻石 | ~5% |
| 中价值 | 累计消费¥200-999 | ~25% |
| 普通用户 | 累计消费<¥200 | ~70% |

3. **用户行为分析维度**

- 抽奖行为路径分析
- 资产获取与消耗趋势
- 兑换偏好分析
- 活跃时段分析

---

## 🔧 四、现有页面数据丰富建议

### 4.1 用户管理页面增强

**当前缺失**：
- 用户资产汇总视图
- 用户行为轨迹
- 批量操作能力

**建议增加数据**：

```javascript
// 用户详情扩展数据结构
{
  // 基本信息（已有）
  user_id: 1,
  phone: '138****8888',
  nickname: '用户昵称',
  status: 'active',
  
  // 资产概览（新增）
  assets: {
    diamond_balance: 12500,      // 钻石余额
    diamond_frozen: 500,         // 冻结钻石
    item_count: 23,              // 持有物品数
    total_value: 156000          // 资产总价值（积分单位）
  },
  
  // 行为统计（新增）
  behavior: {
    total_draws: 45,             // 累计抽奖次数
    win_rate: 62.2,              // 个人中奖率
    last_draw_time: '2026-01-30', // 最后抽奖时间
    total_consumption: 2580000,  // 累计消费金额(分)
    consumption_count: 12        // 消费次数
  },
  
  // 风险标签（新增）
  risk_tags: ['高频用户', '大额交易'],
  
  // 最近操作记录（新增）
  recent_activities: [
    { type: 'draw', time: '2026-01-30 15:30', detail: '参与抽奖，获得红色碎片x5' },
    { type: 'trade', time: '2026-01-30 14:20', detail: '出售物品，获得钻石1000' }
  ]
}
```

**建议增加功能**：

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 资产总览卡片 | 在用户详情页显示资产汇总 | P0 |
| 行为轨迹时间线 | 展示用户最近操作记录 | P1 |
| 批量状态变更 | 支持批量禁用/启用用户 | P1 |
| 批量发放资产 | 支持批量给用户发放钻石/物品 | P2 |

### 4.2 抽奖管理页面增强

**当前问题**：
- 活动卡片指标不够完整
- 缺乏活动对比分析
- 预算预警不够直观

**建议增加数据**：

1. **活动健康度评分系统**

```javascript
// 活动健康度评分模型
{
  campaign_id: 1,
  health_score: 78,  // 综合评分（0-100）
  
  // 分项评分
  dimensions: {
    budget_health: 85,      // 预算健康度
    win_rate_health: 72,    // 中奖率健康度
    user_engagement: 80,    // 用户参与度
    prize_distribution: 65  // 奖品分布健康度
  },
  
  // 问题诊断
  issues: [
    { level: 'warning', message: '高档位奖品发放占比偏高（51%）' },
    { level: 'info', message: '建议增加中档位奖品比例' }
  ]
}
```

2. **实时数据看板增强**

```
今日数据（每5分钟刷新）
├─ 抽奖次数: 383 (↑22% vs 昨日同期)
├─ 参与用户: 28人 (↑12% vs 昨日同期)
├─ 总消耗预算: ¥3,820
├─ 人均抽奖: 13.7次
├─ 预算剩余预估: 2.3天
└─ 预警: 预算将在2.3天内耗尽，请及时补充或调整
```

3. **奖品库存预警增强**

| 奖品 | 当前库存 | 日均消耗 | 预计可用天数 | 状态 |
|------|---------|---------|-------------|------|
| 一等奖iPhone | 5 | 0.3 | 16天 | 🟢 充足 |
| 二等奖耳机 | 12 | 2.1 | 5.7天 | 🟡 关注 |
| 三等奖优惠券 | 8 | 5.2 | 1.5天 | 🔴 紧急 |

### 4.3 财务管理页面增强

**当前问题**：
- 消费记录审核缺乏批量操作
- 缺乏审核效率统计
- 无异常消费自动标记

**建议增加功能**：

1. **批量审核功能**

```
操作栏增强：
[全选] [批量通过] [批量拒绝] | 已选择: 5条

筛选条件：
[状态▼] [门店▼] [金额范围] [提交时间] [异常标记▼]
```

2. **异常标记系统**

| 异常类型 | 触发条件 | 标记 | 处理建议 |
|---------|---------|------|---------|
| 大额消费 | 金额 > ¥500 | 🔴 大额 | 重点核实 |
| 高频消费 | 同用户24h内>5次 | 🟡 高频 | 检查是否异常 |
| 新用户大额 | 注册<7天 且 金额>¥100 | 🟡 新用户大额 | 核实身份 |
| 跨店重复 | 同用户同日多店消费 | 🔵 跨店 | 正常关注 |

3. **审核效率仪表盘**

```
📊 审核效率统计（本周）
├─ 平均审核时长: 4.2小时 (↓12% vs 上周)
├─ 待处理队列: 8条
├─ 24小时超时率: 37.5%
├─ 本周处理量: 45条
└─ 通过率: 89%
```

### 4.4 统计报表页面增强

**当前问题**：
- 指标维度单一
- 缺乏对比分析
- 无下钻能力

**建议增加功能**：

1. **多维度分析**

```
维度选择器：[活动▼] [门店▼] [用户层级▼] [时间段▼]

按门店维度分析示例：
┌─────────┬──────────┬────────┬─────────┬──────────┐
│ 门店    │ 消费金额  │ 抽奖次数│ 用户数   │ 转化率   │
├─────────┼──────────┼────────┼─────────┼──────────┤
│ 门店A   │ ¥12,500  │ 120    │ 15      │ 8.2%    │
│ 门店B   │ ¥8,200   │ 85     │ 12      │ 7.5%    │
│ 门店C   │ ¥15,800  │ 156    │ 18      │ 9.1%    │
│ 门店D   │ ¥6,300   │ 52     │ 8       │ 6.8%    │
│ 门店E   │ ¥9,100   │ 78     │ 11      │ 7.2%    │
└─────────┴──────────┴────────┴─────────┴──────────┘
```

2. **同比/环比分析**

| 指标 | 本周 | 上周 | 环比 | 上月同期 | 同比 |
|------|------|------|------|---------|------|
| 抽奖次数 | 633 | 520 | +21.7% | 480 | +31.9% |
| 参与用户 | 28 | 24 | +16.7% | 22 | +27.3% |
| 中奖率 | 57.8% | 61.2% | -3.4% | 58.5% | -0.7% |

3. **自定义报表配置**

```
自定义报表配置：
├─ 报表名称: [我的日报]
├─ 指标选择: ☑抽奖次数 ☑中奖率 ☑预算消耗 ☐新增用户 ☑活跃用户
├─ 时间维度: [按日]
├─ 对比维度: [环比上周]
├─ 定时推送: ☑启用 [每日9:00] [邮箱/企微]
└─ [保存] [预览]
```

---

## 💡 五、运营效率提升功能

### 5.1 快捷操作面板

**位置**：工作台右上角浮动按钮或固定面板

```
⚡ 快捷操作
├─ 🔔 创建公告          → 跳转公告管理
├─ 🎁 调整奖品库存      → 打开库存调整弹窗
├─ 💎 用户钻石调整      → 打开钻石调整弹窗
├─ 📊 导出今日报表      → 生成并下载报表
├─ ⏸️ 临时关闭活动      → 确认后关闭当前活动
└─ 🔄 刷新缓存          → 清理系统缓存
```

### 5.2 智能提醒系统

**提醒规则配置**：

| 规则名称 | 触发条件 | 提醒内容 | 优先级 | 通知方式 |
|---------|---------|---------|--------|---------|
| 消费审核积压 | 待审核数 > 10 | 消费审核积压，请及时处理 | 高 | 页面+声音 |
| 预算告警 | 预算使用率 > 80% | 活动预算已使用80%，请评估 | 中 | 页面 |
| 高档位预警 | 高档位率 > 50% | 高档位奖品发放占比过高 | 高 | 页面 |
| 客服等待 | 等待会话 > 5 | 有5个客服会话在等待中 | 高 | 页面+声音 |
| 库存不足 | 任一奖品库存 < 3天 | 奖品库存即将耗尽 | 高 | 页面+声音 |
| 风控告警 | 有严重级别告警 | 检测到严重风控告警 | 紧急 | 页面+声音+短信 |

### 5.3 操作日志增强

**当前状态**：已有基本操作日志功能

**建议增强**：

1. **操作影响范围标记**

```javascript
{
  log_id: 12345,
  operator: '管理员A',
  operation: '批量发放钻石',
  time: '2026-01-30 15:30:00',
  
  // 新增：影响范围
  impact: {
    affected_users: 50,           // 影响用户数
    affected_amount: 500000,      // 影响金额
    risk_level: 'medium'          // 风险级别
  },
  
  // 新增：可回滚标记
  rollback: {
    supported: true,
    rollback_deadline: '2026-01-31 15:30:00'
  }
}
```

2. **高风险操作二次确认**

需要二次确认的操作：
- 批量发放资产（金额>10万）
- 批量修改用户状态
- 删除活动/奖品
- 修改系统配置

---

## 📋 六、实施优先级建议

### P0 - 立即实施（1-2周）

| 功能 | 预期收益 | 工作量估算 | 负责人 |
|------|---------|-----------|--------|
| 运营仪表盘 | 减少运营查看多个页面时间50% | 3-5天 | 待定 |
| 待处理中心 | 处理效率提升30%，避免遗漏 | 2-3天 | 待定 |
| 消费审核批量操作 | 审核效率提升60% | 1-2天 | 待定 |
| 侧边栏结构调整 | 导航效率提升 | 1天 | 待定 |

### P1 - 短期实施（2-4周）

| 功能 | 预期收益 | 工作量估算 | 负责人 |
|------|---------|-----------|--------|
| 抽奖健康度分析 | 提前发现问题，减少损失 | 3-5天 | 待定 |
| 用户画像分析 | 支持精准运营决策 | 5-7天 | 待定 |
| 统计报表增强（多维度） | 提升数据驱动决策质量 | 3-5天 | 待定 |
| 异常消费标记系统 | 提高审核准确性 | 2-3天 | 待定 |

### P2 - 中期实施（4-8周）

| 功能 | 预期收益 | 工作量估算 | 负责人 |
|------|---------|-----------|--------|
| 智能提醒系统 | 减少遗漏，提高响应速度 | 3-5天 | 待定 |
| 自定义报表 | 满足个性化分析需求 | 5-7天 | 待定 |
| 操作日志增强 | 提升安全性和可追溯性 | 3-5天 | 待定 |
| 用户行为轨迹 | 深入了解用户 | 3-5天 | 待定 |

---

## 🎯 七、关键成功指标（KPI）

### 7.1 运营效率指标

| 指标 | 当前基线 | 目标值 | 衡量方式 |
|------|---------|--------|---------|
| 页面切换次数 | ~20次/日 | 减少50% | 工具统计 |
| 待处理遗漏率 | 未统计 | <5% | 超时事项/总事项 |
| 平均审核时长 | ~4小时 | <2小时 | 系统统计 |
| 客服响应时间 | 未统计 | <15分钟 | 系统统计 |

### 7.2 数据洞察指标

| 指标 | 当前基线 | 目标值 | 衡量方式 |
|------|---------|--------|---------|
| 预警覆盖率 | ~30% | >90% | 预警触发/实际问题 |
| 数据分析维度 | 2-3个 | >10个 | 可用维度数 |
| 报表使用率 | 未统计 | >80% | 活跃运营/总运营 |

---

## 🔍 八、后端API复用评估（实际代码验证 2026-02-01）

> **重要说明**：本章节基于对后端实际代码的全面审查，评估现有API的复用情况，避免重复开发。
> 
> 验证方法：检查 `/routes/v4/console/` 目录下的路由文件和 `/services/` 目录下的服务文件。

### 8.1 运营数据概览页（Dashboard）

> **代码升级说明**（2026-01-31验证）：`ReportingService` 已重构拆分为 `StatsService` 和 `AnalyticsService`，位于 `services/reporting/` 目录下。原有方法签名保持兼容。

| 功能需求 | 现有后端API | 服务层方法 | 复用状态 |
|---------|------------|-----------|---------|
| 今日统计数据 | `GET /api/v4/console/analytics/stats/today` | `StatsService.getTodayStats()` | ✅ **完全复用** |
| 7天趋势数据 | `GET /api/v4/console/analytics/decisions/analytics?days=7` | `AnalyticsService.getDecisionAnalytics()` | ✅ **完全复用** |
| 抽奖趋势图表 | `GET /api/v4/console/analytics/lottery/trends` | `AnalyticsService.getLotteryTrends()` | ✅ **完全复用** |
| 运营预警列表 | `GET /api/v4/console/lottery-monitoring/realtime-alerts` | `LotteryAlertService` | ✅ **可复用** |
| 活动预算消耗 | `GET /api/v4/console/campaign-budget/batch-status` | `CampaignBudgetService` | ✅ **完全复用** |
| 待处理事项聚合 | 需从多个接口聚合 | - | ⚠️ **需新增** |

**后端新增工作**：1个聚合接口 `GET /api/v4/console/dashboard/pending-summary`（约0.5天）

### 8.2 抽奖监控看板

| 功能需求 | 现有后端API | 服务层方法 | 复用状态 |
|---------|------------|-----------|---------|
| 小时统计指标 | `GET /api/v4/console/lottery-monitoring/hourly-metrics` | `LotteryAnalyticsService.getHourlyMetrics()` | ✅ **完全复用** |
| 活动统计汇总 | `GET /api/v4/console/lottery-monitoring/hourly-metrics/summary/:campaign_id` | `LotteryAnalyticsService.getHourlyMetricsSummary()` | ✅ **完全复用** |
| 用户体验状态 | `GET /api/v4/console/lottery-monitoring/user-experience-states` | `LotteryAnalyticsService.getUserExperienceStates()` | ✅ **完全复用** |
| 用户配额状态 | `GET /api/v4/console/lottery-monitoring/user-quotas` | `LotteryAnalyticsService` | ✅ **完全复用** |
| 活动ROI分析 | `GET /api/v4/console/lottery-monitoring/campaign-roi/:campaign_id` | `LotteryAnalyticsService` | ✅ **完全复用** |
| 异常用户列表 | `GET /api/v4/console/lottery-monitoring/abnormal-users` | `LotteryAnalyticsService` | ✅ **完全复用** |
| 实时告警 | `GET /api/v4/console/lottery-monitoring/realtime-alerts` | `LotteryAlertService` | ✅ **完全复用** |
| 告警确认/解决 | `POST /api/v4/console/lottery-monitoring/realtime-alerts/:id/acknowledge` | `LotteryAlertService` | ✅ **完全复用** |
| 策略效果分析 | `GET /api/v4/console/lottery-monitoring/strategy-effectiveness` | `LotteryAnalyticsService` | ✅ **完全复用** |
| 活动健康度评分 | 需计算多维度分数 | - | ⚠️ **需新增** |
| 奖品库存预警 | 需从奖池数据计算 | - | ⚠️ **需新增** |

**后端新增工作**：2个计算接口（约1天）

### 8.3 客服会话管理

| 功能需求 | 现有后端API | 服务层方法 | 复用状态 |
|---------|------------|-----------|---------|
| 会话列表 | `GET /api/v4/console/customer-service/sessions` | `AdminCustomerServiceService.getSessionList()` | ✅ **完全复用** |
| 会话统计 | `GET /api/v4/console/customer-service/sessions/stats` | `AdminCustomerServiceService.getSessionStats()` | ✅ **完全复用** |
| 会话消息 | `GET /api/v4/console/customer-service/sessions/:session_id/messages` | `AdminCustomerServiceService` | ✅ **完全复用** |
| 发送消息 | `POST /api/v4/console/customer-service/sessions/:session_id/messages` | `AdminCustomerServiceService` | ✅ **完全复用** |
| 关闭会话 | `POST /api/v4/console/customer-service/sessions/:session_id/close` | `AdminCustomerServiceService` | ✅ **完全复用** |
| 标记已读 | `POST /api/v4/console/customer-service/sessions/:session_id/mark-read` | `AdminCustomerServiceService` | ✅ **完全复用** |
| 转接会话 | `POST /api/v4/console/customer-service/sessions/:session_id/transfer` | `AdminCustomerServiceService` | ✅ **完全复用** |

**后端新增工作**：**0天**（全部API已就绪）

### 8.4 风险告警中心

| 功能需求 | 现有后端API | 服务层方法 | 复用状态 |
|---------|------------|-----------|---------|
| 告警列表 | `GET /api/v4/console/risk-alerts` | `MerchantRiskControlService.queryRiskAlertsWithDetails()` | ✅ **完全复用** |
| 待处理告警 | `GET /api/v4/console/risk-alerts/pending` | `MerchantRiskControlService.getPendingAlerts()` | ✅ **完全复用** |
| 告警统计汇总 | `GET /api/v4/console/risk-alerts/stats/summary` | `MerchantRiskControlService` | ✅ **完全复用** |
| 门店告警统计 | `GET /api/v4/console/risk-alerts/stats/store/:store_id` | `MerchantRiskControlService` | ✅ **完全复用** |
| 告警类型列表 | `GET /api/v4/console/risk-alerts/types` | `MerchantRiskControlService` | ✅ **完全复用** |
| 告警详情 | `GET /api/v4/console/risk-alerts/:alert_id` | `MerchantRiskControlService` | ✅ **完全复用** |
| 复核告警 | `POST /api/v4/console/risk-alerts/:alert_id/review` | `MerchantRiskControlService` | ✅ **完全复用** |
| 批量标记已读 | `POST /api/v4/console/risk-alerts/mark-all-read` | `MerchantRiskControlService` | ✅ **完全复用** |

**后端新增工作**：**0天**（全部API已就绪）

### 8.5 消费核销管理

| 功能需求 | 现有后端API | 服务层方法 | 复用状态 |
|---------|------------|-----------|---------|
| 待审核列表 | `GET /api/v4/console/consumption/pending` | `ConsumptionService.getPendingConsumptionRecords()` | ✅ **完全复用** |
| 全部记录列表 | `GET /api/v4/console/consumption/records` | `ConsumptionService.getAdminRecords()` | ✅ **完全复用** |
| 审核通过 | `POST /api/v4/console/consumption/approve/:id` | `ConsumptionService` | ✅ **完全复用** |
| 审核拒绝 | `POST /api/v4/console/consumption/reject/:id` | `ConsumptionService` | ✅ **完全复用** |
| **批量审核** | 暂无 | - | ❌ **需新增** |
| **异常标记系统** | 暂无 | - | ❌ **需新增** |
| **审核效率统计** | 暂无 | - | ⚠️ **需新增** |

**后端新增工作**：3个接口（约1.5天）

### 8.6 API复用汇总

| 模块 | 可复用API | 需新增API | 后端工作量 | 前端可立即开发 |
|------|----------|----------|-----------|--------------|
| 运营数据概览页 | 5个 | 1个 | **0.5天** | ⚠️ 基本就绪 |
| 抽奖监控看板 | 9个 | 2个 | **1天** | ⚠️ 基本就绪 |
| 客服会话管理 | 7个 | 0个 | **0天** | ✅ **完全就绪** |
| 风险告警中心 | 8个 | 0个 | **0天** | ✅ **完全就绪** |
| 消费核销管理 | 4个 | 3个 | **1.5天** | ⚠️ 基本就绪 |
| **合计** | **33个** | **6个** | **3天** | - |

### 8.7 建议开发顺序（按API就绪度）

1. ✅ **客服会话管理** → 后端0工作量，前端可立即开发
2. ✅ **风险告警中心** → 后端0工作量，前端可立即开发
3. ⚠️ **运营数据概览页** → 后端0.5天，前端可先开发主体功能
4. ⚠️ **抽奖监控看板** → 后端1天，前端可先开发主体功能
5. ⚠️ **消费核销管理** → 后端1.5天，批量审核需后端配合

---

## 🔧 九、前后端工作内容划分

> 本章节按优先级详细划分每个功能的前端工作和后端/数据库工作内容

---

### 📋 任务划分汇总表（快速查阅）

#### 🗄️ 后端数据库项目任务清单（总计 18 天）✅ 已全部完成

> **✅ 状态说明**：后端 API 已于 2026-01-31 全部实现并验证通过，前端可直接调用。

| 阶段 | 任务编号 | 任务名称 | 类型 | 工作量 | 涉及表/服务 | 状态 |
|------|---------|---------|------|--------|------------|------|
| **P0** | B-5 | 待处理聚合接口 | 新增API | 0.5天 | `GET /api/v4/console/dashboard/pending-summary` | ✅ |
| **P0** | B-6 | 待处理汇总接口 | 新增API | 0.5天 | consumption_records, customer_service_sessions, risk_alerts, lottery_alerts | ✅ |
| **P0** | B-7 | 待处理列表接口 | 新增API | 1天 | 多表联合查询 | ✅ |
| **P0** | B-8 | 超时计算逻辑 | 服务逻辑 | 0.5天 | - | ✅ |
| **P0** | B-9 | 紧急事项筛选 | 服务逻辑 | 0.5天 | - | ✅ |
| **P0** | B-10 | 批量审核接口 | 新增API | 0.5天 | `POST /api/v4/admin/consumption/batch-review` | ✅ |
| **P0** | B-11 | 事务处理 | 服务逻辑 | 0.25天 | - | ✅ |
| **P0** | B-12 | 操作日志记录 | 服务逻辑 | 0.25天 | admin_operation_logs | ✅ |
| **P0** | B-13 | 徽标计数接口 | 新增API | 0.5天 | `GET /api/v4/admin/nav/badges` | ✅ |
| **P0** | B-13b | 徽标数据缓存 | Redis | 0.25天 | - | ✅ |
| **P0** | DB-1 | **创建索引** | **数据库** | **0.25天** | consumption_records, customer_service_sessions, lottery_draws | ✅ |
| | | **P0 后端小计** | | **5天** | | ✅ |
| **P1** | B-14 | 健康度计算服务 | 新增服务 | 1天 | `LotteryHealthService` | ✅ |
| **P1** | B-15 | 健康度接口 | 新增API | 0.5天 | `GET /api/v4/admin/lottery/health/{campaign_id}` | ✅ |
| **P1** | B-16 | 档位分布统计 | 服务逻辑 | 0.5天 | lottery_draws | ✅ |
| **P1** | B-17 | 问题诊断逻辑 | 服务逻辑 | 0.5天 | - | ✅ |
| **P1** | B-18 | 预算消耗速度计算 | 服务逻辑 | 0.5天 | lottery_campaigns, lottery_draws | ✅ |
| **P1** | B-19 | 用户分层服务 | 新增服务 | 1.5天 | `UserSegmentService` | ✅ |
| **P1** | B-20 | 分层统计接口 | 新增API | 0.5天 | `GET /api/v4/admin/users/segments` | ✅ |
| **P1** | B-21 | 分层用户列表接口 | 新增API | 0.5天 | `GET /api/v4/admin/users/segments/{type}` | ✅ |
| **P1** | B-22 | 活跃时段统计接口 | 新增API | 0.5天 | `GET /api/v4/admin/users/activity-heatmap` | ✅ |
| **P1** | B-23 | 兑换偏好接口 | 新增API | 0.5天 | `GET /api/v4/admin/users/exchange-preferences` | ✅ |
| **P1** | B-24 | 行为漏斗接口 | 新增API | 0.5天 | `GET /api/v4/admin/users/funnel` | ✅ |
| **P1** | B-25 | 多维度统计接口 | 新增API | 1.5天 | `GET /api/v4/admin/statistics/multi-dimension` | ✅ |
| **P1** | B-26 | 同比环比计算 | 服务逻辑 | 0.5天 | - | ✅ |
| **P1** | B-27 | 下钻明细接口 | 新增API | 0.5天 | `GET /api/v4/admin/statistics/drill-down` | ✅ |
| **P1** | B-28 | 异常检测服务 | 新增服务 | 1天 | `ConsumptionAnomalyService` | ✅ |
| **P1** | B-29 | 实时异常标记 | 服务逻辑 | 0.5天 | consumption_records | ✅ |
| **P1** | B-30 | 异常标记接口 | 修改API | 0.5天 | - | ✅ |
| **P1** | DB-2 | **表字段扩展** | **数据库** | **0.25天** | consumption_records (anomaly_flags, anomaly_score) | ✅ |
| | | **P1 后端小计** | | **6天** | | ✅ |
| **P2** | B-31 | 提醒规则引擎 | 新增服务 | 1.5天 | `AlertRuleEngine` | ✅ |
| **P2** | B-32 | 定时检测任务 | 定时任务 | 0.5天 | node-cron | ✅ |
| **P2** | B-33 | 提醒推送服务 | 新增服务 | 1天 | WebSocket + 短信 | ✅ |
| **P2** | B-34 | 提醒规则 CRUD | 新增API | 0.5天 | `POST/GET/PUT/DELETE /api/v4/admin/alert-rules` | ✅ |
| **P2** | B-35 | 提醒历史接口 | 新增API | 0.5天 | `GET /api/v4/admin/notifications` | ✅ |
| **P2** | B-36 | 报表模板 CRUD | 新增API | 0.5天 | `POST/GET/PUT/DELETE /api/v4/admin/report-templates` | ✅ |
| **P2** | B-37 | 动态报表生成 | 服务逻辑 | 1.5天 | 多表 | ✅ |
| **P2** | B-38 | 报表预览接口 | 新增API | 0.5天 | `POST /api/v4/admin/report-templates/preview` | ✅ |
| **P2** | B-39 | 定时推送任务 | 定时任务 | 1天 | node-cron | ✅ |
| **P2** | B-40 | 报表导出 | 服务逻辑 | 1天 | xlsx | ✅ |
| **P2** | B-41 | 扩展日志字段 | 服务逻辑 | 0.5天 | admin_operation_logs | ✅ |
| **P2** | B-42 | 回滚服务 | 新增服务 | 1.5天 | `OperationRollbackService` | ✅ |
| **P2** | B-43 | 回滚接口 | 新增API | 0.5天 | `POST /api/v4/admin/operations/{log_id}/rollback` | ✅ |
| **P2** | B-44 | 高风险操作中间件 | 中间件 | 0.5天 | - | ✅ |
| **P2** | B-45 | 审计统计接口 | 新增API | 0.5天 | `GET /api/v4/admin/operations/audit-report` | ✅ |
| **P2** | B-46 | 行为轨迹聚合 | 新增服务 | 1天 | `UserActivityService` | ✅ |
| **P2** | B-47 | 轨迹列表接口 | 新增API | 0.5天 | `GET /api/v4/admin/users/{user_id}/activities` | ✅ |
| **P2** | B-48 | 轨迹详情接口 | 新增API | 0.5天 | `GET /api/v4/admin/users/activities/{activity_id}` | ✅ |
| **P2** | B-49 | 轨迹导出服务 | 服务逻辑 | 0.5天 | xlsx | ✅ |
| **P2** | DB-3 | **新增表** | **数据库** | **0.5天** | admin_reminder_rules, admin_report_templates | ✅ |
| **P2** | DB-4 | **表字段扩展** | **数据库** | **0.25天** | admin_operation_logs (affected_users, risk_level, rollback_*) | ✅ |
| | | **P2 后端小计** | | **7天** | | ✅ |

---

#### 🎨 前端项目任务清单（总计 20 天）

> **🔴 重要提醒**：前端开发必须直接使用后端返回的字段名（`snake_case` 风格），禁止做字段映射或转换。如发现旧代码使用了非标准字段名，直接修改前端代码适配后端。参考本文档「后端 API 字段规范参考」章节。

---

### 📋 前端现状分析（基于实际代码审查 2026-02-01）

#### 技术栈验证 ✅

| 技术 | 版本 | 用途 | 验证结果 |
|------|------|------|---------|
| Vite | 6.4.1 | 构建工具 | ✅ 最新 |
| Alpine.js | 3.15.4 | 响应式框架 | ✅ 最新 |
| ECharts | 6.0.0 | 图表库 | ✅ 最新 |
| Tailwind CSS | 3.4.19 | CSS 框架 | ✅ 最新 |
| Socket.io-client | 4.8.3 | WebSocket 客户端 | ✅ 已集成 |

#### 现有页面清单（共 28 个页面）

| 文件 | 页面名称 | 当前位置 | 状态 |
|------|---------|---------|------|
| `workspace.html` | 工作台主框架 | 独立入口 | ✅ 存在 |
| `statistics.html` | 数据统计报表 | 侧边栏-工作台 | ✅ 存在 |
| `finance-management.html` | 财务管理（消费审核） | 日常运营 | 🔧 需增强 |
| `customer-service.html` | 客服工作台 | 日常运营 | ✅ 存在 |
| `risk-alerts.html` | 风控告警 | 日常运营 | ✅ 存在 |
| `lottery-alerts.html` | 抽奖告警 | 抽奖运营 | 🔧 需增强 |
| `lottery-management.html` | 抽奖活动管理 | 抽奖运营 | ✅ 存在 |
| `asset-management.html` | 资产管理 | 资产中心 | ✅ 存在 |
| `user-management.html` | 用户权限管理 | 用户门店 | ✅ 存在 |
| `analytics.html` | 运营分析 | 数据分析 | ✅ 存在 |

#### 现有 Alpine.js 组件（共 22 个）

| 组件 | 文件 | 可复用场景 |
|------|------|-----------|
| `data-table.js` | 数据表格 | 待处理列表、用户分层列表、多维度表格 |
| `stats-cards.js` | 统计卡片 | 仪表盘顶部指标、待处理汇总 |
| `filter-bar.js` | 筛选栏 | 类型筛选、维度选择 |
| `modal.js` | 弹窗组件 | 快捷处理弹窗、确认弹窗 |
| `sidebar-nav.js` | 侧边栏导航 | 导航调整、徽标显示 |
| `workspace-tabs.js` | 工作台 Tab | Tab 页面模式 |
| `mini-chart.js` | 迷你图表 | 趋势小图 |
| `animated-counter.js` | 数字动画 | 指标数值动画 |
| `toast.js` | Toast 提示 | 操作反馈 |
| `pagination.js` | 分页组件 | 列表分页 |
| `virtual-list.js` | 虚拟列表 | 大数据量列表 |
| `file-upload.js` | 文件上传 | 图片/文件上传 |

---

### 📊 改动清单汇总

#### 🆕 需新增的页面/Tab（3 个）

| 实现方式 | 功能说明 | 优先级 | 工作量 | 状态 |
|---------|---------|--------|--------|------|
| `workspace.html` 内置 Tab | 运营仪表盘 | P0 | 3天 | ✅ 已确认 |
| `workspace.html` 内置 Tab | 待处理中心（默认激活） | P0 | 2.5天 | ✅ 已确认 |
| `reminder-rules.html` | 提醒规则配置（P2） | P2 | 1天 | 待开发 |

#### 🔧 需增强功能的页面（5 个）

| 页面文件 | 增强内容 | 优先级 | 工作量 |
|---------|---------|--------|--------|
| `finance-management.html` | 批量选择/操作、异常标记、异常统计面板 | P0+P1 | 2天 |
| `lottery-alerts.html` | 健康度分析 Tab、仪表盘、档位分布图 | P1 | 3天 |
| `sidebar-nav.js` | 导航结构调整、待处理徽标、实时更新 | P0 | 1天 |
| `user-management.html` | 用户画像弹窗/Tab、分层饼图、行为漏斗 | P1 | 3天 |
| `statistics.html` | 多维度分析、维度选择器、数据下钻 | P1 | 2天 |

#### 📍 侧边栏结构调整（已确认 2026-02-01）

> **🔴 核心设计理念**：
> - **待办优先**：运营人员上班第一件事是看待办，不是看数据
> - **告警统一**：风险相关功能统一入口，不遗漏告警
> - **高频优先**：日常运营只放每天都要用的功能
> - **低频下沉**：配置类功能移到系统设置

**最终侧边栏结构**（8 个一级分组）：

```
🔔 待处理中心          ← 置顶第1位，带总数徽标，默认激活 Tab
   （工作台 Tab 模式，无子菜单）
───────────────────────────────────────────────────────
📊 运营仪表盘          ← 第2位，工作台 Tab 模式
   （工作台 Tab 模式，无子菜单）
───────────────────────────────────────────────────────
📋 日常运营            ← 精简后仅 3 个子项
   ├─ 消费记录审核     ← 带待审核数徽标
   ├─ 客服工作台       ← 带待处理数徽标
   └─ 内容管理
───────────────────────────────────────────────────────
🚨 风控中心            ← 新增分组，合并风控+抽奖告警
   ├─ 风控告警         ← 带告警数徽标
   └─ 抽奖告警         ← 带告警数徽标
───────────────────────────────────────────────────────
🎰 抽奖运营            ← 保持原有结构
   ├─ 实时监控         ← live 标签
   ├─ 活动管理
   ├─ 奖品配置
   ├─ 预算控制
   ├─ 策略配置
   └─ 干预预设
───────────────────────────────────────────────────────
💎 资产交易            ← 合并原资产中心+市场交易
   ├─ 资产管理         ← 包含资产组合 Tab
   ├─ 资产调整
   ├─ 兑换市场
   └─ C2C 交易
───────────────────────────────────────────────────────
👥 用户门店            ← 保持原有结构
   ├─ 用户管理
   ├─ 用户层级
   └─ 门店管理
───────────────────────────────────────────────────────
📈 数据分析            ← 保持原有结构
   ├─ 统计报表
   └─ 运营分析
───────────────────────────────────────────────────────
⚙️ 系统设置            ← 扩展后 6 个子项
   ├─ 系统配置
   ├─ 物品模板         ← 从日常运营移入
   ├─ 字典管理         ← 从日常运营移入
   ├─ 定价配置         ← 从日常运营移入
   ├─ 功能开关         ← 从日常运营移入
   └─ 配置工具         ← 包含孤儿清理、物料转换、会话管理
```

**调整汇总表**：

| 调整类型 | 菜单项 | 原位置 | 新位置 | 状态 |
|---------|--------|--------|--------|------|
| **🆕 新增置顶** | 待处理中心 | 无 | 侧边栏第1位（Tab 模式） | ✅ 已确认 |
| **🆕 新增** | 运营仪表盘 | 无 | 侧边栏第2位（Tab 模式） | ✅ 已确认 |
| **🔄 合并** | 风控告警 | 日常运营 | 风控中心 | ✅ 已确认 |
| **🔄 合并** | 抽奖告警 | 抽奖运营 | 风控中心 | ✅ 已确认 |
| **🔄 合并** | 资产中心 + 市场交易 | 2 个分组 | 资产交易（1 个分组） | ✅ 已确认 |
| **➡️ 移动** | 物品模板 | 日常运营 | 系统设置 | ✅ 已确认 |
| **➡️ 移动** | 字典管理 | 日常运营 | 系统设置 | ✅ 已确认 |
| **➡️ 移动** | 定价配置 | 日常运营 | 系统设置 | ✅ 已确认 |
| **➡️ 移动** | 功能开关 | 日常运营 | 系统设置 | ✅ 已确认 |
| **🔻 整合** | 孤儿冻结清理 | 资产中心 | 配置工具子功能 | ✅ 已确认 |
| **🔻 整合** | 物料转换规则 | 资产中心 | 配置工具子功能 | ✅ 已确认 |
| **🔻 整合** | 资产组合 | 资产中心 | 资产管理 Tab | ✅ 已确认 |
| **🔻 整合** | 会话管理 | 系统设置 | 配置工具子功能 | ✅ 已确认 |

**效果预期**：
- ✅ 一级分组数量：8 个（原 8 个，结构更清晰）
- ✅ 「日常运营」子项：3 个（原 8 个，减少 62%）
- ✅ 告警功能：统一入口，不遗漏
- ✅ 配置功能：统一归类，减少视觉噪音

---

### 📋 详细任务清单

| 阶段 | 任务编号 | 任务名称 | 类型 | 工作量 | 涉及文件 |
|------|---------|---------|------|--------|----------|
| **P0** | F-1 | 新建仪表盘页面 | 新增 Tab | 0.5天 | `workspace.html` 内置 Tab（已确认） |
| **P0** | F-2 | 顶部指标卡片组件 | 组件开发 | 1天 | 复用 `stats-cards.js` |
| **P0** | F-3 | 趋势图表组件 | 组件开发 | 1天 | ECharts，复用 `statistics.html` |
| **P0** | F-4 | 运营预警列表组件 | 组件开发 | 0.5天 | 复用 `lottery-alerts.html` |
| **P0** | F-5 | 快捷操作按钮组 | 组件开发 | 0.5天 | - |
| **P0** | F-6 | 时间范围切换器 | 组件开发 | 0.5天 | - |
| **P0** | F-7 | 数据自动刷新 | 功能逻辑 | 0.5天 | - |
| **P0** | F-8 | 侧边栏导航调整 | 修改配置 | 0.5天 | `sidebar-nav.js` |
| **P0** | F-9 | 新建待处理中心页面 | 新增 Tab | 0.5天 | `workspace.html` 内置 Tab（已确认，默认激活） |
| **P0** | F-10 | 汇总统计卡片 | 组件开发 | 0.5天 | 复用 `stats-cards.js` |
| **P0** | F-11 | 紧急事项区域 | 组件开发 | 0.5天 | - |
| **P0** | F-12 | 统一待处理列表 | 组件开发 | 1天 | 复用 `data-table.js` |
| **P0** | F-13 | 快捷处理弹窗 | 组件开发 | 1天 | 复用 `modal.js` |
| **P0** | F-14 | 超时计时器 | 功能逻辑 | 0.5天 | - |
| **P0** | F-15 | 类型筛选器 | 组件开发 | 0.5天 | 复用 `filter-bar.js` |
| **P0** | F-16 | 批量选择功能 | 功能增强 | 0.5天 | `finance-management.html` |
| **P0** | F-17 | 批量操作工具栏 | 功能增强 | 0.5天 | `finance-management.html` |
| **P0** | F-18 | 已选计数显示 | 功能增强 | 0.25天 | `finance-management.html` |
| **P0** | F-19 | 批量操作结果提示 | 功能增强 | 0.25天 | `finance-management.html` |
| **P0** | F-20 | 修改导航配置 | 修改配置 | 0.5天 | `sidebar-nav.js` |
| **P0** | F-21 | 新增分组图标 | 修改配置 | 0.25天 | `sidebar-nav.js` |
| **P0** | F-22 | 待处理数量徽标 | 功能增强 | 0.5天 | `sidebar-nav.js` |
| **P0** | F-22b | 徽标实时更新 | 功能增强 | 0.25天 | WebSocket 或轮询 |
| | | **P0 前端小计** | | **5天** | |
| **P1** | F-23 | 新建健康度分析Tab | 功能增强 | 0.5天 | 扩展 `lottery-alerts.html` |
| **P1** | F-24 | 健康度仪表盘 | 组件开发 | 1天 | ECharts |
| **P1** | F-25 | 档位分布图 | 组件开发 | 0.5天 | ECharts 饼图 |
| **P1** | F-26 | 问题诊断列表 | 组件开发 | 0.5天 | - |
| **P1** | F-27 | 健康度趋势图 | 组件开发 | 0.5天 | ECharts |
| **P1** | F-28 | 预算健康度展示 | 组件开发 | 0.5天 | 复用 `stats-cards.js` |
| **P1** | F-29 | 新建用户画像页面 | 新增页面 | 0.5天 | `user-analytics.html` 或扩展详情弹窗 |
| **P1** | F-30 | 用户分层饼图 | 组件开发 | 1天 | ECharts |
| **P1** | F-31 | 分层用户列表 | 组件开发 | 1天 | 复用 `data-table.js` |
| **P1** | F-32 | 用户活跃时段热力图 | 组件开发 | 1天 | ECharts 热力图 |
| **P1** | F-33 | 兑换偏好分析 | 组件开发 | 0.5天 | - |
| **P1** | F-34 | 用户行为漏斗图 | 组件开发 | 1天 | ECharts 漏斗图 |
| **P1** | F-35 | 维度选择器 | 组件开发 | 0.5天 | 复用 `filter-bar.js` |
| **P1** | F-36 | 多维度表格 | 组件开发 | 1天 | 复用 `data-table.js` |
| **P1** | F-37 | 同比/环比显示 | 功能增强 | 0.5天 | - |
| **P1** | F-38 | 数据下钻功能 | 功能增强 | 1天 | - |
| **P1** | F-39 | 图表联动 | 功能增强 | 0.5天 | - |
| **P1** | F-40 | 异常标记展示 | 功能增强 | 0.5天 | `finance-management.html` |
| **P1** | F-41 | 异常类型筛选 | 功能增强 | 0.5天 | `finance-management.html` |
| **P1** | F-42 | 异常详情提示 | 功能增强 | 0.25天 | `finance-management.html` |
| **P1** | F-43 | 异常统计面板 | 组件开发 | 0.5天 | `finance-management.html` |
| | | **P1 前端小计** | | **7天** | |
| **P2** | F-44 | 提醒通知组件 | 组件开发 | 1天 | 页面右上角下拉框 |
| **P2** | F-45 | 声音提醒功能 | 功能开发 | 0.5天 | Audio API |
| **P2** | F-46 | 提醒规则配置页 | 新增页面 | 1天 | - |
| **P2** | F-47 | 消息中心页面 | 新增页面 | 1天 | - |
| **P2** | F-48 | WebSocket 集成 | 功能开发 | 0.5天 | Socket.io Client |
| **P2** | F-49 | 报表配置向导 | 组件开发 | 1.5天 | - |
| **P2** | F-50 | 指标选择器 | 组件开发 | 0.5天 | - |
| **P2** | F-51 | 维度/时间配置 | 组件开发 | 0.5天 | - |
| **P2** | F-52 | 报表预览 | 组件开发 | 1天 | 复用 `statistics.html` |
| **P2** | F-53 | 我的报表列表 | 组件开发 | 0.5天 | 复用 `data-table.js` |
| **P2** | F-54 | 定时推送配置 | 组件开发 | 0.5天 | - |
| **P2** | F-55 | 影响范围展示 | 功能增强 | 0.5天 | 操作日志页 |
| **P2** | F-56 | 风险级别标记 | 功能增强 | 0.25天 | 操作日志页 |
| **P2** | F-57 | 回滚按钮 | 功能增强 | 0.5天 | 操作日志页 |
| **P2** | F-58 | 二次确认弹窗 | 组件开发 | 0.5天 | 复用 `modal.js` |
| **P2** | F-59 | 操作审计报告 | 新增页面 | 1天 | - |
| **P2** | F-60 | 轨迹时间线组件 | 组件开发 | 1天 | 用户详情弹窗 |
| **P2** | F-61 | 行为类型图标 | 样式开发 | 0.25天 | - |
| **P2** | F-62 | 轨迹筛选器 | 组件开发 | 0.5天 | 复用 `filter-bar.js` |
| **P2** | F-63 | 轨迹详情弹窗 | 组件开发 | 0.5天 | 复用 `modal.js` |
| **P2** | F-64 | 轨迹导出 | 功能开发 | 0.5天 | - |
| | | **P2 前端小计** | | **8天** | |

---

### 📊 工作量汇总

| 项目 | P0 (1-2周) | P1 (2-4周) | P2 (4-8周) | 总计 |
|------|-----------|-----------|-----------|------|
| **后端数据库项目** | 5天 | 6天 | 7天 | **18天** |
| **前端项目** | 5天 | 7天 | 8天 | **20天** |
| **合计** | **10天** | **13天** | **15天** | **38天** |

---

### 9.1 P0 - 立即实施（1-2周）

#### 9.1.1 运营仪表盘（Dashboard）

**前端工作内容**：

| 序号 | 工作项 | 描述 | 工作量 |
|------|--------|------|--------|
| F-1 | 新建页面文件 | 创建 `dashboard.html` 页面 | 0.5天 |
| F-2 | 顶部指标卡片组件 | 开发 5 个核心指标卡片（今日抽奖、中奖率、预算消耗、活跃用户、待处理事项） | 1天 |
| F-3 | 趋势图表组件 | 使用 ECharts 开发 7 天趋势折线图，支持切换指标 | 1天 |
| F-4 | 运营预警列表组件 | 开发预警条目列表，支持不同级别颜色区分 | 0.5天 |
| F-5 | 快捷操作按钮组 | 开发底部快捷操作按钮，跳转对应页面 | 0.5天 |
| F-6 | 时间范围切换器 | 开发今日/本周/本月切换功能 | 0.5天 |
| F-7 | 数据自动刷新 | 实现 5 分钟定时刷新机制 | 0.5天 |
| F-8 | 侧边栏导航调整 | 修改 `sidebar-nav.js`，将仪表盘设为首页 | 0.5天 |

**后端/数据库工作内容**（基于8.1节API复用评估）：

| 序号 | 工作项 | 现有API可复用 | 新增工作 | 工作量 |
|------|--------|-------------|---------|--------|
| B-1 | 今日统计数据 | ✅ `GET /api/v4/console/analytics/stats/today` | 无 | 0天 |
| B-2 | 趋势数据 | ✅ `GET /api/v4/console/analytics/decisions/analytics` | 无 | 0天 |
| B-3 | 预警列表 | ✅ `GET /api/v4/console/lottery-monitoring/realtime-alerts` | 无 | 0天 |
| B-4 | 预算消耗 | ✅ `GET /api/v4/console/campaign-budget/batch-status` | 无 | 0天 |
| B-5 | 待处理聚合 | ❌ 需新增 | `GET /api/v4/console/dashboard/pending-summary` | 0.5天 |

**后端总工作量**：**0.5天**（较原估算3天减少83%）

**数据库变更**：无需新增表，仅需优化查询

---

#### 9.1.2 待处理中心

**前端工作内容**：

| 序号 | 工作项 | 描述 | 工作量 |
|------|--------|------|--------|
| F-9 | 新建页面文件 | 创建 `pending-center.html` 页面 | 0.5天 |
| F-10 | 汇总统计卡片 | 开发顶部 5 类待处理事项统计卡片 | 0.5天 |
| F-11 | 紧急事项区域 | 开发超时预警事项列表，红色高亮显示 | 0.5天 |
| F-12 | 统一待处理列表 | 开发可筛选、可排序的混合类型待处理列表 | 1天 |
| F-13 | 快捷处理弹窗 | 开发不同类型事项的快捷处理弹窗 | 1天 |
| F-14 | 超时计时器 | 实现等待时间实时计算和显示 | 0.5天 |
| F-15 | 类型筛选器 | 开发按事项类型筛选功能 | 0.5天 |

**后端/数据库工作内容**：

| 序号 | 工作项 | 描述 | 涉及表 | 工作量 |
|------|--------|------|--------|--------|
| B-6 | 待处理汇总接口 | `GET /api/v4/admin/pending/summary` 返回各类待处理数量 | consumption_records, customer_service_sessions, risk_alerts, lottery_alerts, lottery_presets | 0.5天 |
| B-7 | 待处理列表接口 | `GET /api/v4/admin/pending/list` 返回统一格式的待处理列表 | 多表联合 | 1天 |
| B-8 | 超时计算逻辑 | 根据创建时间计算超时状态和等待时长 | - | 0.5天 |
| B-9 | 紧急事项筛选 | 筛选超过预设阈值的紧急待处理事项 | - | 0.5天 |

**数据库变更**（P0阶段一并执行）：
```sql
-- P0阶段必需索引：为常用查询添加索引，提升待处理中心查询性能
CREATE INDEX idx_consumption_status_created ON consumption_records(status, created_at);
CREATE INDEX idx_sessions_status_created ON customer_service_sessions(status, created_at);
CREATE INDEX idx_lottery_draws_created ON lottery_draws(created_at);
```

---

#### 9.1.3 消费审核批量操作

**前端工作内容**：

| 序号 | 工作项 | 描述 | 工作量 |
|------|--------|------|--------|
| F-16 | 批量选择功能 | 为列表添加复选框，支持全选/反选 | 0.5天 |
| F-17 | 批量操作工具栏 | 开发批量通过/批量拒绝按钮和确认弹窗 | 0.5天 |
| F-18 | 已选计数显示 | 实时显示已选择的记录数量 | 0.25天 |
| F-19 | 批量操作结果提示 | 开发操作成功/失败的结果汇总提示 | 0.25天 |

**后端/数据库工作内容**：

| 序号 | 工作项 | 描述 | 涉及表 | 工作量 |
|------|--------|------|--------|--------|
| B-10 | 批量审核接口 | `POST /api/v4/admin/consumption/batch-review` 批量审核消费记录 | consumption_records | 0.5天 |
| B-11 | 事务处理 | 确保批量操作的原子性，失败时回滚 | - | 0.25天 |
| B-12 | 操作日志记录 | 批量操作需记录到 admin_operation_logs | admin_operation_logs | 0.25天 |

---

#### 9.1.4 侧边栏结构调整（已决策 ✅）

> **调整原则**：待处理中心置顶、合并资产交易、拆散日常运营

**前端工作内容**：

| 序号 | 工作项 | 描述 | 工作量 |
|------|--------|------|--------|
| F-20 | 修改导航配置 | 调整 `sidebar-nav.js` 中的导航结构（详见下方代码） | 0.5天 |
| F-21 | 新增分组图标 | 为「待处理中心」「运营仪表盘」添加图标 | 0.25天 |
| F-22 | 待处理数量徽标 | 在侧边栏显示待处理事项数量红点/徽标 | 0.5天 |
| F-22b | 徽标实时更新 | 通过 WebSocket 或轮询实时更新徽标数字 | 0.25天 |

**`sidebar-nav.js` 调整示例**（基于实际代码结构 2026-02-01）：

> **🔴 注意**：以下代码使用后端 `sidebar-nav.js` 的实际属性命名规范（`name`、`url`、`badgeKey`），禁止使用 `label`、`href`、`badge` 等变体。

```javascript
// 文件路径: admin/src/alpine/components/sidebar-nav.js
// 调整后的导航结构 navGroups
navGroups: [
  // 🔴 新增：待处理中心（置顶第1位）
  {
    id: 'pending-center',
    name: '待处理中心',
    icon: '🔔',
    type: 'single',
    url: '/admin/pending-center.html',
    badgeKey: 'totalPendingCount'  // 显示总待处理数
  },
  // 🔴 新增：运营仪表盘（第2位）
  {
    id: 'dashboard',
    name: '运营仪表盘',
    icon: '📊',
    type: 'single',
    url: '/admin/dashboard.html'
  },
  // 保留：日常运营（精简后）
  {
    id: 'operations',
    name: '日常运营',
    icon: '📋',
    items: [
      { id: 'consumption', name: '消费记录审核', url: '/admin/finance-management.html', badgeKey: 'consumptionPendingCount' },
      { id: 'customer', name: '客服工作台', url: '/admin/customer-service.html', badgeKey: 'customerPendingCount' },
      { id: 'content', name: '内容管理', url: '/admin/content-management.html' }
    ]
  },
  // 🔴 新增：风控中心（合并风控告警+抽奖告警）
  {
    id: 'risk-center',
    name: '风控中心',
    icon: '🚨',
    items: [
      { id: 'risk', name: '风控告警', url: '/admin/risk-alerts.html', badgeKey: 'pendingAlertCount' },
      { id: 'lottery-alerts', name: '抽奖告警', url: '/admin/lottery-alerts.html', badgeKey: 'lotteryAlertCount' }
    ]
  },
  // 保留：抽奖运营
  {
    id: 'lottery-ops',
    name: '抽奖运营',
    icon: '🎰',
    items: [
      { id: 'lottery-monitoring', name: '实时监控', url: '/admin/lottery-management.html?page=lottery-metrics', badge: 'live' },
      { id: 'lottery-campaigns', name: '活动管理', url: '/admin/lottery-management.html?page=campaigns' },
      { id: 'lottery-prizes', name: '奖品配置', url: '/admin/lottery-management.html?page=prizes' },
      { id: 'lottery-budget', name: '预算控制', url: '/admin/lottery-management.html?page=campaign-budget' },
      { id: 'lottery-strategy', name: '策略配置', url: '/admin/lottery-management.html?page=lottery-strategy' },
      { id: 'lottery-presets', name: '干预预设', url: '/admin/presets.html' }
    ]
  },
  // 🔴 合并：资产交易（原资产中心+市场交易）
  {
    id: 'asset-trade',
    name: '资产交易',
    icon: '💎',
    items: [
      { id: 'asset-mgmt', name: '资产管理', url: '/admin/asset-management.html' },
      { id: 'asset-adj', name: '资产调整', url: '/admin/asset-adjustment.html' },
      { id: 'exchange', name: '兑换市场', url: '/admin/exchange-market.html' },
      { id: 'trade', name: 'C2C交易', url: '/admin/trade-management.html' }
    ]
  },
  // 保留：用户门店
  {
    id: 'users',
    name: '用户门店',
    icon: '👥',
    items: [
      { id: 'user-mgmt', name: '用户管理', url: '/admin/user-management.html' },
      { id: 'user-hierarchy', name: '用户层级', url: '/admin/user-hierarchy.html' },
      { id: 'stores', name: '门店管理', url: '/admin/store-management.html' }
    ]
  },
  // 保留：数据分析
  {
    id: 'analytics',
    name: '数据分析',
    icon: '📈',
    items: [
      { id: 'stats', name: '统计报表', url: '/admin/statistics.html' },
      { id: 'analytics', name: '运营分析', url: '/admin/analytics.html' }
    ]
  },
  // 🔴 扩展：系统设置（移入原日常运营的配置项）
  {
    id: 'system',
    name: '系统设置',
    icon: '⚙️',
    items: [
      { id: 'settings', name: '系统配置', url: '/admin/system-settings.html' },
      { id: 'item-tpl', name: '物品模板', url: '/admin/item-templates.html' },
      { id: 'dict', name: '字典管理', url: '/admin/dict-management.html' },
      { id: 'pricing', name: '定价配置', url: '/admin/pricing-config.html' },
      { id: 'feature-flags', name: '功能开关', url: '/admin/feature-flags.html' },
      { id: 'config-tools', name: '配置工具', url: '/admin/config-tools.html' }
    ]
  }
]
```

**徽标计数新增属性**：

```javascript
// 在 sidebar-nav.js 中新增徽标计数属性
// 总待处理数量
totalPendingCount: 0,
// 消费审核待处理数量
consumptionPendingCount: 0,
// 客服会话待处理数量
customerPendingCount: 0,

// 新增徽标获取方法（调用后端 API）
async fetchAllBadgeCounts() {
  try {
    const token = localStorage.getItem('admin_token')
    if (!token) return
    
    // 调用后端 nav/badges 接口
    const response = await fetch('/api/v4/console/nav/badges', {
      headers: { Authorization: `Bearer ${token}` }
    })
    
    if (response.ok) {
      const data = await response.json()
      if (data.success && data.data) {
        // 🔴 直接使用后端返回的字段名
        this.totalPendingCount = data.data.total || 0
        this.consumptionPendingCount = data.data.badges?.consumption || 0
        this.customerPendingCount = data.data.badges?.customer_service || 0
        this.pendingAlertCount = data.data.badges?.risk_alert || 0
        this.lotteryAlertCount = data.data.badges?.lottery_alert || 0
      }
    }
  } catch (error) {
    console.warn('获取徽标计数失败:', error.message)
  }
}
```

**后端/数据库工作内容**：

| 序号 | 工作项 | 描述 | 涉及表 | 工作量 |
|------|--------|------|--------|--------|
| B-13 | 徽标计数接口 | `GET /api/v4/admin/nav/badges` 返回各菜单待处理数量 | 多表 | 0.5天 |
| B-13b | 徽标数据缓存 | 使用 Redis 缓存徽标数量，减少数据库压力 | - | 0.25天 |

**徽标接口响应格式**（后端实际返回）：

> **🔴 注意**：前端必须直接使用以下字段名，禁止做任何映射。

```json
{
  "success": true,
  "data": {
    "badges": {
      "consumption": 8,           // 待审核消费记录数
      "customer_service": 10,     // 待处理客服会话数
      "risk_alert": 0,            // 待处理风控告警数
      "lottery_alert": 0          // 待处理抽奖告警数
    },
    "total": 18,                   // 总待处理数
    "updated_at": "2026-01-31T14:30:00.000+08:00"
  },
  "message": "获取成功"
}
```

**前端使用示例**：
```javascript
// ✅ 正确：直接使用后端返回的字段名
const { badges, total, updated_at } = response.data
this.consumptionCount = badges.consumption
this.customerServiceCount = badges.customer_service  // 使用 customer_service，非 customer
this.riskAlertCount = badges.risk_alert              // 使用 risk_alert，非 risk
this.lotteryAlertCount = badges.lottery_alert        // 使用 lottery_alert，非 lottery
this.totalCount = total

// ❌ 错误：禁止做字段映射
// const mappedBadges = {
//   customer: badges.customer_service,  // ❌ 禁止
//   risk: badges.risk_alert             // ❌ 禁止
// }
```

---

### 9.2 P1 - 短期实施（2-4周）

#### 9.2.1 抽奖健康度分析

**前端工作内容**：

| 序号 | 工作项 | 描述 | 工作量 |
|------|--------|------|--------|
| F-23 | 新建页面/Tab | 在抽奖管理页面新增"健康度分析"Tab | 0.5天 |
| F-24 | 健康度仪表盘 | 开发环形图/仪表盘展示综合评分 | 1天 |
| F-25 | 档位分布图 | 开发饼图展示 high/mid/fallback 分布 | 0.5天 |
| F-26 | 问题诊断列表 | 开发问题诊断和建议列表 | 0.5天 |
| F-27 | 健康度趋势图 | 开发健康度历史趋势折线图 | 0.5天 |
| F-28 | 预算健康度展示 | 开发预算相关指标卡片 | 0.5天 |

**后端/数据库工作内容**：

| 序号 | 工作项 | 描述 | 涉及表 | 工作量 |
|------|--------|------|--------|--------|
| B-14 | 健康度计算服务 | 创建 `LotteryHealthService`，实现健康度评分算法 | lottery_draws, lottery_campaigns, lottery_prizes | 1天 |
| B-15 | 健康度接口 | `GET /api/v4/admin/lottery/health/{campaign_id}` | - | 0.5天 |
| B-16 | 档位分布统计 | 计算各档位发放数量和占比 | lottery_draws | 0.5天 |
| B-17 | 问题诊断逻辑 | 根据阈值判断问题类型和严重程度 | - | 0.5天 |
| B-18 | 预算消耗速度计算 | 计算日均消耗、预计剩余天数 | lottery_campaigns, lottery_draws | 0.5天 |

**数据库变更**：
```sql
-- 可选：新增健康度快照表用于历史趋势
CREATE TABLE lottery_health_snapshots (
  snapshot_id INT PRIMARY KEY AUTO_INCREMENT,
  campaign_id INT NOT NULL,
  health_score DECIMAL(5,2),
  budget_health DECIMAL(5,2),
  win_rate_health DECIMAL(5,2),
  prize_distribution_health DECIMAL(5,2),
  snapshot_date DATE NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_campaign_date (campaign_id, snapshot_date)
);
```

---

#### 9.2.2 用户画像分析

**前端工作内容**：

| 序号 | 工作项 | 描述 | 工作量 |
|------|--------|------|--------|
| F-29 | 新建页面文件 | 创建 `user-analytics.html` 页面 | 0.5天 |
| F-30 | 用户分层饼图 | 开发活跃度分层和价值分层饼图 | 1天 |
| F-31 | 分层用户列表 | 点击饼图分层可查看对应用户列表 | 1天 |
| F-32 | 用户活跃时段热力图 | 开发 24 小时 × 7 天的活跃时段热力图 | 1天 |
| F-33 | 兑换偏好分析 | 开发商品兑换偏好排行榜 | 0.5天 |
| F-34 | 用户行为漏斗图 | 开发抽奖→中奖→兑换的转化漏斗图 | 1天 |

**后端/数据库工作内容**：

| 序号 | 工作项 | 描述 | 涉及表 | 工作量 |
|------|--------|------|--------|--------|
| B-19 | 用户分层服务 | 创建 `UserSegmentService`，实现活跃度和价值分层逻辑 | users, lottery_draws, consumption_records, account_asset_balances | 1.5天 |
| B-20 | 分层统计接口 | `GET /api/v4/admin/users/segments` 返回各分层统计 | - | 0.5天 |
| B-21 | 分层用户列表接口 | `GET /api/v4/admin/users/segments/{type}` 返回分层用户列表 | - | 0.5天 |
| B-22 | 活跃时段统计接口 | `GET /api/v4/admin/users/activity-heatmap` | lottery_draws | 0.5天 |
| B-23 | 兑换偏好接口 | `GET /api/v4/admin/users/exchange-preferences` | exchange_records, exchange_items | 0.5天 |
| B-24 | 行为漏斗接口 | `GET /api/v4/admin/users/funnel` | lottery_draws, exchange_records | 0.5天 |

**数据库变更**：
```sql
-- 可选：用户分层缓存表（每日更新）
CREATE TABLE user_segments_cache (
  user_id INT PRIMARY KEY,
  activity_segment ENUM('high', 'medium', 'low', 'silent'),
  value_segment ENUM('high', 'medium', 'normal'),
  total_draws INT DEFAULT 0,
  total_consumption BIGINT DEFAULT 0,
  last_active_date DATE,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_activity (activity_segment),
  INDEX idx_value (value_segment)
);
```

---

#### 9.2.3 统计报表增强（多维度）

**前端工作内容**：

| 序号 | 工作项 | 描述 | 工作量 |
|------|--------|------|--------|
| F-35 | 维度选择器 | 开发活动/门店/用户层级/时间段的下拉选择器 | 0.5天 |
| F-36 | 多维度表格 | 开发可切换维度的数据表格 | 1天 |
| F-37 | 同比/环比显示 | 在指标后显示同比环比变化率和箭头 | 0.5天 |
| F-38 | 数据下钻功能 | 点击维度可下钻查看明细 | 1天 |
| F-39 | 图表联动 | 表格和图表联动显示 | 0.5天 |

**后端/数据库工作内容**：

| 序号 | 工作项 | 描述 | 涉及表 | 工作量 |
|------|--------|------|--------|--------|
| B-25 | 多维度统计接口 | `GET /api/v4/admin/statistics/multi-dimension` 支持多种维度参数 | lottery_draws, consumption_records, users, stores | 1.5天 |
| B-26 | 同比环比计算 | 计算同比和环比数据 | - | 0.5天 |
| B-27 | 下钻明细接口 | `GET /api/v4/admin/statistics/drill-down` | - | 0.5天 |

---

#### 9.2.4 异常消费标记系统

**前端工作内容**：

| 序号 | 工作项 | 描述 | 工作量 |
|------|--------|------|--------|
| F-40 | 异常标记展示 | 在消费记录列表显示异常标记徽章 | 0.5天 |
| F-41 | 异常类型筛选 | 新增按异常类型筛选的下拉选项 | 0.5天 |
| F-42 | 异常详情提示 | 鼠标悬停显示异常原因说明 | 0.25天 |
| F-43 | 异常统计面板 | 在页面顶部显示各类异常数量统计 | 0.5天 |

**后端/数据库工作内容**：

| 序号 | 工作项 | 描述 | 涉及表 | 工作量 |
|------|--------|------|--------|--------|
| B-28 | 异常检测服务 | 创建 `ConsumptionAnomalyService`，实现异常检测逻辑 | consumption_records, users | 1天 |
| B-29 | 实时异常标记 | 消费提交时自动检测并标记异常 | consumption_records | 0.5天 |
| B-30 | 异常标记接口 | 修改消费列表接口，返回异常标记字段 | - | 0.5天 |

**数据库变更**：
```sql
-- 为消费记录添加异常标记字段
ALTER TABLE consumption_records 
ADD COLUMN anomaly_flags JSON COMMENT '异常标记，如["large_amount","high_frequency"]',
ADD COLUMN anomaly_score TINYINT DEFAULT 0 COMMENT '异常评分0-100';

-- 添加索引
CREATE INDEX idx_anomaly_score ON consumption_records(anomaly_score);
```

---

### 9.3 P2 - 中期实施（4-8周）

#### 9.3.1 智能提醒系统

**前端工作内容**：

| 序号 | 工作项 | 描述 | 工作量 |
|------|--------|------|--------|
| F-44 | 提醒通知组件 | 开发页面右上角的提醒通知下拉框 | 1天 |
| F-45 | 声音提醒功能 | 实现紧急提醒的声音通知 | 0.5天 |
| F-46 | 提醒规则配置页 | 开发提醒规则管理页面 | 1天 |
| F-47 | 消息中心页面 | 开发历史提醒消息查看页面 | 1天 |
| F-48 | WebSocket 集成 | 实现实时提醒推送 | 0.5天 |

**后端/数据库工作内容**：

| 序号 | 工作项 | 描述 | 涉及表 | 工作量 |
|------|--------|------|--------|--------|
| B-31 | 提醒规则引擎 | 创建 `AlertRuleEngine`，支持配置化规则 | alert_rules | 1.5天 |
| B-32 | 定时检测任务 | 创建定时任务检测触发条件 | - | 0.5天 |
| B-33 | 提醒推送服务 | 实现 WebSocket 推送和短信推送 | admin_notifications | 1天 |
| B-34 | 提醒规则 CRUD | `POST/GET/PUT/DELETE /api/v4/admin/alert-rules` | alert_rules | 0.5天 |
| B-35 | 提醒历史接口 | `GET /api/v4/admin/notifications` | admin_notifications | 0.5天 |

**数据库变更**：
```sql
-- 提醒规则表
CREATE TABLE alert_rules (
  rule_id INT PRIMARY KEY AUTO_INCREMENT,
  rule_name VARCHAR(100) NOT NULL,
  rule_type ENUM('threshold', 'anomaly', 'schedule') NOT NULL,
  condition_config JSON NOT NULL COMMENT '触发条件配置',
  notification_config JSON NOT NULL COMMENT '通知方式配置',
  priority ENUM('low', 'medium', 'high', 'urgent') DEFAULT 'medium',
  is_enabled TINYINT(1) DEFAULT 1,
  created_by INT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 管理员通知表
CREATE TABLE admin_notifications (
  notification_id BIGINT PRIMARY KEY AUTO_INCREMENT,
  rule_id INT,
  admin_id INT,
  title VARCHAR(200) NOT NULL,
  content TEXT,
  priority ENUM('low', 'medium', 'high', 'urgent'),
  is_read TINYINT(1) DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_admin_read (admin_id, is_read),
  INDEX idx_created (created_at)
);
```

---

#### 9.3.2 自定义报表

**前端工作内容**：

| 序号 | 工作项 | 描述 | 工作量 |
|------|--------|------|--------|
| F-49 | 报表配置向导 | 开发分步骤的报表配置向导 | 1.5天 |
| F-50 | 指标选择器 | 开发可勾选的指标选择列表 | 0.5天 |
| F-51 | 维度/时间配置 | 开发维度和时间范围配置组件 | 0.5天 |
| F-52 | 报表预览 | 开发配置后的实时预览功能 | 1天 |
| F-53 | 我的报表列表 | 开发已保存报表的管理列表 | 0.5天 |
| F-54 | 定时推送配置 | 开发推送时间和方式配置组件 | 0.5天 |

**后端/数据库工作内容**：

| 序号 | 工作项 | 描述 | 涉及表 | 工作量 |
|------|--------|------|--------|--------|
| B-36 | 报表模板 CRUD | `POST/GET/PUT/DELETE /api/v4/admin/report-templates` | report_templates | 0.5天 |
| B-37 | 动态报表生成 | 根据配置动态生成报表数据 | 多表 | 1.5天 |
| B-38 | 报表预览接口 | `POST /api/v4/admin/report-templates/preview` | - | 0.5天 |
| B-39 | 定时推送任务 | 实现报表定时生成和推送 | report_templates | 1天 |
| B-40 | 报表导出 | 支持 Excel/PDF 格式导出 | - | 1天 |

**数据库变更**：
```sql
-- 报表模板表
CREATE TABLE report_templates (
  template_id INT PRIMARY KEY AUTO_INCREMENT,
  template_name VARCHAR(100) NOT NULL,
  owner_admin_id INT NOT NULL,
  metrics_config JSON NOT NULL COMMENT '指标配置',
  dimension_config JSON COMMENT '维度配置',
  time_range_type ENUM('daily', 'weekly', 'monthly', 'custom'),
  compare_type ENUM('none', 'week_over_week', 'month_over_month'),
  schedule_config JSON COMMENT '定时推送配置',
  is_enabled TINYINT(1) DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_owner (owner_admin_id)
);
```

---

#### 9.3.3 操作日志增强

**前端工作内容**：

| 序号 | 工作项 | 描述 | 工作量 |
|------|--------|------|--------|
| F-55 | 影响范围展示 | 在日志详情显示影响用户数和金额 | 0.5天 |
| F-56 | 风险级别标记 | 用不同颜色标记不同风险级别的操作 | 0.25天 |
| F-57 | 回滚按钮 | 为支持回滚的操作显示回滚按钮 | 0.5天 |
| F-58 | 二次确认弹窗 | 开发高风险操作的二次确认弹窗组件 | 0.5天 |
| F-59 | 操作审计报告 | 开发操作审计的统计报告页面 | 1天 |

**后端/数据库工作内容**：

| 序号 | 工作项 | 描述 | 涉及表 | 工作量 |
|------|--------|------|--------|--------|
| B-41 | 扩展日志字段 | 日志记录增加影响范围、风险级别字段 | admin_operation_logs | 0.5天 |
| B-42 | 回滚服务 | 创建 `OperationRollbackService`，实现关键操作的回滚 | - | 1.5天 |
| B-43 | 回滚接口 | `POST /api/v4/admin/operations/{log_id}/rollback` | admin_operation_logs | 0.5天 |
| B-44 | 高风险操作中间件 | 拦截高风险操作，要求二次确认 token | - | 0.5天 |
| B-45 | 审计统计接口 | `GET /api/v4/admin/operations/audit-report` | admin_operation_logs | 0.5天 |

**数据库变更**：
```sql
-- 扩展操作日志表
ALTER TABLE admin_operation_logs 
ADD COLUMN affected_users INT DEFAULT 0 COMMENT '影响用户数',
ADD COLUMN affected_amount BIGINT DEFAULT 0 COMMENT '影响金额(分)',
ADD COLUMN risk_level ENUM('low', 'medium', 'high') DEFAULT 'low',
ADD COLUMN rollback_supported TINYINT(1) DEFAULT 0,
ADD COLUMN rollback_deadline TIMESTAMP NULL,
ADD COLUMN rollback_status ENUM('none', 'rolled_back', 'expired') DEFAULT 'none';
```

---

#### 9.3.4 用户行为轨迹

**前端工作内容**：

| 序号 | 工作项 | 描述 | 工作量 |
|------|--------|------|--------|
| F-60 | 轨迹时间线组件 | 开发用户详情页的行为时间线组件 | 1天 |
| F-61 | 行为类型图标 | 为不同行为类型设计不同图标 | 0.25天 |
| F-62 | 轨迹筛选器 | 支持按行为类型和时间范围筛选 | 0.5天 |
| F-63 | 轨迹详情弹窗 | 点击轨迹项可查看详细信息 | 0.5天 |
| F-64 | 轨迹导出 | 支持导出用户行为记录 | 0.5天 |

**后端/数据库工作内容**：

| 序号 | 工作项 | 描述 | 涉及表 | 工作量 |
|------|--------|------|--------|--------|
| B-46 | 行为轨迹聚合 | 创建 `UserActivityService`，聚合多表用户行为 | lottery_draws, asset_transactions, exchange_records, market_trades, consumption_records | 1天 |
| B-47 | 轨迹列表接口 | `GET /api/v4/admin/users/{user_id}/activities` | - | 0.5天 |
| B-48 | 轨迹详情接口 | `GET /api/v4/admin/users/activities/{activity_id}` | - | 0.5天 |
| B-49 | 轨迹导出服务 | 实现 CSV/Excel 格式导出 | - | 0.5天 |

**数据库变更**：
```sql
-- 可选：用户行为聚合视图（用于简化查询）
CREATE OR REPLACE VIEW v_user_activities AS
SELECT 
  user_id,
  'draw' as activity_type,
  draw_id as activity_id,
  CONCAT('参与抽奖，获得', IFNULL(reward_name, '未中奖')) as description,
  created_at
FROM lottery_draws
UNION ALL
SELECT 
  user_id,
  'transaction' as activity_type,
  tx_id as activity_id,
  CONCAT(tx_type, ' ', asset_code, ' ', delta_amount) as description,
  created_at
FROM asset_transactions
UNION ALL
SELECT 
  user_id,
  'exchange' as activity_type,
  record_id as activity_id,
  CONCAT('兑换 ', item_name) as description,
  created_at
FROM exchange_records;
```

---

### 9.4 工作量汇总（基于复用分析调整后）

> **说明**：以下工作量已根据 8.5（后端复用）和 8.6（前端复用）的分析结果进行调整，反映实际需要开发的工作量。

#### 9.4.1 前端工作量汇总（调整后）

| 优先级 | 功能模块 | 原估算 | 复用调整后 | 节省 | 说明 |
|--------|---------|--------|-----------|------|------|
| P0 | 运营仪表盘 | 5天 | **2天** | 60% | 复用 statistics.html 组件 |
| P0 | 待处理中心 | 4天 | **1.5天** | 62.5% | 聚合现有页面组件 |
| P0 | 消费审核批量操作 | 1.5天 | **0.5天** | 67% | 仅添加复选框和按钮 |
| P0 | 侧边栏结构调整 | 1.25天 | **1天** | 20% | 调整配置+徽标 |
| **P0 小计** | - | 11.75天 | **5天** | **57.4%** | |
| P1 | 抽奖健康度分析 | 4天 | **2天** | 50% | 扩展现有告警页面 |
| P1 | 用户画像分析 | 5天 | **2.5天** | 50% | 扩展用户详情弹窗 |
| P1 | 统计报表增强 | 3.5天 | **1.5天** | 57% | 添加维度选择器 |
| P1 | 异常消费标记 | 1.75天 | **1天** | 43% | 添加标记徽章 |
| **P1 小计** | - | 14.25天 | **7天** | **50.9%** | |
| P2 | 智能提醒系统 | 4天 | **3天** | 25% | 复用 WebSocket |
| P2 | 自定义报表 | 4.5天 | **3天** | 33% | 扩展 statistics |
| P2 | 操作日志增强 | 2.75天 | **1天** | 64% | 扩展现有日志 |
| P2 | 用户行为轨迹 | 2.75天 | **1天** | 64% | 添加时间线组件 |
| **P2 小计** | - | 14天 | **8天** | **42.9%** | |
| **总计** | - | **40天** | **20天** | **50%** | |

#### 9.4.2 后端工作量汇总（调整后）

| 优先级 | 功能模块 | 原估算 | 复用调整后 | 节省 | 说明 |
|--------|---------|--------|-----------|------|------|
| P0 | 运营仪表盘 | 3天 | **0.5天** | 83% | 直接调用 ReportingService |
| P0 | 待处理中心 | 2.5天 | **1天** | 60% | 新增汇总接口 |
| P0 | 消费审核批量操作 | 1天 | **0.5天** | 50% | 简单批量接口 |
| P0 | 侧边栏徽标接口 | 0.5天 | **0.5天** | 0% | 新增接口 |
| **P0 小计** | - | 7天 | **2.5天** | **64.3%** | |
| P1 | 抽奖健康度分析 | 3天 | **2天** | 33% | 新增健康度评分算法 |
| P1 | 用户画像分析 | 4天 | **1.5天** | 62.5% | 复用 getUserStatistics |
| P1 | 统计报表增强 | 2.5天 | **1.5天** | 40% | 扩展现有接口 |
| P1 | 异常消费标记 | 2天 | **1天** | 50% | 添加标记字段 |
| **P1 小计** | - | 11.5天 | **6天** | **47.8%** | |
| P2 | 智能提醒系统 | 4天 | **3天** | 25% | 新增定时任务+推送 |
| P2 | 自定义报表 | 4.5天 | **3天** | 33% | 动态报表生成 |
| P2 | 操作日志增强 | 3.5天 | **2天** | 43% | 回滚服务 |
| P2 | 用户行为轨迹 | 2.5天 | **1.5天** | 40% | 行为聚合服务 |
| **P2 小计** | - | 14.5天 | **9.5天** | **34.5%** | |
| **总计** | - | **33天** | **18天** | **45.5%** | |

#### 9.4.3 总工作量对比

| 类别 | 原估算 | 复用调整后 | 节省 |
|------|--------|-----------|------|
| 前端总工时 | 40天 | **20天** | 50% |
| 后端总工时 | 33天 | **18天** | 45.5% |
| **项目总计** | **73天** | **38天** | **47.9%** |

#### 9.4.4 数据库变更汇总（精简后）

| 变更类型 | 原计划 | 精简后 | 阶段 | 说明 |
|---------|--------|--------|------|------|
| 新增索引 | 5个 | **3个** | **P0** | 关键查询优化索引，提升待处理中心性能 |
| 新增表 | 5个 | **2个** | P2 | 仅 admin_reminder_rules、admin_report_templates |
| 表字段扩展 | 2个 | **2个** | P1/P2 | consumption_records、admin_operation_logs |
| 新增视图 | 1个 | **0个** | - | 改为服务层聚合 |

**P0阶段必需的数据库变更**：

```sql
-- P0 阶段：关键索引（与待处理中心、运营仪表盘同步上线）
CREATE INDEX idx_consumption_status_created ON consumption_records(status, created_at);
CREATE INDEX idx_sessions_status_created ON customer_service_sessions(status, created_at);
CREATE INDEX idx_lottery_draws_created ON lottery_draws(created_at);
```

**P2阶段数据库变更**（无需提前评估）：

```sql
-- P2 阶段：提醒规则表（智能提醒功能必需）
CREATE TABLE admin_reminder_rules (
  rule_id INT PRIMARY KEY AUTO_INCREMENT,
  rule_name VARCHAR(100) NOT NULL,
  rule_type ENUM('pending_timeout', 'threshold_breach', 'periodic') NOT NULL,
  conditions JSON NOT NULL,
  notification_channels JSON NOT NULL,
  is_active BOOLEAN DEFAULT TRUE,
  created_by INT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- P2 阶段：报表模板表（自定义报表功能必需）
CREATE TABLE admin_report_templates (
  template_id INT PRIMARY KEY AUTO_INCREMENT,
  template_name VARCHAR(100) NOT NULL,
  template_type ENUM('dashboard', 'analysis', 'export') NOT NULL,
  config JSON NOT NULL,
  is_default BOOLEAN DEFAULT FALSE,
  created_by INT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

---

### 9.5 🔄 后端可复用功能分析

> **重要说明**：通过对现有后端代码的深入分析，发现大量功能已经存在，可以直接复用或少量扩展即可满足需求，大幅减少开发工作量。

#### 9.5.1 📊 报表统计服务（已重构为 StatsService + AnalyticsService）- 可直接复用

> **代码升级说明**（2026-01-31验证）：原 `ReportingService.js` 已重构拆分为：
> - `services/reporting/StatsService.js` - 统计概览相关功能
> - `services/reporting/AnalyticsService.js` - 分析报表相关功能
> 
> 原有方法签名保持兼容，API端点不变。

| 已有方法 | 所属服务 | 功能说明 | 对应需求 | 复用度 |
|----------|----------|----------|----------|--------|
| `getTodayStats()` | StatsService | 今日统计（用户/抽奖/积分/库存/聊天） | 运营仪表盘核心指标 | ✅ **直接复用** |
| `getDecisionAnalytics(days, user)` | AnalyticsService | 决策分析（抽奖趋势/用户分布） | 抽奖趋势分析 | ✅ **直接复用** |
| `getLotteryTrends(period, granularity)` | AnalyticsService | 抽奖活动趋势（支持小时/日粒度） | 7天趋势折线图 | ✅ **直接复用** |
| `getChartsData(days)` | AnalyticsService | 多维度图表数据（用户增长/消费/积分） | 统计图表数据 | ✅ **直接复用** |
| `getPerformanceReport()` | StatsService | 系统性能报告 | 系统健康监控 | ✅ **直接复用** |
| `getUserStatistics(user_id)` | StatsService | 用户画像统计 | 用户详情页 | ✅ **直接复用** |
| `getSystemOverview()` | StatsService | 系统概览统计 | 仪表盘系统状态 | ✅ **直接复用** |
| `getInventoryAdminStatistics()` | StatsService | 库存统计（按状态/类型） | 库存健康度 | ✅ **直接复用** |

**现有API端点**（不变）：
- `GET /api/v4/console/analytics/stats/today` - 今日统计
- `GET /api/v4/console/analytics/decisions/analytics` - 决策分析
- `GET /api/v4/console/analytics/lottery/trends` - 抽奖趋势
- `GET /api/v4/console/analytics/performance/report` - 性能报告

---

#### 9.5.2 🚨 告警服务（LotteryAlertService）- 可直接复用

| 已有方法 | 功能说明 | 对应需求 | 复用度 |
|----------|----------|----------|--------|
| `getAlertList(params)` | 告警列表（支持筛选/分页） | 抽奖告警列表 | ✅ **直接复用** |
| `acknowledgeAlert(id)` | 确认告警 | 告警处理 | ✅ **直接复用** |
| `resolveAlert(id, notes)` | 解决告警 | 告警处理 | ✅ **直接复用** |
| `checkAndTriggerAlerts()` | 自动检测触发告警 | 智能预警 | ✅ **直接复用** |

**已有告警类型**：
- `win_rate` - 中奖率异常
- `budget` - 预算告警（90%/100%）
- `inventory` - 库存不足（<10件）
- `user` - 用户异常（连续空奖）

**现有API端点**：
- `GET /api/v4/console/lottery-monitoring/realtime-alerts` - 实时告警列表
- `POST /api/v4/console/lottery-monitoring/realtime-alerts/:id/acknowledge` - 确认告警
- `POST /api/v4/console/lottery-monitoring/realtime-alerts/:id/resolve` - 解决告警

---

#### 9.5.3 📋 消费审核服务（ConsumptionService）- 可直接复用

> **代码结构说明**（2026-01-31验证）：消费服务位于 `services/consumption/` 目录下，采用模块化拆分设计。

| 已有方法 | 功能说明 | 对应需求 | 复用度 |
|----------|----------|----------|--------|
| `getPendingConsumptionRecords()` | 待审核列表 | 待处理中心 | ✅ **直接复用** |
| `getAdminRecords(options)` | 全部记录（支持筛选/搜索/统计） | 消费管理 | ✅ **直接复用** |
| `approveConsumption(id)` | 审核通过 | 消费审核 | ✅ **直接复用** |
| `rejectConsumption(id, reason)` | 审核拒绝 | 消费审核 | ✅ **直接复用** |

**现有API端点**：
- `GET /api/v4/console/consumption/pending` - 待审核列表
- `GET /api/v4/console/consumption/records` - 全部记录
- `POST /api/v4/console/consumption/approve/:id` - 审核通过
- `POST /api/v4/console/consumption/reject/:id` - 审核拒绝

---

#### 9.5.4 💬 客服会话服务（AdminCustomerServiceService）- 可直接复用

> **代码结构说明**（2026-01-31验证）：客服服务位于 `services/customer-service/` 目录下。

| 已有方法 | 功能说明 | 对应需求 | 复用度 |
|----------|----------|----------|--------|
| `getSessionList(options)` | 会话列表（支持分页/筛选） | 客服管理 | ✅ **直接复用** |
| `getSessionStats(admin_id)` | 会话统计（待处理/进行中/已关闭） | 待处理中心 | ✅ **直接复用** |
| `assignSession(session_id, admin_id)` | 分配会话 | 客服管理 | ✅ **直接复用** |
| `closeSession(session_id)` | 关闭会话 | 客服管理 | ✅ **直接复用** |

**现有API端点**：
- `GET /api/v4/console/customer-service/sessions` - 会话列表
- `GET /api/v4/console/customer-service/sessions/stats` - 会话统计

---

#### 9.5.5 📝 审计日志服务（AuditLogService）- 可直接复用

| 已有方法 | 功能说明 | 对应需求 | 复用度 |
|----------|----------|----------|--------|
| `getAdminAuditLogs(options)` | 审计日志列表（支持筛选） | 操作日志 | ✅ **直接复用** |
| `getAuditStatisticsEnhanced()` | 审计统计（今日/本周/类型分布） | 日志统计 | ✅ **直接复用** |
| `queryAuditLogs(filters)` | 日志查询 | 日志搜索 | ✅ **直接复用** |

**现有API端点**：
- `GET /api/v4/console/admin-audit-logs` - 审计日志列表
- `GET /api/v4/console/admin-audit-logs/stats` - 审计统计

---

#### 9.5.6 🎰 抽奖监控服务 - 可直接复用

| 现有API端点 | 功能说明 | 对应需求 | 复用度 |
|-------------|----------|----------|--------|
| `GET /lottery-monitoring/hourly-metrics` | 小时粒度数据 | 抽奖监控 | ✅ **直接复用** |
| `GET /lottery-monitoring/user-profile/:user_id` | 用户抽奖画像 | 用户详情 | ✅ **直接复用** |
| `GET /lottery-monitoring/campaign-roi/:campaign_id` | 活动ROI | 活动分析 | ✅ **直接复用** |
| `GET /lottery-monitoring/abnormal-users` | 异常用户列表 | 风控分析 | ✅ **直接复用** |
| `GET /lottery-monitoring/strategy-effectiveness` | 策略有效性 | 策略分析 | ✅ **直接复用** |

---

#### 9.5.7 🛡️ 风控服务 - 可直接复用

| 现有API端点 | 功能说明 | 对应需求 | 复用度 |
|-------------|----------|----------|--------|
| `GET /risk-alerts` | 风控告警列表 | 风控告警 | ✅ **直接复用** |
| `GET /risk-alerts/pending` | 待处理告警 | 待处理中心 | ✅ **直接复用** |
| `GET /risk-alerts/stats/summary` | 告警统计 | 告警统计 | ✅ **直接复用** |
| `POST /risk-alerts/:id/review` | 处理告警 | 告警处理 | ✅ **直接复用** |
| `GET /risk-profiles/user/:user_id` | 用户风险画像 | 用户风控 | ✅ **直接复用** |

---

#### 9.5.8 📊 工作量调整：基于复用分析

**原始估算 vs 复用后估算**：

| 功能模块 | 原后端工时 | 可复用接口 | 实际需开发 | 调整后工时 |
|----------|-----------|-----------|-----------|-----------|
| **P0 运营仪表盘** | 3天 | `getTodayStats()` `getSystemOverview()` `getLotteryTrends()` | 仅需整合接口 | **0.5天** |
| **P0 待处理中心** | 2.5天 | `getPendingConsumptionRecords()` `getSessionStats()` `getAlertList()` | 新增汇总接口 | **1天** |
| **P0 抽奖告警汇总** | 1.5天 | `getAlertList()` `acknowledgeAlert()` `resolveAlert()` | 无需开发 | **0天** |
| **P1 用户画像增强** | 3天 | `getUserStatistics()` `user-profile` | 扩展行为标签 | **1.5天** |
| **P1 抽奖健康度** | 4天 | `getDecisionAnalytics()` `hourly-metrics` `abnormal-users` | 新增健康度评分算法 | **2天** |
| **P2 智能提醒** | 4天 | 告警检测逻辑已有 | 新增定时任务+推送 | **3天** |

**总结**：

| 类别 | 原估算工时 | 调整后工时 | 节省 |
|------|-----------|-----------|------|
| P0 后端工时 | 7天 | **1.5天** | 78.6% |
| P1 后端工时 | 11.5天 | **5.5天** | 52.2% |
| P2 后端工时 | 14.5天 | **10天** | 31.0% |
| **总计** | **33天** | **17天** | **48.5%** |

---

#### 9.5.9 🆕 需新增的后端功能

基于复用分析，以下功能确实需要新增开发：

| 功能 | 说明 | 预估工时 |
|------|------|----------|
| **待处理汇总接口** | `GET /api/v4/admin/pending/summary` 聚合多个待处理数量 | 0.5天 |
| **健康度评分算法** | 基于多维度计算抽奖活动健康评分（0-100） | 1天 |
| **用户行为标签** | 计算RFM模型、消费偏好等用户标签 | 1.5天 |
| **智能提醒定时任务** | 定时检测预警条件并触发通知 | 2天 |
| **提醒规则配置表** | `admin_reminder_rules` 存储自定义提醒规则 | 0.5天 |
| **报表模板存储** | `admin_report_templates` 存储自定义报表配置 | 0.5天 |
| **导出功能** | Excel/PDF 导出（需安装 exceljs/pdfkit） | 1.5天 |

**新增表结构**（仅保留真正需要的）：

```sql
-- 提醒规则表（智能提醒功能必需）
CREATE TABLE admin_reminder_rules (
  rule_id INT PRIMARY KEY AUTO_INCREMENT,
  rule_name VARCHAR(100) NOT NULL,
  rule_type ENUM('pending_timeout', 'threshold_breach', 'periodic') NOT NULL,
  conditions JSON NOT NULL,
  notification_channels JSON NOT NULL,
  is_active BOOLEAN DEFAULT TRUE,
  created_by INT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 报表模板表（自定义报表功能必需）
CREATE TABLE admin_report_templates (
  template_id INT PRIMARY KEY AUTO_INCREMENT,
  template_name VARCHAR(100) NOT NULL,
  template_type ENUM('dashboard', 'analysis', 'export') NOT NULL,
  config JSON NOT NULL,
  is_default BOOLEAN DEFAULT FALSE,
  created_by INT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

---

### 9.6 🎨 前端页面复用分析

> **重要说明**：通过对现有 admin 页面的深入分析，发现大部分页面已经存在且功能完善，不需要新建，只需调整或增强即可，大幅减少前端开发工作量。

#### 9.6.1 ✅ 已有页面分析（可直接复用或小幅调整）

| 已有页面 | 文件 | 现有功能 | 复用度 | 调整工作 |
|----------|------|----------|--------|----------|
| **工作台框架** | `workspace.html` | Tab系统、侧边栏、iframe嵌套 | ✅ **直接复用** | 添加仪表盘作为默认Tab |
| **数据统计** | `statistics.html` | 核心指标卡片、ECharts趋势图、时间筛选、数字动画 | ✅ **直接复用** | 增强维度筛选 |
| **数据分析** | `analytics.html` | 统计卡片、多种图表、时间筛选 | ✅ **直接复用** | 复用图表组件 |
| **财务管理** | `finance-management.html` | 消费审核列表、筛选、通过/拒绝操作 | ✅ **直接复用** | 仅需添加批量操作 |
| **客服工作台** | `customer-service.html` | 会话列表、实时聊天、用户信息面板 | ✅ **完整功能** | 基本不需要改动 |
| **抽奖告警** | `lottery-alerts.html` | 统计卡片、图表、告警列表、确认/解决操作 | ✅ **完整功能** | 基本不需要改动 |
| **风控告警** | `risk-alerts.html` | 统计卡片、图表、告警列表、处理操作 | ✅ **完整功能** | 基本不需要改动 |
| **用户管理** | `user-management.html` | 用户列表、筛选、详情弹窗、角色管理 | ✅ **直接复用** | 扩展用户画像信息 |

---

#### 9.6.2 🔄 调整后的 P0 前端工作（原11.75天 → **5天**）

| 功能 | 原方案 | 调整后方案 | 复用来源 | 工作量 |
|------|--------|-----------|----------|--------|
| **运营仪表盘** | 新建 dashboard.html | 在 `workspace.html` 中**新增 Tab** | `statistics.html` 指标卡片和图表组件 | **2天** |
| **待处理中心** | 新建 pending-center.html | 在 `workspace.html` 中**新增 Tab** | 聚合各页面待处理组件 | **1.5天** |
| **消费审核批量操作** | 新建功能 | 在 `finance-management.html` 中**添加复选框和批量按钮** | 现有列表组件 | **0.5天** |
| **侧边栏结构调整** | 修改导航 | 调整 `sidebar-nav.js` 配置 | 现有导航机制 | **0.5天** |
| **待处理徽标** | 新建 | 在侧边栏组件中添加数字徽标 | 现有侧边栏组件 | **0.5天** |

---

#### 9.6.3 🔄 调整后的 P1 前端工作（原14.25天 → **7天**）

| 功能 | 原方案 | 调整后方案 | 复用来源 | 工作量 |
|------|--------|-----------|----------|--------|
| **抽奖健康度分析** | 新建页面 | 在 `lottery-alerts.html` 中**新增 Tab** | 现有图表组件 | **2天** |
| **用户画像分析** | 新建 user-analytics.html | 在 `user-management.html` 中**扩展用户详情弹窗** | 现有详情组件 | **2.5天** |
| **统计报表增强** | 新建功能 | 在 `statistics.html` 中**添加维度选择器** | 现有图表和筛选组件 | **1.5天** |
| **异常消费标记** | 新建系统 | 在 `finance-management.html` 中**添加标记徽章** | 现有列表组件 | **1天** |

---

#### 9.6.4 🔄 调整后的 P2 前端工作（原14天 → **8天**）

| 功能 | 原方案 | 调整后方案 | 复用来源 | 工作量 |
|------|--------|-----------|----------|--------|
| **智能提醒系统** | 新建多页面 | 复用现有**通知组件和WebSocket**，新增规则配置页 | Socket.io Client | **3天** |
| **自定义报表** | 新建配置向导 | 基于 `statistics.html` 扩展，添加**配置和保存** | 现有报表组件 | **3天** |
| **操作日志增强** | 新建功能 | 扩展现有日志页面，添加影响范围字段 | 现有列表组件 | **1天** |
| **用户行为轨迹** | 新建组件 | 在用户详情弹窗中**添加时间线组件** | 现有弹窗框架 | **1天** |

---

#### 9.6.5 📊 前端工作量调整总结

**原始估算 vs 复用后估算**：

| 优先级 | 原估算工时 | 调整后工时 | 节省 | 说明 |
|--------|-----------|-----------|------|------|
| P0 前端 | 11.75天 | **5天** | 57.4% | 利用 workspace Tab 机制 |
| P1 前端 | 14.25天 | **7天** | 50.9% | 扩展现有页面功能 |
| P2 前端 | 14天 | **8天** | 42.9% | 复用现有组件 |
| **总计** | **40天** | **20天** | **50%** | |

---

#### 9.6.6 🏗️ 页面实现方案：混合方案（已决策 ✅）

> **决策日期**：2026年1月31日  
> **决策结论**：采用**方案C（混合方案）**，兼顾操作效率和多窗口对比需求

##### 方案对比回顾

| 方案 | 说明 | 优点 | 缺点 |
|------|------|------|------|
| 方案A（纯Tab） | 全部在 workspace Tab 内 | 切换快，状态保持 | 不支持多窗口对比 |
| 方案B（纯独立页面） | 全部独立页面 | 可多窗口并行 | 切换慢，状态丢失 |
| **方案C（混合）** ✅ | Tab + 独立页面结合 | **兼顾效率和灵活性** | 需要设计合理的分工 |

##### 混合方案具体设计

**1️⃣ 放入 workspace Tab 的功能**（高频快速切换）

| 功能 | 类型 | 原因 |
|------|------|------|
| 运营仪表盘 | workspace 内嵌 Tab | 日常巡检首页，需要快速查看 |
| 待处理中心 | workspace 内嵌 Tab | 快速处理待办，需要保持状态 |
| 通知中心 | workspace 内嵌 Tab | 告警汇总，需要即时响应 |

**2️⃣ 保持独立页面的功能**（支持多窗口对比）

| 功能 | 类型 | 原因 |
|------|------|------|
| 数据统计 | 独立页面 | 深度分析时需要独立打开、多屏对比 |
| 用户管理 | 独立页面 | 经常需要和其他页面对比查看 |
| 抽奖管理 | 独立页面 | 配置类操作，需要专注 |
| 消费审核 | 独立页面 | 批量操作时需要独立处理 |
| 客服工作台 | 独立页面 | 长时间处理会话，需要独立窗口 |

**3️⃣ Tab 页面增加"新窗口打开"功能**

```javascript
// workspace-tabs.js 增加功能
openInNewWindow(tabUrl) {
  window.open(tabUrl, '_blank', 'width=1200,height=800')
}
```

每个 Tab 右上角增加 🔗 按钮，运营可选择：
- 在 Tab 内快速切换 → 日常巡检
- 点击"新窗口"打开 → 多屏对比分析

##### 运营工作流程示意

```
日常巡检（单屏）：
┌─────────────────────────────────────┐
│  workspace.html                      │
│  ┌─────┬─────┬─────┐                │
│  │仪表盘│待处理│通知 │  ← Tab 快速切换│
│  └─────┴─────┴─────┘                │
│  [ Tab 内容区域 ]                    │
└─────────────────────────────────────┘

深度分析（双屏/多窗口）：
┌─────────────────┐  ┌─────────────────┐
│  用户管理       │  │  抽奖记录        │
│  (独立窗口1)    │  │  (独立窗口2)     │
│                 │  │                  │
│  用户A的信息    │  │  用户A的抽奖历史  │
└─────────────────┘  └─────────────────┘
```

---

#### 9.6.7 🆕 真正需要新建的页面

基于混合方案，需要新建的页面：

| 新页面 | 类型 | 说明 | 工作量 |
|--------|------|------|--------|
| **运营仪表盘** | workspace 内嵌 Tab | 聚合核心指标，复用 statistics 图表 | 2天 |
| **待处理中心** | workspace 内嵌 Tab | 聚合待处理事项，复用各页面列表组件 | 1.5天 |
| **通知中心** | workspace 内嵌 Tab | 告警汇总和智能提醒入口 | 1天 |

**其余功能**：
- 在现有独立页面基础上增强（保持独立页面形式）
- Tab 页面增加"新窗口打开"按钮

---

#### 9.6.8 🎯 具体复用方案

**1. 运营仪表盘复用方案**（workspace Tab）
```
复用来源：
├── statistics.html → 指标卡片组件（带数字动画）
├── statistics.html → ECharts 趋势图组件
├── lottery-alerts.html → 告警统计卡片
├── workspace.html → Tab 框架系统
└── 后端接口 → getTodayStats() / getLotteryTrends()

实现方式：
├── 在 workspace Tab 配置中新增"运营仪表盘"
├── 创建 dashboard-tab.html 内嵌页面
├── 右上角添加"🔗 新窗口"按钮（支持独立打开）
└── 组合现有组件，调用现有 API
```

**2. 待处理中心复用方案**（workspace Tab）
```
复用来源：
├── finance-management.html → 待审核消费列表组件
├── customer-service.html → 会话列表组件
├── lottery-alerts.html → 告警列表组件
├── risk-alerts.html → 风控告警组件
└── 后端接口 → getPendingConsumptionRecords() / getSessionStats()

实现方式：
├── 在 workspace Tab 配置中新增"待处理中心"
├── 创建 pending-center-tab.html 内嵌页面
├── 每个待处理项提供"跳转处理"按钮（打开对应独立页面）
└── 聚合展示各待处理数据，提供快捷跳转
```

**3. 消费批量操作复用方案**（独立页面增强）
```
修改位置：finance-management.html（保持独立页面）

添加内容：
├── 表头添加全选复选框
├── 每行添加复选框
├── 工具栏添加"批量通过"/"批量拒绝"按钮
├── 添加已选计数显示
└── 添加批量操作确认弹窗

预估修改量：约50行HTML + 100行JS
```

**4. workspace-tabs.js 增强**（支持混合方案）
```javascript
// 新增方法：在新窗口打开当前 Tab
openInNewWindow(tabUrl) {
  // 打开独立窗口，支持多屏对比
  window.open(tabUrl, '_blank', 'width=1200,height=800,menubar=no,toolbar=no')
}

// Tab 配置增加属性
const tabConfig = {
  id: 'dashboard',
  title: '运营仪表盘',
  url: '/admin/dashboard-tab.html',
  canOpenInNewWindow: true  // 允许新窗口打开
}
```

---

### 9.7 技术依赖说明

> ⚠️ **技术栈校验日期**：2026年1月31日（基于实际项目代码验证）

#### 9.7.1 前端技术依赖（admin/package.json 实际版本）

| 依赖项 | 版本 | 用途 | 当前状态 |
|--------|------|------|---------|
| **构建工具** |
| Vite | ^6.4.1 | ES Module 构建 | ✅ 已有 |
| vite-plugin-ejs | ^1.7.0 | EJS 模板支持 | ✅ 已有 |
| PostCSS | ^8.5.6 | CSS 处理 | ✅ 已有 |
| **运行时依赖** |
| Alpine.js | ^3.15.4 | 页面交互框架（轻量级响应式） | ✅ 已有 |
| ECharts | ^6.0.0 | 图表可视化（按需导入约300KB） | ✅ 已有 |
| Socket.io Client | ^4.8.3 | 实时推送（WebSocket 客户端） | ✅ 已有 |
| **样式框架** |
| Tailwind CSS | ^3.4.19 | 原子化 CSS 框架 | ✅ 已有 |

**前端架构特点**：
- 多页应用（MPA）架构，每个 HTML 为独立页面
- Alpine.js 组件化设计（`src/alpine/components/`）
- Alpine.js Store 状态管理（`src/alpine/stores/`）
- 模块化 API 封装（`src/api/`）
- EJS 模板引擎复用公共布局

#### 9.7.2 后端技术依赖（package.json 实际版本）

| 依赖项 | 版本 | 用途 | 当前状态 |
|--------|------|------|---------|
| **Web 框架** |
| Express.js | ^4.18.2 | Web 服务器框架 | ✅ 已有 |
| cors | ^2.8.5 | 跨域处理 | ✅ 已有 |
| helmet | ^7.1.0 | HTTP 安全头 | ✅ 已有 |
| compression | ^1.7.4 | 响应压缩 | ✅ 已有 |
| **数据库** |
| Sequelize | ^6.35.2 | ORM（支持事务、关联查询） | ✅ 已有 |
| mysql2 | ^3.6.5 | MySQL 驱动（连接池管理） | ✅ 已有 |
| ioredis | ^5.7.0 | Redis 客户端（缓存、分布式锁） | ✅ 已有 |
| **定时任务** |
| node-cron | ^3.0.3 | 定时任务调度（Cron 语法） | ✅ 已有 |
| **实时通信** |
| Socket.io | ^4.8.1 | WebSocket 服务端 | ✅ 已有 |
| **数据导出** |
| xlsx | ^0.18.5 | Excel 导出（SheetJS） | ✅ 已有 |
| **认证授权** |
| jsonwebtoken | ^9.0.2 | JWT 认证 | ✅ 已有 |
| bcrypt | ^6.0.0 | 密码加密 | ✅ 已有 |
| **其他** |
| joi | ^17.11.0 | 参数验证 | ✅ 已有 |
| winston | ^3.11.0 | 日志管理 | ✅ 已有 |
| sharp | ^0.34.5 | 图片处理 | ✅ 已有 |

**后端架构特点**：
- RESTful API 设计（`/api/v4/{resource}`）
- 分层架构（Routes → Services → Models）
- 北京时间全链路（UTC+8）
- Redis L2 缓存 + 业务缓存助手
- 完整的审计日志系统

#### 9.7.3 数据库现状（MySQL 实际统计 - 2026-01-31 验证）

| 指标 | 数值 | 说明 |
|------|------|------|
| 数据表总数 | 73 个 | 包含业务表、关联表、日志表 |
| 用户总数 | 52 | 全部活跃状态 |
| 消费记录 | 10 | 其中 8 条待审核 |
| 抽奖记录 | 712 | 累计抽奖数据 |
| 物品实例 | 5,170 | 用户持有物品 |
| 兑换商品 | 35 | **0 个上架中（全部已下架）** |
| 客服会话 | 11 | 10 个活跃会话 |
| 操作日志 | 5,348 | 审计记录 |

**关键业务表索引情况**：
- `consumption_records`：已有 13 个索引（包含状态、门店、商户联合索引）
- `lottery_alerts`：支持活动 ID、告警类型、状态查询
- `admin_operation_logs`：支持操作类型、操作人、时间范围查询

#### 9.7.4 技术风险评估

| 风险项 | 风险等级 | 说明 | 应对措施 |
|--------|---------|------|---------|
| PDF 导出 | 🟡 中等 | 当前无 pdfkit 依赖 | 可用 xlsx 替代或按需引入 |
| 日期处理 | 🟢 低风险 | 后端有 BeijingTimeHelper | 前端使用 Intl API 或新增 dayjs |
| 图表性能 | 🟢 低风险 | ECharts 已配置按需导入 | 大数据量需采样或分页 |
| 实时推送 | 🟢 低风险 | Socket.io 双端已就绪 | 注意消息去重和重连机制 |

---

## 📝 十、总结

### 10.1 核心优化方向

基于当前业务数据和页面分析，核心优化方向：

1. **聚焦待处理事项**：将分散的待审核/待处理事项聚合，减少运营遗漏
2. **强化数据洞察**：从单一展示升级为多维度分析，支持数据驱动决策
3. **提升操作效率**：增加批量操作、快捷操作，减少重复劳动
4. **增强预警能力**：建立智能提醒机制，提前发现潜在问题
5. **优化页面布局**：按使用频率和重要性重新组织侧边栏

### 10.2 🎯 复用分析关键结论

通过对现有代码的深入分析，发现项目已有大量可复用的功能：

| 类别 | 可复用比例 | 关键发现 |
|------|-----------|---------|
| **后端服务** | ~70% | ReportingService、LotteryAlertService、ConsumptionService 等已有完整实现 |
| **前端页面** | ~80% | statistics、finance-management、lottery-alerts 等页面功能完善 |
| **API 接口** | ~65% | 大部分数据查询接口已存在，可直接调用 |

### 10.3 📊 工作量优化成果

| 项目 | 原估算 | 复用调整后 | 节省比例 |
|------|--------|-----------|---------|
| 前端工作量 | 40天 | **20天** | 50% |
| 后端工作量 | 33天 | **18天** | 45.5% |
| **总计** | **73天** | **38天** | **47.9%** |

### 10.4 🏗️ 页面实现方案（已决策）

**采用方案**：**混合方案（方案C）** ✅

| 页面类型 | 实现方式 | 适用场景 |
|---------|---------|---------|
| 运营仪表盘 | workspace Tab | 日常巡检，快速切换 |
| 待处理中心 | workspace Tab | 快速处理待办 |
| 通知中心 | workspace Tab | 即时响应告警 |
| 数据统计 | **独立页面** | 深度分析，多窗口对比 |
| 用户管理 | **独立页面** | 需要和其他页面对比 |
| 消费审核 | **独立页面** | 批量操作，专注处理 |
| 客服工作台 | **独立页面** | 长时间会话处理 |

**关键设计**：Tab 页面增加"🔗 新窗口打开"按钮，兼顾快速切换和多屏对比需求。

### 10.5 🚀 实施建议

1. **P0 阶段（5.5天前端 + 2.5天后端 = 8天）**
   - 运营仪表盘 Tab：复用 statistics.html 图表组件
   - 待处理中心 Tab：聚合现有页面的待处理数据
   - 消费批量操作：在独立页面 finance-management.html 添加复选框功能
   - workspace-tabs.js 增强：添加"新窗口打开"功能

2. **P1 阶段（7天前端 + 6天后端 = 13天）**
   - 健康度分析：新增评分算法，前端扩展告警页面
   - 用户画像：扩展用户详情弹窗，复用统计接口
   - 通知中心 Tab：告警汇总入口

3. **P2 阶段（8天前端 + 9.5天后端 = 17.5天）**
   - 智能提醒：新增定时任务和推送，前端复用通知组件
   - 自定义报表：扩展 statistics 页面功能

---

## 附录

### A. 数据库查询参考

> ⚠️ **数据库验证日期**：2026年1月31日（通过 Node.js + Sequelize 连接真实数据库验证）

本文档数据来源于以下数据库查询：

```sql
-- 用户统计
SELECT COUNT(*) as total, SUM(CASE WHEN status='active' THEN 1 ELSE 0 END) as active FROM users;
-- 实际结果：总数 52，全部活跃状态

-- 抽奖活动统计
SELECT COUNT(*) as total, SUM(CASE WHEN status='active' THEN 1 ELSE 0 END) as active FROM lottery_campaigns;
-- 实际结果：总数 4，运行中 1

-- 抽奖记录统计
SELECT COUNT(*) as total FROM lottery_draws;
-- 实际结果：712 条

-- 奖品档位分布
SELECT reward_tier, COUNT(*) as count FROM lottery_draws GROUP BY reward_tier;
-- 实际结果：high 325 (51.3%), mid 41 (6.5%), fallback 267 (42.2%)

-- 待审核消费记录
SELECT COUNT(*) as total FROM consumption_records WHERE status='pending';
-- 实际结果：8 条待审核

-- 活跃客服会话
SELECT COUNT(*) as total FROM customer_service_sessions WHERE status IN ('waiting', 'active');
-- 实际结果：10 个活跃会话

-- 物品实例统计
SELECT COUNT(*) as total FROM item_instances;
-- 实际结果：5,170 个

-- 兑换商品统计
SELECT COUNT(*) as total, SUM(CASE WHEN status='active' THEN 1 ELSE 0 END) as listed FROM exchange_items;
-- 实际结果：总数 35，上架中 0（全部已下架）

-- 操作日志统计
SELECT COUNT(*) as total FROM admin_operation_logs;
-- 实际结果：5,348 条
```

### B. 数据库表结构验证

#### B.1 关键业务表字段（已验证）

**consumption_records 表**（消费记录）：
```
record_id: bigint NOT NULL (主键)
user_id: int NOT NULL (用户 ID)
merchant_id: int (商户 ID)
consumption_amount: decimal(10,2) NOT NULL (消费金额)
points_to_award: int NOT NULL (奖励积分)
status: enum('pending','approved','rejected','expired') NOT NULL (状态)
final_status: enum('pending_review','approved','rejected') NOT NULL (最终状态)
store_id: int NOT NULL (门店 ID)
reviewed_by: int (审核人)
reviewed_at: datetime (审核时间)
admin_notes: text (管理员备注)
created_at/updated_at: datetime NOT NULL (时间戳)
```

**customer_service_sessions 表**（客服会话）：
```
session_id: bigint NOT NULL (主键)
user_id: int (用户 ID)
admin_id: int (客服 ID)
status: enum('waiting','assigned','active','closed') (状态)
priority: int (优先级)
satisfaction_score: int (满意度评分)
last_message_at: datetime (最后消息时间)
closed_at: datetime (关闭时间)
close_reason: varchar(500) (关闭原因)
```

**lottery_alerts 表**（抽奖告警）：
```
alert_id: int NOT NULL (主键)
campaign_id: int NOT NULL (活动 ID)
alert_type: enum('win_rate','budget','inventory','user','system') NOT NULL (告警类型)
severity: enum('info','warning','danger') NOT NULL (严重程度)
status: enum('active','acknowledged','resolved') NOT NULL (状态)
threshold_value: decimal(10,4) (阈值)
actual_value: decimal(10,4) (实际值)
message: text (告警消息)
```

**admin_operation_logs 表**（操作日志）：
```
log_id: bigint NOT NULL (主键)
operator_id: int NOT NULL (操作人 ID)
operation_type: enum(...) NOT NULL (操作类型，支持 35 种类型)
target_type: varchar(50) NOT NULL (目标类型)
target_id: bigint NOT NULL (目标 ID)
action: varchar(50) NOT NULL (操作动作)
before_data/after_data/changed_fields: json (变更数据)
reason: text (操作原因)
ip_address: varchar(45) (IP 地址)
```

#### B.2 索引验证（consumption_records）

已存在的索引：
- `PRIMARY` - 主键索引
- `uk_consumption_records_idempotency_key` - 幂等键唯一索引
- `uk_consumption_records_business_id` - 业务 ID 唯一索引
- `idx_user_status` - 用户+状态联合索引
- `idx_merchant_time` - 商户+时间联合索引
- `idx_status_created` - 状态+创建时间联合索引
- `idx_consumption_store_status` - 门店+状态联合索引
- `idx_consumption_store_merchant` - 门店+商户联合索引
- `idx_consumption_final_status` - 最终状态索引

### C. 参考文档

| 文档/代码位置 | 说明 |
|--------------|------|
| `/models/index.js` | 项目模型定义入口 |
| `/admin/src/alpine/components/` | Alpine.js 组件目录（共 23 个组件） |
| `/admin/src/api/` | 前端 API 模块（9 个业务模块） |
| `/admin/src/alpine/stores/` | Alpine.js 状态管理（4 个 Store） |
| `/services/` | 后端服务层（50+ 个服务类） |
| `/routes/v4/console/` | 管理后台 API 路由 |

### D. 项目技术架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端 (admin/)                           │
├─────────────────────────────────────────────────────────────────┤
│  Vite 6.4 构建 → Alpine.js 3.15 + ECharts 6.0 + Tailwind 3.4   │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐    │
│  │ Components│  │   API     │  │  Stores   │  │  Utils    │    │
│  │  (23个)   │  │  (9模块)  │  │  (4个)    │  │ (logger)  │    │
│  └───────────┘  └───────────┘  └───────────┘  └───────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              │ HTTP/WebSocket
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      后端 (Node.js 20+)                         │
├─────────────────────────────────────────────────────────────────┤
│  Express 4.18 + JWT 认证 + RBAC 权限                            │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐    │
│  │  Routes   │  │ Services  │  │  Models   │  │  Utils    │    │
│  │ (v4/console)│ │  (50+)    │  │ (73表)    │  │(TimeHelper)│   │
│  └───────────┘  └───────────┘  └───────────┘  └───────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              │ Sequelize ORM
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         数据层                                   │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐        ┌──────────────────┐              │
│  │    MySQL         │        │     Redis        │              │
│  │ (73 表, UTC+8)   │        │ (L2 缓存/分布式锁)│              │
│  └──────────────────┘        └──────────────────┘              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🎯 十一、决策总结与下一步

### 11.1 已确认决策汇总

| 序号 | 决策项 | 决策结果 | 决策日期 |
|-----|--------|---------|---------|
| 1 | **技术实现原则** | 🔴 **以后端为准，前端适配后端** | 2026-02-01 |
| 2 | **优先级划分** | P0/P1/P2 全部实施，按顺序推进 | 2026-01-31 |
| 3 | **页面实现方案** | 方案C（混合方案）- Tab + 独立页面结合 | 2026-01-31 |
| 4 | **侧边栏调整** | 运营优先方案 - 待处理中心置顶、合并资产交易、拆散日常运营 | 2026-01-31 |
| 5 | **预警阈值** | 采用建议值（详见下表） | 2026-01-31 |
| 6 | **索引创建时机** | P0阶段一并创建3个关键索引 | 2026-01-31 |
| 7 | **P2数据库变更** | 无需提前评估，到时再处理 | 2026-01-31 |

### 11.1.1 技术实现原则详解

> **🔴 强制原则：以后端数据库项目实现为准，前端直接适配后端**
>
> **适用范围**：字段命名、数据结构、返回数据、数据类型、枚举值、默认值、业务逻辑——所有技术层面均以后端实现为唯一权威源。

**核心规则**：
1. **字段命名**：前端直接使用后端返回的 `snake_case` 字段名（如 `user_id`、`created_at`、`page_size`）
2. **数据结构**：前端按后端返回的 JSON 结构直接解析，禁止做结构转换或映射
3. **返回数据**：前端直接展示后端返回的数据值，禁止前端自行计算或转换
4. **数据类型**：后端返回 `number` 就是数字、`string` 就是字符串，前端禁止自行转换
5. **枚举值**：前端使用后端定义的枚举值（如 `category: "consumption"`）
6. **默认值**：以后端实际返回为准，前端不得假设默认值
7. **业务逻辑**：计算、统计、判断逻辑以后端代码为准，前端仅做展示
8. **API 路径**：前端使用后端路由文件中定义的实际路径

**禁止行为**：
- ❌ 前端创建 `userId → user_id` 这样的字段映射函数
- ❌ 前端创建 `camelCase ↔ snake_case` 转换层
- ❌ 前端自行定义与后端不同的数据结构
- ❌ 前端自行计算统计数据（应由后端计算返回）
- ❌ 前端自行定义枚举值或状态码
- ❌ 兼容旧 web 端管理平台前端的非标准实现

**执行方式**：
- ✅ 前端开发前，先查阅 `routes/v4/console/*.js` 中的 API 注释和示例
- ✅ 前端开发前，先查阅 `services/*.js` 了解业务逻辑和数据计算方式
- ✅ 发现前端代码使用了非后端标准的字段名/数据/类型时，直接修改前端代码
- ✅ 需要新增字段或修改返回数据时，先修改后端再更新前端
- ✅ 参考本文档「后端 API 字段规范参考」章节中的实际响应格式

### 11.2 预警阈值配置（已决策 ✅）

| 阈值项 | 确认值 | 触发条件 | 应用场景 |
|-------|-------|---------|---------|
| **高档位占比阈值** | **40%** | 高档位奖品发放占比 > 40% | 运营仪表盘预警、抽奖健康度分析 |
| **消费审核超时阈值** | **24小时** | 待审核消费提交时间 > 24小时 | 待处理中心紧急标记 |
| **客服响应超时阈值** | **30分钟** | waiting 状态持续时间 > 30分钟 | 待处理中心紧急标记 |
| **告警处理超时阈值** | **4小时** | 告警创建时间距今 > 4小时且未处理 | 待处理中心紧急标记 |

> **配置说明**：以上阈值将作为系统常量配置，后续可在「系统配置 → 功能开关」中动态调整

### 11.3 实施路线图（已确认 2026-02-01）

```
第1-2周（P0）：
├─ 🔔 待处理中心 Tab（工作台内置，默认激活，带总数徽标）
├─ 📊 运营仪表盘 Tab（工作台内置，核心KPI一屏展示）
├─ 🚨 风控中心（新分组：合并风控告警+抽奖告警）
├─ 💎 资产交易（合并分组：原资产中心+市场交易）
├─ 📋 日常运营精简（保留3个子项，配置类移到系统设置）
└─ ⚙️ 系统设置扩展（接收日常运营移出的配置类菜单）

第3-4周（P1）：
├─ 🎰 抽奖健康度分析
├─ 👤 用户画像弹窗
└─ 📊 多维度分析

第5-6周（P2）：
├─ 📈 KPI追踪系统
├─ 🔔 提醒规则配置
└─ 🔒 风控增强功能
```

### 11.4 预期收益

| 指标 | 当前 | 优化后 | 提升 |
|-----|------|-------|------|
| 待办处理响应时间 | 分散查找 | 登录即见（默认 Tab） | **-80%** |
| 核心指标查看路径 | 多页面切换 | 工作台 Tab 一键切换 | **-60%** |
| 告警遗漏风险 | 分散两处 | 风控中心统一入口 | **-90%** |
| 日常运营菜单噪音 | 8 个子项 | 3 个子项 | **-62%** |
| 导航层级 | 8个一级分组 | 8个一级分组（结构更清晰） | **结构优化** |
| 预警发现时效 | 被动发现 | 实时徽标 + 首页展示 | **主动化** |

---

> **文档维护说明**：
> - 本文档应随业务发展定期更新
> - 数据统计建议每周刷新一次
> - 优先级可根据实际情况调整
> - **技术栈变更时必须同步更新 9.7 节**
> - **决策变更时必须同步更新「关键决策记录」表格**

