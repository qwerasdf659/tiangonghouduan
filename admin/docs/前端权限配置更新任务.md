# 前端权限配置更新任务

> **文档版本**: 1.0.0  
> **创建日期**: 2026-01-27  
> **任务类型**: 前端配置修改  
> **优先级**: 高  
> **预计工时**: 30分钟

---

## 一、任务背景

### 1.1 后端已完成的工作

后端已完成以下权限系统升级：

1. ✅ 创建 `shared/permission-constants.js` 共享常量文件
2. ✅ 新增 `requireRoleLevel(minLevel)` 中间件
3. ✅ 批量替换路由中的权限检查（56处 → 311处使用 requireRoleLevel）
4. ✅ 废除 `ROLE_LEVEL_MAP` 映射表

### 1.2 问题说明

当前前端权限配置中存在阈值不一致问题：

| 配置位置 | ops 对应的 role_level | 实际数据库值 |
|----------|----------------------|--------------|
| 前端 `ROLE_LEVEL_THRESHOLDS.CUSTOMER_SERVICE` | 80 | ops 角色实际是 30 |
| 前端菜单权限 `minLevel` | 80 | 应为 30 |
| 前端页面权限 `minLevel` | 80 | 应为 30 |

**影响**：ops 用户 (role_level=30) 无法看到运营菜单（前端要求 minLevel: 80）

---

## 二、需要修改的文件

**唯一需要修改的文件**：`admin/src/config/permission-rules.js`

---

## 三、具体修改内容

### 3.1 修改 1：阈值常量（第22-29行附近）

**修改前**：
```javascript
export const ROLE_LEVEL_THRESHOLDS = {
  CUSTOMER_SERVICE: 80,
  OPERATIONS: 100,
  ADMIN: 999
}
```

**修改后**：
```javascript
/**
 * 权限等级阈值（与后端 shared/permission-constants.js 保持一致）
 * 
 * 数据库实际 role_level 参考：
 * - admin: 100（超级管理员）
 * - regional_manager: 80（区域经理）
 * - business_manager: 60（业务经理）
 * - sales_staff: 40（销售人员）
 * - merchant_manager: 40（商户店长）
 * - ops: 30（运营，只读）
 * - merchant_staff: 20（商户员工）
 * - user: 0（普通用户）
 */
export const ROLE_LEVEL_THRESHOLDS = {
  CUSTOMER_SERVICE: 1,   // 修正：>= 1 即可访问客服功能
  OPS: 30,               // 新增：运营阈值（以数据库实际值为准）
  ADMIN: 100             // 修正：管理员阈值
}
// 注：不定义 HIGH_OPS(80)，当前无使用场景，需要时直接用数值
```

---

### 3.2 修改 2：菜单权限配置（MENU_ACCESS_RULES）

共 **18 处** `minLevel: 80` 需改为 `minLevel: 30`：

```javascript
export const MENU_ACCESS_RULES = {
  // ===== 所有人可访问（保持不变）=====
  'dashboard': { minLevel: 0, description: '工作台' },
  'operations.customer': { minLevel: 0, description: '客服工作台' },

  // ===== 运营功能：80 → 30 =====
  'operations': { minLevel: 30, description: '日常运营（分组）' },
  'operations.consumption': { minLevel: 30, description: '消费记录审核' },
  'operations.risk': { minLevel: 30, description: '风控告警' },

  'lottery': { minLevel: 30, description: '抽奖活动（分组）' },
  'lottery.campaigns': { minLevel: 30, description: '活动管理' },
  'lottery.presets': { minLevel: 30, description: '抽奖预设' },

  'assets': { minLevel: 30, description: '资产中心（分组）' },
  'assets.asset-mgmt': { minLevel: 30, description: '资产管理' },
  'assets.asset-adj': { minLevel: 30, description: '资产调整' },
  'assets.orphan': { minLevel: 30, description: '孤儿冻结清理' },
  'assets.material-rules': { minLevel: 30, description: '物料转换规则' },
  'assets.assets-portfolio': { minLevel: 30, description: '资产组合' },

  'market': { minLevel: 30, description: '市场交易（分组）' },
  'market.exchange': { minLevel: 30, description: '兑换市场' },
  'market.trade': { minLevel: 30, description: 'C2C交易' },

  'users': { minLevel: 30, description: '用户门店（分组）' },
  'users.user-mgmt': { minLevel: 30, description: '用户管理' },
  'users.user-hierarchy': { minLevel: 30, description: '用户层级' },
  'users.stores': { minLevel: 30, description: '门店管理' },

  'analytics': { minLevel: 30, description: '数据分析（分组）' },
  'analytics.stats': { minLevel: 30, description: '统计报表' },
  'analytics.analytics': { minLevel: 30, description: '运营分析' },

  // ===== 系统设置（保持不变，仅管理员）=====
  'system': { minLevel: 100, description: '系统设置（分组）' },
  'system.settings': { minLevel: 100, description: '系统配置' },
  'system.content': { minLevel: 100, description: '内容管理' },
  'system.sessions': { minLevel: 100, description: '会话管理' },
  'system.item-tpl': { minLevel: 100, description: '物品模板' },
  'system.config-tools': { minLevel: 100, description: '配置工具' }
}
```

---

### 3.3 修改 3：页面权限配置（PAGE_ACCESS_RULES）

共 **18 处** `minLevel: 80` 需改为 `minLevel: 30`：

```javascript
export const PAGE_ACCESS_RULES = {
  // ===== 所有人可访问（保持不变）=====
  'statistics.html': { minLevel: 0, menuId: 'dashboard' },
  'customer-service.html': { minLevel: 0, menuId: 'operations.customer' },

  // ===== 运营功能：80 → 30 =====
  'finance-management.html': { minLevel: 30, menuId: 'operations.consumption' },
  'risk-alerts.html': { minLevel: 30, menuId: 'operations.risk' },
  'lottery-management.html': { minLevel: 30, menuId: 'lottery.campaigns' },
  'presets.html': { minLevel: 30, menuId: 'lottery.presets' },
  'asset-management.html': { minLevel: 30, menuId: 'assets.asset-mgmt' },
  'asset-adjustment.html': { minLevel: 30, menuId: 'assets.asset-adj' },
  'orphan-frozen.html': { minLevel: 30, menuId: 'assets.orphan' },
  'material-conversion-rules.html': { minLevel: 30, menuId: 'assets.material-rules' },
  'assets-portfolio.html': { minLevel: 30, menuId: 'assets.assets-portfolio' },
  'exchange-market.html': { minLevel: 30, menuId: 'market.exchange' },
  'trade-management.html': { minLevel: 30, menuId: 'market.trade' },
  'user-management.html': { minLevel: 30, menuId: 'users.user-mgmt' },
  'user-hierarchy.html': { minLevel: 30, menuId: 'users.user-hierarchy' },
  'store-management.html': { minLevel: 30, menuId: 'users.stores' },
  'analytics.html': { minLevel: 30, menuId: 'analytics.analytics' },

  // ===== 系统设置（保持不变）=====
  'system-settings.html': { minLevel: 100, menuId: 'system.settings' },
  'content-management.html': { minLevel: 100, menuId: 'system.content' },
  'sessions.html': { minLevel: 100, menuId: 'system.sessions' },
  'item-templates.html': { minLevel: 100, menuId: 'system.item-tpl' },
  'config-tools.html': { minLevel: 100, menuId: 'system.config-tools' }
}
```

---

### 3.4 修改 4：角色描述函数（getUserRoleLevelDescription）

**修改前**：
```javascript
export function getUserRoleLevelDescription() {
  const level = getUserRoleLevel()
  if (level >= ROLE_LEVEL_THRESHOLDS.ADMIN) return '超级管理员'
  else if (level >= ROLE_LEVEL_THRESHOLDS.OPERATIONS) return '管理员'
  else if (level >= ROLE_LEVEL_THRESHOLDS.CUSTOMER_SERVICE) return '运营'
  else return '客服'
}
```

**修改后**：
```javascript
/**
 * 获取用户角色级别描述
 * 
 * @description 根据 role_level 返回人类可读的角色描述
 * @returns {string} 角色描述
 */
export function getUserRoleLevelDescription() {
  const level = getUserRoleLevel()
  if (level >= 100) return '超级管理员'
  else if (level >= 80) return '高级运营'
  else if (level >= 30) return '运营'
  else if (level >= 1) return '客服'
  else return '普通用户'
}
```

---

## 四、修改汇总

| 修改项 | 修改位置 | 修改数量 |
|--------|----------|----------|
| 阈值常量 | `ROLE_LEVEL_THRESHOLDS` | 1 处 |
| 菜单权限 | `MENU_ACCESS_RULES` | 18 处 |
| 页面权限 | `PAGE_ACCESS_RULES` | 18 处 |
| 角色描述函数 | `getUserRoleLevelDescription` | 1 处 |
| **总计** | - | **38 处** |

---

## 五、测试验证

### 5.1 验证步骤

1. **修改完成后重新构建**：
   ```bash
   cd /home/devbox/project/admin
   npm run build
   ```

2. **清除浏览器缓存**（或使用无痕模式）

3. **使用不同角色账号登录测试**：
   - admin (role_level=100)：应能看到所有菜单
   - ops (role_level=30)：应能看到运营菜单（operations、lottery、assets、market、users、analytics）
   - 普通用户 (role_level=0)：应只能看到 dashboard

### 5.2 预期结果

| 角色 | role_level | 可见菜单 |
|------|------------|----------|
| admin | 100 | 全部菜单 |
| regional_manager | 80 | 运营 + 系统设置以外的全部 |
| business_manager | 60 | 运营 + 系统设置以外的全部 |
| ops | 30 | 运营相关菜单（不含系统设置） |
| merchant_staff | 20 | 仅 dashboard 和 客服工作台 |
| user | 0 | 仅 dashboard |

---

## 六、关联文档

- [role_level映射方案技术评估.md](./role_level映射方案技术评估.md) - 完整技术评估
- [基于role_level的前端权限控制方案.md](./基于role_level的前端权限控制方案.md) - 前端权限控制方案

---

## 七、联系人

如有问题，请联系后端开发人员确认：
- 共享常量文件位置：`/home/devbox/project/shared/permission-constants.js`
- 后端权限中间件：`/home/devbox/project/middleware/auth.js` → `requireRoleLevel()`

