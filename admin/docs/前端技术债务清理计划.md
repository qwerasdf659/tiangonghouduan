# 前端技术债务清理计划

> **核心目标**：清理管理后台前端的技术债务，所有改动必须对运营人员**完全无感知**——不改变任何页面的功能、布局、操作流程和数据展示。

> **绝对红线**：任何一项清理工作，如果会导致运营人员在使用过程中看到界面变化、流程变化、或需要重新学习操作方式，就**不在本计划范围内**。本计划只处理"引擎盖下的事情"。

---

## 一、当前债务全景

基于 2026-02-06 对 `admin/` 项目的全面扫描（140个源文件、36个HTML页面），识别出以下技术债务：

| # | 债务项 | 规模 | 严重度 |
|:---:|---|---|:---:|
| 1 | 500行以上的JS文件 | 40个 | 🔴 高 |
| 2 | 原生fetch绕过统一请求封装 | 91处 / 21个文件 | 🔴 高 |
| 3 | 同名函数重复定义（不同实现） | 2组 | 🔴 高 |
| 4 | 未清理的事件监听器 | ~70处 | 🔴 高 |
| 5 | 缺少composables逻辑层的模块 | 4/9个 | 🟡 中 |
| 6 | 硬编码API路径 | 34处 / 12个文件 | 🟡 中 |
| 7 | ESLint warnings | 67个 | 🟡 中 |

---

## 二、运营影响分级

### ✅ A类：纯内部重构，运营零感知

以下改动只涉及代码文件的内部结构调整，不改变任何页面的请求地址、界面展示、操作行为。运营人员使用前后**完全看不出区别**。

---

#### A1. 500行以上JS文件拆分（40个文件）

**现状**：单个文件过大，最严重的 `dashboard-panel.js` 有 2641 行、122 个方法。

**最大的文件**：

| 文件 | 行数 | 所属模块 |
|---|:---:|---|
| `analytics/pages/dashboard-panel.js` | 2641 | 仪表盘 |
| `system/pages/risk-alerts.js` | 1590 | 风险预警 |
| `lottery/composables/metrics.js` | 1285 | 抽奖指标 |
| `analytics/pages/statistics.js` | 1201 | 统计分析 |
| `asset/pages/asset-adjustment.js` | 1200 | 资产调整 |
| `system/pages/audit-logs.js` | 1068 | 审计日志 |
| `lottery/pages/lottery-alerts.js` | 1003 | 抽奖预警 |
| `store/pages/store-management.js` | 1005 | 商品管理 |
| `content/pages/content-management.js` | 981 | 内容管理 |

**为什么运营无感知**：只是把一个大文件拆成多个小文件，所有函数名、行为、HTML绑定完全不变。就像把一本书拆成多个章节，内容一个字没改。

**做法**：
- 将页面JS中的业务逻辑抽取到对应模块的 `composables/` 目录
- 每个 composable 文件职责单一（状态管理、API调用、数据转换各自分离）
- 页面JS只保留初始化入口和模板绑定
- 拆完后跑E2E测试确认无回归

---

#### A2. 补齐缺失的 composables 逻辑层（4个模块）

**现状**：9个业务模块中，4个没有 `composables/` 目录，所有业务逻辑直接写在页面文件里，无法复用。

| 模块 | composables | 状态 |
|---|:---:|---|
| lottery | ✅ 17个composable文件 | 良好 |
| user | ✅ | 良好 |
| system | ✅ | 良好 |
| analytics | ✅ | 良好 |
| market | ✅ | 良好 |
| **asset** | ❌ | 逻辑全在页面中 |
| **content** | ❌ | 逻辑全在页面中 |
| **store** | ❌ | 逻辑全在页面中 |
| **operations** | ❌ | 逻辑全在页面中 |

**为什么运营无感知**：和A1一样，纯粹是代码组织方式的调整，不改变任何外在行为。

**做法**：
- 为 asset、content、store、operations 四个模块各建立 `composables/` 目录
- 从对应的 pages/*.js 中提取状态定义和方法
- 页面文件通过 `...useXxxState()` / `...useXxxMethods()` 引入（与 lottery 模块保持一致）

---

#### A3. 硬编码API路径替换（34处 / 12个文件）

**现状**：项目定义了统一的 `API_PREFIX = '/api/v4'`，但34处直接写死了 `/api/v4/...`。

**涉及文件**：

| 文件 | 硬编码处数 | 说明 |
|---|:---:|---|
| `analytics/pages/dashboard-panel.js` | 17 | 最严重，含mock数据和fetch调用 |
| `alpine/components/sidebar-nav.js` | 4 | 导航栏健康检查/徽章 |
| `modules/analytics/composables/consumption.js` | 3 | 批量审核接口 |
| `alpine/components/notification-center.js` | 2 | 通知加载/已读 |
| `alpine/components/user-drawer.js` | 1 | 行为轨迹 |
| `alpine/mixins/auth-guard.js` | 1 | 认证检查 |
| `alpine/mixins/async-data.js` | 1 | 注释中的示例代码 |
| `alpine/mixins/index.js` | 1 | 注释中的示例代码 |
| `alpine/init.js` | 1 | 注释中的示例代码 |
| `api/system/core.js` | 1 | VERSION常量 |
| `modules/user/composables/users.js` | 1 | 用户统计 |
| `modules/asset/pages/asset-adjustment.js` | 1 | 本地API_BASE_URL常量 |

**为什么运营无感知**：`'/api/v4/users'` 替换为 `` `${API_PREFIX}/users` ``，实际请求的URL一模一样。

**做法**：
- 全局搜索 `'/api/v4` 和 `"/api/v4`
- 替换为 `API_PREFIX` 或对应模块的 `ENDPOINTS` 常量引用
- 逐个验证替换后的完整URL正确性

---

#### A4. 事件监听器清理（~70处）

**现状**：73处 `addEventListener`，仅3处有对应的 `removeEventListener`；17处 `setInterval`，14处有 `clearInterval`。

**为什么运营无感知**：添加清理代码不改变任何功能，只是在页面/组件卸载时释放资源。运营人员唯一可能感受到的区别是**长时间使用后页面不再变卡**（正面影响）。

**做法**：
- 为所有注册了事件监听的Alpine组件补充 `destroy()` 方法
- 在 `destroy()` 中清理 `addEventListener`、`setInterval`、`WebSocket` 连接
- 已有 `destroy()` 的组件（`animated-counter`、`notification-center`、`lottery-alerts` 等）可作为参考模板

---

#### A5. ESLint warnings 清理（67个）

**现状**：67个 warning（0个 error），主要是 `no-unused-vars`（未使用变量）和 `no-undef`（未定义变量）。

**为什么运营无感知**：删除废弃变量、补充变量声明，不改变任何运行时行为。

**做法**：
```bash
cd admin && npx eslint src/ --fix   # 自动修复1个
# 剩余66个手动逐一处理
```

---

### ⚠️ B类：内部重构但需要逐步验证

以下改动虽然不改变页面外观，但涉及**网络请求和数据处理链路**，替换不当可能导致某个接口返回异常。需要逐个文件替换并验证。

---

#### B1. 原生 fetch() → 统一 request() 封装（91处 / 21个文件）

**现状**：项目在 `api/base.js` 中封装了统一请求函数 `request()` 和 `http.get/post/...`，提供了：
- Token 自动注入
- 401 未授权自动跳转登录页
- 统一错误处理和日志记录

但91处仍在使用原生 `fetch()`，自行处理上述逻辑（或不处理）。

**各文件情况**：

| 文件 | fetch处数 | 风险 | 说明 |
|---|:---:|:---:|---|
| **API封装层**（7个文件） | | | |
| `api/reminder.js` | 11 | 低 | 封装层文件，替换后行为一致 |
| `api/report-templates.js` | 8 | 低 | 同上 |
| `api/dashboard.js` | 7 | 低 | 同上 |
| `api/user-segments.js` | 5 | 低 | 同上 |
| `api/pending.js` | 4 | 低 | 同上 |
| `api/lottery-health.js` | 4 | 低 | 同上 |
| `api/multi-dimension-stats.js` | 2 | 低 | 同上 |
| **组件层**（3个文件） | | | |
| `alpine/components/sidebar-nav.js` | 4 | 中 | 需核对catch块 |
| `alpine/components/notification-center.js` | 3 | 中 | 含WebSocket逻辑 |
| `modules/system/pages/login.js` | 2 | 中 | 登录流程特殊 |
| **页面层**（5个文件） | | | |
| `analytics/pages/dashboard-panel.js` | 21 | 高 | 最复杂，需逐个验证 |
| `asset/pages/asset-adjustment.js` | 9 | 高 | 含表单提交 |
| `analytics/pages/statistics.js` | 2 | 中 | |
| `content/pages/content-management.js` | 2 | 中 | |
| `user/pages/user-management.js` | 1 | 低 | |
| **零散分布**（6个文件，各1处） | | | |
| `system/pages/orphan-frozen.js` | 1 | 低 | |
| `lottery/composables/redemption.js` | 1 | 低 | |
| `content/pages/customer-service.js` | 1 | 低 | |
| `api/asset.js` | 1 | 低 | |
| `alpine/mixins/index.js` | 1 | 低 | |
| `alpine/mixins/auth-guard.js` | 1 | 低 | |

**为什么需要小心**：

统一 `request()` 的错误行为与原生 `fetch` 不同：

| 行为 | 原生 fetch | 统一 request() |
|---|---|---|
| 401处理 | 各处自行处理（有的不处理） | 自动跳转登录页 |
| 非2xx响应 | 不抛异常（需手动检查） | 自动抛异常 |
| 响应解析 | 手动 `response.json()` | 自动解析 |
| 网络错误日志 | 各处自行记录 | 统一 logger 记录 |

如果某个页面之前的 catch 块依赖 "fetch不会自动抛异常"的行为，替换后可能出现**运营看到的错误提示变了**。

**做法（分三步）**：

**第一步 — API封装层**（7个文件，41处）：这些文件本身就是API封装，替换最安全。将各函数内的 `fetch() + authHeaders() + handleResponse()` 模式统一为 `request()` 或 `http.get/post/...` 调用。

**第二步 — 组件层**（3个文件，9处）：逐个核对每处 fetch 的错误处理逻辑，确保替换后 catch 块的行为不变。

**第三步 — 页面层**（5个文件，41处）：一个页面一个页面来，每替换一处就在浏览器中测试该页面的相关操作：
- `dashboard-panel.js`（21处）：测试仪表盘各Tab数据加载、图表渲染
- `asset-adjustment.js`（9处）：测试资产调整表单提交、审批流程
- 其余3个文件按量从少到多处理

---

#### B2. 重复定义的同名函数合并（2组）

**现状**：`buildQueryString` 和 `buildURL` 在两个文件中各有一份实现，**功能不同**。

| 函数 | api/base.js 中的版本 | utils/index.js 中的版本 |
|---|---|---|
| `buildQueryString` | 返回 `?key=val` 格式（带问号前缀） | 返回 `key=val` 格式（不带问号） |
| `buildURL` | 替换路径参数（`:id` → `123`） | 拼接查询参数（`?key=val`） |

**实际依赖分析**：

| 函数 | 从 api/base.js 导入 | 从 utils/index.js 导入 |
|---|:---:|:---:|
| `buildURL` | **57个文件**（核心基础设施） | 0个文件 |
| `buildQueryString` | ~16个文件 | 0个文件 |

`api/base.js` 的 `buildURL` 被57个文件直接 import，用于构造带路径参数的URL后传给 `this.apiGet(url)`。这是因为 `apiGet()` 不支持 `pathParams`，业务代码必须先拼好URL：

```javascript
// 项目中最普遍的调用模式（57个文件都这么用）
import { buildURL } from '../../../api/base.js'
const url = buildURL(ENDPOINTS.DETAIL, { code })
const response = await this.apiGet(url)
```

`utils/index.js` 中的两个同名函数**没有任何文件 import**，是无人使用的死代码。

**做法**：
1. **删除** `utils/index.js` 中的 `buildQueryString` 和 `buildURL`（死代码，0个调用方）
2. **保留** `api/base.js` 中的 `buildURL` 和 `buildQueryString` 导出不变（57个文件依赖）
3. 同名冲突自然消除——唯一的实现来源是 `api/base.js`

---

## 三、执行计划

### 第1批：随手做（预计1-2天，零风险）

| 任务 | 预估时间 | 验证方式 |
|---|---|---|
| ESLint 67个warning清理 | 半天 | `npx eslint src/` 零warning |
| 硬编码API路径替换（34处/12个文件） | 2小时 | 全局搜索 `'/api/v4` 结果为0（排除注释中的示例） |

### 第2批：API封装层统一（预计2-3天，低风险）

| 任务 | 预估时间 | 验证方式 |
|---|---|---|
| 7个API模块文件的 fetch→request（41处） | 1天 | 对应页面手动操作验证 |
| 删除utils/index.js中的重复函数（2组） | 30分钟 | `utils/index.js` 中无 `buildURL`/`buildQueryString` |
| 事件监听器清理（补destroy） | 1-2天 | 长时间打开页面后内存不增长 |

### 第3批：模块结构优化（预计4-5天，零风险）

| 任务 | 预估时间 | 验证方式 |
|---|---|---|
| asset 模块补composables | 半天 | E2E测试通过 |
| content 模块补composables | 半天 | E2E测试通过 |
| store 模块补composables | 半天 | E2E测试通过 |
| operations 模块补composables | 半天 | E2E测试通过 |
| dashboard-panel.js 拆分（2641行） | 1天 | 仪表盘页面功能完整 |
| 其他大文件拆分（按优先级） | 2天 | E2E测试通过 |

### 第4批：逐页精细处理（预计3-5天，需逐个验证）

| 任务 | 预估时间 | 验证方式 |
|---|---|---|
| dashboard-panel.js 21处fetch替换 | 1天 | 仪表盘各Tab手动验证 |
| asset-adjustment.js 9处fetch替换 | 半天 | 资产调整全流程验证 |
| 其余3个文件fetch替换（5处） | 半天 | 对应页面手动验证 |
| 组件层fetch替换（9处） | 半天 | 侧边栏/通知中心验证 |

---

## 四、验证标准

每一批改动完成后，必须通过以下验证才能合入主分支：

1. **E2E测试全部通过**：`npx playwright test` 22个用例全绿
2. **ESLint检查通过**：`npx eslint src/` 无新增warning
3. **构建成功**：`npm run build` 无报错
4. **关键页面手动验证**（仅B类改动需要）：
   - 仪表盘：各Tab数据加载、图表渲染
   - 用户管理：搜索、筛选、查看详情
   - 资产调整：表单提交、审批操作
   - 交易管理：订单列表、核销操作
   - 抽奖管理：活动列表、配额管理

---

## 五、附录：当前未处理的运营体验问题

以下问题在本次扫描中同时发现，但**不属于本计划范围**（它们需要改变界面行为，需要单独排期）：

| # | 问题 | 影响范围 | 运营感受 |
|:---:|---|---|---|
| 1 | 错误提示直接暴露技术细节 | 全局 | API失败时看到 `SequelizeUniqueConstraintError` 等技术错误，完全无法理解 |
| 2 | 数据刷新状态不透明 | 告警/审核/仪表盘 | 不知道当前数据是10秒前还是10分钟前的，26处轮询逻辑无统一的「上次更新时间」提示 |
| 3 | 筛选重置功能覆盖不全 | lottery-alerts/risk-alerts/sessions等 | 设了筛选条件后想看全量数据只能刷新整个页面，条件残留导致「为什么看不到新告警了」 |
| 4 | 分页默认值不统一 | 全局列表页 | 28个页面 page_size=20、3个=10、2个=1000；数据量增长后 page_size=1000 的页面会突然变卡 |
| 5 | 错误静默/反馈缺失 | 13/31页面 | 加载失败时运营看到空白，不知道原因 |
| 6 | 危险操作缺少二次确认 | 6+个关键页面 | user-management封禁、asset-management禁用等无确认弹窗 |
| 7 | 筛选条件刷新后丢失 | 27/31页面 | 不保存到URL，刷新回初始状态 |
| 8 | 图表环境色不跟随暗色主题 | 含图表的6个页面（38处） | 暗色模式下坐标轴标签、分割线、tooltip背景仍为浅色系，图表可读性严重下降 |
| 9 | 已有组件能力未接入业务 | 全局 | keyboard-shortcuts/data-table/virtual-list 三个组件已定义但0个页面使用，高频操作全靠鼠标 |
| 10 | 表格不支持列排序 | 22/26个表格页 | 只有4个页面支持排序 |
| 11 | 部分页面无帮助提示 | dashboard-panel等 | 无tooltip/placeholder引导 |
| 12 | 部分页面不支持数据导出 | store/content/trade等 | 运营需手动复制数据 |
| 13 | 批量操作覆盖不全 | analytics/dict等 | 需要逐条操作 |

**关于第8项图表颜色的补充说明**：JS中共127处硬编码十六进制颜色值，但只有 **38处** 是真正的问题：

| 分类 | 数量 | 是否需要改 | 说明 |
|---|:---:|:---:|---|
| 图表系列色（itemStyle/lineStyle/color数组） | 87 | ❌ | 红=危险、绿=正常等语义固定色，不应跟主题变 |
| 导出报告HTML样式 | 30 | ❌ | 打印/导出页面永远白底渲染，不受主题影响 |
| **图表环境色**（轴线/背景/文字/tooltip） | **38** | ✅ | 暗色模式下不可见，需提取为主题感知函数 |

问题集中在 `dashboard-panel.js`、`audit-logs.js`、`statistics.js`、`analytics.js` 等页面，典型代码如：
```javascript
// 这些颜色在暗色背景下看不清
borderColor: '#e2e8f0',                    // 浅灰边框 → 暗色下不可见
textStyle: { color: '#334155' },           // 深色文字 → 暗色下也是深色
axisLabel: { color: '#64748b' },           // 坐标轴标签
splitLine: { color: '#f1f5f9' },           // 极浅灰分割线
tooltip: { backgroundColor: 'rgba(255,255,255,0.95)' } // 白底tooltip
```

这些问题需要产品+运营+开发共同评审后排入迭代，不在本次"零感知"技术债务清理范围内。

