<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '数据驾驶舱', 
    pageStyle: `
      [x-cloak] { display: none !important; }
      
      /* 自定义滚动条 */
      .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
      .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
      .scrollbar-thin::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
      .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
      
      /* 指标卡片悬停效果 */
      .stat-card { transition: all 0.3s ease; }
      .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
      
      /* 图表容器 */
      .chart-container { min-height: 320px; }
      
      /* 预警级别颜色 */
      .alert-critical { border-left: 4px solid #ef4444; background: rgba(239, 68, 68, 0.05); }
      .alert-warning { border-left: 4px solid #f59e0b; background: rgba(245, 158, 11, 0.05); }
      .alert-info { border-left: 4px solid #3b82f6; background: rgba(59, 130, 246, 0.05); }
      
      /* 闪烁动画 */
      @keyframes pulse-alert {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
      }
      .pulse-alert { animation: pulse-alert 2s infinite; }
      
      /* 趋势指示器 */
      .trend-up { color: #10b981; }
      .trend-down { color: #ef4444; }
      .trend-flat { color: #6b7280; }
      
      /* Tab样式 */
      .tab-btn { transition: all 0.2s ease; border-bottom: 3px solid transparent; }
      .tab-btn:hover { background: rgba(59, 130, 246, 0.1); }
      .tab-btn.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: 600; }
      
      /* 桑基图容器 */
      .sankey-container { min-height: 400px; }
      
      /* 漏斗图容器 */
      .funnel-container { min-height: 350px; }
    `
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen">
  <div x-data="dashboardPanelPage()" x-init="init()" x-cloak class="p-6 space-y-6">
    <!-- 顶部控制栏 -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold themed-text">📊 数据驾驶舱</h1>
        <p class="text-sm themed-text-muted mt-1">
          实时监控核心业务指标 · 最后更新: <span x-text="lastUpdateTime">--:--:--</span>
        </p>
      </div>
      
      <div class="flex items-center gap-3">
        <!-- 时间范围选择器 -->
        <div class="flex themed-bg-base rounded-lg shadow-sm themed-border">
          <button 
            @click="switchTimeRange('today')"
            :class="timeRange === 'today' ? 'bg-blue-500 text-white' : 'themed-text hover:themed-bg-subtle'"
            class="px-4 py-2 text-sm font-medium rounded-l-lg transition"
          >今日</button>
          <button 
            @click="switchTimeRange('7d')"
            :class="timeRange === '7d' ? 'bg-blue-500 text-white' : 'themed-text hover:themed-bg-subtle'"
            class="px-4 py-2 text-sm font-medium transition"
          >近7天</button>
          <button 
            @click="switchTimeRange('30d')"
            :class="timeRange === '30d' ? 'bg-blue-500 text-white' : 'themed-text hover:themed-bg-subtle'"
            class="px-4 py-2 text-sm font-medium rounded-r-lg transition"
          >近30天</button>
        </div>
        
        <button 
          @click="refreshDashboard()" 
          :disabled="loading"
          class="flex items-center gap-2 px-4 py-2 themed-bg-base themed-border rounded-lg text-sm font-medium themed-text hover:themed-bg-subtle transition"
        >
          <span :class="{ 'animate-spin': loading }">🔄</span>
          刷新
        </button>
      </div>
    </div>
    
    <!-- P2-2: Tab导航栏 -->
    <div class="themed-card rounded-xl overflow-hidden">
      <div class="flex themed-bg-base border-b themed-border overflow-x-auto">
        <button 
          @click="activeTab = 'overview'"
          :class="{ 'active': activeTab === 'overview' }"
          class="tab-btn flex items-center gap-2 px-6 py-4 text-sm themed-text whitespace-nowrap"
        >
          <span>📊</span>
          <span>运营大盘</span>
        </button>
        <button 
          @click="activeTab = 'lottery'"
          :class="{ 'active': activeTab === 'lottery' }"
          class="tab-btn flex items-center gap-2 px-6 py-4 text-sm themed-text whitespace-nowrap"
        >
          <span>🎰</span>
          <span>抽奖分析</span>
        </button>
        <button 
          @click="activeTab = 'user'"
          :class="{ 'active': activeTab === 'user' }"
          class="tab-btn flex items-center gap-2 px-6 py-4 text-sm themed-text whitespace-nowrap"
        >
          <span>👥</span>
          <span>用户分析</span>
        </button>
        <button 
          @click="activeTab = 'asset-flow'"
          :class="{ 'active': activeTab === 'asset-flow' }"
          class="tab-btn flex items-center gap-2 px-6 py-4 text-sm themed-text whitespace-nowrap"
        >
          <span>💎</span>
          <span>资产流动</span>
        </button>
        <button 
          @click="activeTab = 'funnel'"
          :class="{ 'active': activeTab === 'funnel' }"
          class="tab-btn flex items-center gap-2 px-6 py-4 text-sm themed-text whitespace-nowrap"
        >
          <span>📉</span>
          <span>转化漏斗</span>
        </button>
        <button 
          @click="activeTab = 'merchant'"
          :class="{ 'active': activeTab === 'merchant' }"
          class="tab-btn flex items-center gap-2 px-6 py-4 text-sm themed-text whitespace-nowrap"
        >
          <span>🏪</span>
          <span>商户贡献度</span>
        </button>
      </div>
    </div>
    
    <!-- ==================== Tab 1: 运营大盘 ==================== -->
    <template x-if="activeTab === 'overview'">
      <div class="space-y-6">
        <!-- 核心指标卡片 - 5个 -->
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
          <!-- 今日抽奖次数 -->
          <div class="stat-card themed-card rounded-xl p-5">
            <div class="flex items-center justify-between">
              <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">🎰</span>
              </div>
              <template x-if="stats.lottery_trend">
                <span 
                  :class="stats.lottery_trend > 0 ? 'trend-up' : stats.lottery_trend < 0 ? 'trend-down' : 'trend-flat'"
                  class="text-sm font-medium"
                >
                  <span x-text="stats.lottery_trend > 0 ? '↑' : stats.lottery_trend < 0 ? '↓' : '→'"></span>
                  <span x-text="Math.abs(stats.lottery_trend) + '%'"></span>
                </span>
              </template>
            </div>
            <div class="mt-4">
              <div class="text-2xl font-bold themed-text" x-text="formatNumber(stats.lottery_count || 0)">0</div>
              <div class="text-sm themed-text-muted">今日抽奖次数</div>
            </div>
          </div>
          
          <!-- 新增用户 -->
          <div class="stat-card themed-card rounded-xl p-5">
            <div class="flex items-center justify-between">
              <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">👥</span>
              </div>
              <template x-if="stats.user_trend">
                <span 
                  :class="stats.user_trend > 0 ? 'trend-up' : stats.user_trend < 0 ? 'trend-down' : 'trend-flat'"
                  class="text-sm font-medium"
                >
                  <span x-text="stats.user_trend > 0 ? '↑' : stats.user_trend < 0 ? '↓' : '→'"></span>
                  <span x-text="Math.abs(stats.user_trend) + '%'"></span>
                </span>
              </template>
            </div>
            <div class="mt-4">
              <div class="text-2xl font-bold themed-text" x-text="formatNumber(stats.new_users || 0)">0</div>
              <div class="text-sm themed-text-muted">新增用户</div>
            </div>
          </div>
          
          <!-- 中奖率 -->
          <div class="stat-card themed-card rounded-xl p-5">
            <div class="flex items-center justify-between">
              <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">🏆</span>
              </div>
              <template x-if="stats.win_rate_trend">
                <span 
                  :class="stats.win_rate_trend > 0 ? 'trend-up' : stats.win_rate_trend < 0 ? 'trend-down' : 'trend-flat'"
                  class="text-sm font-medium"
                >
                  <span x-text="stats.win_rate_trend > 0 ? '↑' : stats.win_rate_trend < 0 ? '↓' : '→'"></span>
                  <span x-text="Math.abs(stats.win_rate_trend) + '%'"></span>
                </span>
              </template>
            </div>
            <div class="mt-4">
              <div class="text-2xl font-bold themed-text" x-text="(stats.win_rate || 0).toFixed(1) + '%'">0%</div>
              <div class="text-sm themed-text-muted">中奖率</div>
            </div>
          </div>
          
          <!-- 待审核消耗 -->
          <div class="stat-card themed-card rounded-xl p-5">
            <div class="flex items-center justify-between">
              <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">📋</span>
              </div>
              <template x-if="stats.pending_consumption > 0">
                <span class="px-2 py-0.5 bg-red-500 text-white text-xs rounded-full pulse-alert">紧急</span>
              </template>
            </div>
            <div class="mt-4">
              <div class="text-2xl font-bold themed-text" x-text="formatNumber(stats.pending_consumption || 0)">0</div>
              <div class="text-sm themed-text-muted">待审核消耗</div>
            </div>
          </div>
          
          <!-- 活动预算消耗 -->
          <div class="stat-card themed-card rounded-xl p-5">
            <div class="flex items-center justify-between">
              <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">💰</span>
              </div>
              <template x-if="stats.budget_usage >= 80">
                <span 
                  :class="stats.budget_usage >= 90 ? 'bg-red-500' : 'bg-yellow-500'"
                  class="px-2 py-0.5 text-white text-xs rounded-full"
                  x-text="stats.budget_usage >= 90 ? '预警' : '注意'"
                ></span>
              </template>
            </div>
            <div class="mt-4">
              <div class="flex items-baseline gap-1">
                <span class="text-2xl font-bold themed-text" x-text="(stats.budget_usage || 0).toFixed(1) + '%'">0%</span>
              </div>
              <div class="text-sm themed-text-muted">预算消耗率</div>
              <!-- 进度条 -->
              <div class="mt-2 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                <div 
                  class="h-full transition-all duration-500"
                  :class="stats.budget_usage >= 90 ? 'bg-red-500' : stats.budget_usage >= 80 ? 'bg-yellow-500' : 'bg-green-500'"
                  :style="'width: ' + Math.min(stats.budget_usage || 0, 100) + '%'"
                ></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 主内容区：趋势图 + 预警列表 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- 7天趋势图 -->
          <div class="lg:col-span-2 themed-card rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold themed-text">📈 业务趋势</h3>
              <div class="flex gap-2">
                <button 
                  @click="trendType = 'lottery'"
                  :class="trendType === 'lottery' ? 'bg-blue-100 text-blue-600' : 'themed-bg-subtle themed-text'"
                  class="px-3 py-1 rounded-md text-sm font-medium transition"
                >抽奖次数</button>
                <button 
                  @click="trendType = 'users'"
                  :class="trendType === 'users' ? 'bg-blue-100 text-blue-600' : 'themed-bg-subtle themed-text'"
                  class="px-3 py-1 rounded-md text-sm font-medium transition"
                >活跃用户</button>
                <button 
                  @click="trendType = 'prizes'"
                  :class="trendType === 'prizes' ? 'bg-blue-100 text-blue-600' : 'themed-bg-subtle themed-text'"
                  class="px-3 py-1 rounded-md text-sm font-medium transition"
                >奖品发放</button>
              </div>
            </div>
            <div id="trend-chart" class="chart-container"></div>
          </div>
          
          <!-- 实时预警列表 -->
          <div class="themed-card rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold themed-text">🚨 实时预警</h3>
              <span 
                x-show="alerts.length > 0"
                class="px-2 py-0.5 bg-red-100 text-red-600 text-xs rounded-full font-medium"
                x-text="alerts.length + '条'"
              ></span>
            </div>
            
            <!-- 预警列表 -->
            <div class="space-y-3 max-h-[400px] overflow-y-auto scrollbar-thin">
              <template x-if="alerts.length === 0">
                <div class="text-center py-8 themed-text-muted">
                  <div class="text-4xl mb-2">✅</div>
                  <div>暂无预警信息</div>
                </div>
              </template>
              
              <template x-for="alert in alerts" :key="alert.id">
                <div 
                  class="p-4 rounded-lg cursor-pointer hover:shadow-md transition"
                  :class="{
                    'alert-critical': alert.level === 'critical',
                    'alert-warning': alert.level === 'warning',
                    'alert-info': alert.level === 'info'
                  }"
                  @click="handleAlert(alert)"
                >
                  <div class="flex items-start justify-between">
                    <div class="flex-1">
                      <div class="flex items-center gap-2">
                        <span 
                          class="text-xs font-medium px-2 py-0.5 rounded"
                          :class="{
                            'bg-red-100 text-red-600': alert.level === 'critical',
                            'bg-yellow-100 text-yellow-600': alert.level === 'warning',
                            'bg-blue-100 text-blue-600': alert.level === 'info'
                          }"
                          x-text="alert.level === 'critical' ? '紧急' : alert.level === 'warning' ? '警告' : '信息'"
                        ></span>
                        <span class="text-sm font-medium themed-text" x-text="alert.title"></span>
                      </div>
                      <p class="text-sm themed-text-muted mt-1" x-text="alert.message"></p>
                      <div class="text-xs themed-text-muted mt-2" x-text="formatTime(alert.created_at)"></div>
                    </div>
                    <span class="themed-text-muted text-lg">→</span>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
        
        <!-- 快捷操作区域 -->
        <div class="themed-card rounded-xl p-6">
          <h3 class="text-lg font-semibold themed-text mb-4">⚡ 快捷操作</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
            <button 
              @click="quickAction('consumption-review')"
              class="flex flex-col items-center gap-2 p-4 rounded-lg themed-border hover:border-blue-300 hover:bg-blue-50 transition"
            >
              <span class="text-3xl">📋</span>
              <span class="text-sm themed-text">消耗审核</span>
              <span x-show="stats.pending_consumption > 0" class="px-2 py-0.5 bg-red-500 text-white text-xs rounded-full" x-text="stats.pending_consumption">0</span>
            </button>
            
            <button 
              @click="quickAction('customer-service')"
              class="flex flex-col items-center gap-2 p-4 rounded-lg themed-border hover:border-blue-300 hover:bg-blue-50 transition"
            >
              <span class="text-3xl">💬</span>
              <span class="text-sm themed-text">客服会话</span>
              <span x-show="stats.pending_sessions > 0" class="px-2 py-0.5 bg-red-500 text-white text-xs rounded-full" x-text="stats.pending_sessions">0</span>
            </button>
            
            <button 
              @click="quickAction('lottery-alerts')"
              class="flex flex-col items-center gap-2 p-4 rounded-lg themed-border hover:border-blue-300 hover:bg-blue-50 transition"
            >
              <span class="text-3xl">🚨</span>
              <span class="text-sm themed-text">抽奖告警</span>
              <span x-show="stats.lottery_alerts > 0" class="px-2 py-0.5 bg-orange-500 text-white text-xs rounded-full" x-text="stats.lottery_alerts">0</span>
            </button>
            
            <button 
              @click="quickAction('risk-alerts')"
              class="flex flex-col items-center gap-2 p-4 rounded-lg themed-border hover:border-blue-300 hover:bg-blue-50 transition"
            >
              <span class="text-3xl">⚠️</span>
              <span class="text-sm themed-text">风控告警</span>
              <span x-show="stats.risk_alerts > 0" class="px-2 py-0.5 bg-red-500 text-white text-xs rounded-full" x-text="stats.risk_alerts">0</span>
            </button>
            
            <button 
              @click="quickAction('campaign-create')"
              class="flex flex-col items-center gap-2 p-4 rounded-lg themed-border hover:border-blue-300 hover:bg-blue-50 transition"
            >
              <span class="text-3xl">🎯</span>
              <span class="text-sm themed-text">新建活动</span>
            </button>
            
            <button 
              @click="quickAction('statistics')"
              class="flex flex-col items-center gap-2 p-4 rounded-lg themed-border hover:border-blue-300 hover:bg-blue-50 transition"
            >
              <span class="text-3xl">📊</span>
              <span class="text-sm themed-text">数据统计</span>
            </button>
          </div>
        </div>
        
        <!-- 预算状态概览 -->
        <div class="themed-card rounded-xl p-6">
          <h3 class="text-lg font-semibold themed-text mb-4">💰 活动预算状态</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <template x-for="budget in budgetList" :key="budget.lottery_campaign_id">
              <div class="p-4 rounded-lg border" :class="budget.usage >= 90 ? 'border-red-200 bg-red-50' : budget.usage >= 80 ? 'border-yellow-200 bg-yellow-50' : 'themed-border'">
                <div class="flex items-center justify-between mb-2">
                  <span class="font-medium themed-text" x-text="budget.campaign_name"></span>
                  <span 
                    class="text-sm font-medium"
                    :class="budget.usage >= 90 ? 'text-red-600' : budget.usage >= 80 ? 'text-yellow-600' : 'text-green-600'"
                    x-text="budget.usage.toFixed(1) + '%'"
                  ></span>
                </div>
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div 
                    class="h-full transition-all duration-500"
                    :class="budget.usage >= 90 ? 'bg-red-500' : budget.usage >= 80 ? 'bg-yellow-500' : 'bg-green-500'"
                    :style="'width: ' + Math.min(budget.usage, 100) + '%'"
                  ></div>
                </div>
                <div class="flex items-center justify-between mt-2 text-xs themed-text-muted">
                  <span x-text="'已用: ¥' + formatNumber(budget.used)"></span>
                  <span x-text="'预算: ¥' + formatNumber(budget.total)"></span>
                </div>
              </div>
            </template>
            
            <template x-if="budgetList.length === 0">
              <div class="col-span-full text-center py-8 themed-text-muted">
                暂无活动预算数据
              </div>
            </template>
          </div>
        </div>
      </div>
    </template>
    
    <!-- ==================== Tab 2: 抽奖分析 ==================== -->
    <template x-if="activeTab === 'lottery'">
      <div class="space-y-6">
        <!-- 统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="stat-card themed-card rounded-xl p-5">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">🎰</span>
              </div>
              <div>
                <div class="text-2xl font-bold themed-text" x-text="formatNumber(lotteryAnalysis.total_draws)">0</div>
                <div class="text-sm themed-text-muted">总抽奖次数</div>
              </div>
            </div>
          </div>
          
          <div class="stat-card themed-card rounded-xl p-5">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">🎁</span>
              </div>
              <div>
                <div class="text-2xl font-bold themed-text" x-text="formatNumber(lotteryAnalysis.total_wins)">0</div>
                <div class="text-sm themed-text-muted">中奖次数</div>
              </div>
            </div>
          </div>
          
          <div class="stat-card themed-card rounded-xl p-5">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">📊</span>
              </div>
              <div>
                <div class="text-2xl font-bold themed-text" x-text="lotteryAnalysis.win_rate.toFixed(1) + '%'">0%</div>
                <div class="text-sm themed-text-muted">平均中奖率</div>
              </div>
            </div>
          </div>
          
          <div class="stat-card themed-card rounded-xl p-5">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">💰</span>
              </div>
              <div>
                <div class="text-2xl font-bold themed-text" x-text="'¥' + formatNumber(lotteryAnalysis.total_prize_value)">¥0</div>
                <div class="text-sm themed-text-muted">奖品总价值</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 抽奖趋势图 -->
        <div class="themed-card rounded-xl p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold themed-text">📈 抽奖趋势</h3>
            <select x-model="lotteryAnalysis.chart_range" @change="loadLotteryTrend()" class="px-3 py-1 text-sm themed-bg-base themed-border rounded-lg">
              <option value="7d">近7天</option>
              <option value="30d">近30天</option>
            </select>
          </div>
          <div id="lottery-trend-chart" class="chart-container"></div>
        </div>
        
        <!-- 奖品分布和活动排行 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="themed-card rounded-xl p-6">
            <h3 class="text-lg font-semibold themed-text mb-4">🎁 奖品分布</h3>
            <div id="prize-distribution-chart" class="chart-container" style="min-height: 280px;"></div>
          </div>
          
          <div class="themed-card rounded-xl p-6">
            <h3 class="text-lg font-semibold themed-text mb-4">🏆 活动排行</h3>
            <div class="space-y-3 max-h-[300px] overflow-y-auto scrollbar-thin">
              <template x-for="(campaign, index) in lotteryAnalysis.campaign_ranking" :key="campaign.id">
                <div class="flex items-center justify-between p-3 rounded-lg themed-bg-subtle">
                  <div class="flex items-center gap-3">
                    <span class="w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold"
                      :class="index === 0 ? 'bg-yellow-100 text-yellow-600' : index === 1 ? 'bg-gray-200 text-gray-600' : index === 2 ? 'bg-orange-100 text-orange-600' : 'bg-blue-50 text-blue-600'"
                      x-text="index + 1"></span>
                    <span class="font-medium themed-text" x-text="campaign.name"></span>
                  </div>
                  <div class="text-right">
                    <div class="font-bold themed-text" x-text="formatNumber(campaign.draw_count)"></div>
                    <div class="text-xs themed-text-muted" x-text="'中奖率 ' + campaign.win_rate.toFixed(1) + '%'"></div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>
    </template>
    
    <!-- ==================== Tab 3: 用户分析 (P2-7) ==================== -->
    <template x-if="activeTab === 'user'">
      <div class="space-y-6">
        <!-- 用户统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="stat-card themed-card rounded-xl p-5">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">👥</span>
              </div>
              <div>
                <div class="text-2xl font-bold themed-text" x-text="formatNumber(userAnalysis.total_users)">0</div>
                <div class="text-sm themed-text-muted">总用户数</div>
              </div>
            </div>
          </div>
          
          <div class="stat-card themed-card rounded-xl p-5">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">🆕</span>
              </div>
              <div>
                <div class="text-2xl font-bold themed-text" x-text="formatNumber(userAnalysis.new_users_today)">0</div>
                <div class="text-sm themed-text-muted">今日新增</div>
              </div>
            </div>
          </div>
          
          <div class="stat-card themed-card rounded-xl p-5">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">🔥</span>
              </div>
              <div>
                <div class="text-2xl font-bold themed-text" x-text="formatNumber(userAnalysis.active_users)">0</div>
                <div class="text-sm themed-text-muted">活跃用户</div>
              </div>
            </div>
          </div>
          
          <div class="stat-card themed-card rounded-xl p-5">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">👑</span>
              </div>
              <div>
                <div class="text-2xl font-bold themed-text" x-text="formatNumber(userAnalysis.vip_users)">0</div>
                <div class="text-sm themed-text-muted">VIP用户</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 用户增长趋势 -->
        <div class="themed-card rounded-xl p-6">
          <h3 class="text-lg font-semibold themed-text mb-4">📈 用户增长趋势（近7天）</h3>
          <div id="user-growth-chart" class="chart-container"></div>
        </div>
        
        <!-- 用户分层和活跃排行 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="themed-card rounded-xl p-6">
            <h3 class="text-lg font-semibold themed-text mb-4">📊 用户分层分布</h3>
            <div id="user-tier-chart" class="chart-container" style="min-height: 280px;"></div>
          </div>
          
          <div class="themed-card rounded-xl p-6">
            <h3 class="text-lg font-semibold themed-text mb-4">🔥 活跃排行</h3>
            <div class="space-y-3 max-h-[300px] overflow-y-auto scrollbar-thin">
              <template x-for="(user, index) in userAnalysis.active_ranking" :key="user.user_id">
                <div class="flex items-center justify-between p-3 rounded-lg themed-bg-subtle">
                  <div class="flex items-center gap-3">
                    <span class="w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold"
                      :class="index === 0 ? 'bg-yellow-100 text-yellow-600' : index === 1 ? 'bg-gray-200 text-gray-600' : index === 2 ? 'bg-orange-100 text-orange-600' : 'bg-blue-50 text-blue-600'"
                      x-text="index + 1"></span>
                    <div>
                      <span class="font-medium themed-text" x-text="user.nickname"></span>
                      <span class="text-xs themed-text-muted ml-2" x-text="user.phone"></span>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="font-bold themed-text" x-text="user.activity_score + '分'"></div>
                    <div class="text-xs themed-text-muted">活跃度</div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>
    </template>
    
    <!-- ==================== Tab 4: 资产流动 (P2-1 桑基图) ==================== -->
    <template x-if="activeTab === 'asset-flow'">
      <div class="space-y-6">
        <!-- 资产统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="stat-card themed-card rounded-xl p-5">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">💎</span>
              </div>
              <div>
                <div class="text-2xl font-bold themed-text" x-text="formatNumber(assetFlow.system_balance)">0</div>
                <div class="text-sm themed-text-muted">系统余额</div>
              </div>
            </div>
          </div>
          
          <div class="stat-card themed-card rounded-xl p-5">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">👛</span>
              </div>
              <div>
                <div class="text-2xl font-bold themed-text" x-text="formatNumber(assetFlow.user_holding)">0</div>
                <div class="text-sm themed-text-muted">用户持有</div>
              </div>
            </div>
          </div>
          
          <div class="stat-card themed-card rounded-xl p-5">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">🔒</span>
              </div>
              <div>
                <div class="text-2xl font-bold themed-text" x-text="formatNumber(assetFlow.frozen_amount)">0</div>
                <div class="text-sm themed-text-muted">冻结中</div>
              </div>
            </div>
          </div>
          
          <div class="stat-card themed-card rounded-xl p-5">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-lg flex items-center justify-center"
                :class="assetFlow.net_flow >= 0 ? 'bg-green-100' : 'bg-red-100'">
                <span class="text-2xl" x-text="assetFlow.net_flow >= 0 ? '📈' : '📉'"></span>
              </div>
              <div>
                <div class="text-2xl font-bold" 
                  :class="assetFlow.net_flow >= 0 ? 'text-green-600' : 'text-red-600'"
                  x-text="(assetFlow.net_flow >= 0 ? '+' : '') + formatNumber(assetFlow.net_flow)">0</div>
                <div class="text-sm themed-text-muted">今日净流入</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 今日资产流动明细 -->
        <div class="themed-card rounded-xl p-6">
          <h3 class="text-lg font-semibold themed-text mb-4">📊 今日资产流动</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 流入 -->
            <div class="p-4 bg-green-50 rounded-lg border border-green-200">
              <h4 class="font-medium text-green-700 mb-3 flex items-center gap-2">
                <span>📥</span>
                流入（+）
              </h4>
              <div class="space-y-2">
                <template x-for="item in assetFlow.inflows" :key="item.type">
                  <div class="flex justify-between text-sm">
                    <span class="text-green-600" x-text="item.label"></span>
                    <span class="font-medium text-green-700" x-text="'+' + formatNumber(item.amount)"></span>
                  </div>
                </template>
                <div class="pt-2 border-t border-green-200 flex justify-between font-semibold">
                  <span class="text-green-700">总流入</span>
                  <span class="text-green-700" x-text="'+' + formatNumber(assetFlow.total_inflow)"></span>
                </div>
              </div>
            </div>
            
            <!-- 流出 -->
            <div class="p-4 bg-red-50 rounded-lg border border-red-200">
              <h4 class="font-medium text-red-700 mb-3 flex items-center gap-2">
                <span>📤</span>
                流出（-）
              </h4>
              <div class="space-y-2">
                <template x-for="item in assetFlow.outflows" :key="item.type">
                  <div class="flex justify-between text-sm">
                    <span class="text-red-600" x-text="item.label"></span>
                    <span class="font-medium text-red-700" x-text="'-' + formatNumber(item.amount)"></span>
                  </div>
                </template>
                <div class="pt-2 border-t border-red-200 flex justify-between font-semibold">
                  <span class="text-red-700">总流出</span>
                  <span class="text-red-700" x-text="'-' + formatNumber(assetFlow.total_outflow)"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- P2-1: 桑基图 -->
        <div class="themed-card rounded-xl p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold themed-text">🔄 资产流动桑基图</h3>
            <select x-model="assetFlow.chart_range" @change="loadAssetFlowChart()" class="px-3 py-1 text-sm themed-bg-base themed-border rounded-lg">
              <option value="today">今日</option>
              <option value="7d">近7天</option>
              <option value="30d">近30天</option>
            </select>
          </div>
          <div id="asset-sankey-chart" class="sankey-container"></div>
        </div>
        
        <!-- 资产变化趋势 -->
        <div class="themed-card rounded-xl p-6">
          <h3 class="text-lg font-semibold themed-text mb-4">📈 资产变化趋势（7天）</h3>
          <div id="asset-trend-chart" class="chart-container"></div>
        </div>
      </div>
    </template>
    
    <!-- ==================== Tab 5: 转化漏斗 (P3-2) ==================== -->
    <template x-if="activeTab === 'funnel'">
      <div class="space-y-6">
        <!-- 漏斗图 -->
        <div class="themed-card rounded-xl p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold themed-text">📊 用户转化漏斗</h3>
            <select x-model="funnelData.range" @change="loadFunnelData()" class="px-3 py-1 text-sm themed-bg-base themed-border rounded-lg">
              <option value="7d">近7天</option>
              <option value="30d">近30天</option>
              <option value="90d">近90天</option>
            </select>
          </div>
          <div id="conversion-funnel-chart" class="funnel-container"></div>
        </div>
        
        <!-- 关键转化率 -->
        <div class="themed-card rounded-xl p-6">
          <h3 class="text-lg font-semibold themed-text mb-4">📈 关键转化率</h3>
          <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <template x-for="stage in funnelData.stages" :key="stage.name">
              <div class="p-4 themed-bg-subtle rounded-lg text-center">
                <div class="text-3xl font-bold" :class="stage.rate >= 70 ? 'text-green-600' : stage.rate >= 40 ? 'text-yellow-600' : 'text-red-600'" x-text="stage.rate.toFixed(1) + '%'"></div>
                <div class="text-sm themed-text mt-1" x-text="stage.name"></div>
                <div class="text-xs themed-text-muted mt-1" x-text="formatNumber(stage.count) + '人'"></div>
              </div>
            </template>
          </div>
        </div>
        
        <!-- 转化率趋势 -->
        <div class="themed-card rounded-xl p-6">
          <h3 class="text-lg font-semibold themed-text mb-4">📈 转化率趋势</h3>
          <div id="funnel-trend-chart" class="chart-container"></div>
        </div>
      </div>
    </template>
    
    <!-- ==================== Tab 6: 商户贡献度 (P3-3) ==================== -->
    <template x-if="activeTab === 'merchant'">
      <div class="space-y-6">
        <!-- 商户统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="stat-card themed-card rounded-xl p-5">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">🏪</span>
              </div>
              <div>
                <div class="text-2xl font-bold themed-text" x-text="formatNumber(merchantData.total_merchants)">0</div>
                <div class="text-sm themed-text-muted">门店总数</div>
              </div>
            </div>
          </div>
          
          <div class="stat-card themed-card rounded-xl p-5">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">💰</span>
              </div>
              <div>
                <div class="text-2xl font-bold themed-text" x-text="'¥' + formatNumber(merchantData.total_consumption)">¥0</div>
                <div class="text-sm themed-text-muted">总消费金额</div>
              </div>
            </div>
          </div>
          
          <div class="stat-card themed-card rounded-xl p-5">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">📝</span>
              </div>
              <div>
                <div class="text-2xl font-bold themed-text" x-text="formatNumber(merchantData.total_orders)">0</div>
                <div class="text-sm themed-text-muted">总订单数</div>
              </div>
            </div>
          </div>
          
          <div class="stat-card themed-card rounded-xl p-5">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">💵</span>
              </div>
              <div>
                <div class="text-2xl font-bold themed-text" x-text="'¥' + formatNumber(merchantData.avg_order_value)">¥0</div>
                <div class="text-sm themed-text-muted">平均客单价</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 商户贡献度排行 -->
        <div class="themed-card rounded-xl p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold themed-text">🏪 商户贡献度排行</h3>
            <select x-model="merchantData.range" @change="loadMerchantData()" class="px-3 py-1 text-sm themed-bg-base themed-border rounded-lg">
              <option value="7d">近7天</option>
              <option value="30d">近30天</option>
            </select>
          </div>
          
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="themed-bg-subtle">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text">排名</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text">门店名称</th>
                  <th class="px-4 py-3 text-right text-sm font-medium themed-text">消费金额</th>
                  <th class="px-4 py-3 text-right text-sm font-medium themed-text">笔数</th>
                  <th class="px-4 py-3 text-right text-sm font-medium themed-text">客单价</th>
                  <th class="px-4 py-3 text-right text-sm font-medium themed-text">占比</th>
                  <th class="px-4 py-3 text-right text-sm font-medium themed-text">健康度</th>
                </tr>
              </thead>
              <tbody class="divide-y themed-border">
                <template x-for="(merchant, index) in merchantData.ranking" :key="merchant.store_id">
                  <tr class="hover:themed-bg-subtle">
                    <td class="px-4 py-3">
                      <span 
                        class="w-6 h-6 inline-flex items-center justify-center rounded-full text-xs font-bold"
                        :class="index === 0 ? 'bg-yellow-100 text-yellow-600' : index === 1 ? 'bg-gray-200 text-gray-600' : index === 2 ? 'bg-orange-100 text-orange-600' : 'bg-blue-50 text-blue-600'"
                        x-text="index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : index + 1"
                      ></span>
                    </td>
                    <td class="px-4 py-3 font-medium themed-text" x-text="merchant.store_name"></td>
                    <td class="px-4 py-3 text-right themed-text" x-text="'¥' + formatNumber(merchant.consumption_amount)"></td>
                    <td class="px-4 py-3 text-right themed-text" x-text="formatNumber(merchant.order_count)"></td>
                    <td class="px-4 py-3 text-right themed-text" x-text="'¥' + formatNumber(merchant.avg_order_value)"></td>
                    <td class="px-4 py-3 text-right themed-text" x-text="merchant.contribution_rate.toFixed(1) + '%'"></td>
                    <td class="px-4 py-3 text-right">
                      <span 
                        class="px-2 py-1 text-xs font-medium rounded-full"
                        :class="merchant.health_score >= 80 ? 'bg-green-100 text-green-600' : merchant.health_score >= 60 ? 'bg-yellow-100 text-yellow-600' : 'bg-red-100 text-red-600'"
                        x-text="merchant.health_score + '分'"
                      ></span>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- 商户消费趋势和贡献度饼图 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="themed-card rounded-xl p-6">
            <h3 class="text-lg font-semibold themed-text mb-4">📈 商户消费趋势（近7天）</h3>
            <div id="merchant-trend-chart" class="chart-container"></div>
          </div>
          
          <div class="themed-card rounded-xl p-6">
            <h3 class="text-lg font-semibold themed-text mb-4">📊 贡献度分布</h3>
            <div id="merchant-pie-chart" class="chart-container"></div>
          </div>
        </div>
        
        <!-- 环比对比表格 -->
        <div class="themed-card rounded-xl p-6">
          <h3 class="text-lg font-semibold themed-text mb-4">📊 环比对比</h3>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="themed-bg-subtle">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text">门店</th>
                  <th class="px-4 py-3 text-right text-sm font-medium themed-text">本周金额</th>
                  <th class="px-4 py-3 text-right text-sm font-medium themed-text">上周金额</th>
                  <th class="px-4 py-3 text-right text-sm font-medium themed-text">环比变化</th>
                  <th class="px-4 py-3 text-right text-sm font-medium themed-text">健康度</th>
                </tr>
              </thead>
              <tbody class="divide-y themed-border">
                <template x-for="merchant in merchantData.comparison" :key="merchant.store_id">
                  <tr class="hover:themed-bg-subtle">
                    <td class="px-4 py-3 font-medium themed-text" x-text="merchant.store_name"></td>
                    <td class="px-4 py-3 text-right themed-text" x-text="'¥' + formatNumber(merchant.this_week)"></td>
                    <td class="px-4 py-3 text-right themed-text-muted" x-text="'¥' + formatNumber(merchant.last_week)"></td>
                    <td class="px-4 py-3 text-right">
                      <span 
                        :class="merchant.change >= 0 ? 'text-green-600' : 'text-red-600'"
                        x-text="(merchant.change >= 0 ? '+' : '') + merchant.change.toFixed(1) + '%'"
                      ></span>
                      <span x-text="merchant.change >= 0 ? '📈' : '📉'" class="ml-1"></span>
                    </td>
                    <td class="px-4 py-3 text-right">
                      <span 
                        class="px-2 py-1 text-xs font-medium rounded-full"
                        :class="merchant.health_score >= 80 ? 'bg-green-100 text-green-600' : merchant.health_score >= 60 ? 'bg-yellow-100 text-yellow-600' : 'bg-red-100 text-red-600'"
                        x-text="merchant.health_score + '分'"
                      ></span>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </template>
  </div>

  <%- include('partials/footer') %>

  <script type="module" src="./src/modules/analytics/pages/dashboard-panel.js"></script>
</body>
</html>
