<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '字典管理', 
    pageStyle: '[x-cloak] { display: none !important; }' 
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen">
  
  <!-- 页面顶部渐变横幅 -->
  <div class="page-banner" style="background: linear-gradient(135deg, #312e81 0%, #4f46e5 50%, #7c3aed 100%);">
    <div class="container mx-auto px-4 flex justify-between items-center">
      <div>
        <div class="flex items-center gap-3 mb-1">
          <a href="/admin/workspace.html" class="text-indigo-200 hover:text-white text-sm transition">← 返回工作台</a>
        </div>
        <h1>📚 字典管理</h1>
        <p class="text-indigo-100">管理系统基础数据字典，包含类目、稀有度和资产分组等配置</p>
      </div>
      <div class="text-6xl opacity-20">📋</div>
    </div>
  </div>

  <!-- 页面主体 -->
  <div class="container mx-auto px-4 py-6" x-data="dictManagement()" @table-action="handleTableAction($event.detail)">
    
    <!-- 字典类型切换 - 卡片式 Tab -->
    <div class="grid grid-cols-3 gap-4 mb-6">
      <template x-for="(config, key) in dictTypes" :key="key">
        <button 
          @click="switchDictType(key)"
          :class="currentDictType === key 
            ? 'ring-2 ring-indigo-500 border-indigo-200 bg-gradient-to-br from-indigo-50 to-purple-50' 
            : 'border-gray-200 bg-white hover:border-indigo-200 hover:shadow-md'"
          class="themed-card rounded-xl p-4 border transition-all duration-200 text-left group cursor-pointer"
        >
          <div class="flex items-center justify-between mb-2">
            <span class="text-2xl" x-text="key === 'categories' ? '📂' : key === 'rarities' ? '💎' : '📦'"></span>
            <span :class="currentDictType === key ? 'bg-indigo-100 text-indigo-700' : 'bg-gray-100 text-gray-500'"
                  class="text-xs font-medium px-2 py-0.5 rounded-full transition-colors"
                  x-text="key"></span>
          </div>
          <h6 class="font-semibold text-sm" :class="currentDictType === key ? 'text-indigo-900' : 'text-gray-700'" x-text="config.name"></h6>
          <p class="text-xs mt-1" :class="currentDictType === key ? 'text-indigo-500' : 'text-gray-400'"
             x-text="key === 'categories' ? '商品类目分类定义' : key === 'rarities' ? '物品稀有度等级' : '资产分组归类'"></p>
        </button>
      </template>
    </div>

    <!-- 页面标题和新增按钮 -->
    <div class="flex justify-between items-center mb-4">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg flex items-center justify-center font-bold text-lg"
             :class="currentDictType === 'categories' ? 'bg-blue-100 text-blue-600' : currentDictType === 'rarities' ? 'bg-purple-100 text-purple-600' : 'bg-emerald-100 text-emerald-600'">
          <span x-text="currentDictType === 'categories' ? '📂' : currentDictType === 'rarities' ? '💎' : '📦'"></span>
        </div>
        <div>
          <h5 class="font-semibold text-lg" x-text="getCurrentDictConfig().name">字典管理</h5>
          <p class="text-xs themed-text-muted" x-text="'管理' + (getCurrentDictConfig().name || '数据字典') + '配置项'"></p>
        </div>
      </div>
      <button @click="openCreateDictModal()" class="btn-primary px-5 py-2.5 rounded-lg shadow-sm flex items-center gap-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white">
        <span>➕</span> 新增字典
      </button>
    </div>

    <!-- data-table 标准表格组件 -->
    <div x-data="dataTable({
      columns: tableColumns,
      dataSource: fetchTableData,
      primaryKey: '_row_id',
      sortable: true,
      selectable: false,
      exportable: false,
      page_size: 100,
      emptyText: '暂无字典数据'
    })" x-init="init()" @dt-refresh.window="refresh()">
      <%- include('components/data-table') %>
    </div>

    <!-- 字典表单 Modal -->
    <div x-ref="dictModal" 
         x-show="isModalOpen('dictModal')" 
         x-cloak 
         class="fixed inset-0 z-50 flex items-center justify-center">
      <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" @click="hideModal('dictModal')"></div>
      <div class="relative themed-card rounded-xl shadow-2xl w-full max-w-md mx-4 z-10 animate-slide-in-up">
        <div class="p-5 border-b flex justify-between items-center bg-gradient-to-r from-indigo-50 to-white rounded-t-xl">
          <h5 class="font-semibold text-indigo-900 flex items-center gap-2">
            <span class="w-8 h-8 rounded-lg bg-indigo-100 flex items-center justify-center text-sm">📖</span>
            <span x-text="isEditDict ? '编辑字典' : '新增字典'"></span>
          </h5>
          <button @click="hideModal('dictModal')" class="w-8 h-8 rounded-full flex items-center justify-center text-gray-400 hover:bg-gray-100 hover:text-gray-600 transition">✕</button>
        </div>
        <form @submit.prevent="submitDictForm()">
          <div class="p-6 space-y-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">字典代码 <span class="text-red-500">*</span></label>
              <input type="text" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500" 
                     x-model="dictForm[getCurrentDictConfig().codeField]" 
                     :disabled="isEditDict" 
                     required
                     placeholder="如: electronics, food_drink">
              <p class="text-xs themed-text-muted mt-1" x-show="!isEditDict">snake_case格式，创建后不可修改</p>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">显示名称 <span class="text-red-500">*</span></label>
              <input type="text" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500" 
                     x-model="dictForm.display_name" 
                     required
                     placeholder="如: 电子产品、餐饮美食">
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">描述</label>
              <textarea class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500" 
                        x-model="dictForm.description" 
                        rows="3" 
                        placeholder="字典描述..."></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">排序顺序</label>
              <input type="number" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500" 
                     x-model.number="dictForm.sort_order" 
                     min="0"
                     placeholder="数值越小越靠前">
            </div>
            <div class="flex items-center">
              <input type="checkbox" id="dictEnabled" x-model="dictForm.is_enabled" class="mr-2 rounded">
              <label for="dictEnabled" class="text-sm font-medium themed-text-secondary">启用</label>
            </div>
          </div>
          <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-3">
            <button type="button" @click="hideModal('dictModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded-lg hover:bg-gray-300">取消</button>
            <button type="submit" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 disabled:opacity-50" :disabled="saving">
              <span x-show="saving" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>
              <span x-text="isEditDict ? '保存修改' : '创建字典'"></span>
            </button>
          </div>
        </form>
      </div>
    </div>

  </div><!-- 关闭 dictManagement -->

  <%- include('partials/footer') %>
  <script type="module" src="./src/modules/operations/pages/dict-management.js"></script>
</body>
</html>
