<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '门店管理', 
    pageStyle: '[x-cloak] { display: none !important; } .store-card { border: 1px solid #e5e7eb; border-radius: 0.5rem; transition: transform 0.2s, box-shadow 0.2s; } .store-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); } .staff-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }' 
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen">
  
  <!-- 导航栏 -->
  <nav class="bg-gray-700 text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="hover:text-gray-300">← 返回工作台</a>
        <span class="text-lg font-semibold">🏪 管理后台 - 门店管理</span>
      </div>
      <div class="flex items-center space-x-4">
        <span x-data x-text="$store.auth?.user?.nickname ? `欢迎，${$store.auth.user.nickname}` : '欢迎，管理员'">欢迎，管理员</span>
        <button onclick="logout()" class="px-3 py-1 border border-white rounded hover:bg-white hover:themed-text-secondary text-sm">退出登录</button>
      </div>
    </div>
  </nav>

  <!-- 子模块导航 -->
  <div class="themed-bg-base border-b" x-data="storeNavigation()" x-cloak>
    <div class="container mx-auto px-4">
      <div class="flex space-x-1 py-2">
        <template x-for="page in subPages" :key="page.id">
          <button 
            @click="switchPage(page.id)"
            :class="current_page === page.id ? 'themed-bg-primary text-white' : 'themed-text-muted themed-hover-bg'"
            class="px-4 py-2 rounded text-sm font-medium transition-colors"
          >
            <i :class="'bi ' + page.icon" class="mr-1"></i><span x-text="page.title"></span>
          </button>
        </template>
      </div>
    </div>
  </div>

  <!-- 主内容区域 -->
  <div class="container mx-auto px-4 py-6" x-data="storePageContent()" x-cloak>
    
    <!-- ==================== 门店列表 ==================== -->
    <div x-show="current_page === 'stores'" x-cloak>
      <!-- 统计卡片 -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <div class="text-3xl mb-2">🏪</div>
          <div class="themed-text-muted text-sm">总门店数</div>
          <div class="text-2xl font-bold themed-text-primary" x-text="storeStats.total || 0"></div>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <div class="text-3xl mb-2">✅</div>
          <div class="themed-text-muted text-sm">营业中</div>
          <div class="text-2xl font-bold text-green-600" x-text="storeStats.active || 0"></div>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <div class="text-3xl mb-2">👥</div>
          <div class="themed-text-muted text-sm">总员工数</div>
          <div class="text-2xl font-bold text-cyan-600" x-text="storeStats.totalStaff || 0"></div>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <div class="text-3xl mb-2">📈</div>
          <div class="themed-text-muted text-sm">今日营业额</div>
          <div class="text-2xl font-bold text-amber-600" x-text="'¥' + (storeStats.todayRevenue || 0)"></div>
        </div>
      </div>

      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold text-lg">🏪 门店列表</h5>
          <button @click="openCreateStoreModal()" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary text-sm">
            ➕ 添加门店
          </button>
        </div>
        <div class="p-4">
          <!-- 筛选器 -->
          <div class="flex flex-wrap gap-2 mb-4">
            <select class="px-3 py-2 border rounded text-sm" x-model="storeFilters.status" @change="loadStores()">
              <option value="">全部状态</option>
              <option value="active">营业中</option>
              <option value="inactive">休息中</option>
              <option value="closed">已关闭</option>
            </select>
            <input type="text" class="px-3 py-2 border rounded text-sm w-48" placeholder="搜索门店名称..." x-model="storeFilters.keyword">
            <button class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary text-sm" @click="loadStores()">
              🔍 搜索
            </button>
          </div>

          <!-- 门店列表（卡片样式） -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- 空状态提示 -->
            <div x-show="stores.length === 0" class="col-span-3 text-center themed-text-muted py-12">
              暂无门店数据，请点击「添加门店」创建第一个门店
            </div>

            <template x-for="store in stores" :key="store.store_id">
              <div class="store-card p-4 themed-card">
                <div class="flex justify-between items-start mb-3">
                  <h6 class="font-semibold" x-text="store.store_name || store.name || '未命名门店'"></h6>
                  <span 
                    :class="getStoreStatusClass(store.status)" 
                    class="px-2 py-1 text-xs rounded text-white"
                    x-text="store.status_display || store.status"
                  ></span>
                </div>
                <p class="themed-text-muted text-sm mb-2">📍 <span x-text="store.store_address || store.address || '暂无地址'"></span></p>
                <p class="themed-text-muted text-sm mb-2">📞 <span x-text="store.contact_mobile || store.phone || '暂无电话'"></span></p>
                <div class="flex justify-between items-center themed-text-muted text-sm mb-3">
                  <span>👥 <span x-text="store.staff_count || 0"></span> 员工</span>
                  <span>📅 <span x-text="formatDateSafe(store.created_at)"></span></span>
                </div>
                <div class="flex gap-2">
                  <button class="flex-1 px-3 py-1 border themed-border-primary themed-text-primary rounded text-sm hover:bg-blue-50" @click="editStore(store)">
                    ✏️ 编辑
                  </button>
                  <button class="px-3 py-1 border border-cyan-600 text-cyan-600 rounded text-sm hover:bg-cyan-50" @click="viewStoreDetail(store)">
                    👁️ 详情
                  </button>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== 员工管理 ==================== -->
    <div x-show="current_page === 'staff'" x-cloak>
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold text-lg">👥 员工管理</h5>
          <button @click="openCreateStaffModal()" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary text-sm">
            ➕ 添加员工
          </button>
        </div>
        <div class="p-4">
          <!-- 筛选器 -->
          <div class="flex flex-wrap gap-2 mb-4">
            <select class="px-3 py-2 border rounded text-sm" x-model="staffFilters.store_id" @change="loadStaff()">
              <option value="">全部门店</option>
              <template x-for="store in stores" :key="store.store_id">
                <option :value="store.store_id" x-text="store.store_name"></option>
              </template>
            </select>
            <select class="px-3 py-2 border rounded text-sm" x-model="staffFilters.status" @change="loadStaff()">
              <option value="">全部状态（排除已删除）</option>
              <option value="active">在职</option>
              <option value="inactive">离职</option>
              <option value="pending">待审核</option>
              <option value="deleted">已删除</option>
            </select>
            <select class="px-3 py-2 border rounded text-sm" x-model="staffFilters.role" @change="loadStaff()">
              <option value="">全部角色</option>
              <option value="manager">店长</option>
              <option value="staff">员工</option>
            </select>
            <input type="text" class="px-3 py-2 border rounded text-sm w-48" placeholder="搜索员工姓名..." x-model="staffFilters.keyword">
            <button class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary text-sm" @click="loadStaff()">
              🔍 搜索
            </button>
          </div>

          <!-- 员工表格（data-table） -->
          <div @table-action="handleStaffTableAction($event.detail)"
               x-data="dataTable({
                 columns: staffTableColumns,
                 dataSource: fetchStaffTableData,
                 primaryKey: 'store_staff_id',
                 sortable: true,
                 selectable: false,
                 exportable: false,
                 page_size: 20,
                 emptyText: '暂无员工数据'
               })" x-init="init()" @dt-staff-refresh.window="refresh()">
            <%- include('components/data-table') %>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== 门店统计 ==================== -->
    <div x-show="current_page === 'store-stats'" x-cloak>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div class="themed-card rounded-lg shadow">
          <div class="p-4 border-b">
            <h6 class="font-semibold">📊 门店营业额排行</h6>
          </div>
          <div class="p-4">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="themed-bg-base">
                  <tr>
                    <th class="px-3 py-2 text-left">排名</th>
                    <th class="px-3 py-2 text-left">门店名称</th>
                    <th class="px-3 py-2 text-left">营业额</th>
                  </tr>
                </thead>
                <tbody class="divide-y">
                  <template x-for="(store, index) in storeRanking" :key="store.store_id">
                    <tr>
                      <td class="px-3 py-2">
                        <span 
                          :class="index < 3 ? 'bg-amber-400 text-white' : 'themed-bg-muted themed-text-secondary'"
                          class="px-2 py-1 text-xs rounded"
                          x-text="index + 1"
                        ></span>
                      </td>
                      <td class="px-3 py-2" x-text="store.store_name"></td>
                      <td class="px-3 py-2 text-green-600" x-text="'¥' + (store.revenue || 0).toLocaleString()"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="themed-card rounded-lg shadow">
          <div class="p-4 border-b">
            <h6 class="font-semibold">📈 门店状态分布</h6>
          </div>
          <div class="p-4 space-y-3">
            <div class="flex justify-between items-center">
              <span>🟢 营业中</span>
              <span class="px-2 py-1 bg-green-100 themed-text-success text-sm rounded" x-text="storeStats.active || 0"></span>
            </div>
            <div class="flex justify-between items-center">
              <span>🟡 休息中</span>
              <span class="px-2 py-1 bg-amber-100 text-amber-700 text-sm rounded" x-text="storeStats.inactive || 0"></span>
            </div>
            <div class="flex justify-between items-center">
              <span>⚫ 已关闭</span>
              <span class="px-2 py-1 themed-bg-subtle themed-text-secondary text-sm rounded" x-text="storeStats.closed || 0"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== Modal 组件 ==================== -->
    
    <!-- 门店表单 Modal -->
    <div 
      x-show="isModalOpen('storeModal')" 
    x-ref="storeModal"
    class="fixed inset-0 z-50 flex items-center justify-center"
    x-cloak
  >
    <div class="absolute inset-0 bg-black bg-opacity-50" @click="hideModal('storeModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">🏪 <span x-text="isEditMode ? '编辑门店' : '添加门店'"></span></h5>
        <button @click="hideModal('storeModal')" class="text-gray-400 hover:themed-text-muted text-xl">&times;</button>
      </div>
      <form @submit.prevent="saveStore">
        <div class="p-4 space-y-4">
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">门店名称 <span class="text-red-500">*</span></label>
            <input type="text" class="w-full px-3 py-2 border rounded" x-model="storeForm.store_name" required>
          </div>

          <!-- 省市区街道联动选择 -->
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">省份</label>
              <select class="w-full px-3 py-2 border rounded" x-model="storeForm.province_code" @change="isEditMode ? loadCitiesForEdit() : loadCities()">
                <option value="">请选择省份</option>
                <template x-for="p in provinces" :key="p.region_code">
                  <option :value="p.region_code" x-text="p.region_name"></option>
                </template>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">城市</label>
              <select class="w-full px-3 py-2 border rounded" x-model="storeForm.city_code" @change="isEditMode ? loadDistrictsForEdit() : loadDistricts()" :disabled="!storeForm.province_code">
                <option value="">请选择城市</option>
                <template x-for="c in cities" :key="c.region_code">
                  <option :value="c.region_code" x-text="c.region_name"></option>
                </template>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">区县</label>
              <select class="w-full px-3 py-2 border rounded" x-model="storeForm.district_code" @change="isEditMode ? loadStreetsForEdit() : loadStreets()" :disabled="!storeForm.city_code">
                <option value="">请选择区县</option>
                <template x-for="d in districts" :key="d.region_code">
                  <option :value="d.region_code" x-text="d.region_name"></option>
                </template>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">街道</label>
              <select class="w-full px-3 py-2 border rounded" x-model="storeForm.street_code" :disabled="!storeForm.district_code">
                <option value="">请选择街道</option>
                <template x-for="s in streets" :key="s.region_code">
                  <option :value="s.region_code" x-text="s.region_name"></option>
                </template>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">详细地址</label>
            <input type="text" class="w-full px-3 py-2 border rounded" x-model="storeForm.store_address" placeholder="请输入详细地址">
            <small class="themed-text-muted">完整地址：<span x-text="getFormFullAddress()"></span></small>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">联系人</label>
              <input type="text" class="w-full px-3 py-2 border rounded" x-model="storeForm.contact_name" placeholder="请输入联系人姓名">
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">联系电话</label>
              <input type="text" class="w-full px-3 py-2 border rounded" x-model="storeForm.contact_mobile" placeholder="请输入联系电话">
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">门店电话</label>
            <input type="text" class="w-full px-3 py-2 border rounded" x-model="storeForm.phone">
          </div>

          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">门店状态</label>
            <select class="w-full px-3 py-2 border rounded" x-model="storeForm.status">
              <option value="active">营业中</option>
              <option value="inactive">休息中</option>
              <option value="closed">已关闭</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">门店描述</label>
            <textarea class="w-full px-3 py-2 border rounded" x-model="storeForm.notes" rows="3"></textarea>
          </div>
        </div>
        <div class="p-4 border-t flex justify-end space-x-3">
          <button type="button" @click="hideModal('storeModal')" class="px-4 py-2 border rounded themed-text-secondary themed-hover-bg">取消</button>
          <button type="submit" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" :disabled="saving">
            <span x-show="saving" class="inline-block animate-spin mr-1">⏳</span>
            <span x-text="isEditMode ? '保存修改' : '添加门店'"></span>
          </button>
        </div>
      </form>
    </div>
    </div>

    <!-- 门店详情 Modal -->
    <div 
      x-show="isModalOpen('storeDetailModal')" 
    x-ref="storeDetailModal"
    class="fixed inset-0 z-50 flex items-center justify-center"
    x-cloak
  >
    <div class="absolute inset-0 bg-black bg-opacity-50" @click="hideModal('storeDetailModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-2xl mx-4">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">🏪 门店详情</h5>
        <button @click="hideModal('storeDetailModal')" class="text-gray-400 hover:themed-text-muted text-xl">&times;</button>
      </div>
      <div class="p-4">
        <template x-if="selectedStore">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="col-span-2">
              <h4 class="text-xl font-bold" x-text="selectedStore.store_name || selectedStore.name || '未命名门店'"></h4>
              <span 
                :class="getStoreStatusClass(selectedStore.status)"
                class="px-2 py-1 text-xs rounded text-white"
                x-text="selectedStore.status_display || selectedStore.status"
              ></span>
            </div>
            <div>
              <strong class="themed-text-muted">门店ID：</strong>
              <code class="themed-bg-subtle px-2 py-1 rounded text-sm" x-text="selectedStore.store_id"></code>
            </div>
            <div>
              <strong class="themed-text-muted">联系电话：</strong>
              <span x-text="selectedStore.contact_mobile || '暂无'"></span>
            </div>
            <div class="col-span-2">
              <strong class="themed-text-muted">门店地址：</strong>
              <span x-text="getFullAddress(selectedStore)"></span>
            </div>
            <div>
              <strong class="themed-text-muted">员工数量：</strong>
              <span x-text="(selectedStore.staff_count || 0) + ' 人'"></span>
            </div>
            <div>
              <strong class="themed-text-muted">创建时间：</strong>
              <span x-text="formatDateSafe(selectedStore.created_at)"></span>
            </div>
            <div class="col-span-2" x-show="selectedStore.notes">
              <strong class="themed-text-muted">门店描述：</strong>
              <p class="themed-text-muted mt-1" x-text="selectedStore.notes"></p>
            </div>
          </div>
        </template>
      </div>
      <div class="p-4 border-t flex justify-end space-x-3">
        <button type="button" @click="hideModal('storeDetailModal')" class="px-4 py-2 border rounded themed-text-secondary themed-hover-bg">关闭</button>
        <button type="button" @click="editStore(selectedStore); hideModal('storeDetailModal')" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary">
          ✏️ 编辑
        </button>
      </div>
    </div>
    </div>

    <!-- 员工表单 Modal -->
    <div 
      x-show="isModalOpen('staffModal')" 
    x-ref="staffModal"
    class="fixed inset-0 z-50 flex items-center justify-center"
    x-cloak
  >
    <div class="absolute inset-0 bg-black bg-opacity-50" @click="hideModal('staffModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-lg mx-4">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">👤 <span x-text="isEditMode ? '编辑员工' : '添加员工'"></span></h5>
        <button @click="hideModal('staffModal')" class="text-gray-400 hover:themed-text-muted text-xl">&times;</button>
      </div>
      <form @submit.prevent="saveStaff">
        <div class="p-4 space-y-4">
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">员工姓名 <span class="text-red-500">*</span></label>
            <input type="text" class="w-full px-3 py-2 border rounded" x-model="staffForm.name" required>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">手机号码</label>
            <input type="text" class="w-full px-3 py-2 border rounded" x-model="staffForm.phone">
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">所属门店</label>
            <select class="w-full px-3 py-2 border rounded" x-model="staffForm.store_id">
              <option value="">请选择门店</option>
              <template x-for="store in stores" :key="store.store_id">
                <option :value="store.store_id" x-text="store.store_name"></option>
              </template>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">员工角色</label>
            <select class="w-full px-3 py-2 border rounded" x-model="staffForm.role">
              <option value="manager">店长</option>
              <option value="cashier">收银员</option>
              <option value="waiter">服务员</option>
              <option value="chef">厨师</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">入职日期</label>
            <input type="date" class="w-full px-3 py-2 border rounded" x-model="staffForm.hire_date">
          </div>
        </div>
        <div class="p-4 border-t flex justify-end space-x-3">
          <button type="button" @click="hideModal('staffModal')" class="px-4 py-2 border rounded themed-text-secondary themed-hover-bg">取消</button>
          <button type="submit" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" :disabled="saving">
            <span x-show="saving" class="inline-block animate-spin mr-1">⏳</span>
            <span x-text="isEditMode ? '保存修改' : '添加员工'"></span>
          </button>
        </div>
      </form>
    </div>
    </div>

  </div>

  <!-- 页面专属逻辑 -->
  <%- include('partials/footer') %>

  <script type="module" src="./src/modules/store/pages/store-management.js"></script>
</body>
</html>
