<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '广告系统管理', 
    pageStyle: '[x-cloak] { display: none !important; }' 
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen">
  
  <!-- 导航栏 -->
  <nav class="themed-bg-primary text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="hover:text-blue-200 transition-colors">← 返回工作台</a>
        <span class="text-lg font-semibold">📣 广告系统管理</span>
      </div>
    </div>
  </nav>

  <!-- 页面主体 -->
  <div class="container mx-auto px-4 py-6" x-data="adManagement()" x-init="init()">
    
    <!-- 子页面导航 -->
    <div class="themed-card rounded-xl shadow-sm mb-6 overflow-hidden">
      <div class="flex border-b overflow-x-auto bg-gradient-to-r from-gray-50/50 to-transparent">
        <template x-for="page in subPages" :key="page.id">
          <button 
            @click="switchPage(page.id)"
            :class="current_page === page.id ? 'border-b-2 border-blue-500 text-blue-600 bg-blue-50/50 font-semibold' : 'themed-text-muted hover:text-gray-700 hover:bg-gray-50'"
            class="px-5 py-3.5 text-sm whitespace-nowrap transition-all duration-200"
            x-text="page.icon + ' ' + page.name"
          ></button>
        </template>
      </div>
    </div>

    <!-- ===== 广告概览仪表板 ===== -->
    <div x-show="current_page === 'dashboard'" x-cloak>
      <!-- 统计卡片 -->
      <div class="stats-grid stats-grid-4 mb-6">
        <div class="stats-card stats-primary stats-card-animate" x-show="!dashboardLoading">
          <div class="stats-card-icon stats-card-icon-sm">📊</div>
          <div class="stats-card-value" x-text="dashboard.campaign_stats?.total || 0"></div>
          <div class="stats-card-label">总广告计划</div>
        </div>
        <div class="stats-card stats-success stats-card-animate" x-show="!dashboardLoading">
          <div class="stats-card-icon stats-card-icon-sm">🟢</div>
          <div class="stats-card-value" x-text="dashboard.campaign_stats?.by_status?.active || 0"></div>
          <div class="stats-card-label">投放中</div>
        </div>
        <div class="stats-card stats-warning stats-card-animate" x-show="!dashboardLoading">
          <div class="stats-card-icon stats-card-icon-sm">⏳</div>
          <div class="stats-card-value" x-text="dashboard.campaign_stats?.by_status?.pending_review || 0"></div>
          <div class="stats-card-label">待审核</div>
        </div>
        <div class="stats-card stats-info stats-card-animate" x-show="!dashboardLoading">
          <div class="stats-card-icon stats-card-icon-sm">💎</div>
          <div class="stats-card-value stats-card-value-sm" x-text="(dashboard.campaign_stats?.total_spend || 0).toLocaleString()"></div>
          <div class="stats-card-label">总消耗钻石</div>
        </div>
      </div>

      <div x-show="dashboardLoading" class="themed-card rounded-xl shadow-sm p-12 text-center">
        <div class="inline-block w-8 h-8 border-3 border-blue-200 border-t-blue-500 rounded-full animate-spin"></div>
        <p class="mt-3 text-sm themed-text-muted">加载广告概览数据...</p>
      </div>

      <div x-show="!dashboardLoading">
        <!-- 弹窗队列配置 -->
        <div class="themed-card rounded-xl shadow-sm mb-6 overflow-hidden">
          <div class="px-5 py-3 bg-gradient-to-r from-indigo-500 to-blue-500 text-white">
            <h6 class="font-medium text-sm flex items-center gap-2">⚙️ 弹窗队列配置</h6>
          </div>
          <div class="p-5 flex items-center justify-between">
            <div>
              <p class="text-sm font-medium">每次最多弹窗数量</p>
              <p class="text-xs themed-text-muted mt-0.5">控制用户打开页面时的广告弹窗频率，建议3~5个</p>
            </div>
            <div class="flex items-center gap-3">
              <input type="number" x-model.number="popupQueueMaxCount" min="1" max="20"
                     class="w-20 px-3 py-2 text-center text-lg font-bold border-2 border-indigo-200 rounded-lg themed-bg-base focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
              <button @click="savePopupQueueConfig()" class="px-5 py-2 text-sm bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition font-medium shadow-sm" :disabled="saving">保存</button>
            </div>
          </div>
        </div>

        <!-- 数据分布 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="themed-card rounded-xl shadow-sm overflow-hidden">
            <div class="px-5 py-3 bg-gradient-to-r from-blue-500 to-cyan-500 text-white">
              <h6 class="font-medium text-sm">📊 按状态分布</h6>
            </div>
            <div class="p-5 space-y-3">
              <template x-for="(count, status) in (dashboard.campaign_stats?.by_status || {})" :key="status">
                <div class="flex items-center gap-3">
                  <span class="text-xs px-2.5 py-1 rounded-full font-medium text-white min-w-[4rem] text-center" :class="statusColor(status)" x-text="statusText(status)"></span>
                  <div class="flex-1 h-2.5 rounded-full bg-gray-100 overflow-hidden">
                    <div class="h-full rounded-full transition-all duration-500" :class="statusColor(status)"
                         :style="'width: ' + (dashboard.campaign_stats?.total > 0 ? Math.max(count / dashboard.campaign_stats.total * 100, 4) : 0) + '%'"></div>
                  </div>
                  <span class="font-bold text-sm tabular-nums min-w-[2rem] text-right" x-text="count"></span>
                </div>
              </template>
              <div x-show="Object.keys(dashboard.campaign_stats?.by_status || {}).length === 0" class="text-center py-4 themed-text-muted text-sm">
                暂无广告活动数据
              </div>
            </div>
          </div>

          <div class="themed-card rounded-xl shadow-sm overflow-hidden">
            <div class="px-5 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white">
              <h6 class="font-medium text-sm">💰 按计费模式分布</h6>
            </div>
            <div class="p-5 space-y-3">
              <template x-for="(count, mode) in (dashboard.campaign_stats?.by_billing_mode || {})" :key="mode">
                <div class="flex items-center gap-3">
                  <span class="text-xs px-2.5 py-1 rounded-full font-medium text-white min-w-[4rem] text-center" :class="mode === 'fixed_daily' ? 'bg-blue-500' : 'bg-purple-500'" x-text="billingText(mode)"></span>
                  <div class="flex-1 h-2.5 rounded-full bg-gray-100 overflow-hidden">
                    <div class="h-full rounded-full transition-all duration-500" :class="mode === 'fixed_daily' ? 'bg-blue-500' : 'bg-purple-500'"
                         :style="'width: ' + (dashboard.campaign_stats?.total > 0 ? Math.max(count / dashboard.campaign_stats.total * 100, 4) : 0) + '%'"></div>
                  </div>
                  <span class="font-bold text-sm tabular-nums min-w-[2rem] text-right" x-text="count"></span>
                </div>
              </template>
              <div x-show="Object.keys(dashboard.campaign_stats?.by_billing_mode || {}).length === 0" class="text-center py-4 themed-text-muted text-sm">
                暂无计费模式数据
              </div>
            </div>
          </div>
        </div>

        <!-- 运营提示 -->
        <div class="mt-6 themed-card rounded-xl shadow-sm p-5 border-l-4 border-blue-500">
          <h6 class="font-medium text-sm mb-2 flex items-center gap-2">💡 运营指南</h6>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs themed-text-muted">
            <div class="flex items-start gap-2">
              <span class="text-blue-500 mt-0.5">①</span>
              <span><strong class="themed-text-primary">创建广告位</strong> → 在「广告位」页签定义弹窗/轮播位置和定价</span>
            </div>
            <div class="flex items-start gap-2">
              <span class="text-blue-500 mt-0.5">②</span>
              <span><strong class="themed-text-primary">创建广告活动</strong> → 在「广告活动」页签选择广告位、计费模式和预算</span>
            </div>
            <div class="flex items-start gap-2">
              <span class="text-blue-500 mt-0.5">③</span>
              <span><strong class="themed-text-primary">审核上线</strong> → 审核通过后活动自动投放，数据可在「数据报表」查看</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== 广告活动管理 ===== -->
    <div x-show="current_page === 'campaigns'" x-cloak>
      <div class="themed-card rounded-xl shadow-sm overflow-hidden">
        <div class="px-5 py-4 bg-gradient-to-r from-blue-500 to-indigo-500 text-white flex justify-between items-center flex-wrap gap-2">
          <div>
            <h5 class="font-semibold text-lg">📋 广告活动列表</h5>
            <p class="text-blue-100 text-xs mt-0.5">管理所有广告投放计划</p>
          </div>
        </div>
        <div class="px-5 py-3 themed-bg-base border-b flex items-center gap-2 flex-wrap">
          <select x-model="campaignFilters.status" @change="loadCampaigns()" class="px-3 py-1.5 text-sm border rounded-lg themed-bg-base focus:ring-2 focus:ring-blue-500">
            <option value="">全部状态</option>
            <option value="draft">草稿</option>
            <option value="pending_review">待审核</option>
            <option value="approved">已批准</option>
            <option value="active">投放中</option>
            <option value="paused">已暂停</option>
            <option value="completed">已完成</option>
            <option value="rejected">已拒绝</option>
            <option value="cancelled">已取消</option>
          </select>
          <select x-model="campaignFilters.billing_mode" @change="loadCampaigns()" class="px-3 py-1.5 text-sm border rounded-lg themed-bg-base focus:ring-2 focus:ring-blue-500">
            <option value="">全部计费</option>
            <option value="fixed_daily">固定包天</option>
            <option value="bidding">竞价排名</option>
          </select>
          <select x-model="campaignFilters.ad_slot_id" @change="loadCampaigns()" class="px-3 py-1.5 text-sm border rounded-lg themed-bg-base focus:ring-2 focus:ring-blue-500">
            <option value="">全部广告位</option>
            <template x-for="slot in allSlotsList" :key="slot.ad_slot_id">
              <option :value="slot.ad_slot_id" x-text="slot.slot_name"></option>
            </template>
          </select>
          <div class="ml-auto">
            <button @click="openCreateCampaignModal()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm font-medium shadow-sm">➕ 创建广告活动</button>
          </div>
        </div>

        <div x-show="campaignsLoading" class="p-8 text-center themed-text-muted">加载中...</div>
        <div x-show="campaigns.length === 0 && !campaignsLoading" class="empty-state empty-state-compact">
          <div class="empty-state-icon-circle">
            <span class="empty-state-icon">📋</span>
          </div>
          <h6 class="empty-state-title">暂无广告活动</h6>
          <p class="empty-state-description">创建广告活动，选择广告位和计费模式后提交审核即可投放</p>
          <button @click="openCreateCampaignModal()" class="empty-state-action">➕ 创建第一个广告活动</button>
        </div>

        <div x-show="campaigns.length > 0" class="overflow-x-auto">
          <table class="w-full">
            <thead class="themed-bg-base">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">ID</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">计划名称</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">广告主</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">计费模式</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">状态</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">消耗/预算</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">投放日期</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <template x-for="c in campaigns" :key="c.ad_campaign_id">
                <tr class="themed-hover-bg">
                  <td class="px-4 py-3 text-sm" x-text="c.ad_campaign_id"></td>
                  <td class="px-4 py-3 text-sm font-medium" x-text="c.campaign_name"></td>
                  <td class="px-4 py-3 text-sm">
                    <span x-text="c.advertiser?.nickname || ('用户#' + c.advertiser_user_id)"></span>
                  </td>
                  <td class="px-4 py-3 text-sm">
                    <span class="text-xs px-2.5 py-1 rounded-full font-medium text-white"
                          :class="c.billing_mode === 'fixed_daily' ? 'bg-blue-500' : 'bg-purple-500'"
                          x-text="billingText(c.billing_mode)"></span>
                  </td>
                  <td class="px-4 py-3 text-sm">
                    <span class="text-xs px-2.5 py-1 rounded-full font-medium text-white"
                          :class="statusColor(c.status)"
                          x-text="statusText(c.status)"></span>
                  </td>
                  <td class="px-4 py-3 text-sm">
                    <span x-text="(c.budget_spent_diamond || 0) + ' / ' + (c.budget_total_diamond || c.fixed_total_diamond || '-') + ' 💎'"></span>
                  </td>
                  <td class="px-4 py-3 text-sm themed-text-muted" x-text="(c.start_date || '-') + ' ~ ' + (c.end_date || '-')"></td>
                  <td class="px-4 py-3">
                    <div class="flex flex-wrap gap-1.5">
                      <button @click="viewCampaign(c)" class="text-xs px-2.5 py-1 rounded-md bg-blue-50 text-blue-600 hover:bg-blue-100 font-medium transition">详情</button>
                      <button @click="viewCampaignReport(c.ad_campaign_id)" class="text-xs px-2.5 py-1 rounded-md bg-indigo-50 text-indigo-600 hover:bg-indigo-100 font-medium transition">报表</button>
                      <button x-show="c.status === 'pending_review'" @click="reviewCampaign(c, 'approve')" class="text-xs px-2.5 py-1 rounded-md bg-green-50 text-green-600 hover:bg-green-100 font-medium transition">✓ 通过</button>
                      <button x-show="c.status === 'pending_review'" @click="reviewCampaign(c, 'reject')" class="text-xs px-2.5 py-1 rounded-md bg-red-50 text-red-600 hover:bg-red-100 font-medium transition">✕ 拒绝</button>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>

        <!-- 分页 -->
        <template x-if="campaignPagination.total_pages > 1">
          <div class="p-4 border-t flex justify-between items-center">
            <span class="text-sm themed-text-muted" x-text="'共 ' + campaignPagination.total + ' 条'"></span>
            <div class="flex space-x-1">
              <button @click="campaignPage > 1 && (campaignPage--, loadCampaigns())" :disabled="campaignPage <= 1" class="px-3 py-1 text-sm border rounded disabled:opacity-50 themed-hover-bg">‹</button>
              <span class="px-3 py-1 text-sm" x-text="campaignPage + ' / ' + campaignPagination.total_pages"></span>
              <button @click="campaignPage < campaignPagination.total_pages && (campaignPage++, loadCampaigns())" :disabled="campaignPage >= campaignPagination.total_pages" class="px-3 py-1 text-sm border rounded disabled:opacity-50 themed-hover-bg">›</button>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- ===== 广告位管理 ===== -->
    <div x-show="current_page === 'slots'" x-cloak>
      <div class="themed-card rounded-xl shadow-sm overflow-hidden">
        <div class="px-5 py-4 bg-gradient-to-r from-emerald-500 to-teal-500 text-white flex justify-between items-center">
          <div>
            <h5 class="font-semibold text-lg">📍 广告位管理</h5>
            <p class="text-emerald-100 text-xs mt-0.5">管理弹窗和轮播图广告展示位置</p>
          </div>
          <button @click="openCreateSlotModal()" class="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg transition text-sm font-medium backdrop-blur-sm">➕ 新增广告位</button>
        </div>

        <div x-show="slotsLoading" class="p-12 text-center">
          <div class="inline-block w-8 h-8 border-3 border-emerald-200 border-t-emerald-500 rounded-full animate-spin"></div>
          <p class="mt-3 text-sm themed-text-muted">加载广告位中...</p>
        </div>

        <div x-show="adSlots.length === 0 && !slotsLoading" class="empty-state empty-state-compact">
          <div class="empty-state-icon-circle">
            <span class="empty-state-icon">📍</span>
          </div>
          <h6 class="empty-state-title">暂无广告位</h6>
          <p class="empty-state-description">广告位是广告展示的位置，点击「新增广告位」添加弹窗位或轮播位</p>
          <button @click="openCreateSlotModal()" class="empty-state-action">➕ 创建第一个广告位</button>
        </div>

        <div x-show="adSlots.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-5">
          <template x-for="slot in adSlots" :key="slot.ad_slot_id">
            <div class="themed-card rounded-xl overflow-hidden transition-all duration-300 hover:shadow-lg hover:-translate-y-0.5"
                 :class="slot.is_active ? 'border border-green-200' : 'border border-gray-200 opacity-70'">
              <!-- 卡片顶部色条 -->
              <div class="h-1.5" :class="slot.slot_type === 'popup' ? 'bg-gradient-to-r from-orange-400 to-amber-500' : 'bg-gradient-to-r from-blue-400 to-cyan-500'"></div>
              <div class="p-4">
                <div class="flex justify-between items-start mb-3">
                  <div>
                    <h6 class="font-semibold text-base flex items-center gap-1.5">
                      <span x-text="slot.slot_type === 'popup' ? '🪟' : '🎠'"></span>
                      <span x-text="slot.slot_name"></span>
                    </h6>
                    <code class="text-xs themed-text-muted bg-gray-100 px-1.5 py-0.5 rounded font-mono mt-1 inline-block" x-text="slot.slot_key"></code>
                  </div>
                  <span class="text-xs px-2.5 py-1 rounded-full font-medium flex items-center gap-1"
                        :class="slot.is_active ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-500'">
                    <span class="w-1.5 h-1.5 rounded-full" :class="slot.is_active ? 'bg-green-500' : 'bg-gray-400'"></span>
                    <span x-text="slot.is_active ? '已启用' : '已禁用'"></span>
                  </span>
                </div>
                <div class="grid grid-cols-2 gap-x-4 gap-y-2.5 text-sm mb-4">
                  <div>
                    <span class="text-xs themed-text-muted block">类型</span>
                    <span class="font-medium text-sm" :class="slot.slot_type === 'popup' ? 'text-orange-600' : 'text-blue-600'"
                          x-text="slotTypeText(slot.slot_type)"></span>
                  </div>
                  <div>
                    <span class="text-xs themed-text-muted block">位置</span>
                    <span class="font-medium text-sm" x-text="positionText(slot.position)"></span>
                  </div>
                  <div>
                    <span class="text-xs themed-text-muted block">日价</span>
                    <span class="font-bold text-amber-600" x-text="slot.daily_price_diamond + ' 💎'"></span>
                  </div>
                  <div>
                    <span class="text-xs themed-text-muted block">最低出价</span>
                    <span class="font-medium" x-text="slot.min_bid_diamond + ' 💎'"></span>
                  </div>
                  <div>
                    <span class="text-xs themed-text-muted block">最低预算</span>
                    <span class="font-medium" x-text="(slot.min_budget_diamond || 500) + ' 💎'"></span>
                  </div>
                  <div>
                    <span class="text-xs themed-text-muted block">最大展示</span>
                    <span class="font-medium" x-text="slot.max_display_count + ' 条'"></span>
                  </div>
                </div>
                <div class="pt-3 border-t flex flex-wrap gap-2">
                  <button @click="editSlot(slot)" class="text-xs px-3 py-1.5 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 font-medium transition">✏️ 编辑</button>
                  <button @click="viewSlotReport(slot.ad_slot_id)" class="text-xs px-3 py-1.5 rounded-lg bg-indigo-50 text-indigo-600 hover:bg-indigo-100 font-medium transition">📈 报表</button>
                  <button @click="toggleSlotStatus(slot)" class="text-xs px-3 py-1.5 rounded-lg font-medium transition ml-auto"
                          :class="slot.is_active ? 'bg-red-50 text-red-600 hover:bg-red-100' : 'bg-green-50 text-green-600 hover:bg-green-100'"
                          x-text="slot.is_active ? '⏸️ 禁用' : '▶️ 启用'"></button>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>

    <!-- ===== 广告报表 ===== -->
    <div x-show="current_page === 'reports'" x-cloak>
      <div class="themed-card rounded-xl shadow-sm overflow-hidden">
        <div class="px-5 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
          <div class="flex justify-between items-center flex-wrap gap-3">
            <div>
              <h5 class="font-semibold text-lg">📈 广告数据报表</h5>
              <p class="text-blue-100 text-xs mt-0.5">查看广告投放效果，分析曝光、点击和转化数据</p>
            </div>
            <div class="flex items-center gap-2 flex-wrap">
              <div class="flex gap-1 bg-white/10 rounded-lg p-0.5">
                <button @click="setReportRange(1)" class="px-3 py-1 text-xs rounded-md transition font-medium" :class="reportRangeLabel === '今天' ? 'bg-white text-blue-600' : 'text-white/80 hover:bg-white/10'">今天</button>
                <button @click="setReportRange(7)" class="px-3 py-1 text-xs rounded-md transition font-medium" :class="reportRangeLabel === '7天' ? 'bg-white text-blue-600' : 'text-white/80 hover:bg-white/10'">7天</button>
                <button @click="setReportRange(30)" class="px-3 py-1 text-xs rounded-md transition font-medium" :class="reportRangeLabel === '30天' ? 'bg-white text-blue-600' : 'text-white/80 hover:bg-white/10'">30天</button>
              </div>
              <input type="date" x-model="reportFilters.start_date" class="px-2 py-1 text-xs rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/50 focus:ring-2 focus:ring-white/30">
              <span class="text-white/60 text-xs">至</span>
              <input type="date" x-model="reportFilters.end_date" class="px-2 py-1 text-xs rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/50 focus:ring-2 focus:ring-white/30">
              <button @click="loadReportOverview()" class="px-4 py-1.5 text-xs bg-white text-blue-600 rounded-lg hover:bg-blue-50 transition font-semibold">查询</button>
            </div>
          </div>
        </div>

        <div x-show="reportLoading" class="p-12 text-center">
          <div class="inline-block w-8 h-8 border-3 border-blue-200 border-t-blue-500 rounded-full animate-spin"></div>
          <p class="mt-3 text-sm themed-text-muted">加载报表数据...</p>
        </div>

        <div x-show="!reportLoading" class="p-5">
          <div class="stats-grid stats-grid-5 mb-6">
            <div class="stats-card stats-primary stats-card-compact stats-card-animate">
              <div class="stats-card-icon stats-card-icon-sm">👁️</div>
              <div class="stats-card-value stats-card-value-sm" x-text="(reportOverview.total_impressions || 0).toLocaleString()"></div>
              <div class="stats-card-label">总曝光</div>
            </div>
            <div class="stats-card stats-success stats-card-compact stats-card-animate">
              <div class="stats-card-icon stats-card-icon-sm">✅</div>
              <div class="stats-card-value stats-card-value-sm" x-text="(reportOverview.valid_impressions || 0).toLocaleString()"></div>
              <div class="stats-card-label">有效曝光</div>
            </div>
            <div class="stats-card stats-info stats-card-compact stats-card-animate">
              <div class="stats-card-icon stats-card-icon-sm">👆</div>
              <div class="stats-card-value stats-card-value-sm" x-text="(reportOverview.total_clicks || 0).toLocaleString()"></div>
              <div class="stats-card-label">总点击</div>
            </div>
            <div class="stats-card stats-warning stats-card-compact stats-card-animate">
              <div class="stats-card-icon stats-card-icon-sm">🎯</div>
              <div class="stats-card-value stats-card-value-sm" x-text="(reportOverview.total_conversions || 0).toLocaleString()"></div>
              <div class="stats-card-label">总转化</div>
            </div>
            <div class="stats-card stats-danger stats-card-compact stats-card-animate">
              <div class="stats-card-icon stats-card-icon-sm">💎</div>
              <div class="stats-card-value stats-card-value-sm" x-text="(reportOverview.total_spend_diamond || 0).toLocaleString()"></div>
              <div class="stats-card-label">总消耗(钻石)</div>
            </div>
          </div>

          <div x-show="!reportOverview.total_impressions && !reportOverview.total_clicks" class="empty-state empty-state-compact">
            <div class="empty-state-icon-circle">
              <span class="empty-state-icon">📊</span>
            </div>
            <h6 class="empty-state-title">所选时间范围内暂无投放数据</h6>
            <p class="empty-state-description">广告活动需要进入「投放中」状态后才会产生曝光和点击数据</p>
            <div class="empty-state-tips">
              <p class="empty-state-tips-title">如何产生数据？</p>
              <p>1. 在「广告活动」页签创建广告活动</p>
              <p>2. 提交审核并通过后，活动自动进入投放状态</p>
              <p>3. 用户在微信小程序中看到广告后，数据将在此展示</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== 竞价日志（Phase 4） ===== -->
    <div x-show="current_page === 'bid-logs'" x-cloak>
      <!-- 操作说明 -->
      <div class="mb-4 p-3 rounded-xl bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200/60 text-sm text-amber-800">
        <span class="font-semibold">💡 功能说明：</span>竞价日志记录了每次广告位竞价的出价详情与胜负结果。通过筛选活动ID和竞价结果，可快速分析竞价策略效果。
      </div>
      <!-- 统计概览 -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
        <div class="themed-card rounded-xl p-4 border-l-4 border-l-blue-500">
          <p class="text-xs themed-text-muted">总竞价次数</p>
          <p class="text-xl font-bold mt-1 tabular-nums" x-text="bidLogsPagination.total || bidLogs.length || 0"></p>
        </div>
        <div class="themed-card rounded-xl p-4 border-l-4 border-l-emerald-500">
          <p class="text-xs themed-text-muted">胜出次数</p>
          <p class="text-xl font-bold mt-1 text-emerald-600 tabular-nums" x-text="bidLogs.filter(l => l.is_winner).length"></p>
        </div>
        <div class="themed-card rounded-xl p-4 border-l-4 border-l-red-400">
          <p class="text-xs themed-text-muted">落选次数</p>
          <p class="text-xl font-bold mt-1 text-red-500 tabular-nums" x-text="bidLogs.filter(l => !l.is_winner).length"></p>
        </div>
        <div class="themed-card rounded-xl p-4 border-l-4 border-l-purple-500">
          <p class="text-xs themed-text-muted">平均出价</p>
          <p class="text-xl font-bold mt-1 text-purple-600 tabular-nums" x-text="bidLogs.length ? Math.round(bidLogs.reduce((s, l) => s + l.bid_amount_diamond, 0) / bidLogs.length) + ' 💎' : '-'"></p>
        </div>
      </div>
      <div class="themed-card rounded-xl shadow-sm overflow-hidden">
        <div class="p-4 border-b bg-gradient-to-r from-slate-50/80 to-transparent flex justify-between items-center flex-wrap gap-2">
          <h5 class="font-semibold text-lg flex items-center gap-2">⚡ 竞价日志</h5>
          <div class="flex items-center gap-2">
            <input type="number" x-model="bidLogsFilters.ad_campaign_id" placeholder="活动ID" class="px-3 py-1.5 text-sm border border-gray-200 rounded-lg themed-bg-base w-28 focus:ring-2 focus:ring-blue-500">
            <select x-model="bidLogsFilters.is_winner" @change="loadBidLogs()" class="px-3 py-1.5 text-sm border border-gray-200 rounded-lg themed-bg-base focus:ring-2 focus:ring-blue-500">
              <option value="">全部结果</option>
              <option value="true">胜出</option>
              <option value="false">落选</option>
            </select>
            <button @click="loadBidLogs()" class="px-4 py-1.5 text-sm bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-medium">查询</button>
          </div>
        </div>
        <div x-show="bidLogsLoading" class="p-12 text-center">
          <div class="inline-block w-8 h-8 border-3 border-blue-200 border-t-blue-500 rounded-full animate-spin"></div>
          <p class="mt-3 text-sm themed-text-muted">加载竞价日志中...</p>
        </div>
        <div x-show="bidLogs.length === 0 && !bidLogsLoading" class="p-12 text-center">
          <div class="w-16 h-16 bg-gradient-to-br from-amber-100 to-orange-100 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-inner">
            <span class="text-2xl">⚡</span>
          </div>
          <p class="text-sm font-medium text-gray-700 mb-1">暂无竞价日志</p>
          <p class="text-xs themed-text-muted">竞价模式的广告活动投放后，竞价记录将在此显示</p>
        </div>
        <div x-show="bidLogs.length > 0" class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gradient-to-r from-slate-50 to-gray-50"><tr>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">广告位</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">活动</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">出价</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">竞价结果</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">目标用户</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">落选原因</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">时间</th>
            </tr></thead>
            <tbody>
              <template x-for="(log, idx) in bidLogs" :key="log.ad_bid_log_id">
                <tr class="border-t border-gray-100 transition-colors" :class="idx % 2 === 0 ? '' : 'bg-gray-50/50'">
                  <td class="px-4 py-3 text-sm"><span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-md bg-slate-100 text-slate-700 font-mono text-xs">#<span x-text="log.ad_slot_id"></span></span></td>
                  <td class="px-4 py-3 text-sm"><span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-md bg-indigo-50 text-indigo-700 font-mono text-xs">#<span x-text="log.ad_campaign_id"></span></span></td>
                  <td class="px-4 py-3 text-sm font-semibold tabular-nums" x-text="log.bid_amount_diamond + ' 💎'"></td>
                  <td class="px-4 py-3 text-sm">
                    <span class="inline-flex items-center gap-1 text-xs px-2.5 py-1 rounded-full font-medium text-white shadow-sm"
                          :class="log.is_winner ? 'bg-gradient-to-r from-emerald-500 to-green-500' : 'bg-gradient-to-r from-red-400 to-rose-400'">
                      <span x-text="log.is_winner ? '✓' : '✕'"></span>
                      <span x-text="log.is_winner ? '胜出' : '落选'"></span>
                    </span>
                  </td>
                  <td class="px-4 py-3 text-sm"><span class="px-2 py-0.5 rounded-md bg-blue-50 text-blue-700 text-xs font-medium" x-text="'用户 #' + log.target_user_id"></span></td>
                  <td class="px-4 py-3 text-sm">
                    <span x-show="!log.is_winner && log.lose_reason" class="text-xs px-2 py-0.5 rounded-md bg-orange-50 text-orange-700" x-text="loseReasonText(log.lose_reason)"></span>
                    <span x-show="log.is_winner || !log.lose_reason" class="themed-text-muted text-xs">-</span>
                  </td>
                  <td class="px-4 py-3 text-xs themed-text-muted" x-text="formatDate(log.bid_at)"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <template x-if="bidLogsPagination.total_pages > 1">
          <div class="p-4 border-t bg-gray-50/50 flex justify-between items-center">
            <span class="text-sm themed-text-muted" x-text="'共 ' + bidLogsPagination.total + ' 条'"></span>
            <div class="flex items-center gap-1">
              <button @click="bidLogsPage > 1 && (bidLogsPage--, loadBidLogs())" :disabled="bidLogsPage <= 1" class="px-3 py-1.5 text-sm border border-gray-200 rounded-lg disabled:opacity-40 themed-hover-bg transition">‹</button>
              <span class="px-3 py-1.5 text-sm font-medium" x-text="bidLogsPage + ' / ' + bidLogsPagination.total_pages"></span>
              <button @click="bidLogsPage < bidLogsPagination.total_pages && (bidLogsPage++, loadBidLogs())" :disabled="bidLogsPage >= bidLogsPagination.total_pages" class="px-3 py-1.5 text-sm border border-gray-200 rounded-lg disabled:opacity-40 themed-hover-bg transition">›</button>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- ===== 用户标签 DMP（Phase 5） ===== -->
    <div x-show="current_page === 'user-tags'" x-cloak>
      <!-- 操作说明 -->
      <div class="mb-4 p-3 rounded-xl bg-gradient-to-r from-teal-50 to-cyan-50 border border-teal-200/60 text-sm text-teal-800">
        <span class="font-semibold">💡 功能说明：</span>用户画像标签（DMP）基于用户行为自动聚合计算，用于广告精准定向投放。标签每日凌晨3点由系统自动更新。
      </div>
      <!-- 标签分布概览 -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
        <div class="themed-card rounded-xl p-4 border-l-4 border-l-teal-500">
          <p class="text-xs themed-text-muted">已标记用户数</p>
          <p class="text-xl font-bold mt-1 tabular-nums" x-text="userAdTagsPagination.total || userAdTags.length || 0"></p>
        </div>
        <div class="themed-card rounded-xl p-4 border-l-4 border-l-emerald-500">
          <p class="text-xs themed-text-muted">标签值为「是」</p>
          <p class="text-xl font-bold mt-1 text-emerald-600 tabular-nums" x-text="userAdTags.filter(t => t.tag_value === 'true').length"></p>
        </div>
        <div class="themed-card rounded-xl p-4 border-l-4 border-l-gray-400">
          <p class="text-xs themed-text-muted">标签值为「否」</p>
          <p class="text-xl font-bold mt-1 text-gray-500 tabular-nums" x-text="userAdTags.filter(t => t.tag_value !== 'true').length"></p>
        </div>
        <div class="themed-card rounded-xl p-4 border-l-4 border-l-cyan-500">
          <p class="text-xs themed-text-muted">标签类型数</p>
          <p class="text-xl font-bold mt-1 text-cyan-600 tabular-nums" x-text="[...new Set(userAdTags.map(t => t.tag_key))].length"></p>
        </div>
      </div>
      <div class="themed-card rounded-xl shadow-sm overflow-hidden">
        <div class="p-4 border-b bg-gradient-to-r from-teal-50/60 to-transparent flex justify-between items-center flex-wrap gap-2">
          <h5 class="font-semibold text-lg flex items-center gap-2">🏷️ 用户广告标签（DMP）</h5>
          <div class="flex items-center gap-2">
            <input type="number" x-model="userAdTagsFilters.user_id" placeholder="用户ID" class="px-3 py-1.5 text-sm border border-gray-200 rounded-lg themed-bg-base w-28 focus:ring-2 focus:ring-teal-500">
            <select x-model="userAdTagsFilters.tag_key" @change="loadUserAdTags()" class="px-3 py-1.5 text-sm border border-gray-200 rounded-lg themed-bg-base focus:ring-2 focus:ring-teal-500">
              <option value="">全部标签</option>
              <option value="lottery_active_7d">7天抽奖活跃</option>
              <option value="lottery_active_30d">30天抽奖活跃</option>
              <option value="diamond_rich">钻石富豪</option>
              <option value="has_red_shard">持有红水晶碎片</option>
              <option value="market_trader">C2C交易者</option>
              <option value="new_user">新用户</option>
              <option value="active_7d">7天活跃</option>
            </select>
            <button @click="loadUserAdTags()" class="px-4 py-1.5 text-sm bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition font-medium">查询</button>
          </div>
        </div>
        <div x-show="userAdTagsLoading" class="p-12 text-center">
          <div class="inline-block w-8 h-8 border-3 border-teal-200 border-t-teal-500 rounded-full animate-spin"></div>
          <p class="mt-3 text-sm themed-text-muted">加载用户标签中...</p>
        </div>
        <div x-show="userAdTags.length === 0 && !userAdTagsLoading" class="p-12 text-center">
          <div class="w-16 h-16 bg-gradient-to-br from-teal-100 to-cyan-100 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-inner">
            <span class="text-2xl">🏷️</span>
          </div>
          <p class="text-sm font-medium text-gray-700 mb-1">暂无用户广告标签数据</p>
          <p class="text-xs themed-text-muted">需运行标签聚合任务后，用户画像数据将在此展示</p>
        </div>
        <div x-show="userAdTags.length > 0" class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gradient-to-r from-slate-50 to-gray-50"><tr>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">用户</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">标签名称</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">标签键（技术标识）</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">标签值</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">更新时间</th>
            </tr></thead>
            <tbody>
              <template x-for="(tag, idx) in userAdTags" :key="tag.user_ad_tag_id">
                <tr class="border-t border-gray-100 transition-colors" :class="idx % 2 === 0 ? '' : 'bg-gray-50/50'">
                  <td class="px-4 py-3 text-sm"><span class="px-2 py-0.5 rounded-md bg-blue-50 text-blue-700 text-xs font-medium" x-text="'用户 #' + tag.user_id"></span></td>
                  <td class="px-4 py-3 text-sm font-medium" x-text="tagKeyText(tag.tag_key)"></td>
                  <td class="px-4 py-3 text-sm"><code class="text-xs px-1.5 py-0.5 rounded bg-gray-100 text-gray-600 font-mono" x-text="tag.tag_key"></code></td>
                  <td class="px-4 py-3 text-sm">
                    <span class="inline-flex items-center gap-1 text-xs px-2.5 py-1 rounded-full font-medium"
                          :class="tag.tag_value === 'true' ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-500'">
                      <span x-text="tag.tag_value === 'true' ? '●' : '○'"></span>
                      <span x-text="tag.tag_value === 'true' ? '是' : '否'"></span>
                    </span>
                  </td>
                  <td class="px-4 py-3 text-xs themed-text-muted" x-text="formatDate(tag.calculated_at)"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <template x-if="userAdTagsPagination.total_pages > 1">
          <div class="p-4 border-t bg-gray-50/50 flex justify-between items-center">
            <span class="text-sm themed-text-muted" x-text="'共 ' + userAdTagsPagination.total + ' 条'"></span>
            <div class="flex items-center gap-1">
              <button @click="userAdTagsPage > 1 && (userAdTagsPage--, loadUserAdTags())" :disabled="userAdTagsPage <= 1" class="px-3 py-1.5 text-sm border border-gray-200 rounded-lg disabled:opacity-40 themed-hover-bg transition">‹</button>
              <span class="px-3 py-1.5 text-sm font-medium" x-text="userAdTagsPage + ' / ' + userAdTagsPagination.total_pages"></span>
              <button @click="userAdTagsPage < userAdTagsPagination.total_pages && (userAdTagsPage++, loadUserAdTags())" :disabled="userAdTagsPage >= userAdTagsPagination.total_pages" class="px-3 py-1.5 text-sm border border-gray-200 rounded-lg disabled:opacity-40 themed-hover-bg transition">›</button>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- ===== 反作弊日志（Phase 5） ===== -->
    <div x-show="current_page === 'antifraud'" x-cloak>
      <div class="mb-4 p-3 rounded-xl bg-gradient-to-r from-rose-50 to-red-50 border border-rose-200/60 text-sm text-rose-800">
        <span class="font-semibold">💡 功能说明：</span>反作弊系统自动检测异常的广告曝光和点击行为，保障广告投放数据真实有效。
      </div>
      <div class="themed-card rounded-xl shadow-sm overflow-hidden">
        <div class="p-4 border-b bg-gradient-to-r from-slate-50/80 to-transparent flex justify-between items-center flex-wrap gap-2">
          <h5 class="font-semibold text-lg flex items-center gap-2">🛡️ 反作弊判定日志</h5>
          <div class="flex items-center gap-2">
            <input type="number" x-model="antifraudFilters.ad_campaign_id" placeholder="活动ID" class="px-3 py-1.5 text-sm border border-gray-200 rounded-lg themed-bg-base w-28 focus:ring-2 focus:ring-blue-500">
            <select x-model="antifraudFilters.verdict" @change="loadAntifraudLogs()" class="px-3 py-1.5 text-sm border border-gray-200 rounded-lg themed-bg-base focus:ring-2 focus:ring-blue-500">
              <option value="">全部判定</option>
              <option value="valid">有效</option>
              <option value="invalid">无效</option>
              <option value="suspicious">可疑</option>
            </select>
            <select x-model="antifraudFilters.event_type" @change="loadAntifraudLogs()" class="px-3 py-1.5 text-sm border border-gray-200 rounded-lg themed-bg-base focus:ring-2 focus:ring-blue-500">
              <option value="">全部类型</option>
              <option value="impression">曝光</option>
              <option value="click">点击</option>
            </select>
            <button @click="loadAntifraudLogs()" class="px-4 py-1.5 text-sm bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-medium">查询</button>
          </div>
        </div>
        <div x-show="antifraudLogsLoading" class="p-12 text-center">
          <div class="inline-block w-8 h-8 border-3 border-blue-200 border-t-blue-500 rounded-full animate-spin"></div>
          <p class="mt-3 text-sm themed-text-muted">加载反作弊日志中...</p>
        </div>
        <div x-show="antifraudLogs.length === 0 && !antifraudLogsLoading" class="empty-state empty-state-compact">
          <div class="empty-state-icon-circle">
            <span class="empty-state-icon">🛡️</span>
          </div>
          <h6 class="empty-state-title">暂无反作弊判定日志</h6>
          <p class="empty-state-description">广告投放产生曝光和点击后，反作弊系统会自动记录判定结果</p>
        </div>
        <div x-show="antifraudLogs.length > 0" class="overflow-x-auto">
          <table class="w-full">
            <thead class="themed-bg-base"><tr>
              <th class="px-4 py-3 text-left text-sm">用户ID</th>
              <th class="px-4 py-3 text-left text-sm">活动ID</th>
              <th class="px-4 py-3 text-left text-sm">事件类型</th>
              <th class="px-4 py-3 text-left text-sm">触发规则</th>
              <th class="px-4 py-3 text-left text-sm">判定结果</th>
              <th class="px-4 py-3 text-left text-sm">时间</th>
            </tr></thead>
            <tbody class="divide-y">
              <template x-for="log in antifraudLogs" :key="log.ad_antifraud_log_id">
                <tr class="themed-hover-bg">
                  <td class="px-4 py-3 text-sm" x-text="'#' + log.user_id"></td>
                  <td class="px-4 py-3 text-sm" x-text="log.ad_campaign_id"></td>
                  <td class="px-4 py-3 text-sm" x-text="log.event_type === 'impression' ? '曝光' : '点击'"></td>
                  <td class="px-4 py-3 text-sm font-medium" x-text="log.rule_triggered"></td>
                  <td class="px-4 py-3 text-sm"><span class="text-xs px-2 py-0.5 rounded text-white" :class="log.verdict === 'valid' ? 'bg-green-500' : log.verdict === 'invalid' ? 'bg-red-500' : 'bg-yellow-500'" x-text="log.verdict === 'valid' ? '有效' : log.verdict === 'invalid' ? '无效' : '可疑'"></span></td>
                  <td class="px-4 py-3 text-sm themed-text-muted" x-text="formatDate(log.created_at)"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <template x-if="antifraudPagination.total_pages > 1">
          <div class="p-4 border-t flex justify-between items-center">
            <span class="text-sm themed-text-muted" x-text="'共 ' + antifraudPagination.total + ' 条'"></span>
            <div class="flex space-x-1">
              <button @click="antifraudPage > 1 && (antifraudPage--, loadAntifraudLogs())" :disabled="antifraudPage <= 1" class="px-3 py-1 text-sm border rounded disabled:opacity-50">‹</button>
              <span class="px-3 py-1 text-sm" x-text="antifraudPage + ' / ' + antifraudPagination.total_pages"></span>
              <button @click="antifraudPage < antifraudPagination.total_pages && (antifraudPage++, loadAntifraudLogs())" :disabled="antifraudPage >= antifraudPagination.total_pages" class="px-3 py-1 text-sm border rounded disabled:opacity-50">›</button>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- ===== 归因追踪日志（Phase 6） ===== -->
    <div x-show="current_page === 'attribution'" x-cloak>
      <!-- 操作说明 -->
      <div class="mb-4 p-3 rounded-xl bg-gradient-to-r from-indigo-50 to-violet-50 border border-indigo-200/60 text-sm text-indigo-800">
        <span class="font-semibold">💡 功能说明：</span>归因追踪记录用户从广告点击到实际转化行为的完整链路。归因窗口默认24小时，即用户点击广告后24小时内的转化行为归因于该广告。
      </div>
      <!-- 统计概览 -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
        <div class="themed-card rounded-xl p-4 border-l-4 border-l-indigo-500">
          <p class="text-xs themed-text-muted">总转化次数</p>
          <p class="text-xl font-bold mt-1 tabular-nums" x-text="attributionPagination.total || attributionLogs.length || 0"></p>
        </div>
        <div class="themed-card rounded-xl p-4 border-l-4 border-l-purple-500">
          <p class="text-xs themed-text-muted">抽奖转化</p>
          <p class="text-xl font-bold mt-1 text-purple-600 tabular-nums" x-text="attributionLogs.filter(l => l.conversion_type === 'lottery_draw').length"></p>
        </div>
        <div class="themed-card rounded-xl p-4 border-l-4 border-l-blue-500">
          <p class="text-xs themed-text-muted">兑换转化</p>
          <p class="text-xl font-bold mt-1 text-blue-600 tabular-nums" x-text="attributionLogs.filter(l => l.conversion_type === 'exchange').length"></p>
        </div>
        <div class="themed-card rounded-xl p-4 border-l-4 border-l-green-500">
          <p class="text-xs themed-text-muted">市场购买转化</p>
          <p class="text-xl font-bold mt-1 text-green-600 tabular-nums" x-text="attributionLogs.filter(l => l.conversion_type === 'market_buy').length"></p>
        </div>
      </div>
      <div class="themed-card rounded-xl shadow-sm overflow-hidden">
        <div class="p-4 border-b bg-gradient-to-r from-indigo-50/60 to-transparent flex justify-between items-center flex-wrap gap-2">
          <h5 class="font-semibold text-lg flex items-center gap-2">🔗 归因追踪日志</h5>
          <div class="flex items-center gap-2">
            <input type="number" x-model="attributionFilters.ad_campaign_id" placeholder="活动ID" class="px-3 py-1.5 text-sm border border-gray-200 rounded-lg themed-bg-base w-28 focus:ring-2 focus:ring-indigo-500">
            <select x-model="attributionFilters.conversion_type" @change="loadAttributionLogs()" class="px-3 py-1.5 text-sm border border-gray-200 rounded-lg themed-bg-base focus:ring-2 focus:ring-indigo-500">
              <option value="">全部转化类型</option>
              <option value="lottery_draw">抽奖</option>
              <option value="exchange">兑换</option>
              <option value="market_buy">市场购买</option>
              <option value="page_view">页面浏览</option>
            </select>
            <button @click="loadAttributionLogs()" class="px-4 py-1.5 text-sm bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition font-medium">查询</button>
          </div>
        </div>
        <div x-show="attributionLogsLoading" class="p-12 text-center">
          <div class="inline-block w-8 h-8 border-3 border-indigo-200 border-t-indigo-500 rounded-full animate-spin"></div>
          <p class="mt-3 text-sm themed-text-muted">加载归因追踪日志中...</p>
        </div>
        <div x-show="attributionLogs.length === 0 && !attributionLogsLoading" class="p-12 text-center">
          <div class="w-16 h-16 bg-gradient-to-br from-indigo-100 to-violet-100 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-inner">
            <span class="text-2xl">🔗</span>
          </div>
          <p class="text-sm font-medium text-gray-700 mb-1">暂无归因追踪日志</p>
          <p class="text-xs themed-text-muted">广告点击后产生转化行为时，归因数据将在此展示</p>
        </div>
        <div x-show="attributionLogs.length > 0" class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gradient-to-r from-slate-50 to-gray-50"><tr>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">活动</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">用户</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">转化类型</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">转化实体</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">点击时间</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">转化时间</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">归因窗口</th>
            </tr></thead>
            <tbody>
              <template x-for="(log, idx) in attributionLogs" :key="log.ad_attribution_log_id">
                <tr class="border-t border-gray-100 transition-colors" :class="idx % 2 === 0 ? '' : 'bg-gray-50/50'">
                  <td class="px-4 py-3 text-sm"><span class="px-2 py-0.5 rounded-md bg-indigo-50 text-indigo-700 font-mono text-xs" x-text="'#' + log.ad_campaign_id"></span></td>
                  <td class="px-4 py-3 text-sm"><span class="px-2 py-0.5 rounded-md bg-blue-50 text-blue-700 text-xs font-medium" x-text="'用户 #' + log.user_id"></span></td>
                  <td class="px-4 py-3 text-sm">
                    <span class="text-xs px-2.5 py-1 rounded-full font-medium" :class="conversionColor(log.conversion_type)" x-text="conversionText(log.conversion_type)"></span>
                  </td>
                  <td class="px-4 py-3 text-sm"><span class="px-2 py-0.5 rounded-md bg-gray-100 text-gray-600 font-mono text-xs" x-text="log.conversion_entity_id || '-'"></span></td>
                  <td class="px-4 py-3 text-xs themed-text-muted" x-text="formatDate(log.click_at)"></td>
                  <td class="px-4 py-3 text-xs themed-text-muted" x-text="formatDate(log.conversion_at)"></td>
                  <td class="px-4 py-3 text-sm">
                    <span class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-md bg-violet-50 text-violet-700 font-medium">
                      🕐 <span x-text="(log.attribution_window_hours || 24) + '小时'"></span>
                    </span>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <template x-if="attributionPagination.total_pages > 1">
          <div class="p-4 border-t bg-gray-50/50 flex justify-between items-center">
            <span class="text-sm themed-text-muted" x-text="'共 ' + attributionPagination.total + ' 条'"></span>
            <div class="flex items-center gap-1">
              <button @click="attributionPage > 1 && (attributionPage--, loadAttributionLogs())" :disabled="attributionPage <= 1" class="px-3 py-1.5 text-sm border border-gray-200 rounded-lg disabled:opacity-40 themed-hover-bg transition">‹</button>
              <span class="px-3 py-1.5 text-sm font-medium" x-text="attributionPage + ' / ' + attributionPagination.total_pages"></span>
              <button @click="attributionPage < attributionPagination.total_pages && (attributionPage++, loadAttributionLogs())" :disabled="attributionPage >= attributionPagination.total_pages" class="px-3 py-1.5 text-sm border border-gray-200 rounded-lg disabled:opacity-40 themed-hover-bg transition">›</button>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- ===== 活动详情 Modal ===== -->
    <div x-ref="campaignDetailModal" 
         x-show="isModalOpen('campaignDetailModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('campaignDetailModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-3xl mx-4 z-10 max-h-[90vh] overflow-y-auto">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 themed-card">
          <h5 class="font-semibold">📋 广告活动详情</h5>
          <button @click="hideModal('campaignDetailModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <div class="p-6" x-show="campaignDetail">
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div><span class="themed-text-muted">计划名称:</span> <span class="font-medium" x-text="campaignDetail?.campaign_name"></span></div>
            <div><span class="themed-text-muted">状态:</span> <span class="text-xs px-2.5 py-1 rounded-full font-medium text-white" :class="statusColor(campaignDetail?.status)" x-text="statusText(campaignDetail?.status)"></span></div>
            <div><span class="themed-text-muted">广告主:</span> <span x-text="campaignDetail?.advertiser?.nickname || ('用户#' + campaignDetail?.advertiser_user_id)"></span></div>
            <div><span class="themed-text-muted">计费模式:</span> <span x-text="billingText(campaignDetail?.billing_mode)"></span></div>
            <div><span class="themed-text-muted">预算:</span> <span x-text="(campaignDetail?.budget_total_diamond || campaignDetail?.fixed_total_diamond || 0) + ' 💎'"></span></div>
            <div><span class="themed-text-muted">已消耗:</span> <span x-text="(campaignDetail?.budget_spent_diamond || 0) + ' 💎'"></span></div>
            <div><span class="themed-text-muted">投放日期:</span> <span x-text="(campaignDetail?.start_date || '-') + ' ~ ' + (campaignDetail?.end_date || '-')"></span></div>
            <div><span class="themed-text-muted">优先级:</span> <span x-text="campaignDetail?.priority || 0"></span></div>
          </div>
          <div x-show="campaignDetail?.review_note" class="mt-4 p-3 themed-bg-base rounded">
            <p class="text-sm font-medium">审核备注:</p>
            <p class="text-sm themed-text-muted" x-text="campaignDetail?.review_note"></p>
          </div>
          <!-- 素材列表 -->
          <div x-show="campaignDetail?.creatives?.length > 0" class="mt-4">
            <h6 class="font-medium mb-2">广告素材</h6>
            <div class="grid grid-cols-2 gap-3">
              <template x-for="cr in (campaignDetail?.creatives || [])" :key="cr.ad_creative_id">
                <div class="border rounded p-2">
                  <img :src="cr.image_url" alt="" class="w-full h-32 object-contain rounded mb-1" x-show="cr.image_url">
                  <p class="text-xs font-medium" x-text="cr.title"></p>
                  <span class="text-xs px-1 py-0.5 rounded"
                        :class="cr.review_status === 'approved' ? 'bg-green-100 text-green-700' : cr.review_status === 'rejected' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'"
                        x-text="cr.review_status_display || (cr.review_status === 'approved' ? '已通过' : cr.review_status === 'rejected' ? '已拒绝' : '待审核')"></span>
                </div>
              </template>
            </div>
          </div>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end">
          <button type="button" @click="hideModal('campaignDetailModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">关闭</button>
        </div>
      </div>
    </div>

    <!-- ===== 广告位表单 Modal ===== -->
    <div x-ref="slotModal" 
         x-show="isModalOpen('slotModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('slotModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-lg mx-4 z-10 max-h-[90vh] overflow-y-auto">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 themed-card">
          <h5 class="font-semibold">📍 <span x-text="slotEditMode ? '编辑广告位' : '新增广告位'"></span></h5>
          <button @click="hideModal('slotModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <form @submit.prevent="saveSlot()">
          <div class="p-6 space-y-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">广告位标识 <span class="text-red-500">*</span></label>
              <input type="text" x-model="slotForm.slot_key" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500" placeholder="home_popup" :disabled="slotEditMode">
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">广告位名称 <span class="text-red-500">*</span></label>
              <input type="text" x-model="slotForm.slot_name" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500" placeholder="首页弹窗位">
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">广告位类型</label>
                <select x-model="slotForm.slot_type" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
                  <option value="popup">弹窗</option>
                  <option value="carousel">轮播图</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">页面位置</label>
                <select x-model="slotForm.position" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
                  <option value="home">首页</option>
                  <option value="lottery">抽奖页</option>
                  <option value="profile">个人中心</option>
                </select>
              </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">日价(💎)</label>
                <input type="number" x-model.number="slotForm.daily_price_diamond" min="1" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">最低出价(💎)</label>
                <input type="number" x-model.number="slotForm.min_bid_diamond" min="1" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">最低预算(💎)</label>
                <input type="number" x-model.number="slotForm.min_budget_diamond" min="1" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">最大展示数</label>
                <input type="number" x-model.number="slotForm.max_display_count" min="1" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">描述</label>
              <textarea x-model="slotForm.description" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500" rows="2"></textarea>
            </div>
          </div>
          <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-2 sticky bottom-0">
            <button type="button" @click="hideModal('slotModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">取消</button>
            <button type="submit" class="px-4 py-2 themed-btn-primary rounded" :disabled="saving">
              <span x-show="saving" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-1"></span>
              <span x-text="slotEditMode ? '保存修改' : '新增广告位'"></span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ===== 创建广告活动 Modal ===== -->
    <div x-ref="campaignCreateModal"
         x-show="isModalOpen('campaignCreateModal')"
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('campaignCreateModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-2xl mx-4 z-10 max-h-[90vh] overflow-y-auto">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 themed-card">
          <h5 class="font-semibold">➕ 创建广告活动</h5>
          <button @click="hideModal('campaignCreateModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <form @submit.prevent="saveCampaign()">
          <div class="p-6 space-y-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">活动名称 <span class="text-red-500">*</span></label>
              <input type="text" x-model="campaignForm.campaign_name" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500" placeholder="输入广告活动名称">
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">广告位 <span class="text-red-500">*</span></label>
                <select x-model="campaignForm.ad_slot_id" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
                  <option value="">请选择广告位</option>
                  <template x-for="slot in allSlotsList" :key="slot.ad_slot_id">
                    <option :value="slot.ad_slot_id" x-text="slot.slot_name + ' (' + slot.slot_type + ' · ' + slot.position + ')'"></option>
                  </template>
                </select>
                <p class="text-xs themed-text-muted mt-1" x-show="getSelectedSlotInfo()" x-text="'日价: ' + (getSelectedSlotInfo()?.daily_price_diamond || '-') + ' 💎 · 最低出价: ' + (getSelectedSlotInfo()?.min_bid_diamond || '-') + ' 💎'"></p>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">广告主用户ID（可选）</label>
                <input type="number" x-model="campaignForm.advertiser_user_id" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500" placeholder="不填则为当前管理员">
                <p class="text-xs themed-text-muted mt-1">留空表示管理员自己作为广告主</p>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-2">计费模式 <span class="text-red-500">*</span></label>
              <div class="grid grid-cols-2 gap-3">
                <label class="flex items-center p-3 border rounded cursor-pointer transition-colors"
                       :class="campaignForm.billing_mode === 'fixed_daily' ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/20' : 'themed-border hover:bg-gray-50 dark:hover:bg-gray-700'">
                  <input type="radio" name="billing_mode" value="fixed_daily" x-model="campaignForm.billing_mode" class="mr-2">
                  <div>
                    <span class="text-sm font-medium">💰 固定包天</span>
                    <span class="text-xs themed-text-muted block">按天购买展示时间，一次性支付</span>
                  </div>
                </label>
                <label class="flex items-center p-3 border rounded cursor-pointer transition-colors"
                       :class="campaignForm.billing_mode === 'bidding' ? 'border-purple-500 bg-purple-50 dark:bg-purple-900/20' : 'themed-border hover:bg-gray-50 dark:hover:bg-gray-700'">
                  <input type="radio" name="billing_mode" value="bidding" x-model="campaignForm.billing_mode" class="mr-2">
                  <div>
                    <span class="text-sm font-medium">📈 竞价排名</span>
                    <span class="text-xs themed-text-muted block">按日出价竞争展示位，预算用完停投</span>
                  </div>
                </label>
              </div>
            </div>

            <!-- 固定包天字段 -->
            <div x-show="campaignForm.billing_mode === 'fixed_daily'" class="p-4 bg-indigo-50 dark:bg-indigo-900/10 border border-indigo-200 dark:border-indigo-800 rounded-lg">
              <h6 class="text-sm font-medium mb-3 text-indigo-700 dark:text-indigo-300">固定包天参数</h6>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm themed-text-secondary mb-1">投放天数 <span class="text-red-500">*</span></label>
                  <input type="number" x-model.number="campaignForm.fixed_days" min="1" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                  <label class="block text-sm themed-text-secondary mb-1">预估总价</label>
                  <div class="w-full px-3 py-2 border rounded themed-bg-base text-lg font-bold text-indigo-600">
                    <span x-text="((getSelectedSlotInfo()?.daily_price_diamond || 0) * (campaignForm.fixed_days || 0)) + ' 💎'"></span>
                  </div>
                  <p class="text-xs themed-text-muted mt-1" x-text="'= ' + (getSelectedSlotInfo()?.daily_price_diamond || '?') + ' 💎/天 × ' + (campaignForm.fixed_days || 0) + ' 天'"></p>
                </div>
              </div>
            </div>

            <!-- 竞价排名字段 -->
            <div x-show="campaignForm.billing_mode === 'bidding'" class="p-4 bg-purple-50 dark:bg-purple-900/10 border border-purple-200 dark:border-purple-800 rounded-lg">
              <h6 class="text-sm font-medium mb-3 text-purple-700 dark:text-purple-300">竞价排名参数</h6>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm themed-text-secondary mb-1">每日出价（钻石）<span class="text-red-500">*</span></label>
                  <input type="number" x-model.number="campaignForm.daily_bid_diamond" min="1" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-purple-500">
                  <p class="text-xs themed-text-muted mt-1" x-text="'最低出价: ' + (getSelectedSlotInfo()?.min_bid_diamond || 50) + ' 💎'"></p>
                </div>
                <div>
                  <label class="block text-sm themed-text-secondary mb-1">总预算（钻石）<span class="text-red-500">*</span></label>
                  <input type="number" x-model.number="campaignForm.budget_total_diamond" min="1" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-purple-500">
                  <p class="text-xs themed-text-muted mt-1" x-text="'最低预算: ' + (getSelectedSlotInfo()?.min_budget_diamond || 500) + ' 💎 · 预估可投 ' + (campaignForm.daily_bid_diamond > 0 ? Math.floor((campaignForm.budget_total_diamond || 0) / campaignForm.daily_bid_diamond) : '?') + ' 天'"></p>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">投放开始日期</label>
                <input type="date" x-model="campaignForm.start_date" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">投放结束日期</label>
                <input type="date" x-model="campaignForm.end_date" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">展示优先级</label>
                <input type="number" x-model.number="campaignForm.priority" min="1" max="99" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
                <p class="text-xs themed-text-muted mt-1">1~99，数字越大越优先展示</p>
              </div>
            </div>

            <div class="p-3 bg-yellow-50 dark:bg-yellow-900/10 border border-yellow-200 dark:border-yellow-700 rounded text-sm text-yellow-800 dark:text-yellow-300">
              <span class="font-medium">说明：</span>创建后为草稿状态，需通过「审核」流程才能正式投放。固定包天模式在提交审核时会冻结钻石，审核通过后扣除、拒绝后退回。
            </div>
          </div>
          <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-2 sticky bottom-0">
            <button type="button" @click="hideModal('campaignCreateModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">取消</button>
            <button type="submit" class="px-4 py-2 themed-btn-primary rounded" :disabled="saving">
              <span x-show="saving" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-1"></span>
              <span>创建广告活动</span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 审核 Modal -->
    <div x-ref="reviewModal" 
         x-show="isModalOpen('reviewModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('reviewModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-sm mx-4 z-10">
        <div class="p-4 border-b">
          <h5 class="font-semibold" x-text="reviewAction === 'approved' ? '✅ 审核通过' : '❌ 审核拒绝'"></h5>
        </div>
        <div class="p-6">
          <div x-show="reviewAction === 'rejected'" class="mb-3 p-3 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800">
            <span class="font-medium">提示：</span>审核拒绝后，广告主冻结的钻石将自动退回。
          </div>
          <label class="block text-sm font-medium themed-text-secondary mb-1">审核备注</label>
          <textarea x-model="reviewNote" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500" rows="3" placeholder="请输入审核意见..."></textarea>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-2">
          <button type="button" @click="hideModal('reviewModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded">取消</button>
          <button type="button" @click="submitReview()" class="px-4 py-2 rounded text-white" 
                  :class="reviewAction === 'approved' ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'"
                  :disabled="saving">
            <span x-text="reviewAction === 'approved' ? '确认通过' : '确认拒绝'"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- ===== 活动/广告位详细报表 Modal ===== -->
    <div x-ref="reportDetailModal"
         x-show="isModalOpen('reportDetailModal')"
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('reportDetailModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-3xl mx-4 z-10 max-h-[90vh] overflow-y-auto">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 themed-card">
          <h5 class="font-semibold" x-text="reportDetailType === 'campaign' ? '📊 活动详细报表 #' + reportDetailId : '📊 广告位详细报表 #' + reportDetailId"></h5>
          <button @click="hideModal('reportDetailModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <div class="p-6">
          <!-- 活动报表 -->
          <template x-if="reportDetailType === 'campaign'">
            <div>
              <div x-show="campaignReportLoading" class="p-8 text-center themed-text-muted">加载中...</div>
              <div x-show="!campaignReportLoading && campaignReport">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                  <div class="p-3 themed-bg-base rounded-lg text-center">
                    <p class="text-xl font-bold" x-text="campaignReport?.impressions_total || 0"></p>
                    <p class="text-xs themed-text-muted">总曝光</p>
                  </div>
                  <div class="p-3 themed-bg-base rounded-lg text-center">
                    <p class="text-xl font-bold text-green-500" x-text="campaignReport?.impressions_valid || 0"></p>
                    <p class="text-xs themed-text-muted">有效曝光</p>
                  </div>
                  <div class="p-3 themed-bg-base rounded-lg text-center">
                    <p class="text-xl font-bold text-blue-500" x-text="campaignReport?.clicks_total || 0"></p>
                    <p class="text-xs themed-text-muted">总点击</p>
                  </div>
                  <div class="p-3 themed-bg-base rounded-lg text-center">
                    <p class="text-xl font-bold text-orange-500" x-text="campaignReport?.conversions || 0"></p>
                    <p class="text-xs themed-text-muted">转化数</p>
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                  <div class="p-3 themed-bg-base rounded-lg text-center">
                    <p class="text-xl font-bold text-purple-500" x-text="(campaignReport?.spend_diamond || 0) + ' 💎'"></p>
                    <p class="text-xs themed-text-muted">消耗钻石</p>
                  </div>
                  <div class="p-3 themed-bg-base rounded-lg text-center">
                    <p class="text-xl font-bold" x-text="campaignReport?.clicks_total && campaignReport?.impressions_valid ? ((campaignReport.clicks_total / campaignReport.impressions_valid) * 100).toFixed(2) + '%' : '0%'"></p>
                    <p class="text-xs themed-text-muted">点击率</p>
                  </div>
                </div>
                <div x-show="campaignReport?.daily_snapshots?.length > 0">
                  <h6 class="font-medium mb-2 text-sm">每日趋势</h6>
                  <div id="reportDetailChart" class="w-full h-52 mb-4"></div>
                  <h6 class="font-medium mb-2 text-sm">每日数据</h6>
                  <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                      <thead class="themed-bg-base">
                        <tr>
                          <th class="px-3 py-2 text-left">日期</th>
                          <th class="px-3 py-2 text-right">曝光</th>
                          <th class="px-3 py-2 text-right">有效曝光</th>
                          <th class="px-3 py-2 text-right">点击</th>
                          <th class="px-3 py-2 text-right">转化</th>
                          <th class="px-3 py-2 text-right">消耗💎</th>
                        </tr>
                      </thead>
                      <tbody>
                        <template x-for="snap in (campaignReport?.daily_snapshots || [])" :key="snap.snapshot_date">
                          <tr class="border-t">
                            <td class="px-3 py-2" x-text="snap.snapshot_date"></td>
                            <td class="px-3 py-2 text-right" x-text="snap.impressions_total || 0"></td>
                            <td class="px-3 py-2 text-right" x-text="snap.impressions_valid || 0"></td>
                            <td class="px-3 py-2 text-right" x-text="snap.clicks_total || 0"></td>
                            <td class="px-3 py-2 text-right" x-text="snap.conversions || 0"></td>
                            <td class="px-3 py-2 text-right" x-text="snap.spend_diamond || 0"></td>
                          </tr>
                        </template>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              <div x-show="!campaignReportLoading && !campaignReport" class="p-8 text-center themed-text-muted">暂无报表数据</div>
            </div>
          </template>
          <!-- 广告位报表 -->
          <template x-if="reportDetailType === 'slot'">
            <div>
              <div x-show="slotReportLoading" class="p-8 text-center themed-text-muted">加载中...</div>
              <div x-show="!slotReportLoading && slotReport">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                  <div class="p-3 themed-bg-base rounded-lg text-center">
                    <p class="text-xl font-bold" x-text="slotReport?.impressions_total || 0"></p>
                    <p class="text-xs themed-text-muted">总曝光</p>
                  </div>
                  <div class="p-3 themed-bg-base rounded-lg text-center">
                    <p class="text-xl font-bold text-green-500" x-text="slotReport?.impressions_valid || 0"></p>
                    <p class="text-xs themed-text-muted">有效曝光</p>
                  </div>
                  <div class="p-3 themed-bg-base rounded-lg text-center">
                    <p class="text-xl font-bold text-blue-500" x-text="slotReport?.clicks_total || 0"></p>
                    <p class="text-xs themed-text-muted">总点击</p>
                  </div>
                  <div class="p-3 themed-bg-base rounded-lg text-center">
                    <p class="text-xl font-bold text-orange-500" x-text="(slotReport?.total_spend_diamond || 0) + ' 💎'"></p>
                    <p class="text-xs themed-text-muted">总收入</p>
                  </div>
                </div>
                <div x-show="slotReport?.daily_snapshots?.length > 0">
                  <h6 class="font-medium mb-2 text-sm">每日数据</h6>
                  <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                      <thead class="themed-bg-base">
                        <tr>
                          <th class="px-3 py-2 text-left">日期</th>
                          <th class="px-3 py-2 text-right">曝光</th>
                          <th class="px-3 py-2 text-right">点击</th>
                          <th class="px-3 py-2 text-right">转化</th>
                          <th class="px-3 py-2 text-right">收入💎</th>
                        </tr>
                      </thead>
                      <tbody>
                        <template x-for="snap in (slotReport?.daily_snapshots || [])" :key="snap.snapshot_date">
                          <tr class="border-t">
                            <td class="px-3 py-2" x-text="snap.snapshot_date"></td>
                            <td class="px-3 py-2 text-right" x-text="snap.impressions_total || 0"></td>
                            <td class="px-3 py-2 text-right" x-text="snap.clicks_total || 0"></td>
                            <td class="px-3 py-2 text-right" x-text="snap.conversions || 0"></td>
                            <td class="px-3 py-2 text-right" x-text="snap.spend_diamond || 0"></td>
                          </tr>
                        </template>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              <div x-show="!slotReportLoading && !slotReport" class="p-8 text-center themed-text-muted">暂无报表数据</div>
            </div>
          </template>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end">
          <button type="button" @click="hideModal('reportDetailModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">关闭</button>
        </div>
      </div>
    </div>

  </div>

  <%- include('partials/footer') %>

  <script type="module" src="./src/modules/content/pages/ad-management.js"></script>
</body>
</html>
