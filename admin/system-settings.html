<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '系统设置管理', 
    pageStyle: '[x-cloak] { display: none !important; }' 
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen">

  <!-- 页面主体 -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 py-6" x-data="systemSettings()"
       @edit-reminder-rule="openReminderRuleModal($event.detail)"
       @toggle-reminder-rule="toggleReminderRule($event.detail)"
       @delete-reminder-rule="deleteReminderRule($event.detail)"
       @view-audit-detail="viewAuditLogDetail($event.detail)"
       @rollback-audit="rollbackOperation($event.detail)">
    
    <!-- 页面横幅 -->
    <div class="page-banner mb-6">
      <h1>⚙️ 系统设置管理</h1>
      <p>管理系统配置、提醒规则与审计日志</p>
      <div class="flex items-center gap-3 mt-4">
        <template x-for="page in subPages" :key="page.id">
          <button 
            @click="switchPage(page.id)"
            :class="current_page === page.id 
              ? 'bg-white/20 border-white/40 text-white shadow-sm' 
              : 'bg-white/5 border-white/10 text-blue-100 hover:bg-white/10'"
            class="px-5 py-2 rounded-lg text-sm font-medium border transition-all duration-200"
            x-text="page.icon + ' ' + page.name"
          ></button>
        </template>
      </div>
    </div>

    <!-- ==================== 系统配置（全5大分类） ==================== -->
    <div x-show="current_page === 'system-config'" x-cloak>

      <!-- 配置分类概览卡片 -->
      <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
        <template x-for="catKey in allCategories" :key="catKey">
          <button 
            @click="switchCategory(catKey)"
            :class="activeCategory === catKey 
              ? 'ring-2 ring-blue-500 ring-offset-2 shadow-md scale-[1.02]' 
              : 'hover:shadow-md hover:scale-[1.01]'"
            class="themed-card rounded-xl p-4 text-left transition-all duration-200 border"
          >
            <div class="text-2xl mb-1" x-text="categoryDisplay[catKey]?.icon"></div>
            <div class="text-sm font-semibold themed-text" x-text="categoryDisplay[catKey]?.name"></div>
            <div class="flex items-center gap-1 mt-1">
              <span class="text-lg font-bold themed-text-primary" x-text="categoryCounts[catKey] || 0"></span>
              <span class="text-xs themed-text-muted">项配置</span>
            </div>
          </button>
        </template>
      </div>

      <!-- 当前分类配置内容 -->
      <div class="themed-card rounded-xl shadow-sm border overflow-hidden">
        <div class="card-header-accent flex justify-between items-center">
          <div class="flex items-center gap-3">
            <div class="header-icon">
              <span x-text="categoryDisplay[activeCategory]?.icon || '⚙️'"></span>
            </div>
            <div>
              <h5 class="font-semibold themed-text" x-text="categoryDisplay[activeCategory]?.name || activeCategory"></h5>
              <p class="text-xs themed-text-muted mt-0.5" x-text="categoryDisplay[activeCategory]?.description || ''"></p>
            </div>
          </div>
          <button 
            @click="saveCategoryConfig(activeCategory)" 
            :disabled="saving"
            class="btn-primary btn-sm rounded-lg"
          >
            <span x-show="!saving">💾 保存配置</span>
            <span x-show="saving">保存中...</span>
          </button>
        </div>

        <div x-show="categoryLoading" class="p-12 text-center themed-text-muted">
          <div class="loading-spinner w-8 h-8 mb-3 mx-auto"></div>
          <p class="text-sm">加载配置中...</p>
        </div>

        <div x-show="!categoryLoading && categorySettings[activeCategory]?.length > 0" class="p-5">
          <div class="space-y-3">
            <template x-for="setting in (categorySettings[activeCategory] || [])" :key="setting.setting_key">
              <div class="rounded-lg p-4 border themed-bg-base hover:shadow-sm transition-shadow">
                <div class="flex flex-col md:flex-row md:items-center gap-3">
                  <div class="md:w-2/5">
                    <label class="block text-sm font-medium themed-text" x-text="setting.display_name || setting.setting_key"></label>
                    <p class="text-xs themed-text-muted mt-0.5 leading-relaxed" x-text="setting.description || ''"></p>
                    <template x-if="setting.is_readonly">
                      <span class="inline-flex items-center mt-1.5 text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">🔒 只读</span>
                    </template>
                  </div>
                  <div class="md:w-3/5">
                    <template x-if="setting.is_readonly">
                      <div class="form-input bg-gray-50 text-gray-500 cursor-not-allowed" 
                           x-text="editableSettings[activeCategory]?.[setting.setting_key] ?? '-'"></div>
                    </template>
                    <template x-if="!setting.is_readonly && isCampaignSelectKey(setting.setting_key)">
                      <div>
                        <select x-model="editableSettings[activeCategory][setting.setting_key]" class="form-select">
                          <option value="">请选择活动</option>
                          <template x-for="opt in campaignOptions" :key="opt.value">
                            <option :value="opt.value" x-text="opt.label + (opt.status === 'active' ? ' ✅' : '')"></option>
                          </template>
                        </select>
                        <p class="form-hint" x-show="campaignOptionsLoading">活动列表加载中...</p>
                        <p class="form-hint" x-show="!campaignOptionsLoading && campaignOptions.length === 0">暂无可用活动</p>
                      </div>
                    </template>
                    <template x-if="!setting.is_readonly && !isCampaignSelectKey(setting.setting_key) && isBooleanSetting(setting)">
                      <select 
                        x-model="editableSettings[activeCategory][setting.setting_key]"
                        class="form-select"
                        :class="String(editableSettings[activeCategory]?.[setting.setting_key]) === 'true' ? 'border-green-300 bg-green-50/50' : 'border-orange-200 bg-orange-50/50'"
                      >
                        <option :value="false">🔴 关闭</option>
                        <option :value="true">🟢 开启</option>
                      </select>
                    </template>
                    <template x-if="!setting.is_readonly && !isCampaignSelectKey(setting.setting_key) && !isBooleanSetting(setting) && isNumberSetting(setting)">
                      <input type="number" x-model="editableSettings[activeCategory][setting.setting_key]" class="form-input"
                        :step="setting.value_type === 'number' && String(setting.setting_value).includes('.') ? '0.01' : '1'">
                    </template>
                    <template x-if="!setting.is_readonly && !isCampaignSelectKey(setting.setting_key) && !isBooleanSetting(setting) && !isNumberSetting(setting) && isJsonSetting(setting)">
                      <textarea x-model="editableSettings[activeCategory][setting.setting_key]" class="form-textarea font-mono text-xs" rows="4" placeholder="JSON 格式"></textarea>
                    </template>
                    <template x-if="!setting.is_readonly && !isCampaignSelectKey(setting.setting_key) && !isBooleanSetting(setting) && !isNumberSetting(setting) && !isJsonSetting(setting)">
                      <input type="text" x-model="editableSettings[activeCategory][setting.setting_key]" class="form-input" :placeholder="setting.description || ''">
                    </template>
                  </div>
                </div>
              </div>
            </template>
          </div>

          <div class="flex justify-end mt-5 pt-4 border-t">
            <button @click="saveCategoryConfig(activeCategory)" :disabled="saving" class="btn-primary rounded-lg">
              <span x-show="!saving">💾 保存 <span x-text="categoryDisplay[activeCategory]?.name || ''"></span></span>
              <span x-show="saving">保存中...</span>
            </button>
          </div>
        </div>

        <div x-show="!categoryLoading && (!categorySettings[activeCategory] || categorySettings[activeCategory]?.length === 0)" class="empty-state-enhanced">
          <div class="empty-icon">📭</div>
          <div class="empty-title">暂无配置项</div>
          <div class="empty-desc">该分类下还没有配置项</div>
        </div>
      </div>
    </div>

    <!-- ==================== 提醒规则配置 ==================== -->
    <div x-show="current_page === 'reminder-rules'" x-cloak>
      <div class="themed-card rounded-xl shadow-sm border overflow-hidden">
        <div class="card-header-accent flex justify-between items-center">
          <div class="flex items-center gap-3">
            <div class="header-icon">🔔</div>
            <div>
              <h5 class="font-semibold themed-text">提醒规则配置</h5>
              <p class="text-xs themed-text-muted">配置业务告警和提醒触发条件</p>
            </div>
          </div>
          <button @click="openReminderRuleModal()" class="btn-primary btn-sm rounded-lg">➕ 新增规则</button>
        </div>
        <div x-data="reminderRulesTable()" x-init="init()">
          <div x-show="loading" class="p-12 text-center themed-text-muted">
            <div class="loading-spinner w-8 h-8 mb-3 mx-auto"></div>
            <p class="text-sm">加载中...</p>
          </div>
          <div x-show="hasError" class="p-8 text-center">
            <p class="text-red-500 mb-2" x-text="error"></p>
            <button @click="loadData()" class="btn-outline btn-sm rounded-lg">🔄 重试</button>
          </div>
          <div x-show="hasData" class="overflow-x-auto">
            <table class="table w-full">
              <thead>
                <tr>
                  <template x-for="col in columns" :key="col.key">
                    <th :class="{ 'cursor-pointer hover:text-blue-600': col.sortable }" @click="sort(col)">
                      <span x-text="col.label"></span>
                      <span x-show="col.sortable" class="ml-1 text-xs" x-text="getSortIcon(col)"></span>
                    </th>
                  </template>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="(row, idx) in data" :key="row.reminder_rule_id || idx">
                  <tr>
                    <template x-for="col in columns" :key="col.key">
                      <td x-html="renderCell(row, col)"></td>
                    </template>
                    <td>
                      <div class="flex items-center gap-2">
                        <button @click="$dispatch('edit-reminder-rule', row)" class="btn-outline btn-sm rounded">编辑</button>
                        <button @click="$dispatch('toggle-reminder-rule', row)" 
                          :class="row.is_enabled ? 'btn-warning' : 'btn-success'" class="btn-sm rounded"
                          x-text="row.is_enabled ? '禁用' : '启用'"></button>
                        <button @click="$dispatch('delete-reminder-rule', row)" class="btn-danger btn-sm rounded">删除</button>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <div x-show="isEmpty" class="empty-state-enhanced">
            <div class="empty-icon">🔔</div>
            <div class="empty-title">暂无提醒规则</div>
            <div class="empty-desc">点击"新增规则"创建您的第一条提醒规则</div>
          </div>
          <template x-if="total_pages > 1">
            <div class="p-4 border-t flex justify-between items-center">
              <span class="text-sm themed-text-muted" x-text="paginationInfo"></span>
              <div class="pagination">
                <button @click="prevPage()" :disabled="!hasPrevPage" class="pagination-btn">‹</button>
                <template x-for="p in visiblePages" :key="'pr'+p">
                  <button @click="goToPage(p)" :class="p === current_page ? 'active' : ''" class="pagination-btn" :disabled="p === '...'" x-text="p"></button>
                </template>
                <button @click="nextPage()" :disabled="!hasNextPage" class="pagination-btn">›</button>
              </div>
            </div>
          </template>
          <div x-show="lastUpdateTime" class="px-4 py-2 text-xs themed-text-muted text-right border-t">
            最后更新: <span x-text="lastUpdateTime"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== 审计日志 ==================== -->
    <div x-show="current_page === 'audit-logs'" x-cloak>
      <div class="themed-card rounded-xl shadow-sm border overflow-hidden">
        <div class="card-header-accent flex justify-between items-center">
          <div class="flex items-center gap-3">
            <div class="header-icon">📋</div>
            <div>
              <h5 class="font-semibold themed-text">审计日志</h5>
              <p class="text-xs themed-text-muted">记录所有管理员操作，支持追踪和回滚</p>
            </div>
          </div>
        </div>
        <div x-data="auditLogsTable()" x-init="init()">
          <div class="filter-bar mx-4 mt-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
              <input type="text" x-model="activeFilters.operator_id" placeholder="操作人" class="form-input">
              <select x-model="activeFilters.action" class="form-select">
                <option value="">全部操作</option>
                <option value="create">创建</option>
                <option value="update">更新</option>
                <option value="delete">删除</option>
              </select>
              <input type="date" x-model="activeFilters.start_date" class="form-input">
              <button @click="search()" class="btn-primary rounded-lg">🔍 搜索</button>
            </div>
          </div>
          <div x-show="loading" class="p-12 text-center themed-text-muted">
            <div class="loading-spinner w-8 h-8 mb-3 mx-auto"></div>
            <p class="text-sm">加载中...</p>
          </div>
          <div x-show="hasError" class="p-8 text-center">
            <p class="text-red-500 mb-2" x-text="error"></p>
            <button @click="loadData()" class="btn-outline btn-sm rounded-lg">🔄 重试</button>
          </div>
          <div x-show="hasData" class="overflow-x-auto px-4 pb-2">
            <table class="table w-full">
              <thead>
                <tr>
                  <template x-for="col in columns" :key="col.key">
                    <th :class="{ 'cursor-pointer hover:text-blue-600': col.sortable }" @click="sort(col)">
                      <span x-text="col.label"></span>
                      <span x-show="col.sortable" class="ml-1 text-xs" x-text="getSortIcon(col)"></span>
                    </th>
                  </template>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="(row, idx) in data" :key="row.id || idx">
                  <tr>
                    <template x-for="col in columns" :key="col.key">
                      <td x-html="renderCell(row, col)"></td>
                    </template>
                    <td>
                      <div class="flex items-center gap-2">
                        <button @click="$dispatch('view-audit-detail', row)" class="btn-outline btn-sm rounded">详情</button>
                        <template x-if="row.rollback_supported && row.rollback_status !== 'rolled_back'">
                          <button @click="$dispatch('rollback-audit', row)" class="btn-warning btn-sm rounded">回滚</button>
                        </template>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <div x-show="isEmpty" class="empty-state-enhanced">
            <div class="empty-icon">📋</div>
            <div class="empty-title">暂无审计日志数据</div>
            <div class="empty-desc">系统暂未记录到操作日志</div>
          </div>
          <template x-if="total_pages > 1">
            <div class="p-4 border-t flex justify-between items-center">
              <span class="text-sm themed-text-muted" x-text="paginationInfo"></span>
              <div class="pagination">
                <button @click="prevPage()" :disabled="!hasPrevPage" class="pagination-btn">‹</button>
                <template x-for="p in visiblePages" :key="'pal'+p">
                  <button @click="goToPage(p)" :class="p === current_page ? 'active' : ''" class="pagination-btn" :disabled="p === '...'" x-text="p"></button>
                </template>
                <button @click="nextPage()" :disabled="!hasNextPage" class="pagination-btn">›</button>
              </div>
            </div>
          </template>
          <div x-show="lastUpdateTime" class="px-4 py-2 text-xs themed-text-muted text-right border-t">
            最后更新: <span x-text="lastUpdateTime"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== 提醒规则编辑 Modal ==================== -->
    <div x-show="reminderRuleModalOpen" x-cloak class="fixed inset-0 z-50 flex items-center justify-center" style="display: none;">
      <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" @click="reminderRuleModalOpen = false"></div>
      <div class="relative themed-card rounded-xl shadow-2xl w-full max-w-lg mx-4 z-10 max-h-[90vh] flex flex-col animate-slide-in-up">
        <div class="p-5 border-b flex justify-between items-center shrink-0">
          <h5 class="font-semibold text-lg themed-text" x-text="editingRuleId ? '✏️ 编辑提醒规则' : '➕ 新增提醒规则'"></h5>
          <button @click="reminderRuleModalOpen = false" class="w-8 h-8 rounded-lg flex items-center justify-center themed-hover-bg text-gray-400 hover:text-gray-600 transition-colors">✕</button>
        </div>
        <div class="p-6 space-y-5 overflow-y-auto">
          <div>
            <label class="form-label">规则名称 <span class="text-red-500">*</span></label>
            <input type="text" x-model="reminderRuleForm.rule_name" placeholder="如：消费待审核超24小时提醒" class="form-input">
          </div>
          <div>
            <label class="form-label">规则类型 <span class="text-red-500">*</span></label>
            <select x-model="reminderRuleForm.rule_type" class="form-select">
              <option value="">请选择规则类型</option>
              <option value="budget_alert">预算告警</option>
              <option value="consumption_pending">消费待审核</option>
              <option value="win_rate_abnormal">中奖率异常</option>
              <option value="high_tier_win">高档位中奖</option>
              <option value="customer_service">客服咨询</option>
              <option value="risk_alert">风控告警</option>
            </select>
          </div>
          <div>
            <label class="form-label">规则描述</label>
            <input type="text" x-model="reminderRuleForm.rule_description" placeholder="规则的简要描述" class="form-input">
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="form-label">检查间隔（分钟）</label>
              <input type="number" x-model.number="reminderRuleForm.check_interval_minutes" min="1" placeholder="60" class="form-input">
            </div>
            <div>
              <label class="form-label">优先级</label>
              <select x-model="reminderRuleForm.notification_priority" class="form-select">
                <option value="low">🟢 低</option>
                <option value="medium">🟡 中</option>
                <option value="high">🔴 高</option>
              </select>
            </div>
          </div>
          <div>
            <label class="form-label">通知渠道</label>
            <div class="flex flex-wrap gap-4 mt-1">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" value="in_app" x-model="reminderRuleForm.notification_channels" class="form-checkbox">
                <span class="text-sm">站内通知</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" value="sms" x-model="reminderRuleForm.notification_channels" class="form-checkbox">
                <span class="text-sm">短信</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" value="email" x-model="reminderRuleForm.notification_channels" class="form-checkbox">
                <span class="text-sm">邮件</span>
              </label>
            </div>
          </div>
          <div class="flex items-center gap-3 p-3 rounded-lg" :class="reminderRuleForm.is_enabled ? 'bg-green-50 border border-green-200' : 'bg-gray-50 border border-gray-200'">
            <input type="checkbox" x-model="reminderRuleForm.is_enabled" class="form-checkbox">
            <div>
              <span class="text-sm font-medium" x-text="reminderRuleForm.is_enabled ? '🟢 规则已启用' : '⏸️ 规则已禁用'"></span>
              <p class="text-xs themed-text-muted">启用后将按设定的间隔自动检查触发条件</p>
            </div>
          </div>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-xl flex justify-end gap-3 shrink-0">
          <button @click="reminderRuleModalOpen = false" class="btn-secondary rounded-lg">取消</button>
          <button @click="saveReminderRule()" :disabled="saving" class="btn-primary rounded-lg">
            <span x-show="!saving">💾 保存</span>
            <span x-show="saving">保存中...</span>
          </button>
        </div>
      </div>
    </div>

    <!-- ==================== 审计日志详情 Modal ==================== -->
    <div x-ref="auditDetailModal" x-show="isModalOpen('auditDetailModal')" x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center" style="display: none;">
      <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" @click="hideModal('auditDetailModal')"></div>
      <div class="relative themed-card rounded-xl shadow-2xl w-full max-w-2xl mx-4 z-10 max-h-[80vh] overflow-y-auto animate-slide-in-up">
        <div class="p-5 border-b flex justify-between items-center sticky top-0 themed-card z-10">
          <h5 class="font-semibold text-lg themed-text">📋 审计日志详情</h5>
          <button @click="hideModal('auditDetailModal')" class="w-8 h-8 rounded-lg flex items-center justify-center themed-hover-bg text-gray-400 hover:text-gray-600 transition-colors">✕</button>
        </div>
        <div class="p-6" x-show="selectedLog">
          <div class="space-y-5">
            <div class="grid grid-cols-2 gap-4">
              <div class="p-3 rounded-lg themed-bg-base">
                <label class="block text-xs themed-text-muted mb-1">日志ID</label>
                <div class="font-mono text-sm font-medium" x-text="selectedLog?.log_id"></div>
              </div>
              <div class="p-3 rounded-lg themed-bg-base">
                <label class="block text-xs themed-text-muted mb-1">操作人</label>
                <div class="text-sm font-medium" x-text="selectedLog?.operator_name || selectedLog?.operator_id"></div>
              </div>
              <div class="p-3 rounded-lg themed-bg-base">
                <label class="block text-xs themed-text-muted mb-1">操作类型</label>
                <span class="badge badge-primary" x-text="selectedLog?.action"></span>
              </div>
              <div class="p-3 rounded-lg themed-bg-base">
                <label class="block text-xs themed-text-muted mb-1">操作时间</label>
                <div class="text-sm" x-text="formatDate(selectedLog?.created_at)"></div>
              </div>
              <div class="col-span-2 p-3 rounded-lg themed-bg-base">
                <label class="block text-xs themed-text-muted mb-1">目标对象</label>
                <div class="text-sm font-medium" x-text="selectedLog?.target || '-'"></div>
              </div>
            </div>
            <div x-show="selectedLog?.details">
              <label class="block text-xs themed-text-muted mb-2 font-medium">操作详情</label>
              <pre class="themed-bg-subtle p-4 rounded-lg text-xs overflow-x-auto border font-mono leading-relaxed" x-text="JSON.stringify(selectedLog?.details, null, 2)"></pre>
            </div>
            <div x-show="selectedLog?.ip_address" class="p-3 rounded-lg themed-bg-base">
              <label class="block text-xs themed-text-muted mb-1">IP地址</label>
              <div class="font-mono text-sm" x-text="selectedLog?.ip_address"></div>
            </div>
          </div>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-xl flex justify-end">
          <button @click="hideModal('auditDetailModal')" class="btn-secondary rounded-lg">关闭</button>
        </div>
      </div>
    </div>

  </div>

  <%- include('partials/footer') %>
  <script type="module" src="./src/modules/system/pages/system-settings.js"></script>
</body>
</html>
