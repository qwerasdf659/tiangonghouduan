<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '系统设置管理', 
    pageStyle: '[x-cloak] { display: none !important; }' 
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen">
  
  <!-- 导航栏 -->
  <nav class="themed-bg-primary text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="hover:text-yellow-200">← 返回工作台</a>
        <span class="text-lg font-semibold">⚙️ 系统设置管理</span>
      </div>
    </div>
  </nav>

  <!-- 页面主体 -->
  <div class="container mx-auto px-4 py-6" x-data="systemSettings()"
       @edit-reminder-rule="openReminderRuleModal($event.detail)"
       @toggle-reminder-rule="toggleReminderRule($event.detail)"
       @delete-reminder-rule="deleteReminderRule($event.detail)"
       @view-audit-detail="viewAuditLogDetail($event.detail)"
       @rollback-audit="rollbackOperation($event.detail)">
    
    <!-- 子页面导航（方案A：只显示系统配置和审计日志） -->
    <div class="themed-card rounded-lg shadow mb-6">
      <div class="flex border-b overflow-x-auto">
        <template x-for="page in subPages" :key="page.id">
          <button 
            @click="switchPage(page.id)"
            :class="current_page === page.id ? 'border-b-2 border-yellow-500 text-yellow-600 bg-yellow-50' : 'themed-text-muted themed-hover-bg'"
            class="px-6 py-3 font-medium whitespace-nowrap transition-colors"
            x-text="page.icon + ' ' + page.name"
          ></button>
        </template>
      </div>
    </div>

    <!-- 系统配置 -->
    <div x-show="current_page === 'system-config'" x-cloak>
      <div class="themed-card rounded-lg shadow p-6">
        <h5 class="font-semibold mb-4">系统配置</h5>
        <div class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-2">系统名称</label>
              <input type="text" x-model="systemConfig.site_name" class="w-full px-3 py-2 border rounded">
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-2">维护模式</label>
              <select x-model="systemConfig.maintenance_mode" class="w-full px-3 py-2 border rounded">
                <option value="false">关闭</option>
                <option value="true">开启</option>
              </select>
            </div>
          </div>
          <div class="flex justify-end">
            <button @click="saveSystemConfig()" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">保存配置</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 提醒规则配置 (P2-1) -->
    <div x-show="current_page === 'reminder-rules'" x-cloak>
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold">🔔 提醒规则配置</h5>
          <button @click="openReminderRuleModal()" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">
            ➕ 新增规则
          </button>
        </div>
        <!-- data-table: 提醒规则列表 -->
        <div x-data="reminderRulesTable()" x-init="init()">
          <div x-show="loading" class="p-8 text-center themed-text-muted">加载中...</div>
          <div x-show="hasError" class="p-8 text-center">
            <p class="text-red-500 mb-2" x-text="error"></p>
            <button @click="loadData()" class="text-sm themed-text-primary hover:underline">🔄 重试</button>
          </div>
          <div x-show="hasData" class="overflow-x-auto">
            <table class="w-full">
              <thead class="themed-bg-base">
                <tr>
                  <template x-for="col in columns" :key="col.key">
                    <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted"
                        :class="{ 'cursor-pointer hover:text-blue-600': col.sortable }"
                        @click="sort(col)">
                      <span x-text="col.label"></span>
                      <span x-show="col.sortable" class="ml-1 text-xs" x-text="getSortIcon(col)"></span>
                    </th>
                  </template>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                <template x-for="(row, idx) in data" :key="row.reminder_rule_id || idx">
                  <tr class="themed-hover-bg">
                    <template x-for="col in columns" :key="col.key">
                      <td class="px-4 py-3 text-sm" x-html="renderCell(row, col)"></td>
                    </template>
                    <td class="px-4 py-3">
                      <div class="flex space-x-2 text-sm">
                        <button @click="$dispatch('edit-reminder-rule', row)" class="text-blue-500 hover:text-blue-700">编辑</button>
                        <button @click="$dispatch('toggle-reminder-rule', row)" :class="row.is_enabled ? 'text-yellow-500 hover:text-yellow-700' : 'text-green-500 hover:text-green-700'" x-text="row.is_enabled ? '禁用' : '启用'"></button>
                        <button @click="$dispatch('delete-reminder-rule', row)" class="text-red-500 hover:text-red-700">删除</button>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <div x-show="isEmpty" class="p-8 text-center themed-text-muted">暂无提醒规则</div>
          <template x-if="total_pages > 1">
            <div class="p-4 border-t flex justify-between items-center">
              <span class="text-sm themed-text-muted" x-text="paginationInfo"></span>
              <div class="flex space-x-1">
                <button @click="prevPage()" :disabled="!hasPrevPage" class="px-3 py-1 text-sm border rounded disabled:opacity-50 themed-hover-bg">‹</button>
                <template x-for="p in visiblePages" :key="'pr'+p">
                  <button @click="goToPage(p)" :class="p === current_page ? 'bg-yellow-500 text-white' : 'themed-hover-bg'" class="px-3 py-1 text-sm border rounded" :disabled="p === '...'" x-text="p"></button>
                </template>
                <button @click="nextPage()" :disabled="!hasNextPage" class="px-3 py-1 text-sm border rounded disabled:opacity-50 themed-hover-bg">›</button>
              </div>
            </div>
          </template>
          <div x-show="lastUpdateTime" class="px-4 py-2 text-xs themed-text-muted text-right border-t">
            最后更新: <span x-text="lastUpdateTime"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- 审计日志 -->
    <div x-show="current_page === 'audit-logs'" x-cloak>
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">审计日志</h5>
        </div>
        <!-- data-table: 审计日志列表（含筛选） -->
        <div x-data="auditLogsTable()" x-init="init()">
          <div class="p-4 border-b themed-bg-base">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <input type="text" x-model="activeFilters.operator_id" placeholder="操作人" class="px-3 py-2 border rounded">
              <select x-model="activeFilters.action" class="px-3 py-2 border rounded">
                <option value="">全部操作</option>
                <option value="create">创建</option>
                <option value="update">更新</option>
                <option value="delete">删除</option>
              </select>
              <input type="date" x-model="activeFilters.start_date" class="px-3 py-2 border rounded">
              <button @click="search()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">🔍 搜索</button>
            </div>
          </div>
          <div x-show="loading" class="p-8 text-center themed-text-muted">加载中...</div>
          <div x-show="hasError" class="p-8 text-center">
            <p class="text-red-500 mb-2" x-text="error"></p>
            <button @click="loadData()" class="text-sm themed-text-primary hover:underline">🔄 重试</button>
          </div>
          <div x-show="hasData" class="overflow-x-auto">
            <table class="w-full">
              <thead class="themed-bg-base">
                <tr>
                  <template x-for="col in columns" :key="col.key">
                    <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted"
                        :class="{ 'cursor-pointer hover:text-blue-600': col.sortable }"
                        @click="sort(col)">
                      <span x-text="col.label"></span>
                      <span x-show="col.sortable" class="ml-1 text-xs" x-text="getSortIcon(col)"></span>
                    </th>
                  </template>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                <template x-for="(row, idx) in data" :key="row.id || idx">
                  <tr class="themed-hover-bg">
                    <template x-for="col in columns" :key="col.key">
                      <td class="px-4 py-3 text-sm" x-html="renderCell(row, col)"></td>
                    </template>
                    <td class="px-4 py-3 text-sm">
                      <div class="flex space-x-2">
                        <button @click="$dispatch('view-audit-detail', row)" class="themed-text-primary hover:underline">详情</button>
                        <template x-if="row.rollback_supported && row.rollback_status !== 'rolled_back'">
                          <button @click="$dispatch('rollback-audit', row)" class="text-orange-500 hover:text-orange-700">回滚</button>
                        </template>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <div x-show="isEmpty" class="p-8 text-center themed-text-muted">暂无审计日志数据</div>
          <template x-if="total_pages > 1">
            <div class="p-4 border-t flex justify-between items-center">
              <span class="text-sm themed-text-muted" x-text="paginationInfo"></span>
              <div class="flex space-x-1">
                <button @click="prevPage()" :disabled="!hasPrevPage" class="px-3 py-1 text-sm border rounded disabled:opacity-50 themed-hover-bg">‹</button>
                <template x-for="p in visiblePages" :key="'pal'+p">
                  <button @click="goToPage(p)" :class="p === current_page ? 'themed-bg-primary text-white' : 'themed-hover-bg'" class="px-3 py-1 text-sm border rounded" :disabled="p === '...'" x-text="p"></button>
                </template>
                <button @click="nextPage()" :disabled="!hasNextPage" class="px-3 py-1 text-sm border rounded disabled:opacity-50 themed-hover-bg">›</button>
              </div>
            </div>
          </template>
          <div x-show="lastUpdateTime" class="px-4 py-2 text-xs themed-text-muted text-right border-t">
            最后更新: <span x-text="lastUpdateTime"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== Modal 组件区域（必须在 x-data 作用域内） ==================== -->

    <!-- 提醒规则编辑 Modal (P2-1) -->
    <div x-show="reminderRuleModalOpen"
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center"
       style="display: none;">
    <div class="fixed inset-0 bg-black/50" @click="reminderRuleModalOpen = false"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-lg mx-4 z-10 max-h-[90vh] flex flex-col">
      <div class="p-4 border-b flex justify-between items-center shrink-0">
        <h5 class="font-semibold" x-text="editingRuleId ? '编辑提醒规则' : '新增提醒规则'"></h5>
        <button @click="reminderRuleModalOpen = false" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
      </div>
      <div class="p-6 space-y-4 overflow-y-auto">
        <div>
          <label class="block text-sm font-medium themed-text-secondary mb-2">规则名称 *</label>
          <input type="text" x-model="reminderRuleForm.rule_name" placeholder="如：消费待审核超24小时提醒" class="w-full px-3 py-2 border rounded">
        </div>
        <div>
          <label class="block text-sm font-medium themed-text-secondary mb-2">规则类型 *</label>
          <select x-model="reminderRuleForm.rule_type" class="w-full px-3 py-2 border rounded">
            <option value="">请选择规则类型</option>
            <option value="budget_alert">预算告警</option>
            <option value="consumption_pending">消费待审核</option>
            <option value="win_rate_abnormal">中奖率异常</option>
            <option value="high_tier_win">高档位中奖</option>
            <option value="customer_service">客服咨询</option>
            <option value="risk_alert">风控告警</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium themed-text-secondary mb-2">规则描述</label>
          <input type="text" x-model="reminderRuleForm.rule_description" placeholder="规则的简要描述" class="w-full px-3 py-2 border rounded">
        </div>
        <div>
          <label class="block text-sm font-medium themed-text-secondary mb-2">检查间隔（分钟）</label>
          <input type="number" x-model.number="reminderRuleForm.check_interval_minutes" min="1" placeholder="60" class="w-full px-3 py-2 border rounded">
        </div>
        <div>
          <label class="block text-sm font-medium themed-text-secondary mb-2">优先级</label>
          <select x-model="reminderRuleForm.notification_priority" class="w-full px-3 py-2 border rounded">
            <option value="low">低</option>
            <option value="medium">中</option>
            <option value="high">高</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium themed-text-secondary mb-2">通知渠道</label>
          <div class="flex space-x-4">
            <label class="flex items-center">
              <input type="checkbox" value="in_app" x-model="reminderRuleForm.notification_channels" class="mr-2">
              <span class="text-sm">站内通知</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" value="sms" x-model="reminderRuleForm.notification_channels" class="mr-2">
              <span class="text-sm">短信</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" value="email" x-model="reminderRuleForm.notification_channels" class="mr-2">
              <span class="text-sm">邮件</span>
            </label>
          </div>
        </div>
        <div>
          <label class="flex items-center">
            <input type="checkbox" x-model="reminderRuleForm.is_enabled" class="mr-2">
            <span class="text-sm">启用规则</span>
          </label>
        </div>
      </div>
      <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-3 shrink-0">
        <button @click="reminderRuleModalOpen = false" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded-lg hover:bg-gray-300">取消</button>
        <button @click="saveReminderRule()" :disabled="saving" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 disabled:opacity-50">
          <span x-show="!saving">保存</span>
          <span x-show="saving">保存中...</span>
        </button>
      </div>
    </div>

    <!-- 审计日志详情 Modal -->
    <div x-ref="auditDetailModal"
         x-show="isModalOpen('auditDetailModal')"
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('auditDetailModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-2xl mx-4 z-10 max-h-[80vh] overflow-y-auto">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 themed-card">
          <h5 class="font-semibold">📋 审计日志详情</h5>
          <button @click="hideModal('auditDetailModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <div class="p-6" x-show="selectedLog">
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs themed-text-muted mb-1">日志ID</label>
                <div class="font-mono" x-text="selectedLog?.log_id"></div>
              </div>
              <div>
                <label class="block text-xs themed-text-muted mb-1">操作人</label>
                <div x-text="selectedLog?.operator_name || selectedLog?.operator_id"></div>
              </div>
              <div>
                <label class="block text-xs themed-text-muted mb-1">操作类型</label>
                <span class="px-2 py-1 text-xs rounded themed-bg-primary-light themed-text-primary" x-text="selectedLog?.action"></span>
              </div>
              <div>
                <label class="block text-xs themed-text-muted mb-1">操作时间</label>
                <div x-text="formatDate(selectedLog?.created_at)"></div>
              </div>
              <div class="col-span-2">
                <label class="block text-xs themed-text-muted mb-1">目标对象</label>
                <div x-text="selectedLog?.target || '-'"></div>
              </div>
            </div>
            <div x-show="selectedLog?.details">
              <label class="block text-xs themed-text-muted mb-2">操作详情</label>
              <pre class="themed-bg-subtle p-3 rounded text-sm overflow-x-auto" x-text="JSON.stringify(selectedLog?.details, null, 2)"></pre>
            </div>
            <div x-show="selectedLog?.ip_address">
              <label class="block text-xs themed-text-muted mb-1">IP地址</label>
              <div class="font-mono" x-text="selectedLog?.ip_address"></div>
            </div>
          </div>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end">
          <button @click="hideModal('auditDetailModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded-lg hover:bg-gray-300">关闭</button>
        </div>
      </div>
    </div>

  </div>

  <!-- 页面专属逻辑 -->
  <%- include('partials/footer') %>


  <script type="module" src="./src/modules/system/pages/system-settings.js"></script>
</body>
</html>

