<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '系统设置管理', 
    pageStyle: '[x-cloak] { display: none !important; }' 
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen">
  
  <!-- 导航栏 -->
  <nav class="themed-bg-primary text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="hover:text-yellow-200">← 返回工作台</a>
        <span class="text-lg font-semibold">⚙️ 系统设置管理</span>
      </div>
    </div>
  </nav>

  <!-- 页面主体 -->
  <div class="container mx-auto px-4 py-6" x-data="systemSettings()">
    
    <!-- 子页面导航 -->
    <div class="themed-card rounded-lg shadow mb-6">
      <div class="flex border-b overflow-x-auto">
        <template x-for="page in subPages" :key="page.id">
          <button 
            @click="switchPage(page.id)"
            :class="currentPage === page.id ? 'border-b-2 border-yellow-500 text-yellow-600 bg-yellow-50' : 'themed-text-muted themed-hover-bg'"
            class="px-6 py-3 font-medium whitespace-nowrap transition-colors"
            x-text="page.icon + ' ' + page.name"
          ></button>
        </template>
      </div>
    </div>

    <!-- 系统配置 -->
    <div x-show="currentPage === 'system-config'" x-cloak>
      <div class="themed-card rounded-lg shadow p-6">
        <h5 class="font-semibold mb-4">系统配置</h5>
        <div class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-2">系统名称</label>
              <input type="text" x-model="systemConfig.site_name" class="w-full px-3 py-2 border rounded">
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-2">维护模式</label>
              <select x-model="systemConfig.maintenance_mode" class="w-full px-3 py-2 border rounded">
                <option value="false">关闭</option>
                <option value="true">开启</option>
              </select>
            </div>
          </div>
          <div class="flex justify-end">
            <button @click="saveSystemConfig()" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">保存配置</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 字典管理 -->
    <div x-show="currentPage === 'dict-management'" x-cloak>
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold">字典管理</h5>
          <button @click="openCreateDictModal()" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">
            ➕ 新增字典
          </button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="themed-bg-base">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">字典代码</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">字典名称</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">描述</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <template x-if="dictList.length === 0">
                <tr><td colspan="4" class="px-4 py-8 text-center themed-text-muted">暂无字典数据</td></tr>
              </template>
              <template x-for="(dict, index) in dictList" :key="getDictCode(dict) || index">
                <tr class="themed-hover-bg">
                  <td class="px-4 py-3 text-sm font-mono" x-text="getDictCode(dict)"></td>
                  <td class="px-4 py-3 text-sm" x-text="getDictName(dict)"></td>
                  <td class="px-4 py-3 text-sm themed-text-muted" x-text="dict.description || '-'"></td>
                  <td class="px-4 py-3">
                    <div class="flex space-x-2">
                      <button @click="editDict(dict)" class="text-green-500 hover:text-green-700 text-sm">编辑</button>
                      <button @click="deleteDict(dict)" class="text-red-500 hover:text-red-700 text-sm">删除</button>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 功能开关 -->
    <div x-show="currentPage === 'feature-flags'" x-cloak>
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold">🎚️ 功能开关管理</h5>
          <button @click="openCreateFlagModal()" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">
            ➕ 新增开关
          </button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="themed-bg-base">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">功能键名</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">功能名称</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">发布策略</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">状态</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <template x-if="featureFlags.length === 0">
                <tr><td colspan="5" class="px-4 py-8 text-center themed-text-muted">暂无功能开关数据</td></tr>
              </template>
              <template x-for="flag in featureFlags" :key="flag.flag_key">
                <tr class="themed-hover-bg">
                  <td class="px-4 py-3 text-sm font-mono themed-text-muted" x-text="flag.flag_key"></td>
                  <td class="px-4 py-3 text-sm">
                    <div x-text="flag.flag_name || '-'" class="font-medium"></div>
                    <div x-text="flag.description || ''" class="text-xs text-gray-400 truncate max-w-xs" x-show="flag.description"></div>
                  </td>
                  <td class="px-4 py-3 text-sm">
                    <span class="px-2 py-1 text-xs rounded" 
                          :class="getStrategyClass(flag.rollout_strategy)"
                          x-text="getStrategyText(flag.rollout_strategy) + (flag.rollout_strategy === 'percentage' ? ' (' + flag.rollout_percentage + '%)' : '')">
                    </span>
                  </td>
                  <td class="px-4 py-3">
                    <button @click="toggleFeatureFlag(flag)" 
                            :class="flag.is_enabled ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-300 hover:bg-gray-400'"
                            class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full transition-colors duration-200">
                      <span :class="flag.is_enabled ? 'translate-x-5' : 'translate-x-0'"
                            class="inline-block h-5 w-5 transform rounded-full themed-card shadow mt-0.5 ml-0.5 transition-transform duration-200"></span>
                    </button>
                  </td>
                  <td class="px-4 py-3">
                    <div class="flex space-x-2">
                      <button @click="editFeatureFlag(flag)" class="text-green-500 hover:text-green-700 text-sm">编辑</button>
                      <button @click="deleteFeatureFlag(flag)" class="text-red-500 hover:text-red-700 text-sm">删除</button>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 审计日志 -->
    <div x-show="currentPage === 'audit-logs'" x-cloak>
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">审计日志</h5>
        </div>
        <div class="p-4 border-b themed-bg-base">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <input type="text" x-model="logFilters.operator_id" placeholder="操作人" class="px-3 py-2 border rounded">
            <select x-model="logFilters.action" class="px-3 py-2 border rounded">
              <option value="">全部操作</option>
              <option value="create">创建</option>
              <option value="update">更新</option>
              <option value="delete">删除</option>
            </select>
            <input type="date" x-model="logFilters.startDate" class="px-3 py-2 border rounded">
            <button @click="loadAuditLogs()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">🔍 搜索</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="themed-bg-base">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">日志ID</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作人</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作类型</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">目标</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">时间</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <template x-if="auditLogs.length === 0">
                <tr><td colspan="5" class="px-4 py-8 text-center themed-text-muted">暂无审计日志数据</td></tr>
              </template>
              <template x-for="(log, index) in auditLogs" :key="log.id || index">
                <tr class="themed-hover-bg">
                  <td class="px-4 py-3 text-sm font-mono themed-text-muted" x-text="log.id || '-'"></td>
                  <td class="px-4 py-3 text-sm" x-text="log.operator_info?.nickname || log.operator_id || '-'"></td>
                  <td class="px-4 py-3 text-sm">
                    <span class="px-2 py-1 text-xs rounded themed-bg-primary-light themed-text-primary" x-text="log.action_name || log.action || '-'"></span>
                  </td>
                  <td class="px-4 py-3 text-sm themed-text-muted" x-text="log.operation_type_name || log.target || '-'"></td>
                  <td class="px-4 py-3 text-sm themed-text-muted" x-text="formatDate(log.created_at)"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 积分配置（原定价配置）- 使用后端 points 分类 -->
    <div x-show="currentPage === 'pricing-config'" x-cloak>
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">💰 积分配置</h5>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-2">抽奖消耗积分</label>
              <input type="number" x-model.number="pointsDefaults.lottery_cost_points" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-yellow-500" placeholder="100" min="0">
              <p class="text-xs themed-text-muted mt-1">每次抽奖需要消耗的积分数</p>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-2">每日抽奖次数限制</label>
              <input type="number" x-model.number="pointsDefaults.daily_lottery_limit" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-yellow-500" placeholder="10" min="1">
              <p class="text-xs themed-text-muted mt-1">用户每天可抽奖的最大次数</p>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-2">签到积分</label>
              <input type="number" x-model.number="pointsDefaults.sign_in_points" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-yellow-500" placeholder="10" min="0">
              <p class="text-xs themed-text-muted mt-1">用户每日签到可获得的积分数</p>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-2">新用户初始积分</label>
              <input type="number" x-model.number="pointsDefaults.initial_points" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-yellow-500" placeholder="0" min="0">
              <p class="text-xs themed-text-muted mt-1">新注册用户的初始积分数</p>
            </div>
          </div>
          <div class="mt-6 flex justify-end">
            <button @click="savePointsConfigs()" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600" :disabled="saving">
              <span x-show="saving" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>
              保存积分配置
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- ==================== Modal 组件区域 ==================== -->

  <!-- 1. 字典表单 Modal -->
  <div x-ref="dictModal"
       x-show="isModalOpen('dictModal')"
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center"
       style="display: none;">
    <div class="fixed inset-0 bg-black/50" @click="hideModal('dictModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-md mx-4 z-10">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">📖 <span x-text="isEditDict ? '编辑字典' : '新增字典'"></span></h5>
        <button @click="hideModal('dictModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
      </div>
      <form @submit.prevent="submitDictForm()">
        <div class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">字典代码 <span class="text-red-500">*</span></label>
            <!-- 根据当前字典类型绑定对应的代码字段 -->
            <input type="text" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500" 
                   x-model="dictForm[getCurrentDictConfig().codeField]" 
                   :disabled="isEditDict" 
                   required
                   placeholder="如: electronics, food_drink">
            <p class="text-xs themed-text-muted mt-1" x-show="!isEditDict">snake_case格式，创建后不可修改</p>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">显示名称 <span class="text-red-500">*</span></label>
            <input type="text" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500" 
                   x-model="dictForm.display_name" 
                   required
                   placeholder="如: 电子产品、餐饮美食">
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">描述</label>
            <textarea class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500" 
                      x-model="dictForm.description" 
                      rows="3" 
                      placeholder="字典描述..."></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">排序顺序</label>
            <input type="number" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500" 
                   x-model.number="dictForm.sort_order" 
                   min="0"
                   placeholder="0">
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="dictEnabled" x-model="dictForm.is_enabled" class="mr-2 rounded">
            <label for="dictEnabled" class="text-sm font-medium themed-text-secondary">启用</label>
          </div>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-3">
          <button type="button" @click="hideModal('dictModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded-lg hover:bg-gray-300">取消</button>
          <button type="submit" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 disabled:opacity-50" :disabled="saving">
            <span x-show="saving" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>
            <span x-text="isEditDict ? '保存修改' : '创建字典'"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 2. 功能开关表单 Modal -->
  <div x-ref="featureFlagModal"
       x-show="isModalOpen('featureFlagModal')"
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center"
       style="display: none;">
    <div class="fixed inset-0 bg-black/50" @click="hideModal('featureFlagModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-md mx-4 z-10">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">🎚️ <span x-text="editingFlagKey ? '编辑功能开关' : '新增功能开关'"></span></h5>
        <button @click="hideModal('featureFlagModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
      </div>
      <form @submit.prevent="saveFeatureFlag()">
        <div class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">功能键名 <span class="text-red-500">*</span></label>
            <input type="text" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500" 
                   x-model="featureFlagForm.flag_key" :disabled="editingFlagKey" required
                   placeholder="如: lottery_pity_system">
            <p class="text-xs themed-text-muted mt-1" x-show="!editingFlagKey">唯一标识，小写字母开头，仅允许小写字母、数字、下划线</p>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">功能名称 <span class="text-red-500">*</span></label>
            <input type="text" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500" 
                   x-model="featureFlagForm.flag_name" required
                   placeholder="如: 抽奖保底系统">
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">功能描述</label>
            <textarea class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500" 
                      x-model="featureFlagForm.description" rows="2" placeholder="功能开关描述..."></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">发布策略</label>
            <select class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500" 
                    x-model="featureFlagForm.rollout_strategy">
              <option value="all">全量发布</option>
              <option value="percentage">按比例发布</option>
              <option value="whitelist">白名单</option>
              <option value="blacklist">黑名单</option>
            </select>
          </div>
          <div x-show="featureFlagForm.rollout_strategy === 'percentage'">
            <label class="block text-sm font-medium themed-text-secondary mb-1">发布比例 (%)</label>
            <input type="number" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500" 
                   x-model="featureFlagForm.rollout_percentage" min="0" max="100" placeholder="50">
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="flagEnabled" x-model="featureFlagForm.is_enabled" class="mr-2">
            <label for="flagEnabled" class="text-sm font-medium themed-text-secondary">立即启用</label>
          </div>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-3">
          <button type="button" @click="hideModal('featureFlagModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded-lg hover:bg-gray-300">取消</button>
          <button type="submit" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 disabled:opacity-50" :disabled="saving">
            <span x-show="saving" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>
            <span x-text="editingFlagKey ? '保存修改' : '创建开关'"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 3. 审计日志详情 Modal -->
  <div x-ref="auditDetailModal"
       x-show="isModalOpen('auditDetailModal')"
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center"
       style="display: none;">
    <div class="fixed inset-0 bg-black/50" @click="hideModal('auditDetailModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-2xl mx-4 z-10 max-h-[80vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center sticky top-0 themed-card">
        <h5 class="font-semibold">📋 审计日志详情</h5>
        <button @click="hideModal('auditDetailModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
      </div>
      <div class="p-6" x-show="selectedLog">
        <div class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs themed-text-muted mb-1">日志ID</label>
              <div class="font-mono" x-text="selectedLog?.log_id"></div>
            </div>
            <div>
              <label class="block text-xs themed-text-muted mb-1">操作人</label>
              <div x-text="selectedLog?.operator_name || selectedLog?.operator_id"></div>
            </div>
            <div>
              <label class="block text-xs themed-text-muted mb-1">操作类型</label>
              <span class="px-2 py-1 text-xs rounded themed-bg-primary-light themed-text-primary" x-text="selectedLog?.action"></span>
            </div>
            <div>
              <label class="block text-xs themed-text-muted mb-1">操作时间</label>
              <div x-text="formatDate(selectedLog?.created_at)"></div>
            </div>
            <div class="col-span-2">
              <label class="block text-xs themed-text-muted mb-1">目标对象</label>
              <div x-text="selectedLog?.target || '-'"></div>
            </div>
          </div>
          <div x-show="selectedLog?.details">
            <label class="block text-xs themed-text-muted mb-2">操作详情</label>
            <pre class="themed-bg-subtle p-3 rounded text-sm overflow-x-auto" x-text="JSON.stringify(selectedLog?.details, null, 2)"></pre>
          </div>
          <div x-show="selectedLog?.ip_address">
            <label class="block text-xs themed-text-muted mb-1">IP地址</label>
            <div class="font-mono" x-text="selectedLog?.ip_address"></div>
          </div>
        </div>
      </div>
      <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end">
        <button @click="hideModal('auditDetailModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded-lg hover:bg-gray-300">关闭</button>
      </div>
    </div>
  </div>

  <!-- 页面专属逻辑 -->
  <%- include('partials/footer') %>


  <script type="module" src="./src/modules/system/pages/system-settings.js"></script>
</body>
</html>

