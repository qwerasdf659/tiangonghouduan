<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '内容管理中心', 
    pageStyle: '[x-cloak] { display: none !important; }' 
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen">
  
  <!-- 导航栏 -->
  <nav class="themed-bg-primary text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="hover:text-blue-200 transition-colors">← 返回工作台</a>
        <span class="text-lg font-semibold">📄 内容管理中心</span>
      </div>
    </div>
  </nav>

  <!-- 页面主体 -->
  <div class="container mx-auto px-4 py-6" x-data="contentManagement()" x-init="init()">

    <!-- 统计概览卡片 -->
    <div class="stats-grid stats-grid-2 mb-6">
      <div class="stats-card stats-warning stats-card-animate">
        <div class="stats-card-icon">🖼️</div>
        <div class="stats-card-value" x-text="imageStats?.total || 0"></div>
        <div class="stats-card-label">图片资源</div>
      </div>
      <div class="stats-card stats-info stats-card-animate">
        <div class="stats-card-icon">📢</div>
        <div class="stats-card-label">
          公告/弹窗/轮播管理已合并到
          <a href="/admin/ad-management.html" class="underline text-blue-300 hover:text-white">内容投放管理</a>
        </div>
      </div>
    </div>

    <!-- 子页面导航 -->
    <div class="themed-card rounded-xl shadow-sm mb-6 overflow-hidden">
      <div class="flex overflow-x-auto" style="scrollbar-width: none;">
        <template x-for="page in subPages" :key="page.id">
          <button 
            @click="switchPage(page.id)"
            :class="current_page === page.id 
              ? 'border-b-2 border-blue-500 text-blue-600 bg-blue-50/60 font-semibold dark:bg-blue-900/10 dark:text-blue-400' 
              : 'themed-text-muted themed-hover-bg border-b-2 border-transparent'"
            class="px-6 py-3.5 font-medium whitespace-nowrap transition-all duration-200 relative"
            x-text="page.icon + ' ' + page.name"
          ></button>
        </template>
      </div>
    </div>

    <!-- 图片资源管理 -->
    <div x-show="current_page === 'image-resources'" x-cloak>
      <div class="themed-card rounded-xl shadow-sm overflow-hidden">
        <div class="p-5 border-b flex justify-between items-center bg-gradient-to-r from-amber-50 to-transparent dark:from-amber-900/10">
          <div>
            <h5 class="font-semibold text-base">🖼️ 图片资源</h5>
            <p class="text-xs themed-text-muted mt-0.5">统一管理系统中的图片素材，支持分类筛选和批量操作</p>
          </div>
          <button @click="showModal('uploadImageModal')" class="px-4 py-2 themed-btn-primary rounded-lg shadow-sm hover:shadow transition-shadow">
            ➕ 上传图片
          </button>
        </div>

        <div x-show="images.length === 0" class="empty-state">
          <div class="empty-state-icon-circle">
            <div class="empty-state-icon">🖼️</div>
          </div>
          <div class="empty-state-title">暂无图片资源</div>
          <div class="empty-state-description">上传图片素材统一管理，所有轮播图、弹窗使用的图片都会在这里归档和检索</div>
          <button @click="showModal('uploadImageModal')" class="empty-state-action">➕ 上传第一张图片</button>
          <div class="empty-state-tips">
            <div class="empty-state-tips-title">💡 使用提示</div>
            <div>· 支持 JPG/PNG/GIF/WebP 格式，单张不超过 5MB</div>
            <div>· 上传后自动生成 3 种缩略图尺寸（150/300/600px）</div>
            <div>· 图片可绑定到具体业务（抽奖、交易、活动等）</div>
            <div>· 点击图片可预览、复制链接或删除</div>
          </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 p-4" x-show="images.length > 0">
          <template x-for="image in images" :key="image.image_resource_id">
            <div class="themed-card rounded-xl overflow-hidden group relative shadow-sm hover:shadow-md transition-all duration-200">
              <div class="aspect-square themed-bg-subtle flex items-center justify-center img-blur-load">
                <img :data-src="image.url" :alt="image.original_filename" 
                     class="w-full h-full object-cover img-lazy"
                     x-init="$nextTick(() => { if(image.url) { $el.src = image.url; $el.classList.add('loaded') } })">
              </div>
              <div class="p-2.5">
                <p class="text-xs font-medium truncate" x-text="image.original_filename || '未命名'"></p>
                <p class="text-xs themed-text-muted mt-0.5" x-text="formatFileSize(image.file_size)"></p>
              </div>
              <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center space-x-2 rounded-xl">
                <button @click="viewImage(image)" class="px-3 py-1.5 bg-white text-gray-700 rounded-lg text-xs font-medium shadow-sm hover:bg-gray-50 transition-colors">查看</button>
                <button @click="deleteImage(image)" class="px-3 py-1.5 bg-red-500 text-white rounded-lg text-xs font-medium shadow-sm hover:bg-red-600 transition-colors">删除</button>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>

    <!-- ==================== Modal 区域 ==================== -->

    <!-- 图片上传 Modal -->
    <div x-ref="uploadImageModal" 
         x-show="isModalOpen('uploadImageModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('uploadImageModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-md mx-4 z-10">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold">📤 上传图片</h5>
          <button @click="hideModal('uploadImageModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <div class="p-6" x-data="{ dragover: false }">
          <div class="drop-zone p-8 text-center transition-colors"
               :class="{ 'drag-over': dragover }"
               @dragover.prevent="dragover = true"
               @dragleave="dragover = false"
               @drop.prevent="dragover = false; handleImageUpload($event)">
            <span class="text-5xl mb-4 block" x-text="dragover ? '📥' : '☁️'"></span>
            <p class="mb-2" x-text="dragover ? '释放以上传图片' : '拖拽图片到此处或点击上传'"></p>
            <input type="file" class="hidden" id="imageUploadInput" accept="image/*" multiple @change="handleImageUpload($event)">
            <button type="button" onclick="document.getElementById('imageUploadInput').click()" class="px-4 py-2 themed-btn-primary rounded btn-scale">
              选择图片
            </button>
          </div>
          <p class="text-sm themed-text-muted mt-2 text-center">支持 JPG、PNG、GIF 格式，单张最大 5MB</p>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end">
          <button type="button" @click="hideModal('uploadImageModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">关闭</button>
        </div>
      </div>
    </div>

    <!-- 删除确认 Modal -->
    <div x-ref="deleteModal" 
         x-show="isModalOpen('deleteModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('deleteModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-sm mx-4 z-10">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold text-red-600">⚠️ 删除确认</h5>
          <button @click="hideModal('deleteModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <div class="p-6 text-center">
          <span class="text-5xl mb-4 block">🗑️</span>
          <p class="themed-text-secondary">确定要删除此图片吗？</p>
          <p class="text-sm themed-text-muted mt-1">此操作不可撤销</p>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-2">
          <button type="button" @click="hideModal('deleteModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">取消</button>
          <button type="button" @click="confirmDelete()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600" :disabled="deleting">
            <span x-show="deleting" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-1"></span>
            确认删除
          </button>
        </div>
      </div>
    </div>

  </div>

  <!-- 页面专属逻辑 -->
  <%- include('partials/footer') %>

  <script type="module" src="./src/modules/content/pages/content-management.js"></script>
</body>
</html>
