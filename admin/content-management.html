<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '内容管理中心', 
    pageStyle: '[x-cloak] { display: none !important; }' 
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen">
  
  <!-- 导航栏 -->
  <nav class="themed-bg-primary text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="hover:text-blue-200 transition-colors">← 返回工作台</a>
        <span class="text-lg font-semibold">📄 内容管理中心</span>
      </div>
    </div>
  </nav>

  <!-- 页面主体 -->
  <div class="container mx-auto px-4 py-6" x-data="contentManagement()" x-init="init()"
       @edit-announcement="editAnnouncement($event.detail)"
       @delete-announcement="deleteAnnouncement($event.detail)">

    <!-- 统计概览卡片 -->
    <div class="stats-grid stats-grid-4 mb-6">
      <div class="stats-card stats-primary stats-card-animate">
        <div class="stats-card-icon">📢</div>
        <div class="stats-card-value" x-text="announcementStats?.total || 0"></div>
        <div class="stats-card-label">公告总数</div>
      </div>
      <div class="stats-card stats-info stats-card-animate">
        <div class="stats-card-icon">🔔</div>
        <div class="stats-card-value" x-text="bannerStats?.total || 0"></div>
        <div class="stats-card-label">弹窗数量 · <span class="text-green-500" x-text="(bannerStats?.active || 0) + '个启用'"></span></div>
      </div>
      <div class="stats-card stats-success stats-card-animate">
        <div class="stats-card-icon">🎨</div>
        <div class="stats-card-value" x-text="carouselStats?.total || 0"></div>
        <div class="stats-card-label">轮播图数量 · <span class="text-green-500" x-text="(carouselStats?.active || 0) + '个启用'"></span></div>
      </div>
      <div class="stats-card stats-warning stats-card-animate">
        <div class="stats-card-icon">🖼️</div>
        <div class="stats-card-value" x-text="imageStats?.total || 0"></div>
        <div class="stats-card-label">图片资源</div>
      </div>
    </div>

    <!-- 子页面导航 -->
    <div class="themed-card rounded-xl shadow-sm mb-6 overflow-hidden">
      <div class="flex overflow-x-auto" style="scrollbar-width: none;">
        <template x-for="page in subPages" :key="page.id">
          <button 
            @click="switchPage(page.id)"
            :class="current_page === page.id 
              ? 'border-b-2 border-blue-500 text-blue-600 bg-blue-50/60 font-semibold dark:bg-blue-900/10 dark:text-blue-400' 
              : 'themed-text-muted themed-hover-bg border-b-2 border-transparent'"
            class="px-6 py-3.5 font-medium whitespace-nowrap transition-all duration-200 relative"
            x-text="page.icon + ' ' + page.name"
          ></button>
        </template>
      </div>
    </div>

    <!-- 公告管理 -->
    <div x-show="current_page === 'announcements'" x-cloak>
      <div class="themed-card rounded-xl shadow-sm overflow-hidden">
        <div class="p-5 border-b flex justify-between items-center bg-gradient-to-r from-blue-50 to-transparent dark:from-blue-900/10">
          <div>
            <h5 class="font-semibold text-base">📢 公告管理</h5>
            <p class="text-xs themed-text-muted mt-0.5">管理系统公告、活动通知和维护公告</p>
          </div>
          <button @click="openCreateAnnouncementModal()" class="px-4 py-2 themed-btn-primary rounded-lg shadow-sm hover:shadow transition-shadow">
            ➕ 发布公告
          </button>
        </div>
        <!-- data-table: 公告列表 -->
        <div x-data="announcementsTable()" x-init="init()">
          <div x-show="loading" class="p-12 text-center themed-text-muted">
            <div class="inline-block w-8 h-8 border-3 border-blue-200 border-t-blue-500 rounded-full animate-spin mb-3"></div>
            <p>加载中...</p>
          </div>
          <div x-show="hasError" class="p-8 text-center">
            <p class="text-red-500 mb-2" x-text="error"></p>
            <button @click="loadData()" class="text-sm themed-text-primary hover:underline">🔄 重试</button>
          </div>
          <div x-show="hasData" class="overflow-x-auto">
            <table class="w-full">
              <thead class="themed-bg-base">
                <tr>
                  <template x-for="col in columns" :key="col.key">
                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider themed-text-muted"
                        :class="{ 'cursor-pointer hover:text-blue-600': col.sortable }"
                        @click="sort(col)">
                      <span x-text="col.label"></span>
                      <span x-show="col.sortable" class="ml-1 text-xs" x-text="getSortIcon(col)"></span>
                    </th>
                  </template>
                  <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider themed-text-muted">操作</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                <template x-for="(row, idx) in data" :key="row.announcement_id || idx">
                  <tr class="themed-hover-bg transition-colors">
                    <template x-for="col in columns" :key="col.key">
                      <td class="px-4 py-3 text-sm" x-html="renderCell(row, col)"></td>
                    </template>
                    <td class="px-4 py-3">
                      <div class="flex space-x-3">
                        <button @click="$dispatch('edit-announcement', row)" class="text-blue-500 hover:text-blue-700 text-sm font-medium transition-colors">编辑</button>
                        <button @click="$dispatch('delete-announcement', row)" class="text-red-500 hover:text-red-700 text-sm font-medium transition-colors">删除</button>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <div x-show="isEmpty" class="empty-state empty-state-compact">
            <div class="empty-state-icon-circle">
              <div class="empty-state-icon">📢</div>
            </div>
            <div class="empty-state-title">暂无公告数据</div>
            <div class="empty-state-description">点击"发布公告"按钮创建第一条公告，向用户传达重要信息</div>
            <button @click="openCreateAnnouncementModal()" class="empty-state-action">➕ 发布第一条公告</button>
          </div>
          <template x-if="total_pages > 1">
            <div class="p-4 border-t flex justify-between items-center">
              <span class="text-sm themed-text-muted" x-text="paginationInfo"></span>
              <div class="flex space-x-1">
                <button @click="prevPage()" :disabled="!hasPrevPage" class="px-3 py-1 text-sm border rounded disabled:opacity-50 themed-hover-bg">‹</button>
                <template x-for="p in visiblePages" :key="'pa'+p">
                  <button @click="goToPage(p)" :class="p === current_page ? 'themed-bg-primary text-white' : 'themed-hover-bg'" class="px-3 py-1 text-sm border rounded" :disabled="p === '...'" x-text="p"></button>
                </template>
                <button @click="nextPage()" :disabled="!hasNextPage" class="px-3 py-1 text-sm border rounded disabled:opacity-50 themed-hover-bg">›</button>
              </div>
            </div>
          </template>
          <div x-show="lastUpdateTime" class="px-4 py-2 text-xs themed-text-muted text-right border-t">
            最后更新: <span x-text="lastUpdateTime"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- 
      注意：后端没有帮助文章/通知管理API (/api/v4/console/notifications 不存在)
      此Tab已从subPages配置中移除，不再显示
      如需此功能，需要先在后端实现对应API
    -->

    <!-- 弹窗管理（popup_banners） -->
    <div x-show="current_page === 'popup-banners'" x-cloak>
      <div class="themed-card rounded-xl shadow-sm overflow-hidden">
        <div class="p-5 border-b flex justify-between items-center flex-wrap gap-3 bg-gradient-to-r from-purple-50 to-transparent dark:from-purple-900/10">
          <div>
            <h5 class="font-semibold text-base">🔔 弹窗管理</h5>
            <p class="text-xs themed-text-muted mt-0.5">管理首页弹窗广告，支持拖拽排序和频率控制</p>
          </div>
          <div class="flex items-center gap-2">
            <select x-model="bannerFilters.banner_type" @change="loadBanners()" class="px-3 py-2 text-sm border rounded-lg themed-bg-base focus:ring-2 focus:ring-indigo-300 transition-shadow">
              <option value="">全部类型</option>
              <template x-for="t in bannerTypes" :key="t.value">
                <option :value="t.value" x-text="t.label"></option>
              </template>
            </select>
            <button @click="openCreateBannerModal()" class="px-4 py-2 themed-btn-primary rounded-lg shadow-sm hover:shadow transition-shadow">
              ➕ 新增弹窗
            </button>
          </div>
        </div>

        <div x-show="banners.length === 0" class="empty-state">
          <div class="empty-state-icon-circle">
            <div class="empty-state-icon">🔔</div>
          </div>
          <div class="empty-state-title">暂无弹窗数据</div>
          <div class="empty-state-description">创建弹窗向用户展示公告、活动和促销信息，支持定时投放和频率控制</div>
          <button @click="openCreateBannerModal()" class="empty-state-action">➕ 创建第一个弹窗</button>
          <div class="empty-state-tips">
            <div class="empty-state-tips-title">💡 使用提示</div>
            <div>· 支持系统公告、活动推广、日常促销三种类型</div>
            <div>· 可设置强制弹出或按频率投放（每天/每次/仅一次）</div>
            <div>· 拖拽卡片可调整弹窗优先级排序</div>
          </div>
        </div>

        <div x-show="banners.length > 0" class="p-4">
          <p class="text-xs themed-text-muted mb-3 flex items-center gap-1">
            <span class="inline-block w-4 h-4 rounded bg-indigo-100 text-indigo-500 text-center text-xs leading-4">↕</span>
            拖拽卡片可调整展示顺序
          </p>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <template x-for="(banner, idx) in banners" :key="banner.popup_banner_id">
              <div class="themed-card rounded-xl overflow-hidden cursor-grab active:cursor-grabbing transition-all duration-200 hover:shadow-md"
                   :class="bannerDragging && bannerDragIndex === idx ? 'ring-2 ring-indigo-400 shadow-lg scale-[1.02]' : 'shadow-sm'"
                   :data-banner-idx="idx"
                   draggable="true"
                   @dragstart="bannerDragStart(idx, $event)"
                   @dragover="bannerDragOver($event, idx)"
                   @dragend="bannerDragEnd()"
                   @touchstart="bannerTouchStart(idx, $event)"
                   @touchmove="bannerTouchMove($event)"
                   @touchend="bannerTouchEnd()">
                <!-- 状态指示条 -->
                <div class="h-1" :class="banner.is_active ? 'bg-green-500' : 'bg-gray-300'"></div>
                <div class="relative group">
                  <div class="themed-bg-muted flex items-center justify-center cursor-pointer overflow-hidden"
                       :style="getBannerAspectStyle(banner.display_mode)"
                       x-show="banner.image_url" @click="previewBanner(banner)">
                    <img :data-src="banner.image_url" alt=""
                         class="w-full h-full img-lazy"
                         style="object-fit: contain;"
                         x-init="$nextTick(() => { if(banner.image_url) { $el.src = banner.image_url; $el.classList.add('loaded') } })">
                  </div>
                  <div class="h-40 themed-bg-muted flex items-center justify-center" x-show="!banner.image_url">
                    <span class="themed-text-muted text-sm">暂无图片</span>
                  </div>
                  <!-- 状态角标 -->
                  <div class="absolute top-2 right-2">
                    <span class="text-xs px-2 py-1 rounded-full font-medium shadow-sm"
                          :class="banner.is_active ? 'bg-green-500 text-white' : 'bg-gray-400 text-white'"
                          x-text="banner.is_active ? '已启用' : '已禁用'"></span>
                  </div>
                </div>
                <div class="p-4">
                  <h6 class="font-semibold text-sm mb-2 truncate" x-text="banner.title"></h6>
                  <div class="flex flex-wrap items-center gap-1.5 mb-2">
                    <span class="text-xs px-2 py-0.5 rounded-full text-white"
                          :class="banner.banner_type_color || (banner.banner_type === 'notice' ? 'bg-red-500' : banner.banner_type === 'event' ? 'bg-orange-500' : 'bg-blue-500')"
                          x-text="banner.banner_type_display || (banner.banner_type === 'notice' ? '系统公告' : banner.banner_type === 'event' ? '活动推广' : '日常促销')"></span>
                    <span class="text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300"
                          x-text="banner.display_mode_display || banner.display_mode || '未设置'"></span>
                    <span class="text-xs themed-text-muted" x-show="banner.image_width"
                          x-text="banner.image_width + '×' + banner.image_height"></span>
                  </div>
                  <div class="flex flex-wrap items-center gap-1 text-xs themed-text-muted mb-3">
                    <span x-text="'优先级 ' + (banner.priority || 0)"></span>
                    <span>·</span>
                    <span x-text="banner.frequency_rule_display || banner.frequency_rule || ''"></span>
                    <span x-show="banner.force_show" class="text-red-500 font-semibold">· 强制</span>
                  </div>
                  <div class="flex items-center gap-1 pt-3 border-t">
                    <button @click="toggleBannerStatus(banner)" class="flex-1 text-xs py-1.5 rounded-md font-medium transition-colors"
                            :class="banner.is_active ? 'bg-yellow-50 text-yellow-600 hover:bg-yellow-100 dark:bg-yellow-900/20 dark:text-yellow-400' : 'bg-green-50 text-green-600 hover:bg-green-100 dark:bg-green-900/20 dark:text-green-400'"
                            x-text="banner.is_active ? '禁用' : '启用'"></button>
                    <button @click="editBanner(banner)" class="flex-1 text-xs py-1.5 rounded-md font-medium bg-blue-50 text-blue-600 hover:bg-blue-100 dark:bg-blue-900/20 dark:text-blue-400 transition-colors">编辑</button>
                    <button @click="viewBannerShowStats(banner)" class="flex-1 text-xs py-1.5 rounded-md font-medium bg-indigo-50 text-indigo-600 hover:bg-indigo-100 dark:bg-indigo-900/20 dark:text-indigo-400 transition-colors">统计</button>
                    <button @click="deleteBanner(banner)" class="text-xs py-1.5 px-2 rounded-md font-medium text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">🗑</button>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>

    <!-- 轮播图管理（carousel_items 独立表） -->
    <div x-show="current_page === 'carousel-items'" x-cloak>
      <div class="themed-card rounded-xl shadow-sm overflow-hidden">
        <div class="p-5 border-b flex justify-between items-center bg-gradient-to-r from-emerald-50 to-transparent dark:from-emerald-900/10">
          <div>
            <h5 class="font-semibold text-base">🎨 轮播图管理</h5>
            <p class="text-xs themed-text-muted mt-0.5">管理首页轮播图片，支持拖拽排序和定时投放</p>
          </div>
          <button @click="openCreateCarouselModal()" class="px-4 py-2 themed-btn-primary rounded-lg shadow-sm hover:shadow transition-shadow">
            ➕ 新增轮播图
          </button>
        </div>

        <div x-show="carouselItems.length === 0" class="empty-state">
          <div class="empty-state-icon-circle">
            <div class="empty-state-icon">🎨</div>
          </div>
          <div class="empty-state-title">暂无轮播图数据</div>
          <div class="empty-state-description">创建轮播图在首页展示活动海报和品牌宣传内容，吸引用户关注最新活动和促销信息</div>
          <button @click="openCreateCarouselModal()" class="empty-state-action">➕ 添加第一张轮播图</button>
          <div class="empty-state-tips">
            <div class="empty-state-tips-title">💡 使用提示</div>
            <div>· 推荐尺寸：宽屏模式 750×420（16:9 比例）</div>
            <div>· 支持 JPG/PNG 格式，单张不超过 400KB</div>
            <div>· 创建后可拖拽排序，调整展示顺序</div>
            <div>· 支持设置定时投放的开始和结束时间</div>
          </div>
        </div>

        <div x-show="carouselItems.length > 0" class="p-4">
          <p class="text-xs themed-text-muted mb-3 flex items-center gap-1">
            <span class="inline-block w-4 h-4 rounded bg-emerald-100 text-emerald-500 text-center text-xs leading-4">↕</span>
            拖拽卡片可调整展示顺序
          </p>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <template x-for="(item, idx) in carouselItems" :key="item.carousel_item_id">
              <div class="themed-card rounded-xl overflow-hidden cursor-grab active:cursor-grabbing transition-all duration-200 hover:shadow-md"
                   :class="carouselDragging && carouselDragIndex === idx ? 'ring-2 ring-emerald-400 shadow-lg scale-[1.02]' : 'shadow-sm'"
                   :data-carousel-idx="idx"
                   draggable="true"
                   @dragstart="carouselDragStart(idx, $event)"
                   @dragover="carouselDragOver($event, idx)"
                   @dragend="carouselDragEnd()"
                   @touchstart="carouselTouchStart(idx)"
                   @touchmove="carouselTouchMove($event)"
                   @touchend="carouselTouchEnd()">
                <!-- 状态指示条 -->
                <div class="h-1" :class="item.is_active ? 'bg-emerald-500' : 'bg-gray-300'"></div>
                <div class="relative group">
                  <div class="themed-bg-muted flex items-center justify-center cursor-pointer overflow-hidden"
                       :style="getCarouselAspectStyle(item.display_mode)"
                       x-show="item.image_url" @click="previewCarouselItem(item)">
                    <img :data-src="item.image_url" alt=""
                         class="w-full h-full img-lazy"
                         style="object-fit: contain;"
                         x-init="$nextTick(() => { if(item.image_url) { $el.src = item.image_url; $el.classList.add('loaded') } })">
                  </div>
                  <div class="h-40 themed-bg-muted flex items-center justify-center" x-show="!item.image_url">
                    <span class="themed-text-muted text-sm">暂无图片</span>
                  </div>
                  <!-- 状态角标 -->
                  <div class="absolute top-2 right-2">
                    <span class="text-xs px-2 py-1 rounded-full font-medium shadow-sm"
                          :class="item.is_active ? 'bg-emerald-500 text-white' : 'bg-gray-400 text-white'"
                          x-text="item.is_active ? '已启用' : '已禁用'"></span>
                  </div>
                </div>
                <div class="p-4">
                  <h6 class="font-semibold text-sm mb-2 truncate" x-text="item.title"></h6>
                  <div class="flex flex-wrap items-center gap-1.5 mb-2">
                    <span class="text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-600 dark:bg-blue-900/20 dark:text-blue-400" x-text="item.display_mode || 'wide'"></span>
                    <span class="text-xs themed-text-muted" x-show="item.image_width"
                          x-text="item.image_width + '×' + item.image_height"></span>
                    <span class="text-xs themed-text-muted" x-text="'轮播间隔 ' + ((item.slide_interval_ms || 3000) / 1000) + 's'"></span>
                  </div>
                  <div class="flex items-center gap-1 pt-3 border-t">
                    <button @click="toggleCarouselStatus(item)" class="flex-1 text-xs py-1.5 rounded-md font-medium transition-colors"
                            :class="item.is_active ? 'bg-yellow-50 text-yellow-600 hover:bg-yellow-100 dark:bg-yellow-900/20 dark:text-yellow-400' : 'bg-green-50 text-green-600 hover:bg-green-100 dark:bg-green-900/20 dark:text-green-400'"
                            x-text="item.is_active ? '禁用' : '启用'"></button>
                    <button @click="editCarouselItem(item)" class="flex-1 text-xs py-1.5 rounded-md font-medium bg-blue-50 text-blue-600 hover:bg-blue-100 dark:bg-blue-900/20 dark:text-blue-400 transition-colors">编辑</button>
                    <button @click="viewCarouselShowStats(item)" class="flex-1 text-xs py-1.5 rounded-md font-medium bg-indigo-50 text-indigo-600 hover:bg-indigo-100 dark:bg-indigo-900/20 dark:text-indigo-400 transition-colors">统计</button>
                    <button @click="deleteCarouselItem(item)" class="text-xs py-1.5 px-2 rounded-md font-medium text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">🗑</button>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>

    <!-- 图片资源管理 -->
    <div x-show="current_page === 'image-resources'" x-cloak>
      <div class="themed-card rounded-xl shadow-sm overflow-hidden">
        <div class="p-5 border-b flex justify-between items-center bg-gradient-to-r from-amber-50 to-transparent dark:from-amber-900/10">
          <div>
            <h5 class="font-semibold text-base">🖼️ 图片资源</h5>
            <p class="text-xs themed-text-muted mt-0.5">统一管理系统中的图片素材，支持分类筛选和批量操作</p>
          </div>
          <button @click="showModal('uploadImageModal')" class="px-4 py-2 themed-btn-primary rounded-lg shadow-sm hover:shadow transition-shadow">
            ➕ 上传图片
          </button>
        </div>

        <div x-show="images.length === 0" class="empty-state">
          <div class="empty-state-icon-circle">
            <div class="empty-state-icon">🖼️</div>
          </div>
          <div class="empty-state-title">暂无图片资源</div>
          <div class="empty-state-description">上传图片素材统一管理，所有轮播图、弹窗使用的图片都会在这里归档和检索</div>
          <button @click="showModal('uploadImageModal')" class="empty-state-action">➕ 上传第一张图片</button>
          <div class="empty-state-tips">
            <div class="empty-state-tips-title">💡 使用提示</div>
            <div>· 支持 JPG/PNG/GIF/WebP 格式，单张不超过 5MB</div>
            <div>· 上传后自动生成 3 种缩略图尺寸（150/300/600px）</div>
            <div>· 图片可绑定到具体业务（抽奖、交易、活动等）</div>
            <div>· 点击图片可预览、复制链接或删除</div>
          </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 p-4" x-show="images.length > 0">
          <template x-for="image in images" :key="image.image_resource_id">
            <div class="themed-card rounded-xl overflow-hidden group relative shadow-sm hover:shadow-md transition-all duration-200">
              <div class="aspect-square themed-bg-subtle flex items-center justify-center img-blur-load">
                <img :data-src="image.url" :alt="image.original_filename" 
                     class="w-full h-full object-cover img-lazy"
                     x-init="$nextTick(() => { if(image.url) { $el.src = image.url; $el.classList.add('loaded') } })">
              </div>
              <div class="p-2.5">
                <p class="text-xs font-medium truncate" x-text="image.original_filename || '未命名'"></p>
                <p class="text-xs themed-text-muted mt-0.5" x-text="formatFileSize(image.file_size)"></p>
              </div>
              <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center space-x-2 rounded-xl">
                <button @click="viewImage(image)" class="px-3 py-1.5 bg-white text-gray-700 rounded-lg text-xs font-medium shadow-sm hover:bg-gray-50 transition-colors">查看</button>
                <button @click="deleteImage(image)" class="px-3 py-1.5 bg-red-500 text-white rounded-lg text-xs font-medium shadow-sm hover:bg-red-600 transition-colors">删除</button>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>

    <!-- ==================== Modal 区域 ==================== -->

    <!-- 1. 公告表单 Modal -->
    <div x-ref="announcementModal" 
         x-show="isModalOpen('announcementModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('announcementModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-2xl mx-4 z-10 max-h-[90vh] overflow-y-auto">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 themed-card">
          <h5 class="font-semibold">📣 <span x-text="isEditMode ? '编辑公告' : '发布公告'"></span></h5>
          <button @click="hideModal('announcementModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <form @submit.prevent="saveAnnouncement()">
          <div class="p-6 space-y-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">标题 <span class="text-red-500">*</span></label>
              <input type="text" x-model="announcementForm.title" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500" required>
            </div>
            <div class="grid grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">类型</label>
                <select x-model="announcementForm.type" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
                  <option value="notice">通知</option>
                  <option value="system">系统</option>
                  <option value="activity">活动</option>
                  <option value="maintenance">维护</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">优先级</label>
                <select x-model="announcementForm.priority" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
                  <option value="low">低</option>
                  <option value="medium">中</option>
                  <option value="high">高</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">状态</label>
                <select x-model="announcementForm.status" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
                  <option value="published">发布</option>
                  <option value="draft">草稿</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">内容 <span class="text-red-500">*</span></label>
              <textarea x-model="announcementForm.content" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500" rows="6" required></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">过期时间（可选）</label>
              <input type="datetime-local" x-model="announcementForm.expires_at" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
            </div>
          </div>
          <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-2 sticky bottom-0">
            <button type="button" @click="hideModal('announcementModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">取消</button>
            <button type="submit" class="px-4 py-2 themed-btn-primary rounded" :disabled="saving">
              <span x-show="saving" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-1"></span>
              <span x-text="isEditMode ? '保存修改' : '发布公告'"></span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 注意：通知相关Modal已移除，因为后端没有对应API -->

    <!-- 4. 弹窗表单 Modal -->
    <div x-ref="bannerModal" 
         x-show="isModalOpen('bannerModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('bannerModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-2xl mx-4 z-10 max-h-[90vh] overflow-y-auto">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 themed-card">
          <h5 class="font-semibold">🔔 <span x-text="isEditMode ? '编辑弹窗' : '新增弹窗'"></span></h5>
          <button @click="hideModal('bannerModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <form @submit.prevent="saveBanner()">
          <div class="p-6 space-y-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">标题 <span class="text-red-500">*</span></label>
              <input type="text" x-model="bannerForm.title" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
            </div>
            <!-- 弹窗类型 + 频率控制 -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">弹窗类型</label>
                <select x-model="bannerForm.banner_type" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
                  <template x-for="t in bannerTypes" :key="t.value">
                    <option :value="t.value" x-text="t.label"></option>
                  </template>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">弹出优先级</label>
                <input type="number" x-model.number="bannerForm.priority" min="0" max="999" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
                <p class="text-xs themed-text-muted mt-1">数字越大越优先弹出（公告 900-999，活动 500-899，促销 100-499）</p>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">频率规则</label>
                <select x-model="bannerForm.frequency_rule" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
                  <template x-for="r in frequencyRules" :key="r.value">
                    <option :value="r.value" x-text="r.label"></option>
                  </template>
                </select>
              </div>
              <div x-show="needsFrequencyValue()">
                <label class="block text-sm font-medium themed-text-secondary mb-1">频率参数值</label>
                <input type="number" x-model.number="bannerForm.frequency_value" min="1" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
                <p class="text-xs themed-text-muted mt-1" x-text="bannerForm.frequency_rule === 'once_per_n_days' ? '每N天弹一次' : '累计最多弹N次'"></p>
              </div>
            </div>
            <!-- 显示模式选择 -->
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-2">
                显示模式 <span class="text-red-500">*</span>
              </label>
              <div class="grid grid-cols-2 gap-2">
                <template x-for="mode in displayModes" :key="mode.value">
                  <label class="flex items-center p-2 border rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                         :class="bannerForm.display_mode === mode.value ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/20' : 'themed-border'">
                    <input type="radio" name="display_mode" :value="mode.value"
                           x-model="bannerForm.display_mode" @change="onDisplayModeChange()" class="mr-2">
                    <div>
                      <span class="text-sm font-medium" x-text="mode.label"></span>
                      <span class="text-xs themed-text-muted block" x-text="mode.hint"></span>
                    </div>
                  </label>
                </template>
              </div>
              <p x-show="!bannerForm.display_mode" class="mt-1 text-xs text-red-500">请选择一个显示模式</p>
              <div x-show="ratioWarning" class="mt-2 p-2 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded text-sm text-yellow-700 dark:text-yellow-300">
                ⚠️ <span x-text="ratioWarning"></span>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">显示位置</label>
                <select x-model="bannerForm.position" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
                  <option value="home">首页</option>
                  <option value="profile">个人中心</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">管理排序</label>
                <input type="number" x-model.number="bannerForm.display_order" min="0" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">开始时间</label>
                <input type="datetime-local" x-model="bannerForm.start_time" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">结束时间</label>
                <input type="datetime-local" x-model="bannerForm.end_time" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">弹窗图片</label>
              <div x-show="bannerImagePreview || bannerForm.image_url" class="mb-2 relative">
                <img :src="bannerImagePreview || bannerForm.image_url" alt="预览" class="max-w-full max-h-48 object-contain rounded border mx-auto">
                <button type="button" @click="clearBannerImage()" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600">×</button>
              </div>
              <div x-show="!bannerImagePreview && !bannerForm.image_url" class="border-2 border-dashed themed-border rounded-lg p-4 text-center hover:border-indigo-400 transition-colors">
                <input type="file" id="bannerImageInput" accept="image/jpeg,image/png" @change="selectBannerImage($event)" class="hidden">
                <label for="bannerImageInput" class="cursor-pointer">
                  <div class="text-gray-400 mb-2">
                    <svg class="w-8 h-8 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                  </div>
                  <span class="text-sm themed-text-muted">点击选择图片</span>
                  <p class="text-xs text-gray-400 mt-1">仅支持 JPG/PNG，≤ 400KB</p>
                </label>
              </div>
            </div>
            <div class="grid grid-cols-3 gap-4">
              <div class="col-span-2">
                <label class="block text-sm font-medium themed-text-secondary mb-1">跳转链接</label>
                <input type="text" x-model="bannerForm.link_url" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500" placeholder="/pages/lottery/lottery">
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">跳转类型</label>
                <select x-model="bannerForm.link_type" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
                  <option value="none">无跳转</option>
                  <option value="page">页面跳转</option>
                  <option value="miniprogram">小程序</option>
                  <option value="webview">网页</option>
                </select>
              </div>
            </div>
            <div class="flex items-center gap-6">
              <label class="flex items-center cursor-pointer">
                <input type="checkbox" x-model="bannerForm.is_active" class="w-4 h-4 mr-2 rounded themed-border">
                <span class="text-sm themed-text-secondary">启用弹窗</span>
              </label>
              <label class="flex items-center cursor-pointer">
                <input type="checkbox" x-model="bannerForm.force_show" class="w-4 h-4 mr-2 rounded themed-border">
                <span class="text-sm themed-text-secondary">强制弹出（不可点遮罩关闭）</span>
              </label>
            </div>
          </div>
          <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-2 sticky bottom-0">
            <button type="button" @click="hideModal('bannerModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">取消</button>
            <button type="submit" class="px-4 py-2 themed-btn-primary rounded" :disabled="saving">
              <span x-show="saving" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-1"></span>
              <span x-text="isEditMode ? '保存修改' : '新增弹窗'"></span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 5. 轮播图表单 Modal -->
    <div x-ref="carouselModal" 
         x-show="isModalOpen('carouselModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('carouselModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-lg mx-4 z-10 max-h-[90vh] overflow-y-auto">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 themed-card">
          <h5 class="font-semibold">🎨 <span x-text="isEditMode ? '编辑轮播图' : '添加轮播图'"></span></h5>
          <button @click="hideModal('carouselModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <form @submit.prevent="saveCarouselItem()">
          <div class="p-6 space-y-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">标题 <span class="text-red-500">*</span></label>
              <input type="text" x-model="carouselForm.title" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-2">显示模式 <span class="text-red-500">*</span></label>
              <div class="grid grid-cols-3 gap-2">
                <template x-for="mode in carouselDisplayModes" :key="mode.value">
                  <label class="flex items-center p-2 border rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                         :class="carouselForm.display_mode === mode.value ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/20' : 'themed-border'">
                    <input type="radio" name="carousel_display_mode" :value="mode.value"
                           x-model="carouselForm.display_mode" class="mr-2">
                    <div>
                      <span class="text-sm font-medium" x-text="mode.label"></span>
                      <span class="text-xs themed-text-muted block" x-text="mode.hint"></span>
                    </div>
                  </label>
                </template>
              </div>
            </div>
            <div class="grid grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">显示位置</label>
                <select x-model="carouselForm.position" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
                  <option value="home">首页</option>
                  <option value="profile">个人中心</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">排序</label>
                <input type="number" x-model.number="carouselForm.display_order" min="0" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">轮播间隔(ms)</label>
                <input type="number" x-model.number="carouselForm.slide_interval_ms" min="1000" step="500" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">开始时间</label>
                <input type="datetime-local" x-model="carouselForm.start_time" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">结束时间</label>
                <input type="datetime-local" x-model="carouselForm.end_time" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">轮播图片</label>
              <div x-show="carouselImagePreview || carouselForm.image_url" class="mb-2 relative">
                <img :src="carouselImagePreview || carouselForm.image_url" alt="预览" class="max-w-full max-h-48 object-contain rounded border mx-auto">
                <button type="button" @click="clearCarouselImage()" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600">×</button>
              </div>
              <div x-show="!carouselImagePreview && !carouselForm.image_url" class="border-2 border-dashed themed-border rounded-lg p-4 text-center hover:border-indigo-400 transition-colors">
                <input type="file" id="carouselImageInput" accept="image/jpeg,image/png" @change="selectCarouselImage($event)" class="hidden">
                <label for="carouselImageInput" class="cursor-pointer">
                  <div class="text-gray-400 mb-2">
                    <svg class="w-8 h-8 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                  </div>
                  <span class="text-sm themed-text-muted">点击选择图片</span>
                  <p class="text-xs text-gray-400 mt-1">仅支持 JPG/PNG，≤ 400KB</p>
                </label>
              </div>
            </div>
            <div class="grid grid-cols-3 gap-4">
              <div class="col-span-2">
                <label class="block text-sm font-medium themed-text-secondary mb-1">跳转链接</label>
                <input type="text" x-model="carouselForm.link_url" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500" placeholder="/pages/lottery/lottery">
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">跳转类型</label>
                <select x-model="carouselForm.link_type" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
                  <option value="none">无跳转</option>
                  <option value="page">页面跳转</option>
                  <option value="miniprogram">小程序</option>
                  <option value="webview">网页</option>
                </select>
              </div>
            </div>
            <div>
              <label class="flex items-center cursor-pointer">
                <input type="checkbox" x-model="carouselForm.is_active" class="w-4 h-4 mr-2 rounded themed-border">
                <span class="text-sm themed-text-secondary">启用轮播图</span>
              </label>
            </div>
          </div>
          <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-2 sticky bottom-0">
            <button type="button" @click="hideModal('carouselModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">取消</button>
            <button type="submit" class="px-4 py-2 themed-btn-primary rounded" :disabled="saving">
              <span x-show="saving" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-1"></span>
              <span x-text="isEditMode ? '保存修改' : '添加轮播图'"></span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 注意：文章表单Modal已移除，因为后端没有对应API -->

    <!-- 6. 图片上传 Modal -->
    <div x-ref="uploadImageModal" 
         x-show="isModalOpen('uploadImageModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('uploadImageModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-md mx-4 z-10">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold">📤 上传图片</h5>
          <button @click="hideModal('uploadImageModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <div class="p-6" x-data="{ dragover: false }">
          <div class="drop-zone p-8 text-center transition-colors"
               :class="{ 'drag-over': dragover }"
               @dragover.prevent="dragover = true"
               @dragleave="dragover = false"
               @drop.prevent="dragover = false; handleImageUpload($event)">
            <span class="text-5xl mb-4 block" x-text="dragover ? '📥' : '☁️'"></span>
            <p class="mb-2" x-text="dragover ? '释放以上传图片' : '拖拽图片到此处或点击上传'"></p>
            <input type="file" class="hidden" id="imageUploadInput" accept="image/*" multiple @change="handleImageUpload($event)">
            <button type="button" onclick="document.getElementById('imageUploadInput').click()" class="px-4 py-2 themed-btn-primary rounded btn-scale">
              选择图片
            </button>
          </div>
          <p class="text-sm themed-text-muted mt-2 text-center">支持 JPG、PNG、GIF 格式，单张最大 5MB</p>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end">
          <button type="button" @click="hideModal('uploadImageModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">关闭</button>
        </div>
      </div>
    </div>

    <!-- 7. 弹窗展示统计 Modal -->
    <div x-ref="bannerShowStatsModal"
         x-show="isModalOpen('bannerShowStatsModal')"
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('bannerShowStatsModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-2xl mx-4 z-10 max-h-[90vh] overflow-y-auto">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 themed-card">
          <h5 class="font-semibold">📊 弹窗展示统计 - <span x-text="bannerShowStatsTarget?.title"></span></h5>
          <button @click="hideModal('bannerShowStatsModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <div class="p-6">
          <div class="flex items-center gap-2 mb-4">
            <input type="date" x-model="bannerShowStatsDateRange.start_date" class="px-2 py-1 text-sm border rounded themed-bg-base">
            <span class="themed-text-muted">~</span>
            <input type="date" x-model="bannerShowStatsDateRange.end_date" class="px-2 py-1 text-sm border rounded themed-bg-base">
            <button @click="loadBannerShowStats()" class="px-3 py-1 text-sm themed-btn-primary rounded">查询</button>
          </div>
          <div x-show="bannerShowStatsLoading" class="p-8 text-center themed-text-muted">加载中...</div>
          <div x-show="!bannerShowStatsLoading && bannerShowStats">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
              <div class="p-3 themed-bg-base rounded-lg text-center">
                <p class="text-xl font-bold themed-text-primary" x-text="bannerShowStats?.total_shows || 0"></p>
                <p class="text-xs themed-text-muted">总展示次数</p>
              </div>
              <div class="p-3 themed-bg-base rounded-lg text-center">
                <p class="text-xl font-bold text-blue-500" x-text="bannerShowStats?.avg_duration_ms ? Math.round(bannerShowStats.avg_duration_ms / 1000 * 10) / 10 + 's' : '-'"></p>
                <p class="text-xs themed-text-muted">平均展示时长</p>
              </div>
              <div class="p-3 themed-bg-base rounded-lg text-center">
                <p class="text-xl font-bold text-green-500" x-text="bannerShowStats?.unique_users || 0"></p>
                <p class="text-xs themed-text-muted">独立用户数</p>
              </div>
              <div class="p-3 themed-bg-base rounded-lg text-center">
                <p class="text-xl font-bold text-orange-500" x-text="bannerShowStats?.avg_queue_position || '-'"></p>
                <p class="text-xs themed-text-muted">平均队列位置</p>
              </div>
            </div>
            <div x-show="bannerShowStats?.close_method_distribution" class="mb-4">
              <h6 class="font-medium mb-2 text-sm">关闭方式分布</h6>
              <div class="space-y-1">
                <template x-for="(count, method) in (bannerShowStats?.close_method_distribution || {})" :key="method">
                  <div class="flex justify-between items-center text-sm">
                    <span x-text="method === 'close_btn' ? '关闭按钮' : method === 'overlay' ? '点击遮罩' : method === 'confirm_btn' ? '确认按钮' : method"></span>
                    <span class="font-medium" x-text="count"></span>
                  </div>
                </template>
              </div>
            </div>
            <div x-show="bannerShowStats?.daily_stats?.length > 0" class="mb-4">
              <h6 class="font-medium mb-2 text-sm">每日趋势</h6>
              <div id="bannerShowStatsChart" class="w-full h-48 mb-3"></div>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="themed-bg-base">
                    <tr>
                      <th class="px-3 py-2 text-left">日期</th>
                      <th class="px-3 py-2 text-right">展示次数</th>
                      <th class="px-3 py-2 text-right">平均时长</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="day in (bannerShowStats?.daily_stats || [])" :key="day.date">
                      <tr class="border-t">
                        <td class="px-3 py-2" x-text="day.date"></td>
                        <td class="px-3 py-2 text-right" x-text="day.show_count || 0"></td>
                        <td class="px-3 py-2 text-right" x-text="day.avg_duration_ms ? Math.round(day.avg_duration_ms / 1000 * 10) / 10 + 's' : '-'"></td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div x-show="!bannerShowStatsLoading && !bannerShowStats" class="p-8 text-center themed-text-muted">暂无统计数据</div>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end">
          <button type="button" @click="hideModal('bannerShowStatsModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">关闭</button>
        </div>
      </div>
    </div>

    <!-- 8. 轮播图展示统计 Modal -->
    <div x-ref="carouselShowStatsModal"
         x-show="isModalOpen('carouselShowStatsModal')"
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('carouselShowStatsModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-2xl mx-4 z-10 max-h-[90vh] overflow-y-auto">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 themed-card">
          <h5 class="font-semibold">📊 轮播图曝光统计 - <span x-text="carouselShowStatsTarget?.title"></span></h5>
          <button @click="hideModal('carouselShowStatsModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <div class="p-6">
          <div class="flex items-center gap-2 mb-4">
            <input type="date" x-model="carouselShowStatsDateRange.start_date" class="px-2 py-1 text-sm border rounded themed-bg-base">
            <span class="themed-text-muted">~</span>
            <input type="date" x-model="carouselShowStatsDateRange.end_date" class="px-2 py-1 text-sm border rounded themed-bg-base">
            <button @click="loadCarouselShowStats()" class="px-3 py-1 text-sm themed-btn-primary rounded">查询</button>
          </div>
          <div x-show="carouselShowStatsLoading" class="p-8 text-center themed-text-muted">加载中...</div>
          <div x-show="!carouselShowStatsLoading && carouselShowStats">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
              <div class="p-3 themed-bg-base rounded-lg text-center">
                <p class="text-xl font-bold themed-text-primary" x-text="carouselShowStats?.total_exposures || 0"></p>
                <p class="text-xs themed-text-muted">总曝光次数</p>
              </div>
              <div class="p-3 themed-bg-base rounded-lg text-center">
                <p class="text-xl font-bold text-blue-500" x-text="carouselShowStats?.avg_exposure_ms ? Math.round(carouselShowStats.avg_exposure_ms / 1000 * 10) / 10 + 's' : '-'"></p>
                <p class="text-xs themed-text-muted">平均曝光时长</p>
              </div>
              <div class="p-3 themed-bg-base rounded-lg text-center">
                <p class="text-xl font-bold text-green-500" x-text="carouselShowStats?.click_count || 0"></p>
                <p class="text-xs themed-text-muted">点击次数</p>
              </div>
              <div class="p-3 themed-bg-base rounded-lg text-center">
                <p class="text-xl font-bold text-orange-500" x-text="carouselShowStats?.click_rate ? (carouselShowStats.click_rate * 100).toFixed(1) + '%' : '0%'"></p>
                <p class="text-xs themed-text-muted">点击率</p>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
              <div class="p-3 themed-bg-base rounded-lg text-center">
                <p class="text-lg font-bold" x-text="carouselShowStats?.manual_swipe_count || 0"></p>
                <p class="text-xs themed-text-muted">手动滑入次数</p>
              </div>
              <div class="p-3 themed-bg-base rounded-lg text-center">
                <p class="text-lg font-bold" x-text="carouselShowStats?.manual_swipe_rate ? (carouselShowStats.manual_swipe_rate * 100).toFixed(1) + '%' : '0%'"></p>
                <p class="text-xs themed-text-muted">手动滑入率</p>
              </div>
            </div>
            <div x-show="carouselShowStats?.daily_stats?.length > 0">
              <h6 class="font-medium mb-2 text-sm">每日趋势</h6>
              <div id="carouselShowStatsChart" class="w-full h-48 mb-3"></div>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="themed-bg-base">
                    <tr>
                      <th class="px-3 py-2 text-left">日期</th>
                      <th class="px-3 py-2 text-right">曝光次数</th>
                      <th class="px-3 py-2 text-right">点击数</th>
                      <th class="px-3 py-2 text-right">点击率</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="day in (carouselShowStats?.daily_stats || [])" :key="day.date">
                      <tr class="border-t">
                        <td class="px-3 py-2" x-text="day.date"></td>
                        <td class="px-3 py-2 text-right" x-text="day.exposure_count || 0"></td>
                        <td class="px-3 py-2 text-right" x-text="day.click_count || 0"></td>
                        <td class="px-3 py-2 text-right" x-text="day.exposure_count > 0 ? ((day.click_count / day.exposure_count) * 100).toFixed(1) + '%' : '0%'"></td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div x-show="!carouselShowStatsLoading && !carouselShowStats" class="p-8 text-center themed-text-muted">暂无统计数据</div>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end">
          <button type="button" @click="hideModal('carouselShowStatsModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">关闭</button>
        </div>
      </div>
    </div>

    <!-- 9. 删除确认 Modal -->
    <div x-ref="deleteModal" 
         x-show="isModalOpen('deleteModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('deleteModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-sm mx-4 z-10">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold text-red-600">⚠️ 删除确认</h5>
          <button @click="hideModal('deleteModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <div class="p-6 text-center">
          <span class="text-5xl mb-4 block">🗑️</span>
          <p class="themed-text-secondary">确定要删除此项吗？</p>
          <p class="text-sm themed-text-muted mt-1">此操作不可撤销</p>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-2">
          <button type="button" @click="hideModal('deleteModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">取消</button>
          <button type="button" @click="confirmDelete()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600" :disabled="deleting">
            <span x-show="deleting" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-1"></span>
            确认删除
          </button>
        </div>
      </div>
    </div>

  </div>

  <!-- 页面专属逻辑 -->
  <%- include('partials/footer') %>

  <script type="module" src="./src/modules/content/pages/content-management.js"></script>
</body>
</html>
