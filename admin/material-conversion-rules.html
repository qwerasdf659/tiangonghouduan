<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '材料转换规则管理', 
    pageStyle: '[x-cloak] { display: none !important; } .asset-flow { display: flex; align-items: center; gap: 0.5rem; } .validation-warning { border-left: 4px solid #fbbf24; padding: 1rem; background-color: #fef3c7; border-radius: 4px; margin-top: 0.75rem; }' 
  }) %>
</head>
<body class="bg-gray-100 min-h-screen" x-data="materialConversionRulesPage()" x-init="init()" x-cloak>
  
  <!-- 导航栏 -->
  <nav class="bg-teal-600 text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/dashboard.html" class="hover:text-teal-200">← 返回仪表盘</a>
        <span class="text-lg font-semibold">🔄 材料转换规则管理</span>
      </div>
      <div class="flex items-center space-x-4">
        <span x-text="'欢迎，' + (userInfo?.nickname || '管理员')"></span>
        <button @click="logout()" class="px-3 py-1 border border-white/50 rounded hover:bg-white/10">退出登录</button>
      </div>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-6">
    <!-- 操作区域 -->
    <div class="bg-white rounded-lg shadow mb-4">
      <div class="p-4 flex justify-between items-center">
        <div>
          <h5 class="font-semibold text-gray-700">🔄 材料转换规则管理</h5>
          <small class="text-gray-500">配置碎片与水晶之间的转换规则</small>
        </div>
        <button class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700 flex items-center" @click="openAddModal()">
          <span class="mr-1">+</span> 添加转换规则
        </button>
      </div>
    </div>

    <!-- 统计信息 -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
      <div class="bg-white rounded-lg shadow p-4 text-center">
        <h6 class="text-gray-500 text-sm">转换规则总数</h6>
        <h3 class="text-2xl font-bold text-teal-600" x-text="stats.total">-</h3>
      </div>
      <div class="bg-white rounded-lg shadow p-4 text-center">
        <h6 class="text-gray-500 text-sm">已启用</h6>
        <h3 class="text-2xl font-bold text-green-600" x-text="stats.enabled">-</h3>
      </div>
      <div class="bg-white rounded-lg shadow p-4 text-center">
        <h6 class="text-gray-500 text-sm">已禁用</h6>
        <h3 class="text-2xl font-bold text-yellow-600" x-text="stats.disabled">-</h3>
      </div>
      <div class="bg-white rounded-lg shadow p-4 text-center">
        <h6 class="text-gray-500 text-sm">转换路径数</h6>
        <h3 class="text-2xl font-bold text-blue-600" x-text="stats.paths">-</h3>
      </div>
    </div>

    <!-- 数据表格 -->
    <div class="bg-white rounded-lg shadow">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">规则ID</th>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">转换方向</th>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">转换比例</th>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">生效时间</th>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">状态</th>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">风控校验</th>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-700" style="width: 200px;">操作</th>
            </tr>
          </thead>
          <tbody>
            <!-- 加载中 -->
            <tr x-show="loading">
              <td colspan="7" class="text-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-teal-600 mx-auto"></div>
                <p class="mt-2 text-gray-500">正在加载数据...</p>
              </td>
            </tr>
            <!-- 空状态 -->
            <tr x-show="!loading && rules.length === 0">
              <td colspan="7" class="text-center py-8">
                <div class="text-4xl text-gray-300 mb-2">📭</div>
                <p class="text-gray-500">暂无转换规则，点击右上角添加</p>
              </td>
            </tr>
            <!-- 数据列表 -->
            <template x-for="rule in rules" :key="rule.rule_id">
              <tr x-show="!loading" class="border-t hover:bg-gray-50">
                <td class="px-4 py-3">
                  <code class="text-sm bg-gray-100 px-2 py-1 rounded" x-text="'#' + rule.rule_id"></code>
                </td>
                <td class="px-4 py-3">
                  <div class="asset-flow">
                    <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-sm" x-text="rule.from_asset_code"></span>
                    <span class="text-gray-400">→</span>
                    <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-sm" x-text="rule.to_asset_code"></span>
                  </div>
                </td>
                <td class="px-4 py-3">
                  <strong x-text="rule.input_quantity"></strong> : <strong x-text="rule.output_quantity"></strong>
                  <br><small class="text-gray-500" x-text="'(' + getRatio(rule) + ')'"></small>
                </td>
                <td class="px-4 py-3 text-sm text-gray-600" x-text="formatDate(rule.effective_at)"></td>
                <td class="px-4 py-3">
                  <span class="px-2 py-1 rounded text-xs"
                        :class="rule.is_enabled ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'"
                        x-text="rule.is_enabled ? '已启用' : '已禁用'"></span>
                </td>
                <td class="px-4 py-3">
                  <!-- 循环风险 -->
                  <span x-show="rule.cycle_detected" class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs" title="检测到循环转换">
                    ⚠️ 循环
                  </span>
                  <!-- 套利风险 -->
                  <span x-show="rule.arbitrage_detected" class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs" title="检测到套利风险">
                    🛡️ 套利
                  </span>
                  <!-- 正常 -->
                  <span x-show="!rule.cycle_detected && !rule.arbitrage_detected" class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">
                    ✅ 正常
                  </span>
                </td>
                <td class="px-4 py-3 space-x-2">
                  <button class="px-2 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600" @click="openEditModal(rule.rule_id)">
                    编辑
                  </button>
                  <button class="px-2 py-1 rounded text-sm"
                          :class="rule.is_enabled ? 'bg-yellow-500 text-white hover:bg-yellow-600' : 'bg-green-500 text-white hover:bg-green-600'"
                          @click="toggleStatus(rule.rule_id, rule.is_enabled)">
                    <span x-text="rule.is_enabled ? '禁用' : '启用'"></span>
                  </button>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 添加转换规则模态框 -->
  <div x-ref="addModal"
       x-show="isModalShown('addModal')"
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
       @click.self="hideModal('addModal')">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">➕ 添加转换规则</h5>
        <button @click="hideModal('addModal')" class="text-gray-400 hover:text-gray-600">✕</button>
      </div>
      <div class="p-4">
        <form @submit.prevent="submitAdd()">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">源资产 <span class="text-red-500">*</span></label>
              <select class="w-full px-3 py-2 border rounded-lg" x-model="addForm.from_asset_code" required>
                <option value="">请选择</option>
                <template x-for="asset in getEnabledAssetTypes()" :key="asset.asset_code">
                  <option :value="asset.asset_code" x-text="asset.display_name + ' (' + asset.asset_code + ')'"></option>
                </template>
              </select>
              <small class="text-gray-500 text-xs">用户付出的资产</small>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">目标资产 <span class="text-red-500">*</span></label>
              <select class="w-full px-3 py-2 border rounded-lg" x-model="addForm.to_asset_code" required>
                <option value="">请选择</option>
                <template x-for="asset in getEnabledAssetTypes()" :key="asset.asset_code">
                  <option :value="asset.asset_code" x-text="asset.display_name + ' (' + asset.asset_code + ')'"></option>
                </template>
              </select>
              <small class="text-gray-500 text-xs">用户获得的资产</small>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">输入数量 <span class="text-red-500">*</span></label>
              <input type="number" class="w-full px-3 py-2 border rounded-lg" x-model="addForm.input_quantity" required min="1" placeholder="如: 10">
              <small class="text-gray-500 text-xs">每次转换所需的源资产数量</small>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">输出数量 <span class="text-red-500">*</span></label>
              <input type="number" class="w-full px-3 py-2 border rounded-lg" x-model="addForm.output_quantity" required min="1" placeholder="如: 1">
              <small class="text-gray-500 text-xs">每次转换获得的目标资产数量</small>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">生效时间 <span class="text-red-500">*</span></label>
              <input type="datetime-local" class="w-full px-3 py-2 border rounded-lg" x-model="addForm.effective_at" required>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">启用状态</label>
              <select class="w-full px-3 py-2 border rounded-lg" x-model="addForm.is_enabled">
                <option value="1">启用</option>
                <option value="0">禁用</option>
              </select>
            </div>
          </div>
          <!-- 风控提示区域 -->
          <template x-for="warning in addValidationWarnings" :key="warning.type">
            <div class="validation-warning">
              <strong class="text-yellow-700" x-text="'⚠️ ' + warning.title + '：'"></strong>
              <span class="text-yellow-800" x-text="warning.message"></span>
            </div>
          </template>
        </form>
      </div>
      <div class="p-4 border-t flex justify-end space-x-3">
        <button @click="hideModal('addModal')" class="px-4 py-2 border rounded hover:bg-gray-50">取消</button>
        <button @click="submitAdd()" :disabled="submitting" class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700 disabled:opacity-50">
          <span x-show="submitting" class="mr-1">⏳</span>
          确认添加
        </button>
      </div>
    </div>
  </div>

  <!-- 编辑转换规则模态框 -->
  <div x-ref="editModal"
       x-show="isModalShown('editModal')"
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
       @click.self="hideModal('editModal')">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">✏️ 编辑转换规则</h5>
        <button @click="hideModal('editModal')" class="text-gray-400 hover:text-gray-600">✕</button>
      </div>
      <div class="p-4">
        <form @submit.prevent="submitEdit()">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">转换方向</label>
              <input type="text" class="w-full px-3 py-2 border rounded-lg bg-gray-50" x-model="editForm.direction" disabled>
              <small class="text-gray-500 text-xs">转换方向不可修改</small>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">输入数量 <span class="text-red-500">*</span></label>
              <input type="number" class="w-full px-3 py-2 border rounded-lg" x-model="editForm.input_quantity" required min="1">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">输出数量 <span class="text-red-500">*</span></label>
              <input type="number" class="w-full px-3 py-2 border rounded-lg" x-model="editForm.output_quantity" required min="1">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">生效时间 <span class="text-red-500">*</span></label>
              <input type="datetime-local" class="w-full px-3 py-2 border rounded-lg" x-model="editForm.effective_at" required>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">启用状态</label>
              <select class="w-full px-3 py-2 border rounded-lg" x-model="editForm.is_enabled">
                <option value="1">启用</option>
                <option value="0">禁用</option>
              </select>
            </div>
          </div>
          <!-- 风控提示区域 -->
          <template x-for="warning in editValidationWarnings" :key="warning.type">
            <div class="validation-warning">
              <strong class="text-yellow-700" x-text="'⚠️ ' + warning.title + '：'"></strong>
              <span class="text-yellow-800" x-text="warning.message"></span>
            </div>
          </template>
        </form>
      </div>
      <div class="p-4 border-t flex justify-end space-x-3">
        <button @click="hideModal('editModal')" class="px-4 py-2 border rounded hover:bg-gray-50">取消</button>
        <button @click="submitEdit()" :disabled="submitting" class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700 disabled:opacity-50">
          <span x-show="submitting" class="mr-1">⏳</span>
          保存更新
        </button>
      </div>
    </div>
  </div>

  <!-- 页面专属逻辑 -->
  <%- include('partials/footer') %>
  <script type="module" src="./src/modules/system/pages/material-conversion-rules.js"></script>
</body>
</html>
