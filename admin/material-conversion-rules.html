<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '材料转换规则管理', 
    pageStyle: '[x-cloak] { display: none !important; } .asset-flow { display: flex; align-items: center; gap: 0.5rem; } .validation-warning { border-left: 4px solid #fbbf24; padding: 1rem; background-color: #fef3c7; border-radius: 4px; margin-top: 0.75rem; }' 
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen" x-data="materialConversionRulesPage()" x-init="init()" x-cloak>
  
  <!-- 导航栏 -->
  <nav class="themed-bg-primary text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="hover:text-blue-200">← 返回工作台</a>
        <span class="text-lg font-semibold">🔄 材料转换规则管理</span>
      </div>
      <div class="flex items-center space-x-4">
        <span x-text="'欢迎，' + (current_user?.nickname || '管理员')"></span>
        <button @click="logout()" class="px-3 py-1 border border-white/50 rounded hover:bg-white/10">退出登录</button>
      </div>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-6">
    <!-- 操作区域 -->
    <div class="themed-card rounded-lg shadow mb-4">
      <div class="p-4 flex justify-between items-center">
        <div>
          <h5 class="font-semibold themed-text-secondary">🔄 材料转换规则管理</h5>
          <small class="themed-text-muted">配置碎片与水晶之间的转换规则</small>
        </div>
        <button class="px-4 py-2 themed-btn-primary rounded flex items-center" @click="openAddModal()">
          <span class="mr-1">+</span> 添加转换规则
        </button>
      </div>
    </div>

    <!-- 统计信息 -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
      <div class="themed-card rounded-lg shadow p-4 text-center">
        <h6 class="themed-text-muted text-sm">转换规则总数</h6>
        <h3 class="text-2xl font-bold text-teal-600" x-text="stats.total">-</h3>
      </div>
      <div class="themed-card rounded-lg shadow p-4 text-center">
        <h6 class="themed-text-muted text-sm">已启用</h6>
        <h3 class="text-2xl font-bold text-green-600" x-text="stats.enabled">-</h3>
      </div>
      <div class="themed-card rounded-lg shadow p-4 text-center">
        <h6 class="themed-text-muted text-sm">已禁用</h6>
        <h3 class="text-2xl font-bold text-yellow-600" x-text="stats.disabled">-</h3>
      </div>
      <div class="themed-card rounded-lg shadow p-4 text-center">
        <h6 class="themed-text-muted text-sm">转换路径数</h6>
        <h3 class="text-2xl font-bold themed-text-primary" x-text="stats.paths">-</h3>
      </div>
    </div>

    <!-- 数据表格 -->
    <div class="themed-card rounded-lg shadow">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="themed-bg-base">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-secondary">规则ID</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-secondary">转换方向</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-secondary">转换比例</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-secondary">生效时间</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-secondary">状态</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-secondary">风控校验</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-secondary" style="width: 200px;">操作</th>
            </tr>
          </thead>
          <tbody>
            <!-- 加载中 -->
            <tr x-show="loading">
              <td colspan="7" class="text-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-teal-600 mx-auto"></div>
                <p class="mt-2 themed-text-muted">正在加载数据...</p>
              </td>
            </tr>
            <!-- 空状态 -->
            <tr x-show="!loading && rules.length === 0">
              <td colspan="7" class="text-center py-8">
                <div class="text-4xl text-gray-300 mb-2">📭</div>
                <p class="themed-text-muted">暂无转换规则，点击右上角添加</p>
              </td>
            </tr>
            <!-- 数据列表 -->
            <template x-for="rule in rules" :key="rule.rule_id">
              <tr x-show="!loading" class="border-t themed-hover-bg">
                <td class="px-4 py-3">
                  <code class="text-sm themed-bg-subtle px-2 py-1 rounded" x-text="'#' + rule.rule_id"></code>
                </td>
                <td class="px-4 py-3">
                  <div class="asset-flow">
                    <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-sm" x-text="rule.from_asset_code"></span>
                    <span class="text-gray-400">→</span>
                    <span class="px-2 py-1 bg-green-100 themed-text-success rounded text-sm" x-text="rule.to_asset_code"></span>
                  </div>
                </td>
                <td class="px-4 py-3">
                  <strong x-text="rule.from_amount"></strong> : <strong x-text="rule.to_amount"></strong>
                  <br><small class="themed-text-muted" x-text="'(比例: ' + getRatio(rule) + ')'"></small>
                </td>
                <td class="px-4 py-3 text-sm themed-text-muted" x-text="formatDate(rule.effective_at)"></td>
                <td class="px-4 py-3">
                  <span class="px-2 py-1 rounded text-xs"
                        :class="rule.is_enabled ? 'bg-green-100 themed-text-success' : 'themed-bg-subtle themed-text-muted'"
                        x-text="rule.is_enabled ? '已启用' : '已禁用'"></span>
                </td>
                <td class="px-4 py-3">
                  <!-- 循环风险 -->
                  <span x-show="rule.cycle_detected" class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs" title="检测到循环转换">
                    ⚠️ 循环
                  </span>
                  <!-- 套利风险 -->
                  <span x-show="rule.arbitrage_detected" class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs" title="检测到套利风险">
                    🛡️ 套利
                  </span>
                  <!-- 正常 -->
                  <span x-show="!rule.cycle_detected && !rule.arbitrage_detected" class="px-2 py-1 bg-green-100 themed-text-success rounded text-xs">
                    ✅ 正常
                  </span>
                </td>
                <td class="px-4 py-3 space-x-2">
                  <button class="px-2 py-1 themed-bg-primary text-white rounded text-sm themed-hover-primary" @click="openViewModal(rule.rule_id)">
                    查看
                  </button>
                  <!-- 只有启用的规则可以被禁用；禁用后不可重新启用，需创建新规则 -->
                  <button x-show="rule.is_enabled"
                          class="px-2 py-1 bg-yellow-500 text-white rounded text-sm hover:bg-yellow-600"
                          @click="disableRule(rule.rule_id)">
                    禁用
                  </button>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 添加转换规则模态框 -->
  <div x-ref="addModal"
       x-show="isModalShown('addModal')"
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
       @click.self="hideModal('addModal')">
    <div class="themed-card rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">➕ 添加转换规则</h5>
        <button @click="hideModal('addModal')" class="text-gray-400 hover:themed-text-muted">✕</button>
      </div>
      <div class="p-4">
        <form @submit.prevent="submitAdd()">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">源资产 <span class="text-red-500">*</span></label>
              <select class="w-full px-3 py-2 border rounded-lg" x-model="addForm.from_asset_code" required>
                <option value="">请选择</option>
                <template x-for="asset in getEnabledAssetTypes()" :key="asset.asset_code">
                  <option :value="asset.asset_code" x-text="asset.display_name + ' (' + asset.asset_code + ')'"></option>
                </template>
              </select>
              <small class="themed-text-muted text-xs">用户付出的资产</small>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">目标资产 <span class="text-red-500">*</span></label>
              <select class="w-full px-3 py-2 border rounded-lg" x-model="addForm.to_asset_code" required>
                <option value="">请选择</option>
                <template x-for="asset in getEnabledAssetTypes()" :key="asset.asset_code">
                  <option :value="asset.asset_code" x-text="asset.display_name + ' (' + asset.asset_code + ')'"></option>
                </template>
              </select>
              <small class="themed-text-muted text-xs">用户获得的资产</small>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">源资产数量 <span class="text-red-500">*</span></label>
              <input type="number" class="w-full px-3 py-2 border rounded-lg" x-model="addForm.from_amount" required min="1" placeholder="如: 10">
              <small class="themed-text-muted text-xs">每次转换所需的源资产数量</small>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">目标资产数量 <span class="text-red-500">*</span></label>
              <input type="number" class="w-full px-3 py-2 border rounded-lg" x-model="addForm.to_amount" required min="1" placeholder="如: 1">
              <small class="themed-text-muted text-xs">每次转换获得的目标资产数量</small>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">生效时间 <span class="text-red-500">*</span></label>
              <input type="datetime-local" class="w-full px-3 py-2 border rounded-lg" x-model="addForm.effective_at" required>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">启用状态</label>
              <select class="w-full px-3 py-2 border rounded-lg" x-model="addForm.is_enabled">
                <option value="1">启用</option>
                <option value="0">禁用</option>
              </select>
            </div>
          </div>
          <!-- 风控提示区域 -->
          <template x-for="warning in addValidationWarnings" :key="warning.type">
            <div class="validation-warning">
              <strong class="text-yellow-700" x-text="'⚠️ ' + warning.title + '：'"></strong>
              <span class="text-yellow-800" x-text="warning.message"></span>
            </div>
          </template>
        </form>
      </div>
      <div class="p-4 border-t flex justify-end space-x-3">
        <button @click="hideModal('addModal')" class="px-4 py-2 border rounded themed-hover-bg">取消</button>
        <button @click="submitAdd()" :disabled="submitting" class="px-4 py-2 themed-btn-primary rounded disabled:opacity-50">
          <span x-show="submitting" class="mr-1">⏳</span>
          确认添加
        </button>
      </div>
    </div>
  </div>

  <!-- 查看转换规则详情模态框（后端设计：不支持编辑，修改比例需创建新规则） -->
  <div x-ref="editModal"
       x-show="isModalShown('editModal')"
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
       @click.self="hideModal('editModal')">
    <div class="themed-card rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">📋 规则详情</h5>
        <button @click="hideModal('editModal')" class="text-gray-400 hover:themed-text-muted">✕</button>
      </div>
      <div class="p-4">
        <div class="themed-bg-primary-light border border-blue-200 rounded-lg p-3 mb-4">
          <p class="text-sm themed-text-primary">
            ℹ️ <strong>设计说明：</strong>转换规则采用版本化管理，修改比例需新增规则（禁止覆盖历史）。
            如需修改转换比例，请创建新规则并禁用旧规则。
          </p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="md:col-span-2">
            <label class="block text-sm font-medium themed-text-secondary mb-1">转换方向</label>
            <input type="text" class="w-full px-3 py-2 border rounded-lg themed-bg-subtle" x-model="editForm.direction" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">源资产数量</label>
            <input type="number" class="w-full px-3 py-2 border rounded-lg themed-bg-subtle" x-model="editForm.from_amount" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">目标资产数量</label>
            <input type="number" class="w-full px-3 py-2 border rounded-lg themed-bg-subtle" x-model="editForm.to_amount" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">生效时间</label>
            <input type="datetime-local" class="w-full px-3 py-2 border rounded-lg themed-bg-subtle" x-model="editForm.effective_at" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">启用状态</label>
            <input type="text" class="w-full px-3 py-2 border rounded-lg themed-bg-subtle" 
                   :value="editForm.is_enabled === '1' ? '已启用' : '已禁用'" disabled>
          </div>
        </div>
      </div>
      <div class="p-4 border-t flex justify-end">
        <button @click="hideModal('editModal')" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">关闭</button>
      </div>
    </div>
  </div>

  <!-- 页面专属逻辑 -->
  <%- include('partials/footer') %>
  <script type="module" src="./src/modules/system/pages/material-conversion-rules.js"></script>
</body>
</html>
