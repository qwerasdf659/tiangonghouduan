<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '材料转换规则管理', 
    pageStyle: '[x-cloak] { display: none !important; } .asset-flow { display: flex; align-items: center; gap: 0.5rem; } .validation-warning { border-left: 4px solid #fbbf24; padding: 1rem; background-color: #fef3c7; border-radius: 4px; margin-top: 0.75rem; }' 
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen" x-data="materialConversionRulesPage()" x-init="init()" x-cloak @table-action="handleTableAction($event.detail)">
  
  <!-- 导航栏 -->
  <nav class="themed-bg-primary text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="hover:text-blue-200">← 返回工作台</a>
        <span class="text-lg font-semibold">🔄 材料转换规则管理</span>
      </div>
      <div class="flex items-center space-x-4">
        <span x-text="'欢迎，' + (current_user?.nickname || '管理员')"></span>
        <button @click="logout()" class="px-3 py-1 border border-white/50 rounded hover:bg-white/10">退出登录</button>
      </div>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-6">
    <!-- 操作区域 -->
    <div class="themed-card rounded-lg shadow mb-4">
      <div class="p-4 flex justify-between items-center">
        <div>
          <h5 class="font-semibold themed-text-secondary">🔄 材料转换规则管理</h5>
          <small class="themed-text-muted">配置碎片与水晶之间的转换规则</small>
        </div>
        <button class="px-4 py-2 themed-btn-primary rounded flex items-center" @click="openAddModal()">
          <span class="mr-1">+</span> 添加转换规则
        </button>
      </div>
    </div>

    <!-- 统计信息 -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
      <div class="themed-card rounded-lg shadow p-4 text-center">
        <h6 class="themed-text-muted text-sm">转换规则总数</h6>
        <h3 class="text-2xl font-bold text-teal-600" x-text="stats.total">-</h3>
      </div>
      <div class="themed-card rounded-lg shadow p-4 text-center">
        <h6 class="themed-text-muted text-sm">已启用</h6>
        <h3 class="text-2xl font-bold text-green-600" x-text="stats.enabled">-</h3>
      </div>
      <div class="themed-card rounded-lg shadow p-4 text-center">
        <h6 class="themed-text-muted text-sm">已禁用</h6>
        <h3 class="text-2xl font-bold text-yellow-600" x-text="stats.disabled">-</h3>
      </div>
      <div class="themed-card rounded-lg shadow p-4 text-center">
        <h6 class="themed-text-muted text-sm">转换路径数</h6>
        <h3 class="text-2xl font-bold themed-text-primary" x-text="stats.paths">-</h3>
      </div>
    </div>

    <!-- data-table 标准表格组件 -->
    <div x-data="dataTable({
      columns: tableColumns,
      dataSource: fetchTableData,
      primaryKey: 'rule_id',
      sortable: true,
      selectable: false,
      exportable: false,
      page_size: 100,
      emptyText: '暂无转换规则，点击右上角添加'
    })" x-init="init()" @dt-refresh.window="refresh()">
      <%- include('components/data-table') %>
    </div>
  </div>

  <!-- 添加转换规则模态框 -->
  <div x-ref="addModal"
       x-show="isModalShown('addModal')"
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
       @click.self="hideModal('addModal')">
    <div class="themed-card rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">➕ 添加转换规则</h5>
        <button @click="hideModal('addModal')" class="text-gray-400 hover:themed-text-muted">✕</button>
      </div>
      <div class="p-4">
        <form @submit.prevent="submitAdd()">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">源资产 <span class="text-red-500">*</span></label>
              <select class="w-full px-3 py-2 border rounded-lg" x-model="addForm.from_asset_code" required>
                <option value="">请选择</option>
                <template x-for="asset in getEnabledAssetTypes()" :key="asset.asset_code">
                  <option :value="asset.asset_code" x-text="asset.display_name + ' (' + asset.asset_code + ')'"></option>
                </template>
              </select>
              <small class="themed-text-muted text-xs">用户付出的资产</small>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">目标资产 <span class="text-red-500">*</span></label>
              <select class="w-full px-3 py-2 border rounded-lg" x-model="addForm.to_asset_code" required>
                <option value="">请选择</option>
                <template x-for="asset in getEnabledAssetTypes()" :key="asset.asset_code">
                  <option :value="asset.asset_code" x-text="asset.display_name + ' (' + asset.asset_code + ')'"></option>
                </template>
              </select>
              <small class="themed-text-muted text-xs">用户获得的资产</small>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">源资产数量 <span class="text-red-500">*</span></label>
              <input type="number" class="w-full px-3 py-2 border rounded-lg" x-model="addForm.from_amount" required min="1" placeholder="如: 10">
              <small class="themed-text-muted text-xs">每次转换所需的源资产数量</small>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">目标资产数量 <span class="text-red-500">*</span></label>
              <input type="number" class="w-full px-3 py-2 border rounded-lg" x-model="addForm.to_amount" required min="1" placeholder="如: 1">
              <small class="themed-text-muted text-xs">每次转换获得的目标资产数量</small>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">生效时间 <span class="text-red-500">*</span></label>
              <input type="datetime-local" class="w-full px-3 py-2 border rounded-lg" x-model="addForm.effective_at" required>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">启用状态</label>
              <select class="w-full px-3 py-2 border rounded-lg" x-model="addForm.is_enabled">
                <option value="1">启用</option>
                <option value="0">禁用</option>
              </select>
            </div>
          </div>
          <!-- 风控提示区域 -->
          <template x-for="warning in addValidationWarnings" :key="warning.type">
            <div class="validation-warning">
              <strong class="text-yellow-700" x-text="'⚠️ ' + warning.title + '：'"></strong>
              <span class="text-yellow-800" x-text="warning.message"></span>
            </div>
          </template>
        </form>
      </div>
      <div class="p-4 border-t flex justify-end space-x-3">
        <button @click="hideModal('addModal')" class="px-4 py-2 border rounded themed-hover-bg">取消</button>
        <button @click="submitAdd()" :disabled="submitting" class="px-4 py-2 themed-btn-primary rounded disabled:opacity-50">
          <span x-show="submitting" class="mr-1">⏳</span>
          确认添加
        </button>
      </div>
    </div>
  </div>

  <!-- 查看转换规则详情模态框（后端设计：不支持编辑，修改比例需创建新规则） -->
  <div x-ref="editModal"
       x-show="isModalShown('editModal')"
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
       @click.self="hideModal('editModal')">
    <div class="themed-card rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">📋 规则详情</h5>
        <button @click="hideModal('editModal')" class="text-gray-400 hover:themed-text-muted">✕</button>
      </div>
      <div class="p-4">
        <div class="themed-bg-primary-light border border-blue-200 rounded-lg p-3 mb-4">
          <p class="text-sm themed-text-primary">
            ℹ️ <strong>设计说明：</strong>转换规则采用版本化管理，修改比例需新增规则（禁止覆盖历史）。
            如需修改转换比例，请创建新规则并禁用旧规则。
          </p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="md:col-span-2">
            <label class="block text-sm font-medium themed-text-secondary mb-1">转换方向</label>
            <input type="text" class="w-full px-3 py-2 border rounded-lg themed-bg-subtle" x-model="editForm.direction" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">源资产数量</label>
            <input type="number" class="w-full px-3 py-2 border rounded-lg themed-bg-subtle" x-model="editForm.from_amount" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">目标资产数量</label>
            <input type="number" class="w-full px-3 py-2 border rounded-lg themed-bg-subtle" x-model="editForm.to_amount" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">生效时间</label>
            <input type="datetime-local" class="w-full px-3 py-2 border rounded-lg themed-bg-subtle" x-model="editForm.effective_at" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">启用状态</label>
            <input type="text" class="w-full px-3 py-2 border rounded-lg themed-bg-subtle" 
                   :value="editForm.is_enabled === '1' ? '已启用' : '已禁用'" disabled>
          </div>
        </div>
      </div>
      <div class="p-4 border-t flex justify-end">
        <button @click="hideModal('editModal')" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">关闭</button>
      </div>
    </div>
  </div>

  <!-- 页面专属逻辑 -->
  <%- include('partials/footer') %>
  <script type="module" src="./src/modules/system/pages/material-conversion-rules.js"></script>
</body>
</html>
