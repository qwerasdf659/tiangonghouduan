<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '对账报告', 
    pageStyle: '[x-cloak] { display: none !important; }' 
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen">
  
  <!-- 导航栏 -->
  <nav class="page-navbar">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="text-blue-200 hover:text-white transition-colors">← 返回工作台</a>
        <span class="text-lg font-semibold">📊 对账报告</span>
      </div>
    </div>
  </nav>

  <!-- 页面主体 -->
  <div class="container mx-auto px-4 py-6" x-data="reconciliationPage()" x-init="init()">
    
    <!-- 页面横幅 -->
    <div class="page-banner mb-6">
      <h1>📊 对账报告</h1>
      <p>物品守恒验证 + 资产守恒验证，一键发现数据异常</p>
    </div>

    <!-- 操作区域 -->
    <div class="flex space-x-4 mb-6">
      <button @click="runItemReconciliation()" class="themed-btn-primary px-6" :disabled="loading_items">
        <span x-show="!loading_items">🔍 物品对账</span>
        <span x-show="loading_items">对账中...</span>
      </button>
      <button @click="runAssetReconciliation()" class="themed-btn-secondary px-6" :disabled="loading_assets">
        <span x-show="!loading_assets">🔍 资产对账</span>
        <span x-show="loading_assets">对账中...</span>
      </button>
    </div>

    <!-- 物品对账结果 -->
    <template x-if="item_result">
      <div class="content-section mb-6">
        <div class="content-section-header">
          <div class="section-title">
            <span class="title-icon">📦</span>
            物品对账结果
          </div>
          <div class="text-sm text-gray-500" x-text="'检查时间：' + item_result.checked_at"></div>
        </div>
        <div class="content-section-body">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <!-- 物品守恒 -->
            <div class="rounded-lg p-4" :class="item_result.item_conservation.status === 'PASS' ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'">
              <div class="text-lg font-bold" x-text="item_result.item_conservation.status === 'PASS' ? '✅ 物品守恒' : '❌ 物品守恒'"></div>
              <div class="text-sm text-gray-600 mt-1">
                SUM(delta) GROUP BY item_id 全为 0
              </div>
              <div class="mt-2 font-medium" x-text="item_result.item_conservation.imbalanced_count + ' 个不平衡'"></div>
            </div>

            <!-- 持有者一致 -->
            <div class="rounded-lg p-4" :class="item_result.owner_consistency.status === 'PASS' ? 'bg-green-50 border border-green-200' : 'bg-yellow-50 border border-yellow-200'">
              <div class="text-lg font-bold" x-text="item_result.owner_consistency.status === 'PASS' ? '✅ 持有者一致' : '⚠️ 持有者不一致'"></div>
              <div class="text-sm text-gray-600 mt-1">
                ledger 推导持有者 == items.owner
              </div>
              <div class="mt-2 font-medium" x-text="item_result.owner_consistency.mismatch_count + ' 个不一致'"></div>
            </div>

            <!-- 铸造一致 -->
            <div class="rounded-lg p-4" :class="item_result.mint_count_consistency.status === 'PASS' ? 'bg-green-50 border border-green-200' : 'bg-yellow-50 border border-yellow-200'">
              <div class="text-lg font-bold" x-text="item_result.mint_count_consistency.status === 'PASS' ? '✅ 铸造一致' : '⚠️ 铸造不一致'"></div>
              <div class="text-sm text-gray-600 mt-1">
                items 数量 == mint 事件数量
              </div>
              <div class="mt-2 font-medium">
                items: <span x-text="item_result.mint_count_consistency.items_total"></span> / 
                mints: <span x-text="item_result.mint_count_consistency.mint_entries_total"></span>
              </div>
            </div>

          </div>
        </div>
      </div>
    </template>

    <!-- 资产对账结果 -->
    <template x-if="asset_result">
      <div class="content-section mb-6">
        <div class="content-section-header">
          <div class="section-title">
            <span class="title-icon">💎</span>
            资产对账结果
          </div>
          <div class="text-sm text-gray-500" x-text="'检查时间：' + asset_result.checked_at"></div>
        </div>
        <div class="content-section-body">
          
          <!-- 全局守恒趋势图 -->
          <div id="asset-conservation-chart" style="width: 100%; height: 300px;" class="mb-6 border rounded-lg bg-white"></div>

          <!-- 全局守恒 -->
          <h3 class="font-medium mb-3">全局守恒（SUM(delta_amount) by asset_code）</h3>
          <div class="overflow-x-auto mb-6">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-left text-sm">资产代码</th>
                  <th class="px-4 py-2 text-right text-sm">总 delta</th>
                  <th class="px-4 py-2 text-center text-sm">状态</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="(row, idx) in asset_result.global_conservation.by_asset_code" :key="idx">
                  <tr class="border-b">
                    <td class="px-4 py-2 font-mono" x-text="row.asset_code"></td>
                    <td class="px-4 py-2 text-right font-mono" x-text="row.total_delta"></td>
                    <td class="px-4 py-2 text-center" x-text="row.total_delta === 0 ? '✅' : '⚠️'"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>

          <!-- 余额一致性 -->
          <h3 class="font-medium mb-3">
            余额一致性
            <span class="text-sm font-normal" :class="asset_result.balance_consistency.status === 'PASS' ? 'text-green-600' : 'text-red-600'"
                  x-text="asset_result.balance_consistency.status === 'PASS' ? '✅ 全部一致' : '❌ ' + asset_result.balance_consistency.mismatch_count + ' 个不一致'">
            </span>
          </h3>

        </div>
      </div>
    </template>

  </div>

  <!-- 脚本 -->
  <script type="module" src="./src/modules/asset/pages/reconciliation.js"></script>
  <%- include('partials/footer') %>
</body>
</html>
