<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '抽奖管理中心', 
    pageStyle: '[x-cloak] { display: none !important; }' 
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen">
  
  <!-- 导航栏 -->
  <nav class="themed-bg-primary text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="hover:text-blue-200">← 返回工作台</a>
        <span class="text-lg font-semibold">🎁 抽奖管理中心</span>
      </div>
    </div>
  </nav>

  <!-- 页面主体 -->
  <div class="container mx-auto px-4 py-6" x-data="lotteryNavigation()" x-init="init()">
    
    <!-- 子Tab导航（根据左侧侧边栏选择自动显示对应分类的Tab） -->
    <div class="enhanced-tabs mb-6">
      <template x-for="tab in currentTabs" :key="tab.id">
        <button 
          @click="switchPage(tab.id)"
          :class="current_page === tab.id ? 'active' : ''"
          class="tab-item flex items-center gap-1.5"
        >
          <span x-text="tab.icon"></span>
          <span x-text="tab.title"></span>
        </button>
      </template>
    </div>

    <!-- 页面内容区域 -->
    <div x-data="lotteryPageContent()" x-init="init()"
         @edit-campaign="editCampaign($event.detail)"
         @view-campaign="viewCampaignDetail($event.detail)"
         @toggle-campaign="toggleCampaign($event.detail)"
         @edit-prize="editPrize($event.detail)"
         @view-budget="viewBudgetDetail($event.detail)"
         @edit-budget="openEditBudgetModal($event.detail)"
         @edit-strategy="editStrategy($event.detail)"
         @toggle-strategy="toggleStrategy($event.detail)"
         @edit-quota="editQuotaRule($event.detail)"
         @delete-quota="deleteQuotaRule($event.detail)"
         @view-abnormal-user="viewAbnormalUserDetail($event.detail)">
      
      <!-- ==================== 活动管理页 ==================== -->
      <div x-show="current_page === 'campaigns'" x-cloak>
        <!-- 统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl themed-text-primary mb-2">🎁</div>
            <h6 class="themed-text-muted text-sm mb-1">总活动数</h6>
            <h2 class="text-2xl font-bold themed-text-primary" x-text="campaignStats.total">-</h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-green-500 mb-2">▶️</div>
            <h6 class="themed-text-muted text-sm mb-1">进行中</h6>
            <h2 class="text-2xl font-bold text-green-600" x-text="campaignStats.active">-</h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-cyan-500 mb-2">👥</div>
            <h6 class="themed-text-muted text-sm mb-1">今日参与</h6>
            <h2 class="text-2xl font-bold text-cyan-600" x-text="campaignStats.today_participants">-</h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-yellow-500 mb-2">🏆</div>
            <h6 class="themed-text-muted text-sm mb-1">今日中奖</h6>
            <h2 class="text-2xl font-bold text-yellow-600" x-text="campaignStats.today_winners">-</h2>
          </div>
        </div>

        <div class="themed-card rounded-lg shadow">
          <div class="p-4 border-b flex justify-between items-center">
            <h5 class="font-semibold">🎁 活动列表</h5>
            <button @click="openCreateCampaignModal()" class="px-4 py-2 themed-bg-primary text-white rounded hover:opacity-90 transition-colors">
              ➕ 创建活动
            </button>
          </div>
          <!-- 筛选器 -->
          <div class="p-4 border-b themed-bg-base">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <select class="px-3 py-2 border rounded" x-model="campaignFilters.status" @change="loadCampaigns()">
                <option value="">全部状态</option>
                <option value="active">进行中</option>
                <option value="inactive">已结束</option>
                <option value="pending">待开始</option>
              </select>
              <input type="text" class="px-3 py-2 border rounded" placeholder="搜索活动名称..." x-model="campaignFilters.keyword">
              <button class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" @click="loadCampaigns()">
                🔍 搜索
              </button>
            </div>
          </div>
          <!-- 活动列表 -->
          <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <!-- 骨架屏加载状态 -->
              <template x-if="loading">
                <template x-for="i in 3" :key="'skeleton-campaign-' + i">
                  <div class="border rounded-lg p-4 animate-pulse">
                    <div class="flex justify-between items-start mb-2">
                      <div class="skeleton-text w-32"></div>
                      <div class="skeleton-button-sm w-16"></div>
                    </div>
                    <div class="skeleton-text-sm mb-2"></div>
                    <div class="skeleton-text-xs w-3/4 mb-3"></div>
                    <div class="flex gap-2">
                      <div class="skeleton-button flex-1"></div>
                      <div class="skeleton-button-sm w-16"></div>
                    </div>
                  </div>
                </template>
              </template>
              <!-- 空状态 -->

                <div x-show="campaigns.length === 0 && !loading" class="col-span-3 py-12">
                  <div class="flex flex-col items-center justify-center text-center">
                    <div class="text-6xl mb-4">🎁</div>
                    <h3 class="text-lg font-medium themed-text mb-2">暂无活动数据</h3>
                    <p class="themed-text-muted text-sm mb-4">点击上方按钮创建您的第一个抽奖活动</p>
                    <button @click="openCreateCampaignModal()" class="px-4 py-2 themed-bg-primary text-white rounded-lg hover:opacity-90 transition-opacity">
                      ➕ 创建活动
                    </button>
                  </div>
                </div>

              <!-- 数据列表 -->
              <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
                <div class="border rounded-lg p-4 hover:shadow-md transition-shadow relative">
                  <!-- 库存预警标志 -->
                  <div x-show="campaign.stock_warning?.is_warning" class="absolute -top-2 -right-2 z-10">
                    <span class="inline-flex items-center px-2 py-1 text-xs font-bold bg-red-500 text-white rounded-full animate-pulse">
                      ⚠️ 库存
                    </span>
                  </div>
                  <div class="flex justify-between items-start mb-2">
                    <h6 class="font-medium" x-text="campaign.campaign_name"></h6>
                    <span class="px-2 py-1 text-xs rounded" :class="getCampaignStatusClass(campaign.status)" x-text="campaign.status_display || campaign.status"></span>
                  </div>
                  <p class="themed-text-muted text-sm mb-2 line-clamp-1" x-text="campaign.description || '暂无描述'"></p>
                  <!-- 展示配置标签（display_mode + effect_theme） -->
                  <div class="flex gap-1 flex-wrap mb-2">
                    <span class="px-2 py-0.5 text-xs rounded bg-blue-50 text-blue-600" x-text="(displayModeOptions.find(o => o.value === campaign.display_mode) || {}).icon + ' ' + (displayModeOptions.find(o => o.value === campaign.display_mode) || { label: '九宫格' }).label"></span>
                    <span class="px-2 py-0.5 text-xs rounded bg-purple-50 text-purple-600" x-text="'🎨 ' + (effectThemeOptions.find(o => o.value === campaign.effect_theme) || { label: '默认' }).label"></span>
                  </div>
                  
                  <!-- P1新增: ROI/复抽率/库存预警数据条 -->
                  <div class="grid grid-cols-3 gap-2 my-3 text-center text-xs bg-gray-50 rounded-lg p-2">
                    <!-- ROI 指标 -->
                    <div class="flex flex-col items-center">
                      <span class="themed-text-muted">ROI</span>
                      <span class="font-bold"
                            :class="(campaign.roi || 0) >= 0 ? 'text-green-600' : 'text-red-600'"
                            x-text="campaign.roi !== null && campaign.roi !== undefined ? (campaign.roi >= 0 ? '+' : '') + parseFloat(campaign.roi).toFixed(1) + '%' : '-'">
                      </span>
                    </div>
                    <!-- 复抽率 -->
                    <div class="flex flex-col items-center">
                      <span class="themed-text-muted">复抽率</span>
                      <span class="font-bold text-blue-600" 
                            x-text="campaign.repeat_rate !== null && campaign.repeat_rate !== undefined ? parseFloat(campaign.repeat_rate).toFixed(1) + '%' : '-'">
                      </span>
                    </div>
                    <!-- 库存状态 -->
                    <div class="flex flex-col items-center">
                      <span class="themed-text-muted">库存</span>
                      <span class="font-bold"
                            :class="campaign.stock_warning?.is_warning ? 'text-red-600' : 'text-gray-600'"
                            x-text="campaign.stock_warning?.low_stock_count > 0 ? campaign.stock_warning.low_stock_count + '项预警' : '正常'">
                      </span>
                    </div>
                  </div>
                  
                  <div class="flex justify-between items-center text-gray-400 text-sm">
                    <span>📅 <span x-text="formatDateOnly(campaign.start_time)"></span></span>
                    <span>👥 <span x-text="campaign.participant_count || 0"></span></span>
                  </div>
                  <div class="mt-3 flex gap-2 flex-wrap">
                    <button class="flex-1 px-3 py-1 text-sm border themed-border-primary themed-text-primary rounded hover:bg-blue-50" @click="editCampaign(campaign)">
                      ✏️ 编辑
                    </button>
                    <button class="px-3 py-1 text-sm border border-cyan-500 text-cyan-500 rounded hover:bg-cyan-50" @click="viewCampaignDetail(campaign)">
                      👁️ 详情
                    </button>
                    <button class="px-3 py-1 text-sm border border-purple-500 text-purple-500 rounded hover:bg-purple-50" @click="openCampaignRoiModal(campaign)">
                      📊 分析
                    </button>
                    <button class="px-3 py-1 text-sm border border-green-500 text-green-500 rounded hover:bg-green-50" @click="openCampaignReport(campaign.lottery_campaign_id)">
                      📋 复盘
                    </button>
                    <button class="px-3 py-1 text-sm border border-yellow-500 text-yellow-500 rounded hover:bg-yellow-50" @click="toggleCampaign(campaign)" x-text="campaign.status === 'active' ? '⏸️ 停止' : '▶️ 启动'"></button>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== 奖品管理页 ==================== -->
      <div x-show="current_page === 'prizes'" x-cloak>
        <!-- 奖品发放统计卡片 - 渐变风格 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="gradient-stat-card gradient-stat-rose">
            <div class="flex items-center justify-between">
              <div>
                <p class="stat-label">今日发放</p>
                <p class="stat-value" x-text="prizeIssuedStats.today_issued || 0"></p>
              </div>
              <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl">🎁</div>
            </div>
          </div>
          <div class="gradient-stat-card gradient-stat-green">
            <div class="flex items-center justify-between">
              <div>
                <p class="stat-label">发放价值</p>
                <p class="stat-value" x-text="'¥' + (prizeIssuedStats.total_value || 0).toLocaleString()"></p>
              </div>
              <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl">💰</div>
            </div>
          </div>
          <div class="gradient-stat-card gradient-stat-indigo">
            <div class="flex items-center justify-between">
              <div>
                <p class="stat-label">奖品总数</p>
                <p class="stat-value" x-text="prizes.length"></p>
              </div>
              <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl">📦</div>
            </div>
          </div>
          <div class="gradient-stat-card" :class="prizeIssuedStats.low_stock_count > 0 ? 'bg-gradient-to-br from-red-500 to-rose-600' : 'gradient-stat-teal'">
            <div class="flex items-center justify-between">
              <div>
                <p class="stat-label">低库存预警</p>
                <p class="stat-value" x-text="prizeIssuedStats.low_stock_count || 0"></p>
              </div>
              <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl" :class="prizeIssuedStats.low_stock_count > 0 ? 'animate-pulse' : ''">⚠️</div>
            </div>
          </div>
        </div>

        <!-- P2新增: 奖品发放分布（迷你版） -->
        <div x-show="prizeDistributionDetail.length > 0" class="themed-card rounded-lg shadow p-4 mb-6">
          <h6 class="font-semibold text-sm mb-3 flex items-center gap-2">
            📊 今日发放分布
            <button class="text-xs themed-text-primary" @click="loadPrizeIssuedStats()">🔄 刷新</button>
          </h6>
          <div class="flex flex-wrap gap-2">
            <template x-for="stat in prizeDistributionDetail.slice(0, 6)" :key="stat.prize_id || stat.prize_name">
              <div class="inline-flex items-center gap-1 px-3 py-1 bg-gray-100 rounded-full text-xs">
                <span x-text="stat.prize_name || '未知奖品'"></span>
                <span class="font-bold text-blue-600" x-text="(stat.issued_count || stat.count || 0) + '个'"></span>
                <span class="themed-text-muted" x-text="'(' + getPrizeIssuedPercentage(stat) + '%)'"></span>
              </div>
            </template>
            <span x-show="prizeDistributionDetail.length > 6" class="text-xs themed-text-muted self-center">
              +<span x-text="prizeDistributionDetail.length - 6"></span>更多
            </span>
          </div>
        </div>

        <div class="themed-card rounded-lg shadow">
          <div class="p-4 border-b flex justify-between items-center">
            <h5 class="font-semibold">🏆 奖品管理</h5>
            <div class="flex gap-2">
              <button @click="openBatchPrizeModal()" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary transition-colors">
                📦 批量配置奖品
              </button>
              <button @click="openCreatePrizeModal()" class="px-4 py-2 themed-btn-primary rounded transition-colors">
                ➕ 单个添加
              </button>
            </div>
          </div>
          <!-- 筛选器 -->
          <div class="p-4 border-b themed-bg-base">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
              <select class="px-3 py-2 border rounded" x-model="prizeFilters.prize_type" @change="loadPrizes()">
                <option value="">全部类型</option>
                <option value="physical">实物奖品</option>
                <option value="virtual">虚拟奖品</option>
                <option value="coupon">优惠券</option>
              </select>
              <select class="px-3 py-2 border rounded" x-model="prizeFilters.status" @change="loadPrizes()">
                <option value="">全部状态</option>
                <option value="active">启用</option>
                <option value="inactive">禁用</option>
              </select>
              <input type="text" class="px-3 py-2 border rounded" placeholder="搜索奖品名称..." x-model="prizeFilters.keyword">
              <button class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" @click="loadPrizes()">
                🔍 搜索
              </button>
            </div>
          </div>
          <!-- 奖品表格 -->
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="themed-bg-base">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">奖品</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">类型</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">稀有度</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">概率</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">库存</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">状态</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                <tr x-show="prizes.length === 0">
                  <td colspan="8" class="px-4 py-8 text-center themed-text-muted">暂无奖品数据</td>
                </tr>
                <template x-for="prize in prizes" :key="prize.lottery_prize_id">
                  <tr class="themed-hover-bg">
                    <td class="px-4 py-3">
                      <div class="flex items-center">
                        <div class="w-12 h-12 rounded overflow-hidden mr-3 img-blur-load">
                          <img :data-src="prize.image_url || '/admin/images/placeholder.svg'" 
                               :alt="prize.prize_name" 
                               class="w-full h-full object-cover img-lazy"
                               x-init="$nextTick(() => { $el.src = prize.image_url || '/admin/images/placeholder.svg'; $el.classList.add('loaded') })"
                               @error="$el.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><rect width=%22100%22 height=%22100%22 fill=%22%23e5e7eb%22/></svg>'">
                        </div>
                        <div>
                          <div class="font-medium" x-text="prize.prize_name"></div>
                          <small class="text-gray-400" x-text="prize.lottery_prize_id"></small>
                        </div>
                      </div>
                    </td>
                    <td class="px-4 py-3"><span class="px-2 py-1 text-xs rounded bg-cyan-100 text-cyan-700" x-text="prize.prize_type_display || prize.prize_type"></span></td>
                    <!-- 稀有度（rarity_code 来自 rarity_defs 表） -->
                    <td class="px-4 py-3">
                      <span class="px-2 py-1 text-xs rounded text-white"
                            :style="'background:' + (rarityOptions.find(o => o.value === prize.rarity_code) || { color: '#9E9E9E' }).color"
                            x-text="(rarityOptions.find(o => o.value === prize.rarity_code) || { label: '普通' }).label">
                      </span>
                    </td>
                    <!-- sort_order 九宫格位置 -->
                    <td class="px-4 py-3">
                      <span class="px-2 py-1 text-xs rounded bg-indigo-100 text-indigo-700 font-mono"
                            x-text="prize.sort_order != null ? '#' + prize.sort_order : '-'"></span>
                    </td>
                    <td class="px-4 py-3 text-sm" x-text="(prize.win_probability * 100).toFixed(1) + '%'"></td>
                    <td class="px-4 py-3 text-sm" x-text="prize.stock_quantity >= 999999 ? '无限' : prize.stock_quantity"></td>
                    <td class="px-4 py-3">
                      <span class="px-2 py-1 text-xs rounded" :class="isPrizeActive(prize) ? 'bg-green-100 themed-text-success' : 'themed-bg-subtle themed-text-secondary'" x-text="isPrizeActive(prize) ? '启用' : '禁用'"></span>
                    </td>
                    <td class="px-4 py-3">
                      <div class="flex space-x-2">
                        <button class="themed-text-primary hover:text-blue-700 text-sm" @click="editPrize(prize)">编辑</button>
                        <button class="text-green-500 hover:text-green-700 text-sm" @click="openStockModal(prize)">补货</button>
                        <button class="text-yellow-500 hover:text-yellow-700 text-sm" @click="togglePrize(prize)" x-text="isPrizeActive(prize) ? '禁用' : '启用'"></button>
                        <button class="text-red-500 hover:text-red-700 text-sm" @click="deletePrize(prize)">删除</button>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ==================== 预算管理页 ==================== -->
      <div x-show="current_page === 'campaign-budget'" x-cloak>
        <!-- 预算汇总卡片 - 渐变风格 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="gradient-stat-card gradient-stat-blue">
            <div class="flex items-center justify-between">
              <div>
                <p class="stat-label">总预算</p>
                <p class="stat-value text-2xl" x-text="'¥' + (budgetSummary.total_budget || 0).toLocaleString()">-</p>
              </div>
              <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl">💰</div>
            </div>
          </div>
          <div class="gradient-stat-card gradient-stat-green">
            <div class="flex items-center justify-between">
              <div>
                <p class="stat-label">已使用</p>
                <p class="stat-value text-2xl" x-text="'¥' + (budgetSummary.total_used || 0).toLocaleString()">-</p>
              </div>
              <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl">💵</div>
            </div>
          </div>
          <div class="gradient-stat-card gradient-stat-orange">
            <div class="flex items-center justify-between">
              <div>
                <p class="stat-label">剩余预算</p>
                <p class="stat-value text-2xl" x-text="'¥' + (budgetSummary.total_remaining || 0).toLocaleString()">-</p>
              </div>
              <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl">🏦</div>
            </div>
          </div>
          <div class="gradient-stat-card gradient-stat-purple">
            <div class="flex items-center justify-between">
              <div>
                <p class="stat-label">活动总数</p>
                <p class="stat-value text-2xl" x-text="budgetSummary.total_campaigns || 0">-</p>
              </div>
              <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl">📊</div>
            </div>
          </div>
        </div>

        <div class="themed-card rounded-lg shadow">
          <div class="p-4 border-b flex justify-between items-center">
            <h5 class="font-semibold">💰 活动预算列表</h5>
          </div>
          <!-- 筛选器 -->
          <div class="p-4 border-b themed-bg-base">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <select class="px-3 py-2 border rounded" x-model="budgetFilters.budget_type" @change="loadBudgetData()">
                <option value="">全部模式</option>
                <option value="pool">总预算</option>
                <option value="daily">每日预算</option>
                <option value="user">用户预算</option>
              </select>
              <!-- 活动状态筛选（使用后端字段 status: draft/active/paused/ended/cancelled） -->
              <select class="px-3 py-2 border rounded" x-model="budgetFilters.status" @change="loadBudgetData()">
                <option value="">全部状态</option>
                <option value="active">进行中</option>
                <option value="draft">草稿</option>
                <option value="paused">已暂停</option>
                <option value="ended">已结束</option>
                <option value="cancelled">已取消</option>
              </select>
              <button class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" @click="loadBudgetData()">
                🔍 刷新
              </button>
            </div>
          </div>
          <!-- 预算列表表格 - data-table 组件 (#9) -->
          <div x-data="dataTable({ page_size: 50 })" x-effect="setData(budgetCampaigns, budgetCampaigns.length)">
            <!-- 空状态 -->
            <div x-show="isEmpty" class="p-8 text-center themed-text-muted">
              <div class="text-4xl mb-2">📭</div>
              <p>暂无预算数据</p>
            </div>
            <!-- 错误状态 -->
            <div x-show="hasError" class="p-8 text-center">
              <div class="text-4xl mb-2">❌</div>
              <p class="text-red-500 mb-2" x-text="error"></p>
              <button @click="loadBudgetData()" class="px-4 py-2 themed-btn-primary rounded text-sm">🔄 重试</button>
            </div>
            <!-- 表格 -->
            <div x-show="hasData" class="overflow-x-auto">
              <table class="w-full">
                <thead class="themed-bg-base">
                  <tr>
                    <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">活动名称</th>
                    <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">预算模式</th>
                    <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">预算金额</th>
                    <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">已使用</th>
                    <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">使用率</th>
                    <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">状态</th>
                    <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
                  </tr>
                </thead>
                <tbody class="divide-y">
                  <template x-for="campaign in data" :key="campaign.lottery_campaign_id">
                    <tr class="themed-hover-bg">
                      <td class="px-4 py-3 text-sm" x-text="campaign.campaign_name"></td>
                      <td class="px-4 py-3"><span class="px-2 py-1 text-xs rounded bg-cyan-100 text-cyan-700" x-text="campaign.budget_mode_display || campaign.budget_mode"></span></td>
                      <td class="px-4 py-3 text-sm" x-text="'¥' + (campaign.pool_budget?.total || 0).toLocaleString()"></td>
                      <td class="px-4 py-3 text-sm" x-text="'¥' + (campaign.pool_budget?.used || 0).toLocaleString()"></td>
                      <td class="px-4 py-3">
                        <div class="w-full themed-bg-muted rounded-full h-4">
                          <div class="h-4 rounded-full text-xs text-white text-center" 
                               :class="getBudgetUsageClass(campaign)"
                               :style="'width: ' + Math.min(getBudgetUsageRate(campaign), 100) + '%'"
                               x-text="getBudgetUsageRate(campaign) + '%'"></div>
                        </div>
                      </td>
                      <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs rounded" 
                              :class="getBudgetUsageRate(campaign) >= 100 ? 'bg-red-100 text-red-700' : (getBudgetUsageRate(campaign) >= 80 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 themed-text-success')"
                              x-text="getBudgetUsageRate(campaign) >= 100 ? '超支' : (getBudgetUsageRate(campaign) >= 80 ? '预警' : '正常')"></span>
                      </td>
                      <td class="px-4 py-3 space-x-2">
                        <button class="themed-text-primary hover:text-blue-700 text-sm" @click="openSetBudgetModal(campaign.lottery_campaign_id)">设置</button>
                        <button class="text-cyan-600 hover:text-cyan-800 text-sm" @click="viewBudgetTrend(campaign)">📈 趋势</button>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
            <!-- 分页 -->
            <div x-show="total_pages > 1" class="p-4 border-t flex justify-between items-center">
              <span class="text-sm themed-text-muted" x-text="paginationInfo"></span>
              <div class="flex gap-1">
                <button @click="prevPage()" :disabled="!hasPrevPage" class="px-3 py-1 rounded themed-btn-secondary text-sm disabled:opacity-50">上一页</button>
                <template x-for="p in visiblePages" :key="'bp-'+p">
                  <button @click="goToPage(p)" :class="p === current_page ? 'themed-bg-primary text-white' : 'themed-hover-bg'" class="px-3 py-1 border rounded text-sm" :disabled="p === '...'" x-text="p"></button>
                </template>
                <button @click="nextPage()" :disabled="!hasNextPage" class="px-3 py-1 rounded themed-btn-secondary text-sm disabled:opacity-50">下一页</button>
              </div>
            </div>
          </div>
        </div>

        <!-- P1新增: 预算消耗趋势图区域 -->
        <div class="themed-card rounded-lg shadow mt-6 p-4">
          <h6 class="font-semibold mb-4 flex items-center gap-2">
            📈 预算消耗趋势
            <span class="text-xs font-normal themed-text-muted">(选择活动查看详情)</span>
          </h6>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- 活动选择器 -->
            <div class="flex items-center gap-4">
              <label class="text-sm themed-text-secondary shrink-0">选择活动:</label>
              <select 
                class="flex-1 px-3 py-2 border rounded text-sm"
                x-model.number="selectedBudgetCampaignId"
                @change="loadBudgetTrendData(selectedBudgetCampaignId)"
              >
                <option value="">请选择活动</option>
                <template x-for="campaign in budgetCampaigns" :key="campaign.lottery_campaign_id">
                  <option :value="campaign.lottery_campaign_id" x-text="campaign.campaign_name"></option>
                </template>
              </select>
              <button 
                class="px-4 py-2 themed-bg-primary text-white rounded text-sm disabled:opacity-50"
                :disabled="!selectedBudgetCampaignId"
                @click="initBudgetTrendChart()"
              >
                🔄 刷新
              </button>
            </div>
            <!-- 快捷统计 -->
            <div class="flex items-center justify-end gap-6 text-sm">
              <template x-if="selectedBudgetCampaignId && budgetTrendData.length > 0">
                <div class="flex gap-6">
                  <span class="themed-text-muted">
                    7天累计: <span class="font-bold text-red-600" x-text="'¥' + (budgetTrendData[budgetTrendData.length-1]?.cumulative || 0).toLocaleString()"></span>
                  </span>
                  <span class="themed-text-muted">
                    日均消耗: <span class="font-bold text-blue-600" x-text="'¥' + Math.round((budgetTrendData.reduce((sum,d) => sum + d.daily, 0) / 7)).toLocaleString()"></span>
                  </span>
                </div>
              </template>
            </div>
          </div>
          <!-- 趋势图容器 -->
          <div id="budget-trend-chart" class="w-full h-64 mt-4"></div>
        </div>
      </div>

      <!-- ==================== 活动投放位置配置页 ==================== -->
      <div x-show="current_page === 'campaign-placement'" x-cloak>
        <div class="themed-card rounded-lg shadow p-6">
          <div class="flex items-center justify-between mb-6">
            <h5 class="font-semibold text-lg">📍 活动投放位置配置</h5>
            <div class="flex gap-2">
              <button @click="addPlacement()"
                      class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
                ➕ 添加位置
              </button>
              <button @click="savePlacements()"
                      :disabled="savingPlacement"
                      class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm disabled:opacity-50">
                <span x-show="!savingPlacement">💾 保存配置</span>
                <span x-show="savingPlacement">保存中...</span>
              </button>
            </div>
          </div>

          <p class="text-sm themed-text-muted mb-4">
            配置每个活动在小程序端的展示位置和尺寸。保存后立即生效，用户下次打开页面自动获取最新配置。
          </p>

          <!-- 校验错误提示 -->
          <template x-if="placementErrors.length > 0">
            <div class="bg-red-50 border border-red-200 rounded p-3 mb-4">
              <p class="text-red-600 text-sm font-medium mb-1">⚠️ 校验失败：</p>
              <ul class="text-red-500 text-xs list-disc pl-4">
                <template x-for="err in placementErrors" :key="err">
                  <li x-text="err"></li>
                </template>
              </ul>
            </div>
          </template>

          <!-- 空状态 -->
          <template x-if="placements.length === 0 && !loading">
            <div class="text-center py-12 themed-text-muted">
              <p class="text-4xl mb-2">📍</p>
              <p>暂无位置配置，点击"添加位置"开始配置</p>
            </div>
          </template>

          <!-- 位置配置列表 -->
          <div class="space-y-4">
            <template x-for="(item, index) in placements" :key="index">
              <div class="border rounded-lg p-4 themed-bg-base relative">
                <div class="absolute top-2 right-2">
                  <button @click="removePlacement(index)"
                          class="text-red-400 hover:text-red-600 text-sm px-2 py-1">
                    🗑️ 删除
                  </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                  <!-- 活动代码 -->
                  <div>
                    <label class="block text-xs font-medium themed-text-muted mb-1">活动代码</label>
                    <select class="w-full px-2 py-1.5 border rounded text-sm" x-model="item.campaign_code">
                      <option value="">请选择活动</option>
                      <template x-for="c in (campaigns || [])" :key="c.campaign_code">
                        <option :value="c.campaign_code" x-text="c.campaign_name + '（' + c.campaign_code + '）'"></option>
                      </template>
                    </select>
                  </div>

                  <!-- 展示页面 -->
                  <div>
                    <label class="block text-xs font-medium themed-text-muted mb-1">展示页面</label>
                    <select class="w-full px-2 py-1.5 border rounded text-sm" x-model="item.placement.page">
                      <template x-for="opt in placementEnums.pages" :key="opt.value">
                        <option :value="opt.value" x-text="opt.label"></option>
                      </template>
                    </select>
                  </div>

                  <!-- 页面位置 -->
                  <div>
                    <label class="block text-xs font-medium themed-text-muted mb-1">页面位置</label>
                    <select class="w-full px-2 py-1.5 border rounded text-sm" x-model="item.placement.position">
                      <template x-for="opt in placementEnums.positions" :key="opt.value">
                        <option :value="opt.value" x-text="opt.label"></option>
                      </template>
                    </select>
                  </div>

                  <!-- 组件尺寸 -->
                  <div>
                    <label class="block text-xs font-medium themed-text-muted mb-1">组件尺寸</label>
                    <select class="w-full px-2 py-1.5 border rounded text-sm" x-model="item.placement.size">
                      <template x-for="opt in placementEnums.sizes" :key="opt.value">
                        <option :value="opt.value" x-text="opt.label"></option>
                      </template>
                    </select>
                  </div>

                  <!-- 优先级 -->
                  <div>
                    <label class="block text-xs font-medium themed-text-muted mb-1">优先级 (0-1000)</label>
                    <input type="number" min="0" max="1000" step="1"
                           class="w-full px-2 py-1.5 border rounded text-sm"
                           x-model.number="item.placement.priority">
                  </div>
                </div>

                <!-- 配置摘要标签 -->
                <div class="flex gap-2 mt-2 flex-wrap">
                  <span class="px-2 py-0.5 text-xs rounded bg-blue-50 text-blue-600"
                        x-text="'📄 ' + getPageLabel(item.placement.page)"></span>
                  <span class="px-2 py-0.5 text-xs rounded bg-green-50 text-green-600"
                        x-text="'📌 ' + getPositionLabel(item.placement.position)"></span>
                  <span class="px-2 py-0.5 text-xs rounded bg-purple-50 text-purple-600"
                        x-text="'📐 ' + getSizeLabel(item.placement.size)"></span>
                  <span class="px-2 py-0.5 text-xs rounded bg-yellow-50 text-yellow-700"
                        x-text="'⬆️ 优先级: ' + (item.placement.priority || 0)"></span>
                </div>
              </div>
            </template>
          </div>

          <!-- 可视化预览：按页面分组 -->
          <template x-if="placements.length > 0">
            <div class="mt-6 border-t pt-4">
              <h6 class="font-semibold text-sm mb-3">👁️ 页面投放预览</h6>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <template x-for="pageDef in placementEnums.pages" :key="pageDef.value">
                  <div class="border rounded-lg p-3">
                    <p class="text-sm font-medium mb-2" x-text="pageDef.label"></p>
                    <div class="space-y-1">
                      <template x-for="item in placements.filter(p => p.placement.page === pageDef.value).sort((a,b) => (b.placement.priority || 0) - (a.placement.priority || 0))" :key="item.campaign_code + '_' + pageDef.value">
                        <div class="flex items-center justify-between px-2 py-1 bg-gray-50 rounded text-xs">
                          <span class="font-mono" x-text="item.campaign_code"></span>
                          <div class="flex gap-1">
                            <span class="px-1 py-0.5 rounded text-white text-[10px]"
                                  :class="item.placement.position === 'main' ? 'bg-red-500' : 'bg-gray-400'"
                                  x-text="getPositionLabel(item.placement.position)"></span>
                            <span class="px-1 py-0.5 rounded bg-blue-100 text-blue-600 text-[10px]"
                                  x-text="getSizeLabel(item.placement.size)"></span>
                          </div>
                        </div>
                      </template>
                      <template x-if="placements.filter(p => p.placement.page === pageDef.value).length === 0">
                        <p class="text-xs themed-text-muted text-center py-2">暂无活动</p>
                      </template>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </template>
        </div>

        <!-- 九宫格位置预览（sort_order 1-8 顺时针排列参考图） -->
        <div class="themed-card rounded-lg shadow p-6 mt-4">
          <h6 class="font-semibold text-sm mb-3">🎰 九宫格 sort_order 位置参考</h6>
          <p class="text-xs themed-text-muted mb-3">奖品的 sort_order 字段对应九宫格中的位置（顺时针 1→8），中间为抽奖按钮。</p>
          <div class="grid grid-cols-3 gap-2 max-w-xs mx-auto">
            <div class="border rounded p-3 text-center text-sm bg-blue-50">
              <span class="font-bold text-blue-600">1</span>
              <br><span class="text-xs themed-text-muted">左上</span>
            </div>
            <div class="border rounded p-3 text-center text-sm bg-blue-50">
              <span class="font-bold text-blue-600">2</span>
              <br><span class="text-xs themed-text-muted">中上</span>
            </div>
            <div class="border rounded p-3 text-center text-sm bg-blue-50">
              <span class="font-bold text-blue-600">3</span>
              <br><span class="text-xs themed-text-muted">右上</span>
            </div>
            <div class="border rounded p-3 text-center text-sm bg-blue-50">
              <span class="font-bold text-blue-600">8</span>
              <br><span class="text-xs themed-text-muted">左中</span>
            </div>
            <div class="border rounded p-3 text-center text-sm bg-yellow-50 border-yellow-300">
              <span class="font-bold text-yellow-600">🎰</span>
              <br><span class="text-xs text-yellow-600">抽奖</span>
            </div>
            <div class="border rounded p-3 text-center text-sm bg-blue-50">
              <span class="font-bold text-blue-600">4</span>
              <br><span class="text-xs themed-text-muted">右中</span>
            </div>
            <div class="border rounded p-3 text-center text-sm bg-blue-50">
              <span class="font-bold text-blue-600">7</span>
              <br><span class="text-xs themed-text-muted">左下</span>
            </div>
            <div class="border rounded p-3 text-center text-sm bg-blue-50">
              <span class="font-bold text-blue-600">6</span>
              <br><span class="text-xs themed-text-muted">中下</span>
            </div>
            <div class="border rounded p-3 text-center text-sm bg-blue-50">
              <span class="font-bold text-blue-600">5</span>
              <br><span class="text-xs themed-text-muted">右下</span>
            </div>
          </div>
          <p class="text-xs themed-text-muted text-center mt-2">动画路径：1 → 2 → 3 → 4 → 5 → 6 → 7 → 8 → 1 → ...</p>
        </div>
      </div>

      <!-- ==================== 策略配置页 ==================== -->
      <div x-show="current_page === 'lottery-strategy'" x-cloak x-init="$nextTick(() => loadStrategyConfigSummary())">
        <!-- 页面引导说明 -->
        <div class="rounded-lg p-4 mb-6 bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg">
          <div class="flex items-start gap-3">
            <span class="text-2xl mt-0.5">💡</span>
            <div>
              <h5 class="font-semibold text-lg mb-1">策略配置中心</h5>
              <p class="text-sm opacity-90">管理抽奖系统的核心策略参数。策略按功能分组，每个参数控制不同的出奖行为。修改后将实时影响用户抽奖体验。</p>
              <div class="flex flex-wrap gap-3 mt-3 text-xs">
                <span class="px-2 py-1 bg-white/20 rounded">🎲 概率 - 控制出奖概率</span>
                <span class="px-2 py-1 bg-white/20 rounded">🛡️ 保护 - 防止极端体验</span>
                <span class="px-2 py-1 bg-white/20 rounded">💰 预算 - 控制成本</span>
                <span class="px-2 py-1 bg-white/20 rounded">👤 用户 - 个人限制</span>
              </div>
            </div>
          </div>
        </div>

        <!-- ===== 运营辅助信息：策略配置概览 ===== -->
        <template x-if="strategyConfigSummary && !loadingConfigSummary">
          <div class="mb-6 space-y-4">
            <!-- 第一行：配置总览 + 关联活动 + 最近24h执行概况 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <!-- 配置总览 -->
              <div class="rounded-xl shadow-sm overflow-hidden border border-gray-100">
                <div class="bg-gradient-to-br from-indigo-50 to-blue-50 p-4">
                  <div class="flex items-center justify-between mb-3">
                    <span class="inline-flex items-center justify-center w-9 h-9 rounded-lg bg-indigo-100">
                      <span class="text-lg">⚙️</span>
                    </span>
                    <span class="text-xs text-indigo-500 font-medium">配置总览</span>
                  </div>
                  <div class="space-y-2">
                    <div class="flex items-center justify-between">
                      <span class="text-xs text-gray-500">策略参数</span>
                      <span class="text-sm font-semibold text-gray-800">
                        <span x-text="strategyConfigSummary.config_overview.active_strategies"></span>
                        <span class="text-xs text-gray-400 font-normal">/ <span x-text="strategyConfigSummary.config_overview.total_strategies"></span> 项</span>
                      </span>
                    </div>
                    <div class="flex items-center justify-between">
                      <span class="text-xs text-gray-500">矩阵配置</span>
                      <span class="text-sm font-semibold text-gray-800">
                        <span x-text="strategyConfigSummary.config_overview.active_matrix_configs"></span>
                        <span class="text-xs text-gray-400 font-normal">/ <span x-text="strategyConfigSummary.config_overview.matrix_configs"></span> 组</span>
                      </span>
                    </div>
                    <div class="flex items-center justify-between">
                      <span class="text-xs text-gray-500">策略分组</span>
                      <span class="text-sm font-semibold text-gray-800" x-text="Object.keys(strategyConfigSummary.config_overview.config_groups).length + ' 组'"></span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 关联活动 -->
              <div class="rounded-xl shadow-sm overflow-hidden border border-gray-100">
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-4">
                  <div class="flex items-center justify-between mb-3">
                    <span class="inline-flex items-center justify-center w-9 h-9 rounded-lg bg-green-100">
                      <span class="text-lg">🎯</span>
                    </span>
                    <span class="text-xs text-green-600 font-medium">关联活动</span>
                  </div>
                  <div class="space-y-2">
                    <div class="flex items-center justify-between">
                      <span class="text-xs text-gray-500">活跃活动</span>
                      <span class="text-sm font-semibold" :class="strategyConfigSummary.active_campaigns.length > 0 ? 'text-green-600' : 'text-gray-400'"
                            x-text="strategyConfigSummary.active_campaigns.length + ' 个'"></span>
                    </div>
                    <template x-for="campaign in strategyConfigSummary.active_campaigns.slice(0, 3)" :key="campaign.lottery_campaign_id">
                      <div class="flex items-center gap-2 text-xs">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-400 shrink-0"></span>
                        <span class="text-gray-600 truncate" x-text="campaign.campaign_name"></span>
                        <span class="text-gray-400 shrink-0" x-text="campaign.pick_method"></span>
                      </div>
                    </template>
                    <div x-show="strategyConfigSummary.active_campaigns.length === 0" class="text-xs text-gray-400 italic">暂无活跃活动</div>
                  </div>
                </div>
              </div>

              <!-- 最近24h执行概况 -->
              <div class="rounded-xl shadow-sm overflow-hidden border border-gray-100">
                <div class="bg-gradient-to-br from-purple-50 to-violet-50 p-4">
                  <div class="flex items-center justify-between mb-3">
                    <span class="inline-flex items-center justify-center w-9 h-9 rounded-lg bg-purple-100">
                      <span class="text-lg">📊</span>
                    </span>
                    <span class="text-xs text-purple-500 font-medium">最近24小时</span>
                  </div>
                  <div class="space-y-2">
                    <div class="flex items-center justify-between">
                      <span class="text-xs text-gray-500">抽奖总数</span>
                      <span class="text-sm font-semibold text-gray-800" x-text="strategyConfigSummary.recent_24h.total_draws.toLocaleString()"></span>
                    </div>
                    <div class="flex items-center justify-between">
                      <span class="text-xs text-gray-500">保底触发</span>
                      <span class="text-sm font-semibold" :class="strategyConfigSummary.recent_24h.guarantee_rate > 0.15 ? 'text-orange-600' : 'text-gray-800'">
                        <span x-text="strategyConfigSummary.recent_24h.guarantee_triggered"></span>
                        <span class="text-xs text-gray-400 font-normal" x-text="'(' + (strategyConfigSummary.recent_24h.guarantee_rate * 100).toFixed(1) + '%)'"></span>
                      </span>
                    </div>
                    <div class="flex items-center justify-between">
                      <span class="text-xs text-gray-500">平均消耗</span>
                      <span class="text-sm font-semibold text-gray-800" x-text="strategyConfigSummary.recent_24h.avg_cost + ' 积分'"></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 第二行：档位分布 + BxPx命中热力 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- 档位分布 -->
              <div class="rounded-xl shadow-sm border border-gray-100 p-4 bg-white">
                <h6 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                  🎰 最近24小时档位分布
                  <span class="text-xs font-normal text-gray-400" x-text="'总计 ' + strategyConfigSummary.recent_24h.total_draws + ' 次'"></span>
                </h6>
                <div x-show="strategyConfigSummary.recent_24h.total_draws === 0" class="text-center py-4 text-xs text-gray-400">暂无抽奖数据</div>
                <div x-show="strategyConfigSummary.recent_24h.total_draws > 0" class="space-y-2">
                  <!-- high -->
                  <div class="flex items-center gap-2">
                    <span class="text-xs w-14 text-gray-500 shrink-0">高档位</span>
                    <div class="flex-1 bg-gray-100 rounded-full h-5 overflow-hidden">
                      <div class="h-full rounded-full bg-gradient-to-r from-red-400 to-red-500 transition-all flex items-center justify-end pr-1"
                           :style="'width:' + getConfigSummaryTierPercent('high')">
                        <span class="text-[10px] text-white font-medium" x-text="strategyConfigSummary.recent_24h.tier_distribution.high"></span>
                      </div>
                    </div>
                    <span class="text-xs w-10 text-right font-medium text-gray-600" x-text="getConfigSummaryTierPercent('high')"></span>
                  </div>
                  <!-- mid -->
                  <div class="flex items-center gap-2">
                    <span class="text-xs w-14 text-gray-500 shrink-0">中档位</span>
                    <div class="flex-1 bg-gray-100 rounded-full h-5 overflow-hidden">
                      <div class="h-full rounded-full bg-gradient-to-r from-yellow-400 to-yellow-500 transition-all flex items-center justify-end pr-1"
                           :style="'width:' + getConfigSummaryTierPercent('mid')">
                        <span class="text-[10px] text-white font-medium" x-text="strategyConfigSummary.recent_24h.tier_distribution.mid"></span>
                      </div>
                    </div>
                    <span class="text-xs w-10 text-right font-medium text-gray-600" x-text="getConfigSummaryTierPercent('mid')"></span>
                  </div>
                  <!-- low -->
                  <div class="flex items-center gap-2">
                    <span class="text-xs w-14 text-gray-500 shrink-0">低档位</span>
                    <div class="flex-1 bg-gray-100 rounded-full h-5 overflow-hidden">
                      <div class="h-full rounded-full bg-gradient-to-r from-blue-400 to-blue-500 transition-all flex items-center justify-end pr-1"
                           :style="'width:' + getConfigSummaryTierPercent('low')">
                        <span class="text-[10px] text-white font-medium" x-text="strategyConfigSummary.recent_24h.tier_distribution.low"></span>
                      </div>
                    </div>
                    <span class="text-xs w-10 text-right font-medium text-gray-600" x-text="getConfigSummaryTierPercent('low')"></span>
                  </div>
                  <!-- fallback -->
                  <div class="flex items-center gap-2">
                    <span class="text-xs w-14 text-gray-500 shrink-0">保底档</span>
                    <div class="flex-1 bg-gray-100 rounded-full h-5 overflow-hidden">
                      <div class="h-full rounded-full bg-gradient-to-r from-gray-300 to-gray-400 transition-all flex items-center justify-end pr-1"
                           :style="'width:' + getConfigSummaryTierPercent('fallback')">
                        <span class="text-[10px] text-white font-medium" x-text="strategyConfigSummary.recent_24h.tier_distribution.fallback"></span>
                      </div>
                    </div>
                    <span class="text-xs w-10 text-right font-medium text-gray-600" x-text="getConfigSummaryTierPercent('fallback')"></span>
                  </div>
                </div>
              </div>

              <!-- BxPx 命中热力分布 -->
              <div class="rounded-xl shadow-sm border border-gray-100 p-4 bg-white">
                <h6 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                  🔥 BxPx矩阵最近24小时命中分布
                </h6>
                <div x-show="strategyConfigSummary.recent_24h.total_draws === 0" class="text-center py-4 text-xs text-gray-400">暂无决策数据</div>
                <div x-show="strategyConfigSummary.recent_24h.total_draws > 0" class="overflow-x-auto">
                  <table class="w-full text-xs">
                    <thead>
                      <tr>
                        <th class="p-1.5 text-gray-400 font-normal text-left"></th>
                        <th class="p-1.5 text-center text-gray-500 font-medium">P0 低压</th>
                        <th class="p-1.5 text-center text-gray-500 font-medium">P1 中压</th>
                        <th class="p-1.5 text-center text-gray-500 font-medium">P2 高压</th>
                      </tr>
                    </thead>
                    <tbody>
                      <template x-for="bt in ['B0','B1','B2','B3']" :key="bt">
                        <tr>
                          <td class="p-1.5 font-medium text-gray-600" x-text="bt + ' ' + getBudgetTierName(bt)"></td>
                          <template x-for="pt in ['P0','P1','P2']" :key="pt">
                            <td class="p-1.5 text-center">
                              <span class="inline-block px-2 py-1 rounded text-xs font-medium min-w-[40px]"
                                    :class="getConfigSummaryBxPxCount(bt, pt) > 0
                                      ? (getConfigSummaryBxPxCount(bt, pt) > 100 ? 'bg-red-100 text-red-700' : (getConfigSummaryBxPxCount(bt, pt) > 30 ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700'))
                                      : 'bg-gray-50 text-gray-300'"
                                    x-text="getConfigSummaryBxPxCount(bt, pt) || '-'">
                              </span>
                            </td>
                          </template>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </template>

        <!-- 概览加载状态 -->
        <div x-show="loadingConfigSummary" class="mb-6 text-center py-6">
          <div class="animate-spin inline-block w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full"></div>
          <p class="text-xs text-gray-400 mt-2">正在加载策略配置概览...</p>
        </div>

        <div class="themed-card rounded-lg shadow p-6">
          <div class="flex items-center justify-between mb-5">
            <h5 class="font-semibold themed-text-primary flex items-center gap-2">
              ⚙️ 策略参数配置
              <span class="text-sm themed-text-muted font-normal" x-text="'共 ' + strategies.length + ' 项'"></span>
            </h5>
            <button @click="openStrategyCreateModal()" class="px-4 py-2 themed-btn-primary rounded transition-colors text-sm">
              ➕ 新增策略
            </button>
          </div>
          
          <!-- 空数据状态 -->
          <div x-show="Object.keys(strategyGroups).length === 0" class="text-center py-12">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4">
              <span class="text-3xl">⚙️</span>
            </div>
            <p class="themed-text-muted font-medium mb-1">暂无策略配置数据</p>
            <p class="text-sm themed-text-muted">请先在后台添加策略配置项</p>
          </div>

          <!-- 策略组列表 -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <template x-for="(strategies, groupName) in strategyGroups" :key="groupName">
              <div class="rounded-lg overflow-hidden shadow-sm" :class="getStrategyGroupStyle(groupName).border">
                <!-- 分组标题 -->
                <div class="px-4 py-3 flex items-center justify-between" :class="getStrategyGroupStyle(groupName).bg">
                  <div class="flex items-center gap-2">
                    <span class="text-lg" x-text="getStrategyGroupIcon(groupName)"></span>
                    <div>
                      <h6 class="font-semibold text-sm" x-text="getStrategyGroupName(groupName)"></h6>
                      <p class="text-xs opacity-60 mt-0.5" x-text="getStrategyGroupDescription(groupName)"></p>
                    </div>
                  </div>
                  <span class="px-2 py-0.5 text-xs rounded-full font-medium" :class="getStrategyGroupStyle(groupName).badge" x-text="strategies.length + ' 项'"></span>
                </div>
                <!-- 配置项列表 -->
                <div class="divide-y themed-border bg-white">
                  <template x-for="(strategy, idx) in strategies" :key="strategy.lottery_strategy_config_id || idx">
                    <div class="px-4 py-3 hover:bg-gray-50 transition-colors group">
                      <div class="flex items-start justify-between gap-3">
                        <div class="flex-1 min-w-0">
                          <div class="flex items-center gap-2 mb-1">
                            <span class="font-medium text-sm" x-text="getConfigKeyLabel(strategy.config_key)"></span>
                            <span class="text-xs font-mono themed-text-muted opacity-0 group-hover:opacity-100 transition-opacity" x-text="strategy.config_key"></span>
                          </div>
                          <p class="text-xs themed-text-muted leading-relaxed" x-text="getConfigKeyDescription(strategy.config_key) || strategy.description || '暂无描述'"></p>
                          <div class="mt-2 flex items-center gap-2">
                            <span class="text-xs themed-text-muted">当前值:</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-mono font-medium bg-gray-100 themed-text-primary" x-text="formatStrategyValue(strategy.parsed_value, strategy.config_key)"></span>
                          </div>
                        </div>
                        <div class="flex items-center gap-3 shrink-0">
                          <!-- 启用/禁用开关 -->
                          <button
                            @click="toggleStrategyActive(strategy)"
                            class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1"
                            :class="strategy.is_active ? 'bg-green-500' : 'bg-gray-300'"
                            :title="strategy.is_active ? '点击禁用' : '点击启用'"
                          >
                            <span class="inline-block h-4 w-4 rounded-full bg-white shadow transform transition-transform" :class="strategy.is_active ? 'translate-x-6' : 'translate-x-1'"></span>
                          </button>
                          <span class="text-xs w-8" :class="strategy.is_active ? 'text-green-600' : 'text-gray-400'" x-text="strategy.is_active ? '启用' : '禁用'"></span>
                          <!-- 编辑按钮 -->
                          <button
                            @click="openStrategyEditModal(strategy)"
                            class="p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded transition-colors opacity-0 group-hover:opacity-100"
                            title="编辑策略参数"
                          >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                          </button>
                          <!-- 删除按钮 -->
                          <button
                            @click="deleteStrategy(strategy)"
                            class="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors opacity-0 group-hover:opacity-100"
                            title="删除策略"
                          >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                          </button>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </template>
          </div>

          <!-- 层级矩阵配置 -->
          <div class="mt-6 rounded-lg overflow-hidden shadow-sm border-l-4 border-l-indigo-500">
            <div class="px-4 py-3 bg-indigo-50 flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="text-lg">📊</span>
                <div>
                  <h6 class="font-semibold text-sm">层级矩阵配置</h6>
                  <p class="text-xs opacity-60 mt-0.5">预算层级(B0-B3) × 压力层级(P0-P2) 的档位权重乘数矩阵，点击单元格可编辑</p>
                </div>
              </div>
              <span class="px-2 py-0.5 text-xs rounded-full font-medium bg-indigo-100 text-indigo-700" x-text="tierMatrix.length + ' 个配置'"></span>
            </div>
            <div class="p-4 overflow-x-auto bg-white">
              <div x-show="tierMatrix.length === 0" class="text-center py-8">
                <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-indigo-50 mb-3">
                  <span class="text-xl">📊</span>
                </div>
                <p class="themed-text-muted text-sm">暂无矩阵配置数据</p>
              </div>
              <template x-if="tierMatrix.length > 0">
                <div>
                  <table class="w-full border-collapse">
                    <thead>
                      <tr>
                        <th class="px-4 py-3 text-sm font-semibold bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-tl-lg">预算 \ 压力</th>
                        <template x-for="pTier in pressureTiers" :key="pTier">
                          <th class="px-4 py-3 text-sm font-semibold bg-gradient-to-r from-indigo-500 to-purple-500 text-white">
                            <span x-text="getPressureTierName(pTier)"></span>
                            <span class="text-xs opacity-75 block" x-text="pTier"></span>
                          </th>
                        </template>
                      </tr>
                    </thead>
                    <tbody>
                      <template x-for="(bTier, bIdx) in budgetTiers" :key="bTier">
                        <tr :class="bIdx % 2 === 0 ? 'bg-gray-50/50' : ''">
                          <th class="px-4 py-3 text-sm font-semibold text-left bg-gradient-to-b from-blue-50 to-indigo-50 border-r border-gray-200">
                            <span x-text="getBudgetTierName(bTier)"></span>
                            <span class="text-xs themed-text-muted block" x-text="bTier"></span>
                          </th>
                          <template x-for="pTier in pressureTiers" :key="bTier + '-' + pTier">
                            <td class="px-2 py-2 text-center cursor-pointer border border-gray-100 transition-all hover:shadow-md hover:border-indigo-300 hover:bg-indigo-50/50 group" @click="editMatrixCell(bTier, pTier)">
                              <template x-if="getMatrixConfig(bTier, pTier)">
                                <div class="text-xs space-y-1 p-1">
                                  <div class="flex justify-between items-center">
                                    <span class="text-red-400 font-medium">高档:</span>
                                    <span class="font-mono font-semibold" x-text="getMatrixConfig(bTier, pTier).high_multiplier || 0"></span>
                                  </div>
                                  <div class="flex justify-between items-center">
                                    <span class="text-yellow-500 font-medium">中档:</span>
                                    <span class="font-mono font-semibold" x-text="getMatrixConfig(bTier, pTier).mid_multiplier || 0"></span>
                                  </div>
                                  <div class="flex justify-between items-center">
                                    <span class="text-blue-400 font-medium">低档:</span>
                                    <span class="font-mono font-semibold" x-text="getMatrixConfig(bTier, pTier).low_multiplier || 0"></span>
                                  </div>
                                  <div class="flex justify-between items-center pt-0.5 border-t border-gray-200">
                                    <span class="text-gray-400 font-medium">兜底:</span>
                                    <span class="font-mono" x-text="getMatrixConfig(bTier, pTier).fallback_multiplier || 1"></span>
                                  </div>
                                  <div class="opacity-0 group-hover:opacity-100 transition-opacity text-center mt-1">
                                    <span class="text-indigo-500 text-xs">点击编辑 ✏️</span>
                                  </div>
                                </div>
                              </template>
                              <template x-if="!getMatrixConfig(bTier, pTier)">
                                <div class="py-3">
                                  <span class="text-gray-300 text-lg">-</span>
                                  <p class="text-xs themed-text-muted opacity-0 group-hover:opacity-100 transition-opacity mt-1">点击添加</p>
                                </div>
                              </template>
                            </td>
                          </template>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                  <!-- 矩阵图例 -->
                  <div class="mt-3 flex items-center gap-4 text-xs themed-text-muted justify-center">
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-400"></span> 高档乘数</span>
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-yellow-500"></span> 中档乘数</span>
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-400"></span> 低档乘数</span>
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-gray-400"></span> 兜底乘数</span>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== 配额管理页 ==================== -->
      <div x-show="current_page === 'lottery-quota'" x-cloak>
        <!-- 页面引导说明 -->
        <div class="rounded-lg p-4 mb-6 bg-gradient-to-r from-teal-500 to-cyan-600 text-white shadow-lg">
          <div class="flex items-start gap-3">
            <span class="text-2xl mt-0.5">📊</span>
            <div>
              <h5 class="font-semibold text-lg mb-1">配额规则管理</h5>
              <p class="text-sm opacity-90">控制用户每天的抽奖次数上限。规则按优先级生效，高优先级规则覆盖低优先级。规则只能创建和禁用，需要变更时请创建新规则并禁用旧规则。</p>
              <div class="flex flex-wrap gap-3 mt-3 text-xs">
                <span class="px-2 py-1 bg-white/20 rounded">🌐 全局 - 所有活动统一限制</span>
                <span class="px-2 py-1 bg-white/20 rounded">🎯 活动 - 指定活动专属限制</span>
                <span class="px-2 py-1 bg-white/20 rounded">👤 用户 - 特定用户单独限制</span>
                <span class="px-2 py-1 bg-white/20 rounded">🏷️ 角色 - 按角色分组限制</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="rounded-xl shadow-sm overflow-hidden border border-gray-100">
            <div class="bg-gradient-to-br from-teal-50 to-cyan-50 p-4">
              <div class="flex items-center justify-between mb-2">
                <span class="inline-flex items-center justify-center w-9 h-9 rounded-lg bg-teal-100">
                  <span class="text-lg">📋</span>
                </span>
                <span class="text-xs text-teal-600 font-medium">规则总览</span>
              </div>
              <div class="text-2xl font-bold text-gray-800" x-text="quotaStats.totalRules || 0"></div>
              <div class="text-xs text-gray-500 mt-1">配额规则总数</div>
            </div>
          </div>
          <div class="rounded-xl shadow-sm overflow-hidden border border-gray-100">
            <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-4">
              <div class="flex items-center justify-between mb-2">
                <span class="inline-flex items-center justify-center w-9 h-9 rounded-lg bg-green-100">
                  <span class="text-lg">✅</span>
                </span>
                <span class="text-xs text-green-600 font-medium">生效中</span>
              </div>
              <div class="text-2xl font-bold text-green-700" x-text="quotaStats.activeRules || 0"></div>
              <div class="text-xs text-gray-500 mt-1">活跃规则数</div>
            </div>
          </div>
          <div class="rounded-xl shadow-sm overflow-hidden border border-gray-100">
            <div class="bg-gradient-to-br from-gray-50 to-slate-50 p-4">
              <div class="flex items-center justify-between mb-2">
                <span class="inline-flex items-center justify-center w-9 h-9 rounded-lg bg-gray-100">
                  <span class="text-lg">🚫</span>
                </span>
                <span class="text-xs text-gray-500 font-medium">已禁用</span>
              </div>
              <div class="text-2xl font-bold text-gray-500" x-text="(quotaStats.totalRules || 0) - (quotaStats.activeRules || 0)"></div>
              <div class="text-xs text-gray-500 mt-1">禁用规则数</div>
            </div>
          </div>
        </div>

        <!-- 规则表格 -->
        <div class="content-section">
          <div class="content-section-header">
            <div class="section-title">
              <span class="title-icon" style="background: linear-gradient(135deg, #14b8a6, #06b6d4); color: white;">📋</span>
              配额规则列表
              <span x-show="quotas.length > 0" class="badge badge-info ml-2" x-text="quotas.length + ' 条'"></span>
            </div>
            <div class="flex items-center gap-2">
              <button @click="openCreateQuotaModal()" class="action-btn action-btn-primary rounded-lg flex items-center gap-1.5">
                ➕ 新增规则
              </button>
              <button @click="loadQuotas()" class="btn-sm btn-outline rounded-lg flex items-center gap-1">
                ♻️ 刷新
              </button>
            </div>
          </div>

          <!-- 筛选区域 -->
          <div class="p-4 border-b themed-bg-base">
            <div class="flex items-center gap-3 flex-wrap">
              <select class="form-select w-auto text-sm" x-model="quotaFilters.rule_type" @change="loadQuotas()">
                <option value="">全部类型</option>
                <option value="global">🌐 全局</option>
                <option value="campaign">🎯 活动</option>
                <option value="role">🏷️ 角色</option>
                <option value="user">👤 用户</option>
              </select>
              <select class="form-select w-auto text-sm" x-model="quotaFilters.status" @change="loadQuotas()">
                <option value="">全部状态</option>
                <option value="active">✅ 生效中</option>
                <option value="inactive">🚫 已禁用</option>
              </select>
            </div>
          </div>

          <!-- 配额规则表格 - 后端字段: lottery_draw_quota_rule_id, scope_type, scope_id, window_type, limit_value, priority, status -->
          <div class="overflow-x-auto">
            <!-- 空状态 -->
            <div x-show="quotas.length === 0 && !loading" class="py-12">
              <div class="flex flex-col items-center justify-center text-center">
                <div class="text-6xl mb-4">📊</div>
                <h3 class="text-lg font-medium themed-text mb-2">暂无配额规则</h3>
                <p class="themed-text-muted text-sm mb-4">配额规则用于限制用户每日抽奖次数，点击下方按钮创建第一条规则</p>
                <button @click="openCreateQuotaModal()" class="action-btn action-btn-primary rounded-lg">
                  ➕ 创建配额规则
                </button>
              </div>
            </div>
            
            <table x-show="quotas.length > 0" class="w-full">
              <thead>
                <tr class="bg-gradient-to-r from-gray-50 to-slate-50 border-b">
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">规则ID</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">规则类型</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">适用范围</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">时间窗口</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">每日上限</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">优先级</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">状态</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">操作</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                <template x-for="quota in quotas" :key="quota.lottery_draw_quota_rule_id">
                  <tr class="hover:bg-gray-50/50 transition-colors">
                    <td class="px-4 py-3.5 text-sm">
                      <span class="font-mono text-xs bg-gray-100 px-2 py-0.5 rounded" x-text="'#' + quota.lottery_draw_quota_rule_id"></span>
                    </td>
                    <td class="px-4 py-3.5 text-sm">
                      <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium"
                            :class="{
                              'bg-blue-50 text-blue-700 ring-1 ring-blue-200': quota.scope_type === 'global',
                              'bg-green-50 text-green-700 ring-1 ring-green-200': quota.scope_type === 'campaign',
                              'bg-purple-50 text-purple-700 ring-1 ring-purple-200': quota.scope_type === 'role',
                              'bg-orange-50 text-orange-700 ring-1 ring-orange-200': quota.scope_type === 'user'
                            }">
                        <span x-text="{'global':'🌐','campaign':'🎯','role':'🏷️','user':'👤'}[quota.scope_type] || '📋'"></span>
                        <span x-text="quota.scope_type_display || quota.scope_type"></span>
                      </span>
                    </td>
                    <td class="px-4 py-3.5 text-sm">
                      <template x-if="quota.scope_type === 'global'">
                        <span class="text-gray-500 italic">所有活动</span>
                      </template>
                      <template x-if="quota.scope_type === 'campaign'">
                        <span class="font-medium" x-text="getQuotaCampaignName(quota.scope_id)"></span>
                      </template>
                      <template x-if="quota.scope_type === 'role'">
                        <span class="font-mono text-xs bg-purple-50 px-2 py-0.5 rounded" x-text="'角色: ' + quota.scope_id"></span>
                      </template>
                      <template x-if="quota.scope_type === 'user'">
                        <span class="font-mono text-xs bg-orange-50 px-2 py-0.5 rounded" x-text="'用户ID: ' + quota.scope_id"></span>
                      </template>
                    </td>
                    <td class="px-4 py-3.5 text-sm">
                      <span class="inline-flex items-center gap-1 text-gray-600">
                        <span class="text-xs">⏰</span>
                        <span x-text="quota.window_type_display || quota.window_type"></span>
                      </span>
                    </td>
                    <td class="px-4 py-3.5">
                      <span class="inline-flex items-center gap-1 text-sm font-bold" :class="quota.limit_value >= 50 ? 'text-orange-600' : quota.limit_value >= 20 ? 'text-blue-600' : 'text-teal-600'">
                        <span x-text="quota.limit_value"></span>
                        <span class="text-xs font-normal text-gray-400">次/天</span>
                      </span>
                    </td>
                    <td class="px-4 py-3.5 text-sm">
                      <span class="inline-flex items-center justify-center w-7 h-7 rounded-full text-xs font-bold"
                            :class="quota.priority >= 50 ? 'bg-red-100 text-red-700' : quota.priority >= 20 ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-600'"
                            x-text="quota.priority"></span>
                    </td>
                    <td class="px-4 py-3.5">
                      <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium"
                            :class="quota.status === 'active' ? 'bg-green-50 text-green-700 ring-1 ring-green-200' : 'bg-gray-100 text-gray-500'"
                      >
                        <span class="w-1.5 h-1.5 rounded-full" :class="quota.status === 'active' ? 'bg-green-500' : 'bg-gray-400'"></span>
                        <span x-text="quota.status === 'active' ? '生效中' : '已禁用'"></span>
                      </span>
                    </td>
                    <td class="px-4 py-3.5">
                      <button 
                        x-show="quota.status === 'active'"
                        class="inline-flex items-center gap-1 px-2.5 py-1 text-xs font-medium text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors"
                        @click="deleteQuota(quota)">
                        🚫 禁用
                      </button>
                      <span x-show="quota.status !== 'active'" class="text-xs text-gray-400 italic">已禁用</span>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ==================== 定价配置页 ==================== -->
      <div x-show="current_page === 'lottery-pricing'" x-cloak>
        <!-- 页面引导说明 -->
        <div class="rounded-lg p-4 mb-6 bg-gradient-to-r from-amber-500 to-orange-600 text-white shadow-lg">
          <div class="flex items-start gap-3">
            <span class="text-2xl mt-0.5">💵</span>
            <div>
              <h5 class="font-semibold text-lg mb-1">活动定价配置</h5>
              <p class="text-sm opacity-90">配置每个抽奖活动的积分价格和连抽折扣。每个活动独立定价，支持版本管理和历史回滚。修改定价会创建新版本，旧版本自动归档。</p>
              <div class="flex flex-wrap gap-3 mt-3 text-xs">
                <span class="px-2 py-1 bg-white/20 rounded">💰 基础价格 - 单次抽奖消耗积分</span>
                <span class="px-2 py-1 bg-white/20 rounded">🎰 连抽档位 - 多连抽折扣优惠</span>
                <span class="px-2 py-1 bg-white/20 rounded">📋 版本管理 - 历史版本可追溯回滚</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 统计概览 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="rounded-xl shadow-sm overflow-hidden border border-gray-100">
            <div class="bg-gradient-to-br from-amber-50 to-orange-50 p-4">
              <div class="flex items-center justify-between mb-2">
                <span class="inline-flex items-center justify-center w-9 h-9 rounded-lg bg-amber-100">
                  <span class="text-lg">💵</span>
                </span>
                <span class="text-xs text-amber-600 font-medium">定价总览</span>
              </div>
              <div class="text-2xl font-bold text-gray-800" x-text="pricingConfigs.length || 0"></div>
              <div class="text-xs text-gray-500 mt-1">已配置活动数</div>
            </div>
          </div>
          <div class="rounded-xl shadow-sm overflow-hidden border border-gray-100">
            <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-4">
              <div class="flex items-center justify-between mb-2">
                <span class="inline-flex items-center justify-center w-9 h-9 rounded-lg bg-green-100">
                  <span class="text-lg">✅</span>
                </span>
                <span class="text-xs text-green-600 font-medium">生效中</span>
              </div>
              <div class="text-2xl font-bold text-green-700" x-text="pricingConfigs.filter(p => p.status === 'active').length || 0"></div>
              <div class="text-xs text-gray-500 mt-1">活跃定价配置</div>
            </div>
          </div>
          <div class="rounded-xl shadow-sm overflow-hidden border border-gray-100">
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-4">
              <div class="flex items-center justify-between mb-2">
                <span class="inline-flex items-center justify-center w-9 h-9 rounded-lg bg-blue-100">
                  <span class="text-lg">🎰</span>
                </span>
                <span class="text-xs text-blue-600 font-medium">档位统计</span>
              </div>
              <div class="text-2xl font-bold text-blue-700" x-text="pricingConfigs.reduce((s, p) => s + (p.pricing_config?.draw_buttons?.length || 0), 0)"></div>
              <div class="text-xs text-gray-500 mt-1">连抽档位总数</div>
            </div>
          </div>
        </div>

        <!-- 定价配置列表 -->
        <div class="content-section">
          <div class="content-section-header">
            <div class="section-title">
              <span class="title-icon" style="background: linear-gradient(135deg, #f59e0b, #ea580c); color: white;">💵</span>
              活动定价列表
              <span x-show="pricingConfigs.length > 0" class="badge badge-warning ml-2" x-text="pricingConfigs.length + ' 个活动'"></span>
            </div>
            <div class="flex items-center gap-2">
              <button @click="openCreatePricingModal()" class="action-btn action-btn-primary rounded-lg flex items-center gap-1.5">
                ➕ 创建定价
              </button>
              <button 
                @click="refreshPricingWithFeedback()" 
                :disabled="refreshingPricing"
                class="btn-sm btn-outline rounded-lg flex items-center gap-1">
                <span x-show="!refreshingPricing">♻️ 刷新</span>
                <span x-show="refreshingPricing" class="flex items-center gap-1">
                  <span class="loading-spinner w-3 h-3"></span>
                  加载中...
                </span>
              </button>
            </div>
          </div>
          
          <div class="p-4">
            <!-- 空状态 -->
            <div x-show="pricingConfigs.length === 0 && !loading" class="py-12">
              <div class="flex flex-col items-center justify-center text-center">
                <div class="text-6xl mb-4">💵</div>
                <h3 class="text-lg font-medium themed-text mb-2">暂无定价配置</h3>
                <p class="themed-text-muted text-sm mb-4">每个活动需要独立的定价配置，点击下方按钮为活动设置抽奖价格</p>
                <button @click="openCreatePricingModal()" class="action-btn action-btn-primary rounded-lg">
                  ➕ 创建定价配置
                </button>
              </div>
            </div>

            <!-- 定价配置卡片列表 -->
            <div class="space-y-5">
              <template x-for="pricing in pricingConfigs" :key="pricing.lottery_campaign_id || pricing.campaign_code">
                <div class="rounded-xl border border-gray-200 overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                  <!-- 活动信息头部 - 渐变背景 -->
                  <div class="p-4 bg-gradient-to-r from-gray-50 via-white to-gray-50 border-b flex justify-between items-center">
                    <div class="flex items-center gap-3">
                      <span class="inline-flex items-center justify-center w-10 h-10 rounded-xl shadow-sm"
                            :class="pricing.status === 'active' ? 'bg-gradient-to-br from-green-400 to-emerald-500 text-white' : 'bg-gray-200 text-gray-500'">
                        <span class="text-lg">🎯</span>
                      </span>
                      <div>
                        <h6 class="font-semibold text-gray-800" x-text="pricing.campaign_name || '活动 ' + (pricing.campaign_code || pricing.lottery_campaign_id)"></h6>
                        <div class="flex items-center gap-3 mt-1 text-xs text-gray-500">
                          <span class="inline-flex items-center gap-1">
                            <span>📌</span>
                            <code class="bg-gray-100 px-1.5 py-0.5 rounded text-xs" x-text="pricing.campaign_code"></code>
                          </span>
                          <span class="inline-flex items-center gap-1">
                            <span>🏷️</span>
                            版本 <span class="font-bold text-indigo-600" x-text="'v' + (pricing.version || 1)"></span>
                          </span>
                          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium"
                                :class="pricing.status === 'active' ? 'bg-green-50 text-green-700 ring-1 ring-green-200' : 'bg-gray-100 text-gray-500'">
                            <span class="w-1.5 h-1.5 rounded-full" :class="pricing.status === 'active' ? 'bg-green-500' : 'bg-gray-400'"></span>
                            <span x-text="pricing.status_display || (pricing.status === 'active' ? '生效中' : pricing.status)"></span>
                          </span>
                        </div>
                      </div>
                    </div>
                    <div class="flex items-center gap-2">
                      <button class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition-colors" @click="viewPricingVersions(pricing)">
                        📋 版本历史
                      </button>
                      <button class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-amber-600 bg-amber-50 hover:bg-amber-100 rounded-lg transition-colors" @click="editPricing(pricing)">
                        ✏️ 编辑定价
                      </button>
                    </div>
                  </div>
                  
                  <!-- 定价档位详情 -->
                  <div class="p-4">
                    <!-- 基础价格标识 -->
                    <div class="flex items-center gap-2 mb-4">
                      <span class="text-sm font-medium text-gray-500">💰 单抽基础价格</span>
                      <span class="text-lg font-bold text-amber-600" x-text="(pricing.pricing_config?.base_cost || pricing.base_cost || '-') + ' 积分'"></span>
                    </div>

                    <!-- 连抽档位卡片 -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                      <template x-for="btn in (pricing.pricing_config?.draw_buttons || [])" :key="btn.count">
                        <div class="relative rounded-xl overflow-hidden transition-all"
                             :class="btn.enabled ? 'border-2 border-transparent bg-gradient-to-br from-white to-gray-50 shadow-sm hover:shadow' : 'border border-dashed border-gray-200 bg-gray-50 opacity-60'">
                          <!-- 折扣标签 -->
                          <div x-show="btn.discount < 1 && btn.enabled" 
                               class="absolute top-0 right-0 bg-gradient-to-l from-red-500 to-pink-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-bl-lg">
                            <span x-text="Math.round(btn.discount * 100) / 10 + '折'"></span>
                          </div>
                          <div class="p-3 text-center">
                            <div class="text-2xl mb-1" x-text="btn.count === 1 ? '🎲' : btn.count <= 3 ? '🎰' : '🎪'"></div>
                            <div class="text-sm font-bold text-gray-800" x-text="btn.label || (btn.count === 1 ? '单抽' : btn.count + '连抽')"></div>
                            <div class="text-xs text-gray-400 mt-1" x-text="'抽 ' + btn.count + ' 次'"></div>
                            <div class="mt-2 text-xs font-medium" :class="btn.discount < 1 ? 'text-red-500' : 'text-gray-500'">
                              <span x-text="btn.discount < 1 ? (btn.discount * 100).toFixed(0) + '% 折扣' : '原价'"></span>
                            </div>
                            <div class="mt-1">
                              <span class="inline-flex items-center gap-0.5 text-[10px] px-1.5 py-0.5 rounded-full"
                                    :class="btn.enabled ? 'bg-green-50 text-green-600' : 'bg-gray-100 text-gray-400'">
                                <span class="w-1 h-1 rounded-full" :class="btn.enabled ? 'bg-green-500' : 'bg-gray-400'"></span>
                                <span x-text="btn.enabled ? '已启用' : '已禁用'"></span>
                              </span>
                            </div>
                          </div>
                        </div>
                      </template>
                    </div>
                    
                    <!-- 底部配置信息 -->
                    <div class="mt-4 pt-3 border-t border-gray-100 flex flex-wrap gap-x-6 gap-y-1 text-xs text-gray-400">
                      <span class="inline-flex items-center gap-1">
                        📅 生效: <span class="text-gray-600" x-text="formatDateOnly(pricing.effective_at || pricing.created_at) || '-'"></span>
                      </span>
                      <span class="inline-flex items-center gap-1">
                        🔄 更新: <span class="text-gray-600" x-text="formatDateOnly(pricing.updated_at) || '-'"></span>
                      </span>
                      <span class="inline-flex items-center gap-1">
                        👤 操作人: <span class="text-gray-600" x-text="pricing.created_by || '-'"></span>
                      </span>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== 抽奖指标页 ==================== -->
      <div x-show="current_page === 'lottery-metrics'" x-cloak x-init="$nextTick(() => { if(typeof initMonitoringCharts === 'function') initMonitoringCharts() })">
        <!-- 时间范围筛选 -->
        <div class="filter-toolbar">
          <div class="flex items-center gap-4 flex-wrap">
            <label class="form-label mb-0">统计时间范围：</label>
            <select 
              class="form-select w-auto"
              x-model="monitoringFilters.time_range"
              @change="loadEnhancedMetrics()"
            >
              <option value="today">今天</option>
              <option value="yesterday">昨天</option>
              <option value="week">最近7天</option>
              <option value="month">最近30天</option>
            </select>
            <button 
              class="action-btn action-btn-primary rounded-lg flex items-center gap-1.5"
              @click="loadEnhancedMetrics()"
              :disabled="refreshingMetrics || chartLoading"
            >
              <span x-show="!refreshingMetrics && !chartLoading">🔄 刷新数据</span>
              <span x-show="refreshingMetrics || chartLoading" class="flex items-center gap-1">
                <span class="loading-spinner w-4 h-4"></span>
                刷新中...
              </span>
            </button>
            <button 
              class="action-btn rounded-lg flex items-center gap-1.5 bg-gradient-to-r from-purple-500 to-indigo-600 text-white hover:from-purple-600 hover:to-indigo-700"
              @click="openDailyReportModal()"
              :disabled="loadingDailyReport"
            >
              <span x-show="!loadingDailyReport">📊 查看日报</span>
              <span x-show="loadingDailyReport">⏳ 加载中...</span>
            </button>
          </div>
        </div>

        <!-- 🚨 实时告警区 -->
        <div class="content-section mb-6">
          <div class="content-section-header">
            <div class="section-title">
              <span class="title-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white;">🚨</span>
              实时告警
              <span x-show="activeAlerts.length > 0" class="badge badge-danger ml-2" x-text="activeAlerts.length + ' 条'"></span>
            </div>
            <button @click="loadActiveAlerts()" class="btn-sm btn-outline rounded-lg flex items-center gap-1">
              ♻️ 刷新告警
            </button>
          </div>
          <div class="p-4 space-y-2 max-h-40 overflow-y-auto">

              <div x-show="activeAlerts.length === 0" class="text-center py-4">
                <span class="text-3xl">✅</span>
                <p class="text-sm mt-2 themed-text-muted">暂无活跃告警，系统运行平稳</p>
              </div>

            <template x-for="(alert, index) in activeAlerts" :key="index">
              <div class="flex items-start gap-3 p-3 rounded-lg border-l-4" :class="getAlertLevelClass(alert.level)">
                <span class="text-lg" x-text="getAlertLevelIcon(alert.level)"></span>
                <div class="flex-1">
                  <p class="text-sm font-medium" x-text="alert.message"></p>
                  <p class="text-xs opacity-75 mt-1" x-text="new Date(alert.time).toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'})"></p>
                </div>
              </div>
            </template>
          </div>
        </div>
        <!-- 总体统计 - 适配后端返回字段 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="gradient-stat-card gradient-stat-blue">
            <div class="stat-icon">🎲</div>
            <div class="stat-value" x-text="lotteryMetrics.total_draws">-</div>
            <div class="stat-label">总抽奖次数</div>
          </div>
          <div class="gradient-stat-card gradient-stat-green">
            <div class="stat-icon">🏆</div>
            <div class="stat-value" x-text="lotteryMetrics.total_wins">-</div>
            <div class="stat-label">中奖次数</div>
          </div>
          <div class="gradient-stat-card gradient-stat-orange">
            <div class="stat-icon">📈</div>
            <div class="stat-value" x-text="lotteryMetrics.win_rate + '%'">-</div>
            <div class="stat-label">中奖率</div>
          </div>
          <div class="gradient-stat-card gradient-stat-cyan">
            <div class="stat-icon">💰</div>
            <div class="stat-value" x-text="'¥' + (lotteryMetrics.total_value || 0).toFixed(2)">-</div>
            <div class="stat-label">奖品总价值</div>
          </div>
        </div>

        <!-- 🔍 用户档案快速查询 -->
        <div class="filter-toolbar mb-6">
          <div class="flex flex-col md:flex-row items-start md:items-center gap-4">
            <h6 class="font-semibold text-sm flex items-center gap-2 shrink-0">
              👤 用户抽奖档案查询
            </h6>
            <div class="flex flex-1 gap-3 items-center flex-wrap">
              <input 
                type="text" 
                class="form-input flex-1 max-w-xs"
                placeholder="输入手机号..." 
                maxlength="11"
                x-model="searchMobile"
                @keyup.enter="searchUserProfile()"
              >
              <select class="form-select w-auto" x-model="searchCampaignId">
                <option value="">全部活动</option>
                <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
                  <option :value="campaign.lottery_campaign_id" x-text="campaign.campaign_name"></option>
                </template>
              </select>
              <button 
                class="action-btn action-btn-primary rounded-lg flex items-center gap-1.5"
                @click="searchUserProfile()"
                :disabled="loadingUserProfile || !searchMobile"
              >
                <span x-show="!loadingUserProfile">🔍 查询档案</span>
                <span x-show="loadingUserProfile" class="flex items-center gap-1">
                  <span class="loading-spinner w-4 h-4"></span>
                  查询中...
                </span>
              </button>
            </div>
          </div>
        </div>

        <!-- 📈 图表区域：24小时趋势 + 档位分布 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <!-- 24小时抽奖趋势折线图 -->
          <div class="themed-card rounded-lg shadow">
            <div class="p-4 border-b flex items-center justify-between">
              <h5 class="font-semibold">📈 24小时抽奖趋势</h5>
              <span x-show="chartLoading" class="text-xs themed-text-muted flex items-center gap-1">
                <svg class="animate-spin h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                </svg>
                更新中...
              </span>
            </div>
            <div class="p-4">
              <div id="trend-chart-24h" class="w-full h-64"></div>
              <template x-if="hourlyTrend24h.length === 0 && !chartLoading">
                <div class="absolute inset-0 flex items-center justify-center">
                  <p class="themed-text-muted text-sm">暂无趋势数据</p>
                </div>
              </template>
            </div>
          </div>

          <!-- 档位分布饼图 -->
          <div class="themed-card rounded-lg shadow">
            <div class="p-4 border-b">
              <h5 class="font-semibold">📊 档位分布</h5>
            </div>
            <div class="p-4">
              <div id="tier-distribution-chart" class="w-full h-64"></div>
              <template x-if="tierDistribution.length === 0 && !chartLoading">
                <div class="absolute inset-0 flex items-center justify-center">
                  <p class="themed-text-muted text-sm">暂无分布数据</p>
                </div>
              </template>
            </div>
          </div>
        </div>

        <!-- P3-4: 抽奖时段热力图 -->
        <div class="themed-card rounded-lg shadow mb-6">
          <div class="p-4 border-b flex items-center justify-between">
            <div class="flex items-center gap-2">
              <h5 class="font-semibold">🔥 抽奖时段热力图</h5>
              <span class="text-sm themed-text-muted">24小时 × 7天</span>
            </div>
            <div class="flex items-center gap-2">
              <template x-if="heatmapPeak">
                <span class="text-xs themed-text-muted">
                  峰值: <span class="font-medium themed-text-primary" x-text="heatmapPeak.day + ' ' + heatmapPeak.hour"></span>
                </span>
              </template>
              <button 
                @click="loadLotteryHeatmap(7)" 
                class="px-2 py-1 text-xs themed-bg-subtle rounded hover:themed-bg-muted"
                :disabled="loadingHeatmap"
              >
                <span x-show="!loadingHeatmap">🔄 刷新</span>
                <span x-show="loadingHeatmap">加载中...</span>
              </button>
            </div>
          </div>
          <div class="p-4">
            <div id="lottery-heatmap-chart" style="width: 100%; height: 280px;"></div>
            <template x-if="(!lotteryHeatmap || lotteryHeatmap.length === 0) && !loadingHeatmap">
              <div class="text-center py-8 themed-text-muted">
                <p>暂无热力图数据</p>
                <button @click="loadLotteryHeatmap(7)" class="mt-2 text-sm themed-text-primary hover:underline">
                  点击加载
                </button>
              </div>
            </template>
          </div>
        </div>

        <!-- 预算进度条 -->
        <div class="themed-card rounded-lg shadow p-4 mb-6" x-show="budgetProgress.total > 0">
          <div class="flex items-center justify-between mb-2">
            <h6 class="font-semibold text-sm">💰 预算消耗进度</h6>
            <span class="text-sm themed-text-muted">
              已使用 <span class="font-medium" :class="budgetProgress.percentage > 80 ? 'text-red-500' : 'themed-text-primary'" x-text="budgetProgress.used.toLocaleString()"></span>
              / <span x-text="budgetProgress.total.toLocaleString()"></span>
            </span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-3">
            <div class="h-3 rounded-full transition-all duration-500" 
                 :class="budgetProgress.percentage > 90 ? 'bg-red-500' : budgetProgress.percentage > 70 ? 'bg-yellow-500' : 'bg-green-500'"
                 :style="'width: ' + Math.min(budgetProgress.percentage, 100) + '%'"></div>
          </div>
          <div class="flex justify-between mt-1">
            <span class="text-xs themed-text-muted">0%</span>
            <span class="text-xs font-medium" :class="budgetProgress.percentage > 80 ? 'text-red-500' : 'themed-text-muted'" x-text="budgetProgress.percentage + '%'"></span>
            <span class="text-xs themed-text-muted">100%</span>
          </div>
        </div>

        <!-- 奖品分布统计 - 后端返回 prize_distribution: [{name, value}] -->
        <div class="themed-card rounded-lg shadow mb-6">
          <div class="p-4 border-b">
            <h5 class="font-semibold">🏆 按奖品类型分布</h5>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="themed-bg-base">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">奖品等级</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">中奖次数</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">占比</th>
                </tr>
              </thead>
              <tbody class="divide-y">

                <tr x-show="prizeDistribution.length === 0">
                  <td colspan="4" class="px-4 py-8 text-center themed-text-muted">暂无奖品分布数据</td>
                </tr>
                <template x-for="(prize, index) in prizeDistribution" :key="index">
                  <tr class="themed-hover-bg">
                    <td class="px-4 py-3 text-sm font-medium" x-text="prize.prize_name || '-'"></td>
                    <td class="px-4 py-3 text-sm" x-text="prize.value || 0"></td>
                    <td class="px-4 py-3 text-sm">
                      <div class="flex items-center">
                        <div class="w-24 themed-bg-muted rounded-full h-2 mr-2">
                          <div class="themed-bg-primary h-2 rounded-full" 
                               :style="'width: ' + ((prize.value || 0) / (lotteryMetrics.total_draws || 1) * 100) + '%'"></div>
                        </div>
                        <span x-text="((prize.value || 0) / (lotteryMetrics.total_draws || 1) * 100).toFixed(1) + '%'"></span>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 最近抽奖记录 - 后端返回 recent_draws: [{time, user, campaign, result, is_win, draw_id}] -->
        <div class="themed-card rounded-lg shadow">
          <div class="p-4 border-b">
            <h5 class="font-semibold">📋 最近抽奖记录</h5>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="themed-bg-base">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">用户</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">活动</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">结果</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">抽奖时间</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
                </tr>
              </thead>
              <tbody class="divide-y">

                <tr x-show="recentDraws.length === 0">
                  <td colspan="5" class="px-4 py-8 text-center themed-text-muted">暂无最近抽奖记录</td>
                </tr>
                <template x-for="(draw, index) in recentDraws" :key="index">
                  <tr class="themed-hover-bg">
                    <td class="px-4 py-3 text-sm" x-text="draw.user || '-'"></td>
                    <td class="px-4 py-3 text-sm" x-text="draw.campaign || '-'"></td>
                    <td class="px-4 py-3 text-sm">
                      <span class="px-2 py-1 rounded text-xs"
                            :class="draw.is_win ? 'bg-green-100 themed-text-success' : 'themed-bg-subtle themed-text-muted'"
                            x-text="draw.result || '-'"></span>
                    </td>
                    <td class="px-4 py-3 text-sm themed-text-muted" x-text="draw.time ? new Date(draw.time).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' }) : '-'"></td>
                    <td class="px-4 py-3 text-sm">
                      <button x-show="draw.draw_id" 
                              @click="openDrawDetailsModal(draw.draw_id)"
                              class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-700 hover:bg-blue-200"
                              title="查看Pipeline详情">
                        🔍 详情
                      </button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 告警中心已迁移至独立页面 /admin/lottery-alerts.html -->

      <!-- 单次抽奖详情弹窗 (P1) -->
      <div x-show="showDrawDetailsModal" 
           class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
           x-cloak
           @click.self="closeDrawDetailsModal()">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-auto">
          <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10">
            <h5 class="font-semibold">🎰 单次抽奖详情 - Pipeline可视化</h5>
            <button @click="closeDrawDetailsModal()" class="text-gray-500 hover:text-gray-700 text-xl">✕</button>
          </div>

          <!-- 加载状态 -->
          <div x-show="loadingDrawDetails" class="p-8 text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <p class="themed-text-muted">加载抽奖详情...</p>
          </div>

          <!-- 详情内容 -->
          <div x-show="!loadingDrawDetails && drawDetails" class="p-6">
            <template x-if="drawDetails">
              <div class="space-y-6">
                <!-- 基础信息卡片 -->
                <div class="themed-card rounded-lg shadow p-4">
                  <h6 class="font-semibold mb-3 flex items-center gap-2">
                    <span>📋</span> 基础信息
                  </h6>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                      <span class="themed-text-muted">抽奖ID:</span>
                      <p class="font-mono" x-text="drawDetails.basic_info?.draw_id || currentDrawId"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">用户ID:</span>
                      <p x-text="drawDetails.basic_info?.user_id || '-'"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">活动ID:</span>
                      <p x-text="drawDetails.basic_info?.campaign_id || '-'"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">消耗积分:</span>
                      <p x-text="drawDetails.basic_info?.cost_points || 0"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">抽奖时间:</span>
                      <p x-text="formatBeijingTime(drawDetails.basic_info?.created_at)"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">是否中奖:</span>
                      <p>
                        <span class="px-2 py-0.5 text-xs rounded"
                              :class="drawDetails.basic_info?.is_winner ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'"
                              x-text="drawDetails.basic_info?.is_winner ? '中奖' : '未中奖'"></span>
                      </p>
                    </div>
                    <div>
                      <span class="themed-text-muted">中奖档位:</span>
                      <p x-text="drawDetails.basic_info?.result_tier || '-'"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">奖品名称:</span>
                      <p x-text="drawDetails.basic_info?.prize_name || '-'"></p>
                    </div>
                  </div>
                </div>

                <!-- 用户抽奖前状态 -->
                <div x-show="drawDetails.user_state_before" class="themed-card rounded-lg shadow p-4">
                  <h6 class="font-semibold mb-3 flex items-center gap-2">
                    <span>👤</span> 用户抽奖前状态
                  </h6>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                      <span class="themed-text-muted">连空次数:</span>
                      <p x-text="drawDetails.user_state_before?.empty_streak || 0"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">Pity进度:</span>
                      <p x-text="drawDetails.user_state_before?.pity_progress || 0"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">运气债务:</span>
                      <p x-text="drawDetails.user_state_before?.luck_debt?.toFixed(4) || '0.0000'"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">总抽奖次数:</span>
                      <p x-text="drawDetails.user_state_before?.total_draws || 0"></p>
                    </div>
                  </div>
                </div>

                <!-- 决策快照 -->
                <div x-show="drawDetails.decision_snapshot" class="themed-card rounded-lg shadow p-4">
                  <h6 class="font-semibold mb-3 flex items-center gap-2">
                    <span>🎲</span> 决策快照
                  </h6>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                      <span class="themed-text-muted">随机数:</span>
                      <p class="font-mono" x-text="drawDetails.decision_snapshot?.random_number?.toFixed(6) || '-'"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">选中档位:</span>
                      <p x-text="drawDetails.decision_snapshot?.selected_tier || '-'"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">降级次数:</span>
                      <p x-text="drawDetails.decision_snapshot?.downgrade_count || 0"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">触发Pity:</span>
                      <p>
                        <span class="px-2 py-0.5 text-xs rounded"
                              :class="drawDetails.decision_snapshot?.pity_triggered ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-700'"
                              x-text="drawDetails.decision_snapshot?.pity_triggered ? '是' : '否'"></span>
                      </p>
                    </div>
                  </div>
                </div>

                <!-- Pipeline执行详情 -->
                <div x-show="drawDetails.pipeline_execution && drawDetails.pipeline_execution.length > 0" class="themed-card rounded-lg shadow p-4">
                  <h6 class="font-semibold mb-4 flex items-center gap-2">
                    <span>⚙️</span> Pipeline执行流程 (11阶段)
                  </h6>
                  
                  <!-- Pipeline可视化 -->
                  <div class="relative">
                    <template x-for="(stage, index) in drawDetails.pipeline_execution" :key="stage.stage">
                      <div class="flex items-start gap-3 mb-4 last:mb-0">
                        <!-- 阶段序号和连接线 -->
                        <div class="flex flex-col items-center">
                          <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold"
                               :class="getPipelineStageStyle(stage.status)">
                            <span x-text="index + 1"></span>
                          </div>
                          <div x-show="index < drawDetails.pipeline_execution.length - 1" 
                               class="w-0.5 h-8 bg-gray-300 mt-1"></div>
                        </div>
                        
                        <!-- 阶段详情 -->
                        <div class="flex-1 pb-2">
                          <div class="flex items-center gap-2 mb-1">
                            <span x-text="getPipelineStageIcon(stage.status)"></span>
                            <span class="font-medium" x-text="formatPipelineStageName(stage.stage)"></span>
                            <span class="text-xs themed-text-muted" x-text="'(' + stage.stage + ')'"></span>
                            <span class="ml-auto text-xs px-2 py-0.5 rounded"
                                  :class="getPipelineStageStyle(stage.status)"
                                  x-text="stage.status"></span>
                            <span class="text-xs themed-text-muted" x-text="formatDuration(stage.duration_ms)"></span>
                          </div>
                          <!-- 阶段输出 -->
                          <div x-show="stage.output" class="text-xs themed-text-muted bg-gray-50 p-2 rounded mt-1 font-mono overflow-x-auto">
                            <pre x-text="typeof stage.output === 'object' ? JSON.stringify(stage.output, null, 2) : stage.output"></pre>
                          </div>
                        </div>
                      </div>
                    </template>
                  </div>

                  <!-- 总执行时间 -->
                  <div class="mt-4 pt-4 border-t flex justify-between items-center text-sm">
                    <span class="themed-text-muted">总执行时间:</span>
                    <span class="font-medium" x-text="formatDuration(drawDetails.pipeline_execution?.reduce((sum, s) => sum + (s.duration_ms || 0), 0))"></span>
                  </div>
                </div>
              </div>
            </template>
          </div>

          <!-- 空状态 -->
          <div x-show="!loadingDrawDetails && !drawDetails" class="p-8 text-center">
            <div class="text-4xl mb-2">📭</div>
            <p class="themed-text-muted">未找到抽奖详情</p>
          </div>

          <div class="p-4 border-t flex justify-end sticky bottom-0 bg-white">
            <button @click="closeDrawDetailsModal()" class="themed-btn-secondary px-4 py-2 rounded">
              关闭
            </button>
          </div>
        </div>
      </div>

      <!-- ==================== 风控面板页 ==================== -->
      <div x-show="current_page === 'lottery-risk-control'" x-cloak x-init="$nextTick(() => loadAbnormalUsers())">
        <!-- 风控统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
          <div class="gradient-stat-card gradient-stat-blue">
            <div class="stat-icon">🛡️</div>
            <div class="stat-value" x-text="abnormalUserStats.total">0</div>
            <div class="stat-label">异常用户总数</div>
          </div>
          <div class="gradient-stat-card gradient-stat-rose">
            <div class="stat-icon">🔥</div>
            <div class="stat-value" x-text="abnormalUserStats.high_frequency">0</div>
            <div class="stat-label">高频抽奖</div>
            <div class="stat-trend">短时间大量抽奖行为</div>
          </div>
          <div class="gradient-stat-card gradient-stat-orange">
            <div class="stat-icon">📈</div>
            <div class="stat-value" x-text="abnormalUserStats.high_win_rate">0</div>
            <div class="stat-label">高中奖率</div>
            <div class="stat-trend">中奖率异常偏高</div>
          </div>
          <div class="gradient-stat-card gradient-stat-purple">
            <div class="stat-icon">👑</div>
            <div class="stat-value" x-text="abnormalUserStats.high_tier_abnormal">0</div>
            <div class="stat-label">高档位异常</div>
            <div class="stat-trend">高价值奖品命中过多</div>
          </div>
          <div class="gradient-stat-card gradient-stat-teal">
            <div class="stat-icon">⚡</div>
            <div class="stat-value" x-text="abnormalUserStats.rapid_wins">0</div>
            <div class="stat-label">快速连中</div>
            <div class="stat-trend">短时间连续中奖</div>
          </div>
        </div>

        <!-- 筛选工具栏 -->
        <div class="filter-toolbar">
          <div class="flex flex-wrap items-center gap-4">
            <div class="flex-1 min-w-[200px]">
              <label class="form-label">异常类型</label>
              <select x-model="abnormalUserFilters.type" @change="filterAbnormalUsersByType(abnormalUserFilters.type)" class="form-select">
                <option value="all">全部类型</option>
                <option value="high_frequency">🔥 高频抽奖</option>
                <option value="high_win_rate">📈 高中奖率</option>
                <option value="high_tier_abnormal">👑 高档位异常</option>
                <option value="rapid_wins">⚡ 快速连中</option>
              </select>
            </div>
            <div class="flex items-end gap-2 mt-auto">
              <button @click="refreshAbnormalUsers()" class="action-btn action-btn-primary rounded-lg flex items-center gap-1.5">
                ♻️ 刷新数据
              </button>
            </div>
          </div>
        </div>

        <!-- 异常用户列表 -->
        <div class="content-section">
          <div class="content-section-header">
            <div class="section-title">
              <span class="title-icon">🛡️</span>
              异常用户列表
            </div>
            <span class="badge badge-gray" x-text="'共 ' + abnormalUserPagination.total_count + ' 个异常用户'"></span>
          </div>

          <!-- 加载状态 -->
          <div x-show="loadingAbnormalUsers" class="p-12 text-center">
            <div class="loading-spinner w-8 h-8 mx-auto mb-3"></div>
            <p class="themed-text-muted text-sm">正在扫描异常行为数据...</p>
          </div>

          <!-- 空状态 - 良好状态提示 -->
          <div x-show="!loadingAbnormalUsers && abnormalUsers.length === 0" class="empty-state empty-state-success">
            <div class="empty-state-icon-circle" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0);">
              <div class="empty-state-icon" style="font-size: 2.5rem;">✅</div>
            </div>
            <div class="empty-state-title" style="color: #059669;">系统运行正常</div>
            <div class="empty-state-description">当前没有检测到异常用户行为，风控系统持续监控中。</div>
            <div class="empty-state-tips">
              <div class="empty-state-tips-title">💡 风控面板说明</div>
              <div>系统会自动检测以下异常行为：高频抽奖、中奖率偏高、高档位命中过多、短时间连续中奖</div>
              <div>发现异常用户后，可在此查看详情并进行人工审核</div>
            </div>
          </div>

          <!-- 用户列表 -->
          <div x-show="!loadingAbnormalUsers && abnormalUsers.length > 0" class="overflow-x-auto">
            <table class="enhanced-table w-full">
              <thead>
                <tr>
                  <th>用户ID</th>
                  <th>异常类型</th>
                  <th>风险等级</th>
                  <th>异常指标</th>
                  <th>检测时间</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                <template x-for="user in abnormalUsers" :key="user.user_id">
                  <tr class="themed-hover-bg">
                    <td class="px-4 py-3 text-sm font-mono" x-text="user.user_id"></td>
                    <td class="px-4 py-3 text-sm">
                      <span class="px-2 py-1 rounded text-xs inline-flex items-center gap-1"
                            :class="getAbnormalTypeStyle(user.abnormal_type)">
                        <span x-text="getAbnormalTypeIcon(user.abnormal_type)"></span>
                        <span x-text="user.abnormal_type_display || user.abnormal_type"></span>
                      </span>
                    </td>
                    <td class="px-4 py-3 text-sm">
                      <span class="px-2 py-1 rounded text-xs"
                            :class="getRiskLevelStyle(user.risk_level)"
                            x-text="user.risk_level_display || user.risk_level"></span>
                    </td>
                    <td class="px-4 py-3 text-sm themed-text-muted" x-text="user.metrics ? '24h抽奖' + user.metrics.draw_count_24h + '次, 中奖率' + user.metrics.win_rate + '%' : '-'"></td>
                    <td class="px-4 py-3 text-sm themed-text-muted" x-text="formatRiskTime(user.last_draw_time)"></td>
                    <td class="px-4 py-3 text-sm">
                      <div class="flex items-center gap-2">
                        <button @click="viewAbnormalUserDetail(user)"
                                class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-700 hover:bg-blue-200"
                                title="查看详情">
                          👁️ 详情
                        </button>
                        <button @click="goToUserProfile(user.user_id)"
                                class="px-2 py-1 text-xs rounded bg-green-100 text-green-700 hover:bg-green-200"
                                title="查看用户档案">
                          📋 档案
                        </button>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>

          <!-- 分页 -->
          <div x-show="abnormalUserPagination.total_pages > 1" class="p-4 border-t">
            <div class="flex justify-center items-center gap-2">
              <button @click="changeAbnormalUsersPage(1)" 
                      :disabled="abnormalUserPagination.current_page === 1"
                      class="px-3 py-1 rounded themed-btn-secondary disabled:opacity-50">
                首页
              </button>
              <button @click="changeAbnormalUsersPage(abnormalUserPagination.current_page - 1)" 
                      :disabled="abnormalUserPagination.current_page === 1"
                      class="px-3 py-1 rounded themed-btn-secondary disabled:opacity-50">
                上一页
              </button>
              <span class="px-4 py-1 themed-text-muted">
                第 <span x-text="abnormalUserPagination.current_page"></span> / <span x-text="abnormalUserPagination.total_pages"></span> 页
              </span>
              <button @click="changeAbnormalUsersPage(abnormalUserPagination.current_page + 1)" 
                      :disabled="abnormalUserPagination.current_page >= abnormalUserPagination.total_pages"
                      class="px-3 py-1 rounded themed-btn-secondary disabled:opacity-50">
                下一页
              </button>
              <button @click="changeAbnormalUsersPage(abnormalUserPagination.total_pages)" 
                      :disabled="abnormalUserPagination.current_page >= abnormalUserPagination.total_pages"
                      class="px-3 py-1 rounded themed-btn-secondary disabled:opacity-50">
                末页
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 异常用户详情弹窗 -->
      <div x-show="showAbnormalUserDetailModal" 
           class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
           x-cloak
           @click.self="closeAbnormalUserDetailModal()">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] overflow-auto">
          <div class="p-4 border-b flex justify-between items-center">
            <h5 class="font-semibold">🛡️ 异常用户详情</h5>
            <button @click="closeAbnormalUserDetailModal()" class="text-gray-500 hover:text-gray-700">✕</button>
          </div>
          <div class="p-6">
            <template x-if="selectedAbnormalUser">
              <div class="space-y-4">
                <div class="flex items-center gap-3 mb-4">
                  <span x-text="getAbnormalTypeIcon(selectedAbnormalUser.abnormal_type)" class="text-3xl"></span>
                  <div>
                    <span class="text-lg font-semibold" x-text="'用户 #' + selectedAbnormalUser.user_id"></span>
                    <span class="ml-2 px-2 py-0.5 rounded text-xs"
                          :class="getRiskLevelStyle(selectedAbnormalUser.risk_level)"
                          x-text="selectedAbnormalUser.risk_level_display || selectedAbnormalUser.risk_level"></span>
                  </div>
                </div>
                <table class="w-full text-sm">
                  <tr class="border-b">
                    <th class="py-2 text-left w-1/3">用户ID</th>
                    <td class="py-2 font-mono" x-text="selectedAbnormalUser.user_id"></td>
                  </tr>
                  <tr class="border-b">
                    <th class="py-2 text-left">异常类型</th>
                    <td class="py-2">
                      <span class="px-2 py-0.5 rounded text-xs"
                            :class="getAbnormalTypeStyle(selectedAbnormalUser.abnormal_type)"
                            x-text="selectedAbnormalUser.abnormal_type_display || selectedAbnormalUser.abnormal_type"></span>
                    </td>
                  </tr>
                  <tr class="border-b">
                    <th class="py-2 text-left">异常指标</th>
                    <td class="py-2" x-text="selectedAbnormalUser.abnormal_value || '-'"></td>
                  </tr>
                  <tr class="border-b">
                    <th class="py-2 text-left">检测时间</th>
                    <td class="py-2" x-text="formatRiskTime(selectedAbnormalUser.detected_at)"></td>
                  </tr>
                  <tr class="border-b" x-show="selectedAbnormalUser.draw_count">
                    <th class="py-2 text-left">抽奖次数</th>
                    <td class="py-2" x-text="selectedAbnormalUser.draw_count"></td>
                  </tr>
                  <tr class="border-b" x-show="selectedAbnormalUser.win_count">
                    <th class="py-2 text-left">中奖次数</th>
                    <td class="py-2" x-text="selectedAbnormalUser.win_count"></td>
                  </tr>
                  <tr class="border-b" x-show="selectedAbnormalUser.win_rate">
                    <th class="py-2 text-left">中奖率</th>
                    <td class="py-2" x-text="(selectedAbnormalUser.win_rate * 100).toFixed(2) + '%'"></td>
                  </tr>
                  <tr class="border-b" x-show="selectedAbnormalUser.description">
                    <th class="py-2 text-left">描述</th>
                    <td class="py-2" x-text="selectedAbnormalUser.description"></td>
                  </tr>
                </table>
              </div>
            </template>
          </div>
          <div class="p-4 border-t flex justify-end gap-2">
            <button @click="goToUserProfile(selectedAbnormalUser?.user_id)" 
                    class="themed-btn-primary px-4 py-2 rounded">
              📋 查看用户档案
            </button>
            <button @click="closeAbnormalUserDetailModal()" class="themed-btn-secondary px-4 py-2 rounded">
              关闭
            </button>
          </div>
        </div>
      </div>

      <!-- ==================== 策略效果分析页面 (P2) ==================== -->
      <div x-show="current_page === 'strategy-effectiveness'" x-cloak x-init="$nextTick(() => loadStrategyEffectiveness())">
        
        <!-- 页面标题和筛选 -->
        <div class="rounded-lg shadow-lg mb-6 overflow-hidden">
          <div class="bg-gradient-to-r from-violet-600 via-purple-600 to-indigo-600 p-5">
            <div class="flex flex-wrap items-center justify-between gap-4">
              <div>
                <h5 class="font-bold text-white text-lg flex items-center gap-2">
                  📈 策略效果分析
                </h5>
                <p class="text-sm text-white/80 mt-1">实时分析各策略的触发频率、保护效果和矩阵命中分布，帮助运营优化出奖策略</p>
              </div>
              <div class="flex items-center gap-2 flex-wrap">
                <select x-model="strategyEffectivenessFilters.campaign_id" 
                        @change="applyStrategyEffectivenessFilters()"
                        class="rounded-lg px-3 py-2 text-sm w-40 bg-white/90 border-0 shadow-sm">
                  <option value="">全部活动</option>
                  <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
                    <option :value="campaign.lottery_campaign_id" x-text="campaign.campaign_name"></option>
                  </template>
                </select>
                <input type="date" x-model="strategyEffectivenessFilters.start_date"
                       @change="applyStrategyEffectivenessFilters()"
                       class="rounded-lg px-3 py-2 text-sm bg-white/90 border-0 shadow-sm">
                <input type="date" x-model="strategyEffectivenessFilters.end_date"
                       @change="applyStrategyEffectivenessFilters()"
                       class="rounded-lg px-3 py-2 text-sm bg-white/90 border-0 shadow-sm">
                <button @click="resetStrategyEffectivenessFilters()" 
                        class="px-3 py-2 rounded-lg text-sm bg-white/20 text-white hover:bg-white/30 transition-colors">
                  重置
                </button>
                <button @click="refreshStrategyEffectiveness()" 
                        class="px-4 py-2 rounded-lg text-sm bg-white text-purple-700 font-medium hover:bg-gray-50 transition-colors shadow-sm flex items-center gap-1"
                        :disabled="loadingStrategyEffectiveness">
                  <span x-show="!loadingStrategyEffectiveness">🔄 刷新数据</span>
                  <span x-show="loadingStrategyEffectiveness" class="flex items-center gap-1">
                    <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                    加载中...
                  </span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- 加载状态 -->
        <div x-show="loadingStrategyEffectiveness" class="text-center py-16">
          <div class="animate-spin inline-block w-10 h-10 border-4 border-purple-500 border-t-transparent rounded-full mb-4"></div>
          <p class="themed-text-muted text-sm">正在加载策略效果分析数据...</p>
        </div>

        <!-- 无数据状态 -->
        <div x-show="!loadingStrategyEffectiveness && !strategyEffectiveness" class="text-center py-16">
          <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-purple-50 mb-4">
            <span class="text-4xl">📊</span>
          </div>
          <p class="themed-text-muted font-medium mb-1">暂无策略效果数据</p>
          <p class="text-sm themed-text-muted mb-4">请选择活动或调整时间范围后重新加载</p>
          <button @click="loadStrategyEffectiveness()" class="px-6 py-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-lg hover:from-purple-600 hover:to-indigo-700 transition-all shadow-md">
            重新加载
          </button>
        </div>

        <!-- 策略效果分析内容 -->
        <template x-if="strategyEffectiveness && !loadingStrategyEffectiveness">
          <div class="space-y-6">
            
            <!-- 核心指标卡片 -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div class="rounded-xl shadow-sm overflow-hidden border border-gray-100">
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-5">
                  <div class="flex items-center justify-between mb-3">
                    <span class="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-blue-100">
                      <span class="text-xl">📅</span>
                    </span>
                  </div>
                  <p class="text-xs text-blue-600/70 font-medium mb-1">分析周期</p>
                  <p class="font-semibold text-sm text-blue-900">
                    <span x-text="strategyEffectiveness.analysis_period?.start ? formatDateOnly(strategyEffectiveness.analysis_period.start) : '-'"></span>
                    <span class="text-blue-400 mx-1">→</span>
                    <span x-text="strategyEffectiveness.analysis_period?.end ? formatDateOnly(strategyEffectiveness.analysis_period.end) : '-'"></span>
                  </p>
                </div>
              </div>
              <div class="rounded-xl shadow-sm overflow-hidden border border-gray-100">
                <div class="bg-gradient-to-br from-emerald-50 to-green-50 p-5">
                  <div class="flex items-center justify-between mb-3">
                    <span class="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-emerald-100">
                      <span class="text-xl">🎯</span>
                    </span>
                  </div>
                  <p class="text-xs text-emerald-600/70 font-medium mb-1">整体策略评分</p>
                  <p class="text-2xl font-bold" 
                     :class="getStrategyScoreColor(strategyEffectiveness.overall_strategy_score)"
                     x-text="(strategyEffectiveness.overall_strategy_score || 0) + '分'"></p>
                </div>
              </div>
              <div class="rounded-xl shadow-sm overflow-hidden border border-gray-100">
                <div class="bg-gradient-to-br from-violet-50 to-purple-50 p-5">
                  <div class="flex items-center justify-between mb-3">
                    <span class="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-violet-100">
                      <span class="text-xl">📊</span>
                    </span>
                  </div>
                  <p class="text-xs text-violet-600/70 font-medium mb-1">BxPx矩阵评分</p>
                  <p class="text-2xl font-bold text-violet-700" x-text="(strategyEffectiveness.bxpx_matrix_analysis?.effectiveness_score || 0)"></p>
                  <p class="text-xs text-violet-500/60 mt-1" x-show="strategyEffectiveness.bxpx_matrix_analysis?.active_cells != null"
                     x-text="'活跃格子: ' + (strategyEffectiveness.bxpx_matrix_analysis?.active_cells || 0) + '/' + (strategyEffectiveness.bxpx_matrix_analysis?.total_cells || 12)"></p>
                </div>
              </div>
              <div class="rounded-xl shadow-sm overflow-hidden border border-gray-100">
                <div class="bg-gradient-to-br from-amber-50 to-orange-50 p-5">
                  <div class="flex items-center justify-between mb-3">
                    <span class="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-amber-100">
                      <span class="text-xl">⬇️</span>
                    </span>
                  </div>
                  <p class="text-xs text-amber-600/70 font-medium mb-1">总降级次数</p>
                  <p class="text-2xl font-bold text-amber-700" x-text="(strategyEffectiveness.tier_downgrade_analysis?.total_downgrades || 0).toLocaleString()"></p>
                </div>
              </div>
            </div>

            <!-- 指标含义说明（可折叠） -->
            <div class="rounded-xl shadow-sm overflow-hidden border border-blue-100 bg-blue-50/50" x-data="{ showGuide: false }">
              <button @click="showGuide = !showGuide" class="w-full px-5 py-3 flex items-center justify-between text-left hover:bg-blue-50 transition-colors">
                <span class="text-sm font-medium text-blue-700 flex items-center gap-2">
                  <span>💡</span> 指标含义与运营指南
                  <span class="text-xs text-blue-400 font-normal">（点击展开/收起）</span>
                </span>
                <svg :class="showGuide ? 'rotate-180' : ''" class="w-4 h-4 text-blue-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </button>
              <div x-show="showGuide" x-collapse class="px-5 pb-5 space-y-4 text-sm text-slate-600">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="bg-white rounded-lg p-4 border border-slate-100">
                    <h6 class="font-semibold text-slate-800 mb-2">📊 四个核心指标</h6>
                    <dl class="space-y-2">
                      <div>
                        <dt class="font-medium text-emerald-700">整体策略评分（0-100分）</dt>
                        <dd class="text-xs text-slate-500 mt-0.5">综合评估策略运行健康度。80分以上=优秀，60-80=正常，60以下=需关注。评分依据：矩阵分散度、体验机制触发率、降级率。</dd>
                      </div>
                      <div>
                        <dt class="font-medium text-violet-700">BxPx矩阵评分（0-100分）</dt>
                        <dd class="text-xs text-slate-500 mt-0.5">衡量用户群体的多样性。分数越高=不同消费水平的用户越均匀。如果分数很低，说明用户群体过于单一（如全是高消费用户或全是新用户）。</dd>
                      </div>
                      <div>
                        <dt class="font-medium text-amber-700">总降级次数</dt>
                        <dd class="text-xs text-slate-500 mt-0.5">系统原本想给用户好奖品，但因库存不足或预算紧张被迫给了更低档奖品的次数。数字大=需要补充库存或调整预算。</dd>
                      </div>
                    </dl>
                  </div>
                  <div class="bg-white rounded-lg p-4 border border-slate-100">
                    <h6 class="font-semibold text-slate-800 mb-2">🔥 热力图怎么看</h6>
                    <dl class="space-y-2">
                      <div>
                        <dt class="font-medium text-slate-700">纵轴 B（预算层级）= 用户的消费预算</dt>
                        <dd class="text-xs text-slate-500 mt-0.5">由用户消费行为产生的「抽奖专用预算」决定，不是用户钱包余额。<br>B0=预算不足（&lt;100） B1=低预算 B2=中预算 B3=高预算（≥1000）</dd>
                      </div>
                      <div>
                        <dt class="font-medium text-slate-700">横轴 P（压力层级）= 活动的花钱速度</dt>
                        <dd class="text-xs text-slate-500 mt-0.5">衡量整个活动发出奖品的速度是否超出预期。所有用户共享同一个P值。<br>P0=花得慢（充裕） P1=花得正常 P2=花得快（紧张）</dd>
                      </div>
                      <div>
                        <dt class="font-medium text-slate-700">格子里的百分比</dt>
                        <dd class="text-xs text-slate-500 mt-0.5">表示在该条件下发生的抽奖占总抽奖次数的比例。理想状态：数据均匀分布在多个格子中。</dd>
                      </div>
                    </dl>
                  </div>
                </div>
                <div class="bg-white rounded-lg p-4 border border-slate-100">
                  <h6 class="font-semibold text-slate-800 mb-2">⚡ 运营行动指南</h6>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
                    <div class="bg-red-50 rounded p-3 border border-red-100">
                      <p class="font-semibold text-red-700 mb-1">🚨 P2占比偏高</p>
                      <p class="text-red-600">活动预算消耗过快，系统正在自动压低大奖概率来保护预算。</p>
                      <p class="text-red-500 mt-1 font-medium">→ 追加活动预算 或 减少高价值奖品</p>
                    </div>
                    <div class="bg-amber-50 rounded p-3 border border-amber-100">
                      <p class="font-semibold text-amber-700 mb-1">⚠️ B0用户过多</p>
                      <p class="text-amber-600">大量用户消费预算不足，只能抽到参与奖，体验差。</p>
                      <p class="text-amber-500 mt-1 font-medium">→ 降低抽奖门槛 或 增加消费返预算比例</p>
                    </div>
                    <div class="bg-green-50 rounded p-3 border border-green-100">
                      <p class="font-semibold text-green-700 mb-1">✅ 理想分布</p>
                      <p class="text-green-600">多个格子都有数据，P0/P1为主，B1-B3均有用户。</p>
                      <p class="text-green-500 mt-1 font-medium">→ 策略健康运行，持续监控即可</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- BxPx矩阵热力图 -->
            <div class="rounded-xl shadow-sm overflow-hidden border border-gray-100">
              <div class="px-5 py-4 bg-gradient-to-r from-slate-700 to-slate-800 flex items-center justify-between">
                <div>
                  <h6 class="font-semibold text-white flex items-center gap-2">
                    🔥 BxPx 矩阵热力图
                  </h6>
                  <p class="text-xs text-slate-300 mt-1">预算层级(B) × 压力层级(P) 的命中率分布，颜色越深代表命中频率越高</p>
                </div>
                <div class="flex items-center gap-2 text-xs text-slate-300">
                  <span class="flex items-center gap-1"><span class="w-3 h-2 rounded bg-green-200"></span>低</span>
                  <span class="flex items-center gap-1"><span class="w-3 h-2 rounded bg-yellow-300"></span>中</span>
                  <span class="flex items-center gap-1"><span class="w-3 h-2 rounded bg-red-500"></span>高</span>
                </div>
              </div>
              <div class="p-5 bg-white">
                <template x-if="strategyEffectiveness.bxpx_matrix_analysis">
                  <div class="overflow-x-auto">
                    <table class="w-full text-sm border-separate" style="border-spacing: 4px;">
                      <thead>
                        <tr>
                          <th class="p-3 text-center text-xs font-semibold themed-text-muted rounded-lg bg-gray-50">预算 \ 压力</th>
                          <template x-for="pTier in ['P0', 'P1', 'P2']" :key="pTier">
                            <th class="p-3 text-center rounded-lg bg-slate-100">
                              <span class="font-semibold text-slate-700 block" x-text="getPressureTierName(pTier)"></span>
                              <span class="text-xs text-slate-400" x-text="pTier"></span>
                            </th>
                          </template>
                        </tr>
                      </thead>
                      <tbody>
                        <template x-for="bTier in ['B0', 'B1', 'B2', 'B3']" :key="bTier">
                          <tr>
                            <th class="p-3 text-center rounded-lg bg-slate-100">
                              <span class="font-semibold text-slate-700 block" x-text="getBudgetTierName(bTier)"></span>
                              <span class="text-xs text-slate-400" x-text="bTier"></span>
                            </th>
                            <template x-for="pTier in ['P0', 'P1', 'P2']" :key="pTier">
                              <td class="p-1 text-center">
                                <template x-if="strategyEffectiveness.bxpx_matrix_analysis.hit_distribution">
                                  <div class="p-3 rounded-lg transition-transform hover:scale-105 cursor-default"
                                       :class="getBxPxHeatmapColor(strategyEffectiveness.bxpx_matrix_analysis.hit_distribution[bTier + '_' + pTier]?.rate || 0)"
                                       :title="bTier + ' × ' + pTier + ': ' + (strategyEffectiveness.bxpx_matrix_analysis.hit_distribution[bTier + '_' + pTier]?.rate || 0).toFixed(1) + '%'">
                                    <p class="text-lg font-bold" x-text="(strategyEffectiveness.bxpx_matrix_analysis.hit_distribution[bTier + '_' + pTier]?.rate || 0).toFixed(1) + '%'"></p>
                                    <p class="text-xs opacity-75 mt-0.5" x-text="(strategyEffectiveness.bxpx_matrix_analysis.hit_distribution[bTier + '_' + pTier]?.count || 0).toLocaleString() + ' 次'"></p>
                                  </div>
                                </template>
                              </td>
                            </template>
                          </tr>
                        </template>
                      </tbody>
                    </table>
                  </div>
                </template>
                <template x-if="!strategyEffectiveness.bxpx_matrix_analysis || !strategyEffectiveness.bxpx_matrix_analysis.hit_distribution || Object.keys(strategyEffectiveness.bxpx_matrix_analysis.hit_distribution).length === 0">
                  <div class="text-center py-8">
                    <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-gray-100 mb-3">
                      <span class="text-xl">📊</span>
                    </div>
                    <p class="themed-text-muted text-sm">暂无BxPx矩阵数据</p>
                    <p class="text-xs themed-text-muted mt-1">数据将在有抽奖记录后自动生成</p>
                  </div>
                </template>

                <!-- 矩阵工作原理说明 -->
                <div class="mt-4 border-t border-slate-100 pt-4">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs text-slate-500">
                    <div>
                      <p class="font-semibold text-slate-600 mb-2">📐 矩阵如何影响中奖概率</p>
                      <table class="w-full text-xs border-collapse">
                        <thead>
                          <tr class="text-left">
                            <th class="pb-1 text-slate-400 font-medium">场景</th>
                            <th class="pb-1 text-slate-400 font-medium">大奖概率</th>
                            <th class="pb-1 text-slate-400 font-medium">含义</th>
                          </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                          <tr>
                            <td class="py-1.5"><span class="inline-block w-2 h-2 rounded-full bg-green-400 mr-1"></span>B3 + P0</td>
                            <td class="py-1.5 font-medium text-green-600">×1.5 提升</td>
                            <td class="py-1.5">高预算+预算充裕 → 大方发奖</td>
                          </tr>
                          <tr>
                            <td class="py-1.5"><span class="inline-block w-2 h-2 rounded-full bg-blue-400 mr-1"></span>B3 + P1</td>
                            <td class="py-1.5 font-medium text-blue-600">×1.0 正常</td>
                            <td class="py-1.5">高预算+正常消耗 → 按标准概率</td>
                          </tr>
                          <tr>
                            <td class="py-1.5"><span class="inline-block w-2 h-2 rounded-full bg-red-400 mr-1"></span>B3 + P2</td>
                            <td class="py-1.5 font-medium text-red-600">×0.6 压低</td>
                            <td class="py-1.5">高预算+消耗过快 → 保护预算</td>
                          </tr>
                          <tr>
                            <td class="py-1.5"><span class="inline-block w-2 h-2 rounded-full bg-slate-300 mr-1"></span>B0 + 任意</td>
                            <td class="py-1.5 font-medium text-slate-400">不可用</td>
                            <td class="py-1.5">预算不足 → 仅参与奖</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    <div>
                      <p class="font-semibold text-slate-600 mb-2">🎯 数据来源说明</p>
                      <ul class="space-y-1.5">
                        <li class="flex items-start gap-1.5">
                          <span class="text-violet-400 mt-0.5">●</span>
                          <span><strong class="text-slate-600">预算(B)</strong> = 用户消费行为积累的「抽奖专用预算」（BUDGET_POINTS），不是用户钱包可用余额</span>
                        </li>
                        <li class="flex items-start gap-1.5">
                          <span class="text-blue-400 mt-0.5">●</span>
                          <span><strong class="text-slate-600">压力(P)</strong> = 整个活动已发奖总价值 ÷ 活动预算池 ÷ 时间进度，是活动级别指标，所有用户共享</span>
                        </li>
                        <li class="flex items-start gap-1.5">
                          <span class="text-amber-400 mt-0.5">●</span>
                          <span><strong class="text-slate-600">系统自动平衡</strong>：预算充裕时提升大奖概率让用户开心，预算紧张时压低大奖概率保护活动</span>
                        </li>
                        <li class="flex items-start gap-1.5">
                          <span class="text-emerald-400 mt-0.5">●</span>
                          <span><strong class="text-slate-600">无需手动干预</strong>：矩阵根据实时数据自动调节，运营只需监控分布是否健康</span>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 体验机制分析 -->
            <div class="rounded-xl shadow-sm overflow-hidden border border-gray-100">
              <div class="px-5 py-4 bg-gradient-to-r from-emerald-600 to-teal-600">
                <h6 class="font-semibold text-white flex items-center gap-2">
                  🎮 体验保护机制
                </h6>
                <p class="text-xs text-emerald-100 mt-1">这些机制自动保护用户的抽奖体验，防止出现极端不佳情况</p>
              </div>
              <div class="p-5 bg-white">
                <template x-if="strategyEffectiveness.experience_mechanism_analysis">
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Pity（保底）机制 -->
                    <div class="rounded-xl border-l-4 border-l-purple-500 bg-gradient-to-br from-purple-50 to-white p-5 hover:shadow-md transition-shadow">
                      <div class="flex items-center gap-2 mb-4">
                        <span class="inline-flex items-center justify-center w-9 h-9 rounded-lg bg-purple-100">
                          <span class="text-lg">💔</span>
                        </span>
                        <div>
                          <h6 class="font-semibold text-sm text-purple-800">保底机制</h6>
                          <p class="text-xs text-purple-400">连续未中好奖时自动触发</p>
                        </div>
                      </div>
                      <div class="space-y-3 text-sm">
                        <div class="flex justify-between items-center">
                          <span class="text-purple-600/70">触发次数</span>
                          <span class="font-semibold text-purple-800 text-lg" x-text="(strategyEffectiveness.experience_mechanism_analysis.pity_mechanism?.trigger_count || 0).toLocaleString()"></span>
                        </div>
                        <div class="flex justify-between items-center">
                          <span class="text-purple-600/70">触发率</span>
                          <span class="font-semibold text-purple-800" x-text="(strategyEffectiveness.experience_mechanism_analysis.pity_mechanism?.trigger_rate || 0).toFixed(1) + '%'"></span>
                        </div>
                        <div class="pt-2 border-t border-purple-100">
                          <div class="flex justify-between items-center">
                            <span class="text-purple-600/70">效果评估</span>
                            <span class="px-2 py-0.5 rounded text-xs font-medium" 
                                  :class="(strategyEffectiveness.experience_mechanism_analysis.pity_mechanism?.effectiveness || '') === 'good' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'"
                                  x-text="strategyEffectiveness.experience_mechanism_analysis.pity_mechanism?.effectiveness || '-'"></span>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- 防空奖机制 -->
                    <div class="rounded-xl border-l-4 border-l-blue-500 bg-gradient-to-br from-blue-50 to-white p-5 hover:shadow-md transition-shadow">
                      <div class="flex items-center gap-2 mb-4">
                        <span class="inline-flex items-center justify-center w-9 h-9 rounded-lg bg-blue-100">
                          <span class="text-lg">🛡️</span>
                        </span>
                        <div>
                          <h6 class="font-semibold text-sm text-blue-800">防空奖机制</h6>
                          <p class="text-xs text-blue-400">防止连续多次空奖</p>
                        </div>
                      </div>
                      <div class="space-y-3 text-sm">
                        <div class="flex justify-between items-center">
                          <span class="text-blue-600/70">总空奖次数</span>
                          <span class="font-semibold text-blue-800 text-lg" x-text="(strategyEffectiveness.experience_mechanism_analysis.anti_empty_mechanism?.total_empty_count || 0).toLocaleString()"></span>
                        </div>
                        <div class="flex justify-between items-center">
                          <span class="text-blue-600/70">最大连空</span>
                          <span class="font-semibold text-blue-800" x-text="(strategyEffectiveness.experience_mechanism_analysis.anti_empty_mechanism?.max_empty_streak || 0) + ' 次'"></span>
                        </div>
                        <div class="pt-2 border-t border-blue-100">
                          <div class="flex justify-between items-center">
                            <span class="text-blue-600/70">效果评估</span>
                            <span class="px-2 py-0.5 rounded text-xs font-medium"
                                  :class="(strategyEffectiveness.experience_mechanism_analysis.anti_empty_mechanism?.effectiveness || '') === 'good' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'"
                                  x-text="strategyEffectiveness.experience_mechanism_analysis.anti_empty_mechanism?.effectiveness || '-'"></span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- 运气债务机制 -->
                    <div class="rounded-xl border-l-4 border-l-emerald-500 bg-gradient-to-br from-emerald-50 to-white p-5 hover:shadow-md transition-shadow">
                      <div class="flex items-center gap-2 mb-4">
                        <span class="inline-flex items-center justify-center w-9 h-9 rounded-lg bg-emerald-100">
                          <span class="text-lg">🎲</span>
                        </span>
                        <div>
                          <h6 class="font-semibold text-sm text-emerald-800">运气债务机制</h6>
                          <p class="text-xs text-emerald-400">追踪运气偏差，自动回归均值</p>
                        </div>
                      </div>
                      <div class="space-y-3 text-sm">
                        <div class="flex justify-between items-center">
                          <span class="text-emerald-600/70">平均连空数</span>
                          <span class="font-semibold text-emerald-800 text-lg" x-text="strategyEffectiveness.experience_mechanism_analysis.luck_debt_mechanism?.avg_empty_streak || 0"></span>
                        </div>
                        <div class="pt-2 border-t border-emerald-100">
                          <div class="flex justify-between items-center">
                            <span class="text-emerald-600/70">效果评估</span>
                            <span class="px-2 py-0.5 rounded text-xs font-medium"
                                  :class="(strategyEffectiveness.experience_mechanism_analysis.luck_debt_mechanism?.effectiveness || '') === 'good' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'"
                                  x-text="strategyEffectiveness.experience_mechanism_analysis.luck_debt_mechanism?.effectiveness || '-'"></span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </template>
                <template x-if="!strategyEffectiveness.experience_mechanism_analysis">
                  <div class="text-center py-8">
                    <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-emerald-50 mb-3">
                      <span class="text-xl">🎮</span>
                    </div>
                    <p class="themed-text-muted text-sm">暂无体验机制数据</p>
                  </div>
                </template>
              </div>
            </div>

            <!-- P2#12: 策略触发频率热力图 -->
            <div class="rounded-xl shadow-sm overflow-hidden border border-gray-100">
              <div class="px-5 py-4 bg-gradient-to-r from-amber-600 to-orange-600">
                <h6 class="font-semibold text-white flex items-center gap-2">
                  🔥 策略触发频率分布
                </h6>
                <p class="text-xs text-amber-100 mt-1">各保护机制的每日触发频次分布，帮助判断策略是否过于激进或过于保守</p>
              </div>
              <div class="p-5 bg-white">
                <template x-if="strategyEffectiveness && strategyEffectiveness.experience_mechanism_analysis">
                  <div>
                    <!-- 触发次数汇总卡片 -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-5">
                      <div class="rounded-xl p-4 bg-gradient-to-br from-purple-50 to-purple-100/50 border border-purple-200/50 text-center hover:shadow-sm transition-shadow">
                        <div class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-purple-200/50 mb-2">
                          <span class="text-sm">💔</span>
                        </div>
                        <p class="text-xs text-purple-600 font-medium mb-1">保底触发</p>
                        <p class="text-2xl font-bold text-purple-700" 
                           x-text="(strategyEffectiveness.experience_mechanism_analysis.pity_mechanism?.trigger_count || 0).toLocaleString()"></p>
                        <p class="text-xs text-purple-400 mt-1" 
                           x-text="'触发率 ' + (strategyEffectiveness.experience_mechanism_analysis.pity_mechanism?.trigger_rate || 0).toFixed(1) + '%'"></p>
                      </div>
                      <div class="rounded-xl p-4 bg-gradient-to-br from-blue-50 to-blue-100/50 border border-blue-200/50 text-center hover:shadow-sm transition-shadow">
                        <div class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-blue-200/50 mb-2">
                          <span class="text-sm">🛡️</span>
                        </div>
                        <p class="text-xs text-blue-600 font-medium mb-1">反连空触发</p>
                        <p class="text-2xl font-bold text-blue-700" 
                           x-text="(strategyEffectiveness.experience_mechanism_analysis.anti_empty_mechanism?.total_empty_count || 0).toLocaleString()"></p>
                        <p class="text-xs text-blue-400 mt-1">防空奖保护</p>
                      </div>
                      <div class="rounded-xl p-4 bg-gradient-to-br from-orange-50 to-orange-100/50 border border-orange-200/50 text-center hover:shadow-sm transition-shadow">
                        <div class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-orange-200/50 mb-2">
                          <span class="text-sm">⬇️</span>
                        </div>
                        <p class="text-xs text-orange-600 font-medium mb-1">反连高触发</p>
                        <p class="text-2xl font-bold text-orange-700"
                           x-text="(strategyEffectiveness.tier_downgrade_analysis?.total_downgrades || 0).toLocaleString()"></p>
                        <p class="text-xs text-orange-400 mt-1">档位降级保护</p>
                      </div>
                      <div class="rounded-xl p-4 bg-gradient-to-br from-emerald-50 to-emerald-100/50 border border-emerald-200/50 text-center hover:shadow-sm transition-shadow">
                        <div class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-emerald-200/50 mb-2">
                          <span class="text-sm">🎲</span>
                        </div>
                        <p class="text-xs text-emerald-600 font-medium mb-1">运气债务</p>
                        <p class="text-2xl font-bold text-emerald-700"
                           x-text="strategyEffectiveness.experience_mechanism_analysis.luck_debt_mechanism?.avg_empty_streak || 0"></p>
                        <p class="text-xs text-emerald-400 mt-1">平均连空数</p>
                      </div>
                    </div>
                    <!-- 策略触发日级分布图表 -->
                    <div class="rounded-lg bg-gray-50/50 p-3">
                      <div id="strategyTriggerHeatmapChart" class="w-full" style="height: 320px;"></div>
                    </div>
                    <p class="text-xs themed-text-muted text-center mt-3 flex items-center justify-center gap-1">
                      <span class="w-1.5 h-1.5 rounded-full bg-gray-300"></span>
                      数据来源: 每日抽奖指标统计
                    </p>
                  </div>
                </template>
                <template x-if="!strategyEffectiveness || !strategyEffectiveness.experience_mechanism_analysis">
                  <div class="text-center py-8 themed-text-muted">
                    <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-amber-50 mb-3"><span class="text-xl">📊</span></div>
                    <p>暂无策略触发热力图数据</p>
                    <p class="text-xs mt-1">请先在筛选中选择活动并加载数据</p>
                  </div>
                </template>
              </div>
            </div>

            <!-- 档位降级统计 -->
            <div class="themed-card rounded-lg shadow">
              <div class="p-4 border-b">
                <h6 class="font-semibold flex items-center gap-2">
                  ⬇️ 档位降级统计
                  <span class="text-xs themed-text-muted font-normal">各档位降级频次和原因分析</span>
                </h6>
              </div>
              <!-- 使用后端字段: tier_downgrade_analysis.total_downgrades/downgrade_rate/fallback_count/main_cause/suggestions -->
              <div class="p-4">
                <template x-if="strategyEffectiveness.tier_downgrade_analysis">
                  <div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                      <div class="text-center p-3 themed-bg-subtle rounded">
                        <p class="text-xs themed-text-muted mb-1">总降级次数</p>
                        <p class="text-xl font-bold" x-text="(strategyEffectiveness.tier_downgrade_analysis.total_downgrades || 0).toLocaleString()"></p>
                      </div>
                      <div class="text-center p-3 themed-bg-subtle rounded">
                        <p class="text-xs themed-text-muted mb-1">降级率</p>
                        <p class="text-xl font-bold" :class="strategyEffectiveness.tier_downgrade_analysis.downgrade_rate > 10 ? 'text-red-600' : 'text-green-600'" x-text="(strategyEffectiveness.tier_downgrade_analysis.downgrade_rate || 0).toFixed(1) + '%'"></p>
                      </div>
                      <div class="text-center p-3 themed-bg-subtle rounded">
                        <p class="text-xs themed-text-muted mb-1">兜底触发次数</p>
                        <p class="text-xl font-bold" x-text="(strategyEffectiveness.tier_downgrade_analysis.fallback_count || 0).toLocaleString()"></p>
                      </div>
                      <div class="text-center p-3 themed-bg-subtle rounded">
                        <p class="text-xs themed-text-muted mb-1">主要原因</p>
                        <p class="text-sm font-semibold" x-text="strategyEffectiveness.tier_downgrade_analysis.main_cause === 'stock_insufficient' ? '库存不足' : '正常'"></p>
                      </div>
                    </div>
                    <!-- 降级相关建议 -->
                    <template x-if="strategyEffectiveness.tier_downgrade_analysis.suggestions && strategyEffectiveness.tier_downgrade_analysis.suggestions.length > 0">
                      <div class="mt-2">
                        <template x-for="(suggestion, idx) in strategyEffectiveness.tier_downgrade_analysis.suggestions" :key="idx">
                          <p class="text-sm text-orange-600 flex items-center gap-1">
                            <span>⚠️</span>
                            <span x-text="suggestion"></span>
                          </p>
                        </template>
                      </div>
                    </template>
                  </div>
                </template>
                <template x-if="!strategyEffectiveness.tier_downgrade_analysis">
                  <p class="text-center themed-text-muted py-4">暂无档位降级数据</p>
                </template>
              </div>
            </div>

            <!-- 优化建议 -->
            <div class="themed-card rounded-lg shadow">
              <div class="p-4 border-b">
                <h6 class="font-semibold flex items-center gap-2">
                  💡 优化建议
                  <span class="text-xs themed-text-muted font-normal">基于数据分析的策略改进建议</span>
                </h6>
              </div>
              <div class="p-4">
                <template x-if="strategyEffectiveness.optimization_recommendations && strategyEffectiveness.optimization_recommendations.length > 0">
                  <div class="space-y-3">
                    <template x-for="(rec, index) in strategyEffectiveness.optimization_recommendations" :key="index">
                      <div class="p-4 rounded" :class="getRecommendationPriorityStyle(rec.priority)">
                        <div class="flex items-start gap-3">
                          <span class="text-lg" x-text="rec.priority === 'high' ? '🔴' : rec.priority === 'medium' ? '🟡' : '🔵'"></span>
                          <div>
                            <p class="font-semibold" x-text="rec.title || '优化建议'"></p>
                            <p class="text-sm mt-1" x-text="rec.description || rec.content"></p>
                            <div class="mt-2 text-xs opacity-75" x-show="rec.impact">
                              预期影响: <span x-text="rec.impact"></span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </template>
                  </div>
                </template>
                <template x-if="!strategyEffectiveness.optimization_recommendations || strategyEffectiveness.optimization_recommendations.length === 0">
                  <div class="text-center py-8">
                    <div class="text-4xl mb-2">✅</div>
                    <p class="themed-text-muted">当前策略配置良好，暂无优化建议</p>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </template>
      </div>

      <!-- ==================== 运营日报页面 (P2) ==================== -->
      <div x-show="current_page === 'daily-report'" x-cloak x-init="$nextTick(() => loadDailyReportPage())">
        
        <!-- 页面标题和筛选 -->
        <div class="themed-card rounded-lg shadow p-6 mb-6">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <h5 class="font-semibold themed-text-primary flex items-center gap-2">
              📋 运营日报
              <span class="text-sm themed-text-muted font-normal">每日运营数据汇总 / 同比分析 / 告警提醒</span>
            </h5>
            <div class="flex items-center gap-3">
              <!-- 日期切换 -->
              <button @click="changeDailyReportDate(-1)" 
                      class="themed-btn-secondary px-2 py-2 rounded text-sm"
                      title="前一天">
                ◀
              </button>
              <input type="date" x-model="dailyReportFilters.report_date"
                     @change="applyDailyReportFilters()"
                     class="themed-input rounded px-3 py-2 text-sm">
              <button @click="changeDailyReportDate(1)" 
                      class="themed-btn-secondary px-2 py-2 rounded text-sm"
                      title="后一天">
                ▶
              </button>
              <select x-model="dailyReportFilters.campaign_id" 
                      @change="applyDailyReportFilters()"
                      class="themed-input rounded px-3 py-2 text-sm w-40">
                <option value="">全部活动</option>
                <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
                  <option :value="campaign.lottery_campaign_id" x-text="campaign.campaign_name"></option>
                </template>
              </select>
              <button @click="resetDailyReportFilters()" 
                      class="themed-btn-secondary px-3 py-2 rounded text-sm">
                重置
              </button>
              <button @click="refreshDailyReport()" 
                      class="themed-btn-primary px-4 py-2 rounded text-sm flex items-center gap-1"
                      :disabled="loadingDailyReport">
                <span x-show="!loadingDailyReport">🔄 刷新</span>
                <span x-show="loadingDailyReport">加载中...</span>
              </button>
              <button @click="exportDailyReport()" 
                      class="themed-btn-secondary px-4 py-2 rounded text-sm"
                      :disabled="!dailyReport">
                📥 导出
              </button>
            </div>
          </div>
        </div>

        <!-- 加载状态 -->
        <div x-show="loadingDailyReport" class="text-center py-12">
          <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mb-3"></div>
          <p class="themed-text-muted">加载运营日报数据中...</p>
        </div>

        <!-- 无数据状态 -->
        <div x-show="!loadingDailyReport && !dailyReport" class="text-center py-12">
          <div class="text-6xl mb-4">📋</div>
          <p class="themed-text-muted">暂无运营日报数据</p>
          <button @click="loadDailyReportPage()" class="mt-4 themed-btn-primary px-4 py-2 rounded">
            重新加载
          </button>
        </div>

        <!-- 日报内容 -->
        <template x-if="dailyReport && !loadingDailyReport">
          <div class="space-y-6">
            
            <!-- 报告头信息 -->
            <div class="themed-card rounded-lg shadow p-4">
              <div class="flex items-center justify-between">
                <div>
                  <span class="text-2xl font-bold" x-text="dailyReport.report_date || '-'"></span>
                  <span class="ml-2 themed-text-muted text-sm">运营日报</span>
                </div>
                <div class="text-sm themed-text-muted">
                  生成时间: <span x-text="formatDailyReportTime(dailyReport.generated_at)"></span>
                </div>
              </div>
            </div>

            <!-- 当日汇总 KPI 卡片 -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
              <!-- 总抽奖次数 -->
              <div class="themed-card rounded-lg shadow p-4 text-center">
                <div class="text-2xl mb-1">🎰</div>
                <p class="text-xs themed-text-muted mb-1">总抽奖次数</p>
                <p class="text-xl font-bold" x-text="(dailyReport.summary?.total_draws || 0).toLocaleString()"></p>
                <template x-if="dailyReport.vs_yesterday?.draws_change !== undefined">
                  <p class="text-xs mt-1" 
                     :class="formatDailyReportChange(dailyReport.vs_yesterday.draws_change).colorClass"
                     x-text="'较昨日 ' + formatDailyReportChange(dailyReport.vs_yesterday.draws_change).text"></p>
                </template>
              </div>
              
              <!-- 中奖率 -->
              <div class="themed-card rounded-lg shadow p-4 text-center">
                <div class="text-2xl mb-1">🎯</div>
                <p class="text-xs themed-text-muted mb-1">中奖率</p>
                <p class="text-xl font-bold" x-text="formatDailyReportPercentage(dailyReport.summary?.win_rate)"></p>
                <template x-if="dailyReport.vs_yesterday?.wins_change !== undefined">
                  <p class="text-xs mt-1" 
                     :class="formatDailyReportChange(dailyReport.vs_yesterday.wins_change).colorClass"
                     x-text="'较昨日 ' + formatDailyReportChange(dailyReport.vs_yesterday.wins_change).text"></p>
                </template>
              </div>
              
              <!-- 总成本 -->
              <div class="themed-card rounded-lg shadow p-4 text-center">
                <div class="text-2xl mb-1">💰</div>
                <p class="text-xs themed-text-muted mb-1">总成本</p>
                <p class="text-xl font-bold" x-text="formatDailyReportCurrency(dailyReport.summary?.total_cost)"></p>
                <template x-if="dailyReport.vs_yesterday?.cost_change !== undefined">
                  <p class="text-xs mt-1" 
                     :class="formatDailyReportChange(dailyReport.vs_yesterday.cost_change, true).colorClass"
                     x-text="'较昨日 ' + formatDailyReportChange(dailyReport.vs_yesterday.cost_change, true).text"></p>
                </template>
              </div>
              
              <!-- 总收入 -->
              <div class="themed-card rounded-lg shadow p-4 text-center">
                <div class="text-2xl mb-1">💵</div>
                <p class="text-xs themed-text-muted mb-1">总收入</p>
                <p class="text-xl font-bold" x-text="formatDailyReportCurrency(dailyReport.summary?.total_revenue)"></p>
                <template x-if="dailyReport.vs_yesterday?.revenue_change !== undefined">
                  <p class="text-xs mt-1" 
                     :class="formatDailyReportChange(dailyReport.vs_yesterday.revenue_change).colorClass"
                     x-text="'较昨日 ' + formatDailyReportChange(dailyReport.vs_yesterday.revenue_change).text"></p>
                </template>
              </div>
              
              <!-- ROI -->
              <div class="themed-card rounded-lg shadow p-4 text-center">
                <div class="text-2xl mb-1">📈</div>
                <p class="text-xs themed-text-muted mb-1">ROI</p>
                <p class="text-xl font-bold" x-text="formatDailyReportPercentage(dailyReport.summary?.roi)"></p>
                <template x-if="dailyReport.vs_yesterday?.roi_change !== undefined">
                  <p class="text-xs mt-1" 
                     :class="formatDailyReportChange(dailyReport.vs_yesterday.roi_change).colorClass"
                     x-text="'较昨日 ' + formatDailyReportChange(dailyReport.vs_yesterday.roi_change).text"></p>
                </template>
              </div>
              
              <!-- 活跃用户 -->
              <div class="themed-card rounded-lg shadow p-4 text-center">
                <div class="text-2xl mb-1">👥</div>
                <p class="text-xs themed-text-muted mb-1">活跃用户</p>
                <p class="text-xl font-bold" x-text="(dailyReport.summary?.active_users || 0).toLocaleString()"></p>
                <template x-if="dailyReport.vs_yesterday?.users_change !== undefined">
                  <p class="text-xs mt-1" 
                     :class="formatDailyReportChange(dailyReport.vs_yesterday.users_change).colorClass"
                     x-text="'较昨日 ' + formatDailyReportChange(dailyReport.vs_yesterday.users_change).text"></p>
                </template>
              </div>
            </div>

            <!-- P1-7: 单用户高频预警 -->
            <div class="themed-card rounded-lg shadow" x-show="highFrequencyWarnings.length > 0">
              <div class="p-4 border-b bg-red-50">
                <h6 class="font-semibold flex items-center gap-2 text-red-700">
                  🚨 单用户高频预警
                  <span class="text-xs bg-red-200 text-red-800 px-2 py-0.5 rounded" x-text="highFrequencyWarnings.length"></span>
                </h6>
              </div>
              <div class="p-4 space-y-2">
                <template x-for="(warning, index) in highFrequencyWarnings" :key="index">
                  <div class="p-3 rounded border" :class="warning.level === 'danger' ? 'bg-red-50 border-red-300 text-red-700' : 'bg-yellow-50 border-yellow-300 text-yellow-700'">
                    <div class="flex items-start gap-2">
                      <span x-text="warning.level === 'danger' ? '🔴' : '🟡'"></span>
                      <div class="flex-1">
                        <p class="font-semibold text-sm" x-text="warning.title"></p>
                        <p class="text-sm mt-1" x-text="warning.message"></p>
                        <p x-show="warning.suggestion" class="text-xs mt-2 opacity-80" x-text="'💡 ' + warning.suggestion"></p>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </div>

            <!-- P1-7: 预算健康度可视化 -->
            <div class="themed-card rounded-lg shadow">
              <div class="p-4 border-b">
                <h6 class="font-semibold flex items-center gap-2">
                  📊 预算健康度
                  <span class="text-xs px-2 py-0.5 rounded border" :class="getBudgetHealthClass(budgetHealthData.health_level)" x-text="getBudgetHealthLabel(budgetHealthData.health_level)"></span>
                </h6>
              </div>
              <div class="p-4">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                  <div class="text-center p-3 bg-green-50 rounded-lg">
                    <p class="text-2xl font-bold text-green-600" x-text="budgetHealthData.b0_count">0</p>
                    <p class="text-xs text-gray-500 mt-1">B0 (充裕)</p>
                  </div>
                  <div class="text-center p-3 bg-blue-50 rounded-lg">
                    <p class="text-2xl font-bold text-blue-600" x-text="budgetHealthData.b1_count">0</p>
                    <p class="text-xs text-gray-500 mt-1">B1 (正常)</p>
                  </div>
                  <div class="text-center p-3 bg-yellow-50 rounded-lg">
                    <p class="text-2xl font-bold text-yellow-600" x-text="budgetHealthData.b2_count">0</p>
                    <p class="text-xs text-gray-500 mt-1">B2 (偏低)</p>
                  </div>
                  <div class="text-center p-3 bg-red-50 rounded-lg">
                    <p class="text-2xl font-bold text-red-600" x-text="budgetHealthData.b3_count">0</p>
                    <p class="text-xs text-gray-500 mt-1">B3 (最低)</p>
                  </div>
                </div>
                <!-- 进度条可视化 -->
                <div x-show="budgetHealthData.total_days > 0" class="h-4 bg-gray-200 rounded-full overflow-hidden flex">
                  <div class="bg-green-500 transition-all" :style="'width:' + (budgetHealthData.b0_count / budgetHealthData.total_days * 100) + '%'" :title="'B0: ' + budgetHealthData.b0_count + '天'"></div>
                  <div class="bg-blue-500 transition-all" :style="'width:' + (budgetHealthData.b1_count / budgetHealthData.total_days * 100) + '%'" :title="'B1: ' + budgetHealthData.b1_count + '天'"></div>
                  <div class="bg-yellow-500 transition-all" :style="'width:' + (budgetHealthData.b2_count / budgetHealthData.total_days * 100) + '%'" :title="'B2: ' + budgetHealthData.b2_count + '天'"></div>
                  <div class="bg-red-500 transition-all" :style="'width:' + (budgetHealthData.b3_count / budgetHealthData.total_days * 100) + '%'" :title="'B3: ' + budgetHealthData.b3_count + '天'"></div>
                </div>
                <div x-show="budgetHealthData.health_level === 'critical'" class="mt-3 p-2 bg-red-50 border border-red-200 rounded text-xs text-red-700">
                  ⚠️ 预算健康度异常：B3（最低预算层）天数占比过高，建议检查预算配置和出奖策略
                </div>
              </div>
            </div>

            <!-- 告警列表 -->
            <div class="themed-card rounded-lg shadow" x-show="dailyReport.alerts && dailyReport.alerts.length > 0">
              <div class="p-4 border-b">
                <h6 class="font-semibold flex items-center gap-2">
                  ⚠️ 当日告警 
                  <span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded" x-text="dailyReport.alerts?.length || 0"></span>
                </h6>
              </div>
              <div class="p-4 space-y-2">
                <template x-for="(alert, index) in dailyReport.alerts" :key="index">
                  <div class="p-3 rounded border" :class="getDailyAlertStyle(alert.level)">
                    <div class="flex items-start gap-2">
                      <span x-text="alert.level === 'danger' ? '🔴' : alert.level === 'warning' ? '🟡' : '🔵'"></span>
                      <div class="flex-1">
                        <p class="font-semibold" x-text="alert.title || alert.type"></p>
                        <p class="text-sm mt-1" x-text="alert.message || alert.description"></p>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </div>

            <!-- 24小时分布 -->
            <div class="themed-card rounded-lg shadow" x-show="dailyReport.hourly_breakdown && dailyReport.hourly_breakdown.length > 0">
              <div class="p-4 border-b">
                <h6 class="font-semibold flex items-center gap-2">
                  ⏰ 24小时分布
                </h6>
              </div>
              <div class="p-4">
                <div class="overflow-x-auto">
                  <div class="flex gap-1" style="min-width: 600px;">
                    <template x-for="(hour, index) in dailyReport.hourly_breakdown" :key="index">
                      <div class="flex-1 text-center">
                        <div class="h-20 bg-gray-100 rounded relative">
                          <div class="absolute bottom-0 left-0 right-0 bg-blue-500 rounded-b transition-all"
                               :style="'height: ' + Math.min(100, (hour.draws / (Math.max(...dailyReport.hourly_breakdown.map(h => h.draws)) || 1)) * 100) + '%'">
                          </div>
                        </div>
                        <p class="text-xs themed-text-muted mt-1" x-text="index + ':00'"></p>
                        <p class="text-xs font-semibold" x-text="hour.draws || 0"></p>
                      </div>
                    </template>
                  </div>
                </div>
              </div>
            </div>

            <!-- 档位分布和热门奖品 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              
              <!-- 档位分布 -->
              <div class="themed-card rounded-lg shadow" x-show="dailyReport.tier_breakdown && dailyReport.tier_breakdown.length > 0">
                <div class="p-4 border-b">
                  <h6 class="font-semibold flex items-center gap-2">
                    📊 档位分布
                  </h6>
                </div>
                <div class="p-4">
                  <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                      <tr>
                        <th class="p-2 text-left">档位</th>
                        <th class="p-2 text-right">次数</th>
                        <th class="p-2 text-right">成本</th>
                      </tr>
                    </thead>
                    <tbody>
                      <template x-for="(tier, index) in dailyReport.tier_breakdown" :key="index">
                        <tr class="border-b">
                          <td class="p-2">
                            <span class="px-2 py-0.5 rounded text-xs bg-blue-100 text-blue-700" x-text="tier.tier"></span>
                          </td>
                          <td class="p-2 text-right font-mono" x-text="(tier.count || 0).toLocaleString()"></td>
                          <td class="p-2 text-right font-mono" x-text="formatDailyReportCurrency(tier.cost)"></td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- 热门奖品 -->
              <div class="themed-card rounded-lg shadow" x-show="dailyReport.top_prizes && dailyReport.top_prizes.length > 0">
                <div class="p-4 border-b">
                  <h6 class="font-semibold flex items-center gap-2">
                    🏆 热门奖品 TOP5
                  </h6>
                </div>
                <div class="p-4">
                  <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                      <tr>
                        <th class="p-2 text-left">奖品</th>
                        <th class="p-2 text-right">中奖次数</th>
                        <th class="p-2 text-right">总价值</th>
                      </tr>
                    </thead>
                    <tbody>
                      <template x-for="(prize, index) in dailyReport.top_prizes.slice(0, 5)" :key="index">
                        <tr class="border-b">
                          <td class="p-2">
                            <span class="font-semibold" x-text="prize.prize_name"></span>
                          </td>
                          <td class="p-2 text-right font-mono" x-text="(prize.win_count || 0).toLocaleString()"></td>
                          <td class="p-2 text-right font-mono" x-text="formatDailyReportCurrency(prize.total_value)"></td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- 活动明细 -->
            <div class="themed-card rounded-lg shadow" x-show="dailyReport.campaigns_breakdown && dailyReport.campaigns_breakdown.length > 0">
              <div class="p-4 border-b">
                <h6 class="font-semibold flex items-center gap-2">
                  🎁 活动明细
                </h6>
              </div>
              <div class="p-4">
                <div class="overflow-x-auto">
                  <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                      <tr>
                        <th class="p-3 text-left">活动名称</th>
                        <th class="p-3 text-right">抽奖次数</th>
                        <th class="p-3 text-right">中奖次数</th>
                        <th class="p-3 text-right">中奖率</th>
                        <th class="p-3 text-right">成本</th>
                        <th class="p-3 text-right">收入</th>
                        <th class="p-3 text-right">ROI</th>
                      </tr>
                    </thead>
                    <tbody>
                      <template x-for="(campaign, index) in dailyReport.campaigns_breakdown" :key="index">
                        <tr class="border-b hover:bg-gray-50">
                          <td class="p-3 font-semibold" x-text="campaign.campaign_name"></td>
                          <td class="p-3 text-right font-mono" x-text="(campaign.draws || 0).toLocaleString()"></td>
                          <td class="p-3 text-right font-mono" x-text="(campaign.wins || 0).toLocaleString()"></td>
                          <td class="p-3 text-right font-mono" x-text="formatDailyReportPercentage(campaign.win_rate)"></td>
                          <td class="p-3 text-right font-mono" x-text="formatDailyReportCurrency(campaign.cost)"></td>
                          <td class="p-3 text-right font-mono" x-text="formatDailyReportCurrency(campaign.revenue)"></td>
                          <td class="p-3 text-right font-mono" 
                              :class="campaign.roi > 1 ? 'text-green-600' : 'text-red-600'"
                              x-text="formatDailyReportPercentage(campaign.roi)"></td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- 同比分析卡片 -->
            <div class="themed-card rounded-lg shadow" x-show="dailyReport.vs_last_week">
              <div class="p-4 border-b">
                <h6 class="font-semibold flex items-center gap-2">
                  📅 上周同日对比
                </h6>
              </div>
              <div class="p-4">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-center text-sm">
                  <div>
                    <p class="themed-text-muted mb-1">抽奖次数</p>
                    <p class="font-semibold" 
                       :class="formatDailyReportChange(dailyReport.vs_last_week?.draws_change).colorClass"
                       x-text="formatDailyReportChange(dailyReport.vs_last_week?.draws_change).text"></p>
                  </div>
                  <div>
                    <p class="themed-text-muted mb-1">中奖数</p>
                    <p class="font-semibold" 
                       :class="formatDailyReportChange(dailyReport.vs_last_week?.wins_change).colorClass"
                       x-text="formatDailyReportChange(dailyReport.vs_last_week?.wins_change).text"></p>
                  </div>
                  <div>
                    <p class="themed-text-muted mb-1">总成本</p>
                    <p class="font-semibold" 
                       :class="formatDailyReportChange(dailyReport.vs_last_week?.cost_change, true).colorClass"
                       x-text="formatDailyReportChange(dailyReport.vs_last_week?.cost_change, true).text"></p>
                  </div>
                  <div>
                    <p class="themed-text-muted mb-1">总收入</p>
                    <p class="font-semibold" 
                       :class="formatDailyReportChange(dailyReport.vs_last_week?.revenue_change).colorClass"
                       x-text="formatDailyReportChange(dailyReport.vs_last_week?.revenue_change).text"></p>
                  </div>
                  <div>
                    <p class="themed-text-muted mb-1">ROI</p>
                    <p class="font-semibold" 
                       :class="formatDailyReportChange(dailyReport.vs_last_week?.roi_change).colorClass"
                       x-text="formatDailyReportChange(dailyReport.vs_last_week?.roi_change).text"></p>
                  </div>
                  <div>
                    <p class="themed-text-muted mb-1">活跃用户</p>
                    <p class="font-semibold" 
                       :class="formatDailyReportChange(dailyReport.vs_last_week?.users_change).colorClass"
                       x-text="formatDailyReportChange(dailyReport.vs_last_week?.users_change).text"></p>
                  </div>
                </div>
              </div>
            </div>

            <!-- P2#10: 运营日报自动推送配置 -->
            <div class="themed-card rounded-lg shadow">
              <div class="p-4 border-b flex justify-between items-center">
                <h6 class="font-semibold flex items-center gap-2">
                  🔔 运营日报自动推送
                  <span class="text-xs themed-text-muted font-normal">复用 ReportTemplate + ReminderEngine + NotificationService</span>
                </h6>
              </div>
              <div class="p-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <!-- 推送频率说明 -->
                  <div class="rounded-lg p-4 themed-bg-base">
                    <p class="text-sm font-medium mb-2">📅 推送配置</p>
                    <div class="space-y-2 text-xs themed-text-muted">
                      <p>推送频率: <span class="font-medium themed-text-primary">每日定时</span></p>
                      <p>推送时间: <span class="font-medium">09:00（北京时间）</span></p>
                      <p>推送渠道: <span class="font-medium">消息中心</span></p>
                      <p class="mt-2">配置方式: 通过 <a href="/admin/reminder-rules.html" class="themed-text-primary underline">提醒规则管理</a> 页面创建定时提醒规则</p>
                    </div>
                  </div>
                  <!-- 日报内容概要 -->
                  <div class="rounded-lg p-4 themed-bg-base">
                    <p class="text-sm font-medium mb-2">📊 日报内容</p>
                    <div class="space-y-1 text-xs themed-text-muted">
                      <p>• 今日待办汇总（待审核/待核销/待回复）</p>
                      <p>• 昨日核心指标（抽奖次数/中奖率/成本/ROI）</p>
                      <p>• 同比分析（昨日对比/上周同日对比）</p>
                      <p>• 异常告警提醒（高频用户/预算异常/库存预警）</p>
                    </div>
                  </div>
                  <!-- 快捷操作 -->
                  <div class="rounded-lg p-4 themed-bg-base flex flex-col justify-between">
                    <p class="text-sm font-medium mb-2">⚙️ 快捷操作</p>
                    <div class="space-y-2">
                      <button @click="generateAndPushDailyReport()" 
                              class="w-full themed-btn-primary px-3 py-2 rounded text-sm"
                              :disabled="loadingDailyReport">
                        <span x-show="!loadingDailyReport">📤 立即生成并推送今日日报</span>
                        <span x-show="loadingDailyReport">生成中...</span>
                      </button>
                      <button @click="exportDailyReportPDF()" 
                              class="w-full themed-btn-secondary px-3 py-2 rounded text-sm"
                              :disabled="!dailyReport">
                        📥 导出当前日报为PDF
                      </button>
                      <p class="text-xs themed-text-muted text-center mt-1">
                        后端: lottery-report/daily + NotificationService
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </template>
      </div>

      <!-- ==================== 策略效果模拟分析页面 (2026-02-20) ==================== -->
      <div x-show="current_page === 'strategy-simulation'" x-cloak>

        <!-- 页面引导说明 -->
        <div class="rounded-lg p-4 mb-6 bg-gradient-to-r from-emerald-500 to-teal-600 text-white shadow-lg">
          <div class="flex items-start gap-3">
            <span class="text-2xl mt-0.5">🧪</span>
            <div>
              <h5 class="font-semibold text-lg mb-1">策略效果模拟分析</h5>
              <p class="text-sm opacity-90">通过 Monte Carlo 模拟引擎预览参数调整效果，在不影响线上的情况下评估不同配置方案。</p>
              <div class="flex flex-wrap gap-3 mt-3 text-xs">
                <span class="px-2 py-1 bg-white/20 rounded">🎯 参数沙盒 — 安全调参</span>
                <span class="px-2 py-1 bg-white/20 rounded">📊 对比分析 — 当前 vs 模拟</span>
                <span class="px-2 py-1 bg-white/20 rounded">👤 用户旅程 — 逐次透视</span>
                <span class="px-2 py-1 bg-white/20 rounded">📈 灵敏度 — 参数扫射</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 加载中状态 -->
        <template x-if="loading_baseline">
          <div class="flex justify-center items-center py-16">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-emerald-500"></div>
            <span class="ml-3 text-gray-500">加载基线数据...</span>
          </div>
        </template>

        <!-- 主内容区域 -->
        <template x-if="simulation_baseline && !loading_baseline">
          <div>
            <!-- 子Tab切换 -->
            <div class="flex gap-1 mb-6 bg-gray-100 rounded-lg p-1 overflow-x-auto">
              <template x-for="tab in [
                {id:'sandbox', label:'参数沙盒', icon:'🎯'},
                {id:'comparison', label:'对比分析', icon:'📊'},
                {id:'journey', label:'用户旅程', icon:'👤'},
                {id:'sensitivity', label:'灵敏度', icon:'📈'},
                {id:'recommend', label:'目标反推', icon:'🎯'},
                {id:'operations', label:'运维闭环', icon:'🔧'},
                {id:'history', label:'模拟历史', icon:'📋'}
              ]" :key="tab.id">
                <button
                  @click="simulation_sub_tab = tab.id"
                  :class="simulation_sub_tab === tab.id ? 'bg-white shadow text-emerald-600 font-medium' : 'text-gray-500 hover:text-gray-700'"
                  class="px-4 py-2 rounded-md text-sm transition-all"
                  x-text="tab.icon + ' ' + tab.label"
                ></button>
              </template>
            </div>

            <!-- ========== 参数沙盒 Sub-Tab ========== -->
            <div x-show="simulation_sub_tab === 'sandbox'">
              <!-- 活动信息条 -->
              <div class="flex items-center justify-between bg-gray-50 rounded-lg p-3 mb-4">
                <div class="text-sm text-gray-600">
                  <span class="font-medium" x-text="simulation_baseline.campaign?.campaign_name"></span>
                  <span class="text-gray-400 ml-2">|</span>
                  <span class="ml-2">累计抽奖: <span class="font-semibold" x-text="simulation_baseline.actual_distribution?.total_draws?.toLocaleString()"></span> 次</span>
                </div>
                <div class="flex gap-2">
                  <select x-model.number="simulation_count" class="text-sm border rounded px-2 py-1">
                    <option value="1000">快速(1K次)</option>
                    <option value="5000">标准(5K次)</option>
                    <option value="10000" selected>精确(10K次)</option>
                    <option value="50000">高精度(50K次)</option>
                  </select>
                  <button
                    @click="runMonteCarlo()"
                    :disabled="running_simulation"
                    class="px-4 py-1.5 bg-emerald-600 text-white text-sm rounded hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-wait"
                  >
                    <span x-show="!running_simulation">🚀 运行模拟</span>
                    <span x-show="running_simulation" class="flex items-center gap-1">
                      <span class="animate-spin">⏳</span> 模拟中...
                    </span>
                  </button>
                </div>
              </div>

              <!-- 场景预设选择 -->
              <div class="mb-4">
                <h6 class="text-sm font-medium text-gray-700 mb-2">场景预设</h6>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                  <template x-for="(preset, key) in preset_scenarios" :key="key">
                    <button
                      @click="applyPresetScenario(key)"
                      :class="selected_preset === key ? 'border-emerald-500 bg-emerald-50' : 'border-gray-200 hover:border-gray-300'"
                      class="border rounded-lg p-3 text-left text-sm transition-all"
                    >
                      <div class="font-medium" x-text="preset.name"></div>
                      <div class="text-xs text-gray-400 mt-1" x-text="preset.description"></div>
                    </button>
                  </template>
                </div>
              </div>

              <!-- BxPx 矩阵编辑（表格模式） -->
              <div class="mb-4">
                <h6 class="text-sm font-medium text-gray-700 mb-2">BxPx 矩阵配置 <span class="text-gray-400 text-xs">（修改的值高亮黄色）</span></h6>
                <div class="overflow-x-auto">
                  <table class="w-full text-xs border-collapse">
                    <thead>
                      <tr class="bg-gray-50">
                        <th class="border p-1.5">格子</th>
                        <th class="border p-1.5">high 乘数</th>
                        <th class="border p-1.5">mid 乘数</th>
                        <th class="border p-1.5">low 乘数</th>
                        <th class="border p-1.5">fallback 乘数</th>
                        <th class="border p-1.5">空奖权重</th>
                        <th class="border p-1.5">预算上限</th>
                      </tr>
                    </thead>
                    <tbody>
                      <template x-for="mc in proposed_config.matrix_config" :key="mc.budget_tier+'_'+mc.pressure_tier">
                        <tr>
                          <td class="border p-1.5 font-medium bg-gray-50" x-text="mc.budget_tier + '×' + mc.pressure_tier"></td>
                          <template x-for="field in ['high_multiplier','mid_multiplier','low_multiplier','fallback_multiplier','empty_weight_multiplier','cap_multiplier']" :key="field">
                            <td class="border p-0.5"
                                :class="isMatrixValueChanged(mc.budget_tier, mc.pressure_tier, field) ? 'bg-yellow-50' : ''">
                              <input type="number" step="0.1" min="0" max="10"
                                     :value="mc[field]"
                                     @change="updateProposedMatrixValue(mc.budget_tier, mc.pressure_tier, field, $event.target.value)"
                                     class="w-full text-center text-xs border-0 p-1 bg-transparent focus:ring-1 focus:ring-emerald-300 rounded">
                            </td>
                          </template>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- 策略参数编辑 -->
              <div class="mb-4">
                <h6 class="text-sm font-medium text-gray-700 mb-2">策略参数</h6>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                  <template x-for="(values, group) in proposed_config.strategy_config" :key="group">
                    <div class="border rounded-lg p-3">
                      <div class="font-medium text-sm mb-2 capitalize" x-text="group.replace(/_/g, ' ')"></div>
                      <template x-for="(val, key) in values" :key="key">
                        <div class="flex items-center justify-between text-xs mb-1">
                          <span class="text-gray-500" x-text="key"></span>
                          <template x-if="typeof val === 'boolean'">
                            <input type="checkbox" :checked="val" @change="proposed_config.strategy_config[group][key] = $event.target.checked">
                          </template>
                          <template x-if="typeof val === 'number'">
                            <input type="number" step="0.1" :value="val"
                                   @change="proposed_config.strategy_config[group][key] = parseFloat($event.target.value)"
                                   class="w-20 text-center text-xs border rounded p-0.5">
                          </template>
                          <template x-if="typeof val === 'object'">
                            <span class="text-gray-400">JSON</span>
                          </template>
                          <template x-if="typeof val === 'string'">
                            <span class="text-gray-600" x-text="val"></span>
                          </template>
                        </div>
                      </template>
                    </div>
                  </template>
                </div>
              </div>
            </div>

            <!-- ========== 对比分析 Sub-Tab ========== -->
            <div x-show="simulation_sub_tab === 'comparison'">
              <template x-if="!simulation_result">
                <div class="text-center py-16 text-gray-400">
                  <span class="text-4xl mb-3 block">📊</span>
                  <p>请先在「参数沙盒」中运行模拟</p>
                </div>
              </template>
              <template x-if="simulation_result">
                <div>
                  <!-- 风险评估红绿灯 -->
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    <template x-for="(risk, key) in simulation_result.risk_assessment" :key="key">
                      <div class="rounded-lg p-3 text-center" :class="getRiskClass(risk)">
                        <div class="text-xs opacity-70" x-text="key.replace(/_/g, ' ')"></div>
                        <div class="font-bold text-lg mt-1" x-text="getRiskLabel(risk)"></div>
                      </div>
                    </template>
                  </div>

                  <!-- 档位分布对比图表 -->
                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                    <div class="border rounded-lg p-4">
                      <div id="simulation-tier-chart" style="height: 300px;"></div>
                    </div>
                    <div class="border rounded-lg p-4">
                      <h6 class="font-medium text-sm mb-3">档位分布数值对比</h6>
                      <table class="w-full text-sm">
                        <thead><tr class="bg-gray-50"><th class="p-2">档位</th><th class="p-2">当前实际</th><th class="p-2">模拟预测</th><th class="p-2">变化</th></tr></thead>
                        <tbody>
                          <template x-for="tier in ['high','mid','low','fallback']" :key="tier">
                            <tr class="border-t">
                              <td class="p-2 font-medium" x-text="tier"></td>
                              <td class="p-2" x-text="(simulation_baseline?.actual_distribution?.tier_distribution?.[tier] || 0).toFixed(2) + '%'"></td>
                              <td class="p-2" x-text="(simulation_result?.simulation_result?.tier_distribution?.[tier] || 0).toFixed(2) + '%'"></td>
                              <td class="p-2"
                                  :class="(simulation_result?.comparison?.tier_delta?.[tier] || 0) > 0 ? 'text-red-600' : 'text-green-600'"
                                  x-text="((simulation_result?.comparison?.tier_delta?.[tier] || 0) > 0 ? '+' : '') + (simulation_result?.comparison?.tier_delta?.[tier] || 0).toFixed(2) + '%'">
                              </td>
                            </tr>
                          </template>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <!-- 体验机制指标卡片 -->
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    <div class="border rounded-lg p-3 text-center">
                      <div class="text-xs text-gray-500">Pity 触发率</div>
                      <div class="text-xl font-bold mt-1" x-text="(simulation_result?.simulation_result?.experience_metrics?.pity_trigger_rate || 0).toFixed(2) + '%'"></div>
                    </div>
                    <div class="border rounded-lg p-3 text-center">
                      <div class="text-xs text-gray-500">AntiEmpty 触发</div>
                      <div class="text-xl font-bold mt-1" x-text="simulation_result?.simulation_result?.experience_metrics?.anti_empty_trigger_count || 0"></div>
                    </div>
                    <div class="border rounded-lg p-3 text-center">
                      <div class="text-xs text-gray-500">AntiHigh 触发</div>
                      <div class="text-xl font-bold mt-1" x-text="simulation_result?.simulation_result?.experience_metrics?.anti_high_trigger_count || 0"></div>
                    </div>
                    <div class="border rounded-lg p-3 text-center">
                      <div class="text-xs text-gray-500">平均首次非空抽数</div>
                      <div class="text-xl font-bold mt-1" x-text="(simulation_result?.simulation_result?.experience_metrics?.avg_draws_to_first_non_empty || 0).toFixed(1)"></div>
                    </div>
                  </div>

                  <!-- 操作按钮组（保存方案 + 应用到线上） -->
                  <div class="flex gap-3 mt-4 pt-4 border-t">
                    <button @click="saveCurrentAsScenario()"
                            class="px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                      💾 保存为方案 (<span x-text="saved_scenarios.length"></span>/5)
                    </button>
                    <button @click="openApplyConfirm()"
                            class="px-4 py-2 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                      🚀 应用此配置到线上
                    </button>
                  </div>

                  <!-- 多方案并排对比区（Phase 6） -->
                  <template x-if="saved_scenarios.length > 0">
                    <div class="mt-6 border-t pt-4">
                      <h6 class="font-medium text-sm mb-3">📊 多方案并排对比</h6>
                      <div class="overflow-x-auto">
                        <table class="w-full text-sm border-collapse">
                          <thead>
                            <tr class="bg-gray-50">
                              <th class="border p-2 text-left">指标</th>
                              <th class="border p-2">当前实际</th>
                              <template x-for="(scenario, idx) in saved_scenarios" :key="idx">
                                <th class="border p-2">
                                  <div class="flex items-center justify-between">
                                    <span x-text="scenario.name"></span>
                                    <button @click="removeScenario(idx)" class="text-red-400 hover:text-red-600 ml-1 text-xs">✕</button>
                                  </div>
                                </th>
                              </template>
                            </tr>
                          </thead>
                          <tbody>
                            <template x-for="tier in ['high', 'mid', 'low', 'fallback']" :key="tier">
                              <tr class="border-t">
                                <td class="border p-2 font-medium" x-text="tier + ' 比例'"></td>
                                <td class="border p-2 text-center" x-text="(simulation_baseline?.actual_distribution?.tier_distribution?.[tier] || 0).toFixed(2) + '%'"></td>
                                <template x-for="(scenario, idx) in saved_scenarios" :key="idx">
                                  <td class="border p-2 text-center" x-text="(scenario.simulation_result?.simulation_result?.tier_distribution?.[tier] || 0).toFixed(2) + '%'"></td>
                                </template>
                              </tr>
                            </template>
                            <tr class="border-t bg-gray-50">
                              <td class="border p-2 font-medium">空奖率</td>
                              <td class="border p-2 text-center" x-text="(simulation_baseline?.actual_distribution?.tier_distribution?.fallback || 0).toFixed(2) + '%'"></td>
                              <template x-for="(scenario, idx) in saved_scenarios" :key="idx">
                                <td class="border p-2 text-center" x-text="(scenario.simulation_result?.simulation_result?.empty_rate || 0).toFixed(2) + '%'"></td>
                              </template>
                            </tr>
                            <tr class="border-t">
                              <td class="border p-2 font-medium">操作</td>
                              <td class="border p-2 text-center text-gray-400">—</td>
                              <template x-for="(scenario, idx) in saved_scenarios" :key="idx">
                                <td class="border p-2 text-center">
                                  <button @click="loadScenarioToSandbox(idx)" class="text-xs text-blue-600 hover:underline">加载到沙盒</button>
                                </td>
                              </template>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </template>
                </div>
              </template>
            </div>

            <!-- ========== 用户旅程 Sub-Tab ========== -->
            <div x-show="simulation_sub_tab === 'journey'">
              <div class="flex items-end gap-4 mb-4">
                <div>
                  <label class="block text-xs text-gray-500 mb-1">用户预算</label>
                  <input type="number" x-model.number="journey_profile.budget" class="border rounded px-3 py-1.5 text-sm w-24">
                </div>
                <div>
                  <label class="block text-xs text-gray-500 mb-1">用户分群</label>
                  <select x-model="journey_profile.segment_key" class="border rounded px-3 py-1.5 text-sm">
                    <option value="default">default</option>
                    <option value="new_user">new_user</option>
                    <option value="vip_user">vip_user</option>
                  </select>
                </div>
                <div>
                  <label class="block text-xs text-gray-500 mb-1">起始连空</label>
                  <input type="number" x-model.number="journey_profile.initial_empty_streak" min="0" max="20" class="border rounded px-3 py-1.5 text-sm w-16">
                </div>
                <div>
                  <label class="block text-xs text-gray-500 mb-1">模拟次数</label>
                  <input type="number" x-model.number="journey_draw_count" min="5" max="100" class="border rounded px-3 py-1.5 text-sm w-16">
                </div>
                <button @click="runUserJourney()" :disabled="running_journey"
                        class="px-4 py-1.5 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700 disabled:opacity-50">
                  <span x-show="!running_journey">▶ 模拟旅程</span>
                  <span x-show="running_journey">⏳ 运行中...</span>
                </button>
              </div>

              <template x-if="journey_result?.draws?.length > 0">
                <div class="space-y-2 max-h-[600px] overflow-y-auto">
                  <template x-for="draw in journey_result.draws" :key="draw.draw_number">
                    <div class="border rounded-lg p-3 text-xs"
                         :class="draw.final_tier === 'high' ? 'border-yellow-300 bg-yellow-50' : draw.final_tier === 'fallback' ? 'border-gray-200 bg-gray-50' : 'border-blue-200'">
                      <div class="flex items-center justify-between mb-2">
                        <span class="font-bold">第 <span x-text="draw.draw_number"></span> 次</span>
                        <span class="px-2 py-0.5 rounded text-xs font-medium"
                              :class="draw.final_tier === 'high' ? 'bg-yellow-200 text-yellow-800' : draw.final_tier === 'mid' ? 'bg-blue-200 text-blue-800' : draw.final_tier === 'low' ? 'bg-gray-200 text-gray-700' : 'bg-gray-100 text-gray-500'"
                              x-text="draw.final_tier"></span>
                      </div>
                      <div class="text-gray-500">
                        <span x-text="draw.budget_tier + '/' + draw.pressure_tier"></span>
                        <template x-if="draw.triggers?.length > 0">
                          <span class="ml-2 text-orange-600 font-medium">⚡ <span x-text="draw.triggers.join(', ')"></span></span>
                        </template>
                      </div>
                      <div class="mt-1 text-gray-400">
                        连空: <span x-text="draw.user_state_after?.empty_streak"></span>
                        | 近期high: <span x-text="draw.user_state_after?.recent_high_count"></span>
                      </div>
                    </div>
                  </template>
                </div>
              </template>

              <template x-if="!journey_result">
                <div class="text-center py-12 text-gray-400">
                  <span class="text-3xl mb-2 block">👤</span>
                  <p>配置用户画像后点击「模拟旅程」</p>
                </div>
              </template>
            </div>

            <!-- ========== 灵敏度分析 Sub-Tab ========== -->
            <div x-show="simulation_sub_tab === 'sensitivity'">
              <div class="flex items-end gap-3 mb-4">
                <div>
                  <label class="block text-xs text-gray-500 mb-1">目标参数</label>
                  <select x-model.number="sensitivity_config.selected_index" class="border rounded px-3 py-1.5 text-sm">
                    <template x-for="(param, idx) in sensitivity_params" :key="param.key">
                      <option :value="idx" x-text="param.label"></option>
                    </template>
                  </select>
                </div>
                <div>
                  <label class="block text-xs text-gray-500 mb-1">范围</label>
                  <div class="flex gap-1">
                    <input type="number" x-model.number="sensitivity_config.range_min" step="0.1" class="border rounded px-2 py-1.5 text-sm w-16">
                    <span class="py-1.5">~</span>
                    <input type="number" x-model.number="sensitivity_config.range_max" step="0.1" class="border rounded px-2 py-1.5 text-sm w-16">
                  </div>
                </div>
                <div>
                  <label class="block text-xs text-gray-500 mb-1">步数</label>
                  <input type="number" x-model.number="sensitivity_config.steps" min="5" max="20" class="border rounded px-2 py-1.5 text-sm w-16">
                </div>
                <button @click="runSensitivityFromPanel()" :disabled="running_sensitivity"
                        class="px-4 py-1.5 bg-purple-600 text-white text-sm rounded hover:bg-purple-700 disabled:opacity-50">
                  <span x-show="!running_sensitivity">📈 运行分析</span>
                  <span x-show="running_sensitivity">⏳ 分析中...</span>
                </button>
              </div>
              <div id="sensitivity-chart" style="height: 350px;" class="border rounded-lg"></div>
              <template x-if="!sensitivity_result">
                <div class="text-center py-12 text-gray-400">
                  <span class="text-3xl mb-2 block">📈</span>
                  <p>选择参数和范围后点击「运行分析」</p>
                </div>
              </template>
            </div>

            <!-- ========== 目标反推 Sub-Tab (Phase 5) ========== -->
            <div x-show="simulation_sub_tab === 'recommend'">
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-4">
                <!-- 约束条件面板 -->
                <div class="border rounded-lg p-4">
                  <h6 class="font-medium text-sm mb-3">🎯 约束条件</h6>
                  <div class="space-y-3">
                    <div>
                      <label class="block text-xs text-gray-500 mb-1">high 档位比例范围</label>
                      <div class="flex gap-2 items-center">
                        <input type="number" step="0.01" min="0" max="1" x-model.number="recommend_constraints.high_rate_min"
                               class="border rounded px-2 py-1 text-sm w-20">
                        <span class="text-gray-400">~</span>
                        <input type="number" step="0.01" min="0" max="1" x-model.number="recommend_constraints.high_rate_max"
                               class="border rounded px-2 py-1 text-sm w-20">
                      </div>
                    </div>
                    <div>
                      <label class="block text-xs text-gray-500 mb-1">空奖率上限</label>
                      <input type="number" step="0.01" min="0" max="1" x-model.number="recommend_constraints.empty_rate_max"
                             class="border rounded px-2 py-1 text-sm w-20">
                    </div>
                    <div>
                      <label class="block text-xs text-gray-500 mb-1">奖品成本率上限</label>
                      <input type="number" step="0.01" min="0" max="2" x-model.number="recommend_constraints.prize_cost_rate_max"
                             class="border rounded px-2 py-1 text-sm w-20">
                    </div>
                  </div>
                  <button @click="runRecommendFromPanel()" :disabled="running_recommend"
                          class="mt-4 px-4 py-2 bg-teal-600 text-white text-sm rounded hover:bg-teal-700 disabled:opacity-50 w-full">
                    <span x-show="!running_recommend">🔍 搜索推荐方案</span>
                    <span x-show="running_recommend">⏳ 搜索中（可能需要30秒）...</span>
                  </button>
                </div>

                <!-- 推荐结果 -->
                <div class="border rounded-lg p-4">
                  <h6 class="font-medium text-sm mb-3">📋 推荐方案</h6>
                  <template x-if="!recommend_result">
                    <div class="text-center py-8 text-gray-400 text-sm">设置约束后点击搜索</div>
                  </template>
                  <template x-if="recommend_result">
                    <div>
                      <div class="text-xs text-gray-400 mb-3">
                        测试 <span x-text="recommend_result.search_stats?.combinations_tested"></span> 个组合,
                        找到 <span x-text="recommend_result.search_stats?.solutions_found"></span> 个方案,
                        耗时 <span x-text="(recommend_result.search_stats?.elapsed_ms / 1000).toFixed(1)"></span>s
                      </div>
                      <template x-if="recommend_result.recommendations?.length === 0">
                        <div class="text-center py-4 text-yellow-600 text-sm">未找到满足约束的方案，请放宽条件</div>
                      </template>
                      <div class="space-y-3">
                        <template x-for="rec in recommend_result.recommendations" :key="rec.rank">
                          <div class="border rounded-lg p-3 hover:bg-gray-50">
                            <div class="flex items-center justify-between mb-2">
                              <span class="font-medium text-sm">方案 #<span x-text="rec.rank"></span></span>
                              <button @click="applyRecommendation(rec)" class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                加载到沙盒
                              </button>
                            </div>
                            <div class="text-xs text-gray-500 space-y-1">
                              <template x-for="(val, param) in rec.proposed_changes" :key="param">
                                <div>
                                  <span class="text-gray-400" x-text="param"></span>:
                                  <span class="font-medium" x-text="val"></span>
                                </div>
                              </template>
                            </div>
                            <div class="mt-2 text-xs">
                              <span>high: <span x-text="(rec.simulation_result?.tier_distribution?.high || 0).toFixed(1)"></span>%</span>
                              <span class="ml-2">空奖: <span x-text="(rec.simulation_result?.empty_rate || 0).toFixed(1)"></span>%</span>
                            </div>
                          </div>
                        </template>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </div>

            <!-- ========== 运维闭环 Sub-Tab (Phase 7-8) ========== -->
            <div x-show="simulation_sub_tab === 'operations'">
              <!-- 运维子导航 -->
              <div class="flex gap-2 mb-4" x-data="{ ops_tab: 'version_history' }">
                <template x-for="t in [{id:'version_history',label:'版本历史'},{id:'budget_pacing',label:'预算节奏'},{id:'circuit_breaker',label:'熔断监控'}]" :key="t.id">
                  <button @click="ops_tab = t.id; if(t.id === 'version_history') loadVersionHistory(); if(t.id === 'budget_pacing') loadBudgetPacing(); if(t.id === 'circuit_breaker') loadCircuitBreakerStatus();"
                          :class="ops_tab === t.id ? 'bg-emerald-600 text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'"
                          class="px-3 py-1.5 rounded text-sm" x-text="t.label"></button>
                </template>

                <!-- 版本历史面板 -->
                <div x-show="ops_tab === 'version_history'" class="w-full mt-3">
                  <template x-if="loading_version_history">
                    <div class="text-center py-8"><span class="animate-spin inline-block">⏳</span> 加载中...</div>
                  </template>
                  <template x-if="!loading_version_history && version_history.length === 0">
                    <div class="text-center py-8 text-gray-400 text-sm">暂无配置变更记录</div>
                  </template>
                  <template x-if="!loading_version_history && version_history.length > 0">
                    <div class="space-y-2">
                      <template x-for="log in version_history" :key="log.log_id">
                        <div class="border rounded-lg p-3 hover:bg-gray-50">
                          <div class="flex items-center justify-between">
                            <div>
                              <span class="text-sm font-medium" x-text="getOperationTypeLabel(log.operation_type)"></span>
                              <span class="text-xs text-gray-400 ml-2" x-text="formatDate(log.created_at)"></span>
                            </div>
                            <div class="flex gap-2">
                              <template x-if="log.is_reversible && log.before_data">
                                <button @click="rollbackToVersion(log.log_id)" :disabled="rolling_back"
                                        class="text-xs px-2 py-1 bg-orange-100 text-orange-700 rounded hover:bg-orange-200 disabled:opacity-50">
                                  ↩ 回滚到此版本
                                </button>
                              </template>
                            </div>
                          </div>
                          <div class="text-xs text-gray-500 mt-1" x-text="log.reason"></div>
                        </div>
                      </template>
                    </div>
                  </template>
                </div>

                <!-- 预算节奏面板 -->
                <div x-show="ops_tab === 'budget_pacing'" class="w-full mt-3">
                  <template x-if="loading_budget_pacing">
                    <div class="text-center py-8"><span class="animate-spin inline-block">⏳</span> 加载中...</div>
                  </template>
                  <template x-if="!loading_budget_pacing && budget_pacing">
                    <div>
                      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="border rounded-lg p-3 text-center">
                          <div class="text-xs text-gray-500">剩余预算</div>
                          <div class="text-xl font-bold mt-1" x-text="budget_pacing.remaining_budget?.toLocaleString()"></div>
                        </div>
                        <div class="border rounded-lg p-3 text-center">
                          <div class="text-xs text-gray-500">日均消耗</div>
                          <div class="text-xl font-bold mt-1" x-text="budget_pacing.avg_daily_consumption?.toLocaleString()"></div>
                        </div>
                        <div class="border rounded-lg p-3 text-center">
                          <div class="text-xs text-gray-500">日均抽奖</div>
                          <div class="text-xl font-bold mt-1" x-text="budget_pacing.avg_daily_draws?.toLocaleString() + ' 次'"></div>
                        </div>
                        <div class="border rounded-lg p-3 text-center" :class="budget_pacing.estimated_depletion_days <= 7 ? 'bg-red-50 border-red-200' : budget_pacing.estimated_depletion_days <= 30 ? 'bg-yellow-50 border-yellow-200' : ''">
                          <div class="text-xs text-gray-500">预计耗尽</div>
                          <div class="text-xl font-bold mt-1" x-text="budget_pacing.estimated_depletion_days ? budget_pacing.estimated_depletion_days + ' 天' : '—'"></div>
                        </div>
                      </div>
                      <div id="budget-pacing-chart" style="height: 300px;" class="border rounded-lg"></div>
                    </div>
                  </template>
                  <template x-if="!loading_budget_pacing && !budget_pacing">
                    <div class="text-center py-8 text-gray-400 text-sm">点击「预算节奏」按钮加载数据</div>
                  </template>
                </div>

                <!-- 熔断监控面板 -->
                <div x-show="ops_tab === 'circuit_breaker'" class="w-full mt-3">
                  <template x-if="loading_circuit_breaker">
                    <div class="text-center py-8"><span class="animate-spin inline-block">⏳</span> 加载中...</div>
                  </template>
                  <template x-if="!loading_circuit_breaker && circuit_breaker_status">
                    <div>
                      <div class="mb-4 flex items-center gap-3">
                        <span class="text-sm font-medium">监控状态:</span>
                        <span class="px-3 py-1 rounded-full text-sm" :class="getCircuitBreakerBadge().class"
                              x-text="getCircuitBreakerBadge().text"></span>
                        <template x-if="circuit_breaker_status.recent_draws">
                          <span class="text-xs text-gray-400">（近1小时 <span x-text="circuit_breaker_status.recent_draws"></span> 次抽奖）</span>
                        </template>
                      </div>
                      <template x-if="circuit_breaker_status.breaches?.length > 0">
                        <div class="space-y-2">
                          <h6 class="text-sm font-medium text-red-600">⚠ 指标偏离报告</h6>
                          <template x-for="breach in circuit_breaker_status.breaches" :key="breach.metric">
                            <div class="border border-red-200 rounded-lg p-3 bg-red-50">
                              <div class="flex justify-between">
                                <span class="font-medium text-sm" x-text="breach.metric"></span>
                                <span class="text-xs" :class="breach.breach_type === 'above' ? 'text-red-600' : 'text-blue-600'"
                                      x-text="breach.breach_type === 'above' ? '超出上限' : '低于下限'"></span>
                              </div>
                              <div class="text-xs text-gray-600 mt-1">
                                预期: <span x-text="(breach.expected * 100).toFixed(1)"></span>%
                                | 实际: <span class="font-bold" x-text="(breach.actual * 100).toFixed(1)"></span>%
                                | 范围: <span x-text="(breach.lower_bound * 100).toFixed(1)"></span>% ~ <span x-text="(breach.upper_bound * 100).toFixed(1)"></span>%
                              </div>
                            </div>
                          </template>
                        </div>
                      </template>
                      <template x-if="circuit_breaker_status.status === 'no_rules'">
                        <div class="text-center py-4 text-gray-400 text-sm">
                          暂无熔断监控规则。应用模拟配置后可创建监控规则。
                        </div>
                      </template>
                    </div>
                  </template>
                </div>
              </div>
            </div>

            <!-- ========== 模拟历史 Sub-Tab ========== -->
            <div x-show="simulation_sub_tab === 'history'">
              <template x-if="simulation_history.length === 0">
                <div class="text-center py-12 text-gray-400">
                  <span class="text-3xl mb-2 block">📋</span>
                  <p>暂无模拟记录</p>
                </div>
              </template>
              <template x-if="simulation_history.length > 0">
                <div class="space-y-2">
                  <template x-for="record in simulation_history" :key="record.lottery_simulation_record_id">
                    <div class="border rounded-lg p-3 hover:bg-gray-50">
                      <div class="flex items-center justify-between mb-2">
                        <div>
                          <div class="font-medium text-sm" x-text="record.simulation_name || '未命名模拟 #' + record.lottery_simulation_record_id"></div>
                          <div class="text-xs text-gray-400 mt-1">
                            <span x-text="record.simulation_count?.toLocaleString() + ' 次迭代'"></span>
                            <span class="mx-1">|</span>
                            <span x-text="formatDate(record.created_at)"></span>
                          </div>
                        </div>
                        <div class="flex items-center gap-2">
                          <span class="text-xs px-2 py-0.5 rounded"
                                :class="record.status === 'applied' ? 'bg-green-100 text-green-700' : record.status === 'scheduled' ? 'bg-yellow-100 text-yellow-700' : record.status === 'archived' ? 'bg-gray-100 text-gray-500' : 'bg-blue-100 text-blue-700'"
                                x-text="record.status === 'applied' ? '已应用' : record.status === 'scheduled' ? '待生效' : record.status === 'archived' ? '已归档' : '草稿'"></span>
                          <button @click="calculateDrift(record.lottery_simulation_record_id)"
                                  class="text-xs px-2 py-1 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200">
                            📏 偏差追踪
                          </button>
                        </div>
                      </div>
                      <!-- 偏差结果展示 -->
                      <template x-if="record.drift_result">
                        <div class="mt-2 p-2 bg-gray-50 rounded text-xs">
                          <div class="font-medium mb-1">偏差追踪结果 (基于 <span x-text="record.drift_result.actual_draws_count"></span> 次实际抽奖)</div>
                          <div class="grid grid-cols-4 gap-2">
                            <template x-for="tier in ['high', 'mid', 'low', 'fallback']" :key="tier">
                              <div>
                                <span class="text-gray-500" x-text="tier + ':'"></span>
                                <span :class="getDriftColor(record.drift_result.drift_percentage?.[tier])"
                                      x-text="record.drift_result.drift_percentage?.[tier] != null ? record.drift_result.drift_percentage[tier].toFixed(1) + '%' : '—'">
                                </span>
                              </div>
                            </template>
                          </div>
                          <template x-if="record.drift_result.actual_draws_count === 0">
                            <div class="text-gray-400 mt-1">模拟后暂无新的实际抽奖数据</div>
                          </template>
                        </div>
                      </template>
                    </div>
                  </template>
                </div>
              </template>
            </div>
          </div>
        </template>

        <!-- 一键应用确认弹窗（Phase 6） -->
        <div x-show="show_apply_confirm" x-cloak
             class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
             @click.self="closeApplyConfirm()">
          <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 p-6" @click.stop>
            <h5 class="font-bold text-lg mb-4">🚀 应用配置到线上</h5>
            <div class="text-sm text-gray-600 mb-4">
              <p class="mb-2">即将修改以下线上配置，此操作会直接影响正在运行的抽奖系统：</p>
              <div class="bg-gray-50 rounded p-3 text-xs max-h-40 overflow-y-auto">
                <template x-if="proposed_config.matrix_config?.length > 0">
                  <div class="mb-1">
                    <span class="font-medium">矩阵配置:</span>
                    <span x-text="proposed_config.matrix_config.length + ' 个格子'"></span>
                  </div>
                </template>
                <template x-if="Object.keys(proposed_config.strategy_config || {}).length > 0">
                  <div class="mb-1">
                    <span class="font-medium">策略参数:</span>
                    <span x-text="Object.keys(proposed_config.strategy_config).join(', ')"></span>
                  </div>
                </template>
              </div>
            </div>

            <!-- 应用模式选择 -->
            <div class="mb-4">
              <label class="flex items-center gap-2 mb-2 cursor-pointer">
                <input type="radio" value="immediate" x-model="apply_mode">
                <span class="text-sm">立即生效</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" value="scheduled" x-model="apply_mode">
                <span class="text-sm">定时生效</span>
              </label>
              <template x-if="apply_mode === 'scheduled'">
                <div class="mt-2 ml-6">
                  <input type="datetime-local" x-model="schedule_datetime"
                         class="border rounded px-3 py-1.5 text-sm">
                </div>
              </template>
            </div>

            <!-- 熔断监控选项 -->
            <label class="flex items-center gap-2 text-sm text-gray-600 mb-4">
              <input type="checkbox" checked id="create-circuit-breaker">
              同时创建异常熔断监控规则
            </label>

            <div class="flex gap-3 justify-end">
              <button @click="closeApplyConfirm()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300">取消</button>
              <button @click="executeApply().then(() => { if(document.getElementById('create-circuit-breaker')?.checked) createCircuitBreakerAfterApply() })"
                      :disabled="applying_config || (apply_mode === 'scheduled' && !schedule_datetime)"
                      class="px-4 py-2 bg-red-600 text-white rounded text-sm hover:bg-red-700 disabled:opacity-50">
                <span x-show="!applying_config" x-text="apply_mode === 'scheduled' ? '设置定时生效' : '确认应用'"></span>
                <span x-show="applying_config">⏳ 处理中...</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== 批量操作工具页面 (P3) ==================== -->
      <div x-show="current_page === 'batch-operations'" x-cloak>
        
        <!-- 页面标题 -->
        <div class="themed-card rounded-lg shadow p-6 mb-6">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <h5 class="font-semibold themed-text-primary flex items-center gap-2">
              ⚡ 批量操作工具
              <span class="text-sm themed-text-muted font-normal">配额赠送 / 状态切换 / 预算调整</span>
            </h5>
          </div>
        </div>

        <!-- 操作类型选择卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <!-- 批量赠送每日配额 -->
          <div class="themed-card rounded-lg shadow p-6 cursor-pointer hover:shadow-lg transition-shadow"
               @click="openBatchOperationsPanel('quota-grant')">
            <div class="text-center">
              <div class="text-4xl mb-3">🎁</div>
              <h6 class="font-semibold mb-2">批量赠送每日配额</h6>
              <p class="text-sm themed-text-muted">为多个用户批量赠送指定活动的每日抽奖额外配额（bonus_draw_count）</p>
            </div>
          </div>

          <!-- 批量状态切换 -->
          <div class="themed-card rounded-lg shadow p-6 cursor-pointer hover:shadow-lg transition-shadow"
               @click="openBatchOperationsPanel('campaign-status')">
            <div class="text-center">
              <div class="text-4xl mb-3">🔄</div>
              <h6 class="font-semibold mb-2">批量状态切换</h6>
              <p class="text-sm themed-text-muted">批量启动、暂停或结束多个活动</p>
            </div>
          </div>

          <!-- 批量预算调整 -->
          <div class="themed-card rounded-lg shadow p-6 cursor-pointer hover:shadow-lg transition-shadow"
               @click="openBatchOperationsPanel('budget-adjust')">
            <div class="text-center">
              <div class="text-4xl mb-3">💰</div>
              <h6 class="font-semibold mb-2">批量预算调整</h6>
              <p class="text-sm themed-text-muted">批量增加或设置多个活动的预算额度</p>
            </div>
          </div>
        </div>

        <!-- 最近批量操作记录 -->
        <div class="themed-card rounded-lg shadow">
          <div class="p-4 border-b flex justify-between items-center">
            <h6 class="font-semibold flex items-center gap-2">
              📋 最近批量操作记录
            </h6>
            <button @click="loadBatchOperationLogs()" 
                    class="themed-btn-secondary px-3 py-1 rounded text-sm"
                    :disabled="loadingBatchLogs">
              <span x-show="!loadingBatchLogs">刷新</span>
              <span x-show="loadingBatchLogs">加载中...</span>
            </button>
          </div>
          <div class="p-4">
            <div x-show="loadingBatchLogs" class="text-center py-8">
              <div class="animate-spin inline-block w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full"></div>
            </div>
            <div x-show="!loadingBatchLogs && batchOperationLogs.length === 0" class="text-center py-8 themed-text-muted">
              暂无批量操作记录
            </div>
            <template x-if="!loadingBatchLogs && batchOperationLogs.length > 0">
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="p-3 text-left">操作类型</th>
                      <th class="p-3 text-left">操作时间</th>
                      <th class="p-3 text-right">总数</th>
                      <th class="p-3 text-right">成功</th>
                      <th class="p-3 text-right">失败</th>
                      <th class="p-3 text-left">操作人</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="(log, index) in batchOperationLogs" :key="index">
                      <tr class="border-b hover:bg-gray-50">
                        <td class="p-3">
                          <span class="px-2 py-1 rounded text-xs bg-blue-100 text-blue-700" 
                                x-text="getBatchOperationTypeDisplay(log.operation_type)"></span>
                        </td>
                        <td class="p-3 themed-text-muted" x-text="formatBatchOperationTime(log.created_at)"></td>
                        <td class="p-3 text-right font-mono" x-text="log.total_count || 0"></td>
                        <td class="p-3 text-right font-mono text-green-600" x-text="log.success_count || 0"></td>
                        <td class="p-3 text-right font-mono text-red-600" x-text="log.fail_count || 0"></td>
                        <td class="p-3 themed-text-muted" x-text="log.operator_name || log.operator_id"></td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- 批量操作面板弹窗 -->
      <div x-show="showBatchOperationsPanel" 
           class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
           x-cloak
           @click.self="closeBatchOperationsPanel()">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] overflow-auto">
          <div class="p-4 border-b flex justify-between items-center themed-bg-primary text-white rounded-t-lg">
            <h5 class="font-semibold" x-text="currentBatchOperation === 'quota-grant' ? '批量赠送每日配额' : currentBatchOperation === 'campaign-status' ? '批量活动状态切换' : currentBatchOperation === 'budget-adjust' ? '批量预算调整' : currentBatchOperation"></h5>
            <button @click="closeBatchOperationsPanel()" class="p-2 hover:bg-white/20 rounded">✕</button>
          </div>
          
          <div class="p-6">
            <!-- 批量赠送每日配额表单 -->
            <template x-if="currentBatchOperation === 'quota-grant'">
              <div class="space-y-4">
                <div class="p-3 bg-blue-50 rounded text-sm text-blue-700 mb-2">
                  💡 此功能为用户增加指定活动的每日抽奖额外配额（bonus_draw_count），不影响基础配额上限。
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">活动选择 <span class="text-red-500">*</span></label>
                  <select x-model="batchQuotaGrantForm.lottery_campaign_id" class="themed-input w-full rounded px-3 py-2">
                    <option value="">请选择活动</option>
                    <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
                      <option :value="campaign.lottery_campaign_id" x-text="campaign.campaign_name"></option>
                    </template>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">用户手机号列表 <span class="text-red-500">*</span></label>
                  <textarea x-model="batchQuotaGrantForm.mobiles" 
                            class="themed-input w-full rounded px-3 py-2 h-24"
                            placeholder="输入手机号，支持逗号、换行分隔&#10;例如：13800001111, 13800002222&#10;或每行一个手机号"></textarea>
                  <p class="text-xs themed-text-muted mt-1">单次最多支持100个用户，解析失败的手机号将被跳过</p>
                  <!-- 批量解析结果提示 -->
                  <template x-if="batchResolveResult">
                    <div class="mt-2 text-xs">
                      <span class="text-green-600" x-show="batchResolveResult.success_count > 0" x-text="'✅ 成功 ' + batchResolveResult.success_count + ' 个'"></span>
                      <span class="text-red-500 ml-2" x-show="batchResolveResult.failed_count > 0" x-text="'❌ 失败 ' + batchResolveResult.failed_count + ' 个: ' + batchResolveResult.failed_mobiles.join(', ')"></span>
                    </div>
                  </template>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">赠送配额数量（bonus_count） <span class="text-red-500">*</span></label>
                  <input type="number" x-model.number="batchQuotaGrantForm.bonus_count" 
                         class="themed-input w-full rounded px-3 py-2" min="1" max="100">
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">赠送原因 <span class="text-red-500">*</span></label>
                  <select x-model="batchQuotaGrantForm.reason" class="themed-input w-full rounded px-3 py-2">
                    <option value="">请选择赠送原因</option>
                    <option value="节日活动补偿">节日活动补偿</option>
                    <option value="客服投诉补偿">客服投诉补偿</option>
                    <option value="系统故障补偿">系统故障补偿</option>
                    <option value="VIP用户权益">VIP用户权益</option>
                    <option value="运营活动奖励">运营活动奖励</option>
                    <option value="新用户福利">新用户福利</option>
                    <option value="营销推广赠送">营销推广赠送</option>
                    <option value="__custom__">其他（自定义）</option>
                  </select>
                  <!-- 自定义原因输入框 -->
                  <template x-if="batchQuotaGrantForm.reason === '__custom__'">
                    <input type="text" x-model="batchQuotaGrantForm._custom_reason" 
                           class="themed-input w-full rounded px-3 py-2 mt-2"
                           placeholder="请输入自定义赠送原因"
                           @input="batchQuotaGrantForm.reason = '__custom__'">
                  </template>
                </div>
              </div>
            </template>

            <!-- 批量状态切换表单 -->
            <template x-if="currentBatchOperation === 'campaign-status'">
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-2">选择活动 <span class="text-red-500">*</span></label>
                  <div class="border rounded max-h-48 overflow-auto">
                    <label class="flex items-center gap-2 p-2 border-b bg-gray-50">
                      <input type="checkbox" 
                             @change="toggleAllCampaignsSelection($event.target.checked)"
                             :checked="batchCampaignStatusForm.lottery_campaign_ids.length === campaigns.length">
                      <span class="text-sm font-medium">全选</span>
                    </label>
                    <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
                      <label class="flex items-center gap-2 p-2 border-b hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" 
                               :checked="isCampaignSelected(campaign.lottery_campaign_id)"
                               @change="toggleCampaignSelection(campaign.lottery_campaign_id)">
                        <span class="text-sm" x-text="campaign.campaign_name"></span>
                        <span class="text-xs px-2 py-0.5 rounded"
                              :class="campaign.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'"
                              x-text="campaign.status_display || campaign.status"></span>
                      </label>
                    </template>
                  </div>
                  <p class="text-xs themed-text-muted mt-1">已选择 <span x-text="batchCampaignStatusForm.lottery_campaign_ids.length"></span> 个活动</p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">目标状态 <span class="text-red-500">*</span></label>
                  <select x-model="batchCampaignStatusForm.target_status" class="themed-input w-full rounded px-3 py-2">
                    <option value="active">进行中</option>
                    <option value="paused">暂停</option>
                    <option value="ended">结束</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">操作原因 <span class="text-red-500">*</span></label>
                  <input type="text" x-model="batchCampaignStatusForm.reason" 
                         class="themed-input w-full rounded px-3 py-2"
                         placeholder="例如：活动期结束">
                </div>
              </div>
            </template>

            <!-- 批量预算调整表单 -->
            <template x-if="currentBatchOperation === 'budget-adjust'">
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-2">选择活动 <span class="text-red-500">*</span></label>
                  <div class="border rounded max-h-48 overflow-auto">
                    <label class="flex items-center gap-2 p-2 border-b bg-gray-50">
                      <input type="checkbox" 
                             @change="toggleAllCampaignsSelection($event.target.checked)"
                             :checked="batchBudgetAdjustForm.lottery_campaign_ids.length === campaigns.length">
                      <span class="text-sm font-medium">全选</span>
                    </label>
                    <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
                      <label class="flex items-center gap-2 p-2 border-b hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" 
                               :checked="batchBudgetAdjustForm.lottery_campaign_ids.includes(campaign.lottery_campaign_id)"
                               @change="toggleCampaignSelection(campaign.lottery_campaign_id)">
                        <span class="text-sm" x-text="campaign.campaign_name"></span>
                      </label>
                    </template>
                  </div>
                  <p class="text-xs themed-text-muted mt-1">已选择 <span x-text="batchBudgetAdjustForm.lottery_campaign_ids.length"></span> 个活动</p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">调整类型 <span class="text-red-500">*</span></label>
                  <select x-model="batchBudgetAdjustForm.adjustment_type" class="themed-input w-full rounded px-3 py-2">
                    <option value="increase">增加预算</option>
                    <option value="decrease">减少预算</option>
                    <option value="set">设置预算</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">金额 <span class="text-red-500">*</span></label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 themed-text-muted">¥</span>
                    <input type="number" x-model.number="batchBudgetAdjustForm.amount" 
                           class="themed-input w-full rounded pl-7 pr-3 py-2" min="0" step="0.01">
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">操作原因 <span class="text-red-500">*</span></label>
                  <input type="text" x-model="batchBudgetAdjustForm.reason" 
                         class="themed-input w-full rounded px-3 py-2"
                         placeholder="例如：追加节日预算">
                </div>
              </div>
            </template>

            <!-- 操作结果 -->
            <template x-if="batchOperationResult">
              <div class="mt-6 p-4 rounded bg-gray-50">
                <h6 class="font-semibold mb-3">📊 操作结果</h6>
                <div class="grid grid-cols-3 gap-4 text-center">
                  <div>
                    <p class="text-2xl font-bold" x-text="batchOperationResult.total_count || 0"></p>
                    <p class="text-xs themed-text-muted">总数</p>
                  </div>
                  <div>
                    <p class="text-2xl font-bold text-green-600" x-text="batchOperationResult.success_count || 0"></p>
                    <p class="text-xs themed-text-muted">成功</p>
                  </div>
                  <div>
                    <p class="text-2xl font-bold text-red-600" x-text="batchOperationResult.fail_count || 0"></p>
                    <p class="text-xs themed-text-muted">失败</p>
                  </div>
                </div>
                <template x-if="batchOperationResult.result_details?.failed_items?.length > 0">
                  <div class="mt-4">
                    <p class="text-sm font-medium mb-2 text-red-600">失败详情:</p>
                    <div class="max-h-32 overflow-auto text-xs bg-red-50 p-2 rounded">
                      <template x-for="(item, idx) in batchOperationResult.result_details.failed_items" :key="idx">
                        <p class="mb-1" x-text="item.reason || item.error || JSON.stringify(item)"></p>
                      </template>
                    </div>
                  </div>
                </template>
              </div>
            </template>
          </div>

          <!-- 操作按钮 -->
          <div class="p-4 border-t flex justify-end gap-2">
            <button @click="closeBatchOperationsPanel()" class="themed-btn-secondary px-4 py-2 rounded">
              关闭
            </button>
            <button @click="currentBatchOperation === 'quota-grant' ? executeBatchQuotaGrant() : currentBatchOperation === 'campaign-status' ? executeBatchCampaignStatus() : executeBatchBudgetAdjust()"
                    class="themed-btn-primary px-4 py-2 rounded flex items-center gap-1"
                    :disabled="executingBatchOperation">
              <span x-show="!executingBatchOperation">⚡ 执行批量操作</span>
              <span x-show="executingBatchOperation">执行中...</span>
            </button>
          </div>
        </div>
      </div>

      <!-- P1-3: 预设可视化 → 已迁移到 presets.html（抽奖干预管理页面） -->

      <!-- ==================== P1-10: 系统垫付看板页面 ==================== -->
      <div x-show="current_page === 'system-advance'" x-cloak>
        <!-- 页面说明横幅 -->
        <div class="page-banner mb-6">
          <h1>💳 系统垫付看板</h1>
          <p>监控抽奖活动中的库存垫付和预算垫付情况，当奖品库存不足或预算超支时系统会自动垫付，需要运营人员定期清偿。</p>
        </div>

        <!-- 垫付汇总卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="gradient-stat-card gradient-stat-orange">
            <div class="stat-icon">📦</div>
            <div class="stat-value" x-text="advanceDashboard.total_inventory_debt || 0"></div>
            <div class="stat-label">库存垫付 (件)</div>
            <div class="stat-trend">奖品已发放但库存不足的数量</div>
          </div>
          <div class="gradient-stat-card gradient-stat-blue">
            <div class="stat-icon">💰</div>
            <div class="stat-value" x-text="formatAdvanceAmount(advanceDashboard.total_budget_debt)"></div>
            <div class="stat-label">预算垫付</div>
            <div class="stat-trend">超出预算的垫付金额</div>
          </div>
          <div class="gradient-stat-card gradient-stat-rose">
            <div class="stat-icon">⏳</div>
            <div class="stat-value" x-text="advanceDashboard.pending_count || 0"></div>
            <div class="stat-label">待处理</div>
            <div class="stat-trend">尚未清偿的垫付笔数</div>
          </div>
          <div class="gradient-stat-card gradient-stat-green">
            <div class="stat-icon">✅</div>
            <div class="stat-value" x-text="advanceDashboard.cleared_today || 0"></div>
            <div class="stat-label">今日已清偿</div>
            <div class="stat-trend">今日完成清偿的笔数</div>
          </div>
        </div>

        <!-- Tab 切换 -->
        <div class="content-section mb-6">
          <div class="px-4 pt-4">
            <div class="enhanced-tabs">
              <button @click="switchAdvanceTab('overview')"
                      :class="advanceViewTab === 'overview' ? 'active' : ''"
                      class="tab-item">
                📊 总览
              </button>
              <button @click="switchAdvanceTab('by-campaign')"
                      :class="advanceViewTab === 'by-campaign' ? 'active' : ''"
                      class="tab-item">
                🎁 按活动
              </button>
              <button @click="switchAdvanceTab('by-prize')"
                      :class="advanceViewTab === 'by-prize' ? 'active' : ''"
                      class="tab-item">
                🏆 按奖品
              </button>
              <button @click="switchAdvanceTab('by-creator')"
                      :class="advanceViewTab === 'by-creator' ? 'active' : ''"
                      class="tab-item">
                👤 按责任人
              </button>
              <button @click="switchAdvanceTab('trend')"
                      :class="advanceViewTab === 'trend' ? 'active' : ''"
                      class="tab-item">
                📈 趋势
              </button>
            </div>
          </div>

          <!-- 总览视图 -->
          <div x-show="advanceViewTab === 'overview'" class="p-6">
            <!-- 当有垫付数据时显示详情 -->
            <div x-show="advanceDashboard.total_inventory_debt > 0 || advanceDashboard.total_budget_debt > 0" class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- 库存垫付详情 -->
              <div class="stats-card stats-warning">
                <div class="stats-card-icon">📦</div>
                <h6 class="font-semibold mb-4 text-base">库存垫付详情</h6>
                <div class="space-y-3 text-sm">
                  <div class="flex justify-between items-center py-1.5 border-b border-dashed" style="border-color: var(--color-border-light, #f3f4f6);">
                    <span class="themed-text-muted">总欠账数量</span>
                    <span class="font-semibold text-lg" x-text="advanceDashboard.inventory_debt_details?.total_quantity || 0"></span>
                  </div>
                  <div class="flex justify-between items-center py-1.5 border-b border-dashed" style="border-color: var(--color-border-light, #f3f4f6);">
                    <span class="themed-text-muted">已清偿数量</span>
                    <span class="font-semibold text-lg text-green-600" x-text="advanceDashboard.inventory_debt_details?.cleared_quantity || 0"></span>
                  </div>
                  <div class="flex justify-between items-center py-1.5">
                    <span class="themed-text-muted">剩余欠账</span>
                    <span class="font-semibold text-lg text-red-600" x-text="advanceDashboard.inventory_debt_details?.remaining_quantity || advanceDashboard.total_inventory_debt || 0"></span>
                  </div>
                </div>
              </div>
              <!-- 预算垫付详情 -->
              <div class="stats-card stats-primary">
                <div class="stats-card-icon">💰</div>
                <h6 class="font-semibold mb-4 text-base">预算垫付详情</h6>
                <div class="space-y-3 text-sm">
                  <div class="flex justify-between items-center py-1.5 border-b border-dashed" style="border-color: var(--color-border-light, #f3f4f6);">
                    <span class="themed-text-muted">总欠账金额</span>
                    <span class="font-semibold text-lg" x-text="formatAdvanceAmount(advanceDashboard.budget_debt_details?.total_amount)"></span>
                  </div>
                  <div class="flex justify-between items-center py-1.5 border-b border-dashed" style="border-color: var(--color-border-light, #f3f4f6);">
                    <span class="themed-text-muted">已清偿金额</span>
                    <span class="font-semibold text-lg text-green-600" x-text="formatAdvanceAmount(advanceDashboard.budget_debt_details?.cleared_amount)"></span>
                  </div>
                  <div class="flex justify-between items-center py-1.5">
                    <span class="themed-text-muted">剩余欠账</span>
                    <span class="font-semibold text-lg text-red-600" x-text="formatAdvanceAmount(advanceDashboard.budget_debt_details?.remaining_amount || advanceDashboard.total_budget_debt)"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- 当无垫付数据时显示良好状态 -->
            <div x-show="advanceDashboard.total_inventory_debt === 0 && advanceDashboard.total_budget_debt === 0" class="empty-state empty-state-success">
              <div class="empty-state-icon-circle" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0);">
                <div class="empty-state-icon" style="font-size: 2.5rem;">🎉</div>
              </div>
              <div class="empty-state-title" style="color: #059669;">垫付账目已全部清偿</div>
              <div class="empty-state-description">当前没有未清偿的库存垫付或预算垫付记录，运营状态良好。</div>
              <div class="empty-state-tips">
                <div class="empty-state-tips-title">💡 系统垫付说明</div>
                <div>当奖品库存不足时，系统会自动垫付发放奖品，产生「库存垫付」记录</div>
                <div>当活动预算超支时，系统会自动垫付，产生「预算垫付」记录</div>
                <div>运营人员需要定期清偿垫付记录，保证账目平衡</div>
              </div>
            </div>
          </div>

          <!-- 按活动视图 -->
          <div x-show="advanceViewTab === 'by-campaign'" class="p-4">
            <template x-if="advanceByCampaign.length > 0">
              <div class="data-table-wrapper">
                <table class="table w-full">
                  <thead>
                    <tr>
                      <th>活动名称</th>
                      <th>库存欠账</th>
                      <th>预算欠账</th>
                      <th>状态</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="item in advanceByCampaign" :key="item.lottery_campaign_id">
                      <tr>
                        <td x-text="item.campaign_name || '-'"></td>
                        <td>
                          <span class="text-yellow-600 font-semibold" x-text="item.inventory_debt || 0"></span> 件
                        </td>
                        <td>
                          <span class="text-blue-600 font-semibold" x-text="formatAdvanceAmount(item.budget_debt)"></span>
                        </td>
                        <td>
                          <span class="badge"
                                :class="item.status === 'active' ? 'badge-success' : 'badge-gray'"
                                x-text="item.status === 'active' ? '进行中' : '已结束'"></span>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </template>
            <template x-if="advanceByCampaign.length === 0 && !loading">
              <div class="empty-state empty-state-compact">
                <div class="empty-state-icon">🎁</div>
                <div class="empty-state-title">暂无活动维度的垫付数据</div>
                <div class="empty-state-description">当前所有活动的库存和预算均充足，无需垫付。</div>
              </div>
            </template>
          </div>

          <!-- 按奖品视图 -->
          <div x-show="advanceViewTab === 'by-prize'" class="p-4">
            <template x-if="advanceByPrize.length > 0">
              <div class="data-table-wrapper">
                <table class="table w-full">
                  <thead>
                    <tr>
                      <th>奖品名称</th>
                      <th>所属活动</th>
                      <th>库存欠账</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="item in advanceByPrize" :key="item.lottery_prize_id">
                      <tr>
                        <td x-text="item.prize_name || '-'"></td>
                        <td class="text-sm themed-text-muted" x-text="item.campaign_name || '-'"></td>
                        <td>
                          <span class="text-yellow-600 font-semibold" x-text="item.owed_quantity || 0"></span> 件
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </template>
            <template x-if="advanceByPrize.length === 0 && !loading">
              <div class="empty-state empty-state-compact">
                <div class="empty-state-icon">🏆</div>
                <div class="empty-state-title">暂无奖品维度的垫付数据</div>
                <div class="empty-state-description">当前所有奖品库存充足，无需垫付。</div>
              </div>
            </template>
          </div>

          <!-- 按责任人视图 -->
          <div x-show="advanceViewTab === 'by-creator'" class="p-4">
            <template x-if="advanceByCreator.length > 0">
              <div class="data-table-wrapper">
                <table class="table w-full">
                  <thead>
                    <tr>
                      <th>创建人</th>
                      <th>预设数量</th>
                      <th>库存欠账</th>
                      <th>预算欠账</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="item in advanceByCreator" :key="item.creator_id">
                      <tr>
                        <td>
                          <span class="text-blue-600 font-medium" x-text="item.creator_name || '管理员#' + item.creator_id"></span>
                        </td>
                        <td x-text="item.preset_count || 0"></td>
                        <td>
                          <span class="text-yellow-600 font-semibold" x-text="item.inventory_debt || 0"></span> 件
                        </td>
                        <td>
                          <span class="text-blue-600 font-semibold" x-text="formatAdvanceAmount(item.budget_debt)"></span>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </template>
            <template x-if="advanceByCreator.length === 0 && !loading">
              <div class="empty-state empty-state-compact">
                <div class="empty-state-icon">👤</div>
                <div class="empty-state-title">暂无责任人维度的垫付数据</div>
                <div class="empty-state-description">当前没有管理员产生垫付记录。</div>
              </div>
            </template>
              </tbody>
            </table>
          </div>

          <!-- 趋势视图 -->
          <div x-show="advanceViewTab === 'trend'" class="p-4">
            <div class="mb-4 flex gap-4">
              <select class="px-3 py-2 border rounded" x-model="advanceFilters.period" @change="loadAdvanceTrend()">
                <option value="day">按日</option>
                <option value="week">按周</option>
                <option value="month">按月</option>
              </select>
              <select class="px-3 py-2 border rounded" x-model="advanceFilters.days" @change="loadAdvanceTrend()">
                <option value="7">近7天</option>
                <option value="30">近30天</option>
                <option value="90">近90天</option>
              </select>
            </div>
            <div id="advanceTrendChart" class="w-full h-80"></div>
          </div>

          <!-- 分页 -->
          <div class="p-4 border-t flex justify-between items-center" 
               x-show="['by-campaign', 'by-prize', 'by-creator'].includes(advanceViewTab)">
            <span class="text-sm themed-text-muted">
              共 <span x-text="advancePagination.total"></span> 条
            </span>
            <div class="flex gap-2">
              <button class="px-3 py-1 border rounded" 
                      :disabled="advancePagination.page <= 1"
                      @click="changeAdvancePage(advancePagination.page - 1)">
                上一页
              </button>
              <span class="px-3 py-1">
                <span x-text="advancePagination.page"></span> / <span x-text="getAdvanceTotalPages()"></span>
              </span>
              <button class="px-3 py-1 border rounded" 
                      :disabled="advancePagination.page >= getAdvanceTotalPages()"
                      @click="changeAdvancePage(advancePagination.page + 1)">
                下一页
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 创建预设 + 预设详情模态框 → 已迁移到 presets.html（抽奖干预管理页面） -->

      <!-- 活动复盘报告弹窗 (P2) -->
      <div x-show="showReportModal" 
           class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
           x-cloak
           @click.self="closeReportModal()">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-5xl max-h-[90vh] overflow-auto">
          <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10">
            <h5 class="font-semibold">📋 活动复盘报告</h5>
            <div class="flex items-center gap-2">
              <button @click="exportReportPDF()" 
                      :disabled="exportingReport || !campaignReport"
                      class="px-3 py-1 text-sm rounded bg-green-100 text-green-700 hover:bg-green-200 disabled:opacity-50">
                <span x-show="exportingReport">导出中...</span>
                <span x-show="!exportingReport">📥 导出PDF</span>
              </button>
              <button @click="closeReportModal()" class="text-gray-500 hover:text-gray-700 text-xl">✕</button>
            </div>
          </div>

          <!-- 加载状态 -->
          <div x-show="loadingReport" class="p-8 text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <p class="themed-text-muted">生成复盘报告中...</p>
          </div>

          <!-- 报告内容（适配后端扁平数据结构） -->
          <div x-show="!loadingReport && campaignReport" class="p-6">
            <template x-if="campaignReport">
              <div class="space-y-6">
                <!-- 活动基本信息 -->
                <div class="themed-card rounded-lg shadow p-4">
                  <h6 class="font-semibold mb-3 flex items-center gap-2">
                    <span>📋</span> 活动信息
                  </h6>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                      <span class="themed-text-muted">活动名称:</span>
                      <p class="font-medium" x-text="campaignReport.campaign_name || '-'"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">开始日期:</span>
                      <p x-text="formatReportTime(campaignReport.time_range?.start_time)"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">结束日期:</span>
                      <p x-text="formatReportTime(campaignReport.time_range?.end_time)"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">活动ID:</span>
                      <p x-text="campaignReport.lottery_campaign_id || '-'"></p>
                    </div>
                  </div>
                </div>

                <!-- 核心指标（后端扁平字段） -->
                <div class="themed-card rounded-lg shadow p-4">
                  <h6 class="font-semibold mb-3 flex items-center gap-2">
                    <span>📊</span> 核心指标
                  </h6>
                  <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="text-center p-3 bg-blue-50 rounded">
                      <div class="text-2xl font-bold text-blue-600" x-text="formatNumber(campaignReport.total_draws)"></div>
                      <div class="text-xs themed-text-muted">抽奖次数</div>
                    </div>
                    <div class="text-center p-3 bg-green-50 rounded">
                      <div class="text-2xl font-bold text-green-600" x-text="formatNumber(campaignReport.unique_users)"></div>
                      <div class="text-xs themed-text-muted">独立用户</div>
                    </div>
                    <div class="text-center p-3 bg-yellow-50 rounded">
                      <div class="text-2xl font-bold text-yellow-600" x-text="formatNumber(campaignReport.total_cost)"></div>
                      <div class="text-xs themed-text-muted">成本(积分)</div>
                    </div>
                    <div class="text-center p-3 bg-purple-50 rounded">
                      <div class="text-2xl font-bold text-purple-600" x-text="(campaignReport.roi || 0) + '%'"></div>
                      <div class="text-xs themed-text-muted">ROI</div>
                    </div>
                    <div class="text-center p-3 bg-pink-50 rounded">
                      <div class="text-2xl font-bold text-pink-600" x-text="(campaignReport.repeat_rate || 0) + '%'"></div>
                      <div class="text-xs themed-text-muted">复购率</div>
                    </div>
                  </div>
                </div>

                <!-- 财务分析（后端扁平字段） -->
                <div class="themed-card rounded-lg shadow p-4">
                  <h6 class="font-semibold mb-3 flex items-center gap-2">
                    <span>💰</span> 财务分析
                  </h6>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                      <span class="themed-text-muted">总收入:</span>
                      <p class="font-medium" x-text="formatNumber(campaignReport.total_revenue)"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">总成本:</span>
                      <p class="font-medium" x-text="formatNumber(campaignReport.total_cost)"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">利润:</span>
                      <p class="font-medium" :class="(campaignReport.profit || 0) >= 0 ? 'text-green-600' : 'text-red-600'"
                         x-text="formatNumber(campaignReport.profit)"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">ROI:</span>
                      <p class="font-medium" :class="(campaignReport.roi || 0) >= 0 ? 'text-green-600' : 'text-red-600'"
                         x-text="(campaignReport.roi || 0) + '%'"></p>
                    </div>
                  </div>
                </div>

                <!-- 用户分析（后端扁平字段） -->
                <div class="themed-card rounded-lg shadow p-4">
                  <h6 class="font-semibold mb-3 flex items-center gap-2">
                    <span>👥</span> 用户分析
                  </h6>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                      <span class="themed-text-muted">独立用户数:</span>
                      <p class="font-medium" x-text="formatNumber(campaignReport.unique_users)"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">人均抽奖:</span>
                      <p class="font-medium" x-text="(campaignReport.avg_draws_per_user || 0) + '次'"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">复购用户:</span>
                      <p class="font-medium" x-text="formatNumber(campaignReport.repeat_users)"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">复购率:</span>
                      <p class="font-medium" x-text="(campaignReport.repeat_rate || 0) + '%'"></p>
                    </div>
                  </div>
                </div>

                <!-- 档位成本分布（后端 tier_cost_breakdown） -->
                <div x-show="campaignReport.tier_cost_breakdown" class="themed-card rounded-lg shadow p-4">
                  <h6 class="font-semibold mb-3 flex items-center gap-2">
                    <span>📊</span> 档位成本分布
                  </h6>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                      <span class="themed-text-muted">高档位:</span>
                      <p class="font-medium" x-text="formatNumber(campaignReport.tier_cost_breakdown?.high)"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">中档位:</span>
                      <p class="font-medium" x-text="formatNumber(campaignReport.tier_cost_breakdown?.mid)"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">低档位:</span>
                      <p class="font-medium" x-text="formatNumber(campaignReport.tier_cost_breakdown?.low)"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">兜底:</span>
                      <p class="font-medium" x-text="formatNumber(campaignReport.tier_cost_breakdown?.fallback)"></p>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>

          <!-- 空状态 -->
          <div x-show="!loadingReport && !campaignReport" class="p-8 text-center">
            <div class="text-4xl mb-2">📭</div>
            <p class="themed-text-muted">未能生成复盘报告，请稍后重试</p>
          </div>

          <div class="p-4 border-t flex justify-end sticky bottom-0 bg-white">
            <button @click="closeReportModal()" class="themed-btn-secondary px-4 py-2 rounded">
              关闭
            </button>
          </div>
        </div>
      </div>

      <!-- ==================== 核销码管理页 ==================== -->
      <div x-show="current_page === 'redemption-codes'" x-cloak>
        <!-- 统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl themed-text-primary mb-2">🎫</div>
            <h6 class="themed-text-muted text-sm mb-1">核销码总数</h6>
            <h2 class="text-2xl font-bold themed-text-primary" x-text="redemptionStats.total">-</h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-yellow-500 mb-2">⏳</div>
            <h6 class="themed-text-muted text-sm mb-1">待核销</h6>
            <h2 class="text-2xl font-bold text-yellow-600" x-text="redemptionStats.pending">-</h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-green-500 mb-2">✅</div>
            <h6 class="themed-text-muted text-sm mb-1">已核销</h6>
            <h2 class="text-2xl font-bold text-green-600" x-text="redemptionStats.fulfilled">-</h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-red-500 mb-2">❌</div>
            <h6 class="themed-text-muted text-sm mb-1">已过期</h6>
            <h2 class="text-2xl font-bold text-red-600" x-text="redemptionStats.expired">-</h2>
          </div>
        </div>

        <!-- 筛选和操作栏 -->
        <div class="themed-card rounded-lg shadow mb-4 p-4">
          <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
            <div>
              <label class="block text-sm themed-text-muted mb-1">状态</label>
              <select class="w-full px-3 py-2 border rounded" x-model="redemptionFilters.status">
                <option value="">全部状态</option>
                <option value="pending">待核销</option>
                <option value="fulfilled">已核销</option>
                <option value="expired">已过期</option>
                <option value="cancelled">已取消</option>
              </select>
            </div>
            <div>
              <label class="block text-sm themed-text-muted mb-1">奖品类型</label>
              <select class="w-full px-3 py-2 border rounded" x-model="redemptionFilters.prize_type">
                <option value="">全部类型</option>
                <option value="physical">实物奖品</option>
                <option value="virtual">虚拟奖品</option>
                <option value="coupon">优惠券</option>
              </select>
            </div>
            <div>
              <label class="block text-sm themed-text-muted mb-1">核销码</label>
              <input type="text" class="w-full px-3 py-2 border rounded" x-model="redemptionFilters.code" placeholder="输入核销码搜索..." @keyup.enter="searchRedemptionCodes()">
            </div>
            <div>
              <label class="block text-sm themed-text-muted mb-1">手机号</label>
              <input type="text" class="w-full px-3 py-2 border rounded" x-model="redemptionFilters.mobile" maxlength="11" placeholder="输入手机号..." @keyup.enter="searchRedemptionCodes()">
            </div>
            <div class="flex gap-2">
              <button class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" @click="searchRedemptionCodes()">
                🔍 搜索
              </button>
            </div>
          </div>
        </div>

        <!-- 核销码列表 -->
        <div class="themed-card rounded-lg shadow">
          <div class="p-4 border-b flex justify-between items-center">
            <h6 class="font-semibold">📋 核销码列表 <span x-show="redemptionSelectedIds.length > 0" class="ml-2 text-sm font-normal themed-text-primary">(已选中 <span x-text="redemptionSelectedIds.length"></span> 条)</span></h6>
            <div class="flex gap-2 items-center">
              <span x-show="redemptionSelectedIds.length === 0" class="text-xs text-gray-400 mr-2">勾选左侧复选框可批量操作</span>
              <button class="px-3 py-1 text-sm border border-yellow-500 text-yellow-500 rounded hover:bg-yellow-50 disabled:opacity-50 disabled:cursor-not-allowed" @click="batchExpireRedemption()" :disabled="redemptionSelectedIds.length === 0">
                ⏰ 批量过期 <span x-show="redemptionSelectedIds.length > 0" class="ml-1 bg-yellow-500 text-white px-1.5 py-0.5 rounded-full text-xs" x-text="redemptionSelectedIds.length"></span>
              </button>
              <button class="px-3 py-1 text-sm border border-green-500 text-green-500 rounded hover:bg-green-50" @click="exportRedemptionCodes()">
                📥 导出
              </button>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="themed-bg-base">
                <tr>
                  <th class="px-4 py-3 text-left">
                    <input type="checkbox" :checked="checkIsAllRedemptionSelected()" @change="toggleRedemptionSelectAll()">
                  </th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">核销码</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">用户</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">奖品</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">活动</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">状态</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">创建时间</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">有效期至</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                <tr x-show="!redemptionCodes || redemptionCodes.length === 0">
                  <td colspan="9" class="px-4 py-8 text-center themed-text-muted">暂无核销码数据</td>
                </tr>
                <template x-for="c in redemptionCodes" :key="c.redemption_order_id">
                  <tr class="themed-hover-bg" :class="'border-l-4 ' + (c.status === 'pending' ? 'border-l-yellow-500' : c.status === 'fulfilled' || c.status === 'redeemed' ? 'border-l-green-500' : c.status === 'expired' ? 'border-l-red-500' : 'border-l-gray-400')">
                    <td class="px-4 py-3">
                      <input type="checkbox" :value="c.redemption_order_id" :checked="redemptionSelectedIds.includes(c.redemption_order_id)" @change="toggleRedemptionSelect(c.redemption_order_id)">
                    </td>
                    <td class="px-4 py-3">
                      <code class="themed-bg-subtle px-2 py-1 rounded text-sm" :title="c.code_hash || ''" x-text="getCodeDisplay(c.code_hash)"></code>
                    </td>
                    <td class="px-4 py-3 text-sm">
                      <span x-text="c.redeemer_user_id || '-'"></span>
                      <template x-if="getRedeemerName(c)">
                        <br><small class="text-gray-400" x-text="getRedeemerName(c)"></small>
                      </template>
                    </td>
                    <td class="px-4 py-3 text-sm" x-text="getRedemptionPrizeName(c)"></td>
                    <td class="px-4 py-3 text-sm" x-text="getRedemptionCampaignName(c)"></td>
                    <td class="px-4 py-3">
                      <span class="px-2 py-1 text-xs rounded" :class="getRedemptionStatusClass(c.status)" x-text="c.status_display || c.status"></span>
                    </td>
                    <td class="px-4 py-3 text-sm themed-text-muted" x-text="formatDateOnly(c.created_at)"></td>
                    <td class="px-4 py-3 text-sm themed-text-muted" x-text="formatDateOnly(c.expires_at)"></td>
                    <td class="px-4 py-3">
                      <div class="flex space-x-1">
                        <button class="themed-text-primary hover:text-blue-700 text-sm" @click="viewRedemptionDetail(c.redemption_order_id)">详情</button>
                        <template x-if="c.status === 'pending'">
                          <span class="flex space-x-1">
                            <button class="text-green-500 hover:text-green-700 text-sm" @click="openRedeemModal(c.redemption_order_id, getCodeDisplay(c.code_hash))">核销</button>
                            <button class="text-red-500 hover:text-red-700 text-sm" @click="cancelRedemptionCode(c.redemption_order_id)">取消</button>
                          </span>
                        </template>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <!-- 分页 -->
          <div class="p-4 border-t flex justify-center" x-show="total_pages > 1">
            <div class="flex space-x-2">
              <button class="px-3 py-1 border rounded" :class="page === 1 ? 'themed-bg-subtle text-gray-400' : 'themed-hover-bg'" :disabled="page === 1" @click="loadRedemptionCodes(page - 1)">上一页</button>
              <template x-for="p in Array.from({length: Math.min(5, total_pages)}, (_, i) => Math.max(1, page - 2) + i).filter(p => p <= total_pages)" :key="p">
                <button class="px-3 py-1 border rounded" :class="p === page ? 'themed-bg-primary text-white' : 'themed-hover-bg'" @click="loadRedemptionCodes(p)" x-text="p"></button>
              </template>
              <button class="px-3 py-1 border rounded" :class="page === total_pages ? 'themed-bg-subtle text-gray-400' : 'themed-hover-bg'" :disabled="page === total_pages" @click="loadRedemptionCodes(page + 1)">下一页</button>
            </div>
          </div>
        </div>
      </div>

  <!-- ==================== Modal 组件 ==================== -->
  <!-- 注意：Modal 必须在 lotteryPageContent 组件作用域内 -->

  <!-- 活动表单 Modal - 包含后端所有必填字段 -->
  <div x-ref="campaignModal" x-show="isModalOpen('campaignModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('campaignModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center themed-bg-primary rounded-t-lg">
        <h5 class="font-semibold text-white">🎁 <span x-text="isEditMode ? '编辑活动' : '创建活动'"></span></h5>
        <button @click="hideModal('campaignModal')" class="text-white hover:text-gray-200 text-xl">&times;</button>
      </div>
      <form @submit.prevent="submitCampaignForm()">
        <div class="p-4 space-y-4">
          <!-- 基本信息 -->
          <div class="themed-bg-base p-3 rounded">
            <h6 class="text-sm font-semibold themed-text-muted mb-3">📋 基本信息</h6>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">活动名称 <span class="text-red-500">*</span></label>
                <input type="text" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model="campaignForm.campaign_name" placeholder="如：春节抽奖活动" required>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">活动代码 <span class="text-red-500">*</span></label>
                <input type="text" class="w-full px-3 py-2 border rounded themed-bg-subtle focus:ring-2 focus:ring-blue-500" x-model="campaignForm.campaign_code" :readonly="isEditMode" placeholder="自动生成" required>
                <p class="text-xs themed-text-muted mt-1">唯一标识，创建后不可修改</p>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4 mt-3">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">活动类型 <span class="text-red-500">*</span></label>
                <select class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model="campaignForm.campaign_type" required>
                  <template x-for="opt in campaignTypeOptions" :key="opt.value">
                    <option :value="opt.value" x-text="opt.label"></option>
                  </template>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">状态</label>
                <select class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model="campaignForm.status">
                  <option value="draft">草稿</option>
                  <option value="active">进行中</option>
                  <option value="paused">已暂停</option>
                  <option value="ended">已结束</option>
                  <option value="cancelled">已取消</option>
                </select>
              </div>
            </div>
            <div class="mt-3">
              <label class="block text-sm font-medium themed-text-secondary mb-1">活动描述</label>
              <textarea class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model="campaignForm.description" rows="2" placeholder="请输入活动描述..."></textarea>
            </div>
          </div>

          <!-- 时间设置 -->
          <div class="themed-bg-base p-3 rounded">
            <h6 class="text-sm font-semibold themed-text-muted mb-3">⏰ 时间设置</h6>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">开始时间 <span class="text-red-500">*</span></label>
                <input type="datetime-local" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model="campaignForm.start_time" required>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">结束时间 <span class="text-red-500">*</span></label>
                <input type="datetime-local" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model="campaignForm.end_time" required>
              </div>
            </div>
          </div>

          <!-- 抽奖配置 -->
          <div class="themed-bg-base p-3 rounded">
            <h6 class="text-sm font-semibold themed-text-muted mb-3">🎰 抽奖配置</h6>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">每日最大次数</label>
                <input type="number" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model.number="campaignForm.max_draws_per_user_daily" min="1">
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">总最大次数</label>
                <input type="number" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model.number="campaignForm.max_draws_per_user_total" min="0" placeholder="不限制">
                <p class="text-xs themed-text-muted mt-1">0或空表示不限制</p>
              </div>
            </div>
          </div>

          <!-- 展示配置（多活动抽奖系统 2026-02-15） -->
          <div class="themed-bg-base p-3 rounded">
            <h6 class="text-sm font-semibold themed-text-muted mb-3">🎨 展示配置</h6>
            <div class="grid grid-cols-2 gap-4">
              <!-- 抽奖方式（display_mode） -->
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">抽奖方式</label>
                <select class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model="campaignForm.display_mode">
                  <template x-for="opt in displayModeOptions" :key="opt.value">
                    <option :value="opt.value" x-text="opt.icon + ' ' + opt.label"></option>
                  </template>
                </select>
              </div>
              <!-- 网格列数（仅 grid 模式显示） -->
              <div x-show="campaignForm.display_mode && campaignForm.display_mode.startsWith('grid')">
                <label class="block text-sm font-medium themed-text-secondary mb-1">网格列数</label>
                <select class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model.number="campaignForm.grid_cols">
                  <option value="3">3 列</option>
                  <option value="4">4 列</option>
                  <option value="5">5 列</option>
                </select>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4 mt-3">
              <!-- 特效主题（effect_theme） -->
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">特效主题</label>
                <select class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model="campaignForm.effect_theme">
                  <template x-for="opt in effectThemeOptions" :key="opt.value">
                    <option :value="opt.value" x-text="opt.label"></option>
                  </template>
                </select>
                <!-- 主题色预览 -->
                <div class="flex items-center gap-2 mt-1">
                  <template x-for="opt in effectThemeOptions" :key="opt.value">
                    <template x-if="opt.value === campaignForm.effect_theme">
                      <div class="flex gap-1">
                        <span class="inline-block w-4 h-4 rounded" :style="'background:' + opt.primary"></span>
                        <span class="inline-block w-4 h-4 rounded" :style="'background:' + opt.secondary"></span>
                        <span class="text-xs themed-text-muted" x-text="opt.label"></span>
                      </div>
                    </template>
                  </template>
                </div>
              </div>
              <!-- 中奖动画（win_animation） -->
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">中奖动画</label>
                <select class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model="campaignForm.win_animation">
                  <template x-for="opt in winAnimationOptions" :key="opt.value">
                    <option :value="opt.value" x-text="opt.label"></option>
                  </template>
                </select>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4 mt-3">
              <!-- 稀有度光效开关 -->
              <div class="flex items-center gap-2">
                <input type="checkbox" id="rarityEffectsEnabled" x-model="campaignForm.rarity_effects_enabled" class="rounded">
                <label for="rarityEffectsEnabled" class="text-sm themed-text-secondary">✨ 启用稀有度光效</label>
                <p class="text-xs themed-text-muted">开启后奖品按稀有度显示不同颜色光效</p>
              </div>
              <!-- 活动背景图（复用 POST /api/v4/console/images 上传接口） -->
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">活动背景图（可选）</label>
                <div class="flex gap-2">
                  <input type="text" class="flex-1 px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 text-sm" x-model="campaignForm.background_image_url" placeholder="输入图片URL或上传图片">
                  <label class="px-3 py-2 bg-gray-100 border rounded cursor-pointer hover:bg-gray-200 text-sm whitespace-nowrap">
                    📤 上传
                    <input type="file" accept="image/*" class="hidden" @change="
                      const file = $event.target.files[0];
                      if (!file) return;
                      if (file.size > 5 * 1024 * 1024) { showError('图片大小不能超过5MB'); return; }
                      const formData = new FormData();
                      formData.append('image', file);
                      fetch('/api/v4/console/images/upload', {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('token') || '') },
                        body: formData
                      }).then(r => r.json()).then(res => {
                        if (res.success && res.data?.url) {
                          campaignForm.background_image_url = res.data.url;
                          $dispatch('notification', { type: 'success', message: '图片上传成功' });
                        } else {
                          showError('上传失败: ' + (res.message || '未知错误'));
                        }
                      }).catch(err => showError('上传失败: ' + err.message));
                      $event.target.value = '';
                    ">
                  </label>
                </div>
                <div x-show="campaignForm.background_image_url" class="mt-2">
                  <img :src="campaignForm.background_image_url" class="max-h-24 rounded border" alt="背景图预览">
                  <button @click="campaignForm.background_image_url = null" class="text-xs text-red-500 hover:text-red-700 ml-2">清除</button>
                </div>
              </div>
            </div>
          </div>

          <!-- 固定间隔保底配置 -->
          <div class="themed-bg-base p-3 rounded">
            <h6 class="text-sm font-semibold themed-text-muted mb-3">🛡️ 固定间隔保底配置</h6>
            <div class="space-y-3">
              <!-- 启用开关 -->
              <div class="flex items-center justify-between">
                <div>
                  <label class="text-sm font-medium themed-text-secondary">启用固定间隔保底</label>
                  <p class="text-xs themed-text-muted">开启后，用户每累计抽奖N次必定获得一次指定奖品</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" x-model="campaignForm.guarantee_enabled" class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
              </div>

              <!-- 子配置（仅启用时显示） -->
              <div x-show="campaignForm.guarantee_enabled" x-transition class="space-y-3 pl-4 border-l-2 border-blue-200">
                <!-- 保底间隔次数 -->
                <div>
                  <label class="block text-sm font-medium themed-text-secondary mb-1">保底间隔次数</label>
                  <input type="number" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                         x-model.number="campaignForm.guarantee_threshold"
                         min="5" max="100" step="1" placeholder="20">
                  <p class="text-xs themed-text-muted mt-1">范围 5~100，用户每累计此次数触发一次保底</p>
                </div>

                <!-- 保底奖品选择 -->
                <div>
                  <label class="block text-sm font-medium themed-text-secondary mb-1">保底奖品</label>
                  <select class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                          x-model.number="campaignForm.guarantee_prize_id">
                    <option :value="null">自动选择（最高档有库存奖品）</option>
                    <template x-for="tier in ['high', 'mid', 'low']" :key="tier">
                      <optgroup :label="tier === 'high' ? '🔴 高档奖品' : tier === 'mid' ? '🟡 中档奖品' : '🟢 低档奖品'">
                        <template x-for="prize in (currentCampaignPrizes || []).filter(p => p.reward_tier === tier && p.status === 'active')" :key="prize.lottery_prize_id">
                          <option :value="prize.lottery_prize_id"
                                  x-text="`${prize.prize_name} (${prize.prize_value_points}积分, 库存:${prize.stock_quantity})`">
                          </option>
                        </template>
                      </optgroup>
                    </template>
                  </select>
                  <p class="text-xs themed-text-muted mt-1">留空时后端自动选当前活动最高档有库存奖品</p>
                  <template x-if="isEditMode && (!currentCampaignPrizes || currentCampaignPrizes.length === 0)">
                    <p class="text-xs text-amber-600 mt-1">⚠️ 该活动暂无关联奖品，请先在奖品管理中添加奖品</p>
                  </template>
                </div>

                <!-- 预估影响 -->
                <div class="bg-blue-50 rounded-lg p-3 text-sm" x-show="campaignForm.guarantee_threshold > 0">
                  <p class="font-medium text-blue-800">📊 预估影响</p>
                  <p class="text-blue-700">
                    间隔 <span class="font-semibold" x-text="campaignForm.guarantee_threshold"></span> 次
                    → 约 <span class="font-semibold" x-text="(100 / campaignForm.guarantee_threshold).toFixed(1)"></span>% 的抽奖会触发保底
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- 奖池配置 -->
          <div class="themed-bg-base p-3 rounded">
            <h6 class="text-sm font-semibold themed-text-muted mb-3">💰 奖池配置</h6>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">总奖池价值</label>
                <input type="number" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model.number="campaignForm.total_prize_pool" min="0" step="0.01">
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">剩余奖池价值</label>
                <input type="number" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model.number="campaignForm.remaining_prize_pool" min="0" step="0.01">
              </div>
            </div>
          </div>

          <!-- 活动规则 -->
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">📜 活动规则</label>
            <textarea class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model="campaignForm.rules_text" rows="3" placeholder="请输入活动规则说明..."></textarea>
          </div>
        </div>
        <div class="p-4 border-t flex justify-end space-x-2 themed-bg-base">
          <button type="button" class="px-4 py-2 border rounded themed-hover-bg" @click="hideModal('campaignModal')">取消</button>
          <button type="submit" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary disabled:opacity-50" :disabled="saving">
            <span x-show="saving">保存中...</span>
            <span x-show="!saving" x-text="isEditMode ? '保存修改' : '创建活动'"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 活动详情 Modal -->
  <div x-ref="campaignDetailModal" x-show="isModalOpen('campaignDetailModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('campaignDetailModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">🎁 活动详情</h5>
        <button @click="hideModal('campaignDetailModal')" class="text-gray-400 hover:themed-text-muted">&times;</button>
      </div>
      <div class="p-4" x-show="selectedCampaign">
        <div class="mb-4">
          <h4 class="text-xl font-bold" x-text="selectedCampaign?.campaign_name"></h4>
          <span class="px-2 py-1 text-xs rounded" :class="getCampaignStatusClass(selectedCampaign?.status)" x-text="selectedCampaign?.status_display || selectedCampaign?.status"></span>
        </div>
        <div class="space-y-3">
          <div><strong>活动代码：</strong><span class="themed-text-muted" x-text="selectedCampaign?.campaign_code"></span></div>
          <div><strong>活动描述：</strong><p class="themed-text-muted" x-text="selectedCampaign?.description || '暂无描述'"></p></div>
          <div class="grid grid-cols-2 gap-4">
            <div><strong>开始时间：</strong><span x-text="formatDateOnly(selectedCampaign?.start_time)"></span></div>
            <div><strong>结束时间：</strong><span x-text="formatDateOnly(selectedCampaign?.end_time)"></span></div>
            <div><strong>参与人数：</strong><span x-text="selectedCampaign?.participant_count || 0"></span></div>
            <div><strong>中奖人数：</strong><span x-text="selectedCampaign?.winner_count || 0"></span></div>
          </div>
          <!-- 展示配置信息 -->
          <div class="themed-bg-base p-3 rounded">
            <h6 class="text-sm font-semibold themed-text-muted mb-2">🎨 展示配置</h6>
            <div class="grid grid-cols-3 gap-3 text-sm">
              <div>
                <span class="themed-text-muted">抽奖方式：</span>
                <span x-text="(displayModeOptions.find(o => o.value === selectedCampaign?.display_mode) || {}).icon + ' ' + (displayModeOptions.find(o => o.value === selectedCampaign?.display_mode) || { label: '九宫格' }).label"></span>
              </div>
              <div>
                <span class="themed-text-muted">特效主题：</span>
                <span x-text="(effectThemeOptions.find(o => o.value === selectedCampaign?.effect_theme) || { label: '默认' }).label"></span>
              </div>
              <div>
                <span class="themed-text-muted">中奖动画：</span>
                <span x-text="(winAnimationOptions.find(o => o.value === selectedCampaign?.win_animation) || { label: '简单弹窗' }).label"></span>
              </div>
              <div>
                <span class="themed-text-muted">稀有度光效：</span>
                <span x-text="selectedCampaign?.rarity_effects_enabled ? '✅ 开启' : '❌ 关闭'"></span>
              </div>
              <div x-show="selectedCampaign?.display_mode?.startsWith('grid')">
                <span class="themed-text-muted">网格列数：</span>
                <span x-text="selectedCampaign?.grid_cols || 3"></span>
              </div>
            </div>
          </div>
          <div x-show="selectedCampaign?.rules_text">
            <strong>活动规则：</strong>
            <pre class="themed-bg-subtle p-2 rounded mt-1 text-sm whitespace-pre-wrap" x-text="selectedCampaign?.rules_text"></pre>
          </div>
        </div>
      </div>
      <div class="p-4 border-t flex justify-end space-x-2">
        <button type="button" class="px-4 py-2 border rounded themed-hover-bg" @click="hideModal('campaignDetailModal')">关闭</button>
        <button type="button" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" @click="editCampaign(selectedCampaign); hideModal('campaignDetailModal')">
          ✏️ 编辑
        </button>
      </div>
    </div>
  </div>

  <!-- 奖品表单 Modal -->
  <div x-ref="prizeModal" x-show="isModalOpen('prizeModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('prizeModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">🏆 <span x-text="isEditMode ? '编辑奖品' : '添加奖品'"></span></h5>
        <button @click="hideModal('prizeModal')" class="text-gray-400 hover:themed-text-muted">&times;</button>
      </div>
      <form @submit.prevent="submitPrizeForm()">
        <div class="p-4 space-y-4">
          <!-- 活动选择（仅新增时显示） -->
          <div x-show="!isEditMode">
            <label class="block text-sm font-medium themed-text-secondary mb-1">所属活动 <span class="text-red-500">*</span></label>
            <!-- 无活动时显示提示 -->

              <div x-show="!campaigns || campaigns.length === 0" class="p-3 bg-yellow-50 border border-yellow-200 rounded text-yellow-700 text-sm">
                ⚠️ 暂无可用活动，请先到 <a href="#" @click.prevent="switchPage('campaigns')" class="themed-text-primary underline">活动管理</a> 创建活动
              </div>

            <!-- 有活动时显示下拉框 -->
            <template x-if="campaigns && campaigns.length > 0">
              <select class="w-full px-3 py-2 border rounded" x-model.number="prizeForm.lottery_campaign_id" required>
                <option value="">请选择活动</option>
                <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
                  <option :value="campaign.lottery_campaign_id" x-text="campaign.campaign_name"></option>
                </template>
              </select>
            </template>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">奖品名称 <span class="text-red-500">*</span></label>
            <input type="text" class="w-full px-3 py-2 border rounded" x-model="prizeForm.prize_name" required>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">奖品类型</label>
              <select class="w-full px-3 py-2 border rounded" x-model="prizeForm.prize_type">
                <option value="points">积分</option>
                <option value="coupon">优惠券</option>
                <option value="physical">实物</option>
                <option value="virtual">虚拟</option>
                <option value="service">服务</option>
                <option value="product">商品</option>
                <option value="special">特殊</option>
              </select>
            </div>
            <!-- 稀有度选择器（rarity_code 来自 rarity_defs 表） -->
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">💎 稀有度</label>
              <select class="w-full px-3 py-2 border rounded" x-model="prizeForm.rarity_code">
                <template x-for="opt in rarityOptions" :key="opt.value">
                  <option :value="opt.value" x-text="opt.label"></option>
                </template>
              </select>
              <!-- 稀有度颜色预览 -->
              <div class="flex items-center gap-1 mt-1">
                <template x-for="opt in rarityOptions" :key="opt.value">
                  <template x-if="opt.value === prizeForm.rarity_code">
                    <div class="flex items-center gap-1">
                      <span class="inline-block w-3 h-3 rounded-full" :style="'background:' + opt.color"></span>
                      <span class="text-xs themed-text-muted" x-text="opt.label"></span>
                    </div>
                  </template>
                </template>
              </div>
            </div>
            <!-- 九宫格位置（sort_order，1-8 顺时针排列） -->
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">🎰 九宫格位置</label>
              <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="prizeForm.sort_order" min="1" max="8" :placeholder="isEditMode ? '1-8' : '自动分配'">
              <p class="text-xs themed-text-muted mt-1" x-text="isEditMode ? '九宫格顺时针位置编号（1=左上 → 8=左中）' : '留空则由系统自动分配唯一位置编号'"></p>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">中奖概率 (%)</label>
              <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="prizeForm.win_probability" min="0" max="100" step="0.01">
              <p class="text-xs text-amber-600 mt-1">⚠️ 添加后请编辑调整概率，确保所有奖品概率总和=100%</p>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">库存数量</label>
              <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="prizeForm.stock_quantity" min="1" placeholder="输入正整数">
              <p class="text-xs themed-text-muted mt-1">输入999999表示无限库存</p>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">奖品图片URL</label>
            <input type="text" class="w-full px-3 py-2 border rounded" x-model="prizeForm.image_url">
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">奖品描述</label>
            <textarea class="w-full px-3 py-2 border rounded" x-model="prizeForm.prize_description" rows="2"></textarea>
          </div>
          <div class="flex items-center">
            <input type="checkbox" :checked="prizeForm.status === 'active'" @change="prizeForm.status = $event.target.checked ? 'active' : 'inactive'" id="prizeActiveSwitch" class="mr-2">
            <label for="prizeActiveSwitch">启用奖品</label>
          </div>
        </div>
        <div class="p-4 border-t flex justify-end space-x-2">
          <button type="button" class="px-4 py-2 border rounded themed-hover-bg" @click="hideModal('prizeModal')">取消</button>
          <button type="submit" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" :disabled="saving">
            <span x-show="saving">保存中...</span>
            <span x-show="!saving" x-text="isEditMode ? '保存修改' : '添加奖品'"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 批量添加奖品 Modal -->
  <div x-ref="batchPrizeModal" x-show="isModalOpen('batchPrizeModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('batchPrizeModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">📦 批量配置奖品池</h5>
        <button @click="hideModal('batchPrizeModal')" class="text-gray-400 hover:themed-text-muted text-2xl">&times;</button>
      </div>
      
      <div class="p-4 space-y-4">
        <!-- 选择活动 -->
        <div class="flex items-center gap-4">
          <label class="block text-sm font-medium themed-text-secondary whitespace-nowrap">所属活动 *</label>
          <select class="flex-1 px-3 py-2 border rounded" x-model.number="batchLotteryCampaignId">
            <option value="">请选择活动</option>
            <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
              <option :value="campaign.lottery_campaign_id" x-text="campaign.campaign_name"></option>
            </template>
          </select>
        </div>

        <!-- 概率统计 -->
        <div class="p-3 rounded-lg" :class="Math.abs(batchProbabilitySum - 100) <= 0.01 ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'">
          <div class="flex items-center justify-between">
            <span class="font-medium" :class="Math.abs(batchProbabilitySum - 100) <= 0.01 ? 'themed-text-success' : 'text-red-700'">
              概率总和: <span x-text="batchProbabilitySum.toFixed(2)"></span>%
              <span x-show="Math.abs(batchProbabilitySum - 100) <= 0.01" class="ml-2">✅ 正确</span>
              <span x-show="Math.abs(batchProbabilitySum - 100) > 0.01" class="ml-2">❌ 必须等于100%</span>
            </span>
            <button type="button" @click="autoDistributeProbability()" class="px-3 py-1 themed-bg-primary text-white text-sm rounded themed-hover-primary">
              🔄 自动平均分配
            </button>
          </div>
        </div>

        <!-- 奖品列表 -->
        <div class="border rounded-lg overflow-hidden">
          <table class="min-w-full divide-y divide-[var(--color-border)]">
            <thead class="themed-bg-base">
              <tr>
                <th class="px-3 py-2 text-left text-xs font-medium themed-text-muted w-8">#</th>
                <th class="px-3 py-2 text-left text-xs font-medium themed-text-muted">奖品名称 *</th>
                <th class="px-3 py-2 text-left text-xs font-medium themed-text-muted w-28">类型</th>
                <th class="px-3 py-2 text-left text-xs font-medium themed-text-muted w-24">稀有度</th>
                <th class="px-3 py-2 text-left text-xs font-medium themed-text-muted w-24">概率 (%)</th>
                <th class="px-3 py-2 text-left text-xs font-medium themed-text-muted w-24">库存</th>
                <th class="px-3 py-2 text-left text-xs font-medium themed-text-muted w-16">位置</th>
                <th class="px-3 py-2 text-left text-xs font-medium themed-text-muted w-16">操作</th>
              </tr>
            </thead>
            <tbody class="themed-card divide-y divide-[var(--color-border)]">
              <!-- 2026-01-29 技术债务清理：直接使用后端字段名 -->
              <template x-for="(prize, index) in batchPrizes" :key="index">
                <tr>
                  <td class="px-3 py-2 text-sm themed-text-muted" x-text="index + 1"></td>
                  <td class="px-3 py-2">
                    <input type="text" class="w-full px-2 py-1 border rounded text-sm" 
                           x-model="prize.prize_name" placeholder="奖品名称">
                  </td>
                  <td class="px-3 py-2">
                    <select class="w-full px-2 py-1 border rounded text-sm" x-model="prize.prize_type">
                      <option value="points">积分</option>
                      <option value="coupon">优惠券</option>
                      <option value="physical">实物</option>
                      <option value="virtual">虚拟</option>
                      <option value="service">服务</option>
                      <option value="product">商品</option>
                      <option value="special">特殊</option>
                    </select>
                  </td>
                  <!-- 稀有度选择器 -->
                  <td class="px-3 py-2">
                    <select class="w-full px-2 py-1 border rounded text-sm" x-model="prize.rarity_code"
                            :style="'border-color:' + (rarityOptions.find(o => o.value === prize.rarity_code) || {}).color">
                      <template x-for="opt in rarityOptions" :key="opt.value">
                        <option :value="opt.value" x-text="opt.label"></option>
                      </template>
                    </select>
                  </td>
                  <td class="px-3 py-2">
                    <!-- win_probability 使用小数(0-1)，乘100显示为百分比 -->
                    <input type="number" class="w-full px-2 py-1 border rounded text-sm" 
                           :value="(prize.win_probability * 100).toFixed(1)"
                           @input="prize.win_probability = parseFloat($event.target.value) / 100 || 0; updateBatchProbabilitySum()"
                           min="0" max="100" step="0.1">
                  </td>
                  <td class="px-3 py-2">
                    <input type="number" class="w-full px-2 py-1 border rounded text-sm" 
                           x-model.number="prize.stock_quantity" min="1" placeholder="999999=无限">
                  </td>
                  <td class="px-3 py-2">
                    <input type="number" class="w-full px-2 py-1 border rounded text-sm"
                           x-model.number="prize.sort_order" min="1" max="8" placeholder="自动分配">
                  </td>
                  <td class="px-3 py-2">
                    <button type="button" @click="removeBatchPrizeSlot(index)" 
                            class="text-red-500 hover:text-red-700"
                            :disabled="batchPrizes.length <= 1"
                            :class="batchPrizes.length <= 1 ? 'opacity-30 cursor-not-allowed' : ''">
                      🗑️
                    </button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>

        <!-- 添加更多奖品 -->
        <button type="button" @click="addBatchPrizeSlot()" 
                class="w-full py-2 border-2 border-dashed themed-border rounded-lg themed-text-muted hover:border-blue-500 hover:text-blue-500 transition-colors">
          ➕ 添加更多奖品
        </button>

        <!-- 提示信息 -->
        <div class="p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-700">
          <p>💡 <strong>提示：</strong></p>
          <ul class="mt-1 ml-4 list-disc">
            <li>所有奖品的概率总和必须等于 100%</li>
            <li>库存输入 999999 表示无限库存</li>
            <li>"谢谢参与"类型适合保底奖品</li>
          </ul>
        </div>
      </div>

      <div class="p-4 border-t flex justify-end space-x-2">
        <button type="button" class="px-4 py-2 border rounded themed-hover-bg" @click="hideModal('batchPrizeModal')">取消</button>
        <button type="button" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" 
                @click="submitBatchPrizes()" :disabled="saving || Math.abs(batchProbabilitySum - 100) > 0.01">
          <span x-show="saving">提交中...</span>
          <span x-show="!saving">📦 批量添加 (<span x-text="batchPrizes.length"></span>个奖品)</span>
        </button>
      </div>
    </div>
  </div>

  <!-- 奖品补货 Modal -->
  <div x-ref="stockModal" x-show="isModalOpen('stockModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('stockModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-md w-full mx-4">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">📦 奖品补货</h5>
        <button @click="hideModal('stockModal')" class="text-gray-400 hover:themed-text-muted">&times;</button>
      </div>
      <form @submit.prevent="submitAddStock()">
        <div class="p-4 space-y-4">
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">奖品名称</label>
            <input type="text" class="w-full px-3 py-2 border rounded themed-bg-base" :value="stockForm.prize_name" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">补货数量 <span class="text-red-500">*</span></label>
            <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="stockForm.quantity" min="1" required>
          </div>
        </div>
        <div class="p-4 border-t flex justify-end space-x-2">
          <button type="button" class="px-4 py-2 border rounded themed-hover-bg" @click="hideModal('stockModal')">取消</button>
          <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600" :disabled="saving">确认补货</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 预算设置 Modal -->
  <div x-ref="budgetModal" x-show="isModalOpen('budgetModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('budgetModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-md w-full mx-4">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">💰 设置预算</h5>
        <button @click="hideModal('budgetModal')" class="text-gray-400 hover:themed-text-muted">&times;</button>
      </div>
      <form @submit.prevent="submitBudget()">
        <div class="p-4 space-y-4">
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">预算模式</label>
            <select class="w-full px-3 py-2 border rounded" x-model="budgetForm.budget_mode">
              <option value="pool">总预算</option>
              <option value="daily">每日预算</option>
              <option value="user">用户预算</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">预算金额</label>
            <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="budgetForm.pool_budget_total" min="0" step="0.01">
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">预警阈值 (%)</label>
            <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="budgetForm.alert_threshold" min="0" max="100">
          </div>
        </div>
        <div class="p-4 border-t flex justify-end space-x-2">
          <button type="button" class="px-4 py-2 border rounded themed-hover-bg" @click="hideModal('budgetModal')">取消</button>
          <button type="submit" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" :disabled="saving">保存设置</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 矩阵编辑 Modal -->
  <div x-ref="matrixEditModal" x-show="isModalOpen('matrixEditModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('matrixEditModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center sticky top-0 themed-card z-10">
        <h5 class="font-semibold">📊 编辑矩阵配置</h5>
        <button @click="hideModal('matrixEditModal')" class="text-gray-400 hover:themed-text-muted">&times;</button>
      </div>
      <form @submit.prevent="submitMatrixConfig()">
        <div class="p-4 space-y-4" x-show="editingMatrixCell">
          <div class="themed-bg-primary-light p-3 rounded">
            预算层级：<strong x-text="editingMatrixCell?.budget_tier"></strong>
            / 压力层级：<strong x-text="editingMatrixCell?.pressure_tier"></strong>
          </div>
          
          <!-- 基础乘数配置 -->
          <div class="border-b pb-3">
            <h6 class="text-sm font-semibold themed-text-muted mb-3">📐 基础乘数配置</h6>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">Cap乘数</label>
                <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="editingMatrixCell.cap_multiplier" min="0" step="0.01">
                <small class="text-gray-400">中奖上限控制</small>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">空奖权重乘数</label>
                <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="editingMatrixCell.empty_weight_multiplier" min="0" step="0.01">
                <small class="text-gray-400">空奖权重调整</small>
              </div>
            </div>
          </div>
          
          <!-- 档位权重乘数配置（后端P0新增字段） -->
          <div class="border-b pb-3">
            <h6 class="text-sm font-semibold themed-text-muted mb-3">🎯 档位权重乘数</h6>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">高档位 (High)</label>
                <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="editingMatrixCell.high_multiplier" min="0" step="0.01">
                <small class="text-gray-400">高价值奖品权重</small>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">中档位 (Mid)</label>
                <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="editingMatrixCell.mid_multiplier" min="0" step="0.01">
                <small class="text-gray-400">中价值奖品权重</small>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">低档位 (Low)</label>
                <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="editingMatrixCell.low_multiplier" min="0" step="0.01">
                <small class="text-gray-400">低价值奖品权重</small>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">兜底档位 (Fallback)</label>
                <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="editingMatrixCell.fallback_multiplier" min="0" step="0.01">
                <small class="text-gray-400">兜底/谢谢参与权重</small>
              </div>
            </div>
          </div>
          
          <!-- 描述 -->
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">配置说明</label>
            <textarea class="w-full px-3 py-2 border rounded" x-model="editingMatrixCell.description" rows="2" placeholder="可选的配置说明"></textarea>
          </div>
        </div>
        <div class="p-4 border-t flex justify-end space-x-2 sticky bottom-0 themed-card">
          <button type="button" class="px-4 py-2 border rounded themed-hover-bg" @click="hideModal('matrixEditModal')">取消</button>
          <button type="submit" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" :disabled="saving">保存配置</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 策略编辑 Modal -->
  <div x-ref="strategyEditModal" x-show="isModalOpen('strategyEditModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('strategyEditModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center sticky top-0 themed-card z-10">
        <h5 class="font-semibold">⚙️ <span x-text="isStrategyEditMode ? '编辑策略配置' : '新增策略配置'"></span></h5>
        <button @click="hideModal('strategyEditModal')" class="text-gray-400 hover:themed-text-muted text-xl">&times;</button>
      </div>
      <form @submit.prevent="submitStrategyConfig()">
        <div class="p-4 space-y-4">
          <!-- 分组选择 -->
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">配置分组 <span class="text-red-500">*</span></label>
            <select class="w-full px-3 py-2 border rounded themed-border" x-model="editingStrategy.config_group" required>
              <option value="">请选择分组</option>
              <template x-for="opt in getConfigGroupOptions()" :key="opt.value">
                <option :value="opt.value" x-text="opt.label"></option>
              </template>
            </select>
          </div>
          <!-- 配置键名 -->
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">配置键名 <span class="text-red-500">*</span></label>
            <input type="text" class="w-full px-3 py-2 border rounded themed-border" x-model="editingStrategy.config_key" required placeholder="例如: threshold_high, enabled, min_draw_count">
            <small class="text-gray-400">使用 snake_case 格式，如 empty_streak_threshold</small>
          </div>
          <!-- 值类型 -->
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">值类型</label>
            <select class="w-full px-3 py-2 border rounded themed-border" x-model="editingStrategy.value_type">
              <option value="number">数值 (number)</option>
              <option value="boolean">布尔 (boolean)</option>
              <option value="string">字符串 (string)</option>
              <option value="object">对象 (JSON object)</option>
              <option value="array">数组 (JSON array)</option>
            </select>
          </div>
          <!-- 配置值 -->
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">配置值 <span class="text-red-500">*</span></label>
            <template x-if="editingStrategy.value_type === 'boolean'">
              <select class="w-full px-3 py-2 border rounded themed-border" x-model="editingStrategy.config_value">
                <option value="true">是 (true)</option>
                <option value="false">否 (false)</option>
              </select>
            </template>
            <template x-if="editingStrategy.value_type === 'number'">
              <input type="number" class="w-full px-3 py-2 border rounded themed-border" x-model="editingStrategy.config_value" step="any" required>
            </template>
            <template x-if="editingStrategy.value_type === 'object' || editingStrategy.value_type === 'array'">
              <textarea class="w-full px-3 py-2 border rounded themed-border font-mono text-sm" x-model="editingStrategy.config_value" rows="4" required placeholder='{"key": "value"}'></textarea>
            </template>
            <template x-if="editingStrategy.value_type === 'string'">
              <input type="text" class="w-full px-3 py-2 border rounded themed-border" x-model="editingStrategy.config_value" required>
            </template>
          </div>
          <!-- 描述 -->
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">描述说明</label>
            <textarea class="w-full px-3 py-2 border rounded themed-border" x-model="editingStrategy.description" rows="2" placeholder="简要说明此配置项的用途和影响"></textarea>
          </div>
          <!-- 优先级和启用状态 -->
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">优先级</label>
              <input type="number" class="w-full px-3 py-2 border rounded themed-border" x-model.number="editingStrategy.priority" min="0" step="1">
              <small class="text-gray-400">数值越大优先级越高</small>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">启用状态</label>
              <div class="flex items-center gap-3 mt-2">
                <button type="button"
                  @click="editingStrategy.is_active = !editingStrategy.is_active"
                  class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors"
                  :class="editingStrategy.is_active ? 'bg-green-500' : 'bg-gray-300'">
                  <span class="inline-block h-4 w-4 rounded-full bg-white shadow transform transition-transform" :class="editingStrategy.is_active ? 'translate-x-6' : 'translate-x-1'"></span>
                </button>
                <span class="text-sm" x-text="editingStrategy.is_active ? '启用' : '禁用'"></span>
              </div>
            </div>
          </div>
        </div>
        <div class="p-4 border-t flex justify-end space-x-2 sticky bottom-0 themed-card">
          <button type="button" class="px-4 py-2 border rounded themed-hover-bg" @click="hideModal('strategyEditModal')">取消</button>
          <button type="submit" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" :disabled="saving">
            <span x-show="saving">保存中...</span>
            <span x-show="!saving" x-text="isStrategyEditMode ? '保存修改' : '创建配置'"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 配额表单 Modal -->
  <div x-ref="quotaModal" x-show="isModalOpen('quotaModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('quotaModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-md w-full mx-4">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">📊 新增配额规则</h5>
        <button @click="hideModal('quotaModal')" class="text-gray-400 hover:themed-text-muted">&times;</button>
      </div>
      <form @submit.prevent="submitQuotaForm()">
        <div class="p-4 space-y-4">
          <!-- 规则类型选择 -->
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">规则类型 <span class="text-red-500">*</span></label>
            <select class="w-full px-3 py-2 border rounded" x-model="quotaForm.rule_type">
              <option value="global">全局（所有活动）</option>
              <option value="campaign">指定活动</option>
              <option value="role">指定角色</option>
              <option value="user">指定用户</option>
            </select>
          </div>
          
          <!-- 活动选择（campaign类型时显示） -->
          <div x-show="quotaForm.rule_type === 'campaign'">
            <label class="block text-sm font-medium themed-text-secondary mb-1">选择活动 <span class="text-red-500">*</span></label>
            <select class="w-full px-3 py-2 border rounded" x-model="quotaForm.campaign_id">
              <option value="">请选择活动...</option>
              <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
                <option :value="campaign.lottery_campaign_id" x-text="campaign.campaign_name + ' (#' + campaign.lottery_campaign_id + ')'"></option>
              </template>
            </select>
          </div>
          
          <!-- 角色UUID（role类型时显示） -->
          <div x-show="quotaForm.rule_type === 'role'">
            <label class="block text-sm font-medium themed-text-secondary mb-1">角色UUID <span class="text-red-500">*</span></label>
            <input type="text" class="w-full px-3 py-2 border rounded" x-model="quotaForm.role_uuid" placeholder="输入角色UUID">
          </div>
          
          <!-- 目标用户手机号（user类型时显示） -->
          <div x-show="quotaForm.rule_type === 'user'">
            <label class="block text-sm font-medium themed-text-secondary mb-1">目标用户手机号 <span class="text-red-500">*</span></label>
            <input type="text" class="w-full px-3 py-2 border rounded" x-model="quotaForm.target_mobile" maxlength="11" placeholder="输入手机号">
            <template x-if="resolvedUser && quotaForm.rule_type === 'user'">
              <p class="text-xs text-green-600 mt-1">✅ <span x-text="resolvedUser.nickname"></span> (<span x-text="resolvedUser.mobile"></span>)</p>
            </template>
            <template x-if="resolveError && quotaForm.rule_type === 'user'">
              <p class="text-xs text-red-500 mt-1" x-text="resolveError"></p>
            </template>
          </div>
          
          <!-- 每日抽奖次数限制 -->
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">每日抽奖次数上限 <span class="text-red-500">*</span></label>
            <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="quotaForm.limit_value" min="1" required>
            <p class="text-xs themed-text-muted mt-1">用户每天可抽奖的最大次数</p>
          </div>
          
          <!-- 创建原因 -->
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">创建原因</label>
            <input type="text" class="w-full px-3 py-2 border rounded" x-model="quotaForm.reason" placeholder="可选，用于记录创建此规则的原因">
          </div>
        </div>
        <div class="p-4 border-t flex justify-end space-x-2">
          <button type="button" class="px-4 py-2 border rounded themed-hover-bg" @click="hideModal('quotaModal')">取消</button>
          <button type="submit" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" :disabled="saving">
            创建配额
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 核销码详情 Modal -->
  <div x-ref="redemptionDetailModal" x-show="isModalOpen('redemptionDetailModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('redemptionDetailModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-md w-full mx-4">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">ℹ️ 核销码详情</h5>
        <button @click="hideModal('redemptionDetailModal')" class="text-gray-400 hover:themed-text-muted">&times;</button>
      </div>
      <div class="p-4" x-show="redemptionDetail">
        <div class="text-center mb-4">
          <code class="themed-bg-subtle px-3 py-2 rounded text-lg" :title="redemptionDetail?.code_hash || ''" x-text="getCodeDisplay(redemptionDetail?.code_hash)"></code>
          <br><small class="text-gray-400" x-text="'订单ID: ' + (redemptionDetail?.order_id || '-')"></small>
        </div>
        <table class="w-full text-sm">
          <tr class="border-b"><th class="py-2 text-left w-1/3">状态</th><td class="py-2"><span class="px-2 py-1 text-xs rounded" :class="getRedemptionStatusClass(redemptionDetail?.status)" x-text="redemptionDetail?.status_display || redemptionDetail?.status"></span></td></tr>
          <tr class="border-b"><th class="py-2 text-left">核销用户ID</th><td class="py-2" x-text="redemptionDetail?.redeemer_user_id || '-'"></td></tr>
          <tr class="border-b"><th class="py-2 text-left">核销用户</th><td class="py-2" x-text="getRedeemerName(redemptionDetail) || '-'"></td></tr>
          <tr class="border-b"><th class="py-2 text-left">物品类型</th><td class="py-2" x-text="redemptionDetail?.item_instance?.item_type || '-'"></td></tr>
          <tr class="border-b"><th class="py-2 text-left">奖品名称</th><td class="py-2" x-text="getRedemptionPrizeName(redemptionDetail)"></td></tr>
          <tr class="border-b"><th class="py-2 text-left">活动</th><td class="py-2" x-text="getRedemptionCampaignName(redemptionDetail)"></td></tr>
          <tr class="border-b"><th class="py-2 text-left">创建时间</th><td class="py-2" x-text="formatDateOnly(redemptionDetail?.created_at)"></td></tr>
          <tr class="border-b"><th class="py-2 text-left">有效期至</th><td class="py-2" x-text="formatDateOnly(redemptionDetail?.expires_at)"></td></tr>
          <template x-if="redemptionDetail?.status === 'fulfilled' || redemptionDetail?.status === 'redeemed'">
            <tr class="border-b"><th class="py-2 text-left">核销时间</th><td class="py-2" x-text="formatDateOnly(redemptionDetail?.fulfilled_at)"></td></tr>
          </template>
        </table>
      </div>
      <div class="p-4 border-t flex justify-end">
        <button type="button" class="px-4 py-2 border rounded themed-hover-bg" @click="hideModal('redemptionDetailModal')">关闭</button>
      </div>
    </div>
  </div>

  <!-- 手动核销 Modal -->
  <div x-ref="redeemModal" x-show="isModalOpen('redeemModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('redeemModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-md w-full mx-4">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">✅ 手动核销</h5>
        <button @click="hideModal('redeemModal')" class="text-gray-400 hover:themed-text-muted">&times;</button>
      </div>
      <form @submit.prevent="submitRedeem()">
        <div class="p-4 space-y-4">
          <div class="text-center">
            <code class="themed-bg-subtle px-3 py-2 rounded text-lg" x-text="redeemForm.code_display"></code>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">核销门店</label>
            <select class="w-full px-3 py-2 border rounded" x-model="redeemForm.store_id">
              <option value="">请选择门店</option>
              <template x-for="s in stores" :key="s.store_id">
                <option :value="s.store_id" x-text="s.store_name"></option>
              </template>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">备注</label>
            <textarea class="w-full px-3 py-2 border rounded" x-model="redeemForm.remark" rows="2" placeholder="核销备注（选填）"></textarea>
          </div>
        </div>
        <div class="p-4 border-t flex justify-end space-x-2">
          <button type="button" class="px-4 py-2 border rounded themed-hover-bg" @click="hideModal('redeemModal')">取消</button>
          <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600" :disabled="submitting">
            <span x-show="submitting">核销中...</span>
            <span x-show="!submitting">确认核销</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ==================== 定价配置编辑模态框 ==================== -->
  <div x-ref="pricingModal" x-show="isModalOpen('pricingModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('pricingModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">💵 <span x-text="isEditPricing ? '编辑定价配置' : '创建定价配置'"></span></h5>
        <button @click="hideModal('pricingModal')" class="text-gray-400 hover:themed-text-muted">&times;</button>
      </div>
      <form @submit.prevent="savePricing()">
        <div class="p-4 space-y-4 overflow-y-auto flex-1">
          <div class="bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 text-xs text-blue-700">
            ℹ️ 定价配置是每活动独立的（非全局），每个 lottery_campaign 有自己的定价配置
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">活动代码 <span class="text-red-500">*</span></label>
            <select class="w-full px-3 py-2 border rounded" x-model="pricingForm.campaign_code" :disabled="isEditPricing" required>
              <option value="">请选择活动</option>
              <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
                <option :value="campaign.campaign_code" x-text="campaign.campaign_name + ' (' + campaign.campaign_code + ')'"></option>
              </template>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">单抽基础价格 (base_cost) <span class="text-red-500">*</span></label>
            <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="pricingForm.base_cost" min="1" step="1" required>
            <p class="text-xs themed-text-muted mt-1">单位：积分，折扣前的基础定价</p>
          </div>

          <!-- 连抽档位配置 - 每个按钮独立折扣，每活动独立配置 -->
          <div>
            <div class="flex justify-between items-center mb-2">
              <div>
                <label class="block text-sm font-medium themed-text-secondary">连抽档位配置 <span class="text-red-500">*</span></label>
                <span class="text-xs themed-text-muted">档位范围：1-20 次 · 已配置 <span class="font-semibold themed-text-primary" x-text="pricingForm.draw_buttons.length"></span>/20</span>
              </div>
              <button type="button" class="text-xs px-2 py-1 themed-bg-primary text-white rounded themed-hover-primary" 
                      @click="addDrawButton()" 
                      :disabled="pricingForm.draw_buttons.length >= 20"
                      :class="pricingForm.draw_buttons.length >= 20 ? 'opacity-50 cursor-not-allowed' : ''">+ 添加档位</button>
            </div>
            <p class="text-xs themed-text-muted mb-3">每个档位可设置独立的折扣率，1.0=无折扣，0.95=九五折，0.9=九折</p>

            <div class="space-y-2">
              <div class="grid grid-cols-12 gap-2 text-xs font-medium themed-text-muted px-1">
                <div class="col-span-2">次数</div>
                <div class="col-span-3">折扣率</div>
                <div class="col-span-3">折后单价</div>
                <div class="col-span-2">启用</div>
                <div class="col-span-2">操作</div>
              </div>

              <template x-for="(btn, index) in pricingForm.draw_buttons" :key="index">
                <div class="grid grid-cols-12 gap-2 items-center border rounded p-2 themed-bg-base">
                  <div class="col-span-2">
                    <input type="number" class="w-full px-2 py-1 border rounded text-sm text-center" x-model.number="btn.count" min="1" max="20" required>
                  </div>
                  <div class="col-span-3">
                    <input type="number" class="w-full px-2 py-1 border rounded text-sm" x-model.number="btn.discount" min="0.01" max="1" step="0.01" required>
                  </div>
                  <div class="col-span-3 text-sm text-center">
                    <span class="font-medium" :class="btn.discount < 1 ? 'text-red-500' : 'themed-text-primary'" x-text="pricingForm.base_cost > 0 ? Math.floor(pricingForm.base_cost * btn.count * btn.discount) + ' 积分' : '-'"></span>
                    <template x-if="btn.discount < 1 && pricingForm.base_cost > 0">
                      <span class="text-xs themed-text-muted ml-1" x-text="'省' + (pricingForm.base_cost * btn.count - Math.floor(pricingForm.base_cost * btn.count * btn.discount))"></span>
                    </template>
                  </div>
                  <div class="col-span-2 text-center">
                    <input type="checkbox" class="rounded" x-model="btn.enabled">
                  </div>
                  <div class="col-span-2 text-center">
                    <button type="button" class="text-red-400 hover:text-red-600 text-xs" @click="removeDrawButton(index)" :disabled="pricingForm.draw_buttons.length <= 1">✕ 删除</button>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
        <div class="p-4 border-t flex justify-end space-x-2">
          <button type="button" class="px-4 py-2 border rounded themed-hover-bg" @click="hideModal('pricingModal')">取消</button>
          <button type="submit" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" :disabled="saving">
            <span x-show="saving">保存中...</span>
            <span x-show="!saving" x-text="isEditPricing ? '保存修改' : '创建配置'"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ==================== 定价版本历史模态框 ==================== -->
  <div x-ref="pricingVersionsModal" x-show="isModalOpen('pricingVersionsModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('pricingVersionsModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">📋 定价版本历史 - <span x-text="selectedPricingCampaign?.campaign_name || ''"></span></h5>
        <button @click="hideModal('pricingVersionsModal')" class="text-gray-400 hover:themed-text-muted">&times;</button>
      </div>
      <div class="p-4 overflow-y-auto flex-1">

          <div x-show="pricingVersions.length === 0" class="text-center py-8 themed-text-muted">
            <p>暂无版本历史记录</p>
          </div>

        <div class="space-y-3">
          <template x-for="version in pricingVersions" :key="version.version">
            <div class="border rounded-lg p-4">
              <div class="flex justify-between items-start">
                <div>
                  <div class="flex items-center space-x-2">
                    <span class="font-semibold themed-text-primary" x-text="'v' + version.version"></span>
                    <span class="px-2 py-0.5 text-xs rounded" 
                          :class="version.status === 'active' ? 'bg-green-100 themed-text-success' : 'themed-bg-subtle themed-text-muted'"
                          x-text="version.status_display || version.status"></span>
                  </div>
                  <div class="text-sm themed-text-muted mt-1">
                    <span>创建时间: </span><span x-text="formatDateTimeShort(version.created_at)"></span>
                  </div>
                  <div class="text-sm themed-text-muted">
                    <span>基础价格: </span><span x-text="(version.pricing_config?.base_cost || version.base_cost || '-') + ' 积分'"></span>
                  </div>
                </div>
                <div class="flex space-x-2">
                  <template x-if="version.status !== 'active'">
                    <button class="px-3 py-1 text-sm bg-green-500 text-white rounded hover:bg-green-600" 
                            @click="activatePricing(selectedPricingCampaign, version.version)">
                      激活
                    </button>
                  </template>
                  <template x-if="version.status !== 'archived'">
                    <button class="px-3 py-1 text-sm bg-gray-500 text-white rounded hover:bg-gray-600" 
                            @click="archivePricing(selectedPricingCampaign, version.version)">
                      归档
                    </button>
                  </template>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>
      <div class="p-4 border-t">
        <button type="button" class="w-full px-4 py-2 border rounded themed-hover-bg" @click="hideModal('pricingVersionsModal')">关闭</button>
      </div>
    </div>
  </div>

    <!-- ==================== 用户抽奖档案模态框 ==================== -->
    <div x-show="showUserProfileModal" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
      <div class="fixed inset-0 bg-black bg-opacity-50" @click="closeUserProfileModal()"></div>
      <div class="relative themed-card rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
        <!-- 模态框头部 -->
        <div class="p-4 border-b flex justify-between items-center themed-bg-primary text-white rounded-t-lg">
          <h5 class="font-semibold text-lg flex items-center gap-2">
            👤 用户抽奖档案
            <span x-show="userProfile" class="text-sm font-normal opacity-80" x-text="'#' + (userProfile?.user_id || '')"></span>
          </h5>
          <button @click="closeUserProfileModal()" class="text-white hover:text-gray-200 text-2xl">&times;</button>
        </div>

        <!-- 加载状态 -->
        <template x-if="loadingUserProfile">
          <div class="flex-1 flex items-center justify-center py-20">
            <div class="text-center">
              <svg class="animate-spin h-10 w-10 text-blue-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
              </svg>
              <p class="themed-text-muted">加载用户档案中...</p>
            </div>
          </div>
        </template>

        <!-- 无数据状态 -->
        <template x-if="!loadingUserProfile && !userProfile">
          <div class="flex-1 flex items-center justify-center py-20">
            <div class="text-center">
              <div class="text-6xl mb-4">🔍</div>
              <h3 class="text-lg font-medium themed-text mb-2">未找到用户数据</h3>
              <p class="themed-text-muted text-sm">请确认手机号是否正确</p>
            </div>
          </div>
        </template>

        <!-- 档案内容 -->
        <template x-if="!loadingUserProfile && userProfile">
          <div class="flex-1 overflow-y-auto p-6 space-y-6">
            <!-- 用户基本信息 -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <div class="themed-card rounded-lg p-4 border">
                <div class="text-sm themed-text-muted mb-1">用户昵称</div>
                <div class="font-semibold" x-text="userProfile.nickname || '-'"></div>
              </div>
              <div class="themed-card rounded-lg p-4 border">
                <div class="text-sm themed-text-muted mb-1">手机号</div>
                <div class="font-semibold" x-text="userProfile.mobile || '-'"></div>
              </div>
              <div class="themed-card rounded-lg p-4 border">
                <div class="text-sm themed-text-muted mb-1">注册时间</div>
                <div class="font-semibold text-sm" x-text="formatProfileTime(userProfile.created_at)"></div>
              </div>
              <div class="themed-card rounded-lg p-4 border">
                <div class="text-sm themed-text-muted mb-1">用户ID</div>
                <div class="font-semibold text-sm" x-text="userProfile.user_id || '-'"></div>
              </div>
            </div>

            <!-- 抽奖统计 -->
            <div class="themed-card rounded-lg shadow">
              <div class="p-4 border-b">
                <h6 class="font-semibold">📊 抽奖统计概览</h6>
              </div>
              <div class="p-4">
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
                  <div>
                    <div class="text-3xl font-bold themed-text-primary" x-text="userDrawStats.total_draws">0</div>
                    <div class="text-sm themed-text-muted">总抽奖次数</div>
                  </div>
                  <div>
                    <div class="text-3xl font-bold text-green-600" x-text="userDrawStats.total_wins">0</div>
                    <div class="text-sm themed-text-muted">中奖次数</div>
                  </div>
                  <div>
                    <div class="text-3xl font-bold text-yellow-600" x-text="userDrawStats.win_rate + '%'">0%</div>
                    <div class="text-sm themed-text-muted">中奖率</div>
                  </div>
                  <div>
                    <div class="text-3xl font-bold text-cyan-600" x-text="(userDrawStats.total_cost_points || 0).toLocaleString()">0</div>
                    <div class="text-sm themed-text-muted">消耗积分</div>
                  </div>
                  <div>
                    <div class="text-sm font-semibold themed-text" x-text="formatProfileTime(userDrawStats.lastDrawTime) || '-'">-</div>
                    <div class="text-sm themed-text-muted">最近抽奖</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 体验状态 -->
            <template x-if="userExperienceState">
              <div class="themed-card rounded-lg shadow">
                <div class="p-4 border-b">
                  <h6 class="font-semibold">🎯 体验阶段状态</h6>
                </div>
                <div class="p-4">
                  <div class="flex items-center gap-4">
                    <span class="px-3 py-1.5 rounded-full text-sm font-medium" 
                          :class="getProfilePhaseClass(userExperienceState.current_phase)"
                          x-text="userExperienceState.current_phase_display || userExperienceState.current_phase"></span>
                    <span class="text-sm themed-text-muted">
                      连续无奖: <span class="font-medium" x-text="userExperienceState.consecutive_no_win || 0"></span> 次
                    </span>
                    <span class="text-sm themed-text-muted">
                      今日抽奖: <span class="font-medium" x-text="userExperienceState.today_draws || 0"></span> 次
                    </span>
                  </div>
                </div>
              </div>
            </template>

            <!-- 抽奖历史 -->
            <div class="themed-card rounded-lg shadow">
              <div class="p-4 border-b flex justify-between items-center">
                <h6 class="font-semibold">📋 最近抽奖记录</h6>
                <span class="text-sm themed-text-muted" x-text="'共 ' + userDrawHistory.length + ' 条'"></span>
              </div>
              <div class="overflow-x-auto max-h-64">
                <table class="w-full">
                  <thead class="themed-bg-base sticky top-0">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-medium themed-text-muted uppercase">时间</th>
                      <th class="px-4 py-3 text-left text-xs font-medium themed-text-muted uppercase">活动</th>
                      <th class="px-4 py-3 text-left text-xs font-medium themed-text-muted uppercase">结果</th>
                      <th class="px-4 py-3 text-left text-xs font-medium themed-text-muted uppercase">档位</th>
                      <th class="px-4 py-3 text-left text-xs font-medium themed-text-muted uppercase">价值</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y">

                      <tr x-show="userDrawHistory.length === 0">
                        <td colspan="5" class="px-4 py-8 text-center themed-text-muted">暂无抽奖记录</td>
                      </tr>

                    <template x-for="(draw, index) in userDrawHistory" :key="index">
                      <tr class="themed-hover-bg">
                        <td class="px-4 py-3 text-sm themed-text-muted" x-text="formatProfileTime(draw.created_at)"></td>
                        <td class="px-4 py-3 text-sm" x-text="draw.campaign_name"></td>
                        <td class="px-4 py-3 text-sm">
                          <span class="px-2 py-1 rounded text-xs" 
                                :class="draw.is_win ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'"
                                x-text="draw.prize_name || '-'"></span>
                        </td>
                        <td class="px-4 py-3 text-sm" x-text="draw.reward_tier || '-'"></td>
                        <td class="px-4 py-3 text-sm" x-text="draw.prize_value_points ? draw.prize_value_points + '积分' : '-'"></td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </template>

        <!-- 模态框底部 -->
        <div class="p-4 border-t bg-gray-50">
          <button type="button" class="w-full px-4 py-2 themed-bg-primary text-white rounded-lg themed-hover-primary" @click="closeUserProfileModal()">
            关闭
          </button>
        </div>
      </div>
    </div>

    <!-- ==================== P2新增: 运营日报模态框 ==================== -->
    <div x-show="showDailyReportModal" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
      <div class="fixed inset-0 bg-black bg-opacity-50" @click="closeDailyReportModal()"></div>
      <div class="relative themed-card rounded-lg shadow-xl max-w-5xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
        <!-- 模态框头部 -->
        <div class="p-4 border-b flex justify-between items-center bg-gradient-to-r from-purple-500 to-indigo-600 text-white">
          <h5 class="font-semibold text-lg flex items-center gap-2">
            📊 运营日报
            <span class="text-sm font-normal opacity-90" x-text="dailyReportDate"></span>
          </h5>
          <div class="flex items-center gap-2">
            <button class="p-2 hover:bg-white/20 rounded" @click="changeDailyReportDate(-1)" :disabled="loadingDailyReport">
              ⬅️
            </button>
            <button class="p-2 hover:bg-white/20 rounded" @click="changeDailyReportDate(1)" :disabled="loadingDailyReport">
              ➡️
            </button>
            <button class="p-2 hover:bg-white/20 rounded" @click="closeDailyReportModal()">✕</button>
          </div>
        </div>

        <!-- 模态框内容 -->
        <div class="flex-1 overflow-y-auto p-6" x-show="dailyReportData && !loadingDailyReport">
          <!-- 汇总卡片 -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="themed-card rounded-lg p-4 text-center">
              <div class="text-2xl mb-1">🎲</div>
              <div class="text-xs themed-text-muted mb-1">抽奖次数</div>
              <div class="text-xl font-bold themed-text-primary" x-text="dailyReportData?.summary?.total_draws?.toLocaleString() || 0"></div>
              <div class="text-xs mt-1" 
                   :class="getChangeColorClass(dailyReportData?.vs_yesterday?.draws_change)"
                   x-text="'vs昨日 ' + formatReportChange(dailyReportData?.vs_yesterday?.draws_change)"></div>
            </div>
            <div class="themed-card rounded-lg p-4 text-center">
              <div class="text-2xl mb-1">🎯</div>
              <div class="text-xs themed-text-muted mb-1">中奖率</div>
              <div class="text-xl font-bold text-green-600" x-text="(dailyReportData?.summary?.win_rate || 0).toFixed(1) + '%'"></div>
              <div class="text-xs mt-1" 
                   :class="getChangeColorClass(dailyReportData?.vs_yesterday?.wins_change)"
                   x-text="'vs昨日 ' + formatReportChange(dailyReportData?.vs_yesterday?.wins_change)"></div>
            </div>
            <div class="themed-card rounded-lg p-4 text-center">
              <div class="text-2xl mb-1">💰</div>
              <div class="text-xs themed-text-muted mb-1">收入</div>
              <div class="text-xl font-bold text-blue-600" x-text="'¥' + (dailyReportData?.summary?.total_revenue || 0).toLocaleString()"></div>
              <div class="text-xs mt-1" 
                   :class="getChangeColorClass(dailyReportData?.vs_yesterday?.revenue_change)"
                   x-text="'vs昨日 ' + formatReportChange(dailyReportData?.vs_yesterday?.revenue_change)"></div>
            </div>
            <div class="themed-card rounded-lg p-4 text-center">
              <div class="text-2xl mb-1">📈</div>
              <div class="text-xs themed-text-muted mb-1">ROI</div>
              <div class="text-xl font-bold"
                   :class="(dailyReportData?.summary?.roi || 0) >= 0 ? 'text-green-600' : 'text-red-600'" 
                   x-text="((dailyReportData?.summary?.roi || 0) >= 0 ? '+' : '') + (dailyReportData?.summary?.roi || 0).toFixed(1) + '%'"></div>
              <div class="text-xs mt-1" 
                   :class="getChangeColorClass(dailyReportData?.vs_yesterday?.roi_change)"
                   x-text="'vs昨日 ' + formatReportChange(dailyReportData?.vs_yesterday?.roi_change)"></div>
            </div>
          </div>

          <!-- 告警列表 -->
          <template x-if="dailyReportData?.alerts?.length > 0">
            <div class="mb-6">
              <h6 class="font-semibold text-sm mb-3 flex items-center gap-2">
                🚨 告警 (<span x-text="dailyReportData?.alerts?.length || 0"></span>)
              </h6>
              <div class="space-y-2">
                <template x-for="(alert, index) in dailyReportData.alerts" :key="index">
                  <div class="p-3 rounded-lg border" :class="getAlertLevelClass(alert.level)">
                    <div class="flex items-center gap-2">
                      <span x-text="getAlertLevelIcon(alert.level)"></span>
                      <span class="font-medium text-sm" x-text="alert.message"></span>
                    </div>
                    <div class="text-xs mt-1 opacity-75" x-text="alert.suggestion || ''"></div>
                  </div>
                </template>
              </div>
            </div>
          </template>

          <!-- 24小时分布 -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- 小时分布 -->
            <div class="themed-card rounded-lg p-4">
              <h6 class="font-semibold text-sm mb-3">📊 24小时分布</h6>
              <div class="flex flex-wrap gap-1">
                <template x-for="(hour, index) in dailyReportData?.hourly_breakdown || []" :key="index">
                  <div class="flex flex-col items-center text-xs">
                    <div class="w-4 rounded-t" 
                         :style="'height: ' + Math.max(2, (hour.draws / Math.max(...(dailyReportData?.hourly_breakdown || []).map(h => h.draws || 1)) * 40)) + 'px'"
                         :class="index === new Date().getHours() ? 'bg-blue-500' : 'bg-gray-300'"></div>
                    <span class="themed-text-muted" x-text="index"></span>
                  </div>
                </template>
              </div>
              <div class="mt-2 text-xs themed-text-muted text-center">
                峰值时段: <span class="font-bold" x-text="(dailyReportData?.hourly_breakdown || []).reduce((max, h) => h.draws > (max?.draws || 0) ? h : max, {})?.hour + ':00' || '-'"></span>
              </div>
            </div>

            <!-- 热门奖品 -->
            <div class="themed-card rounded-lg p-4">
              <h6 class="font-semibold text-sm mb-3">🏆 热门奖品 Top5</h6>
              <div class="space-y-2">
                <template x-for="(prize, index) in (dailyReportData?.top_prizes || []).slice(0, 5)" :key="index">
                  <div class="flex items-center gap-2">
                    <span class="w-5 h-5 flex items-center justify-center rounded-full text-xs font-bold"
                          :class="index < 3 ? ['bg-yellow-400', 'bg-gray-300', 'bg-amber-600'][index] + ' text-white' : 'bg-gray-100 text-gray-600'"
                          x-text="index + 1"></span>
                    <span class="flex-1 text-sm truncate" x-text="prize.prize_name"></span>
                    <span class="text-sm font-bold text-blue-600" x-text="prize.win_count + '次'"></span>
                  </div>
                </template>
                <template x-if="!dailyReportData?.top_prizes?.length">
                  <div class="text-center text-sm themed-text-muted py-4">暂无数据</div>
                </template>
              </div>
            </div>
          </div>

          <!-- 档位分布 -->
          <div class="themed-card rounded-lg p-4 mb-6">
            <h6 class="font-semibold text-sm mb-3">📊 档位分布</h6>
            <div class="flex flex-wrap gap-3">
              <template x-for="tier in dailyReportData?.tier_breakdown || []" :key="tier.tier">
                <div class="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded-lg">
                  <span class="text-sm font-medium" x-text="tier.tier"></span>
                  <span class="text-sm text-blue-600 font-bold" x-text="tier.count + '次'"></span>
                  <span class="text-xs themed-text-muted" x-text="'(成本: ' + (tier.cost || 0) + ')'"></span>
                </div>
              </template>
            </div>
          </div>

          <!-- 活动分布 -->
          <template x-if="dailyReportData?.campaigns_breakdown?.length > 0">
            <div class="themed-card rounded-lg p-4">
              <h6 class="font-semibold text-sm mb-3">🎁 活动分布</h6>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="themed-bg-base">
                    <tr>
                      <th class="px-3 py-2 text-left">活动名称</th>
                      <th class="px-3 py-2 text-right">抽奖次数</th>
                      <th class="px-3 py-2 text-right">中奖次数</th>
                      <th class="px-3 py-2 text-right">中奖率</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y">
                    <template x-for="campaign in dailyReportData.campaigns_breakdown" :key="campaign.lottery_campaign_id">
                      <tr class="themed-hover-bg">
                        <td class="px-3 py-2" x-text="campaign.campaign_name"></td>
                        <td class="px-3 py-2 text-right" x-text="campaign.draws?.toLocaleString() || 0"></td>
                        <td class="px-3 py-2 text-right" x-text="campaign.wins?.toLocaleString() || 0"></td>
                        <td class="px-3 py-2 text-right" x-text="(campaign.win_rate || 0).toFixed(1) + '%'"></td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>
          </template>
        </div>

        <!-- 加载状态 -->
        <div class="flex-1 flex items-center justify-center p-12" x-show="loadingDailyReport">
          <div class="text-center">
            <div class="animate-spin w-8 h-8 border-4 border-purple-500 border-t-transparent rounded-full mx-auto mb-3"></div>
            <p class="themed-text-muted">正在生成日报...</p>
          </div>
        </div>

        <!-- 无数据状态 -->
        <div class="flex-1 flex items-center justify-center p-12" x-show="!dailyReportData && !loadingDailyReport">
          <div class="text-center">
            <div class="text-4xl mb-3">📭</div>
            <p class="themed-text-muted">暂无日报数据</p>
          </div>
        </div>

        <!-- 模态框底部 -->
        <div class="p-4 border-t bg-gray-50 flex justify-between items-center">
          <span class="text-xs themed-text-muted">
            生成时间: <span x-text="dailyReportData?.generated_at ? formatDateOnly(dailyReportData.generated_at) : '-'"></span>
          </span>
          <button type="button" class="px-6 py-2 themed-bg-primary text-white rounded-lg themed-hover-primary" @click="closeDailyReportModal()">
            关闭
          </button>
        </div>
      </div>
    </div>

    <!-- ==================== P3新增: 活动ROI分析仪表盘模态框 ==================== -->
    <div x-show="showCampaignRoiModal" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
      <div class="fixed inset-0 bg-black bg-opacity-50" @click="closeCampaignRoiModal()"></div>
      <div class="relative themed-card rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
        <!-- 模态框头部 -->
        <div class="p-4 border-b flex justify-between items-center bg-gradient-to-r from-emerald-500 to-teal-600 text-white">
          <h5 class="font-semibold text-lg flex items-center gap-2">
            📊 活动效果分析
            <span class="text-sm font-normal opacity-90" x-text="selectedCampaign?.campaign_name || ''"></span>
          </h5>
          <button class="p-2 hover:bg-white/20 rounded" @click="closeCampaignRoiModal()">✕</button>
        </div>

        <!-- 模态框内容 -->
        <div class="flex-1 overflow-y-auto p-6" x-show="typeof campaignRoiData !== 'undefined' && campaignRoiData && !loadingCampaignRoi">
          <!-- ROI核心指标 -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="themed-card rounded-lg p-4 text-center border-l-4 border-green-500">
              <div class="text-xs themed-text-muted mb-1">总收入</div>
              <div class="text-xl font-bold text-green-600" x-text="'¥' + (campaignRoiData?.total_revenue || 0).toLocaleString()"></div>
            </div>
            <div class="themed-card rounded-lg p-4 text-center border-l-4 border-red-500">
              <div class="text-xs themed-text-muted mb-1">总成本</div>
              <div class="text-xl font-bold text-red-600" x-text="'¥' + (campaignRoiData?.total_cost || 0).toLocaleString()"></div>
            </div>
            <div class="themed-card rounded-lg p-4 text-center border-l-4 border-blue-500">
              <div class="text-xs themed-text-muted mb-1">净利润</div>
              <div class="text-xl font-bold" 
                   :class="(campaignRoiData?.profit || 0) >= 0 ? 'text-green-600' : 'text-red-600'"
                   x-text="(campaignRoiData?.profit >= 0 ? '+¥' : '-¥') + Math.abs(campaignRoiData?.profit || 0).toLocaleString()"></div>
            </div>
            <div class="themed-card rounded-lg p-4 text-center border-l-4 border-purple-500">
              <div class="text-xs themed-text-muted mb-1">ROI</div>
              <div class="text-2xl font-bold" :class="getRoiColorClass(campaignRoiData?.roi)" x-text="formatRoiValue(campaignRoiData?.roi)"></div>
            </div>
          </div>

          <!-- 活动关键数据 -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="themed-card rounded-lg p-3 text-center">
              <div class="text-xs themed-text-muted mb-1">总抽奖次数</div>
              <div class="text-lg font-bold themed-text-primary" x-text="(campaignRoiData?.total_draws || 0).toLocaleString()"></div>
            </div>
            <div class="themed-card rounded-lg p-3 text-center">
              <div class="text-xs themed-text-muted mb-1">总中奖次数</div>
              <div class="text-lg font-bold text-green-600" x-text="(campaignRoiData?.total_wins || 0).toLocaleString()"></div>
            </div>
            <div class="themed-card rounded-lg p-3 text-center">
              <div class="text-xs themed-text-muted mb-1">中奖率</div>
              <div class="text-lg font-bold text-yellow-600" x-text="(campaignRoiData?.win_rate || 0).toFixed(1) + '%'"></div>
            </div>
            <div class="themed-card rounded-lg p-3 text-center">
              <div class="text-xs themed-text-muted mb-1">复购率</div>
              <div class="text-lg font-bold text-blue-600" x-text="(campaignRoiData?.repeat_rate || 0).toFixed(1) + '%'"></div>
            </div>
          </div>

          <!-- 档位成本明细 -->
          <template x-if="campaignRoiData?.tier_cost_breakdown?.length > 0">
            <div class="themed-card rounded-lg p-4 mb-6">
              <h6 class="font-semibold text-sm mb-3">📊 档位成本分析</h6>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="themed-bg-base">
                    <tr>
                      <th class="px-3 py-2 text-left">档位</th>
                      <th class="px-3 py-2 text-right">发放数量</th>
                      <th class="px-3 py-2 text-right">单位成本</th>
                      <th class="px-3 py-2 text-right">总成本</th>
                      <th class="px-3 py-2 text-right">占比</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y">
                    <template x-for="tier in campaignRoiData.tier_cost_breakdown" :key="tier.tier">
                      <tr class="themed-hover-bg">
                        <td class="px-3 py-2 font-medium" x-text="tier.tier"></td>
                        <td class="px-3 py-2 text-right" x-text="(tier.count || 0).toLocaleString()"></td>
                        <td class="px-3 py-2 text-right" x-text="'¥' + (tier.unit_cost || 0).toFixed(2)"></td>
                        <td class="px-3 py-2 text-right font-bold" x-text="'¥' + (tier.total_cost || 0).toLocaleString()"></td>
                        <td class="px-3 py-2 text-right">
                          <span class="inline-block w-16 bg-gray-200 rounded-full h-2 overflow-hidden">
                            <span class="block h-full bg-blue-500" :style="'width: ' + (tier.percentage || 0) + '%'"></span>
                          </span>
                          <span class="ml-1 text-xs" x-text="(tier.percentage || 0).toFixed(1) + '%'"></span>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>
          </template>

          <!-- ROI分析建议 -->
          <div class="themed-card rounded-lg p-4 themed-bg-base">
            <h6 class="font-semibold text-sm mb-3 flex items-center gap-2">
              💡 运营建议
            </h6>
            <div class="space-y-2 text-sm">
              <template x-if="(campaignRoiData?.roi || 0) > 20">
                <p class="text-green-700">✅ 活动ROI表现优秀，可以考虑增加预算或延长活动周期</p>
              </template>
              <template x-if="(campaignRoiData?.roi || 0) > 0 && (campaignRoiData?.roi || 0) <= 20">
                <p class="text-blue-700">📊 活动ROI正常，建议关注高成本档位优化空间</p>
              </template>
              <template x-if="(campaignRoiData?.roi || 0) <= 0">
                <p class="text-yellow-700">⚠️ 活动ROI为负，建议检查奖品成本配置或提高抽奖单价</p>
              </template>
              <template x-if="(campaignRoiData?.repeat_rate || 0) < 20">
                <p class="text-orange-700">🔄 复购率偏低，可通过会员专属奖品或连抽优惠提升</p>
              </template>
              <template x-if="(campaignRoiData?.win_rate || 0) > 50">
                <p class="text-cyan-700">🎯 中奖率较高，注意预算消耗速度</p>
              </template>
            </div>
          </div>
        </div>

        <!-- 加载状态 -->
        <div class="flex-1 flex items-center justify-center p-12" x-show="typeof loadingCampaignRoi !== 'undefined' && loadingCampaignRoi">
          <div class="text-center">
            <div class="animate-spin w-8 h-8 border-4 border-emerald-500 border-t-transparent rounded-full mx-auto mb-3"></div>
            <p class="themed-text-muted">正在计算ROI数据...</p>
          </div>
        </div>

        <!-- 无数据状态 -->
        <div class="flex-1 flex items-center justify-center p-12" x-show="typeof campaignRoiData !== 'undefined' && !campaignRoiData && !loadingCampaignRoi">
          <div class="text-center">
            <div class="text-4xl mb-3">📭</div>
            <p class="themed-text-muted">暂无ROI分析数据</p>
          </div>
        </div>

        <!-- 模态框底部 -->
        <div class="p-4 border-t bg-gray-50 flex justify-end">
          <button type="button" class="px-6 py-2 themed-bg-primary text-white rounded-lg themed-hover-primary" @click="closeCampaignRoiModal()">
            关闭
          </button>
        </div>
      </div>
    </div>

    </div><!-- 关闭 lotteryPageContent -->

  </div><!-- 关闭 lotteryNavigation -->

  <!-- 页面专属逻辑 -->
  <%- include('partials/footer') %>

  <script type="module" src="./src/modules/lottery/pages/lottery-management.js"></script>
</body>
</html>

