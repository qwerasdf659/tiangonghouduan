<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '抽奖管理中心', 
    pageStyle: '[x-cloak] { display: none !important; }' 
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen">
  
  <!-- 导航栏 -->
  <nav class="themed-bg-primary text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="hover:text-blue-200">← 返回工作台</a>
        <span class="text-lg font-semibold">🎁 抽奖管理中心</span>
      </div>
    </div>
  </nav>

  <!-- 页面主体 -->
  <div class="container mx-auto px-4 py-6" x-data="lotteryNavigation()" x-init="init()">
    
    <!-- 子页面导航 -->
    <div class="themed-card rounded-lg shadow mb-6">
      <div class="flex flex-wrap">
        <template x-for="subPage in subPages" :key="subPage.id">
          <button 
            @click="switchPage(subPage.id)"
            :class="current_page === subPage.id ? 'border-b-2 border-blue-500 text-blue-600 bg-blue-50' : 'themed-text-muted themed-hover-bg border-b themed-border'"
            class="px-5 py-3 font-medium whitespace-nowrap transition-colors"
          >
            <span x-text="subPage.icon"></span>
            <span x-text="subPage.title"></span>
          </button>
        </template>
      </div>
    </div>

    <!-- 页面内容区域 -->
    <div x-data="lotteryPageContent()" x-init="init()">
      
      <!-- ==================== 活动管理页 ==================== -->
      <div x-show="current_page === 'campaigns'" x-cloak>
        <!-- 统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl themed-text-primary mb-2">🎁</div>
            <h6 class="themed-text-muted text-sm mb-1">总活动数</h6>
            <h2 class="text-2xl font-bold themed-text-primary" x-text="campaignStats.total">-</h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-green-500 mb-2">▶️</div>
            <h6 class="themed-text-muted text-sm mb-1">进行中</h6>
            <h2 class="text-2xl font-bold text-green-600" x-text="campaignStats.active">-</h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-cyan-500 mb-2">👥</div>
            <h6 class="themed-text-muted text-sm mb-1">今日参与</h6>
            <h2 class="text-2xl font-bold text-cyan-600" x-text="campaignStats.todayParticipants">-</h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-yellow-500 mb-2">🏆</div>
            <h6 class="themed-text-muted text-sm mb-1">今日中奖</h6>
            <h2 class="text-2xl font-bold text-yellow-600" x-text="campaignStats.todayWinners">-</h2>
          </div>
        </div>

        <div class="themed-card rounded-lg shadow">
          <div class="p-4 border-b flex justify-between items-center">
            <h5 class="font-semibold">🎁 活动列表</h5>
            <button @click="openCreateCampaignModal()" class="px-4 py-2 themed-bg-primary text-white rounded hover:opacity-90 transition-colors">
              ➕ 创建活动
            </button>
          </div>
          <!-- 筛选器 -->
          <div class="p-4 border-b themed-bg-base">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <select class="px-3 py-2 border rounded" x-model="campaignFilters.status" @change="loadCampaigns()">
                <option value="">全部状态</option>
                <option value="active">进行中</option>
                <option value="inactive">已结束</option>
                <option value="pending">待开始</option>
              </select>
              <input type="text" class="px-3 py-2 border rounded" placeholder="搜索活动名称..." x-model="campaignFilters.keyword">
              <button class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" @click="loadCampaigns()">
                🔍 搜索
              </button>
            </div>
          </div>
          <!-- 活动列表 -->
          <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <!-- 骨架屏加载状态 -->
              <template x-if="loading">
                <template x-for="i in 3" :key="'skeleton-campaign-' + i">
                  <div class="border rounded-lg p-4 animate-pulse">
                    <div class="flex justify-between items-start mb-2">
                      <div class="skeleton-text w-32"></div>
                      <div class="skeleton-button-sm w-16"></div>
                    </div>
                    <div class="skeleton-text-sm mb-2"></div>
                    <div class="skeleton-text-xs w-3/4 mb-3"></div>
                    <div class="flex gap-2">
                      <div class="skeleton-button flex-1"></div>
                      <div class="skeleton-button-sm w-16"></div>
                    </div>
                  </div>
                </template>
              </template>
              <!-- 空状态 -->
              <template x-if="campaigns.length === 0 && !loading">
                <div class="col-span-3 py-12">
                  <div class="flex flex-col items-center justify-center text-center">
                    <div class="text-6xl mb-4">🎁</div>
                    <h3 class="text-lg font-medium themed-text mb-2">暂无活动数据</h3>
                    <p class="themed-text-muted text-sm mb-4">点击上方按钮创建您的第一个抽奖活动</p>
                    <button @click="openCreateCampaignModal()" class="px-4 py-2 themed-bg-primary text-white rounded-lg hover:opacity-90 transition-opacity">
                      ➕ 创建活动
                    </button>
                  </div>
                </div>
              </template>
              <!-- 数据列表 -->
              <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
                <div class="border rounded-lg p-4 hover:shadow-md transition-shadow relative">
                  <!-- 库存预警标志 -->
                  <div x-show="campaign.stock_warning?.is_warning" class="absolute -top-2 -right-2 z-10">
                    <span class="inline-flex items-center px-2 py-1 text-xs font-bold bg-red-500 text-white rounded-full animate-pulse">
                      ⚠️ 库存
                    </span>
                  </div>
                  <div class="flex justify-between items-start mb-2">
                    <h6 class="font-medium" x-text="campaign.campaign_name"></h6>
                    <span class="px-2 py-1 text-xs rounded" :class="getCampaignStatusClass(campaign.status)" x-text="getCampaignStatusText(campaign.status)"></span>
                  </div>
                  <p class="themed-text-muted text-sm mb-2 line-clamp-1" x-text="campaign.description || '暂无描述'"></p>
                  
                  <!-- P1新增: ROI/复抽率/库存预警数据条 -->
                  <div class="grid grid-cols-3 gap-2 my-3 text-center text-xs bg-gray-50 rounded-lg p-2">
                    <!-- ROI 指标 -->
                    <div class="flex flex-col items-center">
                      <span class="themed-text-muted">ROI</span>
                      <span class="font-bold"
                            :class="(campaign.roi || 0) >= 0 ? 'text-green-600' : 'text-red-600'"
                            x-text="campaign.roi !== null && campaign.roi !== undefined ? (campaign.roi >= 0 ? '+' : '') + parseFloat(campaign.roi).toFixed(1) + '%' : '-'">
                      </span>
                    </div>
                    <!-- 复抽率 -->
                    <div class="flex flex-col items-center">
                      <span class="themed-text-muted">复抽率</span>
                      <span class="font-bold text-blue-600" 
                            x-text="campaign.repeat_rate !== null && campaign.repeat_rate !== undefined ? parseFloat(campaign.repeat_rate).toFixed(1) + '%' : '-'">
                      </span>
                    </div>
                    <!-- 库存状态 -->
                    <div class="flex flex-col items-center">
                      <span class="themed-text-muted">库存</span>
                      <span class="font-bold"
                            :class="campaign.stock_warning?.is_warning ? 'text-red-600' : 'text-gray-600'"
                            x-text="campaign.stock_warning?.low_stock_count > 0 ? campaign.stock_warning.low_stock_count + '项预警' : '正常'">
                      </span>
                    </div>
                  </div>
                  
                  <div class="flex justify-between items-center text-gray-400 text-sm">
                    <span>📅 <span x-text="formatDateOnly(campaign.start_time)"></span></span>
                    <span>👥 <span x-text="campaign.participant_count || 0"></span></span>
                  </div>
                  <div class="mt-3 flex gap-2 flex-wrap">
                    <button class="flex-1 px-3 py-1 text-sm border themed-border-primary themed-text-primary rounded hover:bg-blue-50" @click="editCampaign(campaign)">
                      ✏️ 编辑
                    </button>
                    <button class="px-3 py-1 text-sm border border-cyan-500 text-cyan-500 rounded hover:bg-cyan-50" @click="viewCampaignDetail(campaign)">
                      👁️ 详情
                    </button>
                    <button class="px-3 py-1 text-sm border border-purple-500 text-purple-500 rounded hover:bg-purple-50" @click="openCampaignRoiModal(campaign)">
                      📊 分析
                    </button>
                    <button class="px-3 py-1 text-sm border border-green-500 text-green-500 rounded hover:bg-green-50" @click="openCampaignReport(campaign.lottery_campaign_id)">
                      📋 复盘
                    </button>
                    <button class="px-3 py-1 text-sm border border-yellow-500 text-yellow-500 rounded hover:bg-yellow-50" @click="toggleCampaign(campaign)" x-text="campaign.status === 'active' ? '⏸️ 停止' : '▶️ 启动'"></button>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== 奖品管理页 ==================== -->
      <div x-show="current_page === 'prizes'" x-cloak>
        <!-- P2新增: 奖品发放统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="themed-card rounded-lg shadow p-4 text-center">
            <div class="text-2xl mb-2">🎁</div>
            <h6 class="themed-text-muted text-xs mb-1">今日发放</h6>
            <h2 class="text-xl font-bold themed-text-primary" x-text="prizeIssuedStats.todayIssued || 0"></h2>
          </div>
          <div class="themed-card rounded-lg shadow p-4 text-center">
            <div class="text-2xl mb-2">💰</div>
            <h6 class="themed-text-muted text-xs mb-1">发放价值</h6>
            <h2 class="text-xl font-bold text-green-600" x-text="'¥' + (prizeIssuedStats.totalValue || 0).toLocaleString()"></h2>
          </div>
          <div class="themed-card rounded-lg shadow p-4 text-center">
            <div class="text-2xl mb-2">📦</div>
            <h6 class="themed-text-muted text-xs mb-1">奖品总数</h6>
            <h2 class="text-xl font-bold text-blue-600" x-text="prizes.length"></h2>
          </div>
          <div class="themed-card rounded-lg shadow p-4 text-center">
            <div class="text-2xl mb-2" :class="prizeIssuedStats.lowStockCount > 0 ? 'animate-pulse' : ''">⚠️</div>
            <h6 class="themed-text-muted text-xs mb-1">低库存预警</h6>
            <h2 class="text-xl font-bold" 
                :class="prizeIssuedStats.lowStockCount > 0 ? 'text-red-600' : 'text-gray-600'" 
                x-text="prizeIssuedStats.lowStockCount || 0"></h2>
          </div>
        </div>

        <!-- P2新增: 奖品发放分布（迷你版） -->
        <div x-show="prizeDistributionDetail.length > 0" class="themed-card rounded-lg shadow p-4 mb-6">
          <h6 class="font-semibold text-sm mb-3 flex items-center gap-2">
            📊 今日发放分布
            <button class="text-xs themed-text-primary" @click="loadPrizeIssuedStats()">🔄 刷新</button>
          </h6>
          <div class="flex flex-wrap gap-2">
            <template x-for="stat in prizeDistributionDetail.slice(0, 6)" :key="stat.prize_id || stat.prize_name">
              <div class="inline-flex items-center gap-1 px-3 py-1 bg-gray-100 rounded-full text-xs">
                <span x-text="stat.prize_name || '未知奖品'"></span>
                <span class="font-bold text-blue-600" x-text="(stat.issued_count || stat.count || 0) + '个'"></span>
                <span class="themed-text-muted" x-text="'(' + getPrizeIssuedPercentage(stat) + '%)'"></span>
              </div>
            </template>
            <span x-show="prizeDistributionDetail.length > 6" class="text-xs themed-text-muted self-center">
              +<span x-text="prizeDistributionDetail.length - 6"></span>更多
            </span>
          </div>
        </div>

        <div class="themed-card rounded-lg shadow">
          <div class="p-4 border-b flex justify-between items-center">
            <h5 class="font-semibold">🏆 奖品管理</h5>
            <div class="flex gap-2">
              <button @click="openBatchPrizeModal()" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary transition-colors">
                📦 批量配置奖品
              </button>
              <button @click="openCreatePrizeModal()" class="px-4 py-2 themed-btn-primary rounded transition-colors">
                ➕ 单个添加
              </button>
            </div>
          </div>
          <!-- 筛选器 -->
          <div class="p-4 border-b themed-bg-base">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
              <select class="px-3 py-2 border rounded" x-model="prizeFilters.type" @change="loadPrizes()">
                <option value="">全部类型</option>
                <option value="physical">实物奖品</option>
                <option value="virtual">虚拟奖品</option>
                <option value="coupon">优惠券</option>
              </select>
              <select class="px-3 py-2 border rounded" x-model="prizeFilters.status" @change="loadPrizes()">
                <option value="">全部状态</option>
                <option value="active">启用</option>
                <option value="inactive">禁用</option>
              </select>
              <input type="text" class="px-3 py-2 border rounded" placeholder="搜索奖品名称..." x-model="prizeFilters.keyword">
              <button class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" @click="loadPrizes()">
                🔍 搜索
              </button>
            </div>
          </div>
          <!-- 奖品表格 -->
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="themed-bg-base">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">奖品</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">类型</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">概率</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">库存</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">状态</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                <template x-if="prizes.length === 0">
                  <tr><td colspan="6" class="px-4 py-8 text-center themed-text-muted">暂无奖品数据</td></tr>
                </template>
                <template x-for="prize in prizes" :key="prize.prize_id">
                  <tr class="themed-hover-bg">
                    <td class="px-4 py-3">
                      <div class="flex items-center">
                        <div class="w-12 h-12 rounded overflow-hidden mr-3 img-blur-load">
                          <img :data-src="prize.image_url || '/admin/images/placeholder.svg'" 
                               :alt="prize.prize_name" 
                               class="w-full h-full object-cover img-lazy"
                               x-init="$nextTick(() => { $el.src = prize.image_url || '/admin/images/placeholder.svg'; $el.classList.add('loaded') })"
                               @error="$el.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><rect width=%22100%22 height=%22100%22 fill=%22%23e5e7eb%22/></svg>'">
                        </div>
                        <div>
                          <div class="font-medium" x-text="prize.prize_name"></div>
                          <small class="text-gray-400" x-text="prize.prize_id"></small>
                        </div>
                      </div>
                    </td>
                    <td class="px-4 py-3"><span class="px-2 py-1 text-xs rounded bg-cyan-100 text-cyan-700" x-text="getPrizeTypeText(prize.prize_type)"></span></td>
                    <td class="px-4 py-3 text-sm" x-text="prize.win_probability + '%'"></td>
                    <td class="px-4 py-3 text-sm" x-text="prize.stock_quantity >= 999999 ? '无限' : prize.stock_quantity"></td>
                    <td class="px-4 py-3">
                      <span class="px-2 py-1 text-xs rounded" :class="isPrizeActive(prize) ? 'bg-green-100 themed-text-success' : 'themed-bg-subtle themed-text-secondary'" x-text="isPrizeActive(prize) ? '启用' : '禁用'"></span>
                    </td>
                    <td class="px-4 py-3">
                      <div class="flex space-x-2">
                        <button class="themed-text-primary hover:text-blue-700 text-sm" @click="editPrize(prize)">编辑</button>
                        <button class="text-green-500 hover:text-green-700 text-sm" @click="openStockModal(prize)">补货</button>
                        <button class="text-yellow-500 hover:text-yellow-700 text-sm" @click="togglePrize(prize)" x-text="prize.is_active ? '禁用' : '启用'"></button>
                        <button class="text-red-500 hover:text-red-700 text-sm" @click="deletePrize(prize)">删除</button>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ==================== 预算管理页 ==================== -->
      <div x-show="current_page === 'campaign-budget'" x-cloak>
        <!-- 预算汇总卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl themed-text-primary mb-2">💰</div>
            <h6 class="themed-text-muted text-sm mb-1">总预算</h6>
            <h2 class="text-2xl font-bold themed-text-primary" x-text="'¥' + (budgetSummary.total_budget || 0).toLocaleString()">-</h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-green-500 mb-2">💵</div>
            <h6 class="themed-text-muted text-sm mb-1">已使用</h6>
            <h2 class="text-2xl font-bold text-green-600" x-text="'¥' + (budgetSummary.total_used || 0).toLocaleString()">-</h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-yellow-500 mb-2">🏦</div>
            <h6 class="themed-text-muted text-sm mb-1">剩余预算</h6>
            <h2 class="text-2xl font-bold text-yellow-600" x-text="'¥' + (budgetSummary.total_remaining || 0).toLocaleString()">-</h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-red-500 mb-2">⚠️</div>
            <h6 class="themed-text-muted text-sm mb-1">活动总数</h6>
            <h2 class="text-2xl font-bold text-red-600" x-text="budgetSummary.total_campaigns || 0">-</h2>
          </div>
        </div>

        <div class="themed-card rounded-lg shadow">
          <div class="p-4 border-b flex justify-between items-center">
            <h5 class="font-semibold">💰 活动预算列表</h5>
          </div>
          <!-- 筛选器 -->
          <div class="p-4 border-b themed-bg-base">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <select class="px-3 py-2 border rounded" x-model="budgetFilters.budget_type" @change="loadBudgetData()">
                <option value="">全部模式</option>
                <option value="pool">总预算</option>
                <option value="daily">每日预算</option>
                <option value="user">用户预算</option>
              </select>
              <!-- 活动状态筛选（使用后端字段 status: active/draft/completed/paused） -->
              <select class="px-3 py-2 border rounded" x-model="budgetFilters.status" @change="loadBudgetData()">
                <option value="">全部状态</option>
                <option value="active">进行中</option>
                <option value="draft">草稿</option>
                <option value="completed">已完成</option>
                <option value="paused">已暂停</option>
              </select>
              <button class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" @click="loadBudgetData()">
                🔍 刷新
              </button>
            </div>
          </div>
          <!-- 预算列表表格 -->
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="themed-bg-base">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">活动名称</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">预算模式</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">预算金额</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">已使用</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">使用率</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">状态</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                <template x-if="budgetCampaigns.length === 0">
                  <tr><td colspan="7" class="px-4 py-8 text-center themed-text-muted">暂无预算数据</td></tr>
                </template>
                <template x-for="campaign in budgetCampaigns" :key="campaign.lottery_campaign_id">
                  <tr class="themed-hover-bg">
                    <td class="px-4 py-3 text-sm" x-text="campaign.campaign_name"></td>
                    <td class="px-4 py-3"><span class="px-2 py-1 text-xs rounded bg-cyan-100 text-cyan-700" x-text="getBudgetModeText(campaign.budget_mode)"></span></td>
                    <td class="px-4 py-3 text-sm" x-text="'¥' + (campaign.pool_budget?.total || 0).toLocaleString()"></td>
                    <td class="px-4 py-3 text-sm" x-text="'¥' + (campaign.pool_budget?.used || 0).toLocaleString()"></td>
                    <td class="px-4 py-3">
                      <div class="w-full themed-bg-muted rounded-full h-4">
                        <div class="h-4 rounded-full text-xs text-white text-center" 
                             :class="getBudgetUsageClass(campaign)"
                             :style="'width: ' + Math.min(getBudgetUsageRate(campaign), 100) + '%'"
                             x-text="getBudgetUsageRate(campaign) + '%'"></div>
                      </div>
                    </td>
                    <td class="px-4 py-3">
                      <span class="px-2 py-1 text-xs rounded" 
                            :class="getBudgetUsageRate(campaign) >= 100 ? 'bg-red-100 text-red-700' : (getBudgetUsageRate(campaign) >= 80 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 themed-text-success')"
                            x-text="getBudgetUsageRate(campaign) >= 100 ? '超支' : (getBudgetUsageRate(campaign) >= 80 ? '预警' : '正常')"></span>
                    </td>
                    <td class="px-4 py-3 space-x-2">
                      <button class="themed-text-primary hover:text-blue-700 text-sm" @click="openSetBudgetModal(campaign.lottery_campaign_id)">设置</button>
                      <button class="text-cyan-600 hover:text-cyan-800 text-sm" @click="viewBudgetTrend(campaign)">📈 趋势</button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>

        <!-- P1新增: 预算消耗趋势图区域 -->
        <div class="themed-card rounded-lg shadow mt-6 p-4">
          <h6 class="font-semibold mb-4 flex items-center gap-2">
            📈 预算消耗趋势
            <span class="text-xs font-normal themed-text-muted">(选择活动查看详情)</span>
          </h6>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- 活动选择器 -->
            <div class="flex items-center gap-4">
              <label class="text-sm themed-text-secondary shrink-0">选择活动:</label>
              <select 
                class="flex-1 px-3 py-2 border rounded text-sm"
                x-model.number="selectedBudgetCampaignId"
                @change="loadBudgetTrendData(selectedBudgetCampaignId)"
              >
                <option value="">请选择活动</option>
                <template x-for="campaign in budgetCampaigns" :key="campaign.lottery_campaign_id">
                  <option :value="campaign.lottery_campaign_id" x-text="campaign.campaign_name"></option>
                </template>
              </select>
              <button 
                class="px-4 py-2 themed-bg-primary text-white rounded text-sm disabled:opacity-50"
                :disabled="!selectedBudgetCampaignId"
                @click="initBudgetTrendChart()"
              >
                🔄 刷新
              </button>
            </div>
            <!-- 快捷统计 -->
            <div class="flex items-center justify-end gap-6 text-sm">
              <template x-if="selectedBudgetCampaignId && budgetTrendData.length > 0">
                <div class="flex gap-6">
                  <span class="themed-text-muted">
                    7天累计: <span class="font-bold text-red-600" x-text="'¥' + (budgetTrendData[budgetTrendData.length-1]?.cumulative || 0).toLocaleString()"></span>
                  </span>
                  <span class="themed-text-muted">
                    日均消耗: <span class="font-bold text-blue-600" x-text="'¥' + Math.round((budgetTrendData.reduce((sum,d) => sum + d.daily, 0) / 7)).toLocaleString()"></span>
                  </span>
                </div>
              </template>
            </div>
          </div>
          <!-- 趋势图容器 -->
          <div id="budget-trend-chart" class="w-full h-64 mt-4"></div>
        </div>
      </div>

      <!-- ==================== 策略配置页 ==================== -->
      <div x-show="current_page === 'lottery-strategy'" x-cloak>
        <div class="themed-card rounded-lg shadow p-6">
          <h5 class="font-semibold mb-4">⚙️ 策略配置</h5>
          
          <!-- 数据加载状态提示 -->
          <template x-if="Object.keys(strategyGroups).length === 0">
            <div class="text-center py-8 themed-text-muted">
              <p>暂无策略配置数据</p>
              <p class="text-sm mt-2">请先在后台添加策略配置</p>
            </div>
          </template>
          
          <!-- 策略组列表 - 使用后端 config_group, config_key, config_id 字段 -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <template x-for="(strategies, groupName) in strategyGroups" :key="groupName">
              <div class="border rounded-lg">
                <div class="p-4 border-b themed-bg-base flex justify-between items-center">
                  <h6 class="font-medium" x-text="getStrategyGroupName(groupName)"></h6>
                  <span class="px-2 py-1 text-xs rounded themed-bg-primary-light themed-text-primary" x-text="strategies.length + ' 个配置'"></span>
                </div>
                <div class="divide-y">
                  <template x-for="(strategy, idx) in strategies" :key="strategy.config_id || idx">
                    <div class="p-4 flex justify-between items-center">
                      <div>
                        <div class="font-medium" x-text="strategy.config_key"></div>
                        <small class="text-gray-400" x-text="strategy.description || '暂无描述'"></small>
                        <div class="text-xs themed-text-primary mt-1">
                          值: <span x-text="typeof strategy.parsed_value === 'object' ? JSON.stringify(strategy.parsed_value) : strategy.parsed_value"></span>
                        </div>
                      </div>
                      <span class="px-2 py-1 text-xs rounded" :class="strategy.is_active ? 'bg-green-100 themed-text-success' : 'themed-bg-subtle themed-text-secondary'" x-text="strategy.is_active ? '启用' : '禁用'"></span>
                    </div>
                  </template>
                </div>
              </div>
            </template>
          </div>

          <!-- 层级矩阵配置 - 使用后端 B0/B1/B2/B3 和 P0/P1/P2 格式 -->
          <div class="mt-6 border rounded-lg">
            <div class="p-4 border-b themed-bg-base flex justify-between items-center">
              <h6 class="font-medium">📊 层级矩阵配置</h6>
              <span class="text-sm themed-text-muted" x-text="tierMatrix.length + ' 个配置'"></span>
            </div>
            <div class="p-4 overflow-x-auto">
              <template x-if="tierMatrix.length === 0">
                <div class="text-center py-4 themed-text-muted">暂无矩阵配置数据</div>
              </template>
              <template x-if="tierMatrix.length > 0">
                <table class="w-full border">
                  <thead class="themed-bg-subtle">
                    <tr>
                      <th class="border px-4 py-2">预算/压力</th>
                      <template x-for="pTier in pressureTiers" :key="pTier">
                        <th class="border px-4 py-2 text-sm" x-text="getPressureTierName(pTier)"></th>
                      </template>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="bTier in budgetTiers" :key="bTier">
                      <tr>
                        <th class="border px-4 py-2 themed-bg-base text-sm" x-text="getBudgetTierName(bTier)"></th>
                        <template x-for="pTier in pressureTiers" :key="bTier + '-' + pTier">
                          <td class="border px-2 py-2 text-center cursor-pointer hover:bg-blue-50" @click="editMatrixCell(bTier, pTier)">
                            <template x-if="getMatrixConfig(bTier, pTier)">
                              <div class="text-xs space-y-0.5">
                                <div class="flex justify-between"><span class="text-gray-500">H:</span><span x-text="getMatrixConfig(bTier, pTier).high_multiplier || 0"></span></div>
                                <div class="flex justify-between"><span class="text-gray-500">M:</span><span x-text="getMatrixConfig(bTier, pTier).mid_multiplier || 0"></span></div>
                                <div class="flex justify-between"><span class="text-gray-500">L:</span><span x-text="getMatrixConfig(bTier, pTier).low_multiplier || 0"></span></div>
                                <div class="flex justify-between"><span class="text-gray-500">FB:</span><span x-text="getMatrixConfig(bTier, pTier).fallback_multiplier || 1"></span></div>
                              </div>
                            </template>
                            <template x-if="!getMatrixConfig(bTier, pTier)">
                              <span class="text-gray-400">-</span>
                            </template>
                          </td>
                        </template>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </template>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== 配额管理页 ==================== -->
      <div x-show="current_page === 'lottery-quota'" x-cloak>
        <div class="themed-card rounded-lg shadow">
          <div class="p-4 border-b flex justify-between items-center">
            <h5 class="font-semibold">📊 配额规则管理</h5>
            <button @click="openCreateQuotaModal()" class="px-4 py-2 themed-btn-primary rounded transition-colors">
              ➕ 新增规则
            </button>
          </div>
          <!-- 配额规则表格 - 使用后端字段: rule_id, scope_type, scope_id, window_type, limit_value, priority, status -->
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="themed-bg-base">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">规则ID</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">规则类型</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">适用范围</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">时间窗口</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">每日上限</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">优先级</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">状态</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                <template x-if="quotas.length === 0">
                  <tr><td colspan="8" class="px-4 py-8 text-center themed-text-muted">暂无配额规则</td></tr>
                </template>
                <template x-for="quota in quotas" :key="quota.rule_id">
                  <tr class="themed-hover-bg">
                    <td class="px-4 py-3 text-sm font-mono" x-text="quota.rule_id"></td>
                    <td class="px-4 py-3 text-sm">
                      <span class="px-2 py-1 rounded text-xs"
                            :class="{
                              'themed-bg-primary-light themed-text-primary': quota.scope_type === 'global',
                              'bg-green-100 themed-text-success': quota.scope_type === 'campaign',
                              'bg-purple-100 text-purple-700': quota.scope_type === 'role',
                              'bg-orange-100 text-orange-700': quota.scope_type === 'user'
                            }"
                            x-text="getScopeTypeText(quota.scope_type)">
                      </span>
                    </td>
                    <td class="px-4 py-3 text-sm">
                      <template x-if="quota.scope_type === 'global'">
                        <span class="themed-text-muted">所有活动</span>
                      </template>
                      <template x-if="quota.scope_type === 'campaign'">
                        <span x-text="getQuotaCampaignName(quota.scope_id)"></span>
                      </template>
                      <template x-if="quota.scope_type === 'role'">
                        <span class="font-mono text-xs" x-text="'角色: ' + quota.scope_id"></span>
                      </template>
                      <template x-if="quota.scope_type === 'user'">
                        <span class="font-mono text-xs" x-text="'用户ID: ' + quota.scope_id"></span>
                      </template>
                    </td>
                    <td class="px-4 py-3 text-sm" x-text="getWindowTypeText(quota.window_type)"></td>
                    <td class="px-4 py-3 text-sm font-semibold themed-text-primary" x-text="quota.limit_value + ' 次/天'"></td>
                    <td class="px-4 py-3 text-sm" x-text="quota.priority"></td>
                    <td class="px-4 py-3">
                      <span class="px-2 py-1 rounded text-xs"
                            :class="quota.status === 'active' ? 'bg-green-100 themed-text-success' : 'themed-bg-subtle themed-text-muted'"
                            x-text="quota.status === 'active' ? '启用' : '禁用'">
                      </span>
                    </td>
                    <td class="px-4 py-3">
                      <div class="flex space-x-2">
                        <button class="themed-text-primary hover:text-blue-700 text-sm" @click="editQuota(quota)">编辑</button>
                        <button class="text-red-500 hover:text-red-700 text-sm" @click="deleteQuota(quota)" x-text="quota.status === 'active' ? '禁用' : '已禁用'" :disabled="quota.status !== 'active'" :class="quota.status !== 'active' ? 'opacity-50 cursor-not-allowed' : ''"></button>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ==================== 定价配置页 ==================== -->
      <div x-show="current_page === 'lottery-pricing'" x-cloak>
        <!-- 定价配置说明 -->
        <div class="themed-bg-primary-light border border-blue-200 rounded-lg p-4 mb-6">
          <div class="flex items-start">
            <span class="themed-text-primary mr-2">ℹ️</span>
            <div>
              <h6 class="font-medium themed-text-primary">定价配置说明</h6>
              <p class="text-sm themed-text-primary mt-1">配置每个活动的抽奖价格，支持多种连抽档位和折扣设置。定价配置支持版本管理，可回滚到历史版本。</p>
            </div>
          </div>
        </div>

        <div class="themed-card rounded-lg shadow">
          <div class="p-4 border-b flex justify-between items-center">
            <h5 class="font-semibold">💵 活动定价配置</h5>
            <div class="flex gap-2">
              <button @click="openCreatePricingModal()" class="px-4 py-2 themed-btn-primary rounded transition-colors">
                ➕ 创建定价配置
              </button>
              <button 
                @click="refreshPricingWithFeedback()" 
                :disabled="refreshingPricing"
                class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1">
                <span x-show="!refreshingPricing">🔄 刷新</span>
                <span x-show="refreshingPricing" class="flex items-center gap-1">
                  <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  加载中...
                </span>
              </button>
            </div>
          </div>
          
          <!-- 定价配置列表 -->
          <div class="p-4">
            <template x-if="pricingConfigs.length === 0 && !loading">
              <div class="text-center py-8 themed-text-muted">
                <p>暂无定价配置数据</p>
                <p class="text-sm mt-2">系统将显示已配置定价的活动列表</p>
              </div>
            </template>
            
            <div class="space-y-4">
              <template x-for="pricing in pricingConfigs" :key="pricing.campaign_id || pricing.config_id">
                <div class="border rounded-lg overflow-hidden">
                  <!-- 活动信息头部 -->
                  <div class="p-4 themed-bg-base flex justify-between items-center">
                    <div>
                      <h6 class="font-medium" x-text="pricing.campaign_name || '活动 ' + (pricing.campaign_code || pricing.campaign_id)"></h6>
                      <div class="text-sm themed-text-muted mt-1">
                        <span class="mr-4">活动代码: <code class="themed-bg-subtle px-1 rounded" x-text="pricing.campaign_code"></code></span>
                        <span>版本: <span class="font-semibold themed-text-primary" x-text="'v' + (pricing.version || 1)"></span></span>
                      </div>
                    </div>
                    <div class="flex items-center space-x-2">
                      <span class="px-2 py-1 text-xs rounded" :class="pricing.status === 'active' ? 'bg-green-100 themed-text-success' : 'themed-bg-subtle themed-text-muted'" x-text="getPricingStatusText(pricing.status)"></span>
                      <button class="themed-text-primary hover:text-blue-700 text-sm" @click="viewPricingVersions(pricing)">📋 版本历史</button>
                      <button class="text-green-500 hover:text-green-700 text-sm" @click="editPricing(pricing)">✏️ 编辑</button>
                    </div>
                  </div>
                  
                  <!-- 定价档位详情 -->
                  <div class="p-4">
                    <h6 class="text-sm font-medium themed-text-muted mb-3">抽奖档位配置</h6>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                      <template x-for="btn in (pricing.pricing_config?.draw_buttons || [])" :key="btn.count">
                        <div class="border rounded p-3 text-center" :class="btn.enabled ? 'themed-card' : 'themed-bg-base opacity-60'">
                          <div class="text-lg font-bold themed-text-primary" x-text="btn.label || (btn.count + '连抽')"></div>
                          <div class="text-sm themed-text-muted mt-1">
                            <span>次数: </span><span x-text="btn.count"></span>
                          </div>
                          <div class="text-sm mt-1" :class="btn.discount < 1 ? 'text-red-500' : 'themed-text-muted'">
                            <span>折扣: </span><span x-text="(btn.discount * 100).toFixed(0) + '%'"></span>
                          </div>
                          <div class="text-xs mt-1" :class="btn.enabled ? 'text-green-600' : 'text-gray-400'">
                            <span x-text="btn.enabled ? '✓ 已启用' : '✗ 已禁用'"></span>
                          </div>
                        </div>
                      </template>
                    </div>
                    
                    <!-- 其他配置信息 -->
                    <div class="mt-4 pt-4 border-t grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                      <div>
                        <span class="themed-text-muted">单抽基础价格:</span>
                        <span class="font-medium ml-1" x-text="(pricing.pricing_config?.base_cost || pricing.base_cost || '-') + ' 积分'"></span>
                      </div>
                      <div>
                        <span class="themed-text-muted">生效时间:</span>
                        <span class="font-medium ml-1" x-text="formatDateOnly(pricing.effective_from || pricing.created_at)"></span>
                      </div>
                      <div>
                        <span class="themed-text-muted">更新时间:</span>
                        <span class="font-medium ml-1" x-text="formatDateOnly(pricing.updated_at)"></span>
                      </div>
                      <div>
                        <span class="themed-text-muted">操作人:</span>
                        <span class="font-medium ml-1" x-text="pricing.created_by || '-'"></span>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== 抽奖指标页 ==================== -->
      <div x-show="current_page === 'lottery-metrics'" x-cloak x-init="$nextTick(() => { if(typeof initMonitoringCharts === 'function') initMonitoringCharts() })">
        <!-- 时间范围筛选 -->
        <div class="themed-card rounded-lg shadow p-4 mb-6">
          <div class="flex items-center gap-4">
            <label class="text-sm font-medium themed-text-secondary">统计时间范围：</label>
            <select 
              class="px-3 py-2 border rounded-lg text-sm"
              x-model="monitoringFilters.time_range"
              @change="loadEnhancedMetrics()"
            >
              <option value="today">今天</option>
              <option value="yesterday">昨天</option>
              <option value="week">最近7天</option>
              <option value="month">最近30天</option>
            </select>
            <button 
              class="px-4 py-2 themed-bg-primary text-white rounded-lg text-sm themed-hover-primary disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1"
              @click="loadEnhancedMetrics()"
              :disabled="refreshingMetrics || chartLoading"
            >
              <span x-show="!refreshingMetrics && !chartLoading">🔄 刷新数据</span>
            </button>
            <!-- P2新增: 运营日报入口 -->
            <button 
              class="px-4 py-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-lg text-sm hover:from-purple-600 hover:to-indigo-700 flex items-center gap-1"
              @click="openDailyReportModal()"
              :disabled="loadingDailyReport"
            >
              <span x-show="!loadingDailyReport">📊 查看日报</span>
              <span x-show="loadingDailyReport">⏳ 加载中...</span>
              <span x-show="refreshingMetrics || chartLoading" class="flex items-center gap-1">
                <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                加载中...
              </span>
            </button>
          </div>
        </div>

        <!-- 🚨 实时告警区 -->
        <div class="themed-card rounded-lg shadow mb-6">
          <div class="p-4 border-b flex items-center justify-between">
            <h5 class="font-semibold flex items-center gap-2">
              🚨 实时告警
              <span x-show="activeAlerts.length > 0" class="text-xs px-2 py-0.5 bg-red-100 text-red-600 rounded-full" x-text="activeAlerts.length"></span>
            </h5>
            <button @click="loadActiveAlerts()" class="text-sm themed-text-primary hover:underline">刷新告警</button>
          </div>
          <div class="p-4 space-y-2 max-h-40 overflow-y-auto">
            <template x-if="activeAlerts.length === 0">
              <div class="text-center py-4 themed-text-muted">
                <span class="text-2xl">✅</span>
                <p class="text-sm mt-1">暂无告警信息</p>
              </div>
            </template>
            <template x-for="(alert, index) in activeAlerts" :key="index">
              <div class="flex items-start gap-3 p-3 rounded-lg border-l-4" :class="getAlertLevelClass(alert.level)">
                <span class="text-lg" x-text="getAlertLevelIcon(alert.level)"></span>
                <div class="flex-1">
                  <p class="text-sm font-medium" x-text="alert.message"></p>
                  <p class="text-xs opacity-75 mt-1" x-text="new Date(alert.time).toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'})"></p>
                </div>
              </div>
            </template>
          </div>
        </div>
        <!-- 总体统计 - 适配后端返回字段 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl themed-text-primary mb-2">🎲</div>
            <h6 class="themed-text-muted text-sm mb-1">总抽奖次数</h6>
            <h2 class="text-2xl font-bold themed-text-primary" x-text="lotteryMetrics.totalDraws">-</h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-green-500 mb-2">🏆</div>
            <h6 class="themed-text-muted text-sm mb-1">中奖次数</h6>
            <h2 class="text-2xl font-bold text-green-600" x-text="lotteryMetrics.totalWins">-</h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-yellow-500 mb-2">📈</div>
            <h6 class="themed-text-muted text-sm mb-1">中奖率</h6>
            <h2 class="text-2xl font-bold text-yellow-600" x-text="lotteryMetrics.winRate + '%'">-</h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-cyan-500 mb-2">💰</div>
            <h6 class="themed-text-muted text-sm mb-1">奖品总价值</h6>
            <h2 class="text-2xl font-bold text-cyan-600" x-text="'¥' + (lotteryMetrics.totalValue || 0).toFixed(2)">-</h2>
          </div>
        </div>

        <!-- 🔍 用户档案快速查询 -->
        <div class="themed-card rounded-lg shadow p-4 mb-6">
          <div class="flex flex-col md:flex-row items-start md:items-center gap-4">
            <h6 class="font-semibold text-sm flex items-center gap-2 shrink-0">
              👤 用户抽奖档案查询
            </h6>
            <div class="flex flex-1 gap-3 items-center">
              <input 
                type="text" 
                class="flex-1 max-w-xs px-3 py-2 border rounded-lg text-sm"
                placeholder="输入用户ID..." 
                x-model="searchUserId"
                @keyup.enter="searchUserProfile()"
              >
              <select 
                class="px-3 py-2 border rounded-lg text-sm"
                x-model="searchCampaignId"
              >
                <option value="">全部活动</option>
                <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
                  <option :value="campaign.lottery_campaign_id" x-text="campaign.campaign_name"></option>
                </template>
              </select>
              <button 
                class="px-4 py-2 themed-bg-primary text-white rounded-lg text-sm themed-hover-primary flex items-center gap-1 disabled:opacity-50"
                @click="searchUserProfile()"
                :disabled="loadingUserProfile || !searchUserId"
              >
                <span x-show="!loadingUserProfile">🔍 查询档案</span>
                <span x-show="loadingUserProfile" class="flex items-center gap-1">
                  <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                  </svg>
                  查询中...
                </span>
              </button>
            </div>
          </div>
        </div>

        <!-- 📈 图表区域：24小时趋势 + 档位分布 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <!-- 24小时抽奖趋势折线图 -->
          <div class="themed-card rounded-lg shadow">
            <div class="p-4 border-b flex items-center justify-between">
              <h5 class="font-semibold">📈 24小时抽奖趋势</h5>
              <span x-show="chartLoading" class="text-xs themed-text-muted flex items-center gap-1">
                <svg class="animate-spin h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                </svg>
                更新中...
              </span>
            </div>
            <div class="p-4">
              <div id="trend-chart-24h" class="w-full h-64"></div>
              <template x-if="hourlyTrend24h.length === 0 && !chartLoading">
                <div class="absolute inset-0 flex items-center justify-center">
                  <p class="themed-text-muted text-sm">暂无趋势数据</p>
                </div>
              </template>
            </div>
          </div>

          <!-- 档位分布饼图 -->
          <div class="themed-card rounded-lg shadow">
            <div class="p-4 border-b">
              <h5 class="font-semibold">📊 档位分布</h5>
            </div>
            <div class="p-4">
              <div id="tier-distribution-chart" class="w-full h-64"></div>
              <template x-if="tierDistribution.length === 0 && !chartLoading">
                <div class="absolute inset-0 flex items-center justify-center">
                  <p class="themed-text-muted text-sm">暂无分布数据</p>
                </div>
              </template>
            </div>
          </div>
        </div>

        <!-- P3-4: 抽奖时段热力图 -->
        <div class="themed-card rounded-lg shadow mb-6">
          <div class="p-4 border-b flex items-center justify-between">
            <div class="flex items-center gap-2">
              <h5 class="font-semibold">🔥 抽奖时段热力图</h5>
              <span class="text-sm themed-text-muted">24小时 × 7天</span>
            </div>
            <div class="flex items-center gap-2">
              <template x-if="heatmapPeak">
                <span class="text-xs themed-text-muted">
                  峰值: <span class="font-medium themed-text-primary" x-text="heatmapPeak.day + ' ' + heatmapPeak.hour"></span>
                </span>
              </template>
              <button 
                @click="loadLotteryHeatmap(7)" 
                class="px-2 py-1 text-xs themed-bg-subtle rounded hover:themed-bg-muted"
                :disabled="loadingHeatmap"
              >
                <span x-show="!loadingHeatmap">🔄 刷新</span>
                <span x-show="loadingHeatmap">加载中...</span>
              </button>
            </div>
          </div>
          <div class="p-4">
            <div id="lottery-heatmap-chart" style="width: 100%; height: 280px;"></div>
            <template x-if="(!lotteryHeatmap || lotteryHeatmap.length === 0) && !loadingHeatmap">
              <div class="text-center py-8 themed-text-muted">
                <p>暂无热力图数据</p>
                <button @click="loadLotteryHeatmap(7)" class="mt-2 text-sm themed-text-primary hover:underline">
                  点击加载
                </button>
              </div>
            </template>
          </div>
        </div>

        <!-- 预算进度条 -->
        <div class="themed-card rounded-lg shadow p-4 mb-6" x-show="budgetProgress.total > 0">
          <div class="flex items-center justify-between mb-2">
            <h6 class="font-semibold text-sm">💰 预算消耗进度</h6>
            <span class="text-sm themed-text-muted">
              已使用 <span class="font-medium" :class="budgetProgress.percentage > 80 ? 'text-red-500' : 'themed-text-primary'" x-text="budgetProgress.used.toLocaleString()"></span>
              / <span x-text="budgetProgress.total.toLocaleString()"></span>
            </span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-3">
            <div class="h-3 rounded-full transition-all duration-500" 
                 :class="budgetProgress.percentage > 90 ? 'bg-red-500' : budgetProgress.percentage > 70 ? 'bg-yellow-500' : 'bg-green-500'"
                 :style="'width: ' + Math.min(budgetProgress.percentage, 100) + '%'"></div>
          </div>
          <div class="flex justify-between mt-1">
            <span class="text-xs themed-text-muted">0%</span>
            <span class="text-xs font-medium" :class="budgetProgress.percentage > 80 ? 'text-red-500' : 'themed-text-muted'" x-text="budgetProgress.percentage + '%'"></span>
            <span class="text-xs themed-text-muted">100%</span>
          </div>
        </div>

        <!-- 奖品分布统计 - 后端返回 prize_distribution: [{name, value}] -->
        <div class="themed-card rounded-lg shadow mb-6">
          <div class="p-4 border-b">
            <h5 class="font-semibold">🏆 按奖品类型分布</h5>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="themed-bg-base">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">奖品等级</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">中奖次数</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">占比</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                <template x-if="prizeDistribution.length === 0">
                  <tr><td colspan="3" class="px-4 py-8 text-center themed-text-muted">暂无数据</td></tr>
                </template>
                <template x-for="(prize, index) in prizeDistribution" :key="index">
                  <tr class="themed-hover-bg">
                    <td class="px-4 py-3 text-sm font-medium" x-text="prize.prize_name || '-'"></td>
                    <td class="px-4 py-3 text-sm" x-text="prize.value || 0"></td>
                    <td class="px-4 py-3 text-sm">
                      <div class="flex items-center">
                        <div class="w-24 themed-bg-muted rounded-full h-2 mr-2">
                          <div class="themed-bg-primary h-2 rounded-full" 
                               :style="'width: ' + ((prize.value || 0) / (lotteryMetrics.totalDraws || 1) * 100) + '%'"></div>
                        </div>
                        <span x-text="((prize.value || 0) / (lotteryMetrics.totalDraws || 1) * 100).toFixed(1) + '%'"></span>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 最近抽奖记录 - 后端返回 recent_draws: [{time, user, campaign, result, is_win, draw_id}] -->
        <div class="themed-card rounded-lg shadow">
          <div class="p-4 border-b">
            <h5 class="font-semibold">📋 最近抽奖记录</h5>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="themed-bg-base">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">用户</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">活动</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">结果</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">抽奖时间</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                <template x-if="recentDraws.length === 0">
                  <tr><td colspan="5" class="px-4 py-8 text-center themed-text-muted">暂无抽奖记录</td></tr>
                </template>
                <template x-for="(draw, index) in recentDraws" :key="index">
                  <tr class="themed-hover-bg">
                    <td class="px-4 py-3 text-sm" x-text="draw.user || '-'"></td>
                    <td class="px-4 py-3 text-sm" x-text="draw.campaign || '-'"></td>
                    <td class="px-4 py-3 text-sm">
                      <span class="px-2 py-1 rounded text-xs"
                            :class="draw.is_win ? 'bg-green-100 themed-text-success' : 'themed-bg-subtle themed-text-muted'"
                            x-text="draw.result || '-'"></span>
                    </td>
                    <td class="px-4 py-3 text-sm themed-text-muted" x-text="draw.time ? new Date(draw.time).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' }) : '-'"></td>
                    <td class="px-4 py-3 text-sm">
                      <button x-show="draw.draw_id" 
                              @click="openDrawDetailsModal(draw.draw_id)"
                              class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-700 hover:bg-blue-200"
                              title="查看Pipeline详情">
                        🔍 详情
                      </button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 告警中心已迁移至独立页面 /admin/lottery-alerts.html -->

      <!-- 单次抽奖详情弹窗 (P1) -->
      <div x-show="showDrawDetailsModal" 
           class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
           x-cloak
           @click.self="closeDrawDetailsModal()">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-auto">
          <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10">
            <h5 class="font-semibold">🎰 单次抽奖详情 - Pipeline可视化</h5>
            <button @click="closeDrawDetailsModal()" class="text-gray-500 hover:text-gray-700 text-xl">✕</button>
          </div>

          <!-- 加载状态 -->
          <div x-show="loadingDrawDetails" class="p-8 text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <p class="themed-text-muted">加载抽奖详情...</p>
          </div>

          <!-- 详情内容 -->
          <div x-show="!loadingDrawDetails && drawDetails" class="p-6">
            <template x-if="drawDetails">
              <div class="space-y-6">
                <!-- 基础信息卡片 -->
                <div class="themed-card rounded-lg shadow p-4">
                  <h6 class="font-semibold mb-3 flex items-center gap-2">
                    <span>📋</span> 基础信息
                  </h6>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                      <span class="themed-text-muted">抽奖ID:</span>
                      <p class="font-mono" x-text="drawDetails.basic_info?.draw_id || currentDrawId"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">用户ID:</span>
                      <p x-text="drawDetails.basic_info?.user_id || '-'"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">活动ID:</span>
                      <p x-text="drawDetails.basic_info?.campaign_id || '-'"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">消耗积分:</span>
                      <p x-text="drawDetails.basic_info?.cost_points || 0"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">抽奖时间:</span>
                      <p x-text="formatBeijingTime(drawDetails.basic_info?.created_at)"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">是否中奖:</span>
                      <p>
                        <span class="px-2 py-0.5 text-xs rounded"
                              :class="drawDetails.basic_info?.is_winner ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'"
                              x-text="drawDetails.basic_info?.is_winner ? '中奖' : '未中奖'"></span>
                      </p>
                    </div>
                    <div>
                      <span class="themed-text-muted">中奖档位:</span>
                      <p x-text="drawDetails.basic_info?.result_tier || '-'"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">奖品名称:</span>
                      <p x-text="drawDetails.basic_info?.prize_name || '-'"></p>
                    </div>
                  </div>
                </div>

                <!-- 用户抽奖前状态 -->
                <div x-show="drawDetails.user_state_before" class="themed-card rounded-lg shadow p-4">
                  <h6 class="font-semibold mb-3 flex items-center gap-2">
                    <span>👤</span> 用户抽奖前状态
                  </h6>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                      <span class="themed-text-muted">连空次数:</span>
                      <p x-text="drawDetails.user_state_before?.empty_streak || 0"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">Pity进度:</span>
                      <p x-text="drawDetails.user_state_before?.pity_progress || 0"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">运气债务:</span>
                      <p x-text="drawDetails.user_state_before?.luck_debt?.toFixed(4) || '0.0000'"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">总抽奖次数:</span>
                      <p x-text="drawDetails.user_state_before?.total_draws || 0"></p>
                    </div>
                  </div>
                </div>

                <!-- 决策快照 -->
                <div x-show="drawDetails.decision_snapshot" class="themed-card rounded-lg shadow p-4">
                  <h6 class="font-semibold mb-3 flex items-center gap-2">
                    <span>🎲</span> 决策快照
                  </h6>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                      <span class="themed-text-muted">随机数:</span>
                      <p class="font-mono" x-text="drawDetails.decision_snapshot?.random_number?.toFixed(6) || '-'"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">选中档位:</span>
                      <p x-text="drawDetails.decision_snapshot?.selected_tier || '-'"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">降级次数:</span>
                      <p x-text="drawDetails.decision_snapshot?.downgrade_count || 0"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">触发Pity:</span>
                      <p>
                        <span class="px-2 py-0.5 text-xs rounded"
                              :class="drawDetails.decision_snapshot?.pity_triggered ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-700'"
                              x-text="drawDetails.decision_snapshot?.pity_triggered ? '是' : '否'"></span>
                      </p>
                    </div>
                  </div>
                </div>

                <!-- Pipeline执行详情 -->
                <div x-show="drawDetails.pipeline_execution && drawDetails.pipeline_execution.length > 0" class="themed-card rounded-lg shadow p-4">
                  <h6 class="font-semibold mb-4 flex items-center gap-2">
                    <span>⚙️</span> Pipeline执行流程 (11阶段)
                  </h6>
                  
                  <!-- Pipeline可视化 -->
                  <div class="relative">
                    <template x-for="(stage, index) in drawDetails.pipeline_execution" :key="stage.stage">
                      <div class="flex items-start gap-3 mb-4 last:mb-0">
                        <!-- 阶段序号和连接线 -->
                        <div class="flex flex-col items-center">
                          <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold"
                               :class="getPipelineStageStyle(stage.status)">
                            <span x-text="index + 1"></span>
                          </div>
                          <div x-show="index < drawDetails.pipeline_execution.length - 1" 
                               class="w-0.5 h-8 bg-gray-300 mt-1"></div>
                        </div>
                        
                        <!-- 阶段详情 -->
                        <div class="flex-1 pb-2">
                          <div class="flex items-center gap-2 mb-1">
                            <span x-text="getPipelineStageIcon(stage.status)"></span>
                            <span class="font-medium" x-text="formatPipelineStageName(stage.stage)"></span>
                            <span class="text-xs themed-text-muted" x-text="'(' + stage.stage + ')'"></span>
                            <span class="ml-auto text-xs px-2 py-0.5 rounded"
                                  :class="getPipelineStageStyle(stage.status)"
                                  x-text="stage.status"></span>
                            <span class="text-xs themed-text-muted" x-text="formatDuration(stage.duration_ms)"></span>
                          </div>
                          <!-- 阶段输出 -->
                          <div x-show="stage.output" class="text-xs themed-text-muted bg-gray-50 p-2 rounded mt-1 font-mono overflow-x-auto">
                            <pre x-text="typeof stage.output === 'object' ? JSON.stringify(stage.output, null, 2) : stage.output"></pre>
                          </div>
                        </div>
                      </div>
                    </template>
                  </div>

                  <!-- 总执行时间 -->
                  <div class="mt-4 pt-4 border-t flex justify-between items-center text-sm">
                    <span class="themed-text-muted">总执行时间:</span>
                    <span class="font-medium" x-text="formatDuration(drawDetails.pipeline_execution?.reduce((sum, s) => sum + (s.duration_ms || 0), 0))"></span>
                  </div>
                </div>
              </div>
            </template>
          </div>

          <!-- 空状态 -->
          <div x-show="!loadingDrawDetails && !drawDetails" class="p-8 text-center">
            <div class="text-4xl mb-2">📭</div>
            <p class="themed-text-muted">未找到抽奖详情</p>
          </div>

          <div class="p-4 border-t flex justify-end sticky bottom-0 bg-white">
            <button @click="closeDrawDetailsModal()" class="themed-btn-secondary px-4 py-2 rounded">
              关闭
            </button>
          </div>
        </div>
      </div>

      <!-- ==================== 风控面板页 ==================== -->
      <div x-show="current_page === 'lottery-risk-control'" x-cloak x-init="$nextTick(() => loadAbnormalUsers())">
        <!-- 风控统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl themed-text-primary mb-2">🛡️</div>
            <h6 class="themed-text-muted text-sm mb-1">异常用户总数</h6>
            <h2 class="text-2xl font-bold themed-text-primary" x-text="abnormalUserStats.total">0</h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-red-500 mb-2">🔥</div>
            <h6 class="themed-text-muted text-sm mb-1">高频抽奖</h6>
            <h2 class="text-2xl font-bold text-red-600" x-text="abnormalUserStats.high_frequency">0</h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-orange-500 mb-2">📈</div>
            <h6 class="themed-text-muted text-sm mb-1">高中奖率</h6>
            <h2 class="text-2xl font-bold text-orange-600" x-text="abnormalUserStats.high_win_rate">0</h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-purple-500 mb-2">👑</div>
            <h6 class="themed-text-muted text-sm mb-1">高档位异常</h6>
            <h2 class="text-2xl font-bold text-purple-600" x-text="abnormalUserStats.high_tier_abnormal">0</h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-yellow-500 mb-2">⚡</div>
            <h6 class="themed-text-muted text-sm mb-1">快速连中</h6>
            <h2 class="text-2xl font-bold text-yellow-600" x-text="abnormalUserStats.rapid_wins">0</h2>
          </div>
        </div>

        <!-- 筛选工具栏 -->
        <div class="themed-card rounded-lg shadow p-4 mb-6">
          <div class="flex flex-wrap items-center gap-4">
            <div class="flex-1 min-w-[200px]">
              <label class="text-sm themed-text-muted mb-1 block">异常类型</label>
              <select x-model="abnormalUserFilters.type" @change="filterAbnormalUsersByType(abnormalUserFilters.type)" class="w-full themed-input rounded px-3 py-2">
                <option value="all">全部类型</option>
                <option value="high_frequency">🔥 高频抽奖</option>
                <option value="high_win_rate">📈 高中奖率</option>
                <option value="high_tier_abnormal">👑 高档位异常</option>
                <option value="rapid_wins">⚡ 快速连中</option>
              </select>
            </div>
            <div class="flex items-end gap-2 mt-auto">
              <button @click="refreshAbnormalUsers()" class="themed-btn-primary px-4 py-2 rounded">
                ♻️ 刷新
              </button>
            </div>
          </div>
        </div>

        <!-- 异常用户列表 -->
        <div class="themed-card rounded-lg shadow">
          <div class="p-4 border-b flex justify-between items-center">
            <h5 class="font-semibold">🛡️ 异常用户列表</h5>
            <span class="text-sm themed-text-muted" x-text="'共 ' + abnormalUserPagination.total_count + ' 个异常用户'"></span>
          </div>

          <!-- 加载状态 -->
          <div x-show="loadingAbnormalUsers" class="p-8 text-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
            <p class="themed-text-muted">加载中...</p>
          </div>

          <!-- 空状态 -->
          <div x-show="!loadingAbnormalUsers && abnormalUsers.length === 0" class="p-8 text-center">
            <div class="text-4xl mb-2">✅</div>
            <p class="themed-text-muted">暂无异常用户，系统运行正常</p>
          </div>

          <!-- 用户列表 -->
          <div x-show="!loadingAbnormalUsers && abnormalUsers.length > 0" class="overflow-x-auto">
            <table class="w-full">
              <thead class="themed-bg-base">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">用户ID</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">异常类型</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">风险等级</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">异常指标</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">检测时间</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                <template x-for="user in abnormalUsers" :key="user.user_id">
                  <tr class="themed-hover-bg">
                    <td class="px-4 py-3 text-sm font-mono" x-text="user.user_id"></td>
                    <td class="px-4 py-3 text-sm">
                      <span class="px-2 py-1 rounded text-xs inline-flex items-center gap-1"
                            :class="getAbnormalTypeStyle(user.abnormal_type)">
                        <span x-text="getAbnormalTypeIcon(user.abnormal_type)"></span>
                        <span x-text="getAbnormalTypeText(user.abnormal_type)"></span>
                      </span>
                    </td>
                    <td class="px-4 py-3 text-sm">
                      <span class="px-2 py-1 rounded text-xs"
                            :class="getRiskLevelStyle(user.risk_level)"
                            x-text="getRiskLevelText(user.risk_level)"></span>
                    </td>
                    <td class="px-4 py-3 text-sm themed-text-muted" x-text="user.abnormal_value || '-'"></td>
                    <td class="px-4 py-3 text-sm themed-text-muted" x-text="formatRiskTime(user.detected_at)"></td>
                    <td class="px-4 py-3 text-sm">
                      <div class="flex items-center gap-2">
                        <button @click="viewAbnormalUserDetail(user)"
                                class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-700 hover:bg-blue-200"
                                title="查看详情">
                          👁️ 详情
                        </button>
                        <button @click="goToUserProfile(user.user_id)"
                                class="px-2 py-1 text-xs rounded bg-green-100 text-green-700 hover:bg-green-200"
                                title="查看用户档案">
                          📋 档案
                        </button>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>

          <!-- 分页 -->
          <div x-show="abnormalUserPagination.total_pages > 1" class="p-4 border-t">
            <div class="flex justify-center items-center gap-2">
              <button @click="changeAbnormalUsersPage(1)" 
                      :disabled="abnormalUserPagination.current_page === 1"
                      class="px-3 py-1 rounded themed-btn-secondary disabled:opacity-50">
                首页
              </button>
              <button @click="changeAbnormalUsersPage(abnormalUserPagination.current_page - 1)" 
                      :disabled="abnormalUserPagination.current_page === 1"
                      class="px-3 py-1 rounded themed-btn-secondary disabled:opacity-50">
                上一页
              </button>
              <span class="px-4 py-1 themed-text-muted">
                第 <span x-text="abnormalUserPagination.current_page"></span> / <span x-text="abnormalUserPagination.total_pages"></span> 页
              </span>
              <button @click="changeAbnormalUsersPage(abnormalUserPagination.current_page + 1)" 
                      :disabled="abnormalUserPagination.current_page >= abnormalUserPagination.total_pages"
                      class="px-3 py-1 rounded themed-btn-secondary disabled:opacity-50">
                下一页
              </button>
              <button @click="changeAbnormalUsersPage(abnormalUserPagination.total_pages)" 
                      :disabled="abnormalUserPagination.current_page >= abnormalUserPagination.total_pages"
                      class="px-3 py-1 rounded themed-btn-secondary disabled:opacity-50">
                末页
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 异常用户详情弹窗 -->
      <div x-show="showAbnormalUserDetailModal" 
           class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
           x-cloak
           @click.self="closeAbnormalUserDetailModal()">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] overflow-auto">
          <div class="p-4 border-b flex justify-between items-center">
            <h5 class="font-semibold">🛡️ 异常用户详情</h5>
            <button @click="closeAbnormalUserDetailModal()" class="text-gray-500 hover:text-gray-700">✕</button>
          </div>
          <div class="p-6">
            <template x-if="selectedAbnormalUser">
              <div class="space-y-4">
                <div class="flex items-center gap-3 mb-4">
                  <span x-text="getAbnormalTypeIcon(selectedAbnormalUser.abnormal_type)" class="text-3xl"></span>
                  <div>
                    <span class="text-lg font-semibold" x-text="'用户 #' + selectedAbnormalUser.user_id"></span>
                    <span class="ml-2 px-2 py-0.5 rounded text-xs"
                          :class="getRiskLevelStyle(selectedAbnormalUser.risk_level)"
                          x-text="getRiskLevelText(selectedAbnormalUser.risk_level)"></span>
                  </div>
                </div>
                <table class="w-full text-sm">
                  <tr class="border-b">
                    <th class="py-2 text-left w-1/3">用户ID</th>
                    <td class="py-2 font-mono" x-text="selectedAbnormalUser.user_id"></td>
                  </tr>
                  <tr class="border-b">
                    <th class="py-2 text-left">异常类型</th>
                    <td class="py-2">
                      <span class="px-2 py-0.5 rounded text-xs"
                            :class="getAbnormalTypeStyle(selectedAbnormalUser.abnormal_type)"
                            x-text="getAbnormalTypeText(selectedAbnormalUser.abnormal_type)"></span>
                    </td>
                  </tr>
                  <tr class="border-b">
                    <th class="py-2 text-left">异常指标</th>
                    <td class="py-2" x-text="selectedAbnormalUser.abnormal_value || '-'"></td>
                  </tr>
                  <tr class="border-b">
                    <th class="py-2 text-left">检测时间</th>
                    <td class="py-2" x-text="formatRiskTime(selectedAbnormalUser.detected_at)"></td>
                  </tr>
                  <tr class="border-b" x-show="selectedAbnormalUser.draw_count">
                    <th class="py-2 text-left">抽奖次数</th>
                    <td class="py-2" x-text="selectedAbnormalUser.draw_count"></td>
                  </tr>
                  <tr class="border-b" x-show="selectedAbnormalUser.win_count">
                    <th class="py-2 text-left">中奖次数</th>
                    <td class="py-2" x-text="selectedAbnormalUser.win_count"></td>
                  </tr>
                  <tr class="border-b" x-show="selectedAbnormalUser.win_rate">
                    <th class="py-2 text-left">中奖率</th>
                    <td class="py-2" x-text="(selectedAbnormalUser.win_rate * 100).toFixed(2) + '%'"></td>
                  </tr>
                  <tr class="border-b" x-show="selectedAbnormalUser.description">
                    <th class="py-2 text-left">描述</th>
                    <td class="py-2" x-text="selectedAbnormalUser.description"></td>
                  </tr>
                </table>
              </div>
            </template>
          </div>
          <div class="p-4 border-t flex justify-end gap-2">
            <button @click="goToUserProfile(selectedAbnormalUser?.user_id)" 
                    class="themed-btn-primary px-4 py-2 rounded">
              📋 查看用户档案
            </button>
            <button @click="closeAbnormalUserDetailModal()" class="themed-btn-secondary px-4 py-2 rounded">
              关闭
            </button>
          </div>
        </div>
      </div>

      <!-- ==================== 策略效果分析页面 (P2) ==================== -->
      <div x-show="current_page === 'strategy-effectiveness'" x-cloak x-init="$nextTick(() => loadStrategyEffectiveness())">
        
        <!-- 页面标题和筛选 -->
        <div class="themed-card rounded-lg shadow p-6 mb-6">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <h5 class="font-semibold themed-text-primary flex items-center gap-2">
              📈 策略效果分析
              <span class="text-sm themed-text-muted font-normal">BxPx矩阵热力图 / Pity触发率 / 档位降级统计</span>
            </h5>
            <div class="flex items-center gap-3">
              <select x-model="strategyEffectivenessFilters.campaign_id" 
                      @change="applyStrategyEffectivenessFilters()"
                      class="themed-input rounded px-3 py-2 text-sm w-40">
                <option value="">全部活动</option>
                <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
                  <option :value="campaign.lottery_campaign_id" x-text="campaign.campaign_name"></option>
                </template>
              </select>
              <input type="date" x-model="strategyEffectivenessFilters.start_date"
                     @change="applyStrategyEffectivenessFilters()"
                     class="themed-input rounded px-3 py-2 text-sm"
                     placeholder="开始日期">
              <input type="date" x-model="strategyEffectivenessFilters.end_date"
                     @change="applyStrategyEffectivenessFilters()"
                     class="themed-input rounded px-3 py-2 text-sm"
                     placeholder="结束日期">
              <button @click="resetStrategyEffectivenessFilters()" 
                      class="themed-btn-secondary px-3 py-2 rounded text-sm">
                重置
              </button>
              <button @click="refreshStrategyEffectiveness()" 
                      class="themed-btn-primary px-4 py-2 rounded text-sm flex items-center gap-1"
                      :disabled="loadingStrategyEffectiveness">
                <span x-show="!loadingStrategyEffectiveness">🔄 刷新</span>
                <span x-show="loadingStrategyEffectiveness">加载中...</span>
              </button>
            </div>
          </div>
        </div>

        <!-- 加载状态 -->
        <div x-show="loadingStrategyEffectiveness" class="text-center py-12">
          <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mb-3"></div>
          <p class="themed-text-muted">加载策略效果分析数据中...</p>
        </div>

        <!-- 无数据状态 -->
        <div x-show="!loadingStrategyEffectiveness && !strategyEffectiveness" class="text-center py-12">
          <div class="text-6xl mb-4">📊</div>
          <p class="themed-text-muted">暂无策略效果数据</p>
          <button @click="loadStrategyEffectiveness()" class="mt-4 themed-btn-primary px-4 py-2 rounded">
            重新加载
          </button>
        </div>

        <!-- 策略效果分析内容 -->
        <template x-if="strategyEffectiveness && !loadingStrategyEffectiveness">
          <div class="space-y-6">
            
            <!-- 分析周期和整体评分 -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div class="themed-card rounded-lg shadow p-4 text-center">
                <div class="text-3xl mb-2">📅</div>
                <p class="text-xs themed-text-muted mb-1">分析周期</p>
                <p class="font-semibold text-sm">
                  <span x-text="strategyEffectiveness.analysis_period?.start_date || '-'"></span>
                  至
                  <span x-text="strategyEffectiveness.analysis_period?.end_date || '-'"></span>
                </p>
              </div>
              <div class="themed-card rounded-lg shadow p-4 text-center">
                <div class="text-3xl mb-2">🎯</div>
                <p class="text-xs themed-text-muted mb-1">整体策略评分</p>
                <p class="text-2xl font-bold" 
                   :class="getStrategyScoreColor(strategyEffectiveness.overall_strategy_score)"
                   x-text="(strategyEffectiveness.overall_strategy_score || 0) + '分'"></p>
              </div>
              <div class="themed-card rounded-lg shadow p-4 text-center">
                <div class="text-3xl mb-2">📈</div>
                <p class="text-xs themed-text-muted mb-1">活动数量</p>
                <p class="text-2xl font-bold" x-text="strategyEffectiveness.analysis_period?.campaigns_count || 0"></p>
              </div>
              <div class="themed-card rounded-lg shadow p-4 text-center">
                <div class="text-3xl mb-2">🎰</div>
                <p class="text-xs themed-text-muted mb-1">总抽奖次数</p>
                <p class="text-2xl font-bold" x-text="(strategyEffectiveness.analysis_period?.total_draws || 0).toLocaleString()"></p>
              </div>
            </div>

            <!-- BxPx矩阵热力图 -->
            <div class="themed-card rounded-lg shadow">
              <div class="p-4 border-b">
                <h6 class="font-semibold flex items-center gap-2">
                  🔥 BxPx 矩阵热力图
                  <span class="text-xs themed-text-muted font-normal">预算层级 × 压力层级 命中率分布</span>
                </h6>
              </div>
              <div class="p-4">
                <template x-if="strategyEffectiveness.bxpx_matrix_analysis">
                  <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                      <thead>
                        <tr>
                          <th class="p-2 text-center themed-text-muted">B \ P</th>
                          <template x-for="pTier in ['P0', 'P1', 'P2']" :key="pTier">
                            <th class="p-2 text-center font-semibold" x-text="getPressureTierName(pTier) + ' (' + pTier + ')'"></th>
                          </template>
                        </tr>
                      </thead>
                      <tbody>
                        <template x-for="bTier in ['B0', 'B1', 'B2', 'B3']" :key="bTier">
                          <tr>
                            <th class="p-2 text-center font-semibold" x-text="getBudgetTierName(bTier) + ' (' + bTier + ')'"></th>
                            <template x-for="pTier in ['P0', 'P1', 'P2']" :key="pTier">
                              <td class="p-2 text-center">
                                <template x-if="strategyEffectiveness.bxpx_matrix_analysis.matrix">
                                  <div class="p-3 rounded"
                                       :class="getBxPxHeatmapColor(strategyEffectiveness.bxpx_matrix_analysis.matrix[bTier + '_' + pTier]?.hit_rate || 0)">
                                    <p class="font-bold" x-text="formatStrategyPercentage(strategyEffectiveness.bxpx_matrix_analysis.matrix[bTier + '_' + pTier]?.hit_rate)"></p>
                                    <p class="text-xs opacity-75" x-text="(strategyEffectiveness.bxpx_matrix_analysis.matrix[bTier + '_' + pTier]?.count || 0) + ' 次'"></p>
                                  </div>
                                </template>
                              </td>
                            </template>
                          </tr>
                        </template>
                      </tbody>
                    </table>
                    <!-- 热力图图例 -->
                    <div class="mt-4 flex items-center justify-center gap-2 text-xs">
                      <span class="themed-text-muted">命中率:</span>
                      <span class="px-2 py-1 rounded bg-green-100">0-20%</span>
                      <span class="px-2 py-1 rounded bg-green-300">20-40%</span>
                      <span class="px-2 py-1 rounded bg-yellow-300">40-60%</span>
                      <span class="px-2 py-1 rounded bg-orange-400 text-white">60-80%</span>
                      <span class="px-2 py-1 rounded bg-red-500 text-white">80-100%</span>
                    </div>
                  </div>
                </template>
                <template x-if="!strategyEffectiveness.bxpx_matrix_analysis">
                  <p class="text-center themed-text-muted py-4">暂无BxPx矩阵数据</p>
                </template>
              </div>
            </div>

            <!-- 体验机制分析 -->
            <div class="themed-card rounded-lg shadow">
              <div class="p-4 border-b">
                <h6 class="font-semibold flex items-center gap-2">
                  🎮 体验机制分析
                  <span class="text-xs themed-text-muted font-normal">Pity触发率 / 首次用户保护 / 体验优化</span>
                </h6>
              </div>
              <div class="p-4">
                <template x-if="strategyEffectiveness.experience_mechanism_analysis">
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Pity机制 -->
                    <div class="border rounded-lg p-4">
                      <h6 class="font-semibold mb-3 flex items-center gap-2">💔 Pity机制</h6>
                      <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                          <span class="themed-text-muted">触发次数</span>
                          <span class="font-mono" x-text="strategyEffectiveness.experience_mechanism_analysis.pity?.trigger_count || 0"></span>
                        </div>
                        <div class="flex justify-between">
                          <span class="themed-text-muted">触发率</span>
                          <span class="font-mono" x-text="formatStrategyPercentage(strategyEffectiveness.experience_mechanism_analysis.pity?.trigger_rate)"></span>
                        </div>
                        <div class="flex justify-between">
                          <span class="themed-text-muted">平均连空数</span>
                          <span class="font-mono" x-text="(strategyEffectiveness.experience_mechanism_analysis.pity?.avg_empty_streak || 0).toFixed(1)"></span>
                        </div>
                      </div>
                    </div>
                    
                    <!-- 首次用户保护 -->
                    <div class="border rounded-lg p-4">
                      <h6 class="font-semibold mb-3 flex items-center gap-2">🆕 首次用户保护</h6>
                      <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                          <span class="themed-text-muted">保护用户数</span>
                          <span class="font-mono" x-text="strategyEffectiveness.experience_mechanism_analysis.first_user?.protected_count || 0"></span>
                        </div>
                        <div class="flex justify-between">
                          <span class="themed-text-muted">转化率</span>
                          <span class="font-mono" x-text="formatStrategyPercentage(strategyEffectiveness.experience_mechanism_analysis.first_user?.conversion_rate)"></span>
                        </div>
                        <div class="flex justify-between">
                          <span class="themed-text-muted">留存率</span>
                          <span class="font-mono" x-text="formatStrategyPercentage(strategyEffectiveness.experience_mechanism_analysis.first_user?.retention_rate)"></span>
                        </div>
                      </div>
                    </div>

                    <!-- 体验优化 -->
                    <div class="border rounded-lg p-4">
                      <h6 class="font-semibold mb-3 flex items-center gap-2">✨ 体验优化</h6>
                      <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                          <span class="themed-text-muted">用户满意度</span>
                          <span class="font-mono" x-text="formatStrategyPercentage(strategyEffectiveness.experience_mechanism_analysis.experience?.satisfaction_rate)"></span>
                        </div>
                        <div class="flex justify-between">
                          <span class="themed-text-muted">复抽率</span>
                          <span class="font-mono" x-text="formatStrategyPercentage(strategyEffectiveness.experience_mechanism_analysis.experience?.repeat_rate)"></span>
                        </div>
                        <div class="flex justify-between">
                          <span class="themed-text-muted">平均参与次数</span>
                          <span class="font-mono" x-text="(strategyEffectiveness.experience_mechanism_analysis.experience?.avg_participation || 0).toFixed(1)"></span>
                        </div>
                      </div>
                    </div>
                  </div>
                </template>
                <template x-if="!strategyEffectiveness.experience_mechanism_analysis">
                  <p class="text-center themed-text-muted py-4">暂无体验机制数据</p>
                </template>
              </div>
            </div>

            <!-- 档位降级统计 -->
            <div class="themed-card rounded-lg shadow">
              <div class="p-4 border-b">
                <h6 class="font-semibold flex items-center gap-2">
                  ⬇️ 档位降级统计
                  <span class="text-xs themed-text-muted font-normal">各档位降级频次和原因分析</span>
                </h6>
              </div>
              <div class="p-4">
                <template x-if="strategyEffectiveness.tier_downgrade_analysis && strategyEffectiveness.tier_downgrade_analysis.length > 0">
                  <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                      <thead class="bg-gray-50">
                        <tr>
                          <th class="p-3 text-left">原档位</th>
                          <th class="p-3 text-left">降级到</th>
                          <th class="p-3 text-right">降级次数</th>
                          <th class="p-3 text-right">占比</th>
                          <th class="p-3 text-left">主要原因</th>
                        </tr>
                      </thead>
                      <tbody>
                        <template x-for="(item, index) in strategyEffectiveness.tier_downgrade_analysis" :key="index">
                          <tr class="border-b hover:bg-gray-50">
                            <td class="p-3">
                              <span class="px-2 py-1 rounded bg-blue-100 text-blue-700 text-xs" x-text="item.from_tier"></span>
                            </td>
                            <td class="p-3">
                              <span class="px-2 py-1 rounded bg-yellow-100 text-yellow-700 text-xs" x-text="item.to_tier"></span>
                            </td>
                            <td class="p-3 text-right font-mono" x-text="(item.count || 0).toLocaleString()"></td>
                            <td class="p-3 text-right font-mono" x-text="formatStrategyPercentage(item.percentage)"></td>
                            <td class="p-3">
                              <span class="text-xs themed-text-muted" x-text="item.reason || '-'"></span>
                            </td>
                          </tr>
                        </template>
                      </tbody>
                    </table>
                  </div>
                </template>
                <template x-if="!strategyEffectiveness.tier_downgrade_analysis || strategyEffectiveness.tier_downgrade_analysis.length === 0">
                  <p class="text-center themed-text-muted py-4">暂无档位降级数据</p>
                </template>
              </div>
            </div>

            <!-- 优化建议 -->
            <div class="themed-card rounded-lg shadow">
              <div class="p-4 border-b">
                <h6 class="font-semibold flex items-center gap-2">
                  💡 优化建议
                  <span class="text-xs themed-text-muted font-normal">基于数据分析的策略改进建议</span>
                </h6>
              </div>
              <div class="p-4">
                <template x-if="strategyEffectiveness.optimization_recommendations && strategyEffectiveness.optimization_recommendations.length > 0">
                  <div class="space-y-3">
                    <template x-for="(rec, index) in strategyEffectiveness.optimization_recommendations" :key="index">
                      <div class="p-4 rounded" :class="getRecommendationPriorityStyle(rec.priority)">
                        <div class="flex items-start gap-3">
                          <span class="text-lg" x-text="rec.priority === 'high' ? '🔴' : rec.priority === 'medium' ? '🟡' : '🔵'"></span>
                          <div>
                            <p class="font-semibold" x-text="rec.title || '优化建议'"></p>
                            <p class="text-sm mt-1" x-text="rec.description || rec.content"></p>
                            <div class="mt-2 text-xs opacity-75" x-show="rec.impact">
                              预期影响: <span x-text="rec.impact"></span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </template>
                  </div>
                </template>
                <template x-if="!strategyEffectiveness.optimization_recommendations || strategyEffectiveness.optimization_recommendations.length === 0">
                  <div class="text-center py-8">
                    <div class="text-4xl mb-2">✅</div>
                    <p class="themed-text-muted">当前策略配置良好，暂无优化建议</p>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </template>
      </div>

      <!-- ==================== 运营日报页面 (P2) ==================== -->
      <div x-show="current_page === 'daily-report'" x-cloak x-init="$nextTick(() => loadDailyReportPage())">
        
        <!-- 页面标题和筛选 -->
        <div class="themed-card rounded-lg shadow p-6 mb-6">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <h5 class="font-semibold themed-text-primary flex items-center gap-2">
              📋 运营日报
              <span class="text-sm themed-text-muted font-normal">每日运营数据汇总 / 同比分析 / 告警提醒</span>
            </h5>
            <div class="flex items-center gap-3">
              <!-- 日期切换 -->
              <button @click="changeDailyReportDate(-1)" 
                      class="themed-btn-secondary px-2 py-2 rounded text-sm"
                      title="前一天">
                ◀
              </button>
              <input type="date" x-model="dailyReportFilters.report_date"
                     @change="applyDailyReportFilters()"
                     class="themed-input rounded px-3 py-2 text-sm">
              <button @click="changeDailyReportDate(1)" 
                      class="themed-btn-secondary px-2 py-2 rounded text-sm"
                      title="后一天">
                ▶
              </button>
              <select x-model="dailyReportFilters.campaign_id" 
                      @change="applyDailyReportFilters()"
                      class="themed-input rounded px-3 py-2 text-sm w-40">
                <option value="">全部活动</option>
                <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
                  <option :value="campaign.lottery_campaign_id" x-text="campaign.campaign_name"></option>
                </template>
              </select>
              <button @click="resetDailyReportFilters()" 
                      class="themed-btn-secondary px-3 py-2 rounded text-sm">
                重置
              </button>
              <button @click="refreshDailyReport()" 
                      class="themed-btn-primary px-4 py-2 rounded text-sm flex items-center gap-1"
                      :disabled="loadingDailyReport">
                <span x-show="!loadingDailyReport">🔄 刷新</span>
                <span x-show="loadingDailyReport">加载中...</span>
              </button>
              <button @click="exportDailyReport()" 
                      class="themed-btn-secondary px-4 py-2 rounded text-sm"
                      :disabled="!dailyReport">
                📥 导出
              </button>
            </div>
          </div>
        </div>

        <!-- 加载状态 -->
        <div x-show="loadingDailyReport" class="text-center py-12">
          <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mb-3"></div>
          <p class="themed-text-muted">加载运营日报数据中...</p>
        </div>

        <!-- 无数据状态 -->
        <div x-show="!loadingDailyReport && !dailyReport" class="text-center py-12">
          <div class="text-6xl mb-4">📋</div>
          <p class="themed-text-muted">暂无运营日报数据</p>
          <button @click="loadDailyReportPage()" class="mt-4 themed-btn-primary px-4 py-2 rounded">
            重新加载
          </button>
        </div>

        <!-- 日报内容 -->
        <template x-if="dailyReport && !loadingDailyReport">
          <div class="space-y-6">
            
            <!-- 报告头信息 -->
            <div class="themed-card rounded-lg shadow p-4">
              <div class="flex items-center justify-between">
                <div>
                  <span class="text-2xl font-bold" x-text="dailyReport.report_date || '-'"></span>
                  <span class="ml-2 themed-text-muted text-sm">运营日报</span>
                </div>
                <div class="text-sm themed-text-muted">
                  生成时间: <span x-text="formatDailyReportTime(dailyReport.generated_at)"></span>
                </div>
              </div>
            </div>

            <!-- 当日汇总 KPI 卡片 -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
              <!-- 总抽奖次数 -->
              <div class="themed-card rounded-lg shadow p-4 text-center">
                <div class="text-2xl mb-1">🎰</div>
                <p class="text-xs themed-text-muted mb-1">总抽奖次数</p>
                <p class="text-xl font-bold" x-text="(dailyReport.summary?.total_draws || 0).toLocaleString()"></p>
                <template x-if="dailyReport.vs_yesterday?.total_draws !== undefined">
                  <p class="text-xs mt-1" 
                     :class="formatDailyReportChange(dailyReport.vs_yesterday.total_draws).colorClass"
                     x-text="'较昨日 ' + formatDailyReportChange(dailyReport.vs_yesterday.total_draws).text"></p>
                </template>
              </div>
              
              <!-- 中奖率 -->
              <div class="themed-card rounded-lg shadow p-4 text-center">
                <div class="text-2xl mb-1">🎯</div>
                <p class="text-xs themed-text-muted mb-1">中奖率</p>
                <p class="text-xl font-bold" x-text="formatDailyReportPercentage(dailyReport.summary?.win_rate)"></p>
                <template x-if="dailyReport.vs_yesterday?.win_rate !== undefined">
                  <p class="text-xs mt-1" 
                     :class="formatDailyReportChange(dailyReport.vs_yesterday.win_rate).colorClass"
                     x-text="'较昨日 ' + formatDailyReportChange(dailyReport.vs_yesterday.win_rate).text"></p>
                </template>
              </div>
              
              <!-- 总成本 -->
              <div class="themed-card rounded-lg shadow p-4 text-center">
                <div class="text-2xl mb-1">💰</div>
                <p class="text-xs themed-text-muted mb-1">总成本</p>
                <p class="text-xl font-bold" x-text="formatDailyReportCurrency(dailyReport.summary?.total_cost)"></p>
                <template x-if="dailyReport.vs_yesterday?.total_cost !== undefined">
                  <p class="text-xs mt-1" 
                     :class="formatDailyReportChange(dailyReport.vs_yesterday.total_cost, true).colorClass"
                     x-text="'较昨日 ' + formatDailyReportChange(dailyReport.vs_yesterday.total_cost, true).text"></p>
                </template>
              </div>
              
              <!-- 总收入 -->
              <div class="themed-card rounded-lg shadow p-4 text-center">
                <div class="text-2xl mb-1">💵</div>
                <p class="text-xs themed-text-muted mb-1">总收入</p>
                <p class="text-xl font-bold" x-text="formatDailyReportCurrency(dailyReport.summary?.total_revenue)"></p>
                <template x-if="dailyReport.vs_yesterday?.total_revenue !== undefined">
                  <p class="text-xs mt-1" 
                     :class="formatDailyReportChange(dailyReport.vs_yesterday.total_revenue).colorClass"
                     x-text="'较昨日 ' + formatDailyReportChange(dailyReport.vs_yesterday.total_revenue).text"></p>
                </template>
              </div>
              
              <!-- ROI -->
              <div class="themed-card rounded-lg shadow p-4 text-center">
                <div class="text-2xl mb-1">📈</div>
                <p class="text-xs themed-text-muted mb-1">ROI</p>
                <p class="text-xl font-bold" x-text="formatDailyReportPercentage(dailyReport.summary?.roi)"></p>
                <template x-if="dailyReport.vs_yesterday?.roi !== undefined">
                  <p class="text-xs mt-1" 
                     :class="formatDailyReportChange(dailyReport.vs_yesterday.roi).colorClass"
                     x-text="'较昨日 ' + formatDailyReportChange(dailyReport.vs_yesterday.roi).text"></p>
                </template>
              </div>
              
              <!-- 活跃用户 -->
              <div class="themed-card rounded-lg shadow p-4 text-center">
                <div class="text-2xl mb-1">👥</div>
                <p class="text-xs themed-text-muted mb-1">活跃用户</p>
                <p class="text-xl font-bold" x-text="(dailyReport.summary?.active_users || 0).toLocaleString()"></p>
                <template x-if="dailyReport.vs_yesterday?.active_users !== undefined">
                  <p class="text-xs mt-1" 
                     :class="formatDailyReportChange(dailyReport.vs_yesterday.active_users).colorClass"
                     x-text="'较昨日 ' + formatDailyReportChange(dailyReport.vs_yesterday.active_users).text"></p>
                </template>
              </div>
            </div>

            <!-- 告警列表 -->
            <div class="themed-card rounded-lg shadow" x-show="dailyReport.alerts && dailyReport.alerts.length > 0">
              <div class="p-4 border-b">
                <h6 class="font-semibold flex items-center gap-2">
                  ⚠️ 当日告警 
                  <span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded" x-text="dailyReport.alerts?.length || 0"></span>
                </h6>
              </div>
              <div class="p-4 space-y-2">
                <template x-for="(alert, index) in dailyReport.alerts" :key="index">
                  <div class="p-3 rounded border" :class="getDailyAlertStyle(alert.level)">
                    <div class="flex items-start gap-2">
                      <span x-text="alert.level === 'danger' ? '🔴' : alert.level === 'warning' ? '🟡' : '🔵'"></span>
                      <div class="flex-1">
                        <p class="font-semibold" x-text="alert.title || alert.type"></p>
                        <p class="text-sm mt-1" x-text="alert.message || alert.description"></p>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </div>

            <!-- 24小时分布 -->
            <div class="themed-card rounded-lg shadow" x-show="dailyReport.hourly_breakdown && dailyReport.hourly_breakdown.length > 0">
              <div class="p-4 border-b">
                <h6 class="font-semibold flex items-center gap-2">
                  ⏰ 24小时分布
                </h6>
              </div>
              <div class="p-4">
                <div class="overflow-x-auto">
                  <div class="flex gap-1" style="min-width: 600px;">
                    <template x-for="(hour, index) in dailyReport.hourly_breakdown" :key="index">
                      <div class="flex-1 text-center">
                        <div class="h-20 bg-gray-100 rounded relative">
                          <div class="absolute bottom-0 left-0 right-0 bg-blue-500 rounded-b transition-all"
                               :style="'height: ' + Math.min(100, (hour.draws / (Math.max(...dailyReport.hourly_breakdown.map(h => h.draws)) || 1)) * 100) + '%'">
                          </div>
                        </div>
                        <p class="text-xs themed-text-muted mt-1" x-text="index + ':00'"></p>
                        <p class="text-xs font-semibold" x-text="hour.draws || 0"></p>
                      </div>
                    </template>
                  </div>
                </div>
              </div>
            </div>

            <!-- 档位分布和热门奖品 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              
              <!-- 档位分布 -->
              <div class="themed-card rounded-lg shadow" x-show="dailyReport.tier_breakdown && dailyReport.tier_breakdown.length > 0">
                <div class="p-4 border-b">
                  <h6 class="font-semibold flex items-center gap-2">
                    📊 档位分布
                  </h6>
                </div>
                <div class="p-4">
                  <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                      <tr>
                        <th class="p-2 text-left">档位</th>
                        <th class="p-2 text-right">次数</th>
                        <th class="p-2 text-right">占比</th>
                      </tr>
                    </thead>
                    <tbody>
                      <template x-for="(tier, index) in dailyReport.tier_breakdown" :key="index">
                        <tr class="border-b">
                          <td class="p-2">
                            <span class="px-2 py-0.5 rounded text-xs bg-blue-100 text-blue-700" x-text="tier.tier"></span>
                          </td>
                          <td class="p-2 text-right font-mono" x-text="(tier.count || 0).toLocaleString()"></td>
                          <td class="p-2 text-right font-mono" x-text="formatDailyReportPercentage(tier.percentage)"></td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- 热门奖品 -->
              <div class="themed-card rounded-lg shadow" x-show="dailyReport.top_prizes && dailyReport.top_prizes.length > 0">
                <div class="p-4 border-b">
                  <h6 class="font-semibold flex items-center gap-2">
                    🏆 热门奖品 TOP5
                  </h6>
                </div>
                <div class="p-4">
                  <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                      <tr>
                        <th class="p-2 text-left">奖品</th>
                        <th class="p-2 text-right">中奖次数</th>
                        <th class="p-2 text-right">总价值</th>
                      </tr>
                    </thead>
                    <tbody>
                      <template x-for="(prize, index) in dailyReport.top_prizes.slice(0, 5)" :key="index">
                        <tr class="border-b">
                          <td class="p-2">
                            <span class="font-semibold" x-text="prize.prize_name"></span>
                          </td>
                          <td class="p-2 text-right font-mono" x-text="(prize.count || 0).toLocaleString()"></td>
                          <td class="p-2 text-right font-mono" x-text="formatDailyReportCurrency(prize.total_value)"></td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- 活动明细 -->
            <div class="themed-card rounded-lg shadow" x-show="dailyReport.campaigns_breakdown && dailyReport.campaigns_breakdown.length > 0">
              <div class="p-4 border-b">
                <h6 class="font-semibold flex items-center gap-2">
                  🎁 活动明细
                </h6>
              </div>
              <div class="p-4">
                <div class="overflow-x-auto">
                  <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                      <tr>
                        <th class="p-3 text-left">活动名称</th>
                        <th class="p-3 text-right">抽奖次数</th>
                        <th class="p-3 text-right">中奖次数</th>
                        <th class="p-3 text-right">中奖率</th>
                        <th class="p-3 text-right">成本</th>
                        <th class="p-3 text-right">收入</th>
                        <th class="p-3 text-right">ROI</th>
                      </tr>
                    </thead>
                    <tbody>
                      <template x-for="(campaign, index) in dailyReport.campaigns_breakdown" :key="index">
                        <tr class="border-b hover:bg-gray-50">
                          <td class="p-3 font-semibold" x-text="campaign.campaign_name"></td>
                          <td class="p-3 text-right font-mono" x-text="(campaign.draws || 0).toLocaleString()"></td>
                          <td class="p-3 text-right font-mono" x-text="(campaign.wins || 0).toLocaleString()"></td>
                          <td class="p-3 text-right font-mono" x-text="formatDailyReportPercentage(campaign.win_rate)"></td>
                          <td class="p-3 text-right font-mono" x-text="formatDailyReportCurrency(campaign.cost)"></td>
                          <td class="p-3 text-right font-mono" x-text="formatDailyReportCurrency(campaign.revenue)"></td>
                          <td class="p-3 text-right font-mono" 
                              :class="campaign.roi > 1 ? 'text-green-600' : 'text-red-600'"
                              x-text="formatDailyReportPercentage(campaign.roi)"></td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- 同比分析卡片 -->
            <div class="themed-card rounded-lg shadow" x-show="dailyReport.vs_last_week">
              <div class="p-4 border-b">
                <h6 class="font-semibold flex items-center gap-2">
                  📅 上周同日对比
                </h6>
              </div>
              <div class="p-4">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-center text-sm">
                  <div>
                    <p class="themed-text-muted mb-1">抽奖次数</p>
                    <p class="font-semibold" 
                       :class="formatDailyReportChange(dailyReport.vs_last_week?.total_draws).colorClass"
                       x-text="formatDailyReportChange(dailyReport.vs_last_week?.total_draws).text"></p>
                  </div>
                  <div>
                    <p class="themed-text-muted mb-1">中奖率</p>
                    <p class="font-semibold" 
                       :class="formatDailyReportChange(dailyReport.vs_last_week?.win_rate).colorClass"
                       x-text="formatDailyReportChange(dailyReport.vs_last_week?.win_rate).text"></p>
                  </div>
                  <div>
                    <p class="themed-text-muted mb-1">总成本</p>
                    <p class="font-semibold" 
                       :class="formatDailyReportChange(dailyReport.vs_last_week?.total_cost, true).colorClass"
                       x-text="formatDailyReportChange(dailyReport.vs_last_week?.total_cost, true).text"></p>
                  </div>
                  <div>
                    <p class="themed-text-muted mb-1">总收入</p>
                    <p class="font-semibold" 
                       :class="formatDailyReportChange(dailyReport.vs_last_week?.total_revenue).colorClass"
                       x-text="formatDailyReportChange(dailyReport.vs_last_week?.total_revenue).text"></p>
                  </div>
                  <div>
                    <p class="themed-text-muted mb-1">ROI</p>
                    <p class="font-semibold" 
                       :class="formatDailyReportChange(dailyReport.vs_last_week?.roi).colorClass"
                       x-text="formatDailyReportChange(dailyReport.vs_last_week?.roi).text"></p>
                  </div>
                  <div>
                    <p class="themed-text-muted mb-1">活跃用户</p>
                    <p class="font-semibold" 
                       :class="formatDailyReportChange(dailyReport.vs_last_week?.active_users).colorClass"
                       x-text="formatDailyReportChange(dailyReport.vs_last_week?.active_users).text"></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </template>
      </div>

      <!-- ==================== 批量操作工具页面 (P3) ==================== -->
      <div x-show="current_page === 'batch-operations'" x-cloak>
        
        <!-- 页面标题 -->
        <div class="themed-card rounded-lg shadow p-6 mb-6">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <h5 class="font-semibold themed-text-primary flex items-center gap-2">
              ⚡ 批量操作工具
              <span class="text-sm themed-text-muted font-normal">批量赠送 / 状态切换 / 预算调整</span>
            </h5>
          </div>
        </div>

        <!-- 操作类型选择卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <!-- 批量赠送抽奖次数 -->
          <div class="themed-card rounded-lg shadow p-6 cursor-pointer hover:shadow-lg transition-shadow"
               @click="openBatchOperationsPanel('quota-grant')">
            <div class="text-center">
              <div class="text-4xl mb-3">🎁</div>
              <h6 class="font-semibold mb-2">批量赠送抽奖次数</h6>
              <p class="text-sm themed-text-muted">为多个用户批量赠送指定活动的抽奖次数</p>
            </div>
          </div>

          <!-- 批量状态切换 -->
          <div class="themed-card rounded-lg shadow p-6 cursor-pointer hover:shadow-lg transition-shadow"
               @click="openBatchOperationsPanel('campaign-status')">
            <div class="text-center">
              <div class="text-4xl mb-3">🔄</div>
              <h6 class="font-semibold mb-2">批量状态切换</h6>
              <p class="text-sm themed-text-muted">批量启动、暂停或结束多个活动</p>
            </div>
          </div>

          <!-- 批量预算调整 -->
          <div class="themed-card rounded-lg shadow p-6 cursor-pointer hover:shadow-lg transition-shadow"
               @click="openBatchOperationsPanel('budget-adjust')">
            <div class="text-center">
              <div class="text-4xl mb-3">💰</div>
              <h6 class="font-semibold mb-2">批量预算调整</h6>
              <p class="text-sm themed-text-muted">批量增加或设置多个活动的预算额度</p>
            </div>
          </div>
        </div>

        <!-- 最近批量操作记录 -->
        <div class="themed-card rounded-lg shadow">
          <div class="p-4 border-b flex justify-between items-center">
            <h6 class="font-semibold flex items-center gap-2">
              📋 最近批量操作记录
            </h6>
            <button @click="loadBatchOperationLogs()" 
                    class="themed-btn-secondary px-3 py-1 rounded text-sm"
                    :disabled="loadingBatchLogs">
              <span x-show="!loadingBatchLogs">刷新</span>
              <span x-show="loadingBatchLogs">加载中...</span>
            </button>
          </div>
          <div class="p-4">
            <div x-show="loadingBatchLogs" class="text-center py-8">
              <div class="animate-spin inline-block w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full"></div>
            </div>
            <div x-show="!loadingBatchLogs && batchOperationLogs.length === 0" class="text-center py-8 themed-text-muted">
              暂无批量操作记录
            </div>
            <template x-if="!loadingBatchLogs && batchOperationLogs.length > 0">
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="p-3 text-left">操作类型</th>
                      <th class="p-3 text-left">操作时间</th>
                      <th class="p-3 text-right">总数</th>
                      <th class="p-3 text-right">成功</th>
                      <th class="p-3 text-right">失败</th>
                      <th class="p-3 text-left">操作人</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="(log, index) in batchOperationLogs" :key="index">
                      <tr class="border-b hover:bg-gray-50">
                        <td class="p-3">
                          <span class="px-2 py-1 rounded text-xs bg-blue-100 text-blue-700" 
                                x-text="getBatchOperationTypeText(log.operation_type)"></span>
                        </td>
                        <td class="p-3 themed-text-muted" x-text="formatBatchOperationTime(log.created_at)"></td>
                        <td class="p-3 text-right font-mono" x-text="log.total_count || 0"></td>
                        <td class="p-3 text-right font-mono text-green-600" x-text="log.success_count || 0"></td>
                        <td class="p-3 text-right font-mono text-red-600" x-text="log.fail_count || 0"></td>
                        <td class="p-3 themed-text-muted" x-text="log.operator_name || log.operator_id"></td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- 批量操作面板弹窗 -->
      <div x-show="showBatchOperationsPanel" 
           class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
           x-cloak
           @click.self="closeBatchOperationsPanel()">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] overflow-auto">
          <div class="p-4 border-b flex justify-between items-center themed-bg-primary text-white rounded-t-lg">
            <h5 class="font-semibold" x-text="getBatchOperationTypeText(currentBatchOperation)"></h5>
            <button @click="closeBatchOperationsPanel()" class="p-2 hover:bg-white/20 rounded">✕</button>
          </div>
          
          <div class="p-6">
            <!-- 批量赠送抽奖次数表单 -->
            <template x-if="currentBatchOperation === 'quota-grant'">
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-1">活动选择 <span class="text-red-500">*</span></label>
                  <select x-model="batchQuotaGrantForm.campaign_id" class="themed-input w-full rounded px-3 py-2">
                    <option value="">请选择活动</option>
                    <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
                      <option :value="campaign.lottery_campaign_id" x-text="campaign.campaign_name"></option>
                    </template>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">用户ID列表 <span class="text-red-500">*</span></label>
                  <textarea x-model="batchQuotaGrantForm.user_ids" 
                            class="themed-input w-full rounded px-3 py-2 h-24"
                            placeholder="输入用户ID，支持逗号、换行、空格分隔&#10;例如：1001, 1002, 1003&#10;或每行一个ID"></textarea>
                  <p class="text-xs themed-text-muted mt-1">单次最多支持100个用户</p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">赠送次数 <span class="text-red-500">*</span></label>
                  <input type="number" x-model.number="batchQuotaGrantForm.bonus_count" 
                         class="themed-input w-full rounded px-3 py-2" min="1" max="100">
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">赠送原因 <span class="text-red-500">*</span></label>
                  <input type="text" x-model="batchQuotaGrantForm.reason" 
                         class="themed-input w-full rounded px-3 py-2"
                         placeholder="例如：节日活动补偿">
                </div>
              </div>
            </template>

            <!-- 批量状态切换表单 -->
            <template x-if="currentBatchOperation === 'campaign-status'">
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-2">选择活动 <span class="text-red-500">*</span></label>
                  <div class="border rounded max-h-48 overflow-auto">
                    <label class="flex items-center gap-2 p-2 border-b bg-gray-50">
                      <input type="checkbox" 
                             @change="toggleAllCampaignsSelection($event.target.checked)"
                             :checked="batchCampaignStatusForm.campaign_ids.length === campaigns.length">
                      <span class="text-sm font-medium">全选</span>
                    </label>
                    <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
                      <label class="flex items-center gap-2 p-2 border-b hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" 
                               :checked="isCampaignSelected(campaign.lottery_campaign_id)"
                               @change="toggleCampaignSelection(campaign.lottery_campaign_id)">
                        <span class="text-sm" x-text="campaign.campaign_name"></span>
                        <span class="text-xs px-2 py-0.5 rounded"
                              :class="campaign.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'"
                              x-text="getCampaignStatusText(campaign.status)"></span>
                      </label>
                    </template>
                  </div>
                  <p class="text-xs themed-text-muted mt-1">已选择 <span x-text="batchCampaignStatusForm.campaign_ids.length"></span> 个活动</p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">目标状态 <span class="text-red-500">*</span></label>
                  <select x-model="batchCampaignStatusForm.target_status" class="themed-input w-full rounded px-3 py-2">
                    <option value="active">进行中</option>
                    <option value="paused">暂停</option>
                    <option value="ended">结束</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">操作原因 <span class="text-red-500">*</span></label>
                  <input type="text" x-model="batchCampaignStatusForm.reason" 
                         class="themed-input w-full rounded px-3 py-2"
                         placeholder="例如：活动期结束">
                </div>
              </div>
            </template>

            <!-- 批量预算调整表单 -->
            <template x-if="currentBatchOperation === 'budget-adjust'">
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-2">选择活动 <span class="text-red-500">*</span></label>
                  <div class="border rounded max-h-48 overflow-auto">
                    <label class="flex items-center gap-2 p-2 border-b bg-gray-50">
                      <input type="checkbox" 
                             @change="toggleAllCampaignsSelection($event.target.checked)"
                             :checked="batchBudgetAdjustForm.campaign_ids.length === campaigns.length">
                      <span class="text-sm font-medium">全选</span>
                    </label>
                    <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
                      <label class="flex items-center gap-2 p-2 border-b hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" 
                               :checked="batchBudgetAdjustForm.campaign_ids.includes(campaign.lottery_campaign_id)"
                               @change="toggleCampaignSelection(campaign.lottery_campaign_id)">
                        <span class="text-sm" x-text="campaign.campaign_name"></span>
                      </label>
                    </template>
                  </div>
                  <p class="text-xs themed-text-muted mt-1">已选择 <span x-text="batchBudgetAdjustForm.campaign_ids.length"></span> 个活动</p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">调整类型 <span class="text-red-500">*</span></label>
                  <select x-model="batchBudgetAdjustForm.adjust_type" class="themed-input w-full rounded px-3 py-2">
                    <option value="add">增加预算</option>
                    <option value="set">设置预算</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">金额 <span class="text-red-500">*</span></label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 themed-text-muted">¥</span>
                    <input type="number" x-model.number="batchBudgetAdjustForm.amount" 
                           class="themed-input w-full rounded pl-7 pr-3 py-2" min="0" step="0.01">
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">操作原因 <span class="text-red-500">*</span></label>
                  <input type="text" x-model="batchBudgetAdjustForm.reason" 
                         class="themed-input w-full rounded px-3 py-2"
                         placeholder="例如：追加节日预算">
                </div>
              </div>
            </template>

            <!-- 操作结果 -->
            <template x-if="batchOperationResult">
              <div class="mt-6 p-4 rounded bg-gray-50">
                <h6 class="font-semibold mb-3">📊 操作结果</h6>
                <div class="grid grid-cols-3 gap-4 text-center">
                  <div>
                    <p class="text-2xl font-bold" x-text="batchOperationResult.total_count || 0"></p>
                    <p class="text-xs themed-text-muted">总数</p>
                  </div>
                  <div>
                    <p class="text-2xl font-bold text-green-600" x-text="batchOperationResult.success_count || 0"></p>
                    <p class="text-xs themed-text-muted">成功</p>
                  </div>
                  <div>
                    <p class="text-2xl font-bold text-red-600" x-text="batchOperationResult.fail_count || 0"></p>
                    <p class="text-xs themed-text-muted">失败</p>
                  </div>
                </div>
                <template x-if="batchOperationResult.result_details?.failed_items?.length > 0">
                  <div class="mt-4">
                    <p class="text-sm font-medium mb-2 text-red-600">失败详情:</p>
                    <div class="max-h-32 overflow-auto text-xs bg-red-50 p-2 rounded">
                      <template x-for="(item, idx) in batchOperationResult.result_details.failed_items" :key="idx">
                        <p class="mb-1" x-text="item.reason || item.error || JSON.stringify(item)"></p>
                      </template>
                    </div>
                  </div>
                </template>
              </div>
            </template>
          </div>

          <!-- 操作按钮 -->
          <div class="p-4 border-t flex justify-end gap-2">
            <button @click="closeBatchOperationsPanel()" class="themed-btn-secondary px-4 py-2 rounded">
              关闭
            </button>
            <button @click="currentBatchOperation === 'quota-grant' ? executeBatchQuotaGrant() : currentBatchOperation === 'campaign-status' ? executeBatchCampaignStatus() : executeBatchBudgetAdjust()"
                    class="themed-btn-primary px-4 py-2 rounded flex items-center gap-1"
                    :disabled="executingBatchOperation">
              <span x-show="!executingBatchOperation">⚡ 执行批量操作</span>
              <span x-show="executingBatchOperation">执行中...</span>
            </button>
          </div>
        </div>
      </div>

      <!-- ==================== P1-3: 预设可视化页面 ==================== -->
      <div x-show="current_page === 'preset-visualization'" x-cloak>
        <!-- 预设状态统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl mb-2">🎯</div>
            <h6 class="themed-text-muted text-sm mb-1">总预设数</h6>
            <h2 class="text-2xl font-bold themed-text-primary" x-text="presetStats.total_presets || 0"></h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center cursor-pointer hover:shadow-lg transition-shadow"
               @click="presetFilters.status = 'pending'; searchPresets()">
            <div class="text-3xl text-green-500 mb-2">🟢</div>
            <h6 class="themed-text-muted text-sm mb-1">活跃</h6>
            <h2 class="text-2xl font-bold text-green-600" x-text="presetStats.active_count || presetStats.pending_presets || 0"></h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center cursor-pointer hover:shadow-lg transition-shadow"
               @click="presetFilters.status = 'paused'; searchPresets()">
            <div class="text-3xl text-yellow-500 mb-2">🟡</div>
            <h6 class="themed-text-muted text-sm mb-1">暂停</h6>
            <h2 class="text-2xl font-bold text-yellow-600" x-text="presetStats.paused_count || 0"></h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center cursor-pointer hover:shadow-lg transition-shadow"
               @click="presetFilters.status = 'exhausted'; searchPresets()">
            <div class="text-3xl text-red-500 mb-2">🔴</div>
            <h6 class="themed-text-muted text-sm mb-1">耗尽</h6>
            <h2 class="text-2xl font-bold text-red-600" x-text="presetStats.exhausted_count || 0"></h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center cursor-pointer hover:shadow-lg transition-shadow"
               @click="presetFilters.status = 'used'; searchPresets()">
            <div class="text-3xl text-gray-400 mb-2">⚪</div>
            <h6 class="themed-text-muted text-sm mb-1">已使用</h6>
            <h2 class="text-2xl font-bold text-gray-600" x-text="presetStats.used_presets || 0"></h2>
          </div>
        </div>

        <!-- 预设列表 -->
        <div class="themed-card rounded-lg shadow">
          <div class="p-4 border-b flex justify-between items-center">
            <h5 class="font-semibold">📋 预设队列列表</h5>
            <button @click="openCreatePresetModal()" class="px-4 py-2 themed-bg-primary text-white rounded hover:opacity-90 transition-colors">
              ➕ 创建预设
            </button>
          </div>
          
          <!-- 筛选器 -->
          <div class="p-4 border-b themed-bg-base">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <select class="px-3 py-2 border rounded" x-model="presetFilters.status" @change="searchPresets()">
                <option value="">全部状态</option>
                <option value="pending">待使用/活跃</option>
                <option value="used">已使用</option>
                <option value="paused">暂停</option>
                <option value="exhausted">耗尽</option>
              </select>
              <input type="text" class="px-3 py-2 border rounded" placeholder="用户ID..." 
                     x-model="presetFilters.user_id" @keyup.enter="searchPresets()">
              <button class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" @click="searchPresets()">
                🔍 搜索
              </button>
              <button class="px-4 py-2 themed-btn-secondary rounded" @click="resetPresetFilters()">
                🔄 重置
              </button>
            </div>
          </div>

          <!-- 预设表格 -->
          <div class="p-4 overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="border-b">
                  <th class="text-left py-3 px-2">ID</th>
                  <th class="text-left py-3 px-2">用户ID</th>
                  <th class="text-left py-3 px-2">奖品</th>
                  <th class="text-left py-3 px-2">队列顺序</th>
                  <th class="text-left py-3 px-2">状态</th>
                  <th class="text-left py-3 px-2">创建时间</th>
                  <th class="text-left py-3 px-2">使用时间</th>
                  <th class="text-left py-3 px-2">操作</th>
                </tr>
              </thead>
              <tbody>
                <!-- 骨架屏加载状态 -->
                <template x-if="loading">
                  <template x-for="i in 5" :key="'skeleton-preset-' + i">
                    <tr class="border-b animate-pulse">
                      <td class="py-3 px-2"><div class="skeleton-text-sm w-12"></div></td>
                      <td class="py-3 px-2"><div class="skeleton-text-sm w-16"></div></td>
                      <td class="py-3 px-2"><div class="skeleton-text w-32"></div></td>
                      <td class="py-3 px-2"><div class="skeleton-text-sm w-8"></div></td>
                      <td class="py-3 px-2"><div class="skeleton-button-sm w-16"></div></td>
                      <td class="py-3 px-2"><div class="skeleton-text-sm w-28"></div></td>
                      <td class="py-3 px-2"><div class="skeleton-text-sm w-28"></div></td>
                      <td class="py-3 px-2"><div class="skeleton-button-sm w-20"></div></td>
                    </tr>
                  </template>
                </template>
                <!-- 数据行 -->
                <template x-for="preset in presets" :key="preset.lottery_preset_id">
                  <tr class="border-b hover:bg-gray-50 transition-colors">
                    <td class="py-3 px-2 text-sm" x-text="preset.lottery_preset_id"></td>
                    <td class="py-3 px-2">
                      <span class="text-blue-600 hover:underline cursor-pointer" 
                            x-text="preset.user_id" 
                            @click="viewUserProfile(preset.user_id)"></span>
                    </td>
                    <td class="py-3 px-2">
                      <div class="text-sm font-medium" x-text="preset.prize?.name || preset.prize_name || '-'"></div>
                      <div class="text-xs themed-text-muted" x-text="'#' + (preset.lottery_prize_id || '')"></div>
                    </td>
                    <td class="py-3 px-2 text-center">
                      <span class="inline-block px-2 py-1 rounded bg-blue-100 text-blue-800 text-sm font-medium" 
                            x-text="preset.queue_order || '-'"></span>
                    </td>
                    <td class="py-3 px-2">
                      <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium"
                            :class="getPresetStatusClass(preset.status)">
                        <span x-text="getPresetStatusIcon(preset.status)"></span>
                        <span x-text="getPresetStatusText(preset.status)"></span>
                      </span>
                    </td>
                    <td class="py-3 px-2 text-sm themed-text-muted" x-text="formatDate(preset.created_at)"></td>
                    <td class="py-3 px-2 text-sm themed-text-muted" x-text="preset.used_at ? formatDate(preset.used_at) : '-'"></td>
                    <td class="py-3 px-2">
                      <div class="flex gap-2">
                        <button class="px-2 py-1 text-xs border border-blue-500 text-blue-500 rounded hover:bg-blue-50"
                                @click="viewPresetDetail(preset)">
                          👁️ 详情
                        </button>
                        <button x-show="preset.status === 'pending'"
                                class="px-2 py-1 text-xs border border-red-500 text-red-500 rounded hover:bg-red-50"
                                @click="deleteUserPresets(preset.user_id)">
                          🗑️ 取消
                        </button>
                      </div>
                    </td>
                  </tr>
                </template>
                <!-- 空状态 -->
                <template x-if="presets.length === 0 && !loading">
                  <tr>
                    <td colspan="8" class="py-12 text-center">
                      <div class="text-4xl mb-2">🎯</div>
                      <p class="themed-text-muted">暂无预设数据</p>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>

          <!-- 分页 -->
          <div class="p-4 border-t flex justify-between items-center" x-show="presets.length > 0">
            <span class="text-sm themed-text-muted">
              共 <span x-text="presetPagination.total"></span> 条
            </span>
            <div class="flex gap-2">
              <button class="px-3 py-1 border rounded" 
                      :disabled="presetPagination.page <= 1"
                      @click="changePresetPage(presetPagination.page - 1)">
                上一页
              </button>
              <span class="px-3 py-1">
                <span x-text="presetPagination.page"></span> / <span x-text="presetTotalPages"></span>
              </span>
              <button class="px-3 py-1 border rounded" 
                      :disabled="presetPagination.page >= presetTotalPages"
                      @click="changePresetPage(presetPagination.page + 1)">
                下一页
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== P1-10: 系统垫付看板页面 ==================== -->
      <div x-show="current_page === 'system-advance'" x-cloak>
        <!-- 垫付汇总卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl mb-2">💳</div>
            <h6 class="themed-text-muted text-sm mb-1">库存垫付(件)</h6>
            <h2 class="text-2xl font-bold text-yellow-600" x-text="advanceDashboard.total_inventory_debt || 0"></h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-blue-500 mb-2">💰</div>
            <h6 class="themed-text-muted text-sm mb-1">预算垫付</h6>
            <h2 class="text-2xl font-bold text-blue-600" x-text="formatAdvanceAmount(advanceDashboard.total_budget_debt)"></h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-red-500 mb-2">⏳</div>
            <h6 class="themed-text-muted text-sm mb-1">待处理</h6>
            <h2 class="text-2xl font-bold text-red-600" x-text="advanceDashboard.pending_count || 0"></h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-green-500 mb-2">✅</div>
            <h6 class="themed-text-muted text-sm mb-1">今日已清偿</h6>
            <h2 class="text-2xl font-bold text-green-600" x-text="advanceDashboard.cleared_today || 0"></h2>
          </div>
        </div>

        <!-- Tab 切换 -->
        <div class="themed-card rounded-lg shadow mb-6">
          <div class="flex border-b">
            <button @click="switchAdvanceTab('overview')"
                    :class="advanceViewTab === 'overview' ? 'border-b-2 border-blue-500 text-blue-600 bg-blue-50' : 'themed-text-muted'"
                    class="px-5 py-3 font-medium">
              📊 总览
            </button>
            <button @click="switchAdvanceTab('by-campaign')"
                    :class="advanceViewTab === 'by-campaign' ? 'border-b-2 border-blue-500 text-blue-600 bg-blue-50' : 'themed-text-muted'"
                    class="px-5 py-3 font-medium">
              🎁 按活动
            </button>
            <button @click="switchAdvanceTab('by-prize')"
                    :class="advanceViewTab === 'by-prize' ? 'border-b-2 border-blue-500 text-blue-600 bg-blue-50' : 'themed-text-muted'"
                    class="px-5 py-3 font-medium">
              🏆 按奖品
            </button>
            <button @click="switchAdvanceTab('by-creator')"
                    :class="advanceViewTab === 'by-creator' ? 'border-b-2 border-blue-500 text-blue-600 bg-blue-50' : 'themed-text-muted'"
                    class="px-5 py-3 font-medium">
              👤 按责任人
            </button>
            <button @click="switchAdvanceTab('trend')"
                    :class="advanceViewTab === 'trend' ? 'border-b-2 border-blue-500 text-blue-600 bg-blue-50' : 'themed-text-muted'"
                    class="px-5 py-3 font-medium">
              📈 趋势
            </button>
          </div>

          <!-- 总览视图 -->
          <div x-show="advanceViewTab === 'overview'" class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- 库存垫付详情 -->
              <div class="border rounded-lg p-4">
                <h6 class="font-semibold mb-3 flex items-center gap-2">
                  <span class="text-yellow-500">📦</span> 库存垫付详情
                </h6>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="themed-text-muted">总欠账数量:</span>
                    <span class="font-medium" x-text="advanceDashboard.inventory_debt_details?.total_quantity || 0"></span>
                  </div>
                  <div class="flex justify-between">
                    <span class="themed-text-muted">已清偿数量:</span>
                    <span class="font-medium text-green-600" x-text="advanceDashboard.inventory_debt_details?.cleared_quantity || 0"></span>
                  </div>
                  <div class="flex justify-between">
                    <span class="themed-text-muted">剩余欠账:</span>
                    <span class="font-medium text-red-600" x-text="advanceDashboard.inventory_debt_details?.remaining_quantity || advanceDashboard.total_inventory_debt || 0"></span>
                  </div>
                </div>
              </div>
              <!-- 预算垫付详情 -->
              <div class="border rounded-lg p-4">
                <h6 class="font-semibold mb-3 flex items-center gap-2">
                  <span class="text-blue-500">💰</span> 预算垫付详情
                </h6>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="themed-text-muted">总欠账金额:</span>
                    <span class="font-medium" x-text="formatAdvanceAmount(advanceDashboard.budget_debt_details?.total_amount)"></span>
                  </div>
                  <div class="flex justify-between">
                    <span class="themed-text-muted">已清偿金额:</span>
                    <span class="font-medium text-green-600" x-text="formatAdvanceAmount(advanceDashboard.budget_debt_details?.cleared_amount)"></span>
                  </div>
                  <div class="flex justify-between">
                    <span class="themed-text-muted">剩余欠账:</span>
                    <span class="font-medium text-red-600" x-text="formatAdvanceAmount(advanceDashboard.budget_debt_details?.remaining_amount || advanceDashboard.total_budget_debt)"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 按活动视图 -->
          <div x-show="advanceViewTab === 'by-campaign'" class="p-4">
            <table class="w-full">
              <thead>
                <tr class="border-b">
                  <th class="text-left py-3 px-2">活动名称</th>
                  <th class="text-left py-3 px-2">库存欠账</th>
                  <th class="text-left py-3 px-2">预算欠账</th>
                  <th class="text-left py-3 px-2">状态</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="item in advanceByCampaign" :key="item.lottery_campaign_id">
                  <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-2" x-text="item.campaign_name || '-'"></td>
                    <td class="py-3 px-2">
                      <span class="text-yellow-600 font-medium" x-text="item.inventory_debt || 0"></span> 件
                    </td>
                    <td class="py-3 px-2">
                      <span class="text-blue-600 font-medium" x-text="formatAdvanceAmount(item.budget_debt)"></span>
                    </td>
                    <td class="py-3 px-2">
                      <span class="px-2 py-1 rounded text-xs"
                            :class="item.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'"
                            x-text="item.status === 'active' ? '进行中' : '已结束'"></span>
                    </td>
                  </tr>
                </template>
                <template x-if="advanceByCampaign.length === 0 && !loading">
                  <tr>
                    <td colspan="4" class="py-8 text-center themed-text-muted">暂无数据</td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>

          <!-- 按奖品视图 -->
          <div x-show="advanceViewTab === 'by-prize'" class="p-4">
            <table class="w-full">
              <thead>
                <tr class="border-b">
                  <th class="text-left py-3 px-2">奖品名称</th>
                  <th class="text-left py-3 px-2">所属活动</th>
                  <th class="text-left py-3 px-2">库存欠账</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="item in advanceByPrize" :key="item.lottery_prize_id">
                  <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-2" x-text="item.prize_name || item.name || '-'"></td>
                    <td class="py-3 px-2 text-sm themed-text-muted" x-text="item.campaign_name || '-'"></td>
                    <td class="py-3 px-2">
                      <span class="text-yellow-600 font-medium" x-text="item.owed_quantity || 0"></span> 件
                    </td>
                  </tr>
                </template>
                <template x-if="advanceByPrize.length === 0 && !loading">
                  <tr>
                    <td colspan="3" class="py-8 text-center themed-text-muted">暂无数据</td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>

          <!-- 按责任人视图 -->
          <div x-show="advanceViewTab === 'by-creator'" class="p-4">
            <table class="w-full">
              <thead>
                <tr class="border-b">
                  <th class="text-left py-3 px-2">创建人</th>
                  <th class="text-left py-3 px-2">预设数量</th>
                  <th class="text-left py-3 px-2">库存欠账</th>
                  <th class="text-left py-3 px-2">预算欠账</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="item in advanceByCreator" :key="item.creator_id">
                  <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-2">
                      <span class="text-blue-600" x-text="item.creator_name || '管理员#' + item.creator_id"></span>
                    </td>
                    <td class="py-3 px-2" x-text="item.preset_count || 0"></td>
                    <td class="py-3 px-2">
                      <span class="text-yellow-600 font-medium" x-text="item.inventory_debt || 0"></span> 件
                    </td>
                    <td class="py-3 px-2">
                      <span class="text-blue-600 font-medium" x-text="formatAdvanceAmount(item.budget_debt)"></span>
                    </td>
                  </tr>
                </template>
                <template x-if="advanceByCreator.length === 0 && !loading">
                  <tr>
                    <td colspan="4" class="py-8 text-center themed-text-muted">暂无数据</td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>

          <!-- 趋势视图 -->
          <div x-show="advanceViewTab === 'trend'" class="p-4">
            <div class="mb-4 flex gap-4">
              <select class="px-3 py-2 border rounded" x-model="advanceFilters.period" @change="loadAdvanceTrend()">
                <option value="day">按日</option>
                <option value="week">按周</option>
                <option value="month">按月</option>
              </select>
              <select class="px-3 py-2 border rounded" x-model="advanceFilters.days" @change="loadAdvanceTrend()">
                <option value="7">近7天</option>
                <option value="30">近30天</option>
                <option value="90">近90天</option>
              </select>
            </div>
            <div id="advanceTrendChart" class="w-full h-80"></div>
          </div>

          <!-- 分页 -->
          <div class="p-4 border-t flex justify-between items-center" 
               x-show="['by-campaign', 'by-prize', 'by-creator'].includes(advanceViewTab)">
            <span class="text-sm themed-text-muted">
              共 <span x-text="advancePagination.total"></span> 条
            </span>
            <div class="flex gap-2">
              <button class="px-3 py-1 border rounded" 
                      :disabled="advancePagination.page <= 1"
                      @click="changeAdvancePage(advancePagination.page - 1)">
                上一页
              </button>
              <span class="px-3 py-1">
                <span x-text="advancePagination.page"></span> / <span x-text="advanceTotalPages"></span>
              </span>
              <button class="px-3 py-1 border rounded" 
                      :disabled="advancePagination.page >= advanceTotalPages"
                      @click="changeAdvancePage(advancePagination.page + 1)">
                下一页
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 创建预设模态框 -->
      <div x-show="showCreatePresetModal" 
           class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
           x-cloak
           @click.self="showCreatePresetModal = false; hideModal('createPresetModal')">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-auto">
          <div class="p-4 border-b flex justify-between items-center">
            <h5 class="font-semibold">➕ 创建抽奖预设</h5>
            <button @click="showCreatePresetModal = false; hideModal('createPresetModal')" class="text-gray-500 hover:text-gray-700 text-xl">✕</button>
          </div>
          <div class="p-6">
            <div class="mb-4">
              <label class="block text-sm font-medium mb-1">目标用户ID *</label>
              <input type="number" class="w-full px-3 py-2 border rounded" 
                     placeholder="请输入用户ID" x-model="createPresetForm.user_id">
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2">预设列表 *</label>
              <template x-for="(preset, index) in createPresetForm.presets" :key="index">
                <div class="flex gap-2 mb-2 items-center">
                  <span class="text-sm themed-text-muted w-8" x-text="'#' + (index + 1)"></span>
                  <select class="flex-1 px-3 py-2 border rounded" x-model="preset.lottery_prize_id">
                    <option value="">选择奖品...</option>
                    <template x-for="prize in prizeOptions" :key="prize.value">
                      <option :value="prize.value" x-text="prize.label"></option>
                    </template>
                  </select>
                  <button type="button" @click="removePresetItem(index)" 
                          class="px-2 py-1 text-red-500 hover:bg-red-50 rounded"
                          x-show="createPresetForm.presets.length > 1">
                    ✕
                  </button>
                </div>
              </template>
              <button type="button" @click="addPresetItem()" 
                      class="text-sm text-blue-600 hover:text-blue-800 mt-2">
                ➕ 添加预设项
              </button>
            </div>
            <div class="text-sm themed-text-muted mb-4">
              💡 预设将按顺序依次生效，用户每次抽奖将按队列顺序获得预设奖品
            </div>
          </div>
          <div class="p-4 border-t flex justify-end gap-2">
            <button @click="showCreatePresetModal = false; hideModal('createPresetModal')" 
                    class="themed-btn-secondary px-4 py-2 rounded">
              取消
            </button>
            <button @click="submitCreatePreset()" 
                    class="themed-btn-primary px-4 py-2 rounded"
                    :disabled="saving">
              <span x-show="!saving">确认创建</span>
              <span x-show="saving">创建中...</span>
            </button>
          </div>
        </div>
      </div>

      <!-- 预设详情模态框 -->
      <div x-show="selectedPreset && $el.querySelector('#presetDetailModal')?.open !== false" 
           class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
           x-cloak
           @click.self="selectedPreset = null">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
          <div class="p-4 border-b flex justify-between items-center">
            <h5 class="font-semibold">🎯 预设详情</h5>
            <button @click="selectedPreset = null" class="text-gray-500 hover:text-gray-700 text-xl">✕</button>
          </div>
          <div class="p-6" x-show="selectedPreset">
            <div class="space-y-3">
              <div class="flex justify-between">
                <span class="themed-text-muted">预设ID:</span>
                <span class="font-medium" x-text="selectedPreset?.lottery_preset_id"></span>
              </div>
              <div class="flex justify-between">
                <span class="themed-text-muted">用户ID:</span>
                <span class="font-medium text-blue-600" x-text="selectedPreset?.user_id"></span>
              </div>
              <div class="flex justify-between">
                <span class="themed-text-muted">奖品:</span>
                <span class="font-medium" x-text="selectedPreset?.prize?.name || selectedPreset?.prize_name || '-'"></span>
              </div>
              <div class="flex justify-between">
                <span class="themed-text-muted">队列顺序:</span>
                <span class="font-medium" x-text="selectedPreset?.queue_order"></span>
              </div>
              <div class="flex justify-between">
                <span class="themed-text-muted">状态:</span>
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium"
                      :class="getPresetStatusClass(selectedPreset?.status)">
                  <span x-text="getPresetStatusIcon(selectedPreset?.status)"></span>
                  <span x-text="getPresetStatusText(selectedPreset?.status)"></span>
                </span>
              </div>
              <div class="flex justify-between">
                <span class="themed-text-muted">创建时间:</span>
                <span x-text="formatDate(selectedPreset?.created_at)"></span>
              </div>
              <div class="flex justify-between" x-show="selectedPreset?.used_at">
                <span class="themed-text-muted">使用时间:</span>
                <span x-text="formatDate(selectedPreset?.used_at)"></span>
              </div>
              <div class="flex justify-between" x-show="selectedPreset?.created_by">
                <span class="themed-text-muted">创建人:</span>
                <span x-text="selectedPreset?.created_by_name || '管理员#' + selectedPreset?.created_by"></span>
              </div>
            </div>
          </div>
          <div class="p-4 border-t flex justify-end">
            <button @click="selectedPreset = null" class="themed-btn-secondary px-4 py-2 rounded">
              关闭
            </button>
          </div>
        </div>
      </div>

      <!-- 活动复盘报告弹窗 (P2) -->
      <div x-show="showReportModal" 
           class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
           x-cloak
           @click.self="closeReportModal()">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-5xl max-h-[90vh] overflow-auto">
          <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10">
            <h5 class="font-semibold">📋 活动复盘报告</h5>
            <div class="flex items-center gap-2">
              <button @click="exportReportPDF()" 
                      :disabled="exportingReport || !campaignReport"
                      class="px-3 py-1 text-sm rounded bg-green-100 text-green-700 hover:bg-green-200 disabled:opacity-50">
                <span x-show="exportingReport">导出中...</span>
                <span x-show="!exportingReport">📥 导出PDF</span>
              </button>
              <button @click="closeReportModal()" class="text-gray-500 hover:text-gray-700 text-xl">✕</button>
            </div>
          </div>

          <!-- 加载状态 -->
          <div x-show="loadingReport" class="p-8 text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <p class="themed-text-muted">生成复盘报告中...</p>
          </div>

          <!-- 报告内容 -->
          <div x-show="!loadingReport && campaignReport" class="p-6">
            <template x-if="campaignReport">
              <div class="space-y-6">
                <!-- 活动基本信息 -->
                <div class="themed-card rounded-lg shadow p-4">
                  <h6 class="font-semibold mb-3 flex items-center gap-2">
                    <span>📋</span> 活动信息
                  </h6>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                      <span class="themed-text-muted">活动名称:</span>
                      <p class="font-medium" x-text="campaignReport.campaign_info?.campaign_name || '-'"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">开始日期:</span>
                      <p x-text="formatReportTime(campaignReport.campaign_info?.start_date)"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">结束日期:</span>
                      <p x-text="formatReportTime(campaignReport.campaign_info?.end_date)"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">持续天数:</span>
                      <p x-text="(campaignReport.campaign_info?.duration_days || 0) + '天'"></p>
                    </div>
                  </div>
                </div>

                <!-- 核心指标 -->
                <div class="themed-card rounded-lg shadow p-4">
                  <h6 class="font-semibold mb-3 flex items-center gap-2">
                    <span>📊</span> 核心指标
                  </h6>
                  <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="text-center p-3 bg-blue-50 rounded">
                      <div class="text-2xl font-bold text-blue-600" x-text="formatNumber(campaignReport.overview?.total_draws)"></div>
                      <div class="text-xs themed-text-muted">抽奖次数</div>
                    </div>
                    <div class="text-center p-3 bg-green-50 rounded">
                      <div class="text-2xl font-bold text-green-600" x-text="formatNumber(campaignReport.overview?.unique_users)"></div>
                      <div class="text-xs themed-text-muted">独立用户</div>
                    </div>
                    <div class="text-center p-3 bg-yellow-50 rounded">
                      <div class="text-2xl font-bold text-yellow-600" x-text="formatNumber(campaignReport.overview?.total_cost)"></div>
                      <div class="text-xs themed-text-muted">成本(积分)</div>
                    </div>
                    <div class="text-center p-3 bg-purple-50 rounded">
                      <div class="text-2xl font-bold text-purple-600" x-text="formatPercent(campaignReport.overview?.roi)"></div>
                      <div class="text-xs themed-text-muted">ROI</div>
                    </div>
                    <div class="text-center p-3 bg-pink-50 rounded">
                      <div class="text-2xl font-bold text-pink-600" x-text="formatPercent(campaignReport.overview?.retention_rate)"></div>
                      <div class="text-xs themed-text-muted">复购率</div>
                    </div>
                  </div>
                </div>

                <!-- 奖品分析 -->
                <div x-show="campaignReport.prize_analysis" class="themed-card rounded-lg shadow p-4">
                  <h6 class="font-semibold mb-3 flex items-center gap-2">
                    <span>🏆</span> 奖品分析
                  </h6>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                      <span class="themed-text-muted">总中奖次数:</span>
                      <p class="font-medium" x-text="formatNumber(campaignReport.prize_analysis?.total_wins)"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">中奖率:</span>
                      <p class="font-medium" x-text="formatPercent(campaignReport.prize_analysis?.win_rate)"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">最热门奖品:</span>
                      <p class="font-medium" x-text="campaignReport.prize_analysis?.top_prize?.name || '-'"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">奖品种类:</span>
                      <p class="font-medium" x-text="campaignReport.prize_analysis?.prize_count || 0"></p>
                    </div>
                  </div>
                </div>

                <!-- 用户分析 -->
                <div x-show="campaignReport.user_analysis" class="themed-card rounded-lg shadow p-4">
                  <h6 class="font-semibold mb-3 flex items-center gap-2">
                    <span>👥</span> 用户分析
                  </h6>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                      <span class="themed-text-muted">新用户占比:</span>
                      <p class="font-medium" x-text="formatPercent(campaignReport.user_analysis?.new_user_ratio)"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">人均抽奖:</span>
                      <p class="font-medium" x-text="(campaignReport.user_analysis?.avg_draws_per_user?.toFixed(2) || 0) + '次'"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">活跃用户:</span>
                      <p class="font-medium" x-text="formatNumber(campaignReport.user_analysis?.active_users)"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">复购率:</span>
                      <p class="font-medium" x-text="formatPercent(campaignReport.user_analysis?.retention_rate)"></p>
                    </div>
                  </div>
                </div>

                <!-- 体验指标 -->
                <div x-show="campaignReport.experience_metrics" class="themed-card rounded-lg shadow p-4">
                  <h6 class="font-semibold mb-3 flex items-center gap-2">
                    <span>🎯</span> 体验指标
                  </h6>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                      <span class="themed-text-muted">平均连空:</span>
                      <p class="font-medium" x-text="(campaignReport.experience_metrics?.avg_empty_streak?.toFixed(2) || 0) + '次'"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">Pity触发率:</span>
                      <p class="font-medium" x-text="formatPercent(campaignReport.experience_metrics?.pity_trigger_rate)"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">AntiEmpty触发率:</span>
                      <p class="font-medium" x-text="formatPercent(campaignReport.experience_metrics?.anti_empty_trigger_rate)"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">最大连空:</span>
                      <p class="font-medium" x-text="(campaignReport.experience_metrics?.max_empty_streak || 0) + '次'"></p>
                    </div>
                  </div>
                </div>

                <!-- 历史对比 -->
                <div x-show="campaignReport.comparison_with_history" class="themed-card rounded-lg shadow p-4">
                  <h6 class="font-semibold mb-3 flex items-center gap-2">
                    <span>📈</span> 与上次活动对比
                  </h6>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                      <span class="themed-text-muted">抽奖次数变化:</span>
                      <p class="font-medium" :class="getChangeColorClass(campaignReport.comparison_with_history?.draws_change)"
                         x-text="formatReportChange(campaignReport.comparison_with_history?.draws_change)"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">用户数变化:</span>
                      <p class="font-medium" :class="getChangeColorClass(campaignReport.comparison_with_history?.users_change)"
                         x-text="formatReportChange(campaignReport.comparison_with_history?.users_change)"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">ROI变化:</span>
                      <p class="font-medium" :class="getChangeColorClass(campaignReport.comparison_with_history?.roi_change)"
                         x-text="formatReportChange(campaignReport.comparison_with_history?.roi_change)"></p>
                    </div>
                    <div>
                      <span class="themed-text-muted">中奖率变化:</span>
                      <p class="font-medium" :class="getChangeColorClass(campaignReport.comparison_with_history?.win_rate_change)"
                         x-text="formatReportChange(campaignReport.comparison_with_history?.win_rate_change)"></p>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>

          <!-- 空状态 -->
          <div x-show="!loadingReport && !campaignReport" class="p-8 text-center">
            <div class="text-4xl mb-2">📭</div>
            <p class="themed-text-muted">未能生成复盘报告，请稍后重试</p>
          </div>

          <div class="p-4 border-t flex justify-end sticky bottom-0 bg-white">
            <button @click="closeReportModal()" class="themed-btn-secondary px-4 py-2 rounded">
              关闭
            </button>
          </div>
        </div>
      </div>

      <!-- ==================== 核销码管理页 ==================== -->
      <div x-show="current_page === 'redemption-codes'" x-cloak>
        <!-- 统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl themed-text-primary mb-2">🎫</div>
            <h6 class="themed-text-muted text-sm mb-1">核销码总数</h6>
            <h2 class="text-2xl font-bold themed-text-primary" x-text="redemptionStats.total">-</h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-yellow-500 mb-2">⏳</div>
            <h6 class="themed-text-muted text-sm mb-1">待核销</h6>
            <h2 class="text-2xl font-bold text-yellow-600" x-text="redemptionStats.pending">-</h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-green-500 mb-2">✅</div>
            <h6 class="themed-text-muted text-sm mb-1">已核销</h6>
            <h2 class="text-2xl font-bold text-green-600" x-text="redemptionStats.fulfilled">-</h2>
          </div>
          <div class="themed-card rounded-lg shadow p-6 text-center">
            <div class="text-3xl text-red-500 mb-2">❌</div>
            <h6 class="themed-text-muted text-sm mb-1">已过期</h6>
            <h2 class="text-2xl font-bold text-red-600" x-text="redemptionStats.expired">-</h2>
          </div>
        </div>

        <!-- 筛选和操作栏 -->
        <div class="themed-card rounded-lg shadow mb-4 p-4">
          <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
            <div>
              <label class="block text-sm themed-text-muted mb-1">状态</label>
              <select class="w-full px-3 py-2 border rounded" x-model="redemptionFilters.status">
                <option value="">全部状态</option>
                <option value="pending">待核销</option>
                <option value="fulfilled">已核销</option>
                <option value="expired">已过期</option>
                <option value="cancelled">已取消</option>
              </select>
            </div>
            <div>
              <label class="block text-sm themed-text-muted mb-1">奖品类型</label>
              <select class="w-full px-3 py-2 border rounded" x-model="redemptionFilters.prize_type">
                <option value="">全部类型</option>
                <option value="physical">实物奖品</option>
                <option value="virtual">虚拟奖品</option>
                <option value="coupon">优惠券</option>
              </select>
            </div>
            <div>
              <label class="block text-sm themed-text-muted mb-1">核销码</label>
              <input type="text" class="w-full px-3 py-2 border rounded" x-model="redemptionFilters.code" placeholder="输入核销码搜索..." @keyup.enter="searchRedemptionCodes()">
            </div>
            <div>
              <label class="block text-sm themed-text-muted mb-1">用户ID</label>
              <input type="number" class="w-full px-3 py-2 border rounded" x-model="redemptionFilters.user_id" placeholder="输入用户ID..." @keyup.enter="searchRedemptionCodes()">
            </div>
            <div class="flex gap-2">
              <button class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" @click="searchRedemptionCodes()">
                🔍 搜索
              </button>
            </div>
          </div>
        </div>

        <!-- 核销码列表 -->
        <div class="themed-card rounded-lg shadow">
          <div class="p-4 border-b flex justify-between items-center">
            <h6 class="font-semibold">📋 核销码列表 <span x-show="redemptionSelectedIds.length > 0" class="ml-2 text-sm font-normal themed-text-primary">(已选中 <span x-text="redemptionSelectedIds.length"></span> 条)</span></h6>
            <div class="flex gap-2 items-center">
              <span x-show="redemptionSelectedIds.length === 0" class="text-xs text-gray-400 mr-2">勾选左侧复选框可批量操作</span>
              <button class="px-3 py-1 text-sm border border-yellow-500 text-yellow-500 rounded hover:bg-yellow-50 disabled:opacity-50 disabled:cursor-not-allowed" @click="batchExpireRedemption()" :disabled="redemptionSelectedIds.length === 0">
                ⏰ 批量过期 <span x-show="redemptionSelectedIds.length > 0" class="ml-1 bg-yellow-500 text-white px-1.5 py-0.5 rounded-full text-xs" x-text="redemptionSelectedIds.length"></span>
              </button>
              <button class="px-3 py-1 text-sm border border-green-500 text-green-500 rounded hover:bg-green-50" @click="exportRedemptionCodes()">
                📥 导出
              </button>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="themed-bg-base">
                <tr>
                  <th class="px-4 py-3 text-left">
                    <input type="checkbox" :checked="checkIsAllRedemptionSelected()" @change="toggleRedemptionSelectAll()">
                  </th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">核销码</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">用户</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">奖品</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">活动</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">状态</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">创建时间</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">有效期至</th>
                  <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                <template x-if="redemptionCodes.length === 0">
                  <tr><td colspan="9" class="px-4 py-8 text-center themed-text-muted">暂无数据</td></tr>
                </template>
                <template x-for="c in redemptionCodes" :key="c.order_id">
                  <tr class="themed-hover-bg" :class="'border-l-4 ' + (c.status === 'pending' ? 'border-l-yellow-500' : c.status === 'fulfilled' || c.status === 'redeemed' ? 'border-l-green-500' : c.status === 'expired' ? 'border-l-red-500' : 'border-l-gray-400')">
                    <td class="px-4 py-3">
                      <input type="checkbox" :value="c.order_id" :checked="redemptionSelectedIds.includes(c.order_id)" @change="toggleRedemptionSelect(c.order_id)">
                    </td>
                    <td class="px-4 py-3">
                      <code class="themed-bg-subtle px-2 py-1 rounded text-sm" :title="c.code_hash || ''" x-text="getCodeDisplay(c.code_hash)"></code>
                    </td>
                    <td class="px-4 py-3 text-sm">
                      <span x-text="c.redeemer_user_id || '-'"></span>
                      <template x-if="getRedeemerName(c)">
                        <br><small class="text-gray-400" x-text="getRedeemerName(c)"></small>
                      </template>
                    </td>
                    <td class="px-4 py-3 text-sm" x-text="getRedemptionPrizeName(c)"></td>
                    <td class="px-4 py-3 text-sm" x-text="getRedemptionCampaignName(c)"></td>
                    <td class="px-4 py-3">
                      <span class="px-2 py-1 text-xs rounded" :class="getRedemptionStatusClass(c.status)" x-text="getRedemptionStatusText(c.status)"></span>
                    </td>
                    <td class="px-4 py-3 text-sm themed-text-muted" x-text="formatDateOnly(c.created_at)"></td>
                    <td class="px-4 py-3 text-sm themed-text-muted" x-text="formatDateOnly(c.expires_at)"></td>
                    <td class="px-4 py-3">
                      <div class="flex space-x-1">
                        <button class="themed-text-primary hover:text-blue-700 text-sm" @click="viewRedemptionDetail(c.order_id)">详情</button>
                        <template x-if="c.status === 'pending'">
                          <span class="flex space-x-1">
                            <button class="text-green-500 hover:text-green-700 text-sm" @click="openRedeemModal(c.order_id, getCodeDisplay(c.code_hash))">核销</button>
                            <button class="text-red-500 hover:text-red-700 text-sm" @click="cancelRedemptionCode(c.order_id)">取消</button>
                          </span>
                        </template>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <!-- 分页 -->
          <div class="p-4 border-t flex justify-center" x-show="total_pages > 1">
            <div class="flex space-x-2">
              <button class="px-3 py-1 border rounded" :class="page === 1 ? 'themed-bg-subtle text-gray-400' : 'themed-hover-bg'" :disabled="page === 1" @click="loadRedemptionCodes(page - 1)">上一页</button>
              <template x-for="p in Array.from({length: Math.min(5, total_pages)}, (_, i) => Math.max(1, page - 2) + i).filter(p => p <= total_pages)" :key="p">
                <button class="px-3 py-1 border rounded" :class="p === page ? 'themed-bg-primary text-white' : 'themed-hover-bg'" @click="loadRedemptionCodes(p)" x-text="p"></button>
              </template>
              <button class="px-3 py-1 border rounded" :class="page === total_pages ? 'themed-bg-subtle text-gray-400' : 'themed-hover-bg'" :disabled="page === total_pages" @click="loadRedemptionCodes(page + 1)">下一页</button>
            </div>
          </div>
        </div>
      </div>

  <!-- ==================== Modal 组件 ==================== -->
  <!-- 注意：Modal 必须在 lotteryPageContent 组件作用域内 -->

  <!-- 活动表单 Modal - 包含后端所有必填字段 -->
  <div x-ref="campaignModal" x-show="isModalOpen('campaignModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('campaignModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center themed-bg-primary rounded-t-lg">
        <h5 class="font-semibold text-white">🎁 <span x-text="isEditMode ? '编辑活动' : '创建活动'"></span></h5>
        <button @click="hideModal('campaignModal')" class="text-white hover:text-gray-200 text-xl">&times;</button>
      </div>
      <form @submit.prevent="submitCampaignForm()">
        <div class="p-4 space-y-4">
          <!-- 基本信息 -->
          <div class="themed-bg-base p-3 rounded">
            <h6 class="text-sm font-semibold themed-text-muted mb-3">📋 基本信息</h6>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">活动名称 <span class="text-red-500">*</span></label>
                <input type="text" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model="campaignForm.campaign_name" placeholder="如：春节抽奖活动" required>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">活动代码 <span class="text-red-500">*</span></label>
                <input type="text" class="w-full px-3 py-2 border rounded themed-bg-subtle focus:ring-2 focus:ring-blue-500" x-model="campaignForm.campaign_code" :readonly="isEditMode" placeholder="自动生成" required>
                <p class="text-xs themed-text-muted mt-1">唯一标识，创建后不可修改</p>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4 mt-3">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">活动类型 <span class="text-red-500">*</span></label>
                <select class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model="campaignForm.campaign_type" required>
                  <template x-for="opt in campaignTypeOptions" :key="opt.value">
                    <option :value="opt.value" x-text="opt.label"></option>
                  </template>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">状态</label>
                <select class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model="campaignForm.status">
                  <option value="draft">草稿</option>
                  <option value="active">进行中</option>
                  <option value="paused">已暂停</option>
                  <option value="completed">已结束</option>
                </select>
              </div>
            </div>
            <div class="mt-3">
              <label class="block text-sm font-medium themed-text-secondary mb-1">活动描述</label>
              <textarea class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model="campaignForm.description" rows="2" placeholder="请输入活动描述..."></textarea>
            </div>
          </div>

          <!-- 时间设置 -->
          <div class="themed-bg-base p-3 rounded">
            <h6 class="text-sm font-semibold themed-text-muted mb-3">⏰ 时间设置</h6>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">开始时间 <span class="text-red-500">*</span></label>
                <input type="datetime-local" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model="campaignForm.start_time" required>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">结束时间 <span class="text-red-500">*</span></label>
                <input type="datetime-local" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model="campaignForm.end_time" required>
              </div>
            </div>
          </div>

          <!-- 抽奖配置 -->
          <div class="themed-bg-base p-3 rounded">
            <h6 class="text-sm font-semibold themed-text-muted mb-3">🎰 抽奖配置</h6>
            <div class="grid grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">每次消耗积分 <span class="text-red-500">*</span></label>
                <input type="number" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model.number="campaignForm.cost_per_draw" min="0" step="0.01" required>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">每日最大次数</label>
                <input type="number" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model.number="campaignForm.max_draws_per_user_daily" min="1">
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">总最大次数</label>
                <input type="number" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model.number="campaignForm.max_draws_per_user_total" min="0" placeholder="不限制">
                <p class="text-xs themed-text-muted mt-1">0或空表示不限制</p>
              </div>
            </div>
          </div>

          <!-- 奖池配置 -->
          <div class="themed-bg-base p-3 rounded">
            <h6 class="text-sm font-semibold themed-text-muted mb-3">💰 奖池配置</h6>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">总奖池价值</label>
                <input type="number" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model.number="campaignForm.total_prize_pool" min="0" step="0.01">
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">剩余奖池价值</label>
                <input type="number" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model.number="campaignForm.remaining_prize_pool" min="0" step="0.01">
              </div>
            </div>
          </div>

          <!-- 活动规则 -->
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">📜 活动规则</label>
            <textarea class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" x-model="campaignForm.rules_text" rows="3" placeholder="请输入活动规则说明..."></textarea>
          </div>
        </div>
        <div class="p-4 border-t flex justify-end space-x-2 themed-bg-base">
          <button type="button" class="px-4 py-2 border rounded themed-hover-bg" @click="hideModal('campaignModal')">取消</button>
          <button type="submit" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary disabled:opacity-50" :disabled="saving">
            <span x-show="saving">保存中...</span>
            <span x-show="!saving" x-text="isEditMode ? '保存修改' : '创建活动'"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 活动详情 Modal -->
  <div x-ref="campaignDetailModal" x-show="isModalOpen('campaignDetailModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('campaignDetailModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">🎁 活动详情</h5>
        <button @click="hideModal('campaignDetailModal')" class="text-gray-400 hover:themed-text-muted">&times;</button>
      </div>
      <div class="p-4" x-show="selectedCampaign">
        <div class="mb-4">
          <h4 class="text-xl font-bold" x-text="selectedCampaign?.name"></h4>
          <span class="px-2 py-1 text-xs rounded" :class="getCampaignStatusClass(selectedCampaign?.status)" x-text="getCampaignStatusText(selectedCampaign?.status)"></span>
        </div>
        <div class="space-y-3">
          <div><strong>活动描述：</strong><p class="themed-text-muted" x-text="selectedCampaign?.description || '暂无描述'"></p></div>
          <div class="grid grid-cols-2 gap-4">
            <div><strong>开始时间：</strong><span x-text="formatDateOnly(selectedCampaign?.start_time)"></span></div>
            <div><strong>结束时间：</strong><span x-text="formatDateOnly(selectedCampaign?.end_time)"></span></div>
            <div><strong>参与人数：</strong><span x-text="selectedCampaign?.participant_count || 0"></span></div>
            <div><strong>中奖人数：</strong><span x-text="selectedCampaign?.winner_count || 0"></span></div>
          </div>
          <div x-show="selectedCampaign?.rules">
            <strong>活动规则：</strong>
            <pre class="themed-bg-subtle p-2 rounded mt-1" x-text="selectedCampaign?.rules"></pre>
          </div>
        </div>
      </div>
      <div class="p-4 border-t flex justify-end space-x-2">
        <button type="button" class="px-4 py-2 border rounded themed-hover-bg" @click="hideModal('campaignDetailModal')">关闭</button>
        <button type="button" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" @click="editCampaign(selectedCampaign); hideModal('campaignDetailModal')">
          ✏️ 编辑
        </button>
      </div>
    </div>
  </div>

  <!-- 奖品表单 Modal -->
  <div x-ref="prizeModal" x-show="isModalOpen('prizeModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('prizeModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">🏆 <span x-text="isEditMode ? '编辑奖品' : '添加奖品'"></span></h5>
        <button @click="hideModal('prizeModal')" class="text-gray-400 hover:themed-text-muted">&times;</button>
      </div>
      <form @submit.prevent="submitPrizeForm()">
        <div class="p-4 space-y-4">
          <!-- 活动选择（仅新增时显示） -->
          <div x-show="!isEditMode">
            <label class="block text-sm font-medium themed-text-secondary mb-1">所属活动 <span class="text-red-500">*</span></label>
            <!-- 无活动时显示提示 -->
            <template x-if="!campaigns || campaigns.length === 0">
              <div class="p-3 bg-yellow-50 border border-yellow-200 rounded text-yellow-700 text-sm">
                ⚠️ 暂无可用活动，请先到 <a href="#" @click.prevent="switchPage('campaigns')" class="themed-text-primary underline">活动管理</a> 创建活动
              </div>
            </template>
            <!-- 有活动时显示下拉框 -->
            <template x-if="campaigns && campaigns.length > 0">
              <select class="w-full px-3 py-2 border rounded" x-model.number="prizeForm.campaign_id" required>
                <option value="">请选择活动</option>
                <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
                  <option :value="campaign.lottery_campaign_id" x-text="campaign.campaign_name"></option>
                </template>
              </select>
            </template>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">奖品名称 <span class="text-red-500">*</span></label>
            <input type="text" class="w-full px-3 py-2 border rounded" x-model="prizeForm.prize_name" required>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">奖品类型</label>
            <select class="w-full px-3 py-2 border rounded" x-model="prizeForm.prize_type">
              <option value="virtual">虚拟奖品</option>
              <option value="physical">实物奖品</option>
              <option value="coupon">优惠券</option>
              <option value="points">积分</option>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">中奖概率 (%)</label>
              <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="prizeForm.win_probability" min="0" max="100" step="0.01">
              <p class="text-xs text-amber-600 mt-1">⚠️ 添加后请编辑调整概率，确保所有奖品概率总和=100%</p>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">库存数量</label>
              <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="prizeForm.stock_quantity" min="1" placeholder="输入正整数">
              <p class="text-xs themed-text-muted mt-1">输入999999表示无限库存</p>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">奖品图片URL</label>
            <input type="text" class="w-full px-3 py-2 border rounded" x-model="prizeForm.image_url">
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">奖品描述</label>
            <textarea class="w-full px-3 py-2 border rounded" x-model="prizeForm.prize_description" rows="2"></textarea>
          </div>
          <div class="flex items-center">
            <input type="checkbox" :checked="prizeForm.status === 'active'" @change="prizeForm.status = $event.target.checked ? 'active' : 'inactive'" id="prizeActiveSwitch" class="mr-2">
            <label for="prizeActiveSwitch">启用奖品</label>
          </div>
        </div>
        <div class="p-4 border-t flex justify-end space-x-2">
          <button type="button" class="px-4 py-2 border rounded themed-hover-bg" @click="hideModal('prizeModal')">取消</button>
          <button type="submit" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" :disabled="saving">
            <span x-show="saving">保存中...</span>
            <span x-show="!saving" x-text="isEditMode ? '保存修改' : '添加奖品'"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 批量添加奖品 Modal -->
  <div x-ref="batchPrizeModal" x-show="isModalOpen('batchPrizeModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('batchPrizeModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">📦 批量配置奖品池</h5>
        <button @click="hideModal('batchPrizeModal')" class="text-gray-400 hover:themed-text-muted text-2xl">&times;</button>
      </div>
      
      <div class="p-4 space-y-4">
        <!-- 选择活动 -->
        <div class="flex items-center gap-4">
          <label class="block text-sm font-medium themed-text-secondary whitespace-nowrap">所属活动 *</label>
          <select class="flex-1 px-3 py-2 border rounded" x-model.number="batchCampaignId">
            <option value="">请选择活动</option>
            <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
              <option :value="campaign.lottery_campaign_id" x-text="campaign.campaign_name"></option>
            </template>
          </select>
        </div>

        <!-- 概率统计 -->
        <div class="p-3 rounded-lg" :class="Math.abs(batchProbabilitySum - 100) <= 0.01 ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'">
          <div class="flex items-center justify-between">
            <span class="font-medium" :class="Math.abs(batchProbabilitySum - 100) <= 0.01 ? 'themed-text-success' : 'text-red-700'">
              概率总和: <span x-text="batchProbabilitySum.toFixed(2)"></span>%
              <span x-show="Math.abs(batchProbabilitySum - 100) <= 0.01" class="ml-2">✅ 正确</span>
              <span x-show="Math.abs(batchProbabilitySum - 100) > 0.01" class="ml-2">❌ 必须等于100%</span>
            </span>
            <button type="button" @click="autoDistributeProbability()" class="px-3 py-1 themed-bg-primary text-white text-sm rounded themed-hover-primary">
              🔄 自动平均分配
            </button>
          </div>
        </div>

        <!-- 奖品列表 -->
        <div class="border rounded-lg overflow-hidden">
          <table class="min-w-full divide-y divide-[var(--color-border)]">
            <thead class="themed-bg-base">
              <tr>
                <th class="px-3 py-2 text-left text-xs font-medium themed-text-muted w-8">#</th>
                <th class="px-3 py-2 text-left text-xs font-medium themed-text-muted">奖品名称 *</th>
                <th class="px-3 py-2 text-left text-xs font-medium themed-text-muted w-28">类型</th>
                <th class="px-3 py-2 text-left text-xs font-medium themed-text-muted w-24">概率 (%)</th>
                <th class="px-3 py-2 text-left text-xs font-medium themed-text-muted w-24">库存</th>
                <th class="px-3 py-2 text-left text-xs font-medium themed-text-muted w-16">操作</th>
              </tr>
            </thead>
            <tbody class="themed-card divide-y divide-[var(--color-border)]">
              <!-- 2026-01-29 技术债务清理：直接使用后端字段名 -->
              <template x-for="(prize, index) in batchPrizes" :key="index">
                <tr>
                  <td class="px-3 py-2 text-sm themed-text-muted" x-text="index + 1"></td>
                  <td class="px-3 py-2">
                    <input type="text" class="w-full px-2 py-1 border rounded text-sm" 
                           x-model="prize.prize_name" placeholder="奖品名称">
                  </td>
                  <td class="px-3 py-2">
                    <select class="w-full px-2 py-1 border rounded text-sm" x-model="prize.prize_type">
                      <option value="physical">实物</option>
                      <option value="virtual">虚拟</option>
                      <option value="coupon">优惠券</option>
                      <option value="points">积分</option>
                      <option value="empty">谢谢参与</option>
                    </select>
                  </td>
                  <td class="px-3 py-2">
                    <!-- win_probability 使用小数(0-1)，乘100显示为百分比 -->
                    <input type="number" class="w-full px-2 py-1 border rounded text-sm" 
                           :value="(prize.win_probability * 100).toFixed(1)"
                           @input="prize.win_probability = parseFloat($event.target.value) / 100 || 0; updateBatchProbabilitySum()"
                           min="0" max="100" step="0.1">
                  </td>
                  <td class="px-3 py-2">
                    <input type="number" class="w-full px-2 py-1 border rounded text-sm" 
                           x-model.number="prize.stock_quantity" min="1" placeholder="999999=无限">
                  </td>
                  <td class="px-3 py-2">
                    <button type="button" @click="removeBatchPrizeSlot(index)" 
                            class="text-red-500 hover:text-red-700"
                            :disabled="batchPrizes.length <= 1"
                            :class="batchPrizes.length <= 1 ? 'opacity-30 cursor-not-allowed' : ''">
                      🗑️
                    </button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>

        <!-- 添加更多奖品 -->
        <button type="button" @click="addBatchPrizeSlot()" 
                class="w-full py-2 border-2 border-dashed themed-border rounded-lg themed-text-muted hover:border-blue-500 hover:text-blue-500 transition-colors">
          ➕ 添加更多奖品
        </button>

        <!-- 提示信息 -->
        <div class="p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-700">
          <p>💡 <strong>提示：</strong></p>
          <ul class="mt-1 ml-4 list-disc">
            <li>所有奖品的概率总和必须等于 100%</li>
            <li>库存输入 999999 表示无限库存</li>
            <li>"谢谢参与"类型适合保底奖品</li>
          </ul>
        </div>
      </div>

      <div class="p-4 border-t flex justify-end space-x-2">
        <button type="button" class="px-4 py-2 border rounded themed-hover-bg" @click="hideModal('batchPrizeModal')">取消</button>
        <button type="button" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" 
                @click="submitBatchPrizes()" :disabled="saving || Math.abs(batchProbabilitySum - 100) > 0.01">
          <span x-show="saving">提交中...</span>
          <span x-show="!saving">📦 批量添加 (<span x-text="batchPrizes.length"></span>个奖品)</span>
        </button>
      </div>
    </div>
  </div>

  <!-- 奖品补货 Modal -->
  <div x-ref="stockModal" x-show="isModalOpen('stockModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('stockModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-md w-full mx-4">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">📦 奖品补货</h5>
        <button @click="hideModal('stockModal')" class="text-gray-400 hover:themed-text-muted">&times;</button>
      </div>
      <form @submit.prevent="submitAddStock()">
        <div class="p-4 space-y-4">
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">奖品名称</label>
            <input type="text" class="w-full px-3 py-2 border rounded themed-bg-base" :value="stockForm.prize_name" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">补货数量 <span class="text-red-500">*</span></label>
            <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="stockForm.quantity" min="1" required>
          </div>
        </div>
        <div class="p-4 border-t flex justify-end space-x-2">
          <button type="button" class="px-4 py-2 border rounded themed-hover-bg" @click="hideModal('stockModal')">取消</button>
          <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600" :disabled="saving">确认补货</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 预算设置 Modal -->
  <div x-ref="budgetModal" x-show="isModalOpen('budgetModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('budgetModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-md w-full mx-4">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">💰 设置预算</h5>
        <button @click="hideModal('budgetModal')" class="text-gray-400 hover:themed-text-muted">&times;</button>
      </div>
      <form @submit.prevent="saveBudget()">
        <div class="p-4 space-y-4">
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">预算模式</label>
            <select class="w-full px-3 py-2 border rounded" x-model="budgetForm.budget_mode">
              <option value="pool">总预算</option>
              <option value="daily">每日预算</option>
              <option value="user">用户预算</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">预算金额</label>
            <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="budgetForm.pool_budget_total" min="0" step="0.01">
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">预警阈值 (%)</label>
            <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="budgetForm.alert_threshold" min="0" max="100">
          </div>
        </div>
        <div class="p-4 border-t flex justify-end space-x-2">
          <button type="button" class="px-4 py-2 border rounded themed-hover-bg" @click="hideModal('budgetModal')">取消</button>
          <button type="submit" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" :disabled="saving">保存设置</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 矩阵编辑 Modal -->
  <div x-ref="matrixEditModal" x-show="isModalOpen('matrixEditModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('matrixEditModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center sticky top-0 themed-card z-10">
        <h5 class="font-semibold">📊 编辑矩阵配置</h5>
        <button @click="hideModal('matrixEditModal')" class="text-gray-400 hover:themed-text-muted">&times;</button>
      </div>
      <form @submit.prevent="submitMatrixConfig()">
        <div class="p-4 space-y-4" x-show="editingMatrixCell">
          <div class="themed-bg-primary-light p-3 rounded">
            预算层级：<strong x-text="editingMatrixCell?.budget_tier"></strong>
            / 压力层级：<strong x-text="editingMatrixCell?.pressure_tier"></strong>
          </div>
          
          <!-- 基础乘数配置 -->
          <div class="border-b pb-3">
            <h6 class="text-sm font-semibold themed-text-muted mb-3">📐 基础乘数配置</h6>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">Cap乘数</label>
                <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="editingMatrixCell.cap_multiplier" min="0" step="0.01">
                <small class="text-gray-400">中奖上限控制</small>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">空奖权重乘数</label>
                <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="editingMatrixCell.empty_weight_multiplier" min="0" step="0.01">
                <small class="text-gray-400">空奖权重调整</small>
              </div>
            </div>
          </div>
          
          <!-- 档位权重乘数配置（后端P0新增字段） -->
          <div class="border-b pb-3">
            <h6 class="text-sm font-semibold themed-text-muted mb-3">🎯 档位权重乘数</h6>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">高档位 (High)</label>
                <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="editingMatrixCell.high_multiplier" min="0" step="0.01">
                <small class="text-gray-400">高价值奖品权重</small>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">中档位 (Mid)</label>
                <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="editingMatrixCell.mid_multiplier" min="0" step="0.01">
                <small class="text-gray-400">中价值奖品权重</small>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">低档位 (Low)</label>
                <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="editingMatrixCell.low_multiplier" min="0" step="0.01">
                <small class="text-gray-400">低价值奖品权重</small>
              </div>
              <div>
                <label class="block text-sm font-medium themed-text-secondary mb-1">兜底档位 (Fallback)</label>
                <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="editingMatrixCell.fallback_multiplier" min="0" step="0.01">
                <small class="text-gray-400">兜底/谢谢参与权重</small>
              </div>
            </div>
          </div>
          
          <!-- 描述 -->
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">配置说明</label>
            <textarea class="w-full px-3 py-2 border rounded" x-model="editingMatrixCell.description" rows="2" placeholder="可选的配置说明"></textarea>
          </div>
        </div>
        <div class="p-4 border-t flex justify-end space-x-2 sticky bottom-0 themed-card">
          <button type="button" class="px-4 py-2 border rounded themed-hover-bg" @click="hideModal('matrixEditModal')">取消</button>
          <button type="submit" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" :disabled="saving">保存配置</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 配额表单 Modal -->
  <div x-ref="quotaModal" x-show="isModalOpen('quotaModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('quotaModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-md w-full mx-4">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">📊 <span x-text="isEditQuota ? '编辑配额' : '新增配额'"></span></h5>
        <button @click="hideModal('quotaModal')" class="text-gray-400 hover:themed-text-muted">&times;</button>
      </div>
      <form @submit.prevent="submitQuotaForm()">
        <div class="p-4 space-y-4">
          <!-- 规则类型选择 -->
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">规则类型 <span class="text-red-500">*</span></label>
            <select class="w-full px-3 py-2 border rounded" x-model="quotaForm.rule_type" :disabled="isEditQuota">
              <option value="global">全局（所有活动）</option>
              <option value="campaign">指定活动</option>
              <option value="role">指定角色</option>
              <option value="user">指定用户</option>
            </select>
          </div>
          
          <!-- 活动选择（campaign类型时显示） -->
          <div x-show="quotaForm.rule_type === 'campaign'">
            <label class="block text-sm font-medium themed-text-secondary mb-1">选择活动 <span class="text-red-500">*</span></label>
            <select class="w-full px-3 py-2 border rounded" x-model="quotaForm.campaign_id" :disabled="isEditQuota">
              <option value="">请选择活动...</option>
              <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
                <option :value="campaign.lottery_campaign_id" x-text="campaign.campaign_name + ' (#' + campaign.lottery_campaign_id + ')'"></option>
              </template>
            </select>
          </div>
          
          <!-- 角色UUID（role类型时显示） -->
          <div x-show="quotaForm.rule_type === 'role'">
            <label class="block text-sm font-medium themed-text-secondary mb-1">角色UUID <span class="text-red-500">*</span></label>
            <input type="text" class="w-full px-3 py-2 border rounded" x-model="quotaForm.role_uuid" :disabled="isEditQuota" placeholder="输入角色UUID">
          </div>
          
          <!-- 目标用户ID（user类型时显示） -->
          <div x-show="quotaForm.rule_type === 'user'">
            <label class="block text-sm font-medium themed-text-secondary mb-1">目标用户ID <span class="text-red-500">*</span></label>
            <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="quotaForm.target_user_id" :disabled="isEditQuota" placeholder="输入用户ID">
          </div>
          
          <!-- 每日抽奖次数限制 -->
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">每日抽奖次数上限 <span class="text-red-500">*</span></label>
            <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="quotaForm.limit_value" min="1" required>
            <p class="text-xs themed-text-muted mt-1">用户每天可抽奖的最大次数</p>
          </div>
          
          <!-- 创建原因 -->
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">创建原因</label>
            <input type="text" class="w-full px-3 py-2 border rounded" x-model="quotaForm.reason" placeholder="可选，用于记录创建此规则的原因">
          </div>
        </div>
        <div class="p-4 border-t flex justify-end space-x-2">
          <button type="button" class="px-4 py-2 border rounded themed-hover-bg" @click="hideModal('quotaModal')">取消</button>
          <button type="submit" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" :disabled="saving">
            <span x-text="isEditQuota ? '保存修改' : '创建配额'"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 核销码详情 Modal -->
  <div x-ref="redemptionDetailModal" x-show="isModalOpen('redemptionDetailModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('redemptionDetailModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-md w-full mx-4">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">ℹ️ 核销码详情</h5>
        <button @click="hideModal('redemptionDetailModal')" class="text-gray-400 hover:themed-text-muted">&times;</button>
      </div>
      <div class="p-4" x-show="redemptionDetail">
        <div class="text-center mb-4">
          <code class="themed-bg-subtle px-3 py-2 rounded text-lg" :title="redemptionDetail?.code_hash || ''" x-text="getCodeDisplay(redemptionDetail?.code_hash)"></code>
          <br><small class="text-gray-400" x-text="'订单ID: ' + (redemptionDetail?.order_id || '-')"></small>
        </div>
        <table class="w-full text-sm">
          <tr class="border-b"><th class="py-2 text-left w-1/3">状态</th><td class="py-2"><span class="px-2 py-1 text-xs rounded" :class="getRedemptionStatusClass(redemptionDetail?.status)" x-text="getRedemptionStatusText(redemptionDetail?.status)"></span></td></tr>
          <tr class="border-b"><th class="py-2 text-left">核销用户ID</th><td class="py-2" x-text="redemptionDetail?.redeemer_user_id || '-'"></td></tr>
          <tr class="border-b"><th class="py-2 text-left">核销用户</th><td class="py-2" x-text="getRedeemerName(redemptionDetail) || '-'"></td></tr>
          <tr class="border-b"><th class="py-2 text-left">物品类型</th><td class="py-2" x-text="redemptionDetail?.item_instance?.item_type || '-'"></td></tr>
          <tr class="border-b"><th class="py-2 text-left">奖品名称</th><td class="py-2" x-text="getRedemptionPrizeName(redemptionDetail)"></td></tr>
          <tr class="border-b"><th class="py-2 text-left">活动</th><td class="py-2" x-text="getRedemptionCampaignName(redemptionDetail)"></td></tr>
          <tr class="border-b"><th class="py-2 text-left">创建时间</th><td class="py-2" x-text="formatDateOnly(redemptionDetail?.created_at)"></td></tr>
          <tr class="border-b"><th class="py-2 text-left">有效期至</th><td class="py-2" x-text="formatDateOnly(redemptionDetail?.expires_at)"></td></tr>
          <template x-if="redemptionDetail?.status === 'fulfilled' || redemptionDetail?.status === 'redeemed'">
            <tr class="border-b"><th class="py-2 text-left">核销时间</th><td class="py-2" x-text="formatDateOnly(redemptionDetail?.fulfilled_at)"></td></tr>
          </template>
        </table>
      </div>
      <div class="p-4 border-t flex justify-end">
        <button type="button" class="px-4 py-2 border rounded themed-hover-bg" @click="hideModal('redemptionDetailModal')">关闭</button>
      </div>
    </div>
  </div>

  <!-- 手动核销 Modal -->
  <div x-ref="redeemModal" x-show="isModalOpen('redeemModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('redeemModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-md w-full mx-4">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">✅ 手动核销</h5>
        <button @click="hideModal('redeemModal')" class="text-gray-400 hover:themed-text-muted">&times;</button>
      </div>
      <form @submit.prevent="submitRedeem()">
        <div class="p-4 space-y-4">
          <div class="text-center">
            <code class="themed-bg-subtle px-3 py-2 rounded text-lg" x-text="redeemForm.code_display"></code>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">核销门店</label>
            <select class="w-full px-3 py-2 border rounded" x-model="redeemForm.store_id">
              <option value="">请选择门店</option>
              <template x-for="s in stores" :key="s.store_id">
                <option :value="s.store_id" x-text="s.store_name"></option>
              </template>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">备注</label>
            <textarea class="w-full px-3 py-2 border rounded" x-model="redeemForm.remark" rows="2" placeholder="核销备注（选填）"></textarea>
          </div>
        </div>
        <div class="p-4 border-t flex justify-end space-x-2">
          <button type="button" class="px-4 py-2 border rounded themed-hover-bg" @click="hideModal('redeemModal')">取消</button>
          <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600" :disabled="submitting">
            <span x-show="submitting">核销中...</span>
            <span x-show="!submitting">确认核销</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ==================== 定价配置编辑模态框 ==================== -->
  <div x-ref="pricingModal" x-show="isModalOpen('pricingModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('pricingModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-lg w-full mx-4">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">💵 <span x-text="isEditPricing ? '编辑定价配置' : '创建定价配置'"></span></h5>
        <button @click="hideModal('pricingModal')" class="text-gray-400 hover:themed-text-muted">&times;</button>
      </div>
      <form @submit.prevent="savePricing()">
        <div class="p-4 space-y-4">
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">活动代码 <span class="text-red-500">*</span></label>
            <select class="w-full px-3 py-2 border rounded" x-model="pricingForm.campaign_code" :disabled="isEditPricing" required>
              <option value="">请选择活动</option>
              <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
                <option :value="campaign.campaign_code" x-text="campaign.campaign_name + ' (' + campaign.campaign_code + ')'"></option>
              </template>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">单次抽奖价格 <span class="text-red-500">*</span></label>
            <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="pricingForm.price_per_draw" min="0" step="0.01" required>
            <p class="text-xs themed-text-muted mt-1">单位：积分</p>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">折扣率</label>
              <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="pricingForm.discount_rate" min="0" max="1" step="0.01">
              <p class="text-xs themed-text-muted mt-1">1.0 = 无折扣，0.9 = 9折</p>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">最小购买次数</label>
              <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="pricingForm.min_purchase" min="1">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">最大购买次数</label>
              <input type="number" class="w-full px-3 py-2 border rounded" x-model.number="pricingForm.max_purchase" min="1">
            </div>
          </div>
        </div>
        <div class="p-4 border-t flex justify-end space-x-2">
          <button type="button" class="px-4 py-2 border rounded themed-hover-bg" @click="hideModal('pricingModal')">取消</button>
          <button type="submit" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" :disabled="saving">
            <span x-show="saving">保存中...</span>
            <span x-show="!saving" x-text="isEditPricing ? '保存修改' : '创建配置'"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ==================== 定价版本历史模态框 ==================== -->
  <div x-ref="pricingVersionsModal" x-show="isModalOpen('pricingVersionsModal')" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
    <div class="fixed inset-0 bg-black bg-opacity-50" @click="hideModal('pricingVersionsModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">📋 定价版本历史 - <span x-text="selectedPricingCampaign?.campaign_name || ''"></span></h5>
        <button @click="hideModal('pricingVersionsModal')" class="text-gray-400 hover:themed-text-muted">&times;</button>
      </div>
      <div class="p-4 overflow-y-auto flex-1">
        <template x-if="pricingVersions.length === 0">
          <div class="text-center py-8 themed-text-muted">
            <p>暂无版本历史记录</p>
          </div>
        </template>
        <div class="space-y-3">
          <template x-for="version in pricingVersions" :key="version.version">
            <div class="border rounded-lg p-4">
              <div class="flex justify-between items-start">
                <div>
                  <div class="flex items-center space-x-2">
                    <span class="font-semibold themed-text-primary" x-text="'v' + version.version"></span>
                    <span class="px-2 py-0.5 text-xs rounded" 
                          :class="version.status === 'active' ? 'bg-green-100 themed-text-success' : 'themed-bg-subtle themed-text-muted'"
                          x-text="getPricingStatusText(version.status)"></span>
                  </div>
                  <div class="text-sm themed-text-muted mt-1">
                    <span>创建时间: </span><span x-text="formatDateTimeShort(version.created_at)"></span>
                  </div>
                  <div class="text-sm themed-text-muted">
                    <span>基础价格: </span><span x-text="(version.pricing_config?.base_cost || version.base_cost || '-') + ' 积分'"></span>
                  </div>
                </div>
                <div class="flex space-x-2">
                  <template x-if="version.status !== 'active'">
                    <button class="px-3 py-1 text-sm bg-green-500 text-white rounded hover:bg-green-600" 
                            @click="activatePricing(selectedPricingCampaign, version.version)">
                      激活
                    </button>
                  </template>
                  <template x-if="version.status !== 'archived'">
                    <button class="px-3 py-1 text-sm bg-gray-500 text-white rounded hover:bg-gray-600" 
                            @click="archivePricing(selectedPricingCampaign, version.version)">
                      归档
                    </button>
                  </template>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>
      <div class="p-4 border-t">
        <button type="button" class="w-full px-4 py-2 border rounded themed-hover-bg" @click="hideModal('pricingVersionsModal')">关闭</button>
      </div>
    </div>
  </div>

    </div><!-- 关闭 lotteryPageContent -->

    <!-- ==================== 用户抽奖档案模态框 ==================== -->
    <div x-show="showUserProfileModal" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
      <div class="fixed inset-0 bg-black bg-opacity-50" @click="closeUserProfileModal()"></div>
      <div class="relative themed-card rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
        <!-- 模态框头部 -->
        <div class="p-4 border-b flex justify-between items-center themed-bg-primary text-white rounded-t-lg">
          <h5 class="font-semibold text-lg flex items-center gap-2">
            👤 用户抽奖档案
            <span x-show="userProfile" class="text-sm font-normal opacity-80" x-text="'#' + (userProfile?.user_id || '')"></span>
          </h5>
          <button @click="closeUserProfileModal()" class="text-white hover:text-gray-200 text-2xl">&times;</button>
        </div>

        <!-- 加载状态 -->
        <template x-if="loadingUserProfile">
          <div class="flex-1 flex items-center justify-center py-20">
            <div class="text-center">
              <svg class="animate-spin h-10 w-10 text-blue-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
              </svg>
              <p class="themed-text-muted">加载用户档案中...</p>
            </div>
          </div>
        </template>

        <!-- 无数据状态 -->
        <template x-if="!loadingUserProfile && !userProfile">
          <div class="flex-1 flex items-center justify-center py-20">
            <div class="text-center">
              <div class="text-6xl mb-4">🔍</div>
              <h3 class="text-lg font-medium themed-text mb-2">未找到用户数据</h3>
              <p class="themed-text-muted text-sm">请确认用户ID是否正确</p>
            </div>
          </div>
        </template>

        <!-- 档案内容 -->
        <template x-if="!loadingUserProfile && userProfile">
          <div class="flex-1 overflow-y-auto p-6 space-y-6">
            <!-- 用户基本信息 -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <div class="themed-card rounded-lg p-4 border">
                <div class="text-sm themed-text-muted mb-1">用户昵称</div>
                <div class="font-semibold" x-text="userProfile.nickname || '-'"></div>
              </div>
              <div class="themed-card rounded-lg p-4 border">
                <div class="text-sm themed-text-muted mb-1">手机号</div>
                <div class="font-semibold" x-text="userProfile.phone || '-'"></div>
              </div>
              <div class="themed-card rounded-lg p-4 border">
                <div class="text-sm themed-text-muted mb-1">用户类型</div>
                <div class="font-semibold" x-text="userProfile.user_type || '-'"></div>
              </div>
              <div class="themed-card rounded-lg p-4 border">
                <div class="text-sm themed-text-muted mb-1">注册时间</div>
                <div class="font-semibold text-sm" x-text="formatProfileTime(userProfile.register_time)"></div>
              </div>
            </div>

            <!-- 抽奖统计 -->
            <div class="themed-card rounded-lg shadow">
              <div class="p-4 border-b">
                <h6 class="font-semibold">📊 抽奖统计概览</h6>
              </div>
              <div class="p-4">
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
                  <div>
                    <div class="text-3xl font-bold themed-text-primary" x-text="userDrawStats.totalDraws">0</div>
                    <div class="text-sm themed-text-muted">总抽奖次数</div>
                  </div>
                  <div>
                    <div class="text-3xl font-bold text-green-600" x-text="userDrawStats.totalWins">0</div>
                    <div class="text-sm themed-text-muted">中奖次数</div>
                  </div>
                  <div>
                    <div class="text-3xl font-bold text-yellow-600" x-text="userDrawStats.winRate + '%'">0%</div>
                    <div class="text-sm themed-text-muted">中奖率</div>
                  </div>
                  <div>
                    <div class="text-3xl font-bold text-cyan-600" x-text="'¥' + (userDrawStats.totalValue || 0).toFixed(2)">¥0</div>
                    <div class="text-sm themed-text-muted">奖品价值</div>
                  </div>
                  <div>
                    <div class="text-sm font-semibold themed-text" x-text="formatProfileTime(userDrawStats.lastDrawTime) || '-'">-</div>
                    <div class="text-sm themed-text-muted">最近抽奖</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 体验状态 -->
            <template x-if="userExperienceState">
              <div class="themed-card rounded-lg shadow">
                <div class="p-4 border-b">
                  <h6 class="font-semibold">🎯 体验阶段状态</h6>
                </div>
                <div class="p-4">
                  <div class="flex items-center gap-4">
                    <span class="px-3 py-1.5 rounded-full text-sm font-medium" 
                          :class="getProfilePhaseClass(userExperienceState.current_phase)"
                          x-text="getProfilePhaseText(userExperienceState.current_phase)"></span>
                    <span class="text-sm themed-text-muted">
                      连续无奖: <span class="font-medium" x-text="userExperienceState.consecutive_no_win || 0"></span> 次
                    </span>
                    <span class="text-sm themed-text-muted">
                      今日抽奖: <span class="font-medium" x-text="userExperienceState.today_draws || 0"></span> 次
                    </span>
                  </div>
                </div>
              </div>
            </template>

            <!-- 抽奖历史 -->
            <div class="themed-card rounded-lg shadow">
              <div class="p-4 border-b flex justify-between items-center">
                <h6 class="font-semibold">📋 最近抽奖记录</h6>
                <span class="text-sm themed-text-muted" x-text="'共 ' + userDrawHistory.length + ' 条'"></span>
              </div>
              <div class="overflow-x-auto max-h-64">
                <table class="w-full">
                  <thead class="themed-bg-base sticky top-0">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-medium themed-text-muted uppercase">时间</th>
                      <th class="px-4 py-3 text-left text-xs font-medium themed-text-muted uppercase">活动</th>
                      <th class="px-4 py-3 text-left text-xs font-medium themed-text-muted uppercase">结果</th>
                      <th class="px-4 py-3 text-left text-xs font-medium themed-text-muted uppercase">档位</th>
                      <th class="px-4 py-3 text-left text-xs font-medium themed-text-muted uppercase">价值</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y">
                    <template x-if="userDrawHistory.length === 0">
                      <tr>
                        <td colspan="5" class="px-4 py-8 text-center themed-text-muted">暂无抽奖记录</td>
                      </tr>
                    </template>
                    <template x-for="(draw, index) in userDrawHistory" :key="index">
                      <tr class="themed-hover-bg">
                        <td class="px-4 py-3 text-sm themed-text-muted" x-text="formatProfileTime(draw.drawTime)"></td>
                        <td class="px-4 py-3 text-sm" x-text="draw.campaignName"></td>
                        <td class="px-4 py-3 text-sm">
                          <span class="px-2 py-1 rounded text-xs" 
                                :class="draw.isWin ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'"
                                x-text="draw.prizeName"></span>
                        </td>
                        <td class="px-4 py-3 text-sm" x-text="draw.rewardTier || '-'"></td>
                        <td class="px-4 py-3 text-sm" x-text="draw.prizeValue ? '¥' + draw.prizeValue.toFixed(2) : '-'"></td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </template>

        <!-- 模态框底部 -->
        <div class="p-4 border-t bg-gray-50">
          <button type="button" class="w-full px-4 py-2 themed-bg-primary text-white rounded-lg themed-hover-primary" @click="closeUserProfileModal()">
            关闭
          </button>
        </div>
      </div>
    </div>

    <!-- ==================== P2新增: 运营日报模态框 ==================== -->
    <div x-show="showDailyReportModal" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
      <div class="fixed inset-0 bg-black bg-opacity-50" @click="closeDailyReportModal()"></div>
      <div class="relative themed-card rounded-lg shadow-xl max-w-5xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
        <!-- 模态框头部 -->
        <div class="p-4 border-b flex justify-between items-center bg-gradient-to-r from-purple-500 to-indigo-600 text-white">
          <h5 class="font-semibold text-lg flex items-center gap-2">
            📊 运营日报
            <span class="text-sm font-normal opacity-90" x-text="dailyReportDate"></span>
          </h5>
          <div class="flex items-center gap-2">
            <button class="p-2 hover:bg-white/20 rounded" @click="changeDailyReportDate(-1)" :disabled="loadingDailyReport">
              ⬅️
            </button>
            <button class="p-2 hover:bg-white/20 rounded" @click="changeDailyReportDate(1)" :disabled="loadingDailyReport">
              ➡️
            </button>
            <button class="p-2 hover:bg-white/20 rounded" @click="closeDailyReportModal()">✕</button>
          </div>
        </div>

        <!-- 模态框内容 -->
        <div class="flex-1 overflow-y-auto p-6" x-show="dailyReportData && !loadingDailyReport">
          <!-- 汇总卡片 -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="themed-card rounded-lg p-4 text-center">
              <div class="text-2xl mb-1">🎲</div>
              <div class="text-xs themed-text-muted mb-1">抽奖次数</div>
              <div class="text-xl font-bold themed-text-primary" x-text="dailyReportData?.summary?.total_draws?.toLocaleString() || 0"></div>
              <div class="text-xs mt-1" 
                   :class="getChangeColorClass(dailyReportData?.vs_yesterday?.total_draws_change)"
                   x-text="'vs昨日 ' + formatReportChange(dailyReportData?.vs_yesterday?.total_draws_change)"></div>
            </div>
            <div class="themed-card rounded-lg p-4 text-center">
              <div class="text-2xl mb-1">🎯</div>
              <div class="text-xs themed-text-muted mb-1">中奖率</div>
              <div class="text-xl font-bold text-green-600" x-text="(dailyReportData?.summary?.win_rate || 0).toFixed(1) + '%'"></div>
              <div class="text-xs mt-1" 
                   :class="getChangeColorClass(dailyReportData?.vs_yesterday?.win_rate_change)"
                   x-text="'vs昨日 ' + formatReportChange(dailyReportData?.vs_yesterday?.win_rate_change)"></div>
            </div>
            <div class="themed-card rounded-lg p-4 text-center">
              <div class="text-2xl mb-1">💰</div>
              <div class="text-xs themed-text-muted mb-1">收入</div>
              <div class="text-xl font-bold text-blue-600" x-text="'¥' + (dailyReportData?.summary?.total_revenue || 0).toLocaleString()"></div>
              <div class="text-xs mt-1" 
                   :class="getChangeColorClass(dailyReportData?.vs_yesterday?.revenue_change)"
                   x-text="'vs昨日 ' + formatReportChange(dailyReportData?.vs_yesterday?.revenue_change)"></div>
            </div>
            <div class="themed-card rounded-lg p-4 text-center">
              <div class="text-2xl mb-1">📈</div>
              <div class="text-xs themed-text-muted mb-1">ROI</div>
              <div class="text-xl font-bold"
                   :class="(dailyReportData?.summary?.roi || 0) >= 0 ? 'text-green-600' : 'text-red-600'" 
                   x-text="((dailyReportData?.summary?.roi || 0) >= 0 ? '+' : '') + (dailyReportData?.summary?.roi || 0).toFixed(1) + '%'"></div>
              <div class="text-xs mt-1" 
                   :class="getChangeColorClass(dailyReportData?.vs_yesterday?.roi_change)"
                   x-text="'vs昨日 ' + formatReportChange(dailyReportData?.vs_yesterday?.roi_change)"></div>
            </div>
          </div>

          <!-- 告警列表 -->
          <template x-if="dailyReportData?.alerts?.length > 0">
            <div class="mb-6">
              <h6 class="font-semibold text-sm mb-3 flex items-center gap-2">
                🚨 告警 (<span x-text="dailyReportData?.alerts?.length || 0"></span>)
              </h6>
              <div class="space-y-2">
                <template x-for="alert in dailyReportData.alerts" :key="alert.alert_id || alert.message">
                  <div class="p-3 rounded-lg border" :class="getAlertLevelClass(alert.level)">
                    <div class="flex items-center gap-2">
                      <span x-text="getAlertLevelIcon(alert.level)"></span>
                      <span class="font-medium text-sm" x-text="alert.message"></span>
                    </div>
                    <div class="text-xs mt-1 opacity-75" x-text="alert.details || ''"></div>
                  </div>
                </template>
              </div>
            </div>
          </template>

          <!-- 24小时分布 -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- 小时分布 -->
            <div class="themed-card rounded-lg p-4">
              <h6 class="font-semibold text-sm mb-3">📊 24小时分布</h6>
              <div class="flex flex-wrap gap-1">
                <template x-for="(hour, index) in dailyReportData?.hourly_breakdown || []" :key="index">
                  <div class="flex flex-col items-center text-xs">
                    <div class="w-4 rounded-t" 
                         :style="'height: ' + Math.max(2, (hour.count / Math.max(...(dailyReportData?.hourly_breakdown || []).map(h => h.count || 1)) * 40)) + 'px'"
                         :class="index === new Date().getHours() ? 'bg-blue-500' : 'bg-gray-300'"></div>
                    <span class="themed-text-muted" x-text="index"></span>
                  </div>
                </template>
              </div>
              <div class="mt-2 text-xs themed-text-muted text-center">
                峰值时段: <span class="font-bold" x-text="dailyReportData?.peak_hour ? dailyReportData.peak_hour + ':00' : '-'"></span>
              </div>
            </div>

            <!-- 热门奖品 -->
            <div class="themed-card rounded-lg p-4">
              <h6 class="font-semibold text-sm mb-3">🏆 热门奖品 Top5</h6>
              <div class="space-y-2">
                <template x-for="(prize, index) in (dailyReportData?.top_prizes || []).slice(0, 5)" :key="index">
                  <div class="flex items-center gap-2">
                    <span class="w-5 h-5 flex items-center justify-center rounded-full text-xs font-bold"
                          :class="index < 3 ? ['bg-yellow-400', 'bg-gray-300', 'bg-amber-600'][index] + ' text-white' : 'bg-gray-100 text-gray-600'"
                          x-text="index + 1"></span>
                    <span class="flex-1 text-sm truncate" x-text="prize.prize_name"></span>
                    <span class="text-sm font-bold text-blue-600" x-text="prize.count + '次'"></span>
                  </div>
                </template>
                <template x-if="!dailyReportData?.top_prizes?.length">
                  <div class="text-center text-sm themed-text-muted py-4">暂无数据</div>
                </template>
              </div>
            </div>
          </div>

          <!-- 档位分布 -->
          <div class="themed-card rounded-lg p-4 mb-6">
            <h6 class="font-semibold text-sm mb-3">📊 档位分布</h6>
            <div class="flex flex-wrap gap-3">
              <template x-for="tier in dailyReportData?.tier_breakdown || []" :key="tier.tier_name">
                <div class="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded-lg">
                  <span class="text-sm font-medium" x-text="tier.tier_name"></span>
                  <span class="text-sm text-blue-600 font-bold" x-text="tier.count + '次'"></span>
                  <span class="text-xs themed-text-muted" x-text="'(' + tier.percentage?.toFixed(1) + '%)'"></span>
                </div>
              </template>
            </div>
          </div>

          <!-- 活动分布 -->
          <template x-if="dailyReportData?.campaigns_breakdown?.length > 0">
            <div class="themed-card rounded-lg p-4">
              <h6 class="font-semibold text-sm mb-3">🎁 活动分布</h6>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="themed-bg-base">
                    <tr>
                      <th class="px-3 py-2 text-left">活动名称</th>
                      <th class="px-3 py-2 text-right">抽奖次数</th>
                      <th class="px-3 py-2 text-right">中奖次数</th>
                      <th class="px-3 py-2 text-right">中奖率</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y">
                    <template x-for="campaign in dailyReportData.campaigns_breakdown" :key="campaign.lottery_campaign_id">
                      <tr class="themed-hover-bg">
                        <td class="px-3 py-2" x-text="campaign.campaign_name"></td>
                        <td class="px-3 py-2 text-right" x-text="campaign.draw_count?.toLocaleString() || 0"></td>
                        <td class="px-3 py-2 text-right" x-text="campaign.win_count?.toLocaleString() || 0"></td>
                        <td class="px-3 py-2 text-right" x-text="(campaign.win_rate || 0).toFixed(1) + '%'"></td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>
          </template>
        </div>

        <!-- 加载状态 -->
        <div class="flex-1 flex items-center justify-center p-12" x-show="loadingDailyReport">
          <div class="text-center">
            <div class="animate-spin w-8 h-8 border-4 border-purple-500 border-t-transparent rounded-full mx-auto mb-3"></div>
            <p class="themed-text-muted">正在生成日报...</p>
          </div>
        </div>

        <!-- 无数据状态 -->
        <div class="flex-1 flex items-center justify-center p-12" x-show="!dailyReportData && !loadingDailyReport">
          <div class="text-center">
            <div class="text-4xl mb-3">📭</div>
            <p class="themed-text-muted">暂无日报数据</p>
          </div>
        </div>

        <!-- 模态框底部 -->
        <div class="p-4 border-t bg-gray-50 flex justify-between items-center">
          <span class="text-xs themed-text-muted">
            生成时间: <span x-text="dailyReportData?.generated_at ? formatDateOnly(dailyReportData.generated_at) : '-'"></span>
          </span>
          <button type="button" class="px-6 py-2 themed-bg-primary text-white rounded-lg themed-hover-primary" @click="closeDailyReportModal()">
            关闭
          </button>
        </div>
      </div>
    </div>

    <!-- ==================== P3新增: 活动ROI分析仪表盘模态框 ==================== -->
    <div x-show="showCampaignRoiModal" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
      <div class="fixed inset-0 bg-black bg-opacity-50" @click="closeCampaignRoiModal()"></div>
      <div class="relative themed-card rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
        <!-- 模态框头部 -->
        <div class="p-4 border-b flex justify-between items-center bg-gradient-to-r from-emerald-500 to-teal-600 text-white">
          <h5 class="font-semibold text-lg flex items-center gap-2">
            📊 活动效果分析
            <span class="text-sm font-normal opacity-90" x-text="selectedCampaign?.campaign_name || ''"></span>
          </h5>
          <button class="p-2 hover:bg-white/20 rounded" @click="closeCampaignRoiModal()">✕</button>
        </div>

        <!-- 模态框内容 -->
        <div class="flex-1 overflow-y-auto p-6" x-show="campaignRoiData && !loadingCampaignRoi">
          <!-- ROI核心指标 -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="themed-card rounded-lg p-4 text-center border-l-4 border-green-500">
              <div class="text-xs themed-text-muted mb-1">总收入</div>
              <div class="text-xl font-bold text-green-600" x-text="'¥' + (campaignRoiData?.total_revenue || 0).toLocaleString()"></div>
            </div>
            <div class="themed-card rounded-lg p-4 text-center border-l-4 border-red-500">
              <div class="text-xs themed-text-muted mb-1">总成本</div>
              <div class="text-xl font-bold text-red-600" x-text="'¥' + (campaignRoiData?.total_cost || 0).toLocaleString()"></div>
            </div>
            <div class="themed-card rounded-lg p-4 text-center border-l-4 border-blue-500">
              <div class="text-xs themed-text-muted mb-1">净利润</div>
              <div class="text-xl font-bold" 
                   :class="(campaignRoiData?.profit || 0) >= 0 ? 'text-green-600' : 'text-red-600'"
                   x-text="(campaignRoiData?.profit >= 0 ? '+¥' : '-¥') + Math.abs(campaignRoiData?.profit || 0).toLocaleString()"></div>
            </div>
            <div class="themed-card rounded-lg p-4 text-center border-l-4 border-purple-500">
              <div class="text-xs themed-text-muted mb-1">ROI</div>
              <div class="text-2xl font-bold" :class="getRoiColorClass(campaignRoiData?.roi)" x-text="formatRoiValue(campaignRoiData?.roi)"></div>
            </div>
          </div>

          <!-- 活动关键数据 -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="themed-card rounded-lg p-3 text-center">
              <div class="text-xs themed-text-muted mb-1">总抽奖次数</div>
              <div class="text-lg font-bold themed-text-primary" x-text="(campaignRoiData?.total_draws || 0).toLocaleString()"></div>
            </div>
            <div class="themed-card rounded-lg p-3 text-center">
              <div class="text-xs themed-text-muted mb-1">总中奖次数</div>
              <div class="text-lg font-bold text-green-600" x-text="(campaignRoiData?.total_wins || 0).toLocaleString()"></div>
            </div>
            <div class="themed-card rounded-lg p-3 text-center">
              <div class="text-xs themed-text-muted mb-1">中奖率</div>
              <div class="text-lg font-bold text-yellow-600" x-text="(campaignRoiData?.win_rate || 0).toFixed(1) + '%'"></div>
            </div>
            <div class="themed-card rounded-lg p-3 text-center">
              <div class="text-xs themed-text-muted mb-1">复购率</div>
              <div class="text-lg font-bold text-blue-600" x-text="(campaignRoiData?.repeat_rate || 0).toFixed(1) + '%'"></div>
            </div>
          </div>

          <!-- 档位成本明细 -->
          <template x-if="campaignRoiData?.tier_cost_breakdown?.length > 0">
            <div class="themed-card rounded-lg p-4 mb-6">
              <h6 class="font-semibold text-sm mb-3">📊 档位成本分析</h6>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="themed-bg-base">
                    <tr>
                      <th class="px-3 py-2 text-left">档位</th>
                      <th class="px-3 py-2 text-right">发放数量</th>
                      <th class="px-3 py-2 text-right">单位成本</th>
                      <th class="px-3 py-2 text-right">总成本</th>
                      <th class="px-3 py-2 text-right">占比</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y">
                    <template x-for="tier in campaignRoiData.tier_cost_breakdown" :key="tier.tier_name || tier.tier">
                      <tr class="themed-hover-bg">
                        <td class="px-3 py-2 font-medium" x-text="tier.tier_name || tier.tier"></td>
                        <td class="px-3 py-2 text-right" x-text="(tier.count || 0).toLocaleString()"></td>
                        <td class="px-3 py-2 text-right" x-text="'¥' + (tier.unit_cost || 0).toFixed(2)"></td>
                        <td class="px-3 py-2 text-right font-bold" x-text="'¥' + (tier.total_cost || 0).toLocaleString()"></td>
                        <td class="px-3 py-2 text-right">
                          <span class="inline-block w-16 bg-gray-200 rounded-full h-2 overflow-hidden">
                            <span class="block h-full bg-blue-500" :style="'width: ' + (tier.percentage || 0) + '%'"></span>
                          </span>
                          <span class="ml-1 text-xs" x-text="(tier.percentage || 0).toFixed(1) + '%'"></span>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>
          </template>

          <!-- ROI分析建议 -->
          <div class="themed-card rounded-lg p-4 themed-bg-base">
            <h6 class="font-semibold text-sm mb-3 flex items-center gap-2">
              💡 运营建议
            </h6>
            <div class="space-y-2 text-sm">
              <template x-if="(campaignRoiData?.roi || 0) > 20">
                <p class="text-green-700">✅ 活动ROI表现优秀，可以考虑增加预算或延长活动周期</p>
              </template>
              <template x-if="(campaignRoiData?.roi || 0) > 0 && (campaignRoiData?.roi || 0) <= 20">
                <p class="text-blue-700">📊 活动ROI正常，建议关注高成本档位优化空间</p>
              </template>
              <template x-if="(campaignRoiData?.roi || 0) <= 0">
                <p class="text-yellow-700">⚠️ 活动ROI为负，建议检查奖品成本配置或提高抽奖单价</p>
              </template>
              <template x-if="(campaignRoiData?.repeat_rate || 0) < 20">
                <p class="text-orange-700">🔄 复购率偏低，可通过会员专属奖品或连抽优惠提升</p>
              </template>
              <template x-if="(campaignRoiData?.win_rate || 0) > 50">
                <p class="text-cyan-700">🎯 中奖率较高，注意预算消耗速度</p>
              </template>
            </div>
          </div>
        </div>

        <!-- 加载状态 -->
        <div class="flex-1 flex items-center justify-center p-12" x-show="loadingCampaignRoi">
          <div class="text-center">
            <div class="animate-spin w-8 h-8 border-4 border-emerald-500 border-t-transparent rounded-full mx-auto mb-3"></div>
            <p class="themed-text-muted">正在计算ROI数据...</p>
          </div>
        </div>

        <!-- 无数据状态 -->
        <div class="flex-1 flex items-center justify-center p-12" x-show="!campaignRoiData && !loadingCampaignRoi">
          <div class="text-center">
            <div class="text-4xl mb-3">📭</div>
            <p class="themed-text-muted">暂无ROI分析数据</p>
          </div>
        </div>

        <!-- 模态框底部 -->
        <div class="p-4 border-t bg-gray-50 flex justify-end">
          <button type="button" class="px-6 py-2 themed-bg-primary text-white rounded-lg themed-hover-primary" @click="closeCampaignRoiModal()">
            关闭
          </button>
        </div>
      </div>
    </div>

  </div><!-- 关闭 lotteryNavigation -->

  <!-- 页面专属逻辑 -->
  <%- include('partials/footer') %>


  <script type="module" src="./src/modules/lottery/pages/lottery-management.js"></script>
</body>
</html>
