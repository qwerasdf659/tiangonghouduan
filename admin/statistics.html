<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '数据统计报表', 
    pageStyle: '[x-cloak] { display: none !important; } .chart-container { height: 280px; } .tabular-nums { font-variant-numeric: tabular-nums; } .stats-icon { transition: transform 0.3s ease; } .stats-card-hover:hover .stats-icon { transform: scale(1.1) rotate(5deg); }' 
  }) %>
  <!-- ECharts 已通过 main.js 统一导入，无需 CDN -->
</head>
<body class="themed-bg-subtle min-h-screen" x-data="statisticsPage()" x-init="init()" x-cloak>
  
  <!-- 导航栏 -->
  <nav class="themed-bg-primary text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="hover:text-blue-200">← 返回工作台</a>
        <span class="text-lg font-semibold">📊 数据统计报表</span>
      </div>
      <div class="flex items-center space-x-4">
        <span x-text="'欢迎，' + (userInfo?.nickname || '管理员')"></span>
        <button @click="logout()" class="px-3 py-1 border border-white/50 rounded hover:bg-white/10">退出登录</button>
      </div>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-6">
    <!-- 时间范围选择 -->
    <div class="themed-card rounded-lg shadow mb-6">
      <div class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">统计周期</label>
            <select x-model="filters.period" @change="onPeriodChange()" class="w-full px-3 py-2 border rounded-lg">
              <option value="today">今日</option>
              <option value="yesterday">昨日</option>
              <option value="week">本周</option>
              <option value="month">本月</option>
              <option value="custom">自定义</option>
            </select>
          </div>
          <div x-show="filters.period === 'custom'">
            <label class="block text-sm font-medium themed-text-secondary mb-1">开始日期</label>
            <input type="date" x-model="filters.startDate" class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div x-show="filters.period === 'custom'">
            <label class="block text-sm font-medium themed-text-secondary mb-1">结束日期</label>
            <input type="date" x-model="filters.endDate" class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div>
            <button @click="loadStatistics()" :disabled="loading" class="w-full px-4 py-2 themed-bg-primary text-white rounded-lg themed-hover-primary disabled:opacity-50">
              <span x-show="!loading">🔍 查询</span>
              <span x-show="loading">加载中...</span>
            </button>
          </div>
          <div>
            <button @click="exportReport()" :disabled="exporting" class="w-full px-4 py-2 themed-btn-primary rounded-lg disabled:opacity-50">
              📥 导出报表
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 核心指标总览（带数字动画） -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <!-- 骨架屏加载状态 -->
      <template x-if="loading">
        <template x-for="i in 4" :key="'skeleton-' + i">
          <div class="themed-card rounded-lg shadow p-4">
            <div class="flex justify-between items-center">
              <div class="space-y-2 flex-1">
                <div class="skeleton-text-sm w-20"></div>
                <div class="skeleton-title w-24"></div>
                <div class="skeleton-text-xs w-16"></div>
              </div>
              <div class="skeleton-avatar-lg"></div>
            </div>
          </div>
        </template>
      </template>

      <!-- 实际统计卡片（带数字滚动动画 + 迷你图表） -->
      <template x-if="!loading">
        <div class="themed-card rounded-lg shadow p-4 stats-card-hover transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
          <div class="flex justify-between items-center">
            <div class="flex-1">
              <p class="themed-text-muted text-sm">总用户数</p>
              <h3 class="text-2xl font-bold themed-text tabular-nums" x-text="getAnimatedValue('totalUsers')">-</h3>
              <span :class="stats.userTrend >= 0 ? 'text-green-500' : 'text-red-500'" class="text-sm flex items-center gap-1">
                <span x-text="stats.userTrend >= 0 ? '📈' : '📉'"></span>
                <span x-text="Math.abs(stats.userTrend).toFixed(1) + '%'"></span>
              </span>
            </div>
            <!-- 迷你趋势图 -->
            <div class="w-20 h-10" x-data="trendLine({ data: stats.userTrendData || [10, 15, 12, 18, 22, 25, 30], color: '#818cf8' })"></div>
          </div>
        </div>
      </template>
      <template x-if="!loading">
        <div class="themed-card rounded-lg shadow p-4 stats-card-hover transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
          <div class="flex justify-between items-center">
            <div class="flex-1">
              <p class="themed-text-muted text-sm">抽奖次数</p>
              <h3 class="text-2xl font-bold themed-text tabular-nums" x-text="getAnimatedValue('totalDraws')">-</h3>
              <span :class="stats.drawTrend >= 0 ? 'text-green-500' : 'text-red-500'" class="text-sm flex items-center gap-1">
                <span x-text="stats.drawTrend >= 0 ? '📈' : '📉'"></span>
                <span x-text="Math.abs(stats.drawTrend).toFixed(1) + '%'"></span>
              </span>
            </div>
            <!-- 迷你柱状图 -->
            <div class="w-20 h-10" x-data="trendBar({ data: stats.drawTrendData || [5, 8, 12, 6, 15, 10, 18], color: '#22c55e' })"></div>
          </div>
        </div>
      </template>
      <template x-if="!loading">
        <div class="themed-card rounded-lg shadow p-4 stats-card-hover transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
          <div class="flex justify-between items-center">
            <div class="flex-1">
              <p class="themed-text-muted text-sm">中奖率</p>
              <h3 class="text-2xl font-bold themed-text tabular-nums">
                <span x-text="getAnimatedValue('winRate')">-</span>%
              </h3>
              <span :class="stats.winRateTrend >= 0 ? 'text-green-500' : 'text-red-500'" class="text-sm flex items-center gap-1">
                <span x-text="stats.winRateTrend >= 0 ? '📈' : '📉'"></span>
                <span x-text="Math.abs(stats.winRateTrend).toFixed(1) + '%'"></span>
              </span>
            </div>
            <!-- 进度环 -->
            <div class="w-12 h-12" x-data="progressRing({ data: stats.winRate || 45, color: '#eab308' })"></div>
          </div>
        </div>
      </template>
      <template x-if="!loading">
        <div class="themed-card rounded-lg shadow p-4 stats-card-hover transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
          <div class="flex justify-between items-center">
            <div class="flex-1">
              <p class="themed-text-muted text-sm">积分发放</p>
              <h3 class="text-2xl font-bold themed-text tabular-nums" x-text="getAnimatedValue('totalRevenue')">-</h3>
              <span :class="stats.revenueTrend >= 0 ? 'text-green-500' : 'text-red-500'" class="text-sm flex items-center gap-1">
                <span x-text="stats.revenueTrend >= 0 ? '📈' : '📉'"></span>
                <span x-text="Math.abs(stats.revenueTrend).toFixed(1) + '%'"></span>
              </span>
            </div>
            <!-- 迷你趋势图 -->
            <div class="w-20 h-10" x-data="trendLine({ data: stats.revenueTrendData || [100, 120, 110, 150, 180, 160, 200], color: '#f97316' })"></div>
          </div>
        </div>
      </template>
    </div>

    <!-- 详细统计区域 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <!-- 用户统计 -->
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">👥 用户统计</h5>
        </div>
        <div class="p-4 grid grid-cols-2 gap-4">
          <div class="text-center p-3 themed-bg-primary-light rounded">
            <p class="themed-text-muted text-sm">新增用户</p>
            <h4 class="text-xl font-bold themed-text-primary" x-text="userStats.newUsers">0</h4>
          </div>
          <div class="text-center p-3 bg-green-50 rounded">
            <p class="themed-text-muted text-sm">活跃用户</p>
            <h4 class="text-xl font-bold text-green-600" x-text="userStats.activeUsers">0</h4>
          </div>
          <div class="text-center p-3 bg-purple-50 rounded">
            <p class="themed-text-muted text-sm">管理员</p>
            <h4 class="text-xl font-bold text-purple-600" x-text="userStats.adminUsers">0</h4>
          </div>
          <div class="text-center p-3 themed-bg-base rounded">
            <p class="themed-text-muted text-sm">普通用户</p>
            <h4 class="text-xl font-bold themed-text-muted" x-text="userStats.regularUsers">0</h4>
          </div>
        </div>
      </div>

      <!-- 抽奖统计 -->
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">🎁 抽奖统计</h5>
        </div>
        <div class="p-4 grid grid-cols-2 gap-4">
          <div class="text-center p-3 themed-bg-primary-light rounded">
            <p class="themed-text-muted text-sm">总抽奖次数</p>
            <h4 class="text-xl font-bold themed-text-primary" x-text="lotteryStats.totalDraws">0</h4>
          </div>
          <div class="text-center p-3 bg-yellow-50 rounded">
            <p class="themed-text-muted text-sm">高档奖励</p>
            <h4 class="text-xl font-bold text-yellow-600" x-text="lotteryStats.highTierWins">0</h4>
          </div>
          <div class="text-center p-3 bg-green-50 rounded">
            <p class="themed-text-muted text-sm">普通奖励</p>
            <h4 class="text-xl font-bold text-green-600" x-text="lotteryStats.regularWins">0</h4>
          </div>
          <div class="text-center p-3 bg-red-50 rounded">
            <p class="themed-text-muted text-sm">中奖率</p>
            <h4 class="text-xl font-bold text-red-600" x-text="lotteryStats.winRate + '%'">0%</h4>
          </div>
        </div>
      </div>
    </div>

    <!-- 图表区域 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">📈 用户增长趋势</h5>
        </div>
        <div class="p-4">
          <div x-ref="trendChart" class="chart-container"></div>
        </div>
      </div>
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">📊 用户类型分布</h5>
        </div>
        <div class="p-4">
          <div x-ref="userTypeChart" class="chart-container"></div>
        </div>
      </div>
    </div>
  </div>

  <%- include('partials/footer') %>



  <script type="module" src="./src/modules/analytics/pages/statistics.js"></script>
</body>
</html>
