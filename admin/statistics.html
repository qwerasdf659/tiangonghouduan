<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '数据统计报表', 
    pageStyle: '[x-cloak] { display: none !important; } .chart-container { height: 280px; }' 
  }) %>
  <!-- ECharts 已通过 main.js 统一导入，无需 CDN -->
</head>
<body class="bg-gray-100 min-h-screen" x-data="statisticsPage()" x-init="init()" x-cloak>
  
  <!-- 导航栏 -->
  <nav class="bg-indigo-600 text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/dashboard.html" class="hover:text-indigo-200">← 返回仪表盘</a>
        <span class="text-lg font-semibold">📊 数据统计报表</span>
      </div>
      <div class="flex items-center space-x-4">
        <span x-text="'欢迎，' + (userInfo?.nickname || '管理员')"></span>
        <button @click="logout()" class="px-3 py-1 border border-white/50 rounded hover:bg-white/10">退出登录</button>
      </div>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-6">
    <!-- 时间范围选择 -->
    <div class="bg-white rounded-lg shadow mb-6">
      <div class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">统计周期</label>
            <select x-model="filters.period" @change="onPeriodChange()" class="w-full px-3 py-2 border rounded-lg">
              <option value="today">今日</option>
              <option value="yesterday">昨日</option>
              <option value="week">本周</option>
              <option value="month">本月</option>
              <option value="custom">自定义</option>
            </select>
          </div>
          <div x-show="filters.period === 'custom'">
            <label class="block text-sm font-medium text-gray-700 mb-1">开始日期</label>
            <input type="date" x-model="filters.startDate" class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div x-show="filters.period === 'custom'">
            <label class="block text-sm font-medium text-gray-700 mb-1">结束日期</label>
            <input type="date" x-model="filters.endDate" class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div>
            <button @click="loadStatistics()" :disabled="loading" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50">
              <span x-show="!loading">🔍 查询</span>
              <span x-show="loading">加载中...</span>
            </button>
          </div>
          <div>
            <button @click="exportReport()" :disabled="exporting" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50">
              📥 导出报表
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 核心指标总览 -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-lg shadow p-4">
        <div class="flex justify-between items-center">
          <div>
            <p class="text-gray-500 text-sm">总用户数</p>
            <h3 class="text-2xl font-bold text-gray-900" x-text="formatNumber(stats.totalUsers)">-</h3>
            <span :class="stats.userTrend >= 0 ? 'text-green-500' : 'text-red-500'" class="text-sm">
              <span x-text="(stats.userTrend >= 0 ? '↑' : '↓') + Math.abs(stats.userTrend) + '%'"></span>
            </span>
          </div>
          <div class="text-4xl text-indigo-400">👥</div>
        </div>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <div class="flex justify-between items-center">
          <div>
            <p class="text-gray-500 text-sm">抽奖次数</p>
            <h3 class="text-2xl font-bold text-gray-900" x-text="formatNumber(stats.totalDraws)">-</h3>
            <span :class="stats.drawTrend >= 0 ? 'text-green-500' : 'text-red-500'" class="text-sm">
              <span x-text="(stats.drawTrend >= 0 ? '↑' : '↓') + Math.abs(stats.drawTrend) + '%'"></span>
            </span>
          </div>
          <div class="text-4xl text-green-400">🎁</div>
        </div>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <div class="flex justify-between items-center">
          <div>
            <p class="text-gray-500 text-sm">中奖率</p>
            <h3 class="text-2xl font-bold text-gray-900" x-text="stats.winRate + '%'">-</h3>
            <span :class="stats.winRateTrend >= 0 ? 'text-green-500' : 'text-red-500'" class="text-sm">
              <span x-text="(stats.winRateTrend >= 0 ? '↑' : '↓') + Math.abs(stats.winRateTrend) + '%'"></span>
            </span>
          </div>
          <div class="text-4xl text-yellow-400">🏆</div>
        </div>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <div class="flex justify-between items-center">
          <div>
            <p class="text-gray-500 text-sm">积分发放</p>
            <h3 class="text-2xl font-bold text-gray-900" x-text="formatNumber(stats.totalRevenue)">-</h3>
            <span :class="stats.revenueTrend >= 0 ? 'text-green-500' : 'text-red-500'" class="text-sm">
              <span x-text="(stats.revenueTrend >= 0 ? '↑' : '↓') + Math.abs(stats.revenueTrend) + '%'"></span>
            </span>
          </div>
          <div class="text-4xl text-orange-400">⭐</div>
        </div>
      </div>
    </div>

    <!-- 详细统计区域 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <!-- 用户统计 -->
      <div class="bg-white rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">👥 用户统计</h5>
        </div>
        <div class="p-4 grid grid-cols-2 gap-4">
          <div class="text-center p-3 bg-blue-50 rounded">
            <p class="text-gray-500 text-sm">新增用户</p>
            <h4 class="text-xl font-bold text-blue-600" x-text="userStats.newUsers">0</h4>
          </div>
          <div class="text-center p-3 bg-green-50 rounded">
            <p class="text-gray-500 text-sm">活跃用户</p>
            <h4 class="text-xl font-bold text-green-600" x-text="userStats.activeUsers">0</h4>
          </div>
          <div class="text-center p-3 bg-purple-50 rounded">
            <p class="text-gray-500 text-sm">管理员</p>
            <h4 class="text-xl font-bold text-purple-600" x-text="userStats.adminUsers">0</h4>
          </div>
          <div class="text-center p-3 bg-gray-50 rounded">
            <p class="text-gray-500 text-sm">普通用户</p>
            <h4 class="text-xl font-bold text-gray-600" x-text="userStats.regularUsers">0</h4>
          </div>
        </div>
      </div>

      <!-- 抽奖统计 -->
      <div class="bg-white rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">🎁 抽奖统计</h5>
        </div>
        <div class="p-4 grid grid-cols-2 gap-4">
          <div class="text-center p-3 bg-blue-50 rounded">
            <p class="text-gray-500 text-sm">总抽奖次数</p>
            <h4 class="text-xl font-bold text-blue-600" x-text="lotteryStats.totalDraws">0</h4>
          </div>
          <div class="text-center p-3 bg-yellow-50 rounded">
            <p class="text-gray-500 text-sm">高档奖励</p>
            <h4 class="text-xl font-bold text-yellow-600" x-text="lotteryStats.highTierWins">0</h4>
          </div>
          <div class="text-center p-3 bg-green-50 rounded">
            <p class="text-gray-500 text-sm">普通奖励</p>
            <h4 class="text-xl font-bold text-green-600" x-text="lotteryStats.regularWins">0</h4>
          </div>
          <div class="text-center p-3 bg-red-50 rounded">
            <p class="text-gray-500 text-sm">中奖率</p>
            <h4 class="text-xl font-bold text-red-600" x-text="lotteryStats.winRate + '%'">0%</h4>
          </div>
        </div>
      </div>
    </div>

    <!-- 图表区域 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">📈 用户增长趋势</h5>
        </div>
        <div class="p-4">
          <div id="userTrendChart" class="chart-container"></div>
        </div>
      </div>
      <div class="bg-white rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">📊 抽奖趋势</h5>
        </div>
        <div class="p-4">
          <div id="lotteryTrendChart" class="chart-container"></div>
        </div>
      </div>
    </div>
  </div>

  <%- include('partials/footer') %>



  <script type="module" src="./src/modules/analytics/pages/statistics.js"></script>
</body>
</html>
