<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '扫码核销', 
    pageStyle: '[x-cloak] { display: none !important; }' 
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen">
  
  <!-- 导航栏 -->
  <nav class="themed-bg-primary text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="hover:text-blue-200 transition-colors">← 返回工作台</a>
        <span class="text-lg font-semibold">📱 扫码核销</span>
      </div>
      <div class="flex items-center space-x-4">
        <a href="/admin/redemption-management.html" class="hover:text-blue-200 transition-colors text-sm">核销管理 →</a>
        <button onclick="logout()" class="px-3 py-1 border border-white rounded hover:bg-white hover:themed-text-secondary text-sm">退出登录</button>
      </div>
    </div>
  </nav>

  <!-- 主内容 -->
  <div class="container mx-auto px-4 py-6 max-w-2xl" x-data="redemptionScan()" x-cloak>

    <!-- 操作说明 -->
    <div class="themed-bg-base rounded-lg shadow p-4 mb-6">
      <h2 class="text-lg font-semibold mb-2">核销流程</h2>
      <div class="text-sm themed-text-secondary space-y-1">
        <p>1. 用户在小程序中生成兑换码（XXXX-YYYY-ZZZZ 格式文本码 或 QR码）</p>
        <p>2. 店员在此页面输入文本码 或 使用摄像头扫描QR码</p>
        <p>3. 核销成功后物品状态变为 used，对应的 item_ledger 双录记账</p>
      </div>
    </div>

    <!-- 文本码核销 -->
    <div class="themed-bg-base rounded-lg shadow p-6 mb-6">
      <h3 class="text-lg font-semibold mb-4">📝 文本码核销</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium themed-text-secondary mb-1">兑换码</label>
          <input type="text" x-model="redeem_code"
            @keyup.enter="fulfillByTextCode()"
            placeholder="输入 XXXX-YYYY-ZZZZ 格式兑换码"
            class="w-full px-4 py-3 border rounded-lg themed-border text-lg tracking-wider text-center font-mono focus:ring-2 focus:ring-blue-500"
            :disabled="processing"
            maxlength="14">
        </div>
        <button @click="fulfillByTextCode()" :disabled="processing || !redeem_code.trim()"
          class="w-full py-3 themed-bg-primary text-white rounded-lg themed-hover-primary text-lg font-medium transition-colors"
          :class="processing ? 'opacity-50 cursor-not-allowed' : ''">
          <span x-show="processing" class="inline-block animate-spin mr-2">⏳</span>
          <span x-text="processing ? '核销中...' : '确认核销'"></span>
        </button>
      </div>
    </div>

    <!-- 核销结果 -->
    <div x-show="result" class="mb-6" x-cloak>
      <!-- 成功 -->
      <div x-show="result?.type === 'success'" class="themed-bg-base rounded-lg shadow p-6 border-l-4 border-green-500">
        <div class="flex items-center mb-3">
          <span class="text-3xl mr-3">✅</span>
          <h3 class="text-lg font-semibold text-green-700" x-text="result?.message"></h3>
        </div>
        <div x-show="result?.data" class="space-y-2 text-sm">
          <template x-if="result?.data?.order">
            <div class="bg-green-50 p-3 rounded">
              <p>订单ID：<span class="font-mono" x-text="result.data.order.redemption_order_id"></span></p>
              <p x-show="result.data.order.item_id">物品ID：<span x-text="result.data.order.item_id"></span></p>
            </div>
          </template>
        </div>
        <button @click="clearResult()" class="mt-3 px-4 py-2 bg-green-100 text-green-700 rounded hover:bg-green-200 text-sm">继续核销</button>
      </div>

      <!-- 失败 -->
      <div x-show="result?.type === 'error'" class="themed-bg-base rounded-lg shadow p-6 border-l-4 border-red-500">
        <div class="flex items-center mb-3">
          <span class="text-3xl mr-3">❌</span>
          <h3 class="text-lg font-semibold text-red-700">核销失败</h3>
        </div>
        <p class="text-red-600" x-text="result?.message"></p>
        <button @click="clearResult()" class="mt-3 px-4 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm">重试</button>
      </div>
    </div>

    <!-- 核销历史（本次会话） -->
    <div x-show="history.length > 0" class="themed-bg-base rounded-lg shadow overflow-hidden">
      <div class="px-4 py-3 themed-border-b flex justify-between items-center">
        <h3 class="font-semibold">本次核销记录</h3>
        <button @click="clearHistory()" class="text-sm text-red-500 hover:text-red-700">清空</button>
      </div>
      <div class="divide-y">
        <template x-for="(item, idx) in history" :key="idx">
          <div class="px-4 py-3 flex justify-between items-center">
            <div>
              <span class="font-mono text-sm" x-text="item.code"></span>
              <span class="text-xs themed-text-secondary ml-2" x-text="item.time"></span>
            </div>
            <span class="px-2 py-1 rounded text-xs text-white"
              :class="item.status === 'success' ? 'bg-green-500' : 'bg-red-500'"
              x-text="item.status === 'success' ? '成功' : '失败'"></span>
          </div>
        </template>
      </div>
    </div>

  </div>

  <%- include('partials/footer') %>
  <script type="module" src="./src/modules/operations/pages/redemption-scan.js"></script>
</body>
</html>
