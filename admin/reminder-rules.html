<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æé†’è§„åˆ™é…ç½® - ç®¡ç†åå°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    [x-cloak] { display: none !important; }
    
    /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
    .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
    
    /* è§„åˆ™å¡ç‰‡ */
    .rule-card { transition: all 0.2s ease; }
    .rule-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
    
    /* çŠ¶æ€å¼€å…³ */
    .toggle-switch { position: relative; width: 44px; height: 24px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; inset: 0; background-color: #cbd5e1; transition: .3s; border-radius: 24px; }
    .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
    input:checked + .toggle-slider { background-color: #3b82f6; }
    input:checked + .toggle-slider:before { transform: translateX(20px); }
    
    /* ä¼˜å…ˆçº§æ ‡ç­¾ */
    .priority-high { background-color: #fee2e2; color: #dc2626; }
    .priority-medium { background-color: #fef3c7; color: #d97706; }
    .priority-low { background-color: #d1fae5; color: #059669; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div x-data="reminderRulesPage()" x-init="init()" x-cloak class="p-6">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold text-gray-800">ğŸ”” æé†’è§„åˆ™é…ç½®</h1>
        <p class="text-sm text-gray-500 mt-1">
          ç®¡ç†ç³»ç»Ÿè‡ªåŠ¨æé†’è§„åˆ™ Â· å…± <span x-text="pagination.total">0</span> æ¡è§„åˆ™
        </p>
      </div>
      
      <div class="flex items-center gap-3">
        <!-- æ–°å»ºè§„åˆ™æŒ‰é’® -->
        <button 
          @click="openCreateModal()"
          class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition"
        >
          <span>â•</span>
          æ–°å»ºè§„åˆ™
        </button>
        
        <!-- åˆ·æ–°æŒ‰é’® -->
        <button 
          @click="loadRules()"
          :disabled="loading"
          class="flex items-center gap-2 px-4 py-2 border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-gray-50 transition"
        >
          <span :class="loading && 'animate-spin'">ğŸ”„</span>
          åˆ·æ–°
        </button>
      </div>
    </div>
    
    <!-- ç­›é€‰æ  -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
      <div class="flex flex-wrap items-center gap-4">
        <!-- ç±»å‹ç­›é€‰ -->
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-500">ç±»å‹:</span>
          <select 
            x-model="filter.rule_type"
            @change="loadRules()"
            class="px-3 py-1.5 bg-gray-100 border-0 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
          >
            <option value="">å…¨éƒ¨ç±»å‹</option>
            <option value="budget">é¢„ç®—æé†’</option>
            <option value="inventory">åº“å­˜æé†’</option>
            <option value="performance">æ€§èƒ½æé†’</option>
            <option value="security">å®‰å…¨æé†’</option>
            <option value="business">ä¸šåŠ¡æé†’</option>
            <option value="system">ç³»ç»Ÿæé†’</option>
          </select>
        </div>
        
        <!-- çŠ¶æ€ç­›é€‰ -->
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-500">çŠ¶æ€:</span>
          <select 
            x-model="filter.is_enabled"
            @change="loadRules()"
            class="px-3 py-1.5 bg-gray-100 border-0 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
          >
            <option value="">å…¨éƒ¨çŠ¶æ€</option>
            <option value="true">å·²å¯ç”¨</option>
            <option value="false">å·²ç¦ç”¨</option>
          </select>
        </div>
        
        <!-- ç³»ç»Ÿè§„åˆ™ç­›é€‰ -->
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-500">æ¥æº:</span>
          <select 
            x-model="filter.is_system"
            @change="loadRules()"
            class="px-3 py-1.5 bg-gray-100 border-0 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
          >
            <option value="">å…¨éƒ¨æ¥æº</option>
            <option value="true">ç³»ç»Ÿè§„åˆ™</option>
            <option value="false">è‡ªå®šä¹‰è§„åˆ™</option>
          </select>
        </div>
        
        <!-- æœç´¢æ¡† -->
        <div class="flex-1 min-w-[200px]">
          <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">ğŸ”</span>
            <input 
              type="text"
              x-model="filter.keyword"
              @input.debounce.300ms="loadRules()"
              placeholder="æœç´¢è§„åˆ™åç§°..."
              class="w-full pl-10 pr-4 py-2 bg-gray-100 border-0 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
            />
          </div>
        </div>
      </div>
    </div>
    
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="grid grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">è§„åˆ™æ€»æ•°</p>
            <p class="text-2xl font-bold text-gray-800" x-text="stats.total">0</p>
          </div>
          <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-2xl">ğŸ“‹</div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">å·²å¯ç”¨</p>
            <p class="text-2xl font-bold text-green-600" x-text="stats.enabled">0</p>
          </div>
          <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center text-2xl">âœ…</div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">å·²ç¦ç”¨</p>
            <p class="text-2xl font-bold text-gray-500" x-text="stats.disabled">0</p>
          </div>
          <div class="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center text-2xl">â¸ï¸</div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">ä»Šæ—¥è§¦å‘</p>
            <p class="text-2xl font-bold text-orange-600" x-text="stats.triggered_today">0</p>
          </div>
          <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center text-2xl">ğŸ””</div>
        </div>
      </div>
    </div>
    
    <!-- è§„åˆ™åˆ—è¡¨ -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
      <!-- åŠ è½½çŠ¶æ€ -->
      <div x-show="loading" class="p-12 text-center">
        <div class="animate-spin text-4xl mb-4">â³</div>
        <p class="text-gray-500">åŠ è½½ä¸­...</p>
      </div>
      
      <!-- ç©ºçŠ¶æ€ -->
      <div x-show="!loading && rules.length === 0" class="p-12 text-center">
        <div class="text-6xl mb-4">ğŸ“­</div>
        <p class="text-gray-500 mb-4">æš‚æ— æé†’è§„åˆ™</p>
        <button 
          @click="openCreateModal()"
          class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600 transition"
        >
          åˆ›å»ºç¬¬ä¸€æ¡è§„åˆ™
        </button>
      </div>
      
      <!-- è§„åˆ™è¡¨æ ¼ -->
      <table x-show="!loading && rules.length > 0" class="w-full">
        <thead class="bg-gray-50 border-b border-gray-100">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è§„åˆ™ä¿¡æ¯</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç±»å‹</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä¼˜å…ˆçº§</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ£€æŸ¥é—´éš”</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">çŠ¶æ€</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          <template x-for="rule in rules" :key="rule.reminder_rule_id">
            <tr class="rule-card hover:bg-gray-50 transition">
              <!-- è§„åˆ™ä¿¡æ¯ -->
              <td class="px-6 py-4">
                <div class="flex items-start gap-3">
                  <div>
                    <p class="font-medium text-gray-800" x-text="rule.name || rule.rule_name"></p>
                    <p class="text-sm text-gray-500 mt-1 max-w-md truncate" x-text="rule.description || '-'"></p>
                    <div class="flex items-center gap-2 mt-2">
                      <span 
                        x-show="rule.is_system" 
                        class="px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded"
                      >ç³»ç»Ÿè§„åˆ™</span>
                      <span class="text-xs text-gray-400" x-text="'åˆ›å»ºäº ' + formatDate(rule.created_at)"></span>
                    </div>
                  </div>
                </div>
              </td>
              
              <!-- ç±»å‹ -->
              <td class="px-6 py-4">
                <span 
                  class="px-2 py-1 text-xs rounded-full"
                  :class="getRuleTypeClass(rule.rule_type)"
                  x-text="getRuleTypeName(rule.rule_type)"
                ></span>
              </td>
              
              <!-- ä¼˜å…ˆçº§ -->
              <td class="px-6 py-4">
                <span 
                  class="px-2 py-1 text-xs rounded-full"
                  :class="getPriorityClass(rule.priority)"
                  x-text="getPriorityName(rule.priority)"
                ></span>
              </td>
              
              <!-- æ£€æŸ¥é—´éš” -->
              <td class="px-6 py-4">
                <span class="text-sm text-gray-600" x-text="formatInterval(rule.check_interval)"></span>
              </td>
              
              <!-- çŠ¶æ€å¼€å…³ -->
              <td class="px-6 py-4 text-center">
                <label class="toggle-switch inline-block">
                  <input 
                    type="checkbox" 
                    :checked="rule.is_enabled"
                    @change="toggleRule(rule)"
                    :disabled="rule.is_system"
                  >
                  <span class="toggle-slider"></span>
                </label>
              </td>
              
              <!-- æ“ä½œ -->
              <td class="px-6 py-4 text-right">
                <div class="flex items-center justify-end gap-2">
                  <button 
                    @click="testRule(rule)"
                    class="px-3 py-1 text-xs bg-yellow-50 text-yellow-600 rounded hover:bg-yellow-100 transition"
                    title="æµ‹è¯•è§„åˆ™"
                  >
                    ğŸ§ª æµ‹è¯•
                  </button>
                  <button 
                    @click="executeRule(rule)"
                    class="px-3 py-1 text-xs bg-green-50 text-green-600 rounded hover:bg-green-100 transition"
                    title="ç«‹å³æ‰§è¡Œ"
                  >
                    â–¶ï¸ æ‰§è¡Œ
                  </button>
                  <button 
                    @click="openEditModal(rule)"
                    class="px-3 py-1 text-xs bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition"
                    :disabled="rule.is_system"
                    :class="rule.is_system && 'opacity-50 cursor-not-allowed'"
                  >
                    âœï¸ ç¼–è¾‘
                  </button>
                  <button 
                    @click="deleteRule(rule)"
                    class="px-3 py-1 text-xs bg-red-50 text-red-600 rounded hover:bg-red-100 transition"
                    :disabled="rule.is_system"
                    :class="rule.is_system && 'opacity-50 cursor-not-allowed'"
                  >
                    ğŸ—‘ï¸ åˆ é™¤
                  </button>
                </div>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
      
      <!-- åˆ†é¡µ -->
      <div x-show="!loading && rules.length > 0" class="px-6 py-4 border-t border-gray-100 flex items-center justify-between">
        <p class="text-sm text-gray-500">
          æ˜¾ç¤º <span x-text="(pagination.page - 1) * pagination.page_size + 1"></span> - 
          <span x-text="Math.min(pagination.page * pagination.page_size, pagination.total)"></span> 
          æ¡ï¼Œå…± <span x-text="pagination.total"></span> æ¡
        </p>
        <div class="flex items-center gap-2">
          <button 
            @click="prevPage()"
            :disabled="pagination.page <= 1"
            class="px-3 py-1 border rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
          >ä¸Šä¸€é¡µ</button>
          <span class="px-3 py-1 text-sm">
            <span x-text="pagination.page"></span> / <span x-text="Math.ceil(pagination.total / pagination.page_size) || 1"></span>
          </span>
          <button 
            @click="nextPage()"
            :disabled="pagination.page >= Math.ceil(pagination.total / pagination.page_size)"
            class="px-3 py-1 border rounded text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
          >ä¸‹ä¸€é¡µ</button>
        </div>
      </div>
    </div>
    
    <!-- è§„åˆ™ç¼–è¾‘å¼¹çª— -->
    <div 
      x-show="showModal"
      x-cloak
      class="fixed inset-0 z-50 flex items-center justify-center"
      style="display: none;"
    >
      <div class="fixed inset-0 bg-black/50" @click="closeModal()"></div>
      <div class="relative bg-white rounded-xl shadow-xl w-full max-w-2xl mx-4 z-10 max-h-[90vh] overflow-y-auto">
        <!-- å¼¹çª—å¤´éƒ¨ -->
        <div class="sticky top-0 bg-white px-6 py-4 border-b flex items-center justify-between z-10">
          <h3 class="text-lg font-semibold text-gray-800" x-text="editingRule ? 'ç¼–è¾‘è§„åˆ™' : 'æ–°å»ºè§„åˆ™'"></h3>
          <button @click="closeModal()" class="text-gray-400 hover:text-gray-600 text-xl">âœ•</button>
        </div>
        
        <!-- å¼¹çª—å†…å®¹ -->
        <div class="p-6 space-y-4">
          <!-- è§„åˆ™åç§° -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">è§„åˆ™åç§° <span class="text-red-500">*</span></label>
            <input 
              type="text"
              x-model="form.name"
              placeholder="å¦‚ï¼šé¢„ç®—ä½™é¢ä¸è¶³æé†’"
              class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
          
          <!-- è§„åˆ™ç±»å‹ -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">è§„åˆ™ç±»å‹ <span class="text-red-500">*</span></label>
            <select 
              x-model="form.rule_type"
              class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">è¯·é€‰æ‹©ç±»å‹</option>
              <option value="budget">é¢„ç®—æé†’</option>
              <option value="inventory">åº“å­˜æé†’</option>
              <option value="performance">æ€§èƒ½æé†’</option>
              <option value="security">å®‰å…¨æé†’</option>
              <option value="business">ä¸šåŠ¡æé†’</option>
              <option value="system">ç³»ç»Ÿæé†’</option>
            </select>
          </div>
          
          <!-- è§„åˆ™æè¿° -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">è§„åˆ™æè¿°</label>
            <textarea 
              x-model="form.description"
              rows="2"
              placeholder="æè¿°è§„åˆ™çš„ç”¨é€”å’Œè§¦å‘æ¡ä»¶"
              class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            ></textarea>
          </div>
          
          <!-- ä¼˜å…ˆçº§å’Œæ£€æŸ¥é—´éš” -->
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ä¼˜å…ˆçº§</label>
              <select 
                x-model="form.priority"
                class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="80">é«˜ä¼˜å…ˆçº§</option>
                <option value="50">ä¸­ä¼˜å…ˆçº§</option>
                <option value="20">ä½ä¼˜å…ˆçº§</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">æ£€æŸ¥é—´éš”ï¼ˆåˆ†é’Ÿï¼‰</label>
              <input 
                type="number"
                x-model.number="form.check_interval"
                min="1"
                max="1440"
                class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
          </div>
          
          <!-- è§¦å‘æ¡ä»¶ -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">è§¦å‘æ¡ä»¶ï¼ˆJSONï¼‰</label>
            <textarea 
              x-model="form.trigger_conditions"
              rows="3"
              placeholder='{"threshold": 10, "operator": "<=", "field": "remaining_budget"}'
              class="w-full px-4 py-2 border border-gray-200 rounded-lg font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            ></textarea>
            <p class="text-xs text-gray-500 mt-1">å®šä¹‰è§„åˆ™è§¦å‘çš„æ¡ä»¶ï¼Œä½¿ç”¨ JSON æ ¼å¼</p>
          </div>
          
          <!-- é€šçŸ¥æ¨¡æ¿ -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">é€šçŸ¥æ¨¡æ¿</label>
            <textarea 
              x-model="form.notification_template"
              rows="2"
              placeholder="é¢„ç®—ä½™é¢ä¸è¶³ï¼šå½“å‰ä½™é¢ {remaining_budget} å…ƒï¼Œè¯·åŠæ—¶å……å€¼"
              class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            ></textarea>
            <p class="text-xs text-gray-500 mt-1">æ”¯æŒä½¿ç”¨ {field_name} å ä½ç¬¦å¼•ç”¨æ•°æ®å­—æ®µ</p>
          </div>
        </div>
        
        <!-- å¼¹çª—åº•éƒ¨ -->
        <div class="sticky bottom-0 bg-gray-50 px-6 py-4 border-t flex items-center justify-end gap-3">
          <button 
            @click="closeModal()"
            class="px-4 py-2 border border-gray-200 rounded-lg text-gray-600 hover:bg-gray-100 transition"
          >å–æ¶ˆ</button>
          <button 
            @click="saveRule()"
            :disabled="saving"
            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition disabled:opacity-50"
          >
            <span x-show="!saving">ä¿å­˜</span>
            <span x-show="saving">ä¿å­˜ä¸­...</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- å¼•å…¥ Alpine.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  
  <script>
    // æé†’è§„åˆ™é…ç½®é¡µé¢ç»„ä»¶
    function reminderRulesPage() {
      return {
        loading: false,
        saving: false,
        showModal: false,
        editingRule: null,
        
        // è§„åˆ™åˆ—è¡¨
        rules: [],
        
        // ç»Ÿè®¡æ•°æ®
        stats: {
          total: 0,
          enabled: 0,
          disabled: 0,
          triggered_today: 0
        },
        
        // ç­›é€‰æ¡ä»¶
        filter: {
          rule_type: '',
          is_enabled: '',
          is_system: '',
          keyword: ''
        },
        
        // åˆ†é¡µ
        pagination: {
          page: 1,
          page_size: 20,
          total: 0
        },
        
        // è¡¨å•æ•°æ®
        form: {
          name: '',
          rule_type: '',
          description: '',
          priority: 50,
          check_interval: 60,
          trigger_conditions: '',
          notification_template: ''
        },
        
        async init() {
          console.log('[ReminderRules] åˆå§‹åŒ–æé†’è§„åˆ™é…ç½®é¡µé¢')
          await this.loadRules()
        },
        
        // åŠ è½½è§„åˆ™åˆ—è¡¨
        async loadRules() {
          this.loading = true
          try {
            const token = localStorage.getItem('admin_token')
            if (!token) {
              console.error('[ReminderRules] æœªç™»å½•')
              return
            }
            
            const params = new URLSearchParams({
              page: this.pagination.page,
              page_size: this.pagination.page_size
            })
            
            if (this.filter.rule_type) params.append('rule_type', this.filter.rule_type)
            if (this.filter.is_enabled) params.append('is_enabled', this.filter.is_enabled)
            if (this.filter.is_system) params.append('is_system', this.filter.is_system)
            
            const response = await fetch(`/api/v4/console/reminder-rules?${params}`, {
              headers: { 'Authorization': `Bearer ${token}` }
            })
            
            const result = await response.json()
            
            if (result.success) {
              this.rules = result.data.list || result.data.items || result.data || []
              this.pagination.total = result.data.total || this.rules.length
              
              // æ›´æ–°ç»Ÿè®¡
              this.updateStats()
              
              console.log('[ReminderRules] åŠ è½½è§„åˆ™æˆåŠŸ:', this.rules.length)
            } else {
              console.error('[ReminderRules] åŠ è½½è§„åˆ™å¤±è´¥:', result.message)
            }
          } catch (error) {
            console.error('[ReminderRules] åŠ è½½è§„åˆ™å¼‚å¸¸:', error)
          } finally {
            this.loading = false
          }
        },
        
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        updateStats() {
          this.stats.total = this.pagination.total
          this.stats.enabled = this.rules.filter(r => r.is_enabled).length
          this.stats.disabled = this.rules.filter(r => !r.is_enabled).length
        },
        
        // æ‰“å¼€æ–°å»ºå¼¹çª—
        openCreateModal() {
          this.editingRule = null
          this.form = {
            name: '',
            rule_type: '',
            description: '',
            priority: 50,
            check_interval: 60,
            trigger_conditions: '',
            notification_template: ''
          }
          this.showModal = true
        },
        
        // æ‰“å¼€ç¼–è¾‘å¼¹çª—
        openEditModal(rule) {
          if (rule.is_system) {
            alert('ç³»ç»Ÿè§„åˆ™ä¸å¯ç¼–è¾‘')
            return
          }
          
          this.editingRule = rule
          this.form = {
            name: rule.name || rule.rule_name || '',
            rule_type: rule.rule_type || '',
            description: rule.description || '',
            priority: rule.priority || 50,
            check_interval: rule.check_interval || 60,
            trigger_conditions: typeof rule.trigger_conditions === 'object' 
              ? JSON.stringify(rule.trigger_conditions, null, 2) 
              : rule.trigger_conditions || '',
            notification_template: rule.notification_template || ''
          }
          this.showModal = true
        },
        
        // å…³é—­å¼¹çª—
        closeModal() {
          this.showModal = false
          this.editingRule = null
        },
        
        // ä¿å­˜è§„åˆ™
        async saveRule() {
          if (!this.form.name || !this.form.rule_type) {
            alert('è¯·å¡«å†™è§„åˆ™åç§°å’Œç±»å‹')
            return
          }
          
          this.saving = true
          try {
            const token = localStorage.getItem('admin_token')
            
            // è§£æè§¦å‘æ¡ä»¶ JSON
            let trigger_conditions = null
            if (this.form.trigger_conditions) {
              try {
                trigger_conditions = JSON.parse(this.form.trigger_conditions)
              } catch (e) {
                alert('è§¦å‘æ¡ä»¶ JSON æ ¼å¼é”™è¯¯')
                this.saving = false
                return
              }
            }
            
            const data = {
              name: this.form.name,
              rule_type: this.form.rule_type,
              description: this.form.description,
              priority: this.form.priority,
              check_interval: this.form.check_interval,
              trigger_conditions: trigger_conditions,
              notification_template: this.form.notification_template
            }
            
            const url = this.editingRule 
              ? `/api/v4/console/reminder-rules/${this.editingRule.reminder_rule_id}`
              : '/api/v4/console/reminder-rules'
            
            const response = await fetch(url, {
              method: this.editingRule ? 'PUT' : 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(data)
            })
            
            const result = await response.json()
            
            if (result.success) {
              this.closeModal()
              await this.loadRules()
              console.log('[ReminderRules] ä¿å­˜è§„åˆ™æˆåŠŸ')
            } else {
              alert('ä¿å­˜å¤±è´¥: ' + result.message)
            }
          } catch (error) {
            console.error('[ReminderRules] ä¿å­˜è§„åˆ™å¼‚å¸¸:', error)
            alert('ä¿å­˜å¤±è´¥: ' + error.message)
          } finally {
            this.saving = false
          }
        },
        
        // åˆ‡æ¢è§„åˆ™çŠ¶æ€
        async toggleRule(rule) {
          try {
            const token = localStorage.getItem('admin_token')
            const newStatus = !rule.is_enabled
            
            const response = await fetch(`/api/v4/console/reminder-rules/${rule.reminder_rule_id}/toggle`, {
              method: 'PUT',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ is_enabled: newStatus })
            })
            
            const result = await response.json()
            
            if (result.success) {
              rule.is_enabled = newStatus
              this.updateStats()
              console.log('[ReminderRules] åˆ‡æ¢çŠ¶æ€æˆåŠŸ:', rule.reminder_rule_id, newStatus)
            } else {
              alert('æ“ä½œå¤±è´¥: ' + result.message)
              // æ¢å¤åŸçŠ¶æ€
              rule.is_enabled = !newStatus
            }
          } catch (error) {
            console.error('[ReminderRules] åˆ‡æ¢çŠ¶æ€å¼‚å¸¸:', error)
          }
        },
        
        // æµ‹è¯•è§„åˆ™
        async testRule(rule) {
          try {
            const token = localStorage.getItem('admin_token')
            
            const response = await fetch(`/api/v4/console/reminder-rules/${rule.reminder_rule_id}/test`, {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${token}` }
            })
            
            const result = await response.json()
            
            if (result.success) {
              const data = result.data
              const msg = data.would_trigger 
                ? `âœ… è§„åˆ™ä¼šè§¦å‘\nåŒ¹é…ç”¨æˆ·æ•°: ${data.matched_users}`
                : 'âŒ è§„åˆ™ä¸ä¼šè§¦å‘ï¼ˆæ¡ä»¶ä¸æ»¡è¶³ï¼‰'
              alert(msg)
            } else {
              alert('æµ‹è¯•å¤±è´¥: ' + result.message)
            }
          } catch (error) {
            console.error('[ReminderRules] æµ‹è¯•è§„åˆ™å¼‚å¸¸:', error)
            alert('æµ‹è¯•å¤±è´¥: ' + error.message)
          }
        },
        
        // æ‰§è¡Œè§„åˆ™
        async executeRule(rule) {
          if (!confirm(`ç¡®å®šè¦ç«‹å³æ‰§è¡Œè§„åˆ™"${rule.name || rule.rule_name}"å—ï¼Ÿè¿™å°†å®é™…å‘é€é€šçŸ¥ã€‚`)) {
            return
          }
          
          try {
            const token = localStorage.getItem('admin_token')
            
            const response = await fetch(`/api/v4/console/reminder-rules/${rule.reminder_rule_id}/execute`, {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${token}` }
            })
            
            const result = await response.json()
            
            if (result.success) {
              alert('è§„åˆ™æ‰§è¡Œå®Œæˆ')
            } else {
              alert('æ‰§è¡Œå¤±è´¥: ' + result.message)
            }
          } catch (error) {
            console.error('[ReminderRules] æ‰§è¡Œè§„åˆ™å¼‚å¸¸:', error)
            alert('æ‰§è¡Œå¤±è´¥: ' + error.message)
          }
        },
        
        // åˆ é™¤è§„åˆ™
        async deleteRule(rule) {
          if (rule.is_system) {
            alert('ç³»ç»Ÿè§„åˆ™ä¸å¯åˆ é™¤')
            return
          }
          
          if (!confirm(`ç¡®å®šè¦åˆ é™¤è§„åˆ™"${rule.name || rule.rule_name}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
            return
          }
          
          try {
            const token = localStorage.getItem('admin_token')
            
            const response = await fetch(`/api/v4/console/reminder-rules/${rule.reminder_rule_id}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${token}` }
            })
            
            const result = await response.json()
            
            if (result.success) {
              await this.loadRules()
              console.log('[ReminderRules] åˆ é™¤è§„åˆ™æˆåŠŸ')
            } else {
              alert('åˆ é™¤å¤±è´¥: ' + result.message)
            }
          } catch (error) {
            console.error('[ReminderRules] åˆ é™¤è§„åˆ™å¼‚å¸¸:', error)
            alert('åˆ é™¤å¤±è´¥: ' + error.message)
          }
        },
        
        // åˆ†é¡µ
        prevPage() {
          if (this.pagination.page > 1) {
            this.pagination.page--
            this.loadRules()
          }
        },
        
        nextPage() {
          const totalPages = Math.ceil(this.pagination.total / this.pagination.page_size)
          if (this.pagination.page < totalPages) {
            this.pagination.page++
            this.loadRules()
          }
        },
        
        // å·¥å…·æ–¹æ³•
        formatDate(dateStr) {
          if (!dateStr) return '-'
          const date = new Date(dateStr)
          return date.toLocaleString('zh-CN', { 
            timeZone: 'Asia/Shanghai',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
          })
        },
        
        formatInterval(minutes) {
          if (!minutes) return '-'
          if (minutes < 60) return `${minutes} åˆ†é’Ÿ`
          if (minutes < 1440) return `${Math.floor(minutes / 60)} å°æ—¶`
          return `${Math.floor(minutes / 1440)} å¤©`
        },
        
        getRuleTypeName(type) {
          const types = {
            budget: 'é¢„ç®—æé†’',
            inventory: 'åº“å­˜æé†’',
            performance: 'æ€§èƒ½æé†’',
            security: 'å®‰å…¨æé†’',
            business: 'ä¸šåŠ¡æé†’',
            system: 'ç³»ç»Ÿæé†’'
          }
          return types[type] || type || 'æœªçŸ¥'
        },
        
        getRuleTypeClass(type) {
          const classes = {
            budget: 'bg-green-100 text-green-700',
            inventory: 'bg-yellow-100 text-yellow-700',
            performance: 'bg-blue-100 text-blue-700',
            security: 'bg-red-100 text-red-700',
            business: 'bg-purple-100 text-purple-700',
            system: 'bg-gray-100 text-gray-700'
          }
          return classes[type] || 'bg-gray-100 text-gray-700'
        },
        
        getPriorityName(priority) {
          if (priority >= 70) return 'é«˜'
          if (priority >= 40) return 'ä¸­'
          return 'ä½'
        },
        
        getPriorityClass(priority) {
          if (priority >= 70) return 'priority-high'
          if (priority >= 40) return 'priority-medium'
          return 'priority-low'
        }
      }
    }
  </script>
</body>
</html>

