<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: 'æé†’è§„åˆ™é…ç½®', 
    pageStyle: '[x-cloak] { display: none !important; } .rule-card { transition: all 0.2s ease; } .rule-card:hover { background-color: #f8fafc; }' 
  }) %>
</head>
<body class="themed-bg-base min-h-screen">
  <style>
    /* åˆ‡æ¢å¼€å…³æ ·å¼ */
    .toggle-switch { position: relative; width: 44px; height: 24px; display: inline-block; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { 
      position: absolute; cursor: pointer; 
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #cbd5e1; border-radius: 24px;
      transition: 0.3s;
    }
    .toggle-slider:before {
      position: absolute; content: "";
      height: 18px; width: 18px;
      left: 3px; bottom: 3px;
      background-color: white; border-radius: 50%;
      transition: 0.3s;
    }
    input:checked + .toggle-slider { background-color: #3b82f6; }
    input:checked + .toggle-slider:before { transform: translateX(20px); }
    input:disabled + .toggle-slider { opacity: 0.5; cursor: not-allowed; }
  </style>
  <div x-data="reminderRulesPage()" x-init="init()" x-cloak class="p-6" @table-action="handleTableAction($event.detail)">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold text-gray-800">ğŸ”” æé†’è§„åˆ™é…ç½®</h1>
        <p class="text-sm text-gray-500 mt-1">
          ç®¡ç†ç³»ç»Ÿè‡ªåŠ¨æé†’è§„åˆ™ Â· å…± <span x-text="pagination.total">0</span> æ¡è§„åˆ™
        </p>
      </div>
      
      <div class="flex items-center gap-3">
        <!-- æ–°å»ºè§„åˆ™æŒ‰é’® -->
        <button 
          @click="openCreateModal()"
          class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition"
        >
          <span>â•</span>
          æ–°å»ºè§„åˆ™
        </button>
        
        <!-- åˆ·æ–°æŒ‰é’® -->
        <button 
          @click="loadRules()"
          :disabled="loading"
          class="flex items-center gap-2 px-4 py-2 border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-gray-50 transition"
        >
          <span :class="loading && 'animate-spin'">ğŸ”„</span>
          åˆ·æ–°
        </button>
      </div>
    </div>
    
    <!-- ç­›é€‰æ  -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
      <div class="flex flex-wrap items-center gap-4">
        <!-- ç±»å‹ç­›é€‰ -->
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-500">ç±»å‹:</span>
          <select 
            x-model="filter.rule_type"
            class="px-3 py-1.5 bg-gray-100 border-0 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
          >
            <option value="">å…¨éƒ¨ç±»å‹</option>
            <option value="budget">é¢„ç®—æé†’</option>
            <option value="inventory">åº“å­˜æé†’</option>
            <option value="performance">æ€§èƒ½æé†’</option>
            <option value="security">å®‰å…¨æé†’</option>
            <option value="business">ä¸šåŠ¡æé†’</option>
            <option value="system">ç³»ç»Ÿæé†’</option>
          </select>
        </div>
        
        <!-- çŠ¶æ€ç­›é€‰ -->
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-500">çŠ¶æ€:</span>
          <select 
            x-model="filter.is_enabled"
            class="px-3 py-1.5 bg-gray-100 border-0 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
          >
            <option value="">å…¨éƒ¨çŠ¶æ€</option>
            <option value="true">å·²å¯ç”¨</option>
            <option value="false">å·²ç¦ç”¨</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">è§„åˆ™æ€»æ•°</p>
            <p class="text-2xl font-bold text-gray-800" x-text="stats.total">0</p>
          </div>
          <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-2xl">ğŸ“‹</div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">å·²å¯ç”¨</p>
            <p class="text-2xl font-bold text-green-600" x-text="stats.enabled">0</p>
          </div>
          <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center text-2xl">âœ…</div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">å·²ç¦ç”¨</p>
            <p class="text-2xl font-bold text-gray-500" x-text="stats.disabled">0</p>
          </div>
          <div class="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center text-2xl">â¸ï¸</div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">ä»Šæ—¥è§¦å‘</p>
            <p class="text-2xl font-bold text-orange-600">0</p>
          </div>
          <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center text-2xl">ğŸ””</div>
        </div>
      </div>
    </div>
    
    <!-- data-table æ ‡å‡†è¡¨æ ¼ç»„ä»¶ -->
    <div x-data="dataTable({
      columns: tableColumns,
      dataSource: fetchTableData,
      primaryKey: 'reminder_rule_id',
      sortable: true,
      selectable: false,
      exportable: false,
      serverSort: true,
      page_size: 20,
      emptyText: 'æš‚æ— æé†’è§„åˆ™'
    })" x-init="init()"
       @dt-refresh.window="refresh()"
       @dt-search.window="handleFilterSearch($event.detail.filters)">
      <%- include('components/data-table') %>
    </div>
    
    <!-- è§„åˆ™ç¼–è¾‘å¼¹çª— -->
    <div 
      x-show="showModal"
      x-cloak
      class="fixed inset-0 z-50 flex items-center justify-center"
      style="display: none;"
    >
      <div class="fixed inset-0 bg-black/50" @click="closeModal()"></div>
      <div class="relative bg-white rounded-xl shadow-xl w-full max-w-2xl mx-4 z-10 max-h-[90vh] overflow-y-auto">
        <!-- å¼¹çª—å¤´éƒ¨ -->
        <div class="sticky top-0 bg-white px-6 py-4 border-b flex items-center justify-between z-10">
          <h3 class="text-lg font-semibold text-gray-800" x-text="editMode ? 'ç¼–è¾‘è§„åˆ™' : 'æ–°å»ºè§„åˆ™'"></h3>
          <button @click="closeModal()" class="text-gray-400 hover:text-gray-600 text-xl">âœ•</button>
        </div>
        
        <!-- å¼¹çª—å†…å®¹ -->
        <div class="p-6 space-y-4">
          <!-- è§„åˆ™åç§° -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">è§„åˆ™åç§° <span class="text-red-500">*</span></label>
            <input 
              type="text"
              x-model="form.rule_name"
              placeholder="å¦‚ï¼šé¢„ç®—ä½™é¢ä¸è¶³æé†’"
              class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
          
          <!-- è§„åˆ™ç±»å‹ -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">è§„åˆ™ç±»å‹ <span class="text-red-500">*</span></label>
            <select 
              x-model="form.rule_type"
              class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">è¯·é€‰æ‹©ç±»å‹</option>
              <template x-for="type in ruleTypes" :key="type.value">
                <option :value="type.value" x-text="type.label"></option>
              </template>
            </select>
          </div>
          
          <!-- è§„åˆ™æè¿° -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">è§„åˆ™æè¿°</label>
            <textarea 
              x-model="form.description"
              rows="2"
              placeholder="æè¿°è§„åˆ™çš„ç”¨é€”å’Œè§¦å‘æ¡ä»¶"
              class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            ></textarea>
          </div>
          
          <!-- ä¼˜å…ˆçº§å’Œæ£€æŸ¥é—´éš” -->
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ä¼˜å…ˆçº§</label>
              <select 
                x-model="form.priority"
                class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="80">é«˜ä¼˜å…ˆçº§</option>
                <option value="50">ä¸­ä¼˜å…ˆçº§</option>
                <option value="20">ä½ä¼˜å…ˆçº§</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">æ£€æŸ¥é—´éš”ï¼ˆåˆ†é’Ÿï¼‰</label>
              <input 
                type="number"
                x-model.number="form.check_interval"
                min="1"
                max="1440"
                class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
          </div>
          
          <!-- å¯ç”¨çŠ¶æ€ -->
          <div class="flex items-center gap-2">
            <label class="toggle-switch">
              <input type="checkbox" x-model="form.is_enabled">
              <span class="toggle-slider"></span>
            </label>
            <span class="text-sm text-gray-600">å¯ç”¨è§„åˆ™</span>
          </div>
        </div>
        
        <!-- å¼¹çª—åº•éƒ¨ -->
        <div class="sticky bottom-0 bg-gray-50 px-6 py-4 border-t flex items-center justify-end gap-3">
          <button 
            @click="closeModal()"
            class="px-4 py-2 border border-gray-200 rounded-lg text-gray-600 hover:bg-gray-100 transition"
          >å–æ¶ˆ</button>
          <button 
            @click="saveRule()"
            :disabled="saving"
            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition disabled:opacity-50"
          >
            <span x-show="!saving">ä¿å­˜</span>
            <span x-show="saving">ä¿å­˜ä¸­...</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- é¡µé¢æ¨¡å—å¼•å…¥ -->
  <script type="module" src="./src/pages/reminder-rules.js"></script>
</body>
</html>
