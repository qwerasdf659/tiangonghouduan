<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '财务管理中心', 
    pageStyle: '[x-cloak] { display: none !important; }' 
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen">
  
  <!-- 导航栏 -->
  <nav class="bg-gray-800 text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="hover:text-gray-300">← 返回工作台</a>
        <span class="text-lg font-semibold">💰 财务管理中心</span>
      </div>
    </div>
  </nav>

  <!-- 页面主体 -->
  <div class="container mx-auto px-4 py-6" x-data="financeNavigation()" x-init="init()">
    
    <!-- 子页面导航 -->
    <div class="themed-card rounded-lg shadow mb-6">
      <div class="flex border-b overflow-x-auto">
        <template x-for="page in subPages" :key="page.id">
          <button 
            @click="switchPage(page.id)"
            :class="current_page === page.id ? 'border-b-2 border-gray-800 themed-text themed-bg-base' : 'themed-text-muted themed-hover-bg'"
            class="px-6 py-3 font-medium whitespace-nowrap transition-colors"
          >
            <i :class="page.icon" class="mr-1"></i>
            <span x-text="page.title"></span>
          </button>
        </template>
      </div>
    </div>

    <!-- 页面内容区域 -->
    <div x-data="financePageContent()" x-init="init()">

    <!-- 消费记录审核 -->
    <div x-show="current_page === 'consumption'" x-cloak x-init="loadAnomalyStats()">
      
      <!-- F-43: 异常统计面板 -->
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
        <div class="themed-card rounded-lg shadow p-4 text-center border-l-4 border-red-500">
          <h6 class="themed-text-muted text-sm mb-1">异常总数</h6>
          <p class="text-2xl font-bold text-red-600" x-text="anomalyStats.total_anomaly || 0"></p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center border-l-4 border-orange-500">
          <h6 class="themed-text-muted text-sm mb-1">高频消费</h6>
          <p class="text-2xl font-bold text-orange-600" x-text="anomalyStats.high_frequency || 0"></p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center border-l-4 border-yellow-500">
          <h6 class="themed-text-muted text-sm mb-1">大额异常</h6>
          <p class="text-2xl font-bold text-yellow-600" x-text="anomalyStats.high_amount || 0"></p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center border-l-4 border-purple-500">
          <h6 class="themed-text-muted text-sm mb-1">异常时段</h6>
          <p class="text-2xl font-bold text-purple-600" x-text="anomalyStats.unusual_time || 0"></p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center border-l-4 border-gray-500">
          <h6 class="themed-text-muted text-sm mb-1">其他异常</h6>
          <p class="text-2xl font-bold text-gray-600" x-text="anomalyStats.other || 0"></p>
        </div>
      </div>

      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold">消费记录审核</h5>
          <!-- 批量操作工具栏 -->
          <div x-show="selectedIds.length > 0" class="flex items-center gap-3">
            <span class="text-sm text-gray-600">已选择 <strong x-text="selectedIds.length"></strong> 项</span>
            <button 
              @click="batchApprove()" 
              :disabled="batchProcessing"
              class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed text-sm"
            >
              <span x-show="!batchProcessing">✅ 批量通过</span>
              <span x-show="batchProcessing">处理中...</span>
            </button>
            <button 
              @click="batchReject()" 
              :disabled="batchProcessing"
              class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed text-sm"
            >
              <span x-show="!batchProcessing">❌ 批量拒绝</span>
              <span x-show="batchProcessing">处理中...</span>
            </button>
            <button @click="clearSelection()" class="text-gray-500 hover:text-gray-700 text-sm">取消选择</button>
          </div>
        </div>
        <div class="p-4 border-b themed-bg-base">
          <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <input type="text" x-model="consumptionFilters.user_id" placeholder="用户ID" class="px-3 py-2 border rounded">
            <select x-model="consumptionFilters.status" class="px-3 py-2 border rounded">
              <option value="">全部状态</option>
              <option value="pending">待审核</option>
              <option value="approved">已通过</option>
              <option value="rejected">已拒绝</option>
            </select>
            <!-- F-41: 异常类型筛选 -->
            <select x-model="consumptionFilters.anomaly_type" class="px-3 py-2 border rounded">
              <option value="">全部风控标记</option>
              <option value="high_frequency">🔄 高频消费</option>
              <option value="high_amount">💰 大额异常</option>
              <option value="unusual_time">🌙 异常时段</option>
              <option value="location_mismatch">📍 位置异常</option>
              <option value="device_change">📱 设备变更</option>
              <option value="rapid_succession">⚡ 短时多次</option>
              <option value="first_time_high">🆕 首次大额</option>
              <option value="pattern_break">📊 行为异常</option>
            </select>
            <div class="flex items-center gap-1">
              <input type="date" x-model="consumptionFilters.start_date" placeholder="开始日期" class="px-2 py-2 border rounded w-36" title="开始日期">
              <span class="text-gray-400">~</span>
              <input type="date" x-model="consumptionFilters.end_date" placeholder="结束日期" class="px-2 py-2 border rounded w-36" title="结束日期">
            </div>
            <button @click="loadConsumptions()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">🔍 搜索</button>
            <button @click="resetConsumptionFilters()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">🔄 重置</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="themed-bg-base">
              <tr>
                <!-- 全选复选框 -->
                <th class="px-4 py-3 text-center w-12">
                  <input 
                    type="checkbox" 
                    :checked="isAllSelected"
                    @change="toggleSelectAll()"
                    class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    title="全选/取消全选待审核记录"
                  >
                </th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">记录ID</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">用户</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">门店</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">金额</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">风控标记</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">状态</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">提交时间</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <template x-for="record in consumptions" :key="record.id || record.record_id">
                <tr class="themed-hover-bg" :class="{ 'bg-blue-50': isSelected(record) }">
                  <!-- 单选复选框（仅待审核记录可选） -->
                  <td class="px-4 py-3 text-center">
                    <template x-if="record.status === 'pending'">
                      <input 
                        type="checkbox" 
                        :checked="isSelected(record)"
                        @change="toggleSelection(record.record_id || record.id)"
                        class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                      >
                    </template>
                    <template x-if="record.status !== 'pending'">
                      <span class="text-gray-300">-</span>
                    </template>
                  </td>
                  <td class="px-4 py-3 text-sm" x-text="record.record_id"></td>
                  <td class="px-4 py-3 text-sm" x-text="record.user_name || record.user_id"></td>
                  <td class="px-4 py-3 text-sm" x-text="record.store_name"></td>
                  <td class="px-4 py-3 text-sm font-mono" x-text="'¥' + (record.amount / 100).toFixed(2)"></td>
                  <!-- 风控标记列 (P1-4) + F-42: 异常详情提示 -->
                  <td class="px-4 py-3">
                    <template x-if="record.is_suspicious || record.risk_level === 'high'">
                      <!-- F-42: 添加 title 属性显示详细异常信息 -->
                      <div class="flex flex-col gap-1 cursor-help" :title="getAnomalyTooltip(record)">
                        <span class="inline-flex items-center px-2 py-0.5 text-xs rounded bg-red-100 text-red-700">
                          ⚠️ 异常
                        </span>
                        <template x-if="record.risk_reasons && record.risk_reasons.length > 0">
                          <span class="text-xs text-red-500" x-text="record.risk_reasons[0]"></span>
                        </template>
                        <template x-if="record.anomaly_type">
                          <span class="text-xs text-red-500" x-text="getAnomalyLabel(record.anomaly_type)"></span>
                        </template>
                      </div>
                    </template>
                    <template x-if="record.risk_level === 'medium'">
                      <span class="inline-flex items-center px-2 py-0.5 text-xs rounded bg-yellow-100 text-yellow-700 cursor-help"
                            :title="getAnomalyTooltip(record)">
                        ⚡ 关注
                      </span>
                    </template>
                    <template x-if="!record.is_suspicious && !record.risk_level">
                      <span class="text-gray-400 text-xs">正常</span>
                    </template>
                  </td>
                  <td class="px-4 py-3">
                    <span 
                      :class="{
                        'bg-yellow-100 text-yellow-700': record.status === 'pending',
                        'bg-green-100 themed-text-success': record.status === 'approved',
                        'bg-red-100 text-red-700': record.status === 'rejected'
                      }"
                      class="px-2 py-1 text-xs rounded"
                      x-text="record.status === 'pending' ? '待审核' : record.status === 'approved' ? '已通过' : '已拒绝'"
                    ></span>
                  </td>
                  <td class="px-4 py-3 text-sm themed-text-muted" x-text="formatDateOnly(record.created_at)"></td>
                  <td class="px-4 py-3">
                    <template x-if="record.status === 'pending'">
                      <div class="flex space-x-2">
                        <button @click="approveConsumption(record)" class="text-green-500 hover:text-green-700 text-sm">通过</button>
                        <button @click="rejectConsumption(record)" class="text-red-500 hover:text-red-700 text-sm">拒绝</button>
                      </div>
                    </template>
                    <template x-if="record.status !== 'pending'">
                      <span class="text-gray-400 text-sm">-</span>
                    </template>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
          <!-- 空数据提示 -->
          <div x-show="consumptions.length === 0" class="text-center py-8 themed-text-muted">
            <div class="text-4xl mb-2">📋</div>
            <p>暂无消费记录</p>
          </div>
        </div>
        <!-- 分页 -->
        <div class="p-4 border-t themed-bg-base flex justify-between items-center" x-show="consumptions.length > 0">
          <div class="flex items-center gap-4">
            <span class="text-sm themed-text-muted">
              共 <strong x-text="financePagination.total || 0"></strong> 条记录，
              当前显示第 <strong x-text="((financePagination.page - 1) * financePagination.page_size) + 1"></strong> - 
              <strong x-text="Math.min(financePagination.page * financePagination.page_size, financePagination.total || 0)"></strong> 条
            </span>
            <select x-model="financePagination.page_size" @change="loadConsumptions()" class="px-2 py-1 border rounded text-sm">
              <option value="20">20条/页</option>
              <option value="50">50条/页</option>
              <option value="100">100条/页</option>
            </select>
          </div>
          <div class="flex items-center gap-2">
            <button @click="financePagination.page = 1; loadConsumptions()" :disabled="financePagination.page <= 1" class="px-3 py-1 border rounded text-sm themed-hover-bg disabled:opacity-50">首页</button>
            <button @click="financePagination.page--; loadConsumptions()" :disabled="financePagination.page <= 1" class="px-3 py-1 border rounded text-sm themed-hover-bg disabled:opacity-50">上一页</button>
            <span class="px-3 py-1 text-sm">第 <span x-text="financePagination.page"></span> / <span x-text="Math.ceil((financePagination.total || 0) / financePagination.page_size) || 1"></span> 页</span>
            <button @click="financePagination.page++; loadConsumptions()" :disabled="financePagination.page >= Math.ceil((financePagination.total || 0) / financePagination.page_size)" class="px-3 py-1 border rounded text-sm themed-hover-bg disabled:opacity-50">下一页</button>
            <button @click="financePagination.page = Math.ceil((financePagination.total || 0) / financePagination.page_size); loadConsumptions()" :disabled="financePagination.page >= Math.ceil((financePagination.total || 0) / financePagination.page_size)" class="px-3 py-1 border rounded text-sm themed-hover-bg disabled:opacity-50">末页</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 钻石账户 -->
    <div x-show="current_page === 'diamond-accounts'" x-cloak>
      <!-- 统计卡片 -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <h6 class="themed-text-muted text-sm mb-1">持有用户数</h6>
          <p class="text-2xl font-bold themed-text-primary" x-text="diamondStats.holderCount || 0"></p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <h6 class="themed-text-muted text-sm mb-1">流通总量</h6>
          <p class="text-2xl font-bold text-green-600" x-text="formatNumber(diamondStats.totalCirculation || 0)"></p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <h6 class="themed-text-muted text-sm mb-1">冻结总量</h6>
          <p class="text-2xl font-bold text-yellow-600" x-text="formatNumber(diamondStats.totalFrozen || 0)"></p>
        </div>
      </div>

      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold">💎 钻石账户查询</h5>
          <button @click="openDiamondAdjustModal({})" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary text-sm">
            ➕ 调整用户钻石
          </button>
        </div>
        <!-- 搜索区域 -->
        <div class="p-4 border-b themed-bg-base">
          <div class="flex items-center gap-4">
            <div class="flex-1 max-w-md">
              <label class="block text-sm font-medium themed-text-secondary mb-1">用户ID</label>
              <div class="flex gap-2">
                <input 
                  type="number" 
                  x-model="diamondFilters.user_id" 
                  placeholder="请输入用户ID"
                  @keyup.enter="searchDiamondAccounts()"
                  class="flex-1 px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                >
                <button 
                  @click="searchDiamondAccounts()" 
                  class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary"
                >
                  🔍 查询
                </button>
                <button 
                  @click="clearDiamondSearch()" 
                  class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300"
                  x-show="diamondFilters.user_id"
                >
                  清空
                </button>
              </div>
            </div>
          </div>
          <p class="text-sm themed-text-muted mt-2">
            💡 后端API需要指定用户ID查询，请输入用户ID后点击查询
          </p>
        </div>

        <!-- 搜索结果 -->
        <div class="p-4">
          <!-- 未搜索提示 -->
          <div x-show="!diamondSearched && !diamondFilters.user_id" class="text-center py-8 themed-text-muted">
            <div class="text-4xl mb-2">💎</div>
            <p x-text="diamondSearchTip"></p>
          </div>

          <!-- 搜索中/搜索结果 -->
          <div x-show="diamondSearched || diamondFilters.user_id">
            <!-- 无结果 -->
            <template x-if="diamondAccounts.length === 0 && diamondSearched">
              <div class="text-center py-8 themed-text-muted">
                <div class="text-4xl mb-2">🔍</div>
                <p x-text="diamondSearchTip || '未找到该用户的钻石账户信息'"></p>
              </div>
            </template>

            <!-- 结果列表 -->
            <template x-if="diamondAccounts.length > 0">
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="themed-bg-base">
                    <tr>
                      <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">用户ID</th>
                      <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">昵称</th>
                      <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">手机号</th>
                      <th class="px-4 py-3 text-right text-sm font-medium themed-text-muted">可用余额</th>
                      <th class="px-4 py-3 text-right text-sm font-medium themed-text-muted">冻结余额</th>
                      <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">状态</th>
                      <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y">
                    <template x-for="account in diamondAccounts" :key="account.user_id">
                      <tr class="themed-hover-bg">
                        <td class="px-4 py-3 text-sm font-mono" x-text="account.user_id"></td>
                        <td class="px-4 py-3 text-sm" x-text="account.nickname || '-'"></td>
                        <td class="px-4 py-3 text-sm themed-text-muted" x-text="account.mobile || '-'"></td>
                        <td class="px-4 py-3 text-sm font-mono text-right themed-text-primary" x-text="formatNumber(account.balance || 0)"></td>
                        <td class="px-4 py-3 text-sm font-mono text-right text-yellow-600" x-text="formatNumber(account.frozen || 0)"></td>
                        <td class="px-4 py-3">
                          <span 
                            :class="account.has_diamond ? 'bg-green-100 themed-text-success' : 'themed-bg-subtle themed-text-muted'"
                            class="px-2 py-1 text-xs rounded"
                            x-text="account.has_diamond ? '已开通' : '未开通'"
                          ></span>
                        </td>
                        <td class="px-4 py-3">
                          <div class="flex space-x-2">
                            <button @click="viewDiamondDetail(account)" class="themed-text-primary hover:text-blue-700 text-sm">查看流水</button>
                            <button @click="openDiamondAdjustModal(account)" class="text-green-500 hover:text-green-700 text-sm">调整</button>
                          </div>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>

    <!-- 商户积分 - 适配后端 merchant-points API -->
    <div x-show="current_page === 'merchant-points'" x-cloak>
      <!-- 统计卡片 - 与后端 /api/v4/console/merchant-points/stats/pending 返回字段一致 -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <h6 class="themed-text-muted text-sm mb-1">待审核</h6>
          <p class="text-2xl font-bold text-yellow-600" x-text="merchantStats?.pending_count || 0"></p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <h6 class="themed-text-muted text-sm mb-1">已通过</h6>
          <p class="text-2xl font-bold text-green-600" x-text="merchantStats?.approved_count || 0"></p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <h6 class="themed-text-muted text-sm mb-1">已拒绝</h6>
          <p class="text-2xl font-bold text-red-600" x-text="merchantStats?.rejected_count || 0"></p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <h6 class="themed-text-muted text-sm mb-1">今日发放积分</h6>
          <p class="text-2xl font-bold themed-text-primary" x-text="formatNumber(merchantStats?.today_points || 0)"></p>
        </div>
      </div>

      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">🪙 商户积分申请列表</h5>
        </div>
        <!-- 筛选区域 - user_id 对应后端 API 参数 -->
        <div class="p-4 border-b themed-bg-base">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <input type="text" x-model="merchantFilters.user_id" placeholder="用户ID" class="px-3 py-2 border rounded">
            <input type="text" x-model="merchantFilters.keyword" placeholder="关键词搜索" class="px-3 py-2 border rounded">
            <button @click="searchMerchants()" class="px-4 py-2 themed-btn-primary rounded">🔍 搜索</button>
            <button @click="merchantFilters = { user_id: '', keyword: '' }; loadMerchantPoints()" class="px-4 py-2 bg-gray-300 themed-text-secondary rounded hover:bg-gray-400">重置</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="themed-bg-base">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">申请ID</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">申请人</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">积分金额</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">申请描述</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">状态</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">申请时间</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <!-- 后端返回 audit_id 作为唯一标识（content_review_record_id）-->
              <template x-for="item in merchantPoints" :key="item.audit_id">
                <tr class="themed-hover-bg">
                  <td class="px-4 py-3 text-sm font-mono" x-text="item.audit_id"></td>
                  <td class="px-4 py-3 text-sm">
                    <div x-text="item.applicant?.nickname || '-'"></div>
                    <div class="text-xs themed-text-muted" x-text="item.applicant?.mobile || ''"></div>
                  </td>
                  <td class="px-4 py-3 text-sm font-mono text-orange-600" x-text="item.points_amount || 0"></td>
                  <td class="px-4 py-3 text-sm themed-text-muted max-w-48 truncate" x-text="item.description || '-'" :title="item.description"></td>
                  <td class="px-4 py-3">
                    <span 
                      :class="{
                        'bg-yellow-100 text-yellow-700': item.status === 'pending',
                        'bg-green-100 themed-text-success': item.status === 'approved',
                        'bg-red-100 text-red-700': item.status === 'rejected'
                      }"
                      class="px-2 py-1 text-xs rounded"
                      x-text="item.status === 'pending' ? '待审核' : item.status === 'approved' ? '已通过' : '已拒绝'"
                    ></span>
                  </td>
                  <td class="px-4 py-3 text-sm themed-text-muted" x-text="item.submitted_at || item.created_at"></td>
                  <td class="px-4 py-3">
                    <div class="flex space-x-2">
                      <button @click="viewMerchantDetail(item)" class="themed-text-primary hover:text-blue-700 text-sm">详情</button>
                      <template x-if="item.status === 'pending'">
                        <div class="flex space-x-2">
                          <button @click="approveMerchantPoints(item)" class="text-green-500 hover:text-green-700 text-sm">通过</button>
                          <button @click="rejectMerchantPoints(item)" class="text-red-500 hover:text-red-700 text-sm">拒绝</button>
                        </div>
                      </template>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
          <!-- 空数据提示 -->
          <div x-show="merchantPoints.length === 0" class="text-center py-8 themed-text-muted">
            <div class="text-4xl mb-2">🪙</div>
            <p>暂无商户积分申请记录</p>
          </div>
        </div>
        <!-- 分页 -->
        <div class="p-4 border-t themed-bg-base flex justify-between items-center" x-show="merchantPoints.length > 0">
          <span class="text-sm themed-text-muted">共 <span x-text="financePagination.total"></span> 条记录</span>
          <div class="flex space-x-1">
            <button @click="changePage(financePagination.page - 1)" :disabled="financePagination.page <= 1" class="px-3 py-1 border rounded text-sm themed-hover-bg disabled:opacity-50">上一页</button>
            <span class="px-3 py-1 text-sm">第 <span x-text="financePagination.page"></span> / <span x-text="financeTotalPages"></span> 页</span>
            <button @click="changePage(financePagination.page + 1)" :disabled="financePagination.page >= financeTotalPages" class="px-3 py-1 border rounded text-sm themed-hover-bg disabled:opacity-50">下一页</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 欠账管理 - 适配后端 debt-management API -->
    <div x-show="current_page === 'debt-management'" x-cloak>
      <!-- 统计卡片 -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <h6 class="themed-text-muted text-sm mb-1">库存欠账数</h6>
          <p class="text-2xl font-bold text-red-600" x-text="debtStats?.total_inventory_debt || 0"></p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <h6 class="themed-text-muted text-sm mb-1">预算欠账额</h6>
          <p class="text-2xl font-bold text-orange-600" x-text="formatAmount(debtStats?.total_budget_debt || 0)"></p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <h6 class="themed-text-muted text-sm mb-1">待处理</h6>
          <p class="text-2xl font-bold text-yellow-600" x-text="debtStats?.pending_count || 0"></p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <h6 class="themed-text-muted text-sm mb-1">今日清偿</h6>
          <p class="text-2xl font-bold text-green-600" x-text="debtStats?.cleared_today || 0"></p>
        </div>
      </div>

      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">📋 待冲销欠账列表</h5>
        </div>
        <!-- 筛选区域 -->
        <div class="p-4 border-b themed-bg-base">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <select x-model="debtFilters.debt_type" class="px-3 py-2 border rounded">
              <option value="">全部类型</option>
              <option value="inventory">库存欠账</option>
              <option value="budget">预算欠账</option>
            </select>
            <!-- 活动下拉选择框（替代原输入框，运营人员更易使用） -->
            <select x-model="debtFilters.campaign_id" class="px-3 py-2 border rounded">
              <option value="">全部活动</option>
              <template x-for="campaign in campaignOptions" :key="campaign.value">
                <option :value="campaign.value" x-text="campaign.label"></option>
              </template>
            </select>
            <button @click="searchDebts()" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary">🔍 搜索</button>
            <button @click="resetDebtFilters()" class="px-4 py-2 bg-gray-300 themed-text-secondary rounded hover:bg-gray-400">重置</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="themed-bg-base">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">欠账ID</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">类型</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">活动/奖品</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">欠账数量/金额</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">创建时间</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <template x-for="debt in debts" :key="debt.debt_id || debt.id">
                <tr class="themed-hover-bg">
                  <td class="px-4 py-3 text-sm font-mono" x-text="debt.debt_id || debt.id"></td>
                  <td class="px-4 py-3">
                    <span 
                      :class="debt.debt_type === 'inventory' ? 'themed-bg-primary-light themed-text-primary' : 'bg-orange-100 text-orange-700'"
                      class="px-2 py-1 text-xs rounded"
                      x-text="debt.debt_type === 'inventory' ? '库存' : '预算'"
                    ></span>
                  </td>
                  <td class="px-4 py-3 text-sm">
                    <div x-text="debt.campaign_name || debt.prize_name || '-'"></div>
                    <div class="text-gray-400 text-xs" x-text="'ID: ' + (debt.campaign_id || debt.prize_id || '-')"></div>
                  </td>
                  <td class="px-4 py-3 text-sm font-mono text-red-600" x-text="debt.owed_quantity || debt.owed_amount || 0"></td>
                  <td class="px-4 py-3 text-sm themed-text-muted" x-text="formatDateTimeShort(debt.created_at)"></td>
                  <td class="px-4 py-3">
                    <div class="flex space-x-2">
                      <button @click="viewDebtDetail(debt)" class="themed-text-primary hover:text-blue-700 text-sm">详情</button>
                      <button @click="openRepayModal(debt)" class="text-green-500 hover:text-green-700 text-sm">清偿</button>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
          <!-- 空数据提示 -->
          <div x-show="debts.length === 0" class="text-center py-8 themed-text-muted">
            <div class="text-4xl mb-2">📋</div>
            <p>暂无待冲销欠账记录</p>
          </div>
        </div>
        <!-- 分页 -->
        <div class="p-4 border-t themed-bg-base flex justify-between items-center" x-show="debts.length > 0">
          <span class="text-sm themed-text-muted">共 <span x-text="financePagination.total"></span> 条记录</span>
          <div class="flex space-x-1">
            <button @click="changePage(financePagination.page - 1)" :disabled="financePagination.page <= 1" class="px-3 py-1 border rounded text-sm themed-hover-bg disabled:opacity-50">上一页</button>
            <span class="px-3 py-1 text-sm">第 <span x-text="financePagination.page"></span> / <span x-text="financeTotalPages"></span> 页</span>
            <button @click="changePage(financePagination.page + 1)" :disabled="financePagination.page >= financeTotalPages" class="px-3 py-1 border rounded text-sm themed-hover-bg disabled:opacity-50">下一页</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 活动预算管理 -->
    <div x-show="current_page === 'campaign-budget'" x-cloak>
      <!-- 预算统计卡片 -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <h6 class="themed-text-muted text-sm mb-1">总预算</h6>
          <p class="text-2xl font-bold themed-text-primary" x-text="budgetStats?.totalBudget || 0"></p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <h6 class="themed-text-muted text-sm mb-1">已使用</h6>
          <p class="text-2xl font-bold text-orange-600" x-text="budgetStats?.usedBudget || 0"></p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <h6 class="themed-text-muted text-sm mb-1">剩余预算</h6>
          <p class="text-2xl font-bold text-green-600" x-text="budgetStats?.remainingBudget || 0"></p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <h6 class="themed-text-muted text-sm mb-1">使用率</h6>
          <p class="text-2xl font-bold" :class="(budgetStats?.utilizationRate || 0) > 80 ? 'text-red-600' : 'text-green-600'" x-text="(budgetStats?.utilizationRate || 0) + '%'"></p>
        </div>
      </div>

      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">📊 活动预算列表</h5>
        </div>
        <!-- 筛选区域 -->
        <div class="p-4 border-b themed-bg-base">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <input type="text" x-model="budgetFilters.lottery_campaign_id" placeholder="活动ID" class="px-3 py-2 border rounded">
            <input type="text" x-model="budgetFilters.keyword" placeholder="活动名称关键词" class="px-3 py-2 border rounded">
            <select x-model="budgetFilters.status" class="px-3 py-2 border rounded">
              <option value="">全部状态</option>
              <option value="active">运行中</option>
              <option value="exhausted">已耗尽</option>
            </select>
            <button @click="searchBudgets()" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary">🔍 搜索</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="themed-bg-base">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">活动ID</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">活动名称</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">预算模式</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">剩余预算</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">状态</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <template x-for="budget in budgets" :key="budget.lottery_campaign_id">
                <tr class="themed-hover-bg">
                  <td class="px-4 py-3 text-sm font-mono" x-text="budget.lottery_campaign_id"></td>
                  <td class="px-4 py-3 text-sm" x-text="budget.campaign_name || budget.name || '-'"></td>
                  <td class="px-4 py-3">
                    <span 
                      :class="budget.budget_mode === 'UNLIMITED' ? 'themed-bg-primary-light themed-text-primary' : 'bg-purple-100 text-purple-700'"
                      class="px-2 py-1 text-xs rounded"
                      x-text="getBudgetModeText(budget.budget_mode)"
                    ></span>
                  </td>
                  <td class="px-4 py-3 text-sm font-mono" x-text="budget.pool_budget_remaining ?? budget.remaining ?? '-'"></td>
                  <td class="px-4 py-3">
                    <span 
                      :class="getBudgetStatusFromData(budget) === 'active' ? 'bg-green-100 themed-text-success' : 'bg-red-100 text-red-700'"
                      class="px-2 py-1 text-xs rounded"
                      x-text="getBudgetStatusText(getBudgetStatusFromData(budget))"
                    ></span>
                  </td>
                  <td class="px-4 py-3">
                    <div class="flex space-x-2">
                      <button @click="viewBudgetDetail(budget)" class="themed-text-primary hover:text-blue-700 text-sm">详情</button>
                      <button @click="openEditBudgetModal(budget)" class="text-green-500 hover:text-green-700 text-sm">编辑</button>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
          <!-- 空数据提示 -->
          <div x-show="budgets.length === 0" class="text-center py-8 themed-text-muted">
            <div class="text-4xl mb-2">📊</div>
            <p>暂无活动预算数据</p>
          </div>
        </div>
        <!-- 分页 -->
        <div class="p-4 border-t themed-bg-base flex justify-between items-center" x-show="budgets.length > 0">
          <span class="text-sm themed-text-muted">共 <span x-text="financePagination.total"></span> 条记录</span>
          <div class="flex space-x-1">
            <button @click="changePage(financePagination.page - 1)" :disabled="financePagination.page <= 1" class="px-3 py-1 border rounded text-sm themed-hover-bg disabled:opacity-50">上一页</button>
            <span class="px-3 py-1 text-sm">第 <span x-text="financePagination.page"></span> / <span x-text="financeTotalPages"></span> 页</span>
            <button @click="changePage(financePagination.page + 1)" :disabled="financePagination.page >= financeTotalPages" class="px-3 py-1 border rounded text-sm themed-hover-bg disabled:opacity-50">下一页</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 商户日志 -->
    <div x-show="current_page === 'merchant-logs'" x-cloak>
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">📋 商户操作日志</h5>
        </div>
        <!-- 筛选区域 -->
        <div class="p-4 border-b themed-bg-base">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <input type="text" x-model="logFilters.merchant_id" placeholder="商户ID" class="px-3 py-2 border rounded">
            <select x-model="logFilters.action_type" class="px-3 py-2 border rounded">
              <option value="">全部操作类型</option>
              <option value="login">登录</option>
              <option value="order">订单</option>
              <option value="points">积分</option>
              <option value="settlement">结算</option>
            </select>
            <div class="flex items-center gap-1">
              <input type="date" x-model="logFilters.start_time" class="px-3 py-2 border rounded" title="开始日期">
              <span class="text-gray-400">~</span>
              <input type="date" x-model="logFilters.end_time" class="px-3 py-2 border rounded" title="结束日期">
            </div>
            <button @click="searchLogs()" class="px-4 py-2 themed-btn-primary rounded">🔍 搜索</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="themed-bg-base">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">日志ID</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">商户</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作类型</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">描述</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作时间</th>
                <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">IP地址</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <template x-for="log in merchantLogs" :key="log.id">
                <tr class="themed-hover-bg">
                  <td class="px-4 py-3 text-sm font-mono" x-text="log.id"></td>
                  <td class="px-4 py-3 text-sm" x-text="log.store_info?.store_name || log.operator_info?.nickname || '-'"></td>
                  <td class="px-4 py-3">
                    <span class="px-2 py-1 text-xs rounded themed-bg-subtle themed-text-secondary" x-text="log.operation_type_name || log.operation_type || '-'"></span>
                  </td>
                  <td class="px-4 py-3 text-sm themed-text-muted max-w-xs truncate" x-text="log.action_name || log.result_name || '-'" :title="log.action_name || log.result_name"></td>
                  <td class="px-4 py-3 text-sm themed-text-muted" x-text="log.created_at?.beijing || log.created_at?.relative || '-'"></td>
                  <td class="px-4 py-3 text-sm text-gray-400 font-mono" x-text="log.ip_address || '-'"></td>
                </tr>
              </template>
            </tbody>
          </table>
          <!-- 空数据提示 -->
          <div x-show="merchantLogs.length === 0" class="text-center py-8 themed-text-muted">
            <div class="text-4xl mb-2">📋</div>
            <p>暂无商户操作日志</p>
          </div>
        </div>
        <!-- 分页 -->
        <div class="p-4 border-t themed-bg-base flex justify-between items-center" x-show="merchantLogs.length > 0">
          <span class="text-sm themed-text-muted">共 <span x-text="financePagination.total"></span> 条记录</span>
          <div class="flex space-x-1">
            <button @click="changePage(financePagination.page - 1)" :disabled="financePagination.page <= 1" class="px-3 py-1 border rounded text-sm themed-hover-bg disabled:opacity-50">上一页</button>
            <span class="px-3 py-1 text-sm">第 <span x-text="financePagination.page"></span> / <span x-text="financeTotalPages"></span> 页</span>
            <button @click="changePage(financePagination.page + 1)" :disabled="financePagination.page >= financeTotalPages" class="px-3 py-1 border rounded text-sm themed-hover-bg disabled:opacity-50">下一页</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== Modal 区域 ==================== -->

    <!-- 1. 消费记录详情 Modal -->
    <div x-ref="consumptionDetailModal" 
         x-show="isModalOpen('consumptionDetailModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('consumptionDetailModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-md mx-4 z-10">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold">📋 消费记录详情</h5>
          <button @click="hideModal('consumptionDetailModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <div class="p-6" x-show="selectedConsumption">
          <div class="space-y-3">
            <div class="flex justify-between border-b pb-2">
              <span class="themed-text-muted">记录ID</span>
              <span class="font-mono" x-text="selectedConsumption?.record_id"></span>
            </div>
            <div class="flex justify-between border-b pb-2">
              <span class="themed-text-muted">用户</span>
              <span x-text="selectedConsumption?.user_name || selectedConsumption?.user_id"></span>
            </div>
            <div class="flex justify-between border-b pb-2">
              <span class="themed-text-muted">门店</span>
              <span x-text="selectedConsumption?.store_name"></span>
            </div>
            <div class="flex justify-between border-b pb-2">
              <span class="themed-text-muted">金额</span>
              <span class="font-mono text-lg" x-text="'¥' + (selectedConsumption?.amount / 100).toFixed(2)"></span>
            </div>
            <div class="flex justify-between border-b pb-2">
              <span class="themed-text-muted">状态</span>
              <span class="px-2 py-1 text-xs rounded" :class="getConsumptionStatusClass(selectedConsumption?.status)" x-text="getConsumptionStatusText(selectedConsumption?.status)"></span>
            </div>
            <div class="flex justify-between border-b pb-2">
              <span class="themed-text-muted">提交时间</span>
              <span x-text="formatDateOnly(selectedConsumption?.created_at)"></span>
            </div>
            <div x-show="selectedConsumption?.remark">
              <span class="themed-text-muted block mb-1">备注</span>
              <p class="themed-text themed-bg-base p-2 rounded" x-text="selectedConsumption?.remark"></p>
            </div>
          </div>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-2">
          <button type="button" @click="hideModal('consumptionDetailModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">关闭</button>
          <template x-if="selectedConsumption?.status === 'pending'">
            <div class="flex space-x-2">
              <button type="button" @click="approveConsumption(selectedConsumption); hideModal('consumptionDetailModal')" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">✓ 通过</button>
              <button type="button" @click="showRejectModal(selectedConsumption)" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">✕ 拒绝</button>
            </div>
          </template>
        </div>
      </div>
    </div>

    <!-- 2. 拒绝原因 Modal -->
    <div x-ref="rejectModal" 
         x-show="isModalOpen('rejectModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('rejectModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-sm mx-4 z-10">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold text-red-600">⚠️ 拒绝审核</h5>
          <button @click="hideModal('rejectModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <form @submit.prevent="confirmReject()">
          <div class="p-6 space-y-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">拒绝原因 <span class="text-red-500">*</span></label>
              <textarea x-model="rejectForm.reason" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-red-500" rows="3" required placeholder="请输入拒绝原因..."></textarea>
            </div>
          </div>
          <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-2">
            <button type="button" @click="hideModal('rejectModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">取消</button>
            <button type="submit" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600" :disabled="saving">
              <span x-show="saving" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-1"></span>
              确认拒绝
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 3. 欠账详情 Modal - 适配后端 debt-management 结构 -->
    <div x-ref="debtDetailModal" 
         x-show="isModalOpen('debtDetailModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('debtDetailModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-lg mx-4 z-10 max-h-[90vh] overflow-y-auto">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 themed-card">
          <h5 class="font-semibold">💳 欠账详情</h5>
          <button @click="hideModal('debtDetailModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <div class="p-6" x-show="selectedDebt">
          <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-red-50 rounded-lg p-4 text-center">
              <p class="text-sm themed-text-muted">欠账数量/金额</p>
              <p class="text-2xl font-bold text-red-600" x-text="selectedDebt?.owed_quantity || selectedDebt?.owed_amount || 0"></p>
            </div>
            <div class="themed-bg-primary-light rounded-lg p-4 text-center">
              <p class="text-sm themed-text-muted">欠账类型</p>
              <p class="text-lg font-bold themed-text-primary" x-text="selectedDebt?.debt_type === 'inventory' ? '库存欠账' : '预算欠账'"></p>
            </div>
          </div>
          <div class="space-y-3">
            <div class="flex justify-between border-b pb-2">
              <span class="themed-text-muted">欠账ID</span>
              <span class="font-mono" x-text="selectedDebt?.debt_id || selectedDebt?.id"></span>
            </div>
            <div class="flex justify-between border-b pb-2">
              <span class="themed-text-muted">活动</span>
              <span x-text="selectedDebt?.campaign_name || ('ID: ' + (selectedDebt?.campaign_id || '-'))"></span>
            </div>
            <div class="flex justify-between border-b pb-2">
              <span class="themed-text-muted">奖品</span>
              <span x-text="selectedDebt?.prize_name || ('ID: ' + (selectedDebt?.prize_id || '-'))"></span>
            </div>
            <div class="flex justify-between border-b pb-2">
              <span class="themed-text-muted">创建时间</span>
              <span x-text="formatDateTimeShort(selectedDebt?.created_at)"></span>
            </div>
          </div>
          <div class="mt-6" x-show="selectedDebt?.clear_records?.length > 0">
            <h6 class="font-medium mb-3">清偿记录</h6>
            <div class="space-y-2">
              <template x-for="record in selectedDebt?.clear_records || []" :key="record.record_id">
                <div class="themed-bg-base rounded p-3 flex justify-between items-center">
                  <div>
                    <span class="font-mono text-green-600" x-text="'¥' + (payment.amount / 100).toFixed(2)"></span>
                    <span class="themed-text-muted text-sm ml-2" x-text="formatDateOnly(payment.created_at)"></span>
                  </div>
                  <span class="text-gray-400 text-sm" x-text="payment.remark || ''"></span>
                </div>
              </template>
            </div>
          </div>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-2 sticky bottom-0">
          <button type="button" @click="hideModal('debtDetailModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">关闭</button>
          <button type="button" @click="openRepayModal(selectedDebt)" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">💵 执行清偿</button>
        </div>
      </div>
    </div>

    <!-- 4. 欠账清偿 Modal - 适配后端 /clear 接口 -->
    <div x-ref="debtRepayModal" 
         x-show="isModalOpen('debtRepayModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('debtRepayModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-md mx-4 z-10">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold">💵 欠账清偿</h5>
          <button @click="hideModal('debtRepayModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <form @submit.prevent="submitDebtRepay()">
          <div class="p-6 space-y-4">
            <!-- 欠账信息 -->
            <div class="themed-bg-base rounded p-3">
              <div class="grid grid-cols-2 gap-2 text-sm">
                <div>
                  <span class="themed-text-muted">欠账ID:</span>
                  <span class="font-mono" x-text="debtRepayForm.debt_id"></span>
                </div>
                <div>
                  <span class="themed-text-muted">类型:</span>
                  <span x-text="debtRepayForm.debt_type === 'inventory' ? '库存欠账' : '预算欠账'"></span>
                </div>
              </div>
            </div>
            <div class="bg-red-50 rounded p-3 text-center">
              <p class="text-sm themed-text-muted">待清偿数量/金额</p>
              <p class="text-xl font-bold text-red-600" x-text="debtRepayForm.amount || 0"></p>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">清偿数量/金额 <span class="text-red-500">*</span></label>
              <input type="number" x-model.number="debtRepayForm.amount" step="1" min="1" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-green-500" required>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">备注</label>
              <input type="text" x-model="debtRepayForm.remark" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-green-500" placeholder="清偿备注...">
            </div>
          </div>
          <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-2">
            <button type="button" @click="hideModal('debtRepayModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">取消</button>
            <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600" :disabled="saving">
              <span x-show="saving" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-1"></span>
              确认清偿
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 5. 调整钻石 Modal -->
    <div x-ref="diamondAdjustModal" 
         x-show="isModalOpen('diamondAdjustModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('diamondAdjustModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-md mx-4 z-10">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold">💎 调整用户钻石</h5>
          <button @click="hideModal('diamondAdjustModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <form @submit.prevent="submitDiamondAdjust()">
          <div class="p-6 space-y-4">
            <!-- 用户ID输入 -->
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">用户ID <span class="text-red-500">*</span></label>
              <input 
                type="number" 
                x-model.number="diamondAdjustForm.user_id" 
                class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" 
                required
                placeholder="请输入用户ID"
              >
            </div>

            <!-- 当前余额显示（如有） -->
            <div x-show="selectedDiamondAccount?.balance !== undefined" class="themed-bg-primary-light rounded p-3 text-center">
              <p class="text-sm themed-text-muted">当前钻石余额</p>
              <p class="text-xl font-bold themed-text-primary" x-text="formatNumber(selectedDiamondAccount?.balance || 0)"></p>
            </div>

            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">调整类型</label>
              <select x-model="diamondAdjustForm.type" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500">
                <option value="add">➕ 增加钻石</option>
                <option value="subtract">➖ 扣除钻石</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">调整数量 <span class="text-red-500">*</span></label>
              <input 
                type="number" 
                x-model.number="diamondAdjustForm.amount" 
                min="1" 
                class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" 
                required
                placeholder="请输入调整数量"
              >
            </div>

            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">调整原因 <span class="text-red-500">*</span></label>
              <textarea 
                x-model="diamondAdjustForm.reason" 
                class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" 
                rows="2" 
                required
                placeholder="请输入调整原因（如：客服补偿、数据修正等）"
              ></textarea>
            </div>

            <!-- 预览 -->
            <div class="themed-bg-base rounded p-3 text-sm">
              <p class="themed-text-muted">
                <span x-show="diamondAdjustForm.type === 'add'">将为用户 <span class="font-mono" x-text="diamondAdjustForm.user_id || '?'"></span> <span class="text-green-600 font-medium">增加</span></span>
                <span x-show="diamondAdjustForm.type === 'subtract'">将为用户 <span class="font-mono" x-text="diamondAdjustForm.user_id || '?'"></span> <span class="text-red-600 font-medium">扣除</span></span>
                <span class="font-bold" x-text="diamondAdjustForm.amount || 0"></span> 钻石
              </p>
            </div>
          </div>
          <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-2">
            <button type="button" @click="hideModal('diamondAdjustModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">取消</button>
            <button type="submit" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" :disabled="saving">
              <span x-show="saving" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-1"></span>
              确认调整
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 6. 钻石账户详情 Modal（含流水记录） -->
    <div x-ref="diamondDetailModal" 
         x-show="isModalOpen('diamondDetailModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('diamondDetailModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-3xl mx-4 z-10 max-h-[85vh] overflow-hidden flex flex-col">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold">💎 钻石账户详情</h5>
          <button @click="hideModal('diamondDetailModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <div class="flex-1 overflow-y-auto p-4">
          <div class="space-y-4" x-show="selectedDiamondAccount">
            <!-- 账户信息 -->
            <div class="grid grid-cols-3 gap-4">
              <div class="themed-bg-primary-light rounded-lg p-4 text-center">
                <p class="text-sm themed-text-muted">用户ID</p>
                <p class="text-xl font-bold themed-text-primary" x-text="selectedDiamondAccount?.user_id || '-'"></p>
              </div>
              <div class="bg-green-50 rounded-lg p-4 text-center">
                <p class="text-sm themed-text-muted">可用余额</p>
                <p class="text-xl font-bold text-green-600" x-text="formatNumber(selectedDiamondAccount?.balance || 0)"></p>
              </div>
              <div class="bg-yellow-50 rounded-lg p-4 text-center">
                <p class="text-sm themed-text-muted">冻结余额</p>
                <p class="text-xl font-bold text-yellow-600" x-text="formatNumber(selectedDiamondAccount?.frozen || 0)"></p>
              </div>
            </div>

            <!-- 用户信息 -->
            <div class="border-t pt-4">
              <h6 class="font-medium mb-2">用户信息</h6>
              <div class="grid grid-cols-2 gap-2 text-sm themed-text-muted">
                <p><span class="font-medium">昵称：</span><span x-text="selectedDiamondAccount?.nickname || '-'"></span></p>
                <p><span class="font-medium">手机：</span><span x-text="selectedDiamondAccount?.mobile || '-'"></span></p>
              </div>
            </div>

            <!-- 流水记录 -->
            <div class="border-t pt-4">
              <h6 class="font-medium mb-3">💫 最近流水记录</h6>
              <template x-if="selectedDiamondAccount?.transactions?.length > 0">
                <div class="overflow-x-auto">
                  <table class="w-full text-sm">
                    <thead class="themed-bg-base">
                      <tr>
                        <th class="px-3 py-2 text-left font-medium themed-text-muted">时间</th>
                        <th class="px-3 py-2 text-left font-medium themed-text-muted">类型</th>
                        <th class="px-3 py-2 text-right font-medium themed-text-muted">变动</th>
                        <th class="px-3 py-2 text-right font-medium themed-text-muted">余额</th>
                        <th class="px-3 py-2 text-left font-medium themed-text-muted">原因</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y">
                      <template x-for="tx in selectedDiamondAccount.transactions" :key="tx.transaction_id">
                        <tr class="themed-hover-bg">
                          <td class="px-3 py-2 themed-text-muted" x-text="formatDateTimeShort(tx.created_at)"></td>
                          <td class="px-3 py-2" x-text="tx.tx_type || '-'"></td>
                          <td class="px-3 py-2 text-right font-mono" 
                              :class="tx.amount > 0 ? 'text-green-600' : 'text-red-600'"
                              x-text="(tx.amount > 0 ? '+' : '') + tx.amount"></td>
                          <td class="px-3 py-2 text-right font-mono themed-text-muted" x-text="tx.balance_after"></td>
                          <td class="px-3 py-2 themed-text-muted max-w-xs truncate" x-text="tx.reason || '-'" :title="tx.reason"></td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </div>
              </template>
              <template x-if="!selectedDiamondAccount?.transactions || selectedDiamondAccount.transactions.length === 0">
                <p class="text-center text-gray-400 py-4">暂无流水记录</p>
              </template>
            </div>
          </div>
        </div>
        <div class="p-4 border-t themed-bg-base flex justify-end space-x-2">
          <button @click="hideModal('diamondDetailModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">关闭</button>
          <button @click="openDiamondAdjustModal(selectedDiamondAccount)" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary">调整钻石</button>
        </div>
      </div>
    </div>

    <!-- 7. 商户积分详情 Modal -->
    <div x-ref="merchantPointDetailModal" 
         x-show="isModalOpen('merchantPointDetailModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('merchantPointDetailModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-2xl mx-4 z-10 max-h-[80vh] overflow-hidden flex flex-col">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold">🏪 商户积分详情</h5>
          <button @click="hideModal('merchantPointDetailModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <div class="flex-1 overflow-y-auto p-4">
          <div class="space-y-4" x-show="selectedMerchant">
            <div class="grid grid-cols-2 gap-4">
              <div class="bg-orange-50 rounded-lg p-4 text-center">
                <p class="text-sm themed-text-muted">商户ID</p>
                <p class="text-xl font-bold text-orange-600" x-text="selectedMerchant?.merchant_id || selectedMerchant?.id || '-'"></p>
              </div>
              <div class="bg-green-50 rounded-lg p-4 text-center">
                <p class="text-sm themed-text-muted">积分余额</p>
                <p class="text-xl font-bold text-green-600" x-text="selectedMerchant?.balance || selectedMerchant?.points || 0"></p>
              </div>
            </div>
            <div class="border-t pt-4">
              <h6 class="font-medium mb-2">商户信息</h6>
              <div class="text-sm themed-text-muted">
                <p><span class="font-medium">名称：</span><span x-text="selectedMerchant?.merchant_name || selectedMerchant?.name || '-'"></span></p>
              </div>
            </div>
          </div>
        </div>
        <div class="p-4 border-t themed-bg-base flex justify-end">
          <button @click="hideModal('merchantPointDetailModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">关闭</button>
        </div>
      </div>
    </div>

    <!-- 8. 预算设置 Modal -->
    <div x-ref="budgetModal" 
         x-show="isModalOpen('budgetModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('budgetModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-md mx-4 z-10">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold">📊 预算设置</h5>
          <button @click="hideModal('budgetModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <form @submit.prevent="saveBudget()">
          <div class="p-6 space-y-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">预算类型</label>
              <select x-model="budgetForm.type" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-gray-500">
                <option value="daily">日预算</option>
                <option value="weekly">周预算</option>
                <option value="monthly">月预算</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">预算金额 (元) <span class="text-red-500">*</span></label>
              <input type="number" x-model.number="budgetForm.amount" step="0.01" min="0" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-gray-500" required>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">预警阈值 (%)</label>
              <input type="number" x-model.number="budgetForm.alert_threshold" min="0" max="100" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-gray-500" placeholder="80">
              <p class="text-xs themed-text-muted mt-1">达到此比例时发送预警</p>
            </div>
          </div>
          <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-2">
            <button type="button" @click="hideModal('budgetModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">取消</button>
            <button type="submit" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800" :disabled="saving">保存预算</button>
          </div>
        </form>
      </div>
    </div>

  </div>

  <!-- 页面专属逻辑 -->
  <%- include('partials/footer') %>


  <script type="module" src="./src/modules/analytics/pages/finance-management.js"></script>
</body>
</html>

