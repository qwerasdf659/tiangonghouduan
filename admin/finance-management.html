<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '财务管理中心', 
    pageStyle: '[x-cloak] { display: none !important; }' 
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen">
  
  <!-- 导航栏 -->
  <nav class="bg-gray-800 text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="hover:text-gray-300">← 返回工作台</a>
        <span class="text-lg font-semibold">💰 财务管理中心</span>
      </div>
    </div>
  </nav>

  <!-- 页面主体 -->
  <div class="container mx-auto px-4 py-6" x-data="financeNavigation()" x-init="init()">
    
    <!-- 子页面导航 - 带底部高亮条的现代风格 -->
    <div class="themed-card rounded-xl shadow-sm mb-6 overflow-hidden">
      <div class="flex overflow-x-auto bg-gradient-to-r from-slate-50 to-gray-50">
        <template x-for="page in subPages" :key="page.id">
          <button 
            @click="switchPage(page.id)"
            :class="current_page === page.id
              ? 'border-b-2 border-blue-600 text-blue-700 bg-white font-semibold shadow-sm'
              : 'border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:bg-white/60'"
            class="px-6 py-3.5 font-medium whitespace-nowrap transition-all duration-200 relative"
          >
            <i :class="page.icon" class="mr-1.5"></i>
            <span x-text="page.title"></span>
          </button>
        </template>
      </div>
    </div>

    <!-- 页面内容区域 -->
    <div x-data="financePageContent()" x-init="init()"
         @approve-consumption="approveConsumption($event.detail)"
         @reject-consumption="rejectConsumption($event.detail)"
         @view-diamond-detail="viewDiamondDetail($event.detail)"
         @open-diamond-adjust="openDiamondAdjustModal($event.detail)"
         @view-merchant-detail="viewMerchantDetail($event.detail)"
         @approve-merchant="approveMerchantPoints($event.detail)"
         @reject-merchant="rejectMerchantPoints($event.detail)"
         @batch-approve-merchant="batchApproveMerchantPoints($event.detail.ids)"
         @batch-reject-merchant="openMerchantBatchRejectModal($event.detail.ids)"
         @view-debt-detail="viewDebtDetail($event.detail)"
         @open-repay="openRepayModal($event.detail)"
         @view-budget-detail="viewBudgetDetail($event.detail)"
         @open-edit-budget="openEditBudgetModal($event.detail)">

    <!-- 消费记录审核 -->
    <div x-show="current_page === 'consumption'" x-cloak x-init="loadAnomalyStats()">

      <!-- 异常统计面板 - 使用统一 stats-card 组件 -->
      <div class="stats-grid stats-grid-5 mb-6">
        <div class="stats-card stats-danger stats-card-animate">
          <div class="flex items-center justify-between">
            <div>
              <p class="stats-card-label">异常总数</p>
              <p class="stats-card-value text-red-600" x-text="anomalyStats.total_anomaly || 0"></p>
            </div>
            <div class="stats-card-icon bg-gradient-to-br from-red-100 to-red-200 text-red-600">🚨</div>
          </div>
          <p class="text-xs themed-text-muted mt-2">所有异常记录汇总</p>
        </div>
        <div class="stats-card stats-warning stats-card-animate">
          <div class="flex items-center justify-between">
            <div>
              <p class="stats-card-label">高频消费</p>
              <p class="stats-card-value text-orange-600" x-text="anomalyStats.high_frequency || 0"></p>
            </div>
            <div class="stats-card-icon bg-gradient-to-br from-orange-100 to-orange-200 text-orange-600">🔄</div>
          </div>
          <p class="text-xs themed-text-muted mt-2">短时间内多次消费</p>
        </div>
        <div class="stats-card stats-warning stats-card-animate" style="border-left-color: #eab308;">
          <div class="flex items-center justify-between">
            <div>
              <p class="stats-card-label">大额异常</p>
              <p class="stats-card-value text-yellow-600" x-text="anomalyStats.high_amount || 0"></p>
            </div>
            <div class="stats-card-icon bg-gradient-to-br from-yellow-100 to-yellow-200 text-yellow-600">💰</div>
          </div>
          <p class="text-xs themed-text-muted mt-2">消费金额超过常规</p>
        </div>
        <div class="stats-card stats-info stats-card-animate">
          <div class="flex items-center justify-between">
            <div>
              <p class="stats-card-label">高风险</p>
              <p class="stats-card-value text-purple-600" x-text="anomalyStats.unusual_time || 0"></p>
            </div>
            <div class="stats-card-icon bg-gradient-to-br from-purple-100 to-purple-200 text-purple-600">⚠️</div>
          </div>
          <p class="text-xs themed-text-muted mt-2">需重点关注的记录</p>
        </div>
        <div class="stats-card stats-card-animate" style="border-left: 4px solid #6b7280;">
          <div class="flex items-center justify-between">
            <div>
              <p class="stats-card-label">其他异常</p>
              <p class="stats-card-value text-gray-600" x-text="anomalyStats.other || 0"></p>
            </div>
            <div class="stats-card-icon bg-gradient-to-br from-gray-100 to-gray-200 text-gray-600">📋</div>
          </div>
          <p class="text-xs themed-text-muted mt-2">跨店、行为异常等</p>
        </div>
      </div>

      <div class="themed-card rounded-xl shadow-sm border overflow-hidden">
        <!-- 标题栏 + 批量操作按钮 -->
        <div class="px-5 py-4 bg-gradient-to-r from-slate-50 to-white border-b">
          <div class="flex flex-wrap justify-between items-center gap-3">
            <div class="flex items-center gap-3">
              <div class="flex items-center gap-2">
                <span class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center text-base">📋</span>
                <h5 class="font-semibold text-lg text-gray-800">消费记录审核</h5>
              </div>
              <span class="text-xs bg-amber-100 text-amber-700 px-2.5 py-1 rounded-full font-medium border border-amber-200"
                    x-text="'待审核 ' + (consumptionStats.pendingCount || 0) + ' 条'"></span>
            </div>
            <!-- 批量操作按钮区 - 始终显示，未选中时禁用 -->
            <div class="flex items-center gap-2">
              <!-- 已选计数 -->
              <span class="text-sm themed-text-muted" x-show="selectedIds.length === 0">勾选左侧复选框选择记录</span>
              <span class="text-sm text-blue-700 font-medium" x-show="selectedIds.length > 0">
                已选 <span class="inline-flex items-center justify-center w-6 h-6 bg-blue-500 text-white rounded-full text-xs font-bold" x-text="selectedIds.length"></span> 条
              </span>
              <span class="text-gray-300 mx-1">|</span>
              <!-- 批量通过按钮 -->
              <button
                @click="batchApprove()"
                :disabled="selectedIds.length === 0 || batchProcessing"
                class="inline-flex items-center gap-1.5 px-4 py-2 rounded-lg text-sm font-medium transition-all shadow-sm"
                :class="selectedIds.length > 0
                  ? 'bg-green-500 text-white hover:bg-green-600 cursor-pointer'
                  : 'bg-gray-100 text-gray-400 cursor-not-allowed'"
              >
                <span x-show="batchProcessing" class="inline-block w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"></span>
                <span x-show="!batchProcessing">✓</span>
                <span>批量通过</span>
              </button>
              <!-- 批量拒绝按钮 -->
              <button
                @click="openBatchRejectModal()"
                :disabled="selectedIds.length === 0 || batchProcessing"
                class="inline-flex items-center gap-1.5 px-4 py-2 rounded-lg text-sm font-medium transition-all shadow-sm"
                :class="selectedIds.length > 0
                  ? 'bg-red-500 text-white hover:bg-red-600 cursor-pointer'
                  : 'bg-gray-100 text-gray-400 cursor-not-allowed'"
              >
                <span x-show="batchProcessing" class="inline-block w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"></span>
                <span x-show="!batchProcessing">✕</span>
                <span>批量拒绝</span>
              </button>
              <!-- 清除选择 -->
              <button x-show="selectedIds.length > 0"
                      @click="clearSelection()"
                      class="px-3 py-2 text-sm text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                清除
              </button>
            </div>
          </div>
        </div>

        <!-- 筛选面板 -->
        <div class="p-4 border-b bg-gray-50">
          <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
            <div>
              <label class="block text-xs font-medium themed-text-muted mb-1">手机号</label>
              <input type="text" x-model="consumptionFilters.mobile" placeholder="输入手机号搜索" maxlength="11"
                     @keyup.enter="loadConsumptions()"
                     class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
            </div>
            <div>
              <label class="block text-xs font-medium themed-text-muted mb-1">审核状态</label>
              <select x-model="consumptionFilters.status" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                <option value="">全部状态</option>
                <option value="pending">待审核</option>
                <option value="approved">已通过</option>
                <option value="rejected">已拒绝</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium themed-text-muted mb-1">风控标记</label>
              <select x-model="consumptionFilters.anomaly_type" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                <option value="">全部类型</option>
                <option value="high_frequency">🔄 高频消费</option>
                <option value="high_amount">💰 大额异常</option>
                <option value="unusual_time">🌙 异常时段</option>
                <option value="location_mismatch">📍 位置异常</option>
                <option value="device_change">📱 设备变更</option>
                <option value="rapid_succession">⚡ 短时多次</option>
                <option value="first_time_high">🆕 首次大额</option>
                <option value="pattern_break">📊 行为异常</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium themed-text-muted mb-1">起始日期</label>
              <input type="date" x-model="consumptionFilters.start_date" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
            </div>
            <div>
              <label class="block text-xs font-medium themed-text-muted mb-1">截止日期</label>
              <input type="date" x-model="consumptionFilters.end_date" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
            </div>
            <div class="flex gap-2">
              <button @click="financePagination.page = 1; loadConsumptions()" class="flex-1 px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 text-sm font-medium transition-colors">🔍 搜索</button>
              <button @click="resetConsumptionFilters()" class="px-3 py-2 bg-gray-200 text-gray-600 rounded-lg hover:bg-gray-300 text-sm transition-colors" title="重置筛选条件">🔄</button>
            </div>
          </div>
        </div>

        <!-- 数据表格 -->
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="bg-gradient-to-r from-gray-50 to-slate-50 border-b-2 border-gray-200">
                <th class="px-4 py-3.5 text-center w-12">
                  <input
                    type="checkbox"
                    :checked="isAllSelected"
                    @change="toggleSelectAll()"
                    class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    title="全选/取消全选当前页待审核记录"
                  >
                </th>
                <th class="px-4 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">记录ID</th>
                <th class="px-4 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">用户</th>
                <th class="px-4 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">门店</th>
                <th class="px-4 py-3.5 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">金额</th>
                <th class="px-4 py-3.5 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">风控标记</th>
                <th class="px-4 py-3.5 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">状态</th>
                <th class="px-4 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">提交时间</th>
                <th class="px-4 py-3.5 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">操作</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              <template x-for="(record, idx) in consumptions" :key="record.record_id">
                <tr class="transition-colors"
                    :class="{
                      'bg-blue-50 hover:bg-blue-100': isSelected(record),
                      'bg-red-50/60 hover:bg-red-100/60': !isSelected(record) && isOverdue(record),
                      'bg-orange-50/60 hover:bg-orange-100/60': !isSelected(record) && isNearOverdue(record),
                      'hover:bg-gray-50': !isSelected(record) && !isOverdue(record) && !isNearOverdue(record)
                    }">
                  <td class="px-4 py-3 text-center">
                    <template x-if="record.status === 'pending'">
                      <input
                        type="checkbox"
                        :checked="isSelected(record)"
                        @change="toggleSelection(record.record_id)"
                        class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
                      >
                    </template>
                    <template x-if="record.status !== 'pending'">
                      <span class="text-gray-300">-</span>
                    </template>
                  </td>
                  <td class="px-4 py-3 text-sm font-mono themed-text-primary font-medium" x-text="record.record_id"></td>
                  <td class="px-4 py-3 text-sm" x-text="record.user_name || record.user_id"></td>
                  <td class="px-4 py-3 text-sm themed-text-muted" x-text="record.store_name"></td>
                  <td class="px-4 py-3 text-sm font-mono text-right">
                    <span class="font-semibold" x-text="'¥' + Number(record.consumption_amount || 0).toFixed(2)"></span>
                  </td>
                  <td class="px-4 py-3 text-center">
                    <template x-if="record.is_suspicious || record.risk_level === 'high'">
                      <div class="inline-flex flex-col items-center gap-0.5 cursor-help" :title="getAnomalyTooltip(record)">
                        <span class="inline-flex items-center px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-700 font-medium border border-red-200">
                          ⚠️ 异常
                        </span>
                        <template x-if="record.anomaly_type">
                          <span class="text-xs text-red-500" x-text="getAnomalyLabel(record.anomaly_type)"></span>
                        </template>
                      </div>
                    </template>
                    <template x-if="record.risk_level === 'medium'">
                      <span class="inline-flex items-center px-2 py-0.5 text-xs rounded-full bg-yellow-100 text-yellow-700 font-medium border border-yellow-200 cursor-help"
                            :title="getAnomalyTooltip(record)">
                        ⚡ 关注
                      </span>
                    </template>
                    <template x-if="!record.is_suspicious && !record.risk_level">
                      <span class="inline-flex items-center px-2 py-0.5 text-xs rounded-full bg-green-50 text-green-600 border border-green-100">✓ 正常</span>
                    </template>
                  </td>
                  <td class="px-4 py-3 text-center">
                    <span
                      :class="{
                        'bg-yellow-100 text-yellow-800 border border-yellow-200': record.status === 'pending',
                        'bg-green-100 text-green-700 border border-green-200': record.status === 'approved',
                        'bg-red-100 text-red-700 border border-red-200': record.status === 'rejected'
                      }"
                      class="inline-flex items-center px-2.5 py-1 text-xs rounded-full font-medium"
                      x-text="record.status === 'pending' ? '待审核' : record.status === 'approved' ? '已通过' : '已拒绝'"
                    ></span>
                  </td>
                  <td class="px-4 py-3">
                    <div class="text-sm themed-text-muted" x-text="formatDateOnly(record.created_at)"></div>
                    <template x-if="record.status === 'pending'">
                      <div
                        class="text-xs mt-0.5"
                        :class="getTimeoutTextClass(record)"
                        x-text="getWaitingTimeText(record)"
                      ></div>
                    </template>
                    <template x-if="record.status === 'approved'">
                      <div class="text-xs mt-0.5 text-green-500" x-text="record.reviewed_at ? '审核于 ' + formatDateOnly(record.reviewed_at) : ''"></div>
                    </template>
                  </td>
                  <td class="px-4 py-3 text-center">
                    <template x-if="record.status === 'pending'">
                      <div class="flex justify-center gap-1">
                        <button @click="approveConsumption(record)"
                                class="px-3 py-1 text-xs bg-green-50 text-green-600 rounded-md hover:bg-green-100 transition-colors font-medium border border-green-200">通过</button>
                        <button @click="rejectConsumption(record)"
                                class="px-3 py-1 text-xs bg-red-50 text-red-600 rounded-md hover:bg-red-100 transition-colors font-medium border border-red-200">拒绝</button>
                      </div>
                    </template>
                    <template x-if="record.status === 'approved'">
                      <span class="text-xs text-green-500 font-medium">已处理</span>
                    </template>
                    <template x-if="record.status === 'rejected'">
                      <span class="text-xs text-red-500 font-medium">已拒绝</span>
                    </template>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
          <div x-show="consumptions.length === 0" class="text-center py-12 themed-text-muted">
            <div class="text-5xl mb-3">📋</div>
            <p class="text-base font-medium themed-text-secondary mb-1">暂无消费记录</p>
            <p class="text-sm">当前筛选条件下没有匹配的记录</p>
          </div>
        </div>

        <!-- 分页 -->
        <div class="p-4 border-t bg-gray-50 flex justify-between items-center" x-show="consumptions.length > 0">
          <div class="flex items-center gap-4">
            <span class="text-sm themed-text-muted">
              共 <strong class="themed-text" x-text="financePagination.total || 0"></strong> 条记录，
              显示第 <strong x-text="((financePagination.page - 1) * financePagination.page_size) + 1"></strong>-<strong x-text="Math.min(financePagination.page * financePagination.page_size, financePagination.total || 0)"></strong> 条
            </span>
            <select x-model="financePagination.page_size" @change="financePagination.page = 1; loadConsumptions()" class="px-2 py-1 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
              <option value="20">20条/页</option>
              <option value="50">50条/页</option>
              <option value="100">100条/页</option>
            </select>
          </div>
          <div class="flex items-center gap-1">
            <button @click="financePagination.page = 1; loadConsumptions()" :disabled="financePagination.page <= 1" class="px-3 py-1.5 border rounded-lg text-sm themed-hover-bg disabled:opacity-40 transition-colors">«</button>
            <button @click="financePagination.page--; loadConsumptions()" :disabled="financePagination.page <= 1" class="px-3 py-1.5 border rounded-lg text-sm themed-hover-bg disabled:opacity-40 transition-colors">‹</button>
            <span class="px-3 py-1.5 text-sm font-medium">
              <span x-text="financePagination.page"></span> / <span x-text="Math.ceil((financePagination.total || 0) / financePagination.page_size) || 1"></span>
            </span>
            <button @click="financePagination.page++; loadConsumptions()" :disabled="financePagination.page >= Math.ceil((financePagination.total || 0) / financePagination.page_size)" class="px-3 py-1.5 border rounded-lg text-sm themed-hover-bg disabled:opacity-40 transition-colors">›</button>
            <button @click="financePagination.page = Math.ceil((financePagination.total || 0) / financePagination.page_size); loadConsumptions()" :disabled="financePagination.page >= Math.ceil((financePagination.total || 0) / financePagination.page_size)" class="px-3 py-1.5 border rounded-lg text-sm themed-hover-bg disabled:opacity-40 transition-colors">»</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 钻石账户 -->
    <div x-show="current_page === 'diamond-accounts'" x-cloak>
      <!-- 统计卡片 - 使用统一 stats-card 组件 -->
      <div class="stats-grid stats-grid-4 mb-6">
        <div class="stats-card stats-primary stats-card-animate">
          <div class="flex items-center justify-between">
            <div>
              <p class="stats-card-label">持有用户数</p>
              <p class="stats-card-value themed-text-primary" x-text="diamondStats.holder_count || 0"></p>
            </div>
            <div class="stats-card-icon bg-gradient-to-br from-blue-100 to-blue-200 text-blue-600">👤</div>
          </div>
          <p class="text-xs themed-text-muted mt-2">已开通钻石账户的用户</p>
        </div>
        <div class="stats-card stats-success stats-card-animate">
          <div class="flex items-center justify-between">
            <div>
              <p class="stats-card-label">流通总量</p>
              <p class="stats-card-value text-green-600" x-text="formatNumber(diamondStats.total_circulation || 0)"></p>
            </div>
            <div class="stats-card-icon bg-gradient-to-br from-green-100 to-green-200 text-green-600">💎</div>
          </div>
          <p class="text-xs themed-text-muted mt-2">当前可自由使用的钻石</p>
        </div>
        <div class="stats-card stats-warning stats-card-animate" style="border-left-color: #eab308;">
          <div class="flex items-center justify-between">
            <div>
              <p class="stats-card-label">冻结总量</p>
              <p class="stats-card-value text-yellow-600" x-text="formatNumber(diamondStats.total_frozen || 0)"></p>
            </div>
            <div class="stats-card-icon bg-gradient-to-br from-yellow-100 to-yellow-200 text-yellow-600">🔒</div>
          </div>
          <p class="text-xs themed-text-muted mt-2">挂单交易中冻结的钻石</p>
        </div>
        <div class="stats-card stats-info stats-card-animate">
          <div class="flex items-center justify-between">
            <div>
              <p class="stats-card-label">累计发放</p>
              <p class="stats-card-value text-purple-600" x-text="formatNumber(diamondStats.total_issued || 0)"></p>
            </div>
            <div class="stats-card-icon bg-gradient-to-br from-purple-100 to-purple-200 text-purple-600">📊</div>
          </div>
          <p class="text-xs themed-text-muted mt-2">系统历史累计发放总量</p>
        </div>
      </div>

      <div class="themed-card rounded-xl shadow-sm border overflow-hidden">
        <div class="px-5 py-4 bg-gradient-to-r from-slate-50 to-white border-b flex justify-between items-center">
          <div class="flex items-center gap-2">
            <span class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center text-base">💎</span>
            <div>
              <h5 class="font-semibold text-gray-800">钻石账户查询</h5>
              <p class="text-xs text-gray-400 mt-0.5">输入用户手机号，查看钻石余额和交易流水</p>
            </div>
          </div>
          <button @click="openDiamondAdjustModal({})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm flex items-center gap-1 transition shadow-sm">
            <span>➕</span> 调整用户钻石
          </button>
        </div>
        <!-- 搜索区域 -->
        <div class="p-4 border-b themed-bg-base">
          <div class="flex items-end gap-3">
            <div class="flex-1 max-w-sm">
              <label class="block text-sm font-medium themed-text-secondary mb-1">手机号</label>
              <input 
                type="text" 
                x-model="diamondFilters.mobile" 
                placeholder="请输入11位手机号"
                maxlength="11"
                @keyup.enter="searchDiamondAccounts()"
                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              >
            </div>
            <button 
              @click="searchDiamondAccounts()" 
              class="px-5 py-2 themed-bg-primary text-white rounded-lg themed-hover-primary flex items-center gap-1"
            >
              🔍 查询
            </button>
            <button 
              @click="clearDiamondSearch()" 
              class="px-4 py-2 themed-bg-muted themed-text-secondary rounded-lg hover:bg-gray-300"
              x-show="diamondFilters.mobile"
              x-transition
            >
              清空
            </button>
          </div>
        </div>

        <!-- 搜索结果 -->
        <div class="p-4">
          <!-- 未搜索提示 -->
          <div x-show="!diamondSearched && !diamondFilters.mobile" class="text-center py-12 themed-text-muted">
            <div class="text-5xl mb-3">💎</div>
            <p class="text-base font-medium themed-text-secondary mb-1">钻石账户查询</p>
            <p class="text-sm" x-text="diamondSearchTip"></p>
          </div>

          <!-- 搜索中/搜索结果 -->
          <div x-show="diamondSearched || diamondFilters.mobile">
            <!-- 无结果 -->
            <template x-if="diamondAccounts.length === 0 && diamondSearched">
              <div class="text-center py-12 themed-text-muted">
                <div class="text-5xl mb-3">🔍</div>
                <p class="text-base font-medium themed-text-secondary mb-1">未找到结果</p>
                <p class="text-sm" x-text="diamondSearchTip || '未找到该用户的钻石账户信息'"></p>
              </div>
            </template>

            <!-- 结果列表 -->
            <template x-if="diamondAccounts.length > 0">
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead>
                    <tr class="bg-gradient-to-r from-gray-50 to-slate-50 border-b-2 border-gray-200">
                      <th class="px-4 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">用户ID</th>
                      <th class="px-4 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">昵称</th>
                      <th class="px-4 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">手机号</th>
                      <th class="px-4 py-3.5 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">可用余额</th>
                      <th class="px-4 py-3.5 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">冻结余额</th>
                      <th class="px-4 py-3.5 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">状态</th>
                      <th class="px-4 py-3.5 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">操作</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y">
                    <template x-for="account in diamondAccounts" :key="account.user_id">
                      <tr class="themed-hover-bg transition-colors">
                        <td class="px-4 py-3 text-sm font-mono themed-text-primary font-medium" x-text="account.user_id"></td>
                        <td class="px-4 py-3 text-sm" x-text="account.nickname || '-'"></td>
                        <td class="px-4 py-3 text-sm themed-text-muted font-mono" x-text="account.mobile || '-'"></td>
                        <td class="px-4 py-3 text-sm font-mono text-right">
                          <span class="text-green-600 font-semibold" x-text="formatNumber(account.balance || 0)"></span>
                        </td>
                        <td class="px-4 py-3 text-sm font-mono text-right">
                          <span class="text-yellow-600" x-text="formatNumber(account.frozen || 0)"></span>
                        </td>
                        <td class="px-4 py-3 text-center">
                          <span 
                            :class="account.has_diamond ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-gray-100 themed-text-muted border border-gray-200'"
                            class="px-2.5 py-1 text-xs rounded-full font-medium"
                            x-text="account.has_diamond ? '已开通' : '未开通'"
                          ></span>
                        </td>
                        <td class="px-4 py-3 text-center">
                          <div class="flex justify-center space-x-1">
                            <button @click="viewDiamondDetail(account)" class="px-3 py-1 text-xs bg-blue-50 text-blue-600 rounded-md hover:bg-blue-100 transition-colors font-medium">查看流水</button>
                            <button @click="openDiamondAdjustModal(account)" class="px-3 py-1 text-xs bg-green-50 text-green-600 rounded-md hover:bg-green-100 transition-colors font-medium">调整</button>
                          </div>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>

    <!-- 商户积分 - 适配后端 merchant-points API -->
    <div x-show="current_page === 'merchant-points'" x-cloak>

      <!-- 审核统计面板 - 使用统一 stats-card 组件 -->
      <div class="stats-grid stats-grid-4 mb-6">
        <div class="stats-card stats-warning stats-card-animate" style="border-left-color: #eab308;">
          <div class="flex items-center justify-between">
            <div>
              <p class="stats-card-label">待审核</p>
              <p class="stats-card-value text-yellow-700" x-text="merchantStats?.pending_count || 0"></p>
            </div>
            <div class="stats-card-icon bg-gradient-to-br from-yellow-100 to-amber-200 text-yellow-600">⏳</div>
          </div>
          <p class="text-xs text-yellow-500 mt-2">需要运营人员审核处理</p>
        </div>
        <div class="stats-card stats-success stats-card-animate">
          <div class="flex items-center justify-between">
            <div>
              <p class="stats-card-label">已通过</p>
              <p class="stats-card-value text-green-700" x-text="merchantStats?.approved_count || 0"></p>
            </div>
            <div class="stats-card-icon bg-gradient-to-br from-green-100 to-green-200 text-green-600">✅</div>
          </div>
          <p class="text-xs text-green-500 mt-2">审核通过并已发放积分</p>
        </div>
        <div class="stats-card stats-danger stats-card-animate">
          <div class="flex items-center justify-between">
            <div>
              <p class="stats-card-label">已拒绝</p>
              <p class="stats-card-value text-red-700" x-text="merchantStats?.rejected_count || 0"></p>
            </div>
            <div class="stats-card-icon bg-gradient-to-br from-red-100 to-red-200 text-red-600">❌</div>
          </div>
          <p class="text-xs text-red-500 mt-2">申请不符合要求被驳回</p>
        </div>
        <div class="stats-card stats-primary stats-card-animate">
          <div class="flex items-center justify-between">
            <div>
              <p class="stats-card-label">今日发放积分</p>
              <p class="stats-card-value text-blue-700" x-text="formatNumber(merchantStats?.today_points || 0)"></p>
            </div>
            <div class="stats-card-icon bg-gradient-to-br from-blue-100 to-blue-200 text-blue-600">🪙</div>
          </div>
          <p class="text-xs text-blue-500 mt-2">今日审核通过发放的总积分</p>
        </div>
      </div>

      <!-- 操作提示 - 运营人员使用指引 -->
      <div x-show="merchantStats?.pending_count > 0" class="mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg flex items-center gap-3">
        <span class="text-amber-500 text-xl">💡</span>
        <div class="text-sm text-amber-700">
          <strong>操作提示：</strong>
          当前有 <span class="font-bold" x-text="merchantStats?.pending_count || 0"></span> 条待审核申请。
          勾选多条记录可进行<strong>批量通过/拒绝</strong>操作，也可逐条点击操作按钮进行单独审核。
        </div>
      </div>

      <!-- 积分申请列表卡片 -->
      <div class="themed-card rounded-xl shadow-sm overflow-hidden border">
        <div class="px-5 py-4 bg-gradient-to-r from-slate-50 to-white border-b flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="w-8 h-8 bg-amber-100 rounded-lg flex items-center justify-center text-base">🪙</span>
            <div>
              <h5 class="font-semibold text-gray-800">商户积分申请列表</h5>
              <p class="text-xs text-gray-400 mt-0.5">审核商户积分发放申请，支持批量操作</p>
            </div>
          </div>
        </div>

        <!-- data-table: 商户积分列表（启用行选择） -->
        <div x-data="merchantPointsDataTable()" x-init="init()">

          <!-- 搜索筛选栏 -->
          <div class="p-4 border-b bg-gray-50/50">
            <div class="flex flex-wrap items-center gap-3">
              <div class="flex-1 min-w-[160px] max-w-[200px]">
                <input type="text" x-model="activeFilters.mobile" placeholder="输入手机号搜索"
                       maxlength="11" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-400 transition">
              </div>
              <div class="flex-1 min-w-[160px] max-w-[200px]">
                <input type="text" x-model="activeFilters.keyword" placeholder="输入关键词搜索"
                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-400 transition">
              </div>
              <div class="flex-1 min-w-[140px] max-w-[160px]">
                <select x-model="activeFilters.status" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-400 bg-white">
                  <option value="">全部状态</option>
                  <option value="pending">⏳ 待审核</option>
                  <option value="approved">✅ 已通过</option>
                  <option value="rejected">❌ 已拒绝</option>
                </select>
              </div>
              <button @click="search()" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-sm">
                🔍 搜索
              </button>
              <button @click="handleFilterReset()" class="px-4 py-2 text-sm bg-white text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                ↺ 重置
              </button>
            </div>
          </div>

          <!-- 批量操作栏 - 选中记录时显示 -->
          <div x-show="hasSelected" x-transition class="px-4 py-3 bg-blue-50 border-b border-blue-200 flex items-center justify-between">
            <div class="flex items-center gap-2 text-sm text-blue-700">
              <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-blue-600 text-white text-xs font-bold" x-text="selectedCount"></span>
              <span>条记录已选中</span>
              <button @click="clearSelection()" class="text-blue-500 hover:text-blue-700 underline ml-2">取消选择</button>
            </div>
            <div class="flex items-center gap-2">
              <button @click="$dispatch('batch-approve-merchant', { ids: selectedRows })"
                      :disabled="$root.merchantBatchProcessing"
                      class="px-4 py-1.5 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 transition shadow-sm flex items-center gap-1">
                <span x-show="!$root.merchantBatchProcessing">✅ 批量通过</span>
                <span x-show="$root.merchantBatchProcessing">⏳ 处理中...</span>
              </button>
              <button @click="$dispatch('batch-reject-merchant', { ids: selectedRows })"
                      :disabled="$root.merchantBatchProcessing"
                      class="px-4 py-1.5 text-sm bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 transition shadow-sm flex items-center gap-1">
                <span x-show="!$root.merchantBatchProcessing">❌ 批量拒绝</span>
                <span x-show="$root.merchantBatchProcessing">⏳ 处理中...</span>
              </button>
            </div>
          </div>

          <!-- 加载状态 -->
          <div x-show="loading" class="p-12 text-center">
            <div class="inline-flex items-center gap-2 text-gray-500">
              <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
              </svg>
              <span>正在加载申请列表...</span>
            </div>
          </div>

          <!-- 错误状态 -->
          <div x-show="hasError" class="p-8 text-center">
            <div class="inline-flex flex-col items-center">
              <span class="text-4xl mb-3">⚠️</span>
              <p class="text-red-500 mb-2" x-text="error"></p>
              <button @click="loadData()" class="px-4 py-1.5 text-sm bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition">
                🔄 重新加载
              </button>
            </div>
          </div>

          <!-- 数据表格 -->
          <div x-show="hasData" class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="bg-gradient-to-r from-gray-50 to-slate-50 border-b-2 border-gray-200">
                  <!-- 全选复选框 -->
                  <th class="px-3 py-3.5 w-10">
                    <input type="checkbox" :checked="isAllSelected" :indeterminate="isPartialSelected"
                           @change="toggleSelectAll($event.target.checked)"
                           class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                           title="全选/取消全选">
                  </th>
                  <template x-for="col in columns" :key="col.key">
                    <th class="px-4 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"
                        :class="{ 'cursor-pointer hover:text-gray-700': col.sortable }"
                        @click="sort(col)">
                      <span x-text="col.label"></span>
                      <span x-show="col.sortable" class="ml-1 text-xs" x-text="getSortIcon(col)"></span>
                    </th>
                  </template>
                  <th class="px-4 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">操作</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                <template x-for="(row, idx) in data" :key="row.audit_id || idx">
                  <tr :class="{
                    'bg-yellow-50/40': row.status === 'pending',
                    'bg-blue-50/20': isSelected(row.audit_id),
                    'hover:bg-gray-50': !isSelected(row.audit_id)
                  }" class="transition-colors">
                    <!-- 行选择复选框 -->
                    <td class="px-3 py-3 w-10">
                      <input type="checkbox" :checked="isSelected(row.audit_id)"
                             @change="toggleSelect(row.audit_id)"
                             :disabled="row.status !== 'pending'"
                             :class="row.status !== 'pending' ? 'opacity-30 cursor-not-allowed' : ''"
                             class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                             :title="row.status !== 'pending' ? '仅待审核记录可选' : '选择此记录'">
                    </td>
                    <template x-for="col in columns" :key="col.key">
                      <td class="px-4 py-3 text-sm" x-html="renderCell(row, col)"></td>
                    </template>
                    <td class="px-4 py-3">
                      <div class="flex items-center gap-1">
                        <button @click="$dispatch('view-merchant-detail', row)"
                                class="px-2.5 py-1 text-xs text-blue-600 bg-blue-50 rounded-md hover:bg-blue-100 transition"
                                title="查看申请详情">
                          📋 详情
                        </button>
                        <template x-if="row.status === 'pending'">
                          <button @click="$dispatch('approve-merchant', row)"
                                  class="px-2.5 py-1 text-xs text-green-700 bg-green-50 rounded-md hover:bg-green-100 transition"
                                  title="审核通过，积分将发放给商户">
                            ✅ 通过
                          </button>
                        </template>
                        <template x-if="row.status === 'pending'">
                          <button @click="$dispatch('reject-merchant', row)"
                                  class="px-2.5 py-1 text-xs text-red-700 bg-red-50 rounded-md hover:bg-red-100 transition"
                                  title="拒绝申请，需填写拒绝原因">
                            ❌ 拒绝
                          </button>
                        </template>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>

          <!-- 空状态 -->
          <div x-show="isEmpty" class="p-12 text-center">
            <div class="inline-flex flex-col items-center">
              <span class="text-5xl mb-3">🪙</span>
              <p class="text-gray-500 font-medium">暂无商户积分申请记录</p>
              <p class="text-xs text-gray-400 mt-1">商户提交积分申请后将在此处显示</p>
            </div>
          </div>

          <!-- 分页栏 -->
          <template x-if="total_pages > 1">
            <div class="p-4 border-t bg-gray-50/50 flex justify-between items-center">
              <span class="text-sm text-gray-500" x-text="paginationInfo"></span>
              <div class="flex space-x-1">
                <button @click="prevPage()" :disabled="!hasPrevPage"
                        class="px-3 py-1.5 text-sm border rounded-lg disabled:opacity-40 hover:bg-white transition">‹ 上一页</button>
                <template x-for="p in visiblePages" :key="'mp'+p">
                  <button @click="goToPage(p)"
                          :class="p === current_page ? 'bg-blue-600 text-white border-blue-600' : 'hover:bg-white'"
                          class="px-3 py-1.5 text-sm border rounded-lg transition" :disabled="p === '...'" x-text="p"></button>
                </template>
                <button @click="nextPage()" :disabled="!hasNextPage"
                        class="px-3 py-1.5 text-sm border rounded-lg disabled:opacity-40 hover:bg-white transition">下一页 ›</button>
              </div>
            </div>
          </template>

          <!-- 最后更新时间 -->
          <div x-show="lastUpdateTime" class="px-4 py-2 text-xs text-gray-400 text-right border-t bg-gray-50/30">
            最后更新: <span x-text="lastUpdateTime"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- 欠账管理 - 适配后端 debt-management API -->
    <div x-show="current_page === 'debt-management'" x-cloak>
      <!-- 统计卡片 - 使用统一 stats-card 组件 -->
      <div class="stats-grid stats-grid-4 mb-6">
        <div class="stats-card stats-danger stats-card-animate">
          <div class="flex items-center justify-between">
            <div>
              <p class="stats-card-label">库存欠账数</p>
              <p class="stats-card-value text-red-600" x-text="debtStats?.total_inventory_debt || 0"></p>
            </div>
            <div class="stats-card-icon bg-gradient-to-br from-red-100 to-red-200 text-red-600">📦</div>
          </div>
          <p class="text-xs themed-text-muted mt-2">奖品库存欠账待补充</p>
        </div>
        <div class="stats-card stats-warning stats-card-animate">
          <div class="flex items-center justify-between">
            <div>
              <p class="stats-card-label">预算欠账额</p>
              <p class="stats-card-value text-orange-600" x-text="formatAmount(debtStats?.total_budget_debt || 0)"></p>
            </div>
            <div class="stats-card-icon bg-gradient-to-br from-orange-100 to-orange-200 text-orange-600">💸</div>
          </div>
          <p class="text-xs themed-text-muted mt-2">预算超支待冲销金额</p>
        </div>
        <div class="stats-card stats-warning stats-card-animate" style="border-left-color: #eab308;">
          <div class="flex items-center justify-between">
            <div>
              <p class="stats-card-label">待处理</p>
              <p class="stats-card-value text-yellow-600" x-text="debtStats?.pending_count || 0"></p>
            </div>
            <div class="stats-card-icon bg-gradient-to-br from-yellow-100 to-yellow-200 text-yellow-600">⏳</div>
          </div>
          <p class="text-xs themed-text-muted mt-2">等待运营处理的欠账</p>
        </div>
        <div class="stats-card stats-success stats-card-animate">
          <div class="flex items-center justify-between">
            <div>
              <p class="stats-card-label">今日清偿</p>
              <p class="stats-card-value text-green-600" x-text="debtStats?.cleared_today || 0"></p>
            </div>
            <div class="stats-card-icon bg-gradient-to-br from-green-100 to-green-200 text-green-600">✅</div>
          </div>
          <p class="text-xs themed-text-muted mt-2">今日已完成清偿的记录</p>
        </div>
      </div>

      <div class="themed-card rounded-xl shadow-sm border overflow-hidden">
        <div class="px-5 py-4 bg-gradient-to-r from-slate-50 to-white border-b flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center text-base">💳</span>
            <div>
              <h5 class="font-semibold text-gray-800">待冲销欠账列表</h5>
              <p class="text-xs text-gray-400 mt-0.5">管理库存欠账和预算欠账，执行清偿操作</p>
            </div>
          </div>
        </div>
        <!-- data-table: 债务列表 -->
        <div x-data="debtDataTable()" x-init="init()">
          <div class="p-4 border-b bg-gray-50/50">
            <div class="flex flex-wrap items-center gap-3">
              <div class="flex-1 min-w-[160px] max-w-[200px]">
                <select x-model="activeFilters.debt_type" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-400 bg-white">
                  <option value="">全部类型</option>
                  <option value="inventory">📦 库存欠账</option>
                  <option value="budget">💸 预算欠账</option>
                </select>
              </div>
              <div class="flex-1 min-w-[160px] max-w-[200px]">
                <input type="text" x-model="activeFilters.campaign_id" placeholder="输入活动ID" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-400">
              </div>
              <button @click="search()" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-sm">🔍 搜索</button>
              <button @click="handleFilterReset()" class="px-4 py-2 text-sm bg-white text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition">↺ 重置</button>
            </div>
          </div>
          <div x-show="loading" class="p-8 text-center themed-text-muted">加载中...</div>
          <div x-show="hasError" class="p-8 text-center">
            <p class="text-red-500 mb-2" x-text="error"></p>
            <button @click="loadData()" class="text-sm themed-text-primary hover:underline">🔄 重试</button>
          </div>
          <div x-show="hasData" class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="bg-gradient-to-r from-gray-50 to-slate-50 border-b-2 border-gray-200">
                  <template x-for="col in columns" :key="col.key">
                    <th class="px-4 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"
                        :class="{ 'cursor-pointer hover:text-gray-700': col.sortable }"
                        @click="sort(col)">
                      <span x-text="col.label"></span>
                      <span x-show="col.sortable" class="ml-1 text-xs" x-text="getSortIcon(col)"></span>
                    </th>
                  </template>
                  <th class="px-4 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">操作</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                <template x-for="(row, idx) in data" :key="row.debt_id || idx">
                  <tr class="hover:bg-gray-50 transition-colors">
                    <template x-for="col in columns" :key="col.key">
                      <td class="px-4 py-3 text-sm" x-html="renderCell(row, col)"></td>
                    </template>
                    <td class="px-4 py-3">
                      <div class="flex items-center gap-1">
                        <button @click="$dispatch('view-debt-detail', row)" class="px-2.5 py-1 text-xs text-blue-600 bg-blue-50 rounded-md hover:bg-blue-100 transition font-medium">📋 详情</button>
                        <button @click="$dispatch('open-repay', row)" class="px-2.5 py-1 text-xs text-green-700 bg-green-50 rounded-md hover:bg-green-100 transition font-medium">💵 清偿</button>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <div x-show="isEmpty" class="p-12 text-center">
            <div class="inline-flex flex-col items-center">
              <span class="text-5xl mb-3">✅</span>
              <p class="text-gray-500 font-medium">暂无待冲销欠账</p>
              <p class="text-xs text-gray-400 mt-1">所有欠账已清偿或暂无新增欠账记录</p>
            </div>
          </div>
          <template x-if="total_pages > 1">
            <div class="p-4 border-t flex justify-between items-center">
              <span class="text-sm themed-text-muted" x-text="paginationInfo"></span>
              <div class="flex space-x-1">
                <button @click="prevPage()" :disabled="!hasPrevPage" class="px-3 py-1 text-sm border rounded disabled:opacity-50 themed-hover-bg">‹</button>
                <template x-for="p in visiblePages" :key="'dt'+p">
                  <button @click="goToPage(p)" :class="p === current_page ? 'themed-bg-primary text-white' : 'themed-hover-bg'" class="px-3 py-1 text-sm border rounded" :disabled="p === '...'" x-text="p"></button>
                </template>
                <button @click="nextPage()" :disabled="!hasNextPage" class="px-3 py-1 text-sm border rounded disabled:opacity-50 themed-hover-bg">›</button>
              </div>
            </div>
          </template>
          <div x-show="lastUpdateTime" class="px-4 py-2 text-xs themed-text-muted text-right border-t">
            最后更新: <span x-text="lastUpdateTime"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- 活动预算管理 -->
    <div x-show="current_page === 'campaign-budget'" x-cloak>
      <!-- 预算统计卡片 - 使用统一 stats-card 组件 -->
      <div class="stats-grid stats-grid-4 mb-6">
        <div class="stats-card stats-primary stats-card-animate">
          <div class="flex items-center justify-between">
            <div>
              <p class="stats-card-label">总预算</p>
              <p class="stats-card-value themed-text-primary" x-text="budgetStats?.total_budget || 0"></p>
            </div>
            <div class="stats-card-icon bg-gradient-to-br from-blue-100 to-blue-200 text-blue-600">🏦</div>
          </div>
          <p class="text-xs themed-text-muted mt-2">所有活动的预算总额</p>
        </div>
        <div class="stats-card stats-warning stats-card-animate">
          <div class="flex items-center justify-between">
            <div>
              <p class="stats-card-label">已使用</p>
              <p class="stats-card-value text-orange-600" x-text="budgetStats?.used_budget || 0"></p>
            </div>
            <div class="stats-card-icon bg-gradient-to-br from-orange-100 to-orange-200 text-orange-600">📊</div>
          </div>
          <p class="text-xs themed-text-muted mt-2">已消耗的预算额度</p>
        </div>
        <div class="stats-card stats-success stats-card-animate">
          <div class="flex items-center justify-between">
            <div>
              <p class="stats-card-label">剩余预算</p>
              <p class="stats-card-value text-green-600" x-text="budgetStats?.remaining_budget || 0"></p>
            </div>
            <div class="stats-card-icon bg-gradient-to-br from-green-100 to-green-200 text-green-600">💰</div>
          </div>
          <p class="text-xs themed-text-muted mt-2">当前可用预算余额</p>
        </div>
        <div class="stats-card stats-card-animate" :class="(budgetStats?.utilization_rate || 0) > 80 ? 'stats-danger' : 'stats-success'">
          <div class="flex items-center justify-between">
            <div>
              <p class="stats-card-label">使用率</p>
              <p class="stats-card-value" :class="(budgetStats?.utilization_rate || 0) > 80 ? 'text-red-600' : 'text-green-600'" x-text="(budgetStats?.utilization_rate || 0) + '%'"></p>
            </div>
            <div class="stats-card-icon" :class="(budgetStats?.utilization_rate || 0) > 80 ? 'bg-gradient-to-br from-red-100 to-red-200 text-red-600' : 'bg-gradient-to-br from-green-100 to-green-200 text-green-600'">
              <span x-text="(budgetStats?.utilization_rate || 0) > 80 ? '⚠️' : '📈'"></span>
            </div>
          </div>
          <p class="text-xs themed-text-muted mt-2">
            <span x-show="(budgetStats?.utilization_rate || 0) > 80" class="text-red-500">预算即将耗尽，请关注</span>
            <span x-show="(budgetStats?.utilization_rate || 0) <= 80">预算使用比例正常</span>
          </p>
        </div>
      </div>

      <div class="themed-card rounded-xl shadow-sm border overflow-hidden">
        <div class="px-5 py-4 bg-gradient-to-r from-slate-50 to-white border-b flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center text-base">📊</span>
            <div>
              <h5 class="font-semibold text-gray-800">活动预算列表</h5>
              <p class="text-xs text-gray-400 mt-0.5">查看各活动预算使用情况，调整预算配置</p>
            </div>
          </div>
        </div>
        <!-- data-table: 活动预算列表 -->
        <div x-data="budgetDataTable()" x-init="init()">
          <div class="p-4 border-b bg-gray-50/50">
            <div class="flex flex-wrap items-center gap-3">
              <div class="flex-1 min-w-[140px] max-w-[180px]">
                <input type="text" x-model="activeFilters.lottery_campaign_id" placeholder="输入活动ID" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-400">
              </div>
              <div class="flex-1 min-w-[160px] max-w-[220px]">
                <input type="text" x-model="activeFilters.keyword" placeholder="活动名称关键词" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-400">
              </div>
              <div class="flex-1 min-w-[140px] max-w-[160px]">
                <select x-model="activeFilters.status" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-400 bg-white">
                  <option value="">全部状态</option>
                  <option value="active">🟢 运行中</option>
                  <option value="exhausted">🔴 已耗尽</option>
                </select>
              </div>
              <button @click="search()" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-sm">🔍 搜索</button>
              <button @click="handleFilterReset()" class="px-4 py-2 text-sm bg-white text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition">↺ 重置</button>
            </div>
          </div>
          <div x-show="loading" class="p-8 text-center themed-text-muted">加载中...</div>
          <div x-show="hasError" class="p-8 text-center">
            <p class="text-red-500 mb-2" x-text="error"></p>
            <button @click="loadData()" class="text-sm themed-text-primary hover:underline">🔄 重试</button>
          </div>
          <div x-show="hasData" class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="bg-gradient-to-r from-gray-50 to-slate-50 border-b-2 border-gray-200">
                  <template x-for="col in columns" :key="col.key">
                    <th class="px-4 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"
                        :class="{ 'cursor-pointer hover:text-gray-700': col.sortable }"
                        @click="sort(col)">
                      <span x-text="col.label"></span>
                      <span x-show="col.sortable" class="ml-1 text-xs" x-text="getSortIcon(col)"></span>
                    </th>
                  </template>
                  <th class="px-4 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">操作</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                <template x-for="(row, idx) in data" :key="row.budget_id || idx">
                  <tr class="hover:bg-gray-50 transition-colors">
                    <template x-for="col in columns" :key="col.key">
                      <td class="px-4 py-3 text-sm" x-html="renderCell(row, col)"></td>
                    </template>
                    <td class="px-4 py-3">
                      <div class="flex items-center gap-1">
                        <button @click="$dispatch('view-budget-detail', row)" class="px-2.5 py-1 text-xs text-blue-600 bg-blue-50 rounded-md hover:bg-blue-100 transition font-medium">📋 详情</button>
                        <button @click="$dispatch('open-edit-budget', row)" class="px-2.5 py-1 text-xs text-green-700 bg-green-50 rounded-md hover:bg-green-100 transition font-medium">✏️ 编辑</button>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <div x-show="isEmpty" class="p-12 text-center">
            <div class="inline-flex flex-col items-center">
              <span class="text-5xl mb-3">📊</span>
              <p class="text-gray-500 font-medium">暂无活动预算数据</p>
              <p class="text-xs text-gray-400 mt-1">创建抽奖活动后，预算信息将在此处展示</p>
            </div>
          </div>
          <template x-if="total_pages > 1">
            <div class="p-4 border-t flex justify-between items-center">
              <span class="text-sm themed-text-muted" x-text="paginationInfo"></span>
              <div class="flex space-x-1">
                <button @click="prevPage()" :disabled="!hasPrevPage" class="px-3 py-1 text-sm border rounded disabled:opacity-50 themed-hover-bg">‹</button>
                <template x-for="p in visiblePages" :key="'bg'+p">
                  <button @click="goToPage(p)" :class="p === current_page ? 'themed-bg-primary text-white' : 'themed-hover-bg'" class="px-3 py-1 text-sm border rounded" :disabled="p === '...'" x-text="p"></button>
                </template>
                <button @click="nextPage()" :disabled="!hasNextPage" class="px-3 py-1 text-sm border rounded disabled:opacity-50 themed-hover-bg">›</button>
              </div>
            </div>
          </template>
          <div x-show="lastUpdateTime" class="px-4 py-2 text-xs themed-text-muted text-right border-t">
            最后更新: <span x-text="lastUpdateTime"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- 商户日志 -->
    <div x-show="current_page === 'merchant-logs'" x-cloak>
      <div class="themed-card rounded-xl shadow-sm border overflow-hidden">
        <div class="px-5 py-4 bg-gradient-to-r from-slate-50 to-white border-b flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center text-base">📝</span>
            <div>
              <h5 class="font-semibold text-gray-800">商户操作日志</h5>
              <p class="text-xs text-gray-400 mt-0.5">追踪商户端所有操作记录，包括扫码、消费提交、员工管理等</p>
            </div>
          </div>
        </div>
        <!-- data-table: 商户操作日志 -->
        <div x-data="merchantLogsDataTable()" x-init="init()">
          <div class="p-4 border-b bg-gray-50/50">
            <div class="flex flex-wrap items-center gap-3">
              <div class="flex-1 min-w-[160px] max-w-[200px]">
                <label class="block text-xs font-medium text-gray-500 mb-1">操作人手机号</label>
                <input type="text" x-model="activeFilters.operator_mobile" placeholder="输入手机号" maxlength="11" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-400">
              </div>
              <div class="flex-1 min-w-[180px] max-w-[220px]">
                <label class="block text-xs font-medium text-gray-500 mb-1">操作类型</label>
                <select x-model="activeFilters.operation_type" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-400 bg-white">
                  <option value="">全部操作类型</option>
                  <optgroup label="消费相关">
                    <option value="scan_user">📱 扫码获取用户信息</option>
                    <option value="submit_consumption">💰 提交消费记录</option>
                    <option value="view_consumption_list">📋 查看消费记录列表</option>
                    <option value="view_consumption_detail">🔍 查看消费记录详情</option>
                  </optgroup>
                  <optgroup label="员工管理">
                    <option value="staff_login">🔑 员工登录</option>
                    <option value="staff_logout">🚪 员工登出</option>
                    <option value="staff_add">➕ 员工入职</option>
                    <option value="staff_transfer">🔄 员工调店</option>
                    <option value="staff_disable">🚫 员工禁用</option>
                    <option value="staff_enable">✅ 员工启用</option>
                  </optgroup>
                </select>
              </div>
              <div class="flex-1 min-w-[260px] max-w-[320px]">
                <label class="block text-xs font-medium text-gray-500 mb-1">时间范围</label>
                <div class="flex items-center gap-1">
                  <input type="date" x-model="activeFilters.start_time" class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-400" title="开始日期">
                  <span class="text-gray-400 text-sm">至</span>
                  <input type="date" x-model="activeFilters.end_time" class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-400" title="结束日期">
                </div>
              </div>
              <div class="flex items-end gap-2 pt-5">
                <button @click="search()" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-sm">🔍 搜索</button>
                <button @click="handleFilterReset()" class="px-4 py-2 text-sm bg-white text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition">↺ 重置</button>
              </div>
            </div>
          </div>
          <div x-show="loading" class="p-8 text-center themed-text-muted">加载中...</div>
          <div x-show="hasError" class="p-8 text-center">
            <p class="text-red-500 mb-2" x-text="error"></p>
            <button @click="loadData()" class="text-sm themed-text-primary hover:underline">🔄 重试</button>
          </div>
          <div x-show="hasData" class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="bg-gradient-to-r from-gray-50 to-slate-50 border-b-2 border-gray-200">
                  <template x-for="col in columns" :key="col.key">
                    <th class="px-4 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"
                        :class="{ 'cursor-pointer hover:text-gray-700': col.sortable }"
                        @click="sort(col)">
                      <span x-text="col.label"></span>
                      <span x-show="col.sortable" class="ml-1 text-xs" x-text="getSortIcon(col)"></span>
                    </th>
                  </template>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                <template x-for="(row, idx) in data" :key="row.id || idx">
                  <tr class="hover:bg-gray-50 transition-colors">
                    <template x-for="col in columns" :key="col.key">
                      <td class="px-4 py-3 text-sm" x-html="renderCell(row, col)"></td>
                    </template>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <div x-show="isEmpty" class="p-12 text-center">
            <div class="inline-flex flex-col items-center">
              <span class="text-5xl mb-3">📝</span>
              <p class="text-gray-500 font-medium">暂无商户操作日志</p>
              <p class="text-xs text-gray-400 mt-1">商户端操作记录将在此处自动记录</p>
            </div>
          </div>
          <template x-if="total_pages > 1">
            <div class="p-4 border-t flex justify-between items-center">
              <span class="text-sm themed-text-muted" x-text="paginationInfo"></span>
              <div class="flex space-x-1">
                <button @click="prevPage()" :disabled="!hasPrevPage" class="px-3 py-1 text-sm border rounded disabled:opacity-50 themed-hover-bg">‹</button>
                <template x-for="p in visiblePages" :key="'ml'+p">
                  <button @click="goToPage(p)" :class="p === current_page ? 'themed-bg-primary text-white' : 'themed-hover-bg'" class="px-3 py-1 text-sm border rounded" :disabled="p === '...'" x-text="p"></button>
                </template>
                <button @click="nextPage()" :disabled="!hasNextPage" class="px-3 py-1 text-sm border rounded disabled:opacity-50 themed-hover-bg">›</button>
              </div>
            </div>
          </template>
          <div x-show="lastUpdateTime" class="px-4 py-2 text-xs themed-text-muted text-right border-t">
            最后更新: <span x-text="lastUpdateTime"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== Modal 区域 ==================== -->

    <!-- 1. 消费记录详情 Modal -->
    <div x-ref="consumptionDetailModal" 
         x-show="isModalOpen('consumptionDetailModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('consumptionDetailModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-md mx-4 z-10">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold">📋 消费记录详情</h5>
          <button @click="hideModal('consumptionDetailModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <div class="p-6" x-show="selectedConsumption">
          <div class="space-y-3">
            <div class="flex justify-between border-b pb-2">
              <span class="themed-text-muted">记录ID</span>
              <span class="font-mono" x-text="selectedConsumption?.record_id"></span>
            </div>
            <div class="flex justify-between border-b pb-2">
              <span class="themed-text-muted">用户</span>
              <span x-text="selectedConsumption?.user_name || selectedConsumption?.user_id"></span>
            </div>
            <div class="flex justify-between border-b pb-2">
              <span class="themed-text-muted">门店</span>
              <span x-text="selectedConsumption?.store_name"></span>
            </div>
            <div class="flex justify-between border-b pb-2">
              <span class="themed-text-muted">金额</span>
              <span class="font-mono text-lg" x-text="'¥' + (selectedConsumption?.amount / 100).toFixed(2)"></span>
            </div>
            <div class="flex justify-between border-b pb-2">
              <span class="themed-text-muted">状态</span>
              <span class="px-2 py-1 text-xs rounded" :class="getConsumptionStatusClass(selectedConsumption?.status)" x-text="selectedConsumption?.status_display || selectedConsumption?.status"></span>
            </div>
            <div class="flex justify-between border-b pb-2">
              <span class="themed-text-muted">提交时间</span>
              <span x-text="formatDateOnly(selectedConsumption?.created_at)"></span>
            </div>
            <div x-show="selectedConsumption?.remark">
              <span class="themed-text-muted block mb-1">备注</span>
              <p class="themed-text themed-bg-base p-2 rounded" x-text="selectedConsumption?.remark"></p>
            </div>
          </div>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-2">
          <button type="button" @click="hideModal('consumptionDetailModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">关闭</button>
          <template x-if="selectedConsumption?.status === 'pending'">
            <div class="flex space-x-2">
              <button type="button" @click="approveConsumption(selectedConsumption); hideModal('consumptionDetailModal')" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">✓ 通过</button>
              <button type="button" @click="showRejectModal(selectedConsumption)" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">✕ 拒绝</button>
            </div>
          </template>
        </div>
      </div>
    </div>

    <!-- 2. 拒绝原因 Modal（单条拒绝） -->
    <div x-ref="rejectModal" 
         x-show="isModalOpen('rejectModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('rejectModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-sm mx-4 z-10">
        <div class="p-4 border-b flex justify-between items-center bg-red-50">
          <h5 class="font-semibold text-red-600">⚠️ 拒绝审核</h5>
          <button @click="hideModal('rejectModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <form @submit.prevent="confirmReject()">
          <div class="p-6 space-y-4">
            <div class="bg-red-50 rounded-lg p-3 text-sm">
              <p class="text-red-700">将拒绝记录 <span class="font-mono font-bold" x-text="'#' + (selectedConsumption?.record_id || '')"></span> 的审核</p>
              <p class="text-red-500 text-xs mt-1">拒绝后用户将不会获得积分奖励</p>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">拒绝原因 <span class="text-red-500">*</span></label>
              <textarea x-model="rejectForm.reason" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" rows="3" required placeholder="请输入拒绝原因（至少5个字符）..." minlength="5"></textarea>
              <p class="text-xs themed-text-muted mt-1" x-text="(rejectForm.reason?.length || 0) + '/5 最少字符'"></p>
            </div>
          </div>
          <div class="p-4 border-t bg-gray-50 rounded-b-lg flex justify-end space-x-2">
            <button type="button" @click="hideModal('rejectModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded-lg hover:bg-gray-300 text-sm">取消</button>
            <button type="submit" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm font-medium" :disabled="saving || (rejectForm.reason?.length || 0) < 5">
              <span x-show="saving" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-1"></span>
              确认拒绝
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 2b. 批量拒绝原因 Modal -->
    <div x-ref="batchRejectModal" 
         x-show="isModalOpen('batchRejectModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('batchRejectModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-md mx-4 z-10">
        <div class="p-4 border-b flex justify-between items-center bg-red-50">
          <h5 class="font-semibold text-red-600">⚠️ 批量拒绝审核</h5>
          <button @click="hideModal('batchRejectModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <form @submit.prevent="confirmBatchReject()">
          <div class="p-6 space-y-4">
            <div class="bg-red-50 rounded-lg p-4">
              <div class="flex items-center gap-3">
                <span class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center text-xl">✕</span>
                <div>
                  <p class="text-red-800 font-medium">即将拒绝 <span class="text-lg font-bold" x-text="selectedIds.length"></span> 条消费记录</p>
                  <p class="text-red-500 text-xs mt-0.5">拒绝后相关用户将不会获得积分奖励</p>
                </div>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">拒绝原因 <span class="text-red-500">*</span></label>
              <textarea x-model="batchRejectReason" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" rows="3" required placeholder="请输入统一的拒绝原因（至少5个字符）..." minlength="5"></textarea>
              <p class="text-xs themed-text-muted mt-1" x-text="(batchRejectReason?.length || 0) + '/5 最少字符'"></p>
            </div>
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-xs text-yellow-700">
              <p class="font-medium">提示：此操作不可撤销</p>
              <p class="mt-0.5">所有选中的记录将使用相同的拒绝原因</p>
            </div>
          </div>
          <div class="p-4 border-t bg-gray-50 rounded-b-lg flex justify-end space-x-2">
            <button type="button" @click="hideModal('batchRejectModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded-lg hover:bg-gray-300 text-sm">取消</button>
            <button type="submit" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm font-medium" :disabled="batchProcessing || (batchRejectReason?.length || 0) < 5">
              <span x-show="batchProcessing" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-1"></span>
              确认批量拒绝 (<span x-text="selectedIds.length"></span>条)
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 3. 欠账详情 Modal - 适配后端 debt-management 结构 -->
    <div x-ref="debtDetailModal" 
         x-show="isModalOpen('debtDetailModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('debtDetailModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-lg mx-4 z-10 max-h-[90vh] overflow-y-auto">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 themed-card">
          <h5 class="font-semibold">💳 欠账详情</h5>
          <button @click="hideModal('debtDetailModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <div class="p-6" x-show="selectedDebt">
          <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-red-50 rounded-lg p-4 text-center">
              <p class="text-sm themed-text-muted">欠账数量/金额</p>
              <p class="text-2xl font-bold text-red-600" x-text="selectedDebt?.owed_quantity || selectedDebt?.owed_amount || 0"></p>
            </div>
            <div class="themed-bg-primary-light rounded-lg p-4 text-center">
              <p class="text-sm themed-text-muted">欠账类型</p>
              <p class="text-lg font-bold themed-text-primary" x-text="selectedDebt?.debt_type === 'inventory' ? '库存欠账' : '预算欠账'"></p>
            </div>
          </div>
          <div class="space-y-3">
            <div class="flex justify-between border-b pb-2">
              <span class="themed-text-muted">欠账ID</span>
              <span class="font-mono" x-text="selectedDebt?.debt_id || selectedDebt?.id"></span>
            </div>
            <div class="flex justify-between border-b pb-2">
              <span class="themed-text-muted">活动</span>
              <span x-text="selectedDebt?.campaign_name || ('ID: ' + (selectedDebt?.campaign_id || '-'))"></span>
            </div>
            <div class="flex justify-between border-b pb-2">
              <span class="themed-text-muted">奖品</span>
              <span x-text="selectedDebt?.prize_name || ('ID: ' + (selectedDebt?.prize_id || '-'))"></span>
            </div>
            <div class="flex justify-between border-b pb-2">
              <span class="themed-text-muted">创建时间</span>
              <span x-text="formatDateTimeShort(selectedDebt?.created_at)"></span>
            </div>
          </div>
          <div class="mt-6" x-show="selectedDebt?.clear_records?.length > 0">
            <h6 class="font-medium mb-3">清偿记录</h6>
            <div class="space-y-2">
              <template x-for="record in selectedDebt?.clear_records || []" :key="record.record_id">
                <div class="bg-green-50/50 border border-green-100 rounded-lg p-3 flex justify-between items-center">
                  <div>
                    <span class="font-mono text-green-600 font-medium" x-text="'¥' + Number(record.amount || 0).toFixed(2)"></span>
                    <span class="themed-text-muted text-sm ml-2" x-text="formatDateOnly(record.created_at)"></span>
                  </div>
                  <span class="text-gray-400 text-sm" x-text="record.remark || ''"></span>
                </div>
              </template>
            </div>
          </div>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-2 sticky bottom-0">
          <button type="button" @click="hideModal('debtDetailModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">关闭</button>
          <button type="button" @click="openRepayModal(selectedDebt)" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">💵 执行清偿</button>
        </div>
      </div>
    </div>

    <!-- 4. 欠账清偿 Modal - 适配后端 /clear 接口 -->
    <div x-ref="debtRepayModal" 
         x-show="isModalOpen('debtRepayModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('debtRepayModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-md mx-4 z-10">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold">💵 欠账清偿</h5>
          <button @click="hideModal('debtRepayModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <form @submit.prevent="submitDebtRepay()">
          <div class="p-6 space-y-4">
            <!-- 欠账信息 -->
            <div class="themed-bg-base rounded p-3">
              <div class="grid grid-cols-2 gap-2 text-sm">
                <div>
                  <span class="themed-text-muted">欠账ID:</span>
                  <span class="font-mono" x-text="debtRepayForm.debt_id"></span>
                </div>
                <div>
                  <span class="themed-text-muted">类型:</span>
                  <span x-text="debtRepayForm.debt_type === 'inventory' ? '库存欠账' : '预算欠账'"></span>
                </div>
              </div>
            </div>
            <div class="bg-red-50 rounded p-3 text-center">
              <p class="text-sm themed-text-muted">待清偿数量/金额</p>
              <p class="text-xl font-bold text-red-600" x-text="debtRepayForm.amount || 0"></p>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">清偿数量/金额 <span class="text-red-500">*</span></label>
              <input type="number" x-model.number="debtRepayForm.amount" step="1" min="1" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-green-500" required>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">备注</label>
              <input type="text" x-model="debtRepayForm.remark" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-green-500" placeholder="清偿备注...">
            </div>
          </div>
          <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-2">
            <button type="button" @click="hideModal('debtRepayModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">取消</button>
            <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600" :disabled="saving">
              <span x-show="saving" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-1"></span>
              确认清偿
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 5. 调整钻石 Modal -->
    <div x-ref="diamondAdjustModal" 
         x-show="isModalOpen('diamondAdjustModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('diamondAdjustModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-md mx-4 z-10">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold">💎 调整用户钻石</h5>
          <button @click="hideModal('diamondAdjustModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <form @submit.prevent="submitDiamondAdjust()">
          <div class="p-6 space-y-4">
            <!-- 手机号输入 -->
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">手机号 <span class="text-red-500">*</span></label>
              <input 
                type="text" 
                x-model="diamondAdjustForm.mobile" 
                class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" 
                required
                maxlength="11"
                placeholder="请输入手机号"
              >
              <template x-if="resolvedUser">
                <p class="mt-1 text-xs text-green-600">✅ <span x-text="resolvedUser.nickname"></span> (<span x-text="resolvedUser.mobile"></span>)</p>
              </template>
              <template x-if="resolveError">
                <p class="mt-1 text-xs text-red-500" x-text="resolveError"></p>
              </template>
            </div>

            <!-- 当前余额显示（如有） -->
            <div x-show="selectedDiamondAccount?.balance !== undefined" class="themed-bg-primary-light rounded p-3 text-center">
              <p class="text-sm themed-text-muted">当前钻石余额</p>
              <p class="text-xl font-bold themed-text-primary" x-text="formatNumber(selectedDiamondAccount?.balance || 0)"></p>
            </div>

            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">调整类型</label>
              <select x-model="diamondAdjustForm.type" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500">
                <option value="add">➕ 增加钻石</option>
                <option value="subtract">➖ 扣除钻石</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">调整数量 <span class="text-red-500">*</span></label>
              <input 
                type="number" 
                x-model.number="diamondAdjustForm.amount" 
                min="1" 
                class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" 
                required
                placeholder="请输入调整数量"
              >
            </div>

            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">调整原因 <span class="text-red-500">*</span></label>
              <textarea 
                x-model="diamondAdjustForm.reason" 
                class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500" 
                rows="2" 
                required
                placeholder="请输入调整原因（如：客服补偿、数据修正等）"
              ></textarea>
            </div>

            <!-- 预览 -->
            <div class="themed-bg-base rounded p-3 text-sm">
              <p class="themed-text-muted">
                <span x-show="diamondAdjustForm.type === 'add'">将为用户 <span class="font-mono" x-text="diamondAdjustForm.mobile || '?'"></span> <span class="text-green-600 font-medium">增加</span></span>
                <span x-show="diamondAdjustForm.type === 'subtract'">将为用户 <span class="font-mono" x-text="diamondAdjustForm.mobile || '?'"></span> <span class="text-red-600 font-medium">扣除</span></span>
                <span class="font-bold" x-text="diamondAdjustForm.amount || 0"></span> 钻石
              </p>
            </div>
          </div>
          <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-2">
            <button type="button" @click="hideModal('diamondAdjustModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">取消</button>
            <button type="submit" class="px-4 py-2 themed-bg-primary text-white rounded themed-hover-primary" :disabled="saving">
              <span x-show="saving" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-1"></span>
              确认调整
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 6. 钻石账户详情 Modal（含流水记录） -->
    <div x-ref="diamondDetailModal" 
         x-show="isModalOpen('diamondDetailModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" @click="hideModal('diamondDetailModal')"></div>
      <div class="relative themed-card rounded-xl shadow-2xl w-full max-w-3xl mx-4 z-10 max-h-[90vh] overflow-hidden flex flex-col">
        <!-- 渐变色标题栏 -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-700 px-6 py-4 flex justify-between items-center">
          <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-white/20 rounded-lg flex items-center justify-center text-lg">💎</div>
            <div>
              <h5 class="font-semibold text-white text-lg">钻石账户详情</h5>
              <p class="text-blue-100 text-xs" x-text="'用户 #' + (selectedDiamondAccount?.user_id || '') + ' · ' + (selectedDiamondAccount?.mobile || '')"></p>
            </div>
          </div>
          <button @click="hideModal('diamondDetailModal')" class="text-white/70 hover:text-white text-xl transition-colors">✕</button>
        </div>

        <div class="flex-1 overflow-y-auto">
          <div x-show="selectedDiamondAccount">
            <!-- 账户概览 - 带彩色边框和图标 -->
            <div class="px-6 py-4 bg-gradient-to-b from-gray-50 to-white">
              <div class="grid grid-cols-3 gap-4">
                <div class="themed-card rounded-xl p-4 border border-blue-100 bg-blue-50/50">
                  <div class="flex items-center gap-2 mb-2">
                    <span class="w-7 h-7 bg-blue-100 rounded-md flex items-center justify-center text-sm">👤</span>
                    <span class="text-xs themed-text-muted font-medium">用户ID</span>
                  </div>
                  <p class="text-2xl font-bold themed-text-primary tabular-nums" x-text="selectedDiamondAccount?.user_id || '-'"></p>
                  <p class="text-xs themed-text-muted mt-1" x-text="selectedDiamondAccount?.nickname || '昵称未设置'"></p>
                </div>
                <div class="themed-card rounded-xl p-4 border border-green-100 bg-green-50/50">
                  <div class="flex items-center gap-2 mb-2">
                    <span class="w-7 h-7 bg-green-100 rounded-md flex items-center justify-center text-sm">💎</span>
                    <span class="text-xs themed-text-muted font-medium">可用余额</span>
                  </div>
                  <p class="text-2xl font-bold text-green-600 tabular-nums" x-text="formatNumber(selectedDiamondAccount?.balance || 0)"></p>
                  <p class="text-xs text-green-500 mt-1">可自由使用</p>
                </div>
                <div class="themed-card rounded-xl p-4 border border-yellow-100 bg-yellow-50/50">
                  <div class="flex items-center gap-2 mb-2">
                    <span class="w-7 h-7 bg-yellow-100 rounded-md flex items-center justify-center text-sm">🔒</span>
                    <span class="text-xs themed-text-muted font-medium">冻结余额</span>
                  </div>
                  <p class="text-2xl font-bold text-yellow-600 tabular-nums" x-text="formatNumber(selectedDiamondAccount?.frozen || 0)"></p>
                  <p class="text-xs text-yellow-500 mt-1">交易中暂时冻结</p>
                </div>
              </div>
            </div>

            <!-- 流水记录区域 -->
            <div class="px-6 py-4">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                  <span class="w-1 h-5 bg-blue-500 rounded-full"></span>
                  <h6 class="font-semibold text-sm themed-text">最近交易流水</h6>
                  <span class="text-xs bg-gray-100 themed-text-muted px-2 py-0.5 rounded-full" 
                        x-text="(selectedDiamondAccount?.transactions?.length || 0) + '条'"></span>
                </div>
              </div>

              <template x-if="selectedDiamondAccount?.transactions?.length > 0">
                <div class="rounded-lg border overflow-hidden">
                  <table class="w-full text-sm">
                    <thead>
                      <tr class="bg-gray-50 border-b">
                        <th class="px-4 py-2.5 text-left text-xs font-semibold themed-text-muted">时间</th>
                        <th class="px-4 py-2.5 text-left text-xs font-semibold themed-text-muted">交易类型</th>
                        <th class="px-4 py-2.5 text-right text-xs font-semibold themed-text-muted">变动数量</th>
                        <th class="px-4 py-2.5 text-right text-xs font-semibold themed-text-muted">变动后余额</th>
                        <th class="px-4 py-2.5 text-left text-xs font-semibold themed-text-muted">说明</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                      <template x-for="tx in selectedDiamondAccount.transactions" :key="tx.asset_transaction_id">
                        <tr class="hover:bg-gray-50/80 transition-colors">
                          <td class="px-4 py-2.5 text-xs themed-text-muted whitespace-nowrap" x-text="formatDateTimeShort(tx.created_at)"></td>
                          <td class="px-4 py-2.5">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium"
                                  :class="tx.delta_amount > 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'"
                                  x-text="tx.tx_type_display || tx.tx_type || '-'"></span>
                          </td>
                          <td class="px-4 py-2.5 text-right">
                            <span class="font-mono font-semibold text-sm"
                                  :class="tx.delta_amount > 0 ? 'text-green-600' : 'text-red-500'"
                                  x-text="(tx.delta_amount > 0 ? '+' : '') + formatNumber(tx.delta_amount)"></span>
                          </td>
                          <td class="px-4 py-2.5 text-right font-mono text-sm themed-text-muted" x-text="formatNumber(tx.balance_after)"></td>
                          <td class="px-4 py-2.5 themed-text-muted text-xs max-w-[180px] truncate" x-text="tx.description || '-'" :title="tx.description"></td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </div>
              </template>
              <template x-if="!selectedDiamondAccount?.transactions || selectedDiamondAccount.transactions.length === 0">
                <div class="text-center py-10 rounded-lg border-2 border-dashed border-gray-200">
                  <div class="text-4xl mb-2">📭</div>
                  <p class="themed-text-muted text-sm">暂无交易流水记录</p>
                  <p class="themed-text-hint text-xs mt-1">该用户尚未产生钻石相关交易</p>
                </div>
              </template>
            </div>
          </div>
        </div>

        <!-- 底部操作栏 -->
        <div class="px-6 py-3 border-t bg-gray-50 flex justify-between items-center rounded-b-xl">
          <p class="text-xs themed-text-muted">仅展示最近 20 条记录</p>
          <div class="flex space-x-2">
            <button @click="hideModal('diamondDetailModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded-lg hover:bg-gray-300 text-sm transition-colors">关闭</button>
            <button @click="openDiamondAdjustModal(selectedDiamondAccount)" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm transition-colors flex items-center gap-1">
              <span>✏️</span> 调整钻石
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 7. 商户积分详情 Modal -->
    <div x-ref="merchantPointDetailModal" 
         x-show="isModalOpen('merchantPointDetailModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('merchantPointDetailModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-2xl mx-4 z-10 max-h-[80vh] overflow-hidden flex flex-col">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold">🏪 商户积分详情</h5>
          <button @click="hideModal('merchantPointDetailModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <div class="flex-1 overflow-y-auto p-4">
          <div class="space-y-4" x-show="selectedMerchant">
            <div class="grid grid-cols-2 gap-4">
              <div class="bg-orange-50 rounded-lg p-4 text-center">
                <p class="text-sm themed-text-muted">商户ID</p>
                <p class="text-xl font-bold text-orange-600" x-text="selectedMerchant?.merchant_id || selectedMerchant?.id || '-'"></p>
              </div>
              <div class="bg-green-50 rounded-lg p-4 text-center">
                <p class="text-sm themed-text-muted">积分余额</p>
                <p class="text-xl font-bold text-green-600" x-text="selectedMerchant?.balance || selectedMerchant?.points || 0"></p>
              </div>
            </div>
            <div class="border-t pt-4">
              <h6 class="font-medium mb-2">商户信息</h6>
              <div class="text-sm themed-text-muted">
                <p><span class="font-medium">名称：</span><span x-text="selectedMerchant?.merchant_name || selectedMerchant?.name || '-'"></span></p>
              </div>
            </div>
          </div>
        </div>
        <div class="p-4 border-t themed-bg-base flex justify-end">
          <button @click="hideModal('merchantPointDetailModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">关闭</button>
        </div>
      </div>
    </div>

    <!-- 8. 商户积分批量拒绝 Modal -->
    <div x-ref="merchantBatchRejectModal"
         x-show="isModalOpen('merchantBatchRejectModal')"
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('merchantBatchRejectModal')"></div>
      <div class="relative themed-card rounded-xl shadow-xl w-full max-w-md mx-4 z-10">
        <div class="p-4 border-b bg-red-50 rounded-t-xl flex justify-between items-center">
          <div class="flex items-center gap-2">
            <span class="text-red-500 text-lg">❌</span>
            <h5 class="font-semibold text-red-800">批量拒绝积分申请</h5>
          </div>
          <button @click="hideModal('merchantBatchRejectModal')" class="text-gray-400 hover:text-gray-600 text-xl">✕</button>
        </div>
        <div class="p-6 space-y-4">
          <div class="p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-700">
            ⚠️ 拒绝操作不可撤销，请确认后提交。拒绝后商户不会获得申请的积分。
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">拒绝原因 <span class="text-red-500">*</span></label>
            <textarea x-model="merchantBatchRejectReason"
                      rows="3"
                      placeholder="请输入批量拒绝的统一原因（至少2个字符）..."
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-200 focus:border-red-400 transition text-sm"></textarea>
            <p class="text-xs text-gray-400 mt-1" x-text="'已输入 ' + (merchantBatchRejectReason?.length || 0) + ' 个字符'"></p>
          </div>
        </div>
        <div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end space-x-3">
          <button type="button" @click="hideModal('merchantBatchRejectModal')"
                  class="px-4 py-2 text-sm bg-white text-gray-600 border rounded-lg hover:bg-gray-50 transition">
            取消
          </button>
          <button type="button"
                  @click="confirmMerchantBatchReject(selectedMerchantBatchIds); window.dispatchEvent(new CustomEvent('refresh-merchant-points'))"
                  :disabled="merchantBatchProcessing || !merchantBatchRejectReason || merchantBatchRejectReason.length < 2"
                  class="px-4 py-2 text-sm bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 transition shadow-sm">
            <span x-show="!merchantBatchProcessing">确认拒绝</span>
            <span x-show="merchantBatchProcessing">⏳ 处理中...</span>
          </button>
        </div>
      </div>
    </div>

    <!-- 9. 预算设置 Modal -->
    <div x-ref="budgetModal" 
         x-show="isModalOpen('budgetModal')" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center"
         style="display: none;">
      <div class="fixed inset-0 bg-black/50" @click="hideModal('budgetModal')"></div>
      <div class="relative themed-card rounded-lg shadow-xl w-full max-w-md mx-4 z-10">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold">📊 预算设置</h5>
          <button @click="hideModal('budgetModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
        </div>
        <form @submit.prevent="saveBudget()">
          <div class="p-6 space-y-4">
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">预算类型</label>
              <select x-model="budgetForm.type" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-gray-500">
                <option value="daily">日预算</option>
                <option value="weekly">周预算</option>
                <option value="monthly">月预算</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">预算金额 (元) <span class="text-red-500">*</span></label>
              <input type="number" x-model.number="budgetForm.amount" step="0.01" min="0" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-gray-500" required>
            </div>
            <div>
              <label class="block text-sm font-medium themed-text-secondary mb-1">预警阈值 (%)</label>
              <input type="number" x-model.number="budgetForm.alert_threshold" min="0" max="100" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-gray-500" placeholder="80">
              <p class="text-xs themed-text-muted mt-1">达到此比例时发送预警</p>
            </div>
          </div>
          <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-2">
            <button type="button" @click="hideModal('budgetModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">取消</button>
            <button type="submit" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800" :disabled="saving">保存预算</button>
          </div>
        </form>
      </div>
    </div>

  </div>

  <!-- 页面专属逻辑 -->
  <%- include('partials/footer') %>


  <script type="module" src="./src/modules/analytics/pages/finance-management.js"></script>
</body>
</html>

