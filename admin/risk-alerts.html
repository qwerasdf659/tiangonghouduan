<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '风控告警', 
    pageStyle: '[x-cloak] { display: none !important; } .chart-container { height: 200px; }' 
  }) %>
  <!-- ECharts 已通过 main.js 统一导入，无需 CDN -->
</head>
<body class="themed-bg-subtle min-h-screen" x-data="riskAlertsPage()" x-init="init()" x-cloak>
  
  <!-- 导航栏 -->
  <nav class="themed-bg-primary text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="hover:opacity-80">← 返回工作台</a>
        <span class="text-lg font-semibold">🚨 风控告警</span>
      </div>
      <div class="flex items-center space-x-4">
        <span x-text="'欢迎，' + (current_user?.nickname || '管理员')"></span>
        <button @click="logout()" class="px-3 py-1 border border-white/50 rounded hover:bg-white/10">退出登录</button>
      </div>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-6">
    <!-- 统计卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="themed-card rounded-lg shadow p-4 text-center border-l-4 border-red-500">
        <div class="text-4xl text-red-400 mb-2">🔴</div>
        <h4 class="text-2xl font-bold text-red-600" x-text="stats.critical">0</h4>
        <p class="themed-text-muted text-sm">严重告警</p>
      </div>
      <div class="themed-card rounded-lg shadow p-4 text-center border-l-4 border-yellow-500">
        <div class="text-4xl text-yellow-400 mb-2">🟡</div>
        <h4 class="text-2xl font-bold text-yellow-600" x-text="stats.warning">0</h4>
        <p class="themed-text-muted text-sm">警告</p>
      </div>
      <div class="themed-card rounded-lg shadow p-4 text-center border-l-4 themed-border-primary">
        <div class="text-4xl text-blue-400 mb-2">🔵</div>
        <h4 class="text-2xl font-bold themed-text-primary" x-text="stats.info">0</h4>
        <p class="themed-text-muted text-sm">提示</p>
      </div>
      <div class="themed-card rounded-lg shadow p-4 text-center border-l-4 border-green-500">
        <div class="text-4xl text-green-400 mb-2">✅</div>
        <h4 class="text-2xl font-bold text-green-600" x-text="stats.resolved">0</h4>
        <p class="themed-text-muted text-sm">已处理</p>
      </div>
    </div>

    <!-- 图表区域 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">告警级别分布</h5>
        </div>
        <div class="p-4">
          <div id="levelDistChart" class="chart-container"></div>
        </div>
      </div>
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">告警类型分布</h5>
        </div>
        <div class="p-4">
          <div id="typeDistChart" class="chart-container"></div>
        </div>
      </div>
    </div>

    <!-- 筛选栏 -->
    <div class="themed-card rounded-lg shadow mb-6">
      <div class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">告警级别</label>
            <select x-model="filters.severity" class="w-full px-3 py-2 border rounded-lg">
              <option value="">全部级别</option>
              <option value="critical">严重</option>
              <option value="high">高危</option>
              <option value="medium">中等</option>
              <option value="low">低</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">告警类型</label>
            <select x-model="filters.alert_type" class="w-full px-3 py-2 border rounded-lg">
              <option value="">全部类型</option>
              <option value="frequency_limit">频次限制</option>
              <option value="amount_limit">金额告警</option>
              <option value="duplicate_user">重复用户</option>
              <option value="suspicious_pattern">可疑模式</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">处理状态</label>
            <select x-model="filters.status" class="w-full px-3 py-2 border rounded-lg">
              <option value="">全部状态</option>
              <option value="pending">待处理</option>
              <option value="reviewed">已审核</option>
              <option value="resolved">已处理</option>
              <option value="ignored">已忽略</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">时间范围</label>
            <select x-model="filters.time" class="w-full px-3 py-2 border rounded-lg">
              <option value="">全部时间</option>
              <option value="today">今日</option>
              <option value="week">本周</option>
              <option value="month">本月</option>
            </select>
          </div>
          <div>
            <button @click="loadAlerts()" class="w-full px-4 py-2 themed-bg-primary text-white rounded-lg themed-hover-primary">
              🔍 搜索
            </button>
          </div>
          <div>
            <button @click="toggleAutoRefresh()" :class="autoRefresh ? 'bg-green-600' : 'bg-gray-500'" class="w-full px-4 py-2 text-white rounded-lg hover:opacity-90">
              <span x-text="autoRefresh ? '🔄 自动刷新中' : '⏸️ 自动刷新'"></span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 告警列表 -->
    <div class="themed-card rounded-lg shadow">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">告警列表</h5>
        <button @click="batchResolve()" :disabled="selectedAlerts.length === 0" class="px-4 py-2 themed-btn-primary rounded disabled:opacity-50 text-sm">
          批量处理选中
        </button>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full" x-data="resizableColumns({ storageKey: 'risk-alerts-columns', persistWidths: true })">
          <thead class="themed-bg-base">
            <tr>
              <th class="px-4 py-3 text-left" style="width: 50px;">
                <input type="checkbox" @change="toggleAllAlerts($event.target.checked)" class="rounded">
              </th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted resizable-header">告警ID</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted resizable-header">级别</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted resizable-header">类型</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted resizable-header">关联用户</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted resizable-header">描述</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted resizable-header">状态</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted resizable-header">时间</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
            </tr>
          </thead>
          <tbody class="divide-y">
            <template x-if="alerts.length === 0">
              <tr><td colspan="9" class="px-4 py-8 text-center themed-text-muted">暂无告警数据</td></tr>
            </template>
            <template x-for="alert in alerts" :key="alert.risk_alert_id">
              <tr class="themed-hover-bg">
                <td class="px-4 py-3">
                  <input type="checkbox" :value="alert.risk_alert_id" x-model="selectedAlerts" class="rounded">
                </td>
                <td class="px-4 py-3 text-sm font-mono" x-text="alert.risk_alert_id"></td>
                <td class="px-4 py-3">
                  <span :class="{
                    'bg-red-100 text-red-700': alert.severity === 'critical' || alert.severity === 'high',
                    'bg-yellow-100 text-yellow-700': alert.severity === 'medium',
                    'themed-bg-primary-light themed-text-primary': alert.severity === 'low'
                  }" class="px-2 py-1 text-xs rounded" x-text="getLevelText(alert.severity)"></span>
                </td>
                <td class="px-4 py-3 text-sm" x-text="getTypeText(alert.alert_type)"></td>
                <td class="px-4 py-3 text-sm" x-text="alert.target_user_info?.nickname || alert.target_user_info?.user_id || '-'"></td>
                <td class="px-4 py-3 text-sm max-w-xs truncate" x-text="alert.alert_message"></td>
                <td class="px-4 py-3">
                  <div class="flex flex-col gap-1">
                    <span :class="{
                      'bg-yellow-100 text-yellow-700': alert.status === 'pending',
                      'themed-bg-primary-light themed-text-primary': alert.status === 'reviewed',
                      'bg-green-100 themed-text-success': alert.status === 'resolved',
                      'themed-bg-subtle themed-text-secondary': alert.status === 'ignored'
                    }" class="px-2 py-1 text-xs rounded inline-block" x-text="getStatusText(alert.status)"></span>
                    <!-- P2-8: 升级状态标识 -->
                    <span 
                      x-show="getEscalationStatus(alert)"
                      class="px-2 py-0.5 text-xs rounded bg-red-100 text-red-600 animate-pulse inline-block"
                      x-text="getEscalationStatus(alert)"
                    ></span>
                  </div>
                </td>
                <td class="px-4 py-3 text-sm themed-text-muted" x-text="formatDate(alert.created_at)"></td>
                <td class="px-4 py-3">
                  <div class="flex flex-wrap gap-1">
                    <button @click="viewAlertDetail(alert)" class="themed-text-primary hover:text-blue-700 text-sm">详情</button>
                    <button x-show="alert.status === 'pending'" @click="openHandleModal(alert)" class="text-green-500 hover:text-green-700 text-sm">处理</button>
                    <!-- P2-8: 静默按钮 -->
                    <button 
                      x-show="alert.status === 'pending'"
                      @click.stop="$refs.silenceMenu.classList.toggle('hidden')"
                      class="text-gray-500 hover:text-gray-700 text-sm relative"
                    >
                      🔕静默
                    </button>
                    <!-- 静默下拉菜单 -->
                    <div 
                      x-ref="silenceMenu"
                      class="hidden absolute right-0 mt-6 w-40 bg-white border rounded-lg shadow-lg z-20"
                    >
                      <button @click="silenceAlert(alert, 60); $refs.silenceMenu.classList.add('hidden')" class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-100">静默此条 (1小时)</button>
                      <button @click="silenceAlertType(alert.alert_type, 60); $refs.silenceMenu.classList.add('hidden')" class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-100">静默同类型 (1小时)</button>
                      <button x-show="alert.user_id" @click="silenceUserAlerts(alert.user_id, 60); $refs.silenceMenu.classList.add('hidden')" class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-100">静默该用户 (1小时)</button>
                    </div>
                  </div>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
      
      <!-- 分页 -->
      <div class="p-4 border-t flex justify-between items-center">
        <span class="text-sm themed-text-muted" x-text="'共 ' + totalCount + ' 条记录'"></span>
        <div class="flex space-x-2">
          <button @click="prevPage()" :disabled="current_page <= 1" class="px-3 py-1 border rounded disabled:opacity-50">上一页</button>
          <span class="px-3 py-1" x-text="'第 ' + current_page + ' / ' + total_pages + ' 页'"></span>
          <button @click="nextPage()" :disabled="current_page >= total_pages" class="px-3 py-1 border rounded disabled:opacity-50">下一页</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 处理告警 Modal (新架构) -->
  <div x-ref="handleModal" 
       x-show="isModalOpen('handleModal')" 
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center"
       style="display: none;">
    <div class="fixed inset-0 bg-black/50" @click="hideModal('handleModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-md mx-4 z-10">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">🔧 处理告警</h5>
        <button @click="hideModal('handleModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
      </div>
      <form @submit.prevent="submitHandle()">
        <div class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">处理结果 <span class="text-red-500">*</span></label>
            <select x-model="handleForm.status" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-500">
              <option value="reviewed">标记为已审核</option>
              <option value="ignored">忽略此告警</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">处理备注</label>
            <textarea x-model="handleForm.remark" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-500" placeholder="请输入处理备注..."></textarea>
          </div>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-2">
          <button type="button" @click="hideModal('handleModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">取消</button>
          <button type="submit" class="px-4 py-2 themed-btn-primary rounded disabled:opacity-50" :disabled="submitting">
            <span x-show="submitting" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-1"></span>
            确认处理
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 告警详情模态框 -->
  <div x-show="selectedAlert" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" @click.self="selectedAlert = null">
    <div class="themed-card rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">告警详情</h5>
        <button @click="selectedAlert = null" class="themed-text-muted hover:themed-text-secondary">&times;</button>
      </div>
      <div class="p-4 space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div><span class="themed-text-muted">告警ID:</span> <span class="font-mono" x-text="selectedAlert?.risk_alert_id"></span></div>
          <div><span class="themed-text-muted">级别:</span> <span x-text="getLevelText(selectedAlert?.severity)"></span></div>
          <div><span class="themed-text-muted">类型:</span> <span x-text="getTypeText(selectedAlert?.alert_type)"></span></div>
          <div><span class="themed-text-muted">状态:</span> <span x-text="getStatusText(selectedAlert?.status)"></span></div>
          <div><span class="themed-text-muted">关联用户:</span> <span x-text="selectedAlert?.target_user_info?.nickname || selectedAlert?.target_user_info?.user_id || '-'"></span></div>
          <div><span class="themed-text-muted">触发时间:</span> <span x-text="formatDate(selectedAlert?.created_at)"></span></div>
        </div>
        <div>
          <p class="themed-text-muted mb-2">告警描述:</p>
          <div class="p-3 themed-bg-base rounded" x-text="selectedAlert?.alert_message"></div>
        </div>
        <div x-show="selectedAlert?.rule_name">
          <p class="themed-text-muted mb-2">规则信息:</p>
          <div class="p-3 themed-bg-base rounded">
            <p><span class="themed-text-muted">规则名称:</span> <span x-text="selectedAlert?.rule_name"></span></p>
            <p><span class="themed-text-muted">阈值:</span> <span x-text="selectedAlert?.rule_threshold"></span></p>
            <p><span class="themed-text-muted">实际值:</span> <span x-text="selectedAlert?.actual_value"></span></p>
            <p><span class="themed-text-muted">是否阻断:</span> <span x-text="selectedAlert?.is_blocked ? '是' : '否'"></span></p>
          </div>
        </div>
        <div x-show="timeline.length > 0">
          <p class="themed-text-muted mb-2">处理时间线:</p>
          <div class="space-y-2">
            <template x-for="item in timeline" :key="item.id">
              <div class="flex items-start p-2 themed-bg-base rounded">
                <span class="text-gray-400 text-sm mr-2" x-text="formatDate(item.created_at)"></span>
                <span x-text="item.action"></span>
              </div>
            </template>
          </div>
        </div>
      </div>
      <div class="p-4 border-t flex justify-end">
        <button @click="selectedAlert = null" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">关闭</button>
      </div>
    </div>
  </div>

  <!-- P2-8: 合并告警详情弹窗 -->
  <div 
    x-show="showMergedAlertsModal" 
    x-cloak
    class="fixed inset-0 z-50 flex items-center justify-center"
    style="display: none;"
  >
    <div class="fixed inset-0 bg-black/50" @click="closeMergedAlertsModal()"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-2xl mx-4 z-10 max-h-[80vh] flex flex-col">
      <div class="p-4 border-b flex justify-between items-center shrink-0">
        <h5 class="font-semibold">📊 批量告警详情</h5>
        <button @click="closeMergedAlertsModal()" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
      </div>
      
      <template x-if="currentMergedAlertGroup">
        <div class="p-6 overflow-y-auto flex-1">
          <!-- 统计摘要 -->
          <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="text-center p-3 bg-blue-50 rounded-lg">
              <p class="text-2xl font-bold text-blue-600" x-text="currentMergedAlertGroup.count"></p>
              <span class="text-xs themed-text-muted">告警总数</span>
            </div>
            <div class="text-center p-3 bg-orange-50 rounded-lg">
              <p class="text-sm font-medium text-orange-600" x-text="getTypeText(currentMergedAlertGroup.type)"></p>
              <span class="text-xs themed-text-muted">告警类型</span>
            </div>
            <div class="text-center p-3 bg-purple-50 rounded-lg">
              <p class="text-sm font-medium text-purple-600" x-text="currentMergedAlertGroup.first_time"></p>
              <span class="text-xs themed-text-muted">首次触发</span>
            </div>
          </div>
          
          <!-- 告警列表 -->
          <div class="space-y-3">
            <h6 class="font-medium themed-text mb-2">合并的告警（最近10条）</h6>
            <template x-for="(alert, idx) in (currentMergedAlertGroup.alerts || []).slice(0, 10)" :key="idx">
              <div class="p-3 bg-gray-50 rounded-lg flex items-start justify-between">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="text-xs font-mono themed-text-muted" x-text="alert.risk_alert_id"></span>
                    <span 
                      :class="{
                        'bg-red-100 text-red-600': alert.severity === 'critical' || alert.severity === 'high',
                        'bg-yellow-100 text-yellow-600': alert.severity === 'medium',
                        'bg-blue-100 text-blue-600': alert.severity === 'low'
                      }"
                      class="px-1.5 py-0.5 text-xs rounded"
                      x-text="getLevelText(alert.severity)"
                    ></span>
                  </div>
                  <p class="text-sm themed-text" x-text="alert.alert_message || alert.message"></p>
                  <p class="text-xs themed-text-muted mt-1" x-text="formatDate(alert.created_at)"></p>
                </div>
                <button 
                  @click="openHandleModal(alert); closeMergedAlertsModal()"
                  class="text-green-500 hover:text-green-700 text-sm shrink-0 ml-2"
                >
                  处理
                </button>
              </div>
            </template>
          </div>
        </div>
      </template>
      
      <div class="p-4 border-t flex justify-between items-center shrink-0">
        <span class="text-sm themed-text-muted">同类告警1小时内只显示1次</span>
        <button @click="closeMergedAlertsModal()" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">关闭</button>
      </div>
    </div>
  </div>

  <%- include('partials/footer') %>



  <script type="module" src="./src/modules/system/pages/risk-alerts.js"></script>
</body>
</html>
