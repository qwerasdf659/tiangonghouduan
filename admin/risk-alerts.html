<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '风控告警', 
    pageStyle: '[x-cloak] { display: none !important; } .chart-container { height: 200px; }' 
  }) %>
  <!-- ECharts 已通过 main.js 统一导入，无需 CDN -->
</head>
<body class="themed-bg-subtle min-h-screen" x-data="riskAlertsPage()" x-init="init()" x-cloak>
  
  <!-- 导航栏 -->
  <nav class="themed-bg-primary text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="hover:opacity-80">← 返回工作台</a>
        <span class="text-lg font-semibold">🚨 风控告警</span>
        <span x-show="lastUpdateTime" class="text-xs text-white/60 ml-2">· 最后更新: <span x-text="lastUpdateTime"></span></span>
      </div>
      <div class="flex items-center space-x-4">
        <span x-text="'欢迎，' + (current_user?.nickname || '管理员')"></span>
        <button @click="logout()" class="px-3 py-1 border border-white/50 rounded hover:bg-white/10">退出登录</button>
      </div>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-6">
    <!-- 统计卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="themed-card rounded-lg shadow p-4 text-center border-l-4 border-red-500">
        <div class="text-4xl text-red-400 mb-2">🔴</div>
        <h4 class="text-2xl font-bold text-red-600" x-text="stats.critical">0</h4>
        <p class="themed-text-muted text-sm">严重告警</p>
      </div>
      <div class="themed-card rounded-lg shadow p-4 text-center border-l-4 border-yellow-500">
        <div class="text-4xl text-yellow-400 mb-2">🟡</div>
        <h4 class="text-2xl font-bold text-yellow-600" x-text="stats.warning">0</h4>
        <p class="themed-text-muted text-sm">警告</p>
      </div>
      <div class="themed-card rounded-lg shadow p-4 text-center border-l-4 themed-border-primary">
        <div class="text-4xl text-blue-400 mb-2">🔵</div>
        <h4 class="text-2xl font-bold themed-text-primary" x-text="stats.info">0</h4>
        <p class="themed-text-muted text-sm">提示</p>
      </div>
      <div class="themed-card rounded-lg shadow p-4 text-center border-l-4 border-green-500">
        <div class="text-4xl text-green-400 mb-2">✅</div>
        <h4 class="text-2xl font-bold text-green-600" x-text="stats.resolved">0</h4>
        <p class="themed-text-muted text-sm">已处理</p>
      </div>
    </div>

    <!-- 图表区域 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">告警级别分布</h5>
        </div>
        <div class="p-4">
          <div id="levelDistChart" class="chart-container"></div>
        </div>
      </div>
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">告警类型分布</h5>
        </div>
        <div class="p-4">
          <div id="typeDistChart" class="chart-container"></div>
        </div>
      </div>
    </div>

    <!-- P2#11: 市场价格异常监控面板 -->
    <div class="themed-card rounded-lg shadow mb-6">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold flex items-center gap-2">
          💰 市场价格异常监控
          <span class="text-xs themed-text-muted font-normal">阈值配置已在 system_settings 中定义</span>
        </h5>
        <button @click="loadMarketPriceMonitor()" class="themed-btn-secondary px-3 py-1 rounded text-sm"
                :disabled="loadingMarketMonitor">
          <span x-show="!loadingMarketMonitor">🔄 刷新</span>
          <span x-show="loadingMarketMonitor">加载中...</span>
        </button>
      </div>
      <div class="p-4">
        <!-- 加载状态 -->
        <div x-show="loadingMarketMonitor" class="text-center py-6">
          <div class="animate-spin inline-block w-6 h-6 border-3 border-blue-500 border-t-transparent rounded-full"></div>
          <p class="themed-text-muted mt-2 text-sm">加载市场监控数据...</p>
        </div>
        <!-- 市场健康指标 -->
        <template x-if="marketMonitor && !loadingMarketMonitor">
          <div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
              <div class="p-3 rounded-lg border themed-border-light text-center">
                <p class="text-xs themed-text-muted mb-1">在售挂单数</p>
                <p class="text-xl font-bold themed-text-primary" x-text="marketMonitor.total_listings || 0"></p>
              </div>
              <div class="p-3 rounded-lg border themed-border-light text-center">
                <p class="text-xs themed-text-muted mb-1">兑换成交率</p>
                <p class="text-xl font-bold" 
                   :class="marketMonitor.deal_rate > 0 ? 'text-green-600' : 'themed-text-muted'"
                   x-text="marketMonitor.deal_rate.toFixed(1) + '%'"></p>
              </div>
              <div class="p-3 rounded-lg border themed-border-light text-center">
                <p class="text-xs themed-text-muted mb-1">库存预警率</p>
                <p class="text-xl font-bold"
                   :class="marketMonitor.low_stock_rate > 10 ? 'text-red-600' : 'text-green-600'"
                   x-text="marketMonitor.low_stock_rate.toFixed(1) + '%'"></p>
              </div>
              <div class="p-3 rounded-lg border themed-border-light text-center">
                <p class="text-xs themed-text-muted mb-1">库存预警商品</p>
                <p class="text-xl font-bold" 
                   :class="(marketMonitor.price_anomaly_count || 0) > 0 ? 'text-red-600' : 'text-green-600'"
                   x-text="marketMonitor.price_anomaly_count || 0"></p>
              </div>
            </div>
            <!-- 价格阈值配置显示 -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="rounded-lg p-4 themed-bg-base">
                <h6 class="font-medium text-sm mb-2">📏 价格监控阈值（来自 system_settings）</h6>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="themed-text-muted">价格下限阈值</span>
                    <span class="font-mono" x-text="marketMonitor.thresholds?.price_low || '未配置'"></span>
                  </div>
                  <div class="flex justify-between">
                    <span class="themed-text-muted">价格上限阈值</span>
                    <span class="font-mono" x-text="marketMonitor.thresholds?.price_high || '未配置'"></span>
                  </div>
                  <div class="flex justify-between">
                    <span class="themed-text-muted">超长挂牌天数</span>
                    <span class="font-mono" x-text="(marketMonitor.thresholds?.long_listing_days || '未配置') + '天'"></span>
                  </div>
                  <div class="flex justify-between">
                    <span class="themed-text-muted">告警启用状态</span>
                    <span class="font-mono" :class="marketMonitor.thresholds?.alert_enabled ? 'text-green-600' : 'text-red-600'"
                          x-text="marketMonitor.thresholds?.alert_enabled ? '已启用' : '已关闭'"></span>
                  </div>
                </div>
              </div>
              <div class="rounded-lg p-4 themed-bg-base">
                <h6 class="font-medium text-sm mb-2">📊 市场概览</h6>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="themed-text-muted">C2C挂单数 / 有挂单用户</span>
                    <span class="font-mono">
                      <span x-text="marketMonitor.total_listings || 0"></span>
                      <span class="themed-text-muted"> / </span>
                      <span class="themed-text-primary" x-text="marketMonitor.active_listings || 0"></span>
                    </span>
                  </div>
                  <div class="flex justify-between">
                    <span class="themed-text-muted">达到上限用户</span>
                    <span class="font-mono" :class="(marketMonitor.users_at_limit || 0) > 0 ? 'text-red-600' : 'text-green-600'"
                          x-text="marketMonitor.users_at_limit || 0"></span>
                  </div>
                  <div class="flex justify-between">
                    <span class="themed-text-muted">接近上限用户</span>
                    <span class="font-mono text-yellow-600" x-text="marketMonitor.users_near_limit || 0"></span>
                  </div>
                  <div class="flex justify-between">
                    <span class="themed-text-muted">兑换商品（上架/总计）</span>
                    <span class="font-mono">
                      <span class="text-green-600" x-text="marketMonitor.active_exchange_items || 0"></span>
                      <span class="themed-text-muted"> / </span>
                      <span x-text="marketMonitor.total_exchange_items || 0"></span>
                    </span>
                  </div>
                  <div class="flex justify-between">
                    <span class="themed-text-muted">总兑换次数</span>
                    <span class="font-mono" x-text="marketMonitor.total_exchanges || 0"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </template>
        <!-- 无数据 -->
        <div x-show="!loadingMarketMonitor && !marketMonitor" class="text-center py-6 themed-text-muted">
          <i class="bi bi-graph-down text-4xl mb-2"></i>
          <p>暂无市场监控数据</p>
          <p class="text-xs mt-1">点击刷新按钮加载数据</p>
        </div>
      </div>
    </div>

    <!-- 筛选栏 -->
    <div class="themed-card rounded-lg shadow mb-6">
      <div class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">告警级别</label>
            <select x-model="filters.severity" class="w-full px-3 py-2 border rounded-lg">
              <option value="">全部级别</option>
              <option value="critical">严重</option>
              <option value="high">高危</option>
              <option value="medium">中等</option>
              <option value="low">低</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">告警类型</label>
            <select x-model="filters.alert_type" class="w-full px-3 py-2 border rounded-lg">
              <option value="">全部类型</option>
              <option value="frequency_limit">频次限制</option>
              <option value="amount_limit">金额告警</option>
              <option value="duplicate_user">重复用户</option>
              <option value="suspicious_pattern">可疑模式</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">处理状态</label>
            <select x-model="filters.status" class="w-full px-3 py-2 border rounded-lg">
              <option value="">全部状态</option>
              <option value="pending">待处理</option>
              <option value="reviewed">已审核</option>
              <option value="resolved">已处理</option>
              <option value="ignored">已忽略</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">时间范围</label>
            <select x-model="filters.time" class="w-full px-3 py-2 border rounded-lg">
              <option value="">全部时间</option>
              <option value="today">今日</option>
              <option value="week">本周</option>
              <option value="month">本月</option>
            </select>
          </div>
          <div>
            <button @click="loadAlerts()" class="w-full px-4 py-2 themed-bg-primary text-white rounded-lg themed-hover-primary">
              🔍 搜索
            </button>
          </div>
          <div>
            <button @click="toggleAutoRefresh()" :class="autoRefresh ? 'bg-green-600' : 'bg-gray-500'" class="w-full px-4 py-2 text-white rounded-lg hover:opacity-90">
              <span x-text="autoRefresh ? '🔄 自动刷新中' : '⏸️ 自动刷新'"></span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 告警列表（data-table） -->
    <div class="themed-card rounded-lg shadow" @table-action="handleAlertsTableAction($event.detail)">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">告警列表</h5>
        <button @click="batchResolve()" :disabled="selectedAlerts.length === 0" class="px-4 py-2 themed-btn-primary rounded disabled:opacity-50 text-sm">
          批量处理选中
        </button>
      </div>
      <div x-data="dataTable({
        columns: alertsTableColumns,
        dataSource: fetchAlertsTableData,
        primaryKey: 'risk_alert_id',
        sortable: true,
        selectable: true,
        exportable: false,
        serverSort: true,
        page_size: 20,
        emptyText: '暂无风险告警数据'
      })" x-init="init()" @dt-refresh.window="refresh()">
        <%- include('components/data-table') %>
      </div>
    </div>
  </div>

  <!-- 处理告警 Modal (新架构) -->
  <div x-ref="handleModal" 
       x-show="isModalOpen('handleModal')" 
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center"
       style="display: none;">
    <div class="fixed inset-0 bg-black/50" @click="hideModal('handleModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-md mx-4 z-10">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">🔧 处理告警</h5>
        <button @click="hideModal('handleModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
      </div>
      <form @submit.prevent="submitHandle()">
        <div class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">处理结果 <span class="text-red-500">*</span></label>
            <select x-model="handleForm.status" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-500">
              <option value="reviewed">标记为已审核</option>
              <option value="ignored">忽略此告警</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">处理备注</label>
            <textarea x-model="handleForm.remark" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-500" placeholder="请输入处理备注..."></textarea>
          </div>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-2">
          <button type="button" @click="hideModal('handleModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">取消</button>
          <button type="submit" class="px-4 py-2 themed-btn-primary rounded disabled:opacity-50" :disabled="submitting">
            <span x-show="submitting" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-1"></span>
            确认处理
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 告警详情模态框 -->
  <div x-show="selectedAlert" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" @click.self="selectedAlert = null">
    <div class="themed-card rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">告警详情</h5>
        <button @click="selectedAlert = null" class="themed-text-muted hover:themed-text-secondary">&times;</button>
      </div>
      <div class="p-4 space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div><span class="themed-text-muted">告警ID:</span> <span class="font-mono" x-text="selectedAlert?.risk_alert_id"></span></div>
          <div><span class="themed-text-muted">级别:</span> <span x-text="selectedAlert?.severity_display || selectedAlert?.severity"></span></div>
          <div><span class="themed-text-muted">类型:</span> <span x-text="selectedAlert?.alert_type_display || selectedAlert?.alert_type"></span></div>
          <div><span class="themed-text-muted">状态:</span> <span x-text="selectedAlert?.status_display || selectedAlert?.status"></span></div>
          <div><span class="themed-text-muted">关联用户:</span> <span x-text="selectedAlert?.target_user_info?.nickname || selectedAlert?.target_user_info?.user_id || '-'"></span></div>
          <div><span class="themed-text-muted">触发时间:</span> <span x-text="formatDate(selectedAlert?.created_at)"></span></div>
        </div>
        <div>
          <p class="themed-text-muted mb-2">告警描述:</p>
          <div class="p-3 themed-bg-base rounded" x-text="selectedAlert?.alert_message"></div>
        </div>
        <div x-show="selectedAlert?.rule_name">
          <p class="themed-text-muted mb-2">规则信息:</p>
          <div class="p-3 themed-bg-base rounded">
            <p><span class="themed-text-muted">规则名称:</span> <span x-text="selectedAlert?.rule_name"></span></p>
            <p><span class="themed-text-muted">阈值:</span> <span x-text="selectedAlert?.rule_threshold"></span></p>
            <p><span class="themed-text-muted">实际值:</span> <span x-text="selectedAlert?.actual_value"></span></p>
            <p><span class="themed-text-muted">是否阻断:</span> <span x-text="selectedAlert?.is_blocked ? '是' : '否'"></span></p>
          </div>
        </div>
        <div x-show="timeline.length > 0">
          <p class="themed-text-muted mb-2">处理时间线:</p>
          <div class="space-y-2">
            <template x-for="item in timeline" :key="item.id">
              <div class="flex items-start p-2 themed-bg-base rounded">
                <span class="text-gray-400 text-sm mr-2" x-text="formatDate(item.created_at)"></span>
                <span x-text="item.action"></span>
              </div>
            </template>
          </div>
        </div>
      </div>
      <div class="p-4 border-t flex justify-end">
        <button @click="selectedAlert = null" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">关闭</button>
      </div>
    </div>
  </div>

  <!-- P2-8: 合并告警详情弹窗 -->
  <div 
    x-show="showMergedAlertsModal" 
    x-cloak
    class="fixed inset-0 z-50 flex items-center justify-center"
    style="display: none;"
  >
    <div class="fixed inset-0 bg-black/50" @click="closeMergedAlertsModal()"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-2xl mx-4 z-10 max-h-[80vh] flex flex-col">
      <div class="p-4 border-b flex justify-between items-center shrink-0">
        <h5 class="font-semibold">📊 批量告警详情</h5>
        <button @click="closeMergedAlertsModal()" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
      </div>
      
      <template x-if="currentMergedAlertGroup">
        <div class="p-6 overflow-y-auto flex-1">
          <!-- 统计摘要 -->
          <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="text-center p-3 bg-blue-50 rounded-lg">
              <p class="text-2xl font-bold text-blue-600" x-text="currentMergedAlertGroup.count"></p>
              <span class="text-xs themed-text-muted">告警总数</span>
            </div>
            <div class="text-center p-3 bg-orange-50 rounded-lg">
              <p class="text-sm font-medium text-orange-600" x-text="currentMergedAlertGroup.type_display || currentMergedAlertGroup.type"></p>
              <span class="text-xs themed-text-muted">告警类型</span>
            </div>
            <div class="text-center p-3 bg-purple-50 rounded-lg">
              <p class="text-sm font-medium text-purple-600" x-text="currentMergedAlertGroup.first_time"></p>
              <span class="text-xs themed-text-muted">首次触发</span>
            </div>
          </div>
          
          <!-- 告警列表 -->
          <div class="space-y-3">
            <h6 class="font-medium themed-text mb-2">合并的告警（最近10条）</h6>
            <template x-for="(alert, idx) in (currentMergedAlertGroup.alerts || []).slice(0, 10)" :key="idx">
              <div class="p-3 bg-gray-50 rounded-lg flex items-start justify-between">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="text-xs font-mono themed-text-muted" x-text="alert.risk_alert_id"></span>
                    <span 
                      :class="{
                        'bg-red-100 text-red-600': alert.severity === 'critical' || alert.severity === 'high',
                        'bg-yellow-100 text-yellow-600': alert.severity === 'medium',
                        'bg-blue-100 text-blue-600': alert.severity === 'low'
                      }"
                      class="px-1.5 py-0.5 text-xs rounded"
                      x-text="alert.severity_display || alert.severity"
                    ></span>
                  </div>
                  <p class="text-sm themed-text" x-text="alert.alert_message || alert.message"></p>
                  <p class="text-xs themed-text-muted mt-1" x-text="formatDate(alert.created_at)"></p>
                </div>
                <button 
                  @click="openHandleModal(alert); closeMergedAlertsModal()"
                  class="text-green-500 hover:text-green-700 text-sm shrink-0 ml-2"
                >
                  处理
                </button>
              </div>
            </template>
          </div>
        </div>
      </template>
      
      <div class="p-4 border-t flex justify-between items-center shrink-0">
        <span class="text-sm themed-text-muted">同类告警1小时内只显示1次</span>
        <button @click="closeMergedAlertsModal()" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">关闭</button>
      </div>
    </div>
  </div>

  <%- include('partials/footer') %>

  <script type="module" src="./src/modules/system/pages/risk-alerts.js"></script>
</body>
</html>
