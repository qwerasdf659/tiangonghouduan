<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '消息中心', 
    pageStyle: '[x-cloak] { display: none !important; } .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; } .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; } .scrollbar-thin::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; } .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #a1a1a1; } .message-item { transition: all 0.2s ease; } .message-item:hover { background-color: #f8fafc; transform: translateX(2px); } .unread { background-color: rgba(59, 130, 246, 0.05); border-left: 3px solid #3b82f6; } .type-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; }' 
  }) %>
</head>
<body class="themed-bg-base min-h-screen">
  <div x-data="messageCenterPage()" x-init="init()" x-cloak class="p-6">
    <!-- 页面标题 -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold themed-text-primary">📬 消息中心</h1>
        <p class="text-sm themed-text-muted mt-1">
          查看和管理所有系统通知 · 共 <span x-text="pagination.total">0</span> 条消息
        </p>
      </div>
      
      <div class="flex items-center gap-3">
        <!-- 全部已读按钮 -->
        <button 
          @click="markAllAsRead()"
          x-show="unreadCount > 0"
          class="flex items-center gap-2 px-4 py-2 border themed-border rounded-lg text-sm themed-text-secondary hover:themed-bg-base transition"
        >
          ✓ 全部标记已读 (<span x-text="unreadCount">0</span>)
        </button>
        
        <!-- 声音设置 -->
        <button 
          @click="toggleSound()"
          class="flex items-center gap-2 px-4 py-2 border rounded-lg text-sm transition"
          :class="soundEnabled ? 'themed-text-primary themed-border-primary themed-bg-primary-light' : 'themed-text-secondary hover:themed-bg-base'"
        >
          <span x-text="soundEnabled ? '🔊' : '🔇'"></span>
          <span x-text="soundEnabled ? '声音已开启' : '声音已关闭'"></span>
        </button>
        
        <!-- 刷新按钮 -->
        <button 
          @click="refreshMessages()"
          :disabled="loading"
          class="flex items-center gap-2 px-4 py-2 themed-bg-primary text-white rounded-lg text-sm font-medium themed-hover-primary transition"
        >
          <span :class="loading && 'animate-spin'">🔄</span>
          刷新
        </button>
      </div>
    </div>
    
    <!-- P1-4: WebSocket 连接状态栏 -->
    <div class="themed-card rounded-xl shadow-sm p-3 mb-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-2">
          <span class="text-xs themed-text-muted">实时连接:</span>
          <span :class="connectionStatusClass" class="text-xs font-medium" x-text="connectionStatusText"></span>
        </div>
        <button 
          x-show="!wsConnected"
          @click="reconnectWebSocket()"
          class="text-xs px-2 py-1 themed-bg-primary text-white rounded hover:opacity-80 transition"
        >
          重新连接
        </button>
      </div>
      <div class="flex items-center gap-2 text-xs themed-text-muted">
        <span>新消息将自动推送到此页面</span>
      </div>
    </div>

    <!-- 筛选和搜索栏 -->
    <div class="themed-card rounded-xl shadow-sm p-4 mb-6">
      <div class="flex flex-wrap items-center gap-4">
        <!-- 类型筛选 -->
        <div class="flex items-center gap-2">
          <span class="text-sm themed-text-muted">类型:</span>
          <div class="flex themed-bg-base rounded-lg p-1">
            <button 
              @click="filter.type = ''"
              :class="filter.type === '' ? 'themed-card shadow-sm' : ''"
              class="px-3 py-1.5 text-sm rounded-md transition"
            >全部</button>
            <button 
              @click="filter.type = 'alert'"
              :class="filter.type === 'alert' ? 'themed-card shadow-sm text-red-600' : ''"
              class="px-3 py-1.5 text-sm rounded-md transition"
            >🔔 告警</button>
            <button 
              @click="filter.type = 'warning'"
              :class="filter.type === 'warning' ? 'themed-card shadow-sm text-yellow-600' : ''"
              class="px-3 py-1.5 text-sm rounded-md transition"
            >⚠️ 预警</button>
            <button 
              @click="filter.type = 'info'"
              :class="filter.type === 'info' ? 'themed-card shadow-sm themed-text-primary' : ''"
              class="px-3 py-1.5 text-sm rounded-md transition"
            >ℹ️ 通知</button>
            <button 
              @click="filter.type = 'success'"
              :class="filter.type === 'success' ? 'themed-card shadow-sm text-green-600' : ''"
              class="px-3 py-1.5 text-sm rounded-md transition"
            >✅ 成功</button>
          </div>
        </div>
        
        <!-- 状态筛选 -->
        <div class="flex items-center gap-2">
          <span class="text-sm themed-text-muted">状态:</span>
          <select 
            x-model="filter.status"
            @change="loadMessages()"
            class="px-3 py-1.5 themed-bg-base border-0 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
          >
            <option value="">全部状态</option>
            <option value="unread">未读</option>
            <option value="read">已读</option>
          </select>
        </div>
        
        <!-- P1-4: 来源筛选 -->
        <div class="flex items-center gap-2">
          <span class="text-sm themed-text-muted">来源:</span>
          <select 
            x-model="filter.source"
            @change="loadMessages()"
            class="px-3 py-1.5 themed-bg-base border-0 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
          >
            <option value="">全部来源</option>
            <template x-for="src in availableSources" :key="src">
              <option :value="src" x-text="src"></option>
            </template>
          </select>
        </div>
        
        <!-- 时间范围 -->
        <div class="flex items-center gap-2">
          <span class="text-sm themed-text-muted">时间:</span>
          <select 
            x-model="filter.time_range"
            @change="loadMessages()"
            class="px-3 py-1.5 themed-bg-base border-0 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
          >
            <option value="">全部时间</option>
            <option value="today">今天</option>
            <option value="week">本周</option>
            <option value="month">本月</option>
          </select>
        </div>
        
        <!-- 搜索框 -->
        <div class="flex-1 min-w-[200px]">
          <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 themed-text-muted">🔍</span>
            <input 
              type="text"
              x-model="filter.keyword"
              @input.debounce.300ms="loadMessages()"
              placeholder="搜索消息内容..."
              class="w-full pl-10 pr-4 py-2 themed-bg-base border-0 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
            />
          </div>
        </div>
      </div>
    </div>
    
    <!-- 消息列表 -->
    <div class="themed-card rounded-xl shadow-sm overflow-hidden">
      <!-- 批量操作栏 -->
      <div 
        x-show="selectedIds.length > 0"
        class="px-4 py-3 themed-bg-primary-light border-b flex items-center justify-between"
      >
        <div class="flex items-center gap-3">
          <span class="text-sm themed-text-primary">
            已选择 <span class="font-semibold" x-text="selectedIds.length">0</span> 条消息
          </span>
        </div>
        <div class="flex items-center gap-2">
          <button 
            @click="markSelectedAsRead()"
            class="px-3 py-1.5 text-sm themed-card border themed-border-primary themed-text-primary rounded-lg hover:themed-bg-primary-light transition"
          >
            标记已读
          </button>
          <button 
            @click="deleteSelected()"
            class="px-3 py-1.5 text-sm themed-card border border-red-200 text-red-600 rounded-lg hover:bg-red-50 transition"
          >
            删除选中
          </button>
          <button 
            @click="selectedIds = []"
            class="px-3 py-1.5 text-sm themed-text-muted hover:themed-text-secondary"
          >
            取消选择
          </button>
        </div>
      </div>
      
      <!-- 消息列表内容 -->
      <div class="divide-y themed-divide">
        <!-- 加载中 -->
        <template x-if="loading && messages.length === 0">
          <div class="p-12 text-center themed-text-muted">
            <div class="animate-spin text-4xl mb-2">⏳</div>
            <div>加载中...</div>
          </div>
        </template>
        
        <!-- 空状态 -->

          <div x-show="!loading && messages.length === 0" class="p-12 text-center themed-text-muted">
            <div class="text-5xl mb-4">📭</div>
            <div class="text-lg font-medium">暂无消息</div>
            <div class="text-sm mt-1">当有新的系统通知时会显示在这里</div>
          </div>

        <!-- 消息项 -->
        <template x-for="message in messages" :key="message.id">
          <div 
            class="message-item flex items-start gap-4 p-4 cursor-pointer"
            :class="{ 'unread': !message.is_read }"
            @click="viewMessage(message)"
          >
            <!-- 复选框 -->
            <div class="pt-1">
              <input 
                type="checkbox"
                :value="message.id"
                x-model="selectedIds"
                @click.stop
                class="w-4 h-4 rounded border-gray-300 themed-text-primary focus:ring-blue-500"
              />
            </div>
            
            <!-- 类型图标 -->
            <div 
              class="w-10 h-10 rounded-full flex items-center justify-center text-lg flex-shrink-0"
              :class="getTypeColorClass(message.type)"
            >
              <span x-text="getTypeIcon(message.type)"></span>
            </div>
            
            <!-- 消息内容 -->
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <span 
                  class="font-medium themed-text-primary"
                  :class="{ 'font-semibold': !message.is_read }"
                  x-text="message.title"
                ></span>
                <span 
                  class="type-badge"
                  :class="getTypeBadgeClass(message.type)"
                  x-text="getTypeLabel(message.type)"
                ></span>
                <span 
                  x-show="!message.is_read"
                  class="w-2 h-2 bg-blue-500 rounded-full"
                ></span>
              </div>
              <div class="text-sm themed-text-secondary line-clamp-2" x-text="message.message"></div>
              <div class="flex items-center gap-4 mt-2 text-xs themed-text-muted">
                <span x-text="formatTime(message.created_at)"></span>
                <span x-show="message.source" x-text="'来源: ' + message.source"></span>
              </div>
            </div>
            
            <!-- 操作按钮 -->
            <div class="flex items-center gap-2 flex-shrink-0">
              <button 
                @click.stop="markAsRead(message)"
                x-show="!message.is_read"
                class="p-2 themed-text-muted hover:themed-text-primary hover:themed-bg-primary-light rounded-lg transition"
                title="标记已读"
              >
                ✓
              </button>
              <button 
                @click.stop="deleteMessage(message)"
                class="p-2 themed-text-muted hover:text-red-600 hover:bg-red-50 rounded-lg transition"
                title="删除"
              >
                🗑️
              </button>
            </div>
          </div>
        </template>
      </div>
      
      <!-- 分页 -->
      <template x-if="pagination.total > pagination.page_size">
        <div class="p-4 border-t themed-divide flex items-center justify-between">
          <div class="text-sm themed-text-muted">
            显示 <span x-text="(pagination.page - 1) * pagination.page_size + 1"></span> - 
            <span x-text="Math.min(pagination.page * pagination.page_size, pagination.total)"></span> / 
            共 <span x-text="pagination.total"></span> 条
          </div>
          
          <div class="flex items-center gap-2">
            <button 
              @click="changePage(pagination.page - 1)"
              :disabled="pagination.page <= 1"
              class="px-3 py-1.5 border themed-border rounded-lg text-sm themed-text-secondary hover:themed-bg-base disabled:opacity-50 disabled:cursor-not-allowed transition"
            >
              ← 上一页
            </button>
            
            <!-- 页码显示 -->
            <template x-for="p in getPageNumbers()" :key="p">
              <button 
                x-show="p !== '...'"
                @click="changePage(p)"
                :class="pagination.page === p ? 'themed-bg-primary text-white' : 'themed-card themed-text-secondary hover:themed-bg-base'"
                class="px-3 py-1.5 border themed-border rounded-lg text-sm transition"
                x-text="p"
              ></button>
              <span x-show="p === '...'" class="px-2 themed-text-muted">...</span>
            </template>
            
            <button 
              @click="changePage(pagination.page + 1)"
              :disabled="pagination.page >= Math.ceil(pagination.total / pagination.page_size)"
              class="px-3 py-1.5 border themed-border rounded-lg text-sm themed-text-secondary hover:themed-bg-base disabled:opacity-50 disabled:cursor-not-allowed transition"
            >
              下一页 →
            </button>
          </div>
        </div>
      </template>
    </div>
    
    <!-- 消息详情模态框 -->
    <div 
      x-show="detailModal"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
      @click.self="closeDetailModal()"
      style="display: none;"
    >
      <div 
        class="themed-card rounded-xl shadow-xl w-full max-w-lg max-h-[80vh] overflow-hidden"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0 transform scale-95"
        x-transition:enter-end="opacity-100 transform scale-100"
      >
        <!-- 模态框头部 -->
        <div class="px-6 py-4 border-b themed-divide flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div 
              class="w-10 h-10 rounded-full flex items-center justify-center text-lg"
              :class="getTypeColorClass(currentMessage?.type)"
            >
              <span x-text="getTypeIcon(currentMessage?.type)"></span>
            </div>
            <div>
              <h3 class="font-semibold themed-text-primary" x-text="currentMessage?.title"></h3>
              <span 
                class="type-badge"
                :class="getTypeBadgeClass(currentMessage?.type)"
                x-text="getTypeLabel(currentMessage?.type)"
              ></span>
            </div>
          </div>
          <button 
            @click="closeDetailModal()"
            class="p-2 themed-text-muted hover:themed-text-secondary hover:themed-bg-base rounded-lg transition"
          >
            ✕
          </button>
        </div>
        
        <!-- 模态框内容 -->
        <div class="p-6 overflow-y-auto max-h-[50vh]">
          <p class="themed-text-secondary whitespace-pre-wrap" x-text="currentMessage?.message"></p>
          
          <!-- 附加信息 -->
          <template x-if="currentMessage?.extra_data">
            <div class="mt-4 p-4 themed-bg-base rounded-lg">
              <div class="text-sm font-medium themed-text-primary mb-2">附加信息</div>
              <pre class="text-xs themed-text-muted overflow-x-auto" x-text="JSON.stringify(currentMessage?.extra_data, null, 2)"></pre>
            </div>
          </template>
        </div>
        
        <!-- 模态框底部 -->
        <div class="px-6 py-4 border-t themed-divide flex items-center justify-between themed-bg-base">
          <div class="text-sm themed-text-muted">
            <span x-text="formatFullTime(currentMessage?.created_at)"></span>
            <span x-show="currentMessage?.source" class="ml-2" x-text="'· 来源: ' + currentMessage?.source"></span>
          </div>
          <div class="flex items-center gap-2">
            <button 
              @click="handleMessageAction(currentMessage)"
              class="px-4 py-2 themed-bg-primary text-white text-sm font-medium rounded-lg themed-hover-primary transition"
            >
              去处理 →
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 页面模块引入 -->
  <script type="module" src="./src/pages/message-center.js"></script>
</body>
</html>
