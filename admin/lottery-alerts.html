<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <%- include('partials/head', { 
    title: '抽奖告警中心', 
    pageStyle: '[x-cloak] { display: none !important; } .chart-container { height: 200px; }' 
  }) %>
</head>
<body class="themed-bg-subtle min-h-screen" x-data="lotteryAlertsPage()" x-init="init()" x-cloak>
  
  <!-- 导航栏 -->
  <nav class="themed-bg-primary text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="/admin/workspace.html" class="hover:opacity-80">← 返回工作台</a>
        <span class="text-lg font-semibold">🎰 抽奖告警中心</span>
      </div>
      <div class="flex items-center space-x-4">
        <span x-text="'欢迎，' + (current_user?.nickname || '管理员')"></span>
        <button @click="logout()" class="px-3 py-1 border border-white/50 rounded hover:bg-white/10">退出登录</button>
      </div>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-6">
    <!-- P1-9: Tab切换 - 调整顺序为：全部告警→紧急告警→抽奖告警→系统告警→健康度分析 -->
    <div class="mb-6 border-b">
      <nav class="flex space-x-4 overflow-x-auto">
        <button 
          @click="activeTab = 'all'; filterAlerts('all')" 
          :class="activeTab === 'all' ? 'border-b-2 themed-border-primary themed-text-primary' : 'themed-text-muted hover:themed-text-secondary'"
          class="px-4 py-2 text-sm font-medium transition-colors whitespace-nowrap">
          📋 全部告警
          <span class="ml-1 px-2 py-0.5 text-xs rounded-full themed-bg-muted" x-text="stats.danger + stats.warning + stats.info"></span>
        </button>
        <button 
          @click="activeTab = 'urgent'; filterAlerts('danger')" 
          :class="activeTab === 'urgent' ? 'border-b-2 border-red-500 text-red-600' : 'themed-text-muted hover:themed-text-secondary'"
          class="px-4 py-2 text-sm font-medium transition-colors whitespace-nowrap">
          🔴 紧急告警
          <span x-show="stats.danger > 0" class="ml-1 px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-700" x-text="stats.danger"></span>
        </button>
        <button 
          @click="activeTab = 'alerts'; filterAlerts('')" 
          :class="activeTab === 'alerts' ? 'border-b-2 themed-border-primary themed-text-primary' : 'themed-text-muted hover:themed-text-secondary'"
          class="px-4 py-2 text-sm font-medium transition-colors whitespace-nowrap">
          🎰 抽奖告警
        </button>
        <button 
          @click="activeTab = 'system'; loadSystemHealth()" 
          :class="activeTab === 'system' ? 'border-b-2 border-purple-500 text-purple-600' : 'themed-text-muted hover:themed-text-secondary'"
          class="px-4 py-2 text-sm font-medium transition-colors whitespace-nowrap">
          🖥️ 系统告警
          <span x-show="systemHealth.alert_count > 0" class="ml-1 px-2 py-0.5 text-xs rounded-full bg-purple-100 text-purple-700" x-text="systemHealth.alert_count"></span>
        </button>
        <button 
          @click="activeTab = 'health'; loadHealthData()" 
          :class="activeTab === 'health' ? 'border-b-2 themed-border-primary themed-text-primary' : 'themed-text-muted hover:themed-text-secondary'"
          class="px-4 py-2 text-sm font-medium transition-colors whitespace-nowrap">
          📊 健康度分析
        </button>
      </nav>
    </div>

    <!-- ============ 实时告警Tab（全部告警/紧急告警/抽奖告警 共用） ============ -->
    <div x-show="activeTab === 'alerts' || activeTab === 'all' || activeTab === 'urgent'" x-cloak>
    <!-- 统计卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
      <div class="themed-card rounded-lg shadow p-4 text-center border-l-4 border-red-500">
        <div class="text-3xl text-red-400 mb-2">🔴</div>
        <h4 class="text-2xl font-bold text-red-600" x-text="stats.danger">0</h4>
        <p class="themed-text-muted text-sm">危险告警</p>
      </div>
      <div class="themed-card rounded-lg shadow p-4 text-center border-l-4 border-yellow-500">
        <div class="text-3xl text-yellow-400 mb-2">🟡</div>
        <h4 class="text-2xl font-bold text-yellow-600" x-text="stats.warning">0</h4>
        <p class="themed-text-muted text-sm">警告</p>
      </div>
      <div class="themed-card rounded-lg shadow p-4 text-center border-l-4 themed-border-primary">
        <div class="text-3xl text-blue-400 mb-2">🔵</div>
        <h4 class="text-2xl font-bold themed-text-primary" x-text="stats.info">0</h4>
        <p class="themed-text-muted text-sm">提示</p>
      </div>
      <div class="themed-card rounded-lg shadow p-4 text-center border-l-4 border-orange-500">
        <div class="text-3xl text-orange-400 mb-2">⏳</div>
        <h4 class="text-2xl font-bold text-orange-600" x-text="stats.acknowledged">0</h4>
        <p class="themed-text-muted text-sm">已确认</p>
      </div>
      <div class="themed-card rounded-lg shadow p-4 text-center border-l-4 border-green-500">
        <div class="text-3xl text-green-400 mb-2">✅</div>
        <h4 class="text-2xl font-bold text-green-600" x-text="stats.resolved">0</h4>
        <p class="themed-text-muted text-sm">已解决</p>
      </div>
    </div>

    <!-- 图表区域 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">📊 告警级别分布</h5>
        </div>
        <div class="p-4">
          <div id="severityDistChart" class="chart-container"></div>
        </div>
      </div>
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">📈 告警类型分布</h5>
        </div>
        <div class="p-4">
          <div id="typeDistChart" class="chart-container"></div>
        </div>
      </div>
    </div>

    <!-- 筛选栏 -->
    <div class="themed-card rounded-lg shadow mb-6">
      <div class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">告警级别</label>
            <select x-model="filters.level" class="w-full px-3 py-2 border rounded-lg">
              <option value="">全部级别</option>
              <option value="danger">危险</option>
              <option value="warning">警告</option>
              <option value="info">提示</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">告警类型</label>
            <select x-model="filters.type" class="w-full px-3 py-2 border rounded-lg">
              <option value="">全部类型</option>
              <option value="budget">预算告警</option>
              <option value="inventory">库存告警</option>
              <option value="win_rate">中奖率告警</option>
              <option value="user">用户告警</option>
              <option value="system">系统告警</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">告警状态</label>
            <select x-model="filters.status" class="w-full px-3 py-2 border rounded-lg">
              <option value="">全部状态</option>
              <option value="active">活跃</option>
              <option value="acknowledged">已确认</option>
              <option value="resolved">已解决</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">关联活动</label>
            <select x-model="filters.campaign_id" class="w-full px-3 py-2 border rounded-lg">
              <option value="">全部活动</option>
              <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
                <option :value="campaign.lottery_campaign_id" x-text="campaign.campaign_name"></option>
              </template>
            </select>
          </div>
          <div>
            <button @click="loadAlerts()" class="w-full px-4 py-2 themed-bg-primary text-white rounded-lg themed-hover-primary">
              🔍 搜索
            </button>
          </div>
          <div>
            <button @click="toggleAutoRefresh()" :class="autoRefresh ? 'bg-green-600' : 'bg-gray-500'" class="w-full px-4 py-2 text-white rounded-lg hover:opacity-90">
              <span x-text="autoRefresh ? '🔄 自动刷新中' : '⏸️ 自动刷新'"></span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 告警列表 -->
    <div class="themed-card rounded-lg shadow">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">🚨 实时告警列表</h5>
        <div class="flex space-x-2">
          <button @click="batchAcknowledge()" :disabled="selectedAlerts.length === 0" class="px-4 py-2 bg-orange-500 text-white rounded text-sm disabled:opacity-50 hover:bg-orange-600">
            批量确认 (<span x-text="selectedAlerts.length"></span>)
          </button>
          <button @click="batchResolve()" :disabled="selectedAlerts.length === 0" class="px-4 py-2 themed-btn-primary rounded text-sm disabled:opacity-50">
            批量解决 (<span x-text="selectedAlerts.length"></span>)
          </button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full" x-data="resizableColumns({ storageKey: 'lottery-alerts-columns', persistWidths: true })">
          <thead class="themed-bg-base">
            <tr>
              <th class="px-4 py-3 text-left" style="width: 50px;">
                <input type="checkbox" @change="toggleAllAlerts($event.target.checked)" class="rounded">
              </th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted resizable-header">告警ID</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted resizable-header">级别</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted resizable-header">类型</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted resizable-header">关联活动</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted resizable-header">告警描述</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted resizable-header">阈值/实际</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted resizable-header">状态</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted resizable-header">时间</th>
              <th class="px-4 py-3 text-left text-sm font-medium themed-text-muted">操作</th>
            </tr>
          </thead>
          <tbody class="divide-y">
            <template x-if="loading">
              <tr><td colspan="10" class="px-4 py-8 text-center themed-text-muted">加载中...</td></tr>
            </template>

            <tr x-show="!loading && alerts.length === 0">
              <td colspan="10" class="px-4 py-8 text-center themed-text-muted">暂无告警数据</td>
            </tr>
            <template x-for="alert in alerts" :key="alert.alert_id">
              <tr class="themed-hover-bg">
                <td class="px-4 py-3">
                  <input type="checkbox" :value="alert.alert_id" x-model="selectedAlerts" class="rounded">
                </td>
                <td class="px-4 py-3 text-sm font-mono" x-text="alert.alert_id"></td>
                <td class="px-4 py-3">
                  <span :class="{
                    'bg-red-100 text-red-700': alert.level === 'danger',
                    'bg-yellow-100 text-yellow-700': alert.level === 'warning',
                    'themed-bg-primary-light themed-text-primary': alert.level === 'info'
                  }" class="px-2 py-1 text-xs rounded" x-text="alert.severity_display || alert.level"></span>
                </td>
                <td class="px-4 py-3 text-sm" x-text="alert.type_display || alert.type"></td>
                <td class="px-4 py-3 text-sm" x-text="alert.campaign_name || alert.related_entity?.name || '-'"></td>
                <td class="px-4 py-3 text-sm max-w-xs truncate" :title="alert.message" x-text="alert.message"></td>
                <td class="px-4 py-3 text-sm">
                  <span class="themed-text-muted" x-text="formatThreshold(alert)"></span>
                </td>
                <td class="px-4 py-3">
                  <span :class="{
                    'bg-red-100 text-red-700': alert.status === 'active',
                    'bg-orange-100 text-orange-700': alert.status === 'acknowledged',
                    'bg-green-100 themed-text-success': alert.status === 'resolved'
                  }" class="px-2 py-1 text-xs rounded" x-text="alert.status_display || alert.status"></span>
                </td>
                <td class="px-4 py-3 text-sm themed-text-muted" x-text="formatDate(alert.created_at)"></td>
                <td class="px-4 py-3">
                  <div class="flex space-x-2">
                    <button @click="viewAlertDetail(alert)" class="themed-text-primary hover:text-blue-700 text-sm">详情</button>
                    <button x-show="alert.status === 'active'" @click="acknowledgeAlert(alert)" class="text-orange-500 hover:text-orange-700 text-sm">确认</button>
                    <button x-show="alert.status !== 'resolved'" @click="openResolveModal(alert)" class="text-green-500 hover:text-green-700 text-sm">解决</button>
                  </div>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
      
      <!-- 分页 -->
      <div class="p-4 border-t flex justify-between items-center">
        <span class="text-sm themed-text-muted" x-text="'共 ' + totalCount + ' 条记录'"></span>
        <div class="flex space-x-2">
          <button @click="prevPage()" :disabled="current_page <= 1" class="px-3 py-1 border rounded disabled:opacity-50">上一页</button>
          <span class="px-3 py-1" x-text="'第 ' + current_page + ' / ' + total_pages + ' 页'"></span>
          <button @click="nextPage()" :disabled="current_page >= total_pages" class="px-3 py-1 border rounded disabled:opacity-50">下一页</button>
        </div>
      </div>
    </div>
    </div><!-- 结束实时告警Tab -->

    <!-- ============ P1-21: 系统告警Tab ============ -->
    <div x-show="activeTab === 'system'" x-cloak>
      <!-- 系统健康状态概览 -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <!-- API状态 -->
        <div class="themed-card rounded-lg shadow p-4">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <span class="text-2xl">🌐</span>
              <h4 class="font-semibold themed-text">API服务</h4>
            </div>
            <span 
              class="px-2 py-1 text-xs rounded-full"
              :class="{
                'bg-green-100 text-green-700': systemHealth.api?.status === 'healthy',
                'bg-yellow-100 text-yellow-700': systemHealth.api?.status === 'warning',
                'bg-red-100 text-red-700': systemHealth.api?.status === 'critical',
                'bg-gray-100 text-gray-700': systemHealth.api?.status === 'loading'
              }"
              x-text="systemHealth.api?.status === 'healthy' ? '正常' : systemHealth.api?.status === 'warning' ? '警告' : systemHealth.api?.status === 'critical' ? '异常' : '检测中'">
            </span>
          </div>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="themed-text-muted">响应时间</span>
              <span class="font-medium themed-text" x-text="(systemHealth.api?.response_time || 0) + 'ms'"></span>
            </div>
            <div class="flex justify-between">
              <span class="themed-text-muted">上次检查</span>
              <span class="themed-text" x-text="formatRelativeTime(systemHealth.api?.last_check)"></span>
            </div>
          </div>
        </div>

        <!-- 数据库状态 -->
        <div class="themed-card rounded-lg shadow p-4">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <span class="text-2xl">🗄️</span>
              <h4 class="font-semibold themed-text">数据库</h4>
            </div>
            <span 
              class="px-2 py-1 text-xs rounded-full"
              :class="{
                'bg-green-100 text-green-700': systemHealth.db?.status === 'healthy',
                'bg-yellow-100 text-yellow-700': systemHealth.db?.status === 'warning',
                'bg-red-100 text-red-700': systemHealth.db?.status === 'critical',
                'bg-gray-100 text-gray-700': systemHealth.db?.status === 'loading'
              }"
              x-text="systemHealth.db?.status === 'healthy' ? '正常' : systemHealth.db?.status === 'warning' ? '警告' : systemHealth.db?.status === 'critical' ? '异常' : '检测中'">
            </span>
          </div>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="themed-text-muted">主机</span>
              <span class="font-medium themed-text truncate max-w-[120px]" :title="systemHealth.db?.host" x-text="systemHealth.db?.host || '--'"></span>
            </div>
            <div class="flex justify-between">
              <span class="themed-text-muted">数据库</span>
              <span class="themed-text" x-text="systemHealth.db?.database || '--'"></span>
            </div>
          </div>
        </div>

        <!-- Redis状态 -->
        <div class="themed-card rounded-lg shadow p-4">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <span class="text-2xl">⚡</span>
              <h4 class="font-semibold themed-text">Redis缓存</h4>
            </div>
            <span 
              class="px-2 py-1 text-xs rounded-full"
              :class="{
                'bg-green-100 text-green-700': systemHealth.redis?.status === 'healthy',
                'bg-yellow-100 text-yellow-700': systemHealth.redis?.status === 'warning',
                'bg-red-100 text-red-700': systemHealth.redis?.status === 'critical',
                'bg-gray-100 text-gray-700': systemHealth.redis?.status === 'loading'
              }"
              x-text="systemHealth.redis?.connected ? '已连接' : '未连接'">
            </span>
          </div>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="themed-text-muted">连接状态</span>
              <span class="font-medium" :class="systemHealth.redis?.connected ? 'text-green-600' : 'text-red-600'" x-text="systemHealth.redis?.connected ? '在线' : '离线'"></span>
            </div>
          </div>
        </div>

        <!-- 综合健康度 -->
        <div class="themed-card rounded-lg shadow p-4">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <span class="text-2xl">🏥</span>
              <h4 class="font-semibold themed-text">系统健康度</h4>
            </div>
            <span 
              class="text-2xl font-bold"
              :class="{
                'text-green-600': systemHealth.overall_score >= 80,
                'text-yellow-600': systemHealth.overall_score >= 60 && systemHealth.overall_score < 80,
                'text-red-600': systemHealth.overall_score < 60
              }"
              x-text="systemHealth.overall_score || '--'">
            </span>
          </div>
          <div class="w-full themed-bg-muted rounded-full h-2">
            <div 
              class="h-2 rounded-full transition-all duration-500"
              :class="{
                'bg-green-500': systemHealth.overall_score >= 80,
                'bg-yellow-500': systemHealth.overall_score >= 60 && systemHealth.overall_score < 80,
                'bg-red-500': systemHealth.overall_score < 60
              }"
              :style="{ width: (systemHealth.overall_score || 0) + '%' }">
            </div>
          </div>
        </div>
      </div>

      <!-- 慢接口告警 -->
      <div class="themed-card rounded-lg shadow mb-6">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold">⏱️ 慢接口告警</h5>
          <button @click="loadSystemHealth()" class="px-3 py-1 text-sm themed-bg-primary text-white rounded hover:opacity-90">
            🔄 刷新
          </button>
        </div>
        <div class="p-4">

            <div x-show="!systemHealth.slow_apis || systemHealth.slow_apis.length === 0" class="text-center py-8 themed-text-muted">
              ✅ 暂无慢接口告警，系统响应正常
            </div>

          <div class="space-y-3">
            <template x-for="(api, index) in (systemHealth.slow_apis || [])" :key="index">
              <div class="p-4 rounded-lg border-l-4"
                   :class="{
                     'border-red-500 bg-red-50': api.response_time > 3000,
                     'border-yellow-500 bg-yellow-50': api.response_time > 1000 && api.response_time <= 3000,
                     'border-blue-500 bg-blue-50': api.response_time <= 1000
                   }">
                <div class="flex items-center justify-between">
                  <div>
                    <span class="font-medium themed-text" x-text="api.endpoint"></span>
                    <p class="text-sm themed-text-muted mt-1" x-text="'方法: ' + (api.method || 'GET')"></p>
                  </div>
                  <div class="text-right">
                    <span class="text-lg font-bold"
                          :class="{
                            'text-red-600': api.response_time > 3000,
                            'text-yellow-600': api.response_time > 1000 && api.response_time <= 3000,
                            'text-blue-600': api.response_time <= 1000
                          }"
                          x-text="api.response_time + 'ms'"></span>
                    <p class="text-xs themed-text-muted" x-text="formatDate(api.recorded_at)"></p>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- 系统告警历史 -->
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b">
          <h5 class="font-semibold">📜 系统告警历史</h5>
        </div>
        <div class="p-4">

            <div x-show="!systemHealth.recent_alerts || systemHealth.recent_alerts.length === 0" class="text-center py-8 themed-text-muted">
              🛡️ 近期无系统告警记录
            </div>

          <div class="space-y-3">
            <template x-for="(alert, index) in (systemHealth.recent_alerts || [])" :key="index">
              <div class="p-4 rounded-lg border"
                   :class="{
                     'border-red-300 bg-red-50': alert.severity === 'critical',
                     'border-yellow-300 bg-yellow-50': alert.severity === 'warning',
                     'border-blue-300 bg-blue-50': alert.severity === 'info'
                   }">
                <div class="flex items-start justify-between">
                  <div class="flex items-center gap-2">
                    <span :class="{
                            'text-red-500': alert.severity === 'critical',
                            'text-yellow-500': alert.severity === 'warning',
                            'text-blue-500': alert.severity === 'info'
                          }"
                          x-text="alert.severity === 'critical' ? '🔴' : alert.severity === 'warning' ? '🟡' : '🔵'"></span>
                    <span class="font-medium themed-text" x-text="alert.message"></span>
                  </div>
                  <span class="text-xs themed-text-muted" x-text="formatDate(alert.created_at)"></span>
                </div>
                <p x-show="alert.details" class="text-sm themed-text-muted mt-2" x-text="alert.details"></p>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div><!-- 结束系统告警Tab -->

    <!-- ============ 健康度分析Tab ============ -->
    <div x-show="activeTab === 'health'" x-cloak>
      <!-- 活动选择 -->
      <div class="themed-card rounded-lg shadow p-4 mb-6">
        <div class="flex items-center space-x-4">
          <label class="text-sm font-medium themed-text-secondary">选择活动：</label>
          <select x-model="selectedCampaignId" @change="loadHealthData()" class="px-3 py-2 border rounded-lg min-w-64" :class="!selectedCampaignId ? 'border-yellow-400 ring-1 ring-yellow-300' : ''">
            <option value="">-- 请选择一个抽奖活动 --</option>
            <template x-for="campaign in campaigns" :key="campaign.lottery_campaign_id">
              <option :value="campaign.lottery_campaign_id" x-text="campaign.campaign_name"></option>
            </template>
          </select>
          <button @click="loadHealthData()" class="px-4 py-2 themed-bg-primary text-white rounded-lg themed-hover-primary" :disabled="!selectedCampaignId">
            🔄 刷新
          </button>
        </div>
        <!-- 未选择活动时的提示 -->
        <div x-show="!selectedCampaignId" class="mt-3 flex items-center gap-2 px-4 py-3 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 text-sm">
          <span class="text-lg">⚠️</span>
          <span>健康度分析需要针对<strong>具体活动</strong>进行诊断，请先在上方下拉框中选择一个抽奖活动。</span>
        </div>
      </div>

      <!-- 健康度概览卡片 -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <div class="text-4xl mb-2" :class="healthData.overall_score >= 80 ? 'text-green-500' : healthData.overall_score >= 60 ? 'text-yellow-500' : 'text-red-500'">
            <span x-text="healthData.overall_score || 0"></span>
          </div>
          <p class="text-lg font-semibold">综合评分</p>
          <p class="text-sm themed-text-muted" x-text="getHealthLevel(healthData.overall_score)"></p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <div class="text-4xl mb-2" :class="healthData.budget_health >= 70 ? 'text-green-500' : 'text-yellow-500'">
            <span x-text="healthData.budget_health || 0"></span>
          </div>
          <p class="text-lg font-semibold">预算健康度</p>
          <p class="text-sm themed-text-muted">剩余 <span x-text="healthData.budget_remaining_days || '-'"></span> 天</p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <div class="text-4xl mb-2" :class="healthData.win_rate_health >= 70 ? 'text-green-500' : 'text-yellow-500'">
            <span x-text="healthData.win_rate_health || 0"></span>
          </div>
          <p class="text-lg font-semibold">中奖率健康度</p>
          <p class="text-sm themed-text-muted">当前 <span x-text="(healthData.current_win_rate || 0).toFixed(1)"></span>%</p>
        </div>
        <div class="themed-card rounded-lg shadow p-4 text-center">
          <div class="text-4xl mb-2" :class="healthData.prize_distribution_health >= 70 ? 'text-green-500' : 'text-yellow-500'">
            <span x-text="healthData.prize_distribution_health || 0"></span>
          </div>
          <p class="text-lg font-semibold">奖品分布健康度</p>
          <p class="text-sm themed-text-muted">高档位 <span x-text="(healthData.high_tier_ratio || 0).toFixed(1)"></span>%</p>
        </div>
      </div>

      <!-- 图表区域 -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <!-- 档位分布饼图 -->
        <div class="themed-card rounded-lg shadow">
          <div class="p-4 border-b">
            <h5 class="font-semibold">📊 档位分布</h5>
          </div>
          <div class="p-4">
            <div id="tierDistributionChart" style="height: 250px;"></div>
          </div>
        </div>
        <!-- 健康度趋势 -->
        <div class="themed-card rounded-lg shadow">
          <div class="p-4 border-b">
            <h5 class="font-semibold">📈 健康度趋势（7天）</h5>
          </div>
          <div class="p-4">
            <div id="healthTrendChart" style="height: 250px;"></div>
          </div>
        </div>
      </div>

      <!-- 问题诊断列表 -->
      <div class="themed-card rounded-lg shadow">
        <div class="p-4 border-b flex justify-between items-center">
          <h5 class="font-semibold">🔍 问题诊断与建议</h5>
          <span class="text-sm themed-text-muted" x-text="'共 ' + (healthData.issues?.length || 0) + ' 个问题'"></span>
        </div>
        <div class="p-4">

            <div x-show="!healthData.issues || healthData.issues.length === 0" class="text-center py-8 themed-text-muted">
              ✅ 暂无问题，系统运行健康
            </div>

          <div class="space-y-3">
            <template x-for="(issue, index) in (healthData.issues || [])" :key="index">
              <div class="p-4 rounded-lg border-l-4" 
                   :class="{
                     'border-red-500 bg-red-50': issue.level === 'error',
                     'border-yellow-500 bg-yellow-50': issue.level === 'warning',
                     'border-blue-500 bg-blue-50': issue.level === 'info'
                   }">
                <div class="flex items-start justify-between">
                  <div>
                    <span class="font-medium" x-text="issue.title || issue.message"></span>
                    <p class="text-sm themed-text-muted mt-1" x-text="issue.description || issue.suggestion"></p>
                  </div>
                  <span class="px-2 py-1 text-xs rounded" 
                        :class="{
                          'bg-red-100 text-red-700': issue.level === 'error',
                          'bg-yellow-100 text-yellow-700': issue.level === 'warning',
                          'bg-blue-100 text-blue-700': issue.level === 'info'
                        }"
                        x-text="issue.level === 'error' ? '严重' : issue.level === 'warning' ? '警告' : '提示'">
                  </span>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div><!-- 结束健康度分析Tab -->
  </div>

  <!-- 解决告警 Modal -->
  <div x-ref="resolveModal" 
       x-show="isModalOpen('resolveModal')" 
       x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center"
       style="display: none;">
    <div class="fixed inset-0 bg-black/50" @click="hideModal('resolveModal')"></div>
    <div class="relative themed-card rounded-lg shadow-xl w-full max-w-md mx-4 z-10">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">✅ 解决告警</h5>
        <button @click="hideModal('resolveModal')" class="text-gray-400 hover:themed-text-muted text-xl">✕</button>
      </div>
      <form @submit.prevent="submitResolve()">
        <div class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">告警ID</label>
            <input type="text" :value="resolveForm.alert_id" disabled class="w-full px-3 py-2 border rounded-lg bg-gray-100">
          </div>
          <div>
            <label class="block text-sm font-medium themed-text-secondary mb-1">处理备注</label>
            <textarea x-model="resolveForm.resolution" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500" placeholder="请输入解决方案描述（可选）..."></textarea>
          </div>
        </div>
        <div class="p-4 border-t themed-bg-base rounded-b-lg flex justify-end space-x-2">
          <button type="button" @click="hideModal('resolveModal')" class="px-4 py-2 themed-bg-muted themed-text-secondary rounded hover:bg-gray-300">取消</button>
          <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50" :disabled="submitting">
            <span x-show="submitting" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-1"></span>
            确认解决
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 告警详情模态框 -->
  <div x-show="selectedAlert" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" @click.self="selectedAlert = null">
    <div class="themed-card rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center">
        <h5 class="font-semibold">📋 告警详情</h5>
        <button @click="selectedAlert = null" class="themed-text-muted hover:themed-text-secondary text-xl">&times;</button>
      </div>
      <div class="p-4 space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div><span class="themed-text-muted">告警ID:</span> <span class="font-mono" x-text="selectedAlert?.alert_id"></span></div>
          <div><span class="themed-text-muted">级别:</span> <span x-text="selectedAlert?.severity_display || selectedAlert?.level"></span></div>
          <div><span class="themed-text-muted">类型:</span> <span x-text="selectedAlert?.type_display || selectedAlert?.type"></span></div>
          <div><span class="themed-text-muted">状态:</span> <span x-text="selectedAlert?.status_display || selectedAlert?.status"></span></div>
          <div><span class="themed-text-muted">关联活动:</span> <span x-text="selectedAlert?.campaign_name || selectedAlert?.related_entity?.name || '-'"></span></div>
          <div><span class="themed-text-muted">触发时间:</span> <span x-text="formatDate(selectedAlert?.created_at)"></span></div>
        </div>
        <div>
          <p class="themed-text-muted mb-2">告警描述:</p>
          <div class="p-3 themed-bg-base rounded" x-text="selectedAlert?.message"></div>
        </div>
        <div x-show="selectedAlert?.threshold || selectedAlert?.current_value">
          <p class="themed-text-muted mb-2">告警数据:</p>
          <div class="p-3 themed-bg-base rounded">
            <p><span class="themed-text-muted">规则代码:</span> <span x-text="selectedAlert?.rule_code || '-'"></span></p>
            <p><span class="themed-text-muted">阈值:</span> <span x-text="selectedAlert?.threshold ?? '-'"></span></p>
            <p><span class="themed-text-muted">实际值:</span> <span x-text="selectedAlert?.current_value ?? '-'"></span></p>
            <p x-show="selectedAlert?.deviation_percentage"><span class="themed-text-muted">偏离度:</span> <span x-text="selectedAlert?.deviation_percentage + '%'"></span></p>
            <p x-show="selectedAlert?.suggestion"><span class="themed-text-muted">建议:</span> <span x-text="selectedAlert?.suggestion"></span></p>
          </div>
        </div>
        <div x-show="selectedAlert?.resolved_at">
          <p class="themed-text-muted mb-2">解决信息:</p>
          <div class="p-3 themed-bg-base rounded">
            <p><span class="themed-text-muted">解决时间:</span> <span x-text="formatDate(selectedAlert?.resolved_at)"></span></p>
            <p><span class="themed-text-muted">解决人:</span> <span x-text="selectedAlert?.resolver_name || '-'"></span></p>
            <p x-show="selectedAlert?.resolve_notes"><span class="themed-text-muted">备注:</span> <span x-text="selectedAlert?.resolve_notes"></span></p>
          </div>
        </div>
      </div>
      <div class="p-4 border-t flex justify-end space-x-2">
        <button x-show="selectedAlert?.status === 'active'" @click="acknowledgeAlert(selectedAlert)" class="px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600">确认告警</button>
        <button x-show="selectedAlert?.status !== 'resolved'" @click="openResolveModal(selectedAlert); selectedAlert = null" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">解决告警</button>
        <button @click="selectedAlert = null" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">关闭</button>
      </div>
    </div>
  </div>

  <%- include('partials/footer') %>

  <script type="module" src="./src/modules/lottery/pages/lottery-alerts.js"></script>
</body>
</html>
