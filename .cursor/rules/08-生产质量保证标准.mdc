---
alwaysApply: true
lastUpdated: 2025å¹´12æœˆ18æ—¥
---

# ğŸ›¡ï¸ ç”Ÿäº§è´¨é‡ä¿è¯æ ‡å‡†ï¼ˆåŸºäºå®é™…æŠ€æœ¯å€ºåŠ¡åˆ†æçš„å¼ºåˆ¶è§„èŒƒï¼‰

## ğŸ”´ **åŸºäºç”Ÿäº§é—®é¢˜çš„è´¨é‡æ§åˆ¶ä½“ç³»**

æœ¬è§„èŒƒåŸºäºå®é™…æŠ€æœ¯å€ºåŠ¡æ£€æŸ¥æ¸…å•æç‚¼ï¼Œæ¶µç›–æ¥å£å¥‘çº¦ã€å¥åº·æ£€æŸ¥ã€é…ç½®ç®¡ç†ã€WebSocketå®‰å…¨ã€æ•°æ®åº“è¿ç§»ã€äº‹åŠ¡å¹¶å‘ã€æ€§èƒ½ä¼˜åŒ–ã€æƒé™ç¼“å­˜ç­‰8å¤§å…³é”®é¢†åŸŸçš„å¼ºåˆ¶æ ‡å‡†ã€‚

---

## 1ï¸âƒ£ **APIå“åº”å¥‘çº¦å¼ºåˆ¶æ ‡å‡†**

### **ç»Ÿä¸€å“åº”æ ¼å¼è§„èŒƒ**

**å¼ºåˆ¶è¦æ±‚**: æ‰€æœ‰APIå“åº”å¿…é¡»ä½¿ç”¨ç»Ÿä¸€çš„æ ‡å‡†æ ¼å¼

```javascript
// âœ… æ ‡å‡†å“åº”æ ¼å¼ï¼ˆå¼ºåˆ¶ï¼‰
{
  success: boolean,           // æˆåŠŸæ ‡è¯†
  code: string,              // ä¸šåŠ¡ç ï¼ˆå­—ç¬¦ä¸²ï¼Œå¦‚ 'SUCCESS', 'NOT_FOUND'ï¼‰
  message: string,           // äººç±»å¯è¯»æ¶ˆæ¯
  data: object | array | null, // ä¸šåŠ¡æ•°æ®
  timestamp: string,         // ISO8601 æ—¶é—´æˆ³ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
  version: string,           // APIç‰ˆæœ¬å·
  request_id: string         // è¯·æ±‚è¿½è¸ªID
}
```

**ç¦æ­¢æ¨¡å¼**:
```javascript
// âŒ ç¦æ­¢ï¼šå¤šå¥—æ ¼å¼æ··ç”¨
{ code: 404, msg: '...' }           // é”™è¯¯ï¼šæ•°å­—code + msg
{ status: 'ok', result: {...} }     // é”™è¯¯ï¼šéæ ‡å‡†å­—æ®µ
{ error: '...' }                     // é”™è¯¯ï¼šä»…é”™è¯¯ä¿¡æ¯
```

### **HTTPçŠ¶æ€ç ä¸ä¸šåŠ¡ç åˆ†ç¦»åŸåˆ™**

**å¼ºåˆ¶è§„èŒƒ**:
- HTTPçŠ¶æ€ç ï¼šä»…ç”¨äºä¼ è¾“å±‚ï¼ˆ200/400/401/403/404/500ï¼‰
- ä¸šåŠ¡ç ï¼ˆcodeå­—æ®µï¼‰ï¼šç”¨äºä¸šåŠ¡é€»è¾‘åˆ†ç±»ï¼ˆå­—ç¬¦ä¸²æ ¼å¼ï¼‰

```javascript
// âœ… æ­£ç¡®ä½¿ç”¨
ApiResponse.badRequest('å‚æ•°é”™è¯¯', 'INVALID_PARAMS', details, 400)
// HTTPçŠ¶æ€ç : 400, ä¸šåŠ¡ç : 'INVALID_PARAMS'

ApiResponse.unauthorized('æœªç™»å½•', 'UNAUTHORIZED', null, 401)
// HTTPçŠ¶æ€ç : 401, ä¸šåŠ¡ç : 'UNAUTHORIZED'

// âŒ ç¦æ­¢ï¼šä¸šåŠ¡ç ä½¿ç”¨æ•°å­—
ApiResponse.error('é”™è¯¯', 40001, null, 400)  // é”™è¯¯ï¼š40001ä¸æ˜¯å­—ç¬¦ä¸²
```

### **404å¤„ç†å™¨å­—æ®µå®Œæ•´æ€§**

**å¼ºåˆ¶è¦æ±‚**: 404å¤„ç†å™¨å¿…é¡»åŒ…å«æ‰€æœ‰æ ‡å‡†å­—æ®µ

```javascript
// âœ… æ­£ç¡®çš„404å¤„ç†å™¨
app.use('*', (req, res) => {
  return res.status(404).json({
    success: false,
    code: 'NOT_FOUND',
    message: `æ¥å£ä¸å­˜åœ¨: ${req.method} ${req.originalUrl}`,
    data: { availableEndpoints: [...] },
    timestamp: BeijingTimeHelper.apiTimestamp(),
    version: process.env.API_VERSION || 'v4',    // âœ… å¿…éœ€
    request_id: req.id || generateRequestId()    // âœ… å¿…éœ€
  })
})
```

### **å…¨å±€é”™è¯¯å¤„ç†å™¨è§„èŒƒ**

**å¼ºåˆ¶è¦æ±‚**: å…¨å±€é”™è¯¯å¤„ç†å¿…é¡»ä½¿ç”¨ApiResponseæ ‡å‡†æ ¼å¼

```javascript
// âœ… æ ‡å‡†é”™è¯¯å¤„ç†å™¨
app.use((err, req, res, next) => {
  const statusCode = err.statusCode || err.status || 500
  const errorCode = err.code || 'INTERNAL_ERROR'
  const message = err.message || 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
  
  // å¿…é¡»ä½¿ç”¨ApiResponse.error()
  return res.status(statusCode).json(
    ApiResponse.error(message, errorCode, { stack: err.stack }, statusCode)
  )
})

// âŒ ç¦æ­¢ï¼šç›´æ¥è¿”å›éæ ‡å‡†æ ¼å¼
app.use((err, req, res, next) => {
  res.status(500).json({ error: err.message })  // âŒ éæ ‡å‡†æ ¼å¼
})
```

---

## 2ï¸âƒ£ **å¥åº·æ£€æŸ¥ä¸å¯è§‚æµ‹æ€§æ ‡å‡†**

### **å¥åº·æ£€æŸ¥ç«¯ç‚¹å¼ºåˆ¶å®ç°**

**å¼ºåˆ¶è¦æ±‚**: `/health` ç«¯ç‚¹å¿…é¡»çœŸå®æ£€æŸ¥æ‰€æœ‰ä¾èµ–æœåŠ¡

```javascript
// âœ… çœŸå®å¥åº·æ£€æŸ¥å®ç°
app.get('/health', async (req, res) => {
  const checks = {}
  
  // 1. æ•°æ®åº“æ£€æŸ¥ï¼ˆå¿…éœ€ï¼‰
  try {
    await sequelize.authenticate()
    checks.database = { status: 'connected', latency: latency }
  } catch (error) {
    checks.database = { status: 'disconnected', error: error.message }
  }
  
  // 2. Redisæ£€æŸ¥ï¼ˆå¿…éœ€ï¼‰
  try {
    const { isRedisHealthy } = require('./utils/UnifiedRedisClient')
    const healthy = await isRedisHealthy()
    checks.redis = { status: healthy ? 'connected' : 'disconnected' }
  } catch (error) {
    checks.redis = { status: 'disconnected', error: error.message }
  }
  
  // 3. è®¡ç®—æ•´ä½“çŠ¶æ€
  const allHealthy = Object.values(checks).every(c => c.status === 'connected')
  const overallStatus = allHealthy ? 'healthy' : 'degraded'
  
  // 4. degraded çŠ¶æ€è¿”å› 200ï¼ˆè€Œé 503ï¼‰
  return res.status(200).json({
    status: overallStatus,
    code: allHealthy ? 'SYSTEM_HEALTHY' : 'SYSTEM_DEGRADED',
    checks: checks,
    timestamp: BeijingTimeHelper.apiTimestamp()
  })
})

// âŒ ç¦æ­¢ï¼šå ä½å®ç°
app.get('/health', (req, res) => {
  res.json({ status: 'ok' })  // âŒ æœªçœŸå®æ£€æŸ¥ä¾èµ–
})
```

### **ç»“æ„åŒ–æ—¥å¿—å¼ºåˆ¶æ ‡å‡†**

**å¼ºåˆ¶è¦æ±‚**: ç¦æ­¢åœ¨æœåŠ¡ä»£ç ä¸­ä½¿ç”¨ `console.log/console.warn/console.error`

```javascript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—
const logger = require('./utils/logger')

logger.info('ç”¨æˆ·ç™»å½•æˆåŠŸ', { 
  user_id: userId, 
  ip: req.ip,
  request_id: req.id 
})

logger.error('æ•°æ®åº“æŸ¥è¯¢å¤±è´¥', {
  error: error.message,
  stack: error.stack,
  query: query,
  request_id: req.id
})

// âŒ ç¦æ­¢ï¼šçº¯æ–‡æœ¬æ—¥å¿—ï¼ˆæ— ç»“æ„ã€æ— request_idã€æ— æ³•æœç´¢ï¼‰
console.log('ç”¨æˆ·ç™»å½•æˆåŠŸ:', userId)
console.error('é”™è¯¯:', error)
```

**ä¾‹å¤–åœºæ™¯**: ä»…å…è®¸åœ¨ä»¥ä¸‹åœºæ™¯ä½¿ç”¨ `console.*`:
- åº”ç”¨å¯åŠ¨é˜¶æ®µï¼ˆlogger åˆå§‹åŒ–å‰ï¼‰
- ç´§æ€¥é™çº§åœºæ™¯ï¼ˆlogger ä¸å¯ç”¨ï¼‰
- å¼€å‘è°ƒè¯•ï¼ˆå¿…é¡»å¸¦æ˜ç¡®çš„ `[DEBUG]` å‰ç¼€ï¼‰

### **request_id å…¨é“¾è·¯è¿½è¸ª**

**å¼ºåˆ¶è¦æ±‚**: æ‰€æœ‰æ—¥å¿—å’Œé”™è¯¯å“åº”å¿…é¡»åŒ…å« `request_id`

```javascript
// âœ… åœ¨ä¸­é—´ä»¶ä¸­ç”Ÿæˆ request_id
app.use((req, res, next) => {
  req.id = req.headers['x-request-id'] || generateRequestId()
  res.setHeader('X-Request-ID', req.id)
  next()
})

// âœ… æ—¥å¿—ä¸­ä¼ é€’ request_id
logger.info('å¤„ç†è¯·æ±‚', { request_id: req.id, path: req.path })

// âœ… æœåŠ¡å±‚æ–¹æ³•æ¥æ”¶ request_id
class UserService {
  static async createUser(userData, { request_id }) {
    logger.info('åˆ›å»ºç”¨æˆ·', { request_id, user_data: userData })
    // ...
  }
}

// âŒ ç¦æ­¢ï¼šæ—¥å¿—ç¼ºå°‘ request_id
logger.info('å¤„ç†è¯·æ±‚', { path: req.path })  // âŒ æ— æ³•å…³è”è¯·æ±‚
```

---

## 3ï¸âƒ£ **é…ç½®ä¸ç¯å¢ƒå˜é‡å¼ºåˆ¶æ ‡å‡†**

### **ç¯å¢ƒå˜é‡åŠ è½½ä¸¥æ ¼æ¨¡å¼**

**å¼ºåˆ¶è¦æ±‚**: ç”Ÿäº§ç¯å¢ƒç¦æ­¢ä½¿ç”¨ `dotenv` çš„ `override` æ¨¡å¼

```javascript
// âœ… æ­£ç¡®ï¼šä¸¥æ ¼åŒºåˆ†å¼€å‘/ç”Ÿäº§ç¯å¢ƒ
if (process.env.NODE_ENV === 'development') {
  require('dotenv').config({ override: true })
  console.log('âš ï¸ [Development] ä½¿ç”¨ dotenv override æ¨¡å¼')
} else {
  require('dotenv').config()
  console.log('âœ… [Production] ä½¿ç”¨å¹³å°æ³¨å…¥é…ç½®ï¼Œç¦æ­¢ override')
}

// âŒ ç¦æ­¢ï¼šç»™ NODE_ENV ç¼ºçœå€¼
const env = process.env.NODE_ENV || 'development'  // âŒ ç”Ÿäº§æ¼é…ä¼šå½“å¼€å‘ç¯å¢ƒ
if (env === 'development') { ... }

// âŒ ç¦æ­¢ï¼šå…¨å±€ override
require('dotenv').config({ override: true })  // âŒ ä¼šè¦†ç›–ç”Ÿäº§é…ç½®
```

### **é…ç½®æ ¡éªŒå¼ºåˆ¶æ‰§è¡Œ**

**å¼ºåˆ¶è¦æ±‚**: åº”ç”¨å¯åŠ¨æ—¶å¿…é¡»æ ¡éªŒå¿…éœ€çš„ç¯å¢ƒå˜é‡

```javascript
// âœ… å¯åŠ¨æ—¶å¼ºåˆ¶æ ¡éªŒ
const { validateConfig, isDevelopment } = require('./config/environment')

if (!isDevelopment()) {
  // ç”Ÿäº§/æµ‹è¯•ç¯å¢ƒï¼šæ ¡éªŒå¤±è´¥ç«‹å³é€€å‡º
  validateConfig()
} else {
  // å¼€å‘ç¯å¢ƒï¼šä»…è­¦å‘Š
  try {
    validateConfig()
  } catch (error) {
    console.warn('âš ï¸ [Development] é…ç½®æ ¡éªŒå¤±è´¥ï¼ˆå·²å¿½ç•¥ï¼‰:', error.message)
  }
}

// âœ… é…ç½®æ ¡éªŒå‡½æ•°å®ç°
function validateConfig() {
  const required = ['NODE_ENV', 'PORT', 'DB_HOST', 'DB_PORT', 'DB_NAME',
                   'DB_USER', 'DB_PASSWORD', 'JWT_SECRET', 'REDIS_URL']
  const missing = required.filter(key => !process.env[key])
  
  if (missing.length > 0) {
    console.error('âŒ ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡:', missing)
    process.exit(1)  // ç«‹å³é€€å‡º
  }
  
  // ç±»å‹æ ¡éªŒ
  if (isNaN(parseInt(process.env.PORT))) {
    console.error('âŒ PORT å¿…é¡»æ˜¯æœ‰æ•ˆçš„æ•°å­—')
    process.exit(1)
  }
}

// âŒ ç¦æ­¢ï¼šæ ¡éªŒå‡½æ•°å®šä¹‰ä½†ä¸æ‰§è¡Œ
function validateConfig() { ... }
// ç¼ºå°‘è°ƒç”¨ï¼Œå¯åŠ¨æ—¶ä¸ä¼šè§¦å‘æ ¡éªŒ
```

### **æ•°æ®åº“é…ç½®å»¶è¿Ÿæ ¡éªŒ**

**å¼ºåˆ¶è¦æ±‚**: æ•°æ®åº“é…ç½®ä¸å¾—åœ¨ `require` æ—¶ç«‹å³æ ¡éªŒ

```javascript
// âœ… æ­£ç¡®ï¼šå»¶è¿Ÿåˆ°å®é™…è¿æ¥æ—¶æ ¡éªŒ
// config/database.js
function validateDatabaseConfig() {
  const required = ['DB_HOST', 'DB_PORT', 'DB_USER', 'DB_PASSWORD', 'DB_NAME']
  const missing = required.filter(v => !process.env[v])
  if (missing.length > 0) {
    throw new Error(`ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡: ${missing.join(', ')}`)
  }
}

async function testConnection() {
  validateDatabaseConfig()  // âœ… è¿æ¥æ—¶æ‰æ ¡éªŒ
  await sequelize.authenticate()
}

module.exports = { sequelize, testConnection }

// âŒ ç¦æ­¢ï¼šrequire æ—¶ç«‹å³æ ¡éªŒ
validateDatabaseConfig()  // âŒ æ”¾åœ¨æ–‡ä»¶é¡¶å±‚ï¼Œrequire å³è§¦å‘
module.exports = { sequelize }
```

**æ›¿ä»£æ–¹æ¡ˆ**: æ·»åŠ è·³è¿‡æ ‡å¿—

```javascript
// âœ… æ–¹æ¡ˆ2ï¼šå…è®¸è·³è¿‡æ ¡éªŒ
if (!process.env.SKIP_DB_VALIDATION) {
  validateDatabaseConfig()
}

// å·¥å…·è„šæœ¬ä¸­ä½¿ç”¨
// SKIP_DB_VALIDATION=1 node scripts/generate-docs.js
```

---

## 4ï¸âƒ£ **WebSocketå®‰å…¨å¼ºåˆ¶æ ‡å‡†**

### **æ¡æ‰‹é˜¶æ®µå¼ºåˆ¶JWTé‰´æƒ**

**å¼ºåˆ¶è¦æ±‚**: WebSocket è¿æ¥å¿…é¡»åœ¨æ¡æ‰‹é˜¶æ®µéªŒè¯ JWT

```javascript
// âœ… æ¡æ‰‹å¼ºåˆ¶é‰´æƒ
const jwt = require('jsonwebtoken')

this.io.use((socket, next) => {
  const token = socket.handshake.auth?.token
  
  if (!token) {
    wsLogger.warn('WebSocketæ¡æ‰‹å¤±è´¥ï¼šç¼ºå°‘token', { 
      socket_id: socket.id, 
      ip: socket.handshake.address 
    })
    return next(new Error('Authentication required: missing token'))
  }
  
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET)
    socket.user = decoded  // æŒ‚è½½ç”¨æˆ·ä¿¡æ¯
    wsLogger.info('WebSocketæ¡æ‰‹æˆåŠŸ', { 
      user_id: decoded.user_id, 
      role: decoded.role 
    })
    next()
  } catch (error) {
    wsLogger.warn('WebSocketæ¡æ‰‹å¤±è´¥ï¼štokenæ— æ•ˆ', { 
      error: error.message 
    })
    next(new Error('Authentication failed: invalid token'))
  }
})

// âŒ ç¦æ­¢ï¼šæ— é‰´æƒç›´æ¥è¿æ¥
this.io.on('connection', socket => {
  // âŒ ç›´æ¥è¿æ¥ï¼Œæ— èº«ä»½éªŒè¯
})
```

### **æœåŠ¡ç«¯åˆ¤å®šèº«ä»½åŸåˆ™**

**å¼ºåˆ¶è¦æ±‚**: ç”¨æˆ·èº«ä»½å’Œæƒé™å¿…é¡»ç”±æœåŠ¡ç«¯ä» JWT åˆ¤å®šï¼Œç¦æ­¢ä¿¡ä»»å®¢æˆ·ç«¯å£°æ˜

```javascript
// âœ… æœåŠ¡ç«¯åˆ¤å®šèº«ä»½
this.io.on('connection', socket => {
  // ä» JWT è·å–èº«ä»½ï¼ˆæœåŠ¡ç«¯åˆ¤å®šï¼‰
  const userId = socket.user.user_id
  const isAdmin = socket.user.role === 'admin' || socket.user.is_admin === true
  
  // æ ¹æ®èº«ä»½æ³¨å†Œè¿æ¥
  if (isAdmin) {
    this.connectedAdmins.set(userId, socket.id)
  } else {
    this.connectedUsers.set(userId, socket.id)
  }
  
  wsLogger.info('ç”¨æˆ·èº«ä»½å·²ç¡®å®š', { 
    user_id: userId, 
    is_admin: isAdmin,
    source: 'JWT' 
  })
})

// âŒ ç¦æ­¢ï¼šä¿¡ä»»å®¢æˆ·ç«¯å£°æ˜
socket.on('register_user', data => {
  const { user_id, user_type } = data  // âŒ å®¢æˆ·ç«¯å¯ä¼ªé€ 
  
  if (user_type === 'admin') {
    this.connectedAdmins.set(user_id, socket.id)  // âŒ å¯å†’å……ç®¡ç†å‘˜
  }
})
```

### **WebSocket CORS ç™½åå•**

**å¼ºåˆ¶è¦æ±‚**: WebSocket å¿…é¡»ä½¿ç”¨ CORS ç™½åå•ï¼Œç¦æ­¢ `origin: '*'`

```javascript
// âœ… CORS ç™½åå•é…ç½®
this.io = socketIO(server, {
  cors: {
    origin: (origin, callback) => {
      const allowedOrigins = process.env.ALLOWED_ORIGINS
        ? process.env.ALLOWED_ORIGINS.split(',')
        : ['http://localhost:3000', 'http://localhost:8080']
      
      // å¾®ä¿¡å°ç¨‹åºç‰¹æ®Šå¤„ç†
      if (!origin || origin.includes('servicewechat.com')) {
        return callback(null, true)
      }
      
      // ç™½åå•æ£€æŸ¥
      if (allowedOrigins.includes(origin)) {
        return callback(null, true)
      }
      
      wsLogger.warn('WebSocketè¿æ¥è¢«CORSæ‹’ç»', { origin })
      callback(new Error('Not allowed by CORS'))
    },
    credentials: true
  }
})

// âŒ ç¦æ­¢ï¼šå®Œå…¨å¼€æ”¾
this.io = socketIO(server, {
  cors: { origin: '*' }  // âŒ ä»»æ„åŸŸåå¯è¿æ¥
})
```

---

## 5ï¸âƒ£ **æ•°æ®åº“è¿ç§»ä¸åŒè½¨æ¶æ„æ ‡å‡†**

### **åŒè½¨æ¶æ„ç¦æ­¢é•¿æœŸå­˜åœ¨**

**å¼ºåˆ¶è¦æ±‚**: æ–°æ—§è¡¨å¹¶å­˜çš„åŒè½¨æ¶æ„å¿…é¡»è®¾ç½®æ˜ç¡®çš„è¿ç§»æˆªæ­¢æ—¥æœŸ

```javascript
// âœ… è®¾ç½®è¿ç§»æˆªæ­¢æ—¥æœŸ
const MIGRATION_CUTOFF_DATE = new Date('2025-12-17')
const now = new Date()

if (now > MIGRATION_CUTOFF_DATE) {
  // æˆªæ­¢æ—¥æœŸåï¼šä»…ä½¿ç”¨æ–°è¡¨
  const items = await ItemInstance.findAll({ where: { owner_user_id: userId } })
  
} else {
  // æˆªæ­¢æ—¥æœŸå‰ï¼šåŒè½¨è¯»å–ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
  const [newItems, oldItems] = await Promise.all([
    ItemInstance.findAll({ where: { owner_user_id: userId } }),
    UserInventory.findAll({ where: { user_id: userId } })
  ])
  // åˆå¹¶æ•°æ®...
}

// âŒ ç¦æ­¢ï¼šæ— æœŸé™çš„åŒè½¨é€»è¾‘
const [newItems, oldItems] = await Promise.all([...])  // âŒ æ°¸ä¹…åŒè½¨
```

### **æ—§æ¥å£åºŸå¼ƒæ ‡å‡†æµç¨‹**

**å¼ºåˆ¶è¦æ±‚**: åºŸå¼ƒçš„æ¥å£å¿…é¡»è¿”å› 410 Gone å¹¶æä¾›è¿ç§»å¼•å¯¼

```javascript
// âœ… æ ‡å‡†åºŸå¼ƒæ¥å£
router.get('/old-endpoint/:id', (req, res) => {
  logger.warn('è®¿é—®å·²åºŸå¼ƒçš„æ¥å£', {
    deprecated_endpoint: '/api/v4/old-endpoint',
    new_endpoint: '/api/v4/new-endpoint',
    deprecation_date: '2025-12-17',
    user_id: req.user?.user_id
  })
  
  return res.apiError(
    'æ­¤æ¥å£å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨æ–°æ¥å£',
    'ENDPOINT_DEPRECATED',
    {
      deprecated_since: '2025-12-17',
      new_endpoint: '/api/v4/new-endpoint',
      migration_guide: 'https://docs.example.com/migration'
    },
    410  // HTTP 410 Gone
  )
})

// âŒ ç¦æ­¢ï¼šåˆ é™¤æ¥å£ä½†ä¸è¿”å›ä»»ä½•ä¿¡æ¯
// router.get('/old-endpoint/:id', ...)  // âŒ ç›´æ¥åˆ é™¤ï¼Œå‰ç«¯404
```

### **å¤–é”®çº¦æŸå’Œç´¢å¼•å¼ºåˆ¶è¦æ±‚**

**å¼ºåˆ¶è¦æ±‚**: æ‰€æœ‰å…³è”è¡¨å¿…é¡»æ·»åŠ å¤–é”®çº¦æŸå’Œå…³é”®ç´¢å¼•

```javascript
// âœ… æ¨¡å‹å®šä¹‰åŒ…å«å¤–é”®å’Œç´¢å¼•
// models/MarketListing.js
MarketListing.init({
  seller_user_id: {
    type: DataTypes.INTEGER,
    allowNull: false,
    references: {
      model: 'users',     // âœ… å¤–é”®çº¦æŸ
      key: 'user_id'
    },
    onDelete: 'RESTRICT',
    onUpdate: 'CASCADE'
  }
}, {
  indexes: [
    {
      fields: ['seller_user_id', 'status'],  // âœ… è”åˆç´¢å¼•
      name: 'idx_seller_status'
    },
    {
      unique: true,
      fields: ['business_id'],  // âœ… å¹‚ç­‰é”®å”¯ä¸€ç´¢å¼•
      name: 'uk_business_id'
    }
  ]
})

// âŒ ç¦æ­¢ï¼šç¼ºå°‘å¤–é”®å’Œç´¢å¼•
MarketListing.init({
  seller_user_id: {
    type: DataTypes.INTEGER  // âŒ æ— å¤–é”®çº¦æŸ
  }
}, {
  // âŒ æ— ç´¢å¼•å®šä¹‰
})
```

---

## 6ï¸âƒ£ **äº‹åŠ¡å¹¶å‘ä¸å¹‚ç­‰æ€§æ ‡å‡†**

### **å¹‚ç­‰é”®æ•°æ®åº“å±‚å”¯ä¸€çº¦æŸ**

**å¼ºåˆ¶è¦æ±‚**: æ‰€æœ‰å¹‚ç­‰é”®ï¼ˆbusiness_idï¼‰å¿…é¡»æœ‰æ•°æ®åº“å±‚å”¯ä¸€çº¦æŸ

```javascript
// âœ… æ¨¡å‹å±‚å£°æ˜å”¯ä¸€çº¦æŸ
// models/MarketListing.js
MarketListing.init({
  business_id: {
    type: DataTypes.STRING(100),
    allowNull: false,
    unique: true,  // âœ… å­—æ®µçº§å”¯ä¸€çº¦æŸ
    comment: 'ä¸šåŠ¡å”¯ä¸€IDï¼Œç”¨äºå¹‚ç­‰æ€§æ§åˆ¶'
  }
}, {
  indexes: [
    {
      unique: true,
      fields: ['business_id'],  // âœ… ç´¢å¼•çº§å”¯ä¸€çº¦æŸ
      name: 'uk_business_id'
    }
  ]
})

// âœ… è¿ç§»æ–‡ä»¶æ·»åŠ çº¦æŸ
await queryInterface.addConstraint('market_listings', {
  fields: ['business_id'],
  type: 'unique',
  name: 'uk_market_listings_business_id'
})

// âŒ ç¦æ­¢ï¼šä»…åœ¨ä»£ç å±‚åˆ¤æ–­é‡å¤
const existing = await MarketListing.findOne({ 
  where: { business_id } 
})
if (existing) {
  throw new Error('é‡å¤')  // âŒ å¹¶å‘åœºæ™¯ä¸‹ä¸å¯é 
}
await MarketListing.create({ business_id, ... })
```

### **äº‹åŠ¡è¾¹ç•Œæ¸…æ™°æ€§åŸåˆ™**

**å¼ºåˆ¶è¦æ±‚**: ä¸šåŠ¡æ“ä½œå’Œå®¡è®¡æ—¥å¿—å¿…é¡»åœ¨åŒä¸€äº‹åŠ¡å†…ï¼Œæˆ–ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦

```javascript
// âœ… æ–¹æ¡ˆ1ï¼šå®¡è®¡æ—¥å¿—åœ¨äº‹åŠ¡å†…ï¼ˆæ¨èç”¨äºå…³é”®æ“ä½œï¼‰
const transaction = await sequelize.transaction()
try {
  // ä¸šåŠ¡æ“ä½œ
  await item.update({ status: 'used' }, { transaction })
  
  // å®¡è®¡æ—¥å¿—ï¼ˆåŒä¸€äº‹åŠ¡ï¼‰
  await AuditLogService.logInventoryUse({
    operator_id: userId,
    item_id: itemId,
    action: 'use'
  }, { transaction })
  
  // ç»Ÿä¸€æäº¤
  await transaction.commit()
} catch (error) {
  await transaction.rollback()
  throw error
}

// âœ… æ–¹æ¡ˆ2ï¼šæ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥ï¼ˆè§£è€¦ï¼‰
await transaction.commit()  // ä¸šåŠ¡å…ˆæäº¤

await auditQueue.publish('inventory.used', {  // å¼‚æ­¥å®¡è®¡
  operator_id: userId,
  item_id: itemId,
  timestamp: Date.now()
})

// âŒ ç¦æ­¢ï¼šäº‹åŠ¡å¤–å¼‚æ­¥å†™å…¥
await transaction.commit()  // å·²æäº¤

try {
  await AuditLogService.log({ ... })  // âŒ äº‹åŠ¡å¤–ï¼Œå¯èƒ½ä¸¢å¤±
} catch (error) {
  logger.error('å®¡è®¡æ—¥å¿—å¤±è´¥')  // âŒ ä¸šåŠ¡æˆåŠŸä½†æ—¥å¿—å¤±è´¥
}
```

### **æ‚²è§‚é”ç´¢å¼•æ”¯æŒ**

**å¼ºåˆ¶è¦æ±‚**: ä½¿ç”¨æ‚²è§‚é”çš„æŸ¥è¯¢æ¡ä»¶å¿…é¡»æœ‰ç´¢å¼•æ”¯æŒï¼Œé¿å…è¡¨é”

```javascript
// âœ… ç´¢å¼•æ”¯æŒçš„æ‚²è§‚é”
const item = await ItemInstance.findOne({
  where: { 
    item_instance_id: itemId,  // âœ… ä¸»é”®
    owner_user_id: userId       // âœ… æœ‰è”åˆç´¢å¼•
  },
  lock: transaction.LOCK.UPDATE,
  transaction
})

// ç¡®ä¿ç´¢å¼•å­˜åœ¨
// CREATE INDEX idx_item_owner ON item_instances(item_instance_id, owner_user_id)

// âŒ å±é™©ï¼šæ— ç´¢å¼•æ”¯æŒçš„æ‚²è§‚é”
const item = await ItemInstance.findOne({
  where: { 
    name: itemName  // âŒ æ— ç´¢å¼•ï¼Œé€€åŒ–ä¸ºè¡¨é”
  },
  lock: transaction.LOCK.UPDATE,
  transaction
})
```

---

## 7ï¸âƒ£ **æ€§èƒ½ä¼˜åŒ–å¼ºåˆ¶æ ‡å‡†**

### **ç¦æ­¢N+1æŸ¥è¯¢**

**å¼ºåˆ¶è¦æ±‚**: æ‰¹é‡æ•°æ®å¿…é¡»ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢ï¼Œç¦æ­¢å¾ªç¯æŸ¥è¯¢

```javascript
// âœ… æ‰¹é‡æŸ¥è¯¢
async function getUserAssets(userId) {
  // 1. æŸ¥è¯¢æ‰€æœ‰èµ„äº§è´¦æˆ·
  const accounts = await AssetAccount.findAll({
    where: { user_id: userId, balance: { [Op.gt]: 0 } }
  })
  
  // 2. æ‰¹é‡æŸ¥è¯¢èµ„äº§ç±»å‹
  const assetCodes = [...new Set(accounts.map(a => a.asset_code))]
  const assetTypes = await MaterialAssetType.findAll({
    where: { asset_code: { [Op.in]: assetCodes } }
  })
  
  // 3. å»ºç«‹æ˜ å°„
  const typeMap = new Map()
  assetTypes.forEach(t => typeMap.set(t.asset_code, t))
  
  // 4. ç»„è£…æ•°æ®
  return accounts.map(account => ({
    ...account.toJSON(),
    type: typeMap.get(account.asset_code)
  }))
}

// âŒ ç¦æ­¢ï¼šN+1æŸ¥è¯¢
async function getUserAssets(userId) {
  const accounts = await AssetAccount.findAll({ 
    where: { user_id: userId } 
  })
  
  // âŒ å¾ªç¯æŸ¥è¯¢ï¼ˆN+1ï¼‰
  for (const account of accounts) {
    const type = await MaterialAssetType.findOne({
      where: { asset_code: account.asset_code }
    })
    account.type = type
  }
  
  return accounts
}
```

### **Redis SCAN æ›¿ä»£ KEYS**

**å¼ºåˆ¶è¦æ±‚**: Redis ç”Ÿäº§ç¯å¢ƒç¦æ­¢ä½¿ç”¨ `KEYS` å‘½ä»¤ï¼Œå¿…é¡»ä½¿ç”¨ `SCAN`

```javascript
// âœ… ä½¿ç”¨ SCAN è¿­ä»£
async function _scanKeys(client, pattern) {
  const keys = new Set()
  let cursor = '0'
  
  do {
    const result = await client.scan(cursor, 'MATCH', pattern, 'COUNT', 100)
    cursor = result[0]
    const matchedKeys = result[1]
    matchedKeys.forEach(key => keys.add(key))
  } while (cursor !== '0')
  
  return Array.from(keys)
}

async function getStats(keyPattern = 'rate_limit:*') {
  const client = await this.redisClient.ensureConnection()
  const keys = await this._scanKeys(client, keyPattern)  // âœ… SCAN
  // ...
}

// âŒ ç¦æ­¢ï¼šç”Ÿäº§ç¯å¢ƒä½¿ç”¨ KEYS
async function getStats(keyPattern) {
  const keys = await client.keys(keyPattern)  // âŒ é˜»å¡Redisä¸»çº¿ç¨‹
  // ...
}
```

### **æ…¢æŸ¥è¯¢ç›‘æ§å’Œç´¢å¼•ä¼˜åŒ–**

**å¼ºåˆ¶è¦æ±‚**: å¿…é¡»å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—å¹¶å®šæœŸåˆ†æ

```sql
-- âœ… å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;  -- 1ç§’ä»¥ä¸Šç®—æ…¢æŸ¥è¯¢
SET GLOBAL log_queries_not_using_indexes = 'ON';

-- âœ… åˆ†ææ…¢æŸ¥è¯¢
-- mysqldumpslow -s t -t 10 /var/log/mysql/slow.log

-- âœ… å¸¸è§å¿…éœ€ç´¢å¼•
CREATE INDEX idx_item_instances_owner_status 
  ON item_instances(owner_user_id, status);

CREATE INDEX idx_market_listings_status_created 
  ON market_listings(status, created_at DESC);

CREATE INDEX idx_asset_balances_user_asset 
  ON account_asset_balances(user_id, asset_code);
```

---

## 8ï¸âƒ£ **æƒé™ç¼“å­˜å¤±æ•ˆå¼ºåˆ¶æ ‡å‡†**

### **æƒé™å˜æ›´è‡ªåŠ¨å¤±æ•ˆç¼“å­˜**

**å¼ºåˆ¶è¦æ±‚**: æ‰€æœ‰æƒé™å˜æ›´æ“ä½œå¿…é¡»è‡ªåŠ¨å¤±æ•ˆç›¸å…³ç¼“å­˜

```javascript
// âœ… æƒé™å˜æ›´è‡ªåŠ¨å¤±æ•ˆç¼“å­˜
class UserRoleService {
  static async updateUserRole(userId, roleName, options = {}) {
    const { transaction } = options
    
    // 1. æ›´æ–°è§’è‰²
    await UserRole.update(
      { role_name: roleName },
      { where: { user_id: userId }, transaction }
    )
    
    // 2. è‡ªåŠ¨æ¸…é™¤æƒé™ç¼“å­˜ï¼ˆå¿…éœ€ï¼‰
    await invalidateUserPermissions(userId, `role_change_${roleName}`)
    logger.info('æƒé™ç¼“å­˜å·²æ¸…é™¤', { 
      user_id: userId, 
      reason: `è§’è‰²å˜æ›´ ${roleName}` 
    })
    
    // 3. æƒé™é™çº§æ—¶å¼ºåˆ¶æ–­å¼€WebSocket
    if (targetRole.role_level < 100) {
      try {
        const ChatWebSocketService = require('./ChatWebSocketService')
        ChatWebSocketService.disconnectUser(userId, 'admin')
        logger.info('ç”¨æˆ·æƒé™é™çº§ï¼Œå·²æ–­å¼€WebSocket', { user_id: userId })
      } catch (wsError) {
        logger.warn('æ–­å¼€WebSocketå¤±è´¥ï¼ˆéè‡´å‘½ï¼‰', { error: wsError.message })
      }
    }
  }
}

// âŒ ç¦æ­¢ï¼šæƒé™å˜æ›´ä½†ä¸å¤±æ•ˆç¼“å­˜
static async updateUserRole(userId, roleName) {
  await UserRole.update({ role_name: roleName }, { where: { user_id: userId } })
  // âŒ ç¼ºå°‘ invalidateUserPermissions()
  // ç»“æœï¼šç”¨æˆ·ä»ä»¥æ—§æƒé™è®¿é—®
}
```

### **è´¦å·ç¦ç”¨å¼ºåˆ¶æ–­å¼€è¿æ¥**

**å¼ºåˆ¶è¦æ±‚**: è´¦å·ç¦ç”¨/åœç”¨æ—¶å¿…é¡»æ–­å¼€æ‰€æœ‰WebSocketè¿æ¥

```javascript
// âœ… è´¦å·ç¦ç”¨è‡ªåŠ¨æ–­å¼€è¿æ¥
class UserRoleService {
  static async updateUserStatus(userId, status, options = {}) {
    const { transaction } = options
    
    // 1. æ›´æ–°çŠ¶æ€
    await User.update(
      { status: status },
      { where: { user_id: userId }, transaction }
    )
    
    // 2. è‡ªåŠ¨æ¸…é™¤æƒé™ç¼“å­˜
    await invalidateUserPermissions(userId, `status_change_${status}`)
    
    // 3. ç¦ç”¨/åœç”¨æ—¶æ–­å¼€æ‰€æœ‰è¿æ¥ï¼ˆå¿…éœ€ï¼‰
    if (status === 'inactive' || status === 'banned') {
      try {
        const ChatWebSocketService = require('./ChatWebSocketService')
        ChatWebSocketService.disconnectUser(userId, 'user')
        ChatWebSocketService.disconnectUser(userId, 'admin')
        logger.info('ç”¨æˆ·è¢«ç¦ç”¨ï¼Œå·²æ–­å¼€æ‰€æœ‰WebSocket', { 
          user_id: userId,
          new_status: status 
        })
      } catch (wsError) {
        logger.warn('æ–­å¼€WebSocketå¤±è´¥ï¼ˆéè‡´å‘½ï¼‰', { error: wsError.message })
      }
    }
  }
}

// âŒ ç¦æ­¢ï¼šè´¦å·ç¦ç”¨ä½†ä¸æ–­å¼€è¿æ¥
static async updateUserStatus(userId, status) {
  await User.update({ status }, { where: { user_id: userId } })
  // âŒ ç¼ºå°‘æ–­å¼€è¿æ¥é€»è¾‘
  // ç»“æœï¼šè¢«ç¦ç”¨ç”¨æˆ·ä»å¯æ”¶å‘WebSocketæ¶ˆæ¯
}
```

### **ç¼“å­˜å¤±æ•ˆå‡½æ•°æ ‡å‡†å®ç°**

**å¼ºåˆ¶è¦æ±‚**: å¿…é¡»å®ç°ç»Ÿä¸€çš„ç¼“å­˜å¤±æ•ˆå‡½æ•°

```javascript
// âœ… ç»Ÿä¸€ç¼“å­˜å¤±æ•ˆå‡½æ•°
const memoryCache = new Map()
const { getRedisClient } = require('./utils/UnifiedRedisClient')

async function invalidateUserPermissions(user_id, reason = 'unknown') {
  // 1. æ¸…é™¤å†…å­˜ç¼“å­˜
  memoryCache.delete(`permissions_${user_id}`)
  
  // 2. æ¸…é™¤Redisç¼“å­˜
  try {
    const redisClient = await getRedisClient()
    await redisClient.del(`permissions:${user_id}`)
  } catch (error) {
    logger.error('æ¸…é™¤Redisç¼“å­˜å¤±è´¥', { 
      user_id, 
      error: error.message 
    })
  }
  
  // 3. è®°å½•æ—¥å¿—
  logger.info('æ¸…é™¤ç”¨æˆ·æƒé™ç¼“å­˜', { 
    user_id, 
    reason,
    timestamp: new Date().toISOString()
  })
}

module.exports = { invalidateUserPermissions }

// âŒ ç¦æ­¢ï¼šç¼“å­˜å¤±æ•ˆä¸å®Œæ•´
async function invalidateUserPermissions(user_id) {
  memoryCache.delete(`permissions_${user_id}`)
  // âŒ é—æ¼Redisç¼“å­˜
  // âŒ æ— æ—¥å¿—è®°å½•
}
```

---

## 9ï¸âƒ£ **è´¨é‡æ£€æŸ¥æ¸…å•**

### **P0çº§ï¼ˆå½±å“å®‰å…¨/æ•°æ®ä¸€è‡´æ€§ï¼‰**

- [ ] æ‰€æœ‰APIå“åº”ä½¿ç”¨ç»Ÿä¸€æ ¼å¼ï¼ˆsuccess/code/message/data/timestamp/version/request_idï¼‰
- [ ] HTTPçŠ¶æ€ç ä¸ä¸šåŠ¡ç æ˜ç¡®åˆ†ç¦»ï¼ˆHTTPä»…ä¼ è¾“å±‚ï¼Œcodeå­—æ®µä¸šåŠ¡å±‚ï¼‰
- [ ] WebSocketæ¡æ‰‹å¼ºåˆ¶JWTé‰´æƒ
- [ ] WebSocketèº«ä»½ç”±æœåŠ¡ç«¯ä»JWTåˆ¤å®šï¼Œç¦æ­¢ä¿¡ä»»å®¢æˆ·ç«¯å£°æ˜
- [ ] æ‰€æœ‰å¹‚ç­‰é”®ï¼ˆbusiness_idï¼‰æœ‰æ•°æ®åº“å±‚å”¯ä¸€çº¦æŸ
- [ ] ç”Ÿäº§ç¯å¢ƒä¸ä½¿ç”¨ `dotenv` çš„ `override` æ¨¡å¼
- [ ] `/health` ç«¯ç‚¹çœŸå®æ£€æŸ¥æ•°æ®åº“å’ŒRedisè¿æ¥

### **P1çº§ï¼ˆå½±å“æ€§èƒ½/è¿ç»´ï¼‰**

- [ ] ç¦æ­¢åœ¨æœåŠ¡ä»£ç ä¸­ä½¿ç”¨ `console.log/warn/error`ï¼ˆå¯åŠ¨é˜¶æ®µé™¤å¤–ï¼‰
- [ ] æ‰€æœ‰æ—¥å¿—åŒ…å« `request_id` ç”¨äºé“¾è·¯è¿½è¸ª
- [ ] å¯åŠ¨æ—¶å¼ºåˆ¶æ‰§è¡Œ `validateConfig()` æ ¡éªŒç¯å¢ƒå˜é‡
- [ ] æ•°æ®åº“é…ç½®ä¸åœ¨ `require` æ—¶ç«‹å³æ ¡éªŒ
- [ ] WebSocket CORSä½¿ç”¨ç™½åå•ï¼Œç¦æ­¢ `origin: '*'`
- [ ] æ‰¹é‡æŸ¥è¯¢é¿å…N+1é—®é¢˜
- [ ] Redisä½¿ç”¨ `SCAN` æ›¿ä»£ `KEYS`
- [ ] æƒé™å˜æ›´è‡ªåŠ¨å¤±æ•ˆç¼“å­˜å¹¶æ–­å¼€WebSocket
- [ ] è´¦å·ç¦ç”¨è‡ªåŠ¨æ–­å¼€æ‰€æœ‰WebSocketè¿æ¥
- [ ] åŒè½¨æ¶æ„æœ‰æ˜ç¡®çš„è¿ç§»æˆªæ­¢æ—¥æœŸ

### **P2çº§ï¼ˆæŠ€æœ¯å€ºåŠ¡ï¼‰**

- [ ] å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—å¹¶å®šæœŸåˆ†æ
- [ ] å…³é”®æŸ¥è¯¢æœ‰ç´¢å¼•æ”¯æŒï¼ˆowner_user_id, status, created_atç­‰ï¼‰
- [ ] æ‚²è§‚é”æŸ¥è¯¢æ¡ä»¶æœ‰ç´¢å¼•æ”¯æŒï¼ˆé¿å…è¡¨é”ï¼‰
- [ ] å®¡è®¡æ—¥å¿—åœ¨äº‹åŠ¡å†…æˆ–ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—
- [ ] å¤–é”®çº¦æŸå®Œæ•´ï¼ˆæ‰€æœ‰å…³è”è¡¨ï¼‰
- [ ] åºŸå¼ƒæ¥å£è¿”å›410å¹¶æä¾›è¿ç§»å¼•å¯¼

---

## ğŸ“‹ **æ ¸å¿ƒåŸåˆ™æ€»ç»“**

1. **å¥‘çº¦ä¼˜å…ˆ**: APIå“åº”æ ¼å¼ã€é”™è¯¯ç ã€å­—æ®µé›†åˆå¿…é¡»ç»Ÿä¸€
2. **å®‰å…¨ç¬¬ä¸€**: WebSocketé‰´æƒã€æƒé™ç¼“å­˜ã€å¹‚ç­‰æ€§æ§åˆ¶ä¸å¯å¦¥å
3. **çœŸå®æ£€æŸ¥**: å¥åº·æ£€æŸ¥ã€é…ç½®æ ¡éªŒå¿…é¡»çœŸå®æ‰§è¡Œï¼Œç¦æ­¢å ä½å®ç°
4. **å¯è§‚æµ‹æ€§**: ç»“æ„åŒ–æ—¥å¿—ã€request_idã€é”™è¯¯è¿½è¸ªå¿…é¡»å®Œæ•´
5. **æ€§èƒ½ä¿è¯**: ç¦æ­¢N+1æŸ¥è¯¢ã€KEYSæ‰«æã€æ— ç´¢å¼•çš„æ‚²è§‚é”
6. **ç¼“å­˜ä¸€è‡´æ€§**: æƒé™å˜æ›´å¿…é¡»ç«‹å³å¤±æ•ˆç¼“å­˜å¹¶æ–­å¼€è¿æ¥
7. **è¿ç§»å¯æ§**: åŒè½¨æ¶æ„å¿…é¡»æœ‰æˆªæ­¢æ—¥æœŸï¼Œæ—§æ¥å£æœ‰åºŸå¼ƒå¼•å¯¼

---

**æ ¸å¿ƒç†å¿µ**: ä»"é—®é¢˜ä¿®å¤"åˆ°"é—®é¢˜é¢„é˜²"ï¼Œå°†æŠ€æœ¯å€ºåŠ¡è½¬åŒ–ä¸ºå¼ºåˆ¶æ ‡å‡†ï¼Œå»ºç«‹å¯è½åœ°çš„è´¨é‡ä¿è¯ä½“ç³»ã€‚
