---
alwaysApply: true
lastUpdated: 2025å¹´10æœˆ03æ—¥ 17:05:11
---

# â° æ—¥æœŸæ—¶é—´å¤„ç†æ ‡å‡†ï¼ˆåŸºäºcursoræ–‡æ¡£æ—¶åŒºä¸ä¸€è‡´é—®é¢˜çš„ç»Ÿä¸€è§„èŒƒï¼‰

## ğŸ”´ **åŸºäºå®é™…æ—¶é—´å¤„ç†é—®é¢˜çš„æ ‡å‡†åŒ–ä½“ç³»**

### **å®é™…å‘ç°çš„æ—¶é—´å¤„ç†é—®é¢˜ç»Ÿè®¡**
ä»11ä¸ªcursoræ–‡æ¡£æ·±åº¦åˆ†æå‘ç°ï¼š
- **æ—¶åŒºä¸ä¸€è‡´é—®é¢˜**: GMT+8å¯¼å‡º vs UTCåº”ç”¨æ—¶é—´ï¼Œå‡ºç°15+æ¬¡
- **æ•°æ®åº“æ—¶é—´å­—æ®µæ··ç”¨**: `NOW()` vs `new Date()`æ··ç”¨ï¼Œå¯¼è‡´æ—¶åŒºä¸ä¸€è‡´8æ¬¡
- **æ—¥æœŸæ ¼å¼ä¸ç»Ÿä¸€**: ISOæ ¼å¼ã€æœ¬åœ°æ ¼å¼ã€UTCå­—ç¬¦ä¸²æ ¼å¼æ··ç”¨12+æ¬¡
- **ä¸´æ—¶IDæ—¶é—´æˆ³å†²çª**: `Date.now()`é«˜é¢‘ä½¿ç”¨å¯èƒ½å¯¼è‡´é‡å¤IDï¼Œå‘ç°20+å¤„
- **æ—¥æœŸèŒƒå›´æŸ¥è¯¢å¤æ‚**: å¤æ‚çš„æ—¶é—´è®¡ç®—ä»£ç ï¼Œå®¹æ˜“å‡ºé”™6æ¬¡

### **å®é™…å‘ç°çš„æ—¶åŒºæ··ä¹±æ¨¡å¼**
```markdown
# cursoræ–‡æ¡£ä¸­å‘ç°çš„å®é™…æ—¶åŒºä¸ä¸€è‡´é—®é¢˜ï¼š

## é—®é¢˜1ï¼šå¯¼å‡ºæ—¶é—´ vs åº”ç”¨æ—¶é—´ä¸ä¸€è‡´
å¯¼å‡ºæ—¶é—´ï¼š_Exported on 2025/8/13 at GMT+8 6:41:06_
åº”ç”¨æ—¶é—´ï¼š**æ›´æ–°æ—¶é—´**ï¼š2025å¹´08æœˆ05æ—¥ 23:03:15 UTC

## é—®é¢˜2ï¼šæ··åˆæ—¶é—´æ ¼å¼å’Œæ—¶åŒº
- `new Date().toLocaleString()` (æœ¬åœ°æ—¶é—´ï¼Œæ—¶åŒºä¸ç¡®å®š)
- `new Date().toISOString()` (UTCæ—¶é—´)
- `NOW()` (æ•°æ®åº“æœåŠ¡å™¨æ—¶é—´)
- æ‰‹åŠ¨æ ¼å¼åŒ–æ—¶é—´å­—ç¬¦ä¸²
```

## ğŸŒ **æ—¶åŒºä¸€è‡´æ€§å¼ºåˆ¶è§„èŒƒ**

### **å…¨ç³»ç»ŸUTCæ—¶é—´æ ‡å‡†åŒ–**
```javascript
// ğŸ”´ å¼ºåˆ¶è¦æ±‚ï¼šå…¨ç³»ç»Ÿç»Ÿä¸€ä½¿ç”¨UTCæ—¶é—´æ ‡å‡†
const UTC_TIME_STANDARD_SYSTEM = {
  // ç³»ç»Ÿæ—¶é—´é…ç½®æ ‡å‡†
  timeConfig: {
    // å†…éƒ¨å­˜å‚¨ï¼šå§‹ç»ˆUTC
    storage: 'UTC',
    // æ•°æ®åº“ï¼šç»Ÿä¸€UTCè®¾ç½®
    database: { timezone: 'UTC', sessionTimeZone: '+00:00' },
    // å‰ç«¯æ˜¾ç¤ºï¼šç”¨æˆ·æ—¶åŒºè‡ªé€‚åº”
    display: { userTimeZone: 'auto', format: 'YYYY-MM-DD HH:mm:ss' },
    // APIä¼ è¾“ï¼šISO8601æ ¼å¼
    api: { format: 'ISO8601', timezone: 'UTC' }
  },

  // ç»Ÿä¸€æ—¶é—´åˆ›å»ºå‡½æ•°
  createTime: {
    // UTCæ—¶é—´åˆ›å»ºï¼ˆç³»ç»Ÿå†…éƒ¨ä½¿ç”¨ï¼‰
    utc: () => new Date().toISOString(),
    
    // æ•°æ®åº“æ—¶é—´ï¼ˆSequelizeè‡ªåŠ¨å¤„ç†ï¼‰
    database: () => new Date(), // Sequelizeä¼šè‡ªåŠ¨è½¬æ¢ä¸ºUTCå­˜å‚¨
    
    // æ˜¾ç¤ºæ—¶é—´ï¼ˆç”¨æˆ·ç•Œé¢ï¼‰
    display: (utcTime, userTimeZone = 'UTC') => {
      return new Intl.DateTimeFormat('en-CA', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        timeZone: userTimeZone, hour12: false
      }).format(new Date(utcTime)).replace(',', '');
    }
  },

  // ç¦ç”¨çš„æ—¶é—´å¤„ç†æ–¹å¼ï¼ˆåŸºäºå®é™…é—®é¢˜å‘ç°ï¼‰
  forbiddenPatterns: [
    'new Date().toLocaleString()',  // æœ¬åœ°æ—¶é—´ï¼Œæ—¶åŒºä¸ç¡®å®š
    'NOW()',                        // æ•°æ®åº“æœåŠ¡å™¨æ—¶é—´ï¼Œå¯èƒ½ä¸ä¸€è‡´
    'CURRENT_TIMESTAMP',            // åŒæ ·é—®é¢˜
    'getTime()',                    // æ—¶é—´æˆ³ï¼Œä¸åŒ…å«æ—¶åŒºä¿¡æ¯
    'toString()'                    // åŒ…å«æ—¶åŒºä¿¡æ¯ï¼Œæ ¼å¼ä¸ç»Ÿä¸€
  ],

  // éªŒè¯æ—¶é—´å¤„ç†ä»£ç è§„èŒƒæ€§
  validateTimeUsage: (codeContent) => {
    const violations = [];
    
    UTC_TIME_STANDARD_SYSTEM.forbiddenPatterns.forEach(pattern => {
      if (codeContent.includes(pattern)) {
        violations.push(`ç¦ç”¨æ¨¡å¼: ${pattern}`);
      }
    });

    if (violations.length > 0) {
      console.error('ğŸš« æ—¶é—´å¤„ç†ä»£ç è¿è§„:');
      violations.forEach(v => console.error(`   âŒ ${v}`));
      return false;
    }

    console.log('âœ… æ—¶é—´å¤„ç†ä»£ç è§„èŒƒ');
    return true;
  }
};
```

## ğŸ“… **æ—¥æœŸæ ¼å¼ç»Ÿä¸€è§„èŒƒ**

### **æ ‡å‡†åŒ–æ—¥æœŸæ ¼å¼å®šä¹‰å’Œå¤„ç†**
```javascript
// ğŸ”´ å¼ºåˆ¶è¦æ±‚ï¼šç»Ÿä¸€æ—¥æœŸæ ¼å¼æ ‡å‡†ç³»ç»Ÿ
const DATE_FORMAT_STANDARD_SYSTEM = {
  // æ ‡å‡†æ ¼å¼å®šä¹‰
  formats: {
    // ISOæ ¼å¼ï¼šç³»ç»Ÿå†…éƒ¨ä¼ è¾“
    iso: {
      format: 'YYYY-MM-DDTHH:mm:ss.sssZ',
      example: '2025-10-03T17:05:11.000Z',
      usage: 'APIä¼ è¾“ã€æ•°æ®åº“å­˜å‚¨ã€æ—¥å¿—è®°å½•'
    },
    // æ˜¾ç¤ºæ ¼å¼ï¼šç”¨æˆ·ç•Œé¢
    display: {
      format: 'YYYY-MM-DD HH:mm:ss',
      example: '2025-10-03 17:05:11', 
      usage: 'å‰ç«¯æ˜¾ç¤ºã€æŠ¥è¡¨ç”Ÿæˆã€ç”¨æˆ·é€šçŸ¥'
    },
    // æ—¥æœŸæ ¼å¼ï¼šä»…æ—¥æœŸ
    date: {
      format: 'YYYY-MM-DD',
      example: '2025-10-03',
      usage: 'æ—¥æœŸé€‰æ‹©å™¨ã€æŠ¥è¡¨æ ‡é¢˜ã€ç»Ÿè®¡åˆ†ç»„'
    },
    // æ—¶é—´æ ¼å¼ï¼šä»…æ—¶é—´
    time: {
      format: 'HH:mm:ss',
      example: '17:05:11',
      usage: 'æ—¶é—´é€‰æ‹©å™¨ã€è¿è¡Œæ—¶é—´æ˜¾ç¤º'
    }
  },

  // ç»Ÿä¸€æ ¼å¼åŒ–å·¥å…·ç±»
  formatter: {
    // è½¬æ¢ä¸ºISOæ ¼å¼ï¼ˆç³»ç»Ÿå†…éƒ¨æ ‡å‡†ï¼‰
    toISO: (date) => new Date(date).toISOString(),
    
    // è½¬æ¢ä¸ºæ˜¾ç¤ºæ ¼å¼ï¼ˆç”¨æˆ·ç•Œé¢æ ‡å‡†ï¼‰
    toDisplay: (date, timezone = 'UTC') => {
      return new Intl.DateTimeFormat('en-CA', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        timeZone: timezone, hour12: false
      }).format(new Date(date)).replace(',', '');
    },
    
    // ä»…æ—¥æœŸæ ¼å¼
    toDate: (date) => new Date(date).toISOString().split('T')[0],
    
    // ä»…æ—¶é—´æ ¼å¼
    toTime: (date) => new Date(date).toISOString().split('T')[1].split('.')[0],
    
    // ç›¸å¯¹æ—¶é—´æ˜¾ç¤ºï¼ˆå¦‚ï¼š1å°æ—¶å‰ï¼‰
    toRelative: (utcTime) => {
      const now = new Date();
      const time = new Date(utcTime);
      const diffMs = now - time;
      const diffMinutes = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMinutes / 60);
      const diffDays = Math.floor(diffHours / 24);
      
      if (diffDays > 0) return `${diffDays}å¤©å‰`;
      if (diffHours > 0) return `${diffHours}å°æ—¶å‰`;  
      if (diffMinutes > 0) return `${diffMinutes}åˆ†é’Ÿå‰`;
      return 'åˆšåˆš';
    }
  }
};
```

## ğŸ†” **å®‰å…¨IDç”Ÿæˆè§„èŒƒ**

### **è§£å†³æ—¶é—´æˆ³å†²çªçš„IDç”Ÿæˆç³»ç»Ÿ**
```javascript
// ğŸ”´ è§£å†³cursoræ–‡æ¡£ä¸­å‘ç°çš„Date.now()å†²çªé£é™©
const SAFE_ID_GENERATION_SYSTEM = {
  // å†…éƒ¨è®¡æ•°å™¨ï¼ˆé¿å…é«˜å¹¶å‘å†²çªï¼‰
  _counter: 0,
  _sequence: 0,

  // IDç”Ÿæˆç­–ç•¥åº“
  strategies: {
    // é«˜ç²¾åº¦æ—¶é—´æˆ³ï¼ˆåŒ…å«æ¯«ç§’+éšæœºæ•°+è®¡æ•°å™¨ï¼‰
    highPrecision: () => {
      const now = Date.now();
      const random = Math.random().toString(36).substr(2, 6);
      const counter = (SAFE_ID_GENERATION_SYSTEM._counter++ % 1000).toString().padStart(3, '0');
      return `${now}_${random}_${counter}`;
    },

    // UUID v4ï¼ˆå®Œå…¨éšæœºï¼Œæ— æ—¶é—´ä¾èµ–ï¼‰
    uuid: () => {
      return require('uuid').v4();
    },

    // é›ªèŠ±ç®—æ³•ï¼ˆåˆ†å¸ƒå¼å”¯ä¸€IDï¼‰
    snowflake: (workerId = 1, datacenterId = 1) => {
      const timestamp = Date.now() - 1640995200000; // 2022-01-01 epoch
      const sequence = (SAFE_ID_GENERATION_SYSTEM._sequence++ % 4096);
      
      return ((timestamp << 22) | (datacenterId << 17) | (workerId << 12) | sequence).toString();
    }
  },

  // ä¸šåŠ¡IDç”Ÿæˆå™¨
  generateBusinessId: {
    // æ¶ˆæ¯IDï¼šmsg_20251003170511_a1b2c3d4
    message: () => {
      const timestamp = DATE_FORMAT_STANDARD_SYSTEM.formatter.toISO(new Date());
      const uuid = require('uuid').v4().substr(0, 8);
      return `msg_${timestamp.replace(/[-:T.]/g, '')}_${uuid}`;
    },

    // ä¼šè¯IDï¼šsession_20251003_a1b2c3d4e5f6
    session: () => {
      const dateStr = DATE_FORMAT_STANDARD_SYSTEM.formatter.toDate(new Date()).replace(/-/g, '');
      const uuid = require('uuid').v4().substr(0, 12);
      return `session_${dateStr}_${uuid}`;
    },

    // ä¸´æ—¶IDï¼štemp_1728048311123_a1b2c3_001
    temporary: (prefix = 'temp') => {
      return `${prefix}_${SAFE_ID_GENERATION_SYSTEM.strategies.highPrecision()}`;
    },

    // äº‹åŠ¡IDï¼šç”¨äºæ•°æ®åº“äº‹åŠ¡è¿½è¸ª
    transaction: () => {
      return `tx_${SAFE_ID_GENERATION_SYSTEM.strategies.snowflake()}`;
    }
  }
};
```

## â±ï¸ **æ—¶é—´è®¡ç®—å·¥å…·ç±»æ ‡å‡†åŒ–**

### **æ ‡å‡†æ—¶é—´è®¡ç®—å’ŒæŸ¥è¯¢å·¥å…·**
```javascript
// ğŸ”´ è§£å†³å¤æ‚æ—¶é—´è®¡ç®—çš„æ ‡å‡†åŒ–å·¥å…·ç±»
class StandardTimeCalculator {
  // ä»Šæ—¥æ—¶é—´èŒƒå›´ï¼ˆUTCåŸºå‡†ï¼‰
  static getTodayRange() {
    const now = new Date();
    const start = new Date(Date.UTC(
      now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 0, 0, 0, 0
    ));
    const end = new Date(Date.UTC(
      now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 23, 59, 59, 999
    ));
    
    return {
      start: start.toISOString(),
      end: end.toISOString(),
      display: `${DATE_FORMAT_STANDARD_SYSTEM.formatter.toDate(start)} å…¨å¤©`
    };
  }

  // Nå¤©å‰çš„æ—¶é—´
  static daysAgo(days) {
    const now = new Date();
    const past = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
    return past.toISOString();
  }

  // Nå°æ—¶å‰çš„æ—¶é—´
  static hoursAgo(hours) {
    const now = new Date();
    const past = new Date(now.getTime() - hours * 60 * 60 * 1000);
    return past.toISOString();
  }

  // æ—¶é—´å·®è®¡ç®—ï¼ˆè¿”å›æ˜“è¯»æ ¼å¼ï¼‰
  static timeDifference(startTime, endTime) {
    const start = new Date(startTime);
    const end = new Date(endTime);
    const diffMs = end - start;
    
    if (diffMs < 0) return 'æ—¶é—´é¡ºåºé”™è¯¯';
    
    const seconds = Math.floor(diffMs / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    
    if (days > 0) return `${days}å¤©${hours % 24}å°æ—¶${minutes % 60}åˆ†é’Ÿ`;
    if (hours > 0) return `${hours}å°æ—¶${minutes % 60}åˆ†é’Ÿ${seconds % 60}ç§’`;
    if (minutes > 0) return `${minutes}åˆ†é’Ÿ${seconds % 60}ç§’`;
    return `${seconds}ç§’`;
  }

  // æ•°æ®åº“æŸ¥è¯¢æ—¶é—´èŒƒå›´ç”Ÿæˆå™¨
  static createQueryRange(period) {
    const ranges = {
      today: StandardTimeCalculator.getTodayRange(),
      yesterday: {
        start: StandardTimeCalculator.daysAgo(1),
        end: StandardTimeCalculator.daysAgo(0)
      },
      lastWeek: {
        start: StandardTimeCalculator.daysAgo(7),
        end: new Date().toISOString()
      },
      lastMonth: {
        start: StandardTimeCalculator.daysAgo(30),
        end: new Date().toISOString()
      }
    };

    return ranges[period] || ranges.today;
  }
}

// æ•°æ®åº“æŸ¥è¯¢ç¤ºä¾‹ï¼ˆæ›¿ä»£å¤æ‚çš„æ—¶é—´è®¡ç®—ï¼‰
const timeQueryExamples = {
  // ä»Šæ—¥æ•°æ®æŸ¥è¯¢
  todayData: () => ({
    created_at: {
      [Op.gte]: StandardTimeCalculator.getTodayRange().start,
      [Op.lte]: StandardTimeCalculator.getTodayRange().end
    }
  }),
  
  // æœ€è¿‘ä¸€å‘¨æ•°æ®
  recentData: (days = 7) => ({
    created_at: {
      [Op.gte]: StandardTimeCalculator.daysAgo(days)
    }
  })
};
```

## ğŸ“ **æ—¥å¿—æ—¶é—´æˆ³æ ‡å‡†åŒ–ç³»ç»Ÿ**

### **ç»Ÿä¸€æ—¥å¿—æ—¶é—´æ ¼å¼**
```javascript
// ğŸ”´ ç»Ÿä¸€æ—¥å¿—æ—¶é—´æˆ³æ ¼å¼ç³»ç»Ÿ
class StandardLogger {
  static formatLogTime() {
    return new Date().toISOString();
  }

  static createLogEntry(level, message, data = {}) {
    const timestamp = StandardLogger.formatLogTime();
    const logEntry = {
      timestamp,
      level: level.toUpperCase(),
      message,
      ...data
    };

    // æ ‡å‡†åŒ–æ—¥å¿—è¾“å‡ºæ ¼å¼
    const formattedOutput = `[${timestamp}] ${logEntry.level}: ${message}`;
    
    if (Object.keys(data).length > 0) {
      console.log(formattedOutput, data);
    } else {
      console.log(formattedOutput);
    }

    return logEntry;
  }

  // æ ‡å‡†æ—¥å¿—çº§åˆ«æ–¹æ³•
  static info(message, data) { return StandardLogger.createLogEntry('info', message, data); }
  static warn(message, data) { return StandardLogger.createLogEntry('warn', message, data); }
  static error(message, data) { return StandardLogger.createLogEntry('error', message, data); }
  static debug(message, data) { return StandardLogger.createLogEntry('debug', message, data); }

  // æ“ä½œæ—¥å¿—ï¼ˆç”¨äºè®°å½•é‡è¦æ“ä½œï¼‰
  static operation(operationType, details) {
    return StandardLogger.createLogEntry('operation', `${operationType}æ“ä½œ`, {
      type: operationType,
      details: details,
      timestamp: StandardLogger.formatLogTime()
    });
  }
}

// ä½¿ç”¨ç¤ºä¾‹å’Œæ ‡å‡†
// âœ… æ­£ç¡®ä½¿ç”¨
StandardLogger.info('æœåŠ¡å¯åŠ¨', { port: 3000, env: 'development' });
// è¾“å‡º: [2025-10-03T17:05:11.000Z] INFO: æœåŠ¡å¯åŠ¨ { port: 3000, env: 'development' }

// âŒ ç¦æ­¢ä½¿ç”¨
// console.log('ğŸ“… æ—¶é—´:', new Date().toLocaleString()); // æ ¼å¼ä¸ç»Ÿä¸€ï¼Œæ—¶åŒºä¸æ˜ç¡®
```

## â° **æ—¶é—´æ•°æ®éªŒè¯å’Œé”™è¯¯å¤„ç†**

### **å®‰å…¨æ—¶é—´æ•°æ®å¤„ç†ç³»ç»Ÿ**
```javascript
// ğŸ”´ å¼ºåˆ¶è¦æ±‚ï¼šæ—¶é—´æ•°æ®éªŒè¯å’Œé”™è¯¯å¤„ç†ç³»ç»Ÿ
class TimeDataValidator {
  // æ—¶é—´æ ¼å¼éªŒè¯
  static isValidISO(timeString) {
    try {
      const date = new Date(timeString);
      return !isNaN(date.getTime()) && date.toISOString() === timeString;
    } catch {
      return false;
    }
  }

  // æ—¶é—´èŒƒå›´éªŒè¯
  static isValidRange(startTime, endTime) {
    try {
      const start = new Date(startTime);
      const end = new Date(endTime);
      return !isNaN(start.getTime()) && !isNaN(end.getTime()) && start <= end;
    } catch {
      return false;
    }
  }

  // å®‰å…¨æ—¶é—´è§£æ
  static safeParse(timeString, defaultValue = null) {
    try {
      const date = new Date(timeString);
      if (isNaN(date.getTime())) {
        console.warn(`âš ï¸ æ— æ•ˆæ—¶é—´å­—ç¬¦ä¸²: ${timeString}`);
        return defaultValue;
      }
      return date.toISOString();
    } catch (error) {
      console.error(`âŒ æ—¶é—´è§£æé”™è¯¯: ${error.message}`);
      return defaultValue;
    }
  }

  // æ—¶é—´èŒƒå›´å®‰å…¨è§£æ
  static parseTimeRange(startTime, endTime) {
    const start = TimeDataValidator.safeParse(startTime);
    const end = TimeDataValidator.safeParse(endTime);
    
    if (!start || !end) {
      throw new Error('æ—¶é—´èŒƒå›´è§£æå¤±è´¥');
    }

    if (!TimeDataValidator.isValidRange(start, end)) {
      throw new Error('æ— æ•ˆçš„æ—¶é—´èŒƒå›´ï¼šå¼€å§‹æ—¶é—´å¿…é¡»æ—©äºç»“æŸæ—¶é—´');
    }

    return { start, end };
  }
}

// APIå‚æ•°æ—¶é—´éªŒè¯ä¸­é—´ä»¶
function validateTimeParamsMiddleware(req, res, next) {
  const { start_time, end_time } = req.query;
  
  try {
    if (start_time && !TimeDataValidator.isValidISO(start_time)) {
      return res.status(400).json({ 
        error: 'Invalid start_time format, use ISO 8601 (YYYY-MM-DDTHH:mm:ss.sssZ)' 
      });
    }

    if (end_time && !TimeDataValidator.isValidISO(end_time)) {
      return res.status(400).json({ 
        error: 'Invalid end_time format, use ISO 8601 (YYYY-MM-DDTHH:mm:ss.sssZ)' 
      });
    }

    if (start_time && end_time && !TimeDataValidator.isValidRange(start_time, end_time)) {
      return res.status(400).json({ 
        error: 'Invalid time range: start_time must be before end_time' 
      });
    }

    next();
  } catch (error) {
    return res.status(400).json({ error: error.message });
  }
}
```

## ğŸ’¾ **æ—¶é—´è®¡ç®—ç¼“å­˜ä¼˜åŒ–ç³»ç»Ÿ**

### **é¢‘ç¹æ—¶é—´è®¡ç®—ç»“æœç¼“å­˜**
```javascript
// ğŸ”´ æ—¶é—´è®¡ç®—ç¼“å­˜ç³»ç»Ÿï¼ˆæå‡æ€§èƒ½ï¼‰
class TimeCalculationCache {
  constructor() {
    this.cache = new Map();
    this.cacheTTL = 60000; // 1åˆ†é’Ÿç¼“å­˜
  }

  // ç¼“å­˜æ—¶é—´è®¡ç®—ç»“æœ
  getCachedCalculation(cacheKey, calculationFunction) {
    const cached = this.cache.get(cacheKey);
    const now = Date.now();
    
    // æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ
    if (cached && (now - cached.timestamp) < this.cacheTTL) {
      console.log(`ğŸ’¾ ä½¿ç”¨ç¼“å­˜: ${cacheKey} (${Math.round((now-cached.timestamp)/1000)}ç§’å‰)`);
      return cached.value;
    }
    
    // æ‰§è¡Œè®¡ç®—å¹¶ç¼“å­˜
    console.log(`â³ è®¡ç®—: ${cacheKey}`);
    const value = calculationFunction();
    
    this.cache.set(cacheKey, {
      value: value,
      timestamp: now
    });
    
    return value;
  }

  // å¸¸ç”¨æ—¶é—´è®¡ç®—çš„ç¼“å­˜æ–¹æ³•
  getTodayStart() {
    return this.getCachedCalculation('today_start', () => 
      StandardTimeCalculator.getTodayRange().start);
  }

  getTodayEnd() {
    return this.getCachedCalculation('today_end', () => 
      StandardTimeCalculator.getTodayRange().end);
  }

  getCurrentWeekStart() {
    return this.getCachedCalculation('week_start', () => {
      const now = new Date();
      const weekStart = new Date(now.getTime() - (now.getDay() * 24 * 60 * 60 * 1000));
      return DATE_FORMAT_STANDARD_SYSTEM.formatter.toISO(weekStart);
    });
  }

  // æ¸…ç†è¿‡æœŸç¼“å­˜
  cleanup() {
    const now = Date.now();
    for (const [key, item] of this.cache.entries()) {
      if (now - item.timestamp > this.cacheTTL) {
        this.cache.delete(key);
      }
    }
  }
}

// å…¨å±€æ—¶é—´ç¼“å­˜å®ä¾‹
const globalTimeCache = new TimeCalculationCache();
setInterval(() => globalTimeCache.cleanup(), 60000); // æ¯åˆ†é’Ÿæ¸…ç†è¿‡æœŸç¼“å­˜
```

## ğŸ§ª **æ—¶é—´å¤„ç†æµ‹è¯•éªŒè¯è§„èŒƒ**

### **æ—¶é—´å¤„ç†åŠŸèƒ½å•å…ƒæµ‹è¯•æ ‡å‡†**
```javascript
// ğŸ”´ å¼ºåˆ¶è¦æ±‚ï¼šæ—¶é—´å¤„ç†åŠŸèƒ½å¿…é¡»æœ‰å®Œæ•´çš„å•å…ƒæµ‹è¯•
describe('æ—¶é—´å¤„ç†æ ‡å‡†åŒ–æµ‹è¯•', () => {
  describe('StandardTimeCalculator', () => {
    test('getTodayRangeè¿”å›ä»Šæ—¥UTCæ—¶é—´èŒƒå›´', () => {
      const range = StandardTimeCalculator.getTodayRange();
      expect(range.start).toMatch(/T00:00:00\.000Z$/);
      expect(range.end).toMatch(/T23:59:59\.999Z$/);
    });

    test('daysAgoè®¡ç®—æ­£ç¡®çš„è¿‡å»æ—¶é—´', () => {
      const threeDaysAgo = StandardTimeCalculator.daysAgo(3);
      const now = new Date();
      const past = new Date(threeDaysAgo);
      const diffDays = Math.floor((now - past) / (24 * 60 * 60 * 1000));
      expect(diffDays).toBe(3);
    });

    test('timeDifferenceæ ¼å¼åŒ–æ—¶é—´å·®æ˜¾ç¤º', () => {
      const start = '2025-10-03T17:00:00.000Z';
      const end = '2025-10-03T17:05:11.000Z';
      const diff = StandardTimeCalculator.timeDifference(start, end);
      expect(diff).toBe('5åˆ†é’Ÿ11ç§’');
    });
  });

  describe('TimeDataValidator', () => {
    test('éªŒè¯ISOæ ¼å¼æ­£ç¡®æ€§', () => {
      expect(TimeDataValidator.isValidISO('2025-10-03T17:05:11.000Z')).toBe(true);
      expect(TimeDataValidator.isValidISO('2025-10-03 17:05:11')).toBe(false);
      expect(TimeDataValidator.isValidISO('invalid')).toBe(false);
    });

    test('éªŒè¯æ—¶é—´èŒƒå›´æ­£ç¡®æ€§', () => {
      const start = '2025-10-03T17:00:00.000Z';
      const end = '2025-10-03T17:05:11.000Z';
      expect(TimeDataValidator.isValidRange(start, end)).toBe(true);
      expect(TimeDataValidator.isValidRange(end, start)).toBe(false);
    });
  });

  describe('SAFE_ID_GENERATION_SYSTEM', () => {
    test('ç”Ÿæˆçš„IDåº”è¯¥æ˜¯å”¯ä¸€çš„', () => {
      const ids = new Set();
      for (let i = 0; i < 1000; i++) {
        const id = SAFE_ID_GENERATION_SYSTEM.strategies.highPrecision();
        expect(ids.has(id)).toBe(false);
        ids.add(id);
      }
    });

    test('ä¸šåŠ¡IDæ ¼å¼åº”è¯¥æ­£ç¡®', () => {
      const messageId = SAFE_ID_GENERATION_SYSTEM.generateBusinessId.message();
      expect(messageId).toMatch(/^msg_\d{14}_[a-f0-9]{8}$/);
      
      const sessionId = SAFE_ID_GENERATION_SYSTEM.generateBusinessId.session();
      expect(sessionId).toMatch(/^session_\d{8}_[a-f0-9]{12}$/);
    });
  });
});
```

## ğŸ”„ **æ—¶é—´æ•°æ®è¿ç§»å·¥å…·**

### **ç°æœ‰æ—¶é—´æ•°æ®è¿ç§»å’ŒéªŒè¯**
```sql
-- æ—¶åŒºæ•°æ®è¿ç§»å’ŒéªŒè¯è„šæœ¬
-- ğŸ”´ åŸºäºå®é™…æ—¶åŒºä¸ä¸€è‡´é—®é¢˜çš„è¿ç§»æ–¹æ¡ˆ

-- 1. åˆ›å»ºè¿ç§»è„šæœ¬
CREATE PROCEDURE MigrateTimeDataToUTC()
BEGIN
  DECLARE done INT DEFAULT FALSE;
  DECLARE table_name VARCHAR(64);
  DECLARE time_column VARCHAR(64);
  
  -- å£°æ˜æ¸¸æ ‡éå†æ‰€æœ‰æ—¶é—´å­—æ®µ
  DECLARE time_cursor CURSOR FOR 
    SELECT TABLE_NAME, COLUMN_NAME 
    FROM INFORMATION_SCHEMA.COLUMNS 
    WHERE TABLE_SCHEMA = DATABASE() 
    AND DATA_TYPE IN ('datetime', 'timestamp');
  
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
  
  -- å¼€å¯äº‹åŠ¡
  START TRANSACTION;
  
  OPEN time_cursor;
  
  read_loop: LOOP
    FETCH time_cursor INTO table_name, time_column;
    IF done THEN
      LEAVE read_loop;
    END IF;
    
    -- ä¸ºæ¯ä¸ªè¡¨æ·»åŠ UTCæ—¶é—´å­—æ®µ
    SET @sql = CONCAT('ALTER TABLE ', table_name, 
                     ' ADD COLUMN ', time_column, '_utc DATETIME');
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    
    -- è½¬æ¢ç°æœ‰æ•°æ®ï¼ˆå‡è®¾åŸæ•°æ®ä¸ºGMT+8ï¼‰
    SET @sql = CONCAT('UPDATE ', table_name, 
                     ' SET ', time_column, '_utc = DATE_SUB(', time_column, ', INTERVAL 8 HOUR)',
                     ' WHERE ', time_column, ' IS NOT NULL');
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    
  END LOOP;
  
  CLOSE time_cursor;
  COMMIT;
  
  SELECT 'âœ… æ—¶åŒºæ•°æ®è¿ç§»å®Œæˆ' as result;
END;

-- 2. éªŒè¯è¿ç§»ç»“æœ
SELECT 
  'users' as table_name,
  COUNT(*) as total_records,
  COUNT(created_at_utc) as migrated_records,
  AVG(TIMESTAMPDIFF(HOUR, created_at_utc, created_at)) as avg_hour_diff
FROM users;

-- 3. åˆ‡æ¢åˆ°UTCå­—æ®µï¼ˆéªŒè¯æ— è¯¯åæ‰§è¡Œï¼‰
-- ALTER TABLE users DROP COLUMN created_at;
-- ALTER TABLE users CHANGE created_at_utc created_at DATETIME;
```

## ğŸ“‹ **æ—¶é—´å¤„ç†å®æ–½æ£€æŸ¥æ¸…å•**

### **æ¯æ¬¡æ—¶é—´ç›¸å…³å¼€å‘å‰**
- [ ] ç¡®è®¤ä½¿ç”¨UTCä½œä¸ºå†…éƒ¨å­˜å‚¨æ ‡å‡†
- [ ] éªŒè¯æ—¶é—´æ ¼å¼ä½¿ç”¨ISO8601æ ‡å‡†
- [ ] æ£€æŸ¥æ—¶åŒºå¤„ç†çš„ä¸€è‡´æ€§
- [ ] å‡†å¤‡æ—¶é—´æ•°æ®éªŒè¯æœºåˆ¶

### **æ•°æ®åº“æ—¶é—´å­—æ®µè®¾è®¡æ—¶**
- [ ] ä½¿ç”¨Sequelizeçš„DataTypes.DATEç±»å‹
- [ ] é¿å…ç›´æ¥ä½¿ç”¨NOW()æˆ–CURRENT_TIMESTAMP
- [ ] å»ºç«‹ç»Ÿä¸€çš„æ—¶é—´æŸ¥è¯¢æ–¹æ³•
- [ ] è®¾ç½®åˆé€‚çš„é»˜è®¤å€¼å’Œçº¦æŸ

### **å‰ç«¯æ—¶é—´æ˜¾ç¤ºæ—¶**
- [ ] è‡ªåŠ¨æ£€æµ‹ç”¨æˆ·æ—¶åŒº
- [ ] ä½¿ç”¨ç»Ÿä¸€çš„æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
- [ ] æä¾›ç›¸å¯¹æ—¶é—´æ˜¾ç¤ºé€‰é¡¹
- [ ] ç¡®ä¿æ—¶é—´æ˜¾ç¤ºçš„å¯è¯»æ€§

### **APIæ—¶é—´å‚æ•°å¤„ç†æ—¶**
- [ ] å¼ºåˆ¶ä½¿ç”¨ISO8601æ ¼å¼
- [ ] æ·»åŠ æ—¶é—´å‚æ•°éªŒè¯ä¸­é—´ä»¶
- [ ] æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- [ ] è®°å½•æ—¶é—´ç›¸å…³çš„æ“ä½œæ—¥å¿—

---

**æ ¸å¿ƒåŸåˆ™**: UTCæ—¶é—´æ ‡å‡†åŒ–ã€æ ¼å¼å¼ºåˆ¶ç»Ÿä¸€ã€æ—¶åŒºå¤„ç†ä¸€è‡´ã€IDç”Ÿæˆå®‰å…¨ã€éªŒè¯æœºåˆ¶å®Œæ•´