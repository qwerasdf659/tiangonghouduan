---
alwaysApply: true
---
# æ—¥æœŸæ—¶é—´å¤„ç†è§„èŒƒï¼ˆåŸºäºå®é™…é—®é¢˜åˆ†æç‰ˆï¼‰

## ğŸ”´ åŸºäºå®é™…cursoræ–‡æ¡£å‘ç°çš„æ—¶é—´å¤„ç†é—®é¢˜

### å®é™…å‘ç°çš„æ—¶é—´å¤„ç†é—®é¢˜ç»Ÿè®¡
ä»11ä¸ªcursoræ–‡æ¡£æ·±åº¦åˆ†æå‘ç°ï¼š
- **æ—¶åŒºä¸ä¸€è‡´é—®é¢˜**ï¼šGMT+8å¯¼å‡º vs UTCåº”ç”¨æ—¶é—´ï¼Œå‡ºç°15+æ¬¡
- **æ•°æ®åº“æ—¶é—´å­—æ®µæ··ç”¨**ï¼š`NOW()` vs `new Date()`æ··ç”¨ï¼Œå¯¼è‡´æ—¶åŒºä¸ä¸€è‡´8æ¬¡
- **æ—¥æœŸæ ¼å¼ä¸ç»Ÿä¸€**ï¼šISOæ ¼å¼ã€æœ¬åœ°æ ¼å¼ã€UTCå­—ç¬¦ä¸²æ ¼å¼æ··ç”¨12+æ¬¡
- **ä¸´æ—¶IDæ—¶é—´æˆ³å†²çª**ï¼š`Date.now()`é«˜é¢‘ä½¿ç”¨å¯èƒ½å¯¼è‡´é‡å¤IDï¼Œå‘ç°20+å¤„
- **æ—¥æœŸèŒƒå›´æŸ¥è¯¢å¤æ‚**ï¼šå¤æ‚çš„æ—¶é—´è®¡ç®—ä»£ç ï¼Œå®¹æ˜“å‡ºé”™6æ¬¡

## æ—¶åŒºä¸€è‡´æ€§å¼ºåˆ¶è§„èŒƒ

### å®é™…å‘ç°çš„æ—¶åŒºä¸ä¸€è‡´é—®é¢˜
```markdown
# cursoræ–‡æ¡£ä¸­å‘ç°çš„å®é™…é—®é¢˜ï¼š

## é—®é¢˜1ï¼šå¯¼å‡ºæ—¶é—´ vs åº”ç”¨æ—¶é—´ä¸ä¸€è‡´
å¯¼å‡ºï¼š_Exported on 2025/8/13 at GMT+8 6:41:06_
åº”ç”¨ï¼š**æ›´æ–°æ—¶é—´**ï¼š2025å¹´08æœˆ05æ—¥ 23:03:15 UTC

## é—®é¢˜2ï¼šæ··åˆä½¿ç”¨æœ¬åœ°æ—¶é—´å’ŒUTC
- `new Date().toLocaleString()` (æœ¬åœ°æ—¶é—´)
- `new Date().toISOString()` (UTCæ—¶é—´)
- `NOW()` (æ•°æ®åº“æœåŠ¡å™¨æ—¶é—´)
```

### æ—¶åŒºæ ‡å‡†åŒ–å¼ºåˆ¶è¦æ±‚
```javascript
// ğŸ”´ å¼ºåˆ¶è¦æ±‚ï¼šå…¨ç³»ç»Ÿç»Ÿä¸€ä½¿ç”¨UTCæ—¶é—´
const TIME_ZONE_STANDARDS = {
  // ç³»ç»Ÿå†…éƒ¨å­˜å‚¨ï¼šå§‹ç»ˆä½¿ç”¨UTC
  storage: 'UTC',
  
  // æ•°æ®åº“æ—¶é—´ï¼šç»Ÿä¸€æ—¶åŒºè®¾ç½®
  database: {
    timezone: 'UTC',
    sessionTimeZone: '+00:00'
  },
  
  // å‰ç«¯æ˜¾ç¤ºï¼šæ ¹æ®ç”¨æˆ·æ—¶åŒºæ˜¾ç¤º
  display: {
    userTimeZone: 'auto', // è‡ªåŠ¨æ£€æµ‹ç”¨æˆ·æ—¶åŒº
    format: 'YYYY-MM-DD HH:mm:ss'
  },
  
  // APIä¼ è¾“ï¼šç»Ÿä¸€ISOæ ¼å¼
  api: {
    format: 'ISO8601', // 2025-01-21T10:30:00.000Z
    timezone: 'UTC'
  }
};

// æ—¶é—´åˆ›å»ºç»Ÿä¸€å‡½æ•°
function createUTCTime() {
  return new Date().toISOString();
}

// æ•°æ®åº“æ—¶é—´å­—æ®µç»Ÿä¸€å¤„ç†
function createDBTime() {
  // ğŸ”´ ç¦æ­¢æ··ç”¨ï¼šç»Ÿä¸€ä½¿ç”¨Sequelizeçš„æ—¶é—´å¤„ç†
  return new Date(); // Sequelizeä¼šè‡ªåŠ¨è½¬æ¢ä¸ºUTCå­˜å‚¨
}

// ç¦æ­¢ä½¿ç”¨çš„æ—¶é—´å¤„ç†æ–¹å¼
const FORBIDDEN_TIME_PATTERNS = [
  'new Date().toLocaleString()', // æœ¬åœ°æ—¶é—´ï¼Œæ—¶åŒºä¸ç¡®å®š
  'NOW()', // æ•°æ®åº“æœåŠ¡å™¨æ—¶é—´ï¼Œå¯èƒ½ä¸åº”ç”¨æ—¶åŒºä¸ä¸€è‡´
  'CURRENT_TIMESTAMP', // åŒæ ·çš„é—®é¢˜
  'getTime()', // æ—¶é—´æˆ³ï¼Œä¸åŒ…å«æ—¶åŒºä¿¡æ¯
];
```

## æ•°æ®åº“æ—¶é—´å­—æ®µå¤„ç†ç»Ÿä¸€è§„èŒƒ

### å®é™…å‘ç°çš„æ•°æ®åº“æ—¶é—´å¤„ç†é—®é¢˜
ä»cursor_8.mdå’Œcursor_1.mdå‘ç°çš„å®é™…é”™è¯¯ï¼š
```sql
-- âŒ é”™è¯¯ï¼šæ··ç”¨NOW()å’Œåº”ç”¨æ—¶é—´
UPDATE users SET is_admin=false, updated_at=NOW()  -- æ•°æ®åº“æ—¶é—´
-- åº”ç”¨ä¸­ä½¿ç”¨: updated_at: new Date()              -- åº”ç”¨æ—¶é—´

-- âŒ é”™è¯¯ï¼šå¤æ‚çš„æ—¶é—´è®¡ç®—
created_at: { [sequelize.Op.gte]: new Date(new Date().setHours(0,0,0,0)) }
```

### æ•°æ®åº“æ—¶é—´å­—æ®µæ ‡å‡†åŒ–å¤„ç†
```javascript
// ğŸ”´ å¼ºåˆ¶è¦æ±‚ï¼šæ•°æ®åº“æ—¶é—´å­—æ®µç»Ÿä¸€å¤„ç†è§„èŒƒ
const DB_TIME_STANDARDS = {
  // åˆ›å»ºæ—¶é—´ï¼šä½¿ç”¨Sequelizeé»˜è®¤
  created_at: {
    type: DataTypes.DATE,
    defaultValue: DataTypes.NOW, // Sequelizeå¤„ç†ï¼Œè‡ªåŠ¨UTC
    allowNull: false
  },
  
  // æ›´æ–°æ—¶é—´ï¼šè‡ªåŠ¨æ›´æ–°
  updated_at: {
    type: DataTypes.DATE,
    defaultValue: DataTypes.NOW,
    allowNull: false
  },
  
  // ä¸šåŠ¡æ—¶é—´ï¼šæ˜ç¡®æŒ‡å®šUTC
  business_time: {
    type: DataTypes.DATE,
    get() {
      return this.getDataValue('business_time')?.toISOString();
    },
    set(value) {
      this.setDataValue('business_time', new Date(value));
    }
  }
};

// ç»Ÿä¸€çš„æ—¶é—´æŸ¥è¯¢æ–¹æ³•
class TimeQuery {
  // ä»Šæ—¥æ•°æ®æŸ¥è¯¢ï¼ˆUTCåŸºå‡†ï¼‰
  static getTodayRange() {
    const now = new Date();
    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const todayEnd = new Date(todayStart.getTime() + 24 * 60 * 60 * 1000);
    
    return {
      start: todayStart.toISOString(),
      end: todayEnd.toISOString()
    };
  }
  
  // æ—¶é—´èŒƒå›´æŸ¥è¯¢ç»Ÿä¸€æ–¹æ³•
  static getDateRange(days) {
    const now = new Date();
    const start = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
    
    return {
      [Op.gte]: start.toISOString(),
      [Op.lte]: now.toISOString()
    };
  }
}

// æ•°æ®åº“æŸ¥è¯¢ä¸­çš„æ—¶é—´å¤„ç†
const todayData = await Model.findAll({
  where: {
    created_at: TimeQuery.getDateRange(1) // æœ€è¿‘1å¤©
  }
});
```

## æ—¥æœŸæ ¼å¼ç»Ÿä¸€è§„èŒƒ

### å®é™…å‘ç°çš„æ ¼å¼ä¸ä¸€è‡´é—®é¢˜
```javascript
// cursoræ–‡æ¡£ä¸­å‘ç°çš„å®é™…æ ¼å¼æ··ä¹±ï¼š
// æ ¼å¼1: "2025å¹´08æœˆ05æ—¥ 23:03:15 UTC"
// æ ¼å¼2: "2025-08-08 00:58:06 UTC"  
// æ ¼å¼3: "2025-08-08T20:29:45Z"
// æ ¼å¼4: new Date().toLocaleString() // æœ¬åœ°æ ¼å¼ï¼Œä¸å¯æ§
```

### æ ‡å‡†æ—¥æœŸæ ¼å¼å®šä¹‰
```javascript
// ğŸ”´ å¼ºåˆ¶è¦æ±‚ï¼šç»Ÿä¸€æ—¥æœŸæ ¼å¼æ ‡å‡†
const DATE_FORMAT_STANDARDS = {
  // ISOæ ¼å¼ï¼šç³»ç»Ÿå†…éƒ¨ä¼ è¾“ä½¿ç”¨
  iso: {
    format: 'YYYY-MM-DDTHH:mm:ss.sssZ',
    example: '2025-01-21T10:30:00.000Z',
    usage: 'APIä¼ è¾“ã€æ•°æ®åº“å­˜å‚¨ã€æ—¥å¿—è®°å½•'
  },
  
  // æ˜¾ç¤ºæ ¼å¼ï¼šç”¨æˆ·ç•Œé¢æ˜¾ç¤º
  display: {
    format: 'YYYY-MM-DD HH:mm:ss',
    example: '2025-01-21 10:30:00',
    usage: 'å‰ç«¯æ˜¾ç¤ºã€æŠ¥è¡¨ç”Ÿæˆã€ç”¨æˆ·é€šçŸ¥'
  },
  
  // æ—¥æœŸæ ¼å¼ï¼šä»…æ—¥æœŸæ˜¾ç¤º
  date: {
    format: 'YYYY-MM-DD',
    example: '2025-01-21',
    usage: 'æ—¥æœŸé€‰æ‹©å™¨ã€æŠ¥è¡¨æ ‡é¢˜ã€ç»Ÿè®¡åˆ†ç»„'
  },
  
  // æ—¶é—´æ ¼å¼ï¼šä»…æ—¶é—´æ˜¾ç¤º
  time: {
    format: 'HH:mm:ss',
    example: '10:30:00',
    usage: 'æ—¶é—´é€‰æ‹©å™¨ã€è¿è¡Œæ—¶é—´æ˜¾ç¤º'
  }
};

// ç»Ÿä¸€æ ¼å¼åŒ–å‡½æ•°
class DateFormatter {
  // ISOæ ¼å¼ï¼ˆç³»ç»Ÿå†…éƒ¨ï¼‰
  static toISO(date) {
    return new Date(date).toISOString();
  }
  
  // æ˜¾ç¤ºæ ¼å¼ï¼ˆç”¨æˆ·ç•Œé¢ï¼‰
  static toDisplay(date, timezone = 'UTC') {
    return new Intl.DateTimeFormat('en-CA', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      timeZone: timezone,
      hour12: false
    }).format(new Date(date)).replace(',', '');
  }
  
  // æ—¥æœŸæ ¼å¼
  static toDate(date) {
    return new Date(date).toISOString().split('T')[0];
  }
  
  // æ—¶é—´æ ¼å¼
  static toTime(date) {
    return new Date(date).toISOString().split('T')[1].split('.')[0];
  }
}

// ç¦æ­¢ä½¿ç”¨çš„æ ¼å¼åŒ–æ–¹æ³•
const FORBIDDEN_FORMAT_METHODS = [
  'toLocaleString()', // ä¾èµ–ç³»ç»Ÿlocaleï¼Œä¸å¯æ§
  'toString()',       // åŒ…å«æ—¶åŒºä¿¡æ¯ï¼Œæ ¼å¼ä¸ç»Ÿä¸€
  'toDateString()',   // è‹±æ–‡æ ¼å¼ï¼Œä¸é€‚åˆå›½é™…åŒ–
  'toTimeString()'    // åŒ…å«æ—¶åŒºç®€å†™ï¼Œå¯èƒ½ä¸å‡†ç¡®
];
```

## ä¸´æ—¶IDç”Ÿæˆè§„èŒƒï¼ˆè§£å†³æ—¶é—´æˆ³å†²çªï¼‰

### å®é™…å‘ç°çš„IDå†²çªé£é™©
```javascript
// cursoræ–‡æ¡£ä¸­å‘ç°çš„æ½œåœ¨é—®é¢˜ï¼š
const messageId = `msg_${Date.now()}_${uuidv4().substr(0, 8)}` // é«˜å¹¶å‘ä¸‹å¯èƒ½é‡å¤
const sessionId = `session_${Date.now()}_${uuidv4().substr(0, 8)}` // åŒæ ·é—®é¢˜
const tempMessageId = 'temp_' + Date.now() // æ›´é«˜é£é™©
```

### å®‰å…¨IDç”Ÿæˆè§„èŒƒ
```javascript
// ğŸ”´ å¼ºåˆ¶è¦æ±‚ï¼šå®‰å…¨çš„ä¸´æ—¶IDç”Ÿæˆæœºåˆ¶
const ID_GENERATION_STANDARDS = {
  // é«˜ç²¾åº¦æ—¶é—´æˆ³ï¼šåŒ…å«æ¯«ç§’å’Œéšæœºæ•°
  highPrecision: () => {
    const now = Date.now();
    const random = Math.random().toString(36).substr(2, 6);
    const counter = (ID_GENERATION_STANDARDS._counter++ % 1000).toString().padStart(3, '0');
    return `${now}_${random}_${counter}`;
  },
  
  // UUID v4ï¼šå®Œå…¨éšæœºï¼Œæ— æ—¶é—´ä¾èµ–
  uuid: () => {
    return require('uuid').v4();
  },
  
  // é›ªèŠ±ç®—æ³•ï¼šåˆ†å¸ƒå¼å”¯ä¸€ID
  snowflake: (workerId, datacenterId) => {
    // å®ç°é›ªèŠ±ç®—æ³•ï¼Œç¡®ä¿åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å”¯ä¸€æ€§
    const timestamp = Date.now() - 1640995200000; // 2022-01-01 epoch
    const sequence = (ID_GENERATION_STANDARDS._sequence++ % 4096);
    
    return ((timestamp << 22) | (datacenterId << 17) | (workerId << 12) | sequence).toString();
  },
  
  _counter: 0,
  _sequence: 0
};

// ä¸šåŠ¡IDç”Ÿæˆè§„èŒƒ
class BusinessIdGenerator {
  // æ¶ˆæ¯IDï¼šåŒ…å«ä¸šåŠ¡å‰ç¼€å’Œæ—¶é—´ä¿¡æ¯
  static messageId() {
    const timestamp = DateFormatter.toISO(new Date());
    const uuid = require('uuid').v4().substr(0, 8);
    return `msg_${timestamp.replace(/[-:T.]/g, '')}_${uuid}`;
  }
  
  // ä¼šè¯IDï¼šåŒ…å«æ—¥æœŸå’Œéšæœºéƒ¨åˆ†
  static sessionId() {
    const dateStr = DateFormatter.toDate(new Date()).replace(/-/g, '');
    const uuid = require('uuid').v4().substr(0, 12);
    return `session_${dateStr}_${uuid}`;
  }
  
  // ä¸´æ—¶IDï¼šçŸ­æœŸä½¿ç”¨ï¼ŒåŒ…å«ç²¾ç¡®æ—¶é—´
  static tempId(prefix = 'temp') {
    return `${prefix}_${ID_GENERATION_STANDARDS.highPrecision()}`;
  }
}
```

## æ—¶é—´è®¡ç®—å’ŒèŒƒå›´æŸ¥è¯¢ä¼˜åŒ–

### å®é™…å‘ç°çš„å¤æ‚æ—¶é—´è®¡ç®—é—®é¢˜
```javascript
// cursoræ–‡æ¡£ä¸­å‘ç°çš„å¤æ‚ä¸”æ˜“é”™çš„æ—¶é—´è®¡ç®—ï¼š
created_at: { [sequelize.Op.gte]: new Date(new Date().setHours(0,0,0,0)) }
// é—®é¢˜ï¼šå¤æ‚ã€éš¾è¯»ã€æ—¶åŒºå¤„ç†ä¸æ˜ç¡®
```

### æ ‡å‡†æ—¶é—´è®¡ç®—å·¥å…·ç±»
```javascript
// ğŸ”´ å¼ºåˆ¶è¦æ±‚ï¼šä½¿ç”¨æ ‡å‡†æ—¶é—´è®¡ç®—å·¥å…·ç±»
class TimeCalculator {
  // ä»Šæ—¥å¼€å§‹æ—¶é—´ï¼ˆUTCï¼‰
  static todayStart() {
    const now = new Date();
    const start = new Date(Date.UTC(
      now.getUTCFullYear(),
      now.getUTCMonth(),
      now.getUTCDate(),
      0, 0, 0, 0
    ));
    return start.toISOString();
  }
  
  // ä»Šæ—¥ç»“æŸæ—¶é—´ï¼ˆUTCï¼‰
  static todayEnd() {
    const now = new Date();
    const end = new Date(Date.UTC(
      now.getUTCFullYear(),
      now.getUTCMonth(),
      now.getUTCDate(),
      23, 59, 59, 999
    ));
    return end.toISOString();
  }
  
  // Nå¤©å‰çš„æ—¶é—´
  static daysAgo(days) {
    const now = new Date();
    const past = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
    return past.toISOString();
  }
  
  // Nå°æ—¶å‰çš„æ—¶é—´
  static hoursAgo(hours) {
    const now = new Date();
    const past = new Date(now.getTime() - hours * 60 * 60 * 1000);
    return past.toISOString();
  }
  
  // æ—¶é—´å·®è®¡ç®—ï¼ˆç§’ï¼‰
  static timeDiffSeconds(start, end) {
    const startTime = new Date(start);
    const endTime = new Date(end);
    return Math.floor((endTime - startTime) / 1000);
  }
  
  // æ ¼å¼åŒ–è¿è¡Œæ—¶é—´æ˜¾ç¤º
  static formatRunTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
      return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ${secs}ç§’`;
    } else if (minutes > 0) {
      return `${minutes}åˆ†é’Ÿ${secs}ç§’`;
    } else {
      return `${secs}ç§’`;
    }
  }
}

// æ•°æ®åº“æŸ¥è¯¢ä¸­çš„æ ‡å‡†æ—¶é—´èŒƒå›´
const queryExamples = {
  // ä»Šæ—¥æ•°æ®
  today: {
    created_at: {
      [Op.gte]: TimeCalculator.todayStart(),
      [Op.lte]: TimeCalculator.todayEnd()
    }
  },
  
  // æœ€è¿‘7å¤©
  lastWeek: {
    created_at: {
      [Op.gte]: TimeCalculator.daysAgo(7)
    }
  },
  
  // æœ€è¿‘1å°æ—¶
  lastHour: {
    created_at: {
      [Op.gte]: TimeCalculator.hoursAgo(1)
    }
  }
};
```

## æ—¥å¿—æ—¶é—´æˆ³è§„èŒƒ

### å®é™…å‘ç°çš„æ—¥å¿—æ—¶é—´é—®é¢˜
```javascript
// cursoræ–‡æ¡£ä¸­å‘ç°çš„é—®é¢˜ï¼š
console.log('ğŸ“… æ—¶é—´:', new Date().toLocaleString()) // æ ¼å¼ä¸ç»Ÿä¸€
```

### ç»Ÿä¸€æ—¥å¿—æ—¶é—´æ ¼å¼
```javascript
// ğŸ”´ å¼ºåˆ¶è¦æ±‚ï¼šç»Ÿä¸€æ—¥å¿—æ—¶é—´æˆ³æ ¼å¼
class Logger {
  static formatLogTime() {
    return new Date().toISOString();
  }
  
  static log(level, message, data = {}) {
    const timestamp = Logger.formatLogTime();
    const logEntry = {
      timestamp,
      level,
      message,
      ...data
    };
    
    console.log(`[${timestamp}] ${level.toUpperCase()}: ${message}`, data);
    return logEntry;
  }
  
  static info(message, data) {
    return Logger.log('info', message, data);
  }
  
  static error(message, data) {
    return Logger.log('error', message, data);
  }
  
  static debug(message, data) {
    return Logger.log('debug', message, data);
  }
}

// ä½¿ç”¨ç¤ºä¾‹
Logger.info('æœåŠ¡å¯åŠ¨', { port: 3000, env: 'development' });
// è¾“å‡º: [2025-01-21T10:30:00.000Z] INFO: æœåŠ¡å¯åŠ¨ { port: 3000, env: 'development' }
```

## å‰ç«¯æ—¶é—´æ˜¾ç¤ºè§„èŒƒ

### ç”¨æˆ·æ—¶åŒºè‡ªé€‚åº”æ˜¾ç¤º
```javascript
// ğŸ”´ å¼ºåˆ¶è¦æ±‚ï¼šå‰ç«¯æ—¶é—´æ˜¾ç¤ºè€ƒè™‘ç”¨æˆ·æ—¶åŒº
class FrontendTimeDisplay {
  // è·å–ç”¨æˆ·æ—¶åŒº
  static getUserTimeZone() {
    return Intl.DateTimeFormat().resolvedOptions().timeZone;
  }
  
  // è½¬æ¢UTCæ—¶é—´ä¸ºç”¨æˆ·æœ¬åœ°æ—¶é—´æ˜¾ç¤º
  static toUserLocal(utcTime) {
    const userTZ = FrontendTimeDisplay.getUserTimeZone();
    return new Intl.DateTimeFormat('zh-CN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      timeZone: userTZ,
      hour12: false
    }).format(new Date(utcTime));
  }
  
  // ç›¸å¯¹æ—¶é—´æ˜¾ç¤ºï¼ˆå¦‚ï¼š1å°æ—¶å‰ï¼‰
  static toRelative(utcTime) {
    const now = new Date();
    const time = new Date(utcTime);
    const diffMs = now - time;
    const diffSeconds = Math.floor(diffMs / 1000);
    const diffMinutes = Math.floor(diffSeconds / 60);
    const diffHours = Math.floor(diffMinutes / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffDays > 0) {
      return `${diffDays}å¤©å‰`;
    } else if (diffHours > 0) {
      return `${diffHours}å°æ—¶å‰`;
    } else if (diffMinutes > 0) {
      return `${diffMinutes}åˆ†é’Ÿå‰`;
    } else {
      return 'åˆšåˆš';
    }
  }
}
```

## æ€§èƒ½ä¼˜åŒ–å’Œç¼“å­˜è§„èŒƒ

### æ—¶é—´è®¡ç®—ç»“æœç¼“å­˜
```javascript
// ğŸ”´ å¼ºåˆ¶è¦æ±‚ï¼šé¢‘ç¹çš„æ—¶é—´è®¡ç®—ç»“æœåº”è¯¥ç¼“å­˜
class TimeCache {
  constructor() {
    this.cache = new Map();
    this.cacheTTL = 60000; // 1åˆ†é’Ÿç¼“å­˜
  }
  
  // ç¼“å­˜ä»Šæ—¥å¼€å§‹æ—¶é—´
  getTodayStart() {
    const key = 'today_start';
    const cached = this.cache.get(key);
    
    if (cached && (Date.now() - cached.timestamp) < this.cacheTTL) {
      return cached.value;
    }
    
    const value = TimeCalculator.todayStart();
    this.cache.set(key, { value, timestamp: Date.now() });
    return value;
  }
  
  // æ¸…ç†è¿‡æœŸç¼“å­˜
  cleanup() {
    const now = Date.now();
    for (const [key, item] of this.cache.entries()) {
      if (now - item.timestamp > this.cacheTTL) {
        this.cache.delete(key);
      }
    }
  }
}

const timeCache = new TimeCache();
setInterval(() => timeCache.cleanup(), 60000); // æ¯åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
```

## é”™è¯¯å¤„ç†å’ŒéªŒè¯è§„èŒƒ

### æ—¶é—´æ•°æ®éªŒè¯
```javascript
// ğŸ”´ å¼ºåˆ¶è¦æ±‚ï¼šæ—¶é—´æ•°æ®éªŒè¯å’Œé”™è¯¯å¤„ç†
class TimeValidator {
  // éªŒè¯æ—¶é—´æ ¼å¼
  static isValidISO(timeString) {
    try {
      const date = new Date(timeString);
      return date.toISOString() === timeString;
    } catch {
      return false;
    }
  }
  
  // éªŒè¯æ—¶é—´èŒƒå›´
  static isValidRange(start, end) {
    const startTime = new Date(start);
    const endTime = new Date(end);
    return startTime <= endTime;
  }
  
  // å®‰å…¨çš„æ—¶é—´è§£æ
  static safeParse(timeString, defaultValue = null) {
    try {
      const date = new Date(timeString);
      if (isNaN(date.getTime())) {
        console.warn(`Invalid time string: ${timeString}`);
        return defaultValue;
      }
      return date.toISOString();
    } catch (error) {
      console.error(`Time parsing error: ${error.message}`);
      return defaultValue;
    }
  }
}

// APIä¸­çš„æ—¶é—´å‚æ•°éªŒè¯
function validateTimeParams(req, res, next) {
  const { start_time, end_time } = req.query;
  
  if (start_time && !TimeValidator.isValidISO(start_time)) {
    return res.status(400).json({ error: 'Invalid start_time format, use ISO 8601' });
  }
  
  if (end_time && !TimeValidator.isValidISO(end_time)) {
    return res.status(400).json({ error: 'Invalid end_time format, use ISO 8601' });
  }
  
  if (start_time && end_time && !TimeValidator.isValidRange(start_time, end_time)) {
    return res.status(400).json({ error: 'start_time must be before end_time' });
  }
  
  next();
}
```

## è¿ç§»å’Œå…¼å®¹æ€§å¤„ç†

### ç°æœ‰æ—¶é—´æ•°æ®è¿ç§»
```sql
-- æ—¶åŒºæ•°æ®è¿ç§»SQLç¤ºä¾‹
-- å°†æœ¬åœ°æ—¶é—´è½¬æ¢ä¸ºUTCå­˜å‚¨

-- 1. æ·»åŠ æ–°çš„UTCæ—¶é—´å­—æ®µ
ALTER TABLE your_table ADD COLUMN created_at_utc DATETIME;

-- 2. è½¬æ¢ç°æœ‰æ•°æ®ï¼ˆå‡è®¾åŸæ•°æ®ä¸ºGMT+8ï¼‰
UPDATE your_table 
SET created_at_utc = DATE_SUB(created_at, INTERVAL 8 HOUR)
WHERE created_at IS NOT NULL;

-- 3. éªŒè¯è½¬æ¢ç»“æœ
SELECT 
  id,
  created_at as local_time,
  created_at_utc as utc_time,
  TIMESTAMPDIFF(HOUR, created_at_utc, created_at) as hour_diff
FROM your_table 
LIMIT 10;

-- 4. é‡å‘½åå­—æ®µï¼ˆç¡®è®¤æ— è¯¯åï¼‰
ALTER TABLE your_table DROP COLUMN created_at;
ALTER TABLE your_table CHANGE created_at_utc created_at DATETIME;
```

## æµ‹è¯•å’ŒéªŒè¯è§„èŒƒ

### æ—¶é—´å¤„ç†å•å…ƒæµ‹è¯•
```javascript
// ğŸ”´ å¼ºåˆ¶è¦æ±‚ï¼šæ—¶é—´å¤„ç†åŠŸèƒ½å¿…é¡»æœ‰å®Œæ•´çš„å•å…ƒæµ‹è¯•
describe('TimeCalculator', () => {
  test('todayStart returns start of day in UTC', () => {
    const start = TimeCalculator.todayStart();
    expect(start).toMatch(/T00:00:00\.000Z$/);
  });
  
  test('daysAgo calculates correct past time', () => {
    const threeDaysAgo = TimeCalculator.daysAgo(3);
    const now = new Date();
    const past = new Date(threeDaysAgo);
    const diffDays = Math.floor((now - past) / (24 * 60 * 60 * 1000));
    expect(diffDays).toBe(3);
  });
  
  test('formatRunTime handles various durations', () => {
    expect(TimeCalculator.formatRunTime(30)).toBe('30ç§’');
    expect(TimeCalculator.formatRunTime(90)).toBe('1åˆ†é’Ÿ30ç§’');
    expect(TimeCalculator.formatRunTime(3661)).toBe('1å°æ—¶1åˆ†é’Ÿ1ç§’');
  });
});

describe('TimeValidator', () => {
  test('validates ISO format correctly', () => {
    expect(TimeValidator.isValidISO('2025-01-21T10:30:00.000Z')).toBe(true);
    expect(TimeValidator.isValidISO('2025-01-21 10:30:00')).toBe(false);
    expect(TimeValidator.isValidISO('invalid')).toBe(false);
  });
});
```

**æ ¸å¿ƒåŸåˆ™**ï¼šUTCæ ‡å‡†åŒ–ã€æ ¼å¼ç»Ÿä¸€ã€æ—¶åŒºæ˜ç¡®ã€éªŒè¯å®Œæ•´ã€æ€§èƒ½ä¼˜åŒ–ã€é”™è¯¯å…œåº•
alwaysApply: true
---
