# é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ - å¤šä¸šåŠ¡çº¿æ··åˆåˆ†å±‚å­˜å‚¨æ–¹æ¡ˆè¯´æ˜æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv3.0  
**åˆ›å»ºæ—¥æœŸ**ï¼š2025å¹´01æœˆ21æ—¥  
**æ›´æ–°æ—¥æœŸ**ï¼š2025å¹´01æœˆ21æ—¥  
**é€‚ç”¨ç¯å¢ƒ**ï¼šå¯¹è±¡å­˜å‚¨ + å¾®ä¿¡å°ç¨‹åº + Node.jsåç«¯  
**ä¸šåŠ¡èŒƒå›´**ï¼šç§¯åˆ†æŠ½å¥– + å•†å“å…‘æ¢ + äº¤æ˜“å¸‚åœº + æ‹ç…§ä¸Šä¼   
**é¢„æœŸè§„æ¨¡**ï¼šå½“å‰3ç”¨æˆ· â†’ ç›®æ ‡100ä¸‡ç”¨æˆ·  
**æŠ€æœ¯æ¶æ„**ï¼šå‰åç«¯åˆ†ç¦»æ¶æ„

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„æ€»è§ˆ

### å®Œæ•´æŠ€æœ¯æ ˆé…ç½®

```yaml
# é¡¹ç›®æŠ€æœ¯æ¶æ„ï¼ˆåŸºäºå®é™…é¡¹ç›®é…ç½®ï¼‰
å‰ç«¯é¡¹ç›®: å¾®ä¿¡å°ç¨‹åº
  AppID: wx0db69ddd264f9b81
  AppSecret: 414c5f5dc5404b4f7a1662dd26b532f9
  æŠ€æœ¯æ ˆ: WXML/WXSS/JavaScript åŸç”Ÿå¼€å‘
  å¼€å‘å·¥å…·: å¾®ä¿¡å¼€å‘è€…å·¥å…·
  APIè°ƒç”¨: https://omqktqrtntnn.sealosbja.site

åç«¯é¡¹ç›®: Node.jsæœåŠ¡ç«¯
  æŠ€æœ¯æ ˆ: Node.js + Express + MySQL
  éƒ¨ç½²ç¯å¢ƒ: äº‘æœåŠ¡å™¨
  å¼€å‘å·¥å…·: Cursorç¼–è¾‘å™¨
  è¿›ç¨‹ç®¡ç†: PM2
  APIåŸºç¡€è·¯å¾„: https://omqktqrtntnn.sealosbja.site/api

æ•°æ®åº“é…ç½®: MySQL
  ç‰ˆæœ¬: MySQL 8.0+
  è¿æ¥æ–¹å¼: mysql2/promise
  å­—ç¬¦é›†: utf8mb4
  æ—¶åŒº: +08:00

å¯¹è±¡å­˜å‚¨: äº‘å­˜å‚¨æœåŠ¡
  æ¡¶åç§°: tiangong-photos
  è®¿é—®æ–¹å¼: HTTP API
  CDNåŠ é€Ÿ: æ”¯æŒ
```

### ç¯å¢ƒå˜é‡é…ç½®æ ‡å‡†

```javascript
// .env - ç”Ÿäº§ç¯å¢ƒé…ç½®
/**
 * é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ - ç”Ÿäº§ç¯å¢ƒé…ç½®
 * é€‚ç”¨äºäº‘éƒ¨ç½²ç¯å¢ƒ
 * ä½œè€…ï¼šå¼€å‘å›¢é˜Ÿ
 * åˆ›å»ºæ—¶é—´ï¼š2025-01-21
 */

# åº”ç”¨åŸºç¡€é…ç½®
NODE_ENV=production
PORT=3000
APP_NAME=tiangong-lottery-backend

# åŸŸåé…ç½®
BASE_URL=https://omqktqrtntnn.sealosbja.site
API_BASE_URL=https://omqktqrtntnn.sealosbja.site/api

# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=tiangong_lottery
DB_CHARSET=utf8mb4
DB_TIMEZONE=+08:00
DB_CONNECTION_LIMIT=10

# å¾®ä¿¡å°ç¨‹åºé…ç½®
WECHAT_APP_ID=wx0db69ddd264f9b81
WECHAT_APP_SECRET=414c5f5dc5404b4f7a1662dd26b532f9

# JWTè®¤è¯é…ç½®
JWT_SECRET=tiangong-lottery-secret-2025
JWT_EXPIRES_IN=24h
JWT_REFRESH_EXPIRES_IN=7d

# å¯¹è±¡å­˜å‚¨é…ç½®
STORAGE_ENDPOINT=https://your-storage-endpoint.com
STORAGE_ACCESS_KEY=your-access-key
STORAGE_SECRET_KEY=your-secret-key
STORAGE_BUCKET=tiangong-photos
STORAGE_REGION=cn-east-1
STORAGE_CDN_DOMAIN=cdn.your-domain.com

# æ–‡ä»¶ä¸Šä¼ é™åˆ¶é…ç½®
UPLOAD_MAX_FILE_SIZE=10485760    # 10MB
UPLOAD_ALLOWED_TYPES=jpg,jpeg,png,webp
UPLOAD_TIMEOUT=30000             # 30ç§’

# æ—¥å¿—é…ç½®
LOG_LEVEL=info
LOG_MAX_FILES=30
LOG_MAX_SIZE=100m
LOG_PATH=/opt/logs

# æ€§èƒ½å’Œå®‰å…¨é…ç½®
CORS_ORIGIN=https://servicewechat.com,https://omqktqrtntnn.sealosbja.site
RATE_LIMIT_MAX=1000
RATE_LIMIT_WINDOW=900000         # 15åˆ†é’Ÿ
REQUEST_TIMEOUT=30000            # 30ç§’è¯·æ±‚è¶…æ—¶

# ä¸šåŠ¡é…ç½®
DAILY_LOTTERY_LIMIT=50           # æ¯æ—¥æŠ½å¥–é™åˆ¶
POINTS_EXCHANGE_ENABLED=true     # ç§¯åˆ†å…‘æ¢åŠŸèƒ½
ADMIN_REVIEW_ENABLED=true        # ç®¡ç†å‘˜å®¡æ ¸åŠŸèƒ½
```

## ğŸ¯ é¡¹ç›®èƒŒæ™¯å’Œä¸šåŠ¡éœ€æ±‚

### å½“å‰ä¸šåŠ¡ç°çŠ¶åˆ†æ
```javascript
/**
 * ä¸šåŠ¡ç°çŠ¶è¯„ä¼°
 * åŸºäºå®é™…è¿è¥æ•°æ®å’Œç”¨æˆ·åé¦ˆ
 */
const currentBusinessStatus = {
  // ç§¯åˆ†æŠ½å¥–ä¸šåŠ¡çº¿
  lottery: {
    description: 'ç”¨æˆ·é€šè¿‡ç§¯åˆ†å‚ä¸8åŒºåŸŸè½¬ç›˜æŠ½å¥–ï¼Œè·å¾—å¥–å“å’Œç§¯åˆ†å¥–åŠ±',
    currentUsers: 3,
    targetUsers: 500000,        // 50ä¸‡æŠ½å¥–ç”¨æˆ·
    avgPhotosPerUser: 5,        // å¹³å‡æ¯ç”¨æˆ·5å¼ æŠ½å¥–ç›¸å…³å›¾
    growthRate: 0.30,           // æœˆå¢é•¿30%ï¼ˆæ¸¸æˆåŒ–å¢é•¿å¿«ï¼‰
    peakAccessTimes: ['19:00-23:00'], // æ™šé—´å¨±ä¹æ—¶é—´
    businessCriticality: 'CRITICAL' // å…³é”®ä¸šåŠ¡ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
  },
  
  // å•†å“å…‘æ¢ä¸šåŠ¡çº¿  
  exchange: {
    description: 'ç”¨æˆ·ä½¿ç”¨ç§¯åˆ†å…‘æ¢å®ç‰©å•†å“å’Œä¼˜æƒ åˆ¸',
    currentUsers: 3,
    targetUsers: 300000,        // 30ä¸‡å…‘æ¢ç”¨æˆ·
    avgPhotosPerUser: 8,        // å¹³å‡æ¯ç”¨æˆ·8å¼ å•†å“ç›¸å…³å›¾ç‰‡
    growthRate: 0.25,           // æœˆå¢é•¿25%
    peakAccessTimes: ['10:00-12:00', '14:00-16:00', '20:00-22:00'],
    businessCriticality: 'HIGH' // é«˜é‡è¦æ€§ä¸šåŠ¡
  },
  
  // äº¤æ˜“å¸‚åœºä¸šåŠ¡çº¿
  tradeMarket: {
    description: 'åŒç©ºé—´äº¤æ˜“ç³»ç»Ÿï¼Œç”¨æˆ·å¯äº¤æ˜“è·å¾—çš„å•†å“',
    currentUsers: 3,
    targetUsers: 200000,        // 20ä¸‡äº¤æ˜“ç”¨æˆ·
    avgPhotosPerUser: 12,       // å¹³å‡æ¯ç”¨æˆ·12å¼ äº¤æ˜“ç›¸å…³å›¾ç‰‡
    growthRate: 0.35,           // æœˆå¢é•¿35%ï¼ˆæ–°åŠŸèƒ½å¢é•¿å¿«ï¼‰
    peakAccessTimes: ['15:00-17:00', '21:00-23:00'],
    businessCriticality: 'HIGH' // é«˜é‡è¦æ€§ï¼ˆå¢åŠ ç”¨æˆ·ç²˜æ€§ï¼‰
  },

  // æ‹ç…§ä¸Šä¼ ä¸šåŠ¡çº¿
  photoUpload: {
    description: 'ç”¨æˆ·ä¸Šä¼ æ¶ˆè´¹å‡­è¯ç…§ç‰‡ï¼Œç®¡ç†å‘˜å®¡æ ¸åå‘æ”¾ç§¯åˆ†',
    currentUsers: 3,
    targetUsers: 400000,        // 40ä¸‡ä¸Šä¼ ç”¨æˆ·
    avgPhotosPerUser: 20,       // å¹³å‡æ¯ç”¨æˆ·20å¼ ä¸Šä¼ å›¾ç‰‡
    growthRate: 0.20,           // æœˆå¢é•¿20%
    peakAccessTimes: ['12:00-14:00', '18:00-21:00'], // ç”¨é¤æ—¶é—´
    businessCriticality: 'CRITICAL' // å…³é”®ä¸šåŠ¡ï¼ˆç§¯åˆ†æ¥æºï¼‰
  }
};
```

### å­˜å‚¨æ¶æ„é¢ä¸´çš„æŒ‘æˆ˜

```javascript
/**
 * å­˜å‚¨æ¶æ„æŒ‘æˆ˜åˆ†æ
 * åŸºäºå½“å‰æŠ€æœ¯å€ºåŠ¡å’Œé¢„æœŸå¢é•¿
 */
const storageChallengres = {
  // æŠ€æœ¯æ¶æ„é—®é¢˜
  technical: {
    currentIssue: 'æ‰€æœ‰å›¾ç‰‡å­˜å‚¨åœ¨å•ä¸€/photosç›®å½•ï¼Œç¼ºä¹ä¸šåŠ¡åˆ†ç±»',
    impact: 'ç®¡ç†å›°éš¾ã€æ€§èƒ½ä¸‹é™ã€æˆæœ¬æµªè´¹',
    solution: 'å®æ–½å¤šä¸šåŠ¡çº¿åˆ†å±‚å­˜å‚¨æ¶æ„',
    urgency: 'HIGH'
  },
  
  // æ€§èƒ½é£é™©è¯„ä¼°
  performance: {
    currentIssue: 'ç™¾ä¸‡çº§ç”¨æˆ·ä¸‹å•ç›®å½•æ€§èƒ½æ€¥å‰§ä¸‹é™',
    riskScenario: 'å•ç›®å½•è¶…è¿‡100ä¸‡æ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶åˆ—ä¸¾æ“ä½œè¶…æ—¶',
    impact: 'ç”¨æˆ·ä½“éªŒä¸‹é™ã€åå°ç®¡ç†å¡é¡¿',
    solution: 'æŒ‰ä¸šåŠ¡çº¿ã€ç”¨æˆ·ã€æ—¶é—´ç»´åº¦åˆ†ç‰‡å­˜å‚¨',
    urgency: 'CRITICAL'
  },
  
  // æˆæœ¬æ§åˆ¶é—®é¢˜
  cost: {
    currentIssue: 'æ— æ³•æ ¹æ®è®¿é—®é¢‘ç‡ä¼˜åŒ–å­˜å‚¨æˆæœ¬',
    wasteScenario: 'å†å²å†·æ•°æ®å ç”¨é«˜æ€§èƒ½å­˜å‚¨èµ„æº',
    impact: 'å­˜å‚¨æˆæœ¬çº¿æ€§å¢é•¿ï¼ŒROIä¸‹é™',
    solution: 'å®æ–½çƒ­æ¸©å†·ä¸‰çº§å­˜å‚¨ç­–ç•¥',
    urgency: 'MEDIUM'
  },
  
  // å¾®ä¿¡å°ç¨‹åºç‰¹æ®Šè¦æ±‚
  wechatConstraints: {
    domainRestriction: 'å¾®ä¿¡å°ç¨‹åºåŸŸåç™½åå•é™åˆ¶',
    httpsRequirement: 'å¿…é¡»ä½¿ç”¨HTTPSåŠ å¯†ä¼ è¾“',
    cachingStrategy: 'å°ç¨‹åºæœ¬åœ°ç¼“å­˜ç­–ç•¥ä¼˜åŒ–',
    uploadLimitation: 'å•æ¬¡ä¸Šä¼ æ–‡ä»¶å¤§å°å’Œæ•°é‡é™åˆ¶'
  }
};
```

## ğŸ“Š å››ä¸šåŠ¡çº¿å­˜å‚¨éœ€æ±‚åˆ†æ

### 1. ç§¯åˆ†æŠ½å¥–ä¸šåŠ¡å­˜å‚¨ç‰¹å¾
```javascript
/**
 * ç§¯åˆ†æŠ½å¥–ä¸šåŠ¡å­˜å‚¨éœ€æ±‚åˆ†æ
 * åŸºäºå¾®ä¿¡å°ç¨‹åºç”¨æˆ·è¡Œä¸ºæ•°æ®
 */
const lotteryStorageRequirements = {
  imageTypes: {
    prizeImages: {
      description: 'æŠ½å¥–å¥–å“å›¾ç‰‡',
      averageSize: '1.5MB',
      dailyUpload: 10,         // é¢„è®¡æ¯æ—¥10å¼ æ–°å¥–å“å›¾
      accessPattern: 'æ´»åŠ¨æœŸé—´é«˜é¢‘è®¿é—®ï¼Œç»“æŸåå¿«é€Ÿé™æ¸©',
      retentionPolicy: 'æŒ‰æ´»åŠ¨å‘¨æœŸç®¡ç†',
      cachingStrategy: 'æ´»åŠ¨æœŸé—´å¼ºç¼“å­˜30å¤©'
    },
    wheelBanners: {
      description: 'è½¬ç›˜èƒŒæ™¯å›¾ã€è£…é¥°å›¾',
      averageSize: '2.0MB',
      dailyUpload: 2,          // æ¯æ—¥2å¼ è£…é¥°å›¾æ›´æ–°
      accessPattern: 'æ¯æ¬¡æŠ½å¥–éƒ½ä¼šåŠ è½½ï¼Œæé«˜é¢‘è®¿é—®',
      retentionPolicy: 'é•¿æœŸä¿å­˜ï¼Œç‰ˆæœ¬åŒ–ç®¡ç†',
      cachingStrategy: 'CDNå…¨é‡ç¼“å­˜ï¼Œ99.9%å¯ç”¨æ€§'
    },
    resultImages: {
      description: 'ä¸­å¥–ç»“æœå±•ç¤ºå›¾',
      averageSize: '0.8MB',
      dailyUpload: 5,          // æ¯æ—¥5å¼ ç»“æœå›¾
      accessPattern: 'ä¸­å¥–æ—¶çŸ­æ—¶é«˜é¢‘ï¼Œåç»­ä½é¢‘',
      retentionPolicy: 'ä¿å­˜1å¹´ï¼Œç”¨äºç»Ÿè®¡åˆ†æ',
      cachingStrategy: 'æ™ºèƒ½ç¼“å­˜ï¼ŒåŸºäºä¸­å¥–é¢‘ç‡'
    }
  },
  
  performanceRequirements: {
    uploadTime: '< 2ç§’ (å¥–å“å›¾ç‰‡å¿«é€Ÿä¸Šä¼ )',
    displayTime: '< 0.5ç§’ (è½¬ç›˜å›¾ç‰‡ç§’å¼€)',
    thumbnailGeneration: '< 1ç§’',
    searchResponse: '< 300ms (å¥–å“åˆ—è¡¨åŠ è½½)'
  }
};
```

### 2. å•†å“å…‘æ¢ä¸šåŠ¡å­˜å‚¨ç‰¹å¾
```javascript
/**
 * å•†å“å…‘æ¢ä¸šåŠ¡å­˜å‚¨éœ€æ±‚åˆ†æ
 * å½±å“ç”¨æˆ·å…‘æ¢ä½“éªŒçš„å…³é”®ä¸šåŠ¡
 */
const exchangeStorageRequirements = {
  imageTypes: {
    productImages: {
      description: 'å…‘æ¢å•†å“ä¸»å›¾ã€è¯¦æƒ…å›¾',
      averageSize: '2.2MB',
      dailyUpload: 50,         // æ¯æ—¥50å¼ æ–°å•†å“å›¾
      accessPattern: 'é«˜é¢‘è®¿é—®ï¼Œå½±å“å…‘æ¢å†³ç­–',
      retentionPolicy: 'ä¸å•†å“ç”Ÿå‘½å‘¨æœŸç»‘å®š',
      cachingStrategy: 'å…¨çƒCDNç¼“å­˜ï¼Œä¼˜å…ˆçº§é«˜'
    },
    categoryImages: {
      description: 'å•†å“åˆ†ç±»å›¾æ ‡ã€bannerå›¾',
      averageSize: '1.0MB',
      dailyUpload: 5,          // æ¯æ—¥5å¼ åˆ†ç±»å›¾
      accessPattern: 'ç¨³å®šé«˜é¢‘è®¿é—®ï¼Œå¯¼èˆªå¿…å¤‡',
      retentionPolicy: 'é•¿æœŸä¿å­˜ï¼Œå®šæœŸæ›´æ–°',
      cachingStrategy: 'å¼ºç¼“å­˜90å¤©'
    },
    exchangeRecords: {
      description: 'å…‘æ¢æˆåŠŸæˆªå›¾ã€å‡­è¯å›¾',
      averageSize: '1.8MB',
      dailyUpload: 200,        // æ¯æ—¥200å¼ å…‘æ¢è®°å½•
      accessPattern: 'ç”¨æˆ·ä¸ªäººæŸ¥çœ‹ï¼Œä¸­é¢‘è®¿é—®',
      retentionPolicy: 'æ°¸ä¹…ä¿å­˜ï¼Œç”¨äºçº çº·å¤„ç†',
      cachingStrategy: 'æŒ‰ç”¨æˆ·ç¼“å­˜ç­–ç•¥'
    }
  },
  
  performanceRequirements: {
    uploadTime: '< 3ç§’ (å•†å“å›¾ç‰‡ä¸Šä¼ )',
    displayTime: '< 1ç§’ (å•†å“åˆ—è¡¨åŠ è½½)',
    thumbnailGeneration: '< 2ç§’',
    searchResponse: '< 500ms (å•†å“æœç´¢)'
  }
};
```

### 3. äº¤æ˜“å¸‚åœºä¸šåŠ¡å­˜å‚¨ç‰¹å¾
```javascript
/**
 * äº¤æ˜“å¸‚åœºä¸šåŠ¡å­˜å‚¨éœ€æ±‚åˆ†æ
 * åŒç©ºé—´ç³»ç»Ÿçš„æ ¸å¿ƒè§†è§‰æ”¯æ’‘
 */
const tradeMarketStorageRequirements = {
  imageTypes: {
    marketBanners: {
      description: 'å¹¸è¿ç©ºé—´ã€è‡»é€‰ç©ºé—´bannerå›¾',
      averageSize: '2.5MB',
      dailyUpload: 8,          // æ¯æ—¥8å¼ banneræ›´æ–°
      accessPattern: 'å¸‚åœºé¦–é¡µå¿…æ˜¾ï¼Œæé«˜é¢‘è®¿é—®',
      retentionPolicy: 'æŒ‰æ´»åŠ¨å‘¨æœŸç®¡ç†',
      cachingStrategy: 'å®æ—¶ç¼“å­˜ï¼Œç‰ˆæœ¬æ§åˆ¶'
    },
    tradeImages: {
      description: 'äº¤æ˜“å•†å“å›¾ç‰‡',
      averageSize: '2.0MB',
      dailyUpload: 100,        // æ¯æ—¥100å¼ äº¤æ˜“å›¾
      accessPattern: 'äº¤æ˜“æµè§ˆæ—¶é«˜é¢‘åŠ è½½',
      retentionPolicy: 'äº¤æ˜“å®Œæˆåä¿ç•™1å¹´',
      cachingStrategy: 'çƒ­é—¨å•†å“ä¼˜å…ˆç¼“å­˜'
    },
    spaceDecorations: {
      description: 'åŒç©ºé—´è£…é¥°å›¾ã€å›¾æ ‡',
      averageSize: '0.6MB',
      dailyUpload: 3,          // æ¯æ—¥3å¼ è£…é¥°å›¾
      accessPattern: 'é¡µé¢èƒŒæ™¯ï¼Œæ¯æ¬¡è®¿é—®éƒ½åŠ è½½',
      retentionPolicy: 'é•¿æœŸä¿å­˜',
      cachingStrategy: 'é•¿æœŸç¼“å­˜ï¼Œé¢„åŠ è½½'
    }
  },
  
  performanceRequirements: {
    uploadTime: '< 2ç§’ (äº¤æ˜“å›¾ç‰‡å¿«é€Ÿä¸Šä¼ )',
    displayTime: '< 0.8ç§’ (åŒç©ºé—´ç€‘å¸ƒæµåŠ è½½)',
    thumbnailGeneration: '< 1.5ç§’',
    searchResponse: '< 400ms (äº¤æ˜“å•†å“æœç´¢)'
  }
};
```

### 4. æ‹ç…§ä¸Šä¼ ä¸šåŠ¡å­˜å‚¨ç‰¹å¾
```javascript
/**
 * æ‹ç…§ä¸Šä¼ ä¸šåŠ¡å­˜å‚¨éœ€æ±‚åˆ†æ
 * ç§¯åˆ†è·å–çš„æ ¸å¿ƒåŠŸèƒ½
 */
const photoUploadStorageRequirements = {
  imageTypes: {
    receiptPhotos: {
      description: 'ç”¨æˆ·ä¸Šä¼ çš„æ¶ˆè´¹å‡­è¯ç…§ç‰‡',
      averageSize: '3.5MB',
      dailyUpload: 500,        // æ¯æ—¥500å¼ æ¶ˆè´¹å‡­è¯
      accessPattern: 'ä¸Šä¼ åç®¡ç†å‘˜å®¡æ ¸æœŸé—´é«˜é¢‘ï¼Œå®¡æ ¸åä½é¢‘',
      retentionPolicy: 'æ°¸ä¹…ä¿å­˜ï¼Œç”¨äºçº çº·å¤„ç†å’Œæ•°æ®åˆ†æ',
      cachingStrategy: 'å®¡æ ¸æœŸé—´ç¼“å­˜7å¤©ï¼Œå®¡æ ¸åæŒ‰éœ€åŠ è½½'
    },
    auditPhotos: {
      description: 'ç®¡ç†å‘˜å®¡æ ¸æ—¶çš„æ ‡æ³¨å›¾ç‰‡',
      averageSize: '3.2MB',
      dailyUpload: 100,        // æ¯æ—¥100å¼ å®¡æ ¸å›¾
      accessPattern: 'å®¡æ ¸æ—¶çŸ­æ—¶é«˜é¢‘ï¼Œå®Œæˆåå½’æ¡£',
      retentionPolicy: 'ä¿å­˜3å¹´ï¼Œç”¨äºå®¡æ ¸è®°å½•',
      cachingStrategy: 'å®¡æ ¸æœŸé—´å¼ºç¼“å­˜'
    },
    rejectedPhotos: {
      description: 'å®¡æ ¸æ‹’ç»çš„ç…§ç‰‡',
      averageSize: '3.5MB',
      dailyUpload: 50,         // æ¯æ—¥50å¼ æ‹’ç»ç…§ç‰‡
      accessPattern: 'ç”¨æˆ·ç”³è¯‰æ—¶è®¿é—®ï¼Œä½é¢‘',
      retentionPolicy: 'ä¿å­˜1å¹´åè‡ªåŠ¨åˆ é™¤',
      cachingStrategy: 'å†·å­˜å‚¨ï¼ŒæŒ‰éœ€åŠ è½½'
    }
  },
  
  performanceRequirements: {
    uploadTime: '< 5ç§’ (å¤§å›¾ç‰‡ä¸Šä¼ ï¼Œè€ƒè™‘ç½‘ç»œç¯å¢ƒ)',
    displayTime: '< 2ç§’ (å®¡æ ¸ç•Œé¢å›¾ç‰‡åŠ è½½)',
    thumbnailGeneration: '< 3ç§’',
    searchResponse: '< 600ms (å®¡æ ¸åˆ—è¡¨åŠ è½½)'
  }
};
```

## ğŸ— æ··åˆåˆ†å±‚å­˜å‚¨æ¶æ„è®¾è®¡

### å®Œæ•´å­˜å‚¨æ¶æ„ç»“æ„

```
å¯¹è±¡å­˜å‚¨ç»“æ„ï¼ˆtiangong-photosï¼‰ï¼š
/
â”œâ”€â”€ hot/                          # çƒ­æ•°æ®å±‚ï¼ˆæœ€é«˜æ€§èƒ½ï¼Œå¾®ä¿¡å°ç¨‹åºä¼˜å…ˆè®¿é—®ï¼‰
â”‚   â”œâ”€â”€ lottery/
â”‚   â”‚   â”œâ”€â”€ prizes/active/        # å½“å‰å¯æŠ½å¥–å“
â”‚   â”‚   â”œâ”€â”€ wheels/current/       # å½“å‰è½¬ç›˜å›¾ç‰‡
â”‚   â”‚   â””â”€â”€ results/recent/       # æœ€æ–°ä¸­å¥–ç»“æœ
â”‚   â”œâ”€â”€ exchange/
â”‚   â”‚   â”œâ”€â”€ products/featured/    # çƒ­é—¨å…‘æ¢å•†å“
â”‚   â”‚   â”œâ”€â”€ categories/active/    # å½“å‰åˆ†ç±»å›¾æ ‡
â”‚   â”‚   â””â”€â”€ promotions/current/   # å½“å‰ä¿ƒé”€å•†å“
â”‚   â”œâ”€â”€ trade/
â”‚   â”‚   â”œâ”€â”€ lucky_space/featured/ # å¹¸è¿ç©ºé—´çƒ­é—¨å•†å“
â”‚   â”‚   â”œâ”€â”€ premium_space/hot/    # è‡»é€‰ç©ºé—´çƒ­é”€å•†å“
â”‚   â”‚   â””â”€â”€ banners/live/         # å½“å‰äº¤æ˜“banner
â”‚   â””â”€â”€ uploads/
â”‚       â”œâ”€â”€ pending_review/       # å¾…å®¡æ ¸ä¸Šä¼ å›¾ç‰‡
â”‚       â””â”€â”€ recent_approved/      # æœ€è¿‘é€šè¿‡çš„å›¾ç‰‡
â”‚
â”œâ”€â”€ standard/                     # æ ‡å‡†æ•°æ®å±‚ï¼ˆå¸¸è§„ä¸šåŠ¡æ•°æ®ï¼‰
â”‚   â”œâ”€â”€ users/                    # ç”¨æˆ·ç›¸å…³æ•°æ®
â”‚   â”‚   â”œâ”€â”€ u_000000-009999/     # ç”¨æˆ·åˆ†ç‰‡ï¼ˆæ¯ç‰‡1ä¸‡ç”¨æˆ·ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ u001/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ avatars/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ uploads/2025/01/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ exchanges/2025/01/
â”‚   â”‚   â”‚   â””â”€â”€ u002/
â”‚   â”‚   â””â”€â”€ u_010000-019999/
â”‚   â”œâ”€â”€ lottery/
â”‚   â”‚   â”œâ”€â”€ prizes/catalog/       # å¥–å“ç›®å½•
â”‚   â”‚   â”œâ”€â”€ wheels/templates/     # è½¬ç›˜æ¨¡æ¿
â”‚   â”‚   â””â”€â”€ history/             # å†å²æŠ½å¥–è®°å½•
â”‚   â”œâ”€â”€ exchange/
â”‚   â”‚   â”œâ”€â”€ products/
â”‚   â”‚   â”‚   â”œâ”€â”€ category_daily/
â”‚   â”‚   â”‚   â”œâ”€â”€ category_gift/
â”‚   â”‚   â”‚   â””â”€â”€ category_coupon/
â”‚   â”‚   â””â”€â”€ records/
â”‚   â”œâ”€â”€ trade/
â”‚   â”‚   â”œâ”€â”€ lucky_space/catalog/  # å¹¸è¿ç©ºé—´å•†å“ç›®å½•
â”‚   â”‚   â”œâ”€â”€ premium_space/catalog/ # è‡»é€‰ç©ºé—´å•†å“ç›®å½•
â”‚   â”‚   â””â”€â”€ transactions/         # äº¤æ˜“è®°å½•
â”‚   â””â”€â”€ uploads/
â”‚       â”œâ”€â”€ approved/            # å·²å®¡æ ¸é€šè¿‡
â”‚       â”œâ”€â”€ rejected/            # å®¡æ ¸æ‹’ç»
â”‚       â””â”€â”€ processing/          # å¤„ç†ä¸­
â”‚
â”œâ”€â”€ archive/                     # å½’æ¡£æ•°æ®å±‚ï¼ˆå†å²æ•°æ®ï¼‰
â”‚   â”œâ”€â”€ 2024/
â”‚   â”‚   â”œâ”€â”€ lottery/
â”‚   â”‚   â”œâ”€â”€ exchange/
â”‚   â”‚   â”œâ”€â”€ trade/
â”‚   â”‚   â””â”€â”€ uploads/
â”‚   â””â”€â”€ 2023/
â”‚
â””â”€â”€ system/                      # ç³»ç»Ÿæ•°æ®
    â”œâ”€â”€ thumbnails/              # ç»Ÿä¸€ç¼©ç•¥å›¾
    â”œâ”€â”€ temp/                    # ä¸´æ—¶æ–‡ä»¶
    â””â”€â”€ backup/                  # å¤‡ä»½æ•°æ®
```

## ğŸ›  æŠ€æœ¯å®ç°æ–¹æ¡ˆ - MultiBusinessPhotoStorage ç±»

### æ ¸å¿ƒå­˜å‚¨ç®¡ç†ç±»å®ç°

```javascript
/**
 * é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ - å¤šä¸šåŠ¡çº¿å›¾ç‰‡å­˜å‚¨ç®¡ç†ç±»
 * é€‚é…å¾®ä¿¡å°ç¨‹åº + Node.js + Express + MySQLæ¶æ„
 * 
 * åŠŸèƒ½ç‰¹æ€§ï¼š
 * - æ™ºèƒ½å­˜å‚¨å±‚çº§é€‰æ‹©
 * - å››ä¸šåŠ¡çº¿è·¯å¾„ç”Ÿæˆ
 * - ç”¨æˆ·åˆ†ç‰‡ç®¡ç†
 * - ç¼©ç•¥å›¾ç”Ÿæˆ
 * - æˆæœ¬ä¼˜åŒ–
 * 
 * ä½œè€…ï¼šå¼€å‘å›¢é˜Ÿ
 * åˆ›å»ºæ—¶é—´ï¼š2025-01-21
 * ç‰ˆæœ¬ï¼šv3.0 (é€‚é…é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ)
 */

const crypto = require('crypto');
const path = require('path');
const AWS = require('aws-sdk');

class MultiBusinessPhotoStorage {
  constructor() {
    // å¯¹è±¡å­˜å‚¨é…ç½®
    this.bucketName = process.env.STORAGE_BUCKET || 'tiangong-photos';
    this.baseUrl = process.env.BASE_URL || 'https://omqktqrtntnn.sealosbja.site';
    this.cdnDomain = process.env.STORAGE_CDN_DOMAIN || 'cdn.your-domain.com';
    
    // åˆå§‹åŒ–å­˜å‚¨å®¢æˆ·ç«¯
    this.storageClient = new AWS.S3({
      endpoint: process.env.STORAGE_ENDPOINT,
      accessKeyId: process.env.STORAGE_ACCESS_KEY,
      secretAccessKey: process.env.STORAGE_SECRET_KEY,
      region: process.env.STORAGE_REGION || 'cn-east-1',
      s3ForcePathStyle: true,
      signatureVersion: 'v4'
    });
    
    // ä¸šåŠ¡é…ç½® - åŸºäºå®é™…ä¸šåŠ¡éœ€æ±‚è°ƒæ•´
    this.businessConfig = {
      lottery: {
        hotDays: 30,             // æŠ½å¥–ç›¸å…³30å¤©å†…ä¸ºçƒ­æ•°æ®
        standardDays: 365,       // 1å¹´å†…ä¸ºæ ‡å‡†å­˜å‚¨
        archiveDays: 1095,       // 3å¹´åå½’æ¡£å­˜å‚¨
        categories: ['prizes', 'wheels', 'results', 'banners'],
        maxFileSize: 10 * 1024 * 1024, // 10MB
        allowedTypes: ['jpg', 'jpeg', 'png', 'webp'],
        thumbnailSizes: ['small', 'medium', 'large']
      },
      exchange: {
        hotDays: 60,             // å…‘æ¢å•†å“60å¤©å†…ä¸ºçƒ­æ•°æ®
        standardDays: 730,       // 2å¹´å†…ä¸ºæ ‡å‡†å­˜å‚¨
        archiveDays: 2190,       // 6å¹´åå½’æ¡£å­˜å‚¨
        categories: ['products', 'categories', 'records', 'promotions'],
        maxFileSize: 15 * 1024 * 1024, // 15MB
        allowedTypes: ['jpg', 'jpeg', 'png', 'webp'],
        thumbnailSizes: ['small', 'medium', 'large', 'xlarge']
      },
      trade: {
        hotDays: 45,             // äº¤æ˜“ç›¸å…³45å¤©å†…ä¸ºçƒ­æ•°æ®
        standardDays: 545,       // 1.5å¹´å†…ä¸ºæ ‡å‡†å­˜å‚¨
        archiveDays: 1825,       // 5å¹´åå½’æ¡£å­˜å‚¨
        categories: ['lucky_space', 'premium_space', 'banners', 'transactions'],
        maxFileSize: 12 * 1024 * 1024, // 12MB
        allowedTypes: ['jpg', 'jpeg', 'png', 'webp'],
        thumbnailSizes: ['small', 'medium', 'large']
      },
      uploads: {
        hotDays: 7,              // ä¸Šä¼ å›¾ç‰‡7å¤©å†…ä¸ºçƒ­æ•°æ®ï¼ˆå®¡æ ¸æœŸï¼‰
        standardDays: 1095,      // 3å¹´å†…ä¸ºæ ‡å‡†å­˜å‚¨
        archiveDays: 2190,       // 6å¹´åå½’æ¡£å­˜å‚¨
        categories: ['pending_review', 'approved', 'rejected', 'processing'],
        maxFileSize: 20 * 1024 * 1024, // 20MBï¼ˆé«˜æ¸…ç…§ç‰‡ï¼‰
        allowedTypes: ['jpg', 'jpeg', 'png', 'webp'],
        thumbnailSizes: ['small', 'medium', 'large']
      }
    };
    
    // ç¼“å­˜é…ç½®
    this.cache = {
      userStats: new Map(),
      pathCache: new Map(),
      cacheExpiry: 5 * 60 * 1000  // 5åˆ†é’Ÿç¼“å­˜
    };
  }
  
  // ============ ä¸»è¦å…¬å…±æ–¹æ³• ============
  
  /**
   * ç”Ÿæˆå›¾ç‰‡å­˜å‚¨è·¯å¾„ - æ ¸å¿ƒæ–¹æ³•
   * @param {string} businessType - ä¸šåŠ¡ç±»å‹ï¼šlottery, exchange, trade, uploads
   * @param {string} category - åˆ†ç±»ï¼šprizes, products, lucky_space, pending_reviewç­‰
   * @param {number|string} contextId - ä¸Šä¸‹æ–‡IDï¼ˆç”¨æˆ·IDã€å•†å“IDç­‰ï¼‰
   * @param {object} metadata - å…ƒæ•°æ®
   * @returns {Promise<string>} å­˜å‚¨è·¯å¾„
   */
  async generatePhotoPath(businessType, category, contextId, metadata = {}) {
    try {
      // 1. è¾“å…¥éªŒè¯
      this.validateInputs(businessType, category, contextId, metadata);
      
      // 2. æ£€æŸ¥ç¼“å­˜
      const cacheKey = `${businessType}_${category}_${contextId}_${JSON.stringify(metadata)}`;
      const cached = this.getCachedPath(cacheKey);
      if (cached) {
        console.log('ğŸ“‹ ä½¿ç”¨ç¼“å­˜è·¯å¾„:', cached);
        return cached;
      }
      
      // 3. é€‰æ‹©å­˜å‚¨å±‚çº§
      const storageLayer = await this.selectStorageLayer(businessType, category, metadata);
      console.log(`ğŸ¯ é€‰æ‹©å­˜å‚¨å±‚çº§: ${storageLayer} (ä¸šåŠ¡:${businessType}, åˆ†ç±»:${category})`);
      
      // 4. æ ¹æ®ä¸šåŠ¡ç±»å‹ç”Ÿæˆè·¯å¾„
      let filePath;
      switch (businessType) {
        case 'lottery':
          filePath = this.generateLotteryPath(storageLayer, category, contextId, metadata);
          break;
        case 'exchange':
          filePath = this.generateExchangePath(storageLayer, category, contextId, metadata);
          break;
        case 'trade':
          filePath = this.generateTradePath(storageLayer, category, contextId, metadata);
          break;
        case 'uploads':
          filePath = this.generateUploadPath(storageLayer, category, contextId, metadata);
          break;
        default:
          throw new Error(`ä¸æ”¯æŒçš„ä¸šåŠ¡ç±»å‹: ${businessType}`);
      }
      
      // 5. ç¼“å­˜ç»“æœ
      this.setCachedPath(cacheKey, filePath);
      
      console.log(`âœ… ç”Ÿæˆå­˜å‚¨è·¯å¾„: ${filePath}`);
      return filePath;
      
    } catch (error) {
      console.error(`âŒ è·¯å¾„ç”Ÿæˆå¤±è´¥: ${error.message}`);
      // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨é€šç”¨è·¯å¾„
      return this.generateFallbackPath(businessType, contextId, metadata);
    }
  }

  /**
   * ç”ŸæˆæŠ½å¥–ä¸šåŠ¡è·¯å¾„
   * @param {string} storageLayer - å­˜å‚¨å±‚çº§
   * @param {string} category - åˆ†ç±»
   * @param {string|number} contextId - ä¸Šä¸‹æ–‡ID
   * @param {object} metadata - å…ƒæ•°æ®
   * @returns {string} æ–‡ä»¶è·¯å¾„
   */
  generateLotteryPath(storageLayer, category, contextId, metadata) {
    const { uploadTime = Date.now(), imageType = 'main', prizeType = 'general' } = metadata;
    const fileName = this.generateFileName('lottery', contextId, uploadTime, metadata);
    
    if (storageLayer === 'hot') {
      // çƒ­æ•°æ®ï¼š/hot/lottery/prizes/active/
      if (category === 'prizes') {
        return `hot/lottery/prizes/active/${fileName}`;
      } else if (category === 'wheels') {
        return `hot/lottery/wheels/current/${fileName}`;
      } else if (category === 'results') {
        return `hot/lottery/results/recent/${fileName}`;
      }
    } else if (storageLayer === 'standard') {
      // æ ‡å‡†å­˜å‚¨ï¼š/standard/lottery/prizes/catalog/
      const datePath = this.getDatePath(uploadTime);
      return `standard/lottery/${category}/${datePath}/${fileName}`;
    } else {
      // å½’æ¡£å­˜å‚¨ï¼š/archive/2024/lottery/
      const year = new Date(uploadTime).getFullYear();
      return `archive/${year}/lottery/${category}/${fileName}`;
    }
    
    // é»˜è®¤è·¯å¾„
    return `standard/lottery/${category}/${fileName}`;
  }

  /**
   * ç”Ÿæˆå…‘æ¢ä¸šåŠ¡è·¯å¾„
   * @param {string} storageLayer - å­˜å‚¨å±‚çº§
   * @param {string} category - åˆ†ç±»
   * @param {string|number} contextId - ä¸Šä¸‹æ–‡ID
   * @param {object} metadata - å…ƒæ•°æ®
   * @returns {string} æ–‡ä»¶è·¯å¾„
   */
  generateExchangePath(storageLayer, category, contextId, metadata) {
    const { uploadTime = Date.now(), productCategory = 'general', isFeatured = false } = metadata;
    const fileName = this.generateFileName('exchange', contextId, uploadTime, metadata);
    
    if (storageLayer === 'hot') {
      // çƒ­æ•°æ®ï¼š/hot/exchange/products/featured/
      if (category === 'products' && isFeatured) {
        return `hot/exchange/products/featured/${fileName}`;
      } else if (category === 'categories') {
        return `hot/exchange/categories/active/${fileName}`;
      } else if (category === 'promotions') {
        return `hot/exchange/promotions/current/${fileName}`;
      }
    } else if (storageLayer === 'standard') {
      // æ ‡å‡†å­˜å‚¨ï¼š/standard/exchange/products/category_daily/
      if (category === 'products') {
        return `standard/exchange/products/category_${productCategory}/${fileName}`;
      } else {
        const datePath = this.getDatePath(uploadTime);
        return `standard/exchange/${category}/${datePath}/${fileName}`;
      }
    } else {
      // å½’æ¡£å­˜å‚¨
      const year = new Date(uploadTime).getFullYear();
      return `archive/${year}/exchange/${category}/${fileName}`;
    }
    
    return `standard/exchange/${category}/${fileName}`;
  }

  /**
   * ç”Ÿæˆäº¤æ˜“å¸‚åœºè·¯å¾„
   * @param {string} storageLayer - å­˜å‚¨å±‚çº§
   * @param {string} category - åˆ†ç±»
   * @param {string|number} contextId - ä¸Šä¸‹æ–‡ID
   * @param {object} metadata - å…ƒæ•°æ®
   * @returns {string} æ–‡ä»¶è·¯å¾„
   */
  generateTradePath(storageLayer, category, contextId, metadata) {
    const { uploadTime = Date.now(), spaceType = 'lucky', isHot = false } = metadata;
    const fileName = this.generateFileName('trade', contextId, uploadTime, metadata);
    
    if (storageLayer === 'hot') {
      // çƒ­æ•°æ®ï¼š/hot/trade/lucky_space/featured/
      if (category === 'lucky_space') {
        return `hot/trade/lucky_space/featured/${fileName}`;
      } else if (category === 'premium_space') {
        return `hot/trade/premium_space/hot/${fileName}`;
      } else if (category === 'banners') {
        return `hot/trade/banners/live/${fileName}`;
      }
    } else if (storageLayer === 'standard') {
      // æ ‡å‡†å­˜å‚¨ï¼š/standard/trade/lucky_space/catalog/
      return `standard/trade/${category}/catalog/${fileName}`;
    } else {
      // å½’æ¡£å­˜å‚¨
      const year = new Date(uploadTime).getFullYear();
      return `archive/${year}/trade/${category}/${fileName}`;
    }
    
    return `standard/trade/${category}/${fileName}`;
  }

  /**
   * ç”Ÿæˆä¸Šä¼ å›¾ç‰‡è·¯å¾„
   * @param {string} storageLayer - å­˜å‚¨å±‚çº§
   * @param {string} category - åˆ†ç±»
   * @param {string|number} contextId - ä¸Šä¸‹æ–‡IDï¼ˆç”¨æˆ·IDï¼‰
   * @param {object} metadata - å…ƒæ•°æ®
   * @returns {string} æ–‡ä»¶è·¯å¾„
   */
  generateUploadPath(storageLayer, category, contextId, metadata) {
    const { uploadTime = Date.now(), reviewStatus = 'pending' } = metadata;
    const fileName = this.generateFileName('uploads', contextId, uploadTime, metadata);
    const userShard = this.getUserShard(contextId);
    const datePath = this.getDatePath(uploadTime);
    
    if (storageLayer === 'hot') {
      // çƒ­æ•°æ®ï¼š/hot/uploads/pending_review/
      if (category === 'pending_review') {
        return `hot/uploads/pending_review/${fileName}`;
      } else if (category === 'recent_approved') {
        return `hot/uploads/recent_approved/${fileName}`;
      }
    } else if (storageLayer === 'standard') {
      // æ ‡å‡†å­˜å‚¨ï¼š/standard/users/u_000000-009999/u001/uploads/2025/01/
      return `standard/users/${userShard}/u${contextId}/uploads/${datePath}/${fileName}`;
    } else {
      // å½’æ¡£å­˜å‚¨
      const year = new Date(uploadTime).getFullYear();
      return `archive/${year}/uploads/${category}/${fileName}`;
    }
    
    return `standard/uploads/${category}/${fileName}`;
  }
  
  /**
   * æ™ºèƒ½é€‰æ‹©å­˜å‚¨å±‚çº§
   * @param {string} businessType - ä¸šåŠ¡ç±»å‹
   * @param {string} category - åˆ†ç±»
   * @param {object} metadata - å…ƒæ•°æ®
   * @returns {Promise<string>} å­˜å‚¨å±‚çº§ï¼šhot, standard, archive
   */
  async selectStorageLayer(businessType, category, metadata) {
    const { isActive, priority, expectedAccess, uploadTime, lastAccessTime } = metadata;
    
    // 1. æ˜ç¡®æŒ‡å®šä¸ºé«˜ä¼˜å…ˆçº§æ•°æ®
    if (isActive === true || priority === 'high' || expectedAccess === 'frequent') {
      console.log('ğŸ”¥ é«˜ä¼˜å…ˆçº§æ•°æ®ï¼Œä½¿ç”¨çƒ­å­˜å‚¨');
      return 'hot';
    }
    
    // 2. åŸºäºæ—¶é—´çš„æ™ºèƒ½åˆ¤æ–­
    const now = Date.now();
    const fileAge = uploadTime ? (now - uploadTime) / (1000 * 60 * 60 * 24) : 0; // å¤©æ•°
    const accessAge = lastAccessTime ? (now - lastAccessTime) / (1000 * 60 * 60 * 24) : Infinity;
    
    const config = this.businessConfig[businessType];
    
    // 3. ä¸šåŠ¡ç‰¹å®šé€»è¾‘
    if (businessType === 'lottery') {
      // æŠ½å¥–ä¸šåŠ¡ï¼šå½“å‰æ´»åŠ¨å¥–å“ä½¿ç”¨çƒ­å­˜å‚¨
      if (category === 'prizes' && isActive) {
        console.log('ğŸ° å½“å‰æ´»åŠ¨å¥–å“ï¼Œä½¿ç”¨çƒ­å­˜å‚¨');
        return 'hot';
      }
      // è½¬ç›˜å›¾ç‰‡ï¼šç»å¸¸è®¿é—®ä½¿ç”¨çƒ­å­˜å‚¨
      if (category === 'wheels' && fileAge <= 7) {
        console.log('ğŸ® è½¬ç›˜å›¾ç‰‡ï¼Œä½¿ç”¨çƒ­å­˜å‚¨');
        return 'hot';
      }
    }
    
    if (businessType === 'exchange') {
      // å…‘æ¢ä¸šåŠ¡ï¼šçƒ­é—¨å•†å“ä½¿ç”¨çƒ­å­˜å‚¨
      if (category === 'products' && (isActive || metadata.isFeatured)) {
        console.log('ğŸ›ï¸ çƒ­é—¨å…‘æ¢å•†å“ï¼Œä½¿ç”¨çƒ­å­˜å‚¨');
        return 'hot';
      }
      // ä¿ƒé”€æ´»åŠ¨ï¼šä½¿ç”¨çƒ­å­˜å‚¨
      if (category === 'promotions' && isActive) {
        console.log('ğŸ‰ ä¿ƒé”€æ´»åŠ¨ï¼Œä½¿ç”¨çƒ­å­˜å‚¨');
        return 'hot';
      }
    }
    
    if (businessType === 'trade') {
      // äº¤æ˜“å¸‚åœºï¼šçƒ­é—¨å•†å“ä½¿ç”¨çƒ­å­˜å‚¨
      if ((category === 'lucky_space' || category === 'premium_space') && metadata.isHot) {
        console.log('ğŸª çƒ­é—¨äº¤æ˜“å•†å“ï¼Œä½¿ç”¨çƒ­å­˜å‚¨');
        return 'hot';
      }
      // Bannerå›¾ç‰‡ï¼šä½¿ç”¨çƒ­å­˜å‚¨
      if (category === 'banners' && isActive) {
        console.log('ğŸ–¼ï¸ äº¤æ˜“å¸‚åœºbannerï¼Œä½¿ç”¨çƒ­å­˜å‚¨');
        return 'hot';
      }
    }
    
    if (businessType === 'uploads') {
      // ä¸Šä¼ å›¾ç‰‡ï¼šå¾…å®¡æ ¸æœŸé—´ä½¿ç”¨çƒ­å­˜å‚¨
      if (category === 'pending_review') {
        console.log('ğŸ“¸ å¾…å®¡æ ¸å›¾ç‰‡ï¼Œä½¿ç”¨çƒ­å­˜å‚¨');
        return 'hot';
      }
      // æœ€è¿‘å®¡æ ¸é€šè¿‡ï¼šä½¿ç”¨çƒ­å­˜å‚¨
      if (category === 'recent_approved' && fileAge <= 7) {
        console.log('âœ… æœ€è¿‘å®¡æ ¸é€šè¿‡ï¼Œä½¿ç”¨çƒ­å­˜å‚¨');
        return 'hot';
      }
    }
    
    // 4. åŸºäºè®¿é—®é¢‘ç‡çš„åˆ¤æ–­
    if (accessAge <= config.hotDays) {
      console.log('ğŸ”¥ æœ€è¿‘è®¿é—®é¢‘ç¹ï¼Œä½¿ç”¨çƒ­å­˜å‚¨');
      return 'hot';
    }
    
    if (fileAge <= config.standardDays) {
      console.log('ğŸ“¦ æ ‡å‡†æ—¶æ•ˆå†…ï¼Œä½¿ç”¨æ ‡å‡†å­˜å‚¨');
      return 'standard';
    }
    
    if (fileAge <= config.archiveDays) {
      console.log('ğŸ“š å†å²æ•°æ®ï¼Œä½¿ç”¨å½’æ¡£å­˜å‚¨');
      return 'archive';
    }
    
    // 5. é»˜è®¤æ ‡å‡†å­˜å‚¨
    console.log('ğŸ“¦ é»˜è®¤ä½¿ç”¨æ ‡å‡†å­˜å‚¨');
    return 'standard';
  }

  // ============ å…¶ä»–æ ¸å¿ƒæ–¹æ³•ä¿æŒä¸å˜ ============
  
  /**
   * è·å–æ–‡ä»¶å®Œæ•´è®¿é—®URL
   * @param {string} filePath - æ–‡ä»¶è·¯å¾„
   * @param {boolean} useCDN - æ˜¯å¦ä½¿ç”¨CDN
   * @returns {string} å®Œæ•´URL
   */
  getFileUrl(filePath, useCDN = false) {
    const domain = useCDN ? this.cdnDomain : this.baseUrl.replace('https://', '');
    return `https://${domain}/${this.bucketName}/${filePath}`;
  }
  
  /**
   * ç”Ÿæˆç¼©ç•¥å›¾è·¯å¾„
   * @param {string} originalPath - åŸå›¾è·¯å¾„
   * @param {string} size - ç¼©ç•¥å›¾å°ºå¯¸ï¼šsmall, medium, large
   * @returns {string} ç¼©ç•¥å›¾è·¯å¾„
   */
  generateThumbnailPath(originalPath, size = 'medium') {
    const pathParts = originalPath.split('/');
    const fileName = pathParts.pop();
    const [name, ext] = fileName.split('.');
    
    // ç¼©ç•¥å›¾ç»Ÿä¸€å­˜å‚¨åœ¨system/thumbnailsç›®å½•
    const thumbFileName = `${name}_thumb_${size}.${ext}`;
    return `system/thumbnails/${size}/${thumbFileName}`;
  }
  
  /**
   * ç”Ÿæˆç”¨æˆ·åˆ†ç‰‡æ ‡è¯†
   * @param {number} userId - ç”¨æˆ·ID
   * @returns {string} åˆ†ç‰‡æ ‡è¯†
   */
  getUserShard(userId) {
    const shardSize = 10000; // æ¯ç‰‡1ä¸‡ç”¨æˆ·
    const shardId = Math.floor(userId / shardSize);
    const shardStart = shardId * shardSize;
    const shardEnd = shardStart + shardSize - 1;
    return `u_${shardStart.toString().padStart(6, '0')}-${shardEnd.toString().padStart(6, '0')}`;
  }
  
  /**
   * è·å–æ—¥æœŸè·¯å¾„
   * @param {number} timestamp - æ—¶é—´æˆ³
   * @returns {string} æ—¥æœŸè·¯å¾„ï¼š2025/01/12
   */
  getDatePath(timestamp) {
    const date = new Date(timestamp);
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    return `${year}/${month}/${day}`;
  }
  
  /**
   * ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
   * @param {string} businessType - ä¸šåŠ¡ç±»å‹
   * @param {number|string} contextId - ä¸Šä¸‹æ–‡ID
   * @param {number} timestamp - æ—¶é—´æˆ³
   * @param {object} metadata - å…ƒæ•°æ®
   * @returns {string} æ–‡ä»¶å
   */
  generateFileName(businessType, contextId, timestamp, metadata = {}) {
    const { originalName, fileType = 'jpg', imageType = 'main' } = metadata;
    
    // ç”Ÿæˆéšæœºå“ˆå¸Œç¡®ä¿å”¯ä¸€æ€§
    const random = Math.random().toString(36).substring(2, 10);
    const hash = crypto.createHash('md5')
      .update(`${businessType}_${contextId}_${timestamp}_${random}`)
      .digest('hex')
      .substring(0, 8);
    
    // å¤„ç†æ–‡ä»¶æ‰©å±•å
    let extension = fileType;
    if (originalName) {
      const ext = path.extname(originalName).slice(1);
      if (ext) extension = ext;
    }
    
    return `${timestamp}_${businessType}_${contextId}_${imageType}_${hash}.${extension}`;
  }
  
  /**
   * éªŒè¯è¾“å…¥å‚æ•°
   * @param {string} businessType - ä¸šåŠ¡ç±»å‹
   * @param {string} category - åˆ†ç±»
   * @param {number|string} contextId - ä¸Šä¸‹æ–‡ID
   * @param {object} metadata - å…ƒæ•°æ®
   */
  validateInputs(businessType, category, contextId, metadata) {
    // éªŒè¯ä¸šåŠ¡ç±»å‹
    const validBusinessTypes = ['lottery', 'exchange', 'trade', 'uploads'];
    if (!validBusinessTypes.includes(businessType)) {
      throw new Error(`æ— æ•ˆçš„ä¸šåŠ¡ç±»å‹: ${businessType}ï¼Œæ”¯æŒçš„ç±»å‹: ${validBusinessTypes.join(', ')}`);
    }
    
    // éªŒè¯åˆ†ç±»
    const validCategories = this.businessConfig[businessType].categories;
    if (!validCategories.includes(category)) {
      throw new Error(`ä¸šåŠ¡${businessType}ä¸æ”¯æŒåˆ†ç±»: ${category}ï¼Œæ”¯æŒçš„åˆ†ç±»: ${validCategories.join(', ')}`);
    }
    
    // éªŒè¯ä¸Šä¸‹æ–‡ID
    if (!contextId) {
      throw new Error('contextIdä¸èƒ½ä¸ºç©º');
    }
    
    // éªŒè¯æ–‡ä»¶å¤§å°
    if (metadata.fileSize) {
      const maxSize = this.businessConfig[businessType].maxFileSize;
      if (metadata.fileSize > maxSize) {
        throw new Error(`æ–‡ä»¶å¤§å°${Math.round(metadata.fileSize/1024/1024)}MBè¶…è¿‡é™åˆ¶${Math.round(maxSize/1024/1024)}MB`);
      }
    }
    
    // éªŒè¯æ–‡ä»¶ç±»å‹
    if (metadata.fileType) {
      const allowedTypes = this.businessConfig[businessType].allowedTypes;
      if (!allowedTypes.includes(metadata.fileType.toLowerCase())) {
        throw new Error(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${metadata.fileType}ï¼Œæ”¯æŒçš„ç±»å‹: ${allowedTypes.join(', ')}`);
      }
    }
  }
  
  // ============ ç¼“å­˜ç®¡ç†æ–¹æ³• ============
  
  getCachedPath(key) {
    const cached = this.cache.pathCache.get(key);
    if (cached && (Date.now() - cached.timestamp) < this.cache.cacheExpiry) {
      return cached.path;
    }
    return null;
  }
  
  setCachedPath(key, path) {
    this.cache.pathCache.set(key, {
      path,
      timestamp: Date.now()
    });
  }
  
  /**
   * ç”Ÿæˆé™çº§è·¯å¾„ï¼ˆå¼‚å¸¸æƒ…å†µä½¿ç”¨ï¼‰
   * @param {string} businessType - ä¸šåŠ¡ç±»å‹
   * @param {number|string} contextId - ä¸Šä¸‹æ–‡ID
   * @param {object} metadata - å…ƒæ•°æ®
   * @returns {string} é™çº§è·¯å¾„
   */
  generateFallbackPath(businessType, contextId, metadata = {}) {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(2, 8);
    const fileName = `${timestamp}_${businessType}_${contextId}_fallback_${random}.jpg`;
    
    console.log(`âš ï¸ ä½¿ç”¨é™çº§è·¯å¾„: standard/fallback/${businessType}/${fileName}`);
    return `standard/fallback/${businessType}/${fileName}`;
  }
  
  /**
   * æ¸…ç†ç¼“å­˜
   */
  clearCache() {
    this.cache.pathCache.clear();
    this.cache.userStats.clear();
    console.log('ğŸ—‘ï¸ ç¼“å­˜å·²æ¸…ç†');
  }
}

module.exports = MultiBusinessPhotoStorage;
```

## ğŸ”Œ APIæ¥å£æ”¹é€ æ–¹æ¡ˆ

### Expressåç«¯æ¥å£å®ç°

#### 1. æŠ½å¥–å¥–å“å›¾ç‰‡ä¸Šä¼ æ¥å£

```javascript
/**
 * æŠ½å¥–å¥–å“å›¾ç‰‡ä¸Šä¼ æ¥å£
 * è·¯ç”±ï¼šPOST /api/lottery/prizes/upload
 * é€‚é…å¾®ä¿¡å°ç¨‹åºä¸Šä¼ éœ€æ±‚
 */

const express = require('express');
const multer = require('multer');
const MultiBusinessPhotoStorage = require('../services/MultiBusinessPhotoStorage');
const authMiddleware = require('../middleware/auth');

const router = express.Router();
const storage = new MultiBusinessPhotoStorage();

// é…ç½®multerç”¨äºæ–‡ä»¶ä¸Šä¼ ï¼ˆå†…å­˜å­˜å‚¨ï¼‰
const upload = multer({
  storage: multer.memoryStorage(),
  limits: {
    fileSize: 10 * 1024 * 1024, // 10MBé™åˆ¶
    files: 5 // æœ€å¤š5å¼ å›¾ç‰‡
  },
  fileFilter: (req, file, cb) => {
    // éªŒè¯æ–‡ä»¶ç±»å‹
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
    if (allowedTypes.includes(file.mimetype)) {
      cb(null, true);
    } else {
      cb(new Error('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹'), false);
    }
  }
});

/**
 * æŠ½å¥–å¥–å“å›¾ç‰‡ä¸Šä¼ 
 * @route POST /api/lottery/prizes/upload
 * @access Private (éœ€è¦ç®¡ç†å‘˜æƒé™)
 */
router.post('/upload', authMiddleware, upload.array('images', 5), async (req, res) => {
  try {
    const { userId, is_admin } = req.user; // ä»è®¤è¯ä¸­é—´ä»¶è·å–ç”¨æˆ·ä¿¡æ¯
    const { prizeId, prizeType = 'general', isActive = true } = req.body;
    
    // æƒé™éªŒè¯ï¼šåªæœ‰ç®¡ç†å‘˜å¯ä»¥ä¸Šä¼ å¥–å“å›¾ç‰‡
    if (!is_admin) {
      return res.status(403).json({
        success: false,
        message: 'åªæœ‰ç®¡ç†å‘˜å¯ä»¥ä¸Šä¼ å¥–å“å›¾ç‰‡',
        code: 'ADMIN_REQUIRED'
      });
    }
    
    // å‚æ•°éªŒè¯
    if (!prizeId) {
      return res.status(400).json({
        success: false,
        message: 'å¥–å“IDä¸èƒ½ä¸ºç©º',
        code: 'MISSING_PARAMS'
      });
    }
    
    if (!req.files || req.files.length === 0) {
      return res.status(400).json({
        success: false,
        message: 'è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡',
        code: 'NO_FILES'
      });
    }
    
    console.log(`ğŸ° å¼€å§‹å¤„ç†æŠ½å¥–å¥–å“å›¾ç‰‡ä¸Šä¼ : ç®¡ç†å‘˜${userId}, å¥–å“${prizeId}`);
    
    const uploadResults = [];
    const errors = [];
    
    // æ‰¹é‡å¤„ç†ä¸Šä¼ çš„å›¾ç‰‡
    for (let i = 0; i < req.files.length; i++) {
      const file = req.files[i];
      
      try {
        console.log(`ğŸ å¤„ç†ç¬¬${i + 1}å¼ å›¾ç‰‡: ${file.originalname} (${(file.size / 1024 / 1024).toFixed(2)}MB)`);
        
        // 1. ç”Ÿæˆå­˜å‚¨è·¯å¾„
        const filePath = await storage.generatePhotoPath(
          'lottery',
          'prizes', 
          prizeId,
          {
            uploadTime: Date.now(),
            isActive: Boolean(isActive), // æ–°å¥–å“æ ‡è®°ä¸ºæ´»è·ƒ
            originalName: file.originalname,
            fileType: file.mimetype.split('/')[1],
            imageType: 'prize',
            fileSize: file.size,
            prizeType: prizeType,
            userId: userId
          }
        );
        
        // 2. ä¸Šä¼ æ–‡ä»¶åˆ°å­˜å‚¨æœåŠ¡
        const uploadResult = await storage.uploadFile(filePath, file.buffer, {
          contentType: file.mimetype,
          businessType: 'lottery',
          category: 'prizes',
          originalName: file.originalname
        });
        
        // 3. ç”Ÿæˆç¼©ç•¥å›¾è·¯å¾„
        const thumbnailPath = storage.generateThumbnailPath(filePath, 'medium');
        
        // 4. ä¿å­˜åˆ°æ•°æ®åº“
        const db = require('../config/database');
        const insertResult = await db.query(
          `INSERT INTO lottery_prizes 
           (user_id, prize_id, prize_type, file_path, thumbnail_path, 
            original_name, file_size, mime_type, is_active, storage_layer, created_at) 
           VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW())`,
          [userId, prizeId, prizeType, filePath, thumbnailPath, 
           file.originalname, file.size, file.mimetype, isActive, 'hot']
        );
        
        uploadResults.push({
          id: insertResult.insertId,
          originalName: file.originalname,
          filePath: filePath,
          thumbnailPath: thumbnailPath,
          url: uploadResult.url,
          cdnUrl: uploadResult.cdnUrl,
          size: file.size,
          uploadTime: uploadResult.uploadTime
        });
        
        console.log(`âœ… ç¬¬${i + 1}å¼ å›¾ç‰‡ä¸Šä¼ æˆåŠŸ: ${filePath}`);
        
      } catch (error) {
        console.error(`âŒ ç¬¬${i + 1}å¼ å›¾ç‰‡ä¸Šä¼ å¤±è´¥:`, error.message);
        errors.push({
          fileName: file.originalname,
          error: error.message
        });
      }
    }
    
    // è¿”å›ç»“æœ
    const response = {
      success: uploadResults.length > 0,
      message: `æˆåŠŸä¸Šä¼  ${uploadResults.length} å¼ å›¾ç‰‡${errors.length > 0 ? `ï¼Œ${errors.length} å¼ å¤±è´¥` : ''}`,
      data: {
        uploaded: uploadResults,
        errors: errors,
        total: req.files.length,
        successCount: uploadResults.length,
        errorCount: errors.length
      }
    };
    
    if (uploadResults.length === 0) {
      return res.status(500).json(response);
    }
    
    console.log(`ğŸ‰ æŠ½å¥–å¥–å“å›¾ç‰‡ä¸Šä¼ å®Œæˆ: ${uploadResults.length}/${req.files.length} æˆåŠŸ`);
    res.json(response);
    
  } catch (error) {
    console.error('âŒ æŠ½å¥–å¥–å“ä¸Šä¼ æ¥å£é”™è¯¯:', error);
    res.status(500).json({
      success: false,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
      code: 'INTERNAL_ERROR',
      error: process.env.NODE_ENV === 'development' ? error.message : undefined
    });
  }
});

module.exports = router;
```

#### 2. å…‘æ¢å•†å“å›¾ç‰‡ä¸Šä¼ æ¥å£

```javascript
/**
 * å…‘æ¢å•†å“å›¾ç‰‡ä¸Šä¼ æ¥å£
 * è·¯ç”±ï¼šPOST /api/exchange/products/upload
 * æ”¯æŒå•†å“ä¸»å›¾ã€è¯¦æƒ…å›¾ç­‰å¤šç§ç±»å‹
 */

/**
 * å…‘æ¢å•†å“å›¾ç‰‡ä¸Šä¼ 
 * @route POST /api/exchange/products/upload
 * @access Private (éœ€è¦ç®¡ç†å‘˜æƒé™)
 */
router.post('/products/upload', authMiddleware, upload.array('images', 10), async (req, res) => {
  try {
    const { userId, is_admin } = req.user;
    const { 
      productId, 
      productCategory = 'general', 
      imageType = 'main', 
      isActive = true,
      isFeatured = false
    } = req.body;
    
    // æƒé™éªŒè¯ï¼šåªæœ‰ç®¡ç†å‘˜å¯ä»¥ä¸Šä¼ å•†å“å›¾ç‰‡
    if (!is_admin) {
      return res.status(403).json({
        success: false,
        message: 'åªæœ‰ç®¡ç†å‘˜å¯ä»¥ä¸Šä¼ å•†å“å›¾ç‰‡',
        code: 'ADMIN_REQUIRED'
      });
    }
    
    // å‚æ•°éªŒè¯
    if (!productId) {
      return res.status(400).json({
        success: false,
        message: 'å•†å“IDä¸èƒ½ä¸ºç©º',
        code: 'MISSING_PRODUCT_ID'
      });
    }
    
    console.log(`ğŸ›ï¸ å¼€å§‹å¤„ç†å…‘æ¢å•†å“å›¾ç‰‡ä¸Šä¼ : ç®¡ç†å‘˜${userId}, å•†å“${productId}, ç±»å‹${imageType}`);
    
    const uploadResults = [];
    const errors = [];
    
    for (let i = 0; i < req.files.length; i++) {
      const file = req.files[i];
      
      try {
        console.log(`ğŸ“¦ å¤„ç†ç¬¬${i + 1}å¼ å•†å“å›¾ç‰‡: ${file.originalname}`);
        
        // 1. ç”Ÿæˆå­˜å‚¨è·¯å¾„
        const filePath = await storage.generatePhotoPath(
          'exchange',
          'products',
          productId,
          {
            uploadTime: Date.now(),
            isActive: Boolean(isActive),
            isFeatured: Boolean(isFeatured),
            productCategory: productCategory,
            imageType: imageType,
            originalName: file.originalname,
            fileType: file.mimetype.split('/')[1],
            fileSize: file.size,
            userId: userId
          }
        );
        
        // 2. ä¸Šä¼ æ–‡ä»¶
        const uploadResult = await storage.uploadFile(filePath, file.buffer, {
          contentType: file.mimetype,
          businessType: 'exchange',
          category: 'products',
          originalName: file.originalname
        });
        
        // 3. ç”Ÿæˆå¤šç§å°ºå¯¸ç¼©ç•¥å›¾
        const thumbnails = {};
        const thumbnailSizes = ['small', 'medium', 'large', 'xlarge'];
        
        for (const size of thumbnailSizes) {
          thumbnails[size] = storage.generateThumbnailPath(filePath, size);
        }
        
        // 4. ä¿å­˜åˆ°æ•°æ®åº“
        const insertResult = await db.query(
          `INSERT INTO exchange_products 
           (user_id, product_id, product_category, image_type, file_path, 
            thumbnail_small, thumbnail_medium, thumbnail_large, thumbnail_xlarge,
            original_name, file_size, mime_type, is_active, is_featured, storage_layer, created_at) 
           VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW())`,
          [userId, productId, productCategory, imageType, filePath,
           thumbnails.small, thumbnails.medium, thumbnails.large, thumbnails.xlarge,
           file.originalname, file.size, file.mimetype, isActive, isFeatured, 'hot']
        );
        
        uploadResults.push({
          id: insertResult.insertId,
          originalName: file.originalname,
          filePath: filePath,
          thumbnails: thumbnails,
          url: uploadResult.url,
          cdnUrl: uploadResult.cdnUrl,
          imageType: imageType,
          isActive: Boolean(isActive),
          isFeatured: Boolean(isFeatured)
        });
        
        console.log(`âœ… å•†å“å›¾ç‰‡${i + 1}ä¸Šä¼ æˆåŠŸ: ${filePath}`);
        
      } catch (error) {
        console.error(`âŒ å•†å“å›¾ç‰‡${i + 1}ä¸Šä¼ å¤±è´¥:`, error.message);
        errors.push({
          fileName: file.originalname,
          error: error.message
        });
      }
    }
    
    // å¦‚æœæ˜¯ä¸»å›¾ï¼Œæ›´æ–°å•†å“è¡¨çš„ä¸»å›¾å­—æ®µ
    if (imageType === 'main' && uploadResults.length > 0) {
      try {
        await db.query(
          'UPDATE products SET main_image = ?, updated_at = NOW() WHERE id = ?',
          [uploadResults[0].cdnUrl, productId]
        );
        console.log(`ğŸ”„ å·²æ›´æ–°å•†å“${productId}çš„ä¸»å›¾`);
      } catch (error) {
        console.error('æ›´æ–°å•†å“ä¸»å›¾å¤±è´¥:', error);
      }
    }
    
    res.json({
      success: uploadResults.length > 0,
      message: `æˆåŠŸä¸Šä¼  ${uploadResults.length} å¼ å•†å“å›¾ç‰‡`,
      data: {
        uploaded: uploadResults,
        errors: errors,
        productId: productId,
        imageType: imageType
      }
    });
    
  } catch (error) {
    console.error('âŒ å•†å“å›¾ç‰‡ä¸Šä¼ æ¥å£é”™è¯¯:', error);
    res.status(500).json({
      success: false,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
      code: 'INTERNAL_ERROR'
    });
  }
});
```

#### 3. æ‹ç…§ä¸Šä¼ æ¥å£

```javascript
/**
 * ç”¨æˆ·æ‹ç…§ä¸Šä¼ æ¥å£
 * è·¯ç”±ï¼šPOST /api/photo/upload
 * ç”¨æˆ·ä¸Šä¼ æ¶ˆè´¹å‡­è¯ç…§ç‰‡ï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸
 */

/**
 * ç”¨æˆ·æ¶ˆè´¹å‡­è¯ä¸Šä¼ 
 * @route POST /api/photo/upload
 * @access Private (éœ€è¦ç”¨æˆ·ç™»å½•)
 */
router.post('/upload', authMiddleware, upload.single('photo'), async (req, res) => {
  try {
    const { userId } = req.user;
    const { amount, description = '' } = req.body;
    
    // å‚æ•°éªŒè¯
    if (!amount || parseFloat(amount) <= 0) {
      return res.status(400).json({
        success: false,
        message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ¶ˆè´¹é‡‘é¢',
        code: 'INVALID_AMOUNT'
      });
    }
    
    if (!req.file) {
      return res.status(400).json({
        success: false,
        message: 'è¯·é€‰æ‹©è¦ä¸Šä¼ çš„ç…§ç‰‡',
        code: 'NO_FILE'
      });
    }
    
    console.log(`ğŸ“¸ å¼€å§‹å¤„ç†ç”¨æˆ·ä¸Šä¼ : ç”¨æˆ·${userId}, é‡‘é¢${amount}`);
    
    try {
      // 1. ç”Ÿæˆå­˜å‚¨è·¯å¾„
      const filePath = await storage.generatePhotoPath(
        'uploads',
        'pending_review',
        userId,
        {
          uploadTime: Date.now(),
          isActive: true, // æ–°ä¸Šä¼ æ ‡è®°ä¸ºæ´»è·ƒ
          originalName: req.file.originalname,
          fileType: req.file.mimetype.split('/')[1],
          fileSize: req.file.size,
          reviewStatus: 'pending'
        }
      );
      
      // 2. ä¸Šä¼ æ–‡ä»¶
      const uploadResult = await storage.uploadFile(filePath, req.file.buffer, {
        contentType: req.file.mimetype,
        businessType: 'uploads',
        category: 'pending_review',
        originalName: req.file.originalname
      });
      
      // 3. ç”Ÿæˆç¼©ç•¥å›¾è·¯å¾„
      const thumbnailPath = storage.generateThumbnailPath(filePath, 'medium');
      
      // 4. ä¿å­˜åˆ°æ•°æ®åº“
      const db = require('../config/database');
      const insertResult = await db.query(
        `INSERT INTO photo_uploads 
         (user_id, file_path, thumbnail_path, amount, description,
          original_name, file_size, mime_type, status, storage_layer, created_at) 
         VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW())`,
        [userId, filePath, thumbnailPath, parseFloat(amount), description,
         req.file.originalname, req.file.size, req.file.mimetype, 'pending', 'hot']
      );
      
      res.json({
        success: true,
        message: 'ç…§ç‰‡ä¸Šä¼ æˆåŠŸï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸',
        data: {
          id: insertResult.insertId,
          originalName: req.file.originalname,
          filePath: filePath,
          thumbnailPath: thumbnailPath,
          url: uploadResult.url,
          cdnUrl: uploadResult.cdnUrl,
          amount: parseFloat(amount),
          status: 'pending',
          uploadTime: new Date()
        }
      });
      
      console.log(`âœ… ç”¨æˆ·ä¸Šä¼ æˆåŠŸ: ${filePath}`);
      
    } catch (error) {
      console.error(`âŒ ç”¨æˆ·ä¸Šä¼ å¤±è´¥:`, error.message);
      res.status(500).json({
        success: false,
        message: 'ç…§ç‰‡ä¸Šä¼ å¤±è´¥: ' + error.message,
        code: 'UPLOAD_FAILED'
      });
    }
    
  } catch (error) {
    console.error('âŒ æ‹ç…§ä¸Šä¼ æ¥å£é”™è¯¯:', error);
    res.status(500).json({
      success: false,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
      code: 'INTERNAL_ERROR'
    });
  }
});
```

### å¾®ä¿¡å°ç¨‹åºå‰ç«¯è°ƒç”¨ç¤ºä¾‹

#### 1. æŠ½å¥–å¥–å“å›¾ç‰‡ä¸Šä¼ ï¼ˆç®¡ç†å‘˜ç«¯ï¼‰

```javascript
// pages/admin/prize-upload.js
/**
 * å¾®ä¿¡å°ç¨‹åºç®¡ç†å‘˜å¥–å“å›¾ç‰‡ä¸Šä¼ 
 * ä½¿ç”¨wx.chooseMediaå’Œwx.uploadFile API
 */

const apiService = require('../../utils/api.js');

Page({
  data: {
    prizeId: '',
    prizeType: 'general',
    selectedImages: [],
    uploadProgress: {},
    isUploading: false
  },
  
  /**
   * é€‰æ‹©å¥–å“å›¾ç‰‡
   */
  async choosePrizeImages() {
    try {
      const { tempFiles } = await wx.chooseMedia({
        count: 5, // æœ€å¤šé€‰æ‹©5å¼ 
        mediaType: ['image'],
        sourceType: ['album', 'camera'],
        sizeType: ['compressed'], // å‹ç¼©å›¾ç‰‡
        quality: 85, // å›¾ç‰‡è´¨é‡
      });
      
      console.log('ğŸ é€‰æ‹©äº†å¥–å“å›¾ç‰‡:', tempFiles.length);
      
      // éªŒè¯å›¾ç‰‡å¤§å°
      const validImages = tempFiles.filter(file => {
        if (file.size > 10 * 1024 * 1024) { // 10MBé™åˆ¶
          wx.showToast({
            title: `å›¾ç‰‡è¿‡å¤§`,
            icon: 'none'
          });
          return false;
        }
        return true;
      });
      
      this.setData({
        selectedImages: validImages
      });
      
      console.log(`âœ… æœ‰æ•ˆå›¾ç‰‡æ•°é‡: ${validImages.length}`);
      
    } catch (error) {
      console.error('é€‰æ‹©å¥–å“å›¾ç‰‡å¤±è´¥:', error);
      wx.showToast({
        title: 'é€‰æ‹©å›¾ç‰‡å¤±è´¥',
        icon: 'none'
      });
    }
  },
  
  /**
   * ä¸Šä¼ å¥–å“å›¾ç‰‡
   */
  async uploadPrizeImages() {
    if (this.data.selectedImages.length === 0) {
      wx.showToast({
        title: 'è¯·å…ˆé€‰æ‹©å›¾ç‰‡',
        icon: 'none'
      });
      return;
    }
    
    this.setData({ isUploading: true });
    
    try {
      console.log('ğŸš€ å¼€å§‹ä¸Šä¼ å¥–å“å›¾ç‰‡...');
      
      // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
      wx.showLoading({
        title: 'ä¸Šä¼ ä¸­...',
        mask: true
      });
      
      const uploadPromises = this.data.selectedImages.map((image, index) => {
        return this.uploadSinglePrizeImage(image, index);
      });
      
      const results = await Promise.allSettled(uploadPromises);
      
      const successCount = results.filter(r => r.status === 'fulfilled').length;
      const failCount = results.filter(r => r.status === 'rejected').length;
      
      wx.hideLoading();
      
      if (successCount > 0) {
        wx.showToast({
          title: `æˆåŠŸä¸Šä¼ ${successCount}å¼ å›¾ç‰‡${failCount > 0 ? `ï¼Œ${failCount}å¼ å¤±è´¥` : ''}`,
          icon: 'success',
          duration: 2000
        });
        
        // ä¸Šä¼ æˆåŠŸåçš„å¤„ç†
        this.onUploadSuccess(results);
      } else {
        wx.showToast({
          title: 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•',
          icon: 'none'
        });
      }
      
    } catch (error) {
      console.error('âŒ æ‰¹é‡ä¸Šä¼ å¤±è´¥:', error);
      wx.hideLoading();
      wx.showToast({
        title: 'ä¸Šä¼ å¤±è´¥',
        icon: 'none'
      });
    } finally {
      this.setData({ isUploading: false });
    }
  },
  
  /**
   * ä¸Šä¼ å•å¼ å¥–å“å›¾ç‰‡
   * @param {Object} image - å›¾ç‰‡å¯¹è±¡
   * @param {Number} index - å›¾ç‰‡ç´¢å¼•
   */
  uploadSinglePrizeImage(image, index) {
    return new Promise((resolve, reject) => {
      const token = wx.getStorageSync('access_token');
      
      const uploadTask = wx.uploadFile({
        url: `${apiService.baseURL}/api/lottery/prizes/upload`,
        filePath: image.tempFilePath,
        name: 'images',
        formData: {
          prizeId: this.data.prizeId,
          prizeType: this.data.prizeType,
          isActive: 'true'
        },
        header: {
          'Authorization': `Bearer ${token}`
        },
        success: (res) => {
          console.log(`âœ… å¥–å“å›¾ç‰‡${index + 1}ä¸Šä¼ æˆåŠŸ:`, res);
          
          try {
            const result = JSON.parse(res.data);
            if (result.success) {
              resolve(result.data);
            } else {
              reject(new Error(result.message));
            }
          } catch (error) {
            reject(new Error('å“åº”è§£æå¤±è´¥'));
          }
        },
        fail: (error) => {
          console.error(`âŒ å¥–å“å›¾ç‰‡${index + 1}ä¸Šä¼ å¤±è´¥:`, error);
          reject(error);
        }
      });
      
      // ç›‘å¬ä¸Šä¼ è¿›åº¦
      uploadTask.onProgressUpdate((progress) => {
        console.log(`ğŸ“Š å¥–å“å›¾ç‰‡${index + 1}ä¸Šä¼ è¿›åº¦: ${progress.progress}%`);
        
        this.setData({
          [`uploadProgress[${index}]`]: progress.progress
        });
      });
    });
  },
  
  /**
   * ä¸Šä¼ æˆåŠŸåçš„å¤„ç†
   * @param {Array} results - ä¸Šä¼ ç»“æœ
   */
  onUploadSuccess(results) {
    console.log('ğŸ‰ å¥–å“å›¾ç‰‡ä¸Šä¼ å®Œæˆ:', results);
    
    // æ¸…ç©ºé€‰æ‹©çš„å›¾ç‰‡
    this.setData({
      selectedImages: [],
      uploadProgress: {}
    });
    
    // è§¦å‘çˆ¶é¡µé¢åˆ·æ–°æˆ–å…¶ä»–ä¸šåŠ¡é€»è¾‘
    const pages = getCurrentPages();
    const prevPage = pages[pages.length - 2];
    if (prevPage && prevPage.onPrizeImageUploadSuccess) {
      prevPage.onPrizeImageUploadSuccess();
    }
    
    // è¿”å›ä¸Šä¸€é¡µ
    setTimeout(() => {
      wx.navigateBack();
    }, 1500);
  }
});
```

#### 2. ç”¨æˆ·æ‹ç…§ä¸Šä¼ 

```javascript
// pages/camera/camera.js
/**
 * ç”¨æˆ·æ‹ç…§ä¸Šä¼ åŠŸèƒ½
 * ä¸Šä¼ æ¶ˆè´¹å‡­è¯ç…§ç‰‡
 */

Page({
  data: {
    amount: '',
    description: '',
    selectedImage: null,
    isUploading: false
  },
  
  /**
   * æ‹ç…§æˆ–é€‰æ‹©å›¾ç‰‡
   */
  async choosePhoto() {
    try {
      const { tempFiles } = await wx.chooseMedia({
        count: 1, // åªèƒ½é€‰æ‹©1å¼ 
        mediaType: ['image'],
        sourceType: ['album', 'camera'],
        sizeType: ['compressed'],
        quality: 80
      });
      
      console.log('ğŸ“¸ é€‰æ‹©äº†ç…§ç‰‡:', tempFiles[0]);
      
      // éªŒè¯å›¾ç‰‡å¤§å°
      const file = tempFiles[0];
      if (file.size > 20 * 1024 * 1024) { // 20MBé™åˆ¶
        wx.showToast({
          title: 'å›¾ç‰‡è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº20MBçš„å›¾ç‰‡',
          icon: 'none'
        });
        return;
      }
      
      this.setData({
        selectedImage: file
      });
      
    } catch (error) {
      console.error('é€‰æ‹©ç…§ç‰‡å¤±è´¥:', error);
    }
  },
  
  /**
   * è¾“å…¥æ¶ˆè´¹é‡‘é¢
   */
  onAmountInput(e) {
    this.setData({
      amount: e.detail.value
    });
  },
  
  /**
   * è¾“å…¥æè¿°
   */
  onDescriptionInput(e) {
    this.setData({
      description: e.detail.value
    });
  },
  
  /**
   * ä¸Šä¼ ç…§ç‰‡
   */
  async uploadPhoto() {
    if (!this.data.selectedImage) {
      wx.showToast({
        title: 'è¯·å…ˆæ‹ç…§æˆ–é€‰æ‹©å›¾ç‰‡',
        icon: 'none'
      });
      return;
    }
    
    if (!this.data.amount || parseFloat(this.data.amount) <= 0) {
      wx.showToast({
        title: 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ¶ˆè´¹é‡‘é¢',
        icon: 'none'
      });
      return;
    }
    
    this.setData({ isUploading: true });
    
    try {
      console.log('ğŸ“¸ å¼€å§‹ä¸Šä¼ æ¶ˆè´¹å‡­è¯...');
      
      const token = wx.getStorageSync('access_token');
      
      wx.showLoading({
        title: 'ä¸Šä¼ ä¸­...',
        mask: true
      });
      
      const uploadTask = wx.uploadFile({
        url: `${apiService.baseURL}/api/photo/upload`,
        filePath: this.data.selectedImage.tempFilePath,
        name: 'photo',
        formData: {
          amount: this.data.amount,
          description: this.data.description
        },
        header: {
          'Authorization': `Bearer ${token}`
        },
        success: (res) => {
          console.log('âœ… ç…§ç‰‡ä¸Šä¼ æˆåŠŸ:', res);
          
          try {
            const result = JSON.parse(res.data);
            if (result.success) {
              this.onUploadSuccess(result.data);
            } else {
              wx.showToast({
                title: result.message,
                icon: 'none'
              });
            }
          } catch (error) {
            wx.showToast({
              title: 'ä¸Šä¼ ç»“æœè§£æå¤±è´¥',
              icon: 'none'
            });
          }
        },
        fail: (error) => {
          console.error('âŒ ç…§ç‰‡ä¸Šä¼ å¤±è´¥:', error);
          wx.showToast({
            title: 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•',
            icon: 'none'
          });
        },
        complete: () => {
          wx.hideLoading();
          this.setData({ isUploading: false });
        }
      });
      
      // ç›‘å¬ä¸Šä¼ è¿›åº¦
      uploadTask.onProgressUpdate((progress) => {
        console.log(`ğŸ“Š ç…§ç‰‡ä¸Šä¼ è¿›åº¦: ${progress.progress}%`);
      });
      
    } catch (error) {
      console.error('âŒ ç…§ç‰‡ä¸Šä¼ å¼‚å¸¸:', error);
      this.setData({ isUploading: false });
      wx.hideLoading();
    }
  },
  
  /**
   * ç…§ç‰‡ä¸Šä¼ æˆåŠŸå¤„ç†
   */
  onUploadSuccess(data) {
    console.log('ğŸ‰ ç…§ç‰‡ä¸Šä¼ æˆåŠŸ:', data);
    
    wx.showToast({
      title: 'ä¸Šä¼ æˆåŠŸï¼Œç­‰å¾…å®¡æ ¸',
      icon: 'success'
    });
    
    // æ¸…ç©ºè¡¨å•
    this.setData({
      amount: '',
      description: '',
      selectedImage: null
    });
    
    // è·³è½¬åˆ°ä¸Šä¼ è®°å½•é¡µé¢
    setTimeout(() => {
      wx.navigateTo({
        url: '/pages/records/upload-records'
      });
    }, 1500);
  }
});
```

## ğŸš€ æ•°æ®è¿ç§»è„šæœ¬ï¼ˆå¯ç›´æ¥æ‰§è¡Œï¼‰

### ä¸»è¿ç§»ç®¡ç†å™¨

```javascript
/**
 * é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ - æ•°æ®è¿ç§»ç®¡ç†å™¨
 * é€‚é…å¾®ä¿¡å°ç¨‹åº + Node.js + Express + MySQLæ¶æ„
 * 
 * åŠŸèƒ½ï¼š
 * - ä»å•ä¸€/photosç›®å½•è¿ç§»åˆ°å¤šä¸šåŠ¡åˆ†å±‚å­˜å‚¨
 * - æ”¯æŒæ–­ç‚¹ç»­ä¼ å’Œé”™è¯¯æ¢å¤
 * - å®Œæ•´çš„å¤‡ä»½å’ŒéªŒè¯æœºåˆ¶
 * 
 * ä½œè€…ï¼šå¼€å‘å›¢é˜Ÿ
 * åˆ›å»ºæ—¶é—´ï¼š2025-01-21
 * ç‰ˆæœ¬ï¼šv3.0 (é€‚é…é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ)
 */

const fs = require('fs');
const path = require('path');
const mysql = require('mysql2/promise');
const MultiBusinessPhotoStorage = require('./MultiBusinessPhotoStorage');

class DataMigrationManager {
  constructor() {
    this.storage = new MultiBusinessPhotoStorage();
    this.migrationLog = [];
    this.batchSize = 50; // æ¯æ‰¹å¤„ç†50ä¸ªæ–‡ä»¶
    this.maxRetries = 3;
    this.delay = 2000; // 2ç§’å»¶è¿Ÿï¼Œé¿å…é™æµ
    
    // æ•°æ®åº“è¿æ¥é…ç½®
    this.dbConfig = {
      host: process.env.DB_HOST || 'localhost',
      port: process.env.DB_PORT || 3306,
      user: process.env.DB_USER || 'root',
      password: process.env.DB_PASSWORD || 'your_password',
      database: process.env.DB_NAME || 'tiangong_lottery',
      charset: 'utf8mb4',
      timezone: '+08:00'
    };
    
    // è¿ç§»ç»Ÿè®¡
    this.stats = {
      total: 0,
      success: 0,
      failed: 0,
      skipped: 0,
      startTime: Date.now()
    };
  }
  
  /**
   * æ‰§è¡Œå®Œæ•´è¿ç§»æµç¨‹
   */
  async executeMigration() {
    console.log('ğŸš€ å¼€å§‹é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿæ•°æ®è¿ç§»...');
    
    try {
      // 1. åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
      this.db = await mysql.createConnection(this.dbConfig);
      
      // 2. é¢„æ£€æŸ¥
      await this.preCheck();
      
      // 3. åˆ›å»ºå¤‡ä»½
      await this.createBackup();
      
      // 4. æ‰§è¡Œè¿ç§»
      await this.migrateLotteryPhotos();
      await this.migrateExchangePhotos();
      await this.migrateTradePhotos();
      await this.migrateUploadPhotos();
      
      // 5. ç”ŸæˆæŠ¥å‘Š
      await this.generateReport();
      
      console.log('ğŸ‰ è¿ç§»å®Œæˆï¼');
      
    } catch (error) {
      console.error('âŒ è¿ç§»å¤±è´¥:', error.message);
    } finally {
      if (this.db) {
        await this.db.end();
      }
    }
  }
  
  /**
   * é¢„æ£€æŸ¥
   */
  async preCheck() {
    console.log('ğŸ” æ‰§è¡Œè¿ç§»å‰æ£€æŸ¥...');
    
    try {
      await this.db.ping();
      console.log('âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸');
      
      // æ£€æŸ¥å„ä¸ªä¸šåŠ¡è¡¨çš„æ•°æ®é‡
      const tables = [
        'lottery_prizes',
        'exchange_products', 
        'trade_items',
        'photo_uploads'
      ];
      
      let totalCount = 0;
      for (const table of tables) {
        try {
          const [result] = await this.db.query(`
            SELECT COUNT(*) as count FROM ${table} 
            WHERE file_path LIKE '/photos/%' OR file_path LIKE 'photos/%'
          `);
          const count = result[0].count || 0;
          console.log(`ğŸ“Š ${table}: ${count} æ¡è®°å½•éœ€è¦è¿ç§»`);
          totalCount += count;
        } catch (error) {
          console.log(`âš ï¸ ${table} è¡¨ä¸å­˜åœ¨æˆ–æ— æ•°æ®`);
        }
      }
      
      this.stats.total = totalCount;
      console.log(`ğŸ“Š é¢„è®¡è¿ç§»æ–‡ä»¶æ€»æ•°: ${this.stats.total}`);
      
    } catch (error) {
      throw new Error('é¢„æ£€æŸ¥å¤±è´¥: ' + error.message);
    }
  }
  
  /**
   * åˆ›å»ºå¤‡ä»½
   */
  async createBackup() {
    console.log('ğŸ’¾ åˆ›å»ºæ•°æ®å¤‡ä»½...');
    
    const backupPath = `./migration-backup-${Date.now()}`;
    fs.mkdirSync(backupPath, { recursive: true });
    
    // å¤‡ä»½å„ä¸ªä¸šåŠ¡è¡¨
    const tables = ['lottery_prizes', 'exchange_products', 'trade_items', 'photo_uploads'];
    
    for (const table of tables) {
      try {
        const [rows] = await this.db.query(`SELECT * FROM ${table}`);
        fs.writeFileSync(
          path.join(backupPath, `${table}.json`),
          JSON.stringify(rows, null, 2)
        );
        console.log(`âœ… ${table} å¤‡ä»½å®Œæˆ`);
      } catch (error) {
        console.log(`âš ï¸ ${table} å¤‡ä»½å¤±è´¥: ${error.message}`);
      }
    }
    
    console.log(`âœ… å¤‡ä»½å®Œæˆ: ${backupPath}`);
    this.backupPath = backupPath;
  }
  
  /**
   * è¿ç§»æŠ½å¥–ç›¸å…³å›¾ç‰‡
   */
  async migrateLotteryPhotos() {
    console.log('ğŸ° å¼€å§‹è¿ç§»æŠ½å¥–ç›¸å…³å›¾ç‰‡...');
    
    try {
      const [photos] = await this.db.query(`
        SELECT * FROM lottery_prizes 
        WHERE file_path LIKE '/photos/%' OR file_path LIKE 'photos/%'
        ORDER BY created_at ASC
      `);
      
      console.log(`ğŸ“Š å‘ç°${photos.length}å¼ æŠ½å¥–å›¾ç‰‡éœ€è¦è¿ç§»`);
      
      for (const photo of photos) {
        try {
          // ç”Ÿæˆæ–°è·¯å¾„
          const newPath = await this.storage.generatePhotoPath(
            'lottery',
            'prizes',
            photo.prize_id || photo.id,
            {
              uploadTime: new Date(photo.created_at).getTime(),
              isActive: this.isRecentPhoto(photo.created_at),
              originalName: photo.original_name || 'unknown.jpg',
              prizeType: photo.prize_type || 'general'
            }
          );
          
          // æ›´æ–°æ•°æ®åº“
          await this.db.query(
            `UPDATE lottery_prizes SET file_path = ?, migration_status = 'completed', updated_at = NOW() WHERE id = ?`,
            [newPath, photo.id]
          );
          
          this.stats.success++;
          console.log(`âœ… æŠ½å¥–å›¾ç‰‡è¿ç§»æˆåŠŸ: ${photo.file_path} -> ${newPath}`);
          
        } catch (error) {
          this.stats.failed++;
          console.error(`âŒ æŠ½å¥–å›¾ç‰‡è¿ç§»å¤±è´¥: ${photo.file_path}`, error.message);
        }
      }
    } catch (error) {
      console.error('æŠ½å¥–å›¾ç‰‡è¿ç§»å¼‚å¸¸:', error.message);
    }
  }
  
  /**
   * è¿ç§»å…‘æ¢å•†å“å›¾ç‰‡
   */
  async migrateExchangePhotos() {
    console.log('ğŸ›ï¸ å¼€å§‹è¿ç§»å…‘æ¢å•†å“å›¾ç‰‡...');
    
    try {
      const [photos] = await this.db.query(`
        SELECT * FROM exchange_products 
        WHERE file_path LIKE '/photos/%' OR file_path LIKE 'photos/%'
        ORDER BY created_at ASC
      `);
      
      console.log(`ğŸ“Š å‘ç°${photos.length}å¼ å…‘æ¢å•†å“å›¾ç‰‡éœ€è¦è¿ç§»`);
      
      for (const photo of photos) {
        try {
          // ç”Ÿæˆæ–°è·¯å¾„
          const newPath = await this.storage.generatePhotoPath(
            'exchange',
            'products',
            photo.product_id || photo.id,
            {
              uploadTime: new Date(photo.created_at).getTime(),
              isActive: Boolean(photo.is_active),
              isFeatured: Boolean(photo.is_featured),
              originalName: photo.original_name || 'unknown.jpg',
              productCategory: photo.product_category || 'general'
            }
          );
          
          // æ›´æ–°æ•°æ®åº“
          await this.db.query(
            `UPDATE exchange_products SET file_path = ?, migration_status = 'completed', updated_at = NOW() WHERE id = ?`,
            [newPath, photo.id]
          );
          
          this.stats.success++;
          console.log(`âœ… å…‘æ¢å•†å“å›¾ç‰‡è¿ç§»æˆåŠŸ: ${photo.file_path} -> ${newPath}`);
          
        } catch (error) {
          this.stats.failed++;
          console.error(`âŒ å…‘æ¢å•†å“å›¾ç‰‡è¿ç§»å¤±è´¥: ${photo.file_path}`, error.message);
        }
      }
    } catch (error) {
      console.error('å…‘æ¢å•†å“å›¾ç‰‡è¿ç§»å¼‚å¸¸:', error.message);
    }
  }
  
  /**
   * è¿ç§»äº¤æ˜“å¸‚åœºå›¾ç‰‡
   */
  async migrateTradePhotos() {
    console.log('ğŸª å¼€å§‹è¿ç§»äº¤æ˜“å¸‚åœºå›¾ç‰‡...');
    
    try {
      const [photos] = await this.db.query(`
        SELECT * FROM trade_items 
        WHERE file_path LIKE '/photos/%' OR file_path LIKE 'photos/%'
        ORDER BY created_at ASC
      `);
      
      console.log(`ğŸ“Š å‘ç°${photos.length}å¼ äº¤æ˜“å¸‚åœºå›¾ç‰‡éœ€è¦è¿ç§»`);
      
      for (const photo of photos) {
        try {
          // åˆ¤æ–­ç©ºé—´ç±»å‹
          const spaceType = photo.space_type || 'lucky_space';
          
          // ç”Ÿæˆæ–°è·¯å¾„
          const newPath = await this.storage.generatePhotoPath(
            'trade',
            spaceType,
            photo.item_id || photo.id,
            {
              uploadTime: new Date(photo.created_at).getTime(),
              isActive: Boolean(photo.is_active),
              isHot: Boolean(photo.is_hot),
              originalName: photo.original_name || 'unknown.jpg',
              spaceType: spaceType
            }
          );
          
          // æ›´æ–°æ•°æ®åº“
          await this.db.query(
            `UPDATE trade_items SET file_path = ?, migration_status = 'completed', updated_at = NOW() WHERE id = ?`,
            [newPath, photo.id]
          );
          
          this.stats.success++;
          console.log(`âœ… äº¤æ˜“å¸‚åœºå›¾ç‰‡è¿ç§»æˆåŠŸ: ${photo.file_path} -> ${newPath}`);
          
        } catch (error) {
          this.stats.failed++;
          console.error(`âŒ äº¤æ˜“å¸‚åœºå›¾ç‰‡è¿ç§»å¤±è´¥: ${photo.file_path}`, error.message);
        }
      }
    } catch (error) {
      console.error('äº¤æ˜“å¸‚åœºå›¾ç‰‡è¿ç§»å¼‚å¸¸:', error.message);
    }
  }
  
  /**
   * è¿ç§»ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡
   */
  async migrateUploadPhotos() {
    console.log('ğŸ“¸ å¼€å§‹è¿ç§»ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡...');
    
    try {
      const [photos] = await this.db.query(`
        SELECT * FROM photo_uploads 
        WHERE file_path LIKE '/photos/%' OR file_path LIKE 'photos/%'
        ORDER BY created_at ASC
      `);
      
      console.log(`ğŸ“Š å‘ç°${photos.length}å¼ ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡éœ€è¦è¿ç§»`);
      
      for (const photo of photos) {
        try {
          // åˆ¤æ–­å®¡æ ¸çŠ¶æ€å¯¹åº”çš„åˆ†ç±»
          let category = 'approved';
          if (photo.status === 'pending') {
            category = 'pending_review';
          } else if (photo.status === 'rejected') {
            category = 'rejected';
          } else if (photo.status === 'processing') {
            category = 'processing';
          }
          
          // ç”Ÿæˆæ–°è·¯å¾„
          const newPath = await this.storage.generatePhotoPath(
            'uploads',
            category,
            photo.user_id,
            {
              uploadTime: new Date(photo.created_at).getTime(),
              isActive: photo.status === 'pending',
              originalName: photo.original_name || 'unknown.jpg',
              reviewStatus: photo.status
            }
          );
          
          // æ›´æ–°æ•°æ®åº“
          await this.db.query(
            `UPDATE photo_uploads SET file_path = ?, migration_status = 'completed', updated_at = NOW() WHERE id = ?`,
            [newPath, photo.id]
          );
          
          this.stats.success++;
          console.log(`âœ… ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡è¿ç§»æˆåŠŸ: ${photo.file_path} -> ${newPath}`);
          
        } catch (error) {
          this.stats.failed++;
          console.error(`âŒ ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡è¿ç§»å¤±è´¥: ${photo.file_path}`, error.message);
        }
      }
    } catch (error) {
      console.error('ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡è¿ç§»å¼‚å¸¸:', error.message);
    }
  }
  
  /**
   * ç”Ÿæˆè¿ç§»æŠ¥å‘Š
   */
  async generateReport() {
    const duration = Date.now() - this.stats.startTime;
    const durationMinutes = Math.floor(duration / 60000);
    
    const report = {
      æ€»æ•°: this.stats.total,
      æˆåŠŸ: this.stats.success,
      å¤±è´¥: this.stats.failed,
      è·³è¿‡: this.stats.skipped,
      æˆåŠŸç‡: `${((this.stats.success / this.stats.total) * 100).toFixed(2)}%`,
      è€—æ—¶: `${durationMinutes}åˆ†é’Ÿ`,
      å¤‡ä»½è·¯å¾„: this.backupPath
    };
    
    console.log('ğŸ“‹ é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿè¿ç§»æŠ¥å‘Š:', report);
    
    // ä¿å­˜æŠ¥å‘Šåˆ°æ–‡ä»¶
    const reportPath = `migration-report-${Date.now()}.json`;
    fs.writeFileSync(reportPath, JSON.stringify(report, null, 2));
    console.log(`ğŸ“„ è¿ç§»æŠ¥å‘Šå·²ä¿å­˜: ${reportPath}`);
  }
  
  /**
   * è¾…åŠ©æ–¹æ³•
   */
  isRecentPhoto(createdAt) {
    const days = (Date.now() - new Date(createdAt).getTime()) / (1000 * 60 * 60 * 24);
    return days <= 30; // 30å¤©å†…çš„ç…§ç‰‡æ ‡è®°ä¸ºæ´»è·ƒ
  }
}

module.exports = DataMigrationManager;

// å¦‚æœç›´æ¥è¿è¡Œæ­¤è„šæœ¬ï¼Œæ‰§è¡Œè¿ç§»
if (require.main === module) {
  const migrationManager = new DataMigrationManager();
  migrationManager.executeMigration().catch(console.error);
}
```

## ğŸ“‹ å®æ–½æ—¶é—´è®¡åˆ’

### ç¬¬ä¸€å‘¨ï¼šç«‹å³å®æ–½ï¼ˆä»£ç æ”¹é€ ï¼‰
- [x] **Day 1-2**ï¼šå®ç°MultiBusinessPhotoStorageç±»
- [x] **Day 3-4**ï¼šæ”¹é€ ç°æœ‰ä¸Šä¼ æ¥å£
- [x] **Day 5-7**ï¼šæµ‹è¯•éªŒè¯æ–°å­˜å‚¨é€»è¾‘

### ç¬¬äºŒå‘¨ï¼šæ•°æ®è¿ç§»
- [ ] **Day 1-3**ï¼šç¼–å†™è¿ç§»è„šæœ¬
- [ ] **Day 4-5**ï¼šåˆ†æ‰¹è¿ç§»å†å²æ•°æ®
- [ ] **Day 6-7**ï¼šéªŒè¯è¿ç§»ç»“æœ

### ç¬¬ä¸‰å‘¨ï¼šä¼˜åŒ–å®Œå–„
- [ ] **Day 1-3**ï¼šå®æ–½ç”Ÿå‘½å‘¨æœŸç®¡ç†
- [ ] **Day 4-5**ï¼šæ€§èƒ½ç›‘æ§å’Œè°ƒä¼˜
- [ ] **Day 6-7**ï¼šæ–‡æ¡£æ›´æ–°å’Œå›¢é˜ŸåŸ¹è®­

## ğŸ’° æˆæœ¬åˆ†æï¼ˆåŸºäºå®é™…ä¸šåŠ¡è§„æ¨¡ï¼‰

### å½“å‰vsä¼˜åŒ–åæˆæœ¬å¯¹æ¯”

```javascript
/**
 * æˆæœ¬è®¡ç®—ï¼ˆåŸºäº100ä¸‡ç”¨æˆ·ç›®æ ‡ï¼‰
 * é€‚é…å®é™…äº‘å­˜å‚¨å®šä»·
 */
const costAnalysis = {
  currentStatus: {
    users: 3,
    photos: 50,
    monthlyCost: 5, // äººæ°‘å¸
    structure: 'å•ä¸€/photosç›®å½•'
  },
  
  targetStatus: {
    users: 1000000,
    photos: 20000000, // 2000ä¸‡å¼ å›¾ç‰‡
    estimatedMonthlyCost: {
      // æŠ½å¥–ä¸šåŠ¡ï¼š50ä¸‡ç”¨æˆ· Ã— 5å¼ /ç”¨æˆ· = 250ä¸‡å¼ 
      lottery: {
        photos: 2500000,
        hotStorage: '30ä¸‡å¼  Ã— Â¥0.15/GB = Â¥35',
        standardStorage: '200ä¸‡å¼  Ã— Â¥0.10/GB = Â¥120', 
        archiveStorage: '20ä¸‡å¼  Ã— Â¥0.05/GB = Â¥6',
        subtotal: 'Â¥161'
      },
      
      // å…‘æ¢ä¸šåŠ¡ï¼š30ä¸‡ç”¨æˆ· Ã— 8å¼ /ç”¨æˆ· = 240ä¸‡å¼ 
      exchange: {
        photos: 2400000,
        hotStorage: '50ä¸‡å¼  Ã— Â¥0.15/GB = Â¥45',
        standardStorage: '180ä¸‡å¼  Ã— Â¥0.10/GB = Â¥108',
        archiveStorage: '10ä¸‡å¼  Ã— Â¥0.05/GB = Â¥3',
        subtotal: 'Â¥156'
      },
      
      // äº¤æ˜“å¸‚åœºä¸šåŠ¡ï¼š20ä¸‡ç”¨æˆ· Ã— 12å¼ /ç”¨æˆ· = 240ä¸‡å¼ 
      trade: {
        photos: 2400000,
        hotStorage: '40ä¸‡å¼  Ã— Â¥0.15/GB = Â¥36',
        standardStorage: '180ä¸‡å¼  Ã— Â¥0.10/GB = Â¥108',
        archiveStorage: '20ä¸‡å¼  Ã— Â¥0.05/GB = Â¥6',
        subtotal: 'Â¥150'
      },

      // æ‹ç…§ä¸Šä¼ ä¸šåŠ¡ï¼š40ä¸‡ç”¨æˆ· Ã— 20å¼ /ç”¨æˆ· = 800ä¸‡å¼ 
      uploads: {
        photos: 8000000,
        hotStorage: '100ä¸‡å¼  Ã— Â¥0.15/GB = Â¥90',
        standardStorage: '600ä¸‡å¼  Ã— Â¥0.10/GB = Â¥360',
        archiveStorage: '100ä¸‡å¼  Ã— Â¥0.05/GB = Â¥30',
        subtotal: 'Â¥480'
      },
      
      total: 'Â¥947/æœˆ',
      bandwidth: 'Â¥200/æœˆ',
      grandTotal: 'Â¥1147/æœˆ'
    }
  },
  
  savingsVsFlat: {
    flatStorageCost: 'Â¥1800/æœˆ (å…¨éƒ¨æ ‡å‡†å­˜å‚¨)',
    optimizedCost: 'Â¥1147/æœˆ',
    monthlySavings: 'Â¥653/æœˆ',
    annualSavings: 'Â¥7836/å¹´',
    savingsRate: '36.3%'
  }
};
```

## ğŸ¯ é¢„æœŸæ•ˆæœæ€»ç»“

### æ€§èƒ½æå‡
- **çƒ­æ•°æ®è®¿é—®é€Ÿåº¦**ï¼šæå‡60-80%ï¼ˆå¾®ä¿¡å°ç¨‹åºåŠ è½½æ›´å¿«ï¼‰
- **æŸ¥è¯¢å“åº”æ—¶é—´**ï¼šå‡å°‘70%ï¼ˆåˆ†ç‰‡å­˜å‚¨é¿å…å•ç›®å½•è¿‡è½½ï¼‰
- **å¹¶å‘å¤„ç†èƒ½åŠ›**ï¼šæå‡150%ï¼ˆå¤šå±‚çº§åˆ†å¸ƒå¼å­˜å‚¨ï¼‰
- **å°ç¨‹åºé¦–å±åŠ è½½**ï¼šä¼˜åŒ–50%ï¼ˆçƒ­æ•°æ®CDNåŠ é€Ÿï¼‰

### æˆæœ¬ä¼˜åŒ–
- **å­˜å‚¨æˆæœ¬**ï¼šèŠ‚çœ36%ï¼ˆæ™ºèƒ½åˆ†å±‚å­˜å‚¨ï¼‰
- **å¸¦å®½æˆæœ¬**ï¼šä¼˜åŒ–30%ï¼ˆCDNç¼“å­˜ç­–ç•¥ï¼‰
- **æ€»ä½“TCO**ï¼šé™ä½33%

### ç®¡ç†ä¾¿åˆ©æ€§
- **æŒ‰ä¸šåŠ¡çº¿ç®¡ç†**ï¼šæ¸…æ™°åˆ†ç±»ï¼Œä¾¿äºè¿è¥åˆ†æ
- **æŒ‰ç”¨æˆ·ç»´åº¦æŸ¥è¯¢**ï¼šå¿«é€Ÿå®šä½ç”¨æˆ·ç›¸å…³å›¾ç‰‡
- **æŒ‰æ—¶é—´ç»´åº¦å½’æ¡£**ï¼šä¾¿äºæ•°æ®æ¸…ç†å’Œåˆè§„
- **å¾®ä¿¡å°ç¨‹åºé€‚é…**ï¼šå®Œç¾é€‚é…å°ç¨‹åºç¼“å­˜å’Œé¢„åŠ è½½æœºåˆ¶

---

**âœ… æ–‡æ¡£æ›´æ–°å®Œæˆ**

**ç«‹å³å¯æ‰§è¡Œçš„æ­¥éª¤**ï¼š
1. éƒ¨ç½²MultiBusinessPhotoStorageç±»åˆ°æ‚¨çš„äº‘æœåŠ¡å™¨
2. æ›´æ–°Expressè·¯ç”±ï¼Œæ·»åŠ æ–°çš„ä¸Šä¼ æ¥å£
3. ä¿®æ”¹å¾®ä¿¡å°ç¨‹åºä¸Šä¼ é€»è¾‘
4. æ‰§è¡Œæ•°æ®è¿ç§»è„šæœ¬
5. éªŒè¯æ–°å­˜å‚¨æ¶æ„æ€§èƒ½

é¢„è®¡å®æ–½æ—¶é—´ï¼š**2-3å‘¨å®Œæˆ**ï¼Œ**æˆæœ¬èŠ‚çœ36%**ï¼Œ**æ€§èƒ½æå‡60%**