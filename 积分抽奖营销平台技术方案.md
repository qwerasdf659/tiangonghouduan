# ç§¯åˆ†æŠ½å¥–è¥é”€å¹³å°æŠ€æœ¯æ–¹æ¡ˆ

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´11æœˆ30æ—¥  
> **é€‚ç”¨åœºæ™¯**: åŸºäºæ¶ˆè´¹è¿”ç§¯åˆ†+æ¦‚ç‡æŠ½å¥–çš„è¥é”€å¹³å°

---

## ğŸ“Š ä¸€ã€å•†ä¸šæ¨¡å¼æ¦‚è¿°

### 1.1 èµ„é‡‘æµè½¬é€»è¾‘

```
ç”¨æˆ·æ¶ˆè´¹ 1500å…ƒ
    â†“
å¹³å°ä½£é‡‘ 150å…ƒ (10%)
    â†“
â”œâ”€ å¹³å°åˆ©æ¶¦: 30å…ƒ (20%)
â””â”€ å¥–å“é¢„ç®—: 120å…ƒ (80%)
    â†“
å¥–å“é‡‡è´­: 120å…ƒæˆæœ¬ â†’ å¸‚åœºä»·360å…ƒ â†’ æ ‡ä»·450ç§¯åˆ†
    â†“
ç”¨æˆ·è·å¾—: 1500ç§¯åˆ†
    â†“
æ¦‚ç‡æ§åˆ¶: 80%ä¸­å¥–ç‡(1200ç§¯åˆ†æœ‰æ•ˆ) + 20%è½®ç©º(300ç§¯åˆ†)
    â†“
å®é™…æˆæœ: ç”¨æˆ·è·å¾—çº¦120å…ƒæˆæœ¬çš„å¥–å“
```

### 1.2 æ ¸å¿ƒé—®é¢˜

**ç—›ç‚¹**: æ¯ä¸ªç”¨æˆ·æ¶ˆè´¹é‡‘é¢ä¸åŒï¼Œå¦‚ä½•è‡ªåŠ¨åŒ–æ§åˆ¶å„è‡ªèƒ½è·å¾—çš„å¥–å“æ€»ä»·å€¼ï¼Ÿ

**ç¤ºä¾‹**:
- ç”¨æˆ·Aæ¶ˆè´¹1000å…ƒ â†’ ä½£é‡‘100å…ƒ â†’ å¥–å“é¢„ç®—80å…ƒ â†’ 1000ç§¯åˆ†
- ç”¨æˆ·Bæ¶ˆè´¹500å…ƒ â†’ ä½£é‡‘50å…ƒ â†’ å¥–å“é¢„ç®—40å…ƒ â†’ 500ç§¯åˆ†
- ç”¨æˆ·Cæ¶ˆè´¹2000å…ƒ â†’ ä½£é‡‘200å…ƒ â†’ å¥–å“é¢„ç®—160å…ƒ â†’ 2000ç§¯åˆ†

---

## ğŸ¯ äºŒã€æ ¸å¿ƒè§£å†³æ–¹æ¡ˆï¼šä¸ªäººå¥–å“é¢„ç®—è´¦æˆ·ç³»ç»Ÿ

### 2.1 æ–¹æ¡ˆæ ¸å¿ƒæ€æƒ³

**ä¸ºæ¯ä¸ªç”¨æˆ·è‡ªåŠ¨åˆ›å»º"å¥–å“é¢„ç®—è´¦æˆ·"ï¼ŒæŠ½å¥–æ—¶å®æ—¶æ‰£å‡ï¼Œé¢„ç®—ç”¨å®Œè‡ªåŠ¨è½®ç©º**

### 2.2 æ•°æ®åº“è®¾è®¡

#### ç”¨æˆ·å¥–å“é¢„ç®—è¡¨ (user_prize_budget)

```sql
CREATE TABLE user_prize_budget (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    total_budget DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT 'æ€»é¢„ç®—(æˆæœ¬ä»·)',
    used_budget DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT 'å·²ä½¿ç”¨é¢„ç®—',
    remaining_budget DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT 'å‰©ä½™é¢„ç®—',
    points_balance INT NOT NULL DEFAULT 0 COMMENT 'ç§¯åˆ†ä½™é¢',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id)
) COMMENT='ç”¨æˆ·å¥–å“é¢„ç®—è´¦æˆ·è¡¨';
```

#### æ¶ˆè´¹è®°å½•è¡¨ (transactions)

```sql
CREATE TABLE transactions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    merchant_id BIGINT NOT NULL COMMENT 'å•†å®¶ID',
    consume_amount DECIMAL(10,2) NOT NULL COMMENT 'æ¶ˆè´¹é‡‘é¢',
    commission DECIMAL(10,2) NOT NULL COMMENT 'å¹³å°ä½£é‡‘(10%)',
    profit DECIMAL(10,2) NOT NULL COMMENT 'å¹³å°åˆ©æ¶¦(20%)',
    prize_budget DECIMAL(10,2) NOT NULL COMMENT 'å¥–å“é¢„ç®—(80%)',
    points_granted INT NOT NULL COMMENT 'å‘æ”¾ç§¯åˆ†',
    status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_status (status)
) COMMENT='æ¶ˆè´¹è®°å½•è¡¨';
```

#### å¥–å“åº“è¡¨ (prizes)

```sql
CREATE TABLE prizes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(200) NOT NULL COMMENT 'å¥–å“åç§°',
    cost_price DECIMAL(10,2) NOT NULL COMMENT 'é‡‡è´­æˆæœ¬ä»·',
    market_value DECIMAL(10,2) NOT NULL COMMENT 'å¸‚åœºä»·å€¼',
    points_price INT NOT NULL COMMENT 'ç§¯åˆ†æ ‡ä»·',
    stock INT NOT NULL DEFAULT 0 COMMENT 'åº“å­˜æ•°é‡',
    issued_count INT NOT NULL DEFAULT 0 COMMENT 'å·²å‘æ”¾æ•°é‡',
    category VARCHAR(50) COMMENT 'å¥–å“åˆ†ç±»',
    status ENUM('active', 'inactive') DEFAULT 'active',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_cost_price (cost_price),
    INDEX idx_status (status)
) COMMENT='å¥–å“åº“è¡¨';
```

#### æŠ½å¥–è®°å½•è¡¨ (lottery_records)

```sql
CREATE TABLE lottery_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    prize_id BIGINT COMMENT 'ä¸­å¥–å¥–å“ID(NULLè¡¨ç¤ºè½®ç©º)',
    cost_points INT NOT NULL COMMENT 'æ¶ˆè€—ç§¯åˆ†',
    actual_cost DECIMAL(10,2) DEFAULT 0 COMMENT 'å®é™…æˆæœ¬',
    is_won TINYINT(1) NOT NULL COMMENT 'æ˜¯å¦ä¸­å¥–',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at)
) COMMENT='æŠ½å¥–è®°å½•è¡¨';
```

---

## ğŸ”„ ä¸‰ã€è‡ªåŠ¨åŒ–ä¸šåŠ¡æµç¨‹

### 3.1 æ¶ˆè´¹å®¡æ ¸é€šè¿‡ â†’ è‡ªåŠ¨åˆ†é…é¢„ç®—

```javascript
/**
 * æ¶ˆè´¹å®¡æ ¸é€šè¿‡æ—¶è‡ªåŠ¨è®¡ç®—å’Œåˆ†é…é¢„ç®—
 */
async function onTransactionApproved(userId, consumeAmount, merchantId) {
    // 1. è®¡ç®—ä½£é‡‘å’Œé¢„ç®—åˆ†é…
    const commission = consumeAmount * 0.1;      // 10%ä½£é‡‘
    const profit = commission * 0.2;             // 20%åˆ©æ¶¦
    const prizeBudget = commission * 0.8;        // 80%å¥–å“é¢„ç®—ï¼ˆæˆæœ¬ä»·ï¼‰
    const pointsGranted = consumeAmount;         // 1å…ƒ=1ç§¯åˆ†
    
    // 2. å¼€å¯æ•°æ®åº“äº‹åŠ¡
    const transaction = await sequelize.transaction();
    
    try {
        // 3. è®°å½•æ¶ˆè´¹æ˜ç»†
        await Transaction.create({
            user_id: userId,
            merchant_id: merchantId,
            consume_amount: consumeAmount,
            commission: commission,
            profit: profit,
            prize_budget: prizeBudget,
            points_granted: pointsGranted,
            status: 'approved'
        }, { transaction });
        
        // 4. è‡ªåŠ¨åˆ›å»º/æ›´æ–°ç”¨æˆ·å¥–å“é¢„ç®—è´¦æˆ·ï¼ˆå…³é”®ï¼ï¼‰
        const [budget, created] = await UserPrizeBudget.findOrCreate({
            where: { user_id: userId },
            defaults: {
                total_budget: prizeBudget,
                remaining_budget: prizeBudget,
                points_balance: pointsGranted
            },
            transaction
        });
        
        if (!created) {
            // å·²æœ‰è´¦æˆ·ï¼Œç´¯åŠ é¢„ç®—å’Œç§¯åˆ†
            await budget.increment({
                total_budget: prizeBudget,
                remaining_budget: prizeBudget,
                points_balance: pointsGranted
            }, { transaction });
        }
        
        // 5. æäº¤äº‹åŠ¡
        await transaction.commit();
        
        console.log(`âœ… ç”¨æˆ·${userId}æ¶ˆè´¹${consumeAmount}å…ƒå®¡æ ¸é€šè¿‡`);
        console.log(`   - å‘æ”¾ç§¯åˆ†: ${pointsGranted}`);
        console.log(`   - å¥–å“é¢„ç®—: ${prizeBudget}å…ƒ(æˆæœ¬ä»·)`);
        console.log(`   - å¹³å°åˆ©æ¶¦: ${profit}å…ƒ`);
        
        return { success: true, prizeBudget, pointsGranted };
        
    } catch (error) {
        await transaction.rollback();
        console.error('âŒ æ¶ˆè´¹å®¡æ ¸å¤„ç†å¤±è´¥:', error);
        throw error;
    }
}
```

### 3.2 ç”¨æˆ·æŠ½å¥– â†’ åŠ¨æ€ç­›é€‰å¥–å“æ± 

```javascript
/**
 * ç”¨æˆ·æŠ½å¥–æ ¸å¿ƒé€»è¾‘
 * @param {number} userId - ç”¨æˆ·ID
 * @param {number} costPoints - å•æ¬¡æŠ½å¥–æ¶ˆè€—ç§¯åˆ†(é»˜è®¤100)
 */
async function userDrawLottery(userId, costPoints = 100) {
    // 1. æŸ¥è¯¢ç”¨æˆ·é¢„ç®—å’Œç§¯åˆ†è´¦æˆ·
    const budget = await UserPrizeBudget.findOne({
        where: { user_id: userId }
    });
    
    // 2. å‰ç½®éªŒè¯
    if (!budget) {
        return { success: false, message: 'ç”¨æˆ·è´¦æˆ·ä¸å­˜åœ¨' };
    }
    
    if (budget.points_balance < costPoints) {
        return { success: false, message: 'ç§¯åˆ†ä¸è¶³ï¼Œè¯·ç»§ç»­æ¶ˆè´¹' };
    }
    
    if (budget.remaining_budget <= 0) {
        return { 
            success: false, 
            message: 'å¥–å“é¢„ç®—å·²ç”¨å®Œï¼Œè¯·ç»§ç»­æ¶ˆè´¹è·å–æ›´å¤šæœºä¼š' 
        };
    }
    
    // 3. åŠ¨æ€ç­›é€‰å¯æŠ½å¥–å“ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼ï¼‰
    const availablePrizes = await Prize.findAll({
        where: {
            cost_price: { [Op.lte]: budget.remaining_budget },  // æˆæœ¬ä»·â‰¤å‰©ä½™é¢„ç®—
            points_price: { [Op.lte]: costPoints },             // ç§¯åˆ†æ ‡ä»·â‰¤æ¶ˆè€—ç§¯åˆ†
            stock: { [Op.gt]: 0 },                              // åº“å­˜å……è¶³
            status: 'active'
        },
        order: [['cost_price', 'DESC']]  // ä¼˜å…ˆå±•ç¤ºé«˜ä»·å€¼å¥–å“
    });
    
    // 4. åˆ¤æ–­æ˜¯å¦è½®ç©º
    if (availablePrizes.length === 0) {
        // é¢„ç®—ä¸è¶³ä»¥å…‘æ¢ä»»ä½•å¥–å“ â†’ å¼ºåˆ¶è½®ç©º
        await recordLottery(userId, null, costPoints, 0, false);
        
        return { 
            success: true, 
            result: 'miss', 
            message: 'å¾ˆé—æ†¾æœªä¸­å¥–ï¼Œç»§ç»­åŠªåŠ›ï¼',
            remaining_budget: budget.remaining_budget
        };
    }
    
    // 5. åŠ æƒéšæœºæŠ½å–å¥–å“
    const wonPrize = weightedRandomSelect(availablePrizes);
    
    // 6. æ‰§è¡Œä¸­å¥–å¤„ç†ï¼ˆäº‹åŠ¡ï¼‰
    const transaction = await sequelize.transaction();
    
    try {
        // æ‰£å‡ç”¨æˆ·å¥–å“é¢„ç®—ï¼ˆæˆæœ¬ä»·ï¼‰
        await budget.decrement({
            remaining_budget: wonPrize.cost_price
        }, { transaction });
        
        await budget.increment({
            used_budget: wonPrize.cost_price
        }, { transaction });
        
        // æ‰£å‡ç”¨æˆ·ç§¯åˆ†ï¼ˆæ ‡ä»·ï¼‰
        await budget.decrement({
            points_balance: costPoints
        }, { transaction });
        
        // æ‰£å‡å¥–å“åº“å­˜
        await wonPrize.decrement({ stock: 1 }, { transaction });
        await wonPrize.increment({ issued_count: 1 }, { transaction });
        
        // è®°å½•æŠ½å¥–ç»“æœ
        await LotteryRecord.create({
            user_id: userId,
            prize_id: wonPrize.id,
            cost_points: costPoints,
            actual_cost: wonPrize.cost_price,
            is_won: true
        }, { transaction });
        
        await transaction.commit();
        
        console.log(`ğŸ‰ ç”¨æˆ·${userId}ä¸­å¥–: ${wonPrize.name}`);
        console.log(`   - æ¶ˆè€—ç§¯åˆ†: ${costPoints}`);
        console.log(`   - å®é™…æˆæœ¬: ${wonPrize.cost_price}å…ƒ`);
        console.log(`   - å‰©ä½™é¢„ç®—: ${budget.remaining_budget - wonPrize.cost_price}å…ƒ`);
        
        return { 
            success: true, 
            result: 'won', 
            prize: wonPrize,
            remaining_budget: budget.remaining_budget - wonPrize.cost_price
        };
        
    } catch (error) {
        await transaction.rollback();
        console.error('âŒ æŠ½å¥–å¤„ç†å¤±è´¥:', error);
        throw error;
    }
}

/**
 * åŠ æƒéšæœºé€‰æ‹©ï¼ˆå¯æ ¹æ®æˆæœ¬ä»·è®¾ç½®æƒé‡ï¼‰
 */
function weightedRandomSelect(prizes) {
    // ç®€å•å®ç°ï¼šæˆæœ¬ä»·è¶Šä½æƒé‡è¶Šé«˜ï¼ˆæ§åˆ¶æˆæœ¬ï¼‰
    const weights = prizes.map(p => 1 / p.cost_price);
    const totalWeight = weights.reduce((sum, w) => sum + w, 0);
    
    let random = Math.random() * totalWeight;
    for (let i = 0; i < prizes.length; i++) {
        random -= weights[i];
        if (random <= 0) {
            return prizes[i];
        }
    }
    
    return prizes[0]; // å…œåº•
}
```

---

## ğŸ² å››ã€ä¸‰ç§æ¦‚ç‡æ§åˆ¶ç­–ç•¥

### ç­–ç•¥1: é¢„ç®—è€—å°½å‹ â­ æ¨è

**ç‰¹ç‚¹**: é¢„ç®—ç”¨å®Œè‡ªåŠ¨è½®ç©ºï¼Œæœ€ç²¾å‡†

**é€»è¾‘**:
```
remaining_budget > 0 â†’ ä»æˆæœ¬â‰¤remaining_budgetçš„å¥–å“ä¸­éšæœºæŠ½
remaining_budget = 0 â†’ 100%è½®ç©º
```

**ä¼˜åŠ¿**: å®Œå…¨è‡ªåŠ¨åŒ–ã€ç²¾å‡†æˆæœ¬æ§åˆ¶ã€é˜²æ­¢è¶…æ”¯

---

### ç­–ç•¥2: æ¦‚ç‡è¡°å‡å‹

**ç‰¹ç‚¹**: é¢„ç®—è¶Šå°‘ä¸­å¥–ç‡è¶Šä½

**é€»è¾‘**:
```javascript
function calculateWinRate(usedBudget, totalBudget) {
    const usageRate = usedBudget / totalBudget;
    
    if (usageRate < 0.5) return 0.9;      // å‰50%é¢„ç®—ï¼š90%ä¸­å¥–ç‡
    if (usageRate < 0.8) return 0.7;      // 50-80%ï¼š70%ä¸­å¥–ç‡  
    if (usageRate < 1.0) return 0.4;      // 80-100%ï¼š40%ä¸­å¥–ç‡
    return 0;                              // é¢„ç®—ç”¨å®Œï¼š0%ä¸­å¥–ç‡
}
```

**ä¼˜åŠ¿**: ç”¨æˆ·ä½“éªŒæ›´å¥½ï¼ˆæ¸è¿›å¼é™çº§ï¼‰

---

### ç­–ç•¥3: æ™ºèƒ½åˆ†æ¡£å‹

**ç‰¹ç‚¹**: æ ¹æ®é¢„ç®—è‡ªåŠ¨åˆ‡æ¢å¥–å“æ± 

**é…ç½®**:
```javascript
const PRIZE_TIERS = {
    high: { minBudget: 100, costRange: [50, 100] },
    medium: { minBudget: 50, costRange: [20, 50] },
    low: { minBudget: 0, costRange: [5, 20] }
};

function selectPrizeTier(remainingBudget) {
    if (remainingBudget >= 100) return 'high';
    if (remainingBudget >= 50) return 'medium';
    if (remainingBudget > 0) return 'low';
    return null; // è½®ç©º
}
```

**ä¼˜åŠ¿**: å¥–å“ç®¡ç†æ¸…æ™°ã€ç”¨æˆ·ä½“éªŒæ¸è¿›

---

## ğŸ“Š äº”ã€å®é™…è¿è¡Œç¤ºä¾‹

### ç”¨æˆ·A: æ¶ˆè´¹1000å…ƒ

```
ã€åˆå§‹çŠ¶æ€ã€‘
- å¥–å“é¢„ç®—: 80å…ƒï¼ˆæˆæœ¬ä»·ï¼‰
- ç§¯åˆ†ä½™é¢: 1000åˆ†

ã€ç¬¬1æ¬¡æŠ½å¥–ã€‘æ¶ˆè€—100åˆ†
â”œâ”€ å¯æŠ½å¥–å“: æˆæœ¬â‰¤80å…ƒçš„æ‰€æœ‰å¥–å“
â”œâ”€ ä¸­å¥–: ä»·å€¼50å…ƒçš„è€³æœºï¼ˆæˆæœ¬20å…ƒï¼‰
â”œâ”€ å‰©ä½™é¢„ç®—: 60å…ƒ
â””â”€ å‰©ä½™ç§¯åˆ†: 900åˆ†

ã€ç¬¬2æ¬¡æŠ½å¥–ã€‘æ¶ˆè€—100åˆ†
â”œâ”€ å¯æŠ½å¥–å“: æˆæœ¬â‰¤60å…ƒçš„æ‰€æœ‰å¥–å“
â”œâ”€ ä¸­å¥–: ä»·å€¼100å…ƒçš„ä¿æ¸©æ¯ï¼ˆæˆæœ¬30å…ƒï¼‰
â”œâ”€ å‰©ä½™é¢„ç®—: 30å…ƒ
â””â”€ å‰©ä½™ç§¯åˆ†: 800åˆ†

ã€ç¬¬3æ¬¡æŠ½å¥–ã€‘æ¶ˆè€—100åˆ†
â”œâ”€ å¯æŠ½å¥–å“: æˆæœ¬â‰¤30å…ƒçš„æ‰€æœ‰å¥–å“
â”œâ”€ ä¸­å¥–: ä»·å€¼60å…ƒçš„æ•°æ®çº¿ï¼ˆæˆæœ¬15å…ƒï¼‰
â”œâ”€ å‰©ä½™é¢„ç®—: 15å…ƒ
â””â”€ å‰©ä½™ç§¯åˆ†: 700åˆ†

ã€ç¬¬4æ¬¡æŠ½å¥–ã€‘æ¶ˆè€—100åˆ†
â”œâ”€ å¯æŠ½å¥–å“: æˆæœ¬â‰¤15å…ƒçš„å°å¥–å“
â”œâ”€ ä¸­å¥–: ä»·å€¼30å…ƒçš„é’¥åŒ™æ‰£ï¼ˆæˆæœ¬8å…ƒï¼‰
â”œâ”€ å‰©ä½™é¢„ç®—: 7å…ƒ
â””â”€ å‰©ä½™ç§¯åˆ†: 600åˆ†

ã€ç¬¬5æ¬¡æŠ½å¥–ã€‘æ¶ˆè€—100åˆ†
â”œâ”€ å¯æŠ½å¥–å“: æˆæœ¬â‰¤7å…ƒï¼ˆå¯èƒ½æ— å¥–å“ï¼‰
â”œâ”€ ç»“æœ: è½®ç©º âŒ
â”œâ”€ å‰©ä½™é¢„ç®—: 7å…ƒï¼ˆæœªæ¶ˆè€—ï¼‰
â””â”€ å‰©ä½™ç§¯åˆ†: 500åˆ†

ã€åç»­æŠ½å¥–ã€‘å…¨éƒ¨è½®ç©ºï¼ˆé™¤éå†æ¬¡æ¶ˆè´¹ï¼‰
```

### ç”¨æˆ·B: æ¶ˆè´¹500å…ƒ

```
ã€åˆå§‹çŠ¶æ€ã€‘
- å¥–å“é¢„ç®—: 40å…ƒ
- ç§¯åˆ†ä½™é¢: 500åˆ†

ã€æŠ½å¥–è¿‡ç¨‹ã€‘
â”œâ”€ ç¬¬1æ¬¡: ä¸­å¥–æˆæœ¬20å…ƒ â†’ å‰©ä½™20å…ƒ
â”œâ”€ ç¬¬2æ¬¡: ä¸­å¥–æˆæœ¬15å…ƒ â†’ å‰©ä½™5å…ƒ
â”œâ”€ ç¬¬3æ¬¡: è½®ç©ºï¼ˆæ— æˆæœ¬â‰¤5å…ƒå¥–å“ï¼‰
â””â”€ åç»­: å…¨éƒ¨è½®ç©º
```

---

## ğŸ›¡ï¸ å…­ã€é£æ§æœºåˆ¶

### 6.1 é˜²åˆ·æœºåˆ¶

```javascript
// å•ç”¨æˆ·å•æ—¥æŠ½å¥–æ¬¡æ•°é™åˆ¶
const DAILY_LOTTERY_LIMIT = 50;

async function checkDailyLimit(userId) {
    const today = new Date().toISOString().split('T')[0];
    const count = await LotteryRecord.count({
        where: {
            user_id: userId,
            created_at: {
                [Op.gte]: new Date(today + ' 00:00:00'),
                [Op.lte]: new Date(today + ' 23:59:59')
            }
        }
    });
    
    return count < DAILY_LOTTERY_LIMIT;
}
```

### 6.2 æˆæœ¬é¢„è­¦

```javascript
// æ¯æ—¥æˆæœ¬ç›‘æ§
async function dailyCostMonitor() {
    const today = new Date().toISOString().split('T')[0];
    
    const stats = await LotteryRecord.sum('actual_cost', {
        where: {
            created_at: {
                [Op.gte]: new Date(today + ' 00:00:00')
            },
            is_won: true
        }
    });
    
    const DAILY_COST_LIMIT = 10000; // æ¯æ—¥æˆæœ¬ä¸Šé™10000å…ƒ
    
    if (stats >= DAILY_COST_LIMIT * 0.8) {
        console.warn(`âš ï¸ ä»Šæ—¥æˆæœ¬å·²è¾¾${stats}å…ƒï¼Œæ¥è¿‘ä¸Šé™`);
        // è§¦å‘é™ä½ä¸­å¥–ç‡æˆ–æé«˜è½®ç©ºç‡çš„é€»è¾‘
    }
}
```

### 6.3 ä¿åº•æœºåˆ¶

```javascript
// è¿ç»­Næ¬¡æœªä¸­å¥–å¿…ä¸­ä¸€æ¬¡
async function checkGuarantee(userId) {
    const recentRecords = await LotteryRecord.findAll({
        where: { user_id: userId },
        order: [['created_at', 'DESC']],
        limit: 10
    });
    
    const consecutiveMiss = recentRecords.filter(r => !r.is_won).length;
    
    if (consecutiveMiss >= 10) {
        // å¼ºåˆ¶ä¸­å¥–é€»è¾‘
        return true;
    }
    
    return false;
}
```

---

## ğŸ“ˆ ä¸ƒã€æ•°æ®ç›‘æ§æŒ‡æ ‡

### 7.1 æ ¸å¿ƒæŒ‡æ ‡

```javascript
// å®æ—¶ç›‘æ§ä»ªè¡¨æ¿
async function getRealTimeMetrics() {
    const today = new Date().toISOString().split('T')[0];
    
    // 1. å®é™…ä¸­å¥–ç‡
    const totalLotteries = await LotteryRecord.count({
        where: {
            created_at: { [Op.gte]: new Date(today + ' 00:00:00') }
        }
    });
    
    const wonCount = await LotteryRecord.count({
        where: {
            created_at: { [Op.gte]: new Date(today + ' 00:00:00') },
            is_won: true
        }
    });
    
    const actualWinRate = (wonCount / totalLotteries * 100).toFixed(2);
    
    // 2. å®é™…æˆæœ¬ç‡
    const totalBudget = await Transaction.sum('prize_budget', {
        where: {
            created_at: { [Op.gte]: new Date(today + ' 00:00:00') },
            status: 'approved'
        }
    });
    
    const actualCost = await LotteryRecord.sum('actual_cost', {
        where: {
            created_at: { [Op.gte]: new Date(today + ' 00:00:00') },
            is_won: true
        }
    });
    
    const costRate = (actualCost / totalBudget * 100).toFixed(2);
    
    return {
        actualWinRate,        // å®é™…ä¸­å¥–ç‡ï¼ˆç›®æ ‡80%ï¼‰
        costRate,             // æˆæœ¬ç‡ï¼ˆç›®æ ‡â‰¤100%ï¼‰
        totalLotteries,       // æ€»æŠ½å¥–æ¬¡æ•°
        wonCount,             // ä¸­å¥–æ¬¡æ•°
        totalBudget,          // æ€»é¢„ç®—
        actualCost            // å®é™…æˆæœ¬
    };
}
```

---

## âœ… å…«ã€æ–¹æ¡ˆä¼˜åŠ¿æ€»ç»“

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| âœ… å®Œå…¨è‡ªåŠ¨åŒ– | æ— éœ€æ‰‹åŠ¨ä¸ºæ¯ä¸ªç”¨æˆ·è®¾ç½®ï¼Œç³»ç»Ÿæ ¹æ®æ¶ˆè´¹é‡‘é¢è‡ªåŠ¨è®¡ç®—é¢„ç®— |
| âœ… ç²¾å‡†æˆæœ¬æ§åˆ¶ | æ¯ä¸ªç”¨æˆ·å¥–å“æˆæœ¬ä¸¥æ ¼æ§åˆ¶åœ¨å…¶é¢„ç®—å†…ï¼Œä¸ä¼šè¶…æ”¯ |
| âœ… å…¬å¹³é€æ˜ | æ¶ˆè´¹è¶Šå¤šé¢„ç®—è¶Šå¤šï¼Œå¥–å“ä»·å€¼è¶Šé«˜ï¼Œæ¿€åŠ±ç”¨æˆ·å¤šæ¶ˆè´¹ |
| âœ… åŠ¨æ€å¹³è¡¡ | ç³»ç»Ÿè‡ªåŠ¨æ ¹æ®å‰©ä½™é¢„ç®—ç­›é€‰å¥–å“ï¼Œå®ç°è‡ªç„¶çš„æ¦‚ç‡æ§åˆ¶ |
| âœ… é˜²æ­¢ä½œå¼Š | é¢„ç®—ç”¨å®Œè‡ªåŠ¨è½®ç©ºï¼Œæ— æ³•é€šè¿‡åˆ·æŠ½å¥–è·å–è¶…é¢å¥–å“ |
| âœ… æ•°æ®å¯è¿½æº¯ | æ¯ç¬”é¢„ç®—çš„äº§ç”Ÿã€ä½¿ç”¨ã€ä½™é¢éƒ½æœ‰å®Œæ•´è®°å½• |

---

## ğŸš€ ä¹ã€æ¨èå®æ–½è·¯å¾„

### ç¬¬ä¸€é˜¶æ®µï¼šæ ¸å¿ƒåŠŸèƒ½ï¼ˆ1-2å‘¨ï¼‰

- [x] æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡å’Œåˆ›å»º
- [x] æ¶ˆè´¹å®¡æ ¸è‡ªåŠ¨åˆ†é…é¢„ç®—åŠŸèƒ½
- [x] ç”¨æˆ·æŠ½å¥–æ ¸å¿ƒé€»è¾‘ï¼ˆåŠ¨æ€ç­›é€‰å¥–å“ï¼‰
- [x] åŸºç¡€ç®¡ç†åå°ï¼ˆå¥–å“ç®¡ç†ã€æ¶ˆè´¹å®¡æ ¸ï¼‰

### ç¬¬äºŒé˜¶æ®µï¼šé£æ§ä¼˜åŒ–ï¼ˆ1å‘¨ï¼‰

- [ ] é˜²åˆ·æœºåˆ¶ï¼ˆå•æ—¥é™é¢ã€é¢‘ç‡é™åˆ¶ï¼‰
- [ ] æˆæœ¬é¢„è­¦ç³»ç»Ÿ
- [ ] ä¿åº•æœºåˆ¶ï¼ˆè¿ç»­æœªä¸­å¥–ä¿åº•ï¼‰

### ç¬¬ä¸‰é˜¶æ®µï¼šæ•°æ®åˆ†æï¼ˆ1å‘¨ï¼‰

- [ ] å®æ—¶ç›‘æ§ä»ªè¡¨æ¿
- [ ] è´¢åŠ¡æŠ¥è¡¨ç³»ç»Ÿ
- [ ] ç”¨æˆ·è¡Œä¸ºåˆ†æ

---

## ğŸ“‹ åã€åˆè§„æ€§å»ºè®®

### æ³•å¾‹é£é™©ç‚¹

1. **æŠ½å¥–æ´»åŠ¨èµ„è´¨**: éƒ¨åˆ†åœ°åŒºæŠ½å¥–ç±»è¥é”€éœ€è¦ç”³æŠ¥å¤‡æ¡ˆ
2. **æ¦‚ç‡å…¬ç¤º**: å»ºè®®å…¬ç¤ºå¤§è‡´ä¸­å¥–ç‡ï¼ˆå¦‚"ä¸­å¥–ç‡â‰¥70%"ï¼‰
3. **ç”¨æˆ·åè®®**: æ˜ç¡®ç§¯åˆ†ä½¿ç”¨è§„åˆ™ã€æœ‰æ•ˆæœŸã€è½®ç©ºæœºåˆ¶
4. **å‘ç¥¨é—®é¢˜**: ç”¨æˆ·æ¶ˆè´¹å‘ç¥¨ç”±å•†å®¶å¼€å…·ï¼Œå¥–å“å¯èƒ½æ¶‰åŠä¸ªäººæ‰€å¾—ç¨

### åˆè§„åŒ–å»ºè®®

- å°†"æŠ½å¥–"åŒ…è£…ä¸º"ç§¯åˆ†å…‘æ¢+éšæœºæƒŠå–œåŠ æˆ"
- è®¾ç½®ç§¯åˆ†æœ‰æ•ˆæœŸ(å¦‚1å¹´)ï¼Œè¿‡æœŸæ¸…é›¶
- æä¾›"ä¿åº•å…‘æ¢"é€‰é¡¹ï¼šå›ºå®šç§¯åˆ†æ¢å›ºå®šå¥–å“ï¼ˆæ— æƒŠå–œï¼‰
- æ˜ç¡®æ ‡æ³¨"æœ€ç»ˆè§£é‡Šæƒå½’å¹³å°æ‰€æœ‰"

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚éœ€è¯¦ç»†å±•å¼€æŸä¸ªæ¨¡å—çš„å®ç°ç»†èŠ‚ï¼Œæˆ–éœ€è¦å®Œæ•´çš„ä»£ç å®ç°ï¼Œè¯·éšæ—¶è”ç³»æŠ€æœ¯å›¢é˜Ÿã€‚

---

**æ–‡æ¡£ç»“æŸ**

