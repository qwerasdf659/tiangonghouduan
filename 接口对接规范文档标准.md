# 🔗 接口对接规范文档 - 餐厅积分抽奖系统

> **前后端接口对接完整规范** - 基于实际项目代码的三端协作标准化接口文档

## 📋 一、文档定位与标准

### 1.1 文档定位
- **多重受众**：前端开发、后端开发、测试工程师
- **核心职责**：定义前后端数据交互标准和协议
- **技术边界**：专注接口层面，连接前端、后端、数据库三端
- **内容深度**：提供可直接使用的接口规范和示例
- **项目状态**：✅ **100%基于实际代码分析**
- **更新时间**：2025年07月03日 - 基于实际代码深度分析更新
- **使用模型**：Claude Sonnet 4

### 1.2 🎯 实际项目API架构（基于routes/目录分析）

**📋 核心API模块（基于实际路由文件）**

#### 1.2.1 🔐 认证授权模块 (routes/auth.js - 377行)
```javascript
// 实际实现的认证接口
const AUTH_APIS = {
  login: {
    method: 'POST',
    path: '/api/auth/login', 
    description: '用户登录（手机号 + 验证码）',
    implementation: 'authenticateUser() - 支持findOrCreateByMobile自动创建用户'
  },
  adminLogin: {
    method: 'POST',
    path: '/api/auth/admin-login',
    description: '管理员登录（账号 + 密码）',
    implementation: 'authenticateAdmin() - 隐藏登录入口'
  },
  refreshToken: {
    method: 'POST',
    path: '/api/auth/refresh',
    description: 'JWT Token刷新',
    implementation: 'refreshTokens() - 自动延长有效期'
  },
  verifyToken: {
    method: 'GET',
    path: '/api/auth/verify-token',
    description: 'Token验证',
    implementation: 'verifyToken() - 中间件验证'
  },
  logout: {
    method: 'POST',
    path: '/api/auth/logout',
    description: '退出登录',
    implementation: 'logout() - 清除Token'
  },
  sendCode: {
    method: 'POST',
    path: '/api/auth/send-code',
    description: '发送验证码',
    implementation: 'sendVerificationCode() - 开发阶段暂停'
  }
};
```

#### 1.2.2 🎰 抽奖系统模块 (routes/lottery.js - 277行)
```javascript
// 实际实现的抽奖接口
const LOTTERY_APIS = {
  getConfig: {
    method: 'GET',
    path: '/api/lottery/config',
    description: '获取抽奖配置（转盘渲染必需）',
    implementation: 'LotteryService.getFrontendConfig() - 返回8区域转盘配置'
  },
  performDraw: {
    method: 'POST',
    path: '/api/lottery/draw',
    description: '执行抽奖（支持单抽、连抽）',
    implementation: 'LotteryService.performDraw() - 含10次保底机制'
  },
  getRecords: {
    method: 'GET',
    path: '/api/lottery/records',
    description: '抽奖记录查询（分页）',
    implementation: 'LotteryRecord.findAndCountAll() - 分页查询'
  },
  getStatistics: {
    method: 'GET',
    path: '/api/lottery/statistics',
    description: '抽奖统计数据',
    implementation: 'getLotteryStatistics() - 用户抽奖统计'
  }
};
```

#### 1.2.3 🛍️ 积分兑换模块 (routes/exchange.js - 353行)
```javascript
// 实际实现的兑换接口
const EXCHANGE_APIS = {
  getProducts: {
    method: 'GET',
    path: '/api/exchange/products',
    description: '商品列表（分页、筛选）',
    implementation: 'CommodityPool.findAndCountAll() - 支持分类筛选'
  },
  submitExchange: {
    method: 'POST',
    path: '/api/exchange/submit',
    description: '提交兑换订单',
    implementation: 'processExchange() - 库存检查、积分扣除、WebSocket推送'
  },
  getOrders: {
    method: 'GET',
    path: '/api/exchange/orders',
    description: '兑换订单列表',
    implementation: 'ExchangeOrder.findAndCountAll() - 用户订单查询'
  },
  getCategories: {
    method: 'GET',
    path: '/api/exchange/categories',
    description: '商品分类',
    implementation: 'CommodityPool.getCategories() - 动态分类'
  }
};
```

#### 1.2.4 📸 拍照上传模块 (routes/photo.js - 331行)
```javascript
// 实际实现的拍照接口
const PHOTO_APIS = {
  uploadPhoto: {
    method: 'POST',
    path: '/api/photo/upload',
    description: '拍照上传（消费小票）',
    implementation: 'sealosStorage.uploadImage() - Sealos云存储'
  },
  getHistory: {
    method: 'GET',
    path: '/api/photo/history',
    description: '上传历史记录',
    implementation: 'PhotoReview.findAndCountAll() - 用户上传历史'
  },
  getReviewDetail: {
    method: 'GET',
    path: '/api/photo/review/:id',
    description: '审核详情',
    implementation: 'PhotoReview.findByPk() - 审核状态和理由'
  },
  getStatistics: {
    method: 'GET',
    path: '/api/photo/statistics',
    description: '拍照统计',
    implementation: 'getPhotoStatistics() - 用户拍照统计'
  }
};
```

#### 1.2.5 👥 用户管理模块 (routes/user.js - 237行)
```javascript
// 实际实现的用户接口
const USER_APIS = {
  getUserInfo: {
    method: 'GET',
    path: '/api/user/info',
    description: '获取用户信息',
    implementation: 'User.getSafeUserInfo() - 脱敏用户信息'
  },
  updateUserInfo: {
    method: 'PUT',
    path: '/api/user/info',
    description: '更新用户信息',
    implementation: 'User.update() - 昵称、头像更新'
  },
  uploadAvatar: {
    method: 'POST',
    path: '/api/user/avatar',
    description: '头像上传',
    implementation: 'sealosStorage.uploadAvatar() - 头像云存储'
  },
  getPointsRecords: {
    method: 'GET',
    path: '/api/user/points-records',
    description: '积分记录（分页）',
    implementation: 'PointsRecord.findAndCountAll() - 积分变动明细'
  }
};
```

#### 1.2.6 🏪 商家管理模块 (routes/merchant.js - 545行)
```javascript
// 实际实现的商家接口
const MERCHANT_APIS = {
  applyMerchant: {
    method: 'POST',
    path: '/api/merchant/apply',
    description: '申请商家权限',
    implementation: 'User.update() - 商家权限申请'
  },
  getPendingReviews: {
    method: 'GET',
    path: '/api/merchant/reviews/pending',
    description: '待审核列表',
    implementation: 'PhotoReview.findAndCountAll() - 待审核照片'
  },
  approveReview: {
    method: 'POST',
    path: '/api/merchant/reviews/:id/approve',
    description: '审核通过',
    implementation: 'PhotoReview.approve() - 积分发放、WebSocket推送'
  },
  rejectReview: {
    method: 'POST',
    path: '/api/merchant/reviews/:id/reject',
    description: '审核拒绝',
    implementation: 'PhotoReview.reject() - 拒绝理由、状态更新'
  },
  batchReview: {
    method: 'POST',
    path: '/api/merchant/reviews/batch',
    description: '批量审核',
    implementation: 'processBatchReview() - 批量处理审核'
  },
  getStatistics: {
    method: 'GET',
    path: '/api/merchant/statistics',
    description: '审核统计',
    implementation: 'getMerchantStatistics() - 商家审核数据'
  }
};
```

### 1.3 🔄 WebSocket实时通信（基于services/websocket.js分析）

**实际实现的WebSocket服务**：
```javascript
// WebSocket服务配置 (services/websocket.js - 312行)
const WEBSOCKET_CONFIG = {
  // 连接配置
  connection: {
    path: '/ws',                    // WebSocket路径
    port: 'HTTP服务器端口',         // 与HTTP服务共享端口
    authentication: 'JWT Token',   // JWT认证机制
    heartbeat: 30000,              // 心跳间隔30秒
    maxConnections: 1000           // 最大连接数
  },
  
  // 实际推送事件
  events: {
    'connected': '连接成功',
    'points_update': '积分变动推送',
    'stock_update': '库存变动推送',
    'review_result': '审核结果推送',
    'system_notification': '系统通知推送'
  },
  
  // 实际实现的方法
  methods: {
    'authenticate()': 'JWT Token验证',
    'sendToUser()': '发送消息给特定用户',
    'broadcastToAll()': '广播消息给所有用户',
    'getConnectionStats()': '获取连接统计',
    'cleanupTimeoutConnections()': '清理超时连接'
  }
};
```

### 1.4 🔄 实际数据库事务处理（基于Sequelize实现）

**事务安全机制**：
```javascript
// 实际的事务处理模式
const TRANSACTION_PATTERNS = {
  // 抽奖事务（lotteryService.js）
  lotteryTransaction: {
    operations: [
      '1. 检查用户积分余额',
      '2. 执行抽奖算法（含保底机制）',
      '3. 扣除用户积分',
      '4. 记录积分变动',
      '5. 更新保底计数',
      '6. 发放奖品（如有）',
      '7. WebSocket推送积分变动'
    ],
    rollback: '任何步骤失败时回滚所有操作'
  },
  
  // 兑换事务（exchange.js）
  exchangeTransaction: {
    operations: [
      '1. 检查商品库存',
      '2. 检查用户积分',
      '3. 扣减商品库存',
      '4. 扣除用户积分',
      '5. 创建兑换订单',
      '6. 记录积分变动',
      '7. WebSocket推送库存变动'
    ],
    rollback: '库存不足或积分不足时回滚'
  },
  
  // 审核事务（photo.js）
  reviewTransaction: {
    operations: [
      '1. 更新审核状态',
      '2. 记录审核理由',
      '3. 发放积分奖励（审核通过）',
      '4. 记录积分变动',
      '5. WebSocket推送审核结果'
    ],
    rollback: '积分发放失败时回滚审核状态'
  }
};
```

---

## 🔌 二、核心API接口详细规范

### 2.1 🔐 认证授权接口 (routes/auth.js)

#### 2.1.1 用户登录接口
```http
POST /api/auth/login
Content-Type: application/json
```

**请求参数**：
```json
{
  "mobile": "13800000000",     // 必需：11位手机号
  "verification_code": "123456" // 必需：6位验证码（开发阶段可跳过）
}
```

**响应格式**：
```json
{
  "code": 0,
  "msg": "登录成功",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expires_in": 7200,
    "user_info": {
      "user_id": 11,
      "mobile": "138****0000",
      "nickname": "用户2136",
      "total_points": 1000,
      "is_merchant": false,
      "status": "active",
      "avatar": null,
      "last_login": "2025-07-03T16:15:00.000Z",
      "created_at": "2025-07-03T00:04:00.000Z"
    }
  }
}
```

#### 2.1.2 管理员登录接口
```http
POST /api/auth/admin-login
Content-Type: application/json
```

**请求参数**：
```json
{
  "username": "admin",         // 必需：管理员账号
  "password": "admin123456",   // 必需：管理员密码
  "verification_code": "123456" // 可选：短信二次验证（开发阶段跳过）
}
```

**响应格式**：
```json
{
  "code": 0,
  "msg": "管理员登录成功",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expires_in": 7200,
    "admin_info": {
      "admin_id": 1,
      "username": "admin",
      "role": "super_admin",
      "permissions": ["user_management", "lottery_config", "system_settings"]
    }
  }
}
```

#### 2.1.3 Token刷新接口
```http
POST /api/auth/refresh
Content-Type: application/json
Authorization: Bearer <refresh_token>
```

**响应格式**：
```json
{
  "code": 0,
  "msg": "Token刷新成功",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expires_in": 7200
  }
}
```

### 2.2 🎰 抽奖系统接口 (routes/lottery.js)

#### 2.2.1 获取抽奖配置接口
```http
GET /api/lottery/config
Authorization: Bearer <access_token>
```

**响应格式**：
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "prizes": [
      {
        "id": 1,
        "name": "八八折券",
        "type": "coupon",
        "value": "88.00",
        "angle": 0,
        "color": "#E74C3C",
        "probability": "0.0000",
        "isActivity": true,
        "costPoints": 100
      },
      {
        "id": 2,
        "name": "九八折券",
        "type": "coupon",
        "value": "98.00",
        "angle": 45,
        "color": "#27AE60",
        "probability": "0.1000",
        "isActivity": true,
        "costPoints": 100
      }
    ],
    "costPerDraw": 100,
    "totalPrizes": 8,
    "pitySystem": {
      "enabled": true,
      "pityLimit": 10,
      "pityPrizeName": "九八折券"
    },
    "user_pity": {
      "current_count": 3,
      "remaining_draws": 7,
      "pity_limit": 10
    }
  }
}
```

#### 2.2.2 执行抽奖接口
```http
POST /api/lottery/draw
Content-Type: application/json
Authorization: Bearer <access_token>
```

**请求参数**：
```json
{
  "draw_type": "single"  // 可选：single(单抽), triple(3连抽), quintuple(5连抽), decade(10连抽)
}
```

**响应格式**：
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "draw_type": "single",
    "results": [
      {
        "prize": "九八折券",
        "pity": {
          "triggered": false,
          "remaining": 9
        },
        "reward": {
          "type": "coupon",
          "value": "98.00"
        },
        "draw_sequence": 1
      }
    ],
    "total_cost": 100,
    "user_points": 900,
    "remaining_points": 900,
    "balance": 900,
    "points": 900,
    "today_count": 5,
    "user_info": {
      "remaining_points": 900,
      "today_count": 5,
      "pity_info": {
        "current_count": 4,
        "remaining_draws": 6
      }
    }
  }
}
```

#### 2.2.3 抽奖记录查询接口
```http
GET /api/lottery/records?page=1&limit=20&draw_type=single&prize_type=coupon
Authorization: Bearer <access_token>
```

**查询参数**：
- `page`: 页码（默认1）
- `limit`: 每页数量（默认20，最大100）
- `draw_type`: 抽奖类型筛选（可选）
- `prize_type`: 奖品类型筛选（可选）

**响应格式**：
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "records": [
      {
        "id": 123,
        "draw_id": "draw_20250703_001",
        "prize_name": "九八折券",
        "prize_type": "coupon",
        "prize_value": "98.00",
        "draw_type": "single",
        "points_cost": 100,
        "is_near_miss": false,
        "created_at": "2025-07-03T16:15:00.000Z"
      }
    ],
    "pagination": {
      "total": 150,
      "page": 1,
      "limit": 20,
      "total_pages": 8
    }
  }
}
```

### 2.3 🛍️ 积分兑换接口 (routes/exchange.js)

#### 2.3.1 商品列表接口
```http
GET /api/exchange/products?page=1&limit=20&category=food&sort=hot
Authorization: Bearer <access_token>
```

**查询参数**：
- `page`: 页码（默认1）
- `limit`: 每页数量（默认20）
- `category`: 商品分类（可选）
- `sort`: 排序方式（hot:热门, price:价格, stock:库存）
- `search`: 搜索关键词（可选）

**响应格式**：
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "products": [
      {
        "id": 1,
        "name": "美食券50元",
        "description": "适用于店内所有菜品",
        "category": "voucher",
        "points_required": 500,
        "stock": 100,
        "original_price": "50.00",
        "image_url": "https://sealos.storage/products/voucher50.jpg",
        "is_hot": true,
        "exchange_count": 156,
        "status": "active",
        "created_at": "2025-07-03T00:00:00.000Z"
      }
    ],
    "pagination": {
      "total": 25,
      "page": 1,
      "limit": 20,
      "total_pages": 2
    },
    "categories": ["voucher", "food", "drink", "gift"]
  }
}
```

#### 2.3.2 提交兑换订单接口
```http
POST /api/exchange/submit
Content-Type: application/json
Authorization: Bearer <access_token>
```

**请求参数**：
```json
{
  "product_id": 1,        // 必需：商品ID
  "quantity": 1,          // 必需：兑换数量
  "user_address": {       // 可选：收货地址（实物商品需要）
    "name": "张三",
    "phone": "13800000000",
    "address": "北京市朝阳区xxx"
  },
  "remark": "备注信息"    // 可选：备注
}
```

**响应格式**：
```json
{
  "code": 0,
  "msg": "兑换成功",
  "data": {
    "order_id": "EX20250703001",
    "product_name": "美食券50元",
    "points_cost": 500,
    "quantity": 1,
    "total_points": 500,
    "remaining_points": 400,
    "exchange_code": "EX123456789",
    "order_status": "completed",
    "delivery_info": {
      "type": "virtual",  // virtual:虚拟商品, physical:实物商品
      "estimated_date": null
    },
    "created_at": "2025-07-03T16:20:00.000Z"
  }
}
```

### 2.4 📸 拍照上传接口 (routes/photo.js)

#### 2.4.1 拍照上传接口
```http
POST /api/photo/upload
Content-Type: multipart/form-data
Authorization: Bearer <access_token>
```

**请求参数**：
```javascript
// FormData格式
const formData = new FormData();
formData.append('photo', imageFile);          // 必需：图片文件
formData.append('amount', '58.50');           // 必需：消费金额
formData.append('description', '晚餐消费');   // 可选：消费描述
```

**响应格式**：
```json
{
  "code": 0,
  "msg": "上传成功",
  "data": {
    "upload_id": "UP20250703001",
    "image_url": "https://sealos.storage/uploads/photo_123456.jpg",
    "amount": 58.50,
    "expected_points": 585,
    "status": "pending",
    "review_status": "待审核",
    "upload_time": "2025-07-03T16:25:00.000Z",
    "estimated_review_time": "2025-07-04T16:25:00.000Z"
  }
}
```

#### 2.4.2 上传历史接口
```http
GET /api/photo/history?limit=10&status=all
Authorization: Bearer <access_token>
```

**查询参数**：
- `limit`: 返回数量（默认10，最大50）
- `status`: 状态筛选（all:全部, approved:已通过, pending:待审核, rejected:已拒绝）

**响应格式**：
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "image_url": "https://sealos.storage/uploads/photo_123456.jpg",
        "amount": 58.50,
        "points": 585,
        "status": "approved",
        "review_reason": "审核通过",
        "upload_time": "2025-07-03T14:30:00.000Z",
        "review_time": "2025-07-03T15:30:00.000Z"
      }
    ],
    "total": 15,
    "summary": {
      "total_uploads": 15,
      "approved_count": 12,
      "pending_count": 2,
      "rejected_count": 1,
      "total_points_earned": 7250
    }
  }
}
```

### 2.5 👥 用户管理接口 (routes/user.js)

#### 2.5.1 获取用户信息接口
```http
GET /api/user/info
Authorization: Bearer <access_token>
```

**响应格式**：
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "user_id": 11,
    "mobile": "138****0000",
    "nickname": "用户2136",
    "total_points": 1000,
    "is_merchant": false,
    "status": "active",
    "avatar": "https://sealos.storage/avatars/user11.jpg",
    "last_login": "2025-07-03T16:15:00.000Z",
    "created_at": "2025-07-03T00:04:00.000Z",
    "statistics": {
      "total_lottery_count": 25,
      "total_exchange_count": 8,
      "total_upload_count": 12,
      "total_points_earned": 12500,
      "total_points_spent": 11500
    }
  }
}
```

#### 2.5.2 更新用户信息接口
```http
PUT /api/user/info
Content-Type: application/json
Authorization: Bearer <access_token>
```

**请求参数**：
```json
{
  "nickname": "新昵称",     // 可选：用户昵称
  "avatar": "头像URL"      // 可选：头像地址
}
```

#### 2.5.3 头像上传接口
```http
POST /api/user/avatar
Content-Type: multipart/form-data
Authorization: Bearer <access_token>
```

**请求参数**：
```javascript
// FormData格式
const formData = new FormData();
formData.append('avatar', imageFile);  // 必需：头像文件
```

**响应格式**：
```json
{
  "code": 0,
  "msg": "头像上传成功",
  "data": {
    "avatarUrl": "https://sealos.storage/avatars/user11_20250703.jpg"
  }
}
```

#### 2.5.4 积分记录接口
```http
GET /api/user/points-records?page=1&pageSize=20&type=all
Authorization: Bearer <access_token>
```

**查询参数**：
- `page`: 页码（默认1）
- `pageSize`: 每页数量（默认20）
- `type`: 类型筛选（all:全部, earn:收入, consume:支出）

**响应格式**：
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "records": [
      {
        "id": 1,
        "points": 100,
        "description": "抽奖消费 - 九八折券",
        "type": "spend",
        "source": "lottery",
        "balance_after": 900,
        "created_at": "2025-07-03T14:30:00.000Z"
      },
      {
        "id": 2,
        "points": 585,
        "description": "拍照审核通过",
        "type": "earn",
        "source": "photo_review",
        "balance_after": 1485,
        "created_at": "2025-07-03T13:30:00.000Z"
      }
    ],
    "total": 150,
    "page": 1,
    "pageSize": 20,
    "summary": {
      "total_earned": 7250,
      "total_spent": 2500,
      "current_balance": 4750
    }
  }
}
```

### 2.6 🏪 商家管理接口 (routes/merchant.js)

#### 2.6.1 待审核列表接口
```http
GET /api/merchant/reviews/pending?page=1&limit=20
Authorization: Bearer <access_token>
```

**响应格式**：
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "reviews": [
      {
        "id": 1,
        "user_id": 11,
        "user_nickname": "用户2136",
        "image_url": "https://sealos.storage/uploads/photo_123456.jpg",
        "amount": 58.50,
        "expected_points": 585,
        "description": "晚餐消费",
        "upload_time": "2025-07-03T14:30:00.000Z",
        "waiting_time": "2小时30分钟"
      }
    ],
    "pagination": {
      "total": 25,
      "page": 1,
      "limit": 20,
      "total_pages": 2
    },
    "statistics": {
      "pending_count": 25,
      "today_reviewed": 15,
      "average_review_time": "1.5小时"
    }
  }
}
```

#### 2.6.2 审核通过接口
```http
POST /api/merchant/reviews/:id/approve
Content-Type: application/json
Authorization: Bearer <access_token>
```

**请求参数**：
```json
{
  "actual_amount": 58.50,      // 必需：实际消费金额
  "points_awarded": 585,       // 必需：奖励积分
  "review_reason": "审核通过"  // 可选：审核理由
}
```

**响应格式**：
```json
{
  "code": 0,
  "msg": "审核通过",
  "data": {
    "review_id": 1,
    "points_awarded": 585,
    "user_new_balance": 1585,
    "review_time": "2025-07-03T16:30:00.000Z"
  }
}
```

#### 2.6.3 审核拒绝接口
```http
POST /api/merchant/reviews/:id/reject
Content-Type: application/json
Authorization: Bearer <access_token>
```

**请求参数**：
```json
{
  "reject_reason": "小票不清晰，无法确认消费金额"  // 必需：拒绝理由
}
```

#### 2.6.4 批量审核接口
```http
POST /api/merchant/reviews/batch
Content-Type: application/json
Authorization: Bearer <access_token>
```

**请求参数**：
```json
{
  "reviews": [
    {
      "id": 1,
      "action": "approve",
      "actual_amount": 58.50,
      "points_awarded": 585,
      "review_reason": "审核通过"
    },
    {
      "id": 2,
      "action": "reject",
      "reject_reason": "小票模糊"
    }
  ]
}
```

---

## 🔄 三、WebSocket实时通信规范

### 3.1 连接建立
```javascript
// WebSocket连接
const ws = new WebSocket('ws://localhost:3000/ws');

// 连接时需要JWT认证
ws.onopen = function() {
  ws.send(JSON.stringify({
    type: 'authenticate',
    token: 'Bearer ' + accessToken
  }));
};
```

### 3.2 实时事件类型

#### 3.2.1 积分变动推送
```json
{
  "type": "points_update",
  "data": {
    "user_id": 11,
    "points_change": 585,
    "new_balance": 1585,
    "reason": "拍照审核通过",
    "timestamp": "2025-07-03T16:30:00.000Z"
  }
}
```

#### 3.2.2 库存变动推送
```json
{
  "type": "stock_update",
  "data": {
    "product_id": 1,
    "product_name": "美食券50元",
    "new_stock": 99,
    "stock_change": -1,
    "timestamp": "2025-07-03T16:30:00.000Z"
  }
}
```

#### 3.2.3 审核结果推送
```json
{
  "type": "review_result",
  "data": {
    "review_id": 1,
    "status": "approved",
    "points_awarded": 585,
    "review_reason": "审核通过",
    "timestamp": "2025-07-03T16:30:00.000Z"
  }
}
```

#### 3.2.4 心跳保活
```json
{
  "type": "heartbeat",
  "timestamp": "2025-07-03T16:30:00.000Z"
}
```

---

## 📋 四、错误代码规范

### 4.1 通用错误代码
- `0`: 成功
- `1001-1999`: 参数错误
- `2001-2999`: 认证错误
- `3001-3999`: 业务逻辑错误
- `4001-4999`: 资源错误
- `5001-5999`: 系统错误

### 4.2 具体错误代码
```javascript
const ERROR_CODES = {
  // 认证相关
  2001: '用户未登录',
  2002: 'Token已过期',
  2003: '用户权限不足',
  2004: '验证码错误',
  
  // 业务逻辑相关
  3001: '积分余额不足',
  3002: '商品库存不足',
  3003: '今日抽奖次数已达上限',
  3004: '上传文件格式不支持',
  
  // 资源相关
  4001: '用户不存在',
  4002: '商品不存在',
  4003: '订单不存在',
  4004: '审核记录不存在',
  
  // 系统相关
  5001: '服务器内部错误',
  5002: '数据库连接失败',
  5003: '第三方服务异常'
};
```

---

**更新完成时间**：2025年07月03日 16:30  
**基于实际代码版本**：完全基于routes/目录下6个路由文件的真实实现