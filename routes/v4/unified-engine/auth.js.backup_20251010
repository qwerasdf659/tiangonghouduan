/**
 * V4ç»Ÿä¸€è®¤è¯è·¯ç”± - åŸºäºUUIDè§’è‰²ç³»ç»Ÿ
 * ğŸ›¡ï¸ æƒé™ç®¡ç†ï¼šç§»é™¤is_adminä¾èµ–ï¼Œä½¿ç”¨UUIDè§’è‰²ç³»ç»Ÿ
 * åˆ›å»ºæ—¶é—´ï¼š2025å¹´01æœˆ21æ—¥
 * æ›´æ–°æ—¶é—´ï¼š2025å¹´01æœˆ28æ—¥
 */

const express = require('express')
const router = express.Router()
const { User } = require('../../../models')
const { generateTokens, getUserRoles } = require('../../../middleware/auth')
const ApiResponse = require('../../../utils/ApiResponse')
const BeijingTimeHelper = require('../../../utils/timeHelper')

/**
 * ğŸ›¡ï¸ ç”¨æˆ·ç™»å½•ï¼ˆæ”¯æŒè‡ªåŠ¨æ³¨å†Œï¼‰
 * POST /api/v4/auth/login
 *
 * ä¸šåŠ¡é€»è¾‘ï¼š
 * 1. éªŒè¯éªŒè¯ç ï¼ˆå¼€å‘ç¯å¢ƒï¼š123456ï¼Œç”Ÿäº§ç¯å¢ƒï¼šçœŸå®éªŒè¯ç ï¼‰
 * 2. å¦‚æœç”¨æˆ·å­˜åœ¨ â†’ æ­£å¸¸ç™»å½•
 * 3. å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ â†’ è‡ªåŠ¨æ³¨å†Œå¹¶åˆ†é…æ™®é€šç”¨æˆ·ï¼ˆuserï¼‰è§’è‰²
 *
 * @param {string} mobile - æ‰‹æœºå·
 * @param {string} verification_code - éªŒè¯ç 
 */
router.post('/login', async (req, res) => {
  try {
    const { mobile, verification_code } = req.body

    // éªŒè¯å¿…éœ€å‚æ•°
    if (!mobile) {
      return res.apiError('æ‰‹æœºå·ä¸èƒ½ä¸ºç©º', 'MOBILE_REQUIRED', null, 400)
    }

    // âœ… éªŒè¯ç å¿…å¡«éªŒè¯
    if (!verification_code || verification_code.trim() === '') {
      return res.apiError('éªŒè¯ç ä¸èƒ½ä¸ºç©º', 'VERIFICATION_CODE_REQUIRED', null, 400)
    }

    // âœ… éªŒè¯ç éªŒè¯é€»è¾‘
    if (process.env.NODE_ENV === 'development') {
      // å¼€å‘ç¯å¢ƒï¼šä½¿ç”¨ä¸‡èƒ½éªŒè¯ç  123456
      if (verification_code !== '123456') {
        return res.apiError(
          'éªŒè¯ç é”™è¯¯ï¼ˆå¼€å‘ç¯å¢ƒä½¿ç”¨123456ï¼‰',
          'INVALID_VERIFICATION_CODE',
          null,
          400
        )
      }
    } else {
      // ç”Ÿäº§ç¯å¢ƒï¼šçœŸå®éªŒè¯ç éªŒè¯é€»è¾‘
      // TODO: å®ç°çŸ­ä¿¡éªŒè¯ç éªŒè¯
      return res.apiError('ç”Ÿäº§ç¯å¢ƒéªŒè¯ç éªŒè¯æœªå®ç°', 'VERIFICATION_NOT_IMPLEMENTED', null, 501)
    }

    // æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
    let user = await User.findOne({ where: { mobile } })
    let isNewUser = false

    if (!user) {
      // ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨æ³¨å†Œ
      console.log(`ç”¨æˆ· ${mobile} ä¸å­˜åœ¨ï¼Œå¼€å§‹è‡ªåŠ¨æ³¨å†Œ...`)

      // âœ… ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®å®Œæ•´æ€§ï¼ˆè§£å†³é—®é¢˜1ï¼šç§¯åˆ†è´¦æˆ·åˆ›å»ºç­–ç•¥ï¼‰
      const sequelize = require('../../../config/database')
      const transaction = await sequelize.transaction()

      try {
        // 1. åˆ›å»ºç”¨æˆ·
        user = await User.create({
          mobile,
          nickname: `ç”¨æˆ·${mobile.slice(-4)}`,
          status: 'active',
          consecutive_fail_count: 0,
          history_total_points: 0,
          login_count: 0
        }, { transaction })

        console.log(`ç”¨æˆ· ${mobile} æ³¨å†ŒæˆåŠŸï¼Œuser_id: ${user.user_id}`)

        // âœ… 2. ç«‹å³åˆ›å»ºç§¯åˆ†è´¦æˆ·ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
        const UserPointsAccount = require('../../../models').UserPointsAccount
        await UserPointsAccount.create({
          user_id: user.user_id,
          available_points: 0, // åˆå§‹ç§¯åˆ†ä¸º0
          total_earned: 0,
          total_consumed: 0,
          is_active: true
        }, { transaction })

        console.log(`ç”¨æˆ· ${mobile} ç§¯åˆ†è´¦æˆ·åˆ›å»ºæˆåŠŸ`)

        // 3. ä¸ºæ–°ç”¨æˆ·åˆ†é…æ™®é€šç”¨æˆ·è§’è‰²
        const Role = require('../../../models').Role
        const UserRole = require('../../../models').UserRole

        const userRole = await Role.findOne({ where: { role_name: 'user' } })

        if (userRole) {
          // æ£€æŸ¥è§’è‰²æ˜¯å¦å·²åˆ†é…ï¼ˆé¿å…é‡å¤åˆ†é…ï¼‰
          const existingUserRole = await UserRole.findOne({
            where: {
              user_id: user.user_id,
              role_id: userRole.role_id
            }
          })

          if (!existingUserRole) {
            await UserRole.create({
              user_id: user.user_id,
              role_id: userRole.role_id,
              is_active: true
            }, { transaction })
            console.log(`ç”¨æˆ· ${mobile} å·²åˆ†é…æ™®é€šç”¨æˆ·è§’è‰²`)
          } else {
            console.log(`ç”¨æˆ· ${mobile} å·²æœ‰æ™®é€šç”¨æˆ·è§’è‰²ï¼Œè·³è¿‡åˆ†é…`)
          }
        } else {
          console.warn('è­¦å‘Šï¼šæ™®é€šç”¨æˆ·è§’è‰²ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ†é…è§’è‰²')
        }

        await transaction.commit()
        console.log(`ç”¨æˆ· ${mobile} æ³¨å†Œæµç¨‹å®Œæˆï¼ˆç”¨æˆ·+ç§¯åˆ†è´¦æˆ·+è§’è‰²ï¼‰`)
      } catch (error) {
        await transaction.rollback()
        console.error(`ç”¨æˆ· ${mobile} æ³¨å†Œå¤±è´¥:`, error)
        return res.apiError('ç”¨æˆ·æ³¨å†Œå¤±è´¥', 'REGISTRATION_FAILED', { error: error.message }, 500)
      }

      isNewUser = true
    }

    // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
    if (user.status !== 'active') {
      return res.apiError('ç”¨æˆ·è´¦æˆ·å·²è¢«ç¦ç”¨', 'USER_INACTIVE', null, 403)
    }

    // ğŸ›¡ï¸ è·å–ç”¨æˆ·è§’è‰²ä¿¡æ¯
    const userRoles = await getUserRoles(user.user_id)

    // æ›´æ–°æœ€åç™»å½•æ—¶é—´å’Œç™»å½•æ¬¡æ•°
    await user.update({
      last_login: BeijingTimeHelper.createBeijingTime(),
      login_count: (user.login_count || 0) + 1
    })

    // ç”ŸæˆToken
    const tokens = await generateTokens(user)

    const responseData = {
      access_token: tokens.access_token,
      refresh_token: tokens.refresh_token,
      user: {
        user_id: user.user_id,
        mobile: user.mobile,
        nickname: user.nickname,
        role_based_admin: userRoles.isAdmin, // ğŸ›¡ï¸ åŸºäºè§’è‰²è®¡ç®—
        roles: userRoles.roles,
        status: user.status,
        last_login: user.last_login,
        login_count: user.login_count
      },
      is_new_user: isNewUser, // æ ‡è¯†æ˜¯å¦ä¸ºæ–°æ³¨å†Œç”¨æˆ·
      expires_in: 7 * 24 * 60 * 60, // 7å¤©
      timestamp: BeijingTimeHelper.apiTimestamp()
    }

    const message = isNewUser ? 'æ³¨å†Œå¹¶ç™»å½•æˆåŠŸ' : 'ç™»å½•æˆåŠŸ'
    const response = ApiResponse.success(responseData, message)
    return ApiResponse.send(res, response)
  } catch (error) {
    console.error('ç™»å½•å¤±è´¥:', error)
    return res.apiError('ç™»å½•å¤±è´¥', 'LOGIN_FAILED', error.message, 500)
  }
})

/**
 * ğŸ›¡ï¸ ç”¨æˆ·å¿«é€Ÿç™»å½•ï¼ˆæ‰‹æœºå·ç›´æ¥ç™»å½•ï¼‰
 * POST /api/v4/auth/quick-login
 */
router.post('/quick-login', async (req, res) => {
  try {
    const { mobile } = req.body

    if (!mobile) {
      return res.apiError('æ‰‹æœºå·ä¸èƒ½ä¸ºç©º', 'MOBILE_REQUIRED', null, 400)
    }

    // æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
    let user = await User.findOne({ where: { mobile } })

    if (!user) {
      // åˆ›å»ºæ–°ç”¨æˆ·ï¼ˆæ™®é€šç”¨æˆ·æƒé™ï¼‰
      user = await User.create({
        mobile,
        nickname: `ç”¨æˆ·${mobile.slice(-4)}`,
        status: 'active'
      })

      // ä¸ºæ–°ç”¨æˆ·åˆ†é…æ™®é€šç”¨æˆ·è§’è‰²
      const userRole = await require('../../../models').Role.findOne({
        where: { role_name: 'user' }
      })
      if (userRole) {
        await require('../../../models').UserRole.create({
          user_id: user.user_id,
          role_id: userRole.id,
          is_active: true
        })
      }
    }

    if (user.status !== 'active') {
      return res.apiError('ç”¨æˆ·è´¦æˆ·å·²è¢«ç¦ç”¨', 'USER_INACTIVE', null, 403)
    }

    // ğŸ›¡ï¸ è·å–ç”¨æˆ·è§’è‰²ä¿¡æ¯
    const userRoles = await getUserRoles(user.user_id)

    // æ›´æ–°æœ€åç™»å½•æ—¶é—´
    await user.update({
      last_login: BeijingTimeHelper.createBeijingTime(),
      login_count: (user.login_count || 0) + 1
    })

    // ç”ŸæˆToken
    const tokens = await generateTokens(user)

    const responseData = {
      access_token: tokens.access_token,
      refresh_token: tokens.refresh_token,
      user: {
        user_id: user.user_id,
        mobile: user.mobile,
        nickname: user.nickname,
        role_based_admin: userRoles.isAdmin, // ğŸ›¡ï¸ åŸºäºè§’è‰²è®¡ç®—
        roles: userRoles.roles,
        status: user.status,
        created_at: user.created_at,
        last_login: user.last_login
      },
      expires_in: 7 * 24 * 60 * 60, // 7å¤©
      timestamp: BeijingTimeHelper.apiTimestamp()
    }

    const response = ApiResponse.success(responseData, 'å¿«é€Ÿç™»å½•æˆåŠŸ')
    return ApiResponse.send(res, response)
  } catch (error) {
    console.error('å¿«é€Ÿç™»å½•å¤±è´¥:', error)
    return res.apiError('å¿«é€Ÿç™»å½•å¤±è´¥', 'QUICK_LOGIN_FAILED', error.message, 500)
  }
})

/**
 * ğŸ›¡ï¸ è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
 * GET /api/v4/auth/profile
 */
router.get('/profile', require('../../../middleware/auth').authenticateToken, async (req, res) => {
  try {
    const user_id = req.user.user_id

    // é‡æ–°æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ç¡®ä¿æ•°æ®æœ€æ–°
    const user = await User.findByPk(user_id)
    if (!user) {
      return res.apiError('ç”¨æˆ·ä¸å­˜åœ¨', 'USER_NOT_FOUND', null, 404)
    }

    // ğŸ›¡ï¸ è·å–ç”¨æˆ·è§’è‰²ä¿¡æ¯
    const userRoles = await getUserRoles(user_id)

    const responseData = {
      user: {
        user_id: user.user_id,
        mobile: user.mobile,
        nickname: user.nickname,
        role_based_admin: userRoles.isAdmin, // ğŸ›¡ï¸ åŸºäºè§’è‰²è®¡ç®—
        roles: userRoles.roles,
        status: user.status,
        consecutive_fail_count: user.consecutive_fail_count,
        history_total_points: user.history_total_points,
        created_at: user.created_at,
        last_login: user.last_login,
        login_count: user.login_count
      },
      timestamp: BeijingTimeHelper.apiTimestamp()
    }

    const response = ApiResponse.success(responseData, 'ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ')
    return ApiResponse.send(res, response)
  } catch (error) {
    console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error)
    return res.apiError('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', 'GET_PROFILE_FAILED', error.message, 500)
  }
})

/**
 * ğŸ›¡ï¸ éªŒè¯Tokenæœ‰æ•ˆæ€§
 * POST /api/v4/auth/verify
 */
router.post('/verify', require('../../../middleware/auth').authenticateToken, async (req, res) => {
  try {
    const user_id = req.user.user_id

    // ğŸ›¡ï¸ è·å–ç”¨æˆ·è§’è‰²ä¿¡æ¯
    const userRoles = await getUserRoles(user_id)

    const responseData = {
      valid: true,
      user: {
        user_id,
        mobile: req.user.mobile,
        role_based_admin: userRoles.isAdmin, // ğŸ›¡ï¸ åŸºäºè§’è‰²è®¡ç®—
        roles: userRoles.roles
      },
      timestamp: BeijingTimeHelper.apiTimestamp()
    }

    const response = ApiResponse.success(responseData, 'TokenéªŒè¯æˆåŠŸ')
    return ApiResponse.send(res, response)
  } catch (error) {
    console.error('TokenéªŒè¯å¤±è´¥:', error)
    return res.apiError('TokenéªŒè¯å¤±è´¥', 'TOKEN_VERIFY_FAILED', error.message, 500)
  }
})

/**
 * ğŸ›¡ï¸ åˆ·æ–°è®¿é—®Token
 * POST /api/v4/auth/refresh
 *
 * @body {string} refresh_token - åˆ·æ–°Token
 * @returns {Object} æ–°çš„è®¿é—®Tokenå’Œåˆ·æ–°Token
 */
router.post('/refresh', async (req, res) => {
  try {
    const { refresh_token } = req.body

    // éªŒè¯å¿…éœ€å‚æ•°
    if (!refresh_token) {
      return res.apiError('åˆ·æ–°Tokenä¸èƒ½ä¸ºç©º', 'REFRESH_TOKEN_REQUIRED', null, 400)
    }

    // éªŒè¯åˆ·æ–°Token
    const { verifyRefreshToken } = require('../../../middleware/auth')
    const verifyResult = await verifyRefreshToken(refresh_token)

    if (!verifyResult.valid) {
      return res.apiError('åˆ·æ–°Tokenæ— æ•ˆ', 'INVALID_REFRESH_TOKEN', null, 401)
    }

    // è·å–ç”¨æˆ·ä¿¡æ¯å¹¶é‡æ–°ç”ŸæˆToken
    const user = await User.findByPk(verifyResult.user.user_id)
    if (!user) {
      return res.apiError('ç”¨æˆ·ä¸å­˜åœ¨', 'USER_NOT_FOUND', null, 404)
    }

    if (user.status !== 'active') {
      return res.apiError('ç”¨æˆ·è´¦æˆ·å·²è¢«ç¦ç”¨', 'USER_INACTIVE', null, 403)
    }

    // ç”Ÿæˆæ–°çš„Tokenå¯¹
    const tokens = await generateTokens(user)

    // ğŸ›¡ï¸ è·å–ç”¨æˆ·è§’è‰²ä¿¡æ¯
    const userRoles = await getUserRoles(user.user_id)

    const responseData = {
      access_token: tokens.access_token,
      refresh_token: tokens.refresh_token,
      user: {
        user_id: user.user_id,
        mobile: user.mobile,
        role_based_admin: userRoles.isAdmin, // ğŸ›¡ï¸ åŸºäºè§’è‰²è®¡ç®—
        roles: userRoles.roles,
        status: user.status
      },
      expires_in: 7 * 24 * 60 * 60, // 7å¤©
      timestamp: BeijingTimeHelper.apiTimestamp()
    }

    const response = ApiResponse.success(responseData, 'Tokenåˆ·æ–°æˆåŠŸ')
    return ApiResponse.send(res, response)
  } catch (error) {
    console.error('Tokenåˆ·æ–°å¤±è´¥:', error)
    // åŒºåˆ†ä¸åŒçš„é”™è¯¯ç±»å‹
    if (error.name === 'JsonWebTokenError') {
      return res.apiError('åˆ·æ–°Tokenæ ¼å¼é”™è¯¯', 'INVALID_REFRESH_TOKEN_FORMAT', error.message, 401)
    }
    if (error.name === 'TokenExpiredError') {
      return res.apiError('åˆ·æ–°Tokenå·²è¿‡æœŸ', 'REFRESH_TOKEN_EXPIRED', error.message, 401)
    }
    return res.apiError('Tokenåˆ·æ–°å¤±è´¥', 'REFRESH_TOKEN_FAILED', error.message, 500)
  }
})

module.exports = router
