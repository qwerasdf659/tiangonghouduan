<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç³»ç»Ÿè®¾ç½® - ç®¡ç†åå°</title>
  
  <!-- âœ… Bootstrap 5 - UIæ¡†æ¶ -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- âœ… Bootstrap Icons - å›¾æ ‡åº“ -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- âœ… å…¬å…±æ ·å¼è¡¨ - ç»Ÿä¸€ä¸»é¢˜å’Œå“åº”å¼è®¾è®¡ -->
  <link href="/admin/css/common.css" rel="stylesheet">
  
  <!-- âœ… é¡µé¢ç‰¹æœ‰æ ·å¼ -->
  <style>
    .settings-nav {
      position: sticky;
      top: 20px;
    }
    .settings-section {
      scroll-margin-top: 80px;
    }
  </style>
</head>
<body class="bg-light">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>âš™ï¸ ç®¡ç†åå° - ç³»ç»Ÿè®¾ç½®
      </a>
      <div>
        <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>
  
  <div class="container-fluid mt-4">
    <!-- âœ… åŠŸèƒ½çŠ¶æ€æç¤ºæ¨ªå¹… -->
    <div class="alert alert-success alert-dismissible fade show mb-3" role="alert">
      <h6 class="alert-heading">
        <i class="bi bi-check-circle-fill"></i> ç³»ç»Ÿè®¾ç½®åŠŸèƒ½å·²å®Œæ•´å®ç°
      </h6>
      <hr>
      <p class="mb-2"><strong>âœ… å·²å®ç°çš„åŠŸèƒ½ï¼š</strong></p>
      <ul class="mb-0">
        <li>åŸºç¡€è®¾ç½®ä¿å­˜ï¼ˆâœ“ /api/v4/admin/settings/basicï¼‰</li>
        <li>ç§¯åˆ†è®¾ç½®ä¿å­˜ï¼ˆâœ“ /api/v4/admin/settings/pointsï¼‰</li>
        <li>é€šçŸ¥è®¾ç½®ä¿å­˜ï¼ˆâœ“ /api/v4/admin/settings/notificationï¼‰</li>
        <li>å®‰å…¨è®¾ç½®ä¿å­˜ï¼ˆâœ“ /api/v4/admin/settings/securityï¼‰</li>
        <li>ç¼“å­˜æ¸…é™¤åŠŸèƒ½ï¼ˆâœ“ /api/v4/admin/cache/clearï¼‰</li>
      </ul>
      <hr>
      <p class="mb-0 text-muted small">
        <i class="bi bi-info-circle"></i> 
        æ³¨ï¼šæŠ½å¥–ç®—æ³•é…ç½®ï¼ˆä¸­å¥–ç‡ã€ä¿åº•è§„åˆ™ç­‰ï¼‰åœ¨config/business.config.jsä¸­ç®¡ç†ï¼Œéœ€è¦æŠ€æœ¯å›¢é˜Ÿä¿®æ”¹ä»£ç ã€‚
      </p>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    
    <div class="row">
      <!-- ä¾§è¾¹å¯¼èˆª -->
      <div class="col-md-3">
        <div class="card settings-nav">
          <div class="card-header bg-white">
            <h6 class="mb-0">è®¾ç½®å¯¼èˆª</h6>
          </div>
          <div class="list-group list-group-flush">
            <a href="#basic-settings" class="list-group-item list-group-item-action">
              <i class="bi bi-gear"></i> åŸºç¡€è®¾ç½®
            </a>
            <a href="#lottery-settings" class="list-group-item list-group-item-action">
              <i class="bi bi-gift"></i> æŠ½å¥–è®¾ç½®
            </a>
            <a href="#points-settings" class="list-group-item list-group-item-action">
              <i class="bi bi-star"></i> ç§¯åˆ†è®¾ç½®
            </a>
            <a href="#notification-settings" class="list-group-item list-group-item-action">
              <i class="bi bi-bell"></i> é€šçŸ¥è®¾ç½®
            </a>
            <a href="#security-settings" class="list-group-item list-group-item-action">
              <i class="bi bi-shield-lock"></i> å®‰å…¨è®¾ç½®
            </a>
            <a href="#cache-settings" class="list-group-item list-group-item-action">
              <i class="bi bi-database"></i> ç¼“å­˜ç®¡ç†
            </a>
          </div>
        </div>
      </div>
      
      <!-- ä¸»è¦å†…å®¹åŒº -->
      <div class="col-md-9">
        <!-- åŸºç¡€è®¾ç½® -->
        <div id="basic-settings" class="card mb-3 settings-section">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-gear"></i> åŸºç¡€è®¾ç½®</h5>
          </div>
          <div class="card-body">
            <form id="basicSettingsForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">ç³»ç»Ÿåç§°</label>
                  <input type="text" class="form-control" id="systemName" value="é¤å…æŠ½å¥–ç³»ç»Ÿ">
                </div>
                <div class="col-md-6">
                  <label class="form-label">ç³»ç»Ÿç‰ˆæœ¬</label>
                  <input type="text" class="form-control" id="systemVersion" value="v1.0.0" readonly>
                </div>
                <div class="col-md-6">
                  <label class="form-label">å®¢æœç”µè¯</label>
                  <input type="tel" class="form-control" id="customerServicePhone" placeholder="400-xxx-xxxx">
                </div>
                <div class="col-md-6">
                  <label class="form-label">å®¢æœé‚®ç®±</label>
                  <input type="email" class="form-control" id="customerServiceEmail" placeholder="support@example.com">
                </div>
                <div class="col-12">
                  <label class="form-label">ç³»ç»Ÿå…¬å‘Š</label>
                  <textarea class="form-control" id="systemAnnouncement" rows="3" placeholder="ç³»ç»Ÿå…¬å‘Šå†…å®¹..."></textarea>
                </div>
                <div class="col-12">
                  <label class="form-label">ç»´æŠ¤æ¨¡å¼</label>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="maintenanceMode">
                    <label class="form-check-label" for="maintenanceMode">
                      å¯ç”¨ç»´æŠ¤æ¨¡å¼ï¼ˆå¯ç”¨åæ™®é€šç”¨æˆ·æ— æ³•è®¿é—®ç³»ç»Ÿï¼‰
                    </label>
                  </div>
                </div>
                <div class="col-12">
                  <button type="button" class="btn btn-primary" id="saveBasicSettingsBtn">
                    <i class="bi bi-check-lg"></i> ä¿å­˜è®¾ç½®
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
        
        <!-- æŠ½å¥–è®¾ç½® -->
        <div id="lottery-settings" class="card mb-3 settings-section">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-gift"></i> æŠ½å¥–è®¾ç½®</h5>
          </div>
          <div class="card-body">
            <form id="lotterySettingsForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">æ¯æ—¥æŠ½å¥–æ¬¡æ•°é™åˆ¶</label>
                  <input type="number" class="form-control" id="dailyDrawLimit" min="1" value="10">
                </div>
                <div class="col-md-6">
                  <label class="form-label">æ¯æ¬¡æ¶ˆè´¹æ‰€éœ€ç§¯åˆ†</label>
                  <input type="number" class="form-control" id="drawCostPoints" min="0" value="100">
                </div>
                <div class="col-md-6">
                  <label class="form-label">æœ€ä½æ¶ˆè´¹é‡‘é¢(å…ƒ)</label>
                  <input type="number" class="form-control" id="minConsumptionAmount" min="0" step="0.01" value="50.00">
                </div>
                <div class="col-md-6">
                  <label class="form-label">ç§¯åˆ†å…‘æ¢æ¯”ä¾‹(å…ƒ:ç§¯åˆ†)</label>
                  <input type="text" class="form-control" id="pointsConversionRate" value="1:10">
                </div>
                <div class="col-12">
                  <label class="form-label">ä¿åº•ä¸­å¥–æœºåˆ¶</label>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="guaranteedWinEnabled">
                    <label class="form-check-label" for="guaranteedWinEnabled">
                      å¯ç”¨ä¿åº•ä¸­å¥–ï¼ˆè¿ç»­Næ¬¡æœªä¸­å¥–åå¿…ä¸­ï¼‰
                    </label>
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">ä¿åº•æŠ½å¥–æ¬¡æ•°</label>
                  <input type="number" class="form-control" id="guaranteedWinCount" min="1" value="20">
                </div>
                <div class="col-12">
                  <button type="button" class="btn btn-primary" id="saveLotterySettingsBtn">
                    <i class="bi bi-check-lg"></i> ä¿å­˜è®¾ç½®
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
        
        <!-- ç§¯åˆ†è®¾ç½® -->
        <div id="points-settings" class="card mb-3 settings-section">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-star"></i> ç§¯åˆ†è®¾ç½®</h5>
          </div>
          <div class="card-body">
            <form id="pointsSettingsForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">æ³¨å†Œèµ é€ç§¯åˆ†</label>
                  <input type="number" class="form-control" id="registerBonusPoints" min="0" value="100">
                </div>
                <div class="col-md-6">
                  <label class="form-label">æ¯æ—¥ç­¾åˆ°ç§¯åˆ†</label>
                  <input type="number" class="form-control" id="dailyCheckInPoints" min="0" value="10">
                </div>
                <div class="col-md-6">
                  <label class="form-label">æ¨èå¥½å‹ç§¯åˆ†</label>
                  <input type="number" class="form-control" id="referralBonusPoints" min="0" value="50">
                </div>
                <div class="col-md-6">
                  <label class="form-label">ç§¯åˆ†æœ‰æ•ˆæœŸ(å¤©)</label>
                  <input type="number" class="form-control" id="pointsExpireDays" min="0" value="365" placeholder="0è¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆ">
                </div>
                <div class="col-12">
                  <label class="form-label">ç§¯åˆ†æ¸…é›¶è§„åˆ™</label>
                  <select class="form-select" id="pointsClearRule">
                    <option value="never">æ°¸ä¸æ¸…é›¶</option>
                    <option value="yearly">æ¯å¹´æ¸…é›¶ä¸€æ¬¡</option>
                    <option value="inactive">180å¤©æœªæ´»è·ƒæ¸…é›¶</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">é¢„ç®—åˆ†é…ç³»æ•°</label>
                  <input 
                    type="number" 
                    class="form-control" 
                    id="budget_allocation_ratio"
                    step="0.01" 
                    min="0" 
                    max="1"
                    placeholder="0.24"
                  >
                  <small class="text-muted">
                    å…¬å¼ï¼šé¢„ç®—ç§¯åˆ† = æ¶ˆè´¹é‡‘é¢ Ã— è¯¥ç³»æ•°ï¼ˆå¦‚1000å…ƒÃ—0.24=240é¢„ç®—ç§¯åˆ†ï¼‰
                  </small>
                </div>
                <div class="col-12">
                  <button type="button" class="btn btn-primary" id="savePointsSettingsBtn">
                    <i class="bi bi-check-lg"></i> ä¿å­˜è®¾ç½®
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
        
        <!-- é€šçŸ¥è®¾ç½® -->
        <div id="notification-settings" class="card mb-3 settings-section">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-bell"></i> é€šçŸ¥è®¾ç½®</h5>
          </div>
          <div class="card-body">
            <form id="notificationSettingsForm">
              <div class="row g-3">
                <div class="col-12">
                  <h6>é‚®ä»¶é€šçŸ¥</h6>
                </div>
                <div class="col-md-6">
                  <label class="form-label">SMTPæœåŠ¡å™¨</label>
                  <input type="text" class="form-control" id="smtpHost" placeholder="smtp.example.com">
                </div>
                <div class="col-md-6">
                  <label class="form-label">SMTPç«¯å£</label>
                  <input type="number" class="form-control" id="smtpPort" value="465">
                </div>
                <div class="col-md-6">
                  <label class="form-label">å‘ä»¶äººé‚®ç®±</label>
                  <input type="email" class="form-control" id="smtpEmail" placeholder="noreply@example.com">
                </div>
                <div class="col-md-6">
                  <label class="form-label">é‚®ç®±å¯†ç </label>
                  <input type="password" class="form-control" id="smtpPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <div class="col-12">
                  <hr>
                  <h6>çŸ­ä¿¡é€šçŸ¥</h6>
                </div>
                <div class="col-md-6">
                  <label class="form-label">çŸ­ä¿¡æœåŠ¡å•†</label>
                  <select class="form-select" id="smsProvider">
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="aliyun">é˜¿é‡Œäº‘</option>
                    <option value="tencent">è…¾è®¯äº‘</option>
                    <option value="huawei">åä¸ºäº‘</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">AccessKey ID</label>
                  <input type="text" class="form-control" id="smsAccessKey" placeholder="AccessKey ID">
                </div>
                <div class="col-md-6">
                  <label class="form-label">AccessKey Secret</label>
                  <input type="password" class="form-control" id="smsAccessSecret" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <div class="col-md-6">
                  <label class="form-label">çŸ­ä¿¡ç­¾å</label>
                  <input type="text" class="form-control" id="smsSignature" placeholder="ã€ç³»ç»Ÿåç§°ã€‘">
                </div>
                <div class="col-12">
                  <button type="button" class="btn btn-primary" id="saveNotificationSettingsBtn">
                    <i class="bi bi-check-lg"></i> ä¿å­˜è®¾ç½®
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
        
        <!-- å®‰å…¨è®¾ç½® -->
        <div id="security-settings" class="card mb-3 settings-section">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-shield-lock"></i> å®‰å…¨è®¾ç½®</h5>
          </div>
          <div class="card-body">
            <form id="securitySettingsForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">ç™»å½•å¤±è´¥é”å®šæ¬¡æ•°</label>
                  <input type="number" class="form-control" id="loginFailLimit" min="3" value="5">
                </div>
                <div class="col-md-6">
                  <label class="form-label">é”å®šæ—¶é•¿(åˆ†é’Ÿ)</label>
                  <input type="number" class="form-control" id="lockoutDuration" min="5" value="30">
                </div>
                <div class="col-md-6">
                  <label class="form-label">ä¼šè¯è¶…æ—¶æ—¶é—´(åˆ†é’Ÿ)</label>
                  <input type="number" class="form-control" id="sessionTimeout" min="10" value="120">
                </div>
                <div class="col-md-6">
                  <label class="form-label">JWT Tokenæœ‰æ•ˆæœŸ(å°æ—¶)</label>
                  <input type="number" class="form-control" id="jwtExpireHours" min="1" value="24">
                </div>
                <div class="col-12">
                  <label class="form-label">IPç™½åå•</label>
                  <textarea class="form-control" id="ipWhitelist" rows="3" placeholder="æ¯è¡Œä¸€ä¸ªIPåœ°å€ï¼Œç•™ç©ºè¡¨ç¤ºä¸é™åˆ¶"></textarea>
                  <small class="text-muted">ç¤ºä¾‹ï¼š192.168.1.1 æˆ– 192.168.1.0/24</small>
                </div>
                <div class="col-12">
                  <label class="form-label">å®‰å…¨é€‰é¡¹</label>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="enableTwoFactor">
                    <label class="form-check-label" for="enableTwoFactor">
                      å¯ç”¨åŒå› ç´ è®¤è¯
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="forceHttps">
                    <label class="form-check-label" for="forceHttps">
                      å¼ºåˆ¶ä½¿ç”¨HTTPS
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="enableAuditLog">
                    <label class="form-check-label" for="enableAuditLog">
                      å¯ç”¨æ“ä½œå®¡è®¡æ—¥å¿—
                    </label>
                  </div>
                </div>
                <div class="col-12">
                  <button type="button" class="btn btn-primary" id="saveSecuritySettingsBtn">
                    <i class="bi bi-check-lg"></i> ä¿å­˜è®¾ç½®
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
        
        <!-- ç¼“å­˜ç®¡ç† -->
        <div id="cache-settings" class="card mb-3 settings-section">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-database"></i> ç¼“å­˜ç®¡ç†</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-12">
                <div class="alert alert-info">
                  <i class="bi bi-info-circle"></i>
                  æ¸…é™¤ç¼“å­˜å¯èƒ½ä¼šæš‚æ—¶å½±å“ç³»ç»Ÿæ€§èƒ½ï¼Œå»ºè®®åœ¨ä½å³°æœŸæ“ä½œã€‚
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div class="card-body text-center">
                    <i class="bi bi-box text-primary" style="font-size: 3rem;"></i>
                    <h6 class="mt-2">ç”¨æˆ·ç¼“å­˜</h6>
                    <p class="text-muted small">æ¸…é™¤ç”¨æˆ·ä¿¡æ¯ã€æƒé™ç­‰ç¼“å­˜</p>
                    <button class="btn btn-outline-primary btn-sm clear-cache-btn" data-cache-type="user">
                      <i class="bi bi-trash"></i> æ¸…é™¤
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div class="card-body text-center">
                    <i class="bi bi-graph-up text-success" style="font-size: 3rem;"></i>
                    <h6 class="mt-2">ç»Ÿè®¡ç¼“å­˜</h6>
                    <p class="text-muted small">æ¸…é™¤ç»Ÿè®¡æ•°æ®ç¼“å­˜</p>
                    <button class="btn btn-outline-success btn-sm clear-cache-btn" data-cache-type="stats">
                      <i class="bi bi-trash"></i> æ¸…é™¤
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div class="card-body text-center">
                    <i class="bi bi-gear text-warning" style="font-size: 3rem;"></i>
                    <h6 class="mt-2">ç³»ç»Ÿé…ç½®ç¼“å­˜</h6>
                    <p class="text-muted small">æ¸…é™¤ç³»ç»Ÿé…ç½®ç¼“å­˜</p>
                    <button class="btn btn-outline-warning btn-sm clear-cache-btn" data-cache-type="config">
                      <i class="bi bi-trash"></i> æ¸…é™¤
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div class="card-body text-center">
                    <i class="bi bi-asterisk text-danger" style="font-size: 3rem;"></i>
                    <h6 class="mt-2">å…¨éƒ¨ç¼“å­˜</h6>
                    <p class="text-muted small">æ¸…é™¤æ‰€æœ‰ç¼“å­˜æ•°æ®</p>
                    <button class="btn btn-outline-danger btn-sm clear-cache-btn" data-cache-type="all">
                      <i class="bi bi-trash"></i> æ¸…é™¤
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- åŠ è½½é®ç½©å±‚ -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">å¤„ç†ä¸­...</span>
    </div>
  </div>

  <!-- âœ… Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- âœ… å¼•å…¥é€šç”¨å·¥å…·åº“ -->
  <script src="/admin/js/admin-common.js"></script>
  
  <script>
    /**
     * é¡µé¢åˆå§‹åŒ–
     */
    document.addEventListener('DOMContentLoaded', function() {
      // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
      const userInfo = getCurrentUser();
      if (userInfo && userInfo.nickname) {
        document.getElementById('welcomeText').textContent = `æ¬¢è¿ï¼Œ${userInfo.nickname}`;
      }
      
      // âœ… Tokenå’Œæƒé™éªŒè¯
      if (!getToken() || !checkAdminPermission()) {
        return;
      }
      
      // åŠ è½½æ‰€æœ‰è®¾ç½®
      loadAllSettings();
      
      // ===== é™æ€æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨ =====
      // é€€å‡ºç™»å½•æŒ‰é’®
      document.getElementById('logoutBtn').addEventListener('click', logout);
      
      // ä¿å­˜è®¾ç½®æŒ‰é’®
      document.getElementById('saveBasicSettingsBtn').addEventListener('click', saveBasicSettings);
      document.getElementById('saveLotterySettingsBtn').addEventListener('click', saveLotterySettings);
      document.getElementById('savePointsSettingsBtn').addEventListener('click', savePointsSettings);
      document.getElementById('saveNotificationSettingsBtn').addEventListener('click', saveNotificationSettings);
      document.getElementById('saveSecuritySettingsBtn').addEventListener('click', saveSecuritySettings);
      
      // ===== äº‹ä»¶å§”æ‰˜ï¼šç¼“å­˜æ¸…ç†æŒ‰é’® =====
      document.addEventListener('click', (e) => {
        const clearCacheBtn = e.target.closest('.clear-cache-btn');
        if (clearCacheBtn) {
          const cacheType = clearCacheBtn.dataset.cacheType;
          clearCache(cacheType);
        }
      });
      
      // å¹³æ»‘æ»šåŠ¨
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
          e.preventDefault();
          const target = document.querySelector(this.getAttribute('href'));
          if (target) {
            target.scrollIntoView({ behavior: 'smooth' });
          }
        });
      });
    });
    
    /**
     * åŠ è½½æ‰€æœ‰è®¾ç½®
     */
    async function loadAllSettings() {
      showLoading();
      
      try {
        // å¹¶è¡ŒåŠ è½½æ‰€æœ‰åˆ†ç±»çš„è®¾ç½®
        const [basicRes, pointsRes, notificationRes, securityRes] = await Promise.all([
          apiRequest('/api/v4/admin/settings/basic').catch(e => null),
          apiRequest('/api/v4/admin/settings/points').catch(e => null),
          apiRequest('/api/v4/admin/settings/notification').catch(e => null),
          apiRequest('/api/v4/admin/settings/security').catch(e => null)
        ]);
        
        // åŠ è½½åŸºç¡€è®¾ç½®
        if (basicRes && basicRes.success) {
          basicRes.data.settings.forEach(setting => {
            const { setting_key, parsed_value } = setting;
            if (setting_key === 'system_name') document.getElementById('systemName').value = parsed_value;
            if (setting_key === 'system_version') document.getElementById('systemVersion').value = parsed_value;
            if (setting_key === 'customer_phone') document.getElementById('customerServicePhone').value = parsed_value;
            if (setting_key === 'customer_email') document.getElementById('customerServiceEmail').value = parsed_value;
          });
        }
        
        // åŠ è½½ç§¯åˆ†è®¾ç½®
        if (pointsRes && pointsRes.success) {
          pointsRes.data.settings.forEach(setting => {
            const { setting_key, parsed_value } = setting;
            if (setting_key === 'sign_in_points') document.getElementById('dailyCheckInPoints').value = parsed_value;
            if (setting_key === 'initial_points') document.getElementById('registerBonusPoints').value = parsed_value;
            if (setting_key === 'points_expire_days') document.getElementById('pointsExpireDays').value = parsed_value;
            if (setting_key === 'budget_allocation_ratio') document.getElementById('budget_allocation_ratio').value = parsed_value;
          });
        }
        
        // åŠ è½½é€šçŸ¥è®¾ç½®
        if (notificationRes && notificationRes.success) {
          notificationRes.data.settings.forEach(setting => {
            const { setting_key, parsed_value } = setting;
            const smsCheckbox = document.getElementById('smsEnabled');
            const emailCheckbox = document.getElementById('emailEnabled');
            const appCheckbox = document.getElementById('appNotificationEnabled');
            
            if (setting_key === 'sms_enabled' && smsCheckbox) smsCheckbox.checked = parsed_value;
            if (setting_key === 'email_enabled' && emailCheckbox) emailCheckbox.checked = parsed_value;
            if (setting_key === 'app_notification_enabled' && appCheckbox) appCheckbox.checked = parsed_value;
          });
        }
        
        // åŠ è½½å®‰å…¨è®¾ç½®
        if (securityRes && securityRes.success) {
          securityRes.data.settings.forEach(setting => {
            const { setting_key, parsed_value } = setting;
            if (setting_key === 'max_login_attempts') document.getElementById('loginFailLimit').value = parsed_value;
            if (setting_key === 'lockout_duration') document.getElementById('lockoutDuration').value = parsed_value;
            const pwdLengthInput = document.getElementById('passwordMinLength');
            const rateLimitInput = document.getElementById('apiRateLimit');
            if (setting_key === 'password_min_length' && pwdLengthInput) pwdLengthInput.value = parsed_value;
            if (setting_key === 'api_rate_limit' && rateLimitInput) rateLimitInput.value = parsed_value;
          });
        }
        
        console.log('âœ… æ‰€æœ‰è®¾ç½®åŠ è½½å®Œæˆ');
      } catch (error) {
        console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
        showError('åŠ è½½å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * å¡«å……åŸºç¡€è®¾ç½®
     */
    function fillBasicSettings(data) {
      if (!data) return;
      if (data.system_name) document.getElementById('systemName').value = data.system_name;
      if (data.customer_service_phone) document.getElementById('customerServicePhone').value = data.customer_service_phone;
      if (data.customer_service_email) document.getElementById('customerServiceEmail').value = data.customer_service_email;
      if (data.system_announcement) document.getElementById('systemAnnouncement').value = data.system_announcement;
      if (data.maintenance_mode !== undefined) document.getElementById('maintenanceMode').checked = data.maintenance_mode;
    }
    
    /**
     * å¡«å……æŠ½å¥–è®¾ç½®
     */
    function fillLotterySettings(data) {
      if (!data) return;
      if (data.daily_draw_limit) document.getElementById('dailyDrawLimit').value = data.daily_draw_limit;
      if (data.draw_cost_points) document.getElementById('drawCostPoints').value = data.draw_cost_points;
      if (data.min_consumption_amount) document.getElementById('minConsumptionAmount').value = data.min_consumption_amount;
      if (data.points_conversion_rate) document.getElementById('pointsConversionRate').value = data.points_conversion_rate;
      if (data.guaranteed_win_enabled !== undefined) document.getElementById('guaranteedWinEnabled').checked = data.guaranteed_win_enabled;
      if (data.guaranteed_win_count) document.getElementById('guaranteedWinCount').value = data.guaranteed_win_count;
    }
    
    /**
     * å¡«å……ç§¯åˆ†è®¾ç½®
     */
    function fillPointsSettings(data) {
      if (!data) return;
      if (data.register_bonus_points) document.getElementById('registerBonusPoints').value = data.register_bonus_points;
      if (data.daily_check_in_points) document.getElementById('dailyCheckInPoints').value = data.daily_check_in_points;
      if (data.referral_bonus_points) document.getElementById('referralBonusPoints').value = data.referral_bonus_points;
      if (data.points_expire_days) document.getElementById('pointsExpireDays').value = data.points_expire_days;
      if (data.points_clear_rule) document.getElementById('pointsClearRule').value = data.points_clear_rule;
    }
    
    /**
     * å¡«å……é€šçŸ¥è®¾ç½®
     */
    function fillNotificationSettings(data) {
      if (!data) return;
      if (data.smtp_host) document.getElementById('smtpHost').value = data.smtp_host;
      if (data.smtp_port) document.getElementById('smtpPort').value = data.smtp_port;
      if (data.smtp_email) document.getElementById('smtpEmail').value = data.smtp_email;
      if (data.sms_provider) document.getElementById('smsProvider').value = data.sms_provider;
      if (data.sms_signature) document.getElementById('smsSignature').value = data.sms_signature;
    }
    
    /**
     * å¡«å……å®‰å…¨è®¾ç½®
     */
    function fillSecuritySettings(data) {
      if (!data) return;
      if (data.login_fail_limit) document.getElementById('loginFailLimit').value = data.login_fail_limit;
      if (data.lockout_duration) document.getElementById('lockoutDuration').value = data.lockout_duration;
      if (data.session_timeout) document.getElementById('sessionTimeout').value = data.session_timeout;
      if (data.jwt_expire_hours) document.getElementById('jwtExpireHours').value = data.jwt_expire_hours;
      if (data.ip_whitelist) document.getElementById('ipWhitelist').value = data.ip_whitelist;
      if (data.enable_two_factor !== undefined) document.getElementById('enableTwoFactor').checked = data.enable_two_factor;
      if (data.force_https !== undefined) document.getElementById('forceHttps').checked = data.force_https;
      if (data.enable_audit_log !== undefined) document.getElementById('enableAuditLog').checked = data.enable_audit_log;
    }
    
    /**
     * ä¿å­˜åŸºç¡€è®¾ç½®
     */
    async function saveBasicSettings() {
      showLoading();
      
      try {
        const settings = {
          system_name: document.getElementById('systemName').value,
          customer_phone: document.getElementById('customerServicePhone').value,
          customer_email: document.getElementById('customerServiceEmail').value
        };
        
        // è°ƒç”¨åç«¯API
        const response = await apiRequest('/api/v4/admin/settings/basic', {
          method: 'PUT',
          body: JSON.stringify({ settings })
        });
        
        if (response && response.success) {
          showSuccess('ä¿å­˜æˆåŠŸ', 'åŸºç¡€è®¾ç½®å·²æ›´æ–°');
        } else {
          showError('ä¿å­˜å¤±è´¥', response?.message || 'ä¿å­˜åŸºç¡€è®¾ç½®å¤±è´¥');
        }
      } catch (error) {
        console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
        showError('ä¿å­˜å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * ä¿å­˜æŠ½å¥–è®¾ç½®
     * 
     * æ³¨ï¼šæŠ½å¥–ç®—æ³•é…ç½®åœ¨config/business.config.jsä¸­ç®¡ç†ï¼ˆæŠ€æœ¯å›¢é˜Ÿè´Ÿè´£ï¼‰
     * ç”¨æˆ·ä¸ªæ€§åŒ–æ¦‚ç‡è¯·ä½¿ç”¨ã€ç”¨æˆ·ç®¡ç†ã€‘é¡µé¢çš„ã€æ¦‚ç‡ã€‘åŠŸèƒ½
     */
    async function saveLotterySettings() {
      showLoading();
      
      try {
        const data = {
          daily_draw_limit: parseInt(document.getElementById('dailyDrawLimit').value),
          draw_cost_points: parseInt(document.getElementById('drawCostPoints').value),
          min_consumption_amount: parseFloat(document.getElementById('minConsumptionAmount').value),
          points_conversion_rate: document.getElementById('pointsConversionRate').value,
          guaranteed_win_enabled: document.getElementById('guaranteedWinEnabled').checked,
          guaranteed_win_count: parseInt(document.getElementById('guaranteedWinCount').value)
        };
        
        // æç¤ºç”¨æˆ·ï¼šæŠ½å¥–æ ¸å¿ƒé…ç½®éœ€è¦ä¿®æ”¹ä»£ç 
        alert(
          'ğŸ’¡ æŠ½å¥–é…ç½®è¯´æ˜\n\n' +
          'âœ… è¿è¥é…ç½®ï¼ˆå¯é€šè¿‡ç•Œé¢ä¿®æ”¹ï¼‰ï¼š\n' +
          '   - è¯·å‰å¾€ã€ç”¨æˆ·ç®¡ç†ã€‘é¡µé¢\n' +
          '   - ç‚¹å‡»ç”¨æˆ·çš„ã€æ¦‚ç‡ã€‘æŒ‰é’®\n' +
          '   - å¯è®¾ç½®ç‰¹å®šç”¨æˆ·çš„ä¸­å¥–ç‡\n' +
          '\n' +
          'âš™ï¸ ç®—æ³•é…ç½®ï¼ˆéœ€è¦æŠ€æœ¯å›¢é˜Ÿä¿®æ”¹ä»£ç ï¼‰ï¼š\n' +
          '   - åŸºç¡€ä¸­å¥–ç‡ï¼šconfig/business.config.js\n' +
          '   - ä¿åº•è§¦å‘è§„åˆ™ï¼šBasicGuaranteeStrategy.js\n' +
          '   - è¿æŠ½å®šä»·ï¼šconfig/business.config.js\n' +
          '\n' +
          'ä¿®æ”¹ç®—æ³•é…ç½®åéœ€è¦é‡å¯æœåŠ¡ç”Ÿæ•ˆã€‚'
        );
        
      } catch (error) {
        console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
        showError('ä¿å­˜å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * ä¿å­˜ç§¯åˆ†è®¾ç½®
     */
    async function savePointsSettings() {
      showLoading();
      
      try {
        const settings = {
          sign_in_points: parseInt(document.getElementById('dailyCheckInPoints').value),
          initial_points: parseInt(document.getElementById('registerBonusPoints').value),
          points_expire_days: parseInt(document.getElementById('pointsExpireDays').value),
          budget_allocation_ratio: parseFloat(document.getElementById('budget_allocation_ratio').value)
        };
        
        // è°ƒç”¨åç«¯API
        const response = await apiRequest('/api/v4/admin/settings/points', {
          method: 'PUT',
          body: JSON.stringify({ settings })
        });
        
        if (response && response.success) {
          showSuccess('ä¿å­˜æˆåŠŸ', 'ç§¯åˆ†è®¾ç½®å·²æ›´æ–°ï¼ˆåŒ…æ‹¬é¢„ç®—åˆ†é…ç³»æ•°ï¼‰');
        } else {
          showError('ä¿å­˜å¤±è´¥', response?.message || 'ä¿å­˜ç§¯åˆ†è®¾ç½®å¤±è´¥');
        }
        
      } catch (error) {
        console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
        showError('ä¿å­˜å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * ä¿å­˜é€šçŸ¥è®¾ç½®
     */
    async function saveNotificationSettings() {
      showLoading();
      
      try {
        const settings = {
          sms_enabled: document.getElementById('smsEnabled')?.checked || false,
          email_enabled: document.getElementById('emailEnabled')?.checked || false,
          app_notification_enabled: document.getElementById('appNotificationEnabled')?.checked !== false
        };
        
        // è°ƒç”¨åç«¯API
        const response = await apiRequest('/api/v4/admin/settings/notification', {
          method: 'PUT',
          body: JSON.stringify({ settings })
        });
        
        if (response && response.success) {
          showSuccess('ä¿å­˜æˆåŠŸ', 'é€šçŸ¥è®¾ç½®å·²æ›´æ–°');
        } else {
          showError('ä¿å­˜å¤±è´¥', response?.message || 'ä¿å­˜é€šçŸ¥è®¾ç½®å¤±è´¥');
        }
      } catch (error) {
        console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
        showError('ä¿å­˜å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * ä¿å­˜å®‰å…¨è®¾ç½®
     */
    async function saveSecuritySettings() {
      showLoading();
      
      try {
        const settings = {
          max_login_attempts: parseInt(document.getElementById('loginFailLimit').value),
          lockout_duration: parseInt(document.getElementById('lockoutDuration').value),
          password_min_length: parseInt(document.getElementById('passwordMinLength')?.value || 6),
          api_rate_limit: parseInt(document.getElementById('apiRateLimit')?.value || 100)
        };
        
        // è°ƒç”¨åç«¯API
        const response = await apiRequest('/api/v4/admin/settings/security', {
          method: 'PUT',
          body: JSON.stringify({ settings })
        });
        
        if (response && response.success) {
          showSuccess('ä¿å­˜æˆåŠŸ', 'å®‰å…¨è®¾ç½®å·²æ›´æ–°');
        } else {
          showError('ä¿å­˜å¤±è´¥', response?.message || 'ä¿å­˜å®‰å…¨è®¾ç½®å¤±è´¥');
        }
      } catch (error) {
        console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
        showError('ä¿å­˜å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * æ¸…é™¤ç¼“å­˜
     * @param {string} type - ç¼“å­˜ç±»å‹
     */
    async function clearCache(type) {
      if (!confirm(`ç¡®è®¤æ¸…é™¤${type === 'all' ? 'å…¨éƒ¨' : type}ç¼“å­˜ï¼Ÿ\næ¸…é™¤åéœ€è¦ä¸€å®šæ—¶é—´é‡å»ºç¼“å­˜ï¼Œå¯èƒ½æš‚æ—¶å½±å“æ€§èƒ½ã€‚`)) {
        return;
      }
      
      showLoading();
      
      try {
        // æ ¹æ®ç±»å‹æ„å»ºpattern
        let pattern = '*'; // é»˜è®¤å…¨éƒ¨
        if (type === 'rate_limit') pattern = 'rate_limit:*';
        else if (type === 'user') pattern = 'user_*';
        else if (type === 'prize') pattern = 'prize_*';
        
        // è°ƒç”¨åç«¯API
        const response = await apiRequest('/api/v4/admin/cache/clear', {
          method: 'POST',
          body: JSON.stringify({ pattern, confirm: true })
        });
        
        if (response && response.success) {
          showSuccess('æ¸…é™¤æˆåŠŸ', `å·²æ¸…é™¤${response.data.cleared_count}ä¸ªç¼“å­˜é”®`);
        } else {
          showError('æ¸…é™¤å¤±è´¥', response?.message || 'ç¼“å­˜æ¸…é™¤å¤±è´¥');
        }
      } catch (error) {
        console.error('æ¸…é™¤ç¼“å­˜å¤±è´¥:', error);
        showError('æ¸…é™¤å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * æ˜¾ç¤ºåŠ è½½çŠ¶æ€
     */
    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('show');
    }
    
    /**
     * éšè—åŠ è½½çŠ¶æ€
     */
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('show');
    }
    
    /**
     * æ˜¾ç¤ºæˆåŠŸæç¤º
     * @param {string} title - æ ‡é¢˜
     * @param {string} message - æ¶ˆæ¯
     */
    function showSuccess(title, message) {
      alert(`âœ… ${title}\n${message}`);
    }
    
    /**
     * æ˜¾ç¤ºé”™è¯¯æç¤º
     * @param {string} title - æ ‡é¢˜
     * @param {string} message - æ¶ˆæ¯
     */
    function showError(title, message) {
      alert(`âŒ ${title}\n${message}`);
    }
  </script>
</body>
</html>

