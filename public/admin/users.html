<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”¨æˆ·ç®¡ç† - ç®¡ç†åå°</title>
  
  <!-- âœ… Bootstrap 5 - UIæ¡†æ¶ -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- âœ… Bootstrap Icons - å›¾æ ‡åº“ -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- âœ… å…¬å…±æ ·å¼è¡¨ - ç»Ÿä¸€ä¸»é¢˜å’Œå“åº”å¼è®¾è®¡ -->
  <link href="/admin/css/common.css" rel="stylesheet">
</head>
<body class="bg-light">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ‘¥ ç®¡ç†åå° - ç”¨æˆ·ç®¡ç†
      </a>
      <div>
        <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>
  
  <div class="container-fluid mt-4">
    <!-- ç­›é€‰å™¨åŒºåŸŸ -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">ç”¨æˆ·ç±»å‹</label>
            <select class="form-select" id="userTypeFilter">
              <option value="all">å…¨éƒ¨ç”¨æˆ·</option>
              <option value="normal">æ™®é€šç”¨æˆ·</option>
              <option value="vip">VIPç”¨æˆ·</option>
              <option value="admin">ç®¡ç†å‘˜</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">è´¦æˆ·çŠ¶æ€</label>
            <select class="form-select" id="statusFilter">
              <option value="all">å…¨éƒ¨çŠ¶æ€</option>
              <option value="active">æ­£å¸¸</option>
              <option value="banned">å·²å°ç¦</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">æœç´¢</label>
            <input type="text" class="form-control" id="searchInput" placeholder="æ‰‹æœºå·ã€æ˜µç§°ã€ID">
          </div>
          <div class="col-md-3">
            <label class="form-label">&nbsp;</label>
            <div>
              <button class="btn btn-primary" id="searchBtn">
                <i class="bi bi-search"></i> æœç´¢
              </button>
              <button class="btn btn-outline-secondary" id="resetBtn">
                <i class="bi bi-arrow-clockwise"></i> é‡ç½®
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="row g-3 mb-3">
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h6 class="text-muted">æ€»ç”¨æˆ·æ•°</h6>
            <h3 class="text-primary" id="totalUsers">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h6 class="text-muted">ä»Šæ—¥æ–°å¢</h6>
            <h3 class="text-success" id="todayUsers">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h6 class="text-muted">æ´»è·ƒç”¨æˆ·</h6>
            <h3 class="text-info" id="activeUsers">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h6 class="text-muted">VIPç”¨æˆ·</h6>
            <h3 class="text-warning" id="vipUsers">-</h3>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æ•°æ®è¡¨æ ¼ -->
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th style="width: 80px;">ID</th>
                <th>ç”¨æˆ·ä¿¡æ¯</th>
                <th>è§’è‰²</th>
                <th>å†å²æ€»ç§¯åˆ†</th>
                <th>æ³¨å†Œæ—¶é—´</th>
                <th>æœ€åç™»å½•</th>
                <th>çŠ¶æ€</th>
                <th style="width: 200px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr>
                <td colspan="8" class="text-center py-5">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                  </div>
                  <p class="mt-2 text-muted">æ­£åœ¨åŠ è½½æ•°æ®...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- åˆ†é¡µ -->
        <nav aria-label="åˆ†é¡µå¯¼èˆª">
          <ul class="pagination justify-content-center mb-0" id="pagination">
            <li class="page-item disabled">
              <span class="page-link">åŠ è½½ä¸­...</span>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
  
  <!-- ç”¨æˆ·è¯¦æƒ…æ¨¡æ€æ¡† -->
  <div class="modal fade" id="userDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-person-circle"></i> ç”¨æˆ·è¯¦æƒ…
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="userDetailBody">
          <!-- ç”¨æˆ·è¯¦æƒ…å°†åŠ¨æ€åŠ è½½ -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- è§’è‰²ç®¡ç†æ¨¡æ€æ¡† -->
  <div class="modal fade" id="roleModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-shield-check"></i> è§’è‰²ç®¡ç†
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">é€‰æ‹©è§’è‰²</label>
            <div id="rolesCheckboxes">
              <!-- è§’è‰²å¤é€‰æ¡†å°†åŠ¨æ€åŠ è½½ -->
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" id="saveRolesBtn">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ğŸ†• æ¦‚ç‡è°ƒæ•´æ¨¡æ€æ¡† -->
  <div class="modal fade" id="probabilityModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-info bg-gradient text-white">
          <h5 class="modal-title">
            <i class="bi bi-percent"></i> ç”¨æˆ·ä¸ªæ€§åŒ–ä¸­å¥–ç‡è®¾ç½®
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- ç”¨æˆ·ä¿¡æ¯ -->
          <div class="alert alert-light border">
            <div class="row">
              <div class="col-6">
                <strong>ç”¨æˆ·æ‰‹æœºï¼š</strong><span id="probModalUserMobile">-</span>
              </div>
              <div class="col-6">
                <strong>ç”¨æˆ·IDï¼š</strong><span id="probModalUserId">-</span>
              </div>
            </div>
          </div>
          
          <!-- è°ƒæ•´æ¨¡å¼é€‰æ‹© -->
          <div class="mb-4">
            <label class="form-label fw-bold">è°ƒæ•´æ¨¡å¼</label>
            <div class="btn-group w-100" role="group">
              <input type="radio" class="btn-check" name="adjustmentMode" id="modeGlobal" value="global" checked>
              <label class="btn btn-outline-secondary" for="modeGlobal">
                <i class="bi bi-globe"></i> å…¨å±€å€æ•°è°ƒæ•´
              </label>
              <input type="radio" class="btn-check" name="adjustmentMode" id="modeSpecific" value="specific">
              <label class="btn btn-outline-info" for="modeSpecific">
                <i class="bi bi-bullseye"></i> ç‰¹å®šå¥–å“è°ƒæ•´
              </label>
            </div>
            <div class="form-text">
              å…¨å±€ï¼šæ‰€æœ‰å¥–å“æ¦‚ç‡æŒ‰å€æ•°è°ƒæ•´ | ç‰¹å®šï¼šåªè°ƒæ•´æŸä¸ªå¥–å“ï¼Œå…¶ä»–è‡ªåŠ¨ç¼©æ”¾
            </div>
          </div>
          
          <!-- å…¨å±€å€æ•°è°ƒæ•´åŒºåŸŸ -->
          <div id="globalAdjustArea">
            <div class="mb-3">
              <label class="form-label">æ¦‚ç‡å€æ•°ï¼ˆ0.1-10å€ï¼‰</label>
              <input type="number" class="form-control" id="probabilityMultiplier" 
                     min="0.1" max="10" step="0.1" value="2.0" placeholder="1.0è¡¨ç¤ºä¸å˜ï¼Œ2.0è¡¨ç¤ºç¿»å€">
              <div class="form-text">
                ä¾‹å¦‚ï¼šè®¾ç½®2.0ï¼Œåˆ™æ‰€æœ‰å¥–å“ä¸­å¥–ç‡ç¿»å€ï¼ˆä¸€ç­‰å¥–20%â†’40%ï¼‰
              </div>
            </div>
          </div>
          
          <!-- ç‰¹å®šå¥–å“è°ƒæ•´åŒºåŸŸ -->
          <div id="specificAdjustArea" style="display:none;">
            <div class="mb-3">
              <label class="form-label">é€‰æ‹©è¦è°ƒæ•´çš„å¥–å“</label>
              <select class="form-select" id="targetPrizeSelect">
                <option value="">è¯·å…ˆé€‰æ‹©å¥–å“...</option>
              </select>
              <div class="form-text">
                é€‰æ‹©ä¸€ä¸ªå¥–å“è¿›è¡Œæ¦‚ç‡è°ƒæ•´
              </div>
            </div>
            
            <div class="mb-3">
              <label class="form-label">è®¾ç½®æ–°æ¦‚ç‡ï¼ˆ1%-100%ï¼‰</label>
              <div class="input-group">
                <input type="number" class="form-control" id="customProbability" 
                       min="1" max="100" step="1" value="50" placeholder="50">
                <span class="input-group-text">%</span>
              </div>
              <div class="form-text text-danger">
                âš ï¸ å…¶ä»–å¥–å“æ¦‚ç‡å°†è‡ªåŠ¨æŒ‰æ¯”ä¾‹ç¼©å‡ï¼Œç¡®ä¿æ€»æ¦‚ç‡100%
              </div>
            </div>
            
            <!-- æ¦‚ç‡é¢„è§ˆ -->
            <div class="card bg-light">
              <div class="card-body">
                <h6 class="card-title">æ¦‚ç‡è°ƒæ•´é¢„è§ˆ</h6>
                <div id="probabilityPreview">
                  <p class="text-muted mb-0">è¯·é€‰æ‹©å¥–å“å¹¶è®¾ç½®æ¦‚ç‡</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- å…¬å…±è®¾ç½® -->
          <div class="mb-3 mt-4">
            <label class="form-label">æŒç»­æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
            <select class="form-select" id="durationMinutes">
              <option value="30">30åˆ†é’Ÿ</option>
              <option value="60" selected>1å°æ—¶</option>
              <option value="180">3å°æ—¶</option>
              <option value="360">6å°æ—¶</option>
              <option value="1440">24å°æ—¶</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label class="form-label">è°ƒæ•´åŸå› </label>
            <input type="text" class="form-control" id="probabilityReason" 
                   placeholder="ä¾‹å¦‚ï¼šVIPç”¨æˆ·æŒ½ç•™ã€æ´»åŠ¨ä¿ƒé”€ç­‰" maxlength="100">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-info" id="saveProbabilityBtn">
            <i class="bi bi-check-lg"></i> ä¿å­˜è®¾ç½®
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- åŠ è½½é®ç½©å±‚ -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">å¤„ç†ä¸­...</span>
    </div>
  </div>

  <!-- âœ… Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- âœ… å¼•å…¥é€šç”¨å·¥å…·åº“ -->
  <script src="/admin/js/admin-common.js"></script>
  
  <script>
    /**
     * å…¨å±€å˜é‡
     */
    let currentPage = 1;
    let currentUserId = null;
    let availableRoles = [];
    const pageSize = 20;
    
    /**
     * é¡µé¢åˆå§‹åŒ–
     */
    document.addEventListener('DOMContentLoaded', function() {
      // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
      const userInfo = getCurrentUser();
      if (userInfo && userInfo.nickname) {
        document.getElementById('welcomeText').textContent = `æ¬¢è¿ï¼Œ${userInfo.nickname}`;
      }
      
      // âœ… Tokenå’Œæƒé™éªŒè¯
      if (!getToken() || !checkAdminPermission()) {
        return;
      }
      
      // åŠ è½½å¯ç”¨è§’è‰²åˆ—è¡¨
      loadAvailableRoles();
      
      // ğŸ”§ åŠ è½½ä»ªè¡¨æ¿ç»Ÿè®¡æ•°æ®ï¼ˆåç«¯ç”¨æˆ·åˆ—è¡¨APIä¸è¿”å›ç»Ÿè®¡ï¼‰
      loadDashboardStatistics();
      
      // åŠ è½½ç”¨æˆ·åˆ—è¡¨
      loadUsers();
      
      // ===== é™æ€æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨ =====
      // é€€å‡ºç™»å½•æŒ‰é’®
      document.getElementById('logoutBtn').addEventListener('click', logout);
      
      // æœç´¢æŒ‰é’®
      document.getElementById('searchBtn').addEventListener('click', () => {
        currentPage = 1;
        loadUsers();
      });
      
      // é‡ç½®æŒ‰é’®
      document.getElementById('resetBtn').addEventListener('click', resetFilters);
      
      // ç­›é€‰å™¨å˜åŒ–æ—¶é‡æ–°åŠ è½½
      document.getElementById('userTypeFilter').addEventListener('change', () => {
        currentPage = 1;
        loadUsers();
      });
      
      document.getElementById('statusFilter').addEventListener('change', () => {
        currentPage = 1;
        loadUsers();
      });
      
      // æœç´¢æ¡†å›è½¦è§¦å‘æœç´¢
      document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          currentPage = 1;
          loadUsers();
        }
      });
      
      // ä¿å­˜è§’è‰²æŒ‰é’®
      document.getElementById('saveRolesBtn').addEventListener('click', saveUserRoles);
      
      // ğŸ†• ä¿å­˜æ¦‚ç‡è®¾ç½®æŒ‰é’®
      document.getElementById('saveProbabilityBtn').addEventListener('click', saveProbabilityAdjustment);
      
      // ğŸ†• è°ƒæ•´æ¨¡å¼åˆ‡æ¢äº‹ä»¶
      document.querySelectorAll('input[name="adjustmentMode"]').forEach(radio => {
        radio.addEventListener('change', toggleAdjustmentMode);
      });
      
      // ğŸ†• å¥–å“é€‰æ‹©å’Œæ¦‚ç‡è¾“å…¥å˜åŒ–æ—¶æ›´æ–°é¢„è§ˆ
      document.getElementById('targetPrizeSelect')?.addEventListener('change', updateProbabilityPreview);
      document.getElementById('customProbability')?.addEventListener('input', updateProbabilityPreview);
      
      // ===== äº‹ä»¶å§”æ‰˜ï¼šç”¨æˆ·è¡¨æ ¼æ“ä½œæŒ‰é’® =====
      document.getElementById('usersTableBody').addEventListener('click', (e) => {
        // æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®
        const detailBtn = e.target.closest('.user-detail-btn');
        if (detailBtn) {
          const userId = parseInt(detailBtn.dataset.userId);
          viewUserDetail(userId);
          return;
        }
        
        // ğŸ†• æ¦‚ç‡è°ƒæ•´æŒ‰é’®
        const probabilityBtn = e.target.closest('.user-probability-btn');
        if (probabilityBtn) {
          const userId = parseInt(probabilityBtn.dataset.userId);
          const userMobile = probabilityBtn.dataset.userMobile;
          openProbabilityModal(userId, userMobile);
          return;
        }
        
        // ç®¡ç†è§’è‰²æŒ‰é’®
        const rolesBtn = e.target.closest('.user-roles-btn');
        if (rolesBtn) {
          const userId = parseInt(rolesBtn.dataset.userId);
          manageRoles(userId);
          return;
        }
        
        // å°ç¦æŒ‰é’®
        const banBtn = e.target.closest('.user-ban-btn');
        if (banBtn) {
          const userId = parseInt(banBtn.dataset.userId);
          banUser(userId);
          return;
        }
        
        // è§£å°æŒ‰é’®
        const unbanBtn = e.target.closest('.user-unban-btn');
        if (unbanBtn) {
          const userId = parseInt(unbanBtn.dataset.userId);
          unbanUser(userId);
          return;
        }
      });
      
      // ===== äº‹ä»¶å§”æ‰˜ï¼šåˆ†é¡µæŒ‰é’® =====
      document.getElementById('pagination').addEventListener('click', (e) => {
        e.preventDefault();
        const pageBtn = e.target.closest('.page-nav-btn');
        if (pageBtn && !pageBtn.closest('.disabled') && !pageBtn.closest('.active')) {
          const page = parseInt(pageBtn.dataset.page);
          if (!isNaN(page) && page > 0) {
            changePage(page);
          }
        }
      });
      
      // ===== å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç† =====
      // ä½¿ç”¨Bootstrap Iconsä½œä¸ºé»˜è®¤å¤´åƒå ä½ç¬¦ï¼Œé¿å…404é”™è¯¯
      document.getElementById('usersTableBody').addEventListener('error', (e) => {
        if (e.target.classList.contains('user-avatar-img')) {
          // æ›¿æ¢ä¸ºå ä½ç¬¦å›¾æ ‡ï¼ˆä½¿ç”¨data URIé¿å…é¢å¤–è¯·æ±‚ï¼‰
          e.target.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgZmlsbD0iI2NjYyIgY2xhc3M9ImJpIGJpLXBlcnNvbi1jaXJjbGUiIHZpZXdCb3g9IjAgMCAxNiAxNiI+PHBhdGggZD0iTTExIDZhMyAzIDAgMSAxLTYgMCAzIDMgMCAwIDEgNiAweiIvPjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgZD0iTTAgOGE4IDggMCAxIDEgMTYgMEE4IDggMCAwIDEgMCA4em04IDdhNyA3IDAgMCAwIDUuMzg3LTIuNTAzQTEzLjkzMyAxMy45MzMgMCAwIDAgOCAxMS41YTEzLjkzMyAxMy45MzMgMCAwIDAtNS4zODcgMS4wMDdBNyA3IDAgMCAwIDggMTV6Ii8+PC9zdmc+';
          e.target.alt = 'é»˜è®¤å¤´åƒ';
        }
      }, true);
    });
    
    /**
     * åŠ è½½å¯ç”¨è§’è‰²åˆ—è¡¨
     */
    async function loadAvailableRoles() {
      try {
        // ä½¿ç”¨åç«¯å®é™…APIè·¯å¾„ï¼š/api/v4/console/user-management/roles
        const response = await apiRequest('/api/v4/console/user-management/roles');
        if (response && response.success) {
          availableRoles = response.data.roles || response.data.list || [];
        }
      } catch (error) {
        console.error('åŠ è½½è§’è‰²åˆ—è¡¨å¤±è´¥:', error);
      }
    }
    
    /**
     * åŠ è½½ç”¨æˆ·åˆ—è¡¨
     * @param {boolean} silent - æ˜¯å¦é™é»˜åˆ·æ–°
     */
    async function loadUsers(silent = false) {
      if (!silent) {
        showLoading();
      }
      
      try {
        const userType = document.getElementById('userTypeFilter').value;
        const status = document.getElementById('statusFilter').value;
        const search = document.getElementById('searchInput').value.trim();
        
        // æ„å»ºæŸ¥è¯¢å‚æ•°
        const params = new URLSearchParams({
          page: currentPage,
          limit: pageSize
        });
        
        if (userType !== 'all') {
          params.append('type', userType);
        }
        
        if (status !== 'all') {
          params.append('status', status);
        }
        
        if (search) {
          params.append('search', search);
        }
        
        // è°ƒç”¨API - ä½¿ç”¨åç«¯å®é™…APIè·¯å¾„ï¼š/api/v4/console/user-management/users
        const response = await apiRequest(`/api/v4/console/user-management/users?${params.toString()}`);
        
        if (response && response.success) {
          renderUsers(response.data);
          updateStatistics(response.data);
        } else {
          showError('åŠ è½½å¤±è´¥', response?.message || 'è·å–æ•°æ®å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error);
        showError('åŠ è½½å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
     * @param {Object} data - APIè¿”å›çš„æ•°æ®
     */
    function renderUsers(data) {
      const tbody = document.getElementById('usersTableBody');
      const users = data.users || data.list || [];
      
      if (users.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="text-center py-5">
              <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
              <p class="mt-2 text-muted">æš‚æ— æ•°æ®</p>
            </td>
          </tr>
        `;
        renderPagination(0, 0);
        return;
      }
      
      // ğŸ”§ é€‚é…åç«¯å®é™…è¿”å›çš„å­—æ®µæ ¼å¼
      // åç«¯è¿”å›: user_id, mobile, nickname, history_total_points, status, role_level, roles[], last_login, created_at
      tbody.innerHTML = users.map(user => {
        // ä½¿ç”¨Bootstrap Iconsçš„SVGä½œä¸ºé»˜è®¤å¤´åƒï¼ˆBase64ç¼–ç ï¼Œé¿å…é¢å¤–ç½‘ç»œè¯·æ±‚ï¼‰
        const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgZmlsbD0iI2NjYyIgY2xhc3M9ImJpIGJpLXBlcnNvbi1jaXJjbGUiIHZpZXdCb3g9IjAgMCAxNiAxNiI+PHBhdGggZD0iTTExIDZhMyAzIDAgMSAxLTYgMCAzIDMgMCAwIDEgNiAweiIvPjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgZD0iTTAgOGE4IDggMCAxIDEgMTYgMEE4IDggMCAwIDEgMCA4em04IDdhNyA3IDAgMCAwIDUuMzg3LTIuNTAzQTEzLjkzMyAxMy45MzMgMCAwIDAgOCAxMS41YTEzLjkzMyAxMy45MzMgMCAwIDAtNS4zODcgMS4wMDdBNyA3IDAgMCAwIDggMTV6Ii8+PC9zdmc+';
        
        return `
        <tr>
          <td>${user.user_id}</td>
          <td>
            <div class="d-flex align-items-center">
              <img src="${user.avatar_url || defaultAvatar}" 
                   class="user-avatar me-3 user-avatar-img" 
                   alt="å¤´åƒ"
                   onerror="this.src='${defaultAvatar}'">
              <div>
                <div class="fw-bold">${user.nickname || 'æœªè®¾ç½®æ˜µç§°'}</div>
                <small class="text-muted">${maskPhone(user.mobile || '-')}</small>
              </div>
            </div>
          </td>
          <td>${renderRoleBadges(user.roles, user.role_level)}</td>
          <td class="text-primary fw-bold">${formatNumber(user.history_total_points || 0)}</td>
          <td>
            ${user.created_at ? 
              `<div>${formatDate(user.created_at)}</div>
               <small class="text-muted">${formatRelativeTime(user.created_at)}</small>` :
              '<span class="text-muted">-</span>'
            }
          </td>
          <td>
            ${user.last_login ? 
              `<div>${formatDate(user.last_login)}</div>
               <small class="text-muted">${formatRelativeTime(user.last_login)}</small>` :
              '<span class="text-muted">ä»æœªç™»å½•</span>'
            }
          </td>
          <td>${renderStatusBadge(user.status)}</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary user-detail-btn" data-user-id="${user.user_id}">
                <i class="bi bi-eye"></i> è¯¦æƒ…
              </button>
              <button class="btn btn-outline-info user-probability-btn" data-user-id="${user.user_id}" data-user-mobile="${user.mobile}">
                <i class="bi bi-percent"></i> æ¦‚ç‡
              </button>
              <button class="btn btn-outline-warning user-roles-btn" data-user-id="${user.user_id}">
                <i class="bi bi-shield"></i> è§’è‰²
              </button>
              ${user.status === 'active' ?
                `<button class="btn btn-outline-danger user-ban-btn" data-user-id="${user.user_id}">
                  <i class="bi bi-x-circle"></i> å°ç¦
                </button>` :
                `<button class="btn btn-outline-success user-unban-btn" data-user-id="${user.user_id}">
                  <i class="bi bi-check-circle"></i> è§£å°
                </button>`
              }
            </div>
          </td>
        </tr>
      `;
      }).join('');
      
      // æ¸²æŸ“åˆ†é¡µ
      const total = data.total || users.length;
      renderPagination(total, currentPage);
    }
    
    /**
     * æ¸²æŸ“è§’è‰²å¾½ç« 
     * ğŸ”§ é€‚é…åç«¯è¿”å›æ ¼å¼ï¼šrolesä¸ºå­—ç¬¦ä¸²æ•°ç»„ ["user", "admin"]
     * @param {Array} roles - è§’è‰²æ•°ç»„ï¼ˆå­—ç¬¦ä¸²æ•°ç»„ï¼‰
     * @param {number} roleLevel - ç”¨æˆ·æœ€é«˜è§’è‰²ç­‰çº§ï¼ˆåç«¯è¿”å›çš„role_levelå­—æ®µï¼‰
     * @returns {string} HTMLå­—ç¬¦ä¸²
     */
    function renderRoleBadges(roles, roleLevel = 0) {
      if (!roles || roles.length === 0) {
        return '<span class="text-muted small">æ— è§’è‰²</span>';
      }
      
      // åç«¯è¿”å›çš„rolesæ˜¯å­—ç¬¦ä¸²æ•°ç»„ï¼Œä½¿ç”¨role_levelç¡®å®šæ ·å¼
      const bgColor = roleLevel >= 100 ? 'bg-danger' : 
                     roleLevel >= 50 ? 'bg-warning' : 'bg-secondary';
      
      return roles.map(roleName => {
        return `<span class="badge ${bgColor} role-badge">${roleName}</span>`;
      }).join(' ');
    }
    
    /**
     * æ¸²æŸ“çŠ¶æ€å¾½ç« 
     * @param {string} status - çŠ¶æ€
     * @returns {string} HTMLå­—ç¬¦ä¸²
     */
    function renderStatusBadge(status) {
      const badges = {
        active: '<span class="badge bg-success"><i class="bi bi-check-circle"></i> æ­£å¸¸</span>',
        banned: '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> å·²å°ç¦</span>'
      };
      return badges[status] || '<span class="badge bg-secondary">æœªçŸ¥</span>';
    }
    
    /**
     * æ¸²æŸ“åˆ†é¡µ
     * @param {number} total - æ€»è®°å½•æ•°
     * @param {number} current - å½“å‰é¡µç 
     */
    function renderPagination(total, current) {
      const pagination = document.getElementById('pagination');
      const totalPages = Math.ceil(total / pageSize);
      
      if (totalPages <= 1) {
        pagination.innerHTML = `
          <li class="page-item disabled">
            <span class="page-link">å…± ${total} æ¡è®°å½•</span>
          </li>
        `;
        return;
      }
      
      let html = `
        <li class="page-item ${current === 1 ? 'disabled' : ''}">
          <a class="page-link page-nav-btn" href="#" data-page="${current - 1}">ä¸Šä¸€é¡µ</a>
        </li>
      `;
      
      // æ˜¾ç¤ºé¡µç 
      const maxPages = 7;
      let startPage = Math.max(1, current - Math.floor(maxPages / 2));
      let endPage = Math.min(totalPages, startPage + maxPages - 1);
      
      if (endPage - startPage < maxPages - 1) {
        startPage = Math.max(1, endPage - maxPages + 1);
      }
      
      if (startPage > 1) {
        html += `<li class="page-item"><a class="page-link page-nav-btn" href="#" data-page="1">1</a></li>`;
        if (startPage > 2) {
          html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
      }
      
      for (let i = startPage; i <= endPage; i++) {
        html += `
          <li class="page-item ${i === current ? 'active' : ''}">
            <a class="page-link page-nav-btn" href="#" data-page="${i}">${i}</a>
          </li>
        `;
      }
      
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        html += `<li class="page-item"><a class="page-link page-nav-btn" href="#" data-page="${totalPages}">${totalPages}</a></li>`;
      }
      
      html += `
        <li class="page-item ${current === totalPages ? 'disabled' : ''}">
          <a class="page-link page-nav-btn" href="#" data-page="${current + 1}">ä¸‹ä¸€é¡µ</a>
        </li>
      `;
      
      pagination.innerHTML = html;
    }
    
    /**
     * æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
     * ğŸ”§ åç«¯ç”¨æˆ·åˆ—è¡¨APIä¸è¿”å›statisticsï¼Œéœ€è¦ä»dashboard APIè·å–
     * @param {Object} data - APIè¿”å›çš„æ•°æ®
     */
    function updateStatistics(data) {
      // ä½¿ç”¨åˆ†é¡µä¿¡æ¯ä¸­çš„æ€»æ•°
      if (data.pagination) {
        document.getElementById('totalUsers').textContent = formatNumber(data.pagination.total || 0);
      }
    }
    
    /**
     * ä»Dashboard APIåŠ è½½ç»Ÿè®¡æ•°æ®
     * ğŸ”§ é€‚é…åç«¯dashboard APIè¿”å›çš„æ•°æ®æ ¼å¼
     */
    async function loadDashboardStatistics() {
      try {
        const response = await apiRequest('/api/v4/console/system/dashboard');
        if (response && response.success && response.data) {
          const overview = response.data.overview || {};
          const today = response.data.today || {};
          
          document.getElementById('totalUsers').textContent = formatNumber(overview.total_users || 0);
          document.getElementById('todayUsers').textContent = formatNumber(today.new_users || 0);
          document.getElementById('activeUsers').textContent = formatNumber(overview.active_users || 0);
          // VIPç”¨æˆ·æ•°åç«¯æš‚æœªæä¾›ï¼Œæ˜¾ç¤ºä¸º0
          document.getElementById('vipUsers').textContent = formatNumber(overview.vip_users || 0);
        }
      } catch (error) {
        console.error('åŠ è½½ä»ªè¡¨æ¿ç»Ÿè®¡å¤±è´¥:', error);
      }
    }
    
    /**
     * åˆ‡æ¢é¡µç 
     * @param {number} page - ç›®æ ‡é¡µç 
     */
    function changePage(page) {
      currentPage = page;
      loadUsers();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    /**
     * é‡ç½®ç­›é€‰å™¨
     */
    function resetFilters() {
      document.getElementById('userTypeFilter').value = 'all';
      document.getElementById('statusFilter').value = 'all';
      document.getElementById('searchInput').value = '';
      currentPage = 1;
      loadUsers();
    }
    
    /**
     * æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…
     * @param {number} userId - ç”¨æˆ·ID
     */
    async function viewUserDetail(userId) {
      showLoading();
      
      try {
        // ä½¿ç”¨åç«¯å®é™…APIè·¯å¾„ï¼š/api/v4/console/user-management/users/:user_id
        const response = await apiRequest(`/api/v4/console/user-management/users/${userId}`);
        
        if (response && response.success) {
          const user = response.data.user || response.data;
          renderUserDetail(user);
          new bootstrap.Modal(document.getElementById('userDetailModal')).show();
        } else {
          showError('è·å–å¤±è´¥', response?.message || 'è·å–ç”¨æˆ·è¯¦æƒ…å¤±è´¥');
        }
      } catch (error) {
        console.error('è·å–ç”¨æˆ·è¯¦æƒ…å¤±è´¥:', error);
        showError('è·å–å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * æ¸²æŸ“ç”¨æˆ·è¯¦æƒ…
     * ğŸ”§ é€‚é…åç«¯è¿”å›æ ¼å¼
     * @param {Object} user - ç”¨æˆ·å¯¹è±¡
     */
    function renderUserDetail(user) {
      // ä½¿ç”¨Bootstrap Iconsçš„SVGä½œä¸ºé»˜è®¤å¤´åƒï¼ˆBase64ç¼–ç ï¼‰
      const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgZmlsbD0iI2NjYyIgY2xhc3M9ImJpIGJpLXBlcnNvbi1jaXJjbGUiIHZpZXdCb3g9IjAgMCAxNiAxNiI+PHBhdGggZD0iTTExIDZhMyAzIDAgMSAxLTYgMCAzIDMgMCAwIDEgNiAweiIvPjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgZD0iTTAgOGE4IDggMCAxIDEgMTYgMEE4IDggMCAwIDEgMCA4em04IDdhNyA3IDAgMCAwIDUuMzg3LTIuNTAzQTEzLjkzMyAxMy45MzMgMCAwIDAgOCAxMS41YTEzLjkzMyAxMy45MzMgMCAwIDAtNS4zODcgMS4wMDdBNyA3IDAgMCAwIDggMTV6Ii8+PC9zdmc+';
      
      // ğŸ”§ é€‚é…åç«¯æ ¼å¼ï¼šroleså¯èƒ½æ˜¯å¯¹è±¡æ•°ç»„æˆ–å­—ç¬¦ä¸²æ•°ç»„
      const roleLevel = user.role_level || 0;
      const rolesDisplay = renderRoleBadges(user.roles, roleLevel);
      
      const detailHtml = `
        <div class="row g-3">
          <div class="col-md-12 text-center mb-3">
            <img src="${user.avatar_url || defaultAvatar}" 
                 class="rounded-circle" 
                 style="width: 100px; height: 100px;"
                 alt="å¤´åƒ"
                 onerror="this.src='${defaultAvatar}'">
          </div>
          <div class="col-md-6">
            <strong>ç”¨æˆ·IDï¼š</strong>${user.user_id}
          </div>
          <div class="col-md-6">
            <strong>æ˜µç§°ï¼š</strong>${user.nickname || 'æœªè®¾ç½®'}
          </div>
          <div class="col-md-6">
            <strong>æ‰‹æœºå·ï¼š</strong>${user.mobile || '-'}
          </div>
          <div class="col-md-6">
            <strong>æƒé™ç­‰çº§ï¼š</strong>Lv.${roleLevel}
          </div>
          <div class="col-md-6">
            <strong>è§’è‰²ï¼š</strong>${rolesDisplay}
          </div>
          <div class="col-md-6">
            <strong>çŠ¶æ€ï¼š</strong>${renderStatusBadge(user.status)}
          </div>
          <div class="col-md-6">
            <strong>å†å²æ€»ç§¯åˆ†ï¼š</strong>
            <span class="text-primary fw-bold">${formatNumber(user.history_total_points || 0)}</span>
          </div>
          <div class="col-md-6">
            <strong>è¿ç»­å¤±è´¥æ¬¡æ•°ï¼š</strong>${user.consecutive_fail_count || 0}
          </div>
          <div class="col-md-6">
            <strong>æ³¨å†Œæ—¶é—´ï¼š</strong>${user.created_at ? formatDate(user.created_at) : '-'}
          </div>
          <div class="col-md-6">
            <strong>æœ€åç™»å½•ï¼š</strong>
            ${user.last_login ? formatDate(user.last_login) : 'ä»æœªç™»å½•'}
          </div>
        </div>
      `;
      
      document.getElementById('userDetailBody').innerHTML = detailHtml;
    }
    
    /**
     * ç®¡ç†ç”¨æˆ·è§’è‰²
     * @param {number} userId - ç”¨æˆ·ID
     */
    async function manageRoles(userId) {
      currentUserId = userId;
      showLoading();
      
      try {
        // è·å–ç”¨æˆ·è¯¦æƒ…ï¼ˆåŒ…å«è§’è‰²ä¿¡æ¯ï¼‰ - ä½¿ç”¨åç«¯å®é™…APIè·¯å¾„
        const response = await apiRequest(`/api/v4/console/user-management/users/${userId}`);
        
        if (response && response.success) {
          // ä»ç”¨æˆ·è¯¦æƒ…ä¸­æå–è§’è‰²ä¿¡æ¯
          const user = response.data.user || response.data;
          const userRoles = user.roles || [];
          renderRolesCheckboxes(userRoles);
          new bootstrap.Modal(document.getElementById('roleModal')).show();
        } else {
          showError('è·å–å¤±è´¥', response?.message || 'è·å–ç”¨æˆ·è§’è‰²å¤±è´¥');
        }
      } catch (error) {
        console.error('è·å–ç”¨æˆ·è§’è‰²å¤±è´¥:', error);
        showError('è·å–å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * æ¸²æŸ“è§’è‰²å¤é€‰æ¡†
     * ğŸ”§ é€‚é…åç«¯æ ¼å¼ï¼šç”¨æˆ·è§’è‰²å¯èƒ½æ˜¯å¯¹è±¡æ•°ç»„æˆ–å­—ç¬¦ä¸²æ•°ç»„
     * @param {Array} userRoles - ç”¨æˆ·å½“å‰è§’è‰²ï¼ˆåç«¯æ ¼å¼ï¼šå¯¹è±¡æ•°ç»„ [{role_name, role_level}]ï¼‰
     */
    function renderRolesCheckboxes(userRoles) {
      const container = document.getElementById('rolesCheckboxes');
      
      // ğŸ”§ é€‚é…ï¼šuserRoleså¯èƒ½æ˜¯å¯¹è±¡æ•°ç»„æˆ–å­—ç¬¦ä¸²æ•°ç»„
      const userRoleNames = userRoles.map(r => {
        if (typeof r === 'string') return r;
        return r.role_name;
      });
      
      // availableRolesä»åç«¯è§’è‰²åˆ—è¡¨APIè·å–ï¼Œæ ¼å¼ä¸º [{id, role_uuid, role_name, role_level, description}]
      container.innerHTML = availableRoles.map(role => `
        <div class="form-check">
          <input class="form-check-input" 
                 type="radio" 
                 name="userRole"
                 id="role_${role.id}" 
                 value="${role.role_name}"
                 data-role-level="${role.role_level}"
                 ${userRoleNames.includes(role.role_name) ? 'checked' : ''}>
          <label class="form-check-label" for="role_${role.id}">
            <span class="badge ${role.role_level >= 100 ? 'bg-danger' : role.role_level >= 50 ? 'bg-warning' : 'bg-secondary'} me-2">
              Lv.${role.role_level} ${role.role_name}
            </span>
            <small class="text-muted">${role.description || ''}</small>
          </label>
        </div>
      `).join('');
    }
    
    /**
     * ä¿å­˜ç”¨æˆ·è§’è‰²
     * ğŸ”§ åç«¯APIï¼šPUT /api/v4/console/user-management/users/:user_id/role
     * åç«¯åªæ”¯æŒå•ä¸€è§’è‰²æ¨¡å¼ï¼Œä½¿ç”¨radio buttoné€‰æ‹©
     */
    async function saveUserRoles() {
      const selectedRadio = document.querySelector('#rolesCheckboxes input[type="radio"]:checked');
      
      // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†è§’è‰²
      if (!selectedRadio) {
        showError('ä¿å­˜å¤±è´¥', 'è¯·é€‰æ‹©ä¸€ä¸ªè§’è‰²');
        return;
      }
      
      // è·å–è§’è‰²åç§°ï¼ˆåç«¯éœ€è¦role_nameï¼‰
      const roleName = selectedRadio.value;
      
      if (!roleName) {
        showError('ä¿å­˜å¤±è´¥', 'æ— æ³•è·å–è§’è‰²åç§°');
        return;
      }
      
      showLoading();
      
      try {
        // ä½¿ç”¨åç«¯å®é™…APIè·¯å¾„ï¼šPUT /api/v4/console/user-management/users/:user_id/role
        const response = await apiRequest(`/api/v4/console/user-management/users/${currentUserId}/role`, {
          method: 'PUT',
          body: JSON.stringify({ 
            role_name: roleName,  // åç«¯éœ€è¦role_nameå‚æ•°
            reason: 'ç®¡ç†å‘˜æ‰‹åŠ¨æ›´æ–°è§’è‰²'
          })
        });
        
        if (response && response.success) {
          showSuccess('ä¿å­˜æˆåŠŸ', 'ç”¨æˆ·è§’è‰²å·²æ›´æ–°');
          bootstrap.Modal.getInstance(document.getElementById('roleModal')).hide();
          loadUsers(true);
        } else {
          showError('ä¿å­˜å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        console.error('ä¿å­˜è§’è‰²å¤±è´¥:', error);
        showError('ä¿å­˜å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * å°ç¦ç”¨æˆ·
     * @param {number} userId - ç”¨æˆ·ID
     */
    async function banUser(userId) {
      if (!confirm('ç¡®è®¤å°ç¦è¯¥ç”¨æˆ·ï¼Ÿå°ç¦åç”¨æˆ·å°†æ— æ³•ç™»å½•å’Œä½¿ç”¨ç³»ç»ŸåŠŸèƒ½ã€‚')) {
        return;
      }
      
      showLoading();
      
      try {
        // ä½¿ç”¨åç«¯å®é™…APIè·¯å¾„ï¼šPUT /api/v4/console/user-management/users/:user_id/status
        const response = await apiRequest(`/api/v4/console/user-management/users/${userId}/status`, {
          method: 'PUT',
          body: JSON.stringify({
            status: 'banned',  // è®¾ç½®ä¸ºå°ç¦çŠ¶æ€
            reason: 'ç®¡ç†å‘˜æ‰‹åŠ¨å°ç¦'
          })
        });
        
        if (response && response.success) {
          showSuccess('æ“ä½œæˆåŠŸ', 'ç”¨æˆ·å·²è¢«å°ç¦');
          loadUsers(true);
        } else {
          showError('æ“ä½œå¤±è´¥', response?.message || 'å°ç¦å¤±è´¥');
        }
      } catch (error) {
        console.error('å°ç¦ç”¨æˆ·å¤±è´¥:', error);
        showError('æ“ä½œå¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * è§£å°ç”¨æˆ·
     * @param {number} userId - ç”¨æˆ·ID
     */
    async function unbanUser(userId) {
      if (!confirm('ç¡®è®¤è§£å°è¯¥ç”¨æˆ·ï¼Ÿè§£å°åç”¨æˆ·å¯ä»¥æ­£å¸¸ç™»å½•å’Œä½¿ç”¨ç³»ç»ŸåŠŸèƒ½ã€‚')) {
        return;
      }
      
      showLoading();
      
      try {
        // ä½¿ç”¨åç«¯å®é™…APIè·¯å¾„ï¼šPUT /api/v4/console/user-management/users/:user_id/status
        const response = await apiRequest(`/api/v4/console/user-management/users/${userId}/status`, {
          method: 'PUT',
          body: JSON.stringify({
            status: 'active',  // è®¾ç½®ä¸ºæ­£å¸¸çŠ¶æ€
            reason: 'ç®¡ç†å‘˜æ‰‹åŠ¨è§£å°'
          })
        });
        
        if (response && response.success) {
          showSuccess('æ“ä½œæˆåŠŸ', 'ç”¨æˆ·å·²è§£å°');
          loadUsers(true);
        } else {
          showError('æ“ä½œå¤±è´¥', response?.message || 'è§£å°å¤±è´¥');
        }
      } catch (error) {
        console.error('è§£å°ç”¨æˆ·å¤±è´¥:', error);
        showError('æ“ä½œå¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * æ˜¾ç¤ºåŠ è½½çŠ¶æ€
     */
    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('show');
    }
    
    /**
     * éšè—åŠ è½½çŠ¶æ€
     */
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('show');
    }
    
    /**
     * æ˜¾ç¤ºæˆåŠŸæç¤º
     * @param {string} title - æ ‡é¢˜
     * @param {string} message - æ¶ˆæ¯
     */
    function showSuccess(title, message) {
      alert(`âœ… ${title}\n${message}`);
    }
    
    /**
     * æ˜¾ç¤ºé”™è¯¯æç¤º
     * @param {string} title - æ ‡é¢˜
     * @param {string} message - æ¶ˆæ¯
     */
    function showError(title, message) {
      alert(`âŒ ${title}\n${message}`);
    }
    
    // ========== ğŸ†• ç”¨æˆ·ä¸ªæ€§åŒ–æ¦‚ç‡è°ƒæ•´åŠŸèƒ½ ==========
    
    let currentProbabilityUserId = null;
    let allPrizes = []; // å­˜å‚¨æ‰€æœ‰å¥–å“æ•°æ®
    
    /**
     * æ‰“å¼€æ¦‚ç‡è°ƒæ•´æ¨¡æ€æ¡†
     * @param {number} userId - ç”¨æˆ·ID
     * @param {string} userMobile - ç”¨æˆ·æ‰‹æœºå·
     */
    async function openProbabilityModal(userId, userMobile) {
      currentProbabilityUserId = userId;
      
      // è®¾ç½®ç”¨æˆ·ä¿¡æ¯
      document.getElementById('probModalUserId').textContent = userId;
      document.getElementById('probModalUserMobile').textContent = userMobile;
      
      // åŠ è½½å¥–å“åˆ—è¡¨
      await loadPrizesForProbability();
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      new bootstrap.Modal(document.getElementById('probabilityModal')).show();
    }
    
    /**
     * åŠ è½½å¥–å“åˆ—è¡¨ï¼ˆç”¨äºç‰¹å®šå¥–å“è°ƒæ•´ï¼‰
     */
    async function loadPrizesForProbability() {
      try {
        // è°ƒç”¨åç«¯APIè·å–å¥–å“åˆ—è¡¨ï¼ˆä½¿ç”¨campaign_codeè€ŒéIDï¼‰
        const response = await apiRequest('/api/v4/console/prize-pool/BASIC_LOTTERY'); // é»˜è®¤æ´»åŠ¨ï¼šåŸºç¡€æŠ½å¥–
        
        if (response && response.success) {
          const prizes = response.data.prizes || [];
          allPrizes = prizes; // ä¿å­˜åˆ°å…¨å±€å˜é‡
          
          // å¡«å……å¥–å“ä¸‹æ‹‰åˆ—è¡¨
          const select = document.getElementById('targetPrizeSelect');
          select.innerHTML = '<option value="">è¯·é€‰æ‹©å¥–å“...</option>' +
            prizes.map(prize => {
              const probability = (parseFloat(prize.win_probability || 0) * 100).toFixed(1);
              return `<option value="${prize.prize_id}" data-probability="${prize.win_probability}">
                ${prize.prize_name} (å½“å‰æ¦‚ç‡${probability}%)
              </option>`;
            }).join('');
        }
      } catch (error) {
        console.error('åŠ è½½å¥–å“åˆ—è¡¨å¤±è´¥:', error);
      }
    }
    
    /**
     * åˆ‡æ¢è°ƒæ•´æ¨¡å¼ï¼ˆå…¨å±€/ç‰¹å®šï¼‰
     */
    function toggleAdjustmentMode() {
      const mode = document.querySelector('input[name="adjustmentMode"]:checked').value;
      
      const globalArea = document.getElementById('globalAdjustArea');
      const specificArea = document.getElementById('specificAdjustArea');
      
      if (mode === 'global') {
        globalArea.style.display = 'block';
        specificArea.style.display = 'none';
      } else {
        globalArea.style.display = 'none';
        specificArea.style.display = 'block';
      }
    }
    
    /**
     * æ›´æ–°æ¦‚ç‡é¢„è§ˆ
     */
    function updateProbabilityPreview() {
      const targetPrizeSelect = document.getElementById('targetPrizeSelect');
      const customProbabilityInput = document.getElementById('customProbability');
      
      const selectedPrizeId = parseInt(targetPrizeSelect.value);
      const newProbability = parseFloat(customProbabilityInput.value) / 100; // è½¬æ¢ä¸º0-1
      
      if (!selectedPrizeId || !newProbability) {
        document.getElementById('probabilityPreview').innerHTML = 
          '<p class="text-muted mb-0">è¯·é€‰æ‹©å¥–å“å¹¶è®¾ç½®æ¦‚ç‡</p>';
        return;
      }
      
      // è®¡ç®—è°ƒæ•´åçš„æ¦‚ç‡åˆ†å¸ƒ
      const targetPrize = allPrizes.find(p => p.prize_id === selectedPrizeId);
      if (!targetPrize) return;
      
      const originalProbability = parseFloat(targetPrize.win_probability);
      const otherPrizesTotalProb = allPrizes
        .filter(p => p.prize_id !== selectedPrizeId)
        .reduce((sum, p) => sum + parseFloat(p.win_probability || 0), 0);
      
      const remainingProb = 1.0 - newProbability;
      const scaleFactor = otherPrizesTotalProb > 0 ? remainingProb / otherPrizesTotalProb : 0;
      
      // ç”Ÿæˆé¢„è§ˆHTML
      let previewHtml = '<table class="table table-sm mb-0">';
      previewHtml += '<thead><tr><th>å¥–å“</th><th>åŸæ¦‚ç‡</th><th>â†’</th><th>æ–°æ¦‚ç‡</th></tr></thead>';
      previewHtml += '<tbody>';
      
      allPrizes.forEach(prize => {
        const originalProb = parseFloat(prize.win_probability || 0);
        let adjustedProb;
        let isTarget = false;
        
        if (prize.prize_id === selectedPrizeId) {
          adjustedProb = newProbability;
          isTarget = true;
        } else {
          adjustedProb = originalProb * scaleFactor;
        }
        
        const className = isTarget ? 'table-info' : '';
        previewHtml += `
          <tr class="${className}">
            <td>${prize.prize_name}${isTarget ? ' ğŸ¯' : ''}</td>
            <td>${(originalProb * 100).toFixed(1)}%</td>
            <td><i class="bi bi-arrow-right"></i></td>
            <td class="fw-bold ${isTarget ? 'text-info' : ''}">${(adjustedProb * 100).toFixed(1)}%</td>
          </tr>
        `;
      });
      
      const totalAdjusted = allPrizes.reduce((sum, prize) => {
        if (prize.prize_id === selectedPrizeId) return sum + newProbability;
        const originalProb = parseFloat(prize.win_probability || 0);
        return sum + (originalProb * scaleFactor);
      }, 0);
      
      previewHtml += `
        <tr class="table-light fw-bold">
          <td>æ€»è®¡</td>
          <td>100%</td>
          <td></td>
          <td>${(totalAdjusted * 100).toFixed(1)}%</td>
        </tr>
      `;
      previewHtml += '</tbody></table>';
      
      document.getElementById('probabilityPreview').innerHTML = previewHtml;
    }
    
    /**
     * ä¿å­˜æ¦‚ç‡è°ƒæ•´è®¾ç½®
     */
    async function saveProbabilityAdjustment() {
      if (!currentProbabilityUserId) {
        showError('é”™è¯¯', 'æœªé€‰æ‹©ç”¨æˆ·');
        return;
      }
      
      const mode = document.querySelector('input[name="adjustmentMode"]:checked').value;
      const durationMinutes = parseInt(document.getElementById('durationMinutes').value);
      const reason = document.getElementById('probabilityReason').value || 'ç®¡ç†å‘˜æ¦‚ç‡è°ƒæ•´';
      
      let requestData = {
        user_id: currentProbabilityUserId,
        duration_minutes: durationMinutes,
        reason: reason
      };
      
      if (mode === 'global') {
        // å…¨å±€å€æ•°è°ƒæ•´
        const multiplier = parseFloat(document.getElementById('probabilityMultiplier').value);
        if (!multiplier || multiplier < 0.1 || multiplier > 10) {
          showError('å‚æ•°é”™è¯¯', 'æ¦‚ç‡å€æ•°å¿…é¡»åœ¨0.1-10ä¹‹é—´');
          return;
        }
        requestData.probability_multiplier = multiplier;
      } else {
        // ç‰¹å®šå¥–å“è°ƒæ•´
        const prizeId = parseInt(document.getElementById('targetPrizeSelect').value);
        const customProb = parseFloat(document.getElementById('customProbability').value) / 100;
        
        if (!prizeId) {
          showError('å‚æ•°é”™è¯¯', 'è¯·é€‰æ‹©è¦è°ƒæ•´çš„å¥–å“');
          return;
        }
        
        if (!customProb || customProb < 0.01 || customProb > 1.0) {
          showError('å‚æ•°é”™è¯¯', 'è‡ªå®šä¹‰æ¦‚ç‡å¿…é¡»åœ¨1%-100%ä¹‹é—´');
          return;
        }
        
        requestData.prize_id = prizeId;
        requestData.custom_probability = customProb;
      }
      
      showLoading();
      
      try {
        // è°ƒç”¨åç«¯APIï¼šPOST /api/v4/console/lottery-management/probability-adjust
        const response = await apiRequest('/api/v4/console/lottery-management/probability-adjust', {
          method: 'POST',
          body: JSON.stringify(requestData)
        });
        
        if (response && response.success) {
          showSuccess('è®¾ç½®æˆåŠŸ', response.message || 'ç”¨æˆ·æ¦‚ç‡è°ƒæ•´æˆåŠŸ');
          bootstrap.Modal.getInstance(document.getElementById('probabilityModal')).hide();
          
          // é‡ç½®è¡¨å•
          document.getElementById('probabilityMultiplier').value = '2.0';
          document.getElementById('customProbability').value = '50';
          document.getElementById('targetPrizeSelect').value = '';
          document.getElementById('probabilityReason').value = '';
          document.getElementById('modeGlobal').checked = true;
          toggleAdjustmentMode();
        } else {
          showError('è®¾ç½®å¤±è´¥', response?.message || 'æ¦‚ç‡è°ƒæ•´å¤±è´¥');
        }
      } catch (error) {
        console.error('æ¦‚ç‡è°ƒæ•´å¤±è´¥:', error);
        showError('è®¾ç½®å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
  </script>
</body>
</html>

