<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>会话管理 - 管理后台</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">
  <style>
    .session-card {
      border-left: 4px solid;
      transition: all 0.3s ease;
    }
    .session-card:hover {
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .session-card.active { border-left-color: #198754; }
    .session-card.expired { border-left-color: #dc3545; }
    .session-card.revoked { border-left-color: #6c757d; }
    .device-icon {
      font-size: 1.5rem;
      opacity: 0.7;
    }
    .session-info {
      font-size: 0.85rem;
    }
    .current-session {
      background: #d1e7dd !important;
    }
  </style>
</head>
<body class="bg-light" x-data="sessionsPage()">
  <!-- 顶部导航 -->
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>🔐 管理后台 - 会话管理
      </a>
      <div>
        <span class="text-light me-3" x-text="userInfo ? `欢迎，${userInfo.nickname}` : '欢迎，管理员'"></span>
        <button class="btn btn-outline-light btn-sm" @click="logout()">退出登录</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- 统计卡片 -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-people text-primary" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">在线用户</h6>
            <h2 class="text-primary mb-0" x-text="statistics.onlineUsers"></h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-link-45deg text-success" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">活跃会话</h6>
            <h2 class="text-success mb-0" x-text="statistics.activeSessions"></h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-person text-warning" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">用户会话</h6>
            <h2 class="text-warning mb-0" x-text="statistics.userSessions"></h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-shield-check text-info" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">管理员会话</h6>
            <h2 class="text-info mb-0" x-text="statistics.adminSessions"></h2>
          </div>
        </div>
      </div>
    </div>

    <!-- 筛选栏 -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-center">
          <div class="col-md-2">
            <label class="form-label">状态</label>
            <select class="form-select" x-model="filters.status">
              <option value="">全部状态</option>
              <option value="active">活跃</option>
              <option value="expired">已过期/失效</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">用户类型</label>
            <select class="form-select" x-model="filters.userType">
              <option value="">全部类型</option>
              <option value="user">普通用户</option>
              <option value="admin">管理员</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">用户ID</label>
            <input type="number" class="form-control" x-model="filters.userId" placeholder="输入用户ID...">
          </div>
          <div class="col-md-3">
            <label class="form-label">排序方式</label>
            <select class="form-select" x-model="filters.sortBy">
              <option value="last_activity">最后活动时间</option>
              <option value="created_at">创建时间</option>
              <option value="expires_at">过期时间</option>
            </select>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-primary me-2" @click="loadSessions()">
              <i class="bi bi-search"></i> 搜索
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 批量操作 -->
    <div class="card mb-4">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <button class="btn btn-outline-danger me-2" @click="revokeSelected()">
            <i class="bi bi-x-circle"></i> 撤销选中
          </button>
          <button class="btn btn-outline-warning me-2" @click="revokeExpired()">
            <i class="bi bi-clock-history"></i> 清理过期
          </button>
          <button class="btn btn-outline-secondary" @click="revokeAllExceptCurrent()">
            <i class="bi bi-trash"></i> 强制下线其他设备
          </button>
        </div>
        <button class="btn btn-outline-primary" @click="loadSessions()">
          <i class="bi bi-arrow-clockwise"></i> 刷新
        </button>
      </div>
    </div>

    <!-- 加载状态 -->
    <template x-if="loading">
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">加载中...</span>
        </div>
        <p class="mt-2 text-muted">正在加载会话数据...</p>
      </div>
    </template>

    <!-- 会话列表 -->
    <div class="row" x-show="!loading">
      <!-- 空状态 -->
      <template x-if="sessions.length === 0 && !loading">
        <div class="col-12">
          <div class="card">
            <div class="card-body text-center py-5 text-muted">
              <i class="bi bi-link-45deg" style="font-size: 3rem;"></i>
              <p class="mt-2">暂无会话数据</p>
            </div>
          </div>
        </div>
      </template>

      <!-- 会话卡片 -->
      <template x-for="session in sessions" :key="session.user_session_id || session.session_id">
        <div class="col-md-6 col-lg-4 mb-4">
          <div 
            class="card session-card h-100"
            :class="[getSessionStatus(session), isCurrentSession(session) ? 'current-session' : '']"
          >
            <div class="card-body">
              <div class="d-flex align-items-start">
                <div class="form-check me-3">
                  <input 
                    type="checkbox" 
                    class="form-check-input session-checkbox" 
                    :value="session.user_session_id || session.session_id"
                    :disabled="isCurrentSession(session)"
                    x-model="selectedSessions"
                  >
                </div>
                <div class="device-icon me-3">
                  <i class="bi" :class="session.user_type === 'admin' ? 'bi-shield-check' : 'bi-person'"></i>
                </div>
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between">
                    <h6 class="mb-1">
                      用户 <span x-text="session.user_id"></span>
                      <span x-show="isCurrentSession(session)" class="badge bg-primary ms-2">当前会话</span>
                    </h6>
                    <span 
                      class="badge"
                      :class="getStatusBadgeClass(getSessionStatus(session))"
                      x-text="getStatusLabel(getSessionStatus(session))"
                    ></span>
                  </div>
                  <p class="session-info text-muted mb-1">
                    <i class="bi bi-globe"></i> <span x-text="session.login_ip || session.ip_address || '-'"></span>
                  </p>
                  <p class="session-info text-muted mb-1">
                    <i class="bi bi-person-badge"></i> <span x-text="session.user_type === 'admin' ? '管理员' : '普通用户'"></span>
                  </p>
                  <p class="session-info text-muted mb-0">
                    <i class="bi bi-clock"></i> 最后活动：<span x-text="formatRelativeTime(session.last_activity || session.last_active_at)"></span>
                  </p>
                </div>
              </div>
            </div>
            <div class="card-footer bg-white d-flex justify-content-between">
              <small class="text-muted">创建：<span x-text="formatDateTime(session.created_at)"></span></small>
              <div>
                <button class="btn btn-sm btn-outline-primary me-1" @click="viewSessionDetail(session)">
                  <i class="bi bi-eye"></i>
                </button>
                <button 
                  x-show="!isCurrentSession(session) && getSessionStatus(session) === 'active'"
                  class="btn btn-sm btn-outline-danger" 
                  @click="revokeSession(session.user_session_id || session.session_id)"
                >
                  <i class="bi bi-x-lg"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </template>
    </div>

    <!-- 分页 -->
    <nav aria-label="Page navigation" class="mt-4" x-show="totalPages > 1">
      <ul class="pagination justify-content-center">
        <li class="page-item" :class="{ 'disabled': currentPage === 1 }">
          <a class="page-link" href="#" @click.prevent="loadSessions(currentPage - 1)">上一页</a>
        </li>
        <template x-for="page in getPaginationPages()" :key="page">
          <li class="page-item" :class="{ 'active': page === currentPage, 'disabled': page === '...' }">
            <a class="page-link" href="#" @click.prevent="page !== '...' && loadSessions(page)" x-text="page"></a>
          </li>
        </template>
        <li class="page-item" :class="{ 'disabled': currentPage === totalPages }">
          <a class="page-link" href="#" @click.prevent="loadSessions(currentPage + 1)">下一页</a>
        </li>
      </ul>
    </nav>
  </div>

  <!-- 会话详情模态框 -->
  <div class="modal fade" id="sessionDetailModal" tabindex="-1" x-ref="sessionDetailModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-info-circle"></i> 会话详情</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" x-show="selectedSession">
          <table class="table table-sm">
            <tr><th style="width:35%">会话ID</th><td><code x-text="selectedSession?.user_session_id || selectedSession?.session_id"></code></td></tr>
            <tr><th>用户ID</th><td x-text="selectedSession?.user_id"></td></tr>
            <tr><th>用户昵称</th><td x-text="selectedSession?.user_info?.nickname || '-'"></td></tr>
            <tr><th>用户类型</th><td x-text="selectedSession?.user_type === 'admin' ? '管理员' : '普通用户'"></td></tr>
            <tr><th>状态</th><td><span class="badge" :class="getStatusBadgeClass(getSessionStatus(selectedSession))" x-text="getStatusLabel(getSessionStatus(selectedSession))"></span></td></tr>
            <tr><th>IP地址</th><td x-text="selectedSession?.login_ip || selectedSession?.ip_address || '-'"></td></tr>
            <tr><th>是否过期</th><td x-text="selectedSession?.is_expired ? '是' : '否'"></td></tr>
            <tr><th>是否有效</th><td x-text="selectedSession?.is_valid ? '是' : '否'"></td></tr>
            <tr><th>创建时间</th><td x-text="formatDateTime(selectedSession?.created_at)"></td></tr>
            <tr><th>最后活动</th><td x-text="formatDateTime(selectedSession?.last_activity || selectedSession?.last_active_at)"></td></tr>
            <tr><th>过期时间</th><td x-text="formatDateTime(selectedSession?.expires_at)"></td></tr>
          </table>
          <div x-show="isCurrentSession(selectedSession)" class="alert alert-info mb-0">
            <i class="bi bi-info-circle"></i> 这是您当前的会话，无法撤销
          </div>
        </div>
        <div class="modal-footer">
          <button 
            type="button" 
            class="btn btn-danger"
            x-show="selectedSession && !isCurrentSession(selectedSession) && getSessionStatus(selectedSession) === 'active'"
            @click="revokeSessionFromModal()"
          >撤销会话</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 全局加载遮罩 -->
  <div class="loading-overlay" x-show="globalLoading" x-cloak>
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">加载中...</span>
    </div>
  </div>

  <!-- ✅ JavaScript 加载顺序 -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script src="/admin/js/api-config.js"></script>
  <script src="/admin/js/alpine/init.js"></script>
  <script src="/admin/js/pages/sessions.js"></script>
  <script defer src="/admin/js/vendor/alpine.min.js"></script>
</body>
</html>
