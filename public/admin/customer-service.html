<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- âœ… CSPç­–ç•¥ - å…è®¸åŠ è½½æœ¬åœ°è„šæœ¬å’ŒWebSocketè¿æ¥ -->
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; 
                 script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; 
                 style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; 
                 font-src 'self' https://cdn.jsdelivr.net; 
                 connect-src 'self' ws: wss: http://localhost:* https://localhost:*; 
                 img-src 'self' data: https:;"
    />

    <title>å®¢æœå·¥ä½œå° - ç®¡ç†åå°</title>

    <!-- âœ… Bootstrap 5 - UIæ¡†æ¶ -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- âœ… Bootstrap Icons - å›¾æ ‡åº“ -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- âœ… å…¬å…±æ ·å¼è¡¨ - ç»Ÿä¸€ä¸»é¢˜å’Œå“åº”å¼è®¾è®¡ -->
    <link href="/admin/css/common.css" rel="stylesheet" />

    <!-- âœ… é¡µé¢ç‰¹æœ‰æ ·å¼ -->
    <style>
      body {
        height: 100vh;
        overflow: hidden;
      }
      .cs-container {
        height: calc(100vh - 56px);
        display: flex;
      }
      .sessions-sidebar {
        width: 320px;
        border-right: 1px solid #dee2e6;
        display: flex;
        flex-direction: column;
        background: #f8f9fa;
      }
      .session-item {
        padding: 12px 16px;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
        transition: background 0.2s;
      }
      .session-item:hover {
        background: #e9ecef;
      }
      .session-item.active {
        background: #fff;
        border-left: 3px solid #0d6efd;
      }
      .session-item .unread-badge {
        background: #dc3545;
        color: white;
        border-radius: 10px;
        padding: 2px 8px;
        font-size: 0.75rem;
        font-weight: bold;
      }
      .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #fff;
        overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
        min-height: 0; /* å…è®¸flexå­é¡¹æ”¶ç¼© */
      }
      .chat-interface {
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .chat-header {
        padding: 16px 20px;
        border-bottom: 1px solid #dee2e6;
        background: #fff;
        flex-shrink: 0; /* é˜²æ­¢å¤´éƒ¨è¢«å‹ç¼© */
      }
      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f5f5f5;
        min-height: 0; /* å…³é”®ï¼šå…è®¸flexå­é¡¹æ»šåŠ¨ */
      }
      .message-item {
        margin-bottom: 16px;
        display: flex;
        align-items: flex-start;
      }
      .message-item.user-message {
        justify-content: flex-start;
      }
      .message-item.admin-message {
        justify-content: flex-end;
      }
      .message-bubble {
        max-width: 60%;
        padding: 10px 14px;
        border-radius: 12px;
        word-wrap: break-word;
      }
      .user-message .message-bubble {
        background: #fff;
        border: 1px solid #dee2e6;
      }
      .admin-message .message-bubble {
        background: #0d6efd;
        color: white;
      }
      .message-time {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 4px;
      }
      .chat-input-area {
        padding: 16px 20px;
        border-top: 1px solid #dee2e6;
        background: #fff;
        flex-shrink: 0; /* é˜²æ­¢æ”¾å¤§æ—¶è¢«å‹ç¼© */
      }
      .quick-replies {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }
    </style>
  </head>
  <body class="bg-light">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="navbar navbar-dark bg-primary">
      <div class="container-fluid">
        <a href="/admin/dashboard.html" class="navbar-brand">
          <i class="bi bi-arrow-left me-2"></i>ğŸ’¬ ç®¡ç†åå° - å®¢æœå·¥ä½œå°
        </a>
        <div>
          <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
          <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
        </div>
      </div>
    </nav>

    <!-- å®¢æœå·¥ä½œå°ä¸»ä½“ -->
    <div class="cs-container">
      <!-- ä¼šè¯åˆ—è¡¨ä¾§è¾¹æ  -->
      <div class="sessions-sidebar">
        <!-- ç­›é€‰å™¨ -->
        <div class="p-3 border-bottom bg-white">
          <div class="input-group input-group-sm mb-2">
            <input type="text" class="form-control" id="sessionSearch" placeholder="æœç´¢ç”¨æˆ·..." />
            <button class="btn btn-outline-secondary" id="sessionSearchBtn">
              <i class="bi bi-search"></i>
            </button>
          </div>
          <select class="form-select form-select-sm" id="sessionStatusFilter">
            <option value="all">å…¨éƒ¨ä¼šè¯</option>
            <option value="waiting">å¾…å¤„ç†</option>
            <option value="active">è¿›è¡Œä¸­</option>
            <option value="closed">å·²å…³é—­</option>
          </select>
        </div>

        <!-- ä¼šè¯åˆ—è¡¨ -->
        <div class="flex-fill overflow-auto" id="sessionsList">
          <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">åŠ è½½ä¸­...</span>
            </div>
            <p class="mt-2 text-muted small">æ­£åœ¨åŠ è½½ä¼šè¯...</p>
          </div>
        </div>
      </div>

      <!-- èŠå¤©ä¸»åŒºåŸŸ -->
      <div class="chat-main">
        <!-- é»˜è®¤ç©ºçŠ¶æ€ -->
        <div id="emptyState" class="h-100 d-flex align-items-center justify-content-center">
          <div class="text-center text-muted">
            <i class="bi bi-chat-dots" style="font-size: 4rem"></i>
            <p class="mt-3">è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªä¼šè¯å¼€å§‹èŠå¤©</p>
          </div>
        </div>

        <!-- èŠå¤©ç•Œé¢ï¼ˆéšè—ï¼‰ -->
        <div
          id="chatInterface"
          class="chat-interface"
          style="display: none"
        >
          <!-- èŠå¤©å¤´éƒ¨ -->
          <div class="chat-header">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <img
                  id="chatUserAvatar"
                  src=""
                  class="rounded-circle me-3"
                  style="width: 40px; height: 40px"
                  alt="å¤´åƒ"
                />
                <div>
                  <h6 class="mb-0" id="chatUserName">ç”¨æˆ·æ˜µç§°</h6>
                  <small class="text-muted" id="chatUserMobile">æ‰‹æœºå·</small>
                </div>
              </div>
              <div>
                <button class="btn btn-sm btn-outline-primary me-2" id="transferSessionBtn">
                  <i class="bi bi-arrow-left-right"></i> è½¬æ¥
                </button>
                <button class="btn btn-sm btn-outline-success me-2" id="closeSessionBtn">
                  <i class="bi bi-check-circle"></i> ç»“æŸä¼šè¯
                </button>
                <button class="btn btn-sm btn-outline-info" id="viewUserInfoBtn">
                  <i class="bi bi-person-circle"></i> ç”¨æˆ·ä¿¡æ¯
                </button>
              </div>
            </div>
          </div>

          <!-- æ¶ˆæ¯åŒºåŸŸ -->
          <div class="chat-messages" id="chatMessages">
            <!-- æ¶ˆæ¯å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
          </div>

          <!-- è¾“å…¥åŒºåŸŸ -->
          <div class="chat-input-area">
            <!-- å¿«æ·å›å¤ -->
            <div class="quick-replies">
              <button
                class="btn btn-sm btn-outline-secondary quick-reply-btn"
                data-reply="æ‚¨å¥½ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ"
              >
                ğŸ‘‹ æ¬¢è¿è¯­
              </button>
              <button
                class="btn btn-sm btn-outline-secondary quick-reply-btn"
                data-reply="è¯·ç¨ç­‰ï¼Œæˆ‘ä¸ºæ‚¨æŸ¥è¯¢ä¸€ä¸‹"
              >
                â³ æŸ¥è¯¢ä¸­
              </button>
              <button
                class="btn btn-sm btn-outline-secondary quick-reply-btn"
                data-reply="æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼Œæˆ‘ä»¬ä¼šå°½å¿«å¤„ç†"
              >
                ğŸ™ æ„Ÿè°¢åé¦ˆ
              </button>
              <button
                class="btn btn-sm btn-outline-secondary quick-reply-btn"
                data-reply="ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼"
              >
                ğŸ˜Š ç¥ç¦è¯­
              </button>
            </div>

            <!-- è¾“å…¥æ¡† -->
            <div class="input-group">
              <textarea
                class="form-control"
                id="messageInput"
                rows="3"
                placeholder="è¾“å…¥æ¶ˆæ¯...æŒ‰Enterå‘é€ï¼ŒShift+Enteræ¢è¡Œ"
              ></textarea>
              <button class="btn btn-primary" id="sendMessageBtn">
                <i class="bi bi-send"></i> å‘é€
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç”¨æˆ·ä¿¡æ¯æ¨¡æ€æ¡† -->
    <div class="modal fade" id="userInfoModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-person-circle"></i> ç”¨æˆ·è¯¦ç»†ä¿¡æ¯</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="userInfoBody">
            <!-- ç”¨æˆ·ä¿¡æ¯å°†åŠ¨æ€åŠ è½½ -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
          </div>
        </div>
      </div>
    </div>

    <!-- è½¬æ¥ä¼šè¯æ¨¡æ€æ¡† -->
    <div class="modal fade" id="transferModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-arrow-left-right"></i> è½¬æ¥ä¼šè¯</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <label class="form-label">é€‰æ‹©æ¥æ”¶å®¢æœ</label>
            <select class="form-select" id="transferTargetSelect">
              <option value="">è¯·é€‰æ‹©...</option>
              <!-- å®¢æœåˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
            </select>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" id="submitTransferBtn">ç¡®è®¤è½¬æ¥</button>
          </div>
        </div>
      </div>
    </div>

    <!-- åŠ è½½é®ç½©å±‚ -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner-border text-light" style="width: 3rem; height: 3rem" role="status">
        <span class="visually-hidden">å¤„ç†ä¸­...</span>
      </div>
    </div>

    <!-- âœ… Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- âœ… Socket.IOå®¢æˆ·ç«¯åº“ -->
    <!-- âœ… Socket.IOå®¢æˆ·ç«¯åº“ - æœ¬åœ°ç‰ˆæœ¬ï¼ˆå®‰å…¨ï¼Œä¸ä¾èµ–å¤–éƒ¨CDNï¼‰ -->
    <script src="/admin/js/vendor/socket.io.min.js"></script>

    <!-- âœ… å¼•å…¥é€šç”¨å·¥å…·åº“ -->
    <script src="/admin/js/admin-common.js"></script>

    <!-- âœ… å®¢æœå·¥ä½œå°é¡µé¢é€»è¾‘ -->
    <script src="/admin/js/pages/customer-service.js"></script>
  </body>
</html>
