<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- âœ… CSPç­–ç•¥ - å…è®¸åŠ è½½æœ¬åœ°è„šæœ¬å’ŒWebSocketè¿æ¥ -->
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; 
                 script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; 
                 style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; 
                 font-src 'self' https://cdn.jsdelivr.net; 
                 connect-src 'self' ws: wss: http://localhost:* https://localhost:*; 
                 img-src 'self' data: https:;"
    />

    <title>å®¢æœå·¥ä½œå° - ç®¡ç†åå°</title>

    <!-- âœ… Bootstrap 5 - UIæ¡†æ¶ -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- âœ… Bootstrap Icons - å›¾æ ‡åº“ -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- âœ… å…¬å…±æ ·å¼è¡¨ - ç»Ÿä¸€ä¸»é¢˜å’Œå“åº”å¼è®¾è®¡ -->
    <link href="/admin/css/common.css" rel="stylesheet" />

    <!-- âœ… é¡µé¢ç‰¹æœ‰æ ·å¼ -->
    <style>
      body {
        height: 100vh;
        overflow: hidden;
      }
      .cs-container {
        height: calc(100vh - 56px);
        display: flex;
      }
      .sessions-sidebar {
        width: 320px;
        border-right: 1px solid #dee2e6;
        display: flex;
        flex-direction: column;
        background: #f8f9fa;
      }
      .session-item {
        padding: 12px 16px;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
        transition: background 0.2s;
      }
      .session-item:hover {
        background: #e9ecef;
      }
      .session-item.active {
        background: #fff;
        border-left: 3px solid #0d6efd;
      }
      .session-item .unread-badge {
        background: #dc3545;
        color: white;
        border-radius: 10px;
        padding: 2px 8px;
        font-size: 0.75rem;
        font-weight: bold;
      }
      .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #fff;
      }
      .chat-header {
        padding: 16px 20px;
        border-bottom: 1px solid #dee2e6;
        background: #fff;
      }
      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .message-item {
        margin-bottom: 16px;
        display: flex;
        align-items: flex-start;
      }
      .message-item.user-message {
        justify-content: flex-start;
      }
      .message-item.admin-message {
        justify-content: flex-end;
      }
      .message-bubble {
        max-width: 60%;
        padding: 10px 14px;
        border-radius: 12px;
        word-wrap: break-word;
      }
      .user-message .message-bubble {
        background: #fff;
        border: 1px solid #dee2e6;
      }
      .admin-message .message-bubble {
        background: #0d6efd;
        color: white;
      }
      .message-time {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 4px;
      }
      .chat-input-area {
        padding: 16px 20px;
        border-top: 1px solid #dee2e6;
        background: #fff;
      }
      .quick-replies {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }
    </style>
  </head>
  <body class="bg-light">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="navbar navbar-dark bg-primary">
      <div class="container-fluid">
        <a href="/admin/dashboard.html" class="navbar-brand">
          <i class="bi bi-arrow-left me-2"></i>ğŸ’¬ ç®¡ç†åå° - å®¢æœå·¥ä½œå°
        </a>
        <div>
          <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
          <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
        </div>
      </div>
    </nav>

    <!-- å®¢æœå·¥ä½œå°ä¸»ä½“ -->
    <div class="cs-container">
      <!-- ä¼šè¯åˆ—è¡¨ä¾§è¾¹æ  -->
      <div class="sessions-sidebar">
        <!-- ç­›é€‰å™¨ -->
        <div class="p-3 border-bottom bg-white">
          <div class="input-group input-group-sm mb-2">
            <input type="text" class="form-control" id="sessionSearch" placeholder="æœç´¢ç”¨æˆ·..." />
            <button class="btn btn-outline-secondary" id="sessionSearchBtn">
              <i class="bi bi-search"></i>
            </button>
          </div>
          <select class="form-select form-select-sm" id="sessionStatusFilter">
            <option value="all">å…¨éƒ¨ä¼šè¯</option>
            <option value="waiting">å¾…å¤„ç†</option>
            <option value="active">è¿›è¡Œä¸­</option>
            <option value="closed">å·²å…³é—­</option>
          </select>
        </div>

        <!-- ä¼šè¯åˆ—è¡¨ -->
        <div class="flex-fill overflow-auto" id="sessionsList">
          <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">åŠ è½½ä¸­...</span>
            </div>
            <p class="mt-2 text-muted small">æ­£åœ¨åŠ è½½ä¼šè¯...</p>
          </div>
        </div>
      </div>

      <!-- èŠå¤©ä¸»åŒºåŸŸ -->
      <div class="chat-main">
        <!-- é»˜è®¤ç©ºçŠ¶æ€ -->
        <div id="emptyState" class="h-100 d-flex align-items-center justify-content-center">
          <div class="text-center text-muted">
            <i class="bi bi-chat-dots" style="font-size: 4rem"></i>
            <p class="mt-3">è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªä¼šè¯å¼€å§‹èŠå¤©</p>
          </div>
        </div>

        <!-- èŠå¤©ç•Œé¢ï¼ˆéšè—ï¼‰ -->
        <div
          id="chatInterface"
          style="display: none; height: 100%; display: flex; flex-direction: column"
        >
          <!-- èŠå¤©å¤´éƒ¨ -->
          <div class="chat-header">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <img
                  id="chatUserAvatar"
                  src=""
                  class="rounded-circle me-3"
                  style="width: 40px; height: 40px"
                  alt="å¤´åƒ"
                />
                <div>
                  <h6 class="mb-0" id="chatUserName">ç”¨æˆ·æ˜µç§°</h6>
                  <small class="text-muted" id="chatUserMobile">æ‰‹æœºå·</small>
                </div>
              </div>
              <div>
                <button class="btn btn-sm btn-outline-primary me-2" id="transferSessionBtn">
                  <i class="bi bi-arrow-left-right"></i> è½¬æ¥
                </button>
                <button class="btn btn-sm btn-outline-success me-2" id="closeSessionBtn">
                  <i class="bi bi-check-circle"></i> ç»“æŸä¼šè¯
                </button>
                <button class="btn btn-sm btn-outline-info" id="viewUserInfoBtn">
                  <i class="bi bi-person-circle"></i> ç”¨æˆ·ä¿¡æ¯
                </button>
              </div>
            </div>
          </div>

          <!-- æ¶ˆæ¯åŒºåŸŸ -->
          <div class="chat-messages" id="chatMessages">
            <!-- æ¶ˆæ¯å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
          </div>

          <!-- è¾“å…¥åŒºåŸŸ -->
          <div class="chat-input-area">
            <!-- å¿«æ·å›å¤ -->
            <div class="quick-replies">
              <button
                class="btn btn-sm btn-outline-secondary quick-reply-btn"
                data-reply="æ‚¨å¥½ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ"
              >
                ğŸ‘‹ æ¬¢è¿è¯­
              </button>
              <button
                class="btn btn-sm btn-outline-secondary quick-reply-btn"
                data-reply="è¯·ç¨ç­‰ï¼Œæˆ‘ä¸ºæ‚¨æŸ¥è¯¢ä¸€ä¸‹"
              >
                â³ æŸ¥è¯¢ä¸­
              </button>
              <button
                class="btn btn-sm btn-outline-secondary quick-reply-btn"
                data-reply="æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼Œæˆ‘ä»¬ä¼šå°½å¿«å¤„ç†"
              >
                ğŸ™ æ„Ÿè°¢åé¦ˆ
              </button>
              <button
                class="btn btn-sm btn-outline-secondary quick-reply-btn"
                data-reply="ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼"
              >
                ğŸ˜Š ç¥ç¦è¯­
              </button>
            </div>

            <!-- è¾“å…¥æ¡† -->
            <div class="input-group">
              <textarea
                class="form-control"
                id="messageInput"
                rows="3"
                placeholder="è¾“å…¥æ¶ˆæ¯...æŒ‰Enterå‘é€ï¼ŒShift+Enteræ¢è¡Œ"
              ></textarea>
              <button class="btn btn-primary" id="sendMessageBtn">
                <i class="bi bi-send"></i> å‘é€
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç”¨æˆ·ä¿¡æ¯æ¨¡æ€æ¡† -->
    <div class="modal fade" id="userInfoModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-person-circle"></i> ç”¨æˆ·è¯¦ç»†ä¿¡æ¯</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="userInfoBody">
            <!-- ç”¨æˆ·ä¿¡æ¯å°†åŠ¨æ€åŠ è½½ -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
          </div>
        </div>
      </div>
    </div>

    <!-- è½¬æ¥ä¼šè¯æ¨¡æ€æ¡† -->
    <div class="modal fade" id="transferModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-arrow-left-right"></i> è½¬æ¥ä¼šè¯</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <label class="form-label">é€‰æ‹©æ¥æ”¶å®¢æœ</label>
            <select class="form-select" id="transferTargetSelect">
              <option value="">è¯·é€‰æ‹©...</option>
              <!-- å®¢æœåˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
            </select>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" id="submitTransferBtn">ç¡®è®¤è½¬æ¥</button>
          </div>
        </div>
      </div>
    </div>

    <!-- åŠ è½½é®ç½©å±‚ -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner-border text-light" style="width: 3rem; height: 3rem" role="status">
        <span class="visually-hidden">å¤„ç†ä¸­...</span>
      </div>
    </div>

    <!-- âœ… Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- âœ… Socket.IOå®¢æˆ·ç«¯åº“ -->
    <!-- âœ… Socket.IOå®¢æˆ·ç«¯åº“ - æœ¬åœ°ç‰ˆæœ¬ï¼ˆå®‰å…¨ï¼Œä¸ä¾èµ–å¤–éƒ¨CDNï¼‰ -->
    <script src="/admin/js/vendor/socket.io.min.js"></script>

    <!-- âœ… å¼•å…¥é€šç”¨å·¥å…·åº“ -->
    <script src="/admin/js/admin-common.js"></script>

    <script>
      /**
       * å…¨å±€å˜é‡
       */
      let currentSessionId = null
      let allSessions = []
      let wsConnection = null
      let messagePollingInterval = null

      /**
       * é¡µé¢åˆå§‹åŒ–
       */
      document.addEventListener('DOMContentLoaded', function () {
        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        const userInfo = getCurrentUser()
        if (userInfo && userInfo.nickname) {
          document.getElementById('welcomeText').textContent = `æ¬¢è¿ï¼Œ${userInfo.nickname}`
        }

        // åŠ è½½ä¼šè¯åˆ—è¡¨
        loadSessions()

        // åŠ è½½å®¢æœåˆ—è¡¨ï¼ˆç”¨äºè½¬æ¥ï¼‰
        loadAdminList()

        // åˆå§‹åŒ–WebSocketè¿æ¥
        initWebSocket()

        // ===== é™æ€æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨ =====
        // é€€å‡ºç™»å½•æŒ‰é’®
        document.getElementById('logoutBtn').addEventListener('click', logout)

        // æœç´¢æŒ‰é’®
        document.getElementById('sessionSearchBtn').addEventListener('click', () => loadSessions())

        // çŠ¶æ€ç­›é€‰å™¨
        document
          .getElementById('sessionStatusFilter')
          .addEventListener('change', () => loadSessions())

        // æœç´¢æ¡†å›è½¦æœç´¢
        document.getElementById('sessionSearch').addEventListener('keypress', e => {
          if (e.key === 'Enter') {
            loadSessions()
          }
        })

        // èŠå¤©å¤´éƒ¨æŒ‰é’®
        document.getElementById('transferSessionBtn').addEventListener('click', transferSession)
        document.getElementById('closeSessionBtn').addEventListener('click', closeSession)
        document.getElementById('viewUserInfoBtn').addEventListener('click', viewUserInfo)

        // å‘é€æ¶ˆæ¯æŒ‰é’®
        document.getElementById('sendMessageBtn').addEventListener('click', sendMessage)

        // ç¡®è®¤è½¬æ¥æŒ‰é’®
        document.getElementById('submitTransferBtn').addEventListener('click', submitTransfer)

        // è¾“å…¥æ¡†å›è½¦å‘é€
        document.getElementById('messageInput').addEventListener('keydown', function (e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault()
            sendMessage()
          }
        })

        // ===== äº‹ä»¶å§”æ‰˜ï¼šä¼šè¯åˆ—è¡¨é¡¹ =====
        document.getElementById('sessionsList').addEventListener('click', e => {
          const sessionItem = e.target.closest('.session-item')
          if (sessionItem) {
            const sessionId = parseInt(sessionItem.dataset.sessionId)
            if (!isNaN(sessionId)) {
              openSession(sessionId)
            }
          }
        })

        // ===== äº‹ä»¶å§”æ‰˜ï¼šå¿«æ·å›å¤æŒ‰é’® =====
        document.querySelector('.quick-replies').addEventListener('click', e => {
          const quickReplyBtn = e.target.closest('.quick-reply-btn')
          if (quickReplyBtn) {
            const replyText = quickReplyBtn.dataset.reply
            insertQuickReply(replyText)
          }
        })

        // ===== å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç† =====
        // å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç† - ä½¿ç”¨Bootstrap Iconsä½œä¸ºé»˜è®¤å¤´åƒå ä½ç¬¦
        document.getElementById('sessionsList').addEventListener(
          'error',
          e => {
            if (e.target.classList.contains('session-avatar-img')) {
              // æ›¿æ¢ä¸ºå ä½ç¬¦å›¾æ ‡ï¼ˆä½¿ç”¨data URIé¿å…é¢å¤–è¯·æ±‚å’Œ404é”™è¯¯ï¼‰
              e.target.src =
                'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgZmlsbD0iI2NjYyIgY2xhc3M9ImJpIGJpLXBlcnNvbi1jaXJjbGUiIHZpZXdCb3g9IjAgMCAxNiAxNiI+PHBhdGggZD0iTTExIDZhMyAzIDAgMSAxLTYgMCAzIDMgMCAwIDEgNiAweiIvPjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgZD0iTTAgOGE4IDggMCAxIDEgMTYgMEE4IDggMCAwIDEgMCA4em04IDdhNyA3IDAgMCAwIDUuMzg3LTIuNTAzQTEzLjkzMyAxMy45MzMgMCAwIDAgOCAxMS41YTEzLjkzMyAxMy45MzMgMCAwIDAtNS4zODcgMS4wMDdBNyA3IDAgMCAwIDggMTV6Ii8+PC9zdmc+'
              e.target.alt = 'é»˜è®¤å¤´åƒ'
            }
          },
          true
        )

        // å®šæœŸè½®è¯¢åˆ·æ–°ä¼šè¯åˆ—è¡¨ï¼ˆ30ç§’ï¼‰
        setInterval(() => loadSessions(true), 30000)
      })

      /**
       * åˆå§‹åŒ–WebSocketè¿æ¥ï¼ˆä½¿ç”¨Socket.IOï¼‰
       */
      function initWebSocket() {
        try {
          // ä½¿ç”¨Socket.IOè¿æ¥
          wsConnection = io({
            auth: {
              token: getToken()
            },
            transports: ['websocket', 'polling']
          })

          wsConnection.on('connect', () => {
            console.log('âœ… WebSocketè¿æ¥æˆåŠŸ')
            // Socket.IOä¼šè‡ªåŠ¨å‘é€authä¿¡æ¯
          })

          wsConnection.on('message', data => {
            handleWebSocketMessage(data)
          })

          wsConnection.on('new_message', data => {
            handleWebSocketMessage({ type: 'new_message', ...data })
          })

          wsConnection.on('session_update', data => {
            handleWebSocketMessage({ type: 'session_update', ...data })
          })

          wsConnection.on('error', error => {
            console.error('WebSocketé”™è¯¯:', error)
          })

          wsConnection.on('disconnect', reason => {
            console.log('WebSocketè¿æ¥å·²æ–­å¼€:', reason)
          })

          wsConnection.on('connect_error', error => {
            console.error('WebSocketè¿æ¥å¤±è´¥:', error)
          })
        } catch (error) {
          console.error('WebSocketåˆå§‹åŒ–å¤±è´¥:', error)
        }
      }

      /**
       * å¤„ç†WebSocketæ¶ˆæ¯
       * @param {Object} data - æ¶ˆæ¯æ•°æ®
       */
      function handleWebSocketMessage(data) {
        switch (data.type) {
          case 'new_message':
            // æ–°æ¶ˆæ¯åˆ°è¾¾
            if (data.session_id === currentSessionId) {
              appendMessage(data.message)
              scrollToBottom()
            }
            // æ›´æ–°ä¼šè¯åˆ—è¡¨ï¼ˆæ˜¾ç¤ºæœªè¯»æ ‡è®°ï¼‰
            loadSessions(true)
            break

          case 'new_session':
            // æ–°ä¼šè¯åˆ›å»º
            loadSessions(true)
            break

          case 'session_closed':
            // ä¼šè¯å·²å…³é—­
            if (data.session_id === currentSessionId) {
              alert('å½“å‰ä¼šè¯å·²è¢«å…³é—­')
              closeCurrentChat()
            }
            loadSessions(true)
            break
        }
      }

      /**
       * åŠ è½½ä¼šè¯åˆ—è¡¨
       * @param {boolean} silent - æ˜¯å¦é™é»˜åˆ·æ–°
       */
      async function loadSessions(silent = false) {
        if (!silent) {
          showLoading()
        }

        try {
          const status = document.getElementById('sessionStatusFilter').value
          const search = document.getElementById('sessionSearch').value.trim()

          const params = new URLSearchParams()
          if (status !== 'all') {
            params.append('status', status)
          }
          if (search) {
            params.append('search', search)
          }

          const response = await apiRequest(
            `/api/v4/admin/customer-service/sessions?${params.toString()}`
          )

          if (response && response.success) {
            allSessions = response.data.sessions || response.data.list || []
            renderSessions(allSessions)
          } else {
            if (!silent) {
              showError('åŠ è½½å¤±è´¥', response?.message || 'è·å–ä¼šè¯åˆ—è¡¨å¤±è´¥')
            }
          }
        } catch (error) {
          console.error('åŠ è½½ä¼šè¯å¤±è´¥:', error)
          if (!silent) {
            showError('åŠ è½½å¤±è´¥', error.message)
          }
        } finally {
          if (!silent) {
            hideLoading()
          }
        }
      }

      /**
       * æ¸²æŸ“ä¼šè¯åˆ—è¡¨
       * @param {Array} sessions - ä¼šè¯æ•°ç»„
       */
      function renderSessions(sessions) {
        const container = document.getElementById('sessionsList')

        if (sessions.length === 0) {
          container.innerHTML = `
          <div class="text-center py-5">
            <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
            <p class="mt-2 text-muted small">æš‚æ— ä¼šè¯</p>
          </div>
        `
          return
        }

        // ä½¿ç”¨Bootstrap Iconsçš„SVGä½œä¸ºé»˜è®¤å¤´åƒï¼ˆBase64ç¼–ç ï¼‰
        const defaultAvatar =
          'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgZmlsbD0iI2NjYyIgY2xhc3M9ImJpIGJpLXBlcnNvbi1jaXJjbGUiIHZpZXdCb3g9IjAgMCAxNiAxNiI+PHBhdGggZD0iTTExIDZhMyAzIDAgMSAxLTYgMCAzIDMgMCAwIDEgNiAweiIvPjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgZD0iTTAgOGE4IDggMCAxIDEgMTYgMEE4IDggMCAwIDEgMCA4em04IDdhNyA3IDAgMCAwIDUuMzg3LTIuNTAzQTEzLjkzMyAxMy45MzMgMCAwIDAgOCAxMS41YTEzLjkzMyAxMy45MzMgMCAwIDAtNS4zODcgMS4wMDdBNyA3IDAgMCAwIDggMTV6Ii8+PC9zdmc+'

        container.innerHTML = sessions
          .map(
            session => `
        <div class="session-item ${session.session_id === currentSessionId ? 'active' : ''}" 
             data-session-id="${session.session_id}">
          <div class="d-flex justify-content-between align-items-start mb-1">
            <div class="d-flex align-items-center flex-fill">
              <img src="${session.user_avatar || defaultAvatar}" 
                   class="rounded-circle me-2 session-avatar-img" 
                   style="width: 36px; height: 36px;"
                   alt="å¤´åƒ"
                   onerror="this.src='${defaultAvatar}'">
              <div class="flex-fill">
                <div class="fw-bold small">${session.user_nickname || 'æœªå‘½åç”¨æˆ·'}</div>
                <div class="text-muted" style="font-size: 0.75rem;">${maskPhone(session.user_mobile || '')}</div>
              </div>
            </div>
            ${
              session.unread_count > 0
                ? `<span class="unread-badge">${session.unread_count}</span>`
                : ''
            }
          </div>
          <div class="text-muted small text-truncate">${session.last_message || 'æš‚æ— æ¶ˆæ¯'}</div>
          <div class="d-flex justify-content-between align-items-center mt-1">
            <span class="badge ${getSessionStatusBadge(session.status)}">${getSessionStatusText(session.status)}</span>
            <small class="text-muted" style="font-size: 0.7rem;">${formatRelativeTime(session.updated_at)}</small>
          </div>
        </div>
      `
          )
          .join('')
      }

      /**
       * è·å–ä¼šè¯çŠ¶æ€å¾½ç« æ ·å¼
       * @param {string} status - ä¼šè¯çŠ¶æ€
       * @returns {string} CSSç±»å
       */
      function getSessionStatusBadge(status) {
        const badges = {
          waiting: 'bg-warning text-dark',
          active: 'bg-success',
          closed: 'bg-secondary'
        }
        return badges[status] || 'bg-secondary'
      }

      /**
       * è·å–ä¼šè¯çŠ¶æ€æ–‡æœ¬
       * @param {string} status - ä¼šè¯çŠ¶æ€
       * @returns {string} çŠ¶æ€æ–‡æœ¬
       */
      function getSessionStatusText(status) {
        const texts = {
          waiting: 'å¾…å¤„ç†',
          active: 'è¿›è¡Œä¸­',
          closed: 'å·²å…³é—­'
        }
        return texts[status] || 'æœªçŸ¥'
      }

      /**
       * æ‰“å¼€ä¼šè¯
       * @param {number} sessionId - ä¼šè¯ID
       */
      async function openSession(sessionId) {
        if (sessionId === currentSessionId) return

        currentSessionId = sessionId
        showLoading()

        try {
          // è·å–ä¼šè¯è¯¦æƒ…å’Œæ¶ˆæ¯å†å²
          const response = await apiRequest(
            `/api/v4/admin/customer-service/sessions/${sessionId}/messages`
          )

          if (response && response.success) {
            const session = response.data.session
            const messages = response.data.messages || []

            // æ›´æ–°èŠå¤©å¤´éƒ¨ä¿¡æ¯
            // ä½¿ç”¨Bootstrap Iconsçš„SVGä½œä¸ºé»˜è®¤å¤´åƒï¼ˆBase64ç¼–ç ï¼‰
            const defaultAvatar =
              'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgZmlsbD0iI2NjYyIgY2xhc3M9ImJpIGJpLXBlcnNvbi1jaXJjbGUiIHZpZXdCb3g9IjAgMCAxNiAxNiI+PHBhdGggZD0iTTExIDZhMyAzIDAgMSAxLTYgMCAzIDMgMCAwIDEgNiAweiIvPjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgZD0iTTAgOGE4IDggMCAxIDEgMTYgMEE4IDggMCAwIDEgMCA4em04IDdhNyA3IDAgMCAwIDUuMzg3LTIuNTAzQTEzLjkzMyAxMy45MzMgMCAwIDAgOCAxMS41YTEzLjkzMyAxMy45MzMgMCAwIDAtNS4zODcgMS4wMDdBNyA3IDAgMCAwIDggMTV6Ii8+PC9zdmc+'

            const avatarElement = document.getElementById('chatUserAvatar')
            avatarElement.src = session.user_avatar || defaultAvatar
            avatarElement.onerror = function () {
              this.src = defaultAvatar
            }

            document.getElementById('chatUserName').textContent =
              session.user_nickname || 'æœªå‘½åç”¨æˆ·'
            document.getElementById('chatUserMobile').textContent = maskPhone(
              session.user_mobile || ''
            )

            // æ¸²æŸ“æ¶ˆæ¯
            renderMessages(messages)

            // æ˜¾ç¤ºèŠå¤©ç•Œé¢
            document.getElementById('emptyState').style.display = 'none'
            document.getElementById('chatInterface').style.display = 'flex'

            // æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»
            markAsRead(sessionId)

            // åˆ·æ–°ä¼šè¯åˆ—è¡¨ï¼ˆæ›´æ–°activeçŠ¶æ€ï¼‰
            loadSessions(true)
          } else {
            showError('æ‰“å¼€å¤±è´¥', response?.message || 'è·å–ä¼šè¯ä¿¡æ¯å¤±è´¥')
          }
        } catch (error) {
          console.error('æ‰“å¼€ä¼šè¯å¤±è´¥:', error)
          showError('æ‰“å¼€å¤±è´¥', error.message)
        } finally {
          hideLoading()
        }
      }

      /**
       * æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨
       * @param {Array} messages - æ¶ˆæ¯æ•°ç»„
       */
      function renderMessages(messages) {
        const container = document.getElementById('chatMessages')
        container.innerHTML = ''

        messages.forEach(msg => appendMessage(msg))
        scrollToBottom()
      }

      /**
       * è¿½åŠ å•æ¡æ¶ˆæ¯
       * @param {Object} message - æ¶ˆæ¯å¯¹è±¡
       */
      function appendMessage(message) {
        const container = document.getElementById('chatMessages')
        const isAdmin = message.sender_type === 'admin'

        const messageHtml = `
        <div class="message-item ${isAdmin ? 'admin-message' : 'user-message'}">
          <div>
            <div class="message-bubble">
              ${escapeHtml(message.message_content || message.content)}
            </div>
            <div class="message-time ${isAdmin ? 'text-end' : ''}">${formatDate(message.created_at)}</div>
          </div>
        </div>
      `

        container.insertAdjacentHTML('beforeend', messageHtml)
      }

      /**
       * æ»šåŠ¨åˆ°åº•éƒ¨
       */
      function scrollToBottom() {
        const container = document.getElementById('chatMessages')
        container.scrollTop = container.scrollHeight
      }

      /**
       * å‘é€æ¶ˆæ¯
       */
      async function sendMessage() {
        const input = document.getElementById('messageInput')
        const content = input.value.trim()

        if (!content) {
          alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹')
          return
        }

        if (!currentSessionId) {
          alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä¼šè¯')
          return
        }

        try {
          const response = await apiRequest(
            `/api/v4/admin/customer-service/sessions/${currentSessionId}/send`,
            {
              method: 'POST',
              body: JSON.stringify({ content: content })
            }
          )

          if (response && response.success) {
            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = ''

            // è¿½åŠ æ¶ˆæ¯
            appendMessage({
              sender_type: 'admin',
              message_content: content,
              created_at: new Date().toISOString()
            })

            scrollToBottom()

            // é€šè¿‡WebSocketå‘é€ï¼ˆå¦‚æœè¿æ¥æ­£å¸¸ï¼‰
            if (wsConnection && wsConnection.connected) {
              wsConnection.emit('send_message', {
                session_id: currentSessionId,
                content: content
              })
            }
          } else {
            showError('å‘é€å¤±è´¥', response?.message || 'æ¶ˆæ¯å‘é€å¤±è´¥')
          }
        } catch (error) {
          console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error)
          showError('å‘é€å¤±è´¥', error.message)
        }
      }

      /**
       * æ’å…¥å¿«æ·å›å¤
       * @param {string} text - å›å¤æ–‡æœ¬
       */
      function insertQuickReply(text) {
        document.getElementById('messageInput').value = text
        document.getElementById('messageInput').focus()
      }

      /**
       * æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»
       * @param {number} sessionId - ä¼šè¯ID
       */
      async function markAsRead(sessionId) {
        try {
          await apiRequest(`/api/v4/admin/customer-service/sessions/${sessionId}/mark-read`, {
            method: 'POST'
          })
        } catch (error) {
          console.error('æ ‡è®°å·²è¯»å¤±è´¥:', error)
        }
      }

      /**
       * æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯
       */
      async function viewUserInfo() {
        if (!currentSessionId) return

        showLoading()

        try {
          const session = allSessions.find(s => s.session_id === currentSessionId)
          if (!session) return

          // ä½¿ç”¨åç«¯å®é™…APIè·¯å¾„ï¼š/api/v4/admin/user-management/users/:user_id
          const response = await apiRequest(
            `/api/v4/admin/user-management/users/${session.user_id}`
          )

          if (response && response.success) {
            const user = response.data.user || response.data
            renderUserInfo(user)
            new bootstrap.Modal(document.getElementById('userInfoModal')).show()
          }
        } catch (error) {
          console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error)
        } finally {
          hideLoading()
        }
      }

      /**
       * æ¸²æŸ“ç”¨æˆ·ä¿¡æ¯
       * @param {Object} user - ç”¨æˆ·å¯¹è±¡
       */
      function renderUserInfo(user) {
        // ä½¿ç”¨Bootstrap Iconsçš„SVGä½œä¸ºé»˜è®¤å¤´åƒï¼ˆBase64ç¼–ç ï¼‰
        const defaultAvatar =
          'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgZmlsbD0iI2NjYyIgY2xhc3M9ImJpIGJpLXBlcnNvbi1jaXJjbGUiIHZpZXdCb3g9IjAgMCAxNiAxNiI+PHBhdGggZD0iTTExIDZhMyAzIDAgMSAxLTYgMCAzIDMgMCAwIDEgNiAweiIvPjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgZD0iTTAgOGE4IDggMCAxIDEgMTYgMEE4IDggMCAwIDEgMCA4em04IDdhNyA3IDAgMCAwIDUuMzg3LTIuNTAzQTEzLjkzMyAxMy45MzMgMCAwIDAgOCAxMS41YTEzLjkzMyAxMy45MzMgMCAwIDAtNS4zODcgMS4wMDdBNyA3IDAgMCAwIDggMTV6Ii8+PC9zdmc+'

        const infoHtml = `
        <div class="text-center mb-3">
          <img src="${user.avatar_url || defaultAvatar}" 
               class="rounded-circle" 
               style="width: 80px; height: 80px;"
               onerror="this.src='${defaultAvatar}'"
               alt="å¤´åƒ">
        </div>
        <div class="row g-2">
          <div class="col-6"><strong>ç”¨æˆ·IDï¼š</strong>${user.user_id || user.id}</div>
          <div class="col-6"><strong>æ˜µç§°ï¼š</strong>${user.nickname || 'æœªè®¾ç½®'}</div>
          <div class="col-6"><strong>æ‰‹æœºå·ï¼š</strong>${user.mobile || '-'}</div>
          <div class="col-6"><strong>ç§¯åˆ†ï¼š</strong><span class="text-primary">${formatNumber(user.points_balance || 0)}</span></div>
          <div class="col-6"><strong>æ³¨å†Œæ—¶é—´ï¼š</strong>${formatDate(user.created_at)}</div>
          <div class="col-6"><strong>æœ€åæ´»è·ƒï¼š</strong>${user.last_active_at ? formatDate(user.last_active_at) : 'ä»æœª'}</div>
        </div>
      `

        document.getElementById('userInfoBody').innerHTML = infoHtml
      }

      /**
       * åŠ è½½å®¢æœåˆ—è¡¨ï¼ˆç®¡ç†å‘˜åˆ—è¡¨ï¼‰
       */
      async function loadAdminList() {
        try {
          // ä½¿ç”¨åç«¯å®é™…APIè·¯å¾„ï¼š/api/v4/admin/user-management/users + role_filterå‚æ•°
          const response = await apiRequest('/api/v4/admin/user-management/users?role_filter=admin')
          if (response && response.success) {
            // æ³¨æ„ï¼šè¿”å›æ•°æ®ç»“æ„ä¸º { users: [...], pagination: {...} }
            const admins = response.data.users || []
            const select = document.getElementById('transferTargetSelect')
            select.innerHTML =
              '<option value="">è¯·é€‰æ‹©...</option>' +
              admins
                .map(
                  admin =>
                    `<option value="${admin.user_id}">${admin.nickname || admin.mobile}</option>`
                )
                .join('')
          }
        } catch (error) {
          console.error('åŠ è½½å®¢æœåˆ—è¡¨å¤±è´¥:', error)
        }
      }

      /**
       * è½¬æ¥ä¼šè¯
       */
      function transferSession() {
        if (!currentSessionId) return
        new bootstrap.Modal(document.getElementById('transferModal')).show()
      }

      /**
       * æäº¤è½¬æ¥
       */
      async function submitTransfer() {
        const targetId = document.getElementById('transferTargetSelect').value
        if (!targetId) {
          alert('è¯·é€‰æ‹©æ¥æ”¶å®¢æœ')
          return
        }

        showLoading()

        try {
          const response = await apiRequest(
            `/api/v4/admin/customer-service/sessions/${currentSessionId}/transfer`,
            {
              method: 'POST',
              body: JSON.stringify({ target_admin_id: parseInt(targetId) })
            }
          )

          if (response && response.success) {
            showSuccess('è½¬æ¥æˆåŠŸ', 'ä¼šè¯å·²è½¬æ¥')
            bootstrap.Modal.getInstance(document.getElementById('transferModal')).hide()
            closeCurrentChat()
            loadSessions()
          } else {
            showError('è½¬æ¥å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥')
          }
        } catch (error) {
          console.error('è½¬æ¥å¤±è´¥:', error)
          showError('è½¬æ¥å¤±è´¥', error.message)
        } finally {
          hideLoading()
        }
      }

      /**
       * ç»“æŸä¼šè¯
       */
      async function closeSession() {
        if (!confirm('ç¡®è®¤ç»“æŸå½“å‰ä¼šè¯ï¼Ÿ')) return

        showLoading()

        try {
          const response = await apiRequest(
            `/api/v4/admin/customer-service/sessions/${currentSessionId}/close`,
            {
              method: 'POST'
            }
          )

          if (response && response.success) {
            showSuccess('æ“ä½œæˆåŠŸ', 'ä¼šè¯å·²å…³é—­')
            closeCurrentChat()
            loadSessions()
          } else {
            showError('æ“ä½œå¤±è´¥', response?.message || 'å…³é—­ä¼šè¯å¤±è´¥')
          }
        } catch (error) {
          console.error('å…³é—­ä¼šè¯å¤±è´¥:', error)
          showError('æ“ä½œå¤±è´¥', error.message)
        } finally {
          hideLoading()
        }
      }

      /**
       * å…³é—­å½“å‰èŠå¤©ç•Œé¢
       */
      function closeCurrentChat() {
        currentSessionId = null
        document.getElementById('chatInterface').style.display = 'none'
        document.getElementById('emptyState').style.display = 'flex'
        document.getElementById('messageInput').value = ''
      }

      /**
       * HTMLè½¬ä¹‰
       * @param {string} text - æ–‡æœ¬
       * @returns {string} è½¬ä¹‰åçš„æ–‡æœ¬
       */
      function escapeHtml(text) {
        const div = document.createElement('div')
        div.textContent = text
        return div.innerHTML
      }

      /**
       * æ˜¾ç¤ºåŠ è½½çŠ¶æ€
       */
      function showLoading() {
        document.getElementById('loadingOverlay').classList.add('show')
      }

      /**
       * éšè—åŠ è½½çŠ¶æ€
       */
      function hideLoading() {
        document.getElementById('loadingOverlay').classList.remove('show')
      }

      /**
       * æ˜¾ç¤ºæˆåŠŸæç¤º
       * @param {string} title - æ ‡é¢˜
       * @param {string} message - æ¶ˆæ¯
       */
      function showSuccess(title, message) {
        alert(`âœ… ${title}\n${message}`)
      }

      /**
       * æ˜¾ç¤ºé”™è¯¯æç¤º
       * @param {string} title - æ ‡é¢˜
       * @param {string} message - æ¶ˆæ¯
       */
      function showError(title, message) {
        alert(`âŒ ${title}\n${message}`)
      }

      // é¡µé¢å¸è½½æ—¶å…³é—­WebSocket
      window.addEventListener('beforeunload', () => {
        if (wsConnection) {
          wsConnection.disconnect()
        }
      })
    </script>
  </body>
</html>
