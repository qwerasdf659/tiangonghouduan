<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å›¾è¡¨å¯è§†åŒ– - ç®¡ç†åå°</title>
  
  <!-- âœ… Bootstrap 5 - UIæ¡†æ¶ -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- âœ… Bootstrap Icons - å›¾æ ‡åº“ -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- âœ… å…¬å…±æ ·å¼è¡¨ - ç»Ÿä¸€ä¸»é¢˜å’Œå“åº”å¼è®¾è®¡ -->
  <link href="/admin/css/common.css" rel="stylesheet">
  
  <!-- âœ… é¡µé¢ç‰¹æœ‰æ ·å¼ -->
  <style>
    .chart-container {
      position: relative;
      height: 350px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body class="bg-light">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ“ˆ ç®¡ç†åå° - å›¾è¡¨å¯è§†åŒ–
      </a>
      <div>
        <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>
  
  <div class="container-fluid mt-4">
    <!-- æ—¶é—´èŒƒå›´é€‰æ‹© -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label">æ•°æ®å‘¨æœŸ</label>
            <select class="form-select" id="periodSelect">
              <option value="7">æœ€è¿‘7å¤©</option>
              <option value="14">æœ€è¿‘14å¤©</option>
              <option value="30" selected>æœ€è¿‘30å¤©</option>
              <option value="90">æœ€è¿‘90å¤©</option>
            </select>
          </div>
          <div class="col-md-3">
            <button class="btn btn-primary w-100" id="loadAllChartsBtn">
              <i class="bi bi-arrow-repeat"></i> åˆ·æ–°æ•°æ®
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ç”¨æˆ·å¢é•¿è¶‹åŠ¿ -->
    <div class="row g-3 mb-3">
      <div class="col-lg-8">
        <div class="card">
          <div class="card-header bg-white">
            <h6 class="mb-0">
              <i class="bi bi-graph-up-arrow"></i> ç”¨æˆ·å¢é•¿è¶‹åŠ¿
            </h6>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="userGrowthChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-lg-4">
        <div class="card">
          <div class="card-header bg-white">
            <h6 class="mb-0">
              <i class="bi bi-pie-chart"></i> ç”¨æˆ·ç±»å‹åˆ†å¸ƒ
            </h6>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="userTypePieChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æŠ½å¥–æ•°æ®åˆ†æ -->
    <div class="row g-3 mb-3">
      <div class="col-lg-12">
        <div class="card">
          <div class="card-header bg-white">
            <h6 class="mb-0">
              <i class="bi bi-bar-chart-line"></i> æŠ½å¥–æ¬¡æ•°ä¸ä¸­å¥–ç‡è¶‹åŠ¿
            </h6>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="lotteryTrendChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æ¶ˆè´¹ä¸ç§¯åˆ†åˆ†æ -->
    <div class="row g-3 mb-3">
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header bg-white">
            <h6 class="mb-0">
              <i class="bi bi-cash-stack"></i> æ¶ˆè´¹é‡‘é¢è¶‹åŠ¿
            </h6>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="consumptionChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header bg-white">
            <h6 class="mb-0">
              <i class="bi bi-star-fill"></i> ç§¯åˆ†æµåŠ¨è¶‹åŠ¿
            </h6>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="pointsFlowChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- å¥–å“å‘æ”¾åˆ†æ -->
    <div class="row g-3 mb-3">
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header bg-white">
            <h6 class="mb-0">
              <i class="bi bi-gift-fill"></i> TOP10 çƒ­é—¨å¥–å“
            </h6>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="topPrizesChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header bg-white">
            <h6 class="mb-0">
              <i class="bi bi-clock-history"></i> æ´»è·ƒæ—¶æ®µåˆ†å¸ƒ
            </h6>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="activeHoursChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- åŠ è½½é®ç½©å±‚ -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">å¤„ç†ä¸­...</span>
    </div>
  </div>

  <!-- âœ… Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- âœ… Chart.js - å›¾è¡¨åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- âœ… å¼•å…¥é€šç”¨å·¥å…·åº“ -->
  <script src="/admin/js/admin-common.js"></script>
  
  <script>
    /**
     * å…¨å±€å˜é‡ - å­˜å‚¨å›¾è¡¨å®ä¾‹
     */
    let charts = {
      userGrowth: null,
      userTypePie: null,
      lotteryTrend: null,
      consumption: null,
      pointsFlow: null,
      topPrizes: null,
      activeHours: null
    };
    
    /**
     * é¡µé¢åˆå§‹åŒ–
     */
    document.addEventListener('DOMContentLoaded', function() {
      // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
      const userInfo = getCurrentUser();
      if (userInfo && userInfo.nickname) {
        document.getElementById('welcomeText').textContent = `æ¬¢è¿ï¼Œ${userInfo.nickname}`;
      }
      
      // ===== é™æ€æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨ =====
      // é€€å‡ºç™»å½•æŒ‰é’®
      document.getElementById('logoutBtn').addEventListener('click', logout);
      
      // åˆ·æ–°å›¾è¡¨æŒ‰é’®
      document.getElementById('loadAllChartsBtn').addEventListener('click', () => loadAllCharts());
      
      // âœ… Tokenå’Œæƒé™éªŒè¯
      if (!getToken() || !checkAdminPermission()) {
        return;
      }
      
      // åŠ è½½æ‰€æœ‰å›¾è¡¨
      loadAllCharts();
      
      // å‘¨æœŸé€‰æ‹©å˜åŒ–æ—¶é‡æ–°åŠ è½½
      document.getElementById('periodSelect').addEventListener('change', loadAllCharts);
    });
    
    /**
     * åŠ è½½æ‰€æœ‰å›¾è¡¨æ•°æ®
     */
    async function loadAllCharts() {
      showLoading();
      
      try {
        const days = document.getElementById('periodSelect').value;
        // âœ… å¯¹é½åˆ°æ­£ç¡®çš„system/statisticsè·¯å¾„ï¼ˆæ–‡æ¡£5.2å†³ç­–ï¼‰
        const response = await apiRequest(`/api/v4/system/statistics/charts?days=${days}`);
        
        if (response && response.success) {
          const data = response.data;
          
          // æ¸²æŸ“æ‰€æœ‰å›¾è¡¨
          renderUserGrowthChart(data.user_growth);
          renderUserTypePieChart(data.user_types);
          renderLotteryTrendChart(data.lottery_trend);
          renderConsumptionChart(data.consumption_trend);
          renderPointsFlowChart(data.points_flow);
          renderTopPrizesChart(data.top_prizes);
          renderActiveHoursChart(data.active_hours);
        } else {
          showError('åŠ è½½å¤±è´¥', response?.message || 'è·å–å›¾è¡¨æ•°æ®å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½å›¾è¡¨å¤±è´¥:', error);
        showError('åŠ è½½å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * æ¸²æŸ“ç”¨æˆ·å¢é•¿è¶‹åŠ¿å›¾
     * @param {Object} data - æ•°æ®
     */
    function renderUserGrowthChart(data) {
      const ctx = document.getElementById('userGrowthChart').getContext('2d');
      
      // é”€æ¯æ—§å›¾è¡¨
      if (charts.userGrowth) {
        charts.userGrowth.destroy();
      }
      
      charts.userGrowth = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data?.labels || [],
          datasets: [{
            label: 'æ–°å¢ç”¨æˆ·',
            data: data?.new_users || [],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            tension: 0.4,
            fill: true
          }, {
            label: 'æ´»è·ƒç”¨æˆ·',
            data: data?.active_users || [],
            borderColor: 'rgb(255, 159, 64)',
            backgroundColor: 'rgba(255, 159, 64, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              mode: 'index',
              intersect: false,
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }
    
    /**
     * æ¸²æŸ“ç”¨æˆ·ç±»å‹åˆ†å¸ƒé¥¼å›¾
     * @param {Object} data - æ•°æ®
     */
    function renderUserTypePieChart(data) {
      const ctx = document.getElementById('userTypePieChart').getContext('2d');
      
      if (charts.userTypePie) {
        charts.userTypePie.destroy();
      }
      
      charts.userTypePie = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['æ™®é€šç”¨æˆ·', 'VIPç”¨æˆ·', 'ç®¡ç†å‘˜'],
          datasets: [{
            data: [
              data?.normal || 0,
              data?.vip || 0,
              data?.admin || 0
            ],
            backgroundColor: [
              'rgba(54, 162, 235, 0.8)',
              'rgba(255, 206, 86, 0.8)',
              'rgba(255, 99, 132, 0.8)'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
            }
          }
        }
      });
    }
    
    /**
     * æ¸²æŸ“æŠ½å¥–è¶‹åŠ¿å›¾ï¼ˆåŒYè½´ï¼‰
     * @param {Object} data - æ•°æ®
     */
    function renderLotteryTrendChart(data) {
      const ctx = document.getElementById('lotteryTrendChart').getContext('2d');
      
      if (charts.lotteryTrend) {
        charts.lotteryTrend.destroy();
      }
      
      charts.lotteryTrend = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data?.labels || [],
          datasets: [{
            label: 'æŠ½å¥–æ¬¡æ•°',
            data: data?.draws || [],
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            yAxisID: 'y'
          }, {
            label: 'ä¸­å¥–æ¬¡æ•°',
            data: data?.wins || [],
            backgroundColor: 'rgba(75, 192, 192, 0.6)',
            yAxisID: 'y'
          }, {
            label: 'ä¸­å¥–ç‡(%)',
            data: data?.win_rate || [],
            type: 'line',
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            yAxisID: 'y1',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: {
              position: 'top',
            }
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'æ¬¡æ•°'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'ä¸­å¥–ç‡(%)'
              },
              grid: {
                drawOnChartArea: false,
              }
            }
          }
        }
      });
    }
    
    /**
     * æ¸²æŸ“æ¶ˆè´¹é‡‘é¢è¶‹åŠ¿å›¾
     * @param {Object} data - æ•°æ®
     */
    function renderConsumptionChart(data) {
      const ctx = document.getElementById('consumptionChart').getContext('2d');
      
      if (charts.consumption) {
        charts.consumption.destroy();
      }
      
      charts.consumption = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data?.labels || [],
          datasets: [{
            label: 'æ¶ˆè´¹é‡‘é¢(å…ƒ)',
            data: data?.amounts || [],
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'Â¥' + value;
                }
              }
            }
          }
        }
      });
    }
    
    /**
     * æ¸²æŸ“ç§¯åˆ†æµåŠ¨è¶‹åŠ¿å›¾
     * @param {Object} data - æ•°æ®
     */
    function renderPointsFlowChart(data) {
      const ctx = document.getElementById('pointsFlowChart').getContext('2d');
      
      if (charts.pointsFlow) {
        charts.pointsFlow.destroy();
      }
      
      charts.pointsFlow = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data?.labels || [],
          datasets: [{
            label: 'å‘æ”¾ç§¯åˆ†',
            data: data?.issued || [],
            backgroundColor: 'rgba(75, 192, 192, 0.6)',
          }, {
            label: 'æ¶ˆè€—ç§¯åˆ†',
            data: data?.consumed || [],
            backgroundColor: 'rgba(255, 159, 64, 0.6)',
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }
    
    /**
     * æ¸²æŸ“TOP10çƒ­é—¨å¥–å“å›¾
     * @param {Object} data - æ•°æ®
     */
    function renderTopPrizesChart(data) {
      const ctx = document.getElementById('topPrizesChart').getContext('2d');
      
      if (charts.topPrizes) {
        charts.topPrizes.destroy();
      }
      
      charts.topPrizes = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data?.labels || [],
          datasets: [{
            label: 'å‘æ”¾æ¬¡æ•°',
            data: data?.counts || [],
            backgroundColor: [
              'rgba(255, 99, 132, 0.6)',
              'rgba(54, 162, 235, 0.6)',
              'rgba(255, 206, 86, 0.6)',
              'rgba(75, 192, 192, 0.6)',
              'rgba(153, 102, 255, 0.6)',
              'rgba(255, 159, 64, 0.6)',
              'rgba(199, 199, 199, 0.6)',
              'rgba(83, 102, 255, 0.6)',
              'rgba(255, 99, 255, 0.6)',
              'rgba(99, 255, 132, 0.6)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            x: {
              beginAtZero: true
            }
          }
        }
      });
    }
    
    /**
     * æ¸²æŸ“æ´»è·ƒæ—¶æ®µåˆ†å¸ƒå›¾
     * @param {Object} data - æ•°æ®
     */
    function renderActiveHoursChart(data) {
      const ctx = document.getElementById('activeHoursChart').getContext('2d');
      
      if (charts.activeHours) {
        charts.activeHours.destroy();
      }
      
      charts.activeHours = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: data?.labels || ['0æ—¶', '3æ—¶', '6æ—¶', '9æ—¶', '12æ—¶', '15æ—¶', '18æ—¶', '21æ—¶'],
          datasets: [{
            label: 'æ´»è·ƒç”¨æˆ·æ•°',
            data: data?.values || [],
            fill: true,
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgb(54, 162, 235)',
            pointBackgroundColor: 'rgb(54, 162, 235)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgb(54, 162, 235)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            }
          },
          scales: {
            r: {
              beginAtZero: true
            }
          }
        }
      });
    }
    
    /**
     * æ˜¾ç¤ºåŠ è½½çŠ¶æ€
     */
    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('show');
    }
    
    /**
     * éšè—åŠ è½½çŠ¶æ€
     */
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('show');
    }
    
    /**
     * æ˜¾ç¤ºé”™è¯¯æç¤º
     * @param {string} title - æ ‡é¢˜
     * @param {string} message - æ¶ˆæ¯
     */
    function showError(title, message) {
      alert(`âŒ ${title}\n${message}`);
    }
  </script>
</body>
</html>

