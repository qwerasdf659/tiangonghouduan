<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>欠账管理 - 管理后台</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">
  <style>
    .debt-card {
      border-left: 4px solid #dc3545;
    }
    .debt-card.cleared {
      border-left-color: #28a745;
    }
    .amount-text {
      font-size: 1.5rem;
      font-weight: bold;
    }
    .chart-container {
      height: 300px;
    }
    [x-cloak] { display: none !important; }
  </style>
  <!-- Alpine.js -->
  <script defer src="/admin/js/alpine/init.js"></script>
  <script defer src="/admin/js/vendor/alpine.min.js"></script>
</head>
<body class="bg-light">
  <div x-data="debtManagementPage()" x-init="init()" x-cloak>
    <nav class="navbar navbar-dark bg-primary">
      <div class="container-fluid">
        <a href="/admin/dashboard.html" class="navbar-brand">
          <i class="bi bi-arrow-left me-2"></i>💰 管理后台 - 欠账管理
        </a>
        <div>
          <span class="text-light me-3" x-text="'欢迎，' + (userInfo.nickname || '管理员')"></span>
          <button class="btn btn-outline-light btn-sm" @click="logout">退出登录</button>
        </div>
      </div>
    </nav>

    <div class="container-fluid mt-4">
      <!-- 仪表盘统计 -->
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="card stat-card">
            <div class="card-body text-center">
              <i class="bi bi-exclamation-triangle text-danger" style="font-size: 2rem;"></i>
              <h6 class="text-muted mt-2">待清偿总数</h6>
              <h2 class="text-danger mb-0" x-text="stats.pendingCount"></h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card">
            <div class="card-body text-center">
              <i class="bi bi-currency-yen text-warning" style="font-size: 2rem;"></i>
              <h6 class="text-muted mt-2">待清偿金额</h6>
              <h2 class="text-warning mb-0" x-text="stats.pendingAmount.toLocaleString()"></h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card">
            <div class="card-body text-center">
              <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
              <h6 class="text-muted mt-2">已清偿总数</h6>
              <h2 class="text-success mb-0" x-text="stats.clearedCount"></h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card">
            <div class="card-body text-center">
              <i class="bi bi-percent text-info" style="font-size: 2rem;"></i>
              <h6 class="text-muted mt-2">清偿率</h6>
              <h2 class="text-info mb-0" x-text="stats.clearRate"></h2>
            </div>
          </div>
        </div>
      </div>

      <!-- 图表区域 -->
      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-pie-chart"></i> 欠账来源分布
            </div>
            <div class="card-body">
              <div x-ref="sourceChart" class="chart-container"></div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-bar-chart"></i> 按活动汇总
            </div>
            <div class="card-body">
              <div x-ref="campaignChart" class="chart-container"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 选项卡 -->
      <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link" :class="{ active: activeTab === 'pending' }" @click="activeTab = 'pending'" type="button">
            <i class="bi bi-clock-history"></i> 待清偿列表
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" :class="{ active: activeTab === 'by-campaign' }" @click="activeTab = 'by-campaign'" type="button">
            <i class="bi bi-trophy"></i> 按活动汇总
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" :class="{ active: activeTab === 'by-prize' }" @click="activeTab = 'by-prize'" type="button">
            <i class="bi bi-gift"></i> 按奖品汇总
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" :class="{ active: activeTab === 'limits' }" @click="activeTab = 'limits'" type="button">
            <i class="bi bi-shield-exclamation"></i> 上限配置
          </button>
        </li>
      </ul>

      <div class="tab-content">
        <!-- 待清偿列表 -->
        <div class="tab-pane fade" :class="{ 'show active': activeTab === 'pending' }" x-show="activeTab === 'pending'">
          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>类型</th>
                      <th>活动</th>
                      <th>奖品</th>
                      <th>欠账数量</th>
                      <th>已清偿</th>
                      <th>责任人</th>
                      <th>创建时间</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-if="pendingDebts.length === 0">
                      <tr>
                        <td colspan="9" class="text-center text-muted">🎉 暂无待清偿欠账</td>
                      </tr>
                    </template>
                    <template x-for="debt in pendingDebts" :key="debt.debt_id">
                      <tr>
                        <td x-text="debt.debt_id"></td>
                        <td>
                          <span class="badge" :class="isInventoryDebt(debt) ? 'bg-warning' : 'bg-info'" x-text="isInventoryDebt(debt) ? '库存' : '预算'"></span>
                        </td>
                        <td x-text="debt.campaign?.campaign_name || '-'"></td>
                        <td x-text="isInventoryDebt(debt) ? (debt.prize?.prize_name || '-') : '-'"></td>
                        <td class="text-danger fw-bold" x-text="getDebtQuantity(debt)"></td>
                        <td class="text-success" x-text="getClearedQuantity(debt)"></td>
                        <td x-text="debt.user?.nickname || '-'"></td>
                        <td x-text="formatDateTime(debt.created_at)"></td>
                        <td>
                          <button class="btn btn-sm btn-success" @click="openClearModal(debt)">
                            <i class="bi bi-check-circle"></i> 清偿
                          </button>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- 按活动汇总 -->
        <div class="tab-pane fade" :class="{ 'show active': activeTab === 'by-campaign' }" x-show="activeTab === 'by-campaign'">
          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>活动ID</th>
                      <th>活动名称</th>
                      <th>欠账记录数</th>
                      <th>欠账总量</th>
                      <th>已清偿量</th>
                      <th>清偿率</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-if="byCampaignList.length === 0">
                      <tr>
                        <td colspan="6" class="text-center text-muted">暂无数据</td>
                      </tr>
                    </template>
                    <template x-for="c in byCampaignList" :key="c.campaign_id">
                      <tr>
                        <td x-text="c.campaign_id"></td>
                        <td x-text="c.campaign_name || '-'"></td>
                        <td x-text="getCampaignDebtCount(c)"></td>
                        <td class="text-danger" x-text="getCampaignDebtTotal(c)"></td>
                        <td class="text-success" x-text="getCampaignClearedTotal(c)"></td>
                        <td>
                          <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-success" :style="'width: ' + getCampaignClearRate(c) + '%'" x-text="getCampaignClearRate(c) + '%'"></div>
                          </div>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- 按奖品汇总 -->
        <div class="tab-pane fade" :class="{ 'show active': activeTab === 'by-prize' }" x-show="activeTab === 'by-prize'">
          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>奖品ID</th>
                      <th>奖品名称</th>
                      <th>欠账记录数</th>
                      <th>欠账总量</th>
                      <th>已清偿量</th>
                      <th>清偿率</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-if="byPrizeList.length === 0">
                      <tr>
                        <td colspan="6" class="text-center text-muted">暂无数据</td>
                      </tr>
                    </template>
                    <template x-for="p in byPrizeList" :key="p.prize_id">
                      <tr>
                        <td x-text="p.prize_id"></td>
                        <td x-text="p.prize_name || '-'"></td>
                        <td x-text="p.debt_count || 0"></td>
                        <td class="text-danger" x-text="p.remaining_quantity || 0"></td>
                        <td class="text-success" x-text="p.cleared_quantity || 0"></td>
                        <td>
                          <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-success" :style="'width: ' + getPrizeClearRate(p) + '%'" x-text="getPrizeClearRate(p) + '%'"></div>
                          </div>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- 上限配置 -->
        <div class="tab-pane fade" :class="{ 'show active': activeTab === 'limits' }" x-show="activeTab === 'limits'">
          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>配置ID</th>
                      <th>级别</th>
                      <th>关联ID</th>
                      <th>最大欠账量</th>
                      <th>当前欠账量</th>
                      <th>使用率</th>
                      <th>状态</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-if="limitsList.length === 0">
                      <tr>
                        <td colspan="7" class="text-center text-muted">暂无上限配置</td>
                      </tr>
                    </template>
                    <template x-for="l in limitsList" :key="l.limit_id">
                      <tr>
                        <td x-text="l.limit_id"></td>
                        <td>
                          <span class="badge bg-secondary" x-text="l.limit_level_name || l.limit_level || 'global'"></span>
                        </td>
                        <td>
                          <span x-text="l.reference_id || '-'"></span>
                          <span x-show="l.campaign_name" class="text-muted" x-text="' (' + l.campaign_name + ')'"></span>
                        </td>
                        <td>
                          <small class="text-muted">库存:</small> <span x-text="l.inventory_debt_limit || 0"></span><br>
                          <small class="text-muted">预算:</small> <span x-text="l.budget_debt_limit || 0"></span>
                        </td>
                        <td>-</td>
                        <td>
                          <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-info" style="width: 0%">-</div>
                          </div>
                        </td>
                        <td>
                          <span class="badge" :class="l.status === 'active' ? 'bg-success' : 'bg-secondary'" x-text="l.status === 'active' ? '启用' : '禁用'"></span>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 清偿模态框 -->
    <div class="modal fade" x-ref="clearModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-check-circle"></i> 清偿操作</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form @submit.prevent="submitClear">
              <div class="mb-3">
                <label class="form-label">欠账类型</label>
                <input type="text" class="form-control" :value="clearForm.debtTypeLabel" readonly>
              </div>
              <div class="mb-3">
                <label class="form-label">待清偿数量</label>
                <input type="text" class="form-control" :value="clearForm.pendingQty" readonly>
              </div>
              <div class="mb-3">
                <label class="form-label">清偿数量</label>
                <input type="number" class="form-control" x-model.number="clearForm.amount" :max="clearForm.pendingQty" min="1" required>
              </div>
              <div class="mb-3">
                <label class="form-label">备注</label>
                <textarea class="form-control" x-model="clearForm.remark" rows="2"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-success" @click="submitClear" :disabled="submitting">
              <span x-show="submitting" class="spinner-border spinner-border-sm me-1"></span>
              确认清偿
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 加载遮罩 -->
    <div class="loading-overlay" :class="{ show: loading }">
      <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">加载中...</span>
      </div>
    </div>

    <!-- Toast 通知 -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
      <div x-ref="successToast" class="toast align-items-center text-white bg-success border-0" role="alert">
        <div class="d-flex">
          <div class="toast-body" x-text="toastMessage"></div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
      <div x-ref="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert">
        <div class="d-flex">
          <div class="toast-body" x-text="toastMessage"></div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/lib/echarts.min.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script src="/admin/js/api-config.js"></script>
  <script src="/admin/js/pages/debt-management.js"></script>
  
  <!-- Alpine.js -->
</body>
</html>
