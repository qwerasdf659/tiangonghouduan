<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­—å…¸ç®¡ç† - ç®¡ç†åå°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">
  <style>
    .dict-tab-btn {
      cursor: pointer;
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
    }
    .dict-tab-btn:hover,
    .dict-tab-btn.active {
      border-left-color: #0d6efd;
      background: #e7f1ff;
    }
    .dict-item-row:hover {
      background: #f8f9fa;
    }
    .color-preview {
      display: inline-block;
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 1px solid #dee2e6;
      vertical-align: middle;
    }
    .tier-badge {
      font-weight: bold;
      min-width: 24px;
    }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ“– ç®¡ç†åå° - å­—å…¸ç®¡ç†
      </a>
      <div>
        <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <div class="row">
      <!-- å·¦ä¾§ï¼šå­—å…¸ç±»å‹é€‰æ‹© -->
      <div class="col-md-3">
        <div class="card">
          <div class="card-header bg-white">
            <h6 class="mb-0"><i class="bi bi-book"></i> å­—å…¸ç±»å‹</h6>
          </div>
          <div class="card-body p-0">
            <div class="dict-tab-btn p-3 border-bottom active" data-type="categories" onclick="switchDictType('categories')">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1"><i class="bi bi-folder text-primary"></i> ç‰©å“ç±»ç›®</h6>
                  <small class="text-muted">category_defs</small>
                </div>
                <span class="badge bg-primary" id="categoriesCount">-</span>
              </div>
            </div>
            <div class="dict-tab-btn p-3 border-bottom" data-type="rarities" onclick="switchDictType('rarities')">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1"><i class="bi bi-gem text-warning"></i> ç¨€æœ‰åº¦</h6>
                  <small class="text-muted">rarity_defs</small>
                </div>
                <span class="badge bg-warning text-dark" id="raritiesCount">-</span>
              </div>
            </div>
            <div class="dict-tab-btn p-3" data-type="asset-groups" onclick="switchDictType('asset-groups')">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1"><i class="bi bi-collection text-success"></i> èµ„äº§åˆ†ç»„</h6>
                  <small class="text-muted">asset_group_defs</small>
                </div>
                <span class="badge bg-success" id="assetGroupsCount">-</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§ï¼šå­—å…¸æ•°æ®è¡¨æ ¼ -->
      <div class="col-md-9">
        <div class="card">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
              <i class="bi bi-list-ul"></i> 
              <span id="currentDictTitle">ç‰©å“ç±»ç›®åˆ—è¡¨</span>
            </h6>
            <button class="btn btn-sm btn-success" id="addBtn" onclick="openAddModal()">
              <i class="bi bi-plus"></i> æ–°å¢
            </button>
          </div>
          <div class="card-body">
            <!-- ç±»ç›®è¡¨æ ¼ -->
            <div id="categoriesTable" class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>ç±»ç›®ä»£ç </th>
                    <th>æ˜¾ç¤ºåç§°</th>
                    <th>å›¾æ ‡</th>
                    <th>æ’åº</th>
                    <th>çŠ¶æ€</th>
                    <th style="width: 120px;">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="categoriesList"></tbody>
              </table>
            </div>

            <!-- ç¨€æœ‰åº¦è¡¨æ ¼ -->
            <div id="raritiesTable" class="table-responsive" style="display: none;">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>ç¨€æœ‰åº¦ä»£ç </th>
                    <th>æ˜¾ç¤ºåç§°</th>
                    <th>ç­‰çº§</th>
                    <th>é¢œè‰²</th>
                    <th>æ’åº</th>
                    <th>çŠ¶æ€</th>
                    <th style="width: 120px;">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="raritiesList"></tbody>
              </table>
            </div>

            <!-- èµ„äº§åˆ†ç»„è¡¨æ ¼ -->
            <div id="assetGroupsTable" class="table-responsive" style="display: none;">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>åˆ†ç»„ä»£ç </th>
                    <th>æ˜¾ç¤ºåç§°</th>
                    <th>åˆ†ç»„ç±»å‹</th>
                    <th>é¢œè‰²</th>
                    <th>å¯äº¤æ˜“</th>
                    <th>æ’åº</th>
                    <th>çŠ¶æ€</th>
                    <th style="width: 120px;">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="assetGroupsList"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ç±»ç›®ç¼–è¾‘æ¨¡æ€æ¡† -->
  <div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="categoryModalTitle"><i class="bi bi-folder-plus"></i> æ–°å¢ç±»ç›®</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="categoryForm">
            <input type="hidden" id="categoryEditCode">
            <div class="mb-3">
              <label class="form-label">ç±»ç›®ä»£ç  <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="categoryCode" required placeholder="å¦‚ï¼šconsumableã€equipment">
              <small class="text-muted">å°å†™å­—æ¯å¼€å¤´ï¼Œä»…åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿</small>
            </div>
            <div class="mb-3">
              <label class="form-label">æ˜¾ç¤ºåç§° <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="categoryDisplayName" required placeholder="å¦‚ï¼šæ¶ˆè€—å“ã€è£…å¤‡">
            </div>
            <div class="mb-3">
              <label class="form-label">æè¿°</label>
              <textarea class="form-control" id="categoryDescription" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">å›¾æ ‡URL</label>
              <input type="text" class="form-control" id="categoryIconUrl" placeholder="https://...">
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">æ’åº</label>
                <input type="number" class="form-control" id="categorySortOrder" value="0" min="0">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">çŠ¶æ€</label>
                <select class="form-select" id="categoryIsEnabled">
                  <option value="true">å¯ç”¨</option>
                  <option value="false">ç¦ç”¨</option>
                </select>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="submitCategory()">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç¨€æœ‰åº¦ç¼–è¾‘æ¨¡æ€æ¡† -->
  <div class="modal fade" id="rarityModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="rarityModalTitle"><i class="bi bi-gem"></i> æ–°å¢ç¨€æœ‰åº¦</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="rarityForm">
            <input type="hidden" id="rarityEditCode">
            <div class="mb-3">
              <label class="form-label">ç¨€æœ‰åº¦ä»£ç  <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="rarityCode" required placeholder="å¦‚ï¼šcommonã€rareã€legendary">
            </div>
            <div class="mb-3">
              <label class="form-label">æ˜¾ç¤ºåç§° <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="rarityDisplayName" required placeholder="å¦‚ï¼šæ™®é€šã€ç¨€æœ‰ã€ä¼ è¯´">
            </div>
            <div class="mb-3">
              <label class="form-label">æè¿°</label>
              <textarea class="form-control" id="rarityDescription" rows="2"></textarea>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">ç­‰çº§ (tier)</label>
                <input type="number" class="form-control" id="rarityTier" value="1" min="1">
                <small class="text-muted">æ•°å€¼è¶Šå¤§è¶Šç¨€æœ‰</small>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">ä¸»é¢˜é¢œè‰²</label>
                <div class="input-group">
                  <input type="color" class="form-control form-control-color" id="rarityColorPicker" value="#6c757d">
                  <input type="text" class="form-control" id="rarityColorHex" placeholder="#RRGGBB">
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">æ’åº</label>
                <input type="number" class="form-control" id="raritySortOrder" value="0" min="0">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">çŠ¶æ€</label>
                <select class="form-select" id="rarityIsEnabled">
                  <option value="true">å¯ç”¨</option>
                  <option value="false">ç¦ç”¨</option>
                </select>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="submitRarity()">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- èµ„äº§åˆ†ç»„ç¼–è¾‘æ¨¡æ€æ¡† -->
  <div class="modal fade" id="assetGroupModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="assetGroupModalTitle"><i class="bi bi-collection"></i> æ–°å¢èµ„äº§åˆ†ç»„</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="assetGroupForm">
            <input type="hidden" id="assetGroupEditCode">
            <div class="mb-3">
              <label class="form-label">åˆ†ç»„ä»£ç  <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="assetGroupCode" required placeholder="å¦‚ï¼šmaterialã€currency">
            </div>
            <div class="mb-3">
              <label class="form-label">æ˜¾ç¤ºåç§° <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="assetGroupDisplayName" required placeholder="å¦‚ï¼šææ–™ã€è´§å¸">
            </div>
            <div class="mb-3">
              <label class="form-label">æè¿°</label>
              <textarea class="form-control" id="assetGroupDescription" rows="2"></textarea>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">åˆ†ç»„ç±»å‹</label>
                <select class="form-select" id="assetGroupType">
                  <option value="system">ç³»ç»Ÿ (system)</option>
                  <option value="material" selected>ææ–™ (material)</option>
                  <option value="custom">è‡ªå®šä¹‰ (custom)</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">ä¸»é¢˜é¢œè‰²</label>
                <div class="input-group">
                  <input type="color" class="form-control form-control-color" id="assetGroupColorPicker" value="#28a745">
                  <input type="text" class="form-control" id="assetGroupColorHex" placeholder="#RRGGBB">
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">æ’åº</label>
                <input type="number" class="form-control" id="assetGroupSortOrder" value="0" min="0">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">å¯äº¤æ˜“</label>
                <select class="form-select" id="assetGroupIsTradable">
                  <option value="true">æ˜¯</option>
                  <option value="false">å¦</option>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">çŠ¶æ€</label>
                <select class="form-select" id="assetGroupIsEnabled">
                  <option value="true">å¯ç”¨</option>
                  <option value="false">ç¦ç”¨</option>
                </select>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="submitAssetGroup()">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">åŠ è½½ä¸­...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script src="/admin/js/api-config.js"></script>
  <script>
    // å½“å‰é€‰ä¸­çš„å­—å…¸ç±»å‹
    let currentDictType = 'categories';
    
    // æ•°æ®ç¼“å­˜
    let categoriesData = [];
    let raritiesData = [];
    let assetGroupsData = [];
    
    // é˜²é‡å¤æäº¤æ ‡å¿—
    let isSubmitting = false;

    document.addEventListener('DOMContentLoaded', function() {
      const userInfo = getCurrentUser();
      if (userInfo && userInfo.nickname) {
        document.getElementById('welcomeText').textContent = `æ¬¢è¿ï¼Œ${userInfo.nickname}`;
      }
      document.getElementById('logoutBtn').addEventListener('click', logout);
      
      // é¢œè‰²é€‰æ‹©å™¨åŒæ­¥
      document.getElementById('rarityColorPicker').addEventListener('input', function() {
        document.getElementById('rarityColorHex').value = this.value;
      });
      document.getElementById('rarityColorHex').addEventListener('input', function() {
        if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) {
          document.getElementById('rarityColorPicker').value = this.value;
        }
      });
      document.getElementById('assetGroupColorPicker').addEventListener('input', function() {
        document.getElementById('assetGroupColorHex').value = this.value;
      });
      document.getElementById('assetGroupColorHex').addEventListener('input', function() {
        if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) {
          document.getElementById('assetGroupColorPicker').value = this.value;
        }
      });
      
      // åŠ è½½æ‰€æœ‰æ•°æ®
      loadAllData();
    });

    // åŠ è½½æ‰€æœ‰å­—å…¸æ•°æ®
    async function loadAllData() {
      showLoading();
      try {
        // å¹¶è¡ŒåŠ è½½ä¸‰ç§å­—å…¸
        const [catRes, rarRes, groupRes] = await Promise.all([
          apiRequest(API_ENDPOINTS.DICT.CATEGORIES),
          apiRequest(API_ENDPOINTS.DICT.RARITIES),
          apiRequest(API_ENDPOINTS.DICT.ASSET_GROUPS)
        ]);

        if (catRes && catRes.success) {
          categoriesData = catRes.data.items || [];
          document.getElementById('categoriesCount').textContent = categoriesData.length;
        }
        
        if (rarRes && rarRes.success) {
          raritiesData = rarRes.data.items || [];
          document.getElementById('raritiesCount').textContent = raritiesData.length;
        }
        
        if (groupRes && groupRes.success) {
          assetGroupsData = groupRes.data.items || [];
          document.getElementById('assetGroupsCount').textContent = assetGroupsData.length;
        }

        // æ¸²æŸ“å½“å‰é€‰ä¸­çš„å­—å…¸
        renderCurrentDict();
      } catch (error) {
        console.error('åŠ è½½å­—å…¸æ•°æ®å¤±è´¥:', error);
        showError('åŠ è½½å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }

    // åˆ‡æ¢å­—å…¸ç±»å‹
    function switchDictType(type) {
      currentDictType = type;
      
      // æ›´æ–°é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.dict-tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.type === type) {
          btn.classList.add('active');
        }
      });

      // æ›´æ–°æ ‡é¢˜
      const titles = {
        'categories': 'ç‰©å“ç±»ç›®åˆ—è¡¨',
        'rarities': 'ç¨€æœ‰åº¦åˆ—è¡¨',
        'asset-groups': 'èµ„äº§åˆ†ç»„åˆ—è¡¨'
      };
      document.getElementById('currentDictTitle').textContent = titles[type];

      // åˆ‡æ¢è¡¨æ ¼æ˜¾ç¤º
      document.getElementById('categoriesTable').style.display = type === 'categories' ? 'block' : 'none';
      document.getElementById('raritiesTable').style.display = type === 'rarities' ? 'block' : 'none';
      document.getElementById('assetGroupsTable').style.display = type === 'asset-groups' ? 'block' : 'none';

      renderCurrentDict();
    }

    // æ¸²æŸ“å½“å‰å­—å…¸
    function renderCurrentDict() {
      switch (currentDictType) {
        case 'categories':
          renderCategories();
          break;
        case 'rarities':
          renderRarities();
          break;
        case 'asset-groups':
          renderAssetGroups();
          break;
      }
    }

    // æ¸²æŸ“ç±»ç›®åˆ—è¡¨
    function renderCategories() {
      const tbody = document.getElementById('categoriesList');
      
      if (categoriesData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>`;
        return;
      }

      tbody.innerHTML = categoriesData.map(item => `
        <tr class="dict-item-row">
          <td><code>${escapeHtml(item.category_code)}</code></td>
          <td>${escapeHtml(item.display_name)}</td>
          <td>${item.icon_url ? `<img src="${escapeHtml(item.icon_url)}" alt="" style="width:24px;height:24px;">` : '-'}</td>
          <td><span class="badge bg-secondary">${item.sort_order || 0}</span></td>
          <td><span class="badge ${item.is_enabled ? 'bg-success' : 'bg-secondary'}">${item.is_enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="editCategory('${item.category_code}')"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory('${item.category_code}')"><i class="bi bi-trash"></i></button>
          </td>
        </tr>
      `).join('');
    }

    // æ¸²æŸ“ç¨€æœ‰åº¦åˆ—è¡¨
    function renderRarities() {
      const tbody = document.getElementById('raritiesList');
      
      if (raritiesData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>`;
        return;
      }

      tbody.innerHTML = raritiesData.map(item => `
        <tr class="dict-item-row">
          <td><code>${escapeHtml(item.rarity_code)}</code></td>
          <td>${escapeHtml(item.display_name)}</td>
          <td><span class="badge bg-info tier-badge">${item.tier || 1}</span></td>
          <td>
            ${item.color_hex ? 
              `<span class="color-preview" style="background:${item.color_hex}"></span> <code>${item.color_hex}</code>` : 
              '-'}
          </td>
          <td><span class="badge bg-secondary">${item.sort_order || 0}</span></td>
          <td><span class="badge ${item.is_enabled ? 'bg-success' : 'bg-secondary'}">${item.is_enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="editRarity('${item.rarity_code}')"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteRarity('${item.rarity_code}')"><i class="bi bi-trash"></i></button>
          </td>
        </tr>
      `).join('');
    }

    // æ¸²æŸ“èµ„äº§åˆ†ç»„åˆ—è¡¨
    function renderAssetGroups() {
      const tbody = document.getElementById('assetGroupsList');
      
      if (assetGroupsData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>`;
        return;
      }

      const typeLabels = { system: 'ç³»ç»Ÿ', material: 'ææ–™', custom: 'è‡ªå®šä¹‰' };

      tbody.innerHTML = assetGroupsData.map(item => `
        <tr class="dict-item-row">
          <td><code>${escapeHtml(item.group_code)}</code></td>
          <td>${escapeHtml(item.display_name)}</td>
          <td><span class="badge bg-info">${typeLabels[item.group_type] || item.group_type}</span></td>
          <td>
            ${item.color_hex ? 
              `<span class="color-preview" style="background:${item.color_hex}"></span> <code>${item.color_hex}</code>` : 
              '-'}
          </td>
          <td><span class="badge ${item.is_tradable ? 'bg-success' : 'bg-warning'}">${item.is_tradable ? 'æ˜¯' : 'å¦'}</span></td>
          <td><span class="badge bg-secondary">${item.sort_order || 0}</span></td>
          <td><span class="badge ${item.is_enabled ? 'bg-success' : 'bg-secondary'}">${item.is_enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="editAssetGroup('${item.group_code}')"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteAssetGroup('${item.group_code}')"><i class="bi bi-trash"></i></button>
          </td>
        </tr>
      `).join('');
    }

    // æ‰“å¼€æ–°å¢æ¨¡æ€æ¡†
    function openAddModal() {
      switch (currentDictType) {
        case 'categories':
          document.getElementById('categoryModalTitle').innerHTML = '<i class="bi bi-folder-plus"></i> æ–°å¢ç±»ç›®';
          document.getElementById('categoryForm').reset();
          document.getElementById('categoryEditCode').value = '';
          document.getElementById('categoryCode').disabled = false;
          new bootstrap.Modal(document.getElementById('categoryModal')).show();
          break;
        case 'rarities':
          document.getElementById('rarityModalTitle').innerHTML = '<i class="bi bi-gem"></i> æ–°å¢ç¨€æœ‰åº¦';
          document.getElementById('rarityForm').reset();
          document.getElementById('rarityEditCode').value = '';
          document.getElementById('rarityCode').disabled = false;
          document.getElementById('rarityColorPicker').value = '#6c757d';
          document.getElementById('rarityColorHex').value = '';
          new bootstrap.Modal(document.getElementById('rarityModal')).show();
          break;
        case 'asset-groups':
          document.getElementById('assetGroupModalTitle').innerHTML = '<i class="bi bi-collection"></i> æ–°å¢èµ„äº§åˆ†ç»„';
          document.getElementById('assetGroupForm').reset();
          document.getElementById('assetGroupEditCode').value = '';
          document.getElementById('assetGroupCode').disabled = false;
          document.getElementById('assetGroupColorPicker').value = '#28a745';
          document.getElementById('assetGroupColorHex').value = '';
          new bootstrap.Modal(document.getElementById('assetGroupModal')).show();
          break;
      }
    }

    // ===== ç±»ç›®æ“ä½œ =====
    function editCategory(code) {
      const item = categoriesData.find(c => c.category_code === code);
      if (!item) return;

      document.getElementById('categoryModalTitle').innerHTML = '<i class="bi bi-pencil"></i> ç¼–è¾‘ç±»ç›®';
      document.getElementById('categoryEditCode').value = item.category_code;
      document.getElementById('categoryCode').value = item.category_code;
      document.getElementById('categoryCode').disabled = true;
      document.getElementById('categoryDisplayName').value = item.display_name || '';
      document.getElementById('categoryDescription').value = item.description || '';
      document.getElementById('categoryIconUrl').value = item.icon_url || '';
      document.getElementById('categorySortOrder').value = item.sort_order || 0;
      document.getElementById('categoryIsEnabled').value = item.is_enabled ? 'true' : 'false';
      
      new bootstrap.Modal(document.getElementById('categoryModal')).show();
    }

    async function submitCategory() {
      if (isSubmitting) return;
      
      const editCode = document.getElementById('categoryEditCode').value;
      const data = {
        category_code: document.getElementById('categoryCode').value.trim(),
        display_name: document.getElementById('categoryDisplayName').value.trim(),
        description: document.getElementById('categoryDescription').value.trim() || null,
        icon_url: document.getElementById('categoryIconUrl').value.trim() || null,
        sort_order: parseInt(document.getElementById('categorySortOrder').value) || 0,
        is_enabled: document.getElementById('categoryIsEnabled').value === 'true'
      };

      if (!data.category_code || !data.display_name) {
        alert('è¯·å¡«å†™ç±»ç›®ä»£ç å’Œæ˜¾ç¤ºåç§°');
        return;
      }

      // è‡ªåŠ¨è½¬æ¢ä¸ºå°å†™å¹¶éªŒè¯ä»£ç æ ¼å¼
      data.category_code = data.category_code.toLowerCase();
      if (!/^[a-z][a-z0-9_]*$/.test(data.category_code)) {
        alert('ç±»ç›®ä»£ç æ ¼å¼é”™è¯¯ï¼šå¿…é¡»ä»¥å°å†™å­—æ¯å¼€å¤´ï¼Œä»…åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿');
        return;
      }

      isSubmitting = true;
      showLoading();
      try {
        const url = editCode
          ? API.buildURL(API_ENDPOINTS.DICT.UPDATE_CATEGORY, { code: editCode })
          : API_ENDPOINTS.DICT.CREATE_CATEGORY;
        const method = editCode ? 'PUT' : 'POST';

        const response = await apiRequest(url, { method, body: JSON.stringify(data) });

        if (response && response.success) {
          bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
          alert(`âœ… ${editCode ? 'æ›´æ–°' : 'åˆ›å»º'}æˆåŠŸ`);
          loadAllData();
        } else {
          showError('ä¿å­˜å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        showError('ä¿å­˜å¤±è´¥', error.message);
      } finally {
        isSubmitting = false;
        hideLoading();
      }
    }

    async function deleteCategory(code) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤ç±»ç›® "${code}" å—ï¼Ÿ`)) return;

      showLoading();
      try {
        const response = await apiRequest(API.buildURL(API_ENDPOINTS.DICT.DELETE_CATEGORY, { code }), { method: 'DELETE' });
        if (response && response.success) {
          alert('âœ… åˆ é™¤æˆåŠŸ');
          loadAllData();
        } else {
          showError('åˆ é™¤å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        showError('åˆ é™¤å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }

    // ===== ç¨€æœ‰åº¦æ“ä½œ =====
    function editRarity(code) {
      const item = raritiesData.find(r => r.rarity_code === code);
      if (!item) return;

      document.getElementById('rarityModalTitle').innerHTML = '<i class="bi bi-pencil"></i> ç¼–è¾‘ç¨€æœ‰åº¦';
      document.getElementById('rarityEditCode').value = item.rarity_code;
      document.getElementById('rarityCode').value = item.rarity_code;
      document.getElementById('rarityCode').disabled = true;
      document.getElementById('rarityDisplayName').value = item.display_name || '';
      document.getElementById('rarityDescription').value = item.description || '';
      document.getElementById('rarityTier').value = item.tier || 1;
      document.getElementById('rarityColorHex').value = item.color_hex || '';
      document.getElementById('rarityColorPicker').value = item.color_hex || '#6c757d';
      document.getElementById('raritySortOrder').value = item.sort_order || 0;
      document.getElementById('rarityIsEnabled').value = item.is_enabled ? 'true' : 'false';
      
      new bootstrap.Modal(document.getElementById('rarityModal')).show();
    }

    async function submitRarity() {
      if (isSubmitting) return;
      
      const editCode = document.getElementById('rarityEditCode').value;
      const data = {
        rarity_code: document.getElementById('rarityCode').value.trim(),
        display_name: document.getElementById('rarityDisplayName').value.trim(),
        description: document.getElementById('rarityDescription').value.trim() || null,
        tier: parseInt(document.getElementById('rarityTier').value) || 1,
        color_hex: document.getElementById('rarityColorHex').value.trim() || null,
        sort_order: parseInt(document.getElementById('raritySortOrder').value) || 0,
        is_enabled: document.getElementById('rarityIsEnabled').value === 'true'
      };

      if (!data.rarity_code || !data.display_name) {
        alert('è¯·å¡«å†™ç¨€æœ‰åº¦ä»£ç å’Œæ˜¾ç¤ºåç§°');
        return;
      }

      // è‡ªåŠ¨è½¬æ¢ä¸ºå°å†™å¹¶éªŒè¯ä»£ç æ ¼å¼
      data.rarity_code = data.rarity_code.toLowerCase();
      if (!/^[a-z][a-z0-9_]*$/.test(data.rarity_code)) {
        alert('ç¨€æœ‰åº¦ä»£ç æ ¼å¼é”™è¯¯ï¼šå¿…é¡»ä»¥å°å†™å­—æ¯å¼€å¤´ï¼Œä»…åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿');
        return;
      }

      isSubmitting = true;
      showLoading();
      try {
        const url = editCode
          ? API.buildURL(API_ENDPOINTS.DICT.UPDATE_RARITY, { code: editCode })
          : API_ENDPOINTS.DICT.CREATE_RARITY;
        const method = editCode ? 'PUT' : 'POST';

        const response = await apiRequest(url, { method, body: JSON.stringify(data) });

        if (response && response.success) {
          bootstrap.Modal.getInstance(document.getElementById('rarityModal')).hide();
          alert(`âœ… ${editCode ? 'æ›´æ–°' : 'åˆ›å»º'}æˆåŠŸ`);
          loadAllData();
        } else {
          showError('ä¿å­˜å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        showError('ä¿å­˜å¤±è´¥', error.message);
      } finally {
        isSubmitting = false;
        hideLoading();
      }
    }

    async function deleteRarity(code) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤ç¨€æœ‰åº¦ "${code}" å—ï¼Ÿ`)) return;

      showLoading();
      try {
        const response = await apiRequest(API.buildURL(API_ENDPOINTS.DICT.DELETE_RARITY, { code }), { method: 'DELETE' });
        if (response && response.success) {
          alert('âœ… åˆ é™¤æˆåŠŸ');
          loadAllData();
        } else {
          showError('åˆ é™¤å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        showError('åˆ é™¤å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }

    // ===== èµ„äº§åˆ†ç»„æ“ä½œ =====
    function editAssetGroup(code) {
      const item = assetGroupsData.find(g => g.group_code === code);
      if (!item) return;

      document.getElementById('assetGroupModalTitle').innerHTML = '<i class="bi bi-pencil"></i> ç¼–è¾‘èµ„äº§åˆ†ç»„';
      document.getElementById('assetGroupEditCode').value = item.group_code;
      document.getElementById('assetGroupCode').value = item.group_code;
      document.getElementById('assetGroupCode').disabled = true;
      document.getElementById('assetGroupDisplayName').value = item.display_name || '';
      document.getElementById('assetGroupDescription').value = item.description || '';
      document.getElementById('assetGroupType').value = item.group_type || 'material';
      document.getElementById('assetGroupColorHex').value = item.color_hex || '';
      document.getElementById('assetGroupColorPicker').value = item.color_hex || '#28a745';
      document.getElementById('assetGroupSortOrder').value = item.sort_order || 0;
      document.getElementById('assetGroupIsTradable').value = item.is_tradable ? 'true' : 'false';
      document.getElementById('assetGroupIsEnabled').value = item.is_enabled ? 'true' : 'false';
      
      new bootstrap.Modal(document.getElementById('assetGroupModal')).show();
    }

    async function submitAssetGroup() {
      if (isSubmitting) return;
      
      const editCode = document.getElementById('assetGroupEditCode').value;
      const data = {
        group_code: document.getElementById('assetGroupCode').value.trim(),
        display_name: document.getElementById('assetGroupDisplayName').value.trim(),
        description: document.getElementById('assetGroupDescription').value.trim() || null,
        group_type: document.getElementById('assetGroupType').value,
        color_hex: document.getElementById('assetGroupColorHex').value.trim() || null,
        sort_order: parseInt(document.getElementById('assetGroupSortOrder').value) || 0,
        is_tradable: document.getElementById('assetGroupIsTradable').value === 'true',
        is_enabled: document.getElementById('assetGroupIsEnabled').value === 'true'
      };

      if (!data.group_code || !data.display_name) {
        alert('è¯·å¡«å†™åˆ†ç»„ä»£ç å’Œæ˜¾ç¤ºåç§°');
        return;
      }

      // è‡ªåŠ¨è½¬æ¢ä¸ºå°å†™å¹¶éªŒè¯ä»£ç æ ¼å¼
      data.group_code = data.group_code.toLowerCase();
      if (!/^[a-z][a-z0-9_]*$/.test(data.group_code)) {
        alert('åˆ†ç»„ä»£ç æ ¼å¼é”™è¯¯ï¼šå¿…é¡»ä»¥å°å†™å­—æ¯å¼€å¤´ï¼Œä»…åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿');
        return;
      }

      isSubmitting = true;
      showLoading();
      try {
        const url = editCode
          ? API.buildURL(API_ENDPOINTS.DICT.UPDATE_ASSET_GROUP, { code: editCode })
          : API_ENDPOINTS.DICT.CREATE_ASSET_GROUP;
        const method = editCode ? 'PUT' : 'POST';

        const response = await apiRequest(url, { method, body: JSON.stringify(data) });

        if (response && response.success) {
          bootstrap.Modal.getInstance(document.getElementById('assetGroupModal')).hide();
          alert(`âœ… ${editCode ? 'æ›´æ–°' : 'åˆ›å»º'}æˆåŠŸ`);
          loadAllData();
        } else {
          showError('ä¿å­˜å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        showError('ä¿å­˜å¤±è´¥', error.message);
      } finally {
        isSubmitting = false;
        hideLoading();
      }
    }

    async function deleteAssetGroup(code) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤èµ„äº§åˆ†ç»„ "${code}" å—ï¼Ÿ`)) return;

      showLoading();
      try {
        const response = await apiRequest(API.buildURL(API_ENDPOINTS.DICT.DELETE_ASSET_GROUP, { code }), { method: 'DELETE' });
        if (response && response.success) {
          alert('âœ… åˆ é™¤æˆåŠŸ');
          loadAllData();
        } else {
          showError('åˆ é™¤å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        showError('åˆ é™¤å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }

    // ===== å·¥å…·å‡½æ•° =====
    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('show');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('show');
    }

    function showError(title, message) {
      alert(`âŒ ${title}\n${message}`);
    }
  </script>
</body>
</html>
