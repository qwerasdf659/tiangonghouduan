<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­—å…¸ç®¡ç† - ç®¡ç†åå°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">
  <style>
    .dict-tab-btn {
      cursor: pointer;
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
    }
    .dict-tab-btn:hover,
    .dict-tab-btn.active {
      border-left-color: #0d6efd;
      background: #e7f1ff;
    }
    .dict-item-row:hover {
      background: #f8f9fa;
    }
    .color-preview {
      display: inline-block;
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 1px solid #dee2e6;
      vertical-align: middle;
    }
    .tier-badge {
      font-weight: bold;
      min-width: 24px;
    }
    [x-cloak] { display: none !important; }
  </style>

  <!-- Alpine.js -->
  <script defer src="/admin/js/alpine/init.js"></script>
  <script defer src="/admin/js/vendor/alpine.min.js"></script>
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ“– ç®¡ç†åå° - å­—å…¸ç®¡ç†
      </a>
      <div>
        <span class="text-light me-3" x-data x-text="$store.auth.user?.nickname ? `æ¬¢è¿ï¼Œ${$store.auth.user.nickname}` : 'æ¬¢è¿ï¼Œç®¡ç†å‘˜'">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" onclick="logout()">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4" x-data="dictManagementPage()" x-cloak>
    <div class="row">
      <!-- å·¦ä¾§ï¼šå­—å…¸ç±»å‹é€‰æ‹© -->
      <div class="col-md-3">
        <div class="card">
          <div class="card-header bg-white">
            <h6 class="mb-0"><i class="bi bi-book"></i> å­—å…¸ç±»å‹</h6>
          </div>
          <div class="card-body p-0">
            <div class="dict-tab-btn p-3 border-bottom" :class="{ 'active': currentDictType === 'categories' }" @click="switchDictType('categories')">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1"><i class="bi bi-folder text-primary"></i> ç‰©å“ç±»ç›®</h6>
                  <small class="text-muted">category_defs</small>
                </div>
                <span class="badge bg-primary" x-text="categoriesData.length">-</span>
              </div>
            </div>
            <div class="dict-tab-btn p-3 border-bottom" :class="{ 'active': currentDictType === 'rarities' }" @click="switchDictType('rarities')">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1"><i class="bi bi-gem text-warning"></i> ç¨€æœ‰åº¦</h6>
                  <small class="text-muted">rarity_defs</small>
                </div>
                <span class="badge bg-warning text-dark" x-text="raritiesData.length">-</span>
              </div>
            </div>
            <div class="dict-tab-btn p-3" :class="{ 'active': currentDictType === 'asset-groups' }" @click="switchDictType('asset-groups')">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1"><i class="bi bi-collection text-success"></i> èµ„äº§åˆ†ç»„</h6>
                  <small class="text-muted">asset_group_defs</small>
                </div>
                <span class="badge bg-success" x-text="assetGroupsData.length">-</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§ï¼šå­—å…¸æ•°æ®è¡¨æ ¼ -->
      <div class="col-md-9">
        <div class="card">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
              <i class="bi bi-list-ul"></i> 
              <span x-text="dictTitles[currentDictType]">ç‰©å“ç±»ç›®åˆ—è¡¨</span>
            </h6>
            <button class="btn btn-sm btn-success" @click="openAddModal()">
              <i class="bi bi-plus"></i> æ–°å¢
            </button>
          </div>
          <div class="card-body">
            <!-- ç±»ç›®è¡¨æ ¼ -->
            <div class="table-responsive" x-show="currentDictType === 'categories'" x-cloak>
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>ç±»ç›®ä»£ç </th>
                    <th>æ˜¾ç¤ºåç§°</th>
                    <th>å›¾æ ‡</th>
                    <th>æ’åº</th>
                    <th>çŠ¶æ€</th>
                    <th style="width: 120px;">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-if="categoriesData.length === 0">
                    <tr><td colspan="6" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>
                  </template>
                  <template x-for="item in categoriesData" :key="item.category_code">
                    <tr class="dict-item-row">
                      <td><code x-text="item.category_code"></code></td>
                      <td x-text="item.display_name"></td>
                      <td>
                        <template x-if="item.icon_url">
                          <img :src="item.icon_url" alt="" style="width:24px;height:24px;">
                        </template>
                        <template x-if="!item.icon_url">-</template>
                      </td>
                      <td><span class="badge bg-secondary" x-text="item.sort_order || 0"></span></td>
                      <td><span class="badge" :class="item.is_enabled ? 'bg-success' : 'bg-secondary'" x-text="item.is_enabled ? 'å¯ç”¨' : 'ç¦ç”¨'"></span></td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary me-1" @click="editCategory(item)"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger" @click="deleteCategory(item.category_code)"><i class="bi bi-trash"></i></button>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- ç¨€æœ‰åº¦è¡¨æ ¼ -->
            <div class="table-responsive" x-show="currentDictType === 'rarities'" x-cloak>
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>ç¨€æœ‰åº¦ä»£ç </th>
                    <th>æ˜¾ç¤ºåç§°</th>
                    <th>ç­‰çº§</th>
                    <th>é¢œè‰²</th>
                    <th>æ’åº</th>
                    <th>çŠ¶æ€</th>
                    <th style="width: 120px;">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-if="raritiesData.length === 0">
                    <tr><td colspan="7" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>
                  </template>
                  <template x-for="item in raritiesData" :key="item.rarity_code">
                    <tr class="dict-item-row">
                      <td><code x-text="item.rarity_code"></code></td>
                      <td x-text="item.display_name"></td>
                      <td><span class="badge bg-info tier-badge" x-text="item.tier || 1"></span></td>
                      <td>
                        <template x-if="item.color_hex">
                          <span>
                            <span class="color-preview" :style="`background:${item.color_hex}`"></span>
                            <code x-text="item.color_hex"></code>
                          </span>
                        </template>
                        <template x-if="!item.color_hex">-</template>
                      </td>
                      <td><span class="badge bg-secondary" x-text="item.sort_order || 0"></span></td>
                      <td><span class="badge" :class="item.is_enabled ? 'bg-success' : 'bg-secondary'" x-text="item.is_enabled ? 'å¯ç”¨' : 'ç¦ç”¨'"></span></td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary me-1" @click="editRarity(item)"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger" @click="deleteRarity(item.rarity_code)"><i class="bi bi-trash"></i></button>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- èµ„äº§åˆ†ç»„è¡¨æ ¼ -->
            <div class="table-responsive" x-show="currentDictType === 'asset-groups'" x-cloak>
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>åˆ†ç»„ä»£ç </th>
                    <th>æ˜¾ç¤ºåç§°</th>
                    <th>åˆ†ç»„ç±»å‹</th>
                    <th>é¢œè‰²</th>
                    <th>å¯äº¤æ˜“</th>
                    <th>æ’åº</th>
                    <th>çŠ¶æ€</th>
                    <th style="width: 120px;">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-if="assetGroupsData.length === 0">
                    <tr><td colspan="8" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>
                  </template>
                  <template x-for="item in assetGroupsData" :key="item.group_code">
                    <tr class="dict-item-row">
                      <td><code x-text="item.group_code"></code></td>
                      <td x-text="item.display_name"></td>
                      <td><span class="badge bg-info" x-text="getGroupTypeLabel(item.group_type)"></span></td>
                      <td>
                        <template x-if="item.color_hex">
                          <span>
                            <span class="color-preview" :style="`background:${item.color_hex}`"></span>
                            <code x-text="item.color_hex"></code>
                          </span>
                        </template>
                        <template x-if="!item.color_hex">-</template>
                      </td>
                      <td><span class="badge" :class="item.is_tradable ? 'bg-success' : 'bg-warning'" x-text="item.is_tradable ? 'æ˜¯' : 'å¦'"></span></td>
                      <td><span class="badge bg-secondary" x-text="item.sort_order || 0"></span></td>
                      <td><span class="badge" :class="item.is_enabled ? 'bg-success' : 'bg-secondary'" x-text="item.is_enabled ? 'å¯ç”¨' : 'ç¦ç”¨'"></span></td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary me-1" @click="editAssetGroup(item)"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger" @click="deleteAssetGroup(item.group_code)"><i class="bi bi-trash"></i></button>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç±»ç›®ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal fade" id="categoryModal" tabindex="-1" x-ref="categoryModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" x-text="categoryForm.editCode ? 'ç¼–è¾‘ç±»ç›®' : 'æ–°å¢ç±»ç›®'"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form @submit.prevent="submitCategory">
              <div class="mb-3">
                <label class="form-label">ç±»ç›®ä»£ç  <span class="text-danger">*</span></label>
                <input type="text" class="form-control" x-model="categoryForm.code" :disabled="!!categoryForm.editCode" required placeholder="å¦‚ï¼šconsumableã€equipment">
                <small class="text-muted">å°å†™å­—æ¯å¼€å¤´ï¼Œä»…åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿</small>
              </div>
              <div class="mb-3">
                <label class="form-label">æ˜¾ç¤ºåç§° <span class="text-danger">*</span></label>
                <input type="text" class="form-control" x-model="categoryForm.displayName" required placeholder="å¦‚ï¼šæ¶ˆè€—å“ã€è£…å¤‡">
              </div>
              <div class="mb-3">
                <label class="form-label">æè¿°</label>
                <textarea class="form-control" x-model="categoryForm.description" rows="2"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">å›¾æ ‡URL</label>
                <input type="text" class="form-control" x-model="categoryForm.iconUrl" placeholder="https://...">
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">æ’åº</label>
                  <input type="number" class="form-control" x-model.number="categoryForm.sortOrder" min="0">
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">çŠ¶æ€</label>
                  <select class="form-select" x-model="categoryForm.isEnabled">
                    <option :value="true">å¯ç”¨</option>
                    <option :value="false">ç¦ç”¨</option>
                  </select>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary" :disabled="isSubmitting">ä¿å­˜</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- ç¨€æœ‰åº¦ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal fade" id="rarityModal" tabindex="-1" x-ref="rarityModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" x-text="rarityForm.editCode ? 'ç¼–è¾‘ç¨€æœ‰åº¦' : 'æ–°å¢ç¨€æœ‰åº¦'"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form @submit.prevent="submitRarity">
              <div class="mb-3">
                <label class="form-label">ç¨€æœ‰åº¦ä»£ç  <span class="text-danger">*</span></label>
                <input type="text" class="form-control" x-model="rarityForm.code" :disabled="!!rarityForm.editCode" required placeholder="å¦‚ï¼šcommonã€rareã€legendary">
              </div>
              <div class="mb-3">
                <label class="form-label">æ˜¾ç¤ºåç§° <span class="text-danger">*</span></label>
                <input type="text" class="form-control" x-model="rarityForm.displayName" required placeholder="å¦‚ï¼šæ™®é€šã€ç¨€æœ‰ã€ä¼ è¯´">
              </div>
              <div class="mb-3">
                <label class="form-label">æè¿°</label>
                <textarea class="form-control" x-model="rarityForm.description" rows="2"></textarea>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">ç­‰çº§ (tier)</label>
                  <input type="number" class="form-control" x-model.number="rarityForm.tier" min="1">
                  <small class="text-muted">æ•°å€¼è¶Šå¤§è¶Šç¨€æœ‰</small>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">ä¸»é¢˜é¢œè‰²</label>
                  <div class="input-group">
                    <input type="color" class="form-control form-control-color" x-model="rarityForm.colorHex" @input="syncColorHex('rarity')">
                    <input type="text" class="form-control" x-model="rarityForm.colorHex" placeholder="#RRGGBB">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">æ’åº</label>
                  <input type="number" class="form-control" x-model.number="rarityForm.sortOrder" min="0">
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">çŠ¶æ€</label>
                  <select class="form-select" x-model="rarityForm.isEnabled">
                    <option :value="true">å¯ç”¨</option>
                    <option :value="false">ç¦ç”¨</option>
                  </select>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary" :disabled="isSubmitting">ä¿å­˜</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- èµ„äº§åˆ†ç»„ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal fade" id="assetGroupModal" tabindex="-1" x-ref="assetGroupModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" x-text="assetGroupForm.editCode ? 'ç¼–è¾‘èµ„äº§åˆ†ç»„' : 'æ–°å¢èµ„äº§åˆ†ç»„'"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form @submit.prevent="submitAssetGroup">
              <div class="mb-3">
                <label class="form-label">åˆ†ç»„ä»£ç  <span class="text-danger">*</span></label>
                <input type="text" class="form-control" x-model="assetGroupForm.code" :disabled="!!assetGroupForm.editCode" required placeholder="å¦‚ï¼šmaterialã€currency">
              </div>
              <div class="mb-3">
                <label class="form-label">æ˜¾ç¤ºåç§° <span class="text-danger">*</span></label>
                <input type="text" class="form-control" x-model="assetGroupForm.displayName" required placeholder="å¦‚ï¼šææ–™ã€è´§å¸">
              </div>
              <div class="mb-3">
                <label class="form-label">æè¿°</label>
                <textarea class="form-control" x-model="assetGroupForm.description" rows="2"></textarea>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">åˆ†ç»„ç±»å‹</label>
                  <select class="form-select" x-model="assetGroupForm.groupType">
                    <option value="system">ç³»ç»Ÿ (system)</option>
                    <option value="material">ææ–™ (material)</option>
                    <option value="custom">è‡ªå®šä¹‰ (custom)</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">ä¸»é¢˜é¢œè‰²</label>
                  <div class="input-group">
                    <input type="color" class="form-control form-control-color" x-model="assetGroupForm.colorHex" @input="syncColorHex('assetGroup')">
                    <input type="text" class="form-control" x-model="assetGroupForm.colorHex" placeholder="#RRGGBB">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label">æ’åº</label>
                  <input type="number" class="form-control" x-model.number="assetGroupForm.sortOrder" min="0">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">å¯äº¤æ˜“</label>
                  <select class="form-select" x-model="assetGroupForm.isTradable">
                    <option :value="true">æ˜¯</option>
                    <option :value="false">å¦</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">çŠ¶æ€</label>
                  <select class="form-select" x-model="assetGroupForm.isEnabled">
                    <option :value="true">å¯ç”¨</option>
                    <option :value="false">ç¦ç”¨</option>
                  </select>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary" :disabled="isSubmitting">ä¿å­˜</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">åŠ è½½ä¸­...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script src="/admin/js/api-config.js"></script>
  <script src="/admin/js/pages/dict-management.js"></script>
</body>
</html>
