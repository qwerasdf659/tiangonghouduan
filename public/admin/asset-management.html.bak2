<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">èµ„äº§ç®¡ç† - ç®¡ç†åå°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">
  <style>
    .sub-nav { background: #f8f9fa; border-bottom: 1px solid #dee2e6; padding: 0.5rem 0; }
    .sub-nav .nav-link { color: #495057; padding: 0.5rem 1rem; border-radius: 0.25rem; margin: 0 0.25rem; }
    .sub-nav .nav-link:hover { background: #e9ecef; }
    .sub-nav .nav-link.active { background: #0d6efd; color: white; }
    [x-cloak] { display: none !important; }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸª ç®¡ç†åå° - èµ„äº§ç®¡ç†
      </a>
      <div>
        <span class="text-light me-3" x-data x-text="$store.auth.user?.nickname ? `æ¬¢è¿ï¼Œ${$store.auth.user.nickname}` : 'æ¬¢è¿ï¼Œç®¡ç†å‘˜'">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" onclick="logout()">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>

  <!-- å­æ¨¡å—å¯¼èˆª -->
  <div class="sub-nav" x-data="assetNavigation()">
    <div class="container-fluid">
      <ul class="nav nav-pills">
        <template x-for="page in subPages" :key="page.id">
          <li class="nav-item">
            <a class="nav-link" :class="{ 'active': currentPage === page.id }" :href="'?page=' + page.id" @click.prevent="switchPage(page.id)">
              <i class="bi me-1" :class="page.icon"></i><span x-text="page.title"></span>
            </a>
          </li>
        </template>
      </ul>
    </div>
  </div>

  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <div class="container-fluid mt-4" x-data="assetPageContent()" x-cloak>
    <!-- ææ–™èµ„äº§ç±»å‹ -->
    <div x-show="currentPage === 'material-types'" x-cloak>
      <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-archive"></i> ææ–™èµ„äº§ç±»å‹</h5>
          <button class="btn btn-primary btn-sm" @click="openCreateModal('material-type')">
            <i class="bi bi-plus"></i> æ–°å»ºç±»å‹
          </button>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>èµ„äº§ä»£ç </th>
                  <th>åç§°</th>
                  <th>åˆ†ç±»</th>
                  <th>å•ä½</th>
                  <th>æ˜¯å¦å¯äº¤æ˜“</th>
                  <th>çŠ¶æ€</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                <template x-if="materialTypes.length === 0">
                  <tr><td colspan="7" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>
                </template>
                <template x-for="item in materialTypes" :key="item.asset_code">
                  <tr>
                    <td><code x-text="item.asset_code"></code></td>
                    <td x-text="item.name"></td>
                    <td x-text="item.category || '-'"></td>
                    <td x-text="item.unit || 'ä¸ª'"></td>
                    <td><span class="badge" :class="item.is_tradeable ? 'bg-success' : 'bg-secondary'" x-text="item.is_tradeable ? 'æ˜¯' : 'å¦'"></span></td>
                    <td><span class="badge" :class="item.is_enabled ? 'bg-success' : 'bg-secondary'" x-text="item.is_enabled ? 'å¯ç”¨' : 'ç¦ç”¨'"></span></td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary" @click="editItem('material-type', item)"><i class="bi bi-pencil"></i></button>
                      <button class="btn btn-sm btn-outline-danger" @click="deleteItem('material-type', item.asset_code)"><i class="bi bi-trash"></i></button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ææ–™èµ„äº§è´¦æˆ· -->
    <div x-show="currentPage === 'material-accounts'" x-cloak>
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="bi bi-wallet2"></i> ææ–™èµ„äº§è´¦æˆ·</h5>
        </div>
        <div class="card-body">
          <!-- ç­›é€‰å™¨ -->
          <div class="row mb-3 g-2">
            <div class="col-md-3">
              <input type="text" class="form-control form-control-sm" placeholder="ç”¨æˆ·ID" x-model="materialAccountFilters.user_id">
            </div>
            <div class="col-md-3">
              <select class="form-select form-select-sm" x-model="materialAccountFilters.asset_code">
                <option value="">å…¨éƒ¨èµ„äº§ç±»å‹</option>
                <template x-for="type in materialTypes" :key="type.asset_code">
                  <option :value="type.asset_code" x-text="type.name"></option>
                </template>
              </select>
            </div>
            <div class="col-md-2">
              <button class="btn btn-primary btn-sm w-100" @click="loadMaterialAccounts()">
                <i class="bi bi-search"></i> æœç´¢
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>ç”¨æˆ·ID</th>
                  <th>èµ„äº§ç±»å‹</th>
                  <th>ä½™é¢</th>
                  <th>å†»ç»“</th>
                  <th>å¯ç”¨</th>
                  <th>æ›´æ–°æ—¶é—´</th>
                </tr>
              </thead>
              <tbody>
                <template x-if="materialAccounts.length === 0">
                  <tr><td colspan="6" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>
                </template>
                <template x-for="account in materialAccounts" :key="account.account_id">
                  <tr>
                    <td x-text="account.user_id"></td>
                    <td x-text="account.asset_name || account.asset_code"></td>
                    <td class="text-success" x-text="account.balance"></td>
                    <td class="text-warning" x-text="account.frozen || 0"></td>
                    <td class="text-primary" x-text="account.available || account.balance"></td>
                    <td x-text="$format.date(account.updated_at)"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ææ–™èµ„äº§äº¤æ˜“ -->
    <div x-show="currentPage === 'material-transactions'" x-cloak>
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="bi bi-arrow-left-right"></i> ææ–™èµ„äº§äº¤æ˜“è®°å½•</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>äº¤æ˜“ID</th>
                  <th>ç”¨æˆ·</th>
                  <th>èµ„äº§ç±»å‹</th>
                  <th>å˜åŠ¨ç±»å‹</th>
                  <th>å˜åŠ¨æ•°é‡</th>
                  <th>ä½™é¢å‰</th>
                  <th>ä½™é¢å</th>
                  <th>æ—¶é—´</th>
                </tr>
              </thead>
              <tbody>
                <template x-if="materialTransactions.length === 0">
                  <tr><td colspan="8" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>
                </template>
                <template x-for="tx in materialTransactions" :key="tx.transaction_id">
                  <tr>
                    <td><code x-text="tx.transaction_id"></code></td>
                    <td x-text="tx.user_nickname || tx.user_id"></td>
                    <td x-text="tx.asset_name || tx.asset_code"></td>
                    <td><span class="badge" :class="tx.change_type === 'credit' ? 'bg-success' : 'bg-danger'" x-text="tx.change_type === 'credit' ? 'å¢åŠ ' : 'å‡å°‘'"></span></td>
                    <td :class="tx.change_type === 'credit' ? 'text-success' : 'text-danger'" x-text="(tx.change_type === 'credit' ? '+' : '-') + tx.amount"></td>
                    <td x-text="tx.balance_before"></td>
                    <td x-text="tx.balance_after"></td>
                    <td x-text="$format.date(tx.created_at)"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ç‰©å“å®ä¾‹ -->
    <div x-show="currentPage === 'item-instances'" x-cloak>
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="bi bi-collection"></i> ç‰©å“å®ä¾‹</h5>
        </div>
        <div class="card-body">
          <!-- ç­›é€‰å™¨ -->
          <div class="row mb-3 g-2">
            <div class="col-md-3">
              <input type="text" class="form-control form-control-sm" placeholder="ç”¨æˆ·ID" x-model="itemInstanceFilters.user_id">
            </div>
            <div class="col-md-3">
              <select class="form-select form-select-sm" x-model="itemInstanceFilters.status">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="active">æ­£å¸¸</option>
                <option value="used">å·²ä½¿ç”¨</option>
                <option value="expired">å·²è¿‡æœŸ</option>
              </select>
            </div>
            <div class="col-md-2">
              <button class="btn btn-primary btn-sm w-100" @click="loadItemInstances()">
                <i class="bi bi-search"></i> æœç´¢
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>å®ä¾‹ID</th>
                  <th>ç‰©å“åç§°</th>
                  <th>æ‹¥æœ‰è€…</th>
                  <th>çŠ¶æ€</th>
                  <th>è·å–æ¥æº</th>
                  <th>åˆ›å»ºæ—¶é—´</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                <template x-if="itemInstances.length === 0">
                  <tr><td colspan="7" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>
                </template>
                <template x-for="instance in itemInstances" :key="instance.instance_id">
                  <tr>
                    <td><code x-text="instance.instance_id"></code></td>
                    <td x-text="instance.item_name || instance.template_id"></td>
                    <td x-text="instance.owner_nickname || instance.owner_user_id"></td>
                    <td><span class="badge" :class="getInstanceStatusClass(instance.status)" x-text="getInstanceStatusText(instance.status)"></span></td>
                    <td x-text="instance.source || '-'"></td>
                    <td x-text="$format.date(instance.created_at)"></td>
                    <td>
                      <button class="btn btn-sm btn-outline-info" @click="viewInstanceDetail(instance)"><i class="bi bi-eye"></i></button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- è™šæ‹Ÿèµ„äº§è´¦æˆ· -->
    <div x-show="currentPage === 'virtual-accounts'" x-cloak>
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="bi bi-coin"></i> è™šæ‹Ÿèµ„äº§è´¦æˆ·</h5>
        </div>
        <div class="card-body">
          <!-- ç­›é€‰å™¨ -->
          <div class="row mb-3 g-2">
            <div class="col-md-3">
              <input type="text" class="form-control form-control-sm" placeholder="ç”¨æˆ·ID" x-model="virtualAccountFilters.user_id">
            </div>
            <div class="col-md-3">
              <select class="form-select form-select-sm" x-model="virtualAccountFilters.currency_type">
                <option value="">å…¨éƒ¨è´§å¸</option>
                <option value="coins">é‡‘å¸</option>
                <option value="diamonds">é’»çŸ³</option>
                <option value="points">ç§¯åˆ†</option>
              </select>
            </div>
            <div class="col-md-2">
              <button class="btn btn-primary btn-sm w-100" @click="loadVirtualAccounts()">
                <i class="bi bi-search"></i> æœç´¢
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>ç”¨æˆ·ID</th>
                  <th>ç”¨æˆ·æ˜µç§°</th>
                  <th>è´§å¸ç±»å‹</th>
                  <th>æ€»ä½™é¢</th>
                  <th>å¯ç”¨ä½™é¢</th>
                  <th>å†»ç»“é‡‘é¢</th>
                  <th>æ›´æ–°æ—¶é—´</th>
                </tr>
              </thead>
              <tbody>
                <template x-if="virtualAccounts.length === 0">
                  <tr><td colspan="7" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>
                </template>
                <template x-for="account in virtualAccounts" :key="account.account_id">
                  <tr>
                    <td x-text="account.user_id"></td>
                    <td x-text="account.user_nickname || '-'"></td>
                    <td><span class="badge bg-primary" x-text="getCurrencyName(account.currency_type)"></span></td>
                    <td class="text-success fw-bold" x-text="account.balance"></td>
                    <td class="text-primary" x-text="account.available || account.balance"></td>
                    <td class="text-warning" x-text="account.frozen || 0"></td>
                    <td x-text="$format.date(account.updated_at)"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- è™šæ‹Ÿèµ„äº§äº¤æ˜“ -->
    <div x-show="currentPage === 'virtual-transactions'" x-cloak>
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="bi bi-receipt-cutoff"></i> è™šæ‹Ÿèµ„äº§äº¤æ˜“è®°å½•</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>äº¤æ˜“ID</th>
                  <th>ç”¨æˆ·</th>
                  <th>è´§å¸ç±»å‹</th>
                  <th>äº¤æ˜“ç±»å‹</th>
                  <th>é‡‘é¢</th>
                  <th>ä½™é¢å˜åŒ–</th>
                  <th>å¤‡æ³¨</th>
                  <th>æ—¶é—´</th>
                </tr>
              </thead>
              <tbody>
                <template x-if="virtualTransactions.length === 0">
                  <tr><td colspan="8" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>
                </template>
                <template x-for="tx in virtualTransactions" :key="tx.transaction_id">
                  <tr>
                    <td><code x-text="tx.transaction_id"></code></td>
                    <td x-text="tx.user_nickname || tx.user_id"></td>
                    <td><span class="badge bg-primary" x-text="getCurrencyName(tx.currency_type)"></span></td>
                    <td x-text="tx.transaction_type || '-'"></td>
                    <td :class="tx.amount > 0 ? 'text-success' : 'text-danger'" x-text="(tx.amount > 0 ? '+' : '') + tx.amount"></td>
                    <td x-text="tx.balance_before + ' â†’ ' + tx.balance_after"></td>
                    <td class="text-muted" x-text="tx.remark || '-'"></td>
                    <td x-text="$format.date(tx.created_at)"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- èµ„äº§ç»Ÿè®¡ -->
    <div x-show="currentPage === 'asset-stats'" x-cloak>
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="card stat-card">
            <div class="card-body text-center">
              <i class="bi bi-archive text-primary" style="font-size: 2rem;"></i>
              <h6 class="text-muted mt-2">ææ–™ç±»å‹æ•°</h6>
              <h2 x-text="assetStats.materialTypesCount" class="text-primary mb-0">-</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card">
            <div class="card-body text-center">
              <i class="bi bi-collection text-success" style="font-size: 2rem;"></i>
              <h6 class="text-muted mt-2">ç‰©å“å®ä¾‹æ•°</h6>
              <h2 x-text="assetStats.itemInstancesCount" class="text-success mb-0">-</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card">
            <div class="card-body text-center">
              <i class="bi bi-coin text-warning" style="font-size: 2rem;"></i>
              <h6 class="text-muted mt-2">æ€»é‡‘å¸æµé€š</h6>
              <h2 x-text="assetStats.totalCoins" class="text-warning mb-0">-</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card">
            <div class="card-body text-center">
              <i class="bi bi-gem text-info" style="font-size: 2rem;"></i>
              <h6 class="text-muted mt-2">æ€»é’»çŸ³æµé€š</h6>
              <h2 x-text="assetStats.totalDiamonds" class="text-info mb-0">-</h2>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">å¤„ç†ä¸­...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script src="/admin/js/api-config.js"></script>
  <script src="/admin/js/alpine/init.js"></script>
  <script>
    document.addEventListener('alpine:init', () => {
      // Navigation component
      Alpine.data('assetNavigation', () => ({
        currentPage: 'material-types',
        subPages: [
          { id: 'material-types', title: 'ææ–™èµ„äº§ç±»å‹', icon: 'bi-archive' },
          { id: 'material-accounts', title: 'ææ–™è´¦æˆ·', icon: 'bi-wallet2' },
          { id: 'material-transactions', title: 'ææ–™äº¤æ˜“', icon: 'bi-arrow-left-right' },
          { id: 'item-instances', title: 'ç‰©å“å®ä¾‹', icon: 'bi-collection' },
          { id: 'virtual-accounts', title: 'è™šæ‹Ÿè´¦æˆ·', icon: 'bi-coin' },
          { id: 'virtual-transactions', title: 'è™šæ‹Ÿäº¤æ˜“', icon: 'bi-receipt-cutoff' },
          { id: 'asset-stats', title: 'èµ„äº§ç»Ÿè®¡', icon: 'bi-graph-up' }
        ],
        init() {
          const urlParams = new URLSearchParams(window.location.search);
          this.currentPage = urlParams.get('page') || 'material-types';
          Alpine.store('assetPage', this.currentPage);
        },
        switchPage(pageId) {
          this.currentPage = pageId;
          Alpine.store('assetPage', pageId);
          window.history.pushState({}, '', `?page=${pageId}`);
        }
      }));

      Alpine.store('assetPage', 'material-types');

      // Page content component
      Alpine.data('assetPageContent', () => ({
        materialTypes: [],
        materialAccounts: [],
        materialTransactions: [],
        itemInstances: [],
        virtualAccounts: [],
        virtualTransactions: [],
        materialAccountFilters: { user_id: '', asset_code: '' },
        itemInstanceFilters: { user_id: '', status: '' },
        virtualAccountFilters: { user_id: '', currency_type: '' },
        assetStats: { materialTypesCount: 0, itemInstancesCount: 0, totalCoins: 0, totalDiamonds: 0 },

        get currentPage() {
          return Alpine.store('assetPage');
        },

        init() {
          this.loadAllData();
          this.$watch('$store.assetPage', () => this.loadAllData());
        },

        async loadAllData() {
          showLoading();
          try {
            await Promise.all([
              this.loadMaterialTypes(),
              this.loadMaterialAccounts(),
              this.loadMaterialTransactions(),
              this.loadItemInstances(),
              this.loadVirtualAccounts(),
              this.loadVirtualTransactions()
            ]);
            this.calculateStats();
          } catch (error) {
            console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
          } finally {
            hideLoading();
          }
        },

        async loadMaterialTypes() {
          try {
            const response = await apiRequest(API_ENDPOINTS.MATERIAL?.ASSET_TYPES || '/api/v4/admin/material/asset-types');
            if (response && response.success) {
              this.materialTypes = response.data?.list || response.data || [];
            }
          } catch (error) {
            console.error('åŠ è½½ææ–™ç±»å‹å¤±è´¥:', error);
            this.materialTypes = [];
          }
        },

        async loadMaterialAccounts() {
          try {
            let url = API_ENDPOINTS.MATERIAL?.ACCOUNTS || '/api/v4/admin/material/accounts';
            const params = new URLSearchParams();
            if (this.materialAccountFilters.user_id) params.append('user_id', this.materialAccountFilters.user_id);
            if (this.materialAccountFilters.asset_code) params.append('asset_code', this.materialAccountFilters.asset_code);
            if (params.toString()) url += '?' + params.toString();
            const response = await apiRequest(url);
            if (response && response.success) {
              this.materialAccounts = response.data?.list || response.data || [];
            }
          } catch (error) {
            console.error('åŠ è½½ææ–™è´¦æˆ·å¤±è´¥:', error);
            this.materialAccounts = [];
          }
        },

        async loadMaterialTransactions() {
          try {
            const response = await apiRequest(API_ENDPOINTS.MATERIAL?.TRANSACTIONS || '/api/v4/admin/material/transactions');
            if (response && response.success) {
              this.materialTransactions = response.data?.list || response.data || [];
            }
          } catch (error) {
            console.error('åŠ è½½ææ–™äº¤æ˜“å¤±è´¥:', error);
            this.materialTransactions = [];
          }
        },

        async loadItemInstances() {
          try {
            let url = API_ENDPOINTS.ITEM?.INSTANCES || '/api/v4/admin/items/instances';
            const params = new URLSearchParams();
            if (this.itemInstanceFilters.user_id) params.append('user_id', this.itemInstanceFilters.user_id);
            if (this.itemInstanceFilters.status) params.append('status', this.itemInstanceFilters.status);
            if (params.toString()) url += '?' + params.toString();
            const response = await apiRequest(url);
            if (response && response.success) {
              this.itemInstances = response.data?.list || response.data || [];
            }
          } catch (error) {
            console.error('åŠ è½½ç‰©å“å®ä¾‹å¤±è´¥:', error);
            this.itemInstances = [];
          }
        },

        async loadVirtualAccounts() {
          try {
            let url = API_ENDPOINTS.VIRTUAL?.ACCOUNTS || '/api/v4/admin/virtual/accounts';
            const params = new URLSearchParams();
            if (this.virtualAccountFilters.user_id) params.append('user_id', this.virtualAccountFilters.user_id);
            if (this.virtualAccountFilters.currency_type) params.append('currency_type', this.virtualAccountFilters.currency_type);
            if (params.toString()) url += '?' + params.toString();
            const response = await apiRequest(url);
            if (response && response.success) {
              this.virtualAccounts = response.data?.list || response.data || [];
            }
          } catch (error) {
            console.error('åŠ è½½è™šæ‹Ÿè´¦æˆ·å¤±è´¥:', error);
            this.virtualAccounts = [];
          }
        },

        async loadVirtualTransactions() {
          try {
            const response = await apiRequest(API_ENDPOINTS.VIRTUAL?.TRANSACTIONS || '/api/v4/admin/virtual/transactions');
            if (response && response.success) {
              this.virtualTransactions = response.data?.list || response.data || [];
            }
          } catch (error) {
            console.error('åŠ è½½è™šæ‹Ÿäº¤æ˜“å¤±è´¥:', error);
            this.virtualTransactions = [];
          }
        },

        calculateStats() {
          this.assetStats = {
            materialTypesCount: this.materialTypes.length,
            itemInstancesCount: this.itemInstances.length,
            totalCoins: this.virtualAccounts.filter(a => a.currency_type === 'coins').reduce((sum, a) => sum + (a.balance || 0), 0),
            totalDiamonds: this.virtualAccounts.filter(a => a.currency_type === 'diamonds').reduce((sum, a) => sum + (a.balance || 0), 0)
          };
        },

        getInstanceStatusClass(status) {
          const map = { active: 'bg-success', used: 'bg-secondary', expired: 'bg-danger', locked: 'bg-warning' };
          return map[status] || 'bg-secondary';
        },

        getInstanceStatusText(status) {
          const map = { active: 'æ­£å¸¸', used: 'å·²ä½¿ç”¨', expired: 'å·²è¿‡æœŸ', locked: 'é”å®šä¸­' };
          return map[status] || status;
        },

        getCurrencyName(type) {
          const map = { coins: 'é‡‘å¸', diamonds: 'é’»çŸ³', points: 'ç§¯åˆ†' };
          return map[type] || type;
        },

        openCreateModal(type) {
          alert(`åˆ›å»º${type}åŠŸèƒ½å¼€å‘ä¸­`);
        },

        editItem(type, item) {
          alert(`ç¼–è¾‘${type}: ${item.asset_code || item.name}`);
        },

        deleteItem(type, id) {
          if (confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ')) {
            alert(`åˆ é™¤${type}: ${id}`);
          }
        },

        viewInstanceDetail(instance) {
          alert(`ç‰©å“å®ä¾‹è¯¦æƒ…: ${instance.instance_id}`);
        }
      }));
    });
  </script>
  
  <!-- Alpine.js (defer ç¡®ä¿æœ€ååŠ è½½) -->
  <script defer src="/admin/js/vendor/alpine.min.js"></script>
</body>
</html>
