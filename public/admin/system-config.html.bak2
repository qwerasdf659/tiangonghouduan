<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">ç³»ç»Ÿé…ç½® - ç®¡ç†åå°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">
  <style>
    .sub-nav { background: #f8f9fa; border-bottom: 1px solid #dee2e6; padding: 0.5rem 0; }
    .sub-nav .nav-link { color: #495057; padding: 0.5rem 1rem; border-radius: 0.25rem; margin: 0 0.25rem; }
    .sub-nav .nav-link:hover { background: #e9ecef; }
    .sub-nav .nav-link.active { background: #0d6efd; color: white; }
    [x-cloak] { display: none !important; }
    .config-card { border-left: 3px solid #0d6efd; }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸª ç®¡ç†åå° - ç³»ç»Ÿé…ç½®
      </a>
      <div>
        <span class="text-light me-3" x-data x-text="$store.auth.user?.nickname ? `æ¬¢è¿ï¼Œ${$store.auth.user.nickname}` : 'æ¬¢è¿ï¼Œç®¡ç†å‘˜'">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" onclick="logout()">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>

  <!-- å­æ¨¡å—å¯¼èˆª -->
  <div class="sub-nav" x-data="systemNavigation()">
    <div class="container-fluid">
      <ul class="nav nav-pills">
        <template x-for="page in subPages" :key="page.id">
          <li class="nav-item">
            <a class="nav-link" :class="{ 'active': currentPage === page.id }" :href="'?page=' + page.id" @click.prevent="switchPage(page.id)">
              <i class="bi me-1" :class="page.icon"></i><span x-text="page.title"></span>
            </a>
          </li>
        </template>
      </ul>
    </div>
  </div>

  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <div class="container-fluid mt-4" x-data="systemPageContent()" x-cloak>
    <!-- ç³»ç»Ÿå‚æ•° -->
    <div x-show="currentPage === 'system-params'" x-cloak>
      <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-gear"></i> ç³»ç»Ÿå‚æ•°</h5>
          <button class="btn btn-primary btn-sm" @click="openCreateModal('param')">
            <i class="bi bi-plus"></i> æ–°å»ºå‚æ•°
          </button>
        </div>
        <div class="card-body">
          <!-- ç­›é€‰å™¨ -->
          <div class="row mb-3 g-2">
            <div class="col-md-3">
              <input type="text" class="form-control form-control-sm" placeholder="å‚æ•°é”®å" x-model="paramFilters.param_key">
            </div>
            <div class="col-md-3">
              <select class="form-select form-select-sm" x-model="paramFilters.category">
                <option value="">å…¨éƒ¨åˆ†ç±»</option>
                <option value="system">ç³»ç»Ÿ</option>
                <option value="business">ä¸šåŠ¡</option>
                <option value="ui">ç•Œé¢</option>
                <option value="security">å®‰å…¨</option>
              </select>
            </div>
            <div class="col-md-2">
              <button class="btn btn-primary btn-sm w-100" @click="loadSystemParams()">
                <i class="bi bi-search"></i> æœç´¢
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>å‚æ•°é”®</th>
                  <th>å‚æ•°å€¼</th>
                  <th>åˆ†ç±»</th>
                  <th>æè¿°</th>
                  <th>æ›´æ–°æ—¶é—´</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                <template x-if="systemParams.length === 0">
                  <tr><td colspan="6" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>
                </template>
                <template x-for="param in systemParams" :key="param.param_key">
                  <tr>
                    <td><code x-text="param.param_key"></code></td>
                    <td><span class="text-truncate d-inline-block" style="max-width: 200px;" x-text="param.param_value"></span></td>
                    <td><span class="badge bg-secondary" x-text="param.category || 'é€šç”¨'"></span></td>
                    <td class="text-muted" x-text="param.description || '-'"></td>
                    <td x-text="$format.date(param.updated_at)"></td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary" @click="editParam(param)"><i class="bi bi-pencil"></i></button>
                      <button class="btn btn-sm btn-outline-danger" @click="deleteParam(param)"><i class="bi bi-trash"></i></button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- åŠŸèƒ½å¼€å…³ -->
    <div x-show="currentPage === 'feature-flags'" x-cloak>
      <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-toggles"></i> åŠŸèƒ½å¼€å…³</h5>
          <button class="btn btn-primary btn-sm" @click="openCreateModal('feature')">
            <i class="bi bi-plus"></i> æ–°å»ºå¼€å…³
          </button>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <template x-if="featureFlags.length === 0">
              <div class="col-12 text-center text-muted py-4">æš‚æ— åŠŸèƒ½å¼€å…³</div>
            </template>
            <template x-for="flag in featureFlags" :key="flag.flag_key">
              <div class="col-md-4">
                <div class="card config-card h-100">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <h6 class="card-title mb-0" x-text="flag.flag_name"></h6>
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" :checked="flag.is_enabled" @change="toggleFeatureFlag(flag)">
                      </div>
                    </div>
                    <p class="text-muted small mb-2" x-text="flag.description || 'æ— æè¿°'"></p>
                    <div class="d-flex justify-content-between align-items-center">
                      <code class="small" x-text="flag.flag_key"></code>
                      <span class="badge" :class="flag.is_enabled ? 'bg-success' : 'bg-secondary'" x-text="flag.is_enabled ? 'å·²å¼€å¯' : 'å·²å…³é—­'"></span>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>

    <!-- å®šæ—¶ä»»åŠ¡ -->
    <div x-show="currentPage === 'scheduled-tasks'" x-cloak>
      <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-clock-history"></i> å®šæ—¶ä»»åŠ¡</h5>
          <button class="btn btn-primary btn-sm" @click="openCreateModal('task')">
            <i class="bi bi-plus"></i> æ–°å»ºä»»åŠ¡
          </button>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>ä»»åŠ¡åç§°</th>
                  <th>æ‰§è¡Œè®¡åˆ’</th>
                  <th>ä¸Šæ¬¡æ‰§è¡Œ</th>
                  <th>ä¸‹æ¬¡æ‰§è¡Œ</th>
                  <th>çŠ¶æ€</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                <template x-if="scheduledTasks.length === 0">
                  <tr><td colspan="6" class="text-center text-muted py-4">æš‚æ— å®šæ—¶ä»»åŠ¡</td></tr>
                </template>
                <template x-for="task in scheduledTasks" :key="task.task_id">
                  <tr>
                    <td x-text="task.task_name"></td>
                    <td><code x-text="task.cron_expression || task.schedule"></code></td>
                    <td x-text="task.last_run ? $format.date(task.last_run) : '-'"></td>
                    <td x-text="task.next_run ? $format.date(task.next_run) : '-'"></td>
                    <td><span class="badge" :class="getTaskStatusClass(task.status)" x-text="getTaskStatusText(task.status)"></span></td>
                    <td>
                      <button class="btn btn-sm btn-outline-success" @click="runTask(task)" title="ç«‹å³æ‰§è¡Œ"><i class="bi bi-play"></i></button>
                      <button class="btn btn-sm btn-outline-primary" @click="editTask(task)"><i class="bi bi-pencil"></i></button>
                      <button class="btn btn-sm btn-outline-warning" @click="toggleTask(task)" :title="task.status === 'active' ? 'æš‚åœ' : 'å¯ç”¨'">
                        <i class="bi" :class="task.status === 'active' ? 'bi-pause' : 'bi-play-circle'"></i>
                      </button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- æ“ä½œæ—¥å¿— -->
    <div x-show="currentPage === 'audit-logs'" x-cloak>
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="bi bi-journal-text"></i> æ“ä½œæ—¥å¿—</h5>
        </div>
        <div class="card-body">
          <!-- ç­›é€‰å™¨ -->
          <div class="row mb-3 g-2">
            <div class="col-md-2">
              <input type="text" class="form-control form-control-sm" placeholder="æ“ä½œäººID" x-model="logFilters.operator_id">
            </div>
            <div class="col-md-2">
              <select class="form-select form-select-sm" x-model="logFilters.action_type">
                <option value="">å…¨éƒ¨æ“ä½œ</option>
                <option value="create">åˆ›å»º</option>
                <option value="update">æ›´æ–°</option>
                <option value="delete">åˆ é™¤</option>
                <option value="login">ç™»å½•</option>
              </select>
            </div>
            <div class="col-md-2">
              <input type="date" class="form-control form-control-sm" x-model="logFilters.start_date">
            </div>
            <div class="col-md-2">
              <input type="date" class="form-control form-control-sm" x-model="logFilters.end_date">
            </div>
            <div class="col-md-2">
              <button class="btn btn-primary btn-sm w-100" @click="loadAuditLogs()">
                <i class="bi bi-search"></i> æœç´¢
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>æ—¥å¿—ID</th>
                  <th>æ“ä½œäºº</th>
                  <th>æ“ä½œç±»å‹</th>
                  <th>æ¨¡å—</th>
                  <th>æ“ä½œæè¿°</th>
                  <th>IPåœ°å€</th>
                  <th>æ—¶é—´</th>
                </tr>
              </thead>
              <tbody>
                <template x-if="auditLogs.length === 0">
                  <tr><td colspan="7" class="text-center text-muted py-4">æš‚æ— æ—¥å¿—</td></tr>
                </template>
                <template x-for="log in auditLogs" :key="log.log_id">
                  <tr>
                    <td><code x-text="log.log_id"></code></td>
                    <td x-text="log.operator_name || log.operator_id"></td>
                    <td><span class="badge" :class="getActionTypeClass(log.action_type)" x-text="log.action_type"></span></td>
                    <td x-text="log.module || '-'"></td>
                    <td class="text-muted" x-text="log.description || '-'"></td>
                    <td><code x-text="log.ip_address || '-'"></code></td>
                    <td x-text="$format.date(log.created_at)"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ç¼“å­˜ç®¡ç† -->
    <div x-show="currentPage === 'cache-management'" x-cloak>
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <div class="card stat-card">
            <div class="card-body text-center">
              <i class="bi bi-hdd text-primary" style="font-size: 2rem;"></i>
              <h6 class="text-muted mt-2">ç¼“å­˜å‘½ä¸­ç‡</h6>
              <h2 x-text="cacheStats.hitRate + '%'" class="text-primary mb-0">-</h2>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card stat-card">
            <div class="card-body text-center">
              <i class="bi bi-database text-success" style="font-size: 2rem;"></i>
              <h6 class="text-muted mt-2">ç¼“å­˜æ¡ç›®æ•°</h6>
              <h2 x-text="cacheStats.totalKeys" class="text-success mb-0">-</h2>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card stat-card">
            <div class="card-body text-center">
              <i class="bi bi-speedometer2 text-warning" style="font-size: 2rem;"></i>
              <h6 class="text-muted mt-2">å†…å­˜ä½¿ç”¨</h6>
              <h2 x-text="cacheStats.memoryUsage" class="text-warning mb-0">-</h2>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-trash"></i> ç¼“å­˜æ¸…ç†</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <button class="btn btn-outline-warning w-100" @click="clearCache('user')">
                <i class="bi bi-person"></i> æ¸…é™¤ç”¨æˆ·ç¼“å­˜
              </button>
            </div>
            <div class="col-md-3">
              <button class="btn btn-outline-warning w-100" @click="clearCache('config')">
                <i class="bi bi-gear"></i> æ¸…é™¤é…ç½®ç¼“å­˜
              </button>
            </div>
            <div class="col-md-3">
              <button class="btn btn-outline-warning w-100" @click="clearCache('session')">
                <i class="bi bi-key"></i> æ¸…é™¤ä¼šè¯ç¼“å­˜
              </button>
            </div>
            <div class="col-md-3">
              <button class="btn btn-danger w-100" @click="clearCache('all')">
                <i class="bi bi-trash3"></i> æ¸…é™¤æ‰€æœ‰ç¼“å­˜
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç³»ç»Ÿç»Ÿè®¡ -->
    <div x-show="currentPage === 'system-stats'" x-cloak>
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="card stat-card">
            <div class="card-body text-center">
              <i class="bi bi-gear text-primary" style="font-size: 2rem;"></i>
              <h6 class="text-muted mt-2">ç³»ç»Ÿå‚æ•°</h6>
              <h2 x-text="systemStats.totalParams" class="text-primary mb-0">-</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card">
            <div class="card-body text-center">
              <i class="bi bi-toggles text-success" style="font-size: 2rem;"></i>
              <h6 class="text-muted mt-2">åŠŸèƒ½å¼€å…³</h6>
              <h2 x-text="systemStats.totalFlags" class="text-success mb-0">-</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card">
            <div class="card-body text-center">
              <i class="bi bi-clock text-warning" style="font-size: 2rem;"></i>
              <h6 class="text-muted mt-2">å®šæ—¶ä»»åŠ¡</h6>
              <h2 x-text="systemStats.totalTasks" class="text-warning mb-0">-</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card">
            <div class="card-body text-center">
              <i class="bi bi-journal text-info" style="font-size: 2rem;"></i>
              <h6 class="text-muted mt-2">ä»Šæ—¥æ—¥å¿—</h6>
              <h2 x-text="systemStats.todayLogs" class="text-info mb-0">-</h2>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">å¤„ç†ä¸­...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/alpine/init.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script src="/admin/js/api-config.js"></script>
  <script>
    document.addEventListener('alpine:init', () => {
      // Navigation component
      Alpine.data('systemNavigation', () => ({
        currentPage: 'system-params',
        subPages: [
          { id: 'system-params', title: 'ç³»ç»Ÿå‚æ•°', icon: 'bi-gear' },
          { id: 'feature-flags', title: 'åŠŸèƒ½å¼€å…³', icon: 'bi-toggles' },
          { id: 'scheduled-tasks', title: 'å®šæ—¶ä»»åŠ¡', icon: 'bi-clock-history' },
          { id: 'audit-logs', title: 'æ“ä½œæ—¥å¿—', icon: 'bi-journal-text' },
          { id: 'cache-management', title: 'ç¼“å­˜ç®¡ç†', icon: 'bi-hdd' },
          { id: 'system-stats', title: 'ç³»ç»Ÿç»Ÿè®¡', icon: 'bi-graph-up' }
        ],
        init() {
          const urlParams = new URLSearchParams(window.location.search);
          this.currentPage = urlParams.get('page') || 'system-params';
          Alpine.store('systemPage', this.currentPage);
        },
        switchPage(pageId) {
          this.currentPage = pageId;
          Alpine.store('systemPage', pageId);
          window.history.pushState({}, '', `?page=${pageId}`);
        }
      }));

      Alpine.store('systemPage', 'system-params');

      // Page content component
      Alpine.data('systemPageContent', () => ({
        systemParams: [],
        featureFlags: [],
        scheduledTasks: [],
        auditLogs: [],
        paramFilters: { param_key: '', category: '' },
        logFilters: { operator_id: '', action_type: '', start_date: '', end_date: '' },
        cacheStats: { hitRate: 0, totalKeys: 0, memoryUsage: '0 MB' },
        systemStats: { totalParams: 0, totalFlags: 0, totalTasks: 0, todayLogs: 0 },

        get currentPage() {
          return Alpine.store('systemPage');
        },

        init() {
          this.loadAllData();
          this.$watch('$store.systemPage', () => this.loadAllData());
        },

        async loadAllData() {
          showLoading();
          try {
            await Promise.all([
              this.loadSystemParams(),
              this.loadFeatureFlags(),
              this.loadScheduledTasks(),
              this.loadAuditLogs(),
              this.loadCacheStats()
            ]);
            this.calculateStats();
          } catch (error) {
            console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
          } finally {
            hideLoading();
          }
        },

        async loadSystemParams() {
          try {
            let url = API_ENDPOINTS.SYSTEM?.PARAMS || '/api/v4/admin/system/params';
            const params = new URLSearchParams();
            if (this.paramFilters.param_key) params.append('param_key', this.paramFilters.param_key);
            if (this.paramFilters.category) params.append('category', this.paramFilters.category);
            if (params.toString()) url += '?' + params.toString();
            const response = await apiRequest(url);
            if (response && response.success) {
              this.systemParams = response.data?.list || response.data || [];
            }
          } catch (error) {
            console.error('åŠ è½½ç³»ç»Ÿå‚æ•°å¤±è´¥:', error);
            this.systemParams = [];
          }
        },

        async loadFeatureFlags() {
          try {
            const response = await apiRequest(API_ENDPOINTS.SYSTEM?.FEATURE_FLAGS || '/api/v4/admin/system/feature-flags');
            if (response && response.success) {
              this.featureFlags = response.data?.list || response.data || [];
            }
          } catch (error) {
            console.error('åŠ è½½åŠŸèƒ½å¼€å…³å¤±è´¥:', error);
            this.featureFlags = [];
          }
        },

        async loadScheduledTasks() {
          try {
            const response = await apiRequest(API_ENDPOINTS.SYSTEM?.TASKS || '/api/v4/admin/system/scheduled-tasks');
            if (response && response.success) {
              this.scheduledTasks = response.data?.list || response.data || [];
            }
          } catch (error) {
            console.error('åŠ è½½å®šæ—¶ä»»åŠ¡å¤±è´¥:', error);
            this.scheduledTasks = [];
          }
        },

        async loadAuditLogs() {
          try {
            let url = API_ENDPOINTS.SYSTEM?.AUDIT_LOGS || '/api/v4/admin/system/audit-logs';
            const params = new URLSearchParams();
            if (this.logFilters.operator_id) params.append('operator_id', this.logFilters.operator_id);
            if (this.logFilters.action_type) params.append('action_type', this.logFilters.action_type);
            if (this.logFilters.start_date) params.append('start_date', this.logFilters.start_date);
            if (this.logFilters.end_date) params.append('end_date', this.logFilters.end_date);
            if (params.toString()) url += '?' + params.toString();
            const response = await apiRequest(url);
            if (response && response.success) {
              this.auditLogs = response.data?.list || response.data || [];
            }
          } catch (error) {
            console.error('åŠ è½½æ“ä½œæ—¥å¿—å¤±è´¥:', error);
            this.auditLogs = [];
          }
        },

        async loadCacheStats() {
          try {
            const response = await apiRequest(API_ENDPOINTS.SYSTEM?.CACHE_STATS || '/api/v4/admin/system/cache/stats');
            if (response && response.success) {
              this.cacheStats = {
                hitRate: response.data?.hit_rate || 0,
                totalKeys: response.data?.total_keys || 0,
                memoryUsage: response.data?.memory_usage || '0 MB'
              };
            }
          } catch (error) {
            console.error('åŠ è½½ç¼“å­˜ç»Ÿè®¡å¤±è´¥:', error);
          }
        },

        calculateStats() {
          this.systemStats = {
            totalParams: this.systemParams.length,
            totalFlags: this.featureFlags.length,
            totalTasks: this.scheduledTasks.length,
            todayLogs: this.auditLogs.filter(log => {
              const logDate = new Date(log.created_at).toDateString();
              return logDate === new Date().toDateString();
            }).length
          };
        },

        getTaskStatusClass(status) {
          const map = { active: 'bg-success', paused: 'bg-warning', failed: 'bg-danger', disabled: 'bg-secondary' };
          return map[status] || 'bg-secondary';
        },

        getTaskStatusText(status) {
          const map = { active: 'è¿è¡Œä¸­', paused: 'å·²æš‚åœ', failed: 'å¤±è´¥', disabled: 'å·²ç¦ç”¨' };
          return map[status] || status;
        },

        getActionTypeClass(type) {
          const map = { create: 'bg-success', update: 'bg-primary', delete: 'bg-danger', login: 'bg-info' };
          return map[type] || 'bg-secondary';
        },

        openCreateModal(type) {
          alert(`åˆ›å»º${type}åŠŸèƒ½å¼€å‘ä¸­`);
        },

        editParam(param) {
          alert(`ç¼–è¾‘å‚æ•°: ${param.param_key}`);
        },

        deleteParam(param) {
          if (confirm(`ç¡®å®šè¦åˆ é™¤å‚æ•° ${param.param_key} å—ï¼Ÿ`)) {
            alert('åˆ é™¤å‚æ•°åŠŸèƒ½å¼€å‘ä¸­');
          }
        },

        async toggleFeatureFlag(flag) {
          try {
            showLoading();
            const response = await apiRequest(
              (API_ENDPOINTS.SYSTEM?.FEATURE_FLAGS || '/api/v4/admin/system/feature-flags') + `/${flag.flag_key}/toggle`,
              { method: 'POST', body: JSON.stringify({ is_enabled: !flag.is_enabled }) }
            );
            if (response && response.success) {
              flag.is_enabled = !flag.is_enabled;
              showToast('success', 'åŠŸèƒ½å¼€å…³å·²æ›´æ–°');
            }
          } catch (error) {
            console.error('åˆ‡æ¢åŠŸèƒ½å¼€å…³å¤±è´¥:', error);
            showToast('error', 'æ“ä½œå¤±è´¥');
          } finally {
            hideLoading();
          }
        },

        editTask(task) {
          alert(`ç¼–è¾‘ä»»åŠ¡: ${task.task_name}`);
        },

        async runTask(task) {
          if (confirm(`ç¡®å®šè¦ç«‹å³æ‰§è¡Œä»»åŠ¡ ${task.task_name} å—ï¼Ÿ`)) {
            try {
              showLoading();
              const response = await apiRequest(
                (API_ENDPOINTS.SYSTEM?.TASKS || '/api/v4/admin/system/scheduled-tasks') + `/${task.task_id}/run`,
                { method: 'POST' }
              );
              if (response && response.success) {
                showToast('success', 'ä»»åŠ¡å·²è§¦å‘æ‰§è¡Œ');
                await this.loadScheduledTasks();
              }
            } catch (error) {
              console.error('æ‰§è¡Œä»»åŠ¡å¤±è´¥:', error);
              showToast('error', 'æ‰§è¡Œå¤±è´¥');
            } finally {
              hideLoading();
            }
          }
        },

        async toggleTask(task) {
          const action = task.status === 'active' ? 'æš‚åœ' : 'å¯ç”¨';
          if (confirm(`ç¡®å®šè¦${action}ä»»åŠ¡ ${task.task_name} å—ï¼Ÿ`)) {
            try {
              showLoading();
              const response = await apiRequest(
                (API_ENDPOINTS.SYSTEM?.TASKS || '/api/v4/admin/system/scheduled-tasks') + `/${task.task_id}/toggle`,
                { method: 'POST' }
              );
              if (response && response.success) {
                showToast('success', `ä»»åŠ¡å·²${action}`);
                await this.loadScheduledTasks();
              }
            } catch (error) {
              console.error('åˆ‡æ¢ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
              showToast('error', 'æ“ä½œå¤±è´¥');
            } finally {
              hideLoading();
            }
          }
        },

        async clearCache(type) {
          const typeNames = { user: 'ç”¨æˆ·', config: 'é…ç½®', session: 'ä¼šè¯', all: 'æ‰€æœ‰' };
          if (confirm(`ç¡®å®šè¦æ¸…é™¤${typeNames[type]}ç¼“å­˜å—ï¼Ÿ`)) {
            try {
              showLoading();
              const response = await apiRequest(
                (API_ENDPOINTS.SYSTEM?.CACHE_CLEAR || '/api/v4/admin/system/cache/clear'),
                { method: 'POST', body: JSON.stringify({ type }) }
              );
              if (response && response.success) {
                showToast('success', `${typeNames[type]}ç¼“å­˜å·²æ¸…é™¤`);
                await this.loadCacheStats();
              }
            } catch (error) {
              console.error('æ¸…é™¤ç¼“å­˜å¤±è´¥:', error);
              showToast('error', 'æ¸…é™¤å¤±è´¥');
            } finally {
              hideLoading();
            }
          }
        }
      }));
    });
  </script>
  <script defer src="/admin/js/vendor/alpine.min.js"></script>
</body>
</html>
