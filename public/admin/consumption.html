<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ¶ˆè´¹è®°å½•å®¡æ ¸ - ç®¡ç†åå°</title>

    <!-- âœ… Bootstrap 5 - UIæ¡†æ¶ -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- âœ… Bootstrap Icons - å›¾æ ‡åº“ -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- âœ… å…¬å…±æ ·å¼è¡¨ - ç»Ÿä¸€ä¸»é¢˜å’Œå“åº”å¼è®¾è®¡ -->
    <link href="/admin/css/common.css" rel="stylesheet" />
  </head>
  <body class="bg-light">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="navbar navbar-dark bg-primary">
      <div class="container-fluid">
        <a href="/admin/dashboard.html" class="navbar-brand">
          <i class="bi bi-arrow-left me-2"></i>ğŸ“‹ ç®¡ç†åå° - æ¶ˆè´¹è®°å½•å®¡æ ¸
        </a>
        <div>
          <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
          <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
        </div>
      </div>
    </nav>

    <div class="container-fluid mt-4">
      <!-- ç­›é€‰å™¨åŒºåŸŸ -->
      <div class="card mb-3">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">çŠ¶æ€ç­›é€‰</label>
              <select class="form-select" id="statusFilter">
                <option value="pending">å¾…å®¡æ ¸</option>
                <option value="approved">å·²é€šè¿‡</option>
                <option value="rejected">å·²æ‹’ç»</option>
                <option value="all">å…¨éƒ¨</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">æœç´¢</label>
              <input
                type="text"
                class="form-control"
                id="searchInput"
                placeholder="æ‰‹æœºå·ã€è®¢å•å·"
              />
            </div>
            <div class="col-md-6">
              <label class="form-label">&nbsp;</label>
              <div>
                <button class="btn btn-primary" id="searchBtn">
                  <i class="bi bi-search"></i> æœç´¢
                </button>
                <button class="btn btn-outline-secondary" id="resetBtn">
                  <i class="bi bi-arrow-clockwise"></i> é‡ç½®
                </button>
                <button class="btn btn-outline-success" id="refreshBtn">
                  <i class="bi bi-arrow-repeat"></i> åˆ·æ–°
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ç»Ÿè®¡ä¿¡æ¯ -->
      <div class="row g-3 mb-3">
        <div class="col-md-3">
          <div class="card">
            <div class="card-body text-center">
              <h6 class="text-muted">å¾…å®¡æ ¸</h6>
              <h3 class="text-warning" id="pendingCount">-</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-body text-center">
              <h6 class="text-muted">ä»Šæ—¥å®¡æ ¸</h6>
              <h3 class="text-primary" id="todayCount">-</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-body text-center">
              <h6 class="text-muted">é€šè¿‡</h6>
              <h3 class="text-success" id="approvedCount">-</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-body text-center">
              <h6 class="text-muted">æ‹’ç»</h6>
              <h3 class="text-danger" id="rejectedCount">-</h3>
            </div>
          </div>
        </div>
      </div>

      <!-- æ•°æ®è¡¨æ ¼ -->
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th style="width: 80px">ID</th>
                  <th>ç”¨æˆ·</th>
                  <th>é‡‘é¢</th>
                  <th>ç§¯åˆ†</th>
                  <th>æ—¶é—´</th>
                  <th>çŠ¶æ€</th>
                  <th>å‡­è¯</th>
                  <th style="width: 200px">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="recordsTableBody">
                <tr>
                  <td colspan="8" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                    <p class="mt-2 text-muted">æ­£åœ¨åŠ è½½æ•°æ®...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- åˆ†é¡µ -->
          <nav aria-label="åˆ†é¡µå¯¼èˆª">
            <ul class="pagination justify-content-center mb-0" id="pagination">
              <li class="page-item disabled">
                <span class="page-link">åŠ è½½ä¸­...</span>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>

    <!-- å‡­è¯æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div class="modal fade" id="voucherModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-image"></i> æ¶ˆè´¹å‡­è¯</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center">
            <img id="voucherImage" class="voucher-img" alt="æ¶ˆè´¹å‡­è¯" />
            <div class="mt-3" id="voucherInfo"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
          </div>
        </div>
      </div>
    </div>

    <!-- å®¡æ ¸å¤‡æ³¨æ¨¡æ€æ¡† -->
    <div class="modal fade" id="remarkModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="remarkModalTitle">å®¡æ ¸å¤‡æ³¨</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">å¤‡æ³¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰</label>
              <textarea
                class="form-control"
                id="remarkInput"
                rows="3"
                placeholder="è¯·è¾“å…¥å®¡æ ¸å¤‡æ³¨..."
              ></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" id="remarkSubmitBtn">ç¡®è®¤</button>
          </div>
        </div>
      </div>
    </div>

    <!-- åŠ è½½é®ç½©å±‚ -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner-border text-light" style="width: 3rem; height: 3rem" role="status">
        <span class="visually-hidden">å¤„ç†ä¸­...</span>
      </div>
    </div>

    <!-- âœ… Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- âœ… å¼•å…¥é€šç”¨å·¥å…·åº“ -->
    <script src="/admin/js/admin-common.js"></script>

    <script>
      /**
       * å…¨å±€å˜é‡
       */
      let currentPage = 1
      let currentRecordId = null
      let currentAction = null
      const pageSize = 20

      /**
       * é¡µé¢åˆå§‹åŒ–
       */
      document.addEventListener('DOMContentLoaded', function () {
        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        const userInfo = getCurrentUser()
        if (userInfo && userInfo.nickname) {
          document.getElementById('welcomeText').textContent = `æ¬¢è¿ï¼Œ${userInfo.nickname}`
        }

        // âœ… Tokenå’Œæƒé™éªŒè¯
        if (!getToken() || !checkAdminPermission()) {
          return;
        }

        // åŠ è½½è®°å½•
        loadRecords()

        // çŠ¶æ€ç­›é€‰å™¨å˜åŒ–æ—¶é‡æ–°åŠ è½½
        document.getElementById('statusFilter').addEventListener('change', () => {
          currentPage = 1
          loadRecords()
        })

        // æœç´¢æ¡†å›è½¦è§¦å‘æœç´¢
        document.getElementById('searchInput').addEventListener('keypress', e => {
          if (e.key === 'Enter') {
            currentPage = 1
            loadRecords()
          }
        })

        // å¤‡æ³¨æäº¤æŒ‰é’®
        document.getElementById('remarkSubmitBtn').addEventListener('click', submitReview)

        // âœ… å›ºå®šæŒ‰é’®äº‹ä»¶ç›‘å¬å™¨ï¼ˆæ›¿ä»£onclickï¼‰
        document.getElementById('logoutBtn').addEventListener('click', logout)
        document.getElementById('searchBtn').addEventListener('click', () => loadRecords())
        document.getElementById('resetBtn').addEventListener('click', resetFilters)
        document.getElementById('refreshBtn').addEventListener('click', () => loadRecords(true))

        // âœ… äº‹ä»¶å§”æ‰˜ï¼šå®¡æ ¸æŒ‰é’®ï¼ˆåŠ¨æ€ç”Ÿæˆçš„å…ƒç´ ï¼‰
        document.getElementById('recordsTableBody').addEventListener('click', e => {
          const reviewBtn = e.target.closest('.review-btn')
          if (reviewBtn) {
            const recordId = parseInt(reviewBtn.dataset.recordId)
            const action = reviewBtn.dataset.action
            reviewRecord(recordId, action)
          }

          // æŸ¥çœ‹å‡­è¯æŒ‰é’®
          const voucherBtn = e.target.closest('.view-voucher-btn')
          if (voucherBtn) {
            const url = voucherBtn.dataset.url
            const recordId = parseInt(voucherBtn.dataset.recordId)
            viewVoucher(url, recordId)
          }
        })

        // âœ… äº‹ä»¶å§”æ‰˜ï¼šåˆ†é¡µæŒ‰é’®ï¼ˆåŠ¨æ€ç”Ÿæˆçš„å…ƒç´ ï¼‰
        document.getElementById('pagination').addEventListener('click', e => {
          e.preventDefault()
          const pageBtn = e.target.closest('.page-nav-btn')
          if (pageBtn && !pageBtn.closest('.disabled')) {
            const page = parseInt(pageBtn.dataset.page)
            if (!isNaN(page) && page > 0) {
              changePage(page)
            }
          }
        })
      })

      /**
       * åŠ è½½æ¶ˆè´¹è®°å½•åˆ—è¡¨
       * @param {boolean} silent - æ˜¯å¦é™é»˜åˆ·æ–°ï¼ˆä¸æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼‰
       */
      async function loadRecords(silent = false) {
        if (!silent) {
          showLoading()
        }

        try {
          const status = document.getElementById('statusFilter').value
          const search = document.getElementById('searchInput').value.trim()

          // âœ… æ„å»ºæŸ¥è¯¢å‚æ•°ï¼ˆé€‚é…åç«¯APIï¼špage_sizeè€Œä¸æ˜¯limitï¼‰
          const params = new URLSearchParams({
            page: currentPage,
            page_size: pageSize, // âœ… ä¿®æ”¹ï¼šåç«¯ä½¿ç”¨page_sizeå‚æ•°
            status: status // âœ… åŒ…å«statuså‚æ•°ï¼ˆall/pending/approved/rejectedï¼‰
          })

          // æœç´¢å‚æ•°ï¼ˆå¦‚æœæœ‰ï¼‰
          if (search) {
            params.append('search', search)
          }

          // âœ… è°ƒç”¨æ–°çš„ç®¡ç†å‘˜æŸ¥è¯¢API
          const response = await apiRequest(
            `/api/v4/consumption/admin/records?${params.toString()}`
          )

          if (response && response.success) {
            // âœ… åç«¯è¿”å›æ ¼å¼ï¼š{ records, pagination, statistics }
            renderRecords(response.data)
            updateStatistics(response.data)
          } else {
            showError('åŠ è½½å¤±è´¥', response?.message || 'è·å–æ•°æ®å¤±è´¥')
          }
        } catch (error) {
          console.error('âŒ åŠ è½½è®°å½•å¤±è´¥:', error)
          showError('åŠ è½½å¤±è´¥', error.message)
        } finally {
          hideLoading()
        }
      }

      /**
       * æ¸²æŸ“è®°å½•åˆ—è¡¨
       * @param {Object} data - APIè¿”å›çš„æ•°æ®
       */
      function renderRecords(data) {
        const tbody = document.getElementById('recordsTableBody')
        const records = data.records || data.list || []

        if (records.length === 0) {
          tbody.innerHTML = `
          <tr>
            <td colspan="8" class="text-center py-5">
              <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
              <p class="mt-2 text-muted">æš‚æ— æ•°æ®</p>
            </td>
          </tr>
        `
          renderPagination(0, 0)
          return
        }

        tbody.innerHTML = records
          .map(
            record => `
        <tr>
          <td>${record.record_id || record.id}</td>
          <td>
            <div>${maskPhone(record.mobile || record.user_mobile || '-')}</div>
            <small class="text-muted">${record.nickname || record.user_nickname || '-'}</small>
          </td>
          <td class="fw-bold">Â¥${(record.amount || 0).toFixed(2)}</td>
          <td class="text-primary">${record.points_awarded || 0}</td>
          <td>
            <div>${formatDate(record.created_at)}</div>
            <small class="text-muted">${formatRelativeTime(record.created_at)}</small>
          </td>
          <td>${renderStatusBadge(record.status)}</td>
          <td>
            ${
              record.voucher_url
                ? `<button class="btn btn-sm btn-outline-primary view-voucher-btn" data-url="${record.voucher_url}" data-record-id="${record.record_id || record.id}">
                <i class="bi bi-image"></i> æŸ¥çœ‹
              </button>`
                : '<span class="text-muted">æ— å‡­è¯</span>'
            }
          </td>
          <td class="table-actions">
            ${renderActions(record)}
          </td>
        </tr>
      `
          )
          .join('')

        // âœ… æ¸²æŸ“åˆ†é¡µï¼ˆåç«¯è¿”å›æ ¼å¼ï¼šdata.paginationï¼‰
        const pagination = data.pagination || {}
        const total = pagination.total || records.length
        renderPagination(total, currentPage)
      }

      /**
       * æ¸²æŸ“çŠ¶æ€å¾½ç« 
       * @param {string} status - çŠ¶æ€
       * @returns {string} HTMLå­—ç¬¦ä¸²
       */
      function renderStatusBadge(status) {
        const badges = {
          pending:
            '<span class="badge bg-warning text-dark"><i class="bi bi-clock"></i> å¾…å®¡æ ¸</span>',
          approved:
            '<span class="badge bg-success"><i class="bi bi-check-circle"></i> å·²é€šè¿‡</span>',
          rejected: '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> å·²æ‹’ç»</span>'
        }
        return badges[status] || '<span class="badge bg-secondary">æœªçŸ¥</span>'
      }

      /**
       * æ¸²æŸ“æ“ä½œæŒ‰é’®
       * @param {Object} record - è®°å½•å¯¹è±¡
       * @returns {string} HTMLå­—ç¬¦ä¸²
       */
      function renderActions(record) {
        if (record.status === 'pending') {
          return `
          <button class="btn btn-sm btn-success me-1 review-btn" data-record-id="${record.record_id || record.id}" data-action="approve">
            <i class="bi bi-check-lg"></i> é€šè¿‡
          </button>
          <button class="btn btn-sm btn-danger review-btn" data-record-id="${record.record_id || record.id}" data-action="reject">
            <i class="bi bi-x-lg"></i> æ‹’ç»
          </button>
        `
        } else {
          const reviewInfo = record.reviewed_at
            ? `<div><small class="text-muted">å®¡æ ¸æ—¶é—´ï¼š${formatDate(record.reviewed_at)}</small></div>`
            : ''
          const remark = record.admin_remark
            ? `<div><small class="text-muted">å¤‡æ³¨ï¼š${record.admin_remark}</small></div>`
            : ''
          return `
          <small class="text-muted">å·²å®¡æ ¸</small>
          ${reviewInfo}
          ${remark}
        `
        }
      }

      /**
       * æ¸²æŸ“åˆ†é¡µ
       * @param {number} total - æ€»è®°å½•æ•°
       * @param {number} current - å½“å‰é¡µç 
       */
      function renderPagination(total, current) {
        const pagination = document.getElementById('pagination')
        const totalPages = Math.ceil(total / pageSize)

        if (totalPages <= 1) {
          pagination.innerHTML = `
          <li class="page-item disabled">
            <span class="page-link">å…± ${total} æ¡è®°å½•</span>
          </li>
        `
          return
        }

        let html = `
        <li class="page-item ${current === 1 ? 'disabled' : ''}">
          <a class="page-link page-nav-btn" href="#" data-page="${current - 1}">ä¸Šä¸€é¡µ</a>
        </li>
      `

        // æ˜¾ç¤ºé¡µç 
        const maxPages = 7
        let startPage = Math.max(1, current - Math.floor(maxPages / 2))
        let endPage = Math.min(totalPages, startPage + maxPages - 1)

        if (endPage - startPage < maxPages - 1) {
          startPage = Math.max(1, endPage - maxPages + 1)
        }

        if (startPage > 1) {
          html += `<li class="page-item"><a class="page-link page-nav-btn" href="#" data-page="1">1</a></li>`
          if (startPage > 2) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`
          }
        }

        for (let i = startPage; i <= endPage; i++) {
          html += `
          <li class="page-item ${i === current ? 'active' : ''}">
            <a class="page-link page-nav-btn" href="#" data-page="${i}">${i}</a>
          </li>
        `
        }

        if (endPage < totalPages) {
          if (endPage < totalPages - 1) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`
          }
          html += `<li class="page-item"><a class="page-link page-nav-btn" href="#" data-page="${totalPages}">${totalPages}</a></li>`
        }

        html += `
        <li class="page-item ${current === totalPages ? 'disabled' : ''}">
          <a class="page-link page-nav-btn" href="#" data-page="${current + 1}">ä¸‹ä¸€é¡µ</a>
        </li>
      `

        pagination.innerHTML = html
      }

      /**
       * æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
       * @param {Object} data - APIè¿”å›çš„æ•°æ®
       */
      function updateStatistics(data) {
        if (data.statistics) {
          document.getElementById('pendingCount').textContent = formatNumber(
            data.statistics.pending || 0
          )
          document.getElementById('todayCount').textContent = formatNumber(
            data.statistics.today || 0
          )
          document.getElementById('approvedCount').textContent = formatNumber(
            data.statistics.approved || 0
          )
          document.getElementById('rejectedCount').textContent = formatNumber(
            data.statistics.rejected || 0
          )
        }
      }

      /**
       * åˆ‡æ¢é¡µç 
       * @param {number} page - ç›®æ ‡é¡µç 
       */
      function changePage(page) {
        currentPage = page
        loadRecords()
        window.scrollTo({ top: 0, behavior: 'smooth' })
      }

      /**
       * é‡ç½®ç­›é€‰å™¨
       */
      function resetFilters() {
        document.getElementById('statusFilter').value = 'pending'
        document.getElementById('searchInput').value = ''
        currentPage = 1
        loadRecords()
      }

      /**
       * æŸ¥çœ‹å‡­è¯
       * @param {string} url - å‡­è¯å›¾ç‰‡URL
       * @param {number} recordId - è®°å½•ID
       */
      function viewVoucher(url, recordId) {
        document.getElementById('voucherImage').src = url
        document.getElementById('voucherInfo').innerHTML =
          `<small class="text-muted">è®°å½•ID: ${recordId}</small>`
        new bootstrap.Modal(document.getElementById('voucherModal')).show()
      }

      /**
       * å®¡æ ¸è®°å½•
       * @param {number} recordId - è®°å½•ID
       * @param {string} action - æ“ä½œç±»å‹ï¼ˆapprove/rejectï¼‰
       */
      function reviewRecord(recordId, action) {
        currentRecordId = recordId
        currentAction = action

        const modal = new bootstrap.Modal(document.getElementById('remarkModal'))
        document.getElementById('remarkModalTitle').textContent =
          action === 'approve' ? 'å®¡æ ¸é€šè¿‡ - å¤‡æ³¨' : 'å®¡æ ¸æ‹’ç» - å¤‡æ³¨'
        document.getElementById('remarkInput').value = ''
        document.getElementById('remarkInput').placeholder =
          action === 'approve' ? 'è¯·è¾“å…¥é€šè¿‡åŸå› ï¼ˆå¯é€‰ï¼‰' : 'è¯·è¾“å…¥æ‹’ç»åŸå› ï¼ˆå»ºè®®å¡«å†™ï¼‰'

        modal.show()
      }

      /**
       * æäº¤å®¡æ ¸
       */
      async function submitReview() {
        const remark = document.getElementById('remarkInput').value.trim()

        if (currentAction === 'reject' && !remark) {
          alert('æ‹’ç»å®¡æ ¸æ—¶å»ºè®®å¡«å†™æ‹’ç»åŸå› ')
          return
        }

        showLoading()

        try {
          const endpoint =
            currentAction === 'approve'
              ? `/api/v4/consumption/approve/${currentRecordId}`
              : `/api/v4/consumption/reject/${currentRecordId}`

          // âœ… ä¿®æ­£ï¼šåç«¯æœŸæœ›çš„å‚æ•°åæ˜¯ admin_notes è€Œä¸æ˜¯ admin_remark
          const response = await apiRequest(endpoint, {
            method: 'POST',
            body: JSON.stringify({ admin_notes: remark })
          })

          if (response && response.success) {
            showSuccess('å®¡æ ¸æˆåŠŸ', currentAction === 'approve' ? 'è®°å½•å·²å®¡æ ¸é€šè¿‡' : 'è®°å½•å·²æ‹’ç»')

            // å…³é—­æ¨¡æ€æ¡†
            bootstrap.Modal.getInstance(document.getElementById('remarkModal')).hide()

            // é‡æ–°åŠ è½½æ•°æ®
            loadRecords(true)
          } else {
            showError('å®¡æ ¸å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥')
          }
        } catch (error) {
          console.error('å®¡æ ¸å¤±è´¥:', error)
          showError('å®¡æ ¸å¤±è´¥', error.message)
        } finally {
          hideLoading()
        }
      }

      /**
       * æ˜¾ç¤ºåŠ è½½çŠ¶æ€
       */
      function showLoading() {
        document.getElementById('loadingOverlay').classList.add('show')
      }

      /**
       * éšè—åŠ è½½çŠ¶æ€
       */
      function hideLoading() {
        document.getElementById('loadingOverlay').classList.remove('show')
      }

      /**
       * æ˜¾ç¤ºæˆåŠŸæç¤º
       * @param {string} title - æ ‡é¢˜
       * @param {string} message - æ¶ˆæ¯
       */
      function showSuccess(title, message) {
        alert(`âœ… ${title}\n${message}`)
      }

      /**
       * æ˜¾ç¤ºé”™è¯¯æç¤º
       * @param {string} title - æ ‡é¢˜
       * @param {string} message - æ¶ˆæ¯
       */
      function showError(title, message) {
        alert(`âŒ ${title}\n${message}`)
      }
    </script>
  </body>
</html>
