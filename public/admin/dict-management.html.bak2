<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­—å…¸ç®¡ç† - ç®¡ç†åå°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">
  <style>
    .dict-tab-btn {
      cursor: pointer;
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
    }
    .dict-tab-btn:hover,
    .dict-tab-btn.active {
      border-left-color: #0d6efd;
      background: #e7f1ff;
    }
    .dict-item-row:hover {
      background: #f8f9fa;
    }
    .color-preview {
      display: inline-block;
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 1px solid #dee2e6;
      vertical-align: middle;
    }
    .tier-badge {
      font-weight: bold;
      min-width: 24px;
    }
    [x-cloak] { display: none !important; }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ“– ç®¡ç†åå° - å­—å…¸ç®¡ç†
      </a>
      <div>
        <span class="text-light me-3" x-data x-text="$store.auth.user?.nickname ? `æ¬¢è¿ï¼Œ${$store.auth.user.nickname}` : 'æ¬¢è¿ï¼Œç®¡ç†å‘˜'">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" onclick="logout()">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4" x-data="dictManagementPage()">
    <div class="row">
      <!-- å·¦ä¾§ï¼šå­—å…¸ç±»å‹é€‰æ‹© -->
      <div class="col-md-3">
        <div class="card">
          <div class="card-header bg-white">
            <h6 class="mb-0"><i class="bi bi-book"></i> å­—å…¸ç±»å‹</h6>
          </div>
          <div class="card-body p-0">
            <div class="dict-tab-btn p-3 border-bottom" :class="{ 'active': currentDictType === 'categories' }" @click="switchDictType('categories')">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1"><i class="bi bi-folder text-primary"></i> ç‰©å“ç±»ç›®</h6>
                  <small class="text-muted">category_defs</small>
                </div>
                <span class="badge bg-primary" x-text="categoriesData.length">-</span>
              </div>
            </div>
            <div class="dict-tab-btn p-3 border-bottom" :class="{ 'active': currentDictType === 'rarities' }" @click="switchDictType('rarities')">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1"><i class="bi bi-gem text-warning"></i> ç¨€æœ‰åº¦</h6>
                  <small class="text-muted">rarity_defs</small>
                </div>
                <span class="badge bg-warning text-dark" x-text="raritiesData.length">-</span>
              </div>
            </div>
            <div class="dict-tab-btn p-3" :class="{ 'active': currentDictType === 'asset-groups' }" @click="switchDictType('asset-groups')">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1"><i class="bi bi-collection text-success"></i> èµ„äº§åˆ†ç»„</h6>
                  <small class="text-muted">asset_group_defs</small>
                </div>
                <span class="badge bg-success" x-text="assetGroupsData.length">-</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§ï¼šå­—å…¸æ•°æ®è¡¨æ ¼ -->
      <div class="col-md-9">
        <div class="card">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
              <i class="bi bi-list-ul"></i> 
              <span x-text="dictTitles[currentDictType]">ç‰©å“ç±»ç›®åˆ—è¡¨</span>
            </h6>
            <button class="btn btn-sm btn-success" @click="openAddModal()">
              <i class="bi bi-plus"></i> æ–°å¢
            </button>
          </div>
          <div class="card-body">
            <!-- ç±»ç›®è¡¨æ ¼ -->
            <div class="table-responsive" x-show="currentDictType === 'categories'" x-cloak>
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>ç±»ç›®ä»£ç </th>
                    <th>æ˜¾ç¤ºåç§°</th>
                    <th>å›¾æ ‡</th>
                    <th>æ’åº</th>
                    <th>çŠ¶æ€</th>
                    <th style="width: 120px;">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-if="categoriesData.length === 0">
                    <tr><td colspan="6" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>
                  </template>
                  <template x-for="item in categoriesData" :key="item.category_code">
                    <tr class="dict-item-row">
                      <td><code x-text="item.category_code"></code></td>
                      <td x-text="item.display_name"></td>
                      <td>
                        <template x-if="item.icon_url">
                          <img :src="item.icon_url" alt="" style="width:24px;height:24px;">
                        </template>
                        <template x-if="!item.icon_url">-</template>
                      </td>
                      <td><span class="badge bg-secondary" x-text="item.sort_order || 0"></span></td>
                      <td><span class="badge" :class="item.is_enabled ? 'bg-success' : 'bg-secondary'" x-text="item.is_enabled ? 'å¯ç”¨' : 'ç¦ç”¨'"></span></td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary me-1" @click="editCategory(item)"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger" @click="deleteCategory(item.category_code)"><i class="bi bi-trash"></i></button>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- ç¨€æœ‰åº¦è¡¨æ ¼ -->
            <div class="table-responsive" x-show="currentDictType === 'rarities'" x-cloak>
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>ç¨€æœ‰åº¦ä»£ç </th>
                    <th>æ˜¾ç¤ºåç§°</th>
                    <th>ç­‰çº§</th>
                    <th>é¢œè‰²</th>
                    <th>æ’åº</th>
                    <th>çŠ¶æ€</th>
                    <th style="width: 120px;">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-if="raritiesData.length === 0">
                    <tr><td colspan="7" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>
                  </template>
                  <template x-for="item in raritiesData" :key="item.rarity_code">
                    <tr class="dict-item-row">
                      <td><code x-text="item.rarity_code"></code></td>
                      <td x-text="item.display_name"></td>
                      <td><span class="badge bg-info tier-badge" x-text="item.tier || 1"></span></td>
                      <td>
                        <template x-if="item.color_hex">
                          <span>
                            <span class="color-preview" :style="`background:${item.color_hex}`"></span>
                            <code x-text="item.color_hex"></code>
                          </span>
                        </template>
                        <template x-if="!item.color_hex">-</template>
                      </td>
                      <td><span class="badge bg-secondary" x-text="item.sort_order || 0"></span></td>
                      <td><span class="badge" :class="item.is_enabled ? 'bg-success' : 'bg-secondary'" x-text="item.is_enabled ? 'å¯ç”¨' : 'ç¦ç”¨'"></span></td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary me-1" @click="editRarity(item)"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger" @click="deleteRarity(item.rarity_code)"><i class="bi bi-trash"></i></button>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- èµ„äº§åˆ†ç»„è¡¨æ ¼ -->
            <div class="table-responsive" x-show="currentDictType === 'asset-groups'" x-cloak>
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>åˆ†ç»„ä»£ç </th>
                    <th>æ˜¾ç¤ºåç§°</th>
                    <th>åˆ†ç»„ç±»å‹</th>
                    <th>é¢œè‰²</th>
                    <th>å¯äº¤æ˜“</th>
                    <th>æ’åº</th>
                    <th>çŠ¶æ€</th>
                    <th style="width: 120px;">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-if="assetGroupsData.length === 0">
                    <tr><td colspan="8" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>
                  </template>
                  <template x-for="item in assetGroupsData" :key="item.group_code">
                    <tr class="dict-item-row">
                      <td><code x-text="item.group_code"></code></td>
                      <td x-text="item.display_name"></td>
                      <td><span class="badge bg-info" x-text="getGroupTypeLabel(item.group_type)"></span></td>
                      <td>
                        <template x-if="item.color_hex">
                          <span>
                            <span class="color-preview" :style="`background:${item.color_hex}`"></span>
                            <code x-text="item.color_hex"></code>
                          </span>
                        </template>
                        <template x-if="!item.color_hex">-</template>
                      </td>
                      <td><span class="badge" :class="item.is_tradable ? 'bg-success' : 'bg-warning'" x-text="item.is_tradable ? 'æ˜¯' : 'å¦'"></span></td>
                      <td><span class="badge bg-secondary" x-text="item.sort_order || 0"></span></td>
                      <td><span class="badge" :class="item.is_enabled ? 'bg-success' : 'bg-secondary'" x-text="item.is_enabled ? 'å¯ç”¨' : 'ç¦ç”¨'"></span></td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary me-1" @click="editAssetGroup(item)"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger" @click="deleteAssetGroup(item.group_code)"><i class="bi bi-trash"></i></button>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç±»ç›®ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal fade" id="categoryModal" tabindex="-1" x-ref="categoryModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" x-text="categoryForm.editCode ? 'ç¼–è¾‘ç±»ç›®' : 'æ–°å¢ç±»ç›®'"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form @submit.prevent="submitCategory">
              <div class="mb-3">
                <label class="form-label">ç±»ç›®ä»£ç  <span class="text-danger">*</span></label>
                <input type="text" class="form-control" x-model="categoryForm.code" :disabled="!!categoryForm.editCode" required placeholder="å¦‚ï¼šconsumableã€equipment">
                <small class="text-muted">å°å†™å­—æ¯å¼€å¤´ï¼Œä»…åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿</small>
              </div>
              <div class="mb-3">
                <label class="form-label">æ˜¾ç¤ºåç§° <span class="text-danger">*</span></label>
                <input type="text" class="form-control" x-model="categoryForm.displayName" required placeholder="å¦‚ï¼šæ¶ˆè€—å“ã€è£…å¤‡">
              </div>
              <div class="mb-3">
                <label class="form-label">æè¿°</label>
                <textarea class="form-control" x-model="categoryForm.description" rows="2"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">å›¾æ ‡URL</label>
                <input type="text" class="form-control" x-model="categoryForm.iconUrl" placeholder="https://...">
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">æ’åº</label>
                  <input type="number" class="form-control" x-model.number="categoryForm.sortOrder" min="0">
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">çŠ¶æ€</label>
                  <select class="form-select" x-model="categoryForm.isEnabled">
                    <option :value="true">å¯ç”¨</option>
                    <option :value="false">ç¦ç”¨</option>
                  </select>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary" :disabled="isSubmitting">ä¿å­˜</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- ç¨€æœ‰åº¦ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal fade" id="rarityModal" tabindex="-1" x-ref="rarityModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" x-text="rarityForm.editCode ? 'ç¼–è¾‘ç¨€æœ‰åº¦' : 'æ–°å¢ç¨€æœ‰åº¦'"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form @submit.prevent="submitRarity">
              <div class="mb-3">
                <label class="form-label">ç¨€æœ‰åº¦ä»£ç  <span class="text-danger">*</span></label>
                <input type="text" class="form-control" x-model="rarityForm.code" :disabled="!!rarityForm.editCode" required placeholder="å¦‚ï¼šcommonã€rareã€legendary">
              </div>
              <div class="mb-3">
                <label class="form-label">æ˜¾ç¤ºåç§° <span class="text-danger">*</span></label>
                <input type="text" class="form-control" x-model="rarityForm.displayName" required placeholder="å¦‚ï¼šæ™®é€šã€ç¨€æœ‰ã€ä¼ è¯´">
              </div>
              <div class="mb-3">
                <label class="form-label">æè¿°</label>
                <textarea class="form-control" x-model="rarityForm.description" rows="2"></textarea>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">ç­‰çº§ (tier)</label>
                  <input type="number" class="form-control" x-model.number="rarityForm.tier" min="1">
                  <small class="text-muted">æ•°å€¼è¶Šå¤§è¶Šç¨€æœ‰</small>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">ä¸»é¢˜é¢œè‰²</label>
                  <div class="input-group">
                    <input type="color" class="form-control form-control-color" x-model="rarityForm.colorHex" @input="syncColorHex('rarity')">
                    <input type="text" class="form-control" x-model="rarityForm.colorHex" placeholder="#RRGGBB">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">æ’åº</label>
                  <input type="number" class="form-control" x-model.number="rarityForm.sortOrder" min="0">
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">çŠ¶æ€</label>
                  <select class="form-select" x-model="rarityForm.isEnabled">
                    <option :value="true">å¯ç”¨</option>
                    <option :value="false">ç¦ç”¨</option>
                  </select>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary" :disabled="isSubmitting">ä¿å­˜</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- èµ„äº§åˆ†ç»„ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal fade" id="assetGroupModal" tabindex="-1" x-ref="assetGroupModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" x-text="assetGroupForm.editCode ? 'ç¼–è¾‘èµ„äº§åˆ†ç»„' : 'æ–°å¢èµ„äº§åˆ†ç»„'"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form @submit.prevent="submitAssetGroup">
              <div class="mb-3">
                <label class="form-label">åˆ†ç»„ä»£ç  <span class="text-danger">*</span></label>
                <input type="text" class="form-control" x-model="assetGroupForm.code" :disabled="!!assetGroupForm.editCode" required placeholder="å¦‚ï¼šmaterialã€currency">
              </div>
              <div class="mb-3">
                <label class="form-label">æ˜¾ç¤ºåç§° <span class="text-danger">*</span></label>
                <input type="text" class="form-control" x-model="assetGroupForm.displayName" required placeholder="å¦‚ï¼šææ–™ã€è´§å¸">
              </div>
              <div class="mb-3">
                <label class="form-label">æè¿°</label>
                <textarea class="form-control" x-model="assetGroupForm.description" rows="2"></textarea>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">åˆ†ç»„ç±»å‹</label>
                  <select class="form-select" x-model="assetGroupForm.groupType">
                    <option value="system">ç³»ç»Ÿ (system)</option>
                    <option value="material">ææ–™ (material)</option>
                    <option value="custom">è‡ªå®šä¹‰ (custom)</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">ä¸»é¢˜é¢œè‰²</label>
                  <div class="input-group">
                    <input type="color" class="form-control form-control-color" x-model="assetGroupForm.colorHex" @input="syncColorHex('assetGroup')">
                    <input type="text" class="form-control" x-model="assetGroupForm.colorHex" placeholder="#RRGGBB">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label">æ’åº</label>
                  <input type="number" class="form-control" x-model.number="assetGroupForm.sortOrder" min="0">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">å¯äº¤æ˜“</label>
                  <select class="form-select" x-model="assetGroupForm.isTradable">
                    <option :value="true">æ˜¯</option>
                    <option :value="false">å¦</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">çŠ¶æ€</label>
                  <select class="form-select" x-model="assetGroupForm.isEnabled">
                    <option :value="true">å¯ç”¨</option>
                    <option :value="false">ç¦ç”¨</option>
                  </select>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary" :disabled="isSubmitting">ä¿å­˜</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">åŠ è½½ä¸­...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script src="/admin/js/api-config.js"></script>
  <script src="/admin/js/alpine/init.js"></script>
  <script defer src="/admin/js/vendor/alpine.min.js"></script>
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('dictManagementPage', () => ({
        currentDictType: 'categories',
        categoriesData: [],
        raritiesData: [],
        assetGroupsData: [],
        isSubmitting: false,
        dictTitles: {
          'categories': 'ç‰©å“ç±»ç›®åˆ—è¡¨',
          'rarities': 'ç¨€æœ‰åº¦åˆ—è¡¨',
          'asset-groups': 'èµ„äº§åˆ†ç»„åˆ—è¡¨'
        },
        typeLabels: { system: 'ç³»ç»Ÿ', material: 'ææ–™', custom: 'è‡ªå®šä¹‰' },
        categoryForm: {
          editCode: '',
          code: '',
          displayName: '',
          description: '',
          iconUrl: '',
          sortOrder: 0,
          isEnabled: true,
        },
        rarityForm: {
          editCode: '',
          code: '',
          displayName: '',
          description: '',
          tier: 1,
          colorHex: '#6c757d',
          sortOrder: 0,
          isEnabled: true,
        },
        assetGroupForm: {
          editCode: '',
          code: '',
          displayName: '',
          description: '',
          groupType: 'material',
          colorHex: '#28a745',
          sortOrder: 0,
          isTradable: true,
          isEnabled: true,
        },

        init() {
          this.loadAllData();
        },

        getGroupTypeLabel(type) {
          return this.typeLabels[type] || type;
        },

        syncColorHex(formType) {
          // Color inputs sync automatically with x-model
        },

        async loadAllData() {
          showLoading();
          try {
            const [catRes, rarRes, groupRes] = await Promise.all([
              apiRequest(API_ENDPOINTS.DICT.CATEGORIES),
              apiRequest(API_ENDPOINTS.DICT.RARITIES),
              apiRequest(API_ENDPOINTS.DICT.ASSET_GROUPS)
            ]);

            if (catRes && catRes.success) {
              this.categoriesData = catRes.data.items || [];
            }
            if (rarRes && rarRes.success) {
              this.raritiesData = rarRes.data.items || [];
            }
            if (groupRes && groupRes.success) {
              this.assetGroupsData = groupRes.data.items || [];
            }
          } catch (error) {
            console.error('åŠ è½½å­—å…¸æ•°æ®å¤±è´¥:', error);
            this.showError('åŠ è½½å¤±è´¥', error.message);
          } finally {
            hideLoading();
          }
        },

        switchDictType(type) {
          this.currentDictType = type;
        },

        openAddModal() {
          switch (this.currentDictType) {
            case 'categories':
              this.categoryForm = { editCode: '', code: '', displayName: '', description: '', iconUrl: '', sortOrder: 0, isEnabled: true };
              new bootstrap.Modal(this.$refs.categoryModal).show();
              break;
            case 'rarities':
              this.rarityForm = { editCode: '', code: '', displayName: '', description: '', tier: 1, colorHex: '#6c757d', sortOrder: 0, isEnabled: true };
              new bootstrap.Modal(this.$refs.rarityModal).show();
              break;
            case 'asset-groups':
              this.assetGroupForm = { editCode: '', code: '', displayName: '', description: '', groupType: 'material', colorHex: '#28a745', sortOrder: 0, isTradable: true, isEnabled: true };
              new bootstrap.Modal(this.$refs.assetGroupModal).show();
              break;
          }
        },

        // ===== Category Operations =====
        editCategory(item) {
          this.categoryForm = {
            editCode: item.category_code,
            code: item.category_code,
            displayName: item.display_name || '',
            description: item.description || '',
            iconUrl: item.icon_url || '',
            sortOrder: item.sort_order || 0,
            isEnabled: item.is_enabled,
          };
          new bootstrap.Modal(this.$refs.categoryModal).show();
        },

        async submitCategory() {
          if (this.isSubmitting) return;
          
          const data = {
            category_code: this.categoryForm.code.trim().toLowerCase(),
            display_name: this.categoryForm.displayName.trim(),
            description: this.categoryForm.description.trim() || null,
            icon_url: this.categoryForm.iconUrl.trim() || null,
            sort_order: this.categoryForm.sortOrder || 0,
            is_enabled: this.categoryForm.isEnabled
          };

          if (!data.category_code || !data.display_name) {
            alert('è¯·å¡«å†™ç±»ç›®ä»£ç å’Œæ˜¾ç¤ºåç§°');
            return;
          }

          if (!/^[a-z][a-z0-9_]*$/.test(data.category_code)) {
            alert('ç±»ç›®ä»£ç æ ¼å¼é”™è¯¯ï¼šå¿…é¡»ä»¥å°å†™å­—æ¯å¼€å¤´ï¼Œä»…åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿');
            return;
          }

          this.isSubmitting = true;
          showLoading();
          try {
            const url = this.categoryForm.editCode
              ? API.buildURL(API_ENDPOINTS.DICT.UPDATE_CATEGORY, { code: this.categoryForm.editCode })
              : API_ENDPOINTS.DICT.CREATE_CATEGORY;
            const method = this.categoryForm.editCode ? 'PUT' : 'POST';

            const response = await apiRequest(url, { method, body: JSON.stringify(data) });

            if (response && response.success) {
              bootstrap.Modal.getInstance(this.$refs.categoryModal).hide();
              alert(`âœ… ${this.categoryForm.editCode ? 'æ›´æ–°' : 'åˆ›å»º'}æˆåŠŸ`);
              this.loadAllData();
            } else {
              this.showError('ä¿å­˜å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
            }
          } catch (error) {
            this.showError('ä¿å­˜å¤±è´¥', error.message);
          } finally {
            this.isSubmitting = false;
            hideLoading();
          }
        },

        async deleteCategory(code) {
          if (!confirm(`ç¡®å®šè¦åˆ é™¤ç±»ç›® "${code}" å—ï¼Ÿ`)) return;

          showLoading();
          try {
            const response = await apiRequest(API.buildURL(API_ENDPOINTS.DICT.DELETE_CATEGORY, { code }), { method: 'DELETE' });
            if (response && response.success) {
              alert('âœ… åˆ é™¤æˆåŠŸ');
              this.loadAllData();
            } else {
              this.showError('åˆ é™¤å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
            }
          } catch (error) {
            this.showError('åˆ é™¤å¤±è´¥', error.message);
          } finally {
            hideLoading();
          }
        },

        // ===== Rarity Operations =====
        editRarity(item) {
          this.rarityForm = {
            editCode: item.rarity_code,
            code: item.rarity_code,
            displayName: item.display_name || '',
            description: item.description || '',
            tier: item.tier || 1,
            colorHex: item.color_hex || '#6c757d',
            sortOrder: item.sort_order || 0,
            isEnabled: item.is_enabled,
          };
          new bootstrap.Modal(this.$refs.rarityModal).show();
        },

        async submitRarity() {
          if (this.isSubmitting) return;
          
          const data = {
            rarity_code: this.rarityForm.code.trim().toLowerCase(),
            display_name: this.rarityForm.displayName.trim(),
            description: this.rarityForm.description.trim() || null,
            tier: this.rarityForm.tier || 1,
            color_hex: this.rarityForm.colorHex.trim() || null,
            sort_order: this.rarityForm.sortOrder || 0,
            is_enabled: this.rarityForm.isEnabled
          };

          if (!data.rarity_code || !data.display_name) {
            alert('è¯·å¡«å†™ç¨€æœ‰åº¦ä»£ç å’Œæ˜¾ç¤ºåç§°');
            return;
          }

          if (!/^[a-z][a-z0-9_]*$/.test(data.rarity_code)) {
            alert('ç¨€æœ‰åº¦ä»£ç æ ¼å¼é”™è¯¯ï¼šå¿…é¡»ä»¥å°å†™å­—æ¯å¼€å¤´ï¼Œä»…åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿');
            return;
          }

          this.isSubmitting = true;
          showLoading();
          try {
            const url = this.rarityForm.editCode
              ? API.buildURL(API_ENDPOINTS.DICT.UPDATE_RARITY, { code: this.rarityForm.editCode })
              : API_ENDPOINTS.DICT.CREATE_RARITY;
            const method = this.rarityForm.editCode ? 'PUT' : 'POST';

            const response = await apiRequest(url, { method, body: JSON.stringify(data) });

            if (response && response.success) {
              bootstrap.Modal.getInstance(this.$refs.rarityModal).hide();
              alert(`âœ… ${this.rarityForm.editCode ? 'æ›´æ–°' : 'åˆ›å»º'}æˆåŠŸ`);
              this.loadAllData();
            } else {
              this.showError('ä¿å­˜å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
            }
          } catch (error) {
            this.showError('ä¿å­˜å¤±è´¥', error.message);
          } finally {
            this.isSubmitting = false;
            hideLoading();
          }
        },

        async deleteRarity(code) {
          if (!confirm(`ç¡®å®šè¦åˆ é™¤ç¨€æœ‰åº¦ "${code}" å—ï¼Ÿ`)) return;

          showLoading();
          try {
            const response = await apiRequest(API.buildURL(API_ENDPOINTS.DICT.DELETE_RARITY, { code }), { method: 'DELETE' });
            if (response && response.success) {
              alert('âœ… åˆ é™¤æˆåŠŸ');
              this.loadAllData();
            } else {
              this.showError('åˆ é™¤å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
            }
          } catch (error) {
            this.showError('åˆ é™¤å¤±è´¥', error.message);
          } finally {
            hideLoading();
          }
        },

        // ===== Asset Group Operations =====
        editAssetGroup(item) {
          this.assetGroupForm = {
            editCode: item.group_code,
            code: item.group_code,
            displayName: item.display_name || '',
            description: item.description || '',
            groupType: item.group_type || 'material',
            colorHex: item.color_hex || '#28a745',
            sortOrder: item.sort_order || 0,
            isTradable: item.is_tradable,
            isEnabled: item.is_enabled,
          };
          new bootstrap.Modal(this.$refs.assetGroupModal).show();
        },

        async submitAssetGroup() {
          if (this.isSubmitting) return;
          
          const data = {
            group_code: this.assetGroupForm.code.trim().toLowerCase(),
            display_name: this.assetGroupForm.displayName.trim(),
            description: this.assetGroupForm.description.trim() || null,
            group_type: this.assetGroupForm.groupType,
            color_hex: this.assetGroupForm.colorHex.trim() || null,
            sort_order: this.assetGroupForm.sortOrder || 0,
            is_tradable: this.assetGroupForm.isTradable,
            is_enabled: this.assetGroupForm.isEnabled
          };

          if (!data.group_code || !data.display_name) {
            alert('è¯·å¡«å†™åˆ†ç»„ä»£ç å’Œæ˜¾ç¤ºåç§°');
            return;
          }

          if (!/^[a-z][a-z0-9_]*$/.test(data.group_code)) {
            alert('åˆ†ç»„ä»£ç æ ¼å¼é”™è¯¯ï¼šå¿…é¡»ä»¥å°å†™å­—æ¯å¼€å¤´ï¼Œä»…åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿');
            return;
          }

          this.isSubmitting = true;
          showLoading();
          try {
            const url = this.assetGroupForm.editCode
              ? API.buildURL(API_ENDPOINTS.DICT.UPDATE_ASSET_GROUP, { code: this.assetGroupForm.editCode })
              : API_ENDPOINTS.DICT.CREATE_ASSET_GROUP;
            const method = this.assetGroupForm.editCode ? 'PUT' : 'POST';

            const response = await apiRequest(url, { method, body: JSON.stringify(data) });

            if (response && response.success) {
              bootstrap.Modal.getInstance(this.$refs.assetGroupModal).hide();
              alert(`âœ… ${this.assetGroupForm.editCode ? 'æ›´æ–°' : 'åˆ›å»º'}æˆåŠŸ`);
              this.loadAllData();
            } else {
              this.showError('ä¿å­˜å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
            }
          } catch (error) {
            this.showError('ä¿å­˜å¤±è´¥', error.message);
          } finally {
            this.isSubmitting = false;
            hideLoading();
          }
        },

        async deleteAssetGroup(code) {
          if (!confirm(`ç¡®å®šè¦åˆ é™¤èµ„äº§åˆ†ç»„ "${code}" å—ï¼Ÿ`)) return;

          showLoading();
          try {
            const response = await apiRequest(API.buildURL(API_ENDPOINTS.DICT.DELETE_ASSET_GROUP, { code }), { method: 'DELETE' });
            if (response && response.success) {
              alert('âœ… åˆ é™¤æˆåŠŸ');
              this.loadAllData();
            } else {
              this.showError('åˆ é™¤å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
            }
          } catch (error) {
            this.showError('åˆ é™¤å¤±è´¥', error.message);
          } finally {
            hideLoading();
          }
        },

        showError(title, message) {
          alert(`âŒ ${title}\n${message}`);
        }
      }));
    });
  </script>
</body>
</html>
