<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¥–å“æ± é…ç½® - ç®¡ç†åå°</title>
  
  <!-- âœ… Bootstrap 5 - UIæ¡†æ¶ -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- âœ… Bootstrap Icons - å›¾æ ‡åº“ -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- âœ… å…¬å…±æ ·å¼è¡¨ - ç»Ÿä¸€ä¸»é¢˜å’Œå“åº”å¼è®¾è®¡ -->
  <link href="/admin/css/common.css" rel="stylesheet">
  
  <!-- âœ… é¡µé¢ç‰¹æœ‰æ ·å¼ -->
  <style>
    .stock-badge {
      font-size: 0.875rem;
      padding: 0.25rem 0.75rem;
    }
  </style>
</head>
<body class="bg-light">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ ç®¡ç†åå° - å¥–å“æ± é…ç½®
      </a>
      <div>
        <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>
  
  <div class="container-fluid mt-4">
    <!-- æ“ä½œåŒºåŸŸ -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-0">
              <i class="bi bi-gift-fill"></i> å¥–å“æ± ç®¡ç†
            </h5>
            <small class="text-muted">ç®¡ç†æŠ½å¥–ç³»ç»Ÿä¸­çš„æ‰€æœ‰å¥–å“</small>
          </div>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPrizeModal">
            <i class="bi bi-plus-lg"></i> æ·»åŠ å¥–å“
          </button>
        </div>
      </div>
    </div>
    
    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="row g-3 mb-3">
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h6 class="text-muted">å¥–å“æ€»æ•°</h6>
            <h3 class="text-primary" id="totalPrizes">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h6 class="text-muted">åº“å­˜å……è¶³</h6>
            <h3 class="text-success" id="inStockPrizes">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h6 class="text-muted">åº“å­˜ä¸è¶³</h6>
            <h3 class="text-warning" id="lowStockPrizes">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h6 class="text-muted">å·²é¢†å–</h6>
            <h3 class="text-info" id="claimedPrizes">-</h3>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æ•°æ®è¡¨æ ¼ -->
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th style="width: 80px;">ID</th>
                <th>å¥–å“ä¿¡æ¯</th>
                <th>ç±»å‹</th>
                <th>ä»·å€¼</th>
                <th>åº“å­˜</th>
                <th>å·²é¢†å–</th>
                <th>çŠ¶æ€</th>
                <th style="width: 250px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="prizesTableBody">
              <tr>
                <td colspan="8" class="text-center py-5">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                  </div>
                  <p class="mt-2 text-muted">æ­£åœ¨åŠ è½½æ•°æ®...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <!-- æ·»åŠ å¥–å“æ¨¡æ€æ¡† -->
  <div class="modal fade" id="addPrizeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-plus-circle"></i> æ·»åŠ å¥–å“
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addPrizeForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">å¥–å“åç§° <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="prizeName" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">å¥–å“ç±»å‹ <span class="text-danger">*</span></label>
                <select class="form-select" id="prizeType" required>
                  <option value="">è¯·é€‰æ‹©</option>
                  <option value="physical">å®ç‰©å¥–å“</option>
                  <option value="virtual">è™šæ‹Ÿå¥–å“</option>
                  <option value="points">ç§¯åˆ†å¥–åŠ±</option>
                  <option value="coupon">ä¼˜æƒ åˆ¸</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">å¥–å“ä»·å€¼(å…ƒ) <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="prizeValue" step="0.01" min="0" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">åˆå§‹åº“å­˜ <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="prizeStock" min="0" required>
              </div>
              <div class="col-12">
                <label class="form-label">å¥–å“æè¿°</label>
                <textarea class="form-control" id="prizeDescription" rows="3"></textarea>
              </div>
              <div class="col-12">
                <label class="form-label">å¥–å“å›¾ç‰‡</label>
                <input type="file" class="form-control" id="prizeImageInput" accept="image/*">
                <small class="text-muted">æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œå»ºè®®å°ºå¯¸ 400x400</small>
                <div id="imagePreviewContainer" class="mt-2" style="display: none;">
                  <img id="imagePreview" class="upload-preview" alt="é¢„è§ˆ">
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" id="submitAddPrizeBtn">
            <i class="bi bi-check-lg"></i> æ·»åŠ 
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ç¼–è¾‘å¥–å“æ¨¡æ€æ¡† -->
  <div class="modal fade" id="editPrizeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-pencil-square"></i> ç¼–è¾‘å¥–å“
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editPrizeForm">
            <input type="hidden" id="editPrizeId">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">å¥–å“åç§° <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="editPrizeName" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">å¥–å“ç±»å‹ <span class="text-danger">*</span></label>
                <select class="form-select" id="editPrizeType" required>
                  <option value="physical">å®ç‰©å¥–å“</option>
                  <option value="virtual">è™šæ‹Ÿå¥–å“</option>
                  <option value="points">ç§¯åˆ†å¥–åŠ±</option>
                  <option value="coupon">ä¼˜æƒ åˆ¸</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">å¥–å“ä»·å€¼(å…ƒ) <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="editPrizeValue" step="0.01" min="0" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">å½“å‰åº“å­˜ <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="editPrizeStock" min="0" required>
              </div>
              <div class="col-12">
                <label class="form-label">å¥–å“æè¿°</label>
                <textarea class="form-control" id="editPrizeDescription" rows="3"></textarea>
              </div>
              <div class="col-12">
                <label class="form-label">å¥–å“å›¾ç‰‡</label>
                <input type="file" class="form-control" id="editPrizeImageInput" accept="image/*">
                <small class="text-muted">ç•™ç©ºåˆ™ä¸æ›´æ–°å›¾ç‰‡</small>
                <div id="editImagePreviewContainer" class="mt-2">
                  <img id="editImagePreview" class="upload-preview" alt="å½“å‰å›¾ç‰‡">
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" id="submitEditPrizeBtn">
            <i class="bi bi-check-lg"></i> ä¿å­˜
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- åŠ è½½é®ç½©å±‚ -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">å¤„ç†ä¸­...</span>
    </div>
  </div>

  <!-- âœ… Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- âœ… èµ„æºé…ç½® - ç»Ÿä¸€é™æ€èµ„æºç®¡ç† -->
  <script src="/admin/js/resource-config.js"></script>
  
  <!-- âœ… å¼•å…¥é€šç”¨å·¥å…·åº“ -->
  <script src="/admin/js/admin-common.js"></script>
  
  <script>
    /**
     * å…¨å±€å˜é‡
     */
    const defaultPrizeImage = ResourceConfig.getImage('defaultPrize');
    let currentPrizes = [];
    
    /**
     * é¡µé¢åˆå§‹åŒ–
     */
    document.addEventListener('DOMContentLoaded', function() {
      // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
      const userInfo = getCurrentUser();
      if (userInfo && userInfo.nickname) {
        document.getElementById('welcomeText').textContent = `æ¬¢è¿ï¼Œ${userInfo.nickname}`;
      }
      
      // âœ… Tokenå’Œæƒé™éªŒè¯
      if (!getToken() || !checkAdminPermission()) {
        return;
      }
      
      // åŠ è½½å¥–å“åˆ—è¡¨
      loadPrizes();
      
      // ===== é™æ€æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨ =====
      // é€€å‡ºç™»å½•æŒ‰é’®
      document.getElementById('logoutBtn').addEventListener('click', logout);
      
      // æäº¤æŒ‰é’®
      document.getElementById('submitAddPrizeBtn').addEventListener('click', submitAddPrize);
      document.getElementById('submitEditPrizeBtn').addEventListener('click', submitEditPrize);
      
      // ===== äº‹ä»¶å§”æ‰˜ï¼šå¥–å“æ“ä½œæŒ‰é’® =====
      document.getElementById('prizesTableBody').addEventListener('click', (e) => {
        // ç¼–è¾‘æŒ‰é’®
        const editBtn = e.target.closest('.prize-edit-btn');
        if (editBtn) {
          const prizeId = parseInt(editBtn.dataset.prizeId);
          editPrize(prizeId);
          return;
        }
        
        // è¡¥è´§æŒ‰é’®
        const stockBtn = e.target.closest('.prize-stock-btn');
        if (stockBtn) {
          const prizeId = parseInt(stockBtn.dataset.prizeId);
          addStock(prizeId);
          return;
        }
        
        // åˆ é™¤æŒ‰é’®
        const deleteBtn = e.target.closest('.prize-delete-btn');
        if (deleteBtn) {
          const prizeId = parseInt(deleteBtn.dataset.prizeId);
          deletePrize(prizeId);
          return;
        }
      });
      
      // ===== å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç† =====
      document.getElementById('prizesTableBody').addEventListener('error', (e) => {
        if (e.target.classList.contains('prize-img')) {
          e.target.src = defaultPrizeImage;
        }
      }, true);
      
      // å›¾ç‰‡é¢„è§ˆ
      document.getElementById('prizeImageInput').addEventListener('change', function(e) {
        previewImage(e.target, 'imagePreview', 'imagePreviewContainer');
      });
      
      document.getElementById('editPrizeImageInput').addEventListener('change', function(e) {
        previewImage(e.target, 'editImagePreview', 'editImagePreviewContainer');
      });
    });
    
    /**
     * åŠ è½½å¥–å“åˆ—è¡¨
     */
    async function loadPrizes() {
      showLoading();
      
      try {
        // é€‚é…åç«¯å·²æœ‰è·¯å¾„ï¼š/api/v4/admin/prize-pool/list
        const response = await apiRequest('/api/v4/admin/prize-pool/list');
        
        if (response && response.success) {
          currentPrizes = response.data.prizes || response.data.list || [];
          renderPrizes(currentPrizes);
          updateStatistics(response.data);
        } else {
          showError('åŠ è½½å¤±è´¥', response?.message || 'è·å–æ•°æ®å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½å¥–å“å¤±è´¥:', error);
        showError('åŠ è½½å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * æ¸²æŸ“å¥–å“åˆ—è¡¨
     * @param {Array} prizes - å¥–å“æ•°ç»„
     */
    function renderPrizes(prizes) {
      const tbody = document.getElementById('prizesTableBody');
      
      if (prizes.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="text-center py-5">
              <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
              <p class="mt-2 text-muted">æš‚æ— å¥–å“ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ å¥–å“</p>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = prizes.map(prize => `
        <tr>
          <td>${prize.prize_id || prize.id}</td>
          <td>
            <div class="d-flex align-items-center">
              <img src="${prize.image_url || defaultPrizeImage}" 
                   class="prize-image me-3 prize-img" 
                   alt="${prize.prize_name}"
                   onerror="this.src='${defaultPrizeImage}'">
              <div>
                <div class="fw-bold">${prize.prize_name}</div>
                <small class="text-muted">${prize.description || 'æš‚æ— æè¿°'}</small>
              </div>
            </div>
          </td>
          <td>${getPrizeTypeLabel(prize.prize_type)}</td>
          <td class="fw-bold text-primary">Â¥${(prize.prize_value || 0).toFixed(2)}</td>
          <td>${renderStockBadge(prize.current_stock, prize.initial_stock)}</td>
          <td class="text-info">${formatNumber(prize.claimed_count || 0)}</td>
          <td>${renderPrizeStatus(prize)}</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary prize-edit-btn" data-prize-id="${prize.prize_id || prize.id}">
                <i class="bi bi-pencil"></i> ç¼–è¾‘
              </button>
              <button class="btn btn-outline-success prize-stock-btn" data-prize-id="${prize.prize_id || prize.id}">
                <i class="bi bi-plus-circle"></i> è¡¥è´§
              </button>
              <button class="btn btn-outline-danger prize-delete-btn" data-prize-id="${prize.prize_id || prize.id}">
                <i class="bi bi-trash"></i> åˆ é™¤
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }
    
    /**
     * è·å–å¥–å“ç±»å‹æ ‡ç­¾
     * @param {string} type - å¥–å“ç±»å‹
     * @returns {string} æ ‡ç­¾æ–‡æœ¬
     */
    function getPrizeTypeLabel(type) {
      const labels = {
        physical: '<span class="badge bg-primary">å®ç‰©å¥–å“</span>',
        virtual: '<span class="badge bg-info">è™šæ‹Ÿå¥–å“</span>',
        points: '<span class="badge bg-success">ç§¯åˆ†å¥–åŠ±</span>',
        coupon: '<span class="badge bg-warning text-dark">ä¼˜æƒ åˆ¸</span>'
      };
      return labels[type] || '<span class="badge bg-secondary">æœªçŸ¥</span>';
    }
    
    /**
     * æ¸²æŸ“åº“å­˜å¾½ç« 
     * @param {number} current - å½“å‰åº“å­˜
     * @param {number} initial - åˆå§‹åº“å­˜
     * @returns {string} HTMLå­—ç¬¦ä¸²
     */
    function renderStockBadge(current, initial) {
      const percentage = initial > 0 ? (current / initial) * 100 : 0;
      let badgeClass = 'bg-success';
      let icon = 'check-circle';
      
      if (percentage === 0) {
        badgeClass = 'bg-danger';
        icon = 'x-circle';
      } else if (percentage < 20) {
        badgeClass = 'bg-warning text-dark';
        icon = 'exclamation-circle';
      }
      
      return `
        <span class="badge ${badgeClass} stock-badge">
          <i class="bi bi-${icon}"></i> ${current}/${initial}
        </span>
      `;
    }
    
    /**
     * æ¸²æŸ“å¥–å“çŠ¶æ€
     * @param {Object} prize - å¥–å“å¯¹è±¡
     * @returns {string} HTMLå­—ç¬¦ä¸²
     */
    function renderPrizeStatus(prize) {
      if (prize.current_stock === 0) {
        return '<span class="badge bg-danger">å·²å”®ç½„</span>';
      } else if (prize.current_stock < prize.initial_stock * 0.2) {
        return '<span class="badge bg-warning text-dark">åº“å­˜ä¸è¶³</span>';
      } else {
        return '<span class="badge bg-success">æ­£å¸¸</span>';
      }
    }
    
    /**
     * æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
     * @param {Object} data - APIè¿”å›çš„æ•°æ®
     */
    function updateStatistics(data) {
      if (data.statistics) {
        document.getElementById('totalPrizes').textContent = formatNumber(data.statistics.total || 0);
        document.getElementById('inStockPrizes').textContent = formatNumber(data.statistics.in_stock || 0);
        document.getElementById('lowStockPrizes').textContent = formatNumber(data.statistics.low_stock || 0);
        document.getElementById('claimedPrizes').textContent = formatNumber(data.statistics.claimed || 0);
      }
    }
    
    /**
     * å›¾ç‰‡é¢„è§ˆ
     * @param {HTMLInputElement} input - æ–‡ä»¶è¾“å…¥æ¡†
     * @param {string} previewId - é¢„è§ˆå›¾ç‰‡ID
     * @param {string} containerId - å®¹å™¨ID
     */
    function previewImage(input, previewId, containerId) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById(previewId).src = e.target.result;
          document.getElementById(containerId).style.display = 'block';
        };
        reader.readAsDataURL(input.files[0]);
      }
    }
    
    /**
     * æäº¤æ·»åŠ å¥–å“
     */
    async function submitAddPrize() {
      const form = document.getElementById('addPrizeForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      const formData = new FormData();
      formData.append('prize_name', document.getElementById('prizeName').value);
      formData.append('prize_type', document.getElementById('prizeType').value);
      formData.append('prize_value', document.getElementById('prizeValue').value);
      formData.append('initial_stock', document.getElementById('prizeStock').value);
      formData.append('description', document.getElementById('prizeDescription').value);
      
      const imageFile = document.getElementById('prizeImageInput').files[0];
      if (imageFile) {
        formData.append('image', imageFile);
      }
      
      showLoading();
      
      try {
        // é€‚é…åç«¯batch-add APIï¼š/api/v4/admin/prize-pool/batch-add
        // âš ï¸ æ³¨æ„ï¼šbatch-addè¦æ±‚æ¦‚ç‡æ€»å’Œ=1ï¼Œæ‰€ä»¥å•ä¸ªå¥–å“æ—¶å¿…é¡»è®¾probability=1
        const prizeData = {
          name: document.getElementById('prizeName').value,
          type: document.getElementById('prizeType').value,
          value: parseFloat(document.getElementById('prizeValue').value) || 0,
          quantity: parseInt(document.getElementById('prizeStock').value) || 0,
          description: document.getElementById('prizeDescription').value || '',
          probability: 1, // âš ï¸ å•ä¸ªå¥–å“æ—¶è®¾ä¸º1ä»¥æ»¡è¶³batch-addçš„éªŒè¯è§„åˆ™
          image_id: null, // æš‚ä¸æ”¯æŒå›¾ç‰‡ä¸Šä¼ 
          angle: 0,
          color: '#FF6B6B'
        };
        
        const response = await apiRequest('/api/v4/admin/prize-pool/batch-add', {
          method: 'POST',
          body: JSON.stringify({
            campaign_id: 1, // é»˜è®¤ä½¿ç”¨æ´»åŠ¨ID=1 (BASIC_LOTTERY)
            prizes: [prizeData] // batch-addæœŸæœ›æ•°ç»„ï¼Œå³ä½¿åªæœ‰ä¸€ä¸ªå¥–å“
          })
        });
        
        if (response && response.success) {
          showSuccess('æ·»åŠ æˆåŠŸ', 'å¥–å“å·²æ·»åŠ åˆ°å¥–å“æ± ');
          bootstrap.Modal.getInstance(document.getElementById('addPrizeModal')).hide();
          form.reset();
          document.getElementById('imagePreviewContainer').style.display = 'none';
          loadPrizes();
        } else {
          showError('æ·»åŠ å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        console.error('æ·»åŠ å¥–å“å¤±è´¥:', error);
        showError('æ·»åŠ å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * ç¼–è¾‘å¥–å“
     * @param {number} prizeId - å¥–å“ID
     */
    function editPrize(prizeId) {
      const prize = currentPrizes.find(p => (p.prize_id || p.id) === prizeId);
      if (!prize) {
        alert('å¥–å“ä¸å­˜åœ¨');
        return;
      }
      
      document.getElementById('editPrizeId').value = prizeId;
      document.getElementById('editPrizeName').value = prize.prize_name;
      document.getElementById('editPrizeType').value = prize.prize_type;
      document.getElementById('editPrizeValue').value = prize.prize_value;
      document.getElementById('editPrizeStock').value = prize.current_stock;
      document.getElementById('editPrizeDescription').value = prize.description || '';
      
      if (prize.image_url) {
        document.getElementById('editImagePreview').src = prize.image_url;
        document.getElementById('editImagePreviewContainer').style.display = 'block';
      }
      
      new bootstrap.Modal(document.getElementById('editPrizeModal')).show();
    }
    
    /**
     * æäº¤ç¼–è¾‘å¥–å“
     */
    async function submitEditPrize() {
      const form = document.getElementById('editPrizeForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      const prizeId = document.getElementById('editPrizeId').value;
      const formData = new FormData();
      formData.append('prize_name', document.getElementById('editPrizeName').value);
      formData.append('prize_type', document.getElementById('editPrizeType').value);
      formData.append('prize_value', document.getElementById('editPrizeValue').value);
      formData.append('current_stock', document.getElementById('editPrizeStock').value);
      formData.append('description', document.getElementById('editPrizeDescription').value);
      
      const imageFile = document.getElementById('editPrizeImageInput').files[0];
      if (imageFile) {
        formData.append('image', imageFile);
      }
      
      showLoading();
      
      try {
        // é€‚é…åç«¯APIï¼šPUT /api/v4/admin/prize-pool/prize/:id
        // âš ï¸ åç«¯æœŸæœ›å‰ç«¯å­—æ®µåï¼ˆname/type/valueç­‰ï¼‰ï¼Œä¼šè‡ªåŠ¨æ˜ å°„åˆ°æ•°æ®åº“å­—æ®µ
        const updateData = {
          name: document.getElementById('editPrizeName').value,
          type: document.getElementById('editPrizeType').value,
          value: parseFloat(document.getElementById('editPrizeValue').value) || 0,
          quantity: parseInt(document.getElementById('editPrizeStock').value) || 0,
          description: document.getElementById('editPrizeDescription').value || ''
          // image_idæš‚ä¸æ”¯æŒä¿®æ”¹
        };
        
        const result = await apiRequest(`/api/v4/admin/prize-pool/prize/${prizeId}`, {
          method: 'PUT',
          body: JSON.stringify(updateData)
        });
        
        if (result && result.success) {
          showSuccess('æ›´æ–°æˆåŠŸ', 'å¥–å“ä¿¡æ¯å·²æ›´æ–°');
          bootstrap.Modal.getInstance(document.getElementById('editPrizeModal')).hide();
          loadPrizes();
        } else {
          showError('æ›´æ–°å¤±è´¥', result?.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        console.error('æ›´æ–°å¥–å“å¤±è´¥:', error);
        showError('æ›´æ–°å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * è¡¥è´§
     * @param {number} prizeId - å¥–å“ID
     */
    async function addStock(prizeId) {
      const quantity = prompt('è¯·è¾“å…¥è¡¥è´§æ•°é‡ï¼š');
      if (!quantity || isNaN(quantity) || parseInt(quantity) <= 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è¡¥è´§æ•°é‡');
        return;
      }
      
      showLoading();
      
      try {
        // é€‚é…åç«¯APIï¼šPOST /api/v4/admin/prize-pool/prize/:id/add-stock
        const response = await apiRequest(`/api/v4/admin/prize-pool/prize/${prizeId}/add-stock`, {
          method: 'POST',
          body: JSON.stringify({ quantity: parseInt(quantity) })
        });
        
        if (response && response.success) {
          showSuccess('è¡¥è´§æˆåŠŸ', `å·²è¡¥å…… ${quantity} ä»¶åº“å­˜`);
          loadPrizes();
        } else {
          showError('è¡¥è´§å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        console.error('è¡¥è´§å¤±è´¥:', error);
        showError('è¡¥è´§å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * åˆ é™¤å¥–å“
     * @param {number} prizeId - å¥–å“ID
     */
    async function deletePrize(prizeId) {
      if (!confirm('ç¡®è®¤åˆ é™¤è¯¥å¥–å“ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) {
        return;
      }
      
      showLoading();
      
      try {
        // é€‚é…åç«¯APIï¼šDELETE /api/v4/admin/prize-pool/prize/:id
        const response = await apiRequest(`/api/v4/admin/prize-pool/prize/${prizeId}`, {
          method: 'DELETE'
        });
        
        if (response && response.success) {
          showSuccess('åˆ é™¤æˆåŠŸ', 'å¥–å“å·²ä»å¥–å“æ± ä¸­åˆ é™¤');
          loadPrizes();
        } else {
          showError('åˆ é™¤å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        console.error('åˆ é™¤å¥–å“å¤±è´¥:', error);
        showError('åˆ é™¤å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * æ˜¾ç¤ºåŠ è½½çŠ¶æ€
     */
    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('show');
    }
    
    /**
     * éšè—åŠ è½½çŠ¶æ€
     */
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('show');
    }
    
    /**
     * æ˜¾ç¤ºæˆåŠŸæç¤º
     * @param {string} title - æ ‡é¢˜
     * @param {string} message - æ¶ˆæ¯
     */
    function showSuccess(title, message) {
      alert(`âœ… ${title}\n${message}`);
    }
    
    /**
     * æ˜¾ç¤ºé”™è¯¯æç¤º
     * @param {string} title - æ ‡é¢˜
     * @param {string} message - æ¶ˆæ¯
     */
    function showError(title, message) {
      alert(`âŒ ${title}\n${message}`);
    }
  </script>
</body>
</html>

