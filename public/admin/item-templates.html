<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç‰©å“æ¨¡æ¿ - ç®¡ç†åå°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">
  <style>
    .template-card {
      transition: all 0.3s ease;
      border-top: 3px solid #0d6efd;
    }
    .template-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .template-icon {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    .rarity-badge {
      font-size: 0.7rem;
      padding: 2px 6px;
    }
    .rarity-common { background: #6c757d; }
    .rarity-uncommon { background: #198754; }
    .rarity-rare { background: #0d6efd; }
    .rarity-epic { background: #6f42c1; }
    .rarity-legendary { background: #fd7e14; }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ“¦ ç®¡ç†åå° - ç‰©å“æ¨¡æ¿
      </a>
      <div>
        <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-box-seam text-primary" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">æ¨¡æ¿æ€»æ•°</h6>
            <h2 id="totalTemplates" class="text-primary mb-0">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-tags text-success" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">ç‰©å“ç±»å‹</h6>
            <h2 id="totalTypes" class="text-success mb-0">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-check-circle text-warning" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">å·²å¯ç”¨</h6>
            <h2 id="activeTemplates" class="text-warning mb-0">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-star text-info" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">ç¨€æœ‰åº¦åˆ†å¸ƒ</h6>
            <h2 id="rarityCount" class="text-info mb-0">-</h2>
          </div>
        </div>
      </div>
    </div>

    <!-- ç­›é€‰å’Œæ“ä½œæ  -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-center">
          <div class="col-md-2">
            <label class="form-label">ç‰©å“ç±»å‹</label>
            <select class="form-select" id="typeFilter">
              <option value="">å…¨éƒ¨ç±»å‹</option>
              <option value="voucher">ä¼˜æƒ åˆ¸</option>
              <option value="coupon">ä»£é‡‘åˆ¸</option>
              <option value="points">ç§¯åˆ†</option>
              <option value="gift">ç¤¼å“</option>
              <option value="virtual">è™šæ‹Ÿç‰©å“</option>
              <option value="material">ææ–™</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">ç¨€æœ‰åº¦</label>
            <select class="form-select" id="rarityFilter">
              <option value="">å…¨éƒ¨ç¨€æœ‰åº¦</option>
              <option value="common">æ™®é€š</option>
              <option value="uncommon">ä¼˜è‰¯</option>
              <option value="rare">ç¨€æœ‰</option>
              <option value="epic">å²è¯—</option>
              <option value="legendary">ä¼ è¯´</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">çŠ¶æ€</label>
            <select class="form-select" id="statusFilter">
              <option value="">å…¨éƒ¨çŠ¶æ€</option>
              <option value="active">å¯ç”¨</option>
              <option value="inactive">ç¦ç”¨</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">æœç´¢</label>
            <input type="text" class="form-control" id="searchInput" placeholder="æœç´¢æ¨¡æ¿åç§°...">
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary me-2" onclick="loadTemplates()">
              <i class="bi bi-search"></i> æœç´¢
            </button>
            <button class="btn btn-success" onclick="openCreateModal()">
              <i class="bi bi-plus-lg"></i> æ–°å»ºæ¨¡æ¿
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ç‰©å“æ¨¡æ¿åˆ—è¡¨ -->
    <div class="row" id="templateList">
      <!-- åŠ¨æ€ç”Ÿæˆ -->
    </div>
  </div>

  <!-- æ¨¡æ¿è¡¨å•æ¨¡æ€æ¡† -->
  <div class="modal fade" id="templateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="templateModalTitle"><i class="bi bi-plus-circle"></i> æ–°å»ºç‰©å“æ¨¡æ¿</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="templateForm">
            <input type="hidden" id="templateId">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">æ¨¡æ¿åç§° <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="templateName" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">æ¨¡æ¿ç¼–ç  <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="templateCode" required placeholder="å”¯ä¸€æ ‡è¯†">
              </div>
              <div class="col-md-4">
                <label class="form-label">ç‰©å“ç±»å‹</label>
                <select class="form-select" id="templateType">
                  <option value="voucher">ä¼˜æƒ åˆ¸</option>
                  <option value="coupon">ä»£é‡‘åˆ¸</option>
                  <option value="points">ç§¯åˆ†</option>
                  <option value="gift">ç¤¼å“</option>
                  <option value="virtual">è™šæ‹Ÿç‰©å“</option>
                  <option value="material">ææ–™</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">ç¨€æœ‰åº¦</label>
                <select class="form-select" id="templateRarity">
                  <option value="common">æ™®é€š</option>
                  <option value="uncommon">ä¼˜è‰¯</option>
                  <option value="rare">ç¨€æœ‰</option>
                  <option value="epic">å²è¯—</option>
                  <option value="legendary">ä¼ è¯´</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">çŠ¶æ€</label>
                <select class="form-select" id="templateStatus">
                  <option value="active">å¯ç”¨</option>
                  <option value="inactive">ç¦ç”¨</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">å›¾æ ‡URL</label>
                <input type="text" class="form-control" id="templateIcon" placeholder="https://...">
              </div>
              <div class="col-md-6">
                <label class="form-label">åŸºç¡€ä»·å€¼</label>
                <input type="number" class="form-control" id="templateValue" min="0" step="0.01">
              </div>
              <div class="col-12">
                <label class="form-label">æ¨¡æ¿æè¿°</label>
                <textarea class="form-control" id="templateDescription" rows="2"></textarea>
              </div>
              <div class="col-12">
                <label class="form-label">æ‰©å±•å±æ€§ (JSONæ ¼å¼)</label>
                <textarea class="form-control font-monospace" id="templateAttributes" rows="3" placeholder='{"key": "value"}'></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="submitTemplate()">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">åŠ è½½ä¸­...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script src="/admin/js/api-config.js"></script>
  <script>
    let templates = [];

    document.addEventListener('DOMContentLoaded', function() {
      const userInfo = getCurrentUser();
      if (userInfo && userInfo.nickname) {
        document.getElementById('welcomeText').textContent = `æ¬¢è¿ï¼Œ${userInfo.nickname}`;
      }
      document.getElementById('logoutBtn').addEventListener('click', logout);
      
      loadTemplates();
    });

    async function loadTemplates() {
      showLoading();
      try {
        const type = document.getElementById('typeFilter').value;
        const rarity = document.getElementById('rarityFilter').value;
        const status = document.getElementById('statusFilter').value;
        const search = document.getElementById('searchInput').value;

        // æ„å»ºæŸ¥è¯¢å‚æ•°ï¼ˆä½¿ç”¨åç«¯å­—æ®µåï¼‰
        const params = new URLSearchParams();
        if (type) params.append('item_type', type);  // åç«¯ä½¿ç”¨ item_type
        if (rarity) params.append('rarity_code', rarity);  // åç«¯ä½¿ç”¨ rarity_code
        if (status) params.append('is_enabled', status === 'active' ? 'true' : 'false');  // åç«¯ä½¿ç”¨ is_enabled
        if (search) params.append('keyword', search);  // åç«¯ä½¿ç”¨ keyword

        const url = API_ENDPOINTS.ITEM_TEMPLATE.LIST + (params.toString() ? `?${params.toString()}` : '');
        const response = await apiRequest(url);

        if (response && response.success) {
          // åç«¯è¿”å›æ ¼å¼: { list: [...], pagination: {...} }
          templates = response.data.list || [];
          renderTemplates(templates);
          updateStats(response.data.pagination || {});
        } else {
          showError('åŠ è½½å¤±è´¥', response?.message || 'è·å–ç‰©å“æ¨¡æ¿å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½ç‰©å“æ¨¡æ¿å¤±è´¥:', error);
        showError('åŠ è½½å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }

    function renderTemplates(templates) {
      const container = document.getElementById('templateList');

      if (!templates || templates.length === 0) {
        container.innerHTML = `
          <div class="col-12">
            <div class="card">
              <div class="card-body text-center py-5 text-muted">
                <i class="bi bi-box" style="font-size: 3rem;"></i>
                <p class="mt-2">æš‚æ— ç‰©å“æ¨¡æ¿</p>
              </div>
            </div>
          </div>
        `;
        return;
      }

      // ä½¿ç”¨åç«¯å­—æ®µåï¼šitem_template_id, display_name, template_code, item_type, rarity_code, is_enabled
      container.innerHTML = templates.map(t => `
        <div class="col-md-4 col-lg-3 mb-4">
          <div class="card template-card h-100">
            <div class="card-body text-center">
              <div class="template-icon">${getTypeIcon(t.item_type)}</div>
              <h6 class="card-title">${escapeHtml(t.display_name)}</h6>
              <p class="text-muted small mb-2">${escapeHtml(t.template_code)}</p>
              <span class="badge text-white rarity-${t.rarity_code || 'common'} rarity-badge mb-2">
                ${getRarityLabel(t.rarity_code, t.rarity)}
              </span>
              <p class="small text-muted mb-0">${escapeHtml(truncateText(t.description, 50))}</p>
            </div>
            <div class="card-footer bg-white d-flex justify-content-between align-items-center">
              <span class="badge ${t.is_enabled ? 'bg-success' : 'bg-secondary'}">
                ${t.is_enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
              </span>
              <div>
                <button class="btn btn-sm btn-outline-primary me-1" onclick="editTemplate(${t.item_template_id})">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteTemplate(${t.item_template_id})">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function updateStats(pagination) {
      // ä½¿ç”¨åç«¯åˆ†é¡µæ•°æ®å’Œå‰ç«¯å·²åŠ è½½çš„templatesæ•°ç»„è®¡ç®—ç»Ÿè®¡
      document.getElementById('totalTemplates').textContent = pagination.total_count || templates.length;
      document.getElementById('totalTypes').textContent = new Set(templates.map(t => t.item_type)).size;
      document.getElementById('activeTemplates').textContent = templates.filter(t => t.is_enabled).length;
      
      // ç¨€æœ‰åº¦åˆ†å¸ƒç»Ÿè®¡
      const raritySet = new Set(templates.map(t => t.rarity_code).filter(Boolean));
      document.getElementById('rarityCount').textContent = raritySet.size || '-';
    }

    function getTypeIcon(itemType) {
      // ä½¿ç”¨åç«¯ item_type å­—æ®µ
      const icons = {
        voucher: 'ğŸ«',
        coupon: 'ğŸ«',
        points: 'ğŸ’°',
        gift: 'ğŸ',
        virtual: 'âœ¨',
        material: 'ğŸ“¦'
      };
      return icons[itemType] || 'ğŸ“¦';
    }

    function getRarityLabel(rarityCode, rarityObj) {
      // ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„ rarity å¯¹è±¡ä¸­çš„ display_name
      if (rarityObj && rarityObj.display_name) {
        return rarityObj.display_name;
      }
      // å›é€€åˆ° rarity_code æ˜ å°„
      const labels = {
        common: 'æ™®é€š',
        uncommon: 'ä¼˜è‰¯',
        rare: 'ç¨€æœ‰',
        epic: 'å²è¯—',
        legendary: 'ä¼ è¯´'
      };
      return labels[rarityCode] || 'æ™®é€š';
    }

    function truncateText(text, maxLength) {
      if (!text) return '';
      return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    function openCreateModal() {
      document.getElementById('templateModalTitle').innerHTML = '<i class="bi bi-plus-circle"></i> æ–°å»ºç‰©å“æ¨¡æ¿';
      document.getElementById('templateForm').reset();
      document.getElementById('templateId').value = '';
      new bootstrap.Modal(document.getElementById('templateModal')).show();
    }

    async function editTemplate(templateId) {
      showLoading();
      try {
        // ä½¿ç”¨åç«¯å­—æ®µå id
        const response = await apiRequest(API.buildURL(API_ENDPOINTS.ITEM_TEMPLATE.DETAIL, { id: templateId }));
        if (response && response.success) {
          const t = response.data;
          document.getElementById('templateModalTitle').innerHTML = '<i class="bi bi-pencil"></i> ç¼–è¾‘ç‰©å“æ¨¡æ¿';
          // ä½¿ç”¨åç«¯å­—æ®µå
          document.getElementById('templateId').value = t.item_template_id;
          document.getElementById('templateName').value = t.display_name || '';
          document.getElementById('templateCode').value = t.template_code || '';
          document.getElementById('templateType').value = t.item_type || 'voucher';
          document.getElementById('templateRarity').value = t.rarity_code || 'common';
          document.getElementById('templateStatus').value = t.is_enabled ? 'active' : 'inactive';
          document.getElementById('templateIcon').value = t.image_url || '';
          document.getElementById('templateValue').value = t.reference_price_points || '';
          document.getElementById('templateDescription').value = t.description || '';
          document.getElementById('templateAttributes').value = t.meta ? JSON.stringify(t.meta, null, 2) : '';
          
          new bootstrap.Modal(document.getElementById('templateModal')).show();
        } else {
          showError('åŠ è½½å¤±è´¥', response?.message || 'è·å–æ¨¡æ¿è¯¦æƒ…å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½æ¨¡æ¿è¯¦æƒ…å¤±è´¥:', error);
        showError('åŠ è½½å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }

    async function submitTemplate() {
      const templateId = document.getElementById('templateId').value;
      
      let meta = null;
      try {
        const attrStr = document.getElementById('templateAttributes').value;
        if (attrStr.trim()) {
          meta = JSON.parse(attrStr);
        }
      } catch (e) {
        alert('æ‰©å±•å±æ€§JSONæ ¼å¼é”™è¯¯');
        return;
      }

      // ä½¿ç”¨åç«¯å­—æ®µå
      const statusValue = document.getElementById('templateStatus').value;
      const data = {
        display_name: document.getElementById('templateName').value,
        template_code: document.getElementById('templateCode').value,
        item_type: document.getElementById('templateType').value,
        rarity_code: document.getElementById('templateRarity').value,
        is_enabled: statusValue === 'active',
        image_url: document.getElementById('templateIcon').value || null,
        reference_price_points: parseFloat(document.getElementById('templateValue').value) || 0,
        description: document.getElementById('templateDescription').value || null,
        meta: meta
      };

      if (!data.display_name || !data.template_code) {
        alert('è¯·å¡«å†™æ¨¡æ¿åç§°å’Œç¼–ç ');
        return;
      }

      showLoading();
      try {
        const url = templateId
          ? API.buildURL(API_ENDPOINTS.ITEM_TEMPLATE.UPDATE, { id: templateId })
          : API_ENDPOINTS.ITEM_TEMPLATE.CREATE;
        const method = templateId ? 'PUT' : 'POST';

        const response = await apiRequest(url, {
          method: method,
          body: JSON.stringify(data)
        });

        if (response && response.success) {
          bootstrap.Modal.getInstance(document.getElementById('templateModal')).hide();
          alert(`âœ… ${templateId ? 'æ›´æ–°' : 'åˆ›å»º'}æˆåŠŸ`);
          loadTemplates();
        } else {
          showError('ä¿å­˜å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        console.error('ä¿å­˜æ¨¡æ¿å¤±è´¥:', error);
        showError('ä¿å­˜å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }

    async function deleteTemplate(templateId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ç‰©å“æ¨¡æ¿å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

      showLoading();
      try {
        // ä½¿ç”¨åç«¯å­—æ®µå id
        const response = await apiRequest(API.buildURL(API_ENDPOINTS.ITEM_TEMPLATE.DELETE, { id: templateId }), {
          method: 'DELETE'
        });

        if (response && response.success) {
          alert('âœ… åˆ é™¤æˆåŠŸ');
          loadTemplates();
        } else {
          showError('åˆ é™¤å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        console.error('åˆ é™¤æ¨¡æ¿å¤±è´¥:', error);
        showError('åˆ é™¤å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('show');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('show');
    }

    function showError(title, message) {
      alert(`âŒ ${title}\n${message}`);
    }
  </script>
</body>
</html>

