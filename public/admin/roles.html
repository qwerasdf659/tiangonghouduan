<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è§’è‰²ç®¡ç† - ç®¡ç†åå°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">
  <style>
    .role-card {
      border-left: 4px solid #0d6efd;
      transition: all 0.3s ease;
    }
    .role-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .permission-tag {
      display: inline-block;
      padding: 2px 8px;
      margin: 2px;
      font-size: 0.75rem;
      border-radius: 4px;
      background: #e9ecef;
    }
    .permission-tag.active {
      background: #d1e7dd;
      color: #0f5132;
    }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ›¡ï¸ ç®¡ç†åå° - è§’è‰²ç®¡ç†
      </a>
      <div>
        <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-shield-check text-primary" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">è§’è‰²æ€»æ•°</h6>
            <h2 id="totalRoles" class="text-primary mb-0">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-key text-success" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">æƒé™æ•°é‡</h6>
            <h2 id="totalPermissions" class="text-success mb-0">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-people text-warning" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">ç”¨æˆ·åˆ†é…</h6>
            <h2 id="totalAssigned" class="text-warning mb-0">-</h2>
          </div>
        </div>
      </div>
    </div>

    <!-- æ“ä½œæ  -->
    <div class="card mb-4">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <input type="text" class="form-control" id="searchInput" placeholder="æœç´¢è§’è‰²åç§°..." style="width: 300px;">
        </div>
        <button class="btn btn-success" onclick="openCreateModal()">
          <i class="bi bi-plus-lg"></i> æ–°å¢è§’è‰²
        </button>
      </div>
    </div>

    <!-- è§’è‰²åˆ—è¡¨ -->
    <div class="row" id="roleList">
      <!-- åŠ¨æ€ç”Ÿæˆ -->
    </div>
  </div>

  <!-- è§’è‰²è¡¨å•æ¨¡æ€æ¡† -->
  <div class="modal fade" id="roleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="roleModalTitle"><i class="bi bi-shield-plus"></i> æ–°å¢è§’è‰²</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="roleForm">
            <input type="hidden" id="roleId">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">è§’è‰²åç§° <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="roleName" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">è§’è‰²æ ‡è¯† <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="roleCode" required placeholder="å¦‚ï¼šadminã€manager">
              </div>
              <div class="col-md-6">
                <label class="form-label">è§’è‰²çº§åˆ«</label>
                <input type="number" class="form-control" id="roleLevel" value="0" min="0" max="999">
                <small class="text-muted">æ•°å­—è¶Šå¤§æƒé™è¶Šé«˜</small>
              </div>
              <div class="col-md-6">
                <label class="form-label">çŠ¶æ€</label>
                <select class="form-select" id="roleStatus">
                  <option value="active">å¯ç”¨</option>
                  <option value="inactive">ç¦ç”¨</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">è§’è‰²æè¿°</label>
                <textarea class="form-control" id="roleDescription" rows="2"></textarea>
              </div>
              <div class="col-12">
                <label class="form-label">æƒé™é…ç½®</label>
                <div class="border rounded p-3" id="permissionCheckboxes">
                  <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="submitRole()">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- åˆ†é…ç”¨æˆ·æ¨¡æ€æ¡† -->
  <div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-person-plus"></i> åˆ†é…ç”¨æˆ·</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="assignForm">
            <input type="hidden" id="assignRoleId">
            <div class="mb-3">
              <label class="form-label">è§’è‰²åç§°</label>
              <input type="text" class="form-control" id="assignRoleName" readonly>
            </div>
            <div class="mb-3">
              <label class="form-label">ç”¨æˆ·ID <span class="text-danger">*</span></label>
              <input type="number" class="form-control" id="assignUserId" required placeholder="è¯·è¾“å…¥ç”¨æˆ·ID">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="submitAssign()">ç¡®è®¤åˆ†é…</button>
        </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">åŠ è½½ä¸­...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script src="/admin/js/api-config.js"></script>
  <script>
    let roles = [];
    let permissions = [];

    document.addEventListener('DOMContentLoaded', function() {
      const userInfo = getCurrentUser();
      if (userInfo && userInfo.nickname) {
        document.getElementById('welcomeText').textContent = `æ¬¢è¿ï¼Œ${userInfo.nickname}`;
      }
      document.getElementById('logoutBtn').addEventListener('click', logout);
      document.getElementById('searchInput').addEventListener('input', filterRoles);
      
      loadRoles();
      loadPermissions();
    });

    async function loadRoles() {
      showLoading();
      try {
        const response = await apiRequest(API_ENDPOINTS.ROLE.LIST);
        if (response && response.success) {
          roles = response.data.roles || response.data || [];
          renderRoles(roles);
          updateStats(response.data.stats || {});
        } else {
          showError('åŠ è½½å¤±è´¥', response?.message || 'è·å–è§’è‰²åˆ—è¡¨å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½è§’è‰²å¤±è´¥:', error);
        showError('åŠ è½½å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }

    async function loadPermissions() {
      try {
        const response = await apiRequest(API_ENDPOINTS.ROLE.PERMISSIONS);
        if (response && response.success) {
          permissions = response.data.permissions || response.data || [];
          renderPermissionCheckboxes();
        }
      } catch (error) {
        console.error('åŠ è½½æƒé™å¤±è´¥:', error);
        // ä½¿ç”¨é»˜è®¤æƒé™åˆ—è¡¨
        permissions = [
          { code: 'user:read', name: 'æŸ¥çœ‹ç”¨æˆ·', group: 'ç”¨æˆ·ç®¡ç†' },
          { code: 'user:write', name: 'ç¼–è¾‘ç”¨æˆ·', group: 'ç”¨æˆ·ç®¡ç†' },
          { code: 'role:read', name: 'æŸ¥çœ‹è§’è‰²', group: 'è§’è‰²ç®¡ç†' },
          { code: 'role:write', name: 'ç¼–è¾‘è§’è‰²', group: 'è§’è‰²ç®¡ç†' },
          { code: 'campaign:read', name: 'æŸ¥çœ‹æ´»åŠ¨', group: 'æ´»åŠ¨ç®¡ç†' },
          { code: 'campaign:write', name: 'ç¼–è¾‘æ´»åŠ¨', group: 'æ´»åŠ¨ç®¡ç†' },
          { code: 'prize:read', name: 'æŸ¥çœ‹å¥–å“', group: 'å¥–å“ç®¡ç†' },
          { code: 'prize:write', name: 'ç¼–è¾‘å¥–å“', group: 'å¥–å“ç®¡ç†' },
          { code: 'store:read', name: 'æŸ¥çœ‹é—¨åº—', group: 'é—¨åº—ç®¡ç†' },
          { code: 'store:write', name: 'ç¼–è¾‘é—¨åº—', group: 'é—¨åº—ç®¡ç†' },
          { code: 'report:read', name: 'æŸ¥çœ‹æŠ¥è¡¨', group: 'æ•°æ®æŠ¥è¡¨' },
          { code: 'system:admin', name: 'ç³»ç»Ÿç®¡ç†', group: 'ç³»ç»Ÿè®¾ç½®' }
        ];
        renderPermissionCheckboxes();
      }
    }

    function renderRoles(roles) {
      const container = document.getElementById('roleList');

      if (!roles || roles.length === 0) {
        container.innerHTML = `
          <div class="col-12">
            <div class="card">
              <div class="card-body text-center py-5 text-muted">
                <i class="bi bi-shield" style="font-size: 3rem;"></i>
                <p class="mt-2">æš‚æ— è§’è‰²æ•°æ®</p>
              </div>
            </div>
          </div>
        `;
        return;
      }

      container.innerHTML = roles.map(role => `
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card role-card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h6 class="mb-0">
                <i class="bi bi-shield-check text-primary"></i>
                ${escapeHtml(role.role_name || role.name)}
              </h6>
              <span class="badge ${role.status === 'active' ? 'bg-success' : 'bg-secondary'}">
                ${role.status === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨'}
              </span>
            </div>
            <div class="card-body">
              <p class="text-muted small mb-2">
                <i class="bi bi-tag"></i> æ ‡è¯†ï¼š${escapeHtml(role.role_code || role.code || '-')}
              </p>
              <p class="text-muted small mb-2">
                <i class="bi bi-bar-chart"></i> çº§åˆ«ï¼š${role.role_level || role.level || 0}
              </p>
              <p class="text-muted small mb-3">${escapeHtml(role.description || 'æš‚æ— æè¿°')}</p>
              <div class="permissions-preview">
                ${renderPermissionTags(role.permissions || [])}
              </div>
            </div>
            <div class="card-footer bg-white">
              <button class="btn btn-sm btn-outline-primary me-1" onclick="editRole(${role.role_id || role.id})">
                <i class="bi bi-pencil"></i> ç¼–è¾‘
              </button>
              <button class="btn btn-sm btn-outline-success me-1" onclick="openAssignModal(${role.role_id || role.id}, '${escapeHtml(role.role_name || role.name)}')">
                <i class="bi bi-person-plus"></i> åˆ†é…
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteRole(${role.role_id || role.id})">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderPermissionTags(perms) {
      if (!perms || perms.length === 0) {
        return '<span class="text-muted small">æš‚æ— æƒé™é…ç½®</span>';
      }
      return perms.slice(0, 5).map(p => `
        <span class="permission-tag active">${escapeHtml(typeof p === 'string' ? p : p.name || p.code)}</span>
      `).join('') + (perms.length > 5 ? `<span class="permission-tag">+${perms.length - 5}</span>` : '');
    }

    function renderPermissionCheckboxes() {
      const container = document.getElementById('permissionCheckboxes');
      const groups = {};
      
      permissions.forEach(p => {
        const group = p.group || 'å…¶ä»–';
        if (!groups[group]) groups[group] = [];
        groups[group].push(p);
      });

      container.innerHTML = Object.entries(groups).map(([group, perms]) => `
        <div class="mb-3">
          <h6 class="text-muted">${escapeHtml(group)}</h6>
          <div class="row">
            ${perms.map(p => `
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input permission-checkbox" type="checkbox" value="${p.code}" id="perm_${p.code}">
                  <label class="form-check-label" for="perm_${p.code}">${escapeHtml(p.name)}</label>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    function updateStats(stats) {
      document.getElementById('totalRoles').textContent = stats.total || roles.length;
      document.getElementById('totalPermissions').textContent = stats.permissions || permissions.length;
      document.getElementById('totalAssigned').textContent = stats.assigned || '-';
    }

    function filterRoles() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const filtered = roles.filter(r => 
        (r.role_name || r.name || '').toLowerCase().includes(search) ||
        (r.role_code || r.code || '').toLowerCase().includes(search)
      );
      renderRoles(filtered);
    }

    function openCreateModal() {
      document.getElementById('roleModalTitle').innerHTML = '<i class="bi bi-shield-plus"></i> æ–°å¢è§’è‰²';
      document.getElementById('roleForm').reset();
      document.getElementById('roleId').value = '';
      document.querySelectorAll('.permission-checkbox').forEach(cb => cb.checked = false);
      new bootstrap.Modal(document.getElementById('roleModal')).show();
    }

    async function editRole(roleId) {
      showLoading();
      try {
        const response = await apiRequest(API.buildURL(API_ENDPOINTS.ROLE.DETAIL, { role_id: roleId }));
        if (response && response.success) {
          const role = response.data;
          document.getElementById('roleModalTitle').innerHTML = '<i class="bi bi-pencil"></i> ç¼–è¾‘è§’è‰²';
          document.getElementById('roleId').value = role.role_id || role.id;
          document.getElementById('roleName').value = role.role_name || role.name || '';
          document.getElementById('roleCode').value = role.role_code || role.code || '';
          document.getElementById('roleLevel').value = role.role_level || role.level || 0;
          document.getElementById('roleStatus').value = role.status || 'active';
          document.getElementById('roleDescription').value = role.description || '';
          
          // è®¾ç½®æƒé™å¤é€‰æ¡†
          document.querySelectorAll('.permission-checkbox').forEach(cb => cb.checked = false);
          const rolePerms = role.permissions || [];
          rolePerms.forEach(p => {
            const code = typeof p === 'string' ? p : p.code;
            const cb = document.getElementById(`perm_${code}`);
            if (cb) cb.checked = true;
          });
          
          new bootstrap.Modal(document.getElementById('roleModal')).show();
        } else {
          showError('åŠ è½½å¤±è´¥', response?.message || 'è·å–è§’è‰²è¯¦æƒ…å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½è§’è‰²è¯¦æƒ…å¤±è´¥:', error);
        showError('åŠ è½½å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }

    async function submitRole() {
      const roleId = document.getElementById('roleId').value;
      const selectedPermissions = Array.from(document.querySelectorAll('.permission-checkbox:checked')).map(cb => cb.value);
      
      const data = {
        role_name: document.getElementById('roleName').value,
        role_code: document.getElementById('roleCode').value,
        role_level: parseInt(document.getElementById('roleLevel').value) || 0,
        status: document.getElementById('roleStatus').value,
        description: document.getElementById('roleDescription').value,
        permissions: selectedPermissions
      };

      if (!data.role_name || !data.role_code) {
        alert('è¯·å¡«å†™è§’è‰²åç§°å’Œæ ‡è¯†');
        return;
      }

      showLoading();
      try {
        const url = roleId ? API.buildURL(API_ENDPOINTS.ROLE.UPDATE, { role_id: roleId }) : API_ENDPOINTS.ROLE.CREATE;
        const method = roleId ? 'PUT' : 'POST';

        const response = await apiRequest(url, {
          method: method,
          body: JSON.stringify(data)
        });

        if (response && response.success) {
          bootstrap.Modal.getInstance(document.getElementById('roleModal')).hide();
          alert(`âœ… ${roleId ? 'æ›´æ–°' : 'åˆ›å»º'}æˆåŠŸ`);
          loadRoles();
        } else {
          showError('ä¿å­˜å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        console.error('ä¿å­˜è§’è‰²å¤±è´¥:', error);
        showError('ä¿å­˜å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }

    async function deleteRole(roleId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤è§’è‰²å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

      showLoading();
      try {
        const response = await apiRequest(API.buildURL(API_ENDPOINTS.ROLE.DELETE, { role_id: roleId }), {
          method: 'DELETE'
        });

        if (response && response.success) {
          alert('âœ… åˆ é™¤æˆåŠŸ');
          loadRoles();
        } else {
          showError('åˆ é™¤å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        console.error('åˆ é™¤è§’è‰²å¤±è´¥:', error);
        showError('åˆ é™¤å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }

    function openAssignModal(roleId, roleName) {
      document.getElementById('assignRoleId').value = roleId;
      document.getElementById('assignRoleName').value = roleName;
      document.getElementById('assignUserId').value = '';
      new bootstrap.Modal(document.getElementById('assignModal')).show();
    }

    async function submitAssign() {
      const roleId = document.getElementById('assignRoleId').value;
      const userId = document.getElementById('assignUserId').value;

      if (!userId) {
        alert('è¯·è¾“å…¥ç”¨æˆ·ID');
        return;
      }

      showLoading();
      try {
        const response = await apiRequest(API.buildURL(API_ENDPOINTS.ROLE.ASSIGN, { role_id: roleId }), {
          method: 'POST',
          body: JSON.stringify({ user_id: parseInt(userId) })
        });

        if (response && response.success) {
          bootstrap.Modal.getInstance(document.getElementById('assignModal')).hide();
          alert('âœ… åˆ†é…æˆåŠŸ');
        } else {
          showError('åˆ†é…å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        console.error('åˆ†é…è§’è‰²å¤±è´¥:', error);
        showError('åˆ†é…å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('show');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('show');
    }

    function showError(title, message) {
      alert(`âŒ ${title}\n${message}`);
    }
  </script>
</body>
</html>

