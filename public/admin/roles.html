<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è§’è‰²ç®¡ç† - ç®¡ç†åå°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">
  <style>
    .role-card {
      border-left: 4px solid #0d6efd;
      transition: all 0.3s ease;
    }
    .role-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .role-level-badge {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 10px;
    }
    .role-level-high { background: #d4edda; color: #155724; }
    .role-level-medium { background: #fff3cd; color: #856404; }
    .role-level-low { background: #f8d7da; color: #721c24; }
    .info-alert {
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
      border: 1px solid #90caf9;
      border-radius: 8px;
    }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ›¡ï¸ ç®¡ç†åå° - è§’è‰²ç®¡ç†
      </a>
      <div>
        <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- ç³»ç»Ÿè¯´æ˜ -->
    <div class="alert info-alert mb-4">
      <div class="d-flex align-items-center">
        <i class="bi bi-info-circle text-primary me-2" style="font-size: 1.5rem;"></i>
        <div>
          <strong>è§’è‰²ç®¡ç†è¯´æ˜</strong>
          <p class="mb-0 small text-muted">
            ç³»ç»Ÿè§’è‰²ç”±æ•°æ®åº“é¢„è®¾ï¼Œæ­¤é¡µé¢ä»…å±•ç¤ºè§’è‰²åˆ—è¡¨ã€‚å¦‚éœ€ä¿®æ”¹ç”¨æˆ·è§’è‰²ï¼Œè¯·å‰å¾€ 
            <a href="/admin/user-management.html" class="text-decoration-none">ç”¨æˆ·ç®¡ç†</a> é¡µé¢æ“ä½œã€‚
          </p>
        </div>
      </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-shield-check text-primary" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">è§’è‰²æ€»æ•°</h6>
            <h2 id="totalRoles" class="text-primary mb-0">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-award text-success" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">æœ€é«˜æƒé™çº§åˆ«</h6>
            <h2 id="maxRoleLevel" class="text-success mb-0">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-people text-warning" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">è§’è‰²ç±»å‹</h6>
            <h2 id="roleTypes" class="text-warning mb-0">-</h2>
          </div>
        </div>
      </div>
    </div>

    <!-- æœç´¢æ  -->
    <div class="card mb-4">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <input type="text" class="form-control" id="searchInput" placeholder="æœç´¢è§’è‰²åç§°..." style="width: 300px;">
        </div>
        <div class="text-muted small">
          <i class="bi bi-clock-history"></i> æ•°æ®åŠ è½½æ—¶é—´ï¼š<span id="loadTime">-</span>
        </div>
      </div>
    </div>

    <!-- è§’è‰²åˆ—è¡¨ -->
    <div class="row" id="roleList">
      <!-- åŠ¨æ€ç”Ÿæˆ -->
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">åŠ è½½ä¸­...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script src="/admin/js/api-config.js"></script>
  <script>
    let roles = [];

    document.addEventListener('DOMContentLoaded', function() {
      const userInfo = getCurrentUser();
      if (userInfo && userInfo.nickname) {
        document.getElementById('welcomeText').textContent = `æ¬¢è¿ï¼Œ${userInfo.nickname}`;
      }
      document.getElementById('logoutBtn').addEventListener('click', logout);
      document.getElementById('searchInput').addEventListener('input', filterRoles);
      
      loadRoles();
    });

    /**
     * åŠ è½½è§’è‰²åˆ—è¡¨
     * API: GET /api/v4/console/user-management/roles
     * åç«¯è¿”å›æ ¼å¼: { roles: [{ id, role_uuid, role_name, role_level, description }] }
     */
    async function loadRoles() {
      showLoading();
      const startTime = Date.now();
      
      try {
        const response = await apiRequest(API_ENDPOINTS.ROLE.LIST);
        
        if (response && response.success) {
          // åç«¯è¿”å›æ ¼å¼: { roles: [...] }
          roles = response.data.roles || response.data || [];
          renderRoles(roles);
          updateStats(roles);
          
          // æ˜¾ç¤ºåŠ è½½æ—¶é—´
          const loadTime = Date.now() - startTime;
          document.getElementById('loadTime').textContent = `${loadTime}ms`;
        } else {
          showError('åŠ è½½å¤±è´¥', response?.message || 'è·å–è§’è‰²åˆ—è¡¨å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½è§’è‰²å¤±è´¥:', error);
        showError('åŠ è½½å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }

    /**
     * æ¸²æŸ“è§’è‰²åˆ—è¡¨
     * ä½¿ç”¨åç«¯è¿”å›çš„å­—æ®µåï¼šrole_name, role_level, description
     */
    function renderRoles(roleList) {
      const container = document.getElementById('roleList');

      if (!roleList || roleList.length === 0) {
        container.innerHTML = `
          <div class="col-12">
            <div class="card">
              <div class="card-body text-center py-5 text-muted">
                <i class="bi bi-shield" style="font-size: 3rem;"></i>
                <p class="mt-2">æš‚æ— è§’è‰²æ•°æ®</p>
              </div>
            </div>
          </div>
        `;
        return;
      }

      container.innerHTML = roleList.map(role => `
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card role-card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h6 class="mb-0">
                <i class="bi bi-shield-check text-primary"></i>
                ${escapeHtml(role.role_name)}
              </h6>
              <span class="role-level-badge ${getRoleLevelClass(role.role_level)}">
                çº§åˆ« ${role.role_level || 0}
              </span>
            </div>
            <div class="card-body">
              <p class="text-muted small mb-2">
                <i class="bi bi-fingerprint"></i> UUIDï¼š<code class="small">${escapeHtml(role.role_uuid || '-')}</code>
              </p>
              <p class="text-muted small mb-2">
                <i class="bi bi-hash"></i> IDï¼š${role.id || '-'}
              </p>
              <p class="text-muted small mb-0">
                <i class="bi bi-card-text"></i> ${escapeHtml(role.description || 'æš‚æ— æè¿°')}
              </p>
            </div>
            <div class="card-footer bg-white text-muted small">
              <i class="bi bi-info-circle"></i> 
              ${getRoleLevelDescription(role.role_level)}
            </div>
          </div>
        </div>
      `).join('');
    }

    /**
     * è·å–è§’è‰²çº§åˆ«çš„CSSç±»
     */
    function getRoleLevelClass(level) {
      if (level >= 80) return 'role-level-high';
      if (level >= 40) return 'role-level-medium';
      return 'role-level-low';
    }

    /**
     * è·å–è§’è‰²çº§åˆ«æè¿°
     */
    function getRoleLevelDescription(level) {
      if (level >= 100) return 'è¶…çº§ç®¡ç†å‘˜æƒé™';
      if (level >= 80) return 'é«˜çº§ç®¡ç†æƒé™';
      if (level >= 60) return 'ä¸šåŠ¡ç®¡ç†æƒé™';
      if (level >= 40) return 'è¿è¥æ“ä½œæƒé™';
      if (level >= 20) return 'åŸºç¡€æ“ä½œæƒé™';
      return 'æ™®é€šç”¨æˆ·æƒé™';
    }

    /**
     * æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
     */
    function updateStats(roleList) {
      // è§’è‰²æ€»æ•°
      document.getElementById('totalRoles').textContent = roleList.length;
      
      // æœ€é«˜æƒé™çº§åˆ«
      const maxLevel = roleList.length > 0 
        ? Math.max(...roleList.map(r => r.role_level || 0))
        : 0;
      document.getElementById('maxRoleLevel').textContent = maxLevel;
      
      // è§’è‰²ç±»å‹ç»Ÿè®¡ï¼ˆæŒ‰çº§åˆ«åˆ†ç±»ï¼‰
      const highLevel = roleList.filter(r => (r.role_level || 0) >= 80).length;
      const midLevel = roleList.filter(r => (r.role_level || 0) >= 40 && (r.role_level || 0) < 80).length;
      const lowLevel = roleList.filter(r => (r.role_level || 0) < 40).length;
      document.getElementById('roleTypes').textContent = `${highLevel}é«˜/${midLevel}ä¸­/${lowLevel}ä½`;
    }

    /**
     * æœç´¢è¿‡æ»¤è§’è‰²
     */
    function filterRoles() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const filtered = roles.filter(r => 
        (r.role_name || '').toLowerCase().includes(search) ||
        (r.description || '').toLowerCase().includes(search)
      );
      renderRoles(filtered);
    }

    /**
     * HTMLè½¬ä¹‰
     */
    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('show');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('show');
    }

    function showError(title, message) {
      alert(`âŒ ${title}\n${message}`);
    }
  </script>
</body>
</html>
