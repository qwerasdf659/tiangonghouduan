<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æŠ½å¥–ç›‘æ§ - ç®¡ç†åå°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">
  <style>
    .metric-card {
      border-radius: 12px;
      transition: all 0.3s ease;
    }
    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .metric-value {
      font-size: 2rem;
      font-weight: bold;
    }
    .metric-trend {
      font-size: 0.85rem;
    }
    .trend-up { color: #198754; }
    .trend-down { color: #dc3545; }
    .chart-container {
      height: 350px;
    }
    .live-indicator {
      width: 8px;
      height: 8px;
      background: #198754;
      border-radius: 50%;
      display: inline-block;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ“Š ç®¡ç†åå° - æŠ½å¥–ç›‘æ§
      </a>
      <div class="d-flex align-items-center">
        <span class="live-indicator me-2"></span>
        <span class="text-light me-3" id="lastUpdate">å®æ—¶æ›´æ–°</span>
        <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- æ—¶é—´ç­›é€‰ -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-md-3">
            <label class="form-label">é€‰æ‹©æ´»åŠ¨</label>
            <select class="form-select" id="campaignFilter">
              <option value="">å…¨éƒ¨æ´»åŠ¨</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">æ—¶é—´èŒƒå›´</label>
            <select class="form-select" id="timeRange">
              <option value="today">ä»Šæ—¥</option>
              <option value="yesterday">æ˜¨æ—¥</option>
              <option value="week">æœ¬å‘¨</option>
              <option value="month">æœ¬æœˆ</option>
              <option value="custom">è‡ªå®šä¹‰</option>
            </select>
          </div>
          <div class="col-md-4" id="customDateRange" style="display: none;">
            <label class="form-label">è‡ªå®šä¹‰æ—¶é—´</label>
            <div class="input-group">
              <input type="date" class="form-control" id="startDate">
              <span class="input-group-text">è‡³</span>
              <input type="date" class="form-control" id="endDate">
            </div>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-primary" onclick="loadMetrics()">
              <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°æ•°æ®
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡ -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card metric-card border-primary">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="text-muted">æŠ½å¥–æ¬¡æ•°</h6>
                <div class="metric-value text-primary" id="totalDraws">-</div>
                <div class="metric-trend" id="drawsTrend">-</div>
              </div>
              <i class="bi bi-dice-5 text-primary" style="font-size: 2.5rem;"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card metric-card border-success">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="text-muted">ä¸­å¥–æ¬¡æ•°</h6>
                <div class="metric-value text-success" id="totalWins">-</div>
                <div class="metric-trend" id="winsTrend">-</div>
              </div>
              <i class="bi bi-trophy text-success" style="font-size: 2.5rem;"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card metric-card border-warning">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="text-muted">ä¸­å¥–ç‡</h6>
                <div class="metric-value text-warning" id="winRate">-</div>
                <div class="metric-trend" id="rateTrend">-</div>
              </div>
              <i class="bi bi-percent text-warning" style="font-size: 2.5rem;"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card metric-card border-info">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="text-muted">å¥–å“ä»·å€¼</h6>
                <div class="metric-value text-info" id="totalValue">-</div>
                <div class="metric-trend" id="valueTrend">-</div>
              </div>
              <i class="bi bi-currency-yen text-info" style="font-size: 2.5rem;"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <div class="row g-3 mb-4">
      <div class="col-md-8">
        <div class="card">
          <div class="card-header bg-white">
            <h6 class="mb-0"><i class="bi bi-graph-up"></i> æŠ½å¥–è¶‹åŠ¿</h6>
          </div>
          <div class="card-body">
            <div class="chart-container" id="trendChart"></div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-header bg-white">
            <h6 class="mb-0"><i class="bi bi-pie-chart"></i> å¥–å“åˆ†å¸ƒ</h6>
          </div>
          <div class="card-body">
            <div class="chart-container" id="prizeDistChart"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3">
      <!-- å®æ—¶æŠ½å¥–è®°å½• -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="bi bi-lightning"></i> å®æ—¶æŠ½å¥–è®°å½•</h6>
            <span class="badge bg-success">æœ€æ–°20æ¡</span>
          </div>
          <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-sm table-hover mb-0">
              <thead class="sticky-top bg-light">
                <tr>
                  <th>æ—¶é—´</th>
                  <th>ç”¨æˆ·</th>
                  <th>æ´»åŠ¨</th>
                  <th>ç»“æœ</th>
                </tr>
              </thead>
              <tbody id="realtimeList">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- å¥–å“ç»Ÿè®¡ -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-white">
            <h6 class="mb-0"><i class="bi bi-gift"></i> å¥–å“å‘æ”¾ç»Ÿè®¡</h6>
          </div>
          <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-sm table-hover mb-0">
              <thead class="sticky-top bg-light">
                <tr>
                  <th>å¥–å“åç§°</th>
                  <th>å‘æ”¾æ•°é‡</th>
                  <th>å‰©ä½™åº“å­˜</th>
                  <th>æ¶ˆè€—ç‡</th>
                </tr>
              </thead>
              <tbody id="prizeStatsList">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">åŠ è½½ä¸­...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script src="/admin/js/api-config.js"></script>
  <script src="/admin/js/lib/echarts.min.js"></script>
  <script>
    let trendChart = null;
    let prizeDistChart = null;
    let refreshTimer = null;

    document.addEventListener('DOMContentLoaded', function() {
      const userInfo = getCurrentUser();
      if (userInfo && userInfo.nickname) {
        document.getElementById('welcomeText').textContent = `æ¬¢è¿ï¼Œ${userInfo.nickname}`;
      }
      document.getElementById('logoutBtn').addEventListener('click', logout);

      document.getElementById('timeRange').addEventListener('change', function() {
        document.getElementById('customDateRange').style.display = this.value === 'custom' ? 'block' : 'none';
      });

      initCharts();
      loadCampaigns();
      loadMetrics();

      // è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯30ç§’ï¼‰
      refreshTimer = setInterval(() => {
        loadMetrics();
        updateLastTime();
      }, 30000);
    });

    function initCharts() {
      trendChart = echarts.init(document.getElementById('trendChart'));
      prizeDistChart = echarts.init(document.getElementById('prizeDistChart'));

      window.addEventListener('resize', () => {
        trendChart.resize();
        prizeDistChart.resize();
      });
    }

    async function loadCampaigns() {
      try {
        const response = await apiRequest(API_ENDPOINTS.CAMPAIGN.LIST);
        if (response && response.success) {
          const campaigns = response.data.campaigns || response.data || [];
          const select = document.getElementById('campaignFilter');
          select.innerHTML = '<option value="">å…¨éƒ¨æ´»åŠ¨</option>' +
            campaigns.map(c => `<option value="${c.campaign_id}">${escapeHtml(c.name || c.campaign_name)}</option>`).join('');
        }
      } catch (error) {
        console.error('åŠ è½½æ´»åŠ¨å¤±è´¥:', error);
      }
    }

    async function loadMetrics() {
      showLoading();
      try {
        const campaignId = document.getElementById('campaignFilter').value;
        const timeRange = document.getElementById('timeRange').value;

        const params = new URLSearchParams();
        if (campaignId) params.append('campaign_id', campaignId);
        params.append('time_range', timeRange);

        if (timeRange === 'custom') {
          params.append('start_date', document.getElementById('startDate').value);
          params.append('end_date', document.getElementById('endDate').value);
        }

        const url = API_ENDPOINTS.LOTTERY_MONITORING.STATS + '?' + params.toString();
        const response = await apiRequest(url);

        if (response && response.success) {
          const data = response.data;
          updateMetricCards(data.summary || data);
          updateTrendChart(data.trend || []);
          updatePrizeDistChart(data.prize_distribution || []);
          updateRealtimeList(data.recent_draws || []);
          updatePrizeStats(data.prize_stats || []);
        } else {
          // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
          updateWithMockData();
        }
      } catch (error) {
        console.error('åŠ è½½ç›‘æ§æ•°æ®å¤±è´¥:', error);
        updateWithMockData();
      } finally {
        hideLoading();
        updateLastTime();
      }
    }

    function updateWithMockData() {
      updateMetricCards({
        total_draws: 1234,
        total_wins: 456,
        win_rate: 36.9,
        total_value: 12580,
        draws_trend: 12.5,
        wins_trend: 8.2,
        rate_trend: -2.1,
        value_trend: 15.6
      });

      updateTrendChart([
        { time: '00:00', draws: 45, wins: 15 },
        { time: '04:00', draws: 23, wins: 8 },
        { time: '08:00', draws: 89, wins: 32 },
        { time: '12:00', draws: 156, wins: 58 },
        { time: '16:00', draws: 234, wins: 89 },
        { time: '20:00', draws: 312, wins: 118 },
        { time: '24:00', draws: 375, wins: 136 }
      ]);

      updatePrizeDistChart([
        { name: 'ä¸€ç­‰å¥–', value: 5 },
        { name: 'äºŒç­‰å¥–', value: 25 },
        { name: 'ä¸‰ç­‰å¥–', value: 80 },
        { name: 'å‚ä¸å¥–', value: 346 },
        { name: 'è°¢è°¢å‚ä¸', value: 778 }
      ]);

      updateRealtimeList([
        { time: 'åˆšåˆš', user: 'ç”¨æˆ·***1234', campaign: 'æ–°æ˜¥æŠ½å¥–', result: 'äºŒç­‰å¥–', is_win: true },
        { time: '1åˆ†é’Ÿå‰', user: 'ç”¨æˆ·***5678', campaign: 'æ–°æ˜¥æŠ½å¥–', result: 'è°¢è°¢å‚ä¸', is_win: false },
        { time: '2åˆ†é’Ÿå‰', user: 'ç”¨æˆ·***9012', campaign: 'ä¼šå‘˜ç¦åˆ©', result: 'ä¸‰ç­‰å¥–', is_win: true }
      ]);

      updatePrizeStats([
        { name: 'ä¸€ç­‰å¥–-iPhone', issued: 5, stock: 95, rate: 5 },
        { name: 'äºŒç­‰å¥–-è€³æœº', issued: 25, stock: 175, rate: 12.5 },
        { name: 'ä¸‰ç­‰å¥–-ä¼˜æƒ åˆ¸', issued: 80, stock: 420, rate: 16 }
      ]);
    }

    function updateMetricCards(data) {
      document.getElementById('totalDraws').textContent = formatNumber(data.total_draws || 0);
      document.getElementById('totalWins').textContent = formatNumber(data.total_wins || 0);
      document.getElementById('winRate').textContent = (data.win_rate || 0).toFixed(1) + '%';
      document.getElementById('totalValue').textContent = 'Â¥' + formatNumber(data.total_value || 0);

      updateTrend('drawsTrend', data.draws_trend);
      updateTrend('winsTrend', data.wins_trend);
      updateTrend('rateTrend', data.rate_trend);
      updateTrend('valueTrend', data.value_trend);
    }

    function updateTrend(elementId, value) {
      const element = document.getElementById(elementId);
      if (value === undefined || value === null) {
        element.textContent = '-';
        return;
      }
      const isUp = value >= 0;
      element.innerHTML = `
        <span class="${isUp ? 'trend-up' : 'trend-down'}">
          <i class="bi bi-arrow-${isUp ? 'up' : 'down'}"></i>
          ${Math.abs(value).toFixed(1)}%
        </span>
        <span class="text-muted">è¾ƒæ˜¨æ—¥</span>
      `;
    }

    function updateTrendChart(data) {
      const option = {
        tooltip: { trigger: 'axis' },
        legend: { data: ['æŠ½å¥–æ¬¡æ•°', 'ä¸­å¥–æ¬¡æ•°'], bottom: 0 },
        grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true },
        xAxis: {
          type: 'category',
          data: data.map(d => d.time || d.hour || d.date)
        },
        yAxis: { type: 'value' },
        series: [
          {
            name: 'æŠ½å¥–æ¬¡æ•°',
            type: 'line',
            smooth: true,
            data: data.map(d => d.draws || d.draw_count || 0),
            areaStyle: { opacity: 0.3 },
            itemStyle: { color: '#0d6efd' }
          },
          {
            name: 'ä¸­å¥–æ¬¡æ•°',
            type: 'line',
            smooth: true,
            data: data.map(d => d.wins || d.win_count || 0),
            areaStyle: { opacity: 0.3 },
            itemStyle: { color: '#198754' }
          }
        ]
      };
      trendChart.setOption(option);
    }

    function updatePrizeDistChart(data) {
      const option = {
        tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
        legend: { orient: 'vertical', left: 'left', top: 'center' },
        series: [{
          type: 'pie',
          radius: ['40%', '70%'],
          center: ['60%', '50%'],
          avoidLabelOverlap: false,
          itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 2 },
          label: { show: false },
          emphasis: { label: { show: true, fontSize: 14, fontWeight: 'bold' } },
          data: data.map(d => ({
            name: d.name || d.prize_name,
            value: d.value || d.count
          }))
        }]
      };
      prizeDistChart.setOption(option);
    }

    function updateRealtimeList(records) {
      const tbody = document.getElementById('realtimeList');
      
      if (!records || records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>';
        return;
      }

      tbody.innerHTML = records.map(r => `
        <tr>
          <td><small class="text-muted">${r.time || formatTime(r.created_at)}</small></td>
          <td>${escapeHtml(r.user || r.user_name || '-')}</td>
          <td>${escapeHtml(r.campaign || r.campaign_name || '-')}</td>
          <td>
            <span class="badge ${r.is_win ? 'bg-success' : 'bg-secondary'}">
              ${escapeHtml(r.result || r.prize_name || 'è°¢è°¢å‚ä¸')}
            </span>
          </td>
        </tr>
      `).join('');
    }

    function updatePrizeStats(stats) {
      const tbody = document.getElementById('prizeStatsList');
      
      if (!stats || stats.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>';
        return;
      }

      tbody.innerHTML = stats.map(s => `
        <tr>
          <td>${escapeHtml(s.name || s.prize_name)}</td>
          <td><span class="badge bg-success">${s.issued || s.issued_count || 0}</span></td>
          <td><span class="badge bg-info">${s.stock || s.remaining || 0}</span></td>
          <td>
            <div class="progress" style="height: 20px;">
              <div class="progress-bar ${getProgressBarClass(s.rate || 0)}" 
                   style="width: ${s.rate || 0}%">
                ${(s.rate || 0).toFixed(1)}%
              </div>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function getProgressBarClass(rate) {
      if (rate >= 80) return 'bg-danger';
      if (rate >= 50) return 'bg-warning';
      return 'bg-success';
    }

    function updateLastTime() {
      document.getElementById('lastUpdate').textContent = 'æ›´æ–°äº ' + new Date().toLocaleTimeString('zh-CN');
    }

    function formatNumber(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function formatTime(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;
      if (diff < 60000) return 'åˆšåˆš';
      if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
      return date.toLocaleTimeString('zh-CN');
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('show');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('show');
    }
  </script>
</body>
</html>

