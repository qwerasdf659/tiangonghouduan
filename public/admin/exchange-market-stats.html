<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…‘æ¢å¸‚åœºç»Ÿè®¡åˆ†æ - ç®¡ç†åå°</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">

  <style>
    .stat-card {
      border-radius: 10px;
      transition: transform 0.2s;
    }
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }
    .revenue-badge {
      font-size: 1.1rem;
      padding: 0.5rem 1rem;
    }
    .chart-container {
      position: relative;
      height: 300px;
    }
  </style>
</head>
<body class="bg-light">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ“Š å…‘æ¢å¸‚åœº - ç»Ÿè®¡åˆ†æ
      </a>
      <div>
        <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- è®¢å•ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row g-3 mb-4">
      <div class="col-12">
        <h5 class="mb-3"><i class="bi bi-bar-chart-fill"></i> è®¢å•ç»Ÿè®¡</h5>
      </div>
      <div class="col-md-6 col-xl-2">
        <div class="card stat-card border-0 shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="stat-icon bg-primary text-white me-3">
                <i class="bi bi-receipt"></i>
              </div>
              <div>
                <h6 class="text-muted mb-1">è®¢å•æ€»æ•°</h6>
                <h3 class="mb-0" id="totalOrders">-</h3>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-xl-2">
        <div class="card stat-card border-warning shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="stat-icon bg-warning text-white me-3">
                <i class="bi bi-clock-history"></i>
              </div>
              <div>
                <h6 class="text-muted mb-1">å¾…å¤„ç†</h6>
                <h3 class="text-warning mb-0" id="pendingOrders">-</h3>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-xl-2">
        <div class="card stat-card border-info shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="stat-icon bg-info text-white me-3">
                <i class="bi bi-check-circle"></i>
              </div>
              <div>
                <h6 class="text-muted mb-1">å·²å®Œæˆ</h6>
                <h3 class="text-info mb-0" id="completedOrders">-</h3>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-xl-2">
        <div class="card stat-card border-success shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="stat-icon bg-success text-white me-3">
                <i class="bi bi-truck"></i>
              </div>
              <div>
                <h6 class="text-muted mb-1">å·²å‘è´§</h6>
                <h3 class="text-success mb-0" id="shippedOrders">-</h3>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-xl-2">
        <div class="card stat-card border-secondary shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="stat-icon bg-secondary text-white me-3">
                <i class="bi bi-x-circle"></i>
              </div>
              <div>
                <h6 class="text-muted mb-1">å·²å–æ¶ˆ</h6>
                <h3 class="text-secondary mb-0" id="cancelledOrders">-</h3>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-xl-2">
        <div class="card stat-card border-primary shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="stat-icon bg-primary text-white me-3">
                <i class="bi bi-percent"></i>
              </div>
              <div>
                <h6 class="text-muted mb-1">å®Œæˆç‡</h6>
                <h3 class="text-primary mb-0" id="completionRate">-</h3>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ”¶å…¥ç»Ÿè®¡ -->
    <div class="row g-3 mb-4">
      <div class="col-12">
        <h5 class="mb-3"><i class="bi bi-wallet2"></i> æ”¶å…¥ç»Ÿè®¡</h5>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-body text-center">
            <h6 class="text-muted mb-3">æ€»è™šæ‹Ÿä»·å€¼æ”¶å…¥</h6>
            <div class="mb-2">
              <span class="badge revenue-badge bg-info" id="totalVirtualValue">-</span>
            </div>
            <small class="text-muted">ç”¨æˆ·ä½¿ç”¨è™šæ‹Ÿå¥–å“ä»·å€¼å…‘æ¢å•†å“çš„æ€»é¢</small>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-body text-center">
            <h6 class="text-muted mb-3">æ€»ç§¯åˆ†æ”¶å…¥</h6>
            <div class="mb-2">
              <span class="badge revenue-badge bg-primary" id="totalPoints">-</span>
            </div>
            <small class="text-muted">ç”¨æˆ·ä½¿ç”¨ç§¯åˆ†å…‘æ¢å•†å“çš„æ€»é¢</small>
          </div>
        </div>
      </div>
    </div>

    <!-- å•†å“åº“å­˜ç»Ÿè®¡ -->
    <div class="row g-3 mb-4">
      <div class="col-12">
        <h5 class="mb-3"><i class="bi bi-box-seam"></i> å•†å“åº“å­˜ç»Ÿè®¡</h5>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="border-bottom pb-2">ä¸Šæ¶å•†å“</h6>
            <div class="row text-center mt-3">
              <div class="col-6">
                <h3 class="text-success" id="activeItemCount">-</h3>
                <small class="text-muted">å•†å“æ•°é‡</small>
              </div>
              <div class="col-6">
                <h3 class="text-info" id="activeItemStock">-</h3>
                <small class="text-muted">æ€»åº“å­˜</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="border-bottom pb-2">ä¸‹æ¶å•†å“</h6>
            <div class="row text-center mt-3">
              <div class="col-6">
                <h3 class="text-secondary" id="inactiveItemCount">-</h3>
                <small class="text-muted">å•†å“æ•°é‡</small>
              </div>
              <div class="col-6">
                <h3 class="text-muted" id="inactiveItemStock">-</h3>
                <small class="text-muted">æ€»åº“å­˜</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- è®¢å•çŠ¶æ€åˆ†å¸ƒå›¾ -->
    <div class="row g-3 mb-4">
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-pie-chart"></i> è®¢å•çŠ¶æ€åˆ†å¸ƒ</h6>
            <div class="chart-container">
              <canvas id="orderStatusChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-bar-chart"></i> æ”¶å…¥æ¥æºåˆ†å¸ƒ</h6>
            <div class="chart-container">
              <canvas id="revenueChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å¿«æ·æ“ä½œ -->
    <div class="row g-3 mb-4">
      <div class="col-12">
        <h5 class="mb-3"><i class="bi bi-lightning-fill"></i> å¿«æ·æ“ä½œ</h5>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm">
          <div class="card-body text-center">
            <i class="bi bi-box text-primary" style="font-size: 2rem;"></i>
            <h6 class="mt-3">å•†å“ç®¡ç†</h6>
            <a href="/admin/exchange-market-items.html" class="btn btn-sm btn-primary mt-2">
              <i class="bi bi-arrow-right"></i> å‰å¾€ç®¡ç†
            </a>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm">
          <div class="card-body text-center">
            <i class="bi bi-receipt text-success" style="font-size: 2rem;"></i>
            <h6 class="mt-3">è®¢å•ç®¡ç†</h6>
            <a href="/admin/exchange-market-orders.html" class="btn btn-sm btn-success mt-2">
              <i class="bi bi-arrow-right"></i> å‰å¾€ç®¡ç†
            </a>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm">
          <div class="card-body text-center">
            <i class="bi bi-arrow-clockwise text-info" style="font-size: 2rem;"></i>
            <h6 class="mt-3">åˆ·æ–°æ•°æ®</h6>
            <button class="btn btn-sm btn-info mt-2" id="refreshBtn">
              <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°ç»Ÿè®¡
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- åŠ è½½é®ç½©å±‚ -->
  <div class="loading-overlay" id="loadingOverlay" style="display:none;">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">åŠ è½½ä¸­...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="/admin/js/admin-common.js"></script>

  <script>
    // å…¨å±€å˜é‡
    let orderStatusChart = null;
    let revenueChart = null;

    // é¡µé¢åŠ è½½
    document.addEventListener('DOMContentLoaded', function() {
      checkAuth();
      loadStatistics();
      bindEvents();
    });

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
      document.getElementById('logoutBtn').addEventListener('click', logout);
      document.getElementById('refreshBtn').addEventListener('click', loadStatistics);
    }

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStatistics() {
      try {
        showLoading(true);
        const token = getToken();

        const response = await fetch('/api/v4/shop/exchange/statistics', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await response.json();

        if (data.success) {
          renderStatistics(data.data);
        } else {
          showError(data.message || 'åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥', error);
        showError('åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        showLoading(false);
      }
    }

    // æ¸²æŸ“ç»Ÿè®¡æ•°æ®
    function renderStatistics(stats) {
      // è®¢å•ç»Ÿè®¡
      document.getElementById('totalOrders').textContent = stats.orders.total;
      document.getElementById('pendingOrders').textContent = stats.orders.pending;
      document.getElementById('completedOrders').textContent = stats.orders.completed;
      document.getElementById('shippedOrders').textContent = stats.orders.shipped;
      document.getElementById('cancelledOrders').textContent = stats.orders.cancelled;

      // å®Œæˆç‡
      const completionRate = stats.orders.total > 0
        ? Math.round(((stats.orders.completed + stats.orders.shipped) / stats.orders.total) * 100)
        : 0;
      document.getElementById('completionRate').textContent = completionRate + '%';

      // æ”¶å…¥ç»Ÿè®¡
      document.getElementById('totalVirtualValue').textContent = stats.revenue.total_virtual_value.toFixed(2);
      document.getElementById('totalPoints').textContent = stats.revenue.total_points;

      // å•†å“åº“å­˜ç»Ÿè®¡
      const activeItems = stats.items.find(item => item.status === 'active');
      const inactiveItems = stats.items.find(item => item.status === 'inactive');

      document.getElementById('activeItemCount').textContent = activeItems ? activeItems.count : 0;
      document.getElementById('activeItemStock').textContent = activeItems ? activeItems.total_stock : 0;
      document.getElementById('inactiveItemCount').textContent = inactiveItems ? inactiveItems.count : 0;
      document.getElementById('inactiveItemStock').textContent = inactiveItems ? inactiveItems.total_stock : 0;

      // æ¸²æŸ“å›¾è¡¨
      renderOrderStatusChart(stats.orders);
      renderRevenueChart(stats.revenue);
    }

    // æ¸²æŸ“è®¢å•çŠ¶æ€åˆ†å¸ƒå›¾
    function renderOrderStatusChart(orders) {
      const ctx = document.getElementById('orderStatusChart');

      if (orderStatusChart) {
        orderStatusChart.destroy();
      }

      orderStatusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['å¾…å¤„ç†', 'å·²å®Œæˆ', 'å·²å‘è´§', 'å·²å–æ¶ˆ'],
          datasets: [{
            data: [orders.pending, orders.completed, orders.shipped, orders.cancelled],
            backgroundColor: [
              'rgba(255, 193, 7, 0.8)',  // warning
              'rgba(13, 202, 240, 0.8)', // info
              'rgba(25, 135, 84, 0.8)',  // success
              'rgba(108, 117, 125, 0.8)' // secondary
            ],
            borderColor: [
              'rgba(255, 193, 7, 1)',
              'rgba(13, 202, 240, 1)',
              'rgba(25, 135, 84, 1)',
              'rgba(108, 117, 125, 1)'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    // æ¸²æŸ“æ”¶å…¥æ¥æºåˆ†å¸ƒå›¾
    function renderRevenueChart(revenue) {
      const ctx = document.getElementById('revenueChart');

      if (revenueChart) {
        revenueChart.destroy();
      }

      revenueChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['è™šæ‹Ÿä»·å€¼', 'ç§¯åˆ†'],
          datasets: [{
            label: 'æ”¶å…¥æ€»é¢',
            data: [revenue.total_virtual_value, revenue.total_points],
            backgroundColor: [
              'rgba(13, 202, 240, 0.8)', // info
              'rgba(13, 110, 253, 0.8)'  // primary
            ],
            borderColor: [
              'rgba(13, 202, 240, 1)',
              'rgba(13, 110, 253, 1)'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString();
                }
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed.y || 0;
                  return `æ”¶å…¥: ${value.toLocaleString()}`;
                }
              }
            }
          }
        }
      });
    }

    // å·¥å…·å‡½æ•°
    function showLoading(show) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    function showSuccess(message) {
      alert(message);
    }

    function showError(message) {
      alert(message);
    }
  </script>
</body>
</html>
