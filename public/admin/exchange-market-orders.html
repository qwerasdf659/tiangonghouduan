<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…‘æ¢è®¢å•ç®¡ç† - ç®¡ç†åå°</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">
</head>
<body class="bg-light">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ“¦ å…‘æ¢å¸‚åœº - è®¢å•ç®¡ç†
      </a>
      <div>
        <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row g-3 mb-3">
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h6 class="text-muted">è®¢å•æ€»æ•°</h6>
            <h3 class="text-primary" id="totalOrders">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-warning">
          <div class="card-body text-center">
            <h6 class="text-muted">å¾…å¤„ç†</h6>
            <h3 class="text-warning" id="pendingOrders">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-success">
          <div class="card-body text-center">
            <h6 class="text-muted">å·²å‘è´§</h6>
            <h3 class="text-success" id="shippedOrders">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-secondary">
          <div class="card-body text-center">
            <h6 class="text-muted">å·²å–æ¶ˆ</h6>
            <h3 class="text-secondary" id="cancelledOrders">-</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- ç­›é€‰åŒºåŸŸ -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">è®¢å•çŠ¶æ€</label>
            <select class="form-select" id="statusFilter">
              <option value="">å…¨éƒ¨çŠ¶æ€</option>
              <option value="pending">å¾…å¤„ç†</option>
              <option value="completed">å·²å®Œæˆ</option>
              <option value="shipped">å·²å‘è´§</option>
              <option value="cancelled">å·²å–æ¶ˆ</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">æ”¯ä»˜æ–¹å¼</label>
            <select class="form-select" id="paymentTypeFilter" disabled>
              <option value="">å…¨éƒ¨æ–¹å¼ï¼ˆä»…æ”¯æŒè™šæ‹Ÿä»·å€¼ï¼‰</option>
              <option value="virtual">è™šæ‹Ÿä»·å€¼</option>
            </select>
            <small class="text-muted">å·²ç»Ÿä¸€ä¸ºè™šæ‹Ÿä»·å€¼æ”¯ä»˜</small>
          </div>
          <div class="col-md-3">
            <label class="form-label">æœç´¢è®¢å•å·</label>
            <input type="text" class="form-control" id="orderNoSearch" placeholder="è¾“å…¥è®¢å•å·">
          </div>
          <div class="col-md-3">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-primary w-100" id="searchBtn">
              <i class="bi bi-search"></i> æŸ¥è¯¢
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- è®¢å•åˆ—è¡¨ -->
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>è®¢å•å·</th>
                <th>ç”¨æˆ·</th>
                <th>å•†å“ä¿¡æ¯</th>
                <th>æ•°é‡</th>
                <th>æ”¯ä»˜æ–¹å¼</th>
                <th>æ”¯ä»˜é‡‘é¢</th>
                <th>çŠ¶æ€</th>
                <th>å…‘æ¢æ—¶é—´</th>
                <th style="width: 200px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="ordersTableBody">
              <tr>
                <td colspan="9" class="text-center py-5">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                  </div>
                  <p class="mt-2 text-muted">æ­£åœ¨åŠ è½½æ•°æ®...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- åˆ†é¡µ -->
        <nav aria-label="åˆ†é¡µ" class="mt-3">
          <ul class="pagination justify-content-end" id="pagination"></ul>
        </nav>
      </div>
    </div>
  </div>

  <!-- è®¢å•è¯¦æƒ…æ¨¡æ€æ¡† -->
  <div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-receipt"></i> è®¢å•è¯¦æƒ…
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12">
              <h6 class="border-bottom pb-2">è®¢å•ä¿¡æ¯</h6>
              <table class="table table-sm">
                <tr>
                  <td style="width: 120px;" class="text-muted">è®¢å•å·:</td>
                  <td id="detailOrderNo">-</td>
                </tr>
                <tr>
                  <td class="text-muted">è®¢å•çŠ¶æ€:</td>
                  <td id="detailStatus">-</td>
                </tr>
                <tr>
                  <td class="text-muted">ä¸‹å•æ—¶é—´:</td>
                  <td id="detailExchangeTime">-</td>
                </tr>
                <tr>
                  <td class="text-muted">å‘è´§æ—¶é—´:</td>
                  <td id="detailShippedAt">-</td>
                </tr>
              </table>
            </div>

            <div class="col-12">
              <h6 class="border-bottom pb-2">ç”¨æˆ·ä¿¡æ¯</h6>
              <table class="table table-sm">
                <tr>
                  <td style="width: 120px;" class="text-muted">ç”¨æˆ·ID:</td>
                  <td id="detailUserId">-</td>
                </tr>
              </table>
            </div>

            <div class="col-12">
              <h6 class="border-bottom pb-2">å•†å“ä¿¡æ¯</h6>
              <table class="table table-sm">
                <tr>
                  <td style="width: 120px;" class="text-muted">å•†å“åç§°:</td>
                  <td id="detailItemName">-</td>
                </tr>
                <tr>
                  <td class="text-muted">å•†å“æè¿°:</td>
                  <td id="detailItemDesc">-</td>
                </tr>
                <tr>
                  <td class="text-muted">å…‘æ¢æ•°é‡:</td>
                  <td id="detailQuantity">-</td>
                </tr>
              </table>
            </div>

            <div class="col-12">
              <h6 class="border-bottom pb-2">æ”¯ä»˜ä¿¡æ¯</h6>
              <table class="table table-sm">
                <tr>
                  <td style="width: 120px;" class="text-muted">æ”¯ä»˜æ–¹å¼:</td>
                  <td id="detailPaymentType">-</td>
                </tr>
                <tr id="detailVirtualRow">
                  <td class="text-muted">è™šæ‹Ÿä»·å€¼:</td>
                  <td id="detailVirtualPaid">-</td>
                </tr>
                <tr id="detailPointsRow">
                  <td class="text-muted">ç§¯åˆ†æ”¯ä»˜:</td>
                  <td id="detailPointsPaid">-</td>
                </tr>
              </table>
            </div>

            <div class="col-12 admin-only">
              <h6 class="border-bottom pb-2">ç®¡ç†ä¿¡æ¯</h6>
              <table class="table table-sm">
                <tr>
                  <td style="width: 120px;" class="text-muted">æˆæœ¬:</td>
                  <td id="detailCost">-</td>
                </tr>
                <tr>
                  <td class="text-muted">å¤‡æ³¨:</td>
                  <td id="detailRemark">-</td>
                </tr>
              </table>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ›´æ–°çŠ¶æ€æ¨¡æ€æ¡† -->
  <div class="modal fade" id="updateStatusModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-arrow-repeat"></i> æ›´æ–°è®¢å•çŠ¶æ€
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="updateOrderNo">
          <div class="mb-3">
            <label class="form-label">æ–°çŠ¶æ€ <span class="text-danger">*</span></label>
            <select class="form-select" id="newStatus" required>
              <option value="">è¯·é€‰æ‹©</option>
              <option value="completed">å·²å®Œæˆ</option>
              <option value="shipped">å·²å‘è´§</option>
              <option value="cancelled">å–æ¶ˆè®¢å•</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">å¤‡æ³¨</label>
            <textarea class="form-control" id="statusRemark" rows="3" placeholder="å¯é€‰å¡«å†™å¤‡æ³¨ä¿¡æ¯"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" id="submitUpdateStatusBtn">
            <i class="bi bi-check-lg"></i> ç¡®è®¤æ›´æ–°
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- åŠ è½½é®ç½©å±‚ -->
  <div class="loading-overlay" id="loadingOverlay" style="display:none;">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">å¤„ç†ä¸­...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/admin-common.js"></script>

  <script>
    // å…¨å±€å˜é‡
    let currentPage = 1;
    const pageSize = 20;
    let currentFilters = {
      status: '',
      payment_type: '',
      order_no: ''
    };

    // é¡µé¢åŠ è½½
    document.addEventListener('DOMContentLoaded', function() {
      checkAuth();
      loadOrders();
      bindEvents();
    });

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
      document.getElementById('logoutBtn').addEventListener('click', logout);
      document.getElementById('searchBtn').addEventListener('click', handleSearch);
      document.getElementById('submitUpdateStatusBtn').addEventListener('click', handleUpdateStatus);
    }

    // å¤„ç†æœç´¢
    function handleSearch() {
      currentFilters = {
        status: document.getElementById('statusFilter').value,
        payment_type: document.getElementById('paymentTypeFilter').value,
        order_no: document.getElementById('orderNoSearch').value.trim()
      };
      currentPage = 1;
      loadOrders();
    }

    // åŠ è½½è®¢å•åˆ—è¡¨
    async function loadOrders() {
      try {
        showLoading(true);
        const token = getToken();

        // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨æ™®é€šç”¨æˆ·APIï¼Œç®¡ç†å‘˜ä¼šçœ‹åˆ°fullæ•°æ®
        // å¦‚æœåç«¯è¡¥å……äº†/api/v4/admin/exchange_market/ordersï¼Œå¯ä»¥åˆ‡æ¢åˆ°admin API
        const params = new URLSearchParams({
          page: currentPage,
          page_size: pageSize
        });

        if (currentFilters.status) params.append('status', currentFilters.status);

        const response = await fetch(`/api/v4/exchange_market/orders?${params}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await response.json();

        if (data.success) {
          renderOrders(data.data.orders);
          renderPagination(data.data.pagination);
          updateStats(data.data.orders);
        } else {
          showError(data.message || 'åŠ è½½å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½è®¢å•åˆ—è¡¨å¤±è´¥', error);
        showError('åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        showLoading(false);
      }
    }

    // æ¸²æŸ“è®¢å•åˆ—è¡¨
    function renderOrders(orders) {
      const tbody = document.getElementById('ordersTableBody');

      if (!orders || orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>';
        return;
      }

      tbody.innerHTML = orders.map(order => {
        const statusBadge = getStatusBadge(order.status);
        const paymentTypeText = getPaymentTypeText(order.payment_type);

        // åªæ˜¾ç¤ºè™šæ‹Ÿä»·å€¼ï¼ˆå”¯ä¸€æ”¯ä»˜æ–¹å¼ï¼‰
        const paymentAmount = `<span class="badge bg-info">${order.virtual_value_paid} è™šæ‹Ÿ</span>`;

        return `
          <tr>
            <td><code>${order.order_no}</code></td>
            <td>ID: ${order.user_id}</td>
            <td>
              <div><strong>${escapeHtml(order.item_snapshot?.name || '-')}</strong></div>
              <small class="text-muted">${escapeHtml(order.item_snapshot?.description || '')}</small>
            </td>
            <td>${order.quantity}</td>
            <td>${paymentTypeText}</td>
            <td>${paymentAmount}</td>
            <td>${statusBadge}</td>
            <td>${formatDate(order.exchange_time)}</td>
            <td>
              <button class="btn btn-sm btn-outline-info" onclick="viewOrderDetail('${order.order_no}')">
                <i class="bi bi-eye"></i> è¯¦æƒ…
              </button>
              ${order.status === 'pending' ? `
                <button class="btn btn-sm btn-outline-primary" onclick="updateOrderStatus('${order.order_no}')">
                  <i class="bi bi-arrow-repeat"></i> æ›´æ–°
                </button>
              ` : ''}
            </td>
          </tr>
        `;
      }).join('');
    }

    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    function updateStats(orders) {
      const stats = {
        total: orders.length,
        pending: orders.filter(o => o.status === 'pending').length,
        shipped: orders.filter(o => o.status === 'shipped').length,
        cancelled: orders.filter(o => o.status === 'cancelled').length
      };

      document.getElementById('totalOrders').textContent = stats.total;
      document.getElementById('pendingOrders').textContent = stats.pending;
      document.getElementById('shippedOrders').textContent = stats.shipped;
      document.getElementById('cancelledOrders').textContent = stats.cancelled;
    }

    // æŸ¥çœ‹è®¢å•è¯¦æƒ…
    async function viewOrderDetail(orderNo) {
      try {
        showLoading(true);
        const token = getToken();

        const response = await fetch(`/api/v4/exchange_market/orders/${orderNo}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await response.json();

        if (data.success) {
          const order = data.data.order;

          document.getElementById('detailOrderNo').textContent = order.order_no;
          document.getElementById('detailStatus').innerHTML = getStatusBadge(order.status);
          document.getElementById('detailExchangeTime').textContent = formatDate(order.exchange_time);
          document.getElementById('detailShippedAt').textContent = formatDate(order.shipped_at) || '-';
          document.getElementById('detailUserId').textContent = order.user_id;
          document.getElementById('detailItemName').textContent = order.item_snapshot?.name || '-';
          document.getElementById('detailItemDesc').textContent = order.item_snapshot?.description || '-';
          document.getElementById('detailQuantity').textContent = order.quantity;
          document.getElementById('detailPaymentType').textContent = getPaymentTypeText(order.payment_type);
          document.getElementById('detailVirtualPaid').textContent = order.virtual_value_paid || 0;
          document.getElementById('detailPointsPaid').textContent = order.points_paid || 0;
          document.getElementById('detailCost').textContent = order.total_cost || '-';
          document.getElementById('detailRemark').textContent = order.admin_remark || '-';

          // å§‹ç»ˆæ˜¾ç¤ºè™šæ‹Ÿä»·å€¼è¡Œï¼Œéšè—ç§¯åˆ†æ”¯ä»˜è¡Œï¼ˆåªæ”¯æŒvirtualï¼‰
          document.getElementById('detailVirtualRow').style.display = 'table-row';
          document.getElementById('detailPointsRow').style.display = 'none';

          new bootstrap.Modal(document.getElementById('orderDetailModal')).show();
        } else {
          showError(data.message || 'è·å–è®¢å•è¯¦æƒ…å¤±è´¥');
        }
      } catch (error) {
        console.error('è·å–è®¢å•è¯¦æƒ…å¤±è´¥', error);
        showError('è·å–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        showLoading(false);
      }
    }

    // æ‰“å¼€æ›´æ–°çŠ¶æ€å¯¹è¯æ¡†
    function updateOrderStatus(orderNo) {
      document.getElementById('updateOrderNo').value = orderNo;
      document.getElementById('newStatus').value = '';
      document.getElementById('statusRemark').value = '';
      new bootstrap.Modal(document.getElementById('updateStatusModal')).show();
    }

    // æäº¤çŠ¶æ€æ›´æ–°
    async function handleUpdateStatus() {
      try {
        const orderNo = document.getElementById('updateOrderNo').value;
        const newStatus = document.getElementById('newStatus').value;
        const remark = document.getElementById('statusRemark').value.trim();

        if (!newStatus) {
          showError('è¯·é€‰æ‹©æ–°çŠ¶æ€');
          return;
        }

        showLoading(true);
        const token = getToken();

        const response = await fetch(`/api/v4/exchange_market/orders/${orderNo}/status`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: newStatus, remark })
        });

        const data = await response.json();

        if (data.success) {
          showSuccess('çŠ¶æ€æ›´æ–°æˆåŠŸ');
          bootstrap.Modal.getInstance(document.getElementById('updateStatusModal')).hide();
          loadOrders();
        } else {
          showError(data.message || 'æ›´æ–°å¤±è´¥');
        }
      } catch (error) {
        console.error('æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥', error);
        showError('æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        showLoading(false);
      }
    }

    // æ¸²æŸ“åˆ†é¡µ
    function renderPagination(pagination) {
      const paginationEl = document.getElementById('pagination');
      if (!pagination || pagination.total_pages <= 1) {
        paginationEl.innerHTML = '';
        return;
      }

      let html = '';
      for (let i = 1; i <= pagination.total_pages; i++) {
        html += `
          <li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
          </li>
        `;
      }
      paginationEl.innerHTML = html;
    }

    // åˆ‡æ¢é¡µç 
    function changePage(page) {
      currentPage = page;
      loadOrders();
    }

    // å·¥å…·å‡½æ•°
    function getStatusBadge(status) {
      const map = {
        'pending': '<span class="badge bg-warning">å¾…å¤„ç†</span>',
        'completed': '<span class="badge bg-info">å·²å®Œæˆ</span>',
        'shipped': '<span class="badge bg-success">å·²å‘è´§</span>',
        'cancelled': '<span class="badge bg-secondary">å·²å–æ¶ˆ</span>'
      };
      return map[status] || `<span class="badge bg-secondary">${status}</span>`;
    }

    function getPaymentTypeText(type) {
      // ç»Ÿä¸€è¿”å›"è™šæ‹Ÿä»·å€¼"ï¼Œå› ä¸ºåªæ”¯æŒvirtualæ”¯ä»˜æ–¹å¼
      return 'è™šæ‹Ÿä»·å€¼';
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showLoading(show) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    function showSuccess(message) {
      alert(message);
    }

    function showError(message) {
      alert(message);
    }
  </script>
</body>
</html>
