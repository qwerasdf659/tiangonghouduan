<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ•°æ®ç»Ÿè®¡æŠ¥è¡¨ - ç®¡ç†åå°</title>
  
  <!-- âœ… Bootstrap 5 - UIæ¡†æ¶ -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- âœ… Bootstrap Icons - å›¾æ ‡åº“ -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- âœ… å…¬å…±æ ·å¼è¡¨ - ç»Ÿä¸€ä¸»é¢˜å’Œå“åº”å¼è®¾è®¡ -->
  <link href="/admin/css/common.css" rel="stylesheet">
  
  <!-- âœ… é¡µé¢ç‰¹æœ‰æ ·å¼ -->
  <style>
    .trend-up {
      color: #28a745;
    }
    .trend-down {
      color: #dc3545;
    }
    .export-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }
  </style>
</head>
<body class="bg-light">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ“Š ç®¡ç†åå° - æ•°æ®ç»Ÿè®¡æŠ¥è¡¨
      </a>
      <div>
        <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>
  
  <div class="container-fluid mt-4">
    <!-- æ—¶é—´èŒƒå›´é€‰æ‹© -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label">ç»Ÿè®¡å‘¨æœŸ</label>
            <select class="form-select" id="periodSelect">
              <option value="today">ä»Šæ—¥</option>
              <option value="yesterday">æ˜¨æ—¥</option>
              <option value="week" selected>æœ¬å‘¨</option>
              <option value="month">æœ¬æœˆ</option>
              <option value="custom">è‡ªå®šä¹‰</option>
            </select>
          </div>
          <div class="col-md-3" id="customDateStart" style="display: none;">
            <label class="form-label">å¼€å§‹æ—¥æœŸ</label>
            <input type="date" class="form-control" id="startDate">
          </div>
          <div class="col-md-3" id="customDateEnd" style="display: none;">
            <label class="form-label">ç»“æŸæ—¥æœŸ</label>
            <input type="date" class="form-control" id="endDate">
          </div>
          <div class="col-md-3">
            <button class="btn btn-primary w-100" id="loadStatisticsBtn">
              <i class="bi bi-search"></i> æŸ¥è¯¢
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æ ¸å¿ƒæŒ‡æ ‡æ€»è§ˆ -->
    <div class="row g-3 mb-4">
      <div class="col-12">
        <h5><i class="bi bi-bar-chart-fill"></i> æ ¸å¿ƒæŒ‡æ ‡æ€»è§ˆ</h5>
      </div>
      
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <h6 class="text-muted mb-0">æ€»ç”¨æˆ·æ•°</h6>
                <h2 class="mt-2 mb-0" id="totalUsers">-</h2>
              </div>
              <div class="text-primary" style="font-size: 2rem;">
                <i class="bi bi-people-fill"></i>
              </div>
            </div>
            <div class="d-flex align-items-center">
              <span class="trend-up me-2" id="userTrend">
                <i class="bi bi-arrow-up"></i> +0%
              </span>
              <small class="text-muted">è¾ƒä¸ŠæœŸ</small>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <h6 class="text-muted mb-0">æ€»æŠ½å¥–æ¬¡æ•°</h6>
                <h2 class="mt-2 mb-0" id="totalDraws">-</h2>
              </div>
              <div class="text-success" style="font-size: 2rem;">
                <i class="bi bi-gift-fill"></i>
              </div>
            </div>
            <div class="d-flex align-items-center">
              <span class="trend-up me-2" id="drawTrend">
                <i class="bi bi-arrow-up"></i> +0%
              </span>
              <small class="text-muted">è¾ƒä¸ŠæœŸ</small>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <h6 class="text-muted mb-0">ä¸­å¥–ç‡</h6>
                <h2 class="mt-2 mb-0" id="winRate">-</h2>
              </div>
              <div class="text-warning" style="font-size: 2rem;">
                <i class="bi bi-trophy-fill"></i>
              </div>
            </div>
            <div class="d-flex align-items-center">
              <span class="trend-up me-2" id="winRateTrend">
                <i class="bi bi-arrow-up"></i> +0%
              </span>
              <small class="text-muted">è¾ƒä¸ŠæœŸ</small>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <h6 class="text-muted mb-0">æ€»æ¶ˆè´¹é‡‘é¢</h6>
                <h2 class="mt-2 mb-0" id="totalRevenue">-</h2>
              </div>
              <div class="text-danger" style="font-size: 2rem;">
                <i class="bi bi-currency-dollar"></i>
              </div>
            </div>
            <div class="d-flex align-items-center">
              <span class="trend-up me-2" id="revenueTrend">
                <i class="bi bi-arrow-up"></i> +0%
              </span>
              <small class="text-muted">è¾ƒä¸ŠæœŸ</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ç”¨æˆ·æ•°æ®ç»Ÿè®¡ -->
    <div class="row g-3 mb-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-white">
            <h6 class="mb-0"><i class="bi bi-people"></i> ç”¨æˆ·æ•°æ®ç»Ÿè®¡</h6>
          </div>
          <div class="card-body">
            <table class="table table-sm mb-0">
              <tbody>
                <tr>
                  <td>æ–°å¢ç”¨æˆ·</td>
                  <td class="text-end fw-bold" id="newUsers">-</td>
                </tr>
                <tr>
                  <td>æ´»è·ƒç”¨æˆ·</td>
                  <td class="text-end fw-bold" id="activeUsers">-</td>
                </tr>
                <tr>
                  <td>VIPç”¨æˆ·</td>
                  <td class="text-end fw-bold" id="vipUsers">-</td>
                </tr>
                <tr>
                  <td>å°ç¦ç”¨æˆ·</td>
                  <td class="text-end fw-bold text-danger" id="bannedUsers">-</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-white">
            <h6 class="mb-0"><i class="bi bi-gift"></i> æŠ½å¥–æ•°æ®ç»Ÿè®¡</h6>
          </div>
          <div class="card-body">
            <table class="table table-sm mb-0">
              <tbody>
                <tr>
                  <td>æŠ½å¥–æ€»æ¬¡æ•°</td>
                  <td class="text-end fw-bold" id="lotteryDraws">-</td>
                </tr>
                <tr>
                  <td>ä¸­å¥–æ¬¡æ•°</td>
                  <td class="text-end fw-bold text-success" id="lotteryWins">-</td>
                </tr>
                <tr>
                  <td>æœªä¸­å¥–æ¬¡æ•°</td>
                  <td class="text-end fw-bold text-muted" id="lotteryLosses">-</td>
                </tr>
                <tr>
                  <td>å¹³å‡ä¸­å¥–ç‡</td>
                  <td class="text-end fw-bold text-warning" id="avgWinRate">-</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æ¶ˆè´¹ä¸ç§¯åˆ†ç»Ÿè®¡ -->
    <div class="row g-3 mb-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-white">
            <h6 class="mb-0"><i class="bi bi-cash-stack"></i> æ¶ˆè´¹æ•°æ®ç»Ÿè®¡</h6>
          </div>
          <div class="card-body">
            <table class="table table-sm mb-0">
              <tbody>
                <tr>
                  <td>æ€»æ¶ˆè´¹é‡‘é¢</td>
                  <td class="text-end fw-bold text-primary" id="consumptionTotal">-</td>
                </tr>
                <tr>
                  <td>å®¡æ ¸é€šè¿‡</td>
                  <td class="text-end fw-bold text-success" id="consumptionApproved">-</td>
                </tr>
                <tr>
                  <td>å¾…å®¡æ ¸</td>
                  <td class="text-end fw-bold text-warning" id="consumptionPending">-</td>
                </tr>
                <tr>
                  <td>å·²æ‹’ç»</td>
                  <td class="text-end fw-bold text-danger" id="consumptionRejected">-</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-white">
            <h6 class="mb-0"><i class="bi bi-star-fill"></i> ç§¯åˆ†æ•°æ®ç»Ÿè®¡</h6>
          </div>
          <div class="card-body">
            <table class="table table-sm mb-0">
              <tbody>
                <tr>
                  <td>æ€»å‘æ”¾ç§¯åˆ†</td>
                  <td class="text-end fw-bold text-primary" id="pointsIssued">-</td>
                </tr>
                <tr>
                  <td>æ€»æ¶ˆè€—ç§¯åˆ†</td>
                  <td class="text-end fw-bold text-danger" id="pointsConsumed">-</td>
                </tr>
                <tr>
                  <td>å½“å‰æ€»ç§¯åˆ†</td>
                  <td class="text-end fw-bold text-success" id="pointsCurrent">-</td>
                </tr>
                <tr>
                  <td>å¹³å‡æ¯ç”¨æˆ·ç§¯åˆ†</td>
                  <td class="text-end fw-bold text-info" id="pointsAverage">-</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- å¥–å“å‘æ”¾ç»Ÿè®¡ -->
    <div class="row g-3 mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-white">
            <h6 class="mb-0"><i class="bi bi-box-seam"></i> å¥–å“å‘æ”¾ç»Ÿè®¡</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>å¥–å“åç§°</th>
                    <th>ç±»å‹</th>
                    <th>å‘æ”¾æ•°é‡</th>
                    <th>é¢†å–æ•°é‡</th>
                    <th>é¢†å–ç‡</th>
                    <th>æ€»ä»·å€¼</th>
                  </tr>
                </thead>
                <tbody id="prizeStatsTable">
                  <tr>
                    <td colspan="6" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- å®¢æœå·¥ä½œç»Ÿè®¡ -->
    <div class="row g-3 mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-white">
            <h6 class="mb-0"><i class="bi bi-headset"></i> å®¢æœå·¥ä½œç»Ÿè®¡</h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <div class="text-center p-3">
                  <h4 class="text-primary mb-1" id="totalSessions">-</h4>
                  <small class="text-muted">æ€»ä¼šè¯æ•°</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center p-3">
                  <h4 class="text-success mb-1" id="closedSessions">-</h4>
                  <small class="text-muted">å·²ç»“æŸä¼šè¯</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center p-3">
                  <h4 class="text-warning mb-1" id="avgResponseTime">-</h4>
                  <small class="text-muted">å¹³å‡å“åº”æ—¶é—´</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center p-3">
                  <h4 class="text-info mb-1" id="customerSatisfaction">-</h4>
                  <small class="text-muted">æ»¡æ„åº¦</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- æµ®åŠ¨å¯¼å‡ºæŒ‰é’® -->
  <div class="export-btn">
    <div class="btn-group-vertical">
      <button class="btn btn-success" id="exportExcelBtn" title="å¯¼å‡ºExcel">
        <i class="bi bi-file-earmark-excel"></i> å¯¼å‡ºExcel
      </button>
      <button class="btn btn-danger" id="exportPdfBtn" title="å¯¼å‡ºPDF">
        <i class="bi bi-file-earmark-pdf"></i> å¯¼å‡ºPDF
      </button>
    </div>
  </div>
  
  <!-- åŠ è½½é®ç½©å±‚ -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">å¤„ç†ä¸­...</span>
    </div>
  </div>

  <!-- âœ… Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- âœ… å¼•å…¥é€šç”¨å·¥å…·åº“ -->
  <script src="/admin/js/admin-common.js"></script>
  
  <script>
    /**
     * é¡µé¢åˆå§‹åŒ–
     */
    document.addEventListener('DOMContentLoaded', function() {
      // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
      const userInfo = getCurrentUser();
      if (userInfo && userInfo.nickname) {
        document.getElementById('welcomeText').textContent = `æ¬¢è¿ï¼Œ${userInfo.nickname}`;
      }
      
      // ===== é™æ€æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨ =====
      // é€€å‡ºç™»å½•æŒ‰é’®
      document.getElementById('logoutBtn').addEventListener('click', logout);
      
      // åŠ è½½ç»Ÿè®¡æŒ‰é’®
      document.getElementById('loadStatisticsBtn').addEventListener('click', () => loadStatistics());
      
      // å¯¼å‡ºæŒ‰é’®
      document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
      document.getElementById('exportPdfBtn').addEventListener('click', exportToPDF);
      
      // æ—¶é—´å‘¨æœŸé€‰æ‹©å™¨å˜åŒ–
      document.getElementById('periodSelect').addEventListener('change', function() {
        const isCustom = this.value === 'custom';
        document.getElementById('customDateStart').style.display = isCustom ? 'block' : 'none';
        document.getElementById('customDateEnd').style.display = isCustom ? 'block' : 'none';
        // è‡ªåŠ¨é‡æ–°åŠ è½½ç»Ÿè®¡æ•°æ®
        if (!isCustom) {
          loadStatistics();
        }
      });
      
      // åŠ è½½ç»Ÿè®¡æ•°æ®
      loadStatistics();
    });
    
    /**
     * åŠ è½½ç»Ÿè®¡æ•°æ®
     */
    async function loadStatistics() {
      showLoading();
      
      try {
        const period = document.getElementById('periodSelect').value;
        const params = new URLSearchParams({ period });
        
        // å¦‚æœæ˜¯è‡ªå®šä¹‰æ—¶é—´
        if (period === 'custom') {
          const startDate = document.getElementById('startDate').value;
          const endDate = document.getElementById('endDate').value;
          
          if (!startDate || !endDate) {
            alert('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ');
            hideLoading();
            return;
          }
          
          params.append('start_date', startDate);
          params.append('end_date', endDate);
        }
        
        // è°ƒç”¨API
        const response = await apiRequest(`/api/v4/statistics/report?${params.toString()}`);
        
        if (response && response.success) {
          renderStatistics(response.data);
        } else {
          showError('åŠ è½½å¤±è´¥', response?.message || 'è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
        showError('åŠ è½½å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * æ¸²æŸ“ç»Ÿè®¡æ•°æ®
     * @param {Object} data - ç»Ÿè®¡æ•°æ®
     */
    function renderStatistics(data) {
      // æ ¸å¿ƒæŒ‡æ ‡
      if (data.overview) {
        document.getElementById('totalUsers').textContent = formatNumber(data.overview.total_users || 0);
        document.getElementById('totalDraws').textContent = formatNumber(data.overview.total_draws || 0);
        document.getElementById('winRate').textContent = `${(data.overview.win_rate || 0).toFixed(2)}%`;
        document.getElementById('totalRevenue').textContent = `Â¥${(data.overview.total_revenue || 0).toFixed(2)}`;
        
        // è¶‹åŠ¿æŒ‡æ ‡
        renderTrend('userTrend', data.overview.user_trend);
        renderTrend('drawTrend', data.overview.draw_trend);
        renderTrend('winRateTrend', data.overview.win_rate_trend);
        renderTrend('revenueTrend', data.overview.revenue_trend);
      }
      
      // ç”¨æˆ·æ•°æ®
      if (data.users) {
        document.getElementById('newUsers').textContent = formatNumber(data.users.new_users || 0);
        document.getElementById('activeUsers').textContent = formatNumber(data.users.active_users || 0);
        document.getElementById('vipUsers').textContent = formatNumber(data.users.vip_users || 0);
        document.getElementById('bannedUsers').textContent = formatNumber(data.users.banned_users || 0);
      }
      
      // æŠ½å¥–æ•°æ®
      if (data.lottery) {
        document.getElementById('lotteryDraws').textContent = formatNumber(data.lottery.total_draws || 0);
        document.getElementById('lotteryWins').textContent = formatNumber(data.lottery.wins || 0);
        document.getElementById('lotteryLosses').textContent = formatNumber(data.lottery.losses || 0);
        document.getElementById('avgWinRate').textContent = `${(data.lottery.avg_win_rate || 0).toFixed(2)}%`;
      }
      
      // æ¶ˆè´¹æ•°æ®
      if (data.consumption) {
        document.getElementById('consumptionTotal').textContent = `Â¥${(data.consumption.total || 0).toFixed(2)}`;
        document.getElementById('consumptionApproved').textContent = `Â¥${(data.consumption.approved || 0).toFixed(2)}`;
        document.getElementById('consumptionPending').textContent = `Â¥${(data.consumption.pending || 0).toFixed(2)}`;
        document.getElementById('consumptionRejected').textContent = `Â¥${(data.consumption.rejected || 0).toFixed(2)}`;
      }
      
      // ç§¯åˆ†æ•°æ®
      if (data.points) {
        document.getElementById('pointsIssued').textContent = formatNumber(data.points.issued || 0);
        document.getElementById('pointsConsumed').textContent = formatNumber(data.points.consumed || 0);
        document.getElementById('pointsCurrent').textContent = formatNumber(data.points.current || 0);
        document.getElementById('pointsAverage').textContent = formatNumber(data.points.average || 0);
      }
      
      // å¥–å“å‘æ”¾ç»Ÿè®¡
      if (data.prizes && Array.isArray(data.prizes)) {
        renderPrizeStats(data.prizes);
      }
      
      // å®¢æœæ•°æ®
      if (data.customer_service) {
        document.getElementById('totalSessions').textContent = formatNumber(data.customer_service.total_sessions || 0);
        document.getElementById('closedSessions').textContent = formatNumber(data.customer_service.closed_sessions || 0);
        document.getElementById('avgResponseTime').textContent = `${data.customer_service.avg_response_time || 0}åˆ†é’Ÿ`;
        document.getElementById('customerSatisfaction').textContent = `${(data.customer_service.satisfaction || 0).toFixed(1)}åˆ†`;
      }
    }
    
    /**
     * æ¸²æŸ“è¶‹åŠ¿æŒ‡æ ‡
     * @param {string} elementId - å…ƒç´ ID
     * @param {number} trend - è¶‹åŠ¿å€¼ï¼ˆç™¾åˆ†æ¯”ï¼‰
     */
    function renderTrend(elementId, trend) {
      const element = document.getElementById(elementId);
      if (!element || trend === undefined) return;
      
      const isPositive = trend >= 0;
      element.className = isPositive ? 'trend-up me-2' : 'trend-down me-2';
      element.innerHTML = `
        <i class="bi bi-arrow-${isPositive ? 'up' : 'down'}"></i> 
        ${isPositive ? '+' : ''}${trend.toFixed(1)}%
      `;
    }
    
    /**
     * æ¸²æŸ“å¥–å“ç»Ÿè®¡è¡¨æ ¼
     * @param {Array} prizes - å¥–å“ç»Ÿè®¡æ•°ç»„
     */
    function renderPrizeStats(prizes) {
      const tbody = document.getElementById('prizeStatsTable');
      
      if (prizes.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-4">
              <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
              <p class="mt-2 text-muted">æš‚æ— æ•°æ®</p>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = prizes.map(prize => {
        const claimRate = prize.issued > 0 ? (prize.claimed / prize.issued * 100) : 0;
        return `
          <tr>
            <td>${prize.prize_name}</td>
            <td>${getPrizeTypeLabel(prize.prize_type)}</td>
            <td>${formatNumber(prize.issued || 0)}</td>
            <td>${formatNumber(prize.claimed || 0)}</td>
            <td>
              <div class="d-flex align-items-center">
                <div class="progress flex-fill me-2" style="height: 20px;">
                  <div class="progress-bar ${getProgressColor(claimRate)}" 
                       style="width: ${claimRate}%"
                       role="progressbar">
                    ${claimRate.toFixed(1)}%
                  </div>
                </div>
              </div>
            </td>
            <td class="text-primary fw-bold">Â¥${((prize.prize_value || 0) * (prize.issued || 0)).toFixed(2)}</td>
          </tr>
        `;
      }).join('');
    }
    
    /**
     * è·å–å¥–å“ç±»å‹æ ‡ç­¾
     * @param {string} type - å¥–å“ç±»å‹
     * @returns {string} HTMLå­—ç¬¦ä¸²
     */
    function getPrizeTypeLabel(type) {
      const labels = {
        physical: '<span class="badge bg-primary">å®ç‰©</span>',
        virtual: '<span class="badge bg-info">è™šæ‹Ÿ</span>',
        points: '<span class="badge bg-success">ç§¯åˆ†</span>',
        coupon: '<span class="badge bg-warning text-dark">ä¼˜æƒ åˆ¸</span>'
      };
      return labels[type] || '<span class="badge bg-secondary">æœªçŸ¥</span>';
    }
    
    /**
     * è·å–è¿›åº¦æ¡é¢œè‰²
     * @param {number} percentage - ç™¾åˆ†æ¯”
     * @returns {string} CSSç±»å
     */
    function getProgressColor(percentage) {
      if (percentage >= 80) return 'bg-success';
      if (percentage >= 50) return 'bg-info';
      if (percentage >= 30) return 'bg-warning';
      return 'bg-danger';
    }
    
    /**
     * å¯¼å‡ºä¸ºExcel
     */
    async function exportToExcel() {
      showLoading();
      
      try {
        const period = document.getElementById('periodSelect').value;
        const params = new URLSearchParams({ 
          period,
          format: 'excel'
        });
        
        if (period === 'custom') {
          params.append('start_date', document.getElementById('startDate').value);
          params.append('end_date', document.getElementById('endDate').value);
        }
        
        const response = await fetch(`/api/v4/statistics/export?${params.toString()}`, {
          headers: {
            'Authorization': `Bearer ${getToken()}`
          }
        });
        
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `ç»Ÿè®¡æŠ¥è¡¨_${new Date().toISOString().split('T')[0]}.xlsx`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          
          showSuccess('å¯¼å‡ºæˆåŠŸ', 'Excelæ–‡ä»¶å·²ä¸‹è½½');
        } else {
          showError('å¯¼å‡ºå¤±è´¥', 'æ— æ³•ç”ŸæˆExcelæ–‡ä»¶');
        }
      } catch (error) {
        console.error('å¯¼å‡ºExcelå¤±è´¥:', error);
        showError('å¯¼å‡ºå¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * å¯¼å‡ºä¸ºPDF
     */
    async function exportToPDF() {
      showLoading();
      
      try {
        const period = document.getElementById('periodSelect').value;
        const params = new URLSearchParams({ 
          period,
          format: 'pdf'
        });
        
        if (period === 'custom') {
          params.append('start_date', document.getElementById('startDate').value);
          params.append('end_date', document.getElementById('endDate').value);
        }
        
        const response = await fetch(`/api/v4/statistics/export?${params.toString()}`, {
          headers: {
            'Authorization': `Bearer ${getToken()}`
          }
        });
        
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `ç»Ÿè®¡æŠ¥è¡¨_${new Date().toISOString().split('T')[0]}.pdf`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          
          showSuccess('å¯¼å‡ºæˆåŠŸ', 'PDFæ–‡ä»¶å·²ä¸‹è½½');
        } else {
          showError('å¯¼å‡ºå¤±è´¥', 'æ— æ³•ç”ŸæˆPDFæ–‡ä»¶');
        }
      } catch (error) {
        console.error('å¯¼å‡ºPDFå¤±è´¥:', error);
        showError('å¯¼å‡ºå¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * æ˜¾ç¤ºåŠ è½½çŠ¶æ€
     */
    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('show');
    }
    
    /**
     * éšè—åŠ è½½çŠ¶æ€
     */
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('show');
    }
    
    /**
     * æ˜¾ç¤ºæˆåŠŸæç¤º
     * @param {string} title - æ ‡é¢˜
     * @param {string} message - æ¶ˆæ¯
     */
    function showSuccess(title, message) {
      alert(`âœ… ${title}\n${message}`);
    }
    
    /**
     * æ˜¾ç¤ºé”™è¯¯æç¤º
     * @param {string} title - æ ‡é¢˜
     * @param {string} message - æ¶ˆæ¯
     */
    function showError(title, message) {
      alert(`âŒ ${title}\n${message}`);
    }
  </script>
</body>
</html>

