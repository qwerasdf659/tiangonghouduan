<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ ¸é”€ç ç®¡ç† - ç®¡ç†åå°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">
  <style>
    .code-display {
      font-family: 'Courier New', monospace;
      font-size: 1.2rem;
      letter-spacing: 2px;
      background: #f8f9fa;
      padding: 8px 16px;
      border-radius: 8px;
      border: 2px dashed #dee2e6;
    }
    .status-pending { border-left: 4px solid #ffc107; }
    .status-redeemed { border-left: 4px solid #198754; }
    .status-expired { border-left: 4px solid #dc3545; }
    .status-cancelled { border-left: 4px solid #6c757d; }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ« ç®¡ç†åå° - æ ¸é”€ç ç®¡ç†
      </a>
      <div>
        <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-ticket-perforated text-primary" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">æ ¸é”€ç æ€»æ•°</h6>
            <h2 id="totalCodes" class="text-primary mb-0">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-hourglass-split text-warning" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">å¾…æ ¸é”€</h6>
            <h2 id="pendingCodes" class="text-warning mb-0">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">å·²æ ¸é”€</h6>
            <h2 id="redeemedCodes" class="text-success mb-0">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-x-circle text-danger" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">å·²è¿‡æœŸ</h6>
            <h2 id="expiredCodes" class="text-danger mb-0">-</h2>
          </div>
        </div>
      </div>
    </div>

    <!-- ç­›é€‰å’Œæ“ä½œæ  -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-center">
          <div class="col-md-2">
            <label class="form-label">çŠ¶æ€</label>
            <select class="form-select" id="statusFilter">
              <option value="">å…¨éƒ¨çŠ¶æ€</option>
              <option value="pending">å¾…æ ¸é”€</option>
              <option value="redeemed">å·²æ ¸é”€</option>
              <option value="expired">å·²è¿‡æœŸ</option>
              <option value="cancelled">å·²å–æ¶ˆ</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">å¥–å“ç±»å‹</label>
            <select class="form-select" id="prizeTypeFilter">
              <option value="">å…¨éƒ¨ç±»å‹</option>
              <option value="physical">å®ç‰©å¥–å“</option>
              <option value="virtual">è™šæ‹Ÿå¥–å“</option>
              <option value="coupon">ä¼˜æƒ åˆ¸</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">æ ¸é”€ç </label>
            <input type="text" class="form-control" id="codeSearch" placeholder="è¾“å…¥æ ¸é”€ç æœç´¢...">
          </div>
          <div class="col-md-3">
            <label class="form-label">ç”¨æˆ·ID</label>
            <input type="number" class="form-control" id="userSearch" placeholder="è¾“å…¥ç”¨æˆ·ID...">
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-primary me-2" onclick="loadRedemptionCodes()">
              <i class="bi bi-search"></i> æœç´¢
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- æ ¸é”€ç åˆ—è¡¨ -->
    <div class="card">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="bi bi-list-ul"></i> æ ¸é”€ç åˆ—è¡¨</h6>
        <div>
          <button class="btn btn-sm btn-outline-warning me-2" onclick="batchExpire()">
            <i class="bi bi-clock-history"></i> æ‰¹é‡è¿‡æœŸ
          </button>
          <button class="btn btn-sm btn-outline-success" onclick="exportCodes()">
            <i class="bi bi-download"></i> å¯¼å‡º
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                <th>æ ¸é”€ç </th>
                <th>ç”¨æˆ·</th>
                <th>å¥–å“</th>
                <th>æ´»åŠ¨</th>
                <th>çŠ¶æ€</th>
                <th>åˆ›å»ºæ—¶é—´</th>
                <th>æœ‰æ•ˆæœŸè‡³</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="codeList">
              <!-- åŠ¨æ€ç”Ÿæˆ -->
            </tbody>
          </table>
        </div>
        <!-- åˆ†é¡µ -->
        <nav aria-label="Page navigation">
          <ul class="pagination justify-content-center" id="pagination">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
          </ul>
        </nav>
      </div>
    </div>
  </div>

  <!-- æ ¸é”€è¯¦æƒ…æ¨¡æ€æ¡† -->
  <div class="modal fade" id="codeDetailModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-info-circle"></i> æ ¸é”€ç è¯¦æƒ…</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="codeDetailContent">
          <!-- åŠ¨æ€å¡«å…… -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ‰‹åŠ¨æ ¸é”€æ¨¡æ€æ¡† -->
  <div class="modal fade" id="redeemModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-check-circle"></i> æ‰‹åŠ¨æ ¸é”€</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="redeemForm">
            <input type="hidden" id="redeemCodeId">
            <div class="mb-3 text-center">
              <div class="code-display mb-3" id="redeemCodeDisplay">-</div>
            </div>
            <div class="mb-3">
              <label class="form-label">æ ¸é”€é—¨åº—</label>
              <select class="form-select" id="redeemStoreId">
                <option value="">è¯·é€‰æ‹©é—¨åº—</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">å¤‡æ³¨</label>
              <textarea class="form-control" id="redeemRemark" rows="2" placeholder="æ ¸é”€å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-success" onclick="submitRedeem()">ç¡®è®¤æ ¸é”€</button>
        </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">åŠ è½½ä¸­...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script src="/admin/js/api-config.js"></script>
  <script>
    let codes = [];
    let stores = [];
    let currentPage = 1;
    let totalPages = 1;

    document.addEventListener('DOMContentLoaded', function() {
      const userInfo = getCurrentUser();
      if (userInfo && userInfo.nickname) {
        document.getElementById('welcomeText').textContent = `æ¬¢è¿ï¼Œ${userInfo.nickname}`;
      }
      document.getElementById('logoutBtn').addEventListener('click', logout);
      
      loadStores();
      loadRedemptionCodes();
    });

    async function loadStores() {
      try {
        const response = await apiRequest(API_ENDPOINTS.STORE.LIST);
        if (response && response.success) {
          // é€‚é…åç«¯è¿”å›æ ¼å¼: { items: [...], total, page, ... }
          stores = response.data.items || [];
          const select = document.getElementById('redeemStoreId');
          select.innerHTML = '<option value="">è¯·é€‰æ‹©é—¨åº—</option>' +
            stores.map(s => `<option value="${s.store_id}">${escapeHtml(s.store_name)}</option>`).join('');
        }
      } catch (error) {
        console.error('åŠ è½½é—¨åº—å¤±è´¥:', error);
      }
    }

    async function loadRedemptionCodes(page = 1) {
      showLoading();
      currentPage = page;
      try {
        const status = document.getElementById('statusFilter').value;
        const prizeType = document.getElementById('prizeTypeFilter').value;
        const code = document.getElementById('codeSearch').value;
        const userId = document.getElementById('userSearch').value;

        const params = new URLSearchParams();
        params.append('page', page);
        params.append('limit', 20);
        if (status) params.append('status', status);
        if (prizeType) params.append('prize_type', prizeType);
        if (code) params.append('code', code);
        if (userId) params.append('user_id', userId);

        const url = API_ENDPOINTS.BUSINESS_RECORDS.LIST + '?' + params.toString();
        const response = await apiRequest(url);

        if (response && response.success) {
          // é€‚é…åç«¯è¿”å›æ ¼å¼ï¼šåç«¯è¿”å› orders å­—æ®µï¼ˆä»¥åç«¯ä¸ºå‡†ï¼‰
          codes = response.data.orders || response.data.records || response.data.codes || [];
          totalPages = response.data.pagination?.total_pages || 1;
          renderCodeList(codes);
          renderPagination();
          // ç»Ÿè®¡æ•°æ®éœ€è¦ä»åˆ†é¡µä¿¡æ¯å’Œå½“å‰æ•°æ®è®¡ç®—
          updateStats({
            total: response.data.pagination?.total || codes.length,
            pending: codes.filter(c => c.status === 'pending').length,
            fulfilled: codes.filter(c => c.status === 'fulfilled').length,
            expired: codes.filter(c => c.status === 'expired').length
          });
        } else {
          showError('åŠ è½½å¤±è´¥', response?.message || 'è·å–æ ¸é”€ç åˆ—è¡¨å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½æ ¸é”€ç å¤±è´¥:', error);
        showError('åŠ è½½å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }

    function renderCodeList(codes) {
      const tbody = document.getElementById('codeList');
      
      if (!codes || codes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>';
        return;
      }

      // é€‚é…åç«¯å­—æ®µåï¼ˆä»¥åç«¯ä¸ºå‡†ï¼‰ï¼š
      // order_id - è®¢å•IDï¼ˆUUIDï¼‰
      // code_hash - æ ¸é”€ç å“ˆå¸Œï¼ˆæ˜¾ç¤ºå‰8ä½ï¼‰
      // item_instance - å…³è”çš„ç‰©å“å®ä¾‹
      // redeemer - å…³è”çš„æ ¸é”€ç”¨æˆ·
      // redeemer_user_id - æ ¸é”€ç”¨æˆ·ID
      // status - çŠ¶æ€
      // expires_at - è¿‡æœŸæ—¶é—´
      // fulfilled_at - æ ¸é”€æ—¶é—´
      tbody.innerHTML = codes.map(c => {
        // è·å–ç‰©å“ä¿¡æ¯ï¼ˆä»å…³è”çš„ item_instanceï¼‰
        const itemInfo = c.item_instance || {};
        const itemMeta = itemInfo.meta || {};
        const prizeName = itemMeta.prize_name || itemMeta.name || itemInfo.item_type || '-';
        
        // è·å–æ ¸é”€äººä¿¡æ¯
        const redeemer = c.redeemer || {};
        const redeemerName = redeemer.nickname || redeemer.mobile || '-';
        
        // æ˜¾ç¤ºæ ¸é”€ç ï¼ˆæ˜¾ç¤ºå“ˆå¸Œå‰8ä½ï¼Œå› ä¸ºåç«¯åªå­˜å“ˆå¸Œï¼‰
        const codeDisplay = c.code_hash ? c.code_hash.substring(0, 8) + '...' : '-';
        
        return `
        <tr class="status-${c.status}">
          <td><input type="checkbox" class="code-checkbox" value="${c.order_id}"></td>
          <td><code class="code-display p-1" title="${c.code_hash || ''}">${escapeHtml(codeDisplay)}</code></td>
          <td>
            <small>${c.redeemer_user_id || '-'}</small>
            ${redeemerName !== '-' ? `<br><small class="text-muted">${escapeHtml(redeemerName)}</small>` : ''}
          </td>
          <td>${escapeHtml(prizeName)}</td>
          <td>${escapeHtml(itemMeta.campaign_name || '-')}</td>
          <td><span class="badge ${getStatusBadgeClass(c.status)}">${getStatusLabel(c.status)}</span></td>
          <td><small>${formatDateTime(c.created_at)}</small></td>
          <td><small>${formatDateTime(c.expires_at)}</small></td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="viewCodeDetail('${c.order_id}')">
              <i class="bi bi-eye"></i>
            </button>
            ${c.status === 'pending' ? `
              <button class="btn btn-sm btn-outline-success me-1" onclick="openRedeemModal('${c.order_id}', '${escapeHtml(codeDisplay)}')">
                <i class="bi bi-check-lg"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="cancelCode('${c.order_id}')">
                <i class="bi bi-x-lg"></i>
              </button>
            ` : ''}
          </td>
        </tr>
      `}).join('');
    }

    function renderPagination() {
      const pagination = document.getElementById('pagination');
      let html = '';

      html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadRedemptionCodes(${currentPage - 1})">ä¸Šä¸€é¡µ</a>
      </li>`;

      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="loadRedemptionCodes(${i})">${i}</a>
          </li>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
      }

      html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadRedemptionCodes(${currentPage + 1})">ä¸‹ä¸€é¡µ</a>
      </li>`;

      pagination.innerHTML = html;
    }

    function updateStats(stats) {
      document.getElementById('totalCodes').textContent = stats.total || codes.length;
      document.getElementById('pendingCodes').textContent = stats.pending || codes.filter(c => c.status === 'pending').length;
      // åç«¯çŠ¶æ€æ˜¯ fulfilledï¼ˆä»¥åç«¯ä¸ºå‡†ï¼‰ï¼Œä¸æ˜¯ redeemed
      document.getElementById('redeemedCodes').textContent = stats.fulfilled || stats.redeemed || codes.filter(c => c.status === 'fulfilled').length;
      document.getElementById('expiredCodes').textContent = stats.expired || codes.filter(c => c.status === 'expired').length;
    }

    function getStatusBadgeClass(status) {
      // é€‚é…åç«¯çŠ¶æ€ï¼šfulfilledï¼ˆä»¥åç«¯ä¸ºå‡†ï¼‰
      const classes = {
        pending: 'bg-warning text-dark',
        fulfilled: 'bg-success',  // åç«¯ä½¿ç”¨ fulfilled
        redeemed: 'bg-success',   // å…¼å®¹æ—§å­—æ®µ
        expired: 'bg-danger',
        cancelled: 'bg-secondary'
      };
      return classes[status] || 'bg-secondary';
    }

    function getStatusLabel(status) {
      // é€‚é…åç«¯çŠ¶æ€ï¼šfulfilledï¼ˆä»¥åç«¯ä¸ºå‡†ï¼‰
      const labels = {
        pending: 'å¾…æ ¸é”€',
        fulfilled: 'å·²æ ¸é”€',  // åç«¯ä½¿ç”¨ fulfilled
        redeemed: 'å·²æ ¸é”€',   // å…¼å®¹æ—§å­—æ®µ
        expired: 'å·²è¿‡æœŸ',
        cancelled: 'å·²å–æ¶ˆ'
      };
      return labels[status] || status;
    }

    async function viewCodeDetail(orderId) {
      showLoading();
      try {
        // ä½¿ç”¨ order_id ä½œä¸ºè·¯å¾„å‚æ•°ï¼ˆä»¥åç«¯ä¸ºå‡†ï¼‰
        const response = await apiRequest(API.buildURL(API_ENDPOINTS.BUSINESS_RECORDS.DETAIL, { order_id: orderId }));
        if (response && response.success) {
          const c = response.data;
          // é€‚é…åç«¯å­—æ®µå
          const itemInfo = c.item_instance || {};
          const itemMeta = itemInfo.meta || {};
          const prizeName = itemMeta.prize_name || itemMeta.name || itemInfo.item_type || '-';
          const redeemer = c.redeemer || {};
          const codeDisplay = c.code_hash ? c.code_hash.substring(0, 8) + '...' : '-';
          
          document.getElementById('codeDetailContent').innerHTML = `
            <div class="text-center mb-3">
              <div class="code-display" title="${c.code_hash || ''}">${escapeHtml(codeDisplay)}</div>
              <small class="text-muted">è®¢å•ID: ${c.order_id}</small>
            </div>
            <table class="table table-sm">
              <tr><th style="width:35%">çŠ¶æ€</th><td><span class="badge ${getStatusBadgeClass(c.status)}">${getStatusLabel(c.status)}</span></td></tr>
              <tr><th>æ ¸é”€ç”¨æˆ·ID</th><td>${c.redeemer_user_id || '-'}</td></tr>
              <tr><th>æ ¸é”€ç”¨æˆ·</th><td>${escapeHtml(redeemer.nickname || redeemer.mobile || '-')}</td></tr>
              <tr><th>ç‰©å“ç±»å‹</th><td>${escapeHtml(itemInfo.item_type || '-')}</td></tr>
              <tr><th>å¥–å“åç§°</th><td>${escapeHtml(prizeName)}</td></tr>
              <tr><th>æ´»åŠ¨</th><td>${escapeHtml(itemMeta.campaign_name || '-')}</td></tr>
              <tr><th>åˆ›å»ºæ—¶é—´</th><td>${formatDateTime(c.created_at)}</td></tr>
              <tr><th>æœ‰æ•ˆæœŸè‡³</th><td>${formatDateTime(c.expires_at)}</td></tr>
              ${c.status === 'fulfilled' ? `
                <tr><th>æ ¸é”€æ—¶é—´</th><td>${formatDateTime(c.fulfilled_at)}</td></tr>
              ` : ''}
            </table>
          `;
          new bootstrap.Modal(document.getElementById('codeDetailModal')).show();
        } else {
          showError('åŠ è½½å¤±è´¥', response?.message || 'è·å–è¯¦æƒ…å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½è¯¦æƒ…å¤±è´¥:', error);
        showError('åŠ è½½å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }

    function openRedeemModal(orderId, codeDisplay) {
      document.getElementById('redeemCodeId').value = orderId;
      document.getElementById('redeemCodeDisplay').textContent = codeDisplay;
      document.getElementById('redeemStoreId').value = '';
      document.getElementById('redeemRemark').value = '';
      new bootstrap.Modal(document.getElementById('redeemModal')).show();
    }

    async function submitRedeem() {
      const orderId = document.getElementById('redeemCodeId').value;
      const storeId = document.getElementById('redeemStoreId').value;
      const remark = document.getElementById('redeemRemark').value;

      showLoading();
      try {
        // ä½¿ç”¨ order_id ä½œä¸ºè·¯å¾„å‚æ•°ï¼ˆä»¥åç«¯ä¸ºå‡†ï¼‰
        const response = await apiRequest(API.buildURL(API_ENDPOINTS.BUSINESS_RECORDS.REDEEM, { order_id: orderId }), {
          method: 'POST',
          body: JSON.stringify({
            store_id: storeId ? parseInt(storeId) : null,
            remark: remark
          })
        });

        if (response && response.success) {
          bootstrap.Modal.getInstance(document.getElementById('redeemModal')).hide();
          alert('âœ… æ ¸é”€æˆåŠŸ');
          loadRedemptionCodes(currentPage);
        } else {
          showError('æ ¸é”€å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        console.error('æ ¸é”€å¤±è´¥:', error);
        showError('æ ¸é”€å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }

    async function cancelCode(orderId) {
      if (!confirm('ç¡®å®šè¦å–æ¶ˆæ­¤æ ¸é”€ç å—ï¼Ÿ')) return;

      showLoading();
      try {
        // ä½¿ç”¨ order_id ä½œä¸ºè·¯å¾„å‚æ•°ï¼ˆä»¥åç«¯ä¸ºå‡†ï¼‰
        const response = await apiRequest(API.buildURL(API_ENDPOINTS.BUSINESS_RECORDS.CANCEL, { order_id: orderId }), {
          method: 'POST'
        });

        if (response && response.success) {
          alert('âœ… å·²å–æ¶ˆ');
          loadRedemptionCodes(currentPage);
        } else {
          showError('å–æ¶ˆå¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        console.error('å–æ¶ˆå¤±è´¥:', error);
        showError('å–æ¶ˆå¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }

    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAll').checked;
      document.querySelectorAll('.code-checkbox').forEach(cb => cb.checked = selectAll);
    }

    async function batchExpire() {
      // è·å–é€‰ä¸­çš„ order_idï¼ˆUUID å­—ç¬¦ä¸²ï¼‰
      const selected = Array.from(document.querySelectorAll('.code-checkbox:checked')).map(cb => cb.value);
      if (selected.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦å¤„ç†çš„æ ¸é”€ç ');
        return;
      }

      if (!confirm(`ç¡®å®šè¦å°†é€‰ä¸­çš„ ${selected.length} ä¸ªæ ¸é”€ç è®¾ä¸ºè¿‡æœŸå—ï¼Ÿ`)) return;

      showLoading();
      try {
        // ä½¿ç”¨ order_ids è€Œä¸æ˜¯ code_idsï¼ˆä»¥åç«¯ä¸ºå‡†ï¼‰
        const response = await apiRequest(API_ENDPOINTS.BUSINESS_RECORDS.BATCH_EXPIRE, {
          method: 'POST',
          body: JSON.stringify({ order_ids: selected })
        });

        if (response && response.success) {
          alert('âœ… æ‰¹é‡è¿‡æœŸæˆåŠŸ');
          loadRedemptionCodes(currentPage);
        } else {
          showError('æ“ä½œå¤±è´¥', response?.message || 'æ‰¹é‡è¿‡æœŸå¤±è´¥');
        }
      } catch (error) {
        console.error('æ‰¹é‡è¿‡æœŸå¤±è´¥:', error);
        showError('æ“ä½œå¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }

    function exportCodes() {
      const status = document.getElementById('statusFilter').value;
      const params = new URLSearchParams();
      if (status) params.append('status', status);
      params.append('format', 'csv');
      
      window.open(API_ENDPOINTS.BUSINESS_RECORDS.EXPORT + '?' + params.toString(), '_blank');
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      return new Date(dateStr).toLocaleString('zh-CN');
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('show');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('show');
    }

    function showError(title, message) {
      alert(`âŒ ${title}\n${message}`);
    }
  </script>
</body>
</html>

