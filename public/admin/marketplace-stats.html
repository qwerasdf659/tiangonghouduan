<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”¨æˆ·ä¸Šæ¶çŠ¶æ€ç»Ÿè®¡ - ç®¡ç†åå°</title>
  
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <!-- å…¬å…±æ ·å¼ -->
  <link href="/admin/css/common.css" rel="stylesheet">
</head>
<body class="bg-light">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <span class="navbar-brand">ğŸ“Š ç”¨æˆ·ä¸Šæ¶çŠ¶æ€ç»Ÿè®¡</span>
      <div>
        <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- ç»Ÿè®¡æ¦‚è§ˆå¡ç‰‡ -->
    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="card border-primary">
          <div class="card-body text-center">
            <h6 class="text-muted">æœ‰ä¸Šæ¶å•†å“çš„ç”¨æˆ·</h6>
            <h2 id="totalUsersWithListings" class="text-primary">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card border-warning">
          <div class="card-body text-center">
            <h6 class="text-muted">æ¥è¿‘ä¸Šé™ç”¨æˆ·ï¼ˆâ‰¥8ä»¶ï¼‰</h6>
            <h2 id="usersNearLimit" class="text-warning">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card border-danger">
          <div class="card-body text-center">
            <h6 class="text-muted">è¾¾åˆ°ä¸Šé™ç”¨æˆ·ï¼ˆâ‰¥10ä»¶ï¼‰</h6>
            <h2 id="usersAtLimit" class="text-danger">-</h2>
          </div>
        </div>
      </div>
    </div>

    <!-- ç­›é€‰å’Œæœç´¢ -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">ç­›é€‰æ¡ä»¶</label>
            <select class="form-select" id="filterSelect">
              <option value="all">å…¨éƒ¨ç”¨æˆ·</option>
              <option value="near_limit">æ¥è¿‘ä¸Šé™ï¼ˆâ‰¥8ä»¶ï¼‰</option>
              <option value="at_limit">è¾¾åˆ°ä¸Šé™ï¼ˆâ‰¥10ä»¶ï¼‰</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">&nbsp;</label>
            <div>
              <button class="btn btn-primary" id="searchBtn">
                <i class="bi bi-search"></i> æŸ¥è¯¢
              </button>
              <button class="btn btn-secondary ms-2" id="resetBtn">
                <i class="bi bi-arrow-clockwise"></i> é‡ç½®
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ•°æ®è¡¨æ ¼ -->
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>ç”¨æˆ·ID</th>
                <th>ç”¨æˆ·å</th>
                <th>æ‰‹æœºå·</th>
                <th>ä¸Šæ¶çŠ¶æ€</th>
                <th>å‰©ä½™å¯ä¸Šæ¶</th>
                <th>çŠ¶æ€</th>
                <th>æ³¨å†Œæ—¶é—´</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="statsTableBody">
              <tr>
                <td colspan="8" class="text-center">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- åˆ†é¡µ -->
        <nav aria-label="åˆ†é¡µå¯¼èˆª">
          <ul class="pagination justify-content-end mb-0" id="pagination">
            <!-- åŠ¨æ€ç”Ÿæˆåˆ†é¡µ -->
          </ul>
        </nav>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // å…¨å±€å˜é‡
    let currentPage = 1;
    let pageSize = 20;
    let currentFilter = 'all';

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      // æ£€æŸ¥ç™»å½•çŠ¶æ€
      checkAuth();
      
      // åŠ è½½æ•°æ®
      fetchStats();
      
      // ç»‘å®šäº‹ä»¶
      document.getElementById('searchBtn').addEventListener('click', handleSearch);
      document.getElementById('resetBtn').addEventListener('click', handleReset);
      document.getElementById('filterSelect').addEventListener('change', handleFilterChange);
      document.getElementById('logoutBtn').addEventListener('click', handleLogout);
    });

    // æ£€æŸ¥è®¤è¯
    function checkAuth() {
      const token = localStorage.getItem('admin_token');
      if (!token) {
        window.location.href = '/admin/login.html';
        return;
      }
    }

    // è·å–ç»Ÿè®¡æ•°æ®
    async function fetchStats() {
      try {
        const token = localStorage.getItem('admin_token');
        const params = new URLSearchParams({
          page: currentPage,
          limit: pageSize,
          filter: currentFilter
        });

        const response = await fetch(`/api/v4/admin/marketplace/listing-stats?${params}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const data = await response.json();

        if (data.success) {
          updateSummary(data.data.summary);
          updateTable(data.data.stats);
          updatePagination(data.data.pagination);
        } else {
          showError('è·å–æ•°æ®å¤±è´¥');
        }
      } catch (error) {
        console.error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥', error);
        showError('è·å–æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }
    }

    // æ›´æ–°ç»Ÿè®¡æ¦‚è§ˆ
    function updateSummary(summary) {
      document.getElementById('totalUsersWithListings').textContent = summary.total_users_with_listings;
      document.getElementById('usersNearLimit').textContent = summary.users_near_limit;
      document.getElementById('usersAtLimit').textContent = summary.users_at_limit;
    }

    // æ›´æ–°è¡¨æ ¼
    function updateTable(stats) {
      const tbody = document.getElementById('statsTableBody');
      
      if (stats.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>';
        return;
      }

      tbody.innerHTML = stats.map(item => `
        <tr>
          <td>${item.user_id}</td>
          <td>${item.username || '-'}</td>
          <td>${item.phone || '-'}</td>
          <td>
            <div>
              <span class="badge ${getStatusBadgeClass(item.status)}">
                ${item.active_listings} / ${item.limit}
              </span>
              <div class="progress mt-2" style="height: 8px;">
                <div class="progress-bar ${getProgressClass(item.percentage)}" 
                     role="progressbar" 
                     style="width: ${item.percentage}%"
                     aria-valuenow="${item.percentage}" 
                     aria-valuemin="0" 
                     aria-valuemax="100">
                </div>
              </div>
            </div>
          </td>
          <td>
            <span class="${item.remaining === 0 ? 'text-danger fw-bold' : ''}">
              ${item.remaining} ä»¶
            </span>
          </td>
          <td>
            <span class="badge ${getStatusTagClass(item.status)}">
              ${getStatusText(item.status)}
            </span>
          </td>
          <td>${formatDate(item.registered_at)}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="viewUserListings(${item.user_id})">
              æŸ¥çœ‹å•†å“
            </button>
          </td>
        </tr>
      `).join('');
    }

    // æ›´æ–°åˆ†é¡µ
    function updatePagination(pagination) {
      const paginationEl = document.getElementById('pagination');
      const totalPages = pagination.total_pages;
      
      if (totalPages <= 1) {
        paginationEl.innerHTML = '';
        return;
      }

      let html = '';
      
      // ä¸Šä¸€é¡µ
      html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">ä¸Šä¸€é¡µ</a>
        </li>
      `;

      // é¡µç 
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          html += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
              <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
            </li>
          `;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
      }

      // ä¸‹ä¸€é¡µ
      html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">ä¸‹ä¸€é¡µ</a>
        </li>
      `;

      paginationEl.innerHTML = html;
    }

    // åˆ‡æ¢é¡µç 
    function changePage(page) {
      currentPage = page;
      fetchStats();
    }

    // å¤„ç†æœç´¢
    function handleSearch() {
      currentPage = 1;
      fetchStats();
    }

    // å¤„ç†é‡ç½®
    function handleReset() {
      currentFilter = 'all';
      currentPage = 1;
      document.getElementById('filterSelect').value = 'all';
      fetchStats();
    }

    // å¤„ç†ç­›é€‰å˜åŒ–
    function handleFilterChange(e) {
      currentFilter = e.target.value;
      currentPage = 1;
      fetchStats();
    }

    // æŸ¥çœ‹ç”¨æˆ·å•†å“
    function viewUserListings(userId) {
      window.location.href = `/admin/users.html?user_id=${userId}&tab=inventory`;
    }

    // é€€å‡ºç™»å½•
    function handleLogout() {
      localStorage.removeItem('admin_token');
      window.location.href = '/admin/login.html';
    }

    // è¾…åŠ©å‡½æ•°
    function getStatusBadgeClass(status) {
      const classMap = {
        'at_limit': 'bg-danger',
        'near_limit': 'bg-warning',
        'normal': 'bg-success'
      };
      return classMap[status] || 'bg-secondary';
    }

    function getProgressClass(percentage) {
      if (percentage >= 100) return 'bg-danger';
      if (percentage >= 80) return 'bg-warning';
      return 'bg-success';
    }

    function getStatusTagClass(status) {
      const classMap = {
        'at_limit': 'bg-danger',
        'near_limit': 'bg-warning',
        'normal': 'bg-success'
      };
      return classMap[status] || 'bg-secondary';
    }

    function getStatusText(status) {
      const textMap = {
        'at_limit': 'å·²æ»¡',
        'near_limit': 'æ¥è¿‘',
        'normal': 'æ­£å¸¸'
      };
      return textMap[status] || 'æœªçŸ¥';
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function showError(message) {
      alert(message);
    }
  </script>
</body>
</html>

