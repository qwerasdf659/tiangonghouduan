<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‘˜å·¥ç®¡ç† - ç®¡ç†åå°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">
  <style>
    .staff-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
    }
    .role-badge {
      font-size: 0.75rem;
    }
    [x-cloak] { display: none !important; }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ‘¥ ç®¡ç†åå° - å‘˜å·¥ç®¡ç†
      </a>
      <div>
        <span class="text-light me-3" x-data x-text="$store.auth.user?.nickname ? `æ¬¢è¿ï¼Œ${$store.auth.user.nickname}` : 'æ¬¢è¿ï¼Œç®¡ç†å‘˜'">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" onclick="logout()">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4" x-data="storeStaffPage()">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-people text-primary" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">å‘˜å·¥æ€»æ•°</h6>
            <h2 class="text-primary mb-0" x-text="stats.total">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-person-check text-success" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">åœ¨èŒå‘˜å·¥</h6>
            <h2 class="text-success mb-0" x-text="stats.active">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-person-badge text-warning" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">åº—é•¿æ•°é‡</h6>
            <h2 class="text-warning mb-0" x-text="stats.managers">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-shop text-info" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">è¦†ç›–é—¨åº—</h6>
            <h2 class="text-info mb-0" x-text="stats.stores">-</h2>
          </div>
        </div>
      </div>
    </div>

    <!-- ç­›é€‰å’Œæ“ä½œæ  -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-center">
          <div class="col-md-3">
            <label class="form-label">æ‰€å±é—¨åº—</label>
            <select class="form-select" x-model="filters.storeId">
              <option value="">å…¨éƒ¨é—¨åº—</option>
              <template x-for="store in stores" :key="store.store_id">
                <option :value="store.store_id" x-text="store.store_name"></option>
              </template>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">å‘˜å·¥è§’è‰²</label>
            <select class="form-select" x-model="filters.role">
              <option value="">å…¨éƒ¨è§’è‰²</option>
              <option value="manager">åº—é•¿</option>
              <option value="staff">å‘˜å·¥</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">çŠ¶æ€</label>
            <select class="form-select" x-model="filters.status">
              <option value="">å…¨éƒ¨çŠ¶æ€</option>
              <option value="active">åœ¨èŒ</option>
              <option value="inactive">ç¦»èŒ</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">æœç´¢</label>
            <input type="text" class="form-control" x-model="filters.search" placeholder="æœç´¢å‘˜å·¥å§“å...">
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-primary me-2" @click="loadStaff()">
              <i class="bi bi-search"></i> æœç´¢
            </button>
            <button class="btn btn-success" @click="openCreateModal()">
              <i class="bi bi-plus-lg"></i> å…¥èŒ
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- å‘˜å·¥åˆ—è¡¨ -->
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>å‘˜å·¥ä¿¡æ¯</th>
                <th>æ‰€å±é—¨åº—</th>
                <th>è§’è‰²</th>
                <th>å…¥èŒæ—¶é—´</th>
                <th>çŠ¶æ€</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <template x-if="staffList.length === 0">
                <tr><td colspan="6" class="text-center text-muted py-4">æš‚æ— å‘˜å·¥æ•°æ®</td></tr>
              </template>
              <template x-for="s in staffList" :key="s.store_staff_id || s.user_id">
                <tr>
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="staff-avatar me-3" x-text="getInitials(s.user_nickname || 'U')"></div>
                      <div>
                        <div class="fw-bold" x-text="s.user_nickname || '-'"></div>
                        <small class="text-muted" x-text="`ID: ${s.user_id}`"></small>
                      </div>
                    </div>
                  </td>
                  <td>
                    <i class="bi bi-shop text-primary"></i>
                    <span x-text="s.store_name || '-'"></span>
                  </td>
                  <td>
                    <span class="badge role-badge" :class="s.role_in_store === 'manager' ? 'bg-warning' : 'bg-info'" x-text="s.role_in_store === 'manager' ? 'ğŸ‘‘ åº—é•¿' : 'ğŸ‘¤ å‘˜å·¥'"></span>
                  </td>
                  <td x-text="formatDate(s.joined_at)"></td>
                  <td>
                    <span class="badge" :class="s.status === 'active' ? 'bg-success' : 'bg-secondary'" x-text="s.status === 'active' ? 'åœ¨èŒ' : 'ç¦»èŒ'"></span>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <template x-if="s.status === 'active'">
                        <button class="btn btn-outline-warning" @click="openTransferModal(s)">
                          <i class="bi bi-arrow-left-right"></i> è°ƒåº—
                        </button>
                      </template>
                      <template x-if="s.status === 'active'">
                        <button class="btn btn-outline-primary" @click="changeRole(s)">
                          <i class="bi bi-person-gear"></i>
                          <span x-text="s.role_in_store === 'manager' ? 'é™çº§' : 'å‡çº§'"></span>
                        </button>
                      </template>
                      <template x-if="s.status === 'active'">
                        <button class="btn btn-outline-danger" @click="disableStaff(s.user_id)">
                          <i class="bi bi-person-x"></i> ç¦»èŒ
                        </button>
                      </template>
                      <template x-if="s.status !== 'active'">
                        <button class="btn btn-outline-success" @click="enableStaff(s.user_id, s.store_id)">
                          <i class="bi bi-person-check"></i> å¤èŒ
                        </button>
                      </template>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- å…¥èŒæ¨¡æ€æ¡† -->
    <div class="modal fade" id="staffModal" tabindex="-1" x-ref="staffModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-person-plus"></i> å‘˜å·¥å…¥èŒ</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form @submit.prevent="submitStaff">
              <div class="mb-3">
                <label class="form-label">é€‰æ‹©ç”¨æˆ· <span class="text-danger">*</span></label>
                <input type="number" class="form-control" x-model.number="form.userId" placeholder="è¾“å…¥ç”¨æˆ·ID" required>
                <small class="text-muted">è¯·è¾“å…¥è¦å…¥èŒçš„ç”¨æˆ·ID</small>
              </div>
              <div class="mb-3">
                <label class="form-label">åˆ†é…é—¨åº— <span class="text-danger">*</span></label>
                <select class="form-select" x-model="form.storeId" required>
                  <option value="">è¯·é€‰æ‹©é—¨åº—</option>
                  <template x-for="store in stores" :key="store.store_id">
                    <option :value="store.store_id" x-text="store.store_name"></option>
                  </template>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">å‘˜å·¥è§’è‰²</label>
                <select class="form-select" x-model="form.role">
                  <option value="staff">å‘˜å·¥</option>
                  <option value="manager">åº—é•¿</option>
                </select>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ç¡®è®¤å…¥èŒ</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- è°ƒåº—æ¨¡æ€æ¡† -->
    <div class="modal fade" id="transferModal" tabindex="-1" x-ref="transferModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-arrow-left-right"></i> å‘˜å·¥è°ƒåº—</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form @submit.prevent="submitTransfer">
              <div class="mb-3">
                <label class="form-label">å‘˜å·¥å§“å</label>
                <input type="text" class="form-control" :value="transferForm.staffName" readonly>
              </div>
              <div class="mb-3">
                <label class="form-label">å½“å‰é—¨åº—</label>
                <input type="text" class="form-control" :value="transferForm.currentStore" readonly>
              </div>
              <div class="mb-3">
                <label class="form-label">ç›®æ ‡é—¨åº— <span class="text-danger">*</span></label>
                <select class="form-select" x-model="transferForm.targetStoreId" required>
                  <option value="">è¯·é€‰æ‹©ç›®æ ‡é—¨åº—</option>
                  <template x-for="store in stores" :key="store.store_id">
                    <option :value="store.store_id" x-text="store.store_name"></option>
                  </template>
                </select>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-warning">ç¡®è®¤è°ƒåº—</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">åŠ è½½ä¸­...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script src="/admin/js/api-config.js"></script>
  <script src="/admin/js/alpine/init.js"></script>
  <script defer src="/admin/js/vendor/alpine.min.js"></script>
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('storeStaffPage', () => ({
        staffList: [],
        stores: [],
        filters: {
          storeId: '',
          role: '',
          status: '',
          search: '',
        },
        stats: {
          total: 0,
          active: 0,
          managers: 0,
          stores: 0,
        },
        form: {
          userId: '',
          storeId: '',
          role: 'staff',
        },
        transferForm: {
          userId: '',
          fromStoreId: '',
          staffName: '',
          currentStore: '',
          targetStoreId: '',
        },

        init() {
          this.loadStores();
          this.loadStaff();
        },

        async loadStores() {
          try {
            const response = await apiRequest(API_ENDPOINTS.STORE.LIST);
            if (response && response.success) {
              this.stores = response.data.items || [];
            }
          } catch (error) {
            console.error('åŠ è½½é—¨åº—å¤±è´¥:', error);
          }
        },

        async loadStaff() {
          showLoading();
          try {
            const params = new URLSearchParams();
            if (this.filters.storeId) params.append('store_id', this.filters.storeId);
            if (this.filters.role) params.append('role_in_store', this.filters.role);
            if (this.filters.status) params.append('status', this.filters.status);
            if (this.filters.search) params.append('search', this.filters.search);

            const url = API_ENDPOINTS.STAFF.LIST + (params.toString() ? `?${params.toString()}` : '');
            const response = await apiRequest(url);

            if (response && response.success) {
              this.staffList = response.data.staff || response.data || [];
              this.updateStats(response.data.stats || {});
            } else {
              this.showError('åŠ è½½å¤±è´¥', response?.message || 'è·å–å‘˜å·¥åˆ—è¡¨å¤±è´¥');
            }
          } catch (error) {
            console.error('åŠ è½½å‘˜å·¥å¤±è´¥:', error);
            this.showError('åŠ è½½å¤±è´¥', error.message);
          } finally {
            hideLoading();
          }
        },

        updateStats(apiStats) {
          this.stats.total = apiStats.total || this.staffList.length;
          this.stats.active = apiStats.active || this.staffList.filter(s => s.status === 'active').length;
          this.stats.managers = apiStats.managers || this.staffList.filter(s => s.role_in_store === 'manager').length;
          this.stats.stores = apiStats.stores || new Set(this.staffList.map(s => s.store_id)).size;
        },

        getInitials(name) {
          return name ? name.charAt(0).toUpperCase() : 'U';
        },

        formatDate(dateValue) {
          if (!dateValue) return '-';
          if (typeof dateValue === 'object') {
            if (dateValue.beijing) {
              return dateValue.beijing.split(' ')[0];
            }
            if (dateValue.iso) {
              return new Date(dateValue.iso).toLocaleDateString('zh-CN');
            }
          }
          if (typeof dateValue === 'string') {
            return new Date(dateValue).toLocaleDateString('zh-CN');
          }
          return '-';
        },

        openCreateModal() {
          this.form = { userId: '', storeId: '', role: 'staff' };
          new bootstrap.Modal(this.$refs.staffModal).show();
        },

        async submitStaff() {
          if (!this.form.userId || !this.form.storeId) {
            alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
            return;
          }

          showLoading();
          try {
            const response = await apiRequest(API_ENDPOINTS.STAFF.CREATE, {
              method: 'POST',
              body: JSON.stringify({
                user_id: parseInt(this.form.userId),
                store_id: parseInt(this.form.storeId),
                role_in_store: this.form.role
              })
            });

            if (response && response.success) {
              bootstrap.Modal.getInstance(this.$refs.staffModal).hide();
              alert('âœ… å‘˜å·¥å…¥èŒæˆåŠŸ');
              this.loadStaff();
            } else {
              this.showError('å…¥èŒå¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
            }
          } catch (error) {
            console.error('å‘˜å·¥å…¥èŒå¤±è´¥:', error);
            this.showError('å…¥èŒå¤±è´¥', error.message);
          } finally {
            hideLoading();
          }
        },

        openTransferModal(staff) {
          this.transferForm = {
            userId: staff.user_id,
            fromStoreId: staff.store_id,
            staffName: staff.user_nickname || '-',
            currentStore: staff.store_name || '-',
            targetStoreId: '',
          };
          new bootstrap.Modal(this.$refs.transferModal).show();
        },

        async submitTransfer() {
          if (!this.transferForm.targetStoreId) {
            alert('è¯·é€‰æ‹©ç›®æ ‡é—¨åº—');
            return;
          }

          showLoading();
          try {
            const response = await apiRequest(API_ENDPOINTS.STAFF.TRANSFER, {
              method: 'POST',
              body: JSON.stringify({
                user_id: parseInt(this.transferForm.userId),
                from_store_id: parseInt(this.transferForm.fromStoreId),
                to_store_id: parseInt(this.transferForm.targetStoreId)
              })
            });

            if (response && response.success) {
              bootstrap.Modal.getInstance(this.$refs.transferModal).hide();
              alert('âœ… è°ƒåº—æˆåŠŸ');
              this.loadStaff();
            } else {
              this.showError('è°ƒåº—å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
            }
          } catch (error) {
            console.error('è°ƒåº—å¤±è´¥:', error);
            this.showError('è°ƒåº—å¤±è´¥', error.message);
          } finally {
            hideLoading();
          }
        },

        async changeRole(staff) {
          const newRole = staff.role_in_store === 'manager' ? 'staff' : 'manager';
          const action = newRole === 'manager' ? 'å‡çº§ä¸ºåº—é•¿' : 'é™çº§ä¸ºå‘˜å·¥';

          if (!confirm(`ç¡®å®šè¦å°†æ­¤å‘˜å·¥${action}å—ï¼Ÿ`)) return;

          showLoading();
          try {
            const response = await apiRequest(API.buildURL(API_ENDPOINTS.STAFF.ROLE, { store_staff_id: staff.store_staff_id }), {
              method: 'PUT',
              body: JSON.stringify({ role_in_store: newRole })
            });

            if (response && response.success) {
              alert(`âœ… å·²${action}`);
              this.loadStaff();
            } else {
              this.showError('æ“ä½œå¤±è´¥', response?.message || 'è§’è‰²å˜æ›´å¤±è´¥');
            }
          } catch (error) {
            console.error('è§’è‰²å˜æ›´å¤±è´¥:', error);
            this.showError('æ“ä½œå¤±è´¥', error.message);
          } finally {
            hideLoading();
          }
        },

        async disableStaff(userId) {
          if (!confirm('ç¡®å®šè¦å°†æ­¤å‘˜å·¥è®¾ä¸ºç¦»èŒçŠ¶æ€å—ï¼Ÿ')) return;

          showLoading();
          try {
            const response = await apiRequest(API.buildURL(API_ENDPOINTS.STAFF.DISABLE, { user_id: userId }), {
              method: 'POST'
            });

            if (response && response.success) {
              alert('âœ… å‘˜å·¥å·²ç¦»èŒ');
              this.loadStaff();
            } else {
              this.showError('æ“ä½œå¤±è´¥', response?.message || 'ç¦»èŒå¤„ç†å¤±è´¥');
            }
          } catch (error) {
            console.error('ç¦»èŒå¤„ç†å¤±è´¥:', error);
            this.showError('æ“ä½œå¤±è´¥', error.message);
          } finally {
            hideLoading();
          }
        },

        async enableStaff(userId, storeId) {
          if (!confirm('ç¡®å®šè¦æ¢å¤æ­¤å‘˜å·¥çš„åœ¨èŒçŠ¶æ€å—ï¼Ÿ')) return;

          showLoading();
          try {
            const response = await apiRequest(API_ENDPOINTS.STAFF.ENABLE, {
              method: 'POST',
              body: JSON.stringify({ user_id: userId, store_id: storeId })
            });

            if (response && response.success) {
              alert('âœ… å‘˜å·¥å·²å¤èŒ');
              this.loadStaff();
            } else {
              this.showError('æ“ä½œå¤±è´¥', response?.message || 'å¤èŒå¤„ç†å¤±è´¥');
            }
          } catch (error) {
            console.error('å¤èŒå¤„ç†å¤±è´¥:', error);
            this.showError('æ“ä½œå¤±è´¥', error.message);
          } finally {
            hideLoading();
          }
        },

        showError(title, message) {
          alert(`âŒ ${title}\n${message}`);
        }
      }));
    });
  </script>
</body>
</html>
