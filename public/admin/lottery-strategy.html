<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>策略引擎配置 - 管理后台</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">
  <style>
    .strategy-card {
      border-left: 4px solid #0d6efd;
      transition: all 0.3s ease;
    }
    .strategy-card:hover {
      border-left-color: #0056b3;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .strategy-card.budget_tier { border-left-color: #28a745; }
    .strategy-card.pity { border-left-color: #ffc107; }
    .strategy-card.luck_debt { border-left-color: #dc3545; }
    .strategy-card.anti_empty { border-left-color: #17a2b8; }
    .config-value {
      font-family: 'Consolas', monospace;
      background: #f8f9fa;
      padding: 2px 6px;
      border-radius: 4px;
    }
    .group-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
  </style>

  <!-- Alpine.js -->
  <script defer src="/admin/js/alpine/init.js"></script>
  <script defer src="/admin/js/vendor/alpine.min.js"></script>

  <style>
    [x-cloak] { display: none !important; }
  </style>
</head>
<body class="bg-light" x-data="lotteryStrategyPage()" x-cloak>
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>⚙️ 管理后台 - 策略引擎配置
      </a>
      <div>
        <span class="text-light me-3" x-text="'欢迎，' + (userInfo.nickname || '管理员')">欢迎，管理员</span>
        <button class="btn btn-outline-light btn-sm" @click="logout">退出登录</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- 统计卡片 -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-sliders text-primary" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">策略配置总数</h6>
            <h2 class="text-primary mb-0" x-text="stats.totalStrategies">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">已生效配置</h6>
            <h2 class="text-success mb-0" x-text="stats.activeStrategies">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-grid-3x3 text-warning" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">矩阵配置数</h6>
            <h2 class="text-warning mb-0" x-text="stats.matrixCount">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-layers text-info" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">档位规则数</h6>
            <h2 class="text-info mb-0" x-text="stats.tierRulesCount">-</h2>
          </div>
        </div>
      </div>
    </div>

    <!-- 选项卡 -->
    <ul class="nav nav-tabs mb-4" id="strategyTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="strategies-tab" data-bs-toggle="tab" data-bs-target="#strategies" type="button">
          <i class="bi bi-sliders"></i> 策略参数
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="matrix-tab" data-bs-toggle="tab" data-bs-target="#matrix" type="button">
          <i class="bi bi-grid-3x3"></i> BxPx矩阵
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tiers-tab" data-bs-toggle="tab" data-bs-target="#tiers" type="button">
          <i class="bi bi-layers"></i> 档位规则
        </button>
      </li>
    </ul>

    <div class="tab-content" id="strategyTabContent">
      <!-- 策略参数配置 -->
      <div class="tab-pane fade show active" id="strategies" role="tabpanel">
        <template x-if="loading">
          <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">加载中...</span>
            </div>
          </div>
        </template>
        
        <template x-if="!loading && Object.keys(strategyGroups).length === 0">
          <div class="text-center py-5 text-muted">
            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
            <p class="mt-2">暂无策略配置</p>
          </div>
        </template>
        
        <template x-for="(configs, group) in strategyGroups" :key="group">
          <div class="mb-4">
            <div class="group-header">
              <i :class="'bi ' + getGroupIcon(group) + ' me-2'"></i>
              <span x-text="getGroupName(group) + ' (' + configs.length + '项)'"></span>
            </div>
            <div class="row g-3">
              <template x-for="config in configs" :key="config.strategy_config_id">
                <div class="col-md-6 col-lg-4">
                  <div class="card strategy-card" :class="group">
                    <div class="card-body">
                      <h6 class="card-title" x-text="config.config_key"></h6>
                      <p class="text-muted small mb-2" x-text="config.description || '暂无描述'"></p>
                      <div class="d-flex justify-content-between align-items-center">
                        <span class="config-value" x-text="config.config_value"></span>
                        <button class="btn btn-sm btn-outline-primary" @click="viewStrategyDetail(config.strategy_config_id)">
                          <i class="bi bi-eye"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
            </div>
        </div>
        </template>
      </div>

      <!-- BxPx矩阵配置 -->
      <div class="tab-pane fade" id="matrix" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <i class="bi bi-grid-3x3"></i> BxPx矩阵配置 (Budget Tier × Pressure Tier)
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-bordered text-center">
                <thead class="table-dark">
                  <tr>
                    <th>Budget \ Pressure</th>
                    <th>P0 (无压力)</th>
                    <th>P1 (低压力)</th>
                    <th>P2 (高压力)</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="bt in budgetTiers" :key="bt">
                    <tr>
                      <td class="table-secondary"><strong x-text="bt"></strong></td>
                      <template x-for="pt in pressureTiers" :key="pt">
                        <td>
                          <template x-if="getMatrixConfig(bt, pt)">
                            <div class="small">
                              <div>Cap乘数: <span class="text-primary" x-text="getMatrixConfig(bt, pt).cap_multiplier"></span></div>
                              <div>空奖权重: <span class="text-danger" x-text="getMatrixConfig(bt, pt).empty_weight_multiplier"></span></div>
                              <template x-if="getMatrixConfig(bt, pt).description">
                                <div class="text-muted" x-text="getMatrixConfig(bt, pt).description"></div>
                              </template>
                            </div>
                          </template>
                          <template x-if="!getMatrixConfig(bt, pt)">
                            <span class="text-muted">-</span>
                          </template>
                        </td>
                      </template>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- 档位规则 -->
      <div class="tab-pane fade" id="tiers" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <i class="bi bi-layers"></i> 抽奖档位规则
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>规则ID</th>
                    <th>用户分层</th>
                    <th>档位名称</th>
                    <th>权重</th>
                    <th>概率</th>
                    <th>关联活动</th>
                    <th>状态</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-if="tierRules.length === 0">
                    <tr><td colspan="7" class="text-center text-muted">暂无档位规则</td></tr>
                  </template>
                  <template x-for="rule in tierRules" :key="rule.tier_rule_id">
                    <tr>
                      <td x-text="rule.tier_rule_id"></td>
                      <td><code x-text="rule.segment_key || '-'"></code></td>
                      <td><span class="badge bg-info" x-text="rule.tier_name || '-'"></span></td>
                      <td x-text="rule.tier_weight || 0"></td>
                      <td x-text="rule.probability || '-'"></td>
                      <td x-text="rule.campaign?.campaign_name || '-'"></td>
                      <td>
                        <span class="badge" 
                              :class="rule.status === 'active' ? 'bg-success' : 'bg-secondary'"
                              x-text="rule.status === 'active' ? '启用' : '禁用'"></span>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 策略详情模态框 -->
  <div class="modal fade" id="strategyDetailModal" tabindex="-1" x-ref="detailModal">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-gear"></i> 策略配置详情</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <template x-if="selectedConfig">
            <table class="table table-bordered">
              <tr><th style="width:30%">配置ID</th><td x-text="selectedConfig.strategy_config_id"></td></tr>
              <tr><th>配置键</th><td><code x-text="selectedConfig.config_key"></code></td></tr>
              <tr><th>配置值</th><td><span class="config-value" x-text="selectedConfig.config_value"></span></td></tr>
              <tr><th>数据类型</th><td x-text="selectedConfig.value_type || 'string'"></td></tr>
              <tr><th>配置分组</th><td x-text="selectedConfig.config_group || '-'"></td></tr>
              <tr><th>描述</th><td x-text="selectedConfig.description || '-'"></td></tr>
              <tr><th>是否启用</th><td x-text="selectedConfig.is_active ? '✅ 启用' : '❌ 禁用'"></td></tr>
              <tr><th>优先级</th><td x-text="selectedConfig.priority || 0"></td></tr>
              <tr><th>生效开始时间</th><td x-text="selectedConfig.effective_start ? formatDateTime(selectedConfig.effective_start) : '立即生效'"></td></tr>
              <tr><th>生效结束时间</th><td x-text="selectedConfig.effective_end ? formatDateTime(selectedConfig.effective_end) : '永不过期'"></td></tr>
              <tr><th>创建时间</th><td x-text="formatDateTime(selectedConfig.created_at)"></td></tr>
              <tr><th>更新时间</th><td x-text="formatDateTime(selectedConfig.updated_at)"></td></tr>
            </table>
          </template>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
        </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" :class="{ 'show': loading }">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">加载中...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script src="/admin/js/api-config.js"></script>
  <script src="/admin/js/pages/lottery-strategy.js"></script>
  
  <!-- Alpine.js -->
  <!-- Alpine.js -->
</body>
</html>
