<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¼šè¯ç®¡ç† - ç®¡ç†åå°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">
  <style>
    .session-card {
      border-left: 4px solid;
      transition: all 0.3s ease;
    }
    .session-card:hover {
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .session-card.active { border-left-color: #198754; }
    .session-card.expired { border-left-color: #dc3545; }
    .session-card.revoked { border-left-color: #6c757d; }
    .device-icon {
      font-size: 1.5rem;
      opacity: 0.7;
    }
    .session-info {
      font-size: 0.85rem;
    }
    .current-session {
      background: #d1e7dd !important;
    }
  </style>

  <!-- Alpine.js -->
  <script defer src="/admin/js/alpine/init.js"></script>
  <script defer src="/admin/js/vendor/alpine.min.js"></script>

  <style>
    [x-cloak] { display: none !important; }
  </style>
</head>
<body class="bg-light" x-data="sessionsPage()" x-cloak>
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ” ç®¡ç†åå° - ä¼šè¯ç®¡ç†
      </a>
      <div>
        <span class="text-light me-3" x-text="userInfo ? `æ¬¢è¿ï¼Œ${userInfo.nickname}` : 'æ¬¢è¿ï¼Œç®¡ç†å‘˜'"></span>
        <button class="btn btn-outline-light btn-sm" @click="logout()">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-people text-primary" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">åœ¨çº¿ç”¨æˆ·</h6>
            <h2 class="text-primary mb-0" x-text="statistics.onlineUsers"></h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-link-45deg text-success" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">æ´»è·ƒä¼šè¯</h6>
            <h2 class="text-success mb-0" x-text="statistics.activeSessions"></h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-person text-warning" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">ç”¨æˆ·ä¼šè¯</h6>
            <h2 class="text-warning mb-0" x-text="statistics.userSessions"></h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-shield-check text-info" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">ç®¡ç†å‘˜ä¼šè¯</h6>
            <h2 class="text-info mb-0" x-text="statistics.adminSessions"></h2>
          </div>
        </div>
      </div>
    </div>

    <!-- ç­›é€‰æ  -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-center">
          <div class="col-md-2">
            <label class="form-label">çŠ¶æ€</label>
            <select class="form-select" x-model="filters.status">
              <option value="">å…¨éƒ¨çŠ¶æ€</option>
              <option value="active">æ´»è·ƒ</option>
              <option value="expired">å·²è¿‡æœŸ/å¤±æ•ˆ</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">ç”¨æˆ·ç±»å‹</label>
            <select class="form-select" x-model="filters.userType">
              <option value="">å…¨éƒ¨ç±»å‹</option>
              <option value="user">æ™®é€šç”¨æˆ·</option>
              <option value="admin">ç®¡ç†å‘˜</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">ç”¨æˆ·ID</label>
            <input type="number" class="form-control" x-model="filters.userId" placeholder="è¾“å…¥ç”¨æˆ·ID...">
          </div>
          <div class="col-md-3">
            <label class="form-label">æ’åºæ–¹å¼</label>
            <select class="form-select" x-model="filters.sortBy">
              <option value="last_activity">æœ€åæ´»åŠ¨æ—¶é—´</option>
              <option value="created_at">åˆ›å»ºæ—¶é—´</option>
              <option value="expires_at">è¿‡æœŸæ—¶é—´</option>
            </select>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-primary me-2" @click="loadSessions()">
              <i class="bi bi-search"></i> æœç´¢
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- æ‰¹é‡æ“ä½œ -->
    <div class="card mb-4">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <button class="btn btn-outline-danger me-2" @click="revokeSelected()">
            <i class="bi bi-x-circle"></i> æ’¤é”€é€‰ä¸­
          </button>
          <button class="btn btn-outline-warning me-2" @click="revokeExpired()">
            <i class="bi bi-clock-history"></i> æ¸…ç†è¿‡æœŸ
          </button>
          <button class="btn btn-outline-secondary" @click="revokeAllExceptCurrent()">
            <i class="bi bi-trash"></i> å¼ºåˆ¶ä¸‹çº¿å…¶ä»–è®¾å¤‡
          </button>
        </div>
        <button class="btn btn-outline-primary" @click="loadSessions()">
          <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
        </button>
      </div>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <template x-if="loading">
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">åŠ è½½ä¸­...</span>
        </div>
        <p class="mt-2 text-muted">æ­£åœ¨åŠ è½½ä¼šè¯æ•°æ®...</p>
      </div>
    </template>

    <!-- ä¼šè¯åˆ—è¡¨ -->
    <div class="row" x-show="!loading">
      <!-- ç©ºçŠ¶æ€ -->
      <template x-if="sessions.length === 0 && !loading">
        <div class="col-12">
          <div class="card">
            <div class="card-body text-center py-5 text-muted">
              <i class="bi bi-link-45deg" style="font-size: 3rem;"></i>
              <p class="mt-2">æš‚æ— ä¼šè¯æ•°æ®</p>
            </div>
          </div>
        </div>
      </template>

      <!-- ä¼šè¯å¡ç‰‡ -->
      <template x-for="session in sessions" :key="session.user_session_id || session.session_id">
        <div class="col-md-6 col-lg-4 mb-4">
          <div 
            class="card session-card h-100"
            :class="[getSessionStatus(session), isCurrentSession(session) ? 'current-session' : '']"
          >
            <div class="card-body">
              <div class="d-flex align-items-start">
                <div class="form-check me-3">
                  <input 
                    type="checkbox" 
                    class="form-check-input session-checkbox" 
                    :value="session.user_session_id || session.session_id"
                    :disabled="isCurrentSession(session)"
                    x-model="selectedSessions"
                  >
                </div>
                <div class="device-icon me-3">
                  <i class="bi" :class="session.user_type === 'admin' ? 'bi-shield-check' : 'bi-person'"></i>
                </div>
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between">
                    <h6 class="mb-1">
                      ç”¨æˆ· <span x-text="session.user_id"></span>
                      <span x-show="isCurrentSession(session)" class="badge bg-primary ms-2">å½“å‰ä¼šè¯</span>
                    </h6>
                    <span 
                      class="badge"
                      :class="getStatusBadgeClass(getSessionStatus(session))"
                      x-text="getStatusLabel(getSessionStatus(session))"
                    ></span>
                  </div>
                  <p class="session-info text-muted mb-1">
                    <i class="bi bi-globe"></i> <span x-text="session.login_ip || session.ip_address || '-'"></span>
                  </p>
                  <p class="session-info text-muted mb-1">
                    <i class="bi bi-person-badge"></i> <span x-text="session.user_type === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'"></span>
                  </p>
                  <p class="session-info text-muted mb-0">
                    <i class="bi bi-clock"></i> æœ€åæ´»åŠ¨ï¼š<span x-text="formatRelativeTime(session.last_activity || session.last_active_at)"></span>
                  </p>
                </div>
              </div>
            </div>
            <div class="card-footer bg-white d-flex justify-content-between">
              <small class="text-muted">åˆ›å»ºï¼š<span x-text="formatDateTime(session.created_at)"></span></small>
              <div>
                <button class="btn btn-sm btn-outline-primary me-1" @click="viewSessionDetail(session)">
                  <i class="bi bi-eye"></i>
                </button>
                <button 
                  x-show="!isCurrentSession(session) && getSessionStatus(session) === 'active'"
                  class="btn btn-sm btn-outline-danger" 
                  @click="revokeSession(session.user_session_id || session.session_id)"
                >
                  <i class="bi bi-x-lg"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </template>
    </div>

    <!-- åˆ†é¡µ -->
    <nav aria-label="Page navigation" class="mt-4" x-show="totalPages > 1">
      <ul class="pagination justify-content-center">
        <li class="page-item" :class="{ 'disabled': currentPage === 1 }">
          <a class="page-link" href="#" @click.prevent="loadSessions(currentPage - 1)">ä¸Šä¸€é¡µ</a>
        </li>
        <template x-for="page in getPaginationPages()" :key="page">
          <li class="page-item" :class="{ 'active': page === currentPage, 'disabled': page === '...' }">
            <a class="page-link" href="#" @click.prevent="page !== '...' && loadSessions(page)" x-text="page"></a>
          </li>
        </template>
        <li class="page-item" :class="{ 'disabled': currentPage === totalPages }">
          <a class="page-link" href="#" @click.prevent="loadSessions(currentPage + 1)">ä¸‹ä¸€é¡µ</a>
        </li>
      </ul>
    </nav>
  </div>

  <!-- ä¼šè¯è¯¦æƒ…æ¨¡æ€æ¡† -->
  <div class="modal fade" id="sessionDetailModal" tabindex="-1" x-ref="sessionDetailModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-info-circle"></i> ä¼šè¯è¯¦æƒ…</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" x-show="selectedSession">
          <table class="table table-sm">
            <tr><th style="width:35%">ä¼šè¯ID</th><td><code x-text="selectedSession?.user_session_id || selectedSession?.session_id"></code></td></tr>
            <tr><th>ç”¨æˆ·ID</th><td x-text="selectedSession?.user_id"></td></tr>
            <tr><th>ç”¨æˆ·æ˜µç§°</th><td x-text="selectedSession?.user_info?.nickname || '-'"></td></tr>
            <tr><th>ç”¨æˆ·ç±»å‹</th><td x-text="selectedSession?.user_type === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'"></td></tr>
            <tr><th>çŠ¶æ€</th><td><span class="badge" :class="getStatusBadgeClass(getSessionStatus(selectedSession))" x-text="getStatusLabel(getSessionStatus(selectedSession))"></span></td></tr>
            <tr><th>IPåœ°å€</th><td x-text="selectedSession?.login_ip || selectedSession?.ip_address || '-'"></td></tr>
            <tr><th>æ˜¯å¦è¿‡æœŸ</th><td x-text="selectedSession?.is_expired ? 'æ˜¯' : 'å¦'"></td></tr>
            <tr><th>æ˜¯å¦æœ‰æ•ˆ</th><td x-text="selectedSession?.is_valid ? 'æ˜¯' : 'å¦'"></td></tr>
            <tr><th>åˆ›å»ºæ—¶é—´</th><td x-text="formatDateTime(selectedSession?.created_at)"></td></tr>
            <tr><th>æœ€åæ´»åŠ¨</th><td x-text="formatDateTime(selectedSession?.last_activity || selectedSession?.last_active_at)"></td></tr>
            <tr><th>è¿‡æœŸæ—¶é—´</th><td x-text="formatDateTime(selectedSession?.expires_at)"></td></tr>
          </table>
          <div x-show="isCurrentSession(selectedSession)" class="alert alert-info mb-0">
            <i class="bi bi-info-circle"></i> è¿™æ˜¯æ‚¨å½“å‰çš„ä¼šè¯ï¼Œæ— æ³•æ’¤é”€
          </div>
        </div>
        <div class="modal-footer">
          <button 
            type="button" 
            class="btn btn-danger"
            x-show="selectedSession && !isCurrentSession(selectedSession) && getSessionStatus(selectedSession) === 'active'"
            @click="revokeSessionFromModal()"
          >æ’¤é”€ä¼šè¯</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
        </div>
      </div>
    </div>
  </div>

  <!-- å…¨å±€åŠ è½½é®ç½© -->
  <div class="loading-overlay" x-show="globalLoading" x-cloak>
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">åŠ è½½ä¸­...</span>
    </div>
  </div>

  <!-- âœ… JavaScript åŠ è½½é¡ºåº -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script src="/admin/js/api-config.js"></script>
  <script src="/admin/js/pages/sessions.js"></script>
  <!-- Alpine.js -->
</body>
</html>
