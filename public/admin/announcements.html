<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…¬å‘Šç®¡ç† - ç®¡ç†åå°</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">
</head>
<body class="bg-light">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ“¢ ç³»ç»Ÿå…¬å‘Šç®¡ç†
      </a>
      <div>
        <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- æ“ä½œæŒ‰é’® -->
    <div class="d-flex justify-content-between mb-3">
      <h5><i class="bi bi-megaphone"></i> å…¬å‘Šåˆ—è¡¨</h5>
      <button class="btn btn-primary" id="addAnnouncementBtn">
        <i class="bi bi-plus-lg"></i> å‘å¸ƒæ–°å…¬å‘Š
      </button>
    </div>

    <!-- ç­›é€‰åŒºåŸŸ -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">å…¬å‘ŠçŠ¶æ€</label>
            <select class="form-select" id="statusFilter">
              <option value="">å…¨éƒ¨çŠ¶æ€</option>
              <option value="active">å·²å‘å¸ƒ</option>
              <option value="inactive">å·²ä¸‹çº¿</option>
              <option value="draft">è‰ç¨¿</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">å…¬å‘Šç±»å‹</label>
            <select class="form-select" id="typeFilter">
              <option value="">å…¨éƒ¨ç±»å‹</option>
              <option value="notice">é€šçŸ¥</option>
              <option value="activity">æ´»åŠ¨</option>
              <option value="update">æ›´æ–°</option>
              <option value="warning">è­¦å‘Š</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">å…³é”®è¯æœç´¢</label>
            <input type="text" class="form-control" id="keywordSearch" placeholder="æœç´¢æ ‡é¢˜æˆ–å†…å®¹">
          </div>
          <div class="col-md-3">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-primary w-100" id="searchBtn">
              <i class="bi bi-search"></i> æŸ¥è¯¢
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- å…¬å‘Šåˆ—è¡¨ -->
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th style="width: 60px;">ID</th>
                <th>æ ‡é¢˜</th>
                <th>ç±»å‹</th>
                <th>çŠ¶æ€</th>
                <th>æ’åº</th>
                <th>å‘å¸ƒæ—¶é—´</th>
                <th>è¿‡æœŸæ—¶é—´</th>
                <th style="width: 200px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="announcementsTableBody">
              <tr>
                <td colspan="8" class="text-center py-5">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                  </div>
                  <p class="mt-2 text-muted">æ­£åœ¨åŠ è½½æ•°æ®...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- åˆ†é¡µ -->
        <nav aria-label="åˆ†é¡µ" class="mt-3">
          <ul class="pagination justify-content-end" id="pagination"></ul>
        </nav>
      </div>
    </div>
  </div>

  <!-- æ–°å¢/ç¼–è¾‘å…¬å‘Šæ¨¡æ€æ¡† -->
  <div class="modal fade" id="announcementModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">
            <i class="bi bi-megaphone"></i> å‘å¸ƒæ–°å…¬å‘Š
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="announcementId">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">å…¬å‘Šæ ‡é¢˜ <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="announcementTitle" placeholder="è¯·è¾“å…¥å…¬å‘Šæ ‡é¢˜" maxlength="100" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">å…¬å‘Šç±»å‹ <span class="text-danger">*</span></label>
              <select class="form-select" id="announcementType" required>
                <option value="notice">é€šçŸ¥</option>
                <option value="activity">æ´»åŠ¨</option>
                <option value="update">æ›´æ–°</option>
                <option value="warning">è­¦å‘Š</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">å…¬å‘ŠçŠ¶æ€ <span class="text-danger">*</span></label>
              <select class="form-select" id="announcementStatus" required>
                <option value="draft">è‰ç¨¿</option>
                <option value="active">å‘å¸ƒ</option>
                <option value="inactive">ä¸‹çº¿</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">å…¬å‘Šå†…å®¹ <span class="text-danger">*</span></label>
              <textarea class="form-control" id="announcementContent" rows="6" placeholder="è¯·è¾“å…¥å…¬å‘Šå†…å®¹" required></textarea>
            </div>
            <div class="col-md-4">
              <label class="form-label">æ’åºæƒé‡</label>
              <input type="number" class="form-control" id="announcementSort" value="0" min="0">
              <small class="text-muted">æ•°å­—è¶Šå¤§è¶Šé å‰</small>
            </div>
            <div class="col-md-4">
              <label class="form-label">ç”Ÿæ•ˆæ—¶é—´</label>
              <input type="datetime-local" class="form-control" id="startTime">
            </div>
            <div class="col-md-4">
              <label class="form-label">è¿‡æœŸæ—¶é—´</label>
              <input type="datetime-local" class="form-control" id="endTime">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" id="submitAnnouncementBtn">
            <i class="bi bi-check-lg"></i> ä¿å­˜
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- åŠ è½½é®ç½©å±‚ -->
  <div class="loading-overlay" id="loadingOverlay" style="display:none;">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">å¤„ç†ä¸­...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/admin-common.js"></script>

  <script>
    // å…¨å±€å˜é‡
    let currentPage = 1;
    const pageSize = 20;
    let editingId = null;
    let announcementModal = null;

    // é¡µé¢åŠ è½½
    document.addEventListener('DOMContentLoaded', function() {
      checkAuth();
      announcementModal = new bootstrap.Modal(document.getElementById('announcementModal'));
      loadAnnouncements();
      bindEvents();
    });

    // æƒé™æ£€æŸ¥
    function checkAuth() {
      const token = getToken();
      if (!token) {
        window.location.href = '/admin/login.html';
        return false;
      }
      checkAdminPermission();
      return true;
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
      document.getElementById('logoutBtn').addEventListener('click', logout);
      document.getElementById('searchBtn').addEventListener('click', handleSearch);
      document.getElementById('addAnnouncementBtn').addEventListener('click', openAddModal);
      document.getElementById('submitAnnouncementBtn').addEventListener('click', handleSubmit);
    }

    // å¤„ç†æœç´¢
    function handleSearch() {
      currentPage = 1;
      loadAnnouncements();
    }

    // åŠ è½½å…¬å‘Šåˆ—è¡¨
    async function loadAnnouncements() {
      try {
        showLoading(true);
        
        const status = document.getElementById('statusFilter').value;
        const type = document.getElementById('typeFilter').value;
        const keyword = document.getElementById('keywordSearch').value.trim();
        
        const params = new URLSearchParams({
          page: currentPage,
          page_size: pageSize
        });
        
        if (status) params.append('status', status);
        if (type) params.append('type', type);
        if (keyword) params.append('keyword', keyword);
        
        const response = await apiRequest(`/api/v4/console/system/announcements?${params}`);
        
        if (response && response.success) {
          renderAnnouncements(response.data.announcements || response.data.list || []);
          renderPagination(response.data.pagination);
        } else {
          showError(response?.message || 'åŠ è½½å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½å…¬å‘Šåˆ—è¡¨å¤±è´¥', error);
        showError('åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        showLoading(false);
      }
    }

    // æ¸²æŸ“å…¬å‘Šåˆ—è¡¨
    function renderAnnouncements(announcements) {
      const tbody = document.getElementById('announcementsTableBody');
      
      if (!announcements || announcements.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>';
        return;
      }
      
      tbody.innerHTML = announcements.map(item => {
        const statusBadge = getStatusBadge(item.status);
        const typeBadge = getTypeBadge(item.type || item.announcement_type);
        
        return `
          <tr>
            <td>${item.announcement_id || item.id}</td>
            <td>
              <div class="fw-bold">${escapeHtml(item.title)}</div>
              <small class="text-muted">${escapeHtml((item.content || '').substring(0, 50))}...</small>
            </td>
            <td>${typeBadge}</td>
            <td>${statusBadge}</td>
            <td>${item.sort_order || 0}</td>
            <td>${formatDate(item.start_time || item.created_at)}</td>
            <td>${item.end_time ? formatDate(item.end_time) : '<span class="text-muted">æ°¸ä¹…</span>'}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="editAnnouncement(${item.announcement_id || item.id})">
                <i class="bi bi-pencil"></i> ç¼–è¾‘
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteAnnouncement(${item.announcement_id || item.id})">
                <i class="bi bi-trash"></i> åˆ é™¤
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // æ‰“å¼€æ–°å¢æ¨¡æ€æ¡†
    function openAddModal() {
      editingId = null;
      document.getElementById('modalTitle').innerHTML = '<i class="bi bi-megaphone"></i> å‘å¸ƒæ–°å…¬å‘Š';
      document.getElementById('announcementId').value = '';
      document.getElementById('announcementTitle').value = '';
      document.getElementById('announcementType').value = 'notice';
      document.getElementById('announcementStatus').value = 'draft';
      document.getElementById('announcementContent').value = '';
      document.getElementById('announcementSort').value = '0';
      document.getElementById('startTime').value = '';
      document.getElementById('endTime').value = '';
      announcementModal.show();
    }

    // ç¼–è¾‘å…¬å‘Š
    async function editAnnouncement(id) {
      try {
        showLoading(true);
        const response = await apiRequest(`/api/v4/console/system/announcements/${id}`);
        
        if (response && response.success) {
          const item = response.data.announcement || response.data;
          editingId = id;
          document.getElementById('modalTitle').innerHTML = '<i class="bi bi-pencil"></i> ç¼–è¾‘å…¬å‘Š';
          document.getElementById('announcementId').value = id;
          document.getElementById('announcementTitle').value = item.title || '';
          document.getElementById('announcementType').value = item.type || item.announcement_type || 'notice';
          document.getElementById('announcementStatus').value = item.status || 'draft';
          document.getElementById('announcementContent').value = item.content || '';
          document.getElementById('announcementSort').value = item.sort_order || 0;
          
          // å¤„ç†æ—¶é—´å­—æ®µ
          if (item.start_time) {
            document.getElementById('startTime').value = formatDateTimeLocal(item.start_time);
          }
          if (item.end_time) {
            document.getElementById('endTime').value = formatDateTimeLocal(item.end_time);
          }
          
          announcementModal.show();
        } else {
          showError(response?.message || 'è·å–å…¬å‘Šè¯¦æƒ…å¤±è´¥');
        }
      } catch (error) {
        console.error('è·å–å…¬å‘Šè¯¦æƒ…å¤±è´¥', error);
        showError('è·å–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        showLoading(false);
      }
    }

    // æäº¤è¡¨å•
    async function handleSubmit() {
      const title = document.getElementById('announcementTitle').value.trim();
      const type = document.getElementById('announcementType').value;
      const status = document.getElementById('announcementStatus').value;
      const content = document.getElementById('announcementContent').value.trim();
      const sortOrder = parseInt(document.getElementById('announcementSort').value) || 0;
      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;
      
      if (!title) {
        showError('è¯·è¾“å…¥å…¬å‘Šæ ‡é¢˜');
        return;
      }
      if (!content) {
        showError('è¯·è¾“å…¥å…¬å‘Šå†…å®¹');
        return;
      }
      
      try {
        showLoading(true);
        
        const payload = {
          title,
          type,
          status,
          content,
          sort_order: sortOrder,
          start_time: startTime || null,
          end_time: endTime || null
        };
        
        let response;
        if (editingId) {
          response = await apiRequest(`/api/v4/console/system/announcements/${editingId}`, {
            method: 'PUT',
            body: JSON.stringify(payload)
          });
        } else {
          response = await apiRequest('/api/v4/console/system/announcements', {
            method: 'POST',
            body: JSON.stringify(payload)
          });
        }
        
        if (response && response.success) {
          showSuccess(editingId ? 'æ›´æ–°æˆåŠŸ' : 'å‘å¸ƒæˆåŠŸ');
          announcementModal.hide();
          loadAnnouncements();
        } else {
          showError(response?.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        console.error('ä¿å­˜å…¬å‘Šå¤±è´¥', error);
        showError('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        showLoading(false);
      }
    }

    // åˆ é™¤å…¬å‘Š
    async function deleteAnnouncement(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å…¬å‘Šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        return;
      }
      
      try {
        showLoading(true);
        const response = await apiRequest(`/api/v4/console/system/announcements/${id}`, {
          method: 'DELETE'
        });
        
        if (response && response.success) {
          showSuccess('åˆ é™¤æˆåŠŸ');
          loadAnnouncements();
        } else {
          showError(response?.message || 'åˆ é™¤å¤±è´¥');
        }
      } catch (error) {
        console.error('åˆ é™¤å…¬å‘Šå¤±è´¥', error);
        showError('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        showLoading(false);
      }
    }

    // æ¸²æŸ“åˆ†é¡µ
    function renderPagination(pagination) {
      const paginationEl = document.getElementById('pagination');
      if (!pagination || pagination.total_pages <= 1) {
        paginationEl.innerHTML = '';
        return;
      }
      
      let html = '';
      for (let i = 1; i <= pagination.total_pages; i++) {
        html += `
          <li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
          </li>
        `;
      }
      paginationEl.innerHTML = html;
    }

    function changePage(page) {
      currentPage = page;
      loadAnnouncements();
    }

    // å·¥å…·å‡½æ•°
    function getStatusBadge(status) {
      const map = {
        'active': '<span class="badge bg-success">å·²å‘å¸ƒ</span>',
        'inactive': '<span class="badge bg-secondary">å·²ä¸‹çº¿</span>',
        'draft': '<span class="badge bg-warning">è‰ç¨¿</span>'
      };
      return map[status] || `<span class="badge bg-secondary">${status}</span>`;
    }

    function getTypeBadge(type) {
      const map = {
        'notice': '<span class="badge bg-info">é€šçŸ¥</span>',
        'activity': '<span class="badge bg-success">æ´»åŠ¨</span>',
        'update': '<span class="badge bg-primary">æ›´æ–°</span>',
        'warning': '<span class="badge bg-danger">è­¦å‘Š</span>'
      };
      return map[type] || `<span class="badge bg-secondary">${type}</span>`;
    }

    function formatDateTimeLocal(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toISOString().slice(0, 16);
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showLoading(show) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    function showSuccess(message) {
      alert(message);
    }

    function showError(message) {
      alert(message);
    }
  </script>
</body>
</html>

