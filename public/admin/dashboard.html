<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ•°æ®ä»ªè¡¨ç›˜ - ç®¡ç†åå°</title>
  
  <!-- âœ… Bootstrap 5 - UIæ¡†æ¶ -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- âœ… Bootstrap Icons - å›¾æ ‡åº“ -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- âœ… å…¬å…±æ ·å¼è¡¨ - ç»Ÿä¸€ä¸»é¢˜å’Œå“åº”å¼è®¾è®¡ -->
  <link href="/admin/css/common.css" rel="stylesheet">
</head>
<body class="bg-light">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <span class="navbar-brand">ğŸ“Š ç®¡ç†åå° - æ•°æ®ä»ªè¡¨ç›˜</span>
      <div>
        <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>
  
  <div class="container mt-4">
    <h4 class="mb-3">ä»Šæ—¥æ•°æ®æ¦‚è§ˆ</h4>
    
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h6 class="text-muted">æ€»ç”¨æˆ·æ•°</h6>
            <h2 id="totalUsers" class="text-primary">-</h2>
            <small class="text-success">ä»Šæ—¥æ–°å¢: <span id="todayNewUsers">-</span></small>
          </div>
        </div>
      </div>
      
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h6 class="text-muted">ä»Šæ—¥æŠ½å¥–</h6>
            <h2 id="todayDraws" class="text-success">-</h2>
            <small class="text-info">ä¸­å¥–: <span id="todayWins">-</span></small>
          </div>
        </div>
      </div>
      
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h6 class="text-muted">ä¸­å¥–ç‡</h6>
            <h2 id="winRate" class="text-warning">-</h2>
            <small class="text-secondary">æ¶ˆè€—ç§¯åˆ†: <span id="points">-</span></small>
          </div>
        </div>
      </div>
      
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h6 class="text-muted">å®¢æœä¼šè¯</h6>
            <h2 id="sessions" class="text-danger">-</h2>
            <small class="text-muted">æ¶ˆæ¯æ•°: <span id="messages">-</span></small>
          </div>
        </div>
      </div>
    </div>
    
    <!-- å¿«é€Ÿå¯¼èˆª -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">
              <i class="bi bi-lightning-fill"></i> å¿«é€Ÿæ“ä½œ
            </h5>
            
            <!-- P0 - æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½ -->
            <div class="mb-3">
              <h6 class="text-muted mb-2">
                <span class="badge bg-danger me-2">P0</span>æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½
              </h6>
              <div class="row g-2">
                <div class="col-md-3 col-sm-6">
                  <a href="/admin/consumption.html" class="btn btn-outline-primary w-100">
                    <i class="bi bi-clipboard-check"></i> æ¶ˆè´¹è®°å½•å®¡æ ¸
                  </a>
                </div>
                <div class="col-md-3 col-sm-6">
                  <a href="/admin/presets.html" class="btn btn-outline-warning w-100">
                    <i class="bi bi-stars"></i> æŠ½å¥–é¢„è®¾ç®¡ç†
                  </a>
                </div>
              </div>
            </div>
            
            <!-- P1 - å®ç”¨åŠŸèƒ½ -->
            <div class="mb-3">
              <h6 class="text-muted mb-2">
                <span class="badge bg-primary me-2">P1</span>å®ç”¨åŠŸèƒ½
              </h6>
              <div class="row g-2">
                <div class="col-md-3 col-sm-6">
                  <a href="/admin/users.html" class="btn btn-outline-info w-100">
                    <i class="bi bi-people"></i> ç”¨æˆ·ç®¡ç†
                  </a>
                </div>
                <div class="col-md-3 col-sm-6">
                  <a href="/admin/prizes.html" class="btn btn-outline-success w-100">
                    <i class="bi bi-gift"></i> å¥–å“æ± é…ç½®
                  </a>
                </div>
                <div class="col-md-3 col-sm-6">
                  <a href="/admin/customer-service.html" class="btn btn-outline-danger w-100">
                    <i class="bi bi-chat-dots"></i> å®¢æœå·¥ä½œå°
                  </a>
                </div>
                <div class="col-md-3 col-sm-6">
                  <a href="/admin/activity-conditions.html" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-list-check"></i> æ´»åŠ¨æ¡ä»¶ç®¡ç†
                  </a>
                </div>
              </div>
            </div>
            
            <!-- P2 - é«˜çº§åŠŸèƒ½ -->
            <div>
              <h6 class="text-muted mb-2">
                <span class="badge bg-success me-2">P2</span>é«˜çº§åŠŸèƒ½
              </h6>
              <div class="row g-2">
                <div class="col-md-3 col-sm-6">
                  <a href="/admin/statistics.html" class="btn btn-outline-primary w-100">
                    <i class="bi bi-bar-chart-fill"></i> æ•°æ®ç»Ÿè®¡æŠ¥è¡¨
                  </a>
                </div>
                <div class="col-md-3 col-sm-6">
                  <a href="/admin/charts.html" class="btn btn-outline-success w-100">
                    <i class="bi bi-graph-up"></i> å›¾è¡¨å¯è§†åŒ–
                  </a>
                </div>
                <div class="col-md-3 col-sm-6">
                  <a href="/admin/notifications.html" class="btn btn-outline-warning w-100">
                    <i class="bi bi-bell-fill"></i> ç³»ç»Ÿé€šçŸ¥ä¸­å¿ƒ
                  </a>
                </div>
                <div class="col-md-3 col-sm-6">
                  <a href="/admin/settings.html" class="btn btn-outline-danger w-100">
                    <i class="bi bi-gear-fill"></i> ç³»ç»Ÿè®¾ç½®
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… å¼•å…¥é€šç”¨å·¥å…·åº“ -->
  <script src="/admin/js/admin-common.js"></script>
  
  <script>
    /**
     * æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
     */
    document.addEventListener('DOMContentLoaded', function() {
      const userInfo = getCurrentUser();
      if (userInfo && userInfo.nickname) {
        document.getElementById('welcomeText').textContent = `æ¬¢è¿ï¼Œ${userInfo.nickname}`;
      }
      
      // é€€å‡ºç™»å½•æŒ‰é’®
      document.getElementById('logoutBtn').addEventListener('click', logout);
    });
    
    /**
     * åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
     * ä½¿ç”¨ç°æœ‰ç®¡ç†APIï¼š/api/v4/admin/system/dashboard
     * 
     * åç«¯æ•°æ®ç»“æ„ï¼ˆV4ç»Ÿä¸€æŠ½å¥–å¼•æ“ï¼‰ï¼š
     * {
     *   overview: { total_users, active_users, total_lotteries, win_rate },
     *   today: { new_users, lottery_draws, wins, win_rate, points_consumed },
     *   customer_service: { today_sessions, today_messages },
     *   system: { uptime, memory_usage, cpu_usage, timestamp }
     * }
     */
    async function loadDashboardData() {
      try {
        const response = await apiRequest('/api/v4/admin/system/dashboard');
        
        if (response && response.success && response.data) {
          const data = response.data;
          
          // é€‚é…åç«¯V4æ•°æ®ç»“æ„ - æ€»ç”¨æˆ·æ•°æ®
          if (data.overview) {
            document.getElementById('totalUsers').textContent = formatNumber(data.overview.total_users || 0);
          }
          
          // é€‚é…åç«¯V4æ•°æ®ç»“æ„ - ä»Šæ—¥æ•°æ®
          if (data.today) {
            document.getElementById('todayNewUsers').textContent = data.today.new_users || 0;
            document.getElementById('todayDraws').textContent = formatNumber(data.today.lottery_draws || 0);
            document.getElementById('todayWins').textContent = formatNumber(data.today.wins || 0);
            document.getElementById('winRate').textContent = (data.today.win_rate || 0) + '%';
            document.getElementById('points').textContent = formatNumber(data.today.points_consumed || 0);
          }
          
          // é€‚é…åç«¯V4æ•°æ®ç»“æ„ - å®¢æœä¼šè¯æ•°æ®
          if (data.customer_service) {
            document.getElementById('sessions').textContent = formatNumber(data.customer_service.today_sessions || 0);
            document.getElementById('messages').textContent = formatNumber(data.customer_service.today_messages || 0);
          }
          
          console.log('âœ… ä»ªè¡¨ç›˜æ•°æ®åŠ è½½æˆåŠŸ', {
            total_users: data.overview?.total_users,
            today_new_users: data.today?.new_users,
            today_draws: data.today?.lottery_draws,
            today_wins: data.today?.wins,
            win_rate: data.today?.win_rate
          });
        } else {
          console.warn('âš ï¸ ä»ªè¡¨ç›˜APIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸:', response);
        }
      } catch (error) {
        console.error('âŒ åŠ è½½ä»ªè¡¨ç›˜æ•°æ®å¤±è´¥:', error);
        handleApiError(error, 'åŠ è½½ä»ªè¡¨ç›˜æ•°æ®');
      }
    }
    
    // é¡µé¢åˆå§‹åŒ–
    if (getToken() && checkAdminPermission()) {
      loadDashboardData();
      setInterval(loadDashboardData, 60000); // æ¯åˆ†é’Ÿåˆ·æ–°
    }
  </script>
</body>
</html>

