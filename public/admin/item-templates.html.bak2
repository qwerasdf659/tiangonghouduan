<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç‰©å“æ¨¡æ¿ - ç®¡ç†åå°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">
  <style>
    .template-card {
      transition: all 0.3s ease;
      border-top: 3px solid #0d6efd;
    }
    .template-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .template-icon {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    .rarity-badge {
      font-size: 0.7rem;
      padding: 2px 6px;
    }
    .rarity-common { background: #6c757d; }
    .rarity-uncommon { background: #198754; }
    .rarity-rare { background: #0d6efd; }
    .rarity-epic { background: #6f42c1; }
    .rarity-legendary { background: #fd7e14; }
    [x-cloak] { display: none !important; }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ“¦ ç®¡ç†åå° - ç‰©å“æ¨¡æ¿
      </a>
      <div>
        <span class="text-light me-3" x-data x-text="$store.auth.user?.nickname ? `æ¬¢è¿ï¼Œ${$store.auth.user.nickname}` : 'æ¬¢è¿ï¼Œç®¡ç†å‘˜'">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" onclick="logout()">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4" x-data="itemTemplatesPage()">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-box-seam text-primary" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">æ¨¡æ¿æ€»æ•°</h6>
            <h2 x-text="stats.total" class="text-primary mb-0">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-tags text-success" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">ç‰©å“ç±»å‹</h6>
            <h2 x-text="stats.types" class="text-success mb-0">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-check-circle text-warning" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">å·²å¯ç”¨</h6>
            <h2 x-text="stats.active" class="text-warning mb-0">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-star text-info" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">ç¨€æœ‰åº¦åˆ†å¸ƒ</h6>
            <h2 x-text="stats.rarities" class="text-info mb-0">-</h2>
          </div>
        </div>
      </div>
    </div>

    <!-- ç­›é€‰å’Œæ“ä½œæ  -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-center">
          <div class="col-md-2">
            <label class="form-label">ç‰©å“ç±»å‹</label>
            <select class="form-select" x-model="filters.type" @change="loadTemplates()">
              <option value="">å…¨éƒ¨ç±»å‹</option>
              <option value="voucher">ä¼˜æƒ åˆ¸</option>
              <option value="coupon">ä»£é‡‘åˆ¸</option>
              <option value="points">ç§¯åˆ†</option>
              <option value="gift">ç¤¼å“</option>
              <option value="virtual">è™šæ‹Ÿç‰©å“</option>
              <option value="material">ææ–™</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">ç¨€æœ‰åº¦</label>
            <select class="form-select" x-model="filters.rarity" @change="loadTemplates()">
              <option value="">å…¨éƒ¨ç¨€æœ‰åº¦</option>
              <option value="common">æ™®é€š</option>
              <option value="uncommon">ä¼˜è‰¯</option>
              <option value="rare">ç¨€æœ‰</option>
              <option value="epic">å²è¯—</option>
              <option value="legendary">ä¼ è¯´</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">çŠ¶æ€</label>
            <select class="form-select" x-model="filters.status" @change="loadTemplates()">
              <option value="">å…¨éƒ¨çŠ¶æ€</option>
              <option value="active">å¯ç”¨</option>
              <option value="inactive">ç¦ç”¨</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">æœç´¢</label>
            <input type="text" class="form-control" x-model.debounce.300ms="filters.search" @input="loadTemplates()" placeholder="æœç´¢æ¨¡æ¿åç§°...">
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary me-2" @click="loadTemplates()">
              <i class="bi bi-search"></i> æœç´¢
            </button>
            <button class="btn btn-success" @click="openCreateModal()">
              <i class="bi bi-plus-lg"></i> æ–°å»ºæ¨¡æ¿
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ç‰©å“æ¨¡æ¿åˆ—è¡¨ -->
    <div class="row">
      <template x-if="templates.length === 0">
        <div class="col-12">
          <div class="card">
            <div class="card-body text-center py-5 text-muted">
              <i class="bi bi-box" style="font-size: 3rem;"></i>
              <p class="mt-2">æš‚æ— ç‰©å“æ¨¡æ¿</p>
            </div>
          </div>
        </div>
      </template>
      <template x-for="t in templates" :key="t.item_template_id">
        <div class="col-md-4 col-lg-3 mb-4">
          <div class="card template-card h-100">
            <div class="card-body text-center">
              <div class="template-icon" x-text="getTypeIcon(t.item_type)"></div>
              <h6 class="card-title" x-text="t.display_name"></h6>
              <p class="text-muted small mb-2" x-text="t.template_code"></p>
              <span class="badge text-white rarity-badge mb-2" :class="`rarity-${t.rarity_code || 'common'}`" x-text="getRarityLabel(t.rarity_code, t.rarity)"></span>
              <p class="small text-muted mb-0" x-text="truncateText(t.description, 50)"></p>
            </div>
            <div class="card-footer bg-white d-flex justify-content-between align-items-center">
              <span class="badge" :class="t.is_enabled ? 'bg-success' : 'bg-secondary'" x-text="t.is_enabled ? 'å¯ç”¨' : 'ç¦ç”¨'"></span>
              <div>
                <button class="btn btn-sm btn-outline-primary me-1" @click="editTemplate(t.item_template_id)">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" @click="deleteTemplate(t.item_template_id)">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </template>
    </div>

    <!-- æ¨¡æ¿è¡¨å•æ¨¡æ€æ¡† -->
    <div class="modal fade" id="templateModal" tabindex="-1" x-ref="templateModal">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" x-text="form.templateId ? 'âœï¸ ç¼–è¾‘ç‰©å“æ¨¡æ¿' : 'â• æ–°å»ºç‰©å“æ¨¡æ¿'"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form @submit.prevent="submitTemplate">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">æ¨¡æ¿åç§° <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" x-model="form.displayName" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">æ¨¡æ¿ç¼–ç  <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" x-model="form.templateCode" required placeholder="å”¯ä¸€æ ‡è¯†">
                </div>
                <div class="col-md-4">
                  <label class="form-label">ç‰©å“ç±»å‹</label>
                  <select class="form-select" x-model="form.itemType">
                    <option value="voucher">ä¼˜æƒ åˆ¸</option>
                    <option value="coupon">ä»£é‡‘åˆ¸</option>
                    <option value="points">ç§¯åˆ†</option>
                    <option value="gift">ç¤¼å“</option>
                    <option value="virtual">è™šæ‹Ÿç‰©å“</option>
                    <option value="material">ææ–™</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">ç¨€æœ‰åº¦</label>
                  <select class="form-select" x-model="form.rarityCode">
                    <option value="common">æ™®é€š</option>
                    <option value="uncommon">ä¼˜è‰¯</option>
                    <option value="rare">ç¨€æœ‰</option>
                    <option value="epic">å²è¯—</option>
                    <option value="legendary">ä¼ è¯´</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">çŠ¶æ€</label>
                  <select class="form-select" x-model="form.isEnabled">
                    <option :value="true">å¯ç”¨</option>
                    <option :value="false">ç¦ç”¨</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">å›¾æ ‡URL</label>
                  <input type="text" class="form-control" x-model="form.imageUrl" placeholder="https://...">
                </div>
                <div class="col-md-6">
                  <label class="form-label">åŸºç¡€ä»·å€¼</label>
                  <input type="number" class="form-control" x-model.number="form.referencePricePoints" min="0" step="0.01">
                </div>
                <div class="col-12">
                  <label class="form-label">æ¨¡æ¿æè¿°</label>
                  <textarea class="form-control" x-model="form.description" rows="2"></textarea>
                </div>
                <div class="col-12">
                  <label class="form-label">æ‰©å±•å±æ€§ (JSONæ ¼å¼)</label>
                  <textarea class="form-control font-monospace" x-model="form.meta" rows="3" placeholder='{"key": "value"}'></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary" :disabled="isSubmitting">ä¿å­˜</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">åŠ è½½ä¸­...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/alpine/init.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script src="/admin/js/api-config.js"></script>
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('itemTemplatesPage', () => ({
        templates: [],
        filters: {
          type: '',
          rarity: '',
          status: '',
          search: '',
        },
        stats: {
          total: 0,
          types: 0,
          active: 0,
          rarities: 0,
        },
        form: {
          templateId: '',
          displayName: '',
          templateCode: '',
          itemType: 'voucher',
          rarityCode: 'common',
          isEnabled: true,
          imageUrl: '',
          referencePricePoints: 0,
          description: '',
          meta: '',
        },
        isSubmitting: false,
        typeIcons: {
          voucher: 'ğŸ«', coupon: 'ğŸ«', points: 'ğŸ’°',
          gift: 'ğŸ', virtual: 'âœ¨', material: 'ğŸ“¦'
        },
        rarityLabels: {
          common: 'æ™®é€š', uncommon: 'ä¼˜è‰¯', rare: 'ç¨€æœ‰',
          epic: 'å²è¯—', legendary: 'ä¼ è¯´'
        },

        init() {
          this.loadTemplates();
        },

        getTypeIcon(itemType) {
          return this.typeIcons[itemType] || 'ğŸ“¦';
        },

        getRarityLabel(rarityCode, rarityObj) {
          if (rarityObj && rarityObj.display_name) {
            return rarityObj.display_name;
          }
          return this.rarityLabels[rarityCode] || 'æ™®é€š';
        },

        truncateText(text, maxLength) {
          if (!text) return '';
          return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        },

        async loadTemplates() {
          showLoading();
          try {
            const params = new URLSearchParams();
            if (this.filters.type) params.append('item_type', this.filters.type);
            if (this.filters.rarity) params.append('rarity_code', this.filters.rarity);
            if (this.filters.status) params.append('is_enabled', this.filters.status === 'active' ? 'true' : 'false');
            if (this.filters.search) params.append('keyword', this.filters.search);

            const url = API_ENDPOINTS.ITEM_TEMPLATE.LIST + (params.toString() ? `?${params.toString()}` : '');
            const response = await apiRequest(url);

            if (response && response.success) {
              this.templates = response.data.list || [];
              this.updateStats(response.data.pagination || {});
            } else {
              this.showError('åŠ è½½å¤±è´¥', response?.message || 'è·å–ç‰©å“æ¨¡æ¿å¤±è´¥');
            }
          } catch (error) {
            console.error('åŠ è½½ç‰©å“æ¨¡æ¿å¤±è´¥:', error);
            this.showError('åŠ è½½å¤±è´¥', error.message);
          } finally {
            hideLoading();
          }
        },

        updateStats(pagination) {
          this.stats.total = pagination.total_count || this.templates.length;
          this.stats.types = new Set(this.templates.map(t => t.item_type)).size;
          this.stats.active = this.templates.filter(t => t.is_enabled).length;
          this.stats.rarities = new Set(this.templates.map(t => t.rarity_code).filter(Boolean)).size || '-';
        },

        openCreateModal() {
          this.form = {
            templateId: '', displayName: '', templateCode: '',
            itemType: 'voucher', rarityCode: 'common', isEnabled: true,
            imageUrl: '', referencePricePoints: 0, description: '', meta: ''
          };
          new bootstrap.Modal(this.$refs.templateModal).show();
        },

        async editTemplate(templateId) {
          showLoading();
          try {
            const response = await apiRequest(API.buildURL(API_ENDPOINTS.ITEM_TEMPLATE.DETAIL, { id: templateId }));
            if (response && response.success) {
              const t = response.data;
              this.form = {
                templateId: t.item_template_id,
                displayName: t.display_name || '',
                templateCode: t.template_code || '',
                itemType: t.item_type || 'voucher',
                rarityCode: t.rarity_code || 'common',
                isEnabled: t.is_enabled,
                imageUrl: t.image_url || '',
                referencePricePoints: t.reference_price_points || 0,
                description: t.description || '',
                meta: t.meta ? JSON.stringify(t.meta, null, 2) : ''
              };
              new bootstrap.Modal(this.$refs.templateModal).show();
            } else {
              this.showError('åŠ è½½å¤±è´¥', response?.message || 'è·å–æ¨¡æ¿è¯¦æƒ…å¤±è´¥');
            }
          } catch (error) {
            console.error('åŠ è½½æ¨¡æ¿è¯¦æƒ…å¤±è´¥:', error);
            this.showError('åŠ è½½å¤±è´¥', error.message);
          } finally {
            hideLoading();
          }
        },

        async submitTemplate() {
          if (this.isSubmitting) return;

          let meta = null;
          try {
            if (this.form.meta && this.form.meta.trim()) {
              meta = JSON.parse(this.form.meta);
            }
          } catch (e) {
            alert('æ‰©å±•å±æ€§JSONæ ¼å¼é”™è¯¯');
            return;
          }

          const data = {
            display_name: this.form.displayName,
            template_code: this.form.templateCode,
            item_type: this.form.itemType,
            rarity_code: this.form.rarityCode,
            is_enabled: this.form.isEnabled,
            image_url: this.form.imageUrl || null,
            reference_price_points: this.form.referencePricePoints || 0,
            description: this.form.description || null,
            meta: meta
          };

          if (!data.display_name || !data.template_code) {
            alert('è¯·å¡«å†™æ¨¡æ¿åç§°å’Œç¼–ç ');
            return;
          }

          this.isSubmitting = true;
          showLoading();
          try {
            const url = this.form.templateId
              ? API.buildURL(API_ENDPOINTS.ITEM_TEMPLATE.UPDATE, { id: this.form.templateId })
              : API_ENDPOINTS.ITEM_TEMPLATE.CREATE;
            const method = this.form.templateId ? 'PUT' : 'POST';

            const response = await apiRequest(url, { method, body: JSON.stringify(data) });

            if (response && response.success) {
              bootstrap.Modal.getInstance(this.$refs.templateModal).hide();
              alert(`âœ… ${this.form.templateId ? 'æ›´æ–°' : 'åˆ›å»º'}æˆåŠŸ`);
              this.loadTemplates();
            } else {
              this.showError('ä¿å­˜å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
            }
          } catch (error) {
            console.error('ä¿å­˜æ¨¡æ¿å¤±è´¥:', error);
            this.showError('ä¿å­˜å¤±è´¥', error.message);
          } finally {
            this.isSubmitting = false;
            hideLoading();
          }
        },

        async deleteTemplate(templateId) {
          if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ç‰©å“æ¨¡æ¿å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

          showLoading();
          try {
            const response = await apiRequest(API.buildURL(API_ENDPOINTS.ITEM_TEMPLATE.DELETE, { id: templateId }), {
              method: 'DELETE'
            });

            if (response && response.success) {
              alert('âœ… åˆ é™¤æˆåŠŸ');
              this.loadTemplates();
            } else {
              this.showError('åˆ é™¤å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
            }
          } catch (error) {
            console.error('åˆ é™¤æ¨¡æ¿å¤±è´¥:', error);
            this.showError('åˆ é™¤å¤±è´¥', error.message);
          } finally {
            hideLoading();
          }
        },

        showError(title, message) {
          alert(`âŒ ${title}\n${message}`);
        }
      }));
    });
  </script>
  <script defer src="/admin/js/vendor/alpine.min.js"></script>
</body>
</html>
