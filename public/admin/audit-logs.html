<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®¡è®¡æ—¥å¿— - ç®¡ç†åå°</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">
</head>
<body class="bg-light">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ“‹ å®¡è®¡æ—¥å¿—
      </a>
      <div>
        <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row g-3 mb-3">
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h6 class="text-muted">ä»Šæ—¥æ“ä½œ</h6>
            <h3 class="text-primary" id="todayLogs">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-info">
          <div class="card-body text-center">
            <h6 class="text-muted">æœ¬å‘¨æ“ä½œ</h6>
            <h3 class="text-info" id="weekLogs">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-success">
          <div class="card-body text-center">
            <h6 class="text-muted">æˆåŠŸæ“ä½œ</h6>
            <h3 class="text-success" id="successLogs">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-danger">
          <div class="card-body text-center">
            <h6 class="text-muted">å¤±è´¥æ“ä½œ</h6>
            <h3 class="text-danger" id="failedLogs">-</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- ç­›é€‰åŒºåŸŸ -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-2">
            <label class="form-label">æ“ä½œç±»å‹</label>
            <select class="form-select" id="operationTypeFilter">
              <option value="">å…¨éƒ¨ç±»å‹</option>
              <option value="USER_CREATE">ç”¨æˆ·åˆ›å»º</option>
              <option value="USER_UPDATE">ç”¨æˆ·æ›´æ–°</option>
              <option value="USER_DELETE">ç”¨æˆ·åˆ é™¤</option>
              <option value="POINTS_ADJUST">ç§¯åˆ†è°ƒæ•´</option>
              <option value="PRIZE_CONFIG">å¥–å“é…ç½®</option>
              <option value="ORDER_UPDATE">è®¢å•æ›´æ–°</option>
              <option value="SYSTEM_CONFIG">ç³»ç»Ÿé…ç½®</option>
              <option value="LOGIN">ç™»å½•æ“ä½œ</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">ç›®æ ‡ç±»å‹</label>
            <select class="form-select" id="targetTypeFilter">
              <option value="">å…¨éƒ¨ç›®æ ‡</option>
              <option value="user">ç”¨æˆ·</option>
              <option value="prize">å¥–å“</option>
              <option value="order">è®¢å•</option>
              <option value="system">ç³»ç»Ÿ</option>
              <option value="points">ç§¯åˆ†</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">æ“ä½œå‘˜ID</label>
            <input type="number" class="form-control" id="operatorIdFilter" placeholder="æ“ä½œå‘˜ID">
          </div>
          <div class="col-md-2">
            <label class="form-label">å¼€å§‹æ—¥æœŸ</label>
            <input type="date" class="form-control" id="startDateFilter">
          </div>
          <div class="col-md-2">
            <label class="form-label">ç»“æŸæ—¥æœŸ</label>
            <input type="date" class="form-control" id="endDateFilter">
          </div>
          <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-primary w-100" id="searchBtn">
              <i class="bi bi-search"></i> æŸ¥è¯¢
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- æ—¥å¿—åˆ—è¡¨ -->
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle table-sm">
            <thead class="table-light">
              <tr>
                <th style="width: 60px;">ID</th>
                <th>æ“ä½œç±»å‹</th>
                <th>ç›®æ ‡</th>
                <th>æ“ä½œæè¿°</th>
                <th>æ“ä½œå‘˜</th>
                <th>IPåœ°å€</th>
                <th>ç»“æœ</th>
                <th>æ“ä½œæ—¶é—´</th>
                <th style="width: 80px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="logsTableBody">
              <tr>
                <td colspan="9" class="text-center py-5">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                  </div>
                  <p class="mt-2 text-muted">æ­£åœ¨åŠ è½½æ•°æ®...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- åˆ†é¡µ -->
        <nav aria-label="åˆ†é¡µ" class="mt-3">
          <ul class="pagination justify-content-end" id="pagination"></ul>
        </nav>
      </div>
    </div>
  </div>

  <!-- æ—¥å¿—è¯¦æƒ…æ¨¡æ€æ¡† -->
  <div class="modal fade" id="logDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-file-text"></i> å®¡è®¡æ—¥å¿—è¯¦æƒ…
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label text-muted">æ—¥å¿—ID</label>
              <p id="detailLogId" class="fw-bold">-</p>
            </div>
            <div class="col-md-6">
              <label class="form-label text-muted">æ“ä½œæ—¶é—´</label>
              <p id="detailCreatedAt" class="fw-bold">-</p>
            </div>
            <div class="col-md-6">
              <label class="form-label text-muted">æ“ä½œç±»å‹</label>
              <p id="detailOperationType">-</p>
            </div>
            <div class="col-md-6">
              <label class="form-label text-muted">æ“ä½œç»“æœ</label>
              <p id="detailResult">-</p>
            </div>
            <div class="col-md-6">
              <label class="form-label text-muted">ç›®æ ‡ç±»å‹</label>
              <p id="detailTargetType">-</p>
            </div>
            <div class="col-md-6">
              <label class="form-label text-muted">ç›®æ ‡ID</label>
              <p id="detailTargetId">-</p>
            </div>
            <div class="col-md-6">
              <label class="form-label text-muted">æ“ä½œå‘˜ID</label>
              <p id="detailOperatorId">-</p>
            </div>
            <div class="col-md-6">
              <label class="form-label text-muted">IPåœ°å€</label>
              <p id="detailIpAddress">-</p>
            </div>
            <div class="col-12">
              <label class="form-label text-muted">æ“ä½œæè¿°</label>
              <div class="border rounded p-3 bg-light" id="detailDescription">-</div>
            </div>
            <div class="col-12">
              <label class="form-label text-muted">å˜æ›´è¯¦æƒ…</label>
              <pre class="border rounded p-3 bg-dark text-light" id="detailChanges" style="max-height: 300px; overflow: auto;">-</pre>
            </div>
            <div class="col-12" id="errorSection" style="display: none;">
              <label class="form-label text-muted">é”™è¯¯ä¿¡æ¯</label>
              <div class="border rounded p-3 bg-danger bg-opacity-10 text-danger" id="detailErrorMessage">-</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
        </div>
      </div>
    </div>
  </div>

  <!-- åŠ è½½é®ç½©å±‚ -->
  <div class="loading-overlay" id="loadingOverlay" style="display:none;">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">å¤„ç†ä¸­...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/admin-common.js"></script>

  <script>
    // å…¨å±€å˜é‡
    let currentPage = 1;
    const pageSize = 30;

    // é¡µé¢åŠ è½½
    document.addEventListener('DOMContentLoaded', function() {
      checkAuth();
      initDateFilters();
      loadAuditLogs();
      loadStatistics();
      bindEvents();
    });

    // æƒé™æ£€æŸ¥
    function checkAuth() {
      const token = getToken();
      if (!token) {
        window.location.href = '/admin/login.html';
        return false;
      }
      checkAdminPermission();
      return true;
    }

    // åˆå§‹åŒ–æ—¥æœŸç­›é€‰å™¨
    function initDateFilters() {
      const today = new Date();
      const weekAgo = new Date(today);
      weekAgo.setDate(today.getDate() - 7);
      
      document.getElementById('endDateFilter').value = today.toISOString().split('T')[0];
      document.getElementById('startDateFilter').value = weekAgo.toISOString().split('T')[0];
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
      document.getElementById('logoutBtn').addEventListener('click', logout);
      document.getElementById('searchBtn').addEventListener('click', handleSearch);
    }

    // å¤„ç†æœç´¢
    function handleSearch() {
      currentPage = 1;
      loadAuditLogs();
    }

    // åŠ è½½å®¡è®¡æ—¥å¿—åˆ—è¡¨
    async function loadAuditLogs() {
      try {
        showLoading(true);
        
        const operationType = document.getElementById('operationTypeFilter').value;
        const targetType = document.getElementById('targetTypeFilter').value;
        const operatorId = document.getElementById('operatorIdFilter').value.trim();
        const startDate = document.getElementById('startDateFilter').value;
        const endDate = document.getElementById('endDateFilter').value;
        
        const params = new URLSearchParams({
          page: currentPage,
          page_size: pageSize
        });
        
        if (operationType) params.append('operation_type', operationType);
        if (targetType) params.append('target_type', targetType);
        if (operatorId) params.append('operator_id', operatorId);
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
        
        const response = await apiRequest(`/api/v4/console/system/audit-logs?${params}`);
        
        if (response && response.success) {
          renderLogs(response.data.logs || response.data.list || []);
          renderPagination(response.data.pagination);
        } else {
          showError(response?.message || 'åŠ è½½å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½å®¡è®¡æ—¥å¿—å¤±è´¥', error);
        showError('åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        showLoading(false);
      }
    }

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStatistics() {
      try {
        const response = await apiRequest('/api/v4/console/system/audit-logs/statistics');
        
        if (response && response.success) {
          const stats = response.data.statistics || response.data;
          document.getElementById('todayLogs').textContent = stats.today_count || 0;
          document.getElementById('weekLogs').textContent = stats.week_count || 0;
          document.getElementById('successLogs').textContent = stats.success_count || 0;
          document.getElementById('failedLogs').textContent = stats.failed_count || 0;
        }
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥', error);
      }
    }

    // æ¸²æŸ“æ—¥å¿—åˆ—è¡¨
    function renderLogs(logs) {
      const tbody = document.getElementById('logsTableBody');
      
      if (!logs || logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>';
        return;
      }
      
      tbody.innerHTML = logs.map(log => {
        const id = log.log_id || log.id;
        const operationBadge = getOperationTypeBadge(log.operation_type);
        const resultBadge = getResultBadge(log.result || log.status);
        
        return `
          <tr>
            <td><small>${id}</small></td>
            <td>${operationBadge}</td>
            <td>
              <small class="text-muted">${log.target_type || '-'}</small>
              ${log.target_id ? `<br><code>${log.target_id}</code>` : ''}
            </td>
            <td>
              <div style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                <small>${escapeHtml(log.description || log.action_description || '-')}</small>
              </div>
            </td>
            <td><small>ID: ${log.operator_id || '-'}</small></td>
            <td><small class="text-muted">${log.ip_address || '-'}</small></td>
            <td>${resultBadge}</td>
            <td><small>${formatDate(log.created_at)}</small></td>
            <td>
              <button class="btn btn-sm btn-outline-info" onclick="viewLogDetail(${id})">
                <i class="bi bi-eye"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // æŸ¥çœ‹æ—¥å¿—è¯¦æƒ…
    async function viewLogDetail(id) {
      try {
        showLoading(true);
        const response = await apiRequest(`/api/v4/console/system/audit-logs/${id}`);
        
        if (response && response.success) {
          const log = response.data.log || response.data;
          
          document.getElementById('detailLogId').textContent = log.log_id || log.id;
          document.getElementById('detailCreatedAt').textContent = formatDate(log.created_at);
          document.getElementById('detailOperationType').innerHTML = getOperationTypeBadge(log.operation_type);
          document.getElementById('detailResult').innerHTML = getResultBadge(log.result || log.status);
          document.getElementById('detailTargetType').textContent = log.target_type || '-';
          document.getElementById('detailTargetId').textContent = log.target_id || '-';
          document.getElementById('detailOperatorId').textContent = log.operator_id || '-';
          document.getElementById('detailIpAddress').textContent = log.ip_address || '-';
          document.getElementById('detailDescription').textContent = log.description || log.action_description || '-';
          
          // å˜æ›´è¯¦æƒ…
          const changes = log.changes || log.before_data || log.after_data;
          if (changes) {
            document.getElementById('detailChanges').textContent = JSON.stringify(changes, null, 2);
          } else {
            document.getElementById('detailChanges').textContent = 'æ— å˜æ›´è®°å½•';
          }
          
          // é”™è¯¯ä¿¡æ¯
          const errorSection = document.getElementById('errorSection');
          if (log.error_message) {
            errorSection.style.display = 'block';
            document.getElementById('detailErrorMessage').textContent = log.error_message;
          } else {
            errorSection.style.display = 'none';
          }
          
          new bootstrap.Modal(document.getElementById('logDetailModal')).show();
        } else {
          showError(response?.message || 'è·å–è¯¦æƒ…å¤±è´¥');
        }
      } catch (error) {
        console.error('è·å–æ—¥å¿—è¯¦æƒ…å¤±è´¥', error);
        showError('è·å–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        showLoading(false);
      }
    }

    // æ¸²æŸ“åˆ†é¡µ
    function renderPagination(pagination) {
      const paginationEl = document.getElementById('pagination');
      if (!pagination || pagination.total_pages <= 1) {
        paginationEl.innerHTML = '';
        return;
      }
      
      let html = '';
      const maxPages = Math.min(pagination.total_pages, 10);
      for (let i = 1; i <= maxPages; i++) {
        html += `
          <li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
          </li>
        `;
      }
      if (pagination.total_pages > 10) {
        html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
      }
      paginationEl.innerHTML = html;
    }

    function changePage(page) {
      currentPage = page;
      loadAuditLogs();
    }

    // å·¥å…·å‡½æ•°
    function getOperationTypeBadge(type) {
      const typeMap = {
        'USER_CREATE': '<span class="badge bg-success">ç”¨æˆ·åˆ›å»º</span>',
        'USER_UPDATE': '<span class="badge bg-info">ç”¨æˆ·æ›´æ–°</span>',
        'USER_DELETE': '<span class="badge bg-danger">ç”¨æˆ·åˆ é™¤</span>',
        'POINTS_ADJUST': '<span class="badge bg-warning">ç§¯åˆ†è°ƒæ•´</span>',
        'PRIZE_CONFIG': '<span class="badge bg-primary">å¥–å“é…ç½®</span>',
        'ORDER_UPDATE': '<span class="badge bg-info">è®¢å•æ›´æ–°</span>',
        'SYSTEM_CONFIG': '<span class="badge bg-dark">ç³»ç»Ÿé…ç½®</span>',
        'LOGIN': '<span class="badge bg-secondary">ç™»å½•æ“ä½œ</span>'
      };
      return typeMap[type] || `<span class="badge bg-secondary">${type || '-'}</span>`;
    }

    function getResultBadge(result) {
      const resultMap = {
        'success': '<span class="badge bg-success">æˆåŠŸ</span>',
        'SUCCESS': '<span class="badge bg-success">æˆåŠŸ</span>',
        'failed': '<span class="badge bg-danger">å¤±è´¥</span>',
        'FAILED': '<span class="badge bg-danger">å¤±è´¥</span>',
        'error': '<span class="badge bg-danger">é”™è¯¯</span>',
        'ERROR': '<span class="badge bg-danger">é”™è¯¯</span>'
      };
      return resultMap[result] || `<span class="badge bg-secondary">${result || '-'}</span>`;
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showLoading(show) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    function showSuccess(message) {
      alert(message);
    }

    function showError(message) {
      alert(message);
    }
  </script>
</body>
</html>

