<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BxPxçŸ©é˜µé…ç½® - ç®¡ç†åå°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">
  <style>
    .matrix-table th, .matrix-table td {
      text-align: center;
      vertical-align: middle;
      min-width: 100px;
    }
    .matrix-cell {
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .matrix-cell:hover {
      background: #e9ecef !important;
    }
    .matrix-cell.editable {
      background: #f8f9fa;
    }
    .matrix-cell input {
      width: 80px;
      text-align: center;
    }
    .tier-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
    }
    .tier-B1 { background: #d4edda; color: #155724; }
    .tier-B2 { background: #cce5ff; color: #004085; }
    .tier-B3 { background: #fff3cd; color: #856404; }
    .tier-B4 { background: #f8d7da; color: #721c24; }
    .tier-P1 { background: #e2e3e5; color: #383d41; }
    .tier-P2 { background: #d1ecf1; color: #0c5460; }
    .tier-P3 { background: #d4edda; color: #155724; }
    .tier-P4 { background: #cce5ff; color: #004085; }
    .tier-P5 { background: #e2d5f1; color: #5a2d82; }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ¯ ç®¡ç†åå° - BxPxçŸ©é˜µé…ç½®
      </a>
      <div>
        <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- è¯´æ˜å¡ç‰‡ -->
    <div class="card mb-4">
      <div class="card-body">
        <h6 class="card-title"><i class="bi bi-info-circle"></i> BxPxçŸ©é˜µè¯´æ˜</h6>
        <div class="row">
          <div class="col-md-6">
            <p class="mb-2"><strong>Bxï¼ˆé¢„ç®—å±‚çº§ï¼‰ï¼š</strong></p>
            <ul class="small mb-0">
              <li><span class="tier-badge tier-B1">B1</span> ä½é¢„ç®—ç”¨æˆ·ï¼ˆ&lt;100å…ƒï¼‰</li>
              <li><span class="tier-badge tier-B2">B2</span> ä¸­é¢„ç®—ç”¨æˆ·ï¼ˆ100-500å…ƒï¼‰</li>
              <li><span class="tier-badge tier-B3">B3</span> é«˜é¢„ç®—ç”¨æˆ·ï¼ˆ500-2000å…ƒï¼‰</li>
              <li><span class="tier-badge tier-B4">B4</span> è¶…é«˜é¢„ç®—ç”¨æˆ·ï¼ˆ&gt;2000å…ƒï¼‰</li>
            </ul>
          </div>
          <div class="col-md-6">
            <p class="mb-2"><strong>Pxï¼ˆå¥–å“å±‚çº§ï¼‰ï¼š</strong></p>
            <ul class="small mb-0">
              <li><span class="tier-badge tier-P1">P1</span> æ™®é€šå¥–å“ï¼ˆä»·å€¼&lt;10å…ƒï¼‰</li>
              <li><span class="tier-badge tier-P2">P2</span> ä¼˜è´¨å¥–å“ï¼ˆ10-50å…ƒï¼‰</li>
              <li><span class="tier-badge tier-P3">P3</span> ç¨€æœ‰å¥–å“ï¼ˆ50-200å…ƒï¼‰</li>
              <li><span class="tier-badge tier-P4">P4</span> çè´µå¥–å“ï¼ˆ200-1000å…ƒï¼‰</li>
              <li><span class="tier-badge tier-P5">P5</span> ä¼ è¯´å¥–å“ï¼ˆ&gt;1000å…ƒï¼‰</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- æ´»åŠ¨é€‰æ‹© -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-md-4">
            <label class="form-label">é€‰æ‹©æ´»åŠ¨</label>
            <select class="form-select" id="campaignSelect" onchange="loadMatrixConfig()">
              <option value="">è¯·é€‰æ‹©æ´»åŠ¨</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">é…ç½®ç±»å‹</label>
            <select class="form-select" id="configType" onchange="loadMatrixConfig()">
              <option value="probability">ä¸­å¥–æ¦‚ç‡é…ç½®</option>
              <option value="daily_limit">æ¯æ—¥é™åˆ¶é…ç½®</option>
              <option value="prize_pool">å¥–æ± æƒé‡é…ç½®</option>
            </select>
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button class="btn btn-primary me-2" onclick="loadMatrixConfig()">
              <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
            </button>
            <button class="btn btn-success" onclick="saveMatrixConfig()">
              <i class="bi bi-save"></i> ä¿å­˜é…ç½®
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- çŸ©é˜µè¡¨æ ¼ -->
    <div class="card">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="bi bi-grid-3x3"></i> é…ç½®çŸ©é˜µ</h6>
        <span class="badge bg-info" id="configTypeLabel">ä¸­å¥–æ¦‚ç‡é…ç½®</span>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered matrix-table" id="matrixTable">
            <thead class="table-light">
              <tr>
                <th class="bg-secondary text-white">Bx \ Px</th>
                <th><span class="tier-badge tier-P1">P1</span></th>
                <th><span class="tier-badge tier-P2">P2</span></th>
                <th><span class="tier-badge tier-P3">P3</span></th>
                <th><span class="tier-badge tier-P4">P4</span></th>
                <th><span class="tier-badge tier-P5">P5</span></th>
              </tr>
            </thead>
            <tbody id="matrixBody">
              <!-- åŠ¨æ€ç”Ÿæˆ -->
            </tbody>
          </table>
        </div>
        <div class="mt-3 text-muted small">
          <i class="bi bi-lightbulb"></i> æç¤ºï¼šç‚¹å‡»å•å…ƒæ ¼å¯ç¼–è¾‘æ•°å€¼ï¼Œç¼–è¾‘å®Œæˆåç‚¹å‡»"ä¿å­˜é…ç½®"æŒ‰é’®ç”Ÿæ•ˆ
        </div>
      </div>
    </div>

    <!-- é…ç½®å†å² -->
    <div class="card mt-4">
      <div class="card-header bg-white">
        <h6 class="mb-0"><i class="bi bi-clock-history"></i> é…ç½®å†å²</h6>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>ä¿®æ”¹æ—¶é—´</th>
                <th>ä¿®æ”¹äºº</th>
                <th>é…ç½®ç±»å‹</th>
                <th>ä¿®æ”¹å†…å®¹</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="historyList">
              <tr>
                <td colspan="5" class="text-center text-muted">æš‚æ— å†å²è®°å½•</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">åŠ è½½ä¸­...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script src="/admin/js/api-config.js"></script>
  <script>
    const budgetTiers = ['B1', 'B2', 'B3', 'B4'];
    const prizeTiers = ['P1', 'P2', 'P3', 'P4', 'P5'];
    let matrixConfig = {};
    let originalConfig = {};

    document.addEventListener('DOMContentLoaded', function() {
      const userInfo = getCurrentUser();
      if (userInfo && userInfo.nickname) {
        document.getElementById('welcomeText').textContent = `æ¬¢è¿ï¼Œ${userInfo.nickname}`;
      }
      document.getElementById('logoutBtn').addEventListener('click', logout);
      
      loadCampaigns();
      renderEmptyMatrix();
    });

    async function loadCampaigns() {
      try {
        const response = await apiRequest(API_ENDPOINTS.CAMPAIGN.LIST);
        if (response && response.success) {
          const campaigns = response.data.campaigns || response.data || [];
          const select = document.getElementById('campaignSelect');
          select.innerHTML = '<option value="">è¯·é€‰æ‹©æ´»åŠ¨</option>' +
            campaigns.map(c => `<option value="${c.campaign_id}">${escapeHtml(c.name || c.campaign_name)}</option>`).join('');
        }
      } catch (error) {
        console.error('åŠ è½½æ´»åŠ¨åˆ—è¡¨å¤±è´¥:', error);
      }
    }

    async function loadMatrixConfig() {
      const campaignId = document.getElementById('campaignSelect').value;
      const configType = document.getElementById('configType').value;

      if (!campaignId) {
        renderEmptyMatrix();
        return;
      }

      document.getElementById('configTypeLabel').textContent = getConfigTypeLabel(configType);

      showLoading();
      try {
        const url = API.buildURL(API_ENDPOINTS.MATRIX.GET, { campaign_id: campaignId }) + `?type=${configType}`;
        const response = await apiRequest(url);

        if (response && response.success) {
          matrixConfig = response.data.matrix || response.data || {};
          originalConfig = JSON.parse(JSON.stringify(matrixConfig));
          renderMatrix(matrixConfig, configType);
          loadConfigHistory(campaignId);
        } else {
          // å¦‚æœæ²¡æœ‰é…ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼
          matrixConfig = getDefaultMatrix(configType);
          originalConfig = JSON.parse(JSON.stringify(matrixConfig));
          renderMatrix(matrixConfig, configType);
        }
      } catch (error) {
        console.error('åŠ è½½çŸ©é˜µé…ç½®å¤±è´¥:', error);
        matrixConfig = getDefaultMatrix(configType);
        renderMatrix(matrixConfig, document.getElementById('configType').value);
      } finally {
        hideLoading();
      }
    }

    function getDefaultMatrix(configType) {
      const matrix = {};
      const defaultValues = {
        probability: { B1: { P1: 50, P2: 30, P3: 15, P4: 4, P5: 1 }, B2: { P1: 40, P2: 35, P3: 18, P4: 5, P5: 2 }, B3: { P1: 30, P2: 35, P3: 22, P4: 10, P5: 3 }, B4: { P1: 20, P2: 30, P3: 28, P4: 15, P5: 7 } },
        daily_limit: { B1: { P1: 10, P2: 5, P3: 2, P4: 1, P5: 0 }, B2: { P1: 15, P2: 8, P3: 3, P4: 1, P5: 1 }, B3: { P1: 20, P2: 10, P3: 5, P4: 2, P5: 1 }, B4: { P1: 30, P2: 15, P3: 8, P4: 3, P5: 2 } },
        prize_pool: { B1: { P1: 100, P2: 50, P3: 20, P4: 5, P5: 1 }, B2: { P1: 80, P2: 60, P3: 30, P4: 10, P5: 2 }, B3: { P1: 60, P2: 60, P3: 40, P4: 15, P5: 5 }, B4: { P1: 40, P2: 50, P3: 50, P4: 25, P5: 10 } }
      };
      return defaultValues[configType] || defaultValues.probability;
    }

    function renderEmptyMatrix() {
      const tbody = document.getElementById('matrixBody');
      tbody.innerHTML = budgetTiers.map(bTier => `
        <tr>
          <th class="table-light"><span class="tier-badge tier-${bTier}">${bTier}</span></th>
          ${prizeTiers.map(pTier => `
            <td class="matrix-cell text-muted">-</td>
          `).join('')}
        </tr>
      `).join('');
    }

    function renderMatrix(matrix, configType) {
      const tbody = document.getElementById('matrixBody');
      const unit = getConfigUnit(configType);

      tbody.innerHTML = budgetTiers.map(bTier => `
        <tr>
          <th class="table-light"><span class="tier-badge tier-${bTier}">${bTier}</span></th>
          ${prizeTiers.map(pTier => {
            const value = matrix[bTier]?.[pTier] ?? 0;
            return `
              <td class="matrix-cell editable" onclick="editCell(this, '${bTier}', '${pTier}')">
                <span class="cell-value">${value}${unit}</span>
              </td>
            `;
          }).join('')}
        </tr>
      `).join('');
    }

    function editCell(cell, bTier, pTier) {
      // å¦‚æœå·²ç»åœ¨ç¼–è¾‘æ¨¡å¼ï¼Œå¿½ç•¥
      if (cell.querySelector('input')) return;

      const value = matrixConfig[bTier]?.[pTier] ?? 0;
      const configType = document.getElementById('configType').value;
      const unit = getConfigUnit(configType);

      cell.innerHTML = `
        <input type="number" class="form-control form-control-sm" value="${value}" min="0" 
               onblur="saveCell(this, '${bTier}', '${pTier}')"
               onkeypress="if(event.key==='Enter')this.blur()">
      `;
      cell.querySelector('input').focus();
      cell.querySelector('input').select();
    }

    function saveCell(input, bTier, pTier) {
      const value = parseFloat(input.value) || 0;
      const configType = document.getElementById('configType').value;
      const unit = getConfigUnit(configType);

      // æ›´æ–°é…ç½®
      if (!matrixConfig[bTier]) matrixConfig[bTier] = {};
      matrixConfig[bTier][pTier] = value;

      // æ›´æ–°æ˜¾ç¤º
      input.parentElement.innerHTML = `<span class="cell-value">${value}${unit}</span>`;
    }

    async function saveMatrixConfig() {
      const campaignId = document.getElementById('campaignSelect').value;
      const configType = document.getElementById('configType').value;

      if (!campaignId) {
        alert('è¯·å…ˆé€‰æ‹©æ´»åŠ¨');
        return;
      }

      showLoading();
      try {
        const response = await apiRequest(API.buildURL(API_ENDPOINTS.MATRIX.UPDATE, { campaign_id: campaignId }), {
          method: 'PUT',
          body: JSON.stringify({
            type: configType,
            matrix: matrixConfig
          })
        });

        if (response && response.success) {
          originalConfig = JSON.parse(JSON.stringify(matrixConfig));
          alert('âœ… é…ç½®ä¿å­˜æˆåŠŸ');
          loadConfigHistory(campaignId);
        } else {
          showError('ä¿å­˜å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        console.error('ä¿å­˜çŸ©é˜µé…ç½®å¤±è´¥:', error);
        showError('ä¿å­˜å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }

    async function loadConfigHistory(campaignId) {
      try {
        const response = await apiRequest(API.buildURL(API_ENDPOINTS.MATRIX.HISTORY, { campaign_id: campaignId }));
        if (response && response.success) {
          const history = response.data.history || response.data || [];
          renderHistory(history);
        }
      } catch (error) {
        console.error('åŠ è½½é…ç½®å†å²å¤±è´¥:', error);
      }
    }

    function renderHistory(history) {
      const tbody = document.getElementById('historyList');
      
      if (!history || history.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">æš‚æ— å†å²è®°å½•</td></tr>';
        return;
      }

      tbody.innerHTML = history.slice(0, 10).map(h => `
        <tr>
          <td>${formatDateTime(h.created_at)}</td>
          <td>${escapeHtml(h.operator_name || h.operator_id || '-')}</td>
          <td><span class="badge bg-info">${getConfigTypeLabel(h.config_type)}</span></td>
          <td><small class="text-muted">${escapeHtml(truncateText(h.change_summary || JSON.stringify(h.changes), 50))}</small></td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="rollbackConfig(${h.history_id || h.id})">
              <i class="bi bi-arrow-counterclockwise"></i> å›æ»š
            </button>
          </td>
        </tr>
      `).join('');
    }

    async function rollbackConfig(historyId) {
      if (!confirm('ç¡®å®šè¦å›æ»šåˆ°æ­¤ç‰ˆæœ¬çš„é…ç½®å—ï¼Ÿ')) return;

      showLoading();
      try {
        const response = await apiRequest(API.buildURL(API_ENDPOINTS.MATRIX.ROLLBACK, { history_id: historyId }), {
          method: 'POST'
        });

        if (response && response.success) {
          alert('âœ… å›æ»šæˆåŠŸ');
          loadMatrixConfig();
        } else {
          showError('å›æ»šå¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        console.error('å›æ»šé…ç½®å¤±è´¥:', error);
        showError('å›æ»šå¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }

    function getConfigTypeLabel(type) {
      const labels = {
        probability: 'ä¸­å¥–æ¦‚ç‡é…ç½®',
        daily_limit: 'æ¯æ—¥é™åˆ¶é…ç½®',
        prize_pool: 'å¥–æ± æƒé‡é…ç½®'
      };
      return labels[type] || type;
    }

    function getConfigUnit(type) {
      const units = {
        probability: '%',
        daily_limit: 'æ¬¡',
        prize_pool: ''
      };
      return units[type] || '';
    }

    function truncateText(text, maxLength) {
      if (!text) return '';
      return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      return new Date(dateStr).toLocaleString('zh-CN');
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('show');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('show');
    }

    function showError(title, message) {
      alert(`âŒ ${title}\n${message}`);
    }
  </script>
</body>
</html>

