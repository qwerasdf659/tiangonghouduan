<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æŠ½å¥–æ´»åŠ¨ç®¡ç† - ç®¡ç†åå°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">
  <style>
    .campaign-card {
      transition: all 0.3s ease;
    }
    .campaign-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .status-active { background-color: #28a745; }
    .status-paused { background-color: #ffc107; color: #333; }
    .status-ended { background-color: #6c757d; }
    .budget-progress {
      height: 8px;
      border-radius: 4px;
    }
    .prize-mini-card {
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 8px;
      margin: 4px;
      display: inline-block;
      font-size: 0.85rem;
    }
    .chart-container {
      height: 300px;
    }
  </style>
</head>
<body class="bg-light" x-data="campaignsPage()">
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ° ç®¡ç†åå° - æŠ½å¥–æ´»åŠ¨ç®¡ç†
      </a>
      <div>
        <span class="text-light me-3" x-text="'æ¬¢è¿ï¼Œ' + (userInfo.nickname || 'ç®¡ç†å‘˜')">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" @click="logout">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-trophy text-primary" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">æ´»åŠ¨æ€»æ•°</h6>
            <h2 class="text-primary mb-0" x-text="stats.totalCampaigns">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-play-circle text-success" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">è¿›è¡Œä¸­</h6>
            <h2 class="text-success mb-0" x-text="stats.activeCampaigns">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-gift text-warning" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">å¥–å“æ€»æ•°</h6>
            <h2 class="text-warning mb-0" x-text="stats.totalPrizes">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="card-body text-center">
            <i class="bi bi-currency-yen text-danger" style="font-size: 2rem;"></i>
            <h6 class="text-muted mt-2">é¢„ç®—æ¶ˆè€—</h6>
            <h2 class="text-danger mb-0" x-text="formatNumber(stats.budgetUsed)">-</h2>
          </div>
        </div>
      </div>
    </div>

    <!-- ç­›é€‰å’Œæ“ä½œæ  -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-center">
          <div class="col-md-3">
            <label class="form-label">æ´»åŠ¨çŠ¶æ€</label>
            <select class="form-select" x-model="filters.status">
              <option value="">å…¨éƒ¨çŠ¶æ€</option>
              <option value="active">è¿›è¡Œä¸­</option>
              <option value="paused">å·²æš‚åœ</option>
              <option value="ended">å·²ç»“æŸ</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">é¢„ç®—æ¨¡å¼</label>
            <select class="form-select" x-model="filters.budgetMode">
              <option value="">å…¨éƒ¨æ¨¡å¼</option>
              <option value="user">ç”¨æˆ·é¢„ç®—</option>
              <option value="pool">å¥–æ± é¢„ç®—</option>
              <option value="none">æ— é™åˆ¶</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">æœç´¢</label>
            <input type="text" class="form-control" x-model="filters.search" placeholder="æœç´¢æ´»åŠ¨åç§°..." @keyup.enter="loadCampaigns">
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-primary w-100" @click="loadCampaigns">
              <i class="bi bi-search"></i> æœç´¢
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- æ´»åŠ¨åˆ—è¡¨ -->
    <div class="row" x-show="campaigns.length > 0">
      <template x-for="campaign in campaigns" :key="campaign.campaign_id">
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card campaign-card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h6 class="mb-0" x-text="campaign.campaign_name || 'æœªå‘½åæ´»åŠ¨'"></h6>
              <span class="badge" 
                    :class="'status-' + (campaign.status || 'ended')"
                    x-text="getStatusText(campaign.status)"></span>
            </div>
            <div class="card-body">
              <p class="text-muted small mb-2">
                <i class="bi bi-calendar-event"></i> 
                <span x-text="formatDate(campaign.start_time)"></span> ~ <span x-text="formatDate(campaign.end_time)"></span>
              </p>
              <p class="mb-2">
                <i class="bi bi-wallet2 text-success"></i> 
                é¢„ç®—æ¨¡å¼: <strong x-text="getBudgetModeText(campaign.budget_mode)"></strong>
              </p>
              <div class="mb-2">
                <small class="text-muted">é¢„ç®—ä½¿ç”¨è¿›åº¦</small>
                <div class="progress budget-progress">
                  <div class="progress-bar" 
                       :class="getBudgetProgressColor(campaign)"
                       :style="'width: ' + calculateBudgetProgress(campaign) + '%'"></div>
                </div>
                <small class="text-muted" x-text="calculateBudgetProgress(campaign).toFixed(1) + '%'"></small>
              </div>
              <p class="mb-0">
                <i class="bi bi-gift text-warning"></i> 
                å¥–å“æ•°é‡: <strong x-text="campaign.prizes ? campaign.prizes.length : 0"></strong>
              </p>
            </div>
            <div class="card-footer bg-white">
              <button class="btn btn-sm btn-outline-primary" @click="viewCampaignDetail(campaign.campaign_id)">
                <i class="bi bi-eye"></i> æŸ¥çœ‹è¯¦æƒ…
              </button>
            </div>
          </div>
        </div>
      </template>
    </div>

    <!-- ç©ºçŠ¶æ€ -->
    <div class="card" x-show="!loading && campaigns.length === 0">
      <div class="card-body text-center py-5">
        <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
        <h5 class="text-muted mt-3">æš‚æ— æŠ½å¥–æ´»åŠ¨</h5>
        <p class="text-muted">è¯·ç­‰å¾…ç³»ç»Ÿç®¡ç†å‘˜åˆ›å»ºæ´»åŠ¨</p>
      </div>
    </div>
  </div>

  <!-- æ´»åŠ¨è¯¦æƒ…æ¨¡æ€æ¡† -->
  <div class="modal fade" id="campaignDetailModal" tabindex="-1" x-ref="detailModal">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-info-circle"></i> æ´»åŠ¨è¯¦æƒ…</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                  <i class="bi bi-info-square"></i> åŸºæœ¬ä¿¡æ¯
                </div>
                <div class="card-body">
                  <table class="table table-sm">
                    <tr><th style="width:40%">æ´»åŠ¨ID</th><td x-text="selectedCampaign?.campaign_id || '-'"></td></tr>
                    <tr><th>æ´»åŠ¨åç§°</th><td x-text="selectedCampaign?.campaign_name || '-'"></td></tr>
                    <tr><th>æ´»åŠ¨ä»£ç </th><td x-text="selectedCampaign?.campaign_code || '-'"></td></tr>
                    <tr><th>æ´»åŠ¨ç±»å‹</th><td x-text="selectedCampaign?.campaign_type || '-'"></td></tr>
                    <tr><th>æ´»åŠ¨çŠ¶æ€</th><td><span class="badge" :class="'status-' + (selectedCampaign?.status || 'ended')" x-text="getStatusText(selectedCampaign?.status)"></span></td></tr>
                    <tr><th>å¼€å§‹æ—¶é—´</th><td x-text="formatDateTime(selectedCampaign?.start_time)"></td></tr>
                    <tr><th>ç»“æŸæ—¶é—´</th><td x-text="formatDateTime(selectedCampaign?.end_time)"></td></tr>
                    <tr><th>åˆ›å»ºæ—¶é—´</th><td x-text="formatDateTime(selectedCampaign?.createdAt)"></td></tr>
                  </table>
                </div>
              </div>
            </div>
            <!-- é¢„ç®—é…ç½® -->
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header bg-success text-white">
                  <i class="bi bi-wallet2"></i> é¢„ç®—é…ç½®
                </div>
                <div class="card-body">
                  <table class="table table-sm">
                    <tr><th style="width:40%">é¢„ç®—æ¨¡å¼</th><td x-text="getBudgetModeText(selectedCampaign?.budget_mode)"></td></tr>
                    <tr><th>å¥–æ± æ€»é¢„ç®—</th><td x-text="formatNumber(selectedCampaign?.pool_budget_total || 0)"></td></tr>
                    <tr><th>å¥–æ± å‰©ä½™é¢„ç®—</th><td x-text="formatNumber(selectedCampaign?.pool_budget_remaining || 0)"></td></tr>
                    <tr><th>å¥–æ± å·²ç”¨é¢„ç®—</th><td x-text="formatNumber((selectedCampaign?.pool_budget_total || 0) - (selectedCampaign?.pool_budget_remaining || 0))"></td></tr>
                    <tr><th>æ€»å‚ä¸äººæ•°</th><td x-text="formatNumber(selectedCampaign?.total_participants || 0)"></td></tr>
                    <tr><th>æ€»æŠ½å¥–æ¬¡æ•°</th><td x-text="formatNumber(selectedCampaign?.total_draws || 0)"></td></tr>
                    <tr><th>æ€»ä¸­å¥–æ¬¡æ•°</th><td x-text="formatNumber(selectedCampaign?.total_prizes_awarded || 0)"></td></tr>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <!-- å¥–å“åˆ—è¡¨ -->
          <div class="card">
            <div class="card-header bg-warning">
              <i class="bi bi-gift"></i> å…³è”å¥–å“
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>å¥–å“åç§°</th>
                      <th>ç¨€æœ‰åº¦</th>
                      <th>åŸºç¡€æ¦‚ç‡</th>
                      <th>åº“å­˜</th>
                      <th>å·²å‘æ”¾</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-if="!selectedCampaign?.prizes || selectedCampaign.prizes.length === 0">
                      <tr><td colspan="5" class="text-center text-muted">æš‚æ— å¥–å“</td></tr>
                    </template>
                    <template x-for="prize in (selectedCampaign?.prizes || [])" :key="prize.prize_id">
                      <tr>
                        <td x-text="prize.prize_name || '-'"></td>
                        <td><span class="badge bg-secondary" x-text="prize.reward_tier || prize.prize_type || '-'"></span></td>
                        <td x-text="((prize.win_probability || 0) * 100).toFixed(2) + '%'"></td>
                        <td x-text="prize.stock_quantity || 0"></td>
                        <td x-text="prize.total_win_count || 0"></td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
        </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" :class="{ 'show': loading }">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">åŠ è½½ä¸­...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/lib/echarts.min.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script src="/admin/js/api-config.js"></script>
  <script src="/admin/js/pages/campaigns.js"></script>
  
  <!-- Alpine.js -->
  <script defer src="/admin/js/vendor/alpine.min.js"></script>
</body>
</html>
