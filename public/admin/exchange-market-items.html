<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…‘æ¢å¸‚åœºå•†å“ç®¡ç† - ç®¡ç†åå°</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">

  <style>
    .price-badge {
      font-size: 0.875rem;
      padding: 0.25rem 0.75rem;
    }
    .stock-warning { color: #ff6b6b; }
    .stock-low { color: #ffa500; }
    .stock-ok { color: #51cf66; }
  </style>
</head>
<body class="bg-light">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ›’ å…‘æ¢å¸‚åœº - å•†å“ç®¡ç†
      </a>
      <div>
        <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- æ“ä½œåŒºåŸŸ -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-0">
              <i class="bi bi-shop"></i> å…‘æ¢å•†å“ç®¡ç†
            </h5>
            <small class="text-muted">ç®¡ç†ç”¨æˆ·å¯å…‘æ¢çš„å®˜æ–¹å•†å“</small>
          </div>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
            <i class="bi bi-plus-lg"></i> æ·»åŠ å•†å“
          </button>
        </div>
      </div>
    </div>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="row g-3 mb-3">
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h6 class="text-muted">å•†å“æ€»æ•°</h6>
            <h3 class="text-primary" id="totalItems">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h6 class="text-muted">ä¸Šæ¶å•†å“</h6>
            <h3 class="text-success" id="activeItems">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h6 class="text-muted">åº“å­˜é¢„è­¦</h6>
            <h3 class="text-warning" id="lowStockItems">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body text-center">
            <h6 class="text-muted">æ€»å…‘æ¢æ¬¡æ•°</h6>
            <h3 class="text-info" id="totalExchanges">-</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- ç­›é€‰åŒºåŸŸ -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">çŠ¶æ€ç­›é€‰</label>
            <select class="form-select" id="statusFilter">
              <option value="">å…¨éƒ¨çŠ¶æ€</option>
              <option value="active">ä¸Šæ¶</option>
              <option value="inactive">ä¸‹æ¶</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">æ”¯ä»˜æ–¹å¼</label>
            <select class="form-select" id="priceTypeFilter">
              <option value="">å…¨éƒ¨æ–¹å¼</option>
              <option value="virtual">è™šæ‹Ÿå¥–å“ä»·å€¼</option>
              <option value="points">ç§¯åˆ†</option>
              <option value="mixed">æ··åˆæ”¯ä»˜</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">æ’åºæ–¹å¼</label>
            <select class="form-select" id="sortByFilter">
              <option value="sort_order">æŒ‰æ’åºå·</option>
              <option value="created_at">æŒ‰åˆ›å»ºæ—¶é—´</option>
              <option value="stock">æŒ‰åº“å­˜</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-primary w-100" id="searchBtn">
              <i class="bi bi-search"></i> æŸ¥è¯¢
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- æ•°æ®è¡¨æ ¼ -->
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th style="width: 60px;">ID</th>
                <th>å•†å“ä¿¡æ¯</th>
                <th>æ”¯ä»˜æ–¹å¼</th>
                <th>ä»·æ ¼</th>
                <th>åº“å­˜</th>
                <th>å…‘æ¢æ¬¡æ•°</th>
                <th>çŠ¶æ€</th>
                <th>æ’åº</th>
                <th style="width: 200px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="itemsTableBody">
              <tr>
                <td colspan="9" class="text-center py-5">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                  </div>
                  <p class="mt-2 text-muted">æ­£åœ¨åŠ è½½æ•°æ®...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- åˆ†é¡µ -->
        <nav aria-label="åˆ†é¡µ" class="mt-3">
          <ul class="pagination justify-content-end" id="pagination"></ul>
        </nav>
      </div>
    </div>
  </div>

  <!-- æ·»åŠ å•†å“æ¨¡æ€æ¡† -->
  <div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-plus-circle"></i> æ·»åŠ å…‘æ¢å•†å“
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addItemForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">å•†å“åç§° <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="item_name" required maxlength="100">
              </div>
              <div class="col-md-6">
                <label class="form-label">æ”¯ä»˜æ–¹å¼ <span class="text-danger">*</span></label>
                <select class="form-select" name="price_type" required id="priceTypeSelect">
                  <option value="">è¯·é€‰æ‹©</option>
                  <option value="virtual">è™šæ‹Ÿå¥–å“ä»·å€¼</option>
                  <option value="points">ç§¯åˆ†</option>
                  <option value="mixed">æ··åˆæ”¯ä»˜</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">å•†å“æè¿°</label>
                <textarea class="form-control" name="item_description" rows="3" maxlength="500"></textarea>
              </div>
              <div class="col-md-6" id="virtualPriceGroup" style="display:none;">
                <label class="form-label">è™šæ‹Ÿä»·å€¼ä»·æ ¼ <span class="text-danger">*</span></label>
                <input type="number" class="form-control" name="virtual_value_price" min="0" step="0.01">
                <small class="text-muted">ç”¨æˆ·éœ€è¦æ¶ˆè€—çš„è™šæ‹Ÿå¥–å“ä»·å€¼</small>
              </div>
              <div class="col-md-6" id="pointsPriceGroup" style="display:none;">
                <label class="form-label">ç§¯åˆ†ä»·æ ¼ <span class="text-danger">*</span></label>
                <input type="number" class="form-control" name="points_price" min="0">
                <small class="text-muted">ç”¨æˆ·éœ€è¦æ¶ˆè€—çš„ç§¯åˆ†æ•°é‡</small>
              </div>
              <div class="col-md-4">
                <label class="form-label">æˆæœ¬ä»· <span class="text-danger">*</span></label>
                <input type="number" class="form-control" name="cost_price" min="0" step="0.01" required>
                <small class="text-muted">å†…éƒ¨æˆæœ¬ï¼ˆç®¡ç†å‘˜å¯è§ï¼‰</small>
              </div>
              <div class="col-md-4">
                <label class="form-label">åˆå§‹åº“å­˜ <span class="text-danger">*</span></label>
                <input type="number" class="form-control" name="stock" min="0" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">æ’åºå· <span class="text-danger">*</span></label>
                <input type="number" class="form-control" name="sort_order" value="100" required>
                <small class="text-muted">æ•°å­—è¶Šå°è¶Šé å‰</small>
              </div>
              <div class="col-md-12">
                <label class="form-label">å•†å“çŠ¶æ€ <span class="text-danger">*</span></label>
                <select class="form-select" name="status" required>
                  <option value="active">ä¸Šæ¶</option>
                  <option value="inactive">ä¸‹æ¶</option>
                </select>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" id="submitAddItemBtn">
            <i class="bi bi-check-lg"></i> æ·»åŠ 
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç¼–è¾‘å•†å“æ¨¡æ€æ¡† -->
  <div class="modal fade" id="editItemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-pencil-square"></i> ç¼–è¾‘å•†å“
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editItemForm">
            <input type="hidden" name="item_id" id="editItemId">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">å•†å“åç§° <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="item_name" id="editItemName" required maxlength="100">
              </div>
              <div class="col-md-6">
                <label class="form-label">æ”¯ä»˜æ–¹å¼ <span class="text-danger">*</span></label>
                <select class="form-select" name="price_type" id="editPriceType" required>
                  <option value="virtual">è™šæ‹Ÿå¥–å“ä»·å€¼</option>
                  <option value="points">ç§¯åˆ†</option>
                  <option value="mixed">æ··åˆæ”¯ä»˜</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">å•†å“æè¿°</label>
                <textarea class="form-control" name="item_description" id="editItemDescription" rows="3"></textarea>
              </div>
              <div class="col-md-6" id="editVirtualPriceGroup">
                <label class="form-label">è™šæ‹Ÿä»·å€¼ä»·æ ¼</label>
                <input type="number" class="form-control" name="virtual_value_price" id="editVirtualPrice" min="0" step="0.01">
              </div>
              <div class="col-md-6" id="editPointsPriceGroup">
                <label class="form-label">ç§¯åˆ†ä»·æ ¼</label>
                <input type="number" class="form-control" name="points_price" id="editPointsPrice" min="0">
              </div>
              <div class="col-md-4">
                <label class="form-label">æˆæœ¬ä»·</label>
                <input type="number" class="form-control" name="cost_price" id="editCostPrice" min="0" step="0.01">
              </div>
              <div class="col-md-4">
                <label class="form-label">å½“å‰åº“å­˜</label>
                <input type="number" class="form-control" name="stock" id="editStock" min="0">
              </div>
              <div class="col-md-4">
                <label class="form-label">æ’åºå·</label>
                <input type="number" class="form-control" name="sort_order" id="editSortOrder">
              </div>
              <div class="col-md-12">
                <label class="form-label">å•†å“çŠ¶æ€</label>
                <select class="form-select" name="status" id="editStatus">
                  <option value="active">ä¸Šæ¶</option>
                  <option value="inactive">ä¸‹æ¶</option>
                </select>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" id="submitEditItemBtn">
            <i class="bi bi-check-lg"></i> ä¿å­˜
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- åŠ è½½é®ç½©å±‚ -->
  <div class="loading-overlay" id="loadingOverlay" style="display:none;">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">å¤„ç†ä¸­...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/admin-common.js"></script>

  <script>
    // å…¨å±€å˜é‡
    let currentPage = 1;
    const pageSize = 20;
    let currentFilters = {
      status: '',
      price_type: '',
      sort_by: 'sort_order'
    };

    // é¡µé¢åŠ è½½
    document.addEventListener('DOMContentLoaded', function() {
      checkAuth();
      loadItems();
      bindEvents();
    });

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
      document.getElementById('logoutBtn').addEventListener('click', logout);
      document.getElementById('searchBtn').addEventListener('click', handleSearch);
      document.getElementById('priceTypeSelect').addEventListener('change', handlePriceTypeChange);
      document.getElementById('editPriceType').addEventListener('change', handleEditPriceTypeChange);
      document.getElementById('submitAddItemBtn').addEventListener('click', handleAddItem);
      document.getElementById('submitEditItemBtn').addEventListener('click', handleEditItem);
    }

    // å¤„ç†æ”¯ä»˜æ–¹å¼é€‰æ‹©
    function handlePriceTypeChange(e) {
      const priceType = e.target.value;
      const virtualGroup = document.getElementById('virtualPriceGroup');
      const pointsGroup = document.getElementById('pointsPriceGroup');
      const virtualInput = document.querySelector('#addItemForm [name="virtual_value_price"]');
      const pointsInput = document.querySelector('#addItemForm [name="points_price"]');

      virtualGroup.style.display = 'none';
      pointsGroup.style.display = 'none';
      virtualInput.required = false;
      pointsInput.required = false;

      if (priceType === 'virtual' || priceType === 'mixed') {
        virtualGroup.style.display = 'block';
        virtualInput.required = true;
      }
      if (priceType === 'points' || priceType === 'mixed') {
        pointsGroup.style.display = 'block';
        pointsInput.required = true;
      }
    }

    function handleEditPriceTypeChange(e) {
      const priceType = e.target.value;
      const virtualGroup = document.getElementById('editVirtualPriceGroup');
      const pointsGroup = document.getElementById('editPointsPriceGroup');

      virtualGroup.style.display = (priceType === 'virtual' || priceType === 'mixed') ? 'block' : 'none';
      pointsGroup.style.display = (priceType === 'points' || priceType === 'mixed') ? 'block' : 'none';
    }

    // å¤„ç†æœç´¢
    function handleSearch() {
      currentFilters = {
        status: document.getElementById('statusFilter').value,
        price_type: document.getElementById('priceTypeFilter').value,
        sort_by: document.getElementById('sortByFilter').value
      };
      currentPage = 1;
      loadItems();
    }

    // åŠ è½½å•†å“åˆ—è¡¨
    async function loadItems() {
      try {
        showLoading(true);
        const token = getToken();

        const params = new URLSearchParams({
          page: currentPage,
          page_size: pageSize,
          sort_by: currentFilters.sort_by || 'sort_order',
          sort_order: 'ASC'
        });

        if (currentFilters.status) params.append('status', currentFilters.status);
        if (currentFilters.price_type) params.append('price_type', currentFilters.price_type);

        const response = await fetch(`/api/v4/exchange_market/items?${params}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await response.json();

        if (data.success) {
          renderItems(data.data.items);
          renderPagination(data.data.pagination);
          updateStats(data.data.items);
        } else {
          showError(data.message || 'åŠ è½½å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½å•†å“åˆ—è¡¨å¤±è´¥', error);
        showError('åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        showLoading(false);
      }
    }

    // æ¸²æŸ“å•†å“åˆ—è¡¨
    function renderItems(items) {
      const tbody = document.getElementById('itemsTableBody');

      if (!items || items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>';
        return;
      }

      tbody.innerHTML = items.map(item => {
        const stockClass = item.stock === 0 ? 'stock-warning' : (item.stock <= 10 ? 'stock-low' : 'stock-ok');
        const statusBadge = item.status === 'active'
          ? '<span class="badge bg-success">ä¸Šæ¶</span>'
          : '<span class="badge bg-secondary">ä¸‹æ¶</span>';

        let priceDisplay = '';
        if (item.price_type === 'virtual') {
          priceDisplay = `<span class="badge bg-info">${item.virtual_value_price} è™šæ‹Ÿä»·å€¼</span>`;
        } else if (item.price_type === 'points') {
          priceDisplay = `<span class="badge bg-primary">${item.points_price} ç§¯åˆ†</span>`;
        } else if (item.price_type === 'mixed') {
          priceDisplay = `
            <span class="badge bg-info">${item.virtual_value_price} è™šæ‹Ÿ</span>
            <span class="badge bg-primary">${item.points_price} ç§¯åˆ†</span>
          `;
        }

        return `
          <tr>
            <td>${item.id}</td>
            <td>
              <div><strong>${escapeHtml(item.name)}</strong></div>
              <small class="text-muted">${escapeHtml(item.description || '')}</small>
            </td>
            <td>${getPriceTypeText(item.price_type)}</td>
            <td>${priceDisplay}</td>
            <td><span class="${stockClass}">${item.stock}</span></td>
            <td>${item.total_exchange_count || 0}</td>
            <td>${statusBadge}</td>
            <td>${item.sort_order}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="editItem(${item.id})">
                <i class="bi bi-pencil"></i> ç¼–è¾‘
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteItem(${item.id})">
                <i class="bi bi-trash"></i> åˆ é™¤
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    function updateStats(items) {
      const stats = {
        total: items.length,
        active: items.filter(i => i.status === 'active').length,
        lowStock: items.filter(i => i.stock <= 10 && i.stock > 0).length,
        totalExchanges: items.reduce((sum, i) => sum + (i.total_exchange_count || 0), 0)
      };

      document.getElementById('totalItems').textContent = stats.total;
      document.getElementById('activeItems').textContent = stats.active;
      document.getElementById('lowStockItems').textContent = stats.lowStock;
      document.getElementById('totalExchanges').textContent = stats.totalExchanges;
    }

    // æ¸²æŸ“åˆ†é¡µ
    function renderPagination(pagination) {
      const paginationEl = document.getElementById('pagination');
      if (!pagination || pagination.total_pages <= 1) {
        paginationEl.innerHTML = '';
        return;
      }

      let html = '';
      for (let i = 1; i <= pagination.total_pages; i++) {
        html += `
          <li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
          </li>
        `;
      }
      paginationEl.innerHTML = html;
    }

    // åˆ‡æ¢é¡µç 
    function changePage(page) {
      currentPage = page;
      loadItems();
    }

    // æ·»åŠ å•†å“
    async function handleAddItem() {
      try {
        const form = document.getElementById('addItemForm');
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        showLoading(true);
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // ç±»å‹è½¬æ¢
        data.virtual_value_price = parseFloat(data.virtual_value_price) || 0;
        data.points_price = parseInt(data.points_price) || 0;
        data.cost_price = parseFloat(data.cost_price) || 0;
        data.stock = parseInt(data.stock) || 0;
        data.sort_order = parseInt(data.sort_order) || 100;

        const token = getToken();
        const response = await fetch('/api/v4/admin/exchange_market/items', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
          showSuccess('æ·»åŠ æˆåŠŸ');
          bootstrap.Modal.getInstance(document.getElementById('addItemModal')).hide();
          form.reset();
          loadItems();
        } else {
          showError(result.message || 'æ·»åŠ å¤±è´¥');
        }
      } catch (error) {
        console.error('æ·»åŠ å•†å“å¤±è´¥', error);
        showError('æ·»åŠ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        showLoading(false);
      }
    }

    // ç¼–è¾‘å•†å“
    async function editItem(itemId) {
      try {
        showLoading(true);
        const token = getToken();

        const response = await fetch(`/api/v4/exchange_market/items/${itemId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await response.json();

        if (data.success) {
          const item = data.data.item;

          document.getElementById('editItemId').value = item.id;
          document.getElementById('editItemName').value = item.name;
          document.getElementById('editItemDescription').value = item.description || '';
          document.getElementById('editPriceType').value = item.price_type;
          document.getElementById('editVirtualPrice').value = item.virtual_value_price || 0;
          document.getElementById('editPointsPrice').value = item.points_price || 0;
          document.getElementById('editCostPrice').value = item.cost_price || 0;
          document.getElementById('editStock').value = item.stock;
          document.getElementById('editSortOrder').value = item.sort_order;
          document.getElementById('editStatus').value = item.status;

          handleEditPriceTypeChange({ target: { value: item.price_type } });

          new bootstrap.Modal(document.getElementById('editItemModal')).show();
        } else {
          showError(data.message || 'è·å–å•†å“ä¿¡æ¯å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½å•†å“ä¿¡æ¯å¤±è´¥', error);
        showError('åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        showLoading(false);
      }
    }

    // æäº¤ç¼–è¾‘
    async function handleEditItem() {
      try {
        const form = document.getElementById('editItemForm');
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        showLoading(true);
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        const itemId = data.item_id;
        delete data.item_id;

        // ç±»å‹è½¬æ¢
        data.virtual_value_price = parseFloat(data.virtual_value_price) || 0;
        data.points_price = parseInt(data.points_price) || 0;
        data.cost_price = parseFloat(data.cost_price) || 0;
        data.stock = parseInt(data.stock) || 0;
        data.sort_order = parseInt(data.sort_order) || 100;

        const token = getToken();
        const response = await fetch(`/api/v4/admin/exchange_market/items/${itemId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
          showSuccess('æ›´æ–°æˆåŠŸ');
          bootstrap.Modal.getInstance(document.getElementById('editItemModal')).hide();
          loadItems();
        } else {
          showError(result.message || 'æ›´æ–°å¤±è´¥');
        }
      } catch (error) {
        console.error('æ›´æ–°å•†å“å¤±è´¥', error);
        showError('æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        showLoading(false);
      }
    }

    // åˆ é™¤å•†å“
    async function deleteItem(itemId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•†å“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        return;
      }

      try {
        showLoading(true);
        const token = getToken();

        const response = await fetch(`/api/v4/admin/exchange_market/items/${itemId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await response.json();

        if (data.success) {
          showSuccess('åˆ é™¤æˆåŠŸ');
          loadItems();
        } else {
          showError(data.message || 'åˆ é™¤å¤±è´¥');
        }
      } catch (error) {
        console.error('åˆ é™¤å•†å“å¤±è´¥', error);
        showError('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        showLoading(false);
      }
    }

    // å·¥å…·å‡½æ•°
    function getPriceTypeText(type) {
      const map = {
        'virtual': 'è™šæ‹Ÿä»·å€¼',
        'points': 'ç§¯åˆ†',
        'mixed': 'æ··åˆæ”¯ä»˜'
      };
      return map[type] || type;
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showLoading(show) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    function showSuccess(message) {
      alert(message); // å¯ä»¥æ›¿æ¢ä¸ºæ›´å¥½çš„æç¤ºç»„ä»¶
    }

    function showError(message) {
      alert(message); // å¯ä»¥æ›¿æ¢ä¸ºæ›´å¥½çš„æç¤ºç»„ä»¶
    }
  </script>
</body>
</html>
