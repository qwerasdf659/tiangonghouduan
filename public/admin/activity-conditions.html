<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ´»åŠ¨æ¡ä»¶é…ç½® - ç®¡ç†åå°</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">

  <style>
    .condition-row {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 1px solid #dee2e6;
    }
    .condition-preview {
      background: #fff;
      border: 1px solid #0d6efd;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
    }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ¯ æ´»åŠ¨æ¡ä»¶é…ç½®
      </a>
      <div>
        <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">é€‰æ‹©æ´»åŠ¨</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <label class="form-label">æ´»åŠ¨åç§°</label>
            <select class="form-select" id="activitySelect" onchange="loadActivityConditions()">
              <option value="">-- è¯·é€‰æ‹©æ´»åŠ¨ --</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">æ´»åŠ¨çŠ¶æ€</label>
            <input type="text" class="form-control" id="activityStatus" readonly>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">å‚ä¸æ¡ä»¶é…ç½®</h5>
        <button class="btn btn-sm btn-success" onclick="addCondition()">
          <i class="bi bi-plus-circle"></i> æ·»åŠ æ¡ä»¶
        </button>
      </div>
      <div class="card-body">
        <div id="conditionsContainer"></div>

        <div class="condition-preview">
          <h6><i class="bi bi-eye"></i> æ¡ä»¶é¢„è§ˆ</h6>
          <div id="conditionPreview" class="text-muted">æš‚æ— æ¡ä»¶é…ç½®</div>
        </div>

        <div class="mt-4 d-flex gap-2">
          <button class="btn btn-primary" onclick="saveConditions()">
            <i class="bi bi-save"></i> ä¿å­˜é…ç½®
          </button>
          <button class="btn btn-outline-danger" onclick="clearAllConditions()">
            <i class="bi bi-trash"></i> æ¸…ç©ºæ‰€æœ‰æ¡ä»¶
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/admin-common.js"></script>

  <script>
    let conditionCounter = 0;
    let currentActivityCode = null;

    const CONDITION_TYPES = {
      'user_points': {
        label: 'ç”¨æˆ·ç§¯åˆ†',
        operators: ['>=', '<=', '>', '<', '='],
        valueType: 'number',
        placeholder: 'å¦‚ï¼š100',
        defaultMessage: 'æ‚¨çš„ç§¯åˆ†ä¸è¶³ï¼Œå¿«å»æ¶ˆè´¹è·å–ç§¯åˆ†å§ï¼'
      },
      'user_type': {
        label: 'ç”¨æˆ·ç±»å‹',
        operators: ['=', 'in'],
        valueType: 'select',
        options: ['normal', 'vip', 'svip', 'admin'],
        placeholder: 'é€‰æ‹©ç”¨æˆ·ç±»å‹',
        defaultMessage: 'æ­¤æ´»åŠ¨ä»…é™ç‰¹å®šç”¨æˆ·ç±»å‹å‚ä¸'
      },
      'registration_days': {
        label: 'æ³¨å†Œå¤©æ•°',
        operators: ['>=', '<=', '>', '<'],
        valueType: 'number',
        placeholder: 'å¦‚ï¼š30',
        defaultMessage: 'æ³¨å†Œæ»¡30å¤©åæ‰èƒ½å‚ä¸'
      },
      'consecutive_fail_count': {
        label: 'è¿ç»­æœªä¸­å¥–æ¬¡æ•°',
        operators: ['>=', '<=', '='],
        valueType: 'number',
        placeholder: 'å¦‚ï¼š10',
        defaultMessage: 'è¿ç»­æœªä¸­å¥–æ¬¡æ•°ä¸è¶³ï¼Œç»§ç»­åŠªåŠ›å§ï¼'
      }
    };

    document.addEventListener('DOMContentLoaded', function() {
      if (!checkAdminPermission()) return;
      loadActivities();
    });

    async function loadActivities() {
      try {
        const response = await apiRequest('/api/v4/lottery/campaigns');
        if (response && response.success && response.data) {
          const select = document.getElementById('activitySelect');
          select.innerHTML = '<option value="">-- è¯·é€‰æ‹©æ´»åŠ¨ --</option>';

          response.data.forEach(activity => {
            const option = document.createElement('option');
            option.value = activity.campaign_code;
            option.dataset.campaignId = activity.campaign_id;
            const statusText = activity.status === 'active' ? 'è¿›è¡Œä¸­' : activity.status === 'draft' ? 'è‰ç¨¿' : 'å·²ç»“æŸ';
            option.textContent = `${activity.campaign_name} (${statusText})`;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('åŠ è½½æ´»åŠ¨åˆ—è¡¨å¤±è´¥:', error);
        alert('åŠ è½½æ´»åŠ¨åˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
      }
    }

    async function loadActivityConditions() {
      const campaignCode = document.getElementById('activitySelect').value;
      if (!campaignCode) {
        clearConditionsUI();
        return;
      }

      currentActivityCode = campaignCode;

      try {
        const response = await apiRequest(`/api/v4/lottery/campaigns/${campaignCode}`);
        if (response && response.success && response.data) {
          const activity = response.data;
          const statusMap = {'active': 'è¿›è¡Œä¸­', 'draft': 'è‰ç¨¿', 'paused': 'å·²æš‚åœ', 'completed': 'å·²ç»“æŸ'};
          document.getElementById('activityStatus').value = statusMap[activity.status] || activity.status;

          clearConditionsUI();

          const conditions = activity.participation_conditions || {};
          const messages = activity.condition_error_messages || {};

          if (Object.keys(conditions).length > 0) {
            Object.entries(conditions).forEach(([type, rule]) => {
              addCondition(type, rule.operator, rule.value, messages[type]);
            });
          }
          updatePreview();
        }
      } catch (error) {
        console.error('åŠ è½½æ´»åŠ¨æ¡ä»¶å¤±è´¥:', error);
        alert('åŠ è½½æ´»åŠ¨æ¡ä»¶å¤±è´¥: ' + error.message);
      }
    }

    function addCondition(presetType = '', presetOperator = '', presetValue = '', presetMessage = '') {
      conditionCounter++;
      const id = conditionCounter;
      const container = document.getElementById('conditionsContainer');
      const conditionRow = document.createElement('div');
      conditionRow.className = 'condition-row';
      conditionRow.id = `condition-${id}`;

      const defaultType = presetType || 'user_points';
      const defaultOperator = presetOperator || '>=';

      conditionRow.innerHTML = `
        <div class="row g-2">
          <div class="col-md-3">
            <label class="form-label small">æ¡ä»¶ç±»å‹</label>
            <select class="form-control form-control-sm" id="type-${id}" onchange="updateConditionUI(${id})">
              ${Object.entries(CONDITION_TYPES).map(([key, config]) => `
                <option value="${key}" ${key === defaultType ? 'selected' : ''}>${config.label}</option>
              `).join('')}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label small">è¿ç®—ç¬¦</label>
            <select class="form-control form-control-sm" id="operator-${id}" onchange="updatePreview()"></select>
          </div>
          <div class="col-md-2">
            <label class="form-label small">æ¡ä»¶å€¼</label>
            <div id="value-container-${id}"></div>
          </div>
          <div class="col-md-4">
            <label class="form-label small">ä¸æ»¡è¶³æ—¶çš„æç¤ºè¯­</label>
            <input type="text" class="form-control form-control-sm" id="message-${id}"
                   placeholder="å¦‚ï¼šæ‚¨çš„ç§¯åˆ†ä¸è¶³100åˆ†"
                   value="${presetMessage || CONDITION_TYPES[defaultType].defaultMessage}"
                   onchange="updatePreview()">
          </div>
          <div class="col-md-1 d-flex align-items-end">
            <button class="btn btn-sm btn-outline-danger w-100" onclick="removeCondition(${id})">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      `;

      container.appendChild(conditionRow);
      updateConditionUI(id, presetOperator, presetValue);
      updatePreview();
    }

    function updateConditionUI(id, presetOperator = '', presetValue = '') {
      const typeSelect = document.getElementById(`type-${id}`);
      const type = typeSelect.value;
      const config = CONDITION_TYPES[type];

      const operatorSelect = document.getElementById(`operator-${id}`);
      operatorSelect.innerHTML = config.operators.map(op => `
        <option value="${op}" ${op === presetOperator ? 'selected' : ''}>${op}</option>
      `).join('');

      const valueContainer = document.getElementById(`value-container-${id}`);
      if (config.valueType === 'number') {
        valueContainer.innerHTML = `
          <input type="number" class="form-control form-control-sm" id="value-${id}"
                 placeholder="${config.placeholder}"
                 value="${presetValue || ''}"
                 onchange="updatePreview()">
        `;
      } else if (config.valueType === 'select') {
        const isMultiple = operatorSelect.value === 'in';
        if (isMultiple) {
          valueContainer.innerHTML = `
            <select class="form-control form-control-sm" id="value-${id}" multiple onchange="updatePreview()">
              ${config.options.map(opt => `
                <option value="${opt}" ${Array.isArray(presetValue) && presetValue.includes(opt) ? 'selected' : ''}>${opt}</option>
              `).join('')}
            </select>
          `;
        } else {
          valueContainer.innerHTML = `
            <select class="form-control form-control-sm" id="value-${id}" onchange="updatePreview()">
              ${config.options.map(opt => `
                <option value="${opt}" ${opt === presetValue ? 'selected' : ''}>${opt}</option>
              `).join('')}
            </select>
          `;
        }
      }

      const messageInput = document.getElementById(`message-${id}`);
      if (!messageInput.value || messageInput.value === CONDITION_TYPES[typeSelect.dataset.prevType]?.defaultMessage) {
        messageInput.value = config.defaultMessage;
      }
      typeSelect.dataset.prevType = type;
      updatePreview();
    }

    function removeCondition(id) {
      const row = document.getElementById(`condition-${id}`);
      if (row) {
        row.remove();
        updatePreview();
      }
    }

    function clearAllConditions() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ¡ä»¶å—ï¼Ÿ')) {
        clearConditionsUI();
        updatePreview();
      }
    }

    function clearConditionsUI() {
      document.getElementById('conditionsContainer').innerHTML = '';
      conditionCounter = 0;
      document.getElementById('conditionPreview').innerHTML = 'æš‚æ— æ¡ä»¶é…ç½®';
    }

    function updatePreview() {
      const conditions = collectConditions();
      const previewDiv = document.getElementById('conditionPreview');

      if (conditions.participation_conditions && Object.keys(conditions.participation_conditions).length > 0) {
        let html = '<div class="alert alert-info mb-0">';
        html += '<strong>å‚ä¸æ­¤æ´»åŠ¨éœ€è¦æ»¡è¶³ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶ï¼š</strong><ul class="mb-0 mt-2">';

        Object.entries(conditions.participation_conditions).forEach(([type, rule]) => {
          const config = CONDITION_TYPES[type];
          let valueDisplay = rule.value;
          if (Array.isArray(rule.value)) {
            valueDisplay = rule.value.join('ã€');
          }
          html += `<li><strong>${config.label}</strong> <span class="badge bg-secondary">${rule.operator}</span> ${valueDisplay}</li>`;
        });

        html += '</ul></div>';
        previewDiv.innerHTML = html;
      } else {
        previewDiv.innerHTML = '<div class="text-muted">æš‚æ— æ¡ä»¶é…ç½®ï¼ˆæ‰€æœ‰ç”¨æˆ·å‡å¯å‚ä¸ï¼‰</div>';
      }
    }

    function collectConditions() {
      const participation_conditions = {};
      const condition_error_messages = {};

      document.querySelectorAll('.condition-row').forEach(row => {
        const id = row.id.replace('condition-', '');
        const type = document.getElementById(`type-${id}`).value;
        const operator = document.getElementById(`operator-${id}`).value;
        const valueElement = document.getElementById(`value-${id}`);
        const message = document.getElementById(`message-${id}`).value;

        let value;
        if (valueElement.tagName === 'SELECT' && valueElement.multiple) {
          value = Array.from(valueElement.selectedOptions).map(opt => opt.value);
        } else {
          value = valueElement.value;
          if (!isNaN(value) && value !== '') {
            value = Number(value);
          }
        }

        participation_conditions[type] = { operator, value };
        condition_error_messages[type] = message;
      });

      return { participation_conditions, condition_error_messages };
    }

    async function saveConditions() {
      if (!currentActivityCode) {
        alert('è¯·å…ˆé€‰æ‹©æ´»åŠ¨');
        return;
      }

      const conditions = collectConditions();

      if (Object.keys(conditions.participation_conditions).length === 0) {
        if (!confirm('æœªé…ç½®ä»»ä½•æ¡ä»¶ï¼Œè¿™æ„å‘³ç€æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥å‚ä¸æ­¤æ´»åŠ¨ã€‚ç¡®å®šè¦ä¿å­˜å—ï¼Ÿ')) {
          return;
        }
      }

      try {
        const response = await apiRequest(
          `/api/v4/activities/${currentActivityCode}/configure-conditions`,
          {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(conditions)
          }
        );

        if (response && response.success) {
          alert('âœ… æ¡ä»¶é…ç½®ä¿å­˜æˆåŠŸï¼');
        } else {
          alert('ä¿å­˜å¤±è´¥: ' + (response?.message || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (error) {
        console.error('ä¿å­˜æ¡ä»¶å¤±è´¥:', error);
        if (error.message.includes('403') || error.message.includes('æƒé™')) {
          alert('ä¿å­˜å¤±è´¥: æ‚¨æ²¡æœ‰ç®¡ç†å‘˜æƒé™ï¼Œè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜');
        } else if (error.message.includes('404')) {
          alert('ä¿å­˜å¤±è´¥: æ´»åŠ¨ä¸å­˜åœ¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        } else {
          alert('ä¿å­˜å¤±è´¥: ' + error.message);
        }
      }
    }
  </script>
</body>
</html>
