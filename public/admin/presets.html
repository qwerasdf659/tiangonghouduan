<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æŠ½å¥–é¢„è®¾ç®¡ç† - ç®¡ç†åå°</title>
  
  <!-- âœ… Bootstrap 5 - UIæ¡†æ¶ -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- âœ… Bootstrap Icons - å›¾æ ‡åº“ -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- âœ… å…¬å…±æ ·å¼è¡¨ - ç»Ÿä¸€ä¸»é¢˜å’Œå“åº”å¼è®¾è®¡ -->
  <link href="/admin/css/common.css" rel="stylesheet">
  
  <!-- âœ… é¡µé¢ç‰¹æœ‰æ ·å¼ -->
  <style>
    .prize-card {
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .prize-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .probability-bar {
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      background: #e9ecef;
    }
    .probability-fill {
      height: 100%;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body class="bg-light">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ¯ ç®¡ç†åå° - æŠ½å¥–é¢„è®¾ç®¡ç†
      </a>
      <div>
        <span class="text-light me-3" id="welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>
  
  <div class="container-fluid mt-4">
    <!-- æ“ä½œåŒºåŸŸ -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-0">
              <i class="bi bi-gift"></i> æŠ½å¥–é¢„è®¾é…ç½®
            </h5>
            <small class="text-muted">åˆ›å»ºå’Œç®¡ç†æŠ½å¥–é¢„è®¾æ–¹æ¡ˆ</small>
          </div>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPresetModal">
            <i class="bi bi-plus-lg"></i> åˆ›å»ºæ–°é¢„è®¾
          </button>
        </div>
      </div>
    </div>
    
    <!-- é¢„è®¾åˆ—è¡¨ -->
    <div class="row g-3" id="presetsList">
      <div class="col-12 text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">åŠ è½½ä¸­...</span>
        </div>
        <p class="mt-2 text-muted">æ­£åœ¨åŠ è½½é¢„è®¾åˆ—è¡¨...</p>
      </div>
    </div>
  </div>
  
  <!-- åˆ›å»ºé¢„è®¾æ¨¡æ€æ¡† -->
  <div class="modal fade" id="createPresetModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-plus-circle"></i> åˆ›å»ºæŠ½å¥–é¢„è®¾
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- åŸºæœ¬ä¿¡æ¯ -->
          <div class="card mb-3">
            <div class="card-header">
              <h6 class="mb-0"><i class="bi bi-info-circle"></i> åŸºæœ¬ä¿¡æ¯</h6>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">é¢„è®¾åç§° <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="presetName" placeholder="ä¾‹å¦‚ï¼šå‘¨æœ«ç‰¹æƒ é¢„è®¾">
                </div>
                <div class="col-md-6">
                  <label class="form-label">é¢„è®¾ç±»å‹</label>
                  <select class="form-select" id="presetType">
                    <option value="normal">æ™®é€šæŠ½å¥–</option>
                    <option value="special">ç‰¹æ®Šæ´»åŠ¨</option>
                    <option value="vip">VIPä¸“å±</option>
                  </select>
                </div>
                <div class="col-12">
                  <label class="form-label">é¢„è®¾æè¿°</label>
                  <textarea class="form-control" id="presetDescription" rows="2" placeholder="è¯·è¾“å…¥é¢„è®¾è¯´æ˜..."></textarea>
                </div>
              </div>
            </div>
          </div>
          
          <!-- å¥–å“é…ç½® -->
          <div class="card">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-box-seam"></i> å¥–å“é…ç½®</h6>
                <button type="button" class="btn btn-sm btn-success" id="addPrizeItemBtn">
                  <i class="bi bi-plus"></i> æ·»åŠ å¥–å“
                </button>
              </div>
            </div>
            <div class="card-body">
              <div id="prizesContainer">
                <!-- å¥–å“é¡¹ç›®å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
              </div>
              <div class="alert alert-info mt-3 mb-0" role="alert">
                <i class="bi bi-lightbulb"></i> 
                <strong>æç¤ºï¼š</strong>æ‰€æœ‰å¥–å“çš„æ¦‚ç‡æ€»å’Œåº”ç­‰äº100%
                <span class="ms-3">å½“å‰æ€»æ¦‚ç‡ï¼š<strong id="totalProbability">0.00</strong>%</span>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" id="submitPresetBtn">
            <i class="bi bi-check-lg"></i> åˆ›å»ºé¢„è®¾
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- æŸ¥çœ‹é¢„è®¾è¯¦æƒ…æ¨¡æ€æ¡† -->
  <div class="modal fade" id="viewPresetModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewPresetTitle">é¢„è®¾è¯¦æƒ…</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="viewPresetBody">
          <!-- é¢„è®¾è¯¦æƒ…å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- åŠ è½½é®ç½©å±‚ -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">å¤„ç†ä¸­...</span>
    </div>
  </div>

  <!-- âœ… Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- âœ… å¼•å…¥é€šç”¨å·¥å…·åº“ -->
  <script src="/admin/js/admin-common.js"></script>
  
  <script>
    /**
     * å…¨å±€å˜é‡
     */
    let prizeItemCount = 0;
    let currentPresets = [];
    
    /**
     * é¡µé¢åˆå§‹åŒ–
     */
    document.addEventListener('DOMContentLoaded', function() {
      // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
      const userInfo = getCurrentUser();
      if (userInfo && userInfo.nickname) {
        document.getElementById('welcomeText').textContent = `æ¬¢è¿ï¼Œ${userInfo.nickname}`;
      }
      
      // âœ… Tokenå’Œæƒé™éªŒè¯
      if (!getToken() || !checkAdminPermission()) {
        return;
      }
      
      // åŠ è½½é¢„è®¾åˆ—è¡¨
      loadPresets();
      
      // ===== é™æ€æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨ =====
      // é€€å‡ºç™»å½•æŒ‰é’®
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', logout);
      } else {
        console.error('âŒ é€€å‡ºç™»å½•æŒ‰é’®ä¸å­˜åœ¨: #logoutBtn');
      }
      
      // æ·»åŠ å¥–å“é¡¹æŒ‰é’®
      const addPrizeItemBtn = document.getElementById('addPrizeItemBtn');
      if (addPrizeItemBtn) {
        addPrizeItemBtn.addEventListener('click', addPrizeItem);
      } else {
        console.error('âŒ æ·»åŠ å¥–å“æŒ‰é’®ä¸å­˜åœ¨: #addPrizeItemBtn');
      }
      
      // æäº¤é¢„è®¾æŒ‰é’®
      const submitPresetBtn = document.getElementById('submitPresetBtn');
      if (submitPresetBtn) {
        submitPresetBtn.addEventListener('click', submitPreset);
      } else {
        console.error('âŒ æäº¤é¢„è®¾æŒ‰é’®ä¸å­˜åœ¨: #submitPresetBtn');
      }
      
      // ===== äº‹ä»¶å§”æ‰˜ï¼šé¢„è®¾æ“ä½œæŒ‰é’® =====
      const presetsContainer = document.getElementById('presetsList');
      if (presetsContainer) {
        presetsContainer.addEventListener('click', (e) => {
          // æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®
          const viewBtn = e.target.closest('.preset-view-btn');
          if (viewBtn) {
            const presetId = parseInt(viewBtn.dataset.presetId);
            viewPreset(presetId);
            return;
          }
          
          // æ¿€æ´»é¢„è®¾æŒ‰é’®
          const activateBtn = e.target.closest('.preset-activate-btn');
          if (activateBtn) {
            const presetId = parseInt(activateBtn.dataset.presetId);
            activatePreset(presetId);
            return;
          }
        });
      } else {
        console.error('âŒ é¢„è®¾åˆ—è¡¨å®¹å™¨ä¸å­˜åœ¨: #presetsList');
      }
      
      // ===== äº‹ä»¶å§”æ‰˜ï¼šç§»é™¤å¥–å“é¡¹æŒ‰é’® =====
      const prizesContainer = document.getElementById('prizesContainer');
      if (prizesContainer) {
        prizesContainer.addEventListener('click', (e) => {
          const removeBtn = e.target.closest('.remove-prize-item-btn');
          if (removeBtn) {
            const itemId = parseInt(removeBtn.dataset.itemId);
            removePrizeItem(itemId);
          }
        });
        
        // ===== äº‹ä»¶å§”æ‰˜ï¼šæ¦‚ç‡è¾“å…¥å˜åŒ– =====
        prizesContainer.addEventListener('change', (e) => {
          if (e.target.classList.contains('prize-probability')) {
            updateTotalProbability();
          }
        });
      } else {
        console.error('âŒ å¥–å“å®¹å™¨ä¸å­˜åœ¨: #prizesContainer');
      }
      
      // åˆå§‹åŒ–é»˜è®¤å¥–å“é¡¹ç›®
      addPrizeItem();
    });
    
    /**
     * åŠ è½½é¢„è®¾åˆ—è¡¨
     */
    async function loadPresets() {
      showLoading();
      
      try {
        const response = await apiRequest('/api/v4/lottery-preset/list');
        
        if (response && response.success) {
          currentPresets = response.data.presets || response.data.list || [];
          renderPresetsList(currentPresets);
        } else {
          showError('åŠ è½½å¤±è´¥', response?.message || 'è·å–é¢„è®¾åˆ—è¡¨å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½é¢„è®¾å¤±è´¥:', error);
        showError('åŠ è½½å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * æ¸²æŸ“é¢„è®¾åˆ—è¡¨
     * @param {Array} presets - é¢„è®¾æ•°ç»„
     */
    function renderPresetsList(presets) {
      const container = document.getElementById('presetsList');
      
      // ===== å®¹å™¨å­˜åœ¨æ€§æ£€æŸ¥ =====
      if (!container) {
        console.error('âŒ é¢„è®¾åˆ—è¡¨å®¹å™¨ä¸å­˜åœ¨: #presetsList');
        showError('é¡µé¢é”™è¯¯', 'é¢„è®¾åˆ—è¡¨å®¹å™¨æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return;
      }
      
      if (presets.length === 0) {
        container.innerHTML = `
          <div class="col-12 text-center py-5">
            <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
            <p class="mt-2 text-muted">æš‚æ— é¢„è®¾ï¼Œç‚¹å‡»å³ä¸Šè§’åˆ›å»ºæ–°é¢„è®¾</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = presets.map(preset => `
        <div class="col-md-6 col-lg-4">
          <div class="card prize-card h-100">
            <div class="card-header bg-primary text-white">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">${preset.preset_name || preset.name}</h6>
                <span class="badge bg-light text-dark">${getTypeLabel(preset.preset_type || preset.type)}</span>
              </div>
            </div>
            <div class="card-body">
              <p class="text-muted small mb-3">${preset.description || 'æš‚æ— æè¿°'}</p>
              
              <div class="mb-2">
                <small class="text-muted">åŒ…å«å¥–å“ï¼š</small>
                <strong>${getPrizesCount(preset)}</strong> ç§
              </div>
              
              <div class="mb-2">
                <small class="text-muted">åˆ›å»ºæ—¶é—´ï¼š</small>
                <div><small>${formatDate(preset.created_at)}</small></div>
              </div>
              
              <div class="mb-3">
                <small class="text-muted">åˆ›å»ºè€…ï¼š</small>
                <strong>${preset.creator_name || 'ç®¡ç†å‘˜'}</strong>
              </div>
              
              <div class="d-grid gap-2">
                <button class="btn btn-outline-primary btn-sm preset-view-btn" data-preset-id="${preset.preset_id || preset.id}">
                  <i class="bi bi-eye"></i> æŸ¥çœ‹è¯¦æƒ…
                </button>
                <button class="btn btn-outline-success btn-sm preset-activate-btn" data-preset-id="${preset.preset_id || preset.id}">
                  <i class="bi bi-lightning"></i> æ¿€æ´»é¢„è®¾
                </button>
              </div>
            </div>
            <div class="card-footer text-muted">
              <small>
                <i class="bi bi-calendar"></i> 
                ${formatRelativeTime(preset.created_at)}
              </small>
            </div>
          </div>
        </div>
      `).join('');
    }
    
    /**
     * è·å–ç±»å‹æ ‡ç­¾
     * @param {string} type - ç±»å‹
     * @returns {string} æ ‡ç­¾æ–‡æœ¬
     */
    function getTypeLabel(type) {
      const labels = {
        normal: 'æ™®é€š',
        special: 'ç‰¹æ®Š',
        vip: 'VIP'
      };
      return labels[type] || 'æ™®é€š';
    }
    
    /**
     * è·å–å¥–å“æ•°é‡
     * @param {Object} preset - é¢„è®¾å¯¹è±¡
     * @returns {number} å¥–å“æ•°é‡
     */
    function getPrizesCount(preset) {
      if (preset.prizes && Array.isArray(preset.prizes)) {
        return preset.prizes.length;
      }
      if (preset.preset_config) {
        try {
          const config = typeof preset.preset_config === 'string' ? 
            JSON.parse(preset.preset_config) : preset.preset_config;
          return config.prizes?.length || 0;
        } catch {
          return 0;
        }
      }
      return 0;
    }
    
    /**
     * æ·»åŠ å¥–å“é¡¹ç›®
     */
    function addPrizeItem() {
      prizeItemCount++;
      const container = document.getElementById('prizesContainer');
      
      // ===== å®¹å™¨å­˜åœ¨æ€§æ£€æŸ¥ =====
      if (!container) {
        console.error('âŒ å¥–å“å®¹å™¨ä¸å­˜åœ¨: #prizesContainer');
        showError('é¡µé¢é”™è¯¯', 'å¥–å“å®¹å™¨æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return;
      }
      
      const itemHtml = `
        <div class="card mb-2 prize-item" id="prizeItem${prizeItemCount}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">å¥–å“ #${prizeItemCount}</h6>
              <button type="button" class="btn btn-sm btn-outline-danger remove-prize-item-btn" data-item-id="${prizeItemCount}">
                <i class="bi bi-trash"></i>
              </button>
            </div>
            <div class="row g-2">
              <div class="col-md-4">
                <label class="form-label small">å¥–å“åç§° <span class="text-danger">*</span></label>
                <input type="text" class="form-control form-control-sm prize-name" placeholder="ä¾‹å¦‚ï¼šç°é‡‘çº¢åŒ…">
              </div>
              <div class="col-md-3">
                <label class="form-label small">ç±»å‹ <span class="text-danger">*</span></label>
                <select class="form-select form-select-sm prize-type">
                  <option value="physical">å®ç‰©å¥–å“</option>
                  <option value="virtual">è™šæ‹Ÿå¥–å“</option>
                  <option value="points">ç§¯åˆ†</option>
                  <option value="coupon">ä¼˜æƒ åˆ¸</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label small">ä»·å€¼ <span class="text-danger">*</span></label>
                <input type="number" class="form-control form-control-sm prize-value" step="0.01" min="0" placeholder="0.00">
              </div>
              <div class="col-md-3">
                <label class="form-label small">ä¸­å¥–æ¦‚ç‡(%) <span class="text-danger">*</span></label>
                <input type="number" class="form-control form-control-sm prize-probability" 
                  step="0.01" min="0" max="100" placeholder="0.00">
              </div>
            </div>
          </div>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', itemHtml);
    }
    
    /**
     * åˆ é™¤å¥–å“é¡¹ç›®
     * @param {number} itemId - é¡¹ç›®ID
     */
    function removePrizeItem(itemId) {
      const item = document.getElementById(`prizeItem${itemId}`);
      if (item) {
        item.remove();
        updateTotalProbability();
      }
    }
    
    /**
     * æ›´æ–°æ€»æ¦‚ç‡
     */
    function updateTotalProbability() {
      const items = document.querySelectorAll('.prize-probability');
      let total = 0;
      
      items.forEach(item => {
        const value = parseFloat(item.value) || 0;
        total += value;
      });
      
      const totalElement = document.getElementById('totalProbability');
      
      // ===== å…ƒç´ å­˜åœ¨æ€§æ£€æŸ¥ =====
      if (!totalElement) {
        console.error('âŒ æ€»æ¦‚ç‡æ˜¾ç¤ºå…ƒç´ ä¸å­˜åœ¨: #totalProbability');
        return;
      }
      
      totalElement.textContent = total.toFixed(2);
      
      // æ ¹æ®æ€»æ¦‚ç‡æ˜¾ç¤ºä¸åŒé¢œè‰²
      if (Math.abs(total - 100) < 0.01) {
        totalElement.className = 'text-success fw-bold';
      } else if (total > 100) {
        totalElement.className = 'text-danger fw-bold';
      } else {
        totalElement.className = 'text-warning fw-bold';
      }
    }
    
    /**
     * æäº¤é¢„è®¾
     */
    async function submitPreset() {
      // æ”¶é›†åŸºæœ¬ä¿¡æ¯
      const nameElement = document.getElementById('presetName');
      const typeElement = document.getElementById('presetType');
      const descriptionElement = document.getElementById('presetDescription');
      
      // ===== è¡¨å•å…ƒç´ å­˜åœ¨æ€§æ£€æŸ¥ =====
      if (!nameElement || !typeElement || !descriptionElement) {
        console.error('âŒ è¡¨å•å…ƒç´ ç¼ºå¤±');
        showError('è¡¨å•é”™è¯¯', 'é¢„è®¾è¡¨å•å…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return;
      }
      
      const name = nameElement.value.trim();
      const type = typeElement.value;
      const description = descriptionElement.value.trim();
      
      if (!name) {
        alert('è¯·è¾“å…¥é¢„è®¾åç§°');
        return;
      }
      
      // æ”¶é›†å¥–å“ä¿¡æ¯
      const prizes = [];
      const prizeItems = document.querySelectorAll('.prize-item');
      
      if (prizeItems.length === 0) {
        alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªå¥–å“');
        return;
      }
      
      let totalProbability = 0;
      for (const item of prizeItems) {
        const prizeName = item.querySelector('.prize-name').value.trim();
        const prizeType = item.querySelector('.prize-type').value;
        const prizeValue = parseFloat(item.querySelector('.prize-value').value) || 0;
        const prizeProbability = parseFloat(item.querySelector('.prize-probability').value) || 0;
        
        if (!prizeName) {
          alert('è¯·å¡«å†™æ‰€æœ‰å¥–å“çš„åç§°');
          return;
        }
        
        if (prizeValue <= 0) {
          alert('å¥–å“ä»·å€¼å¿…é¡»å¤§äº0');
          return;
        }
        
        if (prizeProbability <= 0) {
          alert('ä¸­å¥–æ¦‚ç‡å¿…é¡»å¤§äº0');
          return;
        }
        
        totalProbability += prizeProbability;
        
        prizes.push({
          prize_name: prizeName,
          prize_type: prizeType,
          prize_value: prizeValue,
          probability: prizeProbability
        });
      }
      
      // éªŒè¯æ€»æ¦‚ç‡
      if (Math.abs(totalProbability - 100) > 0.01) {
        if (!confirm(`å½“å‰æ€»æ¦‚ç‡ä¸º ${totalProbability.toFixed(2)}%ï¼Œä¸ç­‰äº100%ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
          return;
        }
      }
      
      showLoading();
      
      try {
        const response = await apiRequest('/api/v4/lottery-preset/create', {
          method: 'POST',
          body: JSON.stringify({
            preset_name: name,
            preset_type: type,
            description: description,
            preset_config: {
              prizes: prizes,
              total_probability: totalProbability
            }
          })
        });
        
        if (response && response.success) {
          showSuccess('åˆ›å»ºæˆåŠŸ', 'æŠ½å¥–é¢„è®¾å·²åˆ›å»º');
          
          // å…³é—­æ¨¡æ€æ¡†
          bootstrap.Modal.getInstance(document.getElementById('createPresetModal')).hide();
          
          // é‡ç½®è¡¨å•
          resetPresetForm();
          
          // é‡æ–°åŠ è½½åˆ—è¡¨
          loadPresets();
        } else {
          showError('åˆ›å»ºå¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        console.error('åˆ›å»ºé¢„è®¾å¤±è´¥:', error);
        showError('åˆ›å»ºå¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * é‡ç½®é¢„è®¾è¡¨å•
     */
    function resetPresetForm() {
      document.getElementById('presetName').value = '';
      document.getElementById('presetType').value = 'normal';
      document.getElementById('presetDescription').value = '';
      document.getElementById('prizesContainer').innerHTML = '';
      prizeItemCount = 0;
      addPrizeItem();
    }
    
    /**
     * æŸ¥çœ‹é¢„è®¾è¯¦æƒ…
     * @param {number} presetId - é¢„è®¾ID
     */
    function viewPreset(presetId) {
      const preset = currentPresets.find(p => (p.preset_id || p.id) === presetId);
      if (!preset) {
        alert('é¢„è®¾ä¸å­˜åœ¨');
        return;
      }
      
      document.getElementById('viewPresetTitle').textContent = preset.preset_name || preset.name;
      
      let prizes = [];
      if (preset.prizes && Array.isArray(preset.prizes)) {
        prizes = preset.prizes;
      } else if (preset.preset_config) {
        try {
          const config = typeof preset.preset_config === 'string' ? 
            JSON.parse(preset.preset_config) : preset.preset_config;
          prizes = config.prizes || [];
        } catch (error) {
          console.error('è§£æé¢„è®¾é…ç½®å¤±è´¥:', error);
        }
      }
      
      const detailsHtml = `
        <div class="row g-3">
          <div class="col-md-6">
            <strong>é¢„è®¾ç±»å‹ï¼š</strong>
            <span class="badge bg-primary">${getTypeLabel(preset.preset_type || preset.type)}</span>
          </div>
          <div class="col-md-6">
            <strong>åˆ›å»ºæ—¶é—´ï¼š</strong> ${formatDate(preset.created_at)}
          </div>
          <div class="col-12">
            <strong>æè¿°ï¼š</strong>
            <p class="text-muted">${preset.description || 'æš‚æ— æè¿°'}</p>
          </div>
          <div class="col-12">
            <h6 class="border-bottom pb-2">å¥–å“é…ç½®ï¼ˆ${prizes.length}ç§ï¼‰</h6>
            <div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead class="table-light">
                  <tr>
                    <th>å¥–å“åç§°</th>
                    <th>ç±»å‹</th>
                    <th>ä»·å€¼</th>
                    <th>ä¸­å¥–æ¦‚ç‡</th>
                    <th>æ¦‚ç‡å›¾ç¤º</th>
                  </tr>
                </thead>
                <tbody>
                  ${prizes.map(prize => `
                    <tr>
                      <td>${prize.prize_name}</td>
                      <td>${getPrizeTypeLabel(prize.prize_type)}</td>
                      <td class="fw-bold">Â¥${(prize.prize_value || 0).toFixed(2)}</td>
                      <td><strong>${(prize.probability || 0).toFixed(2)}%</strong></td>
                      <td>
                        <div class="probability-bar">
                          <div class="probability-fill bg-primary" style="width: ${prize.probability}%"></div>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('viewPresetBody').innerHTML = detailsHtml;
      new bootstrap.Modal(document.getElementById('viewPresetModal')).show();
    }
    
    /**
     * è·å–å¥–å“ç±»å‹æ ‡ç­¾
     * @param {string} type - å¥–å“ç±»å‹
     * @returns {string} æ ‡ç­¾æ–‡æœ¬
     */
    function getPrizeTypeLabel(type) {
      const labels = {
        physical: 'å®ç‰©',
        virtual: 'è™šæ‹Ÿ',
        points: 'ç§¯åˆ†',
        coupon: 'ä¼˜æƒ åˆ¸'
      };
      return labels[type] || 'æœªçŸ¥';
    }
    
    /**
     * æ¿€æ´»é¢„è®¾
     * @param {number} presetId - é¢„è®¾ID
     */
    async function activatePreset(presetId) {
      const preset = currentPresets.find(p => (p.preset_id || p.id) === presetId);
      if (!preset) {
        alert('é¢„è®¾ä¸å­˜åœ¨');
        return;
      }
      
      if (!confirm(`ç¡®è®¤æ¿€æ´»é¢„è®¾"${preset.preset_name || preset.name}"ï¼Ÿ\næ¿€æ´»åå°†æ›¿æ¢å½“å‰çš„æŠ½å¥–é…ç½®ã€‚`)) {
        return;
      }
      
      showLoading();
      
      try {
        const response = await apiRequest(`/api/v4/lottery-preset/activate/${presetId}`, {
          method: 'POST'
        });
        
        if (response && response.success) {
          showSuccess('æ¿€æ´»æˆåŠŸ', 'æŠ½å¥–é¢„è®¾å·²æ¿€æ´»');
        } else {
          showError('æ¿€æ´»å¤±è´¥', response?.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        console.error('æ¿€æ´»é¢„è®¾å¤±è´¥:', error);
        showError('æ¿€æ´»å¤±è´¥', error.message);
      } finally {
        hideLoading();
      }
    }
    
    /**
     * æ˜¾ç¤ºåŠ è½½çŠ¶æ€
     */
    function showLoading() {
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) {
        loadingOverlay.classList.add('show');
      } else {
        console.error('âŒ åŠ è½½é®ç½©å±‚ä¸å­˜åœ¨: #loadingOverlay');
      }
    }
    
    /**
     * éšè—åŠ è½½çŠ¶æ€
     */
    function hideLoading() {
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) {
        loadingOverlay.classList.remove('show');
      } else {
        console.error('âŒ åŠ è½½é®ç½©å±‚ä¸å­˜åœ¨: #loadingOverlay');
      }
    }
    
    /**
     * æ˜¾ç¤ºæˆåŠŸæç¤º
     * @param {string} title - æ ‡é¢˜
     * @param {string} message - æ¶ˆæ¯
     */
    function showSuccess(title, message) {
      alert(`âœ… ${title}\n${message}`);
    }
    
    /**
     * æ˜¾ç¤ºé”™è¯¯æç¤º
     * @param {string} title - æ ‡é¢˜
     * @param {string} message - æ¶ˆæ¯
     */
    function showError(title, message) {
      alert(`âŒ ${title}\n${message}`);
    }
  </script>
</body>
</html>

