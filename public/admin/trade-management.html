<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">äº¤æ˜“ç®¡ç† - ç®¡ç†åå°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/admin/css/common.css" rel="stylesheet">
  <style>
    .sub-nav { background: #f8f9fa; border-bottom: 1px solid #dee2e6; padding: 0.5rem 0; }
    .sub-nav .nav-link { color: #495057; padding: 0.5rem 1rem; border-radius: 0.25rem; margin: 0 0.25rem; }
    .sub-nav .nav-link:hover { background: #e9ecef; }
    .sub-nav .nav-link.active { background: #0d6efd; color: white; }
    [x-cloak] { display: none !important; }
    .stat-card { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075); }
    .user-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
  </style>

  <!-- âœ… Alpine.js Mixin ç³»ç»Ÿ -->
  <script defer src="/admin/js/alpine/mixins-bundle.js"></script>
  <script defer src="/admin/js/alpine/init.js"></script>
  <script defer src="/admin/js/vendor/alpine.min.js"></script>
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>ğŸ’± ç®¡ç†åå° - äº¤æ˜“ç®¡ç†
      </a>
      <div>
        <span class="text-light me-3" x-data x-text="$store.auth.user?.nickname ? `æ¬¢è¿ï¼Œ${$store.auth.user.nickname}` : 'æ¬¢è¿ï¼Œç®¡ç†å‘˜'">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn btn-outline-light btn-sm" onclick="logout()">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </nav>

  <!-- å­æ¨¡å—å¯¼èˆª -->
  <div class="sub-nav" x-data="tradeNavigation()" x-cloak>
    <div class="container-fluid">
      <ul class="nav nav-pills">
        <template x-for="page in subPages" :key="page.id">
          <li class="nav-item">
            <a class="nav-link" :class="{ 'active': currentPage === page.id }" :href="'?page=' + page.id" @click.prevent="switchPage(page.id)">
              <i class="bi me-1" :class="page.icon"></i><span x-text="page.title"></span>
            </a>
          </li>
        </template>
      </ul>
    </div>
  </div>

  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <div class="container-fluid mt-4" x-data="tradePageContent()" x-cloak>
    
    <!-- ==================== C2Cäº¤æ˜“è®¢å• ==================== -->
    <div x-show="currentPage === 'trade-orders'" x-cloak>
      <!-- ç»Ÿè®¡å¡ç‰‡ -->
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="card stat-card">
            <div class="card-body text-center">
              <i class="bi bi-receipt text-primary" style="font-size: 2rem;"></i>
              <h6 class="text-muted mt-2">è®¢å•æ€»æ•°</h6>
              <h2 x-text="tradeStats.total" class="text-primary mb-0">-</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card">
            <div class="card-body text-center">
              <i class="bi bi-hourglass-split text-warning" style="font-size: 2rem;"></i>
              <h6 class="text-muted mt-2">å¾…æ”¯ä»˜</h6>
              <h2 x-text="tradeStats.created" class="text-warning mb-0">-</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card">
            <div class="card-body text-center">
              <i class="bi bi-snow2 text-info" style="font-size: 2rem;"></i>
              <h6 class="text-muted mt-2">å†»ç»“ä¸­</h6>
              <h2 x-text="tradeStats.frozen" class="text-info mb-0">-</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card">
            <div class="card-body text-center">
              <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
              <h6 class="text-muted mt-2">å·²å®Œæˆ</h6>
              <h2 x-text="tradeStats.completed" class="text-success mb-0">-</h2>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="bi bi-arrow-left-right"></i> C2Cäº¤æ˜“è®¢å•</h5>
        </div>
        <div class="card-body">
          <!-- ç­›é€‰å™¨ -->
          <div class="row mb-3 g-2">
            <div class="col-md-2">
              <select class="form-select form-select-sm" x-model="tradeFilters.status">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="created">å¾…æ”¯ä»˜</option>
                <option value="frozen">å†»ç»“ä¸­</option>
                <option value="completed">å·²å®Œæˆ</option>
                <option value="cancelled">å·²å–æ¶ˆ</option>
              </select>
            </div>
            <div class="col-md-2">
              <input type="text" class="form-control form-control-sm" placeholder="ä¹°å®¶ID" x-model="tradeFilters.buyer_user_id">
            </div>
            <div class="col-md-2">
              <input type="text" class="form-control form-control-sm" placeholder="å–å®¶ID" x-model="tradeFilters.seller_user_id">
            </div>
            <div class="col-md-2">
              <button class="btn btn-primary btn-sm w-100" @click="loadTradeOrders()">
                <i class="bi bi-search"></i> æœç´¢
              </button>
            </div>
          </div>
          
          <!-- è®¢å•è¡¨æ ¼ -->
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>è®¢å•ID</th>
                  <th>ä¹°å®¶</th>
                  <th>å–å®¶</th>
                  <th>å•†å“</th>
                  <th>é‡‘é¢</th>
                  <th>çŠ¶æ€</th>
                  <th>åˆ›å»ºæ—¶é—´</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                <template x-if="tradeOrders.length === 0">
                  <tr><td colspan="8" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>
                </template>
                <template x-for="order in tradeOrders" :key="order.order_id">
                  <tr>
                    <td><code x-text="order.order_id"></code></td>
                    <td>
                      <span x-text="order.buyer_nickname || order.buyer_user_id"></span>
                    </td>
                    <td>
                      <span x-text="order.seller_nickname || order.seller_user_id"></span>
                    </td>
                    <td x-text="order.listing_title || order.listing_id"></td>
                    <td>
                      <span class="badge bg-info" x-text="(order.total_price || order.price) + ' ' + (order.currency || 'é’»çŸ³')"></span>
                    </td>
                    <td>
                      <span class="badge" :class="{
                        'bg-warning': order.status === 'created',
                        'bg-info': order.status === 'frozen',
                        'bg-success': order.status === 'completed',
                        'bg-danger': order.status === 'cancelled'
                      }" x-text="getTradeStatusText(order.status)"></span>
                    </td>
                    <td x-text="$format.date(order.created_at)"></td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary" @click="viewTradeOrderDetail(order)">
                        <i class="bi bi-eye"></i>
                      </button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          
          <!-- åˆ†é¡µ -->
          <nav x-show="tradePagination.totalPages > 1">
            <ul class="pagination pagination-sm justify-content-center mb-0">
              <li class="page-item" :class="{ disabled: tradeCurrentPage === 1 }">
                <a class="page-link" href="#" @click.prevent="changeTradePage(tradeCurrentPage - 1)">ä¸Šä¸€é¡µ</a>
              </li>
              <template x-for="p in tradePagination.totalPages" :key="p">
                <li class="page-item" :class="{ active: tradeCurrentPage === p }">
                  <a class="page-link" href="#" @click.prevent="changeTradePage(p)" x-text="p"></a>
                </li>
              </template>
              <li class="page-item" :class="{ disabled: tradeCurrentPage === tradePagination.totalPages }">
                <a class="page-link" href="#" @click.prevent="changeTradePage(tradeCurrentPage + 1)">ä¸‹ä¸€é¡µ</a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>

    <!-- ==================== ä¸Šæ¶ç»Ÿè®¡ ==================== -->
    <div x-show="currentPage === 'marketplace-stats'" x-cloak>
      <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <div class="card stat-card">
            <div class="card-body text-center">
              <i class="bi bi-people text-primary" style="font-size: 2rem;"></i>
              <h6 class="text-muted mt-2">æœ‰ä¸Šæ¶å•†å“çš„ç”¨æˆ·</h6>
              <h2 x-text="marketplaceSummary.total_users_with_listings" class="text-primary mb-0">-</h2>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card stat-card">
            <div class="card-body text-center">
              <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
              <h6 class="text-muted mt-2">æ¥è¿‘ä¸Šé™ç”¨æˆ·</h6>
              <h2 x-text="marketplaceSummary.users_near_limit" class="text-warning mb-0">-</h2>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card stat-card">
            <div class="card-body text-center">
              <i class="bi bi-x-octagon text-danger" style="font-size: 2rem;"></i>
              <h6 class="text-muted mt-2">è¾¾åˆ°ä¸Šé™ç”¨æˆ·</h6>
              <h2 x-text="marketplaceSummary.users_at_limit" class="text-danger mb-0">-</h2>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-bar-chart"></i> ç”¨æˆ·ä¸Šæ¶ç»Ÿè®¡</h5>
          <div>
            <select class="form-select form-select-sm d-inline-block w-auto" x-model="marketplaceFilters.status" @change="loadMarketplaceStats()">
              <option value="all">å…¨éƒ¨ç”¨æˆ·</option>
              <option value="near_limit">æ¥è¿‘ä¸Šé™</option>
              <option value="at_limit">è¾¾åˆ°ä¸Šé™</option>
            </select>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>ç”¨æˆ·</th>
                  <th>å½“å‰ä¸Šæ¶æ•°</th>
                  <th>æœ€å¤§ä¸Šæ¶æ•°</th>
                  <th>ä½¿ç”¨ç‡</th>
                  <th>çŠ¶æ€</th>
                </tr>
              </thead>
              <tbody>
                <template x-if="marketplaceStats.length === 0">
                  <tr><td colspan="5" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>
                </template>
                <template x-for="stat in marketplaceStats" :key="stat.user_id">
                  <tr>
                    <td>
                      <div class="d-flex align-items-center">
                        <img :src="stat.avatar_url || '/admin/images/default-avatar.png'" class="user-avatar me-2">
                        <div>
                          <div x-text="stat.nickname || 'ç”¨æˆ·' + stat.user_id"></div>
                          <small class="text-muted" x-text="'ID: ' + stat.user_id"></small>
                        </div>
                      </div>
                    </td>
                    <td x-text="stat.current_listings"></td>
                    <td x-text="stat.max_listings || maxListings"></td>
                    <td>
                      <div class="progress" style="height: 20px;">
                        <div class="progress-bar" :class="{
                          'bg-success': (stat.current_listings / (stat.max_listings || maxListings)) < 0.7,
                          'bg-warning': (stat.current_listings / (stat.max_listings || maxListings)) >= 0.7 && (stat.current_listings / (stat.max_listings || maxListings)) < 1,
                          'bg-danger': (stat.current_listings / (stat.max_listings || maxListings)) >= 1
                        }" :style="'width: ' + Math.min(100, (stat.current_listings / (stat.max_listings || maxListings) * 100)) + '%'"
                        x-text="Math.round(stat.current_listings / (stat.max_listings || maxListings) * 100) + '%'"></div>
                      </div>
                    </td>
                    <td>
                      <span class="badge" :class="{
                        'bg-success': (stat.current_listings / (stat.max_listings || maxListings)) < 0.7,
                        'bg-warning': (stat.current_listings / (stat.max_listings || maxListings)) >= 0.7 && (stat.current_listings / (stat.max_listings || maxListings)) < 1,
                        'bg-danger': (stat.current_listings / (stat.max_listings || maxListings)) >= 1
                      }" x-text="(stat.current_listings / (stat.max_listings || maxListings)) >= 1 ? 'å·²è¾¾ä¸Šé™' : (stat.current_listings / (stat.max_listings || maxListings)) >= 0.7 ? 'æ¥è¿‘ä¸Šé™' : 'æ­£å¸¸'"></span>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          
          <!-- åˆ†é¡µ -->
          <nav x-show="marketplacePagination.totalPages > 1">
            <ul class="pagination pagination-sm justify-content-center mb-0">
              <li class="page-item" :class="{ disabled: marketplaceCurrentPage === 1 }">
                <a class="page-link" href="#" @click.prevent="changeMarketplacePage(marketplaceCurrentPage - 1)">ä¸Šä¸€é¡µ</a>
              </li>
              <template x-for="p in marketplacePagination.totalPages" :key="p">
                <li class="page-item" :class="{ active: marketplaceCurrentPage === p }">
                  <a class="page-link" href="#" @click.prevent="changeMarketplacePage(p)" x-text="p"></a>
                </li>
              </template>
              <li class="page-item" :class="{ disabled: marketplaceCurrentPage === marketplacePagination.totalPages }">
                <a class="page-link" href="#" @click.prevent="changeMarketplacePage(marketplaceCurrentPage + 1)">ä¸‹ä¸€é¡µ</a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>

    <!-- ==================== å…‘æ¢è®¢å• ==================== -->
    <div x-show="currentPage === 'redemption-orders'" x-cloak>
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="bi bi-arrow-repeat"></i> å…‘æ¢è®¢å•</h5>
        </div>
        <div class="card-body">
          <!-- ç­›é€‰å™¨ -->
          <div class="row mb-3 g-2">
            <div class="col-md-2">
              <select class="form-select form-select-sm" x-model="redemptionFilters.status">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="pending">å¾…å¤„ç†</option>
                <option value="completed">å·²å®Œæˆ</option>
                <option value="rejected">å·²æ‹’ç»</option>
              </select>
            </div>
            <div class="col-md-2">
              <button class="btn btn-primary btn-sm w-100" @click="loadRedemptionOrders()">
                <i class="bi bi-search"></i> æœç´¢
              </button>
            </div>
          </div>
          
          <!-- è®¢å•è¡¨æ ¼ -->
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>è®¢å•å·</th>
                  <th>ç”¨æˆ·</th>
                  <th>å…‘æ¢ç±»å‹</th>
                  <th>æ•°é‡</th>
                  <th>çŠ¶æ€</th>
                  <th>åˆ›å»ºæ—¶é—´</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                <template x-if="redemptionOrders.length === 0">
                  <tr><td colspan="7" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>
                </template>
                <template x-for="order in redemptionOrders" :key="order.order_id">
                  <tr>
                    <td><code x-text="order.order_no || order.order_id"></code></td>
                    <td x-text="order.user_nickname || order.user_id"></td>
                    <td x-text="order.redemption_type || '-'"></td>
                    <td x-text="order.quantity || order.amount"></td>
                    <td>
                      <span class="badge" :class="{
                        'bg-warning': order.status === 'pending',
                        'bg-success': order.status === 'completed',
                        'bg-danger': order.status === 'rejected'
                      }" x-text="getRedemptionStatusText(order.status)"></span>
                    </td>
                    <td x-text="$format.date(order.created_at)"></td>
                    <td>
                      <button class="btn btn-sm btn-outline-success me-1" @click="approveRedemption(order)" x-show="order.status === 'pending'">
                        <i class="bi bi-check"></i>
                      </button>
                      <button class="btn btn-sm btn-outline-danger" @click="rejectRedemption(order)" x-show="order.status === 'pending'">
                        <i class="bi bi-x"></i>
                      </button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          
          <!-- åˆ†é¡µ -->
          <nav x-show="redemptionPagination.totalPages > 1">
            <ul class="pagination pagination-sm justify-content-center mb-0">
              <li class="page-item" :class="{ disabled: redemptionCurrentPage === 1 }">
                <a class="page-link" href="#" @click.prevent="changeRedemptionPage(redemptionCurrentPage - 1)">ä¸Šä¸€é¡µ</a>
              </li>
              <template x-for="p in redemptionPagination.totalPages" :key="p">
                <li class="page-item" :class="{ active: redemptionCurrentPage === p }">
                  <a class="page-link" href="#" @click.prevent="changeRedemptionPage(p)" x-text="p"></a>
                </li>
              </template>
              <li class="page-item" :class="{ disabled: redemptionCurrentPage === redemptionPagination.totalPages }">
                <a class="page-link" href="#" @click.prevent="changeRedemptionPage(redemptionCurrentPage + 1)">ä¸‹ä¸€é¡µ</a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>

  </div>

  <!-- ==================== æ¨¡æ€æ¡† ==================== -->
  
  <!-- äº¤æ˜“è®¢å•è¯¦æƒ…æ¨¡æ€æ¡† -->
  <div class="modal fade" id="tradeDetailModal" tabindex="-1" x-ref="tradeDetailModal">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">äº¤æ˜“è®¢å•è¯¦æƒ…</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" x-show="selectedTradeOrder">
          <div class="row">
            <div class="col-md-6">
              <p><strong>è®¢å•IDï¼š</strong><code x-text="selectedTradeOrder?.order_id"></code></p>
              <p><strong>ä¸Šæ¶IDï¼š</strong><span x-text="selectedTradeOrder?.listing_id"></span></p>
              <p><strong>ä¹°å®¶ï¼š</strong><span x-text="selectedTradeOrder?.buyer_nickname || selectedTradeOrder?.buyer_user_id"></span></p>
              <p><strong>å–å®¶ï¼š</strong><span x-text="selectedTradeOrder?.seller_nickname || selectedTradeOrder?.seller_user_id"></span></p>
            </div>
            <div class="col-md-6">
              <p><strong>å•†å“ï¼š</strong><span x-text="selectedTradeOrder?.listing_title || '-'"></span></p>
              <p><strong>æ•°é‡ï¼š</strong><span x-text="selectedTradeOrder?.quantity || 1"></span></p>
              <p><strong>é‡‘é¢ï¼š</strong><span x-text="(selectedTradeOrder?.total_price || selectedTradeOrder?.price) + ' ' + (selectedTradeOrder?.currency || 'é’»çŸ³')"></span></p>
              <p><strong>çŠ¶æ€ï¼š</strong><span class="badge" :class="{
                'bg-warning': selectedTradeOrder?.status === 'created',
                'bg-info': selectedTradeOrder?.status === 'frozen',
                'bg-success': selectedTradeOrder?.status === 'completed',
                'bg-danger': selectedTradeOrder?.status === 'cancelled'
              }" x-text="getTradeStatusText(selectedTradeOrder?.status)"></span></p>
              <p><strong>åˆ›å»ºæ—¶é—´ï¼š</strong><span x-text="$format.date(selectedTradeOrder?.created_at)"></span></p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
        </div>
      </div>
    </div>
  </div>

  <!-- é€šç”¨ä¾èµ– -->
  <script src="/admin/js/api-config.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  <script src="/admin/js/pages/trade-management.js"></script>
</body>
</html>

