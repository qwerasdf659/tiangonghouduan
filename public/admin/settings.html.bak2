<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>系统设置 - 管理后台</title>
  
  <!-- ✅ Bootstrap 5 - UI框架 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- ✅ Bootstrap Icons - 图标库 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- ✅ 公共样式表 - 统一主题和响应式设计 -->
  <link href="/admin/css/common.css" rel="stylesheet">
  
  <!-- ✅ 页面特有样式 -->
  <style>
    .settings-nav {
      position: sticky;
      top: 20px;
    }
    .settings-section {
      scroll-margin-top: 80px;
    }
  </style>
</head>
<body class="bg-light" x-data="settingsPage()">
  <!-- 顶部导航 -->
  <nav class="navbar navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/admin/dashboard.html" class="navbar-brand">
        <i class="bi bi-arrow-left me-2"></i>⚙️ 管理后台 - 系统设置
      </a>
      <div>
        <span class="text-light me-3" x-text="'欢迎，' + (userInfo?.nickname || '管理员')"></span>
        <button class="btn btn-outline-light btn-sm" @click="logout">退出登录</button>
      </div>
    </div>
  </nav>
  
  <div class="container-fluid mt-4">
    <!-- ✅ 功能状态提示横幅 -->
    <div class="alert alert-success alert-dismissible fade show mb-3" role="alert" x-show="showBanner">
      <h6 class="alert-heading">
        <i class="bi bi-check-circle-fill"></i> 系统设置功能已完整实现
      </h6>
      <hr>
      <p class="mb-2"><strong>✅ 已实现的功能：</strong></p>
      <ul class="mb-0">
        <li>基础设置保存（✓ /api/v4/console/settings/basic）</li>
        <li>积分设置保存（✓ /api/v4/console/settings/points）</li>
        <li>通知设置保存（✓ /api/v4/console/settings/notification）</li>
        <li>安全设置保存（✓ /api/v4/console/settings/security）</li>
        <li>缓存清除功能（✓ /api/v4/console/cache/clear）</li>
      </ul>
      <hr>
      <p class="mb-0 text-muted small">
        <i class="bi bi-info-circle"></i> 
        注：抽奖算法配置（中奖率、保底规则等）在config/business.config.js中管理，需要技术团队修改代码。
      </p>
      <button type="button" class="btn-close" @click="showBanner = false" aria-label="Close"></button>
    </div>
    
    <div class="row">
      <!-- 侧边导航 -->
      <div class="col-md-3">
        <div class="card settings-nav">
          <div class="card-header bg-white">
            <h6 class="mb-0">设置导航</h6>
          </div>
          <div class="list-group list-group-flush">
            <a href="#basic-settings" class="list-group-item list-group-item-action" @click.prevent="scrollTo('basic-settings')">
              <i class="bi bi-gear"></i> 基础设置
            </a>
            <a href="#lottery-settings" class="list-group-item list-group-item-action" @click.prevent="scrollTo('lottery-settings')">
              <i class="bi bi-gift"></i> 抽奖设置
            </a>
            <a href="#points-settings" class="list-group-item list-group-item-action" @click.prevent="scrollTo('points-settings')">
              <i class="bi bi-star"></i> 积分设置
            </a>
            <a href="#notification-settings" class="list-group-item list-group-item-action" @click.prevent="scrollTo('notification-settings')">
              <i class="bi bi-bell"></i> 通知设置
            </a>
            <a href="#security-settings" class="list-group-item list-group-item-action" @click.prevent="scrollTo('security-settings')">
              <i class="bi bi-shield-lock"></i> 安全设置
            </a>
            <a href="#cache-settings" class="list-group-item list-group-item-action" @click.prevent="scrollTo('cache-settings')">
              <i class="bi bi-database"></i> 缓存管理
            </a>
          </div>
        </div>
      </div>
      
      <!-- 主要内容区 -->
      <div class="col-md-9">
        <!-- 基础设置 -->
        <div id="basic-settings" class="card mb-3 settings-section">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-gear"></i> 基础设置</h5>
          </div>
          <div class="card-body">
            <form @submit.prevent="saveBasicSettings">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">系统名称</label>
                  <input type="text" class="form-control" x-model="basicSettings.systemName">
                </div>
                <div class="col-md-6">
                  <label class="form-label">系统版本</label>
                  <input type="text" class="form-control" x-model="basicSettings.systemVersion" readonly>
                </div>
                <div class="col-md-6">
                  <label class="form-label">客服电话</label>
                  <input type="tel" class="form-control" x-model="basicSettings.customerServicePhone" placeholder="400-xxx-xxxx">
                </div>
                <div class="col-md-6">
                  <label class="form-label">客服邮箱</label>
                  <input type="email" class="form-control" x-model="basicSettings.customerServiceEmail" placeholder="support@example.com">
                </div>
                <div class="col-12">
                  <label class="form-label">系统公告</label>
                  <textarea class="form-control" x-model="basicSettings.systemAnnouncement" rows="3" placeholder="系统公告内容..."></textarea>
                </div>
                <div class="col-12">
                  <label class="form-label">维护模式</label>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" x-model="basicSettings.maintenanceMode" id="maintenanceMode">
                    <label class="form-check-label" for="maintenanceMode">
                      启用维护模式（启用后普通用户无法访问系统）
                    </label>
                  </div>
                </div>
                <div class="col-12">
                  <button type="submit" class="btn btn-primary" :disabled="saving.basic">
                    <span x-show="saving.basic" class="spinner-border spinner-border-sm me-1"></span>
                    <i class="bi bi-check-lg" x-show="!saving.basic"></i> 保存设置
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
        
        <!-- 抽奖设置 -->
        <div id="lottery-settings" class="card mb-3 settings-section">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-gift"></i> 抽奖设置</h5>
          </div>
          <div class="card-body">
            <form @submit.prevent="saveLotterySettings">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">每日抽奖次数限制</label>
                  <input type="number" class="form-control" x-model.number="lotterySettings.dailyDrawLimit" min="1">
                </div>
                <div class="col-md-6">
                  <label class="form-label">每次消费所需积分</label>
                  <input type="number" class="form-control" x-model.number="lotterySettings.drawCostPoints" min="0">
                </div>
                <div class="col-md-6">
                  <label class="form-label">最低消费金额(元)</label>
                  <input type="number" class="form-control" x-model.number="lotterySettings.minConsumptionAmount" min="0" step="0.01">
                </div>
                <div class="col-md-6">
                  <label class="form-label">积分兑换比例(元:积分)</label>
                  <input type="text" class="form-control" x-model="lotterySettings.pointsConversionRate">
                </div>
                <div class="col-12">
                  <label class="form-label">保底中奖机制</label>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" x-model="lotterySettings.guaranteedWinEnabled" id="guaranteedWinEnabled">
                    <label class="form-check-label" for="guaranteedWinEnabled">
                      启用保底中奖（连续N次未中奖后必中）
                    </label>
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">保底抽奖次数</label>
                  <input type="number" class="form-control" x-model.number="lotterySettings.guaranteedWinCount" min="1">
                </div>
                <div class="col-12">
                  <button type="submit" class="btn btn-primary" :disabled="saving.lottery">
                    <span x-show="saving.lottery" class="spinner-border spinner-border-sm me-1"></span>
                    <i class="bi bi-check-lg" x-show="!saving.lottery"></i> 保存设置
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
        
        <!-- 积分设置 -->
        <div id="points-settings" class="card mb-3 settings-section">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-star"></i> 积分设置</h5>
          </div>
          <div class="card-body">
            <form @submit.prevent="savePointsSettings">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">注册赠送积分</label>
                  <input type="number" class="form-control" x-model.number="pointsSettings.registerBonusPoints" min="0">
                </div>
                <div class="col-md-6">
                  <label class="form-label">每日签到积分</label>
                  <input type="number" class="form-control" x-model.number="pointsSettings.dailyCheckInPoints" min="0">
                </div>
                <div class="col-md-6">
                  <label class="form-label">推荐好友积分</label>
                  <input type="number" class="form-control" x-model.number="pointsSettings.referralBonusPoints" min="0">
                </div>
                <div class="col-md-6">
                  <label class="form-label">积分有效期(天)</label>
                  <input type="number" class="form-control" x-model.number="pointsSettings.pointsExpireDays" min="0" placeholder="0表示永久有效">
                </div>
                <div class="col-12">
                  <label class="form-label">积分清零规则</label>
                  <select class="form-select" x-model="pointsSettings.pointsClearRule">
                    <option value="never">永不清零</option>
                    <option value="yearly">每年清零一次</option>
                    <option value="inactive">180天未活跃清零</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">预算分配系数</label>
                  <input 
                    type="number" 
                    class="form-control" 
                    x-model.number="pointsSettings.budgetAllocationRatio"
                    step="0.01" 
                    min="0" 
                    max="1"
                    placeholder="0.24"
                  >
                  <small class="text-muted">
                    公式：预算积分 = 消费金额 × 该系数（如1000元×0.24=240预算积分）
                  </small>
                </div>
                <div class="col-12">
                  <button type="submit" class="btn btn-primary" :disabled="saving.points">
                    <span x-show="saving.points" class="spinner-border spinner-border-sm me-1"></span>
                    <i class="bi bi-check-lg" x-show="!saving.points"></i> 保存设置
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
        
        <!-- 通知设置 -->
        <div id="notification-settings" class="card mb-3 settings-section">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-bell"></i> 通知设置</h5>
          </div>
          <div class="card-body">
            <form @submit.prevent="saveNotificationSettings">
              <div class="row g-3">
                <div class="col-12">
                  <h6>邮件通知</h6>
                </div>
                <div class="col-md-6">
                  <label class="form-label">SMTP服务器</label>
                  <input type="text" class="form-control" x-model="notificationSettings.smtpHost" placeholder="smtp.example.com">
                </div>
                <div class="col-md-6">
                  <label class="form-label">SMTP端口</label>
                  <input type="number" class="form-control" x-model.number="notificationSettings.smtpPort">
                </div>
                <div class="col-md-6">
                  <label class="form-label">发件人邮箱</label>
                  <input type="email" class="form-control" x-model="notificationSettings.smtpEmail" placeholder="noreply@example.com">
                </div>
                <div class="col-md-6">
                  <label class="form-label">邮箱密码</label>
                  <input type="password" class="form-control" x-model="notificationSettings.smtpPassword" placeholder="••••••••">
                </div>
                <div class="col-12">
                  <hr>
                  <h6>短信通知</h6>
                </div>
                <div class="col-md-6">
                  <label class="form-label">短信服务商</label>
                  <select class="form-select" x-model="notificationSettings.smsProvider">
                    <option value="">请选择</option>
                    <option value="aliyun">阿里云</option>
                    <option value="tencent">腾讯云</option>
                    <option value="huawei">华为云</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">AccessKey ID</label>
                  <input type="text" class="form-control" x-model="notificationSettings.smsAccessKey" placeholder="AccessKey ID">
                </div>
                <div class="col-md-6">
                  <label class="form-label">AccessKey Secret</label>
                  <input type="password" class="form-control" x-model="notificationSettings.smsAccessSecret" placeholder="••••••••">
                </div>
                <div class="col-md-6">
                  <label class="form-label">短信签名</label>
                  <input type="text" class="form-control" x-model="notificationSettings.smsSignature" placeholder="【系统名称】">
                </div>
                <div class="col-12">
                  <button type="submit" class="btn btn-primary" :disabled="saving.notification">
                    <span x-show="saving.notification" class="spinner-border spinner-border-sm me-1"></span>
                    <i class="bi bi-check-lg" x-show="!saving.notification"></i> 保存设置
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
        
        <!-- 安全设置 -->
        <div id="security-settings" class="card mb-3 settings-section">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-shield-lock"></i> 安全设置</h5>
          </div>
          <div class="card-body">
            <form @submit.prevent="saveSecuritySettings">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">登录失败锁定次数</label>
                  <input type="number" class="form-control" x-model.number="securitySettings.loginFailLimit" min="3">
                </div>
                <div class="col-md-6">
                  <label class="form-label">锁定时长(分钟)</label>
                  <input type="number" class="form-control" x-model.number="securitySettings.lockoutDuration" min="5">
                </div>
                <div class="col-md-6">
                  <label class="form-label">会话超时时间(分钟)</label>
                  <input type="number" class="form-control" x-model.number="securitySettings.sessionTimeout" min="10">
                </div>
                <div class="col-md-6">
                  <label class="form-label">JWT Token有效期(小时)</label>
                  <input type="number" class="form-control" x-model.number="securitySettings.jwtExpireHours" min="1">
                </div>
                <div class="col-12">
                  <label class="form-label">IP白名单</label>
                  <textarea class="form-control" x-model="securitySettings.ipWhitelist" rows="3" placeholder="每行一个IP地址，留空表示不限制"></textarea>
                  <small class="text-muted">示例：192.168.1.1 或 192.168.1.0/24</small>
                </div>
                <div class="col-12">
                  <label class="form-label">安全选项</label>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" x-model="securitySettings.enableTwoFactor" id="enableTwoFactor">
                    <label class="form-check-label" for="enableTwoFactor">
                      启用双因素认证
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" x-model="securitySettings.forceHttps" id="forceHttps">
                    <label class="form-check-label" for="forceHttps">
                      强制使用HTTPS
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" x-model="securitySettings.enableAuditLog" id="enableAuditLog">
                    <label class="form-check-label" for="enableAuditLog">
                      启用操作审计日志
                    </label>
                  </div>
                </div>
                <div class="col-12">
                  <button type="submit" class="btn btn-primary" :disabled="saving.security">
                    <span x-show="saving.security" class="spinner-border spinner-border-sm me-1"></span>
                    <i class="bi bi-check-lg" x-show="!saving.security"></i> 保存设置
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
        
        <!-- 缓存管理 -->
        <div id="cache-settings" class="card mb-3 settings-section">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-database"></i> 缓存管理</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-12">
                <div class="alert alert-info">
                  <i class="bi bi-info-circle"></i>
                  清除缓存可能会暂时影响系统性能，建议在低峰期操作。
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div class="card-body text-center">
                    <i class="bi bi-box text-primary" style="font-size: 3rem;"></i>
                    <h6 class="mt-2">用户缓存</h6>
                    <p class="text-muted small">清除用户信息、权限等缓存</p>
                    <button 
                      class="btn btn-outline-primary btn-sm" 
                      @click="clearCache('user')"
                      :disabled="clearing.user"
                    >
                      <span x-show="clearing.user" class="spinner-border spinner-border-sm me-1"></span>
                      <i class="bi bi-trash" x-show="!clearing.user"></i> 清除
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div class="card-body text-center">
                    <i class="bi bi-graph-up text-success" style="font-size: 3rem;"></i>
                    <h6 class="mt-2">统计缓存</h6>
                    <p class="text-muted small">清除统计数据缓存</p>
                    <button 
                      class="btn btn-outline-success btn-sm" 
                      @click="clearCache('stats')"
                      :disabled="clearing.stats"
                    >
                      <span x-show="clearing.stats" class="spinner-border spinner-border-sm me-1"></span>
                      <i class="bi bi-trash" x-show="!clearing.stats"></i> 清除
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div class="card-body text-center">
                    <i class="bi bi-gear text-warning" style="font-size: 3rem;"></i>
                    <h6 class="mt-2">系统配置缓存</h6>
                    <p class="text-muted small">清除系统配置缓存</p>
                    <button 
                      class="btn btn-outline-warning btn-sm" 
                      @click="clearCache('config')"
                      :disabled="clearing.config"
                    >
                      <span x-show="clearing.config" class="spinner-border spinner-border-sm me-1"></span>
                      <i class="bi bi-trash" x-show="!clearing.config"></i> 清除
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div class="card-body text-center">
                    <i class="bi bi-asterisk text-danger" style="font-size: 3rem;"></i>
                    <h6 class="mt-2">全部缓存</h6>
                    <p class="text-muted small">清除所有缓存数据</p>
                    <button 
                      class="btn btn-outline-danger btn-sm" 
                      @click="clearCache('all')"
                      :disabled="clearing.all"
                    >
                      <span x-show="clearing.all" class="spinner-border spinner-border-sm me-1"></span>
                      <i class="bi bi-trash" x-show="!clearing.all"></i> 清除
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 加载遮罩层 -->
  <div class="loading-overlay" :class="{ 'show': loading }">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">处理中...</span>
    </div>
  </div>

  <!-- ✅ Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- ✅ 引入通用工具库 -->
  <script src="/admin/js/api-config.js"></script>
  <script src="/admin/js/admin-common.js"></script>
  
  <!-- ✅ 页面专属逻辑（必须在 Alpine 之前加载） -->
  <script src="/admin/js/pages/settings.js"></script>
  
  <!-- ✅ Alpine.js -->
  <script defer src="/admin/js/vendor/alpine.min.js"></script>
</body>
</html>
