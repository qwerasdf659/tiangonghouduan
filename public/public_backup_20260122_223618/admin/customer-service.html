<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- âœ… CSPç­–ç•¥ - å…è®¸åŠ è½½æœ¬åœ°è„šæœ¬å’ŒWebSocketè¿æ¥ -->
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; 
                 script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; 
                 style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; 
                 font-src 'self' https://cdn.jsdelivr.net; 
                 connect-src 'self' ws: wss: http://localhost:* https://localhost:*; 
                 img-src 'self' data: https:;"
    />

    <title>å®¢æœå·¥ä½œå° - ç®¡ç†åå°</title>

    <!-- âœ… Bootstrap 5 - UIæ¡†æ¶ -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- âœ… Bootstrap Icons - å›¾æ ‡åº“ -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- âœ… å…¬å…±æ ·å¼è¡¨ - ç»Ÿä¸€ä¸»é¢˜å’Œå“åº”å¼è®¾è®¡ -->
    <link href="/admin/css/common.css" rel="stylesheet" />

    <!-- âœ… é¡µé¢ç‰¹æœ‰æ ·å¼ -->
    <style>
      body {
        height: 100vh;
        overflow: hidden;
      }
      .cs-container {
        height: calc(100vh - 56px);
        display: flex;
      }
      .sessions-sidebar {
        width: 320px;
        border-right: 1px solid #dee2e6;
        display: flex;
        flex-direction: column;
        background: #f8f9fa;
      }
      .session-item {
        padding: 12px 16px;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
        transition: background 0.2s;
      }
      .session-item:hover {
        background: #e9ecef;
      }
      .session-item.active {
        background: #fff;
        border-left: 3px solid #0d6efd;
      }
      .session-item .unread-badge {
        background: #dc3545;
        color: white;
        border-radius: 10px;
        padding: 2px 8px;
        font-size: 0.75rem;
        font-weight: bold;
      }
      .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #fff;
        overflow: hidden;
        min-height: 0;
      }
      .chat-interface {
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .chat-header {
        padding: 16px 20px;
        border-bottom: 1px solid #dee2e6;
        background: #fff;
        flex-shrink: 0;
      }
      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f5f5f5;
        min-height: 0;
      }
      .message-item {
        margin-bottom: 16px;
        display: flex;
        align-items: flex-start;
      }
      .message-item.user-message {
        justify-content: flex-start;
      }
      .message-item.admin-message {
        justify-content: flex-end;
      }
      .message-bubble {
        max-width: 60%;
        padding: 10px 14px;
        border-radius: 12px;
        word-wrap: break-word;
      }
      .user-message .message-bubble {
        background: #fff;
        border: 1px solid #dee2e6;
      }
      .admin-message .message-bubble {
        background: #0d6efd;
        color: white;
      }
      .message-time {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 4px;
      }
      .chat-input-area {
        padding: 16px 20px;
        border-top: 1px solid #dee2e6;
        background: #fff;
        flex-shrink: 0;
      }
      .quick-replies {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }
    </style>
  
  <!-- âœ… Alpine.js Mixin ç³»ç»Ÿ -->
  <script defer src="/admin/js/alpine/mixins-bundle.js"></script>
  <script defer src="/admin/js/alpine/init.js"></script>
  <script defer src="/admin/js/vendor/alpine.min.js"></script>

  <style>
    [x-cloak] { display: none !important; }
  </style>
</head>
  <body class="bg-light" x-data="customerServicePage()" x-cloak>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="navbar navbar-dark bg-primary">
      <div class="container-fluid">
        <a href="/admin/dashboard.html" class="navbar-brand">
          <i class="bi bi-arrow-left me-2"></i>ğŸ’¬ ç®¡ç†åå° - å®¢æœå·¥ä½œå°
        </a>
        <div>
          <span class="text-light me-3" x-text="'æ¬¢è¿ï¼Œ' + welcomeText">æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
          <button class="btn btn-outline-light btn-sm" @click="handleLogout">é€€å‡ºç™»å½•</button>
        </div>
      </div>
    </nav>

    <!-- å®¢æœå·¥ä½œå°ä¸»ä½“ -->
    <div class="cs-container">
      <!-- ä¼šè¯åˆ—è¡¨ä¾§è¾¹æ  -->
      <div class="sessions-sidebar">
        <!-- ç­›é€‰å™¨ -->
        <div class="p-3 border-bottom bg-white">
          <div class="input-group input-group-sm mb-2">
            <input 
              type="text" 
              class="form-control" 
              x-model="searchKeyword" 
              placeholder="æœç´¢ç”¨æˆ·..."
              @keypress.enter="loadSessions()"
            />
            <button class="btn btn-outline-secondary" @click="loadSessions()">
              <i class="bi bi-search"></i>
            </button>
          </div>
          <select class="form-select form-select-sm" x-model="statusFilter" @change="loadSessions()">
            <option value="all">å…¨éƒ¨ä¼šè¯</option>
            <option value="waiting">å¾…å¤„ç†</option>
            <option value="active">è¿›è¡Œä¸­</option>
            <option value="closed">å·²å…³é—­</option>
          </select>
        </div>

        <!-- ä¼šè¯åˆ—è¡¨ -->
        <div class="flex-fill overflow-auto" id="sessionsList">
          <!-- åŠ è½½çŠ¶æ€ -->
          <template x-if="sessionsLoading">
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
              </div>
              <p class="mt-2 text-muted small">æ­£åœ¨åŠ è½½ä¼šè¯...</p>
            </div>
          </template>
          
          <!-- æ— æ•°æ®çŠ¶æ€ -->
          <template x-if="!sessionsLoading && allSessions.length === 0">
            <div class="text-center py-5">
              <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
              <p class="mt-2 text-muted small">æš‚æ— ä¼šè¯</p>
            </div>
          </template>
          
          <!-- ä¼šè¯åˆ—è¡¨ -->
          <template x-for="session in allSessions" :key="session.session_id">
            <div 
              class="session-item" 
              :class="{ 'active': String(session.session_id) === String(currentSessionId) }"
              @click="openSession(session.session_id)"
            >
              <div class="d-flex justify-content-between align-items-start mb-1">
                <div class="d-flex align-items-center flex-fill">
                  <img 
                    :src="getSessionUserAvatar(session)" 
                    class="rounded-circle me-2 session-avatar-img" 
                    style="width: 36px; height: 36px;"
                    alt="å¤´åƒ"
                    @error="$event.target.src = defaultAvatar"
                  >
                  <div class="flex-fill">
                    <div class="fw-bold small" x-text="getSessionUserNickname(session)"></div>
                    <div class="text-muted" style="font-size: 0.75rem;" x-text="maskPhone(getSessionUserMobile(session))"></div>
                  </div>
                </div>
                <span class="unread-badge" x-show="session.unread_count > 0" x-text="session.unread_count"></span>
              </div>
              <div class="text-muted small text-truncate" x-text="getSessionLastMessage(session)"></div>
              <div class="d-flex justify-content-between align-items-center mt-1">
                <span class="badge" :class="getSessionStatusBadge(session.status)" x-text="getSessionStatusText(session.status)"></span>
                <small class="text-muted" style="font-size: 0.7rem;" x-text="$format.relativeTime(session.updated_at)"></small>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- èŠå¤©ä¸»åŒºåŸŸ -->
      <div class="chat-main">
        <!-- é»˜è®¤ç©ºçŠ¶æ€ -->
        <div x-show="!currentSessionId" class="h-100 d-flex align-items-center justify-content-center">
          <div class="text-center text-muted">
            <i class="bi bi-chat-dots" style="font-size: 4rem"></i>
            <p class="mt-3">è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªä¼šè¯å¼€å§‹èŠå¤©</p>
          </div>
        </div>

        <!-- èŠå¤©ç•Œé¢ -->
        <div
          x-show="currentSessionId"
          class="chat-interface"
          x-cloak
        >
          <!-- èŠå¤©å¤´éƒ¨ -->
          <div class="chat-header">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <img
                  :src="currentChatUser.avatar"
                  class="rounded-circle me-3"
                  style="width: 40px; height: 40px"
                  alt="å¤´åƒ"
                  @error="$event.target.src = defaultAvatar"
                />
                <div>
                  <h6 class="mb-0" x-text="currentChatUser.nickname">ç”¨æˆ·æ˜µç§°</h6>
                  <small class="text-muted" x-text="maskPhone(currentChatUser.mobile)">æ‰‹æœºå·</small>
                </div>
              </div>
              <div>
                <button class="btn btn-sm btn-outline-primary me-2" @click="transferSession">
                  <i class="bi bi-arrow-left-right"></i> è½¬æ¥
                </button>
                <button class="btn btn-sm btn-outline-success me-2" @click="closeSession">
                  <i class="bi bi-check-circle"></i> ç»“æŸä¼šè¯
                </button>
                <button class="btn btn-sm btn-outline-info" @click="viewUserInfo">
                  <i class="bi bi-person-circle"></i> ç”¨æˆ·ä¿¡æ¯
                </button>
              </div>
            </div>
          </div>

          <!-- æ¶ˆæ¯åŒºåŸŸ -->
          <div class="chat-messages" x-ref="chatMessages">
            <template x-for="msg in currentMessages" :key="msg.message_id || msg.id || Math.random()">
              <div class="message-item" :class="msg.sender_type === 'admin' ? 'admin-message' : 'user-message'">
                <div>
                  <div class="message-bubble" x-text="msg.message_content || msg.content"></div>
                  <div class="message-time" :class="msg.sender_type === 'admin' ? 'text-end' : ''" x-text="$format.date(msg.created_at)"></div>
                </div>
              </div>
            </template>
          </div>

          <!-- è¾“å…¥åŒºåŸŸ -->
          <div class="chat-input-area">
            <!-- å¿«æ·å›å¤ -->
            <div class="quick-replies">
              <template x-for="reply in quickReplies" :key="reply.text">
                <button
                  class="btn btn-sm btn-outline-secondary"
                  @click="insertQuickReply(reply.content)"
                  x-text="reply.text"
                ></button>
              </template>
            </div>

            <!-- è¾“å…¥æ¡† -->
            <div class="input-group">
              <textarea
                class="form-control"
                x-model="messageInput"
                rows="3"
                placeholder="è¾“å…¥æ¶ˆæ¯...æŒ‰Enterå‘é€ï¼ŒShift+Enteræ¢è¡Œ"
                @keydown.enter.prevent="if (!$event.shiftKey) sendMessage()"
              ></textarea>
              <button class="btn btn-primary" @click="sendMessage">
                <i class="bi bi-send"></i> å‘é€
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç”¨æˆ·ä¿¡æ¯æ¨¡æ€æ¡† -->
    <div class="modal fade" id="userInfoModal" tabindex="-1" x-ref="userInfoModal">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-person-circle"></i> ç”¨æˆ·è¯¦ç»†ä¿¡æ¯</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <template x-if="userInfoData">
              <div>
                <div class="text-center mb-3">
                  <img 
                    :src="userInfoData.avatar_url || defaultAvatar" 
                    class="rounded-circle" 
                    style="width: 80px; height: 80px;" 
                    @error="$event.target.src = defaultAvatar" 
                    alt="å¤´åƒ"
                  >
                </div>
                <div class="row g-2">
                  <div class="col-6"><strong>ç”¨æˆ·IDï¼š</strong><span x-text="userInfoData.user_id || userInfoData.id"></span></div>
                  <div class="col-6"><strong>æ˜µç§°ï¼š</strong><span x-text="userInfoData.nickname || 'æœªè®¾ç½®'"></span></div>
                  <div class="col-6"><strong>æ‰‹æœºå·ï¼š</strong><span x-text="userInfoData.mobile || '-'"></span></div>
                  <div class="col-6"><strong>ç§¯åˆ†ï¼š</strong><span class="text-primary" x-text="$format.number(userInfoData.points_balance || 0)"></span></div>
                  <div class="col-6"><strong>æ³¨å†Œæ—¶é—´ï¼š</strong><span x-text="$format.date(userInfoData.created_at)"></span></div>
                  <div class="col-6"><strong>æœ€åæ´»è·ƒï¼š</strong><span x-text="userInfoData.last_active_at ? $format.date(userInfoData.last_active_at) : 'ä»æœª'"></span></div>
                </div>
              </div>
            </template>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
          </div>
        </div>
      </div>
    </div>

    <!-- è½¬æ¥ä¼šè¯æ¨¡æ€æ¡† -->
    <div class="modal fade" id="transferModal" tabindex="-1" x-ref="transferModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-arrow-left-right"></i> è½¬æ¥ä¼šè¯</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <label class="form-label">é€‰æ‹©æ¥æ”¶å®¢æœ</label>
            <select class="form-select" x-model="transferTargetId">
              <option value="">è¯·é€‰æ‹©...</option>
              <template x-for="admin in adminList" :key="admin.user_id">
                <option :value="admin.user_id" x-text="admin.nickname || admin.mobile"></option>
              </template>
            </select>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" @click="submitTransfer">ç¡®è®¤è½¬æ¥</button>
          </div>
        </div>
      </div>
    </div>

    <!-- åŠ è½½é®ç½©å±‚ -->
    <div class="loading-overlay" :class="{ 'show': loadingOverlay }">
      <div class="spinner-border text-light" style="width: 3rem; height: 3rem" role="status">
        <span class="visually-hidden">å¤„ç†ä¸­...</span>
      </div>
    </div>

    <!-- âœ… Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- âœ… Socket.IOå®¢æˆ·ç«¯åº“ - æœ¬åœ°ç‰ˆæœ¬ -->
    <script src="/admin/js/vendor/socket.io.min.js"></script>

    <!-- âœ… å¼•å…¥é€šç”¨å·¥å…·åº“ -->
    <script src="/admin/js/admin-common.js"></script>
    <script src="/admin/js/api-config.js"></script>


    <!-- âœ… å®¢æœå·¥ä½œå°é¡µé¢é€»è¾‘ -->
    <script src="/admin/js/pages/customer-service.js"></script>

</body>
</html>
