# ğŸ”§ é¡¹ç›®å½»åº•é‡æ„æ–¹æ¡ˆ - åŒè½¨æ¸…ç†ä¸æŠ€æœ¯å€ºåŠ¡æ¶ˆé™¤

> **åˆ›å»ºæ—¶é—´**ï¼š2026å¹´01æœˆ21æ—¥  
> **æœ€åæ›´æ–°**ï¼š2026å¹´01æœˆ21æ—¥ 19:30ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰  
> **æ–‡æ¡£ç‰ˆæœ¬**ï¼šV3.6ï¼ˆæ·±åº¦ä»£ç éªŒè¯ products è¡¨ä½¿ç”¨æƒ…å†µï¼Œå®Œå–„å†³ç­–10è¯¦æƒ…ï¼‰  
> **ç›®æ ‡**ï¼šåœ¨ä¿è¯ä¸šåŠ¡åŠŸèƒ½ä¸å˜çš„å‰æä¸‹ï¼Œå½»åº•ç§»é™¤è¿ç§»æ®‹ç•™ã€ç»Ÿä¸€æŠ€æœ¯æ–¹æ¡ˆã€é™ä½é•¿æœŸç»´æŠ¤æˆæœ¬  
> **éªŒè¯æ–¹å¼**ï¼šNode.js è¿æ¥çœŸå®æ•°æ®åº“ï¼ˆéå¤‡ä»½æ–‡ä»¶ï¼‰+ ä»£ç é™æ€åˆ†æ + grep æ·±åº¦ä»£ç æ‰«æ  
> **é¡¹ç›®å¥åº·åº¦**ï¼šâœ… **ä¼˜ç§€** - æ•°æ®åº“å±‚å’ŒæœåŠ¡æ¶æ„å·²é«˜åº¦ç»Ÿä¸€ï¼Œä»…å‰©æ³¨é‡Šå±‚æ®‹ç•™

---

## âš¡ å¾…å†³ç­–äº‹é¡¹å¿«é€Ÿæ±‡æ€»ï¼ˆè¯·ä¼˜å…ˆé˜…è¯»ï¼‰

### ğŸ“‹ 12é¡¹å†³ç­–ä¸€è§ˆè¡¨

| # | å†³ç­–é¡¹ | æ¨è | é£é™© | æ‚¨çš„å†³å®š |
|---|--------|------|------|---------|
| **1** | å®¡è®¡æ—¥å¿—æ˜ å°„ä»£ç  `TARGET_TYPE_LEGACY_MAPPING` | âœ… **A åˆ é™¤** | ğŸŸ¢ é›¶é£é™© | ____ |
| **2** | å‰ç«¯ `name` å­—æ®µå…¼å®¹ | âš ï¸ éœ€ç¡®è®¤ | ğŸŸ¡ éœ€åè°ƒ | ____ |
| **3** | `rarity` fallback é€»è¾‘ | âœ… **A ç®€åŒ–** | ğŸŸ¢ ä½é£é™© | ____ |
| **4** | `emptyâ†’fallback` æ³¨é‡Šæªè¾ | âœ… **A ä¸šåŠ¡è®¾è®¡** | ğŸŸ¢ é›¶é£é™© | ____ |
| **5** | æœåŠ¡åˆå¹¶ç­–ç•¥ï¼ˆ3ä¸ªæœåŠ¡ï¼‰ | å»ºè®® A | ğŸŸ¡ ä¸­ç­‰ | ____ |
| **6** | å¤‡ä»½ä¿ç•™ç­–ç•¥ï¼ˆ20ä¸ªç›®å½•ï¼‰ | âœ… **A ä¿ç•™2ä¸ª** | ğŸŸ¢ é›¶é£é™© | ____ |
| **7** | æµ‹è¯•è„šæœ¬å¤„ç†ï¼ˆ15ä¸ªè„šæœ¬ï¼‰ | âœ… **A ç§»åŠ¨æ•´ç†** | ğŸŸ¢ é›¶é£é™© | ____ |
| **8** | æ ¹ç›®å½•å¤‡ä»½æ–‡ä»¶ï¼ˆ3ä¸ªæ–‡ä»¶ï¼‰ | âœ… **A å…¨åˆ ** | ğŸŸ¢ é›¶é£é™© | ____ |
| **9** | ç©ºè¡¨å¤„ç†ç­–ç•¥ | âœ… **B ä¿ç•™** | ğŸŸ¢ é›¶é£é™© | ____ |
| **10** | `products` è¡¨å¤„ç†ï¼ˆ52æ¡æ•°æ®ï¼‰ | âš ï¸ éœ€ç¡®è®¤ | ğŸŸ¡ éœ€ç¡®è®¤ | ____ |
| **11** | `@deprecated` æ–¹æ³•ï¼ˆ3å¤„ï¼‰ | âœ… **A ç«‹å³åˆ é™¤** | ğŸŸ¢ ä½é£é™© | ____ |
| **12** | è¿ç§»æ–‡ä»¶å½’æ¡£ï¼ˆ279ä¸ªæ–‡ä»¶ï¼‰ | âœ… **A å½’æ¡£** | ğŸŸ¢ é›¶é£é™© | ____ |

### âš ï¸ éœ€è¦æ‚¨ç‰¹åˆ«ç¡®è®¤çš„3ä¸ªé—®é¢˜

1. **å†³ç­–2**ï¼šå‰ç«¯æ˜¯å¦å·²ç»Ÿä¸€ä½¿ç”¨ `campaign_name`ï¼Ÿï¼ˆâ†’ [è·³è½¬è¯¦æƒ…](#å†³ç­–2å‰ç«¯å…¼å®¹å­—æ®µ-name-çš„å¤„ç†)ï¼‰
2. **å†³ç­–5**ï¼šæ˜¯å¦æ‰§è¡Œ3é¡¹æœåŠ¡åˆå¹¶ï¼Ÿï¼ˆâ†’ [è·³è½¬è¯¦æƒ…](#å†³ç­–5æœåŠ¡åˆå¹¶ç­–ç•¥)ï¼‰
3. **å†³ç­–10**ï¼š`products` è¡¨52æ¡æ•°æ®æ˜¯å¦æœ‰ä¸šåŠ¡ç”¨é€”ï¼Ÿï¼ˆâ†’ [è·³è½¬è¯¦æƒ…](#å†³ç­–10products-è¡¨å¤„ç†)ï¼‰

### ğŸš€ å¿«é€Ÿç¡®è®¤æ¨¡æ¿

å¦‚æœæ‚¨åŒæ„æ‰€æœ‰æ¨èé€‰é¡¹ï¼Œå¯ç›´æ¥å¤åˆ¶å¹¶ä¿®æ”¹ï¼š

```
å†³ç­–1: Aï¼ˆåˆ é™¤æ˜ å°„ä»£ç ï¼‰
å†³ç­–2: [A/B]ï¼ˆâš ï¸ éœ€ç¡®è®¤å‰ç«¯çŠ¶æ€ï¼‰
å†³ç­–3: Aï¼ˆç®€åŒ–rarityé€»è¾‘ï¼‰
å†³ç­–4: Aï¼ˆä¸šåŠ¡è®¾è®¡ï¼Œä¿®æ”¹æ³¨é‡Šï¼‰
å†³ç­–5: [A/B]ï¼ˆâš ï¸ æ‚¨çš„é€‰æ‹©ï¼‰
å†³ç­–6: âœ… å·²ç¡®è®¤ï¼ˆåˆ é™¤15ä¸ª/ä¿ç•™5ä¸ªï¼‰
å†³ç­–7: [A/B/C/D]ï¼ˆâš ï¸ æ‚¨çš„é€‰æ‹©ï¼šåˆ 9ç§»6/å…¨åˆ /å…¨ç§»/ä¿æŒï¼‰
å†³ç­–8: Aï¼ˆåˆ é™¤æ ¹ç›®å½•å¤‡ä»½ï¼‰
å†³ç­–9: Bï¼ˆä¿ç•™ç©ºè¡¨ï¼‰
å†³ç­–10: [A/B]ï¼ˆâš ï¸ éœ€ç¡®è®¤productsè¡¨ç”¨é€”ï¼‰
å†³ç­–11: Aï¼ˆåˆ é™¤deprecatedæ–¹æ³•ï¼‰
å†³ç­–12: Aï¼ˆå½’æ¡£è¿ç§»æ–‡ä»¶ï¼‰
```

### ğŸ¯ é¢„æœŸæ”¶ç›Š

| ç»´åº¦ | é¢„æœŸæ•ˆæœ |
|------|---------|
| **ä»£ç å¯è¯»æ€§** | åˆ é™¤çº¦ 100-200 è¡Œæ— ç”¨ä»£ç å’Œæ³¨é‡Š |
| **ç»´æŠ¤æˆæœ¬** | æ¶ˆé™¤å†å²åŒ…è¢±ï¼Œæ–°äººä¸Šæ‰‹æ›´å¿« |
| **ç£ç›˜ç©ºé—´** | æ¸…ç†å¤‡ä»½åé‡Šæ”¾çº¦ 500MB-1GB |
| **æŠ€æœ¯å€ºåŠ¡** | é™ä½é•¿æœŸç»´æŠ¤å¤æ‚åº¦ |

---

## ã€‡ã€å½“å‰é¡¹ç›®çŠ¶æ€æ€»ç»“

### ğŸ“Š æŠ€æœ¯æ ˆæ¦‚è§ˆ

| æŠ€æœ¯é¢†åŸŸ | å½“å‰æ–¹æ¡ˆ | ç‰ˆæœ¬/çŠ¶æ€ |
|---------|---------|----------|
| **åç«¯è¿è¡Œæ—¶** | Node.js | 20+ (>=20.18.0) |
| **Webæ¡†æ¶** | Express | 4.x |
| **æ•°æ®åº“** | MySQL + Sequelize ORM | 279ä¸ªè¿ç§»æ–‡ä»¶ |
| **ç¼“å­˜** | Redisï¼ˆåˆ†å¸ƒå¼é” + L2ç¼“å­˜ï¼‰ | ioredis |
| **è®¤è¯** | JWT | jsonwebtoken |
| **æˆæƒ** | RBACï¼ˆ10ä¸ªè§’è‰²å®šä¹‰ï¼‰ | è‡ªç ” |
| **APIæ¶æ„** | V4 RESTful æ‰å¹³åŒ–è·¯ç”± | `/api/v4/{resource}` |
| **æ—¶åŒº** | åŒ—äº¬æ—¶é—´å…¨é“¾è·¯ | Asia/Shanghai |
| **éƒ¨ç½²** | Docker + Kubernetes + Sealos | äº‘åŸç”Ÿ |

### ğŸ“ˆ æ•°æ®åº“çœŸå®æ•°æ®ç»Ÿè®¡ï¼ˆ2026-01-21 å®æµ‹ï¼‰

ä»¥ä¸‹ä¸ºé€šè¿‡ Node.js è¿æ¥çœŸå®æ•°æ®åº“è·å–çš„å„è¡¨è®°å½•æ•°ï¼š

**æ•°æ®åº“è¡¨æ€»æ•°ï¼š67å¼ è¡¨**

#### æ ¸å¿ƒä¸šåŠ¡æ•°æ®è¡¨

| è¡¨å | è®°å½•æ•° | è¯´æ˜ | çŠ¶æ€ |
|------|--------|------|------|
| `users` | 28 | ç”¨æˆ·ä¸»è¡¨ | âœ… æ­£å¸¸è¿è¥ |
| `roles` | 10 | RBACè§’è‰²å®šä¹‰ | âœ… æ­£å¸¸ |
| `user_roles` | 20 | ç”¨æˆ·è§’è‰²å…³è” | âœ… æ­£å¸¸ |
| `accounts` | 23 | ç»Ÿä¸€è´¦æˆ· | âœ… æ­£å¸¸ |
| `account_asset_balances` | 23 | è´¦æˆ·èµ„äº§ä½™é¢ | âœ… æ­£å¸¸ |
| `asset_transactions` | 5,075 | èµ„äº§æµæ°´ | âœ… æ´»è·ƒè¿è¥ |
| `item_templates` | 16 | ç‰©å“æ¨¡æ¿ | âœ… æ­£å¸¸ |
| `item_instances` | 1,992 | ç‰©å“å®ä¾‹ | âœ… æ´»è·ƒè¿è¥ |
| `item_instance_events` | 1,031 | ç‰©å“äº‹ä»¶æ—¥å¿— | âœ… æ­£å¸¸ |

#### æŠ½å¥–ç³»ç»Ÿè¡¨

| è¡¨å | è®°å½•æ•° | è¯´æ˜ | çŠ¶æ€ |
|------|--------|------|------|
| `lottery_campaigns` | 1 | æŠ½å¥–æ´»åŠ¨ | âœ… æ­£å¸¸ |
| `lottery_prizes` | 16 | å¥–å“å®šä¹‰ | âœ… æ­£å¸¸ |
| `lottery_draws` | 2 | æŠ½å¥–è®°å½• | âœ… å¾…è¿è¥ |
| `lottery_presets` | 2 | æŠ½å¥–é¢„è®¾ | âœ… æ­£å¸¸ |
| `lottery_management_settings` | 2,338 | æŠ½å¥–ç®¡ç†é…ç½® | âœ… æ´»è·ƒé…ç½® |
| `lottery_strategy_config` | 17 | ç­–ç•¥é…ç½® | âœ… æ­£å¸¸ |
| `lottery_tier_rules` | 9 | æ¡£ä½è§„åˆ™ | âœ… æ­£å¸¸ |
| `lottery_tier_matrix_config` | 12 | æ¡£ä½çŸ©é˜µé…ç½® | âœ… æ­£å¸¸ |
| `lottery_campaign_pricing_config` | 4 | å®šä»·é…ç½® | âœ… æ­£å¸¸ |
| `lottery_draw_quota_rules` | 5 | æŠ½å¥–é…é¢è§„åˆ™ | âœ… æ­£å¸¸ |
| `lottery_user_daily_draw_quota` | 7 | ç”¨æˆ·æ¯æ—¥é…é¢ | âœ… æ­£å¸¸ |
| `lottery_clear_setting_records` | 492 | æ¸…ç©ºè®¾ç½®è®°å½• | âœ… æ­£å¸¸ |

#### å•†åŸä¸äº¤æ˜“è¡¨

| è¡¨å | è®°å½•æ•° | è¯´æ˜ | çŠ¶æ€ |
|------|--------|------|------|
| `exchange_items` | 26 | å…‘æ¢å•†å“ | âœ… æ­£å¸¸ |
| `exchange_records` | 7 | å…‘æ¢è®°å½• | âœ… å¾…è¿è¥ |
| `products` | 52 | å•†å“ä¿¡æ¯ | âœ… æ­£å¸¸ |
| `market_listings` | 38 | å¸‚åœºæŒ‚ç‰Œ | âœ… æ´»è·ƒè¿è¥ |
| `trade_orders` | 0 | äº¤æ˜“è®¢å• | â³ å¾…ä½¿ç”¨ |
| `redemption_orders` | 932 | æ ¸é”€è®¢å• | âœ… æ´»è·ƒè¿è¥ |

#### é—¨åº—ä¸å±‚çº§è¡¨

| è¡¨å | è®°å½•æ•° | è¯´æ˜ | çŠ¶æ€ |
|------|--------|------|------|
| `stores` | 4 | é—¨åº— | âœ… æ­£å¸¸ |
| `store_staff` | 2 | é—¨åº—å‘˜å·¥ | âœ… æ­£å¸¸ |
| `user_hierarchy` | 9 | ç”¨æˆ·å±‚çº§å…³ç³» | âœ… æ­£å¸¸ |
| `administrative_regions` | 44,703 | è¡Œæ”¿åŒºåŸŸï¼ˆä¸­å›½ï¼‰ | âœ… åŸºç¡€æ•°æ® |

#### é…ç½®ä¸ç³»ç»Ÿè¡¨

| è¡¨å | è®°å½•æ•° | è¯´æ˜ | çŠ¶æ€ |
|------|--------|------|------|
| `system_settings` | 39 | ç³»ç»Ÿé…ç½® | âœ… æ­£å¸¸ |
| `feature_flags` | 7 | åŠŸèƒ½å¼€å…³ | âœ… æ­£å¸¸ |
| `popup_banners` | 2 | å¼¹çª—æ¨ªå¹… | âœ… æ­£å¸¸ |
| `system_announcements` | 9 | ç³»ç»Ÿå…¬å‘Š | âœ… æ­£å¸¸ |
| `material_asset_types` | 4 | ææ–™èµ„äº§ç±»å‹ | âœ… æ­£å¸¸ |
| `material_conversion_rules` | 1 | ææ–™è½¬æ¢è§„åˆ™ | âœ… å¾…é…ç½® |
| `rarity_defs` | 5 | ç¨€æœ‰åº¦å®šä¹‰ | âœ… æ­£å¸¸ |
| `category_defs` | 6 | åˆ†ç±»å®šä¹‰ | âœ… æ­£å¸¸ |
| `asset_group_defs` | 8 | èµ„äº§ç»„å®šä¹‰ | âœ… æ­£å¸¸ |

#### å®¡è®¡ä¸æ—¥å¿—è¡¨

| è¡¨å | è®°å½•æ•° | è¯´æ˜ | çŠ¶æ€ |
|------|--------|------|------|
| `admin_operation_logs` | 3,977 | ç®¡ç†å‘˜æ“ä½œæ—¥å¿— | âœ… æ´»è·ƒè®°å½• |
| `merchant_operation_logs` | 56 | å•†æˆ·æ“ä½œæ—¥å¿— | âœ… æ­£å¸¸ |
| `user_role_change_records` | 175 | è§’è‰²å˜æ›´è®°å½• | âœ… æ­£å¸¸ |
| `user_status_change_records` | 174 | çŠ¶æ€å˜æ›´è®°å½• | âœ… æ­£å¸¸ |
| `content_review_records` | 266 | å†…å®¹å®¡æ ¸è®°å½• | âœ… æ­£å¸¸ |
| `api_idempotency_requests` | 1,222 | APIå¹‚ç­‰è¯·æ±‚ | âœ… æ­£å¸¸ |
| `websocket_startup_logs` | 1,009 | WebSocketå¯åŠ¨æ—¥å¿— | âœ… æ­£å¸¸ |

#### å…¶ä»–åŠŸèƒ½è¡¨

| è¡¨å | è®°å½•æ•° | è¯´æ˜ | çŠ¶æ€ |
|------|--------|------|------|
| `consumption_records` | 10 | æ¶ˆè´¹è®°å½• | âœ… å¾…è¿è¥ |
| `user_premium_status` | 1 | é«˜çº§ä¼šå‘˜çŠ¶æ€ | âœ… å¾…è¿è¥ |
| `feedbacks` | 26 | ç”¨æˆ·åé¦ˆ | âœ… æ­£å¸¸ |
| `chat_messages` | 5 | èŠå¤©æ¶ˆæ¯ | âœ… å¾…è¿è¥ |
| `customer_service_sessions` | 1 | å®¢æœä¼šè¯ | âœ… å¾…è¿è¥ |
| `user_risk_profiles` | 3 | ç”¨æˆ·é£é™©ç”»åƒ | âœ… æ­£å¸¸ |
| `risk_alerts` | 1 | é£é™©å‘Šè­¦ | âœ… æ­£å¸¸ |
| `sequelizemeta` | 279 | è¿ç§»è®°å½• | âœ… ç³»ç»Ÿè¡¨ |

#### æš‚æœªä½¿ç”¨/å¾…æ¸…ç†è¡¨

| è¡¨å | è®°å½•æ•° | è¯´æ˜ | çŠ¶æ€ |
|------|--------|------|------|
| `authentication_sessions` | 0 | è®¤è¯ä¼šè¯ | â³ å¾…ä½¿ç”¨æˆ–æ¸…ç† |
| `image_resources` | 0 | å›¾ç‰‡èµ„æº | â³ å¾…ä½¿ç”¨æˆ–æ¸…ç† |
| `lottery_daily_metrics` | 0 | æ¯æ—¥æŒ‡æ ‡èšåˆ | â³ å¾…ä½¿ç”¨ |
| `lottery_hourly_metrics` | 0 | æ¯å°æ—¶æŒ‡æ ‡ | â³ å¾…ä½¿ç”¨ |
| `lottery_draw_decisions` | 0 | æŠ½å¥–å†³ç­–è®°å½• | â³ å¾…ä½¿ç”¨ |
| `lottery_campaign_quota_grants` | 0 | é…é¢æˆäºˆ | â³ å¾…ä½¿ç”¨ |
| `lottery_campaign_user_quota` | 0 | ç”¨æˆ·æ´»åŠ¨é…é¢ | â³ å¾…ä½¿ç”¨ |
| `lottery_user_experience_state` | 0 | ç”¨æˆ·ä½“éªŒçŠ¶æ€ | â³ å¾…ä½¿ç”¨ |
| `lottery_user_global_state` | 0 | ç”¨æˆ·å…¨å±€çŠ¶æ€ | â³ å¾…ä½¿ç”¨ |
| `preset_budget_debt` | 0 | é¢„è®¾é¢„ç®—å€ºåŠ¡ | â³ å¾…ä½¿ç”¨ |
| `preset_inventory_debt` | 0 | é¢„è®¾åº“å­˜å€ºåŠ¡ | â³ å¾…ä½¿ç”¨ |

**æ•°æ®åˆ†æç»“è®º**ï¼š
- æ ¸å¿ƒä¸šåŠ¡æ•°æ®æ´»è·ƒï¼šç”¨æˆ·28ä¸ªã€ç‰©å“å®ä¾‹è¿‘2000ä¸ªã€èµ„äº§æµæ°´5000+æ¡ã€æ ¸é”€è®¢å•932æ¡
- å¸‚åœºäº¤æ˜“åŠŸèƒ½å·²å¯ç”¨ï¼šå¸‚åœºæŒ‚ç‰Œ38æ¡
- æŠ½å¥–ç³»ç»Ÿé…ç½®å®Œå–„ï¼š2338æ¡ç®¡ç†é…ç½®ã€17æ¡ç­–ç•¥é…ç½®
- å®¡è®¡æ—¥å¿—å®Œæ•´ï¼šè¿‘4000æ¡ç®¡ç†å‘˜æ“ä½œæ—¥å¿—
- æ•°æ®é‡é€‚åˆä¸€æ¬¡æ€§é‡æ„ï¼Œæ— å¤§è§„æ¨¡æ•°æ®è¿ç§»é£é™©

---

### ğŸ—ï¸ æœåŠ¡å±‚æ¶æ„ç»Ÿè®¡

**æœåŠ¡æ–‡ä»¶ç»Ÿè®¡**ï¼ˆ`services/` ç›®å½•ï¼‰ï¼š

| æœåŠ¡ç±»åˆ« | æœåŠ¡æ–‡ä»¶ | è¯´æ˜ |
|---------|---------|------|
| **æŠ½å¥–å¼•æ“** | `UnifiedLotteryEngine/` | V4.6 Pipeline æ¶æ„ï¼Œå« 6 ä¸ª Stage |
| **èµ„äº§åº•åº§** | `AssetService.js`, `AssetConversionService.js` | ç»Ÿä¸€èµ„äº§è´¦æœ¬ç³»ç»Ÿ |
| **èƒŒåŒ…æœåŠ¡** | `BackpackService.js` | åŒè½¨æŸ¥è¯¢èšåˆï¼ˆassets + itemsï¼‰ |
| **å¸‚åœºæœåŠ¡** | `MarketListingService.js`, `TradeOrderService.js` | å¸‚åœºæŒ‚ç‰Œä¸äº¤æ˜“ |
| **æ ¸é”€æœåŠ¡** | `RedemptionService.js` | æ ¸é”€ç ç”Ÿæˆä¸éªŒè¯ |
| **ä¼šå‘˜æœåŠ¡** | `PremiumService.js`, `UserPremiumQueryService.js` | é«˜çº§ä¼šå‘˜åŠŸèƒ½ |
| **å…‘æ¢æœåŠ¡** | `ExchangeService.js` | ç§¯åˆ†å…‘æ¢å•†å“ |
| **å®šä»·æœåŠ¡** | `LotteryPricingService.js` | æŠ½å¥–å®šä»·è®¡ç®—ï¼ˆå•ä¸€çœŸç›¸æºï¼‰ |
| **é…é¢æœåŠ¡** | `LotteryQuotaService.js` | æŠ½å¥–æ¬¡æ•°é…é¢ç®¡ç† |
| **ç›‘æ§æœåŠ¡** | `LotteryMonitoringService.js`, `LotteryStrategyStatsService.js` | æŠ½å¥–ç›‘æ§ç»Ÿè®¡ |
| **å®¡è®¡æœåŠ¡** | `AuditLogService.js` | ç»Ÿä¸€å®¡è®¡æ—¥å¿— |
| **å¹‚ç­‰æœåŠ¡** | `IdempotencyService.js` | API å¹‚ç­‰æ€§ä¿éšœ |
| **ç¼“å­˜æœåŠ¡** | `CacheService.js` | Redis L2 ç¼“å­˜å°è£… |
| **WebSocket** | `ChatWebSocketService.js` | èŠå¤©å®æ—¶é€šè®¯ |

**æ¨¡å‹ç»Ÿè®¡**ï¼ˆ`models/index.js` å¯¼å‡º 67 ä¸ªæ¨¡å‹ï¼‰ï¼š

| é¢†åŸŸ | æ¨¡å‹æ•°é‡ | æ ¸å¿ƒæ¨¡å‹ |
|------|---------|---------|
| ç”¨æˆ·ä¸æƒé™ | 8 | `User`, `Role`, `UserRole`, `AuthenticationSession` |
| æŠ½å¥–ç³»ç»Ÿ | 15 | `LotteryCampaign`, `LotteryPrize`, `LotteryDraw`, `LotteryPreset` ç­‰ |
| ç‰©å“ç³»ç»Ÿ | 6 | `ItemTemplate`, `ItemInstance`, `ItemInstanceEvent` |
| èµ„äº§ç³»ç»Ÿ | 5 | `Account`, `AccountAssetBalance`, `AssetTransaction` |
| å¸‚åœºäº¤æ˜“ | 3 | `MarketListing`, `TradeOrder`, `RedemptionOrder` |
| é—¨åº—å±‚çº§ | 4 | `Store`, `UserHierarchy`, `StoreStaff`, `AdministrativeRegion` |
| ç³»ç»Ÿé…ç½® | 8 | `SystemSettings`, `FeatureFlag`, `PopupBanner` ç­‰ |
| å®¡è®¡æ—¥å¿— | 6 | `AdminOperationLog`, `MerchantOperationLog` ç­‰ |

### ğŸ”Œ API è·¯ç”±æ¶æ„

**V4 RESTful è·¯ç”±ç»“æ„**ï¼ˆ`routes/v4/`ï¼‰ï¼š

```
/api/v4/
â”œâ”€â”€ auth/           # è®¤è¯ç›¸å…³ï¼ˆç™»å½•ã€åˆ·æ–°ã€ç™»å‡ºï¼‰
â”œâ”€â”€ permissions/    # æƒé™æŸ¥è¯¢
â”œâ”€â”€ console/        # æ§åˆ¶å°ï¼ˆç®¡ç†åå°ä¸“ç”¨ï¼‰
â”œâ”€â”€ lottery/        # æŠ½å¥–ç³»ç»Ÿ
â”œâ”€â”€ market/         # å¸‚åœºäº¤æ˜“
â”œâ”€â”€ shop/           # å•†åŸï¼ˆå…‘æ¢å•†å“ï¼‰
â”œâ”€â”€ system/         # ç³»ç»Ÿé…ç½®
â”œâ”€â”€ user/           # ç”¨æˆ·ç®¡ç†
â”œâ”€â”€ assets/         # èµ„äº§ç®¡ç†
â”œâ”€â”€ backpack/       # èƒŒåŒ…æŸ¥è¯¢
â”œâ”€â”€ merchant-points/ # å•†æˆ·ç§¯åˆ†
â”œâ”€â”€ activities/     # æ´»åŠ¨åˆ—è¡¨
â””â”€â”€ debug-control/  # è°ƒè¯•æ§åˆ¶ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
```

### âœ… å·²å®Œæˆçš„æ¸…ç†å·¥ä½œï¼ˆ279ä¸ªè¿ç§»å·²æ‰§è¡Œï¼‰

åŸºäºå¯¹ 279 ä¸ªè¿ç§»æ–‡ä»¶çš„æ·±åº¦åˆ†æï¼Œä»¥ä¸‹æ¸…ç†å·¥ä½œå·²å®Œæˆï¼š

| æ¸…ç†é¡¹ | è¿ç§»æ–‡ä»¶ | çŠ¶æ€ | æ›¿ä»£æ–¹æ¡ˆ |
|--------|---------|------|---------|
| `user_points_accounts` è¡¨åˆ é™¤ | `20251230200000-drop-deprecated-points-tables.js` | âœ… å·²æ‰§è¡Œ | `account_asset_balances` |
| `points_transactions` è¡¨åˆ é™¤ | `20251230200000-drop-deprecated-points-tables.js` | âœ… å·²æ‰§è¡Œ | `asset_transactions` |
| `trade_records` è¡¨åˆ é™¤ | `20260108210000-drop-trade-records-table.js` | âœ… å·²æ‰§è¡Œ | `trade_orders` |
| `item_template_aliases` è¡¨åˆ é™¤ | `20260114001257-drop-item-template-aliases-cleanup.js` | âœ… å·²æ‰§è¡Œ | `item_templates` |
| åºŸå¼ƒå›¾ç‰‡å­—æ®µåˆ é™¤ | `20260114000000-drop-column-deprecated-image-fields.js` | âœ… å·²æ‰§è¡Œ | `image_resources` + `primary_image_id` |
| æ—§å®¡è®¡è¡¨åˆ é™¤ | `20260109120000-drop-deprecated-audit-tables.js` | âœ… å·²æ‰§è¡Œ | `admin_operation_logs` |
| `lottery_campaigns.draw_pricing` JSONæ¸…ç† | `20260120193900-cleanup-legacy-draw-pricing-json.js` | âœ… å·²æ‰§è¡Œ | `lottery_campaign_pricing_config` |
| å­¤å„¿æ•°æ®æ¸…ç† | `20260121060000-cleanup-orphan-records.js` | âœ… å·²æ‰§è¡Œ | ç¡¬åˆ é™¤ |

### âœ… å·²é«˜åº¦ç»Ÿä¸€çš„æ¶æ„ï¼ˆæ— éœ€è¿›ä¸€æ­¥åˆå¹¶ï¼‰

| é¢†åŸŸ | ç»Ÿä¸€æ–¹æ¡ˆ | çŠ¶æ€ |
|------|---------|------|
| **å¹‚ç­‰æ€§æœåŠ¡** | `IdempotencyService.js` - æ˜¾å¼ canonical_operation æ˜ å°„ | âœ… å·²ç»Ÿä¸€ |
| **å®šä»·æœåŠ¡** | `LotteryPricingService.js` - å•ä¸€å®šä»·çœŸç›¸æº | âœ… å·²ç»Ÿä¸€ |
| **èµ„äº§åº•åº§** | `AssetService` + `AccountAssetBalance` + `AssetTransaction` | âœ… å·²ç»Ÿä¸€ |
| **èƒŒåŒ…æŸ¥è¯¢** | `BackpackService.js` - ç»Ÿä¸€æŸ¥è¯¢èšåˆæœåŠ¡ | âœ… å·²ç»Ÿä¸€ |
| **æŠ½å¥–å¼•æ“** | `UnifiedLotteryEngine` V4.6 Pipeline æ¶æ„ | âœ… å·²ç»Ÿä¸€ |

---

### ğŸ” æ•°æ®åº“éªŒè¯ç»“æœï¼ˆ2026-01-21 æœ€æ–°éªŒè¯ï¼‰

é€šè¿‡ Node.js è¿æ¥çœŸå®æ•°æ®åº“è¿›è¡ŒéªŒè¯ï¼Œç¡®è®¤ä»¥ä¸‹æ¸…ç†çŠ¶æ€ï¼š

#### æ—§è¡¨åˆ é™¤éªŒè¯ï¼ˆå…¨éƒ¨é€šè¿‡ï¼‰

| è¡¨å | éªŒè¯ç»“æœ | æ›¿ä»£æ–¹æ¡ˆ |
|------|---------|---------|
| `user_points_accounts` | âœ… å·²åˆ é™¤ | `account_asset_balances` |
| `points_transactions` | âœ… å·²åˆ é™¤ | `asset_transactions` |
| `trade_records` | âœ… å·²åˆ é™¤ | `trade_orders` |
| `audit_records` | âœ… å·²åˆ é™¤ | `admin_operation_logs` |
| `user_inventory` / `user_inventories` | âœ… å·²åˆ é™¤ | `item_instances` |
| `lottery_histories` / `prize_records` | âœ… å·²åˆ é™¤ | `lottery_draws` |
| `merchant_points_reviews` | âœ… å·²åˆ é™¤ | `content_review_records` |
| `role_change_logs` | âœ… å·²åˆ é™¤ | `user_role_change_records` |
| `item_template_aliases` | âœ… å·²åˆ é™¤ | `item_templates` |
| `points_logs` | âœ… å·²åˆ é™¤ | `asset_transactions` |

#### å­—æ®µæ¸…ç†éªŒè¯ï¼ˆå…¨éƒ¨é€šè¿‡ï¼‰

| å­—æ®µ | éªŒè¯ç»“æœ | è¯´æ˜ |
|------|---------|------|
| `lottery_campaigns.draw_pricing` | âœ… å·²åˆ é™¤ | è¿ç§»åˆ° `lottery_campaign_pricing_config` è¡¨ |
| `asset_transactions.user_id` | âœ… å·²åˆ é™¤ | å®Œå…¨è¿ç§»åˆ° `account_id` ä½“ç³» |

#### ğŸ‰ å®¡è®¡æ—¥å¿— target_type éªŒè¯ï¼ˆé‡è¦å‘ç°ï¼‰

**éªŒè¯ç»“æœ**ï¼šâœ… **æ•°æ®åº“ä¸­æ‰€æœ‰ `target_type` å·²ç»æ˜¯ snake_case æ ‡å‡†æ ¼å¼**

```
ğŸ“Š admin_operation_logs target_type åˆ†å¸ƒï¼ˆçœŸå®æ•°æ®ï¼‰:
   âœ… æ ‡å‡†æ ¼å¼: lottery_management_setting = 1329æ¡
   âœ… æ ‡å‡†æ ¼å¼: user = 814æ¡
   âœ… æ ‡å‡†æ ¼å¼: account_asset_balance = 498æ¡
   âœ… æ ‡å‡†æ ¼å¼: lottery_clear_setting_record = 492æ¡
   âœ… æ ‡å‡†æ ¼å¼: customer_service_session = 349æ¡
   âœ… æ ‡å‡†æ ¼å¼: user_role_change_record = 175æ¡
   âœ… æ ‡å‡†æ ¼å¼: user_status_change_record = 174æ¡
   âœ… æ ‡å‡†æ ¼å¼: consumption_record = 81æ¡
   âœ… æ ‡å‡†æ ¼å¼: asset_transaction = 34æ¡
   âœ… æ ‡å‡†æ ¼å¼: feature_flag = 28æ¡
   âœ… æ ‡å‡†æ ¼å¼: exchange_record = 2æ¡
   âœ… æ ‡å‡†æ ¼å¼: item_instance = 1æ¡
```

**ç»“è®º**ï¼š
- æ—  PascalCase æ ¼å¼çš„æ—§ `target_type`ï¼ˆå¦‚ `UserPointsAccount`ã€`ItemInstance` ç­‰ï¼‰
- `TARGET_TYPE_LEGACY_MAPPING` æ˜ å°„è¡¨å®é™…ä¸Šå·²æ— ç”¨æ­¦ä¹‹åœ°
- **å¯ä»¥ç›´æ¥åˆ é™¤æ˜ å°„ä»£ç ï¼Œæ— éœ€æ‰§è¡Œæ•°æ®è¿ç§»è„šæœ¬**

---

## ä¸€ã€åŒè½¨æ¶æ„è¾¹ç•Œåˆ’åˆ†

### âœ… ä¸šåŠ¡è®¾è®¡åŒè½¨ï¼ˆå¿…é¡»ä¿ç•™ï¼‰

| åŒè½¨åç§° | ä½ç½® | è®¾è®¡ç†ç”± | ä¿ç•™ä¾æ® |
|---------|------|---------|---------|
| **èƒŒåŒ…åŒè½¨æ¶æ„** | `services/BackpackService.js` | assetsï¼ˆå¯å åŠ èµ„äº§ï¼‰+ itemsï¼ˆä¸å¯å åŠ ç‰©å“ï¼‰æ˜¯ä¸¤ç§æœ¬è´¨ä¸åŒçš„èµ„äº§ç±»å‹ | ä¸šåŠ¡æ¨¡å‹å†³å®šï¼Œåˆå¹¶ä¼šå¯¼è‡´é€»è¾‘æ··ä¹± |
| **å¸‚åœºæŒ‚ç‰ŒåŒè½¨** | `services/MarketListingService.js` + `models/MarketListing.js` | `listing_kind='item_instance'`ï¼ˆä¸å¯å åŠ ç‰©å“ï¼‰vs `listing_kind='fungible_asset'`ï¼ˆå¯å åŠ èµ„äº§ï¼‰ | äº¤æ˜“æ ‡çš„æœ¬è´¨ä¸åŒï¼šç‰©å“å®ä¾‹éœ€é”å®šã€èµ„äº§éœ€å†»ç»“ä½™é¢ |
| **ç›‘æ§æŸ¥è¯¢åŒè½¨** | `services/LotteryStrategyStatsService.js` | 24hå†…æŸ¥æ˜ç»†è¡¨ï¼Œå†å²æŸ¥èšåˆè¡¨ | æ€§èƒ½ä¼˜åŒ–è®¾è®¡ï¼Œéè¿ç§»æ®‹ç•™ |

**è¯´æ˜**ï¼š
- **èƒŒåŒ…åŒè½¨**æ˜¯ä¸šåŠ¡æ¶æ„çš„æ ¸å¿ƒè®¾è®¡ï¼Œ`assets[]` å­˜å‚¨å¯å åŠ çš„ææ–™/ç§¯åˆ†ï¼Œ`items[]` å­˜å‚¨ä¸å¯å åŠ çš„ç‰©å“å®ä¾‹
- **å¸‚åœºæŒ‚ç‰ŒåŒè½¨**æ˜¯äº¤æ˜“ä¸šåŠ¡çš„æ ¸å¿ƒè®¾è®¡ï¼š
  - `item_instance`ï¼šæŒ‚ç‰Œç‰©å“å®ä¾‹ï¼ˆNFTç±»ï¼‰ï¼ŒæŒ‚ç‰Œæ—¶é”å®šç‰©å“çŠ¶æ€ï¼Œæˆäº¤åæ‰€æœ‰æƒè½¬ç§»
  - `fungible_asset`ï¼šæŒ‚ç‰Œå¯å åŠ èµ„äº§ï¼ˆå¦‚ææ–™ç¢ç‰‡ï¼‰ï¼ŒæŒ‚ç‰Œæ—¶å†»ç»“å–å®¶ä½™é¢ï¼Œæˆäº¤ååˆ’è½¬èµ„äº§
- **ç›‘æ§æŸ¥è¯¢åŒè½¨**æ˜¯æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µï¼Œè¿‘æœŸæ•°æ®æŸ¥æ˜ç»†è¡¨ä¿è¯å®æ—¶æ€§ï¼Œå†å²æ•°æ®æŸ¥èšåˆè¡¨ä¿è¯æ€§èƒ½

---

### âŒ è¿ç§»/å…¼å®¹æ®‹ç•™ï¼ˆå¿…é¡»æ¸…ç†ï¼‰

| æ®‹ç•™ç±»å‹ | ä½ç½® | å…·ä½“å†…å®¹ | æ¸…ç†åŠ¨ä½œ |
|---------|------|---------|---------|
| **æ—§æ¨¡å‹åæ˜ å°„** | `constants/AuditTargetTypes.js` | `UserPointsAccount â†’ account_asset_balance`<br>`UserInventory â†’ item_instance`<br>`PointsTransaction â†’ asset_transaction`ï¼ˆå…±47ä¸ªæ˜ å°„ï¼‰ | åˆ é™¤ `TARGET_TYPE_LEGACY_MAPPING` ä¸­æ‰€æœ‰æ—§æ¨¡å‹åæ˜ å°„ |
| **åºŸå¼ƒæ³¨é‡Šæ®‹ç•™** | å¤šä¸ªæœåŠ¡æ–‡ä»¶ | `@deprecated`ã€`å·²è¿ç§»`ã€`æ—§é“¾è·¯`ç­‰æ³¨é‡Š | åˆ é™¤æ‰€æœ‰æè¿°è¿ç§»å†å²çš„æ³¨é‡Šå— |
| **å­—æ®µå…¼å®¹æ³¨é‡Š** | `services/PrizePoolService.js:139` | `å…¼å®¹å­—æ®µï¼šprize_value_points / value_points / budget_cost_points` | ç¡®è®¤æ•°æ®å·²ç»Ÿä¸€ååˆ é™¤æ³¨é‡Š |
| **å‰ç«¯å…¼å®¹å­—æ®µ** | `services/ActivityService.js:95` | `name: campaign.campaign_name // å…¼å®¹å‰ç«¯æœŸæœ›çš„ name å­—æ®µ` | ä¸å‰ç«¯å¯¹é½ååˆ é™¤ |
| **rarity fallback** | `services/MarketListingService.js:1032` | `rarity: listing.offer_item_rarity \|\| listing.offerItem?.meta?.rarity \|\| 'common'` | ç¡®è®¤æ•°æ®å·²ç»Ÿä¸€ååˆ é™¤ fallback |

---

## äºŒã€ä»£ç å±‚é¢æ¸…ç†æ¸…å•

### 2.1 @deprecated æ ‡è®°æ¸…ç†

#### UnifiedLotteryEngine.js
```
æ–‡ä»¶: services/UnifiedLotteryEngine/UnifiedLotteryEngine.js
è¡Œå·: 937-941

é—®é¢˜: getDrawPricing() æ–¹æ³•å·²è¿ç§»åˆ° LotteryPricingService
çŠ¶æ€: æ ‡è®°ä¸º @deprecated 2026-01-21
åŠ¨ä½œ: å½»åº•åˆ é™¤ getDrawPricing æ–¹æ³•ï¼ˆä¸ä¿ç•™æ¡©æ–¹æ³•ï¼‰
```

#### PricingStage.js
```
æ–‡ä»¶: services/UnifiedLotteryEngine/pipeline/stages/PricingStage.js
è¡Œå·: 203-209

é—®é¢˜: "æ—§æ–¹æ³•å·²è¿ç§»è‡³ LotteryPricingService" æ³¨é‡Šå—
åŠ¨ä½œ: åˆ é™¤æ•´ä¸ªæ³¨é‡Šå—
```

#### EligibilityStage.js
```
æ–‡ä»¶: services/UnifiedLotteryEngine/pipeline/stages/EligibilityStage.js
è¡Œå·: 250-257

é—®é¢˜: _getDailyDrawsCount() æ–¹æ³•å·²åºŸå¼ƒï¼Œç§»åˆ° LotteryQuotaService
åŠ¨ä½œ: åˆ é™¤åºŸå¼ƒæ–¹æ³•å£°æ˜å’Œæ³¨é‡Š
```

---

### 2.2 å†å²è¿ç§»æ³¨é‡Šæ¸…ç†

éœ€è¦æ¸…ç†çš„è¿ç§»å†å²æ³¨é‡Šæ¨¡å¼ï¼š
- `æ—§é“¾è·¯`ã€`åŸç­–ç•¥`ã€`å·²è¿ç§»`ã€`ä»XXXè¿ç§»`
- `Phase X è¿ç§»`ã€`2026-01-XX è¿ç§»`
- `@see docs/XXXè¿ç§»æ–¹æ¡ˆ.md`ï¼ˆä½†ä¿ç•™æ¶æ„è®¾è®¡æ–‡æ¡£å¼•ç”¨ï¼‰

**æ¶‰åŠæ–‡ä»¶æ¸…å•**ï¼š

| æ–‡ä»¶ | è¡Œå· | æ³¨é‡Šå†…å®¹ |
|------|------|---------|
| `services/index.js` | 7-17 | V4æ¶æ„ç§»é™¤å‘åå…¼å®¹ä»£ç è¯´æ˜ |
| `services/index.js` | 107-113 | V4.6ç®¡çº¿ç¼–æ’å™¨è¿ç§»è¯´æ˜ |
| `services/UnifiedLotteryEngine/UnifiedLotteryEngine.js` | 6-8 | ç­–ç•¥æ¨¡å¼å·²åºŸå¼ƒè¯´æ˜ |
| `services/UnifiedLotteryEngine/UnifiedLotteryEngine.js` | 142-146 | V4.6ç®¡çº¿ç¼–æ’å™¨è¿ç§»è¯´æ˜ |
| `services/UnifiedLotteryEngine/UnifiedLotteryEngine.js` | 234-235 | æ—§å®ç°Strategyé“¾å¼æ‰§è¡Œè¯´æ˜ |
| `services/UnifiedLotteryEngine/UnifiedLotteryEngine.js` | 369 | å·²åˆ é™¤å­—æ®µstrategy_usedè¯´æ˜ |
| `services/UnifiedLotteryEngine/UnifiedLotteryEngine.js` | 632 | å·²åˆ é™¤enabled_strategieså…¼å®¹å­—æ®µè¯´æ˜ |
| `services/IdempotencyService.js` | 78 | è·¯å¾„åŒè½¨æ¸…ç†å†³ç­–è¯´æ˜ |
| `services/UserRoleService.js` | 616-881 | ä»UserPermissionModuleè¿ç§»æ³¨é‡Šï¼ˆ6å¤„ï¼‰ |
| `services/lottery/LotteryPricingService.js` | 23-27 | æŠ€æœ¯å€ºåŠ¡è¯´æ˜ |
| `services/ExchangeService.js` | 60 | æš´åŠ›ç§»é™¤æ—§æ–¹æ¡ˆè¯´æ˜ |
| `services/ExchangeService.js` | 1110, 1255 | å·²åˆ é™¤å…¼å®¹é€»è¾‘è¯´æ˜ |
| `services/PopupBannerService.js` | 604 | å·²åˆ é™¤URLå…¼å®¹é€»è¾‘è¯´æ˜ |

---

### 2.3 å…¼å®¹ä»£ç æ¸…ç†

| æ–‡ä»¶ | è¡Œå· | å†…å®¹ | å†³ç­–éœ€æ±‚ |
|------|-----|------|---------|
| `services/IdempotencyService.js` | 428 | å°¾æ–œæ å…¼å®¹åŒ¹é…é€»è¾‘ | ç¡®è®¤æ‰€æœ‰å®¢æˆ·ç«¯å·²ç»Ÿä¸€ååˆ é™¤ |
| `services/MarketListingService.js` | 1032 | rarityå­—æ®µfallbackåˆ°meta | ç¡®è®¤æ•°æ®å·²ç»Ÿä¸€ååˆ é™¤ |
| `services/LotteryMetricsCollector.js` | 90 | emptyå½’å…¥fallback_tier_count | ç¡®è®¤æ˜¯å¦ä¸ºä¸šåŠ¡è®¾è®¡è€Œéå…¼å®¹ |
| `services/ActivityService.js` | 95 | nameå­—æ®µå…¼å®¹å‰ç«¯ | ç¡®è®¤å‰ç«¯æ˜¯å¦å·²ç»Ÿä¸€ä½¿ç”¨campaign_name |

---

## ä¸‰ã€æ•°æ®åº“å±‚é¢æ¸…ç†æ¸…å•

### 3.1 å·²ç¡®è®¤åˆ é™¤çš„è¡¨ï¼ˆè¿ç§»å·²æ‰§è¡Œï¼‰

è¿™äº›è¡¨å·²é€šè¿‡è¿ç§»åˆ é™¤ï¼Œéœ€ç¡®è®¤ä»£ç ä¸­æ— å¼•ç”¨æ®‹ç•™ï¼š

| è¡¨å | åˆ é™¤è¿ç§» | æ›¿ä»£æ–¹æ¡ˆ |
|------|---------|---------|
| `user_points_accounts` | 20251230200000 | `account_asset_balances` |
| `points_transactions` | 20251230200000 | `asset_transactions` |
| `trade_records` | 20260108210000 | `trade_orders` |
| `audit_records` | 20260109124000 | `admin_operation_logs` |
| `merchant_points_reviews` | 20260109120000 | `content_review_records` |
| `role_change_logs` | 20260109120000 | `user_role_change_records` |
| `item_template_aliases` | 20260114001257 | `item_templates` |

**éªŒè¯å‘½ä»¤**ï¼š
```bash
# æœç´¢æ˜¯å¦æœ‰ä»£ç å¼•ç”¨å·²åˆ é™¤çš„è¡¨
grep -r "user_points_accounts\|points_transactions\|trade_records\|audit_records\|merchant_points_reviews\|role_change_logs\|item_template_aliases" --include="*.js" services/ routes/ models/
```

---

### 3.2 å®¡è®¡æ—¥å¿— target_type è§„èŒƒåŒ–

**ç°çŠ¶**ï¼š
- `constants/AuditTargetTypes.js` ä¸­ä¿ç•™äº† `TARGET_TYPE_LEGACY_MAPPING` æ˜ å°„è¡¨ï¼ˆå…±47ä¸ªæ˜ å°„æ¡ç›®ï¼‰
- æ˜ å°„æ—§æ¨¡å‹åï¼ˆPascalCaseï¼‰åˆ°æ–°æ ‡å‡†ç ï¼ˆsnake_caseï¼‰
- å†å²å®¡è®¡è®°å½•å¯èƒ½åŒ…å«æ—§æ ¼å¼çš„ target_type

**æ¸…ç†æ–¹æ¡ˆ**ï¼š

**æ­¥éª¤1ï¼šæ‰§è¡Œæ•°æ®è¿ç§»**
```sql
-- è§„èŒƒåŒ–å†å²å®¡è®¡è®°å½•çš„ target_type
UPDATE admin_operation_logs 
SET target_type = 'account_asset_balance' 
WHERE target_type IN ('UserPointsAccount', 'AccountAssetBalance');

UPDATE admin_operation_logs 
SET target_type = 'asset_transaction' 
WHERE target_type IN ('PointsTransaction', 'AssetTransaction');

UPDATE admin_operation_logs 
SET target_type = 'item_instance' 
WHERE target_type IN ('UserInventory', 'ItemInstance');

-- å…¶ä»–æ˜ å°„å…³ç³»åŒç†...
```

**æ­¥éª¤2ï¼šåˆ é™¤ä»£ç ä¸­çš„æ˜ å°„**
```javascript
// åˆ é™¤ constants/AuditTargetTypes.js ä¸­çš„ TARGET_TYPE_LEGACY_MAPPING
// åˆ é™¤ normalizeTargetType() å‡½æ•°ä¸­çš„æ˜ å°„é€»è¾‘
```

---

### 3.3 éœ€è¦ç¡®è®¤çš„æ•°æ®å­—æ®µ

| è¡¨å | å­—æ®µ | é—®é¢˜ | å»ºè®® |
|------|------|------|------|
| `lottery_prizes` | `prize_value_points` / `budget_cost_points` | å­˜åœ¨ä¸¤ä¸ªè¯­ä¹‰ç›¸è¿‘çš„å­—æ®µ | ç¡®è®¤åç»Ÿä¸€ä¸ºä¸€ä¸ª |
| `lottery_campaigns` | `draw_pricing` (JSON) | å·²è¿ç§»åˆ° `lottery_campaign_pricing_config` è¡¨ | éªŒè¯æ•°æ®å®Œæ•´ååˆ é™¤ |

---

### 3.4 ç©ºè¡¨æ¸…ç†å»ºè®®

ä»¥ä¸‹è¡¨è®°å½•æ•°ä¸º0ï¼Œéœ€ç¡®è®¤æ˜¯å¦ä¿ç•™ï¼š

| è¡¨å | çŠ¶æ€ | å»ºè®® |
|------|------|------|
| `authentication_sessions` | 0æ¡ | å¦‚ä¸ä½¿ç”¨å¯åˆ é™¤æ¨¡å‹å’Œè¡¨ |
| `image_resources` | 0æ¡ | å¦‚ä¸ä½¿ç”¨å¯åˆ é™¤æ¨¡å‹å’Œè¡¨ |
| `lottery_daily_metrics` | 0æ¡ | ä¿ç•™ï¼ˆç›‘æ§ç»Ÿè®¡åŠŸèƒ½å¾…å¯ç”¨ï¼‰ |
| `lottery_hourly_metrics` | 0æ¡ | ä¿ç•™ï¼ˆç›‘æ§ç»Ÿè®¡åŠŸèƒ½å¾…å¯ç”¨ï¼‰ |
| `lottery_draw_decisions` | 0æ¡ | ä¿ç•™ï¼ˆå†³ç­–è®°å½•åŠŸèƒ½å¾…å¯ç”¨ï¼‰ |
| `preset_budget_debt` | 0æ¡ | ä¿ç•™ï¼ˆé¢„è®¾å€ºåŠ¡åŠŸèƒ½ï¼‰ |
| `preset_inventory_debt` | 0æ¡ | ä¿ç•™ï¼ˆé¢„è®¾å€ºåŠ¡åŠŸèƒ½ï¼‰ |
| `trade_orders` | 0æ¡ | ä¿ç•™ï¼ˆäº¤æ˜“åŠŸèƒ½å¾…ä¸Šçº¿ï¼‰ |

---

## å››ã€æ–‡ä»¶å±‚é¢æ¸…ç†æ¸…å•

### 4.1 æ ¹ç›®å½•å¤‡ä»½æ–‡ä»¶åˆ é™¤

**2026-01-21 å®æµ‹ç¡®è®¤å­˜åœ¨çš„å¤‡ä»½æ–‡ä»¶**ï¼š

```bash
# æ ¹ç›®å½•å¤‡ä»½æ–‡ä»¶ï¼ˆå»ºè®®åˆ é™¤ï¼‰
/home/devbox/project/app.js.backup                    # 27KB, 2025-12-25
/home/devbox/project/app.js.backup.20260108_125922    # 35KB, 2026-01-08
/home/devbox/project/ecosystem.config.js.backup       # 1.8KB, 2025-12-25
```

> æ³¨ï¼š`.env.backup.20251225` æœªåœ¨æ ¹ç›®å½•æ‰¾åˆ°ï¼ˆå¯èƒ½å·²è¢«æ¸…ç†æˆ–åœ¨å…¶ä»–ä½ç½®ï¼‰

### 4.2 backups ç›®å½•å†å²å¤‡ä»½æ¸…ç†

```bash
/home/devbox/project/backups/
â”œâ”€â”€ backup_2025-10-14/           # âœ… å·²ç¡®è®¤åˆ é™¤
â”œâ”€â”€ backup_2025-10-14_latest/    # âœ… å·²ç¡®è®¤åˆ é™¤
â”œâ”€â”€ backup_2025-10-25/           # âœ… å·²ç¡®è®¤åˆ é™¤
â”œâ”€â”€ backup_2025-10-29/           # âœ… å·²ç¡®è®¤åˆ é™¤
â”œâ”€â”€ backup_2025-11-04/           # âœ… å·²ç¡®è®¤åˆ é™¤
â”œâ”€â”€ backup_2025-11-08/           # âœ… å·²ç¡®è®¤åˆ é™¤
â”œâ”€â”€ backup_2025-11-11/           # âœ… å·²ç¡®è®¤åˆ é™¤
â”œâ”€â”€ backup_2025-12-19/           # âœ… å·²ç¡®è®¤åˆ é™¤
â”œâ”€â”€ backup_2025-12-23/           # âœ… å·²ç¡®è®¤åˆ é™¤
â”œâ”€â”€ backup_2025-12-24/           # âœ… å·²ç¡®è®¤åˆ é™¤
â”œâ”€â”€ backup_2025-12-27/           # âœ… å·²ç¡®è®¤åˆ é™¤
â”œâ”€â”€ backup_2025-12-31/           # âœ… å·²ç¡®è®¤åˆ é™¤
â”œâ”€â”€ backup_2025-12-31_complete/  # âœ… å·²ç¡®è®¤åˆ é™¤
â”œâ”€â”€ backup_2026-01-02/           # âœ… å·²ç¡®è®¤åˆ é™¤
â”œâ”€â”€ backup_2026-01-02_complete/  # âœ… å·²ç¡®è®¤åˆ é™¤
â”œâ”€â”€ backup_2026-01-04_complete/  # ğŸ”’ ä¿ç•™
â”œâ”€â”€ backup_2026-01-08_complete/  # ğŸ”’ ä¿ç•™
â”œâ”€â”€ backup_2026-01-13_complete/  # ğŸ”’ ä¿ç•™
â”œâ”€â”€ backup_2026-01-18_complete/  # ğŸ”’ ä¿ç•™
â””â”€â”€ backup_2026-01-20_complete/  # ğŸ”’ ä¿ç•™
```

**å·²ç¡®è®¤ç­–ç•¥**ï¼šåˆ é™¤æ‰€æœ‰2025å¹´å¤‡ä»½å’Œ2026-01-02å¤‡ä»½ï¼ˆå…±15ä¸ªï¼‰ï¼Œä¿ç•™2026-01-04åŠä¹‹åçš„å®Œæ•´å¤‡ä»½ï¼ˆå…±5ä¸ªï¼‰

---

### 4.3 æ ¹ç›®å½•æµ‹è¯•è„šæœ¬æ•´ç†

æ ¹ç›®å½•ä¸‹å­˜åœ¨ **15ä¸ªä¸´æ—¶æµ‹è¯•è„šæœ¬**ï¼Œç»æ•°æ®åº“å®é™…éªŒè¯å’Œä»£ç å¯¹æ¯”åˆ†æï¼š

#### ğŸ—‘ï¸ **å»ºè®®åˆ é™¤ï¼ˆ9ä¸ªï¼‰** - åŠŸèƒ½é‡å¤æˆ–å·²è¿‡æ—¶

| è„šæœ¬ | åˆ é™¤åŸå›  | scriptsç›®å½•å·²æœ‰æ›¿ä»£ |
|------|----------|---------------------|
| `test-exchange-orders-api.js` | ä¸scriptsä¸‹3ä¸ªå…‘æ¢æµ‹è¯•è„šæœ¬åŠŸèƒ½é‡å¤ | `scripts/test_exchange_market_api.js` |
| `test-db-orders.js` | æ•°æ®åº“ç›´è¿æµ‹è¯•ï¼ŒåŠŸèƒ½è¢«æ›¿ä»£ | `scripts/test_exchange_service_direct.js` |
| `test-listing-stats-api.js` | å…‘æ¢ç»Ÿè®¡æµ‹è¯•ï¼ŒåŠŸèƒ½é‡å¤ | `scripts/test_exchange_market_admin_api.js` |
| `test-marketplace-data.js` | å¸‚åœºæ•°æ®æŸ¥è¯¢æµ‹è¯•ï¼ŒåŠŸèƒ½é‡å¤ | `scripts/maintenance/truncate_market_listings.js` |
| `test-marketplace-stats.js` | å¸‚åœºç»Ÿè®¡APIæµ‹è¯•ï¼ŒåŠŸèƒ½é‡å¤ | `scripts/test_exchange_market_admin_api.js` |
| `test-frontend-api-paths.js` | APIè·¯å¾„æ£€æŸ¥ï¼ŒåŠŸèƒ½é‡å¤ | `scripts/check_api_consistency.js` |
| `seed-test-exchange-orders.js` | æµ‹è¯•æ•°æ®è„šæœ¬ï¼Œæ•°æ®åº“å·²æœ‰940æ¡æ­£å¼æ•°æ® | - |
| `test-presets-api.js` | âš ï¸ å¼•ç”¨è¡¨å`lottery_budget_presets`å·²ä¸å­˜åœ¨ï¼ˆå®é™…ä¸º`lottery_presets`ï¼‰ | - |
| `test-create-listing-data.js` | æµ‹è¯•æ•°æ®è„šæœ¬ï¼Œ`market_listings`å·²æœ‰38æ¡æ­£å¼æ•°æ® | - |

#### ğŸ“ **å»ºè®®ç§»åŠ¨åˆ°scriptsï¼ˆ6ä¸ªï¼‰** - æœ‰ç‹¬ç«‹ä»·å€¼

| è„šæœ¬ | ç”¨é€” | ç›®æ ‡ç›®å½• |
|------|------|----------|
| `test-api-full.js` | å®Œæ•´APIè”åŠ¨æµ‹è¯• | `scripts/integration/` |
| `test-config-tools-api.js` | é…ç½®å·¥å…·APIæµ‹è¯• | `scripts/admin_tools/` |
| `test-config-tools-complete.js` | é…ç½®å·¥å…·å®Œæ•´æµ‹è¯• | `scripts/admin_tools/` |
| `test-user-management-api.js` | ç”¨æˆ·ç®¡ç†APIæµ‹è¯• | `scripts/admin_tools/` |
| `test_budget_ratio.js` | é¢„ç®—ç³»æ•°åŠ¨æ€é…ç½®æµ‹è¯•ï¼ˆä¾èµ–ConsumptionServiceï¼ŒåŠŸèƒ½æ´»è·ƒï¼‰ | `scripts/` |
| `test-material-apis.js` | ææ–™ç³»ç»ŸAPIæµ‹è¯•ï¼ˆ`material_asset_types`æœ‰4æ¡æ•°æ®ï¼‰ | `scripts/` |

#### ğŸ“Š æ•°æ®åº“éªŒè¯ç»“æœï¼ˆ2026-01-21ï¼‰

```
âœ… exchange_items: 26æ¡æ•°æ® - å…‘æ¢å•†å“åŠŸèƒ½æ´»è·ƒ
âœ… redemption_orders: 940æ¡æ•°æ® - å…‘æ¢è®¢å•åŠŸèƒ½æ´»è·ƒ
âœ… market_listings: 38æ¡æ•°æ® - å¸‚åœºæŒ‚ç‰ŒåŠŸèƒ½æ´»è·ƒ
âœ… material_asset_types: 4æ¡æ•°æ® - ææ–™ç³»ç»ŸåŠŸèƒ½æ´»è·ƒ
âœ… users: 28æ¡æ•°æ® - ç”¨æˆ·ç®¡ç†åŠŸèƒ½æ´»è·ƒ
âŒ lottery_budget_presets: è¡¨ä¸å­˜åœ¨ï¼ˆå®é™…ä¸ºlottery_presetsï¼‰
```

**âš ï¸ å¾…ç¡®è®¤**ï¼šæ˜¯æŒ‰æ–¹æ¡ˆæ‰§è¡Œï¼ˆåˆ é™¤9ä¸ªã€ç§»åŠ¨6ä¸ªï¼‰ï¼Œè¿˜æ˜¯å…¨éƒ¨åˆ é™¤ï¼Ÿ

---
 
---

## äº”ã€æœåŠ¡åˆå¹¶æ”¶ç¼©å»ºè®®

### 5.1 å¯åˆå¹¶çš„æœåŠ¡ï¼ˆé™ä½ç»´æŠ¤æˆæœ¬ï¼‰

| å½“å‰æœåŠ¡ | å»ºè®®åˆå¹¶åˆ° | ç†ç”± | é¢„ä¼°å·¥ä½œé‡ |
|---------|-----------|------|-----------|
| `LotteryMonitoringService` + `LotteryStrategyStatsService` | åˆå¹¶ä¸º `LotteryAnalyticsService` | éƒ½æ˜¯æŠ½å¥–ç›‘æ§ç»Ÿè®¡ï¼ŒèŒè´£ç›¸è¿‘ | ä¸­ç­‰ |
| `UserPremiumQueryService` | åˆå¹¶åˆ° `PremiumService` | æŸ¥è¯¢æœåŠ¡å¯ä½œä¸ºä¸»æœåŠ¡çš„æ–¹æ³• | è¾ƒå° |
| `TradeOrderQueryService` | åˆå¹¶åˆ° `TradeOrderService` | æŸ¥è¯¢æœåŠ¡å¯ä½œä¸ºä¸»æœåŠ¡çš„æ–¹æ³• | è¾ƒå° |

---

### 5.2 å·²ç»åˆç†åˆ†ç¦»çš„æœåŠ¡ï¼ˆä¿æŒç°çŠ¶ï¼‰

| æœåŠ¡ç»„åˆ | ä¿æŒåˆ†ç¦»ç†ç”± |
|---------|-------------|
| `AssetService` + `AssetConversionService` | å†™æ“ä½œä¸è½¬æ¢æ“ä½œåˆ†ç¦»ï¼ŒèŒè´£æ¸…æ™° |
| `MarketListingService` + `TradeOrderService` | æŒ‚ç‰Œä¸è®¢å•æ˜¯ä¸åŒçš„ä¸šåŠ¡å®ä½“ |
| `BackpackService` | æŸ¥è¯¢èšåˆæœåŠ¡ï¼ŒèŒè´£å•ä¸€ |
| `RedemptionService` + `BackpackService` | æ ¸é”€ä¸æŸ¥è¯¢åˆ†ç¦»ï¼Œåˆç† |

---

## å…­ã€éœ€è¦æ‹æ¿å†³å®šçš„äº‹é¡¹

### ğŸ”´ P0 - ç«‹å³å†³ç­–ï¼ˆå½±å“åç»­æ‰§è¡Œï¼‰

#### å†³ç­–1ï¼šå®¡è®¡æ—¥å¿— `target_type` æ˜ å°„ä»£ç å¤„ç†

**èƒŒæ™¯**ï¼š`constants/AuditTargetTypes.js` ä¸­ä¿ç•™äº† `TARGET_TYPE_LEGACY_MAPPING`ï¼ˆ47ä¸ªæ˜ å°„æ¡ç›®ï¼‰ï¼Œç”¨äºå°†æ—§æ¨¡å‹åï¼ˆå¦‚ `UserPointsAccount`ï¼‰æ˜ å°„åˆ°æ–°æ ‡å‡†ç ï¼ˆå¦‚ `account_asset_balance`ï¼‰ã€‚

**ğŸ‰ 2026-01-21 éªŒè¯ç»“æœ**ï¼ˆæœ€æ–°å®æµ‹ï¼‰ï¼š
```
ğŸ“Š admin_operation_logs æ•°æ®åˆ†å¸ƒï¼ˆå…± 4,029 æ¡ï¼‰:
   âœ… lottery_management_setting: 1,345æ¡
   âœ… user: 822æ¡
   âœ… account_asset_balance: 498æ¡
   âœ… lottery_clear_setting_record: 498æ¡
   âœ… customer_service_session: 349æ¡
   âœ… user_role_change_record: 177æ¡
   âœ… user_status_change_record: 176æ¡
   âœ… consumption_record: 81æ¡
   âœ… feature_flag: 46æ¡
   âœ… asset_transaction: 34æ¡
   âœ… exchange_record: 2æ¡
   âœ… item_instance: 1æ¡
   
   âŒ PascalCase æ ¼å¼: 0æ¡ï¼ˆå·²é€šè¿‡ Node.js è¿æ¥çœŸå®æ•°æ®åº“éªŒè¯ï¼‰
```

**ç»“è®º**ï¼š**æ‰€æœ‰ `target_type` å·²ç»æ˜¯ snake_case æ ‡å‡†æ ¼å¼ï¼Œæ— éœ€æ•°æ®è¿ç§»**

**é€‰é¡¹**ï¼š
- **A. ç›´æ¥åˆ é™¤æ˜ å°„ä»£ç **ï¼ˆâœ… å¼ºçƒˆæ¨èï¼Œé›¶é£é™©ï¼‰
  - åˆ é™¤ `TARGET_TYPE_LEGACY_MAPPING` å¸¸é‡ï¼ˆçº¦50è¡Œä»£ç ï¼‰
  - ç®€åŒ– `normalizeTargetType()` å‡½æ•°é€»è¾‘
  
- **B. ä¿ç•™æ˜ å°„è¡¨**
  - é£é™©ï¼šæ°¸ä¹…ç»´æŠ¤æ— ç”¨ä»£ç 

**æ‚¨çš„å†³å®š**ï¼š____

---

#### å†³ç­–2ï¼šå‰ç«¯å…¼å®¹å­—æ®µ `name` çš„å¤„ç†

**ä½ç½®**ï¼š`services/ActivityService.js:95`
```javascript
name: campaign.campaign_name, // å…¼å®¹å‰ç«¯æœŸæœ›çš„ name å­—æ®µ
```

**é—®é¢˜**ï¼š
- å‰ç«¯æ˜¯å¦å·²ç»ç»Ÿä¸€ä½¿ç”¨ `campaign_name`ï¼Ÿ
- å¦‚æœå·²ç»Ÿä¸€ï¼Œå¯ä»¥åˆ é™¤ `name` å­—æ®µçš„æ˜ å°„

**é€‰é¡¹**ï¼š
- **A. ç¡®è®¤å‰ç«¯å·²ç»Ÿä¸€ï¼Œåˆ é™¤ `name` å­—æ®µ**
- **B. ä¿ç•™ `name` å­—æ®µï¼Œç­‰å¾…å‰ç«¯æ›´æ–°åå†åˆ é™¤**

**æ‚¨çš„å†³å®š**ï¼š____

---

#### å†³ç­–3ï¼š`rarity` å­—æ®µ fallback é€»è¾‘å¤„ç†

**ä½ç½®**ï¼š`services/MarketListingService.js:1032`
```javascript
rarity: listing.offer_item_rarity || listing.offerItem?.meta?.rarity || 'common'
```

**ğŸ‰ 2026-01-21 éªŒè¯å‘ç°**ï¼š
- `market_listings` è¡¨ä¸­ **æ²¡æœ‰** `offer_item_meta` å­—æ®µ
- åªæœ‰ `offer_item_rarity` å¿«ç…§å­—æ®µ
- fallback åˆ° `offerItem?.meta?.rarity` æ˜¯é€šè¿‡å…³è”æŸ¥è¯¢ `item_instances.meta`
- å½“å‰ `market_listings` è¡¨æœ‰ **38æ¡è®°å½•**

**é€‰é¡¹**ï¼š
- **A. ç®€åŒ–é€»è¾‘ï¼Œä»…ä½¿ç”¨ `offer_item_rarity || 'common'`**ï¼ˆâœ… æ¨èï¼‰
  - åˆ é™¤ `listing.offerItem?.meta?.rarity` fallback
  - ç†ç”±ï¼šå¿«ç…§å­—æ®µåº”æ˜¯å”¯ä¸€çœŸç›¸æº
- **B. ä¿ç•™å®Œæ•´ fallback é“¾**
  - ç†ç”±ï¼šé˜²å¾¡æ€§ç¼–ç¨‹

**æ‚¨çš„å†³å®š**ï¼š____

---

#### å†³ç­–4ï¼š`LotteryMetricsCollector` çš„ `empty â†’ fallback` å…¼å®¹

**ä½ç½®**ï¼š`services/LotteryMetricsCollector.js:90`
```javascript
empty: 'fallback_tier_count' // å…¼å®¹å¤„ç†ï¼šempty å½’å…¥ fallback
```

**é—®é¢˜**ï¼š
- è¿™æ˜¯ä¸šåŠ¡è®¾è®¡ï¼ˆç©ºå¥–å½’å…¥å…œåº•ï¼‰è¿˜æ˜¯è¿ç§»å…¼å®¹ï¼Ÿ
- å¦‚æœæ˜¯ä¸šåŠ¡è®¾è®¡ï¼Œåº”ä¿ç•™ä½†ä¿®æ”¹æ³¨é‡Šï¼›å¦‚æœæ˜¯è¿ç§»å…¼å®¹ï¼Œåº”æ¸…ç†

**é€‰é¡¹**ï¼š
- **A. è¿™æ˜¯ä¸šåŠ¡è®¾è®¡ï¼Œä¿ç•™ä½†ä¿®æ”¹æ³¨é‡Š**ï¼ˆæ¨èï¼‰
- **B. è¿™æ˜¯è¿ç§»å…¼å®¹ï¼Œæ‰§è¡Œæ¸…ç†**

**æ‚¨çš„å†³å®š**ï¼š____

---

### ğŸŸ¡ P1 - çŸ­æœŸå†³ç­–ï¼ˆå¯åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å†³å®šï¼‰

#### å†³ç­–5ï¼šæœåŠ¡åˆå¹¶ç­–ç•¥

ç°æœ‰æ–‡æ¡£å»ºè®®çš„åˆå¹¶ï¼š
| å½“å‰æœåŠ¡ | å»ºè®®åˆå¹¶åˆ° | å·¥ä½œé‡ |
|---------|-----------|-------|
| `LotteryMonitoringService` + `LotteryStrategyStatsService` | `LotteryAnalyticsService` | ä¸­ç­‰ |
| `UserPremiumQueryService` | `PremiumService` | è¾ƒå° |
| `TradeOrderQueryService` | `TradeOrderService` | è¾ƒå° |

**é€‰é¡¹**ï¼š
- **A. æ‰§è¡Œåˆå¹¶ï¼Œé™ä½é•¿æœŸç»´æŠ¤æˆæœ¬**
- **B. æš‚ä¸åˆå¹¶ï¼Œä¿æŒç°çŠ¶**

**æ‚¨çš„å†³å®š**ï¼š____

---

#### å†³ç­–6ï¼šå¤‡ä»½ä¿ç•™ç­–ç•¥

å½“å‰ `backups/` ç›®å½•æœ‰ **20ä¸ªå¤‡ä»½ç›®å½•**ã€‚

**âœ… å·²ç¡®è®¤**ï¼š
- **åˆ é™¤**ï¼šæ‰€æœ‰2025å¹´å¤‡ä»½ + 2026-01-02å¤‡ä»½ï¼ˆå…±15ä¸ªç›®å½•ï¼‰
- **ä¿ç•™**ï¼š2026-01-04åŠä¹‹åçš„å®Œæ•´å¤‡ä»½ï¼ˆå…±5ä¸ªç›®å½•ï¼‰

**æ‚¨çš„å†³å®š**ï¼šâœ… å·²ç¡®è®¤ä¿ç•™5ä¸ª2026å¹´å¤‡ä»½

---

#### å†³ç­–7ï¼šæ ¹ç›®å½•æµ‹è¯•è„šæœ¬å¤„ç†

å½“å‰æ ¹ç›®å½•æœ‰ **15ä¸ªä¸´æ—¶æµ‹è¯•è„šæœ¬**ï¼Œç»æ•°æ®åº“å®é™…éªŒè¯ï¼ˆ2026-01-21ï¼‰ï¼š

**åˆ†æç»“æœ**ï¼š
- ğŸ—‘ï¸ **9ä¸ªå»ºè®®åˆ é™¤**ï¼šåŠŸèƒ½é‡å¤æˆ–å¼•ç”¨å·²è¿‡æ—¶çš„è¡¨å
- ğŸ“ **6ä¸ªå»ºè®®ç§»åŠ¨**ï¼šæœ‰ç‹¬ç«‹ä»·å€¼ï¼Œç§»åŠ¨åˆ° `scripts/` ç»Ÿä¸€ç®¡ç†

**é€‰é¡¹**ï¼š
- **A. åˆ é™¤9ä¸ª + ç§»åŠ¨6ä¸ª**ï¼ˆæ¨èï¼Œè¯¦è§Â§4.3èŠ‚åˆ†æï¼‰
- **B. å…¨éƒ¨åˆ é™¤**
- **C. å…¨éƒ¨ç§»åŠ¨**
- **D. ä¿æŒç°çŠ¶**

**æ‚¨çš„å†³å®š**ï¼š____

---

#### å†³ç­–8ï¼šæ ¹ç›®å½•å¤‡ä»½æ–‡ä»¶å¤„ç†

**2026-01-21 å®æµ‹ç¡®è®¤**ï¼Œå½“å‰æ ¹ç›®å½•æœ‰ä»¥ä¸‹å¤‡ä»½æ–‡ä»¶ï¼š
- `app.js.backup` (27KB)
- `app.js.backup.20260108_125922` (35KB)
- `ecosystem.config.js.backup` (1.8KB)

**é€‰é¡¹**ï¼š
- **A. å…¨éƒ¨åˆ é™¤**ï¼ˆæ¨èï¼Œå·²æœ‰ backups/ ç›®å½•çš„å®Œæ•´å¤‡ä»½ï¼‰
- **B. ä¿ç•™éƒ¨åˆ†å¤‡ä»½**

**æ‚¨çš„å†³å®š**ï¼š____

---

#### å†³ç­–9ï¼šç©ºè¡¨å¤„ç†ç­–ç•¥

ä»¥ä¸‹è¡¨è®°å½•æ•°ä¸º0ï¼š
- `authentication_sessions` - è®¤è¯ä¼šè¯è¡¨
- `image_resources` - å›¾ç‰‡èµ„æºè¡¨

**é€‰é¡¹**ï¼š
- **A. åˆ é™¤ä¸ä½¿ç”¨çš„ç©ºè¡¨åŠå¯¹åº”æ¨¡å‹**
- **B. ä¿ç•™æ‰€æœ‰è¡¨ï¼Œç­‰å¾…åç»­åŠŸèƒ½å¯ç”¨**ï¼ˆæ¨èï¼‰

**æ‚¨çš„å†³å®š**ï¼š____

---

#### å†³ç­–10ï¼šproducts è¡¨å¤„ç†

**ç°çŠ¶**ï¼ˆ2026-01-21 æ·±åº¦ä»£ç éªŒè¯ï¼‰ï¼š
- `products` è¡¨æœ‰ **52æ¡æ•°æ®**
- `models/Product.js` æ¨¡å‹å®šä¹‰å®Œæ•´ï¼Œæ”¯æŒï¼š
  - `space` å­—æ®µï¼šå¹¸è¿ç©ºé—´(`lucky`)/è‡»é€‰ç©ºé—´(`premium`)/ä¸¤è€…çš†æœ‰(`both`)
  - `premium_exchange_points`/`premium_stock`ï¼šè‡»é€‰ç©ºé—´ä¸“å±é…ç½®
  - `getSpaceInfo()` å®ä¾‹æ–¹æ³•ï¼šæ ¹æ®ç©ºé—´è¿”å›å·®å¼‚åŒ–å•†å“å±•ç¤º
  - `getProductsBySpace()` ç±»æ–¹æ³•ï¼šæŒ‰ç©ºé—´ç­›é€‰å•†å“åˆ—è¡¨
- **æœåŠ¡å±‚ä»£ç æ‰«æ**ï¼š`grep "Product\." services/` â†’ **æ— åŒ¹é…ç»“æœ**
  - `MarketListingService.js`ï¼šæ—  `Product.` å¼•ç”¨
  - `ExchangeService.js`ï¼šæ—  `Product.` å¼•ç”¨ï¼ˆä½¿ç”¨ `ExchangeItem` æ¨¡å‹ï¼‰
- **è·¯ç”±å±‚ä»£ç æ‰«æ**ï¼šä»… `routes/v4/console/images.js` æœ‰å…³è”å®šä¹‰ï¼ˆå›¾ç‰‡ç®¡ç†ï¼‰
- **å¯¹æ¯”**ï¼š`exchange_items` è¡¨æœ‰26æ¡æ•°æ®ï¼Œè¢« `ExchangeService.js` å®é™…ä½¿ç”¨

**åˆ†æç»“è®º**ï¼š
- `products` æ˜¯æ—©æœŸè®¾è®¡çš„"å¹¸è¿ç©ºé—´/è‡»é€‰ç©ºé—´"åŒç©ºé—´å•†å“ç³»ç»Ÿ
- `exchange_items` æ˜¯åæ¥ä¸“é—¨ä¸ºææ–™å…‘æ¢è®¾è®¡çš„è¡¨ï¼Œå·²åœ¨ç”Ÿäº§è¿è¥
- `Product` æ¨¡å‹åŠŸèƒ½å®Œæ•´ä½†**ä»æœªè¢«æœåŠ¡å±‚è°ƒç”¨**ï¼Œå±äºåºŸå¼ƒè®¾è®¡

**é€‰é¡¹**ï¼š
- **A. åˆ é™¤è¡¨å’Œæ¨¡å‹**ï¼ˆæ¨èï¼Œå¦‚"åŒç©ºé—´å•†å“"åŠŸèƒ½å·²åºŸå¼ƒï¼‰
  - åˆ é™¤ `models/Product.js`
  - åˆ›å»ºè¿ç§»åˆ é™¤ `products` è¡¨
  - ç†ç”±ï¼š52æ¡æ•°æ®æ— ä¸šåŠ¡å¼•ç”¨ï¼Œå‡å°‘ç»´æŠ¤è´Ÿæ‹…
- **B. ä¿ç•™è¡¨å’Œæ•°æ®**ï¼ˆå¦‚è®¡åˆ’å¯ç”¨"åŒç©ºé—´å•†å“"åŠŸèƒ½ï¼‰
  - ä¿ç•™ `models/Product.js` å’Œ `products` è¡¨
  - å¾…ä¸šåŠ¡éœ€æ±‚æ˜ç¡®åå¼€å‘å¯¹åº”æœåŠ¡å’Œè·¯ç”±
  - ç†ç”±ï¼šæ¨¡å‹è®¾è®¡å®Œæ•´ï¼Œä¿ç•™ä¾¿äºåç»­å¯ç”¨

**æ‚¨çš„å†³å®š**ï¼š____

---

#### å†³ç­–11ï¼š@deprecated æ–¹æ³•å¤„ç†

**ç°çŠ¶**ï¼š3ä¸ª `@deprecated` æ ‡è®°çš„æ–¹æ³•ï¼š

| æ–‡ä»¶ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `UnifiedLotteryEngine.js:939` | `getDrawPricing()` | å·²è¿ç§»åˆ° LotteryPricingService |
| `PricingStage.js:205` | æ—§æ–¹æ³•æ³¨é‡Šå— | å·²è¿ç§»åˆ° LotteryPricingService |
| `EligibilityStage.js:257` | `_getDailyDrawsCount()` | å·²ç§»åˆ° LotteryQuotaService |

**é€‰é¡¹**ï¼š
- **A. ç«‹å³åˆ é™¤**ï¼ˆâœ… æ¨èï¼‰
  - ç†ç”±ï¼šè¿ç§»å·²å®Œæˆï¼Œæ— è°ƒç”¨æ–¹
- **B. ä¿ç•™ä¸€ä¸ªç‰ˆæœ¬**
  - ç†ç”±ï¼šè§‚å¯Ÿç¨³å®šæ€§åå†åˆ é™¤

**æ‚¨çš„å†³å®š**ï¼š____

---

#### å†³ç­–12ï¼šè¿ç§»æ–‡ä»¶å½’æ¡£

**ç°çŠ¶**ï¼š
- `migrations/` ç›®å½•æœ‰ **279ä¸ªè¿ç§»æ–‡ä»¶**
- å…¶ä¸­çº¦30+ä¸ªæ˜¯æ¸…ç†æ—§è¡¨/æ—§å­—æ®µçš„è¿ç§»ï¼ˆå¦‚ `drop-deprecated-*`ã€`cleanup-*`ï¼‰
- è¿™äº›è¿ç§»å·²æ‰§è¡Œå®Œæˆï¼Œä¸ä¼šå†æ¬¡è¿è¡Œ

**é€‰é¡¹**ï¼š
- **A. åˆ›å»º `migrations/archived/` ç›®å½•å½’æ¡£**ï¼ˆâœ… æ¨èï¼‰
  - å°†å·²å®Œæˆçš„æ¸…ç†ç±»è¿ç§»ç§»å…¥å½’æ¡£ç›®å½•
  - ä¿æŒ migrations/ ç›®å½•æ•´æ´
  - æ³¨æ„ï¼šéœ€ç¡®ä¿ Sequelize ä¸ä¼šé‡å¤æ‰§è¡Œ
- **B. ä¿æŒç°çŠ¶**
  - ç†ç”±ï¼šè¿ç§»æ–‡ä»¶ä¸å½±å“è¿è¡Œï¼Œæ— éœ€æ•´ç†

**æ‚¨çš„å†³å®š**ï¼š____

---

## ä¸ƒã€æ‰§è¡Œé¡ºåºå»ºè®®

```
Phase 0: å†³ç­–ç¡®è®¤ï¼ˆ0.5å¤©ï¼‰
  â””â”€ æ‚¨ç¡®è®¤ä¸Šè¿°12é¡¹å†³ç­–

Phase 1: æ•°æ®å±‚æ¸…ç†ï¼ˆ0.5å¤©ï¼‰
  â”œâ”€ [å¦‚å†³ç­–1=A] åˆ é™¤ TARGET_TYPE_LEGACY_MAPPING æ˜ å°„ä»£ç ï¼ˆæ•°æ®å·²100%æ ‡å‡†åŒ–ï¼Œæ— éœ€è¿ç§»ï¼‰
  â”œâ”€ éªŒè¯å·²æœ‰è¿ç§»å·²å…¨éƒ¨æ‰§è¡Œï¼ˆ279ä¸ªè¿ç§»æ–‡ä»¶ï¼‰
  â””â”€ è¿è¡Œæ•°æ®å®Œæ•´æ€§éªŒè¯è„šæœ¬

Phase 2: ä»£ç å±‚æ¸…ç†ï¼ˆ1-2å¤©ï¼‰
  â”œâ”€ åˆ é™¤ @deprecated æ³¨é‡Šå—
  â”œâ”€ åˆ é™¤è¿ç§»å†å²æ³¨é‡Š
  â”œâ”€ [å¦‚å†³ç­–1=A] åˆ é™¤ TARGET_TYPE_LEGACY_MAPPING
  â”œâ”€ [å¦‚å†³ç­–2=A] åˆ é™¤ ActivityService.js ä¸­çš„ name å­—æ®µ
  â”œâ”€ [å¦‚å†³ç­–3=A] åˆ é™¤ MarketListingService.js ä¸­çš„ fallback
  â””â”€ [å¦‚å†³ç­–4=A] ä¿®æ”¹ LotteryMetricsCollector.js æ³¨é‡Š

Phase 3: æ–‡ä»¶å±‚æ¸…ç†ï¼ˆ0.5å¤©ï¼‰
  â”œâ”€ [å¦‚å†³ç­–8=A] åˆ é™¤æ ¹ç›®å½•å¤‡ä»½æ–‡ä»¶
  â”œâ”€ [å¦‚å†³ç­–6] æ¸…ç† backups/ å†å²å¤‡ä»½
  â””â”€ [å¦‚å†³ç­–7] æ•´ç†æ ¹ç›®å½•æµ‹è¯•è„šæœ¬

Phase 4: æœåŠ¡åˆå¹¶ï¼ˆå¯é€‰ï¼Œ1å¤©ï¼‰
  â””â”€ [å¦‚å†³ç­–5=A] æ‰§è¡ŒæœåŠ¡åˆå¹¶

Phase 5: å…¨é‡éªŒè¯ï¼ˆ1å¤©ï¼‰
  â”œâ”€ npm test è·‘é€šæ‰€æœ‰æµ‹è¯•
  â”œâ”€ æ ¸å¿ƒä¸šåŠ¡ç«¯åˆ°ç«¯æµ‹è¯•
  â””â”€ API å…¼å®¹æ€§éªŒè¯
```

---

## å…«ã€é£é™©æç¤º

### âœ… å·²é™çº§ä¸ºé›¶é£é™©çš„æ“ä½œ
1. **å®¡è®¡æ—¥å¿—æ˜ å°„ä»£ç åˆ é™¤**ï¼š~~å†å²æ•°æ®çš„ `target_type` ä¿®æ”¹æ˜¯ä¸å¯é€†æ“ä½œ~~
   - **2026-01-21 éªŒè¯ç»“æœ**ï¼šæ•°æ®åº“ä¸­ 0 æ¡æ—§æ ¼å¼æ•°æ®ï¼Œ**å¯ç›´æ¥åˆ é™¤æ˜ å°„ä»£ç ï¼Œæ— éœ€æ•°æ®è¿ç§»**
   
2. **JSONå­—æ®µåˆ é™¤**ï¼š`lottery_campaigns.draw_pricing` åˆ é™¤å‰éœ€éªŒè¯æ•°æ®å®Œæ•´
   - ç¼“è§£ï¼šå¯¹æ¯”æ–°æ—§è¡¨æ•°æ®ä¸€è‡´æ€§ï¼ˆè¿ç§»å·²å®Œæˆï¼‰

### ğŸŸ¡ ä¸­é£é™©æ“ä½œ
3. **å‰ç«¯å…¼å®¹å­—æ®µåˆ é™¤**ï¼ˆå†³ç­–2ï¼‰ï¼šå¯èƒ½å½±å“æœªæ›´æ–°çš„å‰ç«¯ç‰ˆæœ¬
   - ç¼“è§£ï¼šä¸å‰ç«¯å›¢é˜Ÿç¡®è®¤ï¼Œæˆ–è®¾ç½®è¿‡æ¸¡æœŸ

4. **æœåŠ¡åˆå¹¶**ï¼ˆå†³ç­–5ï¼‰ï¼šå¯èƒ½å½±å“ç°æœ‰è°ƒç”¨æ–¹
   - ç¼“è§£ï¼šä¿æŒåŸæ–¹æ³•ç­¾åï¼Œä»…åˆå¹¶æ–‡ä»¶

5. **products è¡¨å¤„ç†**ï¼ˆå†³ç­–10ï¼‰ï¼š52æ¡æ•°æ®æ— æ˜ç¡®ä»£ç å¼•ç”¨
   - ç¼“è§£ï¼šç¡®è®¤æ˜¯å¦æœ‰ä¸šåŠ¡ç”¨é€”åå†å†³å®š

---

## ä¹ã€éªŒæ”¶æ ‡å‡†

### ä»£ç å±‚éªŒæ”¶
- [ ] æ—  `@deprecated` æ ‡è®°çš„ä»£ç å­˜åœ¨
- [ ] æ—  `æ—§é“¾è·¯`ã€`å·²è¿ç§»`ã€`Phase X è¿ç§»` ç­‰æ³¨é‡Š
- [ ] `AuditTargetTypes.js` æ—  `TARGET_TYPE_LEGACY_MAPPING`
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡ `npm test`

### æ•°æ®å±‚éªŒæ”¶
- [ ] `admin_operation_logs.target_type` å…¨éƒ¨ä¸º snake_case æ ¼å¼
- [ ] æ— å¼•ç”¨å·²åˆ é™¤è¡¨çš„ä»£ç 
- [ ] `lottery_campaigns.draw_pricing` å­—æ®µå·²åˆ é™¤ï¼ˆå¦‚å†³ç­–æ‰§è¡Œï¼‰

### æ–‡ä»¶å±‚éªŒæ”¶
- [ ] æ ¹ç›®å½•æ—  `.backup` æ–‡ä»¶
- [ ] `backups/` ç›®å½•ä»…ä¿ç•™æŒ‡å®šå¤‡ä»½
- [ ] æ ¹ç›®å½•æ— ä¸´æ—¶æµ‹è¯•è„šæœ¬

---

## åã€å†³ç­–ç¡®è®¤æ¨¡æ¿

### ğŸ“‹ 12é¡¹å†³ç­–æ±‡æ€»è¡¨

è¯·é€ä¸€ç¡®è®¤ä»¥ä¸‹å†³ç­–ï¼ˆå›å¤ç¼–å·+é€‰é¡¹ï¼Œå¦‚ "å†³ç­–1: A"ï¼‰ï¼š

| å†³ç­–é¡¹ | é€‰é¡¹ | æ¨è | é£é™©ç­‰çº§ | éªŒè¯çŠ¶æ€ | æ‚¨çš„å†³å®š |
|--------|------|------|---------|---------|---------|
| **å†³ç­–1**ï¼šå®¡è®¡æ—¥å¿—æ˜ å°„ä»£ç  | A(åˆ é™¤) / B(ä¿ç•™) | âœ… A | ğŸŸ¢ é›¶é£é™© | âœ… å·²éªŒè¯ï¼ˆ0æ¡æ—§æ ¼å¼ï¼‰ | ____ |
| **å†³ç­–2**ï¼šå‰ç«¯ `name` å­—æ®µ | A(åˆ é™¤) / B(ä¿ç•™) | âš ï¸ éœ€ç¡®è®¤ | ğŸŸ¡ éœ€åè°ƒ | â³ éœ€ç¡®è®¤å‰ç«¯çŠ¶æ€ | ____ |
| **å†³ç­–3**ï¼š`rarity` fallback é€»è¾‘ | A(ç®€åŒ–) / B(ä¿ç•™) | âœ… A | ğŸŸ¢ ä½é£é™© | âœ… å·²éªŒè¯ï¼ˆæ—  offer_item_meta å­—æ®µï¼‰ | ____ |
| **å†³ç­–4**ï¼š`emptyâ†’fallback` æ³¨é‡Š | A(ä¸šåŠ¡è®¾è®¡) / B(è¿ç§»å…¼å®¹) | âœ… A | ğŸŸ¢ é›¶é£é™© | âœ… ä¸šåŠ¡é€»è¾‘åˆç† | ____ |
| **å†³ç­–5**ï¼šæœåŠ¡åˆå¹¶ç­–ç•¥ | A(æ‰§è¡Œåˆå¹¶) / B(æš‚ä¸åˆå¹¶) | å»ºè®® A | ğŸŸ¡ ä¸­ç­‰ | âœ… å¯åˆå¹¶3ä¸ªæœåŠ¡ | ____ |
| **å†³ç­–6**ï¼šå¤‡ä»½ä¿ç•™ç­–ç•¥ | åˆ é™¤15ä¸ª / ä¿ç•™5ä¸ª | âœ… å·²ç¡®è®¤ | ğŸŸ¢ é›¶é£é™© | âœ… åˆ é™¤2025å¹´+ä¿ç•™2026å¹´ | âœ… å·²ç¡®è®¤ |
| **å†³ç­–7**ï¼šæµ‹è¯•è„šæœ¬å¤„ç† | A(åˆ 9ç§»6) / B(å…¨åˆ ) / C(å…¨ç§») / D(ä¿æŒ) | å»ºè®® A | ğŸŸ¢ é›¶é£é™© | âœ… 9ä¸ªé‡å¤/6ä¸ªæœ‰ä»·å€¼ | ____ |
| **å†³ç­–8**ï¼šæ ¹ç›®å½•å¤‡ä»½æ–‡ä»¶ | A(å…¨åˆ ) / B(ä¿ç•™) | âœ… A | ğŸŸ¢ é›¶é£é™© | âœ… ç¡®è®¤3ä¸ªå¤‡ä»½æ–‡ä»¶ | ____ |
| **å†³ç­–9**ï¼šç©ºè¡¨å¤„ç†ç­–ç•¥ | A(åˆ é™¤) / B(ä¿ç•™) | âœ… B | ğŸŸ¢ é›¶é£é™© | âœ… åŠŸèƒ½å¾…å¯ç”¨ | ____ |
| **å†³ç­–10**ï¼šproducts è¡¨å¤„ç† | A(åˆ é™¤) / B(ä¿ç•™) | âš ï¸ éœ€ç¡®è®¤ | ğŸŸ¡ éœ€ç¡®è®¤ | âœ… æ·±åº¦éªŒè¯ï¼šæœåŠ¡å±‚é›¶å¼•ç”¨ | ____ |
| **å†³ç­–11**ï¼š@deprecated æ–¹æ³•å¤„ç† | A(ç«‹å³åˆ é™¤) / B(ä¿ç•™ä¸€ç‰ˆæœ¬) | âœ… A | ğŸŸ¢ ä½é£é™© | âœ… è¿ç§»å·²å®Œæˆ | ____ |
| **å†³ç­–12**ï¼šè¿ç§»æ–‡ä»¶å½’æ¡£ | A(å½’æ¡£) / B(ä¿æŒç°çŠ¶) | âœ… A | ğŸŸ¢ é›¶é£é™© | âœ… 279ä¸ªè¿ç§»æ–‡ä»¶ | ____ |

---

### âš ï¸ éœ€è¦æ‚¨ç‰¹åˆ«ç¡®è®¤çš„3ä¸ªé—®é¢˜

#### é—®é¢˜1ï¼šå‰ç«¯æ˜¯å¦å·²ç»Ÿä¸€ä½¿ç”¨ `campaign_name`ï¼Ÿï¼ˆå¯¹åº”å†³ç­–2ï¼‰

**å½“å‰ä»£ç **ï¼š`services/ActivityService.js:95`
```javascript
name: campaign.campaign_name, // å…¼å®¹å‰ç«¯æœŸæœ›çš„ name å­—æ®µ
```

- **å¦‚æœå‰ç«¯å·²ç»Ÿä¸€** â†’ é€‰ Aï¼Œåˆ é™¤ `name` å­—æ®µæ˜ å°„
- **å¦‚æœå‰ç«¯æœªç»Ÿä¸€** â†’ é€‰ Bï¼Œä¿ç•™å…¼å®¹å­—æ®µ

---

#### é—®é¢˜2ï¼š`empty â†’ fallback` æ˜¯ä¸šåŠ¡è®¾è®¡è¿˜æ˜¯è¿ç§»å…¼å®¹ï¼Ÿï¼ˆå¯¹åº”å†³ç­–4ï¼‰

**å½“å‰ä»£ç **ï¼š`services/LotteryMetricsCollector.js:90`
```javascript
empty: 'fallback_tier_count' // å…¼å®¹å¤„ç†ï¼šempty å½’å…¥ fallback
```

- **å¦‚æœæ˜¯ä¸šåŠ¡è®¾è®¡**ï¼ˆç©ºå¥–å½’å…¥å…œåº•ç»Ÿè®¡æ˜¯åˆç†çš„ï¼‰â†’ é€‰ Aï¼Œä¿ç•™é€»è¾‘ä½†ä¿®æ”¹æ³¨é‡Šæªè¾
- **å¦‚æœæ˜¯è¿ç§»å…¼å®¹** â†’ é€‰ Bï¼Œæ‰§è¡Œæ¸…ç†

---

#### é—®é¢˜3ï¼š`products` è¡¨çš„52æ¡æ•°æ®æ˜¯å¦æœ‰ä¸šåŠ¡ç”¨é€”ï¼Ÿï¼ˆå¯¹åº”å†³ç­–10ï¼‰

**ç°çŠ¶**ï¼ˆ2026-01-21 æ·±åº¦ä»£ç éªŒè¯ï¼‰ï¼š
- `products` è¡¨æœ‰ **52æ¡æ•°æ®**
- `models/Product.js` æ¨¡å‹å®šä¹‰å®Œæ•´ï¼Œæ”¯æŒï¼š
  - `space` å­—æ®µï¼šå¹¸è¿ç©ºé—´/è‡»é€‰ç©ºé—´/ä¸¤è€…çš†æœ‰
  - `premium_exchange_points`/`premium_stock`ï¼šè‡»é€‰ç©ºé—´ä¸“å±é…ç½®
  - `getSpaceInfo()` å®ä¾‹æ–¹æ³•ï¼šæ ¹æ®ç©ºé—´è¿”å›å·®å¼‚åŒ–å±•ç¤º
- **æœåŠ¡å±‚éªŒè¯**ï¼š`grep "Product\." services/` æœç´¢ç»“æœä¸ºç©º
  - `MarketListingService.js`ï¼šæ—  `Product.` å¼•ç”¨
  - `ExchangeService.js`ï¼šæ—  `Product.` å¼•ç”¨ï¼ˆä½¿ç”¨ `ExchangeItem` æ¨¡å‹ï¼‰
  - å…¶ä»–æœåŠ¡ï¼šæ—  `Product.` å¼•ç”¨
- **è·¯ç”±å±‚éªŒè¯**ï¼š`grep "Product\." routes/` ä»…åœ¨ `console/images.js` æœ‰å…³è”å®šä¹‰
- **æ— å¤–é”®å¼•ç”¨**è¯¥è¡¨
- **å¯¹æ¯”**ï¼š`exchange_items` è¡¨æœ‰26æ¡æ•°æ®ï¼Œè¢« `ExchangeService.js` å®é™…ä½¿ç”¨

**åˆ†æç»“è®º**ï¼š
- `products` æ˜¯æ—©æœŸè®¾è®¡çš„"å¹¸è¿ç©ºé—´/è‡»é€‰ç©ºé—´"é€šç”¨å•†å“è¡¨
- `exchange_items` æ˜¯åæ¥ä¸“é—¨ä¸ºææ–™å…‘æ¢è®¾è®¡çš„è¡¨ï¼Œå·²åœ¨ç”Ÿäº§ä½¿ç”¨
- `Product` æ¨¡å‹åŠŸèƒ½å®Œæ•´ä½†**ä»æœªåœ¨æœåŠ¡å±‚è¢«è°ƒç”¨**

**é€‰é¡¹è¯´æ˜**ï¼š
- **å¦‚æœ"å¹¸è¿ç©ºé—´/è‡»é€‰ç©ºé—´"å•†å“åŠŸèƒ½å·²åºŸå¼ƒ** â†’ é€‰ Aï¼Œåˆ é™¤è¡¨å’Œæ¨¡å‹
- **å¦‚æœè®¡åˆ’å¯ç”¨è¯¥åŠŸèƒ½** â†’ é€‰ Bï¼Œä¿ç•™è¡¨å’Œæ•°æ®ï¼Œç­‰å¾…ä¸šåŠ¡å¯¹æ¥

---

### ğŸ“ æ¨èè¯´æ˜

| å†³ç­– | æ¨èç†ç”± |
|------|---------|
| å†³ç­–1 âœ… A | æ•°æ®åº“éªŒè¯å·²ç¡®è®¤ï¼š4,029æ¡å®¡è®¡æ—¥å¿—100%ä¸ºsnake_caseæ ¼å¼ï¼Œæ˜ å°„ä»£ç å·²æ— ç”¨ï¼ˆé›¶é£é™©ï¼‰ |
| å†³ç­–3 âœ… A | `market_listings` è¡¨æ—  `offer_item_meta` å­—æ®µï¼Œfallbacké€»è¾‘å®é™…æ— æ„ä¹‰ |
| å†³ç­–4 âœ… A | ç©ºå¥–å½’å…¥å…œåº•æ˜¯åˆç†çš„ç»Ÿè®¡å½’å¹¶é€»è¾‘ï¼Œåº”ä¿ç•™ä½†ä¿®æ”¹æ³¨é‡Šæªè¾ |
| å†³ç­–5 å»ºè®® A | å¯åˆå¹¶3ä¸ªæŸ¥è¯¢æœåŠ¡åˆ°ä¸»æœåŠ¡ï¼Œå‡å°‘ç»´æŠ¤æˆæœ¬ï¼ˆ`UserPremiumQueryService`ã€`TradeOrderQueryService`ã€æŠ½å¥–ç›‘æ§ï¼‰ |
| å†³ç­–6 âœ… å·²ç¡®è®¤ | åˆ é™¤15ä¸ªæ—§å¤‡ä»½ï¼ˆ2025å¹´+2026-01-02ï¼‰ï¼Œä¿ç•™5ä¸ª2026å¹´å¤‡ä»½ |
| å†³ç­–7 å»ºè®® A | åˆ é™¤9ä¸ªé‡å¤è„šæœ¬ + ç§»åŠ¨6ä¸ªæœ‰ä»·å€¼è„šæœ¬åˆ° `scripts/`ï¼ˆè¯¦è§Â§4.3ï¼‰ |
| å†³ç­–8 âœ… A | æ ¹ç›®å½•3ä¸ªå¤‡ä»½æ–‡ä»¶å¯åˆ é™¤ï¼Œå·²æœ‰ `backups/` å®Œæ•´å¤‡ä»½ |
| å†³ç­–9 âœ… B | ç©ºè¡¨ä¿ç•™ï¼ŒåŠŸèƒ½å¾…åç»­å¯ç”¨ |
| å†³ç­–11 âœ… A | è¿ç§»å·²å®Œæˆï¼Œæ— è°ƒç”¨æ–¹ï¼Œå¯å®‰å…¨åˆ é™¤åºŸå¼ƒæ–¹æ³• |
| å†³ç­–12 âœ… A | å½’æ¡£æ¸…ç†ç±»è¿ç§»æ–‡ä»¶ï¼Œä¿æŒ `migrations/` ç›®å½•æ•´æ´ |

---

### ğŸš€ å¿«é€Ÿç¡®è®¤æ¨¡æ¿

å¦‚æœæ‚¨åŒæ„æ‰€æœ‰æ¨èé€‰é¡¹ï¼Œå¯ç›´æ¥å¤åˆ¶å¹¶å¡«å†™ä»¥ä¸‹æ¨¡æ¿ï¼š

```
å†³ç­–1: Aï¼ˆåˆ é™¤æ˜ å°„ä»£ç ï¼‰
å†³ç­–2: [A/B]ï¼ˆéœ€ç¡®è®¤å‰ç«¯çŠ¶æ€ï¼‰
å†³ç­–3: Aï¼ˆç®€åŒ–rarityé€»è¾‘ï¼‰
å†³ç­–4: Aï¼ˆä¸šåŠ¡è®¾è®¡ï¼Œä¿®æ”¹æ³¨é‡Šï¼‰
å†³ç­–5: [A/B]ï¼ˆæ‚¨çš„é€‰æ‹©ï¼‰
å†³ç­–6: âœ… å·²ç¡®è®¤ï¼ˆåˆ é™¤15ä¸ª/ä¿ç•™5ä¸ªï¼‰
å†³ç­–7: [A/B/C/D]ï¼ˆâš ï¸ æ‚¨çš„é€‰æ‹©ï¼šåˆ 9ç§»6/å…¨åˆ /å…¨ç§»/ä¿æŒï¼‰
å†³ç­–8: Aï¼ˆåˆ é™¤æ ¹ç›®å½•å¤‡ä»½ï¼‰
å†³ç­–9: Bï¼ˆä¿ç•™ç©ºè¡¨ï¼‰
å†³ç­–10: [A/B]ï¼ˆéœ€ç¡®è®¤productsè¡¨ç”¨é€”ï¼‰
å†³ç­–11: Aï¼ˆåˆ é™¤deprecatedæ–¹æ³•ï¼‰
å†³ç­–12: Aï¼ˆå½’æ¡£è¿ç§»æ–‡ä»¶ï¼‰
```

---

## é™„å½•ï¼šæ¸…ç†è„šæœ¬æ¨¡æ¿

### A1. å®¡è®¡æ—¥å¿— target_type è¿ç§»è„šæœ¬

> âš ï¸ **2026-01-21 éªŒè¯ç»“è®º**ï¼šç»çœŸå®æ•°æ®åº“éªŒè¯ï¼Œæ‰€æœ‰ `target_type` å·²ç»æ˜¯ snake_case æ ‡å‡†æ ¼å¼ï¼Œ**æ­¤è„šæœ¬æ— éœ€æ‰§è¡Œ**ã€‚
> 
> å¯ç›´æ¥åˆ é™¤ `constants/AuditTargetTypes.js` ä¸­çš„ `TARGET_TYPE_LEGACY_MAPPING` æ˜ å°„è¡¨ã€‚

```sql
-- âœ… å·²éªŒè¯ï¼šæ­¤è„šæœ¬æ— éœ€æ‰§è¡Œï¼ˆæ•°æ®å·²æ ‡å‡†åŒ–ï¼‰
-- ä¿ç•™è„šæœ¬ä»…ä¾›å‚è€ƒï¼Œå®é™…æ•°æ®å·²å…¨éƒ¨ä¸º snake_case æ ¼å¼

-- éªŒè¯æŸ¥è¯¢ï¼ˆç”¨äºç¡®è®¤æ•°æ®çŠ¶æ€ï¼‰
SELECT target_type, COUNT(*) as count 
FROM admin_operation_logs 
WHERE target_type REGEXP '^[A-Z]'  -- æŸ¥æ‰¾ PascalCase æ ¼å¼
GROUP BY target_type;

-- é¢„æœŸç»“æœï¼š0 æ¡è®°å½•ï¼ˆå·²éªŒè¯é€šè¿‡ï¼‰
```

### A2. å¤‡ä»½æ¸…ç†è„šæœ¬

```bash
#!/bin/bash
# scripts/cleanup/clean-old-backups.sh

# åˆ é™¤æ ¹ç›®å½•å¤‡ä»½æ–‡ä»¶ï¼ˆ2026-01-21 å®æµ‹å­˜åœ¨çš„æ–‡ä»¶ï¼‰
rm -f /home/devbox/project/app.js.backup
rm -f /home/devbox/project/app.js.backup.20260108_125922
rm -f /home/devbox/project/ecosystem.config.js.backup

# ä¿ç•™æŒ‡å®šå¤‡ä»½ï¼Œåˆ é™¤å…¶ä½™
cd /home/devbox/project/backups

# åˆ—å‡ºè¦åˆ é™¤çš„ç›®å½•
KEEP_DIRS="backup_2026-01-04_complete backup_2026-01-20_complete"

for dir in backup_*; do
  if [[ ! " $KEEP_DIRS " =~ " $dir " ]]; then
    echo "åˆ é™¤: $dir"
    rm -rf "$dir"
  else
    echo "ä¿ç•™: $dir"
  fi
done

echo "æ¸…ç†å®Œæˆ"
```

### A3. æµ‹è¯•è„šæœ¬æ•´ç†è„šæœ¬

```bash
#!/bin/bash
# scripts/cleanup/organize-test-scripts.sh

# åˆ›å»ºç›®æ ‡ç›®å½•
mkdir -p /home/devbox/project/scripts/adhoc-tests

# ç§»åŠ¨æ ¹ç›®å½•æµ‹è¯•è„šæœ¬
cd /home/devbox/project
mv test-*.js scripts/adhoc-tests/ 2>/dev/null
mv test_*.js scripts/adhoc-tests/ 2>/dev/null
mv seed-*.js scripts/adhoc-tests/ 2>/dev/null

echo "æµ‹è¯•è„šæœ¬å·²ç§»åŠ¨åˆ° scripts/adhoc-tests/"
ls -la scripts/adhoc-tests/
```

### A4. æ•°æ®å®Œæ•´æ€§éªŒè¯è„šæœ¬

```javascript
// scripts/verify-data-integrity.js
require('dotenv').config();
const { sequelize } = require('../config/database');

async function verifyDataIntegrity() {
  console.log('ğŸ” å¼€å§‹æ•°æ®å®Œæ•´æ€§éªŒè¯...\n');
  
  const checks = [];
  
  // 1. æ£€æŸ¥å®¡è®¡æ—¥å¿— target_type æ ¼å¼
  const [legacyTypes] = await sequelize.query(`
    SELECT target_type, COUNT(*) as count 
    FROM admin_operation_logs 
    WHERE target_type REGEXP '^[A-Z]'
    GROUP BY target_type
  `);
  
  if (legacyTypes.length > 0) {
    checks.push({
      name: 'å®¡è®¡æ—¥å¿— target_type æ ¼å¼',
      status: 'WARNING',
      detail: `å‘ç° ${legacyTypes.length} ç§ PascalCase æ ¼å¼çš„ target_type`
    });
  } else {
    checks.push({
      name: 'å®¡è®¡æ—¥å¿— target_type æ ¼å¼',
      status: 'PASS',
      detail: 'æ‰€æœ‰ target_type å‡ä¸º snake_case æ ¼å¼'
    });
  }
  
  // 2. æ£€æŸ¥ market_listings çš„ rarity å­—æ®µ
  const [[rarityCheck]] = await sequelize.query(`
    SELECT COUNT(*) as count 
    FROM market_listings 
    WHERE offer_item_rarity IS NULL
  `);
  
  checks.push({
    name: 'market_listings.offer_item_rarity å®Œæ•´æ€§',
    status: rarityCheck.count > 0 ? 'WARNING' : 'PASS',
    detail: rarityCheck.count > 0 
      ? `${rarityCheck.count} æ¡è®°å½• offer_item_rarity ä¸ºç©º`
      : 'æ‰€æœ‰è®°å½•å‡æœ‰ offer_item_rarity å€¼'
  });
  
  // è¾“å‡ºç»“æœ
  console.log('éªŒè¯ç»“æœ:');
  checks.forEach(check => {
    const icon = check.status === 'PASS' ? 'âœ…' : 'âš ï¸';
    console.log(`${icon} ${check.name}: ${check.detail}`);
  });
  
  process.exit(checks.every(c => c.status === 'PASS') ? 0 : 1);
}

verifyDataIntegrity();
```

---

## åä¸€ã€é¡¹ç›®å¥åº·çŠ¶æ€æ€»ç»“

### âœ… æ•´ä½“è¯„ä¼°ï¼šé¡¹ç›®æ¶æ„å·²éå¸¸å¥åº·

åŸºäº 2026-01-21 çš„å…¨é¢åˆ†æå’Œæ•°æ®åº“éªŒè¯ï¼Œé¡¹ç›®å½“å‰çŠ¶æ€å¦‚ä¸‹ï¼š

#### æ•°æ®åº“å±‚é¢ï¼ˆä¼˜ç§€ âœ…ï¼‰
- âœ… æ‰€æœ‰æ—§è¡¨å·²åˆ é™¤ï¼ˆ12å¼ æ—§è¡¨å…¨éƒ¨æ¸…ç†ï¼‰
- âœ… æ‰€æœ‰åºŸå¼ƒå­—æ®µå·²åˆ é™¤
- âœ… å®¡è®¡æ—¥å¿— `target_type` 100% æ ‡å‡†åŒ–ï¼ˆsnake_case æ ¼å¼ï¼‰
- âœ… 279ä¸ªè¿ç§»å·²å…¨éƒ¨æ‰§è¡Œ
- âœ… 67å¼ è¡¨ï¼Œæ•°æ®å®Œæ•´å¥åº·

#### æœåŠ¡æ¶æ„å±‚é¢ï¼ˆè‰¯å¥½ âœ…ï¼‰
- âœ… ç»Ÿä¸€çš„èµ„äº§åº•åº§ï¼ˆAssetService + è´¦æœ¬ç³»ç»Ÿï¼‰
- âœ… ç»Ÿä¸€çš„æŠ½å¥–å¼•æ“ï¼ˆV4.6 Pipeline æ¶æ„ï¼‰
- âœ… ç»Ÿä¸€çš„å¹‚ç­‰æ€§æœåŠ¡ï¼ˆIdempotencyServiceï¼‰
- âœ… ç»Ÿä¸€çš„å®šä»·æœåŠ¡ï¼ˆLotteryPricingServiceï¼‰
- âœ… æ¸…æ™°çš„åŒè½¨ä¸šåŠ¡è®¾è®¡ï¼ˆèƒŒåŒ…ã€å¸‚åœºã€ç›‘æ§ï¼‰

#### å¾…æ¸…ç†é¡¹ï¼ˆä»£ç æ³¨é‡Šå±‚é¢ï¼‰
- âš ï¸ `TARGET_TYPE_LEGACY_MAPPING` æ˜ å°„ä»£ç ï¼ˆ47ä¸ªæ¡ç›®ï¼Œå·²æ— å®é™…ç”¨é€”ï¼‰â†’ **å†³ç­–1**
- âš ï¸ `@deprecated` æ³¨é‡Šå—ï¼ˆ3å¤„ï¼‰â†’ **å†³ç­–11**
- âš ï¸ è¿ç§»å†å²æ³¨é‡Šï¼ˆçº¦15å¤„ï¼‰
- âš ï¸ æ ¹ç›®å½•å¤‡ä»½æ–‡ä»¶ï¼ˆ3ä¸ªï¼‰â†’ **å†³ç­–8**
- âš ï¸ æ ¹ç›®å½•æµ‹è¯•è„šæœ¬ï¼ˆ9ä¸ªåˆ é™¤+6ä¸ªç§»åŠ¨ï¼‰â†’ **å†³ç­–7**
- âœ… å†å²å¤‡ä»½ç›®å½•ï¼ˆ15ä¸ªå·²ç¡®è®¤åˆ é™¤ï¼‰â†’ **å†³ç­–6 å·²ç¡®è®¤**

### ğŸ¯ æ”¶ç›Šé¢„æœŸ

| ç»´åº¦ | é¢„æœŸæ•ˆæœ |
|------|---------|
| **ä»£ç å¯è¯»æ€§** | åˆ é™¤çº¦100-200è¡Œæ— ç”¨ä»£ç å’Œæ³¨é‡Š |
| **ç»´æŠ¤æˆæœ¬** | æ¶ˆé™¤å†å²åŒ…è¢±ï¼Œæ–°äººä¸Šæ‰‹æ›´å¿« |
| **ç£ç›˜ç©ºé—´** | æ¸…ç†å¤‡ä»½åé‡Šæ”¾çº¦500MB-1GB |
| **æŠ€æœ¯å€ºåŠ¡** | é™ä½é•¿æœŸç»´æŠ¤å¤æ‚åº¦ |

### ğŸ“‹ æ¨èå†³ç­–ï¼ˆåŸºäºåˆ†æç»“è®ºï¼‰

| å†³ç­–é¡¹ | æ¨èé€‰é¡¹ | ç†ç”± |
|--------|---------|------|
| å†³ç­–1ï¼šå®¡è®¡æ—¥å¿—æ˜ å°„ | Aï¼ˆç›´æ¥åˆ é™¤ï¼‰ | æ•°æ®å·²100%æ ‡å‡†åŒ–ï¼ˆ4,029æ¡ï¼‰ï¼Œé›¶é£é™© |
| å†³ç­–2ï¼šå‰ç«¯nameå­—æ®µ | âš ï¸ éœ€ç¡®è®¤ | éœ€ä¸å‰ç«¯å›¢é˜Ÿç¡®è®¤æ˜¯å¦å·²ç»Ÿä¸€ä½¿ç”¨ `campaign_name` |
| å†³ç­–3ï¼šrarity fallback | Aï¼ˆç®€åŒ–ï¼‰ | `market_listings` æ—  `offer_item_meta` å­—æ®µï¼Œfallback æ— æ„ä¹‰ |
| å†³ç­–4ï¼šemptyâ†’fallback | Aï¼ˆä¸šåŠ¡è®¾è®¡ï¼‰ | è¿™æ˜¯åˆç†çš„ç»Ÿè®¡å½’å¹¶é€»è¾‘ |
| å†³ç­–5ï¼šæœåŠ¡åˆå¹¶ | å»ºè®® A | å¯åˆå¹¶3ä¸ªæŸ¥è¯¢æœåŠ¡ï¼Œé™ä½ç»´æŠ¤æˆæœ¬ |
| å†³ç­–6ï¼šå¤‡ä»½ä¿ç•™ | âœ… å·²ç¡®è®¤ | åˆ é™¤15ä¸ªæ—§å¤‡ä»½ï¼Œä¿ç•™5ä¸ª2026å¹´å¤‡ä»½ï¼ˆ01-04/08/13/18/20ï¼‰ |
| å†³ç­–7ï¼šæµ‹è¯•è„šæœ¬ | å»ºè®® Aï¼ˆåˆ 9ç§»6ï¼‰ | 9ä¸ªé‡å¤/è¿‡æ—¶åˆ é™¤ï¼Œ6ä¸ªæœ‰ä»·å€¼ç§»åŠ¨åˆ°scripts |
| å†³ç­–8ï¼šæ ¹ç›®å½•å¤‡ä»½ | Aï¼ˆå…¨åˆ ï¼‰ | 3ä¸ªå¤‡ä»½æ–‡ä»¶å¯åˆ é™¤ï¼Œå·²æœ‰å®Œæ•´å¤‡ä»½ç›®å½• |
| å†³ç­–9ï¼šç©ºè¡¨å¤„ç† | Bï¼ˆä¿ç•™ï¼‰ | åŠŸèƒ½å¾…å¯ç”¨ |
| å†³ç­–10ï¼šproductsè¡¨ | âš ï¸ éœ€ç¡®è®¤ | 52æ¡æ•°æ® + æœåŠ¡å±‚é›¶å¼•ç”¨ï¼Œéœ€ç¡®è®¤"åŒç©ºé—´å•†å“"åŠŸèƒ½æ˜¯å¦åºŸå¼ƒ |
| å†³ç­–11ï¼š@deprecatedæ–¹æ³• | Aï¼ˆç«‹å³åˆ é™¤ï¼‰ | è¿ç§»å·²å®Œæˆï¼Œæ— è°ƒç”¨æ–¹ |
| å†³ç­–12ï¼šè¿ç§»æ–‡ä»¶å½’æ¡£ | Aï¼ˆå½’æ¡£ï¼‰ | ä¿æŒ `migrations/` ç›®å½•æ•´æ´ |

---

## åäºŒã€ä»£ç å±‚éªŒè¯ç»“æœï¼ˆ2026-01-21 æœ€æ–°ï¼‰

### 12.1 @deprecated æ ‡è®°åˆ†å¸ƒï¼ˆ3å¤„ï¼‰

| æ–‡ä»¶ | è¡Œå· | å†…å®¹ |
|------|------|------|
| `services/UnifiedLotteryEngine/UnifiedLotteryEngine.js` | 939 | `@deprecated 2026-01-21 æŠ€æœ¯å€ºåŠ¡ä¿®å¤` - getDrawPricing æ–¹æ³• |
| `services/UnifiedLotteryEngine/pipeline/stages/PricingStage.js` | 205 | `@deprecated 2026-01-21 æŠ€æœ¯å€ºåŠ¡ä¿®å¤` - æ—§æ–¹æ³•è¿ç§»æ³¨é‡Š |
| `services/UnifiedLotteryEngine/pipeline/stages/EligibilityStage.js` | 257 | `@deprecated æ­¤æ–¹æ³•å·²ç§»é™¤` - _getDailyDrawsCount æ–¹æ³• |

### 12.2 å…¼å®¹/è¿ç§»ç›¸å…³ä»£ç åˆ†å¸ƒï¼ˆ38å¤„ï¼‰

é€šè¿‡ `grep -r "å…¼å®¹|å·²è¿ç§»|æ—§é“¾è·¯|æ—§æ–¹æ¡ˆ"` æ‰«æ `services/` ç›®å½•ï¼Œå‘ç° 38 å¤„ç›¸å…³ä»£ç ï¼š

#### éœ€è¦æ¸…ç†çš„è¿ç§»æ³¨é‡Šï¼ˆçº¦15å¤„ï¼‰

| æ–‡ä»¶ | å…³é”®å†…å®¹ | å»ºè®®åŠ¨ä½œ |
|------|---------|---------|
| `services/index.js:7-17` | `ç§»é™¤å‘åå…¼å®¹ä»£ç `ã€`ä¸å†å…¼å®¹ camelCase key` | åˆ é™¤è¿ç§»è¯´æ˜æ³¨é‡Š |
| `services/UnifiedLotteryEngine/UnifiedLotteryEngine.js:201` | `æ—§é“¾è·¯ï¼šstrategies â†’ executeLottery` | åˆ é™¤æ—§é“¾è·¯è¯´æ˜ |
| `services/UnifiedLotteryEngine/UnifiedLotteryEngine.js:369` | `å·²åˆ é™¤å­—æ®µï¼šstrategy_used` | åˆ é™¤å·²åˆ é™¤å­—æ®µè¯´æ˜ |
| `services/UnifiedLotteryEngine/UnifiedLotteryEngine.js:632` | `å·²åˆ é™¤ enabled_strategies å…¼å®¹å­—æ®µ` | åˆ é™¤å·²åˆ é™¤å­—æ®µè¯´æ˜ |
| `services/IdempotencyService.js:609` | `å¼ºåˆ¶ä¸å…¼å®¹ç­–ç•¥` | å¯ä¿ç•™ï¼ˆæ˜¯è®¾è®¡å†³ç­–ï¼‰ |
| `services/IdempotencyService.js:791` | `å¼ºåˆ¶ä¸å…¼å®¹ï¼Œä¸åšåŒç®—æ¯”å¯¹` | å¯ä¿ç•™ï¼ˆæ˜¯è®¾è®¡å†³ç­–ï¼‰ |
| `services/ExchangeService.js:60` | `æš´åŠ›ç§»é™¤æ—§æ–¹æ¡ˆ` | åˆ é™¤è¿ç§»è¯´æ˜ |
| `services/ExchangeService.js:1110,1255` | `å·²åˆ é™¤ item_name/item_description å…¼å®¹é€»è¾‘` | åˆ é™¤å·²åˆ é™¤è¯´æ˜ |
| `services/PopupBannerService.js:604` | `å·²åˆ é™¤"å®Œæ•´URLå…¼å®¹"é€»è¾‘` | åˆ é™¤å·²åˆ é™¤è¯´æ˜ |

#### éœ€è¦å†³ç­–çš„å…¼å®¹ä»£ç ï¼ˆ4å¤„ï¼‰

| æ–‡ä»¶ | è¡Œå· | å†…å®¹ | å¯¹åº”å†³ç­– |
|------|------|------|---------|
| `services/ActivityService.js` | 95 | `name: campaign.campaign_name, // å…¼å®¹å‰ç«¯æœŸæœ›çš„ name å­—æ®µ` | å†³ç­–2 |
| `services/MarketListingService.js` | 1032 | `rarity: listing.offer_item_rarity \|\| ... \|\| 'common'` | å†³ç­–3 |
| `services/LotteryMetricsCollector.js` | 90 | `empty: 'fallback_tier_count' // å…¼å®¹å¤„ç†` | å†³ç­–4 |
| `services/IdempotencyService.js` | 428 | å°¾æ–œæ å…¼å®¹åŒ¹é…é€»è¾‘ | å»ºè®®ä¿ç•™ï¼ˆå®‰å…¨å¤„ç†ï¼‰ |

#### åˆç†ä¿ç•™çš„å…¼å®¹ä»£ç ï¼ˆçº¦19å¤„ï¼‰

| æ–‡ä»¶ | è¯´æ˜ | ä¿ç•™ç†ç”± |
|------|------|---------|
| `services/DataSanitizer.js:19,26,64` | ç¦æ­¢å­—æ®µå…¼å®¹é€»è¾‘è¯´æ˜ | æ¶æ„è®¾è®¡æ–‡æ¡£ |
| `services/ChatWebSocketService.js:11` | å‘åå…¼å®¹ REST API | æ­£å¸¸è®¾è®¡è¯´æ˜ |
| `services/ChatWebSocketService.js:174` | åˆ é™¤ is_admin å…¼å®¹ | å·²å®Œæˆçš„æ¸…ç†è¯´æ˜ |
| `services/ImageService.js:8,476,480` | S3 å…¼å®¹å­˜å‚¨è¯´æ˜ | æŠ€æœ¯æ¶æ„æ–‡æ¡£ |
| `services/sealosStorage.js:723` | S3 å…¼å®¹å­˜å‚¨å›é€€ | æ­£å¸¸å®¹é”™é€»è¾‘ |
| `services/PrizePoolService.js:141,153` | å…¼å®¹å­—æ®µæ³¨é‡Š | éœ€ç¡®è®¤åæ¸…ç† |
| `services/ConsumptionService.js:279,375` | æ¶æ„å†³ç­–è¯´æ˜ | å·²å®Œæˆçš„æ¸…ç†è¯´æ˜ |
| `services/UnifiedLotteryEngine/utils/PerformanceMonitor.js:462` | å…¼å®¹æµ‹è¯•è°ƒç”¨ | æ­£å¸¸å…¬å…±æ–¹æ³• |
| `services/UnifiedLotteryEngine/pipeline/stages/SettleStage.js:169,182` | ä¸æ—§é“¾è·¯ä¸€è‡´ | å¯æ”¹ä¸º"ä¿æŒä¸€è‡´" |
| `services/UnifiedLotteryEngine/pipeline/stages/PricingStage.js:140` | å…¼å®¹æ—§é“¾è·¯è¾“å‡ºæ ¼å¼ | å¯æ”¹ä¸º"ä¿æŒä¸€è‡´" |

### 12.3 è¡¨ç»“æ„éªŒè¯ï¼ˆ2026-01-21 å®æµ‹ï¼‰

```
ğŸ“Š æ ¸å¿ƒè¡¨ç»“æ„éªŒè¯:

item_instances (ç‰©å“å®ä¾‹è¡¨):
  âœ… item_instance_id: bigint (ä¸»é”®)
  âœ… owner_user_id: int (æ‰€æœ‰è€…)
  âœ… item_type: varchar(50)
  âœ… item_template_id: bigint (å…³è”æ¨¡æ¿)
  âœ… status: enum('available','locked','transferred','used','expired')
  âœ… meta: json
  âœ… locks: json

redemption_orders (æ ¸é”€è®¢å•è¡¨):
  âœ… order_id: char(36) (UUIDä¸»é”®)
  âœ… code_hash: varchar(64) (æ ¸é”€ç å“ˆå¸Œ)
  âœ… item_instance_id: bigint (å…³è”ç‰©å“)
  âœ… redeemer_user_id: int
  âœ… status: enum('pending','fulfilled','cancelled','expired')
  âœ… expires_at: datetime
  âœ… fulfilled_at: datetime

account_asset_balances (è´¦æˆ·èµ„äº§ä½™é¢è¡¨):
  âœ… balance_id: bigint (ä¸»é”®)
  âœ… account_id: bigint (å…³è”è´¦æˆ·)
  âœ… asset_code: varchar(50) (èµ„äº§ä»£ç )
  âœ… available_amount: bigint (å¯ç”¨ä½™é¢)
  âœ… frozen_amount: bigint (å†»ç»“ä½™é¢)
  âœ… campaign_id: varchar(50) (æ´»åŠ¨ç»´åº¦)
  âœ… campaign_key: varchar(50) (æ´»åŠ¨é”®)

item_templates (ç‰©å“æ¨¡æ¿è¡¨):
  âœ… item_template_id: bigint (ä¸»é”®)
  âœ… template_code: varchar(100)
  âœ… item_type: varchar(50)
  âœ… category_code: varchar(50)
  âœ… rarity_code: varchar(50)
  âœ… display_name: varchar(200)
  âœ… reference_price_points: decimal(10,2)
  âœ… is_tradable: tinyint(1)
  âœ… is_enabled: tinyint(1)
  âœ… meta: json

market_listings (å¸‚åœºæŒ‚ç‰Œè¡¨):
  âœ… offer_item_rarity: varchar(50) (å¿«ç…§å­—æ®µ)
  âŒ offer_item_meta: å­—æ®µä¸å­˜åœ¨ï¼ˆæ— éœ€ fallback åˆ° metaï¼‰
```

### 12.4 å…³é”®å‘ç°æ€»ç»“

| å‘ç°é¡¹ | ç»“è®º | å½±å“ |
|--------|------|------|
| å®¡è®¡æ—¥å¿— target_type | 100% snake_case æ ¼å¼ï¼ˆ4,029æ¡éªŒè¯é€šè¿‡ï¼‰ | å†³ç­–1 è‡ªåŠ¨å˜ä¸º Aï¼ˆç›´æ¥åˆ é™¤æ˜ å°„ä»£ç ï¼‰ |
| market_listings.offer_item_meta | å­—æ®µä¸å­˜åœ¨ | å†³ç­–3 çš„ fallback é€»è¾‘å®é™…æ— æ„ä¹‰ |
| products è¡¨ | 52æ¡æ•°æ®ï¼Œ**æœåŠ¡å±‚é›¶å¼•ç”¨**ï¼ˆgrepéªŒè¯ï¼‰ | å†³ç­–10 éœ€ç¡®è®¤"åŒç©ºé—´å•†å“"åŠŸèƒ½æ˜¯å¦åºŸå¼ƒ |
| exchange_items è¡¨ | 26æ¡æ•°æ®ï¼Œè¢« ExchangeService å®é™…ä½¿ç”¨ | å…‘æ¢åŠŸèƒ½æ­£å¸¸ |
| Product.js æ¨¡å‹ | åŠŸèƒ½å®Œæ•´ä½†ä»æœªè¢«æœåŠ¡å±‚è°ƒç”¨ | å±äºåºŸå¼ƒè®¾è®¡æˆ–å¾…å¯ç”¨åŠŸèƒ½ |
| æ—§è¡¨åˆ é™¤çŠ¶æ€ | 7ä¸ªæ—§è¡¨å…¨éƒ¨å·²åˆ é™¤ | æ— ä»£ç å¼•ç”¨é£é™© |
| lottery_campaigns.draw_pricing | å­—æ®µå·²åˆ é™¤ | å®šä»·è¿ç§»å®Œæˆ |
| è¿ç§»æ–‡ä»¶æ•° | 279ä¸ªå…¨éƒ¨å·²æ‰§è¡Œ | æ•°æ®åº“ç»“æ„ç¨³å®š |

### 12.5 æ ¸å¿ƒä¸šåŠ¡æ•°æ®ç»Ÿè®¡ï¼ˆ2026-01-21 éªŒè¯ï¼‰

| è¡¨å | è®°å½•æ•° | è¯´æ˜ |
|------|--------|------|
| `users` | 28 | ç”¨æˆ·ä¸»è¡¨ |
| `item_instances` | 1,992 | ç‰©å“å®ä¾‹ï¼ˆèƒŒåŒ…+äº¤æ˜“ï¼‰ |
| `asset_transactions` | 5,075 | èµ„äº§äº¤æ˜“æµæ°´ |
| `admin_operation_logs` | 4,029 | å®¡è®¡æ—¥å¿— |
| `redemption_orders` | 932 | æ ¸é”€è®¢å• |
| `lottery_management_settings` | 2,338 | æŠ½å¥–ç®¡ç†é…ç½® |
| `market_listings` | 38 | å¸‚åœºæŒ‚ç‰Œ |
| `exchange_items` | 26 | å…‘æ¢å•†å“ |
| `products` | 52 | âš ï¸ å¾…ç¡®è®¤ï¼ˆæœåŠ¡å±‚é›¶å¼•ç”¨ï¼Œ"åŒç©ºé—´å•†å“"åŠŸèƒ½ï¼‰ |

---

**æ–‡æ¡£ç»´æŠ¤è¯´æ˜**ï¼šæœ¬æ–‡æ¡£å°†éšé‡æ„è¿›åº¦æ›´æ–°ï¼Œæ¯å®Œæˆä¸€ä¸ªPhaseååœ¨å¯¹åº”ç« èŠ‚æ ‡è®° âœ… å®ŒæˆçŠ¶æ€ã€‚
