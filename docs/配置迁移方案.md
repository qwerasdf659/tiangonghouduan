# lottery_campaigns 策略参数统一迁移方案

> 需求目标：将 `lottery_campaigns` 表中 6 个策略/机制参数迁移到 `lottery_strategy_config` 表，统一策略配置管理入口
> 基准日期：2026-02-23
> 数据来源：Node.js 直连 restaurant_points_dev 数据库 + 代码逐文件追踪
> 迁移策略：一步到位（插入 config 数据 + 改代码 + 删原列，同一迁移文件完成）

## 〇、lottery_campaigns 表字段分类总览

`lottery_campaigns` 表当前 **49 列**（2026-02-23 实查确认），其中约 12 个是策略/机制参数。经逐字段代码追踪和数据库实查，分类如下：

### 迁移到 `lottery_strategy_config`（6 个字段）

| 字段 | 中文 | 迁移为 | 活动 1 值 | 迁移理由 |
|------|------|--------|----------|---------|
| `segment_resolver_version` | 用户分群版本 | `segment.resolver_version` | v1 | 可调策略参数，与其他策略性质一致 |
| `guarantee_enabled` | 固定间隔保底开关 | `guarantee.enabled` | 0（关闭） | 可调策略参数，运营按活动开关 |
| `guarantee_threshold` | 保底触发间隔 | `guarantee.threshold` | 10 | 可调策略参数，不同活动可能不同间隔 |
| `guarantee_prize_id` | 保底指定奖品 ID | `guarantee.prize_id` | null | 可调策略参数，不同活动保底不同奖品 |
| `tier_fallback_lottery_prize_id` | 档位降级兜底奖品 ID | `tier_fallback.prize_id` | 119（参与有礼） | 可调策略参数，不同活动兜底不同奖品 |
| `preset_debt_enabled` | 预设队列透支开关 | `preset.debt_enabled` | 0 | 可调策略参数，不同活动预设行为不同 |

### 留在 `lottery_campaigns`（6 个字段）

| 字段 | 中文 | 活动 1 值 | 留下理由 |
|------|------|----------|---------|
| `budget_mode` | 预算模式 | user | **模式选择器**，决定用哪个 BudgetProvider，是 pipeline 路径分叉点 |
| `pick_method` | 抽取方式 | tier_first | **模式选择器**，决定走 TierPickStage 还是直接 PrizePickStage |
| `preset_budget_policy` | 预设预算策略 | pool_first | **模式选择器**，3 值枚举（follow_campaign/pool_first/user_first），与 budget_mode 同等性质 |
| `default_quota` | 默认预算配额 | 0.00 | 预算初始化参数，和 PoolQuotaBudgetProvider 强耦合 |
| `quota_init_mode` | 配额初始化模式 | on_demand | 同上，是预算初始化行为模式 |
| `tier_weight_scale` | 档位权重缩放系数 | 1000000 | **系统常量**，所有活动相同值，TierPickStage 硬编码 `WEIGHT_SCALE=1000000`；字段留作审计参考 |

### 分类原则

- **迁移**：运营可能按活动调整的可调参数，受益于 `DynamicConfigLoader` 的缓存/审计/生效时间等能力
- **留下**：决定 pipeline 走哪条路径的模式选择器，或与特定 Provider 初始化强耦合的参数
- 迁移完成后 `lottery_campaigns` 从 49 列减至 **43 列**

## 一、Part A — 用户分群版本迁移

### 1.1 当前问题

抽奖引擎的策略配置分散在两张表：

| 配置项 | 存储位置 | 管理入口 |
|---|---|---|
| 7 个策略开关 + 4 个灰度旋钮 | `lottery_strategy_config` 表 | 策略开关页面 |
| **用户分群版本** | `lottery_campaigns` 表 | **活动编辑页面** |
| 预算模式 | `lottery_campaigns` 表 | 活动编辑页面 |

用户分群版本与其他策略开关的性质一致（按活动独立配置、运营随时可调），但存储位置不同导致管理入口分散。

### 1.2 改造目标

将 `segment_resolver_version` 迁移到 `lottery_strategy_config` 表，以 `config_group='segment', config_key='resolver_version'` 存储。迁移完成后：

- 策略开关页面新增"用户分群"下拉框，运营在一个页面管理全部策略
- 每活动默认策略配置从 24 条变为 25 条
- 新建活动默认分群版本为 `'default'`（不分群，所有人概率一样）
- `lottery_campaigns` 表删除 `segment_resolver_version` 列，不保留旧字段

### 1.3 不涉及的内容

- `budget_mode` 保持在 `lottery_campaigns` 表不动
- 分群规则本身（`config/segment_rules.js`）不变
- 现有 7 个策略开关和 4 个灰度旋钮不受影响
- 微信小程序不涉及

---

## 二、Part A 数据库真实状态（2026-02-23 实查）

### 2.1 lottery_campaigns 表现有值

| 活动 ID | 活动名称 | segment_resolver_version | 状态 |
|---|---|---|---|
| 1 | 餐厅积分抽奖 | v1 | active |
| 25 | 走走走 | v1 | ended |
| 26 | 再找找 | v1 | paused |
| 27 | 12312 | v1 | ended |

4 个活动全部使用 `v1`（按注册时间区分新老用户）。

### 2.2 lottery_strategy_config 表现状

| 活动 ID | 记录数 | config_group 列表 |
|---|---|---|
| 1 | 24 条 | anti_empty, anti_high, budget_tier, grayscale, luck_debt, management, matrix, pity, pressure_tier |
| 25 | 24 条 | 同上 |
| 26 | 26 条 | 同上（pressure_tier.enabled 和 matrix.enabled 各有 2 条，含历史重复记录） |
| 27 | 24 条 | 同上 |

当前无 `config_group='segment'` 的记录。

### 2.3 可用的分群版本

来自 `config/segment_rules.js` 内置规则 + `segment_rule_configs` 表自定义规则：

| 版本 | 描述 | 分群方式 |
|---|---|---|
| default | 默认分层策略 — 所有用户使用相同配置 | 不分群 |
| v1 | 新老用户分层策略（注册7天内为新用户） | 按注册时间 |
| v2 | VIP用户分层策略（基于历史消费积分） | 按消费等级 |
| v3 | 组合分层策略（新用户 + VIP + 普通） | 注册时间 + 消费等级 |
| v4 | 活跃度分层策略（基于最后活跃时间） | 按活跃度 |

### 2.4 现有 API

| API | 状态 | 用途 |
|---|---|---|
| `GET /api/v4/console/segment-rules` | 已存在 | 返回所有可用分群版本列表（供下拉框渲染） |
| `GET /api/v4/console/lottery-campaigns/:id/strategy-config` | 已存在 | 返回活动的全部策略配置（迁移后会包含 segment 分组） |
| `PUT /api/v4/console/lottery-campaigns/:id/strategy-config` | 已存在 | 批量更新策略配置（支持任意 config_group，无需改动） |

不需要新建 API。

---

## 三、Part A 影响范围（代码逐文件追踪）

通过 `rg segment_resolver_version` 确认，涉及以下文件：

### 3.1 后端文件（5 个）

| # | 文件 | 当前代码 | 改动内容 |
|---|---|---|---|
| 1 | `models/LotteryCampaign.js` L782-787 | 字段定义 `segment_resolver_version: { type: DataTypes.STRING(32), defaultValue: 'v1' }` | 删除该字段定义 |
| 2 | `services/UnifiedLotteryEngine/pipeline/stages/TierPickStage.js` L465 | `const resolver_version = campaign.segment_resolver_version \|\| 'default'` | 改为从 `DynamicConfigLoader.getValue('segment', 'resolver_version', 'default', { lottery_campaign_id })` 读取 |
| 3 | `services/UnifiedLotteryEngine/pipeline/stages/DecisionSnapshotStage.js` L120 | `segment_resolver_version: campaign_data.campaign?.segment_resolver_version` | 改为从 DynamicConfigLoader 读取，或从 TierPickStage 上下文结果获取 |
| 4 | `services/admin-lottery/CRUDService.js` L157-185 | STRATEGY_DEFAULTS 数组（24 条默认配置） | 新增第 25 条：`{ group: 'segment', key: 'resolver_version', value: 'default', type: 'string', desc: '用户分群版本' }` |
| 5 | `config/segment_rules.js` L8, L17 | 注释引用 `活动的 segment_resolver_version 字段` | 更新注释为 `lottery_strategy_config 表的 segment.resolver_version` |

### 3.2 前端文件（2 个）

| # | 文件 | 当前代码 | 改动内容 |
|---|---|---|---|
| 6 | `admin/src/modules/lottery/composables/campaigns.js` L244, L304, L379 | 活动表单中读写 `campaignForm.segment_resolver_version` | 删除这 3 处引用（分群版本不再通过活动表单管理） |
| 7 | `admin/lottery-management.html` L5641-5650 | 活动编辑表单中的分群版本下拉框 | 删除该下拉框；在策略开关 Tab 中新增分群版本下拉框（复用已有的 `loadAvailableSegmentVersions()` 调用 `GET /api/v4/console/segment-rules`） |

### 3.3 新建文件（1 个）

| # | 文件 | 内容 |
|---|---|---|
| 8 | `migrations/2026XXXX-migrate-segment-to-strategy-config.js` | 数据迁移（详见第四节） |

---

## 四、Part A 数据迁移方案（一步到位）

### 4.1 迁移文件 up 逻辑

按以下顺序在同一事务内执行：

**步骤 1：读取现有值并插入 strategy_config 表**

```sql
-- 对每个活动，读取 campaigns 表的 segment_resolver_version 值，插入 strategy_config 表
-- 幂等检查：先查是否已存在，不存在才插入
INSERT INTO lottery_strategy_config
  (lottery_campaign_id, config_group, config_key, config_value, value_type, description, is_active, priority, created_at, updated_at)
SELECT
  lottery_campaign_id,
  'segment',
  'resolver_version',
  CONCAT('"', segment_resolver_version, '"'),  -- JSON 字符串格式
  'string',
  '用户分群版本',
  1,
  0,
  NOW(),
  NOW()
FROM lottery_campaigns
WHERE lottery_campaign_id NOT IN (
  SELECT lottery_campaign_id FROM lottery_strategy_config
  WHERE config_group = 'segment' AND config_key = 'resolver_version'
)
```

**步骤 2：删除 campaigns 表的列**

```sql
ALTER TABLE lottery_campaigns DROP COLUMN segment_resolver_version
```

### 4.2 迁移文件 down 逻辑（回滚）

```sql
-- 1. 加回列
ALTER TABLE lottery_campaigns ADD COLUMN segment_resolver_version VARCHAR(32) NOT NULL DEFAULT 'v1'

-- 2. 从 strategy_config 回填
UPDATE lottery_campaigns c
  JOIN lottery_strategy_config sc ON c.lottery_campaign_id = sc.lottery_campaign_id
  SET c.segment_resolver_version = JSON_UNQUOTE(sc.config_value)
  WHERE sc.config_group = 'segment' AND sc.config_key = 'resolver_version' AND sc.is_active = 1

-- 3. 删除 config 记录
DELETE FROM lottery_strategy_config WHERE config_group = 'segment' AND config_key = 'resolver_version'
```

### 4.3 迁移后数据状态

| 活动 ID | 新增 strategy_config 记录 | config_value |
|---|---|---|
| 1 | `segment.resolver_version` | `"v1"` |
| 25 | `segment.resolver_version` | `"v1"` |
| 26 | `segment.resolver_version` | `"v1"` |
| 27 | `segment.resolver_version` | `"v1"` |

每活动从 24 条（活动 26 为 26 条）变为 25 条（活动 26 为 27 条）。

---

## 五、Part A 逐文件改动详述

### 5.1 TierPickStage.js — 核心读取点

改前（L462-465）：

```javascript
async _resolveUserSegment(user_id, campaign) {
  try {
    const resolver_version = campaign.segment_resolver_version || 'default'
```

改后：

```javascript
async _resolveUserSegment(user_id, campaign) {
  try {
    const { DynamicConfigLoader } = require('../../compute/config/StrategyConfig')
    const resolver_version = await DynamicConfigLoader.getValue(
      'segment', 'resolver_version', 'default',
      { lottery_campaign_id: campaign.lottery_campaign_id }
    )
```

走 DynamicConfigLoader 三层优先级（DB 活动级 > env > 代码默认值 `'default'`），与其他策略配置读取方式一致。配置有 5 分钟缓存（按活动 ID 隔离），不会每次抽奖都查数据库。

### 5.2 DecisionSnapshotStage.js — 快照记录

改前（L120）：

```javascript
segment_resolver_version: campaign_data.campaign?.segment_resolver_version
```

改后：

```javascript
segment_resolver_version: tier_pick_data?.resolver_version || 'default'
```

从 TierPickStage 的上下文结果中获取已解析的版本值（TierPickStage 需在上下文中存储 `resolver_version`）。

### 5.3 CRUDService.js — 创建活动默认配置

在 L160-184 的 `STRATEGY_DEFAULTS` 数组末尾新增：

```javascript
{ group: 'segment', key: 'resolver_version', value: 'default', type: 'string', desc: '用户分群版本' }
```

同时从 L115-147 的 `LotteryCampaign.create()` 调用中确认不再传入 `segment_resolver_version`（模型删除该字段后，传入会被 Sequelize 忽略，但代码应保持干净）。

### 5.4 LotteryCampaign.js — 删除字段

删除 L775-787 的 `segment_resolver_version` 字段定义。

### 5.5 前端 campaigns.js — 移除表单字段

删除 3 处引用：

- L244：`segment_resolver_version: 'default'`（表单默认值）
- L304：`segment_resolver_version: fullCampaign.segment_resolver_version || 'default'`（回填逻辑）
- L379：`segment_resolver_version: this.campaignForm.segment_resolver_version || 'default'`（提交逻辑）

`loadAvailableSegmentVersions()` 方法（L184-204）保留，搬到策略开关页面复用。

### 5.6 前端 lottery-management.html — UI 调整

**删除**：活动编辑表单中的分群版本下拉框（L5641-5650）。

**新增**：策略开关 Tab 顶部增加"用户分群"下拉框：

- 调用已有的 `GET /api/v4/console/segment-rules` 获取版本列表
- 当前值从 `GET /:lottery_campaign_id/strategy-config` 返回的 `segment.resolver_version` 读取
- 修改后通过 `PUT /:lottery_campaign_id/strategy-config` 提交 `{ config: { segment: { resolver_version: '选中的值' } } }`

---

## 六、Part A 实施顺序

| 步骤 | 内容 | 涉及文件 |
|---|---|---|
| 1 | 后端代码改动（TierPickStage + DecisionSnapshotStage + CRUDService + Model） | 4 个后端文件 |
| 2 | 数据迁移（插入 config 数据 + 删除 campaigns 列） | 1 个迁移文件 |
| 3 | 前端改动（campaigns.js 移除 + lottery-management.html 策略开关 Tab 加下拉框） | 2 个前端文件 |
| 4 | 测试验证 | — |

步骤 1 和 2 必须一起部署（代码依赖新的读取方式，迁移删除旧列）。步骤 3 可与 1-2 同步开发。

---

## 七、Part A 验收标准

1. 新建一个活动 → `lottery_strategy_config` 自动插入 25 条记录（含 `segment.resolver_version = 'default'`）
2. `lottery_campaigns` 表不再有 `segment_resolver_version` 列
3. 策略开关页面显示"用户分群"下拉框，当前值正确显示（活动 1/25/26/27 显示 `v1`）
4. 在策略开关页面将活动 1 的分群版本改为 `v2` → 活动 1 用 VIP 分群，其他活动不受影响
5. 抽奖功能正常 — TierPickStage 按新路径读取分群版本，分群逻辑无变化
6. DecisionSnapshotStage 的快照记录正确包含 `segment_resolver_version` 字段

---

---

## Part B — 固定间隔保底迁移（3 个字段）

### B.1 业务说明

固定间隔保底是活动级**机制**（非策略），实现"每 N 次抽奖必出大奖"的营销承诺。当前作为 `lottery_campaigns` 表字段，与 Pity 策略（策略 5）是不同层次的保障：

| | Pity 保底（策略 5） | 固定间隔保底（机制） |
|---|---|---|
| 触发条件 | 连续空奖次数 >= 阈值 | 累计抽奖次数 % N == 0 |
| 作用层次 | 概率调权（软硬保底） | 决策源覆盖（强制 high 档） |
| 业务目的 | 体验补偿 | 营销承诺 |

### B.2 数据库真实状态（2026-02-23 实查）

| 活动 ID | guarantee_enabled | guarantee_threshold | guarantee_prize_id |
|---|---|---|---|
| 1 | **0（关闭）** | 10 | null |
| 25 | **0（关闭）** | 10 | null |
| 26 | **0（关闭）** | 10 | null |
| 27 | **0（关闭）** | 10 | null |

4 个活动全部关闭。`guarantee_prize_id` 全部 null（触发时自动选最高档有库存奖品）。

### B.3 代码链路

| 文件 | 位置 | 当前代码 | 改动 |
|---|---|---|---|
| `LoadDecisionSourceStage.js` L280-304 | `_checkGuarantee()` | `campaign.guarantee_enabled === true` + `campaign.guarantee_threshold` | 改为 `DynamicConfigLoader.getValue('guarantee', 'enabled/threshold/prize_id', ...)` |
| `TierPickStage.js` L167-193 | guarantee 模式分支 | `decision_source === 'guarantee'` 时强制 high 档 | 不改（读的是 decision_source，不直接读 campaign 字段） |
| `GuaranteeStage.js` L93-180 | 保底奖品选择 | `campaign.guarantee_prize_id` 或自动选高档 | 改为从 DynamicConfigLoader 读取 prize_id |
| `DecisionSnapshotStage.js` | 快照记录 | 无直接引用 | 不改 |
| `models/LotteryCampaign.js` | 字段定义 | 3 个字段定义 | 删除 |
| `admin-lottery/CRUDService.js` | 创建活动 | `STRATEGY_DEFAULTS` 数组 | 新增 3 条 guarantee 默认配置 |

### B.4 迁移数据

新增 `config_group` 和 `config_key`：

| config_group | config_key | value_type | 活动 1 值 | 默认值（新活动） |
|---|---|---|---|---|
| guarantee | enabled | boolean | false | false |
| guarantee | threshold | number | 10 | 10 |
| guarantee | prize_id | number | null | null |

迁移 SQL：

```sql
INSERT INTO lottery_strategy_config
  (lottery_campaign_id, config_group, config_key, config_value, value_type, description, is_active, priority, created_at, updated_at)
SELECT lottery_campaign_id, 'guarantee', 'enabled', IF(guarantee_enabled, 'true', 'false'), 'boolean', '固定间隔保底开关', 1, 0, NOW(), NOW()
FROM lottery_campaigns
WHERE lottery_campaign_id NOT IN (
  SELECT lottery_campaign_id FROM lottery_strategy_config WHERE config_group='guarantee' AND config_key='enabled'
);

INSERT INTO lottery_strategy_config
  (lottery_campaign_id, config_group, config_key, config_value, value_type, description, is_active, priority, created_at, updated_at)
SELECT lottery_campaign_id, 'guarantee', 'threshold', guarantee_threshold, 'number', '保底触发间隔（每N次）', 1, 0, NOW(), NOW()
FROM lottery_campaigns
WHERE lottery_campaign_id NOT IN (
  SELECT lottery_campaign_id FROM lottery_strategy_config WHERE config_group='guarantee' AND config_key='threshold'
);

INSERT INTO lottery_strategy_config
  (lottery_campaign_id, config_group, config_key, config_value, value_type, description, is_active, priority, created_at, updated_at)
SELECT lottery_campaign_id, 'guarantee', 'prize_id',
  CASE WHEN guarantee_prize_id IS NOT NULL THEN guarantee_prize_id ELSE 'null' END,
  'number', '保底指定奖品ID（null=自动选最高档）', 1, 0, NOW(), NOW()
FROM lottery_campaigns
WHERE lottery_campaign_id NOT IN (
  SELECT lottery_campaign_id FROM lottery_strategy_config WHERE config_group='guarantee' AND config_key='prize_id'
);

ALTER TABLE lottery_campaigns DROP COLUMN guarantee_enabled;
ALTER TABLE lottery_campaigns DROP COLUMN guarantee_threshold;
ALTER TABLE lottery_campaigns DROP COLUMN guarantee_prize_id;
```

---

## Part C — 档位降级兜底迁移（1 个字段）

### C.1 业务说明

档位降级兜底是基础设施级安全网：当所有档位（high → mid → low → fallback）都没有可用奖品时，使用指定奖品确保抽奖永远能返回结果。

与固定间隔保底的区别：
- `guarantee_prize_id`：**主动触发**（到次数了）— 营销承诺
- `tier_fallback_lottery_prize_id`：**被动兜底**（没奖品了）— 系统安全

### C.2 数据库真实状态

| 活动 ID | tier_fallback_lottery_prize_id | 对应奖品 |
|---|---|---|
| 1 | **119** | "参与有礼"（virtual, reward_tier=low, prize_value_points=0, is_fallback=1） |
| 25 | null | 未配置 |
| 26 | null | 未配置 |
| 27 | null | 未配置 |

活动 1 共有 6 个 `is_fallback=1` 的奖品（ID 114-119）。

### C.3 代码链路

| 文件 | 位置 | 当前代码 | 改动 |
|---|---|---|---|
| `LoadCampaignStage.js` L194-226 | `_getFallbackPrize()` | `campaign.tier_fallback_lottery_prize_id` | 改为 `DynamicConfigLoader.getValue('tier_fallback', 'prize_id', null, { lottery_campaign_id })` |
| `models/LotteryCampaign.js` | 字段定义 + 关联 | `tier_fallback_lottery_prize_id` 字段 + `belongsTo LotteryPrize` | 删除字段定义和关联 |
| `admin-lottery/CRUDService.js` | 创建活动 | `STRATEGY_DEFAULTS` | 新增 1 条 tier_fallback 默认配置 |

### C.4 迁移数据

| config_group | config_key | value_type | 活动 1 值 | 默认值（新活动） |
|---|---|---|---|---|
| tier_fallback | prize_id | number | 119 | null |

迁移 SQL：

```sql
INSERT INTO lottery_strategy_config
  (lottery_campaign_id, config_group, config_key, config_value, value_type, description, is_active, priority, created_at, updated_at)
SELECT lottery_campaign_id, 'tier_fallback', 'prize_id',
  CASE WHEN tier_fallback_lottery_prize_id IS NOT NULL THEN tier_fallback_lottery_prize_id ELSE 'null' END,
  'number', '档位降级兜底奖品ID（null=自动选is_fallback=1的奖品）', 1, 0, NOW(), NOW()
FROM lottery_campaigns
WHERE lottery_campaign_id NOT IN (
  SELECT lottery_campaign_id FROM lottery_strategy_config WHERE config_group='tier_fallback' AND config_key='prize_id'
);

ALTER TABLE lottery_campaigns DROP COLUMN tier_fallback_lottery_prize_id;
```

---

## Part D — 预设队列透支开关迁移（1 个字段）

### D.1 业务说明

预设队列功能已在 pipeline 中实现（`LoadDecisionSourceStage` 最高优先级检查预设，`TierPickStage`/`PrizePickStage` 都有 `preset` 模式分支）。`preset_debt_enabled` 控制：预设要发的奖品库存不足时，是允许先发后补（欠账），还是预设作废走正常抽奖。

- `lottery_presets` 表存在（2 条记录），有完整审批流程字段
- `preset_budget_debt` 表存在，用于记录欠账
- 只是"库存不足时的欠账判断"这一环尚未接入 pipeline

### D.2 数据库真实状态

| 活动 ID | preset_debt_enabled |
|---|---|
| 1 | **0（不允许）** |
| 25 | **0（不允许）** |
| 26 | **0（不允许）** |
| 27 | **0（不允许）** |

### D.3 代码链路

| 文件 | 位置 | 当前代码 | 改动 |
|---|---|---|---|
| `services/ActivityService.js` L474, L503 | API 响应 | `preset_debt_enabled: !!campaign.preset_debt_enabled` | 改为从 DynamicConfigLoader 读取 |
| `services/admin-lottery/CampaignService.js` L289-296 | 更新校验 | boolean 类型校验 + 写入 campaigns 表 | 改为写入 strategy_config 表（通过 PUT strategy-config API） |
| `models/LotteryCampaign.js` | 字段定义 | `preset_debt_enabled: DataTypes.BOOLEAN` | 删除 |
| `admin-lottery/CRUDService.js` | 创建活动 | `STRATEGY_DEFAULTS` | 新增 1 条 preset 默认配置 |

### D.4 迁移数据

| config_group | config_key | value_type | 活动 1 值 | 默认值（新活动） |
|---|---|---|---|---|
| preset | debt_enabled | boolean | false | false |

迁移 SQL：

```sql
INSERT INTO lottery_strategy_config
  (lottery_campaign_id, config_group, config_key, config_value, value_type, description, is_active, priority, created_at, updated_at)
SELECT lottery_campaign_id, 'preset', 'debt_enabled', IF(preset_debt_enabled, 'true', 'false'), 'boolean', '预设队列透支开关', 1, 0, NOW(), NOW()
FROM lottery_campaigns
WHERE lottery_campaign_id NOT IN (
  SELECT lottery_campaign_id FROM lottery_strategy_config WHERE config_group='preset' AND config_key='debt_enabled'
);

ALTER TABLE lottery_campaigns DROP COLUMN preset_debt_enabled;
```

---

## Part E — 迁移汇总

### E.1 新增 config_group/config_key 全表

| config_group | config_key | value_type | 默认值 | 描述 | 来源字段 |
|---|---|---|---|---|---|
| segment | resolver_version | string | default | 用户分群版本 | segment_resolver_version |
| guarantee | enabled | boolean | false | 固定间隔保底开关 | guarantee_enabled |
| guarantee | threshold | number | 10 | 保底触发间隔 | guarantee_threshold |
| guarantee | prize_id | number | null | 保底指定奖品ID | guarantee_prize_id |
| tier_fallback | prize_id | number | null | 档位降级兜底奖品ID | tier_fallback_lottery_prize_id |
| preset | debt_enabled | boolean | false | 预设队列透支开关 | preset_debt_enabled |

每活动 6 条新记录。4 个活动共 24 条。迁移后每活动默认配置从 24 条变为 **30 条**。

### E.2 迁移后从 campaigns 表删除的列（6 列）

`segment_resolver_version`, `guarantee_enabled`, `guarantee_threshold`, `guarantee_prize_id`, `tier_fallback_lottery_prize_id`, `preset_debt_enabled`

`lottery_campaigns` 从 49 列减至 **43 列**。

### E.3 迁移后 lottery_campaigns 表剩余字段全览（43 列）

| 类别 | 列数 | 字段 |
|------|------|------|
| **主键/身份** | 5 | `lottery_campaign_id`（活动ID）, `campaign_name`（活动名称）, `campaign_code`（活动代码）, `campaign_type`（活动类型）, `status`（活动状态） |
| **时间规则** | 5 | `start_time`（开始时间）, `end_time`（结束时间）, `daily_reset_time`（每日重置时间）, `created_at`（创建时间）, `updated_at`（更新时间） |
| **抽奖限制** | 3 | `max_draws_per_user_daily`（每人每日抽奖上限）, `max_draws_per_user_total`（每人总抽奖上限）, `daily_budget_limit`（每日预算上限） |
| **奖池/预算** | 9 | `total_prize_pool`（总奖池价值）, `remaining_prize_pool`（剩余奖池价值）, `prize_distribution_config`（奖品分布配置）, `budget_mode`（预算模式）, `pool_budget_total`（活动池总预算）, `pool_budget_remaining`（活动池剩余预算）, `public_pool_remaining`（公共池剩余）, `reserved_pool_remaining`（预留池剩余）, `allowed_campaign_ids`（允许的预算来源活动） |
| **预算子系统** | 6 | `pick_method`（抽取方式）, `preset_budget_policy`（预设预算策略）, `default_quota`（默认配额）, `quota_init_mode`（配额初始化模式）, `max_budget_debt`（预算欠账上限）, `max_inventory_debt_quantity`（库存欠账上限） |
| **运行时计数** | 3 | `total_participants`（总参与人数）, `total_draws`（总抽奖次数）, `total_prizes_awarded`（总发奖数） |
| **参与条件** | 2 | `participation_conditions`（参与条件规则）, `condition_error_messages`（条件不满足提示语） |
| **前端展示** | 7 | `display_mode`（展示玩法）, `grid_cols`（网格列数）, `effect_theme`（特效主题）, `rarity_effects_enabled`（稀有度光效开关）, `win_animation`（中奖动画）, `banner_image_url`（横幅图）, `background_image_url`（背景图） |
| **内容描述** | 2 | `description`（活动描述）, `rules_text`（活动规则） |
| **系统常量** | 1 | `tier_weight_scale`（档位权重缩放系数，所有活动=1000000） |

### E.4 留在 campaigns 表的策略相关字段说明（6 个）

| 字段 | 中文 | 留下理由 |
|---|---|---|
| `budget_mode`（预算模式） | user/pool/none | 模式选择器：决定用 UserBudgetProvider / PoolBudgetProvider / NoBudgetProvider |
| `pick_method`（抽取方式） | tier_first/normalize | 模式选择器：决定走 TierPickStage 档位抽取还是 normalize 直接抽奖 |
| `preset_budget_policy`（预设预算策略） | follow_campaign/pool_first/user_first | 模式选择器：预设发奖时的预算扣减顺序 |
| `default_quota`（默认配额） | 0.00 | 预算初始化参数：PoolQuotaBudgetProvider 按需创建配额时的初始值 |
| `quota_init_mode`（配额初始化模式） | on_demand/pre_allocated | 预算初始化参数：按需创建还是预分配 |
| `tier_weight_scale`（档位权重缩放系数） | 1000000 | 系统常量：所有活动均相同，TierPickStage 硬编码同值，留作审计参考 |

### E.4 实施顺序

| 阶段 | 内容 | 文件数 |
|---|---|---|
| 1 | Part A — 用户分群迁移（代码 + 迁移 + 前端） | 8 个 |
| 2 | Part B — 固定间隔保底迁移（代码 + 迁移） | 5 个 |
| 3 | Part C — 档位降级兜底迁移（代码 + 迁移） | 3 个 |
| 4 | Part D — 预设透支开关迁移（代码 + 迁移） | 4 个 |
| 5 | 前端策略开关页面适配（guarantee/tier_fallback/preset 新分组） | 2 个 |
| 6 | 测试验证 | — |

Part A-D 的数据迁移可合并为同一个迁移文件。代码改动互相独立，可并行开发。建议与 10 策略活动级开关改造的 P6 阶段合并执行。

### E.5 验收标准

1. Part A 验收（详见第七节）
2. 新建活动 → `lottery_strategy_config` 自动插入 **30 条**记录（含 segment/guarantee/tier_fallback/preset 共 6 条新增）
3. `lottery_campaigns` 表不再有被迁移的 6 列
4. 修改活动 1 的 `guarantee.enabled=true` → 仅活动 1 开启固定间隔保底，其他活动不受影响
5. 修改活动 1 的 `tier_fallback.prize_id` → 仅活动 1 兜底奖品变更
6. 抽奖功能全链路正常 — `LoadDecisionSourceStage`、`GuaranteeStage`、`LoadCampaignStage`、`TierPickStage` 按新路径读取配置

---

## 八、改造后的完整策略配置矩阵

| # | 策略/机制 | 配置方式 | 配置位置 | 管理入口 |
|---|---|---|---|---|
| 1 | **用户分群** | **下拉选择版本** | **`lottery_strategy_config` segment.resolver_version** | **策略开关页面（Part A 迁移）** |
| 2 | 预算分层 | 下拉选择模式 | `lottery_campaigns.budget_mode` | 活动编辑页面（保持不动） |
| 3 | Pity 保底 | on/off 开关 + 参数 | `lottery_strategy_config` pity.* | 策略开关页面 |
| 4 | 运气债务 | on/off 开关 + 参数 | `lottery_strategy_config` luck_debt.* | 策略开关页面 |
| 5 | 防连空 | on/off 开关 + 参数 | `lottery_strategy_config` anti_empty.* | 策略开关页面 |
| 6 | 防连高 | on/off 开关 + 参数 | `lottery_strategy_config` anti_high.* | 策略开关页面 |
| 7 | 活动压力 | on/off 开关 + 参数 | `lottery_strategy_config` pressure_tier.* | 策略开关页面 |
| 8 | BxPx 矩阵 | on/off 开关 | `lottery_strategy_config` matrix.* | 策略开关页面 |
| 9 | 管理干预 | on/off 开关 | `lottery_strategy_config` management.* | 策略开关页面 |
| 10 | 灰度发布 | 4 个百分比旋钮 | `lottery_strategy_config` grayscale.* | 策略开关页面 |
| 11 | **固定间隔保底** | **on/off 开关 + 间隔 + 奖品** | **`lottery_strategy_config` guarantee.*** | **策略开关页面（Part B 迁移）** |
| 12 | **档位降级兜底** | **奖品 ID** | **`lottery_strategy_config` tier_fallback.*** | **策略开关页面（Part C 迁移）** |
| 13 | **预设透支开关** | **on/off 开关** | **`lottery_strategy_config` preset.*** | **策略开关页面（Part D 迁移）** |

---

## 九、实时数据库验证报告（2026-02-23 Node.js 直连实查）

> 以下内容通过 Node.js + Sequelize 直连 `restaurant_points_dev` 数据库实时查询生成，非引用历史报告。

### 9.1 两张表功能状态：均正常可用

| 检查项 | lottery_campaigns | lottery_strategy_config |
|--------|-------------------|------------------------|
| 表是否存在 | 存在（49 列） | 存在（15 列） |
| 数据记录数 | 4 条活动 | 98 条配置 |
| SELECT 查询 | 正常 | 正常 |
| INSERT 写入 | 正常 | 正常 |
| 唯一约束 | 主键 `lottery_campaign_id` | 联合唯一 `uk_strategy_campaign_group_key_priority(lottery_campaign_id, config_group, config_key, priority)` |
| 唯一约束验证 | — | 已验证：插入重复记录被拦截 |
| 外键完整性 | `tier_fallback_lottery_prize_id=119` → `lottery_prizes.119`（"参与有礼"，存在且有效） | 无外键约束（通过业务逻辑保证） |
| 引擎读取路径 | `TierPickStage` 直读 `campaign.segment_resolver_version` | `DynamicConfigLoader.getValue()` 按 `config_group+config_key` 读取，5 分钟缓存 |

**结论：两张表的 CRUD 和引擎读取路径均正常工作，迁移方案的前提条件成立。**

### 9.2 文档与实际数据差异修正

| 文档原文 | 实际值 | 影响 |
|----------|--------|------|
| 第〇节"当前 **47 列**" | 实际 **49 列** | 纯数字笔误，E.2 节已正确写 49 列，不影响方案 |
| 活动 1 `preset_budget_policy` = `pool_first` | 数据库确认 = `pool_first` | 一致，无差异 |
| 活动 25/26/27 `preset_budget_policy` | 数据库 = `follow_campaign`（非 `pool_first`） | 文档未提及其他活动的差异值，不影响迁移（此字段留在 campaigns 表不动） |
| 活动 26 有 26 条策略配置（含 2 条历史重复） | 数据库确认：`matrix.enabled` 重复 2 条（priority=10 和 0），`pressure_tier.enabled` 重复 2 条（priority=10 和 0） | 不影响引擎（DynamicConfigLoader 按 priority DESC 取第一条），但建议迁移前清理 |

### 9.3 活动 26 重复记录详情

| config_id | config_group | config_key | priority | created_at | 说明 |
|-----------|-------------|------------|----------|------------|------|
| 23 | matrix | enabled | 10 | 2026-02-23 06:55 | 原始记录（保留） |
| 74 | matrix | enabled | 0 | 2026-02-24 10:15 | 重复记录（建议删除） |
| 22 | pressure_tier | enabled | 10 | 2026-02-23 06:55 | 原始记录（保留） |
| 79 | pressure_tier | enabled | 0 | 2026-02-24 10:15 | 重复记录（建议删除） |

**建议**：迁移前执行清理 SQL：

```sql
DELETE FROM lottery_strategy_config WHERE lottery_strategy_config_id IN (74, 79);
```

### 9.4 迁移目标 config_group 验证

已确认 `lottery_strategy_config` 表中 **不存在** `segment`、`guarantee`、`tier_fallback`、`preset` 四个 config_group 的记录。迁移 SQL 的幂等检查（`WHERE lottery_campaign_id NOT IN (...)`）会正常工作，不会产生冲突。

### 9.5 关联表验证

| 表 | 记录数 | 状态 |
|----|--------|------|
| `segment_rule_configs` | 5 条（default, v1, v2, v3, v4） | 正常，与 `config/segment_rules.js` 内置规则一致 |
| `lottery_presets` | 2 条（均已 used） | 正常，预设队列功能可用 |
| `preset_budget_debt` | 0 条 | 正常，当前无欠账记录（所有活动 `preset_debt_enabled=0`） |
| `lottery_prizes` ID=119 | 1 条（"参与有礼"，`is_fallback=1`） | 正常，活动 1 的 `tier_fallback_lottery_prize_id` 指向有效 |

---

## 十、问题归属分类（后端 / Web 管理前端 / 微信小程序前端）

### 10.1 后端数据库项目的改动（核心，5 个代码文件 + 1 个迁移文件）

| # | 文件 | 改动类型 | 改动内容 |
|---|------|----------|----------|
| 1 | `models/LotteryCampaign.js` | 删除字段定义 | 删除 6 个字段：`segment_resolver_version`（L782-787）、`guarantee_enabled`（L1106-1111）、`guarantee_threshold`（L1120-1125）、`guarantee_prize_id`（L1134-1139）、`tier_fallback_lottery_prize_id`（L754-759）、`preset_debt_enabled`（L796-801） |
| 2 | `services/UnifiedLotteryEngine/pipeline/stages/TierPickStage.js` | 改读取源 | L465 从 `campaign.segment_resolver_version` 改为 `DynamicConfigLoader.getValue('segment', 'resolver_version', 'default', ...)` |
| 3 | `services/UnifiedLotteryEngine/pipeline/stages/LoadDecisionSourceStage.js` | 改读取源 | L283-284 从 `campaign.guarantee_enabled` / `campaign.guarantee_threshold` 改为 DynamicConfigLoader 读取 |
| 4 | `services/admin-lottery/CRUDService.js` | 扩展默认配置 | `STRATEGY_DEFAULTS` 数组（L160-185）从 24 条扩展到 30 条，新增 segment/guarantee/tier_fallback/preset 共 6 条 |
| 5 | `config/segment_rules.js` | 更新注释 | 注释中 `segment_resolver_version 字段` 改为 `lottery_strategy_config 表的 segment.resolver_version` |
| 6 | `migrations/2026XXXX-migrate-strategy-params.js` | 新建迁移文件 | 数据迁移（插入 24 条 config 记录 + 删除 6 列） |

**不需要新建 API**。现有 3 个 API 完全够用：

- `GET /api/v4/console/lottery-campaigns/:id/strategy-config` — 已有，返回全部策略配置，迁移后自动包含新 config_group
- `PUT /api/v4/console/lottery-campaigns/:id/strategy-config` — 已有，支持任意 config_group 的批量更新，无需改动
- `GET /api/v4/console/segment-rules` — 已有，返回分群版本列表

**后端技术栈适配评估**：

| 技术点 | 现有能力 | 迁移方案是否适配 |
|--------|----------|------------------|
| Sequelize ORM（v6.35.2） | 模型定义、迁移工具、事务支持 | 完全适配：删字段用 `queryInterface.removeColumn`，插数据用 raw SQL |
| DynamicConfigLoader | 三层优先级读取（DB 活动级 > env > 代码默认值），5 分钟缓存 | 完全复用：新 config_group 自动走同一套加载/缓存逻辑 |
| CRUDService.STRATEGY_DEFAULTS | 新建活动时自动插入默认配置 | 扩展即可：数组新增 6 条记录 |
| Pipeline 架构 | 各 Stage 独立读取配置 | 只改读取源，不动 pipeline 逻辑 |
| 审计日志（AuditLogService） | 策略配置变更自动记录 | 复用：PUT strategy-config 已接入审计 |
| 唯一约束 `uk_strategy_campaign_group_key_priority` | 防重复写入 | 迁移 SQL 的幂等检查 + 唯一约束双重保障 |

### 10.2 Web 管理后台前端项目的改动（2 个文件）

| # | 文件 | 改动类型 | 改动内容 |
|---|------|----------|----------|
| 1 | `admin/src/modules/lottery/composables/campaigns.js` | 删除表单字段 | 删除 3 处 `segment_resolver_version` 引用（L244 默认值、L304 回填、L379 提交） |
| 2 | `admin/lottery-management.html` | UI 迁移 | 活动编辑表单中删除分群版本下拉框（L5641-5650）；策略开关 Tab 新增分群版本下拉框 + guarantee/tier_fallback/preset 配置区域 |

**Web 前端技术栈适配评估**：

| 技术点 | 现有能力 | 迁移方案是否适配 |
|--------|----------|------------------|
| Alpine.js（v3.15.4） | 响应式数据绑定、组件化 | 完全适配：策略开关页面已有 `x-data` 组件管理策略配置的加载/修改/提交 |
| Vite（v6.4.1）多页应用 | `lottery-management.html` 单页含抽奖管理全部 Tab | 适配：在已有的策略开关 Tab 中扩展 UI |
| 已有 API 调用模式 | `GET/PUT strategy-config` 已在策略开关页面使用 | 完全复用：新增的 config_group 走同一套读写逻辑 |
| `loadAvailableSegmentVersions()` | 已在 campaigns.js L184-204 实现，调用 `GET /api/v4/console/segment-rules` | 复用：搬到策略开关页面 |
| Tailwind CSS（v3.4.19） | 策略开关页面已有 on/off 开关、数字输入框的样式模式 | 复用：guarantee/tier_fallback/preset 的 UI 控件用同样的样式模式 |

### 10.3 微信小程序前端项目

**本次迁移不涉及微信小程序前端。**

原因：被迁移的 6 个字段（`segment_resolver_version`、`guarantee_*`、`tier_fallback_lottery_prize_id`、`preset_debt_enabled`）全部是后端引擎内部配置参数和管理后台运营配置，小程序用户端的抽奖 API（`POST /api/v4/lottery/draw`）入参和出参均不包含这些字段。抽奖引擎内部从哪张表读取配置，对小程序完全透明。

---

## 十一、可复用能力与可扩展点

### 11.1 后端可复用（不需改动直接用）

| 能力 | 复用方式 |
|------|----------|
| `DynamicConfigLoader.getValue(group, key, default, options)` | 新 config_group 直接调用，自动走 DB 查询 + 5 分钟缓存 + env 降级 |
| `PUT /api/v4/console/lottery-campaigns/:id/strategy-config` | 接收任意 config_group 的 JSON，无需改路由/Controller |
| `GET /api/v4/console/lottery-campaigns/:id/strategy-config` | 自动返回所有 config_group（含新增的），无需改路由/Controller |
| `CRUDService.updateStrategyConfig()` | 内部按 group+key 做 upsert，支持新增的 config_group |
| `AuditLogService` 审计日志 | 策略配置变更自动记录操作人、变更前后值 |
| Sequelize Migration 工具 | `npx sequelize-cli db:migrate` 执行迁移，`db:migrate:undo` 回滚 |

### 11.2 后端可扩展

| 扩展点 | 说明 |
|--------|------|
| 新增 config_group | 未来如有新的策略参数需从 campaigns 表迁出，只需：(1) CRUDService.STRATEGY_DEFAULTS 加记录 (2) 引擎 Stage 改读取源 (3) 迁移文件 |
| `DynamicConfigLoader` 缓存策略 | 当前 5 分钟 TTL，可通过 env `STRATEGY_CONFIG_CACHE_TTL` 调整 |
| 唯一约束包含 priority | 当前唯一键包含 `priority`，支持同一 group+key 有多条不同优先级的记录（用于灰度/AB 测试场景） |

### 11.3 Web 管理前端可复用

| 能力 | 复用方式 |
|------|----------|
| 策略开关页面的 Alpine.js 组件 | 已有 `loadStrategyConfig()` / `saveStrategyConfig()` 方法，新 config_group 直接加 UI 控件绑定 |
| on/off 开关 + 数字输入框 UI 模式 | Tailwind 样式已封装，guarantee/preset 直接复用 |
| `loadAvailableSegmentVersions()` 方法 | 已实现，从 campaigns.js 搬到策略页面即可 |

---

## 十二、需要拍板的决策点

### 决策 1：活动 26 重复记录是否在迁移前清理？

- **建议**：迁移前清理（DELETE id=74,79），保持数据干净
- **不清理的风险**：DynamicConfigLoader 按 priority DESC 取第一条，功能不受影响，但迁移后每活动记录数不统一（活动 26 = 32 条，其他 = 30 条）
- **需要你确认**：是否执行清理

### 决策 2：Part A-D 合并为一个迁移文件还是分开？

- **文档建议**：合并为同一个迁移文件（E.4 节）
- **优势**：一次性完成，原子性好，回滚简单
- **劣势**：迁移文件较长（约 80 行 SQL）
- **建议**：合并为一个迁移文件，6 个字段同一事务内迁移
- **需要你确认**：合并还是分开

### 决策 3：迁移后是否立即删除 campaigns 表旧列？

- **文档方案**：一步到位（插入 config 数据 + 改代码 + 删列，同一迁移文件）
- **替代方案**：分两步（先迁移数据+改代码，验证无误后再删列）
- **建议**：项目未上线，一步到位，降低长期维护成本
- **需要你确认**：一步到位还是分两步
