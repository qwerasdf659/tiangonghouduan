# lottery_campaigns 策略参数统一迁移方案

> 需求目标：将 `lottery_campaigns` 表中 6 个策略/机制参数迁移到 `lottery_strategy_config` 表，统一策略配置管理入口
> 基准日期：2026-02-23（初版） / 2026-02-24（二次验证修正）
> 数据来源：Node.js + Sequelize 直连 restaurant_points_dev 数据库（`dbconn.sealosbja.site:42569`）+ 代码逐文件追踪
> 迁移策略：一步到位（插入 config 数据 + 改代码 + 删原列，同一迁移文件完成）
> 二次验证：2026-02-24 通过 Node.js 直连数据库重新验证全部数据，修正行号偏移和遗漏文件

## 〇、lottery_campaigns 表字段分类总览

`lottery_campaigns` 表当前 **49 列**（2026-02-23 实查确认），其中约 12 个是策略/机制参数。经逐字段代码追踪和数据库实查，分类如下：

### 迁移到 `lottery_strategy_config`（6 个字段）

| 字段 | 中文 | 迁移为 | 活动 1 值 | 迁移理由 |
|------|------|--------|----------|---------|
| `segment_resolver_version` | 用户分群版本 | `segment.resolver_version` | v1 | 可调策略参数，与其他策略性质一致 |
| `guarantee_enabled` | 固定间隔保底开关 | `guarantee.enabled` | 0（关闭） | 可调策略参数，运营按活动开关 |
| `guarantee_threshold` | 保底触发间隔 | `guarantee.threshold` | 10 | 可调策略参数，不同活动可能不同间隔 |
| `guarantee_prize_id` | 保底指定奖品 ID | `guarantee.prize_id` | null | 可调策略参数，不同活动保底不同奖品 |
| `tier_fallback_lottery_prize_id` | 档位降级兜底奖品 ID | `tier_fallback.prize_id` | 119（参与有礼） | 可调策略参数，不同活动兜底不同奖品 |
| `preset_debt_enabled` | 预设队列透支开关 | `preset.debt_enabled` | 0 | 可调策略参数，不同活动预设行为不同 |

### 留在 `lottery_campaigns`（6 个字段）

| 字段 | 中文 | 活动 1 值 | 留下理由 |
|------|------|----------|---------|
| `budget_mode` | 预算模式 | user | **模式选择器**，决定用哪个 BudgetProvider，是 pipeline 路径分叉点 |
| `pick_method` | 抽取方式 | tier_first | **模式选择器**，决定走 TierPickStage 还是直接 PrizePickStage |
| `preset_budget_policy` | 预设预算策略 | pool_first | **模式选择器**，3 值枚举（follow_campaign/pool_first/user_first），与 budget_mode 同等性质 |
| `default_quota` | 默认预算配额 | 0.00 | 预算初始化参数，和 PoolQuotaBudgetProvider 强耦合 |
| `quota_init_mode` | 配额初始化模式 | on_demand | 同上，是预算初始化行为模式 |
| `tier_weight_scale` | 档位权重缩放系数 | 1000000 | **系统常量**，所有活动相同值，TierPickStage 硬编码 `WEIGHT_SCALE=1000000`；字段留作审计参考 |

### 分类原则

- **迁移**：运营可能按活动调整的可调参数，受益于 `DynamicConfigLoader` 的缓存/审计/生效时间等能力
- **留下**：决定 pipeline 走哪条路径的模式选择器，或与特定 Provider 初始化强耦合的参数
- 迁移完成后 `lottery_campaigns` 从 49 列减至 **43 列**

## 一、Part A — 用户分群版本迁移

### 1.1 当前问题

抽奖引擎的策略配置分散在两张表：

| 配置项 | 存储位置 | 管理入口 |
|---|---|---|
| 7 个策略开关 + 4 个灰度旋钮 | `lottery_strategy_config` 表 | 策略开关页面 |
| **用户分群版本** | `lottery_campaigns` 表 | **活动编辑页面** |
| 预算模式 | `lottery_campaigns` 表 | 活动编辑页面 |

用户分群版本与其他策略开关的性质一致（按活动独立配置、运营随时可调），但存储位置不同导致管理入口分散。

### 1.2 改造目标

将 `segment_resolver_version` 迁移到 `lottery_strategy_config` 表，以 `config_group='segment', config_key='resolver_version'` 存储。迁移完成后：

- 策略开关页面新增"用户分群"下拉框，运营在一个页面管理全部策略
- 每活动默认策略配置从 24 条变为 25 条
- 新建活动默认分群版本为 `'default'`（不分群，所有人概率一样）
- `lottery_campaigns` 表删除 `segment_resolver_version` 列，不保留旧字段

### 1.3 不涉及的内容

- `budget_mode` 保持在 `lottery_campaigns` 表不动
- 分群规则本身（`config/segment_rules.js`）不变
- 现有 7 个策略开关和 4 个灰度旋钮不受影响
- 微信小程序不涉及

---

## 二、Part A 数据库真实状态（2026-02-23 实查）

### 2.1 lottery_campaigns 表现有值

| 活动 ID | 活动名称 | segment_resolver_version | 状态 |
|---|---|---|---|
| 1 | 餐厅积分抽奖 | v1 | active |
| 25 | 走走走 | v1 | ended |
| 26 | 再找找 | v1 | paused |
| 27 | 12312 | v1 | ended |

4 个活动全部使用 `v1`（按注册时间区分新老用户）。

### 2.2 lottery_strategy_config 表现状

| 活动 ID | 记录数 | config_group 列表 |
|---|---|---|
| 1 | 24 条 | anti_empty, anti_high, budget_tier, grayscale, luck_debt, management, matrix, pity, pressure_tier |
| 25 | 24 条 | 同上 |
| 26 | 26 条 | 同上（pressure_tier.enabled 和 matrix.enabled 各有 2 条，含历史重复记录） |
| 27 | 24 条 | 同上 |

当前无 `config_group='segment'` 的记录。

### 2.3 可用的分群版本

来自 `config/segment_rules.js` 内置规则 + `segment_rule_configs` 表自定义规则：

| 版本 | 描述 | 分群方式 |
|---|---|---|
| default | 默认分层策略 — 所有用户使用相同配置 | 不分群 |
| v1 | 新老用户分层策略（注册7天内为新用户） | 按注册时间 |
| v2 | VIP用户分层策略（基于历史消费积分） | 按消费等级 |
| v3 | 组合分层策略（新用户 + VIP + 普通） | 注册时间 + 消费等级 |
| v4 | 活跃度分层策略（基于最后活跃时间） | 按活跃度 |

### 2.4 现有 API

| API | 状态 | 用途 |
|---|---|---|
| `GET /api/v4/console/segment-rules` | 已存在 | 返回所有可用分群版本列表（供下拉框渲染） |
| `GET /api/v4/console/lottery-campaigns/:id/strategy-config` | 已存在 | 返回活动的全部策略配置（迁移后会包含 segment 分组） |
| `PUT /api/v4/console/lottery-campaigns/:id/strategy-config` | 已存在 | 批量更新策略配置（支持任意 config_group，无需改动） |

不需要新建 API。

---

## 三、Part A 影响范围（代码逐文件追踪）

通过 `rg segment_resolver_version` 确认，涉及以下文件：

### 3.1 后端文件（5 个）

| # | 文件 | 当前代码 | 改动内容 |
|---|---|---|---|
| 1 | `models/LotteryCampaign.js` L782 | 字段定义 `segment_resolver_version: { type: DataTypes.STRING(32), defaultValue: 'v1' }` | 删除该字段定义 |
| 2 | `services/UnifiedLotteryEngine/pipeline/stages/TierPickStage.js` L472 | `const resolver_version = campaign.segment_resolver_version \|\| 'default'` | 改为从 `DynamicConfigLoader.getValue('segment', 'resolver_version', 'default', { lottery_campaign_id })` 读取 |
| 3 | `services/UnifiedLotteryEngine/pipeline/stages/DecisionSnapshotStage.js` L120 | `segment_resolver_version: campaign_data.campaign?.segment_resolver_version` | 改为从 TierPickStage 上下文结果获取 |
| 4 | `services/admin-lottery/CRUDService.js` L165 | STRATEGY_DEFAULTS 数组（24 条默认配置） | 新增第 25 条：`{ group: 'segment', key: 'resolver_version', value: 'default', type: 'string', desc: '用户分群版本' }` |
| 5 | `config/segment_rules.js` | 注释引用 `活动的 segment_resolver_version 字段` | 更新注释为 `lottery_strategy_config 表的 segment.resolver_version` |

### 3.2 前端文件（2 个）

| # | 文件 | 当前代码 | 改动内容 |
|---|---|---|---|
| 6 | `admin/src/modules/lottery/composables/campaigns.js` L265, L325, L400 | 活动表单中读写 `campaignForm.segment_resolver_version` | 删除这 3 处引用（分群版本不再通过活动表单管理） |
| 7 | `admin/lottery-management.html` L5663-5672 | 活动编辑表单中的分群版本下拉框 | 删除该下拉框；在策略开关 Tab 中新增分群版本下拉框（复用已有的 `loadAvailableSegmentVersions()` 调用 `GET /api/v4/console/segment-rules`） |

### 3.3 新建文件（1 个）

| # | 文件 | 内容 |
|---|---|---|
| 8 | `migrations/2026XXXX-migrate-segment-to-strategy-config.js` | 数据迁移（详见第四节） |

---

## 四、Part A 数据迁移方案（一步到位）

### 4.1 迁移文件 up 逻辑

按以下顺序在同一事务内执行：

**步骤 1：读取现有值并插入 strategy_config 表**

```sql
-- 对每个活动，读取 campaigns 表的 segment_resolver_version 值，插入 strategy_config 表
-- 幂等检查：先查是否已存在，不存在才插入
INSERT INTO lottery_strategy_config
  (lottery_campaign_id, config_group, config_key, config_value, value_type, description, is_active, priority, created_at, updated_at)
SELECT
  lottery_campaign_id,
  'segment',
  'resolver_version',
  CONCAT('"', segment_resolver_version, '"'),  -- JSON 字符串格式
  'string',
  '用户分群版本',
  1,
  0,
  NOW(),
  NOW()
FROM lottery_campaigns
WHERE lottery_campaign_id NOT IN (
  SELECT lottery_campaign_id FROM lottery_strategy_config
  WHERE config_group = 'segment' AND config_key = 'resolver_version'
)
```

**步骤 2：删除 campaigns 表的列**

```sql
ALTER TABLE lottery_campaigns DROP COLUMN segment_resolver_version
```

### 4.2 迁移文件 down 逻辑（回滚）

```sql
-- 1. 加回列
ALTER TABLE lottery_campaigns ADD COLUMN segment_resolver_version VARCHAR(32) NOT NULL DEFAULT 'v1'

-- 2. 从 strategy_config 回填
UPDATE lottery_campaigns c
  JOIN lottery_strategy_config sc ON c.lottery_campaign_id = sc.lottery_campaign_id
  SET c.segment_resolver_version = JSON_UNQUOTE(sc.config_value)
  WHERE sc.config_group = 'segment' AND sc.config_key = 'resolver_version' AND sc.is_active = 1

-- 3. 删除 config 记录
DELETE FROM lottery_strategy_config WHERE config_group = 'segment' AND config_key = 'resolver_version'
```

### 4.3 迁移后数据状态

| 活动 ID | 新增 strategy_config 记录 | config_value |
|---|---|---|
| 1 | `segment.resolver_version` | `"v1"` |
| 25 | `segment.resolver_version` | `"v1"` |
| 26 | `segment.resolver_version` | `"v1"` |
| 27 | `segment.resolver_version` | `"v1"` |

每活动从 24 条（活动 26 为 26 条）变为 25 条（活动 26 为 27 条）。

---

## 五、Part A 逐文件改动详述

### 5.1 TierPickStage.js — 核心读取点

改前（L469-472）：

```javascript
async _resolveUserSegment(user_id, campaign) {
  try {
    const resolver_version = campaign.segment_resolver_version || 'default'
```

改后：

```javascript
async _resolveUserSegment(user_id, campaign) {
  try {
    const { DynamicConfigLoader } = require('../../compute/config/StrategyConfig')
    const resolver_version = await DynamicConfigLoader.getValue(
      'segment', 'resolver_version', 'default',
      { lottery_campaign_id: campaign.lottery_campaign_id }
    )
```

走 DynamicConfigLoader 三层优先级（DB 活动级 > env > 代码默认值 `'default'`），与其他策略配置读取方式一致。配置有 5 分钟缓存（按活动 ID 隔离），不会每次抽奖都查数据库。

### 5.2 DecisionSnapshotStage.js — 快照记录

改前（L120）：

```javascript
segment_resolver_version: campaign_data.campaign?.segment_resolver_version
```

改后：

```javascript
segment_resolver_version: tier_pick_data?.resolver_version || 'default'
```

从 TierPickStage 的上下文结果中获取已解析的版本值（TierPickStage 需在上下文中存储 `resolver_version`）。

### 5.3 CRUDService.js — 创建活动默认配置

在 L165 开始的 `STRATEGY_DEFAULTS` 数组末尾新增：

```javascript
{ group: 'segment', key: 'resolver_version', value: 'default', type: 'string', desc: '用户分群版本' }
```

同时确认 `LotteryCampaign.create()` 调用中不再传入 `segment_resolver_version`（模型删除该字段后，传入会被 Sequelize 忽略，但代码应保持干净）。

### 5.4 LotteryCampaign.js — 删除字段

删除 L775-787 的 `segment_resolver_version` 字段定义。

### 5.5 前端 campaigns.js — 移除表单字段

删除 3 处 segment_resolver_version 引用：

- L265：`segment_resolver_version: 'default'`（创建活动表单默认值）
- L325：`segment_resolver_version: fullCampaign.segment_resolver_version || 'default'`（编辑活动回填逻辑）
- L400：`segment_resolver_version: this.campaignForm.segment_resolver_version || 'default'`（提交逻辑）

`loadAvailableSegmentVersions()` 方法（L205-225）保留，搬到策略开关页面复用。

### 5.6 前端 lottery-management.html — UI 调整

**删除**：活动编辑表单中的分群版本下拉框（L5663-5672）。

**新增**：策略开关 Tab 顶部增加"用户分群"下拉框：

- 调用已有的 `GET /api/v4/console/segment-rules` 获取版本列表
- 当前值从 `GET /:lottery_campaign_id/strategy-config` 返回的 `segment.resolver_version` 读取
- 修改后通过 `PUT /:lottery_campaign_id/strategy-config` 提交 `{ config: { segment: { resolver_version: '选中的值' } } }`

---

## 六、Part A 实施顺序

| 步骤 | 内容 | 涉及文件 |
|---|---|---|
| 1 | 后端代码改动（TierPickStage + DecisionSnapshotStage + CRUDService + Model） | 4 个后端文件 |
| 2 | 数据迁移（插入 config 数据 + 删除 campaigns 列） | 1 个迁移文件 |
| 3 | 前端改动（campaigns.js 移除 + lottery-management.html 策略开关 Tab 加下拉框） | 2 个前端文件 |
| 4 | 测试验证 | — |

步骤 1 和 2 必须一起部署（代码依赖新的读取方式，迁移删除旧列）。步骤 3 可与 1-2 同步开发。

---

## 七、Part A 验收标准

1. 新建一个活动 → `lottery_strategy_config` 自动插入 25 条记录（含 `segment.resolver_version = 'default'`）
2. `lottery_campaigns` 表不再有 `segment_resolver_version` 列
3. 策略开关页面显示"用户分群"下拉框，当前值正确显示（活动 1/25/26/27 显示 `v1`）
4. 在策略开关页面将活动 1 的分群版本改为 `v2` → 活动 1 用 VIP 分群，其他活动不受影响
5. 抽奖功能正常 — TierPickStage 按新路径读取分群版本，分群逻辑无变化
6. DecisionSnapshotStage 的快照记录正确包含 `segment_resolver_version` 字段

---

---

## Part B — 固定间隔保底迁移（3 个字段）

### B.1 业务说明

固定间隔保底是活动级**机制**（非策略），实现"每 N 次抽奖必出大奖"的营销承诺。当前作为 `lottery_campaigns` 表字段，与 Pity 策略（策略 5）是不同层次的保障：

| | Pity 保底（策略 5） | 固定间隔保底（机制） |
|---|---|---|
| 触发条件 | 连续空奖次数 >= 阈值 | 累计抽奖次数 % N == 0 |
| 作用层次 | 概率调权（软硬保底） | 决策源覆盖（强制 high 档） |
| 业务目的 | 体验补偿 | 营销承诺 |

### B.2 数据库真实状态（2026-02-23 实查）

| 活动 ID | guarantee_enabled | guarantee_threshold | guarantee_prize_id |
|---|---|---|---|
| 1 | **0（关闭）** | 10 | null |
| 25 | **0（关闭）** | 10 | null |
| 26 | **0（关闭）** | 10 | null |
| 27 | **0（关闭）** | 10 | null |

4 个活动全部关闭。`guarantee_prize_id` 全部 null（触发时自动选最高档有库存奖品）。

### B.3 代码链路

**后端（6 个文件）：**

| 文件 | 位置 | 当前代码 | 改动 |
|---|---|---|---|
| `LoadDecisionSourceStage.js` L278-282 | `_checkGuarantee()` | `campaign.guarantee_enabled === true` + `campaign.guarantee_threshold` | 改为 `DynamicConfigLoader.getValue('guarantee', 'enabled/threshold/prize_id', ...)` |
| `TierPickStage.js` L167-193 | guarantee 模式分支 | `decision_source === 'guarantee'` 时强制 high 档 | 不改（读的是 decision_source，不直接读 campaign 字段） |
| `GuaranteeStage.js` L93-180 | 保底奖品选择 | `campaign.guarantee_enabled === true`（L93）, `campaign.guarantee_threshold`（L103）, `campaign.guarantee_prize_id`（L104） | 改为从 DynamicConfigLoader 读取 3 个字段 |
| `DecisionSnapshotStage.js` | 快照记录 | 无直接引用 | 不改 |
| `models/LotteryCampaign.js` | 字段定义 + 关联 | 3 个字段定义（L1106, L1120, L1134）+ `belongsTo LotteryPrize` 关联（L101-103） | 删除字段定义和关联 |
| `admin-lottery/CRUDService.js` | 创建活动 | `STRATEGY_DEFAULTS` 数组（L165） | 新增 3 条 guarantee 默认配置 |

**Web 管理前端（2 个文件，原文档遗漏）：**

| 文件 | 位置 | 当前代码 | 改动 |
|---|---|---|---|
| `admin/src/modules/lottery/composables/campaigns.js` | L64-68, L274-276, L327-330, L409-411 | 活动表单状态定义和读写 `guarantee_enabled`, `guarantee_threshold`, `guarantee_prize_id` 共 4 处 | 删除全部 4 处引用（保底配置迁移到策略开关页面管理） |
| `admin/lottery-management.html` | L5786-5829 | 活动编辑表单中的固定间隔保底配置区域（开关 + 间隔 + 奖品选择 + 触发率计算） | 删除该区域；在策略开关 Tab 中新增 guarantee 分组的配置控件 |

### B.4 迁移数据

新增 `config_group` 和 `config_key`：

| config_group | config_key | value_type | 活动 1 值 | 默认值（新活动） |
|---|---|---|---|---|
| guarantee | enabled | boolean | false | false |
| guarantee | threshold | number | 10 | 10 |
| guarantee | prize_id | number | null | null |

迁移 SQL：

```sql
INSERT INTO lottery_strategy_config
  (lottery_campaign_id, config_group, config_key, config_value, value_type, description, is_active, priority, created_at, updated_at)
SELECT lottery_campaign_id, 'guarantee', 'enabled', IF(guarantee_enabled, 'true', 'false'), 'boolean', '固定间隔保底开关', 1, 0, NOW(), NOW()
FROM lottery_campaigns
WHERE lottery_campaign_id NOT IN (
  SELECT lottery_campaign_id FROM lottery_strategy_config WHERE config_group='guarantee' AND config_key='enabled'
);

INSERT INTO lottery_strategy_config
  (lottery_campaign_id, config_group, config_key, config_value, value_type, description, is_active, priority, created_at, updated_at)
SELECT lottery_campaign_id, 'guarantee', 'threshold', guarantee_threshold, 'number', '保底触发间隔（每N次）', 1, 0, NOW(), NOW()
FROM lottery_campaigns
WHERE lottery_campaign_id NOT IN (
  SELECT lottery_campaign_id FROM lottery_strategy_config WHERE config_group='guarantee' AND config_key='threshold'
);

INSERT INTO lottery_strategy_config
  (lottery_campaign_id, config_group, config_key, config_value, value_type, description, is_active, priority, created_at, updated_at)
SELECT lottery_campaign_id, 'guarantee', 'prize_id',
  CASE WHEN guarantee_prize_id IS NOT NULL THEN guarantee_prize_id ELSE 'null' END,
  'number', '保底指定奖品ID（null=自动选最高档）', 1, 0, NOW(), NOW()
FROM lottery_campaigns
WHERE lottery_campaign_id NOT IN (
  SELECT lottery_campaign_id FROM lottery_strategy_config WHERE config_group='guarantee' AND config_key='prize_id'
);

ALTER TABLE lottery_campaigns DROP COLUMN guarantee_enabled;
ALTER TABLE lottery_campaigns DROP COLUMN guarantee_threshold;
ALTER TABLE lottery_campaigns DROP COLUMN guarantee_prize_id;
```

---

## Part C — 档位降级兜底迁移（1 个字段）

### C.1 业务说明

档位降级兜底是基础设施级安全网：当所有档位（high → mid → low → fallback）都没有可用奖品时，使用指定奖品确保抽奖永远能返回结果。

与固定间隔保底的区别：
- `guarantee_prize_id`：**主动触发**（到次数了）— 营销承诺
- `tier_fallback_lottery_prize_id`：**被动兜底**（没奖品了）— 系统安全

### C.2 数据库真实状态

| 活动 ID | tier_fallback_lottery_prize_id | 对应奖品 |
|---|---|---|
| 1 | **119** | "参与有礼"（virtual, reward_tier=low, prize_value_points=0, is_fallback=1） |
| 25 | null | 未配置 |
| 26 | null | 未配置 |
| 27 | null | 未配置 |

活动 1 共有 6 个 `is_fallback=1` 的奖品（ID 114-119）。

### C.3 代码链路

| 文件 | 位置 | 当前代码 | 改动 |
|---|---|---|---|
| `LoadCampaignStage.js` L194-200 | `_getFallbackPrize()` | `campaign.tier_fallback_lottery_prize_id`（L196 判断 + L198 匹配） | 改为 `DynamicConfigLoader.getValue('tier_fallback', 'prize_id', null, { lottery_campaign_id })` |
| `models/LotteryCampaign.js` | 字段定义（L754）+ 关联（L93-95） | `tier_fallback_lottery_prize_id` 字段 + `belongsTo LotteryPrize as tierFallbackPrize` | 删除字段定义和关联 |
| `admin-lottery/CRUDService.js` L165 | 创建活动 | `STRATEGY_DEFAULTS` | 新增 1 条 tier_fallback 默认配置 |

### C.4 迁移数据

| config_group | config_key | value_type | 活动 1 值 | 默认值（新活动） |
|---|---|---|---|---|
| tier_fallback | prize_id | number | 119 | null |

迁移 SQL：

```sql
INSERT INTO lottery_strategy_config
  (lottery_campaign_id, config_group, config_key, config_value, value_type, description, is_active, priority, created_at, updated_at)
SELECT lottery_campaign_id, 'tier_fallback', 'prize_id',
  CASE WHEN tier_fallback_lottery_prize_id IS NOT NULL THEN tier_fallback_lottery_prize_id ELSE 'null' END,
  'number', '档位降级兜底奖品ID（null=自动选is_fallback=1的奖品）', 1, 0, NOW(), NOW()
FROM lottery_campaigns
WHERE lottery_campaign_id NOT IN (
  SELECT lottery_campaign_id FROM lottery_strategy_config WHERE config_group='tier_fallback' AND config_key='prize_id'
);

ALTER TABLE lottery_campaigns DROP COLUMN tier_fallback_lottery_prize_id;
```

---

## Part D — 预设队列透支开关迁移（1 个字段）

### D.1 业务说明

预设队列功能已在 pipeline 中实现（`LoadDecisionSourceStage` 最高优先级检查预设，`TierPickStage`/`PrizePickStage` 都有 `preset` 模式分支）。`preset_debt_enabled` 控制：预设要发的奖品库存不足时，是允许先发后补（欠账），还是预设作废走正常抽奖。

- `lottery_presets` 表存在（2 条记录），有完整审批流程字段
- `preset_budget_debt` 表存在，用于记录欠账
- 只是"库存不足时的欠账判断"这一环尚未接入 pipeline

### D.2 数据库真实状态

| 活动 ID | preset_debt_enabled |
|---|---|
| 1 | **0（不允许）** |
| 25 | **0（不允许）** |
| 26 | **0（不允许）** |
| 27 | **0（不允许）** |

### D.3 代码链路

**后端（5 个文件 + 1 个测试文件）：**

| 文件 | 位置 | 当前代码 | 改动 |
|---|---|---|---|
| `services/ActivityService.js` L474, L503 | API 响应 | `preset_debt_enabled: !!campaign.preset_debt_enabled` | 改为从 DynamicConfigLoader 读取 |
| `services/admin-lottery/CampaignService.js` L289-354 | 更新校验 + 写入 | boolean 类型校验（L290-292）+ 写入 campaigns 表（L353-354） | 删除 preset_debt_enabled 校验和写入逻辑（改由 PUT strategy-config API 管理） |
| `routes/v4/console/campaign-budget.js` L189-262 | 预算配置路由 | 接收并处理 `preset_debt_enabled`（L204 解构、L233 传入、L262 返回） | 删除 preset_debt_enabled 相关的入参解构、传入、响应（此字段不再属于预算配置） |
| `models/LotteryCampaign.js` L796-801 | 字段定义 | `preset_debt_enabled: DataTypes.BOOLEAN` | 删除 |
| `admin-lottery/CRUDService.js` L165 | 创建活动 | `STRATEGY_DEFAULTS` | 新增 1 条 preset 默认配置 |
| `tests/integration/campaign_preset_budget_policy.test.js` L108-110 | 测试断言 | 断言 `campaign.preset_debt_enabled` 存在且为 boolean | 改为从 strategy_config 读取验证，或删除该断言 |

### D.4 迁移数据

| config_group | config_key | value_type | 活动 1 值 | 默认值（新活动） |
|---|---|---|---|---|
| preset | debt_enabled | boolean | false | false |

迁移 SQL：

```sql
INSERT INTO lottery_strategy_config
  (lottery_campaign_id, config_group, config_key, config_value, value_type, description, is_active, priority, created_at, updated_at)
SELECT lottery_campaign_id, 'preset', 'debt_enabled', IF(preset_debt_enabled, 'true', 'false'), 'boolean', '预设队列透支开关', 1, 0, NOW(), NOW()
FROM lottery_campaigns
WHERE lottery_campaign_id NOT IN (
  SELECT lottery_campaign_id FROM lottery_strategy_config WHERE config_group='preset' AND config_key='debt_enabled'
);

ALTER TABLE lottery_campaigns DROP COLUMN preset_debt_enabled;
```

---

## Part E — 迁移汇总

### E.1 新增 config_group/config_key 全表

| config_group | config_key | value_type | 默认值 | 描述 | 来源字段 |
|---|---|---|---|---|---|
| segment | resolver_version | string | default | 用户分群版本 | segment_resolver_version |
| guarantee | enabled | boolean | false | 固定间隔保底开关 | guarantee_enabled |
| guarantee | threshold | number | 10 | 保底触发间隔 | guarantee_threshold |
| guarantee | prize_id | number | null | 保底指定奖品ID | guarantee_prize_id |
| tier_fallback | prize_id | number | null | 档位降级兜底奖品ID | tier_fallback_lottery_prize_id |
| preset | debt_enabled | boolean | false | 预设队列透支开关 | preset_debt_enabled |

每活动 6 条新记录。4 个活动共 24 条。迁移后每活动默认配置从 24 条变为 **30 条**。

### E.2 迁移后从 campaigns 表删除的列（6 列）

`segment_resolver_version`, `guarantee_enabled`, `guarantee_threshold`, `guarantee_prize_id`, `tier_fallback_lottery_prize_id`, `preset_debt_enabled`

`lottery_campaigns` 从 49 列减至 **43 列**。

### E.3 迁移后 lottery_campaigns 表剩余字段全览（43 列）

| 类别 | 列数 | 字段 |
|------|------|------|
| **主键/身份** | 5 | `lottery_campaign_id`（活动ID）, `campaign_name`（活动名称）, `campaign_code`（活动代码）, `campaign_type`（活动类型）, `status`（活动状态） |
| **时间规则** | 5 | `start_time`（开始时间）, `end_time`（结束时间）, `daily_reset_time`（每日重置时间）, `created_at`（创建时间）, `updated_at`（更新时间） |
| **抽奖限制** | 3 | `max_draws_per_user_daily`（每人每日抽奖上限）, `max_draws_per_user_total`（每人总抽奖上限）, `daily_budget_limit`（每日预算上限） |
| **奖池/预算** | 9 | `total_prize_pool`（总奖池价值）, `remaining_prize_pool`（剩余奖池价值）, `prize_distribution_config`（奖品分布配置）, `budget_mode`（预算模式）, `pool_budget_total`（活动池总预算）, `pool_budget_remaining`（活动池剩余预算）, `public_pool_remaining`（公共池剩余）, `reserved_pool_remaining`（预留池剩余）, `allowed_campaign_ids`（允许的预算来源活动） |
| **预算子系统** | 6 | `pick_method`（抽取方式）, `preset_budget_policy`（预设预算策略）, `default_quota`（默认配额）, `quota_init_mode`（配额初始化模式）, `max_budget_debt`（预算欠账上限）, `max_inventory_debt_quantity`（库存欠账上限） |
| **运行时计数** | 3 | `total_participants`（总参与人数）, `total_draws`（总抽奖次数）, `total_prizes_awarded`（总发奖数） |
| **参与条件** | 2 | `participation_conditions`（参与条件规则）, `condition_error_messages`（条件不满足提示语） |
| **前端展示** | 7 | `display_mode`（展示玩法）, `grid_cols`（网格列数）, `effect_theme`（特效主题）, `rarity_effects_enabled`（稀有度光效开关）, `win_animation`（中奖动画）, `banner_image_url`（横幅图）, `background_image_url`（背景图） |
| **内容描述** | 2 | `description`（活动描述）, `rules_text`（活动规则） |
| **系统常量** | 1 | `tier_weight_scale`（档位权重缩放系数，所有活动=1000000） |

### E.4 留在 campaigns 表的策略相关字段说明（6 个）

| 字段 | 中文 | 留下理由 |
|---|---|---|
| `budget_mode`（预算模式） | user/pool/none | 模式选择器：决定用 UserBudgetProvider / PoolBudgetProvider / NoBudgetProvider |
| `pick_method`（抽取方式） | tier_first/normalize | 模式选择器：决定走 TierPickStage 档位抽取还是 normalize 直接抽奖 |
| `preset_budget_policy`（预设预算策略） | follow_campaign/pool_first/user_first | 模式选择器：预设发奖时的预算扣减顺序 |
| `default_quota`（默认配额） | 0.00 | 预算初始化参数：PoolQuotaBudgetProvider 按需创建配额时的初始值 |
| `quota_init_mode`（配额初始化模式） | on_demand/pre_allocated | 预算初始化参数：按需创建还是预分配 |
| `tier_weight_scale`（档位权重缩放系数） | 1000000 | 系统常量：所有活动均相同，TierPickStage 硬编码同值，留作审计参考 |

### E.4 实施顺序

| 阶段 | 内容 | 后端文件数 | 前端文件数 |
|---|---|---|---|
| 1 | Part A — 用户分群迁移（后端改读取源 + 前端删表单字段） | 5 个 | 2 个 |
| 2 | Part B — 固定间隔保底迁移（后端改读取源 + **前端删保底表单**） | 6 个 | **2 个** |
| 3 | Part C — 档位降级兜底迁移（仅后端） | 3 个 | 0 个 |
| 4 | Part D — 预设透支开关迁移（后端 + 测试） | 6 个 | 0 个 |
| 5 | 统一迁移文件（Part A-D 数据迁移 + 删列） | 1 个 | — |
| 6 | 前端策略开关页面适配（segment/guarantee/tier_fallback/preset 4 个新分组） | — | 2 个 |
| 7 | 测试验证 | — | — |

Part A-D 的数据迁移合并为同一个迁移文件。后端代码改动互相独立，可并行开发。前端改动分两步：先删旧表单字段（阶段 1-2），再在策略开关 Tab 新增控件（阶段 6）。

### E.5 验收标准

1. Part A 验收（详见第七节）
2. 新建活动 → `lottery_strategy_config` 自动插入 **30 条**记录（含 segment/guarantee/tier_fallback/preset 共 6 条新增）
3. `lottery_campaigns` 表不再有被迁移的 6 列
4. 修改活动 1 的 `guarantee.enabled=true` → 仅活动 1 开启固定间隔保底，其他活动不受影响
5. 修改活动 1 的 `tier_fallback.prize_id` → 仅活动 1 兜底奖品变更
6. 抽奖功能全链路正常 — `LoadDecisionSourceStage`、`GuaranteeStage`、`LoadCampaignStage`、`TierPickStage` 按新路径读取配置

---

## 八、改造后的完整策略配置矩阵

| # | 策略/机制 | 配置方式 | 配置位置 | 管理入口 |
|---|---|---|---|---|
| 1 | **用户分群** | **下拉选择版本** | **`lottery_strategy_config` segment.resolver_version** | **策略开关页面（Part A 迁移）** |
| 2 | 预算分层 | 下拉选择模式 | `lottery_campaigns.budget_mode` | 活动编辑页面（保持不动） |
| 3 | Pity 保底 | on/off 开关 + 参数 | `lottery_strategy_config` pity.* | 策略开关页面 |
| 4 | 运气债务 | on/off 开关 + 参数 | `lottery_strategy_config` luck_debt.* | 策略开关页面 |
| 5 | 防连空 | on/off 开关 + 参数 | `lottery_strategy_config` anti_empty.* | 策略开关页面 |
| 6 | 防连高 | on/off 开关 + 参数 | `lottery_strategy_config` anti_high.* | 策略开关页面 |
| 7 | 活动压力 | on/off 开关 + 参数 | `lottery_strategy_config` pressure_tier.* | 策略开关页面 |
| 8 | BxPx 矩阵 | on/off 开关 | `lottery_strategy_config` matrix.* | 策略开关页面 |
| 9 | 管理干预 | on/off 开关 | `lottery_strategy_config` management.* | 策略开关页面 |
| 10 | 灰度发布 | 4 个百分比旋钮 | `lottery_strategy_config` grayscale.* | 策略开关页面 |
| 11 | **固定间隔保底** | **on/off 开关 + 间隔 + 奖品** | **`lottery_strategy_config` guarantee.*** | **策略开关页面（Part B 迁移）** |
| 12 | **档位降级兜底** | **奖品 ID** | **`lottery_strategy_config` tier_fallback.*** | **策略开关页面（Part C 迁移）** |
| 13 | **预设透支开关** | **on/off 开关** | **`lottery_strategy_config` preset.*** | **策略开关页面（Part D 迁移）** |

---

## 九、实时数据库验证报告（2026-02-24 Node.js 直连实查）

> 以下内容通过 Node.js + Sequelize 直连 `restaurant_points_dev` 数据库（`dbconn.sealosbja.site:42569`）实时查询生成，非引用历史报告。验证日期：2026-02-24。

### 9.1 两张表功能状态：均正常可用

| 检查项 | lottery_campaigns | lottery_strategy_config |
|--------|-------------------|------------------------|
| 表是否存在 | 存在（**49 列**，逐列确认） | 存在（10 列） |
| 数据记录数 | 4 条活动（ID: 1, 25, 26, 27） | 98 条配置（1→24, 25→24, 26→26, 27→24） |
| 9 个 config_group | — | `anti_empty, anti_high, budget_tier, grayscale, luck_debt, management, matrix, pity, pressure_tier` |
| 唯一约束 | 主键 `lottery_campaign_id` | 联合唯一 `uk_strategy_campaign_group_key_priority(lottery_campaign_id, config_group, config_key, priority)` |
| 索引 | — | `idx_strategy_config_group_active(config_group, is_active)`, `idx_strategy_config_campaign(lottery_campaign_id)` |
| 外键完整性 | `tier_fallback_lottery_prize_id=119` → `lottery_prizes.119`（存在且有效） | 无外键约束（通过业务逻辑保证） |
| 引擎读取路径 | `TierPickStage` 直读 `campaign.segment_resolver_version` | `DynamicConfigLoader.getValue()` 按 `config_group+config_key` 读取，5 分钟缓存 |

**结论：两张表的 CRUD 和引擎读取路径均正常工作，迁移方案的前提条件成立。**

### 9.2 6 个待迁移字段的数据库实查值（2026-02-24 确认）

| 活动 ID | 活动名称 | 状态 | segment_resolver_version | guarantee_enabled | guarantee_threshold | guarantee_prize_id | tier_fallback_lottery_prize_id | preset_debt_enabled |
|---|---|---|---|---|---|---|---|---|
| 1 | 餐厅积分抽奖 | active | v1 | 0（关闭） | 10 | null | **119** | 0 |
| 25 | 走走走 | ended | v1 | 0（关闭） | 10 | null | null | 0 |
| 26 | 再找找 | paused | v1 | 0（关闭） | 10 | null | null | 0 |
| 27 | 12312 | ended | v1 | 0（关闭） | 10 | null | null | 0 |

留在 campaigns 表的模式选择器字段（不迁移）：

| 活动 ID | budget_mode | pick_method | preset_budget_policy |
|---|---|---|---|
| 1 | user | tier_first | **pool_first** |
| 25 | user | tier_first | follow_campaign |
| 26 | user | tier_first | follow_campaign |
| 27 | user | tier_first | follow_campaign |

### 9.3 文档与实际数据差异修正

| 文档原文 | 实际值 | 影响 |
|----------|--------|------|
| 第〇节"当前 **47 列**" | 实际 **49 列** | 纯数字笔误，E.2 节已正确写 49 列，不影响方案 |
| Part B 代码链路仅列 6 个后端文件 | **实际还有 2 个前端文件**涉及 guarantee 字段（`campaigns.js` 4 处 + `lottery-management.html` L5786-5829 保底 UI 区域） | **已补充至 B.3 节**，前端改动量比原文档大 |
| Part D 代码链路仅列 4 个文件 | **实际还有** `routes/v4/console/campaign-budget.js`（L189-262）和 `tests/integration/campaign_preset_budget_policy.test.js`（L108-110） | **已补充至 D.3 节** |
| campaigns.js 行号 L244, L304, L379 | 实际 **L265, L325, L400**（约偏移 20 行） | **已修正** |
| lottery-management.html 行号 L5641-5650 | 实际 **L5663-5672** | **已修正** |
| `loadAvailableSegmentVersions()` L184-204 | 实际 **L205-225** | **已修正** |
| `STRATEGY_DEFAULTS` L157-185 | 实际起始 **L165**，24 条配置跨至 L292 | 范围更大但不影响方案 |

### 9.4 活动 26 重复记录详情

| config_id | config_group | config_key | config_value | priority | created_at (北京时间) | 说明 |
|-----------|-------------|------------|---|----------|------------|------|
| 23 | matrix | enabled | true | 10 | 2026-02-23 06:55 | 原始记录（保留） |
| 74 | matrix | enabled | true | 0 | 2026-02-24 10:15 | 重复记录（建议删除） |
| 22 | pressure_tier | enabled | true | 10 | 2026-02-23 06:55 | 原始记录（保留） |
| 79 | pressure_tier | enabled | true | 0 | 2026-02-24 10:15 | 重复记录（建议删除） |

**建议**：迁移前执行清理 SQL：

```sql
DELETE FROM lottery_strategy_config WHERE lottery_strategy_config_id IN (74, 79);
```

### 9.5 迁移目标 config_group 验证

已确认 `lottery_strategy_config` 表中 **不存在** `segment`、`guarantee`、`tier_fallback`、`preset` 四个 config_group 的记录（查询返回 0 条）。迁移 SQL 的幂等检查（`WHERE lottery_campaign_id NOT IN (...)`）会正常工作，不会产生冲突。

### 9.6 关联表验证

| 表 | 记录数 | 主键列 | 状态 |
|----|--------|--------|------|
| `segment_rule_configs` | 5 条（default, v1, v2, v3, v4） | `segment_rule_config_id` | 正常，5 条均 `is_system=1, status=active` |
| `lottery_presets` | 2 条 | — | 正常，预设队列功能可用 |
| `preset_budget_debt` | 0 条 | — | 正常，当前无欠账记录 |
| `preset_debt_limits` | 存在 | — | 正常 |
| `preset_inventory_debt` | 存在 | — | 正常 |
| `lottery_prizes` ID=119 | 1 条 | `lottery_prize_id` | 正常，活动 1 的 `tier_fallback_lottery_prize_id` 指向有效 |

---

## 十、问题归属分类（后端 / Web 管理前端 / 微信小程序前端）

### 10.1 后端数据库项目的改动（核心，8 个代码文件 + 1 个迁移文件 + 1 个测试文件）

| # | 文件 | 改动类型 | 改动内容 |
|---|------|----------|----------|
| 1 | `models/LotteryCampaign.js` | 删除字段定义 + 关联 | 删除 6 个字段：`segment_resolver_version`（L782）、`guarantee_enabled`（L1106）、`guarantee_threshold`（L1120）、`guarantee_prize_id`（L1134）、`tier_fallback_lottery_prize_id`（L754）、`preset_debt_enabled`（L796）；删除 `belongsTo LotteryPrize` 关联（guarantee_prize_id L101-103） |
| 2 | `services/UnifiedLotteryEngine/pipeline/stages/TierPickStage.js` | 改读取源 | L472 从 `campaign.segment_resolver_version` 改为 `DynamicConfigLoader.getValue('segment', 'resolver_version', 'default', ...)` |
| 3 | `services/UnifiedLotteryEngine/pipeline/stages/LoadDecisionSourceStage.js` | 改读取源 | L278-279 从 `campaign.guarantee_enabled` / `campaign.guarantee_threshold` 改为 DynamicConfigLoader 读取 |
| 4 | `services/UnifiedLotteryEngine/pipeline/stages/GuaranteeStage.js` | 改读取源 | L93, L103, L104 从 campaign 直读改为 DynamicConfigLoader 读取 guarantee.enabled/threshold/prize_id |
| 5 | `services/UnifiedLotteryEngine/pipeline/stages/LoadCampaignStage.js` | 改读取源 | L196 从 `campaign.tier_fallback_lottery_prize_id` 改为 DynamicConfigLoader 读取 |
| 6 | `services/admin-lottery/CRUDService.js` | 扩展默认配置 | `STRATEGY_DEFAULTS` 数组（L165）从 24 条扩展到 30 条，新增 segment/guarantee/tier_fallback/preset 共 6 条 |
| 7 | `services/ActivityService.js` | 改读取源 | L474, L503 的 `preset_debt_enabled` 改为从 DynamicConfigLoader 读取 |
| 8 | `services/admin-lottery/CampaignService.js` | 删除校验和写入 | L289-354 删除 `preset_debt_enabled` 的 boolean 校验和 campaigns 表写入逻辑 |
| 9 | `routes/v4/console/campaign-budget.js` | 删除字段处理 | L189-262 删除 `preset_debt_enabled` 的入参解构、传入、响应 |
| 10 | `config/segment_rules.js` | 更新注释 | 注释中 `segment_resolver_version 字段` 改为 `lottery_strategy_config 表的 segment.resolver_version` |
| 11 | `services/UnifiedLotteryEngine/pipeline/stages/DecisionSnapshotStage.js` | 改读取源 | L120 从 `campaign_data.campaign?.segment_resolver_version` 改为从 TierPickStage 上下文获取 |
| 12 | `migrations/2026XXXX-migrate-strategy-params.js` | 新建迁移文件 | 数据迁移（插入 24 条 config 记录 + 删除 6 列） |
| 13 | `tests/integration/campaign_preset_budget_policy.test.js` | 更新测试断言 | L108-110 的 `preset_debt_enabled` 断言需从 strategy_config 路径验证 |

**不需要新建 API**。现有 3 个 API 完全够用：

- `GET /api/v4/console/lottery-campaigns/:id/strategy-config` — 已有，返回全部策略配置，迁移后自动包含新 config_group
- `PUT /api/v4/console/lottery-campaigns/:id/strategy-config` — 已有，支持任意 config_group 的批量更新，无需改动
- `GET /api/v4/console/segment-rules` — 已有，返回分群版本列表

**后端技术栈适配评估**：

| 技术点 | 现有能力 | 迁移方案是否适配 |
|--------|----------|------------------|
| Node.js 20+ + Express | V4 RESTful API 架构，`/api/v4/` 统一路径 | 完全适配：不新增路由，只改 Service 层读取源 |
| Sequelize ORM（v6.35.2） | 模型定义、迁移工具、事务支持 | 完全适配：删字段用 `queryInterface.removeColumn`，插数据用 raw SQL |
| DynamicConfigLoader | 三层优先级读取（DB 活动级 > env > 代码默认值），5 分钟缓存，`clearCache()` 方法 | 完全复用：新 config_group 自动走同一套加载/缓存逻辑 |
| CRUDService.STRATEGY_DEFAULTS | 新建活动时自动插入默认配置 | 扩展即可：数组新增 6 条记录 |
| Pipeline 架构（Stage 链） | 各 Stage 独立读取配置，`LoadDecisionSourceStage` → `TierPickStage` → `GuaranteeStage` | 只改读取源，不动 pipeline 编排逻辑 |
| 审计日志（AuditLogService） | 策略配置变更自动记录操作人、变更前后值 | 复用：PUT strategy-config 已接入审计 |
| 唯一约束 `uk_strategy_campaign_group_key_priority` | 防重复写入，4 列联合唯一 | 迁移 SQL 的幂等检查 + 唯一约束双重保障 |
| sequelize-cli 迁移工具 | `npx sequelize-cli db:migrate` 执行，`db:migrate:undo` 回滚 | 完全适配：迁移文件标准格式 |

### 10.2 Web 管理后台前端项目的改动（2 个文件，但改动点比原估计多）

| # | 文件 | 改动类型 | 改动内容 |
|---|------|----------|----------|
| 1 | `admin/src/modules/lottery/composables/campaigns.js` | 删除表单字段 | **Part A**：删除 3 处 `segment_resolver_version` 引用（L265 默认值、L325 回填、L400 提交）；**Part B**：删除 4 处 `guarantee_*` 引用（L64-68 状态定义、L274-276 创建默认值、L327-330 编辑回填、L409-411 提交数据） |
| 2 | `admin/lottery-management.html` | UI 迁移 | **Part A**：删除分群版本下拉框（L5663-5672）；**Part B**：删除固定间隔保底配置区域（L5786-5829，含开关/间隔/奖品选择/触发率计算）；策略开关 Tab 新增 segment/guarantee/tier_fallback/preset 4 个新 config_group 的配置控件 |

**Web 前端技术栈适配评估**：

| 技术点 | 现有能力 | 迁移方案是否适配 |
|--------|----------|------------------|
| Alpine.js（v3.15.4） | 响应式数据绑定、`x-data` 组件化 | 完全适配：策略开关页面已有组件管理策略配置的加载/修改/提交 |
| Vite（v6.4.1）多页应用 | `lottery-management.html` 单页含抽奖管理全部 Tab | 适配：在已有的策略开关 Tab 中扩展 UI |
| 已有 API 调用模式 | `GET/PUT strategy-config` 已在策略开关页面 `strategy.js` 中使用（`loadActivityStrategyConfig()` / `updateStrategyConfig()`） | 完全复用：新增的 config_group 走同一套读写逻辑 |
| `loadAvailableSegmentVersions()` | 已在 campaigns.js L205-225 实现，调用 `GET /api/v4/console/segment-rules` | 复用：搬到策略开关页面（`strategy.js` 或内联到 HTML） |
| Tailwind CSS（v3.4.19） | 策略开关页面已有 on/off 开关、数字输入框、下拉选择框的样式模式 | 复用：guarantee/tier_fallback/preset 的 UI 控件用同样的样式模式 |
| ECharts（v6.0.0） | 策略模拟器已有 | 不涉及 |

### 10.3 微信小程序前端项目

**本次迁移不涉及微信小程序前端。**

原因：被迁移的 6 个字段（`segment_resolver_version`、`guarantee_*`、`tier_fallback_lottery_prize_id`、`preset_debt_enabled`）全部是后端引擎内部配置参数和管理后台运营配置，小程序用户端的抽奖 API（`POST /api/v4/lottery/draw`）入参和出参均不包含这些字段。抽奖引擎内部从哪张表读取配置，对小程序完全透明。

小程序只需关注抽奖结果接口的响应格式，这些响应格式不会因配置存储位置的变化而改变。

---

## 十一、可复用能力与可扩展点

### 11.1 后端可复用（不需改动直接用）

| 能力 | 所在文件 | 复用方式 |
|------|----------|----------|
| `DynamicConfigLoader.getValue(group, key, default, options)` | `services/UnifiedLotteryEngine/compute/config/StrategyConfig.js` L876-884 | 新 config_group 直接调用，自动走 DB 查询 + 5 分钟缓存 + env 降级 |
| `DynamicConfigLoader.clearCache(lottery_campaign_id)` | 同上 | 配置更新后清除缓存，策略开关 PUT 路由已在 L577 调用 |
| `PUT /api/v4/console/lottery-campaigns/:id/strategy-config` | `routes/v4/console/lottery-campaigns.js` L555-591 | 接收任意 config_group 的 JSON，内部按 group+key 做 upsert，无需改路由 |
| `GET /api/v4/console/lottery-campaigns/:id/strategy-config` | 同上 L519-539 | 自动返回所有 config_group（含新增的），无需改路由 |
| `GET /api/v4/console/segment-rules` | 同上 | 返回 `segment_rule_configs` 表全部 5 条分群版本 |
| `CRUDService.STRATEGY_DEFAULTS` 扩展模式 | `services/admin-lottery/CRUDService.js` L165 | 数组追加记录即可，新建活动自动插入 |
| `AuditLogService` 审计日志 | — | 策略配置变更自动记录操作人、变更前后值 |
| Sequelize Migration 工具链 | `package.json` scripts | `npx sequelize-cli db:migrate` 执行，`db:migrate:undo` 回滚 |

### 11.2 后端可扩展

| 扩展点 | 说明 |
|--------|------|
| 新增 config_group | 未来如有新的策略参数需从 campaigns 表迁出，只需 3 步：(1) `STRATEGY_DEFAULTS` 加记录 (2) 引擎 Stage 改读取源为 `DynamicConfigLoader.getValue()` (3) 迁移文件搬数据+删列 |
| `DynamicConfigLoader` 缓存 TTL | 当前 5 分钟 TTL，可通过 env `STRATEGY_CONFIG_CACHE_TTL` 调整（毫秒） |
| 唯一约束含 priority 列 | `uk_strategy_campaign_group_key_priority` 包含 `priority`，支持同一 group+key 有多条不同优先级的记录（灰度/AB 测试场景已在用） |
| 活动级隔离 | `DynamicConfigLoader` 按 `lottery_campaign_id` 隔离缓存和配置，天然支持多活动独立策略 |

### 11.3 Web 管理前端可复用

| 能力 | 所在文件 | 复用方式 |
|------|----------|----------|
| 策略开关页面的 Alpine.js 组件 | `admin/src/modules/lottery/composables/strategy.js` | 已有 `loadActivityStrategyConfig()` / `updateStrategyConfig()` 方法，新 config_group 直接加 UI 控件绑定 |
| 活动策略开关 Tab 已有布局 | `admin/lottery-management.html` L1174-1400+ | 活动选择器 + 策略分组列表 + 编辑控件，新分组直接嵌入 |
| on/off 开关 + 数字输入框 + 下拉选择 UI 模式 | 同上 | Tailwind 样式已封装，guarantee/preset/tier_fallback 直接复用同样的控件模式 |
| `loadAvailableSegmentVersions()` 方法 | `admin/src/modules/lottery/composables/campaigns.js` L205-225 | 已实现，调用 `GET /api/v4/console/segment-rules`，搬到策略页面即可 |
| API 调用封装 `apiGet` / `apiPost` | `admin/src/alpine/mixins/` | 统一的请求/响应/错误处理，新增的 API 调用直接复用 |

---

## 十二、决策点（全部已确认 2026-02-24）

| # | 决策 | 结论 | 理由 |
|---|------|------|------|
| 1 | 活动 26 重复记录清理 | **清理**（DELETE id=74,79） | 保持数据干净，迁移后每活动 30 条统一 |
| 2 | Part A-D 合并还是分开 | **合并为一个迁移文件** | 原子性好，回滚简单，一次事务完成 |
| 3 | 迁移后是否立即删列 | **一步到位**（插数据+改代码+删列） | 项目未上线，不留旧字段，降低长期维护成本 |
| 4 | guarantee 从活动编辑表单移除 | **完全移除**，统一到策略开关 Tab | 现有 guarantee UI（开关/间隔/奖品/触发率计算）迁移到策略 Tab 复用 |
| 5 | preset_debt_enabled 从 campaign-budget API 剥离 | **直接删除**，不做兼容 | 项目未上线，不背兼容债务 |

---

## 十三、行业方案对比与技术路线评估

> 对比大厂（美团/腾讯/阿里）、游戏公司、活动策划平台、虚拟物品交易平台的策略配置管理方案，评估本项目当前方案在行业中的定位。

### 13.1 行业六大方案横向对比

| 方案 | 代表公司/产品 | 核心架构 | 适用规模 | 配置热更新 | 审计追踪 | 灰度/AB 测试 | 运维成本 |
|------|-------------|----------|----------|-----------|---------|-------------|---------|
| **A. 独立配置中心** | 携程 Apollo、阿里 Nacos、美团 Lion | 独立服务，HTTP 长轮询/推送，命名空间隔离 | 100+ 微服务，百万级配置项 | 秒级推送 | 内置完整审计 | 原生支持灰度发布 | **高**：需独立部署、集群运维 |
| **B. EAV 策略配置表** | 途牛 RBZ 运营系统、GS2-Lottery 抽卡系统、**本项目** | 数据库表 `entity_id + group + key + value`，应用层缓存 | 单体/少量服务，千级配置项 | 缓存 TTL（本项目 5 分钟） | 需自行实现 | priority 列支持 | **低**：无额外基础设施 |
| **C. DDD 策略领域分表** | 小傅哥大营销平台、美团抽奖中台 | 每种策略独立表（strategy_rule, strategy_award…），责任链模式 | 大型营销中台，多 BU 共用 | 按表粒度刷新 | 按表独立审计 | 需额外逻辑 | **中**：表多，迁移频繁 |
| **D. JSON 列存储** | 早期创业项目、快速原型 | 实体表加 JSON 列存全部配置 | 极小规模，快速验证 | 整体覆写 | 无法细粒度审计 | 不支持 | **极低** |
| **E. Excel/CSV → 数据库** | Metaplay（游戏）、Scorewarrior | 策划填表 → 版本库 → 编译为二进制 → CDN 分发 | 游戏行业，数百张策划表 | 热更新包 | Git 版本控制 | 分支合并 | **中**：需工具链 |
| **F. Feature Flag SaaS** | LaunchDarkly、Flagsmith、Unleash | 外部 SaaS，SDK 集成，按用户/环境开关 | SaaS 产品功能开关 | 实时 | 内置 | 原生支持 | **中**：按量付费 |

### 13.2 各行业实际选择

**大公司（美团/腾讯/阿里/京东）：**

- **营销中台**采用方案 C（DDD 分表）+ 方案 A（配置中心）的组合：策略规则用独立表建模（strategy 表 + strategy_rule 表 + strategy_award 表），全局开关和环境变量走 Apollo/Nacos
- 典型架构：`活动表 → 策略表 → 策略规则表 → 奖品表`，通过责任链（前置规则 → 中置规则 → 后置规则）串联
- **为什么这么做**：多 BU 共用中台，每个 BU 有不同的规则模型，需要强类型表结构保证数据完整性
- **代价**：表数量 10-20 张，每新增一种策略可能需要新建表 + 迁移，团队 5-10 人维护

**游戏公司（米哈游/网易/Metaplay/GS2）：**

- 抽卡/Gacha 系统采用方案 B（EAV 策略表）或方案 E（Excel 工具链）：
  - GS2-Lottery：`prize_table + prize_table_item`，权重概率分配，支持嵌套最多 5 层（SSR/SR/R 分层）
  - Metaplay：策划用 Google Sheets 编辑 → 编译为 GameConfig 二进制 → CDN 热更新
  - 国内手游：通常用 Excel 策划表 → JSON → 数据库，运行时按 config_key 读取
- **为什么这么做**：策划频繁调数值（概率/保底/权重），需要非程序员可编辑的界面
- **关键特征**：保底机制（Pity System）是标配，与本项目的 Pity + Guarantee 双保底设计一致

**小公司/创业项目：**

- 初期用方案 D（JSON 列）快速上线，后期迁移到方案 B（EAV 表）
- 典型路径：`.env 硬编码 → 数据库 JSON 列 → EAV 配置表 → 引入缓存层`
- 本项目已经跳过了前两步，直接处于 EAV + 缓存层阶段

**虚拟物品交易/二手平台（Steam Community Market, 闲鱼, 转转）：**

- 交易规则配置采用方案 B 变体：`config_group=交易手续费/上架规则/审核策略`，按品类隔离
- 价格策略用独立的 pricing_rule 表（更接近方案 C），但策略开关仍用 EAV 表管理
- NFT 交易平台（OpenSea, NFTGo）使用链上合约参数 + 链下配置数据库的混合模式

**活动策划公司/营销 SaaS（有赞/微盟/欢乐逛）：**

- 采用方案 B + 模板化：预设活动模板（大转盘/九宫格/刮刮卡），每个模板有标准化的配置参数表
- 运营通过可视化后台编辑参数，底层存储为 EAV 或 JSON
- 与本项目的"策略开关页面"设计理念一致

### 13.3 本项目方案在行业坐标中的定位

```
配置复杂度 ↑
              │
  方案A+C     │ ● 美团营销中台（10-20张表，Apollo配置中心）
  大厂中台    │ ● 阿里活动平台（DDD领域分表 + Nacos）
              │
              │
  方案B+缓存  │ ★ 本项目（EAV策略表 + DynamicConfigLoader 5分钟缓存）
  中型系统    │ ● GS2-Lottery（prize_table EAV + 权重）
              │ ● 途牛RBZ运营系统（EAV + 动态表单）
              │ ● 有赞/微盟活动系统
              │
  方案D/JSON  │ ● 早期创业项目
  小型系统    │ ● MVP快速验证
              │
              └──────────────────────────────────→ 团队规模
                1-3人          5-10人          20+人
```

**本项目处于"中型系统最佳实践区"**：

- 比方案 D（JSON 列）更强：有细粒度审计、priority 支持、活动级隔离
- 比方案 A+C（大厂中台）更轻：无需独立配置中心服务、无需 DDD 分表
- 与游戏行业抽卡系统同级：GS2-Lottery 的 prize_table 就是 EAV 模式
- 与营销 SaaS 同级：有赞/微盟的活动参数管理采用相似模式

### 13.4 为什么本项目不需要升级到方案 A 或方案 C

| 维度 | 大厂方案 A+C 的前提 | 本项目实际情况 | 结论 |
|------|-------------------|---------------|------|
| 服务数量 | 100+ 微服务需要统一配置分发 | 单体 Express 应用，所有配置在同一进程内 | 不需要独立配置中心 |
| 配置项数量 | 百万级配置项，秒级推送 | 30 条/活动 × 4 活动 = 120 条，5 分钟缓存够用 | EAV 表 + 缓存足够 |
| 团队规模 | 5-10 人维护中台，多 BU 共用 | 小团队，单业务线 | 不需要 DDD 分表隔离 |
| 策略类型数 | 10+ 种策略，各有不同的数据模型 | 13 种策略，数据模型统一（group+key+value） | EAV 模式天然支持 |
| 配置变更频率 | 每天 50 万+ 次变更 | 运营偶尔调整策略开关 | 无需秒级推送 |

**DynamicConfigLoader 已经是本项目规模下的"迷你 Apollo"**：

- Apollo 核心能力：DB 存储 → 缓存 → 推送/轮询 → 本地降级
- DynamicConfigLoader：DB 存储（Sequelize）→ 5 分钟 TTL 缓存（内存 Map）→ env 降级 → 代码默认值
- 功能上 1:1 对应，只是不需要独立部署

### 13.5 本项目的技术优势（行业对比视角）

| 行业常见问题 | 本项目已有的解决方案 | 对应能力 |
|-------------|-------------------|---------|
| 配置散落在多张表，管理入口分散 | **本次迁移正在解决** — 从 campaigns 表集中到 strategy_config 表 | 迁移后 13 种策略统一在策略开关页面管理 |
| 配置变更无审计，出问题无法追溯 | AuditLogService 已接入 PUT strategy-config | 自动记录操作人、变更前后值、时间 |
| 缓存一致性问题（改了配置不生效） | DynamicConfigLoader.clearCache() 在 PUT 路由 L577 调用 | 更新配置后立即清缓存，下次请求读新值 |
| 新增策略需要改表结构 | EAV 模式不需要 DDL，只需插入新 config_group 的记录 | 扩展零迁移成本 |
| 多活动互相干扰 | 按 lottery_campaign_id 隔离，唯一约束保障 | 改活动 1 不影响活动 25/26/27 |
| 保底机制缺失或单一 | Pity（连续空奖保底）+ Guarantee（固定间隔保底）双保底 | 游戏行业标配，本项目已实现 |
| A/B 测试无基础设施 | priority 列 + grayscale 配置组 | 同一 group+key 可按 priority 叠加多条记录 |

### 13.6 结论：当前方案是本项目最优解

**不需要升级的理由：**

1. **方案 B（EAV 策略表 + 应用层缓存）是本项目体量的行业最佳实践**，与途牛、GS2-Lottery、有赞等同规模系统采用相同模式
2. **DynamicConfigLoader 已覆盖 Apollo 的核心能力**（DB → 缓存 → 降级），不需要引入独立配置中心服务
3. **迁移方向完全正确**：从散落字段 → 集中 EAV 表，与行业演进路径"配置外部化 → 配置集中化 → 配置动态化"一致
4. **Pipeline 架构 + 策略开关页面**的组合，功能上等同于大厂的"责任链模式 + 运营后台"，只是实现更轻量

**如果未来需要升级的触发条件：**

| 触发条件 | 升级方向 |
|---------|---------|
| 配置项 > 1000 条，需要秒级生效 | 引入 Redis Pub/Sub 替代 TTL 轮询 |
| 拆分为微服务架构 | 考虑 Nacos 统一配置管理 |
| 多 BU 共用营销中台 | DDD 分表（strategy_rule 独立表） |
| 非技术人员频繁编辑策略参数 | 可视化规则引擎（类似有赞活动编辑器） |

当前阶段这些条件均不满足，保持现有架构即可。
