# äº‹åŠ¡è¾¹ç•Œæ²»ç†ç°çŠ¶æ ¸æŸ¥æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2026-01-03  
**æ ¸æŸ¥èŒƒå›´**: åç«¯ä»£ç  + çœŸå®æ•°æ®åº“ï¼ˆrestaurant_points_devï¼‰  
**æ ¸æŸ¥æ–¹æ³•**: ä»£ç é™æ€åˆ†æ + Node.jsç›´è¿MySQLæ•°æ®éªŒè¯  
**æ ¸æŸ¥ç›®æ ‡**: éªŒè¯æŠ€æœ¯å€ºåŠ¡æŠ¥å‘Šä¸­æåˆ°çš„"ä¸‰ç§äº‹åŠ¡æ¨¡å¼å¹¶å­˜"é—®é¢˜æ˜¯å¦çœŸå®å­˜åœ¨

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

### æ ¸å¿ƒå‘ç°

1. **äº‹åŠ¡æ¨¡å¼å¹¶å­˜é—®é¢˜ âœ… ç¡®è®¤å­˜åœ¨**
   - ä»£ç å±‚é¢ç¡®å®å­˜åœ¨ä¸‰ç§äº‹åŠ¡å¤„ç†æ¨¡å¼å¹¶å­˜çš„æƒ…å†µ
   - ä½†å…³é”®ä¸šåŠ¡é“¾è·¯ï¼ˆæŠ½å¥–ã€å…‘æ¢ã€äº¤æ˜“ï¼‰å·²åšäº†è¾ƒå¥½çš„äº‹åŠ¡ä¼ é€’
   - æ–°å¼•å…¥çš„ `TransactionManager` å’Œ `TransactionContext` å°šæœªå…¨åŸŸç»Ÿä¸€

2. **çœŸå®æ•°æ®ä¸€è‡´æ€§ âœ… å½“å‰è‰¯å¥½**
   - æ–°è´¦æœ¬å¯ç”¨åï¼ˆ2026-01-02 20:24:20ä¹‹åï¼‰çš„æ•°æ®ä¸€è‡´æ€§è‰¯å¥½
   - æœªå‘ç°"æŠ½å¥–æˆåŠŸä½†æ‰£æ¬¾ç¼ºå¤±"ç­‰éƒ¨åˆ†æˆåŠŸçš„è¯æ®
   - å†å²æ•°æ®ï¼ˆ2025-10-02 ~ 2026-01-02ï¼‰å› è´¦æœ¬è¿ç§»åˆ†ç•Œæ— æ³•ç›´æ¥å¯¹è´¦

3. **æ½œåœ¨é£é™©ç‚¹ âš ï¸ éœ€è¦æ²»ç†**
   - å¤šä¸ªæœåŠ¡æ–¹æ³•æ”¯æŒ"å¯é€‰ transaction å‚æ•°"ï¼Œå­˜åœ¨è°ƒç”¨æ–¹å¿˜ä¼ å¯¼è‡´è„±ç¦»äº‹åŠ¡çš„é£é™©
   - éƒ¨åˆ†æœåŠ¡æ–¹æ³•æ— æ¡ä»¶è‡ªå»ºäº‹åŠ¡ï¼Œè‹¥è¢«å¤–å±‚äº‹åŠ¡åŒ…è£¹è°ƒç”¨ä¼šå½¢æˆåµŒå¥—äº‹åŠ¡
   - ç¼ºå°‘é™æ€æ£€æŸ¥æœºåˆ¶é˜²æ­¢"å¿˜ä¼  transaction"

---

## 1. æŠ€æœ¯æ ˆä¸äº‹åŠ¡åŸºç¡€è®¾æ–½ç¡®è®¤

### 1.1 æ ¸å¿ƒæŠ€æœ¯æ ˆ

```javascript
// package.json ç¡®è®¤çš„å…³é”®ä¾èµ–
{
  "sequelize": "^6.35.0",      // ORMå±‚
  "mysql2": "^3.6.0",           // MySQLé©±åŠ¨
  "dotenv": "^16.3.0"           // ç¯å¢ƒå˜é‡ç®¡ç†
}
```

**Node.jsç‰ˆæœ¬**: `>=20.18.0`

### 1.2 æ•°æ®åº“è¿æ¥é…ç½®

**ç»Ÿä¸€é…ç½®æº**: `config/database.js`  
**ç¯å¢ƒå˜é‡åŠ è½½**: é€šè¿‡ `dotenv` ä» `.env` æ–‡ä»¶è¯»å–

```javascript
// config/database.js å…³é”®é…ç½®
{
  host: process.env.DB_HOST,
  port: process.env.DB_PORT,
  database: process.env.DB_NAME,
  username: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  timezone: '+08:00',                    // åŒ—äº¬æ—¶é—´
  pool: { max: 40, min: 5, acquire: 10000, idle: 60000, evict: 30000 },
  logging: slowQueryLogger                // æ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆé˜ˆå€¼1000msï¼‰
}
```

**å®é™…è¿æ¥éªŒè¯**ï¼ˆé€šè¿‡ Node.js ç›´è¿ï¼‰:

```
æ•°æ®åº“: restaurant_points_dev
ä¸»æœº: test-db-12-mysql-0:3306
è¡¨æ•°é‡: 45
```

### 1.3 äº‹åŠ¡åŸºç¡€è®¾æ–½

é¡¹ç›®ä¸­å­˜åœ¨ä¸‰å±‚äº‹åŠ¡ç®¡ç†æœºåˆ¶ï¼š

#### å±‚çº§1: SequelizeåŸç”Ÿäº‹åŠ¡

```javascript
// ç›´æ¥ä½¿ç”¨ sequelize.transaction()
const transaction = await sequelize.transaction({
  isolationLevel: Transaction.ISOLATION_LEVELS.READ_COMMITTED
})
```

**ä½¿ç”¨ä½ç½®**: éå¸ƒ `services/` ç›®å½•ï¼Œè‡³å°‘50+å¤„

#### å±‚çº§2: TransactionManagerï¼ˆç»Ÿä¸€äº‹åŠ¡ç®¡ç†å™¨ï¼‰

**æ–‡ä»¶**: `utils/TransactionManager.js`

**è®¾è®¡ç›®æ ‡**:

- é›†ä¸­äº‹åŠ¡åˆ›å»ºå’Œæ‰§è¡Œ
- æ™ºèƒ½é‡è¯•ï¼ˆdeadlock/timeoutï¼‰
- é”™è¯¯åˆ†ç±»å’Œè¯Šæ–­

**æ ¸å¿ƒæ–¹æ³•**:

```javascript
TransactionManager.execute(
  async transaction => {
    // ä¸šåŠ¡é€»è¾‘
  },
  { timeout: 30000, maxRetries: 3 }
)
```

**å®é™…ä½¿ç”¨æƒ…å†µ**: âš ï¸ **å°šæœªå…¨åŸŸæ¨å¹¿**ï¼Œå¤§éƒ¨åˆ†æœåŠ¡ä»ç›´æ¥ä½¿ç”¨ `sequelize.transaction()`

#### å±‚çº§3: TransactionContextï¼ˆAsyncLocalStorageè‡ªåŠ¨ä¼ æ’­ï¼‰

**æ–‡ä»¶**: `utils/TransactionContext.js`

**è®¾è®¡ç›®æ ‡**:

- ä½¿ç”¨ Node.js `AsyncLocalStorage` è‡ªåŠ¨ä¼ æ’­äº‹åŠ¡å¯¹è±¡
- æ”¯æŒ `getTransaction({ required: true })` å¼ºåˆ¶è¦æ±‚äº‹åŠ¡å­˜åœ¨

**å®é™…ä½¿ç”¨æƒ…å†µ**: âš ï¸ **å°šæœªå…¨åŸŸé›†æˆ**

---

## 2. ä¸‰ç§äº‹åŠ¡æ¨¡å¼å¹¶å­˜çš„ä»£ç è¯æ®

### 2.1 æ¨¡å¼A: è‡ªç®¡ç†äº‹åŠ¡ï¼ˆæ–¹æ³•å†…éƒ¨è‡ªå»ºã€è‡ªæäº¤/å›æ»šï¼‰

#### è¯æ®1: CustomerServiceSessionService.sendMessage()

**æ–‡ä»¶**: `services/CustomerServiceSessionService.js:479-540`

```javascript
static async sendMessage(session_id, data) {
  const sequelize = CustomerServiceSession.sequelize
  const transaction = await sequelize.transaction({
    isolationLevel: Transaction.ISOLATION_LEVELS.READ_COMMITTED
  })

  try {
    // ... ä¸šåŠ¡é€»è¾‘ï¼ˆä¼šè¯æ¶ˆæ¯åˆ›å»ºã€çŠ¶æ€æ›´æ–°ï¼‰
    await transaction.commit()
    return result
  } catch (error) {
    await transaction.rollback()
    throw error
  }
}
```

**é£é™©åˆ†æ**:

- âœ… æ–¹æ³•æœ¬èº«äº‹åŠ¡è¾¹ç•Œæ¸…æ™°
- âš ï¸ è‹¥è¢«å¤–å±‚äº‹åŠ¡åŒ…è£¹è°ƒç”¨ï¼Œä¼šå½¢æˆåµŒå¥—äº‹åŠ¡
- å½“å‰è°ƒç”¨æ–¹ `AdminCustomerServiceService.sendMessage()` **æœªè‡ªå»ºäº‹åŠ¡**ï¼Œæš‚æ— åµŒå¥—é£é™©

#### è¯æ®2: ConsumptionService.merchantSubmitConsumption()

**æ–‡ä»¶**: `services/ConsumptionService.js:199-350`

```javascript
static async merchantSubmitConsumption(data) {
  const transaction = await sequelize.transaction({
    isolationLevel: Transaction.ISOLATION_LEVELS.READ_COMMITTED
  })

  try {
    // 1. éªŒè¯äºŒç»´ç 
    // 2. åˆ›å»ºæ¶ˆè´¹è®°å½•
    // 3. åˆ›å»ºå®¡æ ¸è®°å½•
    // 4. å†»ç»“ç§¯åˆ†ï¼ˆè°ƒç”¨ AssetService.freezeï¼‰
    await transaction.commit()
    return { consumption_record, review_record }
  } catch (error) {
    await transaction.rollback()
    throw error
  }
}
```

**é£é™©åˆ†æ**:

- âœ… å…¥å£æ–¹æ³•è‡ªå»ºäº‹åŠ¡åˆç†
- âœ… è°ƒç”¨ `AssetService.freeze()` æ—¶æ˜¾å¼ä¼ é€’ `{ transaction }`
- âœ… è°ƒç”¨æ–¹ï¼ˆè·¯ç”±å±‚ï¼‰æœªå†åŒ…äº‹åŠ¡ï¼Œæ— åµŒå¥—é£é™©

### 2.2 æ¨¡å¼B: ä¼ é€’äº‹åŠ¡ï¼ˆå¯é€‰ transaction å‚æ•°ï¼‰

#### è¯æ®1: TradeOrderService.createOrder()

**æ–‡ä»¶**: `services/TradeOrderService.js:179-410`

```javascript
static async createOrder(params, options = {}) {
  const transaction = options.transaction || (await sequelize.transaction())

  try {
    // 1. éªŒè¯æŒ‚ç‰ŒçŠ¶æ€
    // 2. é”å®šæŒ‚ç‰Œ
    // 3. åˆ›å»ºè®¢å•
    // 4. å†»ç»“ä¹°å®¶èµ„äº§ï¼ˆè°ƒç”¨ AssetService.freezeï¼Œä¼ é€’ transactionï¼‰
    await AssetService.freeze({ ... }, { transaction })

    // 5. æ›´æ–°è®¢å•çŠ¶æ€
    if (!options.transaction) {
      await transaction.commit()  // ä»…åœ¨è‡ªå»ºäº‹åŠ¡æ—¶æäº¤
    }
    return { order_id, is_duplicate }
  } catch (error) {
    if (!options.transaction) {
      await transaction.rollback()  // ä»…åœ¨è‡ªå»ºäº‹åŠ¡æ—¶å›æ»š
    }
    throw error
  }
}
```

**é£é™©åˆ†æ**:

- âœ… æ”¯æŒå¤–éƒ¨äº‹åŠ¡ä¼ å…¥ï¼ˆé¿å…åµŒå¥—ï¼‰
- âœ… åªåœ¨è‡ªå»ºäº‹åŠ¡æ—¶æäº¤/å›æ»šï¼ˆæ­£ç¡®æ¨¡å¼ï¼‰
- âœ… è°ƒç”¨ `AssetService.*` æ—¶æ˜¾å¼ä¼ é€’ `transaction`
- âš ï¸ **è‹¥è°ƒç”¨æ–¹å¿˜è®°ä¼  `transaction`ï¼Œä¼šè‡ªå»ºæ–°äº‹åŠ¡**ï¼ˆå¯èƒ½è„±ç¦»å¤–å±‚äº‹åŠ¡è¾¹ç•Œï¼‰

#### è¯æ®2: ExchangeService.exchangeItem()

**æ–‡ä»¶**: `services/ExchangeService.js:352-550`

```javascript
static async exchangeItem(params, options = {}) {
  const externalTransaction = options.transaction
  const transaction = externalTransaction || (await sequelize.transaction())

  try {
    // 1. é”å®šå…‘æ¢å•†å“
    // 2. æ‰£å‡ææ–™èµ„äº§ï¼ˆè°ƒç”¨ AssetService.changeBalanceï¼Œä¼ é€’ transactionï¼‰
    await AssetService.changeBalance({ ... }, { transaction })

    // 3. åˆ›å»ºå…‘æ¢è®°å½•
    if (!externalTransaction) {
      await transaction.commit()
    }
    return result
  } catch (error) {
    if (!externalTransaction) {
      await transaction.rollback()
    }
    throw error
  }
}
```

**é£é™©åˆ†æ**: åŒ `TradeOrderService`

#### è¯æ®3: AssetService.changeBalance()

**æ–‡ä»¶**: `services/AssetService.js:237-430`

```javascript
static async changeBalance(params, options = {}) {
  const externalTransaction = options.transaction
  const transaction = externalTransaction || (await sequelize.transaction())

  try {
    // 1. å¹‚ç­‰æ€§æ£€æŸ¥
    // 2. è´¦æˆ·é”å®š
    // 3. ä½™é¢å˜æ›´
    // 4. åˆ›å»ºæµæ°´è®°å½•

    if (!externalTransaction) {
      await transaction.commit()
    }
    return { transaction_record, new_balance, is_duplicate }
  } catch (error) {
    if (!externalTransaction) {
      await transaction.rollback()
    }
    throw error
  }
}
```

**ç‰¹åˆ«æ³¨æ„**: `AssetService` è¿˜åŒ…å« `checkTransactionBoundary()` è­¦å‘Šå‡½æ•°ï¼Œè¯´æ˜å›¢é˜Ÿå·²æ„è¯†åˆ°"å¿˜ä¼  transaction"çš„é£é™©

### 2.3 æ¨¡å¼C: ç»Ÿä¸€äº‹åŠ¡ç®¡ç†å™¨ï¼ˆTransactionManagerï¼‰

#### è®¾è®¡æ„å›¾

**æ–‡ä»¶**: `utils/TransactionManager.js`

```javascript
class TransactionManager {
  static async execute(operation, options = {}) {
    const { timeout = 30000, maxRetries = 3 } = options

    for (let attempt = 0; attempt < maxRetries; attempt++) {
      const transaction = await sequelize.transaction({
        isolationLevel: Transaction.ISOLATION_LEVELS.READ_COMMITTED
      })

      try {
        const result = await operation(transaction)
        await transaction.commit()
        return result
      } catch (error) {
        await transaction.rollback()

        const errorType = this.analyzeError(error)
        if (errorType.retryable && attempt < maxRetries - 1) {
          await delay(exponentialBackoff(attempt))
          continue
        }
        throw error
      }
    }
  }
}
```

**å®é™…ä½¿ç”¨æƒ…å†µ**: âš ï¸ **å‡ ä¹æœªè¢«é‡‡ç”¨**

é€šè¿‡å…¨ä»“æœç´¢ `TransactionManager.execute`ï¼Œæœªå‘ç°å®é™…ä¸šåŠ¡ä»£ç è°ƒç”¨æ­¤æ–¹æ³•ã€‚

---

## 3. çœŸå®æ•°æ®åº“éªŒè¯ç»“æœ

### 3.1 æ•°æ®åº“è¿æ¥ä¸è¡¨ç»“æ„ç¡®è®¤

**è¿æ¥å‘½ä»¤**ï¼ˆé€šè¿‡ Node.js + dotenvï¼‰:

```bash
node -r dotenv/config -e "(async()=>{
  const {sequelize}=require('./config/database');
  await sequelize.authenticate();
  // ...
})()"
```

**æ ¸å¿ƒä¸šåŠ¡è¡¨æ•°æ®é‡**:

| è¡¨å                     | è¡Œæ•° | è¯´æ˜                   |
| ------------------------ | ---- | ---------------------- |
| `users`                  | 22   | ç”¨æˆ·è¡¨                 |
| `lottery_draws`          | 2841 | æŠ½å¥–è®°å½•               |
| `lottery_campaigns`      | 1    | æŠ½å¥–æ´»åŠ¨               |
| `lottery_prizes`         | 9    | å¥–å“é…ç½®               |
| `asset_transactions`     | 216  | **èµ„äº§æµæ°´ï¼ˆæ–°è´¦æœ¬ï¼‰** |
| `accounts`               | 13   | è´¦æˆ·è¡¨                 |
| `account_asset_balances` | 11   | è´¦æˆ·ä½™é¢è¡¨             |
| `consumption_records`    | 184  | æ¶ˆè´¹è®°å½•               |
| `content_review_records` | 184  | å®¡æ ¸è®°å½•               |
| `item_instances`         | 1211 | ç‰©å“å®ä¾‹               |
| `item_instance_events`   | 301  | ç‰©å“äº‹ä»¶               |
| `trade_orders`           | 0    | äº¤æ˜“è®¢å•ï¼ˆæ— æ•°æ®ï¼‰     |
| `market_listings`        | 1    | å¸‚åœºæŒ‚ç‰Œ               |
| `exchange_records`       | 0    | å…‘æ¢è®°å½•ï¼ˆæ— æ•°æ®ï¼‰     |
| `exchange_items`         | 24   | å…‘æ¢å•†å“é…ç½®           |

**å…³é”®å‘ç°**:

- âŒ æ—§è´¦æœ¬è¡¨ **ä¸å­˜åœ¨**: `points_transactions`, `user_points_accounts`, `user_inventory` ç­‰
- âœ… å½“å‰ç§¯åˆ†/èµ„äº§çœŸç›¸æº: `asset_transactions` + `account_asset_balances`

### 3.2 è´¦æœ¬è¿ç§»åˆ†ç•Œçº¿è¯†åˆ«

**asset_transactions æ—¶é—´èŒƒå›´**:

```sql
SELECT MIN(created_at), MAX(created_at) FROM asset_transactions;
-- ç»“æœ: 2026-01-02 20:24:20 ~ 2026-01-03 04:23:32
```

**lottery_draws æ—¶é—´èŒƒå›´**:

```sql
SELECT MIN(created_at), MAX(created_at) FROM lottery_draws;
-- ç»“æœ: 2025-10-02 01:24:29 ~ 2026-01-03 01:50:21
```

**å…³é”®ç»“è®º**:

- æ–°è´¦æœ¬å¯ç”¨æ—¶é—´: **2026-01-02 20:24:20**
- å¤§é‡æŠ½å¥–è®°å½•ï¼ˆ2840æ¡ï¼‰å‘ç”Ÿåœ¨æ–°è´¦æœ¬å¯ç”¨å‰
- åªæœ‰ **1æ¡** æŠ½å¥–è®°å½•å‘ç”Ÿåœ¨æ–°è´¦æœ¬å¯ç”¨å

### 3.3 æ–°è´¦æœ¬å¯ç”¨åçš„æ•°æ®ä¸€è‡´æ€§éªŒè¯

#### éªŒè¯1: æŠ½å¥–æ‰£æ¬¾ä¸€è‡´æ€§

**æŸ¥è¯¢é€»è¾‘**:

```sql
-- æ–°è´¦æœ¬å¯ç”¨åçš„æŠ½å¥–è®°å½•
SELECT COUNT(*), SUM(cost_points)
FROM lottery_draws
WHERE created_at >= '2026-01-02 20:24:20';
-- ç»“æœ: 1æ¡, æ€»æ‰£æ¬¾100

-- æ–°è´¦æœ¬å¯ç”¨åçš„æŠ½å¥–æ‰£æ¬¾æµæ°´
SELECT COUNT(*), SUM(delta_amount)
FROM asset_transactions
WHERE business_type = 'lottery_consume'
  AND created_at >= '2026-01-02 20:24:20';
-- ç»“æœ: 1æ¡, æ€»é‡‘é¢-100
```

**ç»“è®º**: âœ… **å®Œå…¨ä¸€è‡´ï¼Œæ— éƒ¨åˆ†æˆåŠŸè¯æ®**

#### éªŒè¯2: æ¶ˆè´¹å¥–åŠ±å‘æ”¾ä¸€è‡´æ€§

**æŸ¥è¯¢é€»è¾‘**:

```sql
-- æ¶ˆè´¹è®°å½•çŠ¶æ€åˆ†å¸ƒ
SELECT status, COUNT(*) FROM consumption_records GROUP BY status;
-- ç»“æœ: pending(79), approved(55), rejected(50)

-- å®¡æ ¸è®°å½•çŠ¶æ€åˆ†å¸ƒ
SELECT audit_status, COUNT(*) FROM content_review_records GROUP BY audit_status;
-- ç»“æœ: pending(79), approved(55), rejected(50)
```

**çŠ¶æ€ä¸€è‡´æ€§**: âœ… æ¶ˆè´¹è®°å½•ä¸å®¡æ ¸è®°å½•çŠ¶æ€å®Œå…¨å¯¹åº”

**ä½†æ˜¯**:

```sql
-- æ–°è´¦æœ¬å¯ç”¨åçš„æ¶ˆè´¹å¥–åŠ±æµæ°´
SELECT COUNT(*), SUM(delta_amount)
FROM asset_transactions
WHERE business_type = 'consumption_reward'
  AND created_at >= '2026-01-02 20:24:20';
-- ç»“æœ: 0æ¡
```

**åŸå› åˆ†æ**:

- æ‰€æœ‰æ¶ˆè´¹è®°å½•çš„æ—¶é—´èŒƒå›´: `2025-10-31 ~ 2025-12-31`ï¼ˆæ—©äºæ–°è´¦æœ¬å¯ç”¨ï¼‰
- æ–°è´¦æœ¬å¯ç”¨åï¼ˆ2026-01-02ä¹‹åï¼‰**æ²¡æœ‰æ–°çš„æ¶ˆè´¹è®°å½•äº§ç”Ÿ**
- å› æ­¤æ²¡æœ‰å¯¹åº”çš„ `consumption_reward` æµæ°´æ˜¯æ­£å¸¸çš„

#### éªŒè¯3: èµ„äº§æµæ°´ç±»å‹åˆ†å¸ƒ

```sql
SELECT business_type, COUNT(*), SUM(delta_amount)
FROM asset_transactions
GROUP BY business_type;
```

| business_type      | æ•°é‡ | æ€»é‡‘é¢ |
| ------------------ | ---- | ------ |
| `exchange_debit`   | 95   | -9500  |
| `test_recharge`    | 94   | +9400  |
| `admin_adjustment` | 26   | +650   |
| `lottery_consume`  | 1    | -100   |

**åˆ†æ**:

- âœ… å…‘æ¢æ‰£æ¬¾æµæ°´æ­£å¸¸
- âœ… æµ‹è¯•å……å€¼æµæ°´æ­£å¸¸
- âš ï¸ ç¼ºå°‘ `consumption_reward`ï¼ˆåŸå› ï¼šæ¶ˆè´¹è®°å½•éƒ½åœ¨æ–°è´¦æœ¬å¯ç”¨å‰ï¼‰
- âš ï¸ ç¼ºå°‘ `lottery_reward`ï¼ˆå¯èƒ½å¥–å“å‘æ”¾èµ°çš„æ˜¯ `item_instances` è€Œéèµ„äº§æµæ°´ï¼‰

---

## 4. åµŒå¥—äº‹åŠ¡é£é™©ç‚¹åˆ†æ

### 4.1 æ½œåœ¨åµŒå¥—äº‹åŠ¡åœºæ™¯

#### åœºæ™¯1: AdminCustomerServiceService â†’ CustomerServiceSessionService

**è°ƒç”¨é“¾**:

```
routes/v4/system/chat.js
  â†’ AdminCustomerServiceService.sendMessage()
    â†’ CustomerServiceSessionService.sendMessage()  // å†…éƒ¨è‡ªå»ºäº‹åŠ¡
```

**å½“å‰çŠ¶æ€**: âœ… **æ— åµŒå¥—é£é™©**

- `AdminCustomerServiceService.sendMessage()` æœªè‡ªå»ºäº‹åŠ¡
- ç›´æ¥è°ƒç”¨ `CustomerServiceSessionService.sendMessage()`

**æ½œåœ¨é£é™©**: âš ï¸ è‹¥æœªæ¥æœ‰äººç»™ `AdminCustomerServiceService` åŠ äº‹åŠ¡åŒ…è£¹ï¼Œä¼šç«‹å³å½¢æˆåµŒå¥—

#### åœºæ™¯2: è‹¥ AssetService è¢«å¿˜ä¼  transaction

**è°ƒç”¨é“¾**:

```
æŸæœåŠ¡æ–¹æ³•ï¼ˆè‡ªå»ºäº‹åŠ¡ï¼‰
  â†’ AssetService.changeBalance()  // å¿˜è®°ä¼  { transaction }
    â†’ å†…éƒ¨è‡ªå»ºæ–°äº‹åŠ¡å¹¶æäº¤  // å¤–å±‚å›æ»šä¸å½±å“æ­¤æäº¤
```

**å®é™…æƒ…å†µ**: âœ… **å…³é”®é“¾è·¯éƒ½ä¼ äº† transaction**

- `TradeOrderService` â†’ `AssetService.freeze/settleFromFrozen/changeBalance` âœ… ä¼ é€’
- `ExchangeService` â†’ `AssetService.changeBalance` âœ… ä¼ é€’
- `ConsumptionService` â†’ `AssetService.freeze` âœ… ä¼ é€’

**ä½†æ˜¯**: âš ï¸ **ç¼ºå°‘é™æ€æ£€æŸ¥æœºåˆ¶**ï¼Œæ— æ³•é˜²æ­¢æœªæ¥æœ‰äººå¿˜è®°ä¼ 

### 4.2 "å¿˜ä¼  transaction"é«˜å±æ–¹æ³•æ¸…å•

ä»¥ä¸‹æœåŠ¡æ–¹æ³•æ”¯æŒ `options.transaction`ï¼Œè‹¥è°ƒç”¨æ–¹å¿˜è®°ä¼ é€’ä¼šè‡ªå»ºæ–°äº‹åŠ¡ï¼š

| æœåŠ¡                | æ–¹æ³•                 | æ–‡ä»¶ä½ç½®                            | é£é™©ç­‰çº§  |
| ------------------- | -------------------- | ----------------------------------- | --------- |
| `AssetService`      | `changeBalance()`    | `services/AssetService.js:237`      | ğŸ”´ HIGH   |
| `AssetService`      | `freeze()`           | `services/AssetService.js:438`      | ğŸ”´ HIGH   |
| `AssetService`      | `unfreeze()`         | `services/AssetService.js:627`      | ğŸ”´ HIGH   |
| `AssetService`      | `settleFromFrozen()` | `services/AssetService.js:816`      | ğŸ”´ HIGH   |
| `TradeOrderService` | `createOrder()`      | `services/TradeOrderService.js:179` | ğŸŸ¡ MEDIUM |
| `TradeOrderService` | `completeOrder()`    | `services/TradeOrderService.js:434` | ğŸŸ¡ MEDIUM |
| `TradeOrderService` | `cancelOrder()`      | `services/TradeOrderService.js:712` | ğŸŸ¡ MEDIUM |
| `ExchangeService`   | `exchangeItem()`     | `services/ExchangeService.js:352`   | ğŸŸ¡ MEDIUM |
| `PrizePoolService`  | `batchAddPrizes()`   | `services/PrizePoolService.js:108`  | ğŸŸ  LOW    |

**é£é™©ç­‰çº§è¯´æ˜**:

- ğŸ”´ **HIGH**: åº•å±‚èµ„äº§æ“ä½œæœåŠ¡ï¼Œè¢«å¤šå¤„è°ƒç”¨ï¼Œå¿˜ä¼ å½±å“é¢å¤§
- ğŸŸ¡ **MEDIUM**: ä¸šåŠ¡ç¼–æ’æœåŠ¡ï¼Œé€šå¸¸ç”±è·¯ç”±å±‚ç›´æ¥è°ƒç”¨ï¼Œå¿˜ä¼ æ¦‚ç‡è¾ƒä½
- ğŸŸ  **LOW**: é…ç½®ç±»æ“ä½œï¼Œè°ƒç”¨é¢‘ç‡ä½

---

## 5. ä¸šåŠ¡é€»è¾‘ä¸å•†ä¸šæ¨¡å¼æ€»ç»“

### 5.1 æ ¸å¿ƒç»æµé“¾è·¯

#### é“¾è·¯1: ç§¯åˆ†æ¶ˆè´¹æŠ½å¥–

```
ç”¨æˆ·æ¶ˆè€— POINTS (100åˆ†/æ¬¡)
  â†’ lottery_draws è®°å½•æŠ½å¥–ç»“æœ
  â†’ asset_transactions (business_type='lottery_consume', delta_amount=-100)
  â†’ ä¸­å¥–åç”Ÿæˆ item_instancesï¼ˆç‰©å“å®ä¾‹ï¼‰
  â†’ item_instance_events è®°å½•ç‰©å“æµè½¬
```

**äº‹åŠ¡è¾¹ç•Œ**: `UnifiedLotteryEngine.execute_draw()` è‡ªå»ºäº‹åŠ¡ï¼ŒåŒ…å«ï¼š

- æ‰¹é‡æŠ½å¥–å¾ªç¯
- ç»Ÿä¸€ç§¯åˆ†æ‰£å‡ï¼ˆä¸€æ¬¡æ€§æ‰£å‡ N Ã— cost_pointsï¼‰
- å¥–å“å‘æ”¾ï¼ˆè°ƒç”¨å„ç­–ç•¥çš„ `executeLottery`ï¼‰

**ä¸€è‡´æ€§çŠ¶æ€**: âœ… æ–°è´¦æœ¬å¯ç”¨åæ•°æ®ä¸€è‡´

#### é“¾è·¯2: å•†å®¶æ¶ˆè´¹å½•å…¥ â†’ å®¡æ ¸ â†’ å‘æ”¾ç§¯åˆ†

```
å•†å®¶æäº¤æ¶ˆè´¹è®°å½•
  â†’ consumption_records (status='pending')
  â†’ content_review_records (audit_status='pending')
  â†’ å†»ç»“ç§¯åˆ†ï¼ˆé¢„ç•™å¥–åŠ±é¢åº¦ï¼‰

ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡
  â†’ consumption_records (status='approved')
  â†’ content_review_records (audit_status='approved')
  â†’ asset_transactions (business_type='consumption_reward', delta_amount=+å¥–åŠ±ç§¯åˆ†)
  â†’ asset_transactions (business_type='consumption_budget_allocation', asset_code='BUDGET_POINTS')
```

**äº‹åŠ¡è¾¹ç•Œ**:

- æäº¤: `ConsumptionService.merchantSubmitConsumption()` è‡ªå»ºäº‹åŠ¡
- å®¡æ ¸: `ConsumptionService.approveConsumption()` è‡ªå»ºäº‹åŠ¡

**ä¸€è‡´æ€§çŠ¶æ€**: âœ… æ¶ˆè´¹è®°å½•ä¸å®¡æ ¸è®°å½•çŠ¶æ€å®Œå…¨å¯¹åº”ï¼ˆ184æ¡ï¼‰

#### é“¾è·¯3: ææ–™å…‘æ¢å®ç‰©

```
ç”¨æˆ·é€‰æ‹©å…‘æ¢å•†å“ï¼ˆæ¶ˆè€—ææ–™èµ„äº§ï¼‰
  â†’ exchange_items æŸ¥è¯¢å•†å“é…ç½®
  â†’ asset_transactions (business_type='exchange_debit', delta_amount=-ææ–™æ•°é‡)
  â†’ exchange_records åˆ›å»ºå…‘æ¢è®°å½•
  â†’ åç»­ç‰©æµå‘è´§æµç¨‹
```

**äº‹åŠ¡è¾¹ç•Œ**: `ExchangeService.exchangeItem()` è‡ªå»ºäº‹åŠ¡

**ä¸€è‡´æ€§çŠ¶æ€**: âœ… å…‘æ¢æ‰£æ¬¾æµæ°´æ­£å¸¸ï¼ˆ95æ¡ï¼Œ-9500ï¼‰

#### é“¾è·¯4: DIAMOND äº¤æ˜“å¸‚åœºï¼ˆå½“å‰ç¯å¢ƒæ— æ•°æ®ï¼‰

```
å–å®¶æŒ‚ç‰Œï¼ˆç‰©å“æˆ–å¯å åŠ èµ„äº§ï¼‰
  â†’ market_listings (status='on_sale')

ä¹°å®¶ä¸‹å•
  â†’ trade_orders (status='created')
  â†’ å†»ç»“ä¹°å®¶ DIAMONDï¼ˆgross_amount = å•†å“ä»·æ ¼ + å¹³å°æ‰‹ç»­è´¹ï¼‰
  â†’ trade_orders (status='frozen')

å®Œæˆäº¤æ˜“
  â†’ ä»å†»ç»“æ‰£å‡ä¹°å®¶ DIAMOND
  â†’ å–å®¶å…¥è´¦ net_amountï¼ˆæ‰£é™¤æ‰‹ç»­è´¹ï¼‰
  â†’ å¹³å°æ‰‹ç»­è´¹å…¥è´¦ï¼ˆsystem_code='SYSTEM_PLATFORM_FEE'ï¼‰
  â†’ è½¬ç§»ç‰©å“æ‰€æœ‰æƒï¼ˆitem_instances.owner_user_idï¼‰
  â†’ trade_orders (status='completed')
  â†’ market_listings (status='sold')
```

**äº‹åŠ¡è¾¹ç•Œ**:

- ä¸‹å•: `TradeOrderService.createOrder()` è‡ªå»ºäº‹åŠ¡
- å®Œæˆ: `TradeOrderService.completeOrder()` è‡ªå»ºäº‹åŠ¡

**ä¸€è‡´æ€§çŠ¶æ€**: âš ï¸ å½“å‰ç¯å¢ƒ `trade_orders=0`ï¼Œæ— æ³•éªŒè¯

### 5.2 åŒè´¦æˆ·æ¨¡å‹ï¼ˆPOINTS + BUDGET_POINTSï¼‰

**å‘ç°**: æ¶ˆè´¹å®¡æ ¸é€šè¿‡æ—¶ä¼šåŒæ—¶å‘æ”¾ä¸¤ç§ç§¯åˆ†ï¼š

1. **POINTS**ï¼ˆç”¨æˆ·ç§¯åˆ†ï¼‰: ç”¨äºæŠ½å¥–æ¶ˆè´¹
2. **BUDGET_POINTS**ï¼ˆé¢„ç®—ç§¯åˆ†ï¼‰: ç”¨äºå¥–å“é¢„ç®—åˆ†é…

**è®¡ç®—å…¬å¼**ï¼ˆæ¥è‡ªä»£ç ï¼‰:

```javascript
// ç”¨æˆ·ç§¯åˆ† = æ¶ˆè´¹é‡‘é¢ Ã— å¥–åŠ±æ¯”ä¾‹ï¼ˆå¦‚ 1å…ƒ = 1åˆ†ï¼‰
const pointsToAward = consumption_amount * reward_ratio

// é¢„ç®—ç§¯åˆ† = æ¶ˆè´¹é‡‘é¢ Ã— é¢„ç®—ç³»æ•°ï¼ˆé»˜è®¤ 0.24ï¼‰
// ä¸šåŠ¡è§„åˆ™: å¹³å°æŠ½æˆ10% â†’ 80%ä½œä¸ºé¢„ç®— â†’ ä»·å€¼ç³»æ•°3å€
const budgetPointsToAllocate = consumption_amount * 0.24
```

---

## 6. æ²»ç†æ–¹æ¡ˆå»ºè®®

### 6.1 P0 - ç«‹å³æ‰§è¡Œï¼ˆå½±å“æ•°æ®ä¸€è‡´æ€§ï¼‰

#### å»ºè®®1: äº‹åŠ¡è¾¹ç•Œè§„èŒƒåŒ–

**ç›®æ ‡**: æ˜ç¡®"å…¥å£ç¼–æ’å±‚"æ¸…å•ï¼Œç»Ÿä¸€äº‹åŠ¡åˆ›å»ºä½ç½®

**å®æ–½æ­¥éª¤**:

1. åˆ—å‡ºæ‰€æœ‰"äº‹åŠ¡å…¥å£"ï¼ˆAPIè·¯ç”±ã€å®šæ—¶ä»»åŠ¡ã€æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è€…ï¼‰
2. å…¥å£å±‚ç»Ÿä¸€ä½¿ç”¨ `TransactionManager.execute()` åˆ›å»ºäº‹åŠ¡
3. æœåŠ¡å±‚é»˜è®¤ä¸è‡ªå»ºäº‹åŠ¡ï¼Œé™¤éå®ƒæœ¬èº«å°±æ˜¯å…¥å£

**ç¤ºä¾‹æ”¹é€ **:

```javascript
// âŒ æ”¹é€ å‰: æœåŠ¡å±‚è‡ªå»ºäº‹åŠ¡
class TradeOrderService {
  static async createOrder(params, options = {}) {
    const transaction = options.transaction || (await sequelize.transaction())
    // ...
  }
}

// âœ… æ”¹é€ å: å…¥å£å±‚ç»Ÿä¸€ç®¡ç†
// routes/v4/market/trade.js
router.post('/orders', async (req, res) => {
  const result = await TransactionManager.execute(async transaction => {
    return await TradeOrderService.createOrder(params, { transaction })
  })
  res.json(result)
})

// services/TradeOrderService.js
class TradeOrderService {
  static async createOrder(params, options = {}) {
    const transaction = options.transaction // å¼ºåˆ¶è¦æ±‚ä¼ å…¥
    if (!transaction) {
      throw new Error('createOrder å¿…é¡»åœ¨äº‹åŠ¡ä¸­è°ƒç”¨')
    }
    // ...
  }
}
```

#### å»ºè®®2: ç¦æ­¢"é™é»˜è„±ç¦»äº‹åŠ¡"

**ç›®æ ‡**: è·¨è¡¨å†™å…¥ç±»æœåŠ¡æ–¹æ³•å¼ºåˆ¶è¦æ±‚ `transaction`

**å®æ–½æ­¥éª¤**:

1. è¯†åˆ«æ‰€æœ‰è·¨è¡¨å†™å…¥æ–¹æ³•ï¼ˆå¦‚ `AssetService.*`ï¼‰
2. ç§»é™¤ `options.transaction || (await sequelize.transaction())` çš„å…œåº•é€»è¾‘
3. æ”¹ä¸ºå¼ºåˆ¶è¦æ±‚ä¼ å…¥æˆ–ä» `TransactionContext` è·å–

**ç¤ºä¾‹æ”¹é€ **:

```javascript
// âŒ æ”¹é€ å‰: å¿˜ä¼ ä¼šè‡ªå»ºäº‹åŠ¡
static async changeBalance(params, options = {}) {
  const transaction = options.transaction || (await sequelize.transaction())
  // ...
}

// âœ… æ”¹é€ å: å¼ºåˆ¶è¦æ±‚ä¼ å…¥
static async changeBalance(params, options = {}) {
  const transaction = options.transaction ||
    TransactionContext.getTransaction({ required: true })

  if (!transaction) {
    throw new Error('changeBalance å¿…é¡»åœ¨äº‹åŠ¡ä¸­è°ƒç”¨ï¼Œè¯·æ£€æŸ¥è°ƒç”¨é“¾')
  }
  // ...
}
```

#### å»ºè®®3: éš”ç¦»"å¿…é¡»è‡ªç®¡ç†äº‹åŠ¡"çš„æ–¹æ³•

**ç›®æ ‡**: æ˜ç¡®æ ‡æ³¨å“ªäº›æ–¹æ³•æ˜¯"å…¥å£çº§"ï¼Œä¸Šå±‚ä¸åº”å†åŒ…äº‹åŠ¡

**å®æ–½æ­¥éª¤**:

1. è¯†åˆ«æ‰€æœ‰æ— æ¡ä»¶è‡ªå»ºäº‹åŠ¡çš„æ–¹æ³•ï¼ˆå¦‚ `CustomerServiceSessionService.sendMessage()`ï¼‰
2. åœ¨æ–¹æ³•æ³¨é‡Šä¸­æ˜ç¡®æ ‡æ³¨ `@transactional-entry`
3. ç¡®ä¿ä¸Šå±‚è°ƒç”¨æ–¹ä¸ä¼šå†åŒ…äº‹åŠ¡

**ç¤ºä¾‹æ ‡æ³¨**:

```javascript
/**
 * å‘é€æ¶ˆæ¯ï¼ˆç®¡ç†å‘˜ç«¯ï¼‰
 *
 * @transactional-entry æ­¤æ–¹æ³•å†…éƒ¨è‡ªç®¡ç†äº‹åŠ¡ï¼Œè°ƒç”¨æ–¹ä¸åº”å†åŒ…äº‹åŠ¡
 * @param {number} session_id - ä¼šè¯ID
 * @param {Object} data - æ¶ˆæ¯æ•°æ®
 */
static async sendMessage(session_id, data) {
  const transaction = await sequelize.transaction({ ... })
  // ...
}
```

### 6.2 P1 - è¿‘æœŸä¼˜åŒ–ï¼ˆæå‡ä»£ç è´¨é‡ï¼‰

#### å»ºè®®4: æ¨å¹¿ TransactionManager å’Œ TransactionContext

**ç›®æ ‡**: ç»Ÿä¸€äº‹åŠ¡ç®¡ç†æœºåˆ¶ï¼Œå‡å°‘æ ·æ¿ä»£ç 

**å®æ–½æ­¥éª¤**:

1. å®Œå–„ `TransactionManager.execute()` çš„é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘
2. åœ¨è·¯ç”±å±‚å…¨é¢æ¨å¹¿ä½¿ç”¨
3. æœåŠ¡å±‚é€šè¿‡ `TransactionContext.getTransaction()` è·å–äº‹åŠ¡

#### å»ºè®®5: æ·»åŠ é™æ€æ£€æŸ¥ï¼ˆESLintè§„åˆ™ï¼‰

**ç›®æ ‡**: é˜²æ­¢"å¿˜ä¼  transaction"

**å®æ–½æ­¥éª¤**:

1. ç¼–å†™è‡ªå®šä¹‰ ESLint è§„åˆ™ï¼Œæ£€æµ‹ä»¥ä¸‹æ¨¡å¼ï¼š

   ```javascript
   // æ£€æµ‹: AssetService.* è°ƒç”¨æ—¶ç¼ºå°‘ { transaction }
   await AssetService.changeBalance(params) // âŒ æŠ¥é”™
   await AssetService.changeBalance(params, { transaction }) // âœ… é€šè¿‡
   ```

2. åœ¨ CI/CD ä¸­å¼ºåˆ¶æ‰§è¡Œ

#### å»ºè®®6: å®Œå–„å•å…ƒæµ‹è¯•è¦†ç›–

**ç›®æ ‡**: éªŒè¯äº‹åŠ¡è¾¹ç•Œæ­£ç¡®æ€§

**æµ‹è¯•åœºæ™¯**:

1. äº‹åŠ¡æäº¤åœºæ™¯ï¼šå¤šè¡¨å†™å…¥æˆåŠŸï¼Œæ•°æ®ä¸€è‡´
2. äº‹åŠ¡å›æ»šåœºæ™¯ï¼šä¸­é—´æ­¥éª¤å¤±è´¥ï¼Œæ‰€æœ‰å†™å…¥å›æ»š
3. åµŒå¥—äº‹åŠ¡æ£€æµ‹ï¼šå¤–å±‚å›æ»šæ—¶ï¼Œå†…å±‚ä¸åº”å·²æäº¤
4. å¿˜ä¼  transactionï¼šåº”æŠ›å‡ºæ˜ç¡®é”™è¯¯è€Œéé™é»˜è‡ªå»ºäº‹åŠ¡

### 6.3 P2 - é•¿æœŸæ”¹è¿›ï¼ˆæŠ€æœ¯å€ºåŠ¡æ¸…ç†ï¼‰

#### å»ºè®®7: æ•°æ®åº“å¯¹è´¦ä¸è¿ç§»å£å¾„

**ç›®æ ‡**: å»ºç«‹ç¨³å®šçš„å¯¹è´¦æœºåˆ¶

**å®æ–½æ­¥éª¤**:

1. ç»™ `lottery_draws` æ·»åŠ  `lottery_session_id` æˆ–è§„èŒƒåŒ– `idempotency_key`
2. ç¡®ä¿æŠ½å¥–è®°å½•ä¸è´¦æœ¬æµæ°´å¯é€šè¿‡å”¯ä¸€é”®å…³è”
3. å¯¹"æ–°è´¦æœ¬å¯ç”¨å‰"çš„å†å²æ•°æ®ï¼š
   - æ–¹æ¡ˆA: è¡¥è¿ç§»ç”Ÿæˆå†å²æµæ°´ï¼ˆæ¨èï¼‰
   - æ–¹æ¡ˆB: æ˜ç¡®æ ‡æ³¨"å†å²æ•°æ®ä»…è¡Œä¸ºè®°å½•ï¼Œä¸åšè´¢åŠ¡å¯¹è´¦"

#### å»ºè®®8: ç›‘æ§ä¸å‘Šè­¦

**ç›®æ ‡**: å®æ—¶å‘ç°äº‹åŠ¡ä¸€è‡´æ€§é—®é¢˜

**ç›‘æ§æŒ‡æ ‡**:

1. æŠ½å¥–æ¬¡æ•° vs æ‰£æ¬¾æµæ°´æ•°é‡ï¼ˆæ¯å°æ—¶å¯¹è´¦ï¼‰
2. å®¡æ ¸é€šè¿‡æ•°é‡ vs å¥–åŠ±å‘æ”¾æµæ°´æ•°é‡
3. å…‘æ¢è®¢å•æ•°é‡ vs ææ–™æ‰£å‡æµæ°´æ•°é‡
4. äº‹åŠ¡å›æ»šç‡ï¼ˆæŒ‰ `business_type` åˆ†ç»„ï¼‰

**å‘Šè­¦é˜ˆå€¼**:

- å¯¹è´¦å·®å¼‚ > 0 â†’ ç«‹å³å‘Šè­¦
- äº‹åŠ¡å›æ»šç‡ > 5% â†’ è­¦å‘Š
- äº‹åŠ¡è¶…æ—¶æ¬¡æ•° > 10æ¬¡/å°æ—¶ â†’ è­¦å‘Š

---

## 7. é™„å½•

### 7.1 å…¨ä»“è‡ªå»ºäº‹åŠ¡ç‚¹æ¸…å•

é€šè¿‡ `grep -RIn "await sequelize.transaction" services` ç»Ÿè®¡ï¼š

| æ–‡ä»¶                               | æ–¹æ³•                          | è¡Œå· | ç±»å‹     |
| ---------------------------------- | ----------------------------- | ---- | -------- |
| `TradeOrderService.js`             | `createOrder()`               | 179  | å¯é€‰ä¼ é€’ |
| `TradeOrderService.js`             | `completeOrder()`             | 434  | å¯é€‰ä¼ é€’ |
| `TradeOrderService.js`             | `cancelOrder()`               | 712  | å¯é€‰ä¼ é€’ |
| `UserService.js`                   | `createUser()`                | 46   | å¯é€‰ä¼ é€’ |
| `ContentAuditEngine.js`            | `submitForAudit()`            | 110  | å¯é€‰ä¼ é€’ |
| `ContentAuditEngine.js`            | `processAudit()`              | 178  | å¯é€‰ä¼ é€’ |
| `CustomerServiceSessionService.js` | `sendMessage()`               | 479  | è‡ªç®¡ç†   |
| `CustomerServiceSessionService.js` | `transferSession()`           | 631  | è‡ªç®¡ç†   |
| `CustomerServiceSessionService.js` | `closeSession()`              | 768  | è‡ªç®¡ç†   |
| `CustomerServiceSessionService.js` | `markSessionAsRead()`         | 862  | è‡ªç®¡ç†   |
| `MerchantReviewService.js`         | `submitMerchantForReview()`   | 73   | å¯é€‰ä¼ é€’ |
| `MerchantReviewService.js`         | `approveMerchant()`           | 189  | å¯é€‰ä¼ é€’ |
| `MerchantReviewService.js`         | `rejectMerchant()`            | 293  | å¯é€‰ä¼ é€’ |
| `MerchantReviewService.js`         | `updateMerchantInfo()`        | 363  | è‡ªç®¡ç†   |
| `ConsumptionService.js`            | `merchantSubmitConsumption()` | 199  | è‡ªç®¡ç†   |
| `ConsumptionService.js`            | `approveConsumption()`        | 357  | è‡ªç®¡ç†   |
| `ConsumptionService.js`            | `rejectConsumption()`         | 528  | è‡ªç®¡ç†   |
| `PrizePoolService.js`              | `batchAddPrizes()`            | 108  | å¯é€‰ä¼ é€’ |
| `AssetService.js`                  | `changeBalance()`             | 237  | å¯é€‰ä¼ é€’ |
| `AssetService.js`                  | `freeze()`                    | 438  | å¯é€‰ä¼ é€’ |
| `AssetService.js`                  | `unfreeze()`                  | 627  | å¯é€‰ä¼ é€’ |
| `AssetService.js`                  | `settleFromFrozen()`          | 816  | å¯é€‰ä¼ é€’ |
| `AssetService.js`                  | `transferItem()`              | 1267 | å¯é€‰ä¼ é€’ |
| `ExchangeService.js`               | `exchangeItem()`              | 352  | å¯é€‰ä¼ é€’ |
| `ExchangeService.js`               | `createListing()`             | 821  | å¯é€‰ä¼ é€’ |
| `RedemptionService.js`             | `redeemPrize()`               | 70   | å¯é€‰ä¼ é€’ |
| `MaterialManagementService.js`     | `createMaterialType()`        | 114  | è‡ªç®¡ç†   |
| `MaterialManagementService.js`     | `updateMaterialType()`        | 202  | è‡ªç®¡ç†   |

**ç»Ÿè®¡**:

- è‡ªç®¡ç†äº‹åŠ¡: 11å¤„
- å¯é€‰ä¼ é€’äº‹åŠ¡: 25å¤„
- **æ€»è®¡**: 36å¤„

### 7.2 æ ¸æŸ¥è„šæœ¬æ±‡æ€»

#### è„šæœ¬1: æ•°æ®åº“è¿æ¥ä¸è¡¨æšä¸¾

```bash
node -r dotenv/config -e "(async()=>{
  const {sequelize}=require('./config/database');
  await sequelize.authenticate();
  const [db]=await sequelize.query('SELECT DATABASE() db');
  console.log('Connected to:', db[0].db);
  const [tables]=await sequelize.query('SHOW TABLES');
  console.log('Table count:', tables.length);
  await sequelize.close();
})()"
```

#### è„šæœ¬2: æŠ½å¥–æ‰£æ¬¾ä¸€è‡´æ€§å¯¹è´¦

```bash
node -r dotenv/config -e '(async () => {
  const { sequelize } = require("./config/database");
  await sequelize.authenticate();

  const [[{ min_at: txStart }]] = await sequelize.query(
    "SELECT MIN(created_at) min_at FROM asset_transactions"
  );

  const [[drawAfter]] = await sequelize.query(
    "SELECT COUNT(*) cnt, SUM(cost_points) sum_cost FROM lottery_draws WHERE created_at >= ?",
    { replacements: [txStart] }
  );

  const [[consumeTx]] = await sequelize.query(
    "SELECT COUNT(*) cnt, SUM(delta_amount) sum_delta FROM asset_transactions WHERE business_type = ? AND created_at >= ?",
    { replacements: ["lottery_consume", txStart] }
  );

  console.log(JSON.stringify({
    asset_tx_start: txStart,
    draws_after_start: drawAfter,
    lottery_consume_txs_after_start: consumeTx
  }, null, 2));

  await sequelize.close();
})().catch(e => { console.error("ERR", e.message); process.exit(1); });'
```

#### è„šæœ¬3: èµ„äº§æµæ°´ç±»å‹åˆ†å¸ƒ

```bash
node -r dotenv/config -e '(async () => {
  const { sequelize } = require("./config/database");
  await sequelize.authenticate();

  const [types] = await sequelize.query(
    "SELECT business_type, COUNT(*) cnt, SUM(delta_amount) sum_delta FROM asset_transactions GROUP BY business_type ORDER BY cnt DESC"
  );

  console.log("asset_transactions.business_type");
  for (const r of types) {
    console.log(r.business_type, r.cnt, r.sum_delta);
  }

  await sequelize.close();
})().catch(e => { console.error("ERR", e.message); process.exit(1); });'
```

### 7.3 ç›¸å…³æ–‡æ¡£ç´¢å¼•

- **æŠ€æœ¯å€ºåŠ¡å…¨é¢åˆ†ææŠ¥å‘Š**: `docs/æŠ€æœ¯å€ºåŠ¡å…¨é¢åˆ†ææŠ¥å‘Š.md`
- **ç§¯åˆ†é¢„ç®—æ¶æ„çœŸå®çŠ¶æ€æ ¸æŸ¥æŠ¥å‘Š**: `docs/ç§¯åˆ†é¢„ç®—æ¶æ„çœŸå®çŠ¶æ€æ ¸æŸ¥æŠ¥å‘Š.md`
- **TransactionManager è®¾è®¡æ–‡æ¡£**: `utils/TransactionManager.js` (ä»£ç æ³¨é‡Š)
- **TransactionContext è®¾è®¡æ–‡æ¡£**: `utils/TransactionContext.js` (ä»£ç æ³¨é‡Š)

---

## ğŸ“ æ ¸æŸ¥ç»“è®º

### âœ… å·²ç¡®è®¤çš„äº‹å®

1. **ä¸‰ç§äº‹åŠ¡æ¨¡å¼å¹¶å­˜** - ä»£ç å±‚é¢ç¡®è®¤å­˜åœ¨
2. **å…³é”®é“¾è·¯äº‹åŠ¡ä¼ é€’æ­£ç¡®** - æŠ½å¥–ã€å…‘æ¢ã€äº¤æ˜“é“¾è·¯å·²æ˜¾å¼ä¼ é€’ `transaction`
3. **æ–°è´¦æœ¬å¯ç”¨åæ•°æ®ä¸€è‡´** - æœªå‘ç°éƒ¨åˆ†æˆåŠŸè¯æ®
4. **å†å²æ•°æ®å£å¾„ä¸åŒ** - éœ€æŒ‰è¿ç§»åˆ†ç•Œçº¿è§£è¯»

### âš ï¸ éœ€è¦æ²»ç†çš„é£é™©

1. **ç¼ºå°‘é™æ€æ£€æŸ¥** - æ— æ³•é˜²æ­¢"å¿˜ä¼  transaction"
2. **TransactionManager æœªæ¨å¹¿** - æ ·æ¿ä»£ç é‡å¤
3. **éƒ¨åˆ†æ–¹æ³•å­˜åœ¨åµŒå¥—é£é™©** - éœ€æ˜ç¡®æ ‡æ³¨å…¥å£çº§æ–¹æ³•
4. **å¯¹è´¦æœºåˆ¶ä¸å®Œå–„** - ç¼ºå°‘ç¨³å®šçš„å…³è”é”®

### ğŸ¯ ä¼˜å…ˆçº§å»ºè®®

- **P0**: äº‹åŠ¡è¾¹ç•Œè§„èŒƒåŒ–ã€ç¦æ­¢é™é»˜è„±ç¦»äº‹åŠ¡
- **P1**: æ¨å¹¿ TransactionManagerã€æ·»åŠ é™æ€æ£€æŸ¥
- **P2**: å®Œå–„å¯¹è´¦æœºåˆ¶ã€ç›‘æ§å‘Šè­¦

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-03  
**æ ¸æŸ¥äººå‘˜**: AI Assistant  
**å®¡æ ¸çŠ¶æ€**: å¾…äººå·¥å®¡æ ¸
