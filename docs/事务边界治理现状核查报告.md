# äº‹åŠ¡è¾¹ç•Œæ²»ç†ç°çŠ¶æ ¸æŸ¥æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2026-01-03  
**æ ¸æŸ¥æ›´æ–°**: 2026-01-05ï¼ˆè¡¥å……çœŸå®æ•°æ®åº“éªŒè¯ç»“æœä¸è¡Œä¸šå®è·µå‚è€ƒï¼‰  
**æ ¸æŸ¥èŒƒå›´**: åç«¯ä»£ç  + çœŸå®æ•°æ®åº“ï¼ˆrestaurant_points_devï¼‰  
**æ ¸æŸ¥æ–¹æ³•**: ä»£ç é™æ€åˆ†æ + Node.jsç›´è¿MySQLæ•°æ®éªŒè¯ï¼ˆé€šè¿‡ dotenv è¯»å– .env é…ç½®ï¼‰  
**æ ¸æŸ¥ç›®æ ‡**: éªŒè¯æŠ€æœ¯å€ºåŠ¡æŠ¥å‘Šä¸­æåˆ°çš„"ä¸‰ç§äº‹åŠ¡æ¨¡å¼å¹¶å­˜"é—®é¢˜æ˜¯å¦çœŸå®å­˜åœ¨  
**çœŸå®æ•°æ®åº“**: test-db-12-mysql-0:3306 / restaurant_points_dev (MySQL 8.0.30, 45å¼ è¡¨)

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

### æ ¸å¿ƒå‘ç°

1. **äº‹åŠ¡æ¨¡å¼å¹¶å­˜é—®é¢˜ âœ… ç¡®è®¤å­˜åœ¨**
   - ä»£ç å±‚é¢ç¡®å®å­˜åœ¨ä¸‰ç§äº‹åŠ¡å¤„ç†æ¨¡å¼å¹¶å­˜çš„æƒ…å†µ
   - ä½†å…³é”®ä¸šåŠ¡é“¾è·¯ï¼ˆæŠ½å¥–ã€å…‘æ¢ã€äº¤æ˜“ï¼‰å·²åšäº†è¾ƒå¥½çš„äº‹åŠ¡ä¼ é€’
   - æ–°å¼•å…¥çš„ `TransactionManager` å’Œ `TransactionContext` å°šæœªå…¨åŸŸç»Ÿä¸€

2. **çœŸå®æ•°æ®ä¸€è‡´æ€§ âœ… å½“å‰è‰¯å¥½ï¼ˆåŸºäº 2026-01-05 çœŸå®åº“éªŒè¯ï¼‰**
   - æ–°è´¦æœ¬å¯ç”¨åï¼ˆ2026-01-02 20:24:20ä¹‹åï¼‰çš„æ•°æ®ä¸€è‡´æ€§è‰¯å¥½
   - æœªå‘ç°"æŠ½å¥–æˆåŠŸä½†æ‰£æ¬¾ç¼ºå¤±"ç­‰éƒ¨åˆ†æˆåŠŸçš„è¯æ®
   - **å¹‚ç­‰é”®å”¯ä¸€æ€§**: `asset_transactions.idempotency_key` æ— é‡å¤ï¼ˆæ•°æ®åº“å·²éªŒè¯ï¼‰
   - **å…³é”®å‘ç°**: 55æ¡ `approved` çŠ¶æ€çš„æ¶ˆè´¹è®°å½•**å…¨éƒ¨ç¼ºå¤±å¥–åŠ±æµæ°´**ï¼ˆå› ä¸ºæ¶ˆè´¹è®°å½•æ—¶é—´èŒƒå›´ 2025-10-31~2025-12-31ï¼Œæ—©äºæ–°è´¦æœ¬å¯ç”¨ï¼‰
   - å†å²æ•°æ®ï¼ˆ2025-10-02 ~ 2026-01-02ï¼‰å› è´¦æœ¬è¿ç§»åˆ†ç•Œæ— æ³•ç›´æ¥å¯¹è´¦ï¼Œ**å·²å†³ç­–ç›´æ¥åˆ é™¤**

3. **æ½œåœ¨é£é™©ç‚¹ âš ï¸ éœ€è¦æ²»ç†**
   - å¤šä¸ªæœåŠ¡æ–¹æ³•æ”¯æŒ"å¯é€‰ transaction å‚æ•°"ï¼Œå­˜åœ¨è°ƒç”¨æ–¹å¿˜ä¼ å¯¼è‡´è„±ç¦»äº‹åŠ¡çš„é£é™©
   - éƒ¨åˆ†æœåŠ¡æ–¹æ³•æ— æ¡ä»¶è‡ªå»ºäº‹åŠ¡ï¼Œè‹¥è¢«å¤–å±‚äº‹åŠ¡åŒ…è£¹è°ƒç”¨ä¼šå½¢æˆåµŒå¥—äº‹åŠ¡
   - ç¼ºå°‘é™æ€æ£€æŸ¥æœºåˆ¶é˜²æ­¢"å¿˜ä¼  transaction"

### ğŸ¯ æ²»ç†å†³ç­–ï¼ˆå·²æ‹æ¿ - æœ€ç»ˆç‰ˆï¼‰

**å†³ç­–æ—¶é—´**: 2026-01-05  
**å†³ç­–äºº**: é¡¹ç›®è´Ÿè´£äººï¼ˆå·²ç¡®è®¤æœ€ç»ˆå£å¾„ï¼‰  
**å†³ç­–æ›´æ–°**: 2026-01-05ï¼ˆè¡¥å……è¡Œä¸šå®è·µå‚è€ƒä¸çº¦æŸç­–ç•¥ç»†åŒ–ï¼‰

#### æ¶æ„å‚è€ƒä¸è¡Œä¸šå®è·µ

**å¤§å…¬å¸ï¼ˆç¾å›¢/è…¾è®¯/é˜¿é‡Œï¼‰æ ‡å‡†å®è·µ**ï¼š
- è´¦æœ¬å¼ºå¹‚ç­‰ + è·¨æœåŠ¡æœ€ç»ˆä¸€è‡´ + å¯¹è´¦å…œåº•
- å•æœåŠ¡å†…æœ¬åœ°äº‹åŠ¡å¼ºä¸€è‡´
- ä¸ä¾èµ– FK åšè·¨åŸŸä¸€è‡´æ€§ï¼ˆä¸ºåˆ†åº“åˆ†è¡¨/æœåŠ¡æ‹†åˆ†ç•™ç©ºé—´ï¼‰

**æ¸¸æˆ/è™šæ‹Ÿç‰©å“äº¤æ˜“è¡Œä¸šå®è·µ**ï¼š
- è´¦æœ¬ï¼ˆæµæ°´+ä½™é¢ï¼‰+ ç‰©å“å®ä¾‹ï¼ˆowner+çŠ¶æ€æœºï¼‰+ äº‹ä»¶è¡¨å®¡è®¡
- åº”ç”¨å±‚äº‹åŠ¡ä¿è¯åŸå­æ€§ + å¯¹è´¦å·¡æ£€å…œåº•
- ä¸ä¾èµ– FK çº¦æŸï¼ˆä¾¿äºæ¼”è¿›ï¼‰

**å°å…¬å¸/æ—©æœŸé¡¹ç›®å¸¸è§åšæ³•**ï¼š
- å•ä½“å•åº“å°½é‡ç”¨ DB å¼ºçº¦æŸå…œåº•ï¼ˆå‡å°‘è¿ç»´ç³»ç»ŸæŠ•å…¥ï¼‰
- å…³é”®é“¾è·¯å¡è¿›ä¸€ä¸ªæ•°æ®åº“äº‹åŠ¡

**æœ¬é¡¹ç›®å®šä½**ï¼šå•ä½“ Node + å• MySQLï¼Œä½†ä¸šåŠ¡å·²æ˜¯"è´¦æœ¬+å†»ç»“æ¨¡å‹+ç‰©å“å®ä¾‹/äº‹ä»¶"å½¢æ€ï¼Œéœ€è¦å¯å¯¹è´¦çš„èµ„äº§ç³»ç»Ÿã€‚

**æœ€ç»ˆé€‰å‹**ï¼šé‡‡ç”¨"å¤§å…¬å¸/æ¸¸æˆå…¬å¸å¸¸ç”¨çš„æŠ˜ä¸­æ–¹æ¡ˆ"â€”â€”**åº”ç”¨å±‚å¼ºä¸€è‡´ï¼ˆä¸»åŠ›ï¼‰+ DB çº¦æŸå…œåº•ï¼ˆä¸åŠ  FKï¼‰+ å¯¹è´¦å·¡æ£€ï¼ˆå…œåº•ï¼‰**

---

#### æ ¸å¿ƒæˆ˜ç•¥é€‰æ‹©

1. **âœ… é‡‡ç”¨"å¼ºç¡¬"æ¨¡å¼ - å¼ºåˆ¶äº‹åŠ¡è¾¹ç•Œ**
   - `AssetService.*` ç­‰è·¨è¡¨å†™å…¥æ–¹æ³• **ä¸å†å…è®¸** "æ²¡ä¼  transaction å°±è‡ªå»ºäº‹åŠ¡"
   - æ”¹ä¸º **å¿…é¡»åœ¨äº‹åŠ¡å†…è°ƒç”¨**ï¼Œç¼ºå¤± **ç›´æ¥æŠ›é”™**ï¼ˆç ´åæ€§å˜æ›´ï¼‰
   - **å½±å“**: çŸ­æœŸæš´éœ²éšè—è°ƒç”¨ç‚¹ï¼ˆå¿…é¡»ä¿®å¤ï¼‰ï¼Œé•¿æœŸä¿è¯ä¸€è‡´æ€§
   - **å†³ç­–ä¾æ®**: é˜²æ­¢"å¤–å±‚å›æ»šä½†èµ„äº§å·²æäº¤"çš„éƒ¨åˆ†æˆåŠŸé£é™©ï¼ˆå½“å‰æœ€å¤§é£é™©æºï¼‰

2. **âœ… é‡‡ç”¨"ç»Ÿä¸€å…¥å£"æ¨¡å¼ - äº‹åŠ¡ç¼–æ’æ”¶æ•›**
   - è·¯ç”±/ä»»åŠ¡å…¥å£ **ç»Ÿä¸€ä½¿ç”¨** `TransactionManager.execute()` å¼€äº‹åŠ¡
   - **æœåŠ¡å±‚ç¦æ­¢è‡ªå»ºäº‹åŠ¡**ï¼ˆä¸å…è®¸ `sequelize.transaction()`ï¼›ä¹Ÿä¸å…è®¸"å…¥å£çº§æœåŠ¡ä¾‹å¤–"ï¼‰
   - æœåŠ¡å±‚åªå…è®¸ï¼šæ˜¾å¼æ¥æ”¶ `options.transaction` æˆ–é€šè¿‡ `TransactionContext.getTransaction({ required: true })` è·å–
   - **å½±å“**: æ”¹åŠ¨é‡å¤§ï¼Œä½†äº‹åŠ¡è¾¹ç•Œå•ä¸€ã€æ¶æ„æ¸…æ™°ã€å¯é™æ€æ‰«æ
   - **å†³ç­–ä¾æ®**: å¤§å…¬å¸æ ‡å‡†å®è·µï¼Œå•ä¸€äº‹åŠ¡æºä¾¿äºå®¡è®¡å’Œé—®é¢˜æ’æŸ¥

3. **âœ… èŠå¤©/å®¢æœé“¾è·¯çº³å…¥ç»Ÿä¸€ç¼–æ’**
   - `CustomerServiceSessionService.*` ç­‰æ–¹æ³•å¿…é¡»æ”¹é€ ä¸ºæ”¯æŒå¤–éƒ¨äº‹åŠ¡
   - ä¸å†ç»´æŒä»»ä½•"è‡ªç®¡ç†äº‹åŠ¡"ï¼ˆæœåŠ¡å±‚ç¦æ­¢è‡ªå»ºäº‹åŠ¡çš„ä¸€éƒ¨åˆ†ï¼‰
   - **å½±å“**: éœ€æ”¹é€ ç°æœ‰å®ç°ï¼Œä½†æ¶æ„ç»Ÿä¸€
   - **å†³ç­–ä¾æ®**: æ¶æ„ä¸€è‡´æ€§ä¼˜å…ˆï¼Œé¿å…"ç‰¹æ®Šé“¾è·¯"æˆä¸ºæŠ€æœ¯å€ºåŠ¡

4. **âœ… å†å²æ•°æ®é‡‡ç”¨"æ¸…ç†åˆ é™¤"ç­–ç•¥ï¼ˆä¸å…¼å®¹è€æ•°æ®ï¼‰**
   - **ç›´æ¥æ¸…ç†** 2026-01-02 20:24:20 ä¹‹å‰çš„æ‰€æœ‰å†å²æ•°æ®ï¼ˆæ°¸ä¹…ä¸¢å¤±ï¼Œä¸å…¼å®¹è€æ•°æ®ï¼‰
   - åªä¿ç•™æ–°è´¦æœ¬å¯ç”¨åçš„æ•°æ®ï¼ˆæœ€ç®€å•ã€æœ€å¹²å‡€ï¼‰
   - **å½±å“**: æ°¸ä¹…ä¸¢å¤±å†å²è¡Œä¸ºè®°å½•ï¼Œä½†æ•°æ®å£å¾„å®Œå…¨ç»Ÿä¸€
   - **å†³ç­–ä¾æ®**: é¿å…è¢«å†å²æ•°æ®å¡ä½ï¼Œæ–°è´¦æœ¬åˆ†ç•Œçº¿æ˜ç¡®ï¼ˆä¸çœŸå®åº“æ—¶é—´åˆ†å±‚ä¸€è‡´ï¼‰

5. **âœ… é‡‡ç”¨"åº”ç”¨å±‚å¼ºä¸€è‡´ + DB çº¦æŸå…œåº•"æ¨¡å¼ - ä¸ä¸Šæ•°æ®åº“ FK çº¦æŸ**
   - **åº”ç”¨å±‚å¼ºä¸€è‡´ï¼ˆä¸»åŠ›ï¼‰**ï¼šå…³é”®é“¾è·¯å¿…é¡»åœ¨åŒä¸€äº‹åŠ¡é‡Œå®Œæˆï¼ˆåŒäº‹åŠ¡å†™å…¥ä¸šåŠ¡è®°å½• + èµ„äº§æµæ°´ + å…³è”é”®ï¼‰
   - **DB çº¦æŸå…œåº•ï¼ˆä¸åŠ  FKï¼‰**ï¼š
     - **UNIQUEï¼ˆå¹‚ç­‰é”®ï¼‰**ï¼š`asset_transactions`ã€`lottery_draws`ã€`consumption_records` å·²æœ‰ï¼Œç»§ç»­ä¿æŒ
     - **NOT NULL**ï¼šåªå¯¹"æ–°å£å¾„æ•°æ®"è¦æ±‚å…³é”®å­—æ®µä¸ä¸ºç©ºï¼ˆé¿å…è¢«å†å²æ•°æ®å¡ä½ï¼‰
     - **CHECK**ï¼šç”¨äº"è¡Œå†…è§„åˆ™"ï¼ˆçŠ¶æ€æšä¸¾ã€é‡‘é¢èŒƒå›´ï¼‰ï¼Œä½†ä¸è·¨è¡¨æ£€æŸ¥
     - **ç´¢å¼•**ï¼šå…³é”®æŸ¥è¯¢å­—æ®µå’Œå¯¹è´¦å­—æ®µå¿…é¡»æœ‰ç´¢å¼•æ”¯æŒ
   - **è·¨è¡¨ä¸€è‡´æ€§**ï¼ˆå¦‚"approved å¿…é¡»æœ‰å¥–åŠ±æµæ°´"ï¼‰ï¼šä¸ä¾èµ– DB CHECKï¼ˆå› ä¸ºè·¨è¡¨ï¼‰ï¼Œæ”¹ç”¨ï¼š
     - åŒäº‹åŠ¡å†™å…¥ï¼ˆçŠ¶æ€æ”¹ä¸º approved + å†™å¥–åŠ±æµæ°´ï¼‰
     - å¯¹è´¦å·¡æ£€ï¼ˆå®šæ—¶æŸ¥ç¼ºå¤±/é‡‘é¢ä¸ç¬¦å¹¶å‘Šè­¦/å†»ç»“å…¥å£/äººå·¥ä¿®å¤ï¼‰
   - **å½±å“**: ä¾èµ–åº”ç”¨å±‚ä¿è¯ä¸€è‡´æ€§ï¼Œéœ€è¦å®Œå–„çš„å¯¹è´¦å’Œå‘Šè­¦æœºåˆ¶ï¼›ä½†æœªæ¥åˆ†åº“åˆ†è¡¨/æœåŠ¡æ‹†åˆ†æˆæœ¬ä½
   - **å†³ç­–ä¾æ®**: å‚è€ƒå¤§å…¬å¸/æ¸¸æˆå…¬å¸å®è·µï¼Œå•æœåŠ¡å†…æœ¬åœ°äº‹åŠ¡ + å¯¹è´¦å…œåº•ï¼Œä¸ä¾èµ– FK åšè·¨åŸŸä¸€è‡´æ€§

6. **âœ… å¼ºçº¦æŸè¡¨èŒƒå›´ï¼ˆåˆ†å±‚ç­–ç•¥ï¼Œä¸å»ºè®®å…¨è¡¨ä¸€åˆ€åˆ‡ï¼‰**
   - **P0 å¿…é¡»å¼ºçº¦æŸ**ï¼šæ‰€æœ‰ä¼šå½±å“èµ„äº§/æƒç›Šçš„"äº‹å®è¡¨"
     - æ ¸å¿ƒè´¦æœ¬ï¼š`asset_transactions`ã€`accounts`ã€`account_asset_balances`
     - ä¸šåŠ¡å•æ®ï¼š`lottery_draws`ã€`consumption_records`ã€`exchange_records`ã€`trade_orders`ã€`market_listings`
     - **çº¦æŸç±»å‹**: UNIQUEï¼ˆå¹‚ç­‰é”®ï¼‰+ NOT NULLï¼ˆå…³é”®å­—æ®µï¼‰+ ç´¢å¼•ï¼ˆæŸ¥è¯¢/å¯¹è´¦ï¼‰
   - **P1/P2 å¯å¼±çº¦æŸ**ï¼šæ—¥å¿—/é…ç½®/å±•ç¤º/æ´¾ç”Ÿç±»è¡¨
     - å®¡è®¡æ—¥å¿—ï¼š`item_instance_events`ã€`audit_logs`ã€`admin_operation_logs`
     - èŠå¤©/å®¢æœï¼š`customer_service_sessions`ã€`chat_messages`
     - ç³»ç»Ÿé…ç½®ï¼š`system_settings`ã€`system_announcements`
     - **çº¦æŸç±»å‹**: åŸºç¡€ NOT NULL + å¿…è¦ç´¢å¼•å³å¯
   - **å†³ç­–ä¾æ®**: ä¸å»ºè®®"å…¨éƒ¨è¡¨"ä¸€åˆ€åˆ‡ï¼Œåˆ†å±‚ç®¡ç†é™ä½å†å²æ•°æ®è¿ç§»æˆæœ¬ï¼Œèšç„¦æ ¸å¿ƒèµ„äº§/æƒç›Šè¡¨

7. **âœ… æŠ½å¥–æ‰£æ¬¾å…³è”ç²’åº¦ï¼šæŒ‰ Sessionï¼ˆæ‰¹é‡æ‰£æ¬¾ï¼‰**
   - ä¸€ä¸ª `lottery_session_id` å¯¹åº”ä¸€æ¡æ‰£æ¬¾æµæ°´ï¼ˆæ‰¹é‡æŠ½å¥–ä¸€æ¬¡æ€§æ‰£ NÃ—costï¼‰
   - `lottery_draws` å­˜å‚¨ `lottery_session_id`ï¼ˆNOT NULLï¼‰
   - å¤šæ¡ `lottery_draws` å…è®¸æŒ‡å‘åŒä¸€ä¸ª `asset_transaction_id`
   - **ä¸æ”¯æŒ**å•æŠ½æ’¤é”€ï¼ˆç®€åŒ–ä¸šåŠ¡é€»è¾‘ï¼‰
   - **å½±å“**: éœ€è¦ç¡®ä¿ `lottery_session_id` å­—æ®µå®Œæ•´æ€§

8. **âœ… "å®¡æ ¸é€šè¿‡å¿…é¡»æœ‰å¥–åŠ±æµæ°´"è§„åˆ™ï¼šåªå¯¹åˆ†ç•Œçº¿åæ–°æ•°æ®å¼ºåˆ¶**
   - **ç”Ÿæ•ˆèŒƒå›´**: ä»…å¯¹ `created_at >= '2026-01-02 20:24:20'` çš„æ¶ˆè´¹è®°å½•å¼ºåˆ¶
   - **å†å²æ•°æ®**: ç›´æ¥åˆ é™¤ï¼ˆä¸åšå›å¡«/è¿ç§»ï¼‰
   - **å®æ–½æ–¹å¼**: 
     - åº”ç”¨å±‚ï¼šåŒäº‹åŠ¡å†™å…¥ï¼ˆå®¡æ ¸é€šè¿‡ + å†™å¥–åŠ±æµæ°´ï¼‰
     - DB å±‚ï¼šNOT NULL çº¦æŸä»…å¯¹æ–°æ•°æ®ç”Ÿæ•ˆï¼ˆé€šè¿‡è¿ç§»æ—¶é—´æ§åˆ¶ï¼‰
     - å¯¹è´¦å±‚ï¼šå®šæ—¶æŸ¥ç¼ºå¤±å¹¶å‘Šè­¦/å†»ç»“å…¥å£
   - **å†³ç­–ä¾æ®**: ä¸çœŸå®åº“æ—¶é—´åˆ†å±‚ä¸€è‡´ï¼Œé¿å…å†å²æ•°æ®è¿ç§»æˆæœ¬

9. **âœ… å¯¹è´¦ä¸å¤„ç½®ç­–ç•¥ï¼ˆåˆ†ç•Œç‚¹ä¹‹åï¼‰ï¼šå‘Šè­¦ + é˜»æ–­å‘å¸ƒ + è‡ªåŠ¨å†»ç»“å…¥å£**
   - å¯¹è´¦è„šæœ¬/æ ¡éªŒé€»è¾‘å‘ç°ä»»ä½•å·®å¼‚ï¼š**ä¸»åŠ¨æ­¢è¡€**ï¼ˆå‘Šè­¦é€šçŸ¥ + é˜»æ–­å‘å¸ƒ + è‡ªåŠ¨å†»ç»“ç›¸å…³ä¸šåŠ¡å…¥å£ï¼‰
   - ç›®æ ‡ï¼šå·®å¼‚ä¸€æ—¦å‡ºç°ï¼Œç³»ç»Ÿä¸»åŠ¨åš"å¤–éƒ¨åŠ¨ä½œ"å»æ­¢è¡€ï¼ŒæŠŠå½±å“é¢å‹åˆ°æœ€å°
   - **å†³ç­–ä¾æ®**: å‚è€ƒæ¸¸æˆå…¬å¸å®è·µï¼Œå…è®¸äººå·¥ä¿®å¤ä½†å¿…é¡»å¯è¿½æº¯

10. **âœ… æµ‹è¯•æ•°æ®ä¸çœŸå®æ•°æ®ï¼šä¸åšç‰©ç†éš”ç¦»**
    - ä¸æ‹†åº“/ä¸åˆ† schema
    - è¦æ±‚ï¼šæµ‹è¯•å†™å…¥å¿…é¡»å¯è¯†åˆ«ï¼ˆå¦‚ `idempotency_key` ç»Ÿä¸€åŠ  `test_` å‰ç¼€æˆ– `meta.source='test'`ï¼‰ï¼Œå¹¶åœ¨ç»Ÿè®¡/å¯¹è´¦æ—¶æ˜ç¡®æ’é™¤æµ‹è¯•æ•°æ®
    - **å†³ç­–ä¾æ®**: é™ä½è¿ç»´æˆæœ¬ï¼Œä½†éœ€è¦ä¸¥æ ¼çš„æµ‹è¯•æ•°æ®æ ‡è®°è§„èŒƒ

---

## 1. æŠ€æœ¯æ ˆä¸äº‹åŠ¡åŸºç¡€è®¾æ–½ç¡®è®¤

### 1.1 æ ¸å¿ƒæŠ€æœ¯æ ˆ

```javascript
// package.json ç¡®è®¤çš„å…³é”®ä¾èµ–
{
  "sequelize": "^6.35.0",      // ORMå±‚
  "mysql2": "^3.6.0",           // MySQLé©±åŠ¨
  "dotenv": "^16.3.0"           // ç¯å¢ƒå˜é‡ç®¡ç†
}
```

**Node.jsç‰ˆæœ¬**: `>=20.18.0`

### 1.2 æ•°æ®åº“è¿æ¥é…ç½®

**ç»Ÿä¸€é…ç½®æº**: `config/database.js`  
**ç¯å¢ƒå˜é‡åŠ è½½**: é€šè¿‡ `dotenv` ä» `.env` æ–‡ä»¶è¯»å–ï¼ˆapp.js å¯åŠ¨æ—¶åŠ è½½ï¼‰

```javascript
// config/database.js å…³é”®é…ç½®
{
  host: process.env.DB_HOST,
  port: process.env.DB_PORT,
  database: process.env.DB_NAME,
  username: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  timezone: '+08:00',                    // åŒ—äº¬æ—¶é—´
  pool: { max: 40, min: 5, acquire: 10000, idle: 60000, evict: 30000 },
  logging: slowQueryLogger                // æ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆé˜ˆå€¼1000msï¼‰
}
```

**å®é™…è¿æ¥éªŒè¯**ï¼ˆ2026-01-05 é€šè¿‡ Node.js + dotenv ç›´è¿çœŸå®åº“ï¼‰:

```json
{
  "connected": true,
  "db": "restaurant_points_dev",
  "server_host": "test-db-12-mysql-0",
  "server_port": "3306",
  "server_version": "8.0.30",
  "current_user_name": "root@%"
}
```

**è¡¨æ•°é‡**: 45 å¼   
**æ ¸æŸ¥æ–¹å¼**: `node -r dotenv/config -e "require('./config/database').sequelize.authenticate()"`ï¼ˆç¡®ä¿è¯»å–çš„æ˜¯ .env é…ç½®çš„çœŸå®åº“ï¼Œè€Œéå¤‡ä»½æ–‡ä»¶ï¼‰

### 1.3 äº‹åŠ¡åŸºç¡€è®¾æ–½

é¡¹ç›®ä¸­å­˜åœ¨ä¸‰å±‚äº‹åŠ¡ç®¡ç†æœºåˆ¶ï¼š

#### å±‚çº§1: SequelizeåŸç”Ÿäº‹åŠ¡

```javascript
// ç›´æ¥ä½¿ç”¨ sequelize.transaction()
const transaction = await sequelize.transaction({
  isolationLevel: Transaction.ISOLATION_LEVELS.READ_COMMITTED
})
```

**ä½¿ç”¨ä½ç½®**: éå¸ƒ `services/` ç›®å½•ï¼Œè‡³å°‘50+å¤„

#### å±‚çº§2: TransactionManagerï¼ˆç»Ÿä¸€äº‹åŠ¡ç®¡ç†å™¨ï¼‰

**æ–‡ä»¶**: `utils/TransactionManager.js`

**è®¾è®¡ç›®æ ‡**:

- é›†ä¸­äº‹åŠ¡åˆ›å»ºå’Œæ‰§è¡Œ
- æ™ºèƒ½é‡è¯•ï¼ˆdeadlock/timeoutï¼‰
- é”™è¯¯åˆ†ç±»å’Œè¯Šæ–­

**æ ¸å¿ƒæ–¹æ³•**:

```javascript
TransactionManager.execute(
  async transaction => {
    // ä¸šåŠ¡é€»è¾‘
  },
  { timeout: 30000, maxRetries: 3 }
)
```

**å®é™…ä½¿ç”¨æƒ…å†µ**: âš ï¸ **å°šæœªå…¨åŸŸæ¨å¹¿**ï¼Œå¤§éƒ¨åˆ†æœåŠ¡ä»ç›´æ¥ä½¿ç”¨ `sequelize.transaction()`

#### å±‚çº§3: TransactionContextï¼ˆAsyncLocalStorageè‡ªåŠ¨ä¼ æ’­ï¼‰

**æ–‡ä»¶**: `utils/TransactionContext.js`

**è®¾è®¡ç›®æ ‡**:

- ä½¿ç”¨ Node.js `AsyncLocalStorage` è‡ªåŠ¨ä¼ æ’­äº‹åŠ¡å¯¹è±¡
- æ”¯æŒ `getTransaction({ required: true })` å¼ºåˆ¶è¦æ±‚äº‹åŠ¡å­˜åœ¨

**å®é™…ä½¿ç”¨æƒ…å†µ**: âš ï¸ **å°šæœªå…¨åŸŸé›†æˆ**

---

## 2. ä¸‰ç§äº‹åŠ¡æ¨¡å¼å¹¶å­˜çš„ä»£ç è¯æ®

### 2.1 æ¨¡å¼A: è‡ªç®¡ç†äº‹åŠ¡ï¼ˆæ–¹æ³•å†…éƒ¨è‡ªå»ºã€è‡ªæäº¤/å›æ»šï¼‰

#### è¯æ®1: CustomerServiceSessionService.sendMessage()

**æ–‡ä»¶**: `services/CustomerServiceSessionService.js:479-540`

```javascript
static async sendMessage(session_id, data) {
  const sequelize = CustomerServiceSession.sequelize
  const transaction = await sequelize.transaction({
    isolationLevel: Transaction.ISOLATION_LEVELS.READ_COMMITTED
  })

  try {
    // ... ä¸šåŠ¡é€»è¾‘ï¼ˆä¼šè¯æ¶ˆæ¯åˆ›å»ºã€çŠ¶æ€æ›´æ–°ï¼‰
    await transaction.commit()
    return result
  } catch (error) {
    await transaction.rollback()
    throw error
  }
}
```

**é£é™©åˆ†æ**:

- âœ… æ–¹æ³•æœ¬èº«äº‹åŠ¡è¾¹ç•Œæ¸…æ™°
- âš ï¸ è‹¥è¢«å¤–å±‚äº‹åŠ¡åŒ…è£¹è°ƒç”¨ï¼Œä¼šå½¢æˆåµŒå¥—äº‹åŠ¡
- å½“å‰è°ƒç”¨æ–¹ `AdminCustomerServiceService.sendMessage()` **æœªè‡ªå»ºäº‹åŠ¡**ï¼Œæš‚æ— åµŒå¥—é£é™©

#### è¯æ®2: ConsumptionService.merchantSubmitConsumption()

**æ–‡ä»¶**: `services/ConsumptionService.js:199-350`

```javascript
static async merchantSubmitConsumption(data) {
  const transaction = await sequelize.transaction({
    isolationLevel: Transaction.ISOLATION_LEVELS.READ_COMMITTED
  })

  try {
    // 1. éªŒè¯äºŒç»´ç 
    // 2. åˆ›å»ºæ¶ˆè´¹è®°å½•
    // 3. åˆ›å»ºå®¡æ ¸è®°å½•
    // 4. å†»ç»“ç§¯åˆ†ï¼ˆè°ƒç”¨ AssetService.freezeï¼‰
    await transaction.commit()
    return { consumption_record, review_record }
  } catch (error) {
    await transaction.rollback()
    throw error
  }
}
```

**é£é™©åˆ†æ**:

- âœ… å…¥å£æ–¹æ³•è‡ªå»ºäº‹åŠ¡åˆç†
- âœ… è°ƒç”¨ `AssetService.freeze()` æ—¶æ˜¾å¼ä¼ é€’ `{ transaction }`
- âœ… è°ƒç”¨æ–¹ï¼ˆè·¯ç”±å±‚ï¼‰æœªå†åŒ…äº‹åŠ¡ï¼Œæ— åµŒå¥—é£é™©

### 2.2 æ¨¡å¼B: ä¼ é€’äº‹åŠ¡ï¼ˆå¯é€‰ transaction å‚æ•°ï¼‰

#### è¯æ®1: TradeOrderService.createOrder()

**æ–‡ä»¶**: `services/TradeOrderService.js:179-410`

```javascript
static async createOrder(params, options = {}) {
  const transaction = options.transaction || (await sequelize.transaction())

  try {
    // 1. éªŒè¯æŒ‚ç‰ŒçŠ¶æ€
    // 2. é”å®šæŒ‚ç‰Œ
    // 3. åˆ›å»ºè®¢å•
    // 4. å†»ç»“ä¹°å®¶èµ„äº§ï¼ˆè°ƒç”¨ AssetService.freezeï¼Œä¼ é€’ transactionï¼‰
    await AssetService.freeze({ ... }, { transaction })

    // 5. æ›´æ–°è®¢å•çŠ¶æ€
    if (!options.transaction) {
      await transaction.commit()  // ä»…åœ¨è‡ªå»ºäº‹åŠ¡æ—¶æäº¤
    }
    return { order_id, is_duplicate }
  } catch (error) {
    if (!options.transaction) {
      await transaction.rollback()  // ä»…åœ¨è‡ªå»ºäº‹åŠ¡æ—¶å›æ»š
    }
    throw error
  }
}
```

**é£é™©åˆ†æ**:

- âœ… æ”¯æŒå¤–éƒ¨äº‹åŠ¡ä¼ å…¥ï¼ˆé¿å…åµŒå¥—ï¼‰
- âœ… åªåœ¨è‡ªå»ºäº‹åŠ¡æ—¶æäº¤/å›æ»šï¼ˆæ­£ç¡®æ¨¡å¼ï¼‰
- âœ… è°ƒç”¨ `AssetService.*` æ—¶æ˜¾å¼ä¼ é€’ `transaction`
- âš ï¸ **è‹¥è°ƒç”¨æ–¹å¿˜è®°ä¼  `transaction`ï¼Œä¼šè‡ªå»ºæ–°äº‹åŠ¡**ï¼ˆå¯èƒ½è„±ç¦»å¤–å±‚äº‹åŠ¡è¾¹ç•Œï¼‰

#### è¯æ®2: ExchangeService.exchangeItem()

**æ–‡ä»¶**: `services/ExchangeService.js:352-550`

```javascript
static async exchangeItem(params, options = {}) {
  const externalTransaction = options.transaction
  const transaction = externalTransaction || (await sequelize.transaction())

  try {
    // 1. é”å®šå…‘æ¢å•†å“
    // 2. æ‰£å‡ææ–™èµ„äº§ï¼ˆè°ƒç”¨ AssetService.changeBalanceï¼Œä¼ é€’ transactionï¼‰
    await AssetService.changeBalance({ ... }, { transaction })

    // 3. åˆ›å»ºå…‘æ¢è®°å½•
    if (!externalTransaction) {
      await transaction.commit()
    }
    return result
  } catch (error) {
    if (!externalTransaction) {
      await transaction.rollback()
    }
    throw error
  }
}
```

**é£é™©åˆ†æ**: åŒ `TradeOrderService`

#### è¯æ®3: AssetService.changeBalance()

**æ–‡ä»¶**: `services/AssetService.js:237-430`

```javascript
static async changeBalance(params, options = {}) {
  const externalTransaction = options.transaction
  const transaction = externalTransaction || (await sequelize.transaction())

  try {
    // 1. å¹‚ç­‰æ€§æ£€æŸ¥
    // 2. è´¦æˆ·é”å®š
    // 3. ä½™é¢å˜æ›´
    // 4. åˆ›å»ºæµæ°´è®°å½•

    if (!externalTransaction) {
      await transaction.commit()
    }
    return { transaction_record, new_balance, is_duplicate }
  } catch (error) {
    if (!externalTransaction) {
      await transaction.rollback()
    }
    throw error
  }
}
```

**ç‰¹åˆ«æ³¨æ„**: `AssetService` è¿˜åŒ…å« `checkTransactionBoundary()` è­¦å‘Šå‡½æ•°ï¼Œè¯´æ˜å›¢é˜Ÿå·²æ„è¯†åˆ°"å¿˜ä¼  transaction"çš„é£é™©

### 2.3 æ¨¡å¼C: ç»Ÿä¸€äº‹åŠ¡ç®¡ç†å™¨ï¼ˆTransactionManagerï¼‰

#### è®¾è®¡æ„å›¾

**æ–‡ä»¶**: `utils/TransactionManager.js`

```javascript
class TransactionManager {
  static async execute(operation, options = {}) {
    const { timeout = 30000, maxRetries = 3 } = options

    for (let attempt = 0; attempt < maxRetries; attempt++) {
      const transaction = await sequelize.transaction({
        isolationLevel: Transaction.ISOLATION_LEVELS.READ_COMMITTED
      })

      try {
        const result = await operation(transaction)
        await transaction.commit()
        return result
      } catch (error) {
        await transaction.rollback()

        const errorType = this.analyzeError(error)
        if (errorType.retryable && attempt < maxRetries - 1) {
          await delay(exponentialBackoff(attempt))
          continue
        }
        throw error
      }
    }
  }
}
```

**å®é™…ä½¿ç”¨æƒ…å†µ**: âš ï¸ **å‡ ä¹æœªè¢«é‡‡ç”¨**

é€šè¿‡å…¨ä»“æœç´¢ `TransactionManager.execute`ï¼Œæœªå‘ç°å®é™…ä¸šåŠ¡ä»£ç è°ƒç”¨æ­¤æ–¹æ³•ã€‚

---

## 3. çœŸå®æ•°æ®åº“éªŒè¯ç»“æœ

### 3.1 æ•°æ®åº“è¿æ¥ä¸è¡¨ç»“æ„ç¡®è®¤

**è¿æ¥å‘½ä»¤**ï¼ˆé€šè¿‡ Node.js + dotenvï¼‰:

```bash
node -r dotenv/config -e "(async()=>{
  const {sequelize}=require('./config/database');
  await sequelize.authenticate();
  // ...
})()"
```

**æ ¸å¿ƒä¸šåŠ¡è¡¨æ•°æ®é‡**ï¼ˆ2026-01-05 çœŸå®åº“éªŒè¯ï¼‰:

| è¡¨å                     | è¡Œæ•° | è¯´æ˜                   |
| ------------------------ | ---- | ---------------------- |
| `users`                  | 22   | ç”¨æˆ·è¡¨                 |
| `lottery_draws`          | 2841 | æŠ½å¥–è®°å½•               |
| `lottery_campaigns`      | 1    | æŠ½å¥–æ´»åŠ¨               |
| `lottery_prizes`         | 9    | å¥–å“é…ç½®               |
| `asset_transactions`     | 252  | **èµ„äº§æµæ°´ï¼ˆæ–°è´¦æœ¬ï¼‰** |
| `accounts`               | 14   | è´¦æˆ·è¡¨                 |
| `account_asset_balances` | 11   | è´¦æˆ·ä½™é¢è¡¨             |
| `consumption_records`    | 184  | æ¶ˆè´¹è®°å½•               |
| `content_review_records` | 184  | å®¡æ ¸è®°å½•               |
| `item_instances`         | 1225 | ç‰©å“å®ä¾‹               |
| `item_instance_events`   | 311  | ç‰©å“äº‹ä»¶               |
| `trade_orders`           | 0    | äº¤æ˜“è®¢å•ï¼ˆæ— æ•°æ®ï¼‰     |
| `market_listings`        | 1    | å¸‚åœºæŒ‚ç‰Œ               |
| `exchange_records`       | 0    | å…‘æ¢è®°å½•ï¼ˆæ— æ•°æ®ï¼‰     |
| `exchange_items`         | 24   | å…‘æ¢å•†å“é…ç½®           |
| `customer_service_sessions` | 1 | å®¢æœä¼šè¯               |
| `chat_messages`          | 0    | èŠå¤©æ¶ˆæ¯               |

**å…³é”®å‘ç°**:

- âŒ æ—§è´¦æœ¬è¡¨ **ä¸å­˜åœ¨**: `points_transactions`, `user_points_accounts`, `user_inventory` ç­‰
- âœ… å½“å‰ç§¯åˆ†/èµ„äº§çœŸç›¸æº: `asset_transactions` + `account_asset_balances`
- âœ… **å¹‚ç­‰é”®å”¯ä¸€æ€§éªŒè¯**: `asset_transactions.idempotency_key` æ— é‡å¤è®°å½•ï¼ˆæ•°æ®åº“å±‚ UNIQUE çº¦æŸç”Ÿæ•ˆï¼‰
- âš ï¸ **æµ‹è¯•æ•°æ®å æ¯”é«˜**: èµ„äº§æµæ°´ä¸­ `test_recharge`(110ç¬”) + `exchange_debit`(111ç¬”ï¼Œmeta å« test_*) å ä¸»å¯¼

### 3.2 è´¦æœ¬è¿ç§»åˆ†ç•Œçº¿è¯†åˆ«ï¼ˆ2026-01-05 çœŸå®åº“éªŒè¯ï¼‰

**asset_transactions æ—¶é—´èŒƒå›´**:

```sql
SELECT MIN(created_at), MAX(created_at) FROM asset_transactions;
-- ç»“æœ: 2026-01-02 20:24:20 ~ 2026-01-05 03:34:39
```

**lottery_draws æ—¶é—´èŒƒå›´**:

```sql
SELECT MIN(created_at), MAX(created_at) FROM lottery_draws;
-- ç»“æœ: 2025-10-02 01:24:29 ~ 2026-01-03 01:50:21
```

**consumption_records æ—¶é—´èŒƒå›´**:

```sql
SELECT MIN(created_at), MAX(created_at) FROM consumption_records;
-- ç»“æœ: 2025-10-31 02:54:25 ~ 2025-12-31 08:43:14
```

**å…³é”®ç»“è®º**:

- æ–°è´¦æœ¬å¯ç”¨æ—¶é—´: **2026-01-02 20:24:20**ï¼ˆæ­£å¼ Cutover åˆ†ç•Œçº¿ï¼‰
- å¤§é‡æŠ½å¥–è®°å½•ï¼ˆ2840æ¡ï¼‰å‘ç”Ÿåœ¨æ–°è´¦æœ¬å¯ç”¨å‰
- åªæœ‰ **1æ¡** æŠ½å¥–è®°å½•å‘ç”Ÿåœ¨æ–°è´¦æœ¬å¯ç”¨å
- **æ‰€æœ‰æ¶ˆè´¹è®°å½•**ï¼ˆ184æ¡ï¼‰å‡åœ¨æ–°è´¦æœ¬å¯ç”¨å‰ï¼Œå› æ­¤ 55æ¡ `approved` çŠ¶æ€è®°å½•ç¼ºå¤±å¥–åŠ±æµæ°´å±äºæ­£å¸¸ï¼ˆæ—§å£å¾„æ•°æ®ï¼‰
- **å·²å†³ç­–**: åˆ†ç•Œçº¿ä¹‹å‰çš„æ•°æ®è§†ä¸º"å†å²å£å¾„"ï¼Œç›´æ¥åˆ é™¤ï¼Œä¸åšå¼ºä¸€è‡´å¯¹è´¦

### 3.3 æ–°è´¦æœ¬å¯ç”¨åçš„æ•°æ®ä¸€è‡´æ€§éªŒè¯ï¼ˆ2026-01-05 çœŸå®åº“éªŒè¯ï¼‰

#### éªŒè¯1: æŠ½å¥–æ‰£æ¬¾ä¸€è‡´æ€§

**æŸ¥è¯¢é€»è¾‘**ï¼ˆé€šè¿‡ Node.js + Sequelize ç›´è¿çœŸå®åº“ï¼‰:

```sql
-- æ–°è´¦æœ¬å¯ç”¨åçš„æŠ½å¥–è®°å½•
SELECT COUNT(*), SUM(cost_points)
FROM lottery_draws
WHERE created_at >= '2026-01-02 20:24:20';
-- ç»“æœ: 1æ¡, æ€»æ‰£æ¬¾100

-- æ–°è´¦æœ¬å¯ç”¨åçš„æŠ½å¥–æ‰£æ¬¾æµæ°´
SELECT COUNT(*), SUM(delta_amount)
FROM asset_transactions
WHERE business_type = 'lottery_consume'
  AND created_at >= '2026-01-02 20:24:20';
-- ç»“æœ: 1æ¡, æ€»é‡‘é¢-100
```

**ç»“è®º**: âœ… **å®Œå…¨ä¸€è‡´ï¼Œæ— éƒ¨åˆ†æˆåŠŸè¯æ®**ï¼ˆåŸºäºçœŸå®æ•°æ®åº“éªŒè¯ï¼‰

#### éªŒè¯2: æ¶ˆè´¹å¥–åŠ±å‘æ”¾ä¸€è‡´æ€§ï¼ˆ2026-01-05 çœŸå®åº“éªŒè¯ï¼‰

**æŸ¥è¯¢é€»è¾‘**ï¼ˆé€šè¿‡ Node.js + Sequelize ç›´è¿çœŸå®åº“ï¼‰:

```sql
-- æ¶ˆè´¹è®°å½•çŠ¶æ€åˆ†å¸ƒ
SELECT status, COUNT(*) FROM consumption_records GROUP BY status;
-- ç»“æœ: pending(79), approved(55), rejected(50)

-- å®¡æ ¸è®°å½•çŠ¶æ€åˆ†å¸ƒ
SELECT audit_status, COUNT(*) FROM content_review_records GROUP BY audit_status;
-- ç»“æœ: pending(79), approved(55), rejected(50)
```

**çŠ¶æ€ä¸€è‡´æ€§**: âœ… æ¶ˆè´¹è®°å½•ä¸å®¡æ ¸è®°å½•çŠ¶æ€å®Œå…¨å¯¹åº”

**è·¨è¡¨ä¸€è‡´æ€§æ ¸æŸ¥**ï¼ˆapproved æ˜¯å¦æœ‰å¥–åŠ±æµæ°´ï¼‰:

```sql
-- æŸ¥è¯¢ï¼šapproved çŠ¶æ€ä½†ç¼ºå¤±å¥–åŠ±æµæ°´çš„è®°å½•
SELECT cr.record_id, cr.user_id, cr.status, cr.points_to_award, cr.idempotency_key
FROM consumption_records cr
LEFT JOIN asset_transactions atx 
  ON atx.idempotency_key = CONCAT('consumption_reward_', cr.record_id)
  AND atx.business_type = 'consumption_reward'
WHERE cr.status = 'approved' AND atx.transaction_id IS NULL
LIMIT 20;
-- ç»“æœ: 55æ¡ approved è®°å½•å…¨éƒ¨ç¼ºå¤±å¥–åŠ±æµæ°´
```

**åŸå› åˆ†æ**:

- æ‰€æœ‰æ¶ˆè´¹è®°å½•çš„æ—¶é—´èŒƒå›´: `2025-10-31 ~ 2025-12-31`ï¼ˆ**æ—©äºæ–°è´¦æœ¬å¯ç”¨ 2026-01-02 20:24:20**ï¼‰
- æ–°è´¦æœ¬å¯ç”¨åï¼ˆ2026-01-02ä¹‹åï¼‰**æ²¡æœ‰æ–°çš„æ¶ˆè´¹è®°å½•äº§ç”Ÿ**
- å› æ­¤ 55æ¡ `approved` è®°å½•ç¼ºå¤±å¥–åŠ±æµæ°´å±äº**æ—§å£å¾„æ•°æ®**ï¼ˆæ­£å¸¸ç°è±¡ï¼‰
- **ä»£ç å±‚é¢éªŒè¯**: `ConsumptionService.approveConsumption()` è°ƒç”¨ `AssetService.changeBalance()` çš„å¹‚ç­‰é”®æ ¼å¼ä¸º `consumption_reward:approve:{recordId}`ï¼ˆä¸æŸ¥è¯¢å‡è®¾çš„ `consumption_reward_{recordId}` æ ¼å¼ä¸åŒï¼Œä½†ä¸å½±å“ç»“è®ºï¼šå†å²æ•°æ®éƒ½åœ¨åˆ†ç•Œçº¿å‰ï¼‰

**æ–°è´¦æœ¬å¯ç”¨åçš„æ¶ˆè´¹å¥–åŠ±æµæ°´**:

```sql
SELECT COUNT(*), SUM(delta_amount)
FROM asset_transactions
WHERE business_type = 'consumption_reward'
  AND created_at >= '2026-01-02 20:24:20';
-- ç»“æœ: 0æ¡ï¼ˆå› ä¸ºåˆ†ç•Œçº¿åæ— æ–°æ¶ˆè´¹è®°å½•äº§ç”Ÿï¼‰
```

#### éªŒè¯3: èµ„äº§æµæ°´ç±»å‹åˆ†å¸ƒï¼ˆ2026-01-05 çœŸå®åº“éªŒè¯ï¼‰

**æŸ¥è¯¢é€»è¾‘**ï¼ˆæŒ‰ business_type + asset_code èšåˆï¼‰:

```sql
SELECT business_type, asset_code, COUNT(*) cnt, SUM(delta_amount) sum_delta
FROM asset_transactions
GROUP BY business_type, asset_code
ORDER BY cnt DESC, business_type ASC;
```

**çœŸå®æ•°æ®ç»“æœ**:

| business_type      | asset_code | æ•°é‡ | æ€»é‡‘é¢   |
| ------------------ | ---------- | ---- | -------- |
| `exchange_debit`   | red_shard  | 111  | -11100   |
| `test_recharge`    | red_shard  | 110  | +11000   |
| `admin_adjustment` | red_shard  | 30   | +750     |
| `lottery_consume`  | POINTS     | 1    | -100     |

**åˆ†æ**:

- âœ… å…‘æ¢æ‰£æ¬¾æµæ°´æ­£å¸¸ï¼ˆ111ç¬” `red_shard` æ‰£å‡ï¼‰
- âœ… æµ‹è¯•å……å€¼æµæ°´æ­£å¸¸ï¼ˆ110ç¬” `red_shard` å……å€¼ï¼Œå¹‚ç­‰é”®å‰ç¼€ `test_recharge`ï¼‰
- âš ï¸ **æµ‹è¯•æ•°æ®å æ¯”é«˜**: `test_recharge` + `exchange_debit`(meta å« test_*) å ä¸»å¯¼ï¼Œéœ€è¦åœ¨å¯¹è´¦/ç»Ÿè®¡æ—¶æ’é™¤
- âš ï¸ ç¼ºå°‘ `consumption_reward`ï¼ˆåŸå› ï¼šæ‰€æœ‰æ¶ˆè´¹è®°å½•æ—¶é—´èŒƒå›´ 2025-10-31~2025-12-31ï¼Œæ—©äºæ–°è´¦æœ¬å¯ç”¨ 2026-01-02 20:24:20ï¼‰
- âš ï¸ ç¼ºå°‘ `lottery_reward`ï¼ˆå¯èƒ½å¥–å“å‘æ”¾èµ°çš„æ˜¯ `item_instances` è€Œéèµ„äº§æµæ°´ï¼‰

**å¹‚ç­‰é”®é‡å¤æ€§æ£€æŸ¥**:

```sql
SELECT idempotency_key, COUNT(*) cnt 
FROM asset_transactions 
GROUP BY idempotency_key 
HAVING cnt > 1;
-- ç»“æœ: 0æ¡ï¼ˆæ— é‡å¤ï¼ŒUNIQUE çº¦æŸç”Ÿæ•ˆï¼‰
```

---

## 4. åµŒå¥—äº‹åŠ¡é£é™©ç‚¹åˆ†æ

### 4.1 æ½œåœ¨åµŒå¥—äº‹åŠ¡åœºæ™¯

#### åœºæ™¯1: AdminCustomerServiceService â†’ CustomerServiceSessionService

**è°ƒç”¨é“¾**:

```
routes/v4/system/chat.js
  â†’ AdminCustomerServiceService.sendMessage()
    â†’ CustomerServiceSessionService.sendMessage()  // å†…éƒ¨è‡ªå»ºäº‹åŠ¡
```

**å½“å‰çŠ¶æ€**: âœ… **æ— åµŒå¥—é£é™©**

- `AdminCustomerServiceService.sendMessage()` æœªè‡ªå»ºäº‹åŠ¡
- ç›´æ¥è°ƒç”¨ `CustomerServiceSessionService.sendMessage()`

**æ½œåœ¨é£é™©**: âš ï¸ è‹¥æœªæ¥æœ‰äººç»™ `AdminCustomerServiceService` åŠ äº‹åŠ¡åŒ…è£¹ï¼Œä¼šç«‹å³å½¢æˆåµŒå¥—

#### åœºæ™¯2: è‹¥ AssetService è¢«å¿˜ä¼  transaction

**è°ƒç”¨é“¾**:

```
æŸæœåŠ¡æ–¹æ³•ï¼ˆè‡ªå»ºäº‹åŠ¡ï¼‰
  â†’ AssetService.changeBalance()  // å¿˜è®°ä¼  { transaction }
    â†’ å†…éƒ¨è‡ªå»ºæ–°äº‹åŠ¡å¹¶æäº¤  // å¤–å±‚å›æ»šä¸å½±å“æ­¤æäº¤
```

**å®é™…æƒ…å†µ**: âœ… **å…³é”®é“¾è·¯éƒ½ä¼ äº† transaction**

- `TradeOrderService` â†’ `AssetService.freeze/settleFromFrozen/changeBalance` âœ… ä¼ é€’
- `ExchangeService` â†’ `AssetService.changeBalance` âœ… ä¼ é€’
- `ConsumptionService` â†’ `AssetService.freeze` âœ… ä¼ é€’

**ä½†æ˜¯**: âš ï¸ **ç¼ºå°‘é™æ€æ£€æŸ¥æœºåˆ¶**ï¼Œæ— æ³•é˜²æ­¢æœªæ¥æœ‰äººå¿˜è®°ä¼ 

### 4.2 "å¿˜ä¼  transaction"é«˜å±æ–¹æ³•æ¸…å•

ä»¥ä¸‹æœåŠ¡æ–¹æ³•æ”¯æŒ `options.transaction`ï¼Œè‹¥è°ƒç”¨æ–¹å¿˜è®°ä¼ é€’ä¼šè‡ªå»ºæ–°äº‹åŠ¡ï¼š

| æœåŠ¡                | æ–¹æ³•                 | æ–‡ä»¶ä½ç½®                            | é£é™©ç­‰çº§  |
| ------------------- | -------------------- | ----------------------------------- | --------- |
| `AssetService`      | `changeBalance()`    | `services/AssetService.js:237`      | ğŸ”´ HIGH   |
| `AssetService`      | `freeze()`           | `services/AssetService.js:438`      | ğŸ”´ HIGH   |
| `AssetService`      | `unfreeze()`         | `services/AssetService.js:627`      | ğŸ”´ HIGH   |
| `AssetService`      | `settleFromFrozen()` | `services/AssetService.js:816`      | ğŸ”´ HIGH   |
| `TradeOrderService` | `createOrder()`      | `services/TradeOrderService.js:179` | ğŸŸ¡ MEDIUM |
| `TradeOrderService` | `completeOrder()`    | `services/TradeOrderService.js:434` | ğŸŸ¡ MEDIUM |
| `TradeOrderService` | `cancelOrder()`      | `services/TradeOrderService.js:712` | ğŸŸ¡ MEDIUM |
| `ExchangeService`   | `exchangeItem()`     | `services/ExchangeService.js:352`   | ğŸŸ¡ MEDIUM |
| `PrizePoolService`  | `batchAddPrizes()`   | `services/PrizePoolService.js:108`  | ğŸŸ  LOW    |

**é£é™©ç­‰çº§è¯´æ˜**:

- ğŸ”´ **HIGH**: åº•å±‚èµ„äº§æ“ä½œæœåŠ¡ï¼Œè¢«å¤šå¤„è°ƒç”¨ï¼Œå¿˜ä¼ å½±å“é¢å¤§
- ğŸŸ¡ **MEDIUM**: ä¸šåŠ¡ç¼–æ’æœåŠ¡ï¼Œé€šå¸¸ç”±è·¯ç”±å±‚ç›´æ¥è°ƒç”¨ï¼Œå¿˜ä¼ æ¦‚ç‡è¾ƒä½
- ğŸŸ  **LOW**: é…ç½®ç±»æ“ä½œï¼Œè°ƒç”¨é¢‘ç‡ä½

---

## 5. ä¸šåŠ¡é€»è¾‘ä¸å•†ä¸šæ¨¡å¼æ€»ç»“

### 5.1 æ ¸å¿ƒç»æµé“¾è·¯

#### é“¾è·¯1: ç§¯åˆ†æ¶ˆè´¹æŠ½å¥–

```
ç”¨æˆ·æ¶ˆè€— POINTS (100åˆ†/æ¬¡)
  â†’ lottery_draws è®°å½•æŠ½å¥–ç»“æœ
  â†’ asset_transactions (business_type='lottery_consume', delta_amount=-100)
  â†’ ä¸­å¥–åç”Ÿæˆ item_instancesï¼ˆç‰©å“å®ä¾‹ï¼‰
  â†’ item_instance_events è®°å½•ç‰©å“æµè½¬
```

**äº‹åŠ¡è¾¹ç•Œ**: `UnifiedLotteryEngine.execute_draw()` è‡ªå»ºäº‹åŠ¡ï¼ŒåŒ…å«ï¼š

- æ‰¹é‡æŠ½å¥–å¾ªç¯
- ç»Ÿä¸€ç§¯åˆ†æ‰£å‡ï¼ˆä¸€æ¬¡æ€§æ‰£å‡ N Ã— cost_pointsï¼‰
- å¥–å“å‘æ”¾ï¼ˆè°ƒç”¨å„ç­–ç•¥çš„ `executeLottery`ï¼‰

**ä¸€è‡´æ€§çŠ¶æ€**: âœ… æ–°è´¦æœ¬å¯ç”¨åæ•°æ®ä¸€è‡´

#### é“¾è·¯2: å•†å®¶æ¶ˆè´¹å½•å…¥ â†’ å®¡æ ¸ â†’ å‘æ”¾ç§¯åˆ†

```
å•†å®¶æäº¤æ¶ˆè´¹è®°å½•
  â†’ consumption_records (status='pending')
  â†’ content_review_records (audit_status='pending')
  â†’ å†»ç»“ç§¯åˆ†ï¼ˆé¢„ç•™å¥–åŠ±é¢åº¦ï¼‰

ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡
  â†’ consumption_records (status='approved')
  â†’ content_review_records (audit_status='approved')
  â†’ asset_transactions (business_type='consumption_reward', delta_amount=+å¥–åŠ±ç§¯åˆ†)
  â†’ asset_transactions (business_type='consumption_budget_allocation', asset_code='BUDGET_POINTS')
```

**äº‹åŠ¡è¾¹ç•Œ**:

- æäº¤: `ConsumptionService.merchantSubmitConsumption()` è‡ªå»ºäº‹åŠ¡
- å®¡æ ¸: `ConsumptionService.approveConsumption()` è‡ªå»ºäº‹åŠ¡

**ä¸€è‡´æ€§çŠ¶æ€**: âœ… æ¶ˆè´¹è®°å½•ä¸å®¡æ ¸è®°å½•çŠ¶æ€å®Œå…¨å¯¹åº”ï¼ˆ184æ¡ï¼‰

#### é“¾è·¯3: ææ–™å…‘æ¢å®ç‰©

```
ç”¨æˆ·é€‰æ‹©å…‘æ¢å•†å“ï¼ˆæ¶ˆè€—ææ–™èµ„äº§ï¼‰
  â†’ exchange_items æŸ¥è¯¢å•†å“é…ç½®
  â†’ asset_transactions (business_type='exchange_debit', delta_amount=-ææ–™æ•°é‡)
  â†’ exchange_records åˆ›å»ºå…‘æ¢è®°å½•
  â†’ åç»­ç‰©æµå‘è´§æµç¨‹
```

**äº‹åŠ¡è¾¹ç•Œ**: `ExchangeService.exchangeItem()` è‡ªå»ºäº‹åŠ¡

**ä¸€è‡´æ€§çŠ¶æ€**: âœ… å…‘æ¢æ‰£æ¬¾æµæ°´æ­£å¸¸ï¼ˆ95æ¡ï¼Œ-9500ï¼‰

#### é“¾è·¯4: DIAMOND äº¤æ˜“å¸‚åœºï¼ˆå½“å‰ç¯å¢ƒæ— æ•°æ®ï¼‰

```
å–å®¶æŒ‚ç‰Œï¼ˆç‰©å“æˆ–å¯å åŠ èµ„äº§ï¼‰
  â†’ market_listings (status='on_sale')

ä¹°å®¶ä¸‹å•
  â†’ trade_orders (status='created')
  â†’ å†»ç»“ä¹°å®¶ DIAMONDï¼ˆgross_amount = å•†å“ä»·æ ¼ + å¹³å°æ‰‹ç»­è´¹ï¼‰
  â†’ trade_orders (status='frozen')

å®Œæˆäº¤æ˜“
  â†’ ä»å†»ç»“æ‰£å‡ä¹°å®¶ DIAMOND
  â†’ å–å®¶å…¥è´¦ net_amountï¼ˆæ‰£é™¤æ‰‹ç»­è´¹ï¼‰
  â†’ å¹³å°æ‰‹ç»­è´¹å…¥è´¦ï¼ˆsystem_code='SYSTEM_PLATFORM_FEE'ï¼‰
  â†’ è½¬ç§»ç‰©å“æ‰€æœ‰æƒï¼ˆitem_instances.owner_user_idï¼‰
  â†’ trade_orders (status='completed')
  â†’ market_listings (status='sold')
```

**äº‹åŠ¡è¾¹ç•Œ**:

- ä¸‹å•: `TradeOrderService.createOrder()` è‡ªå»ºäº‹åŠ¡
- å®Œæˆ: `TradeOrderService.completeOrder()` è‡ªå»ºäº‹åŠ¡

**ä¸€è‡´æ€§çŠ¶æ€**: âš ï¸ å½“å‰ç¯å¢ƒ `trade_orders=0`ï¼Œæ— æ³•éªŒè¯

### 5.2 åŒè´¦æˆ·æ¨¡å‹ï¼ˆPOINTS + BUDGET_POINTSï¼‰

**å‘ç°**: æ¶ˆè´¹å®¡æ ¸é€šè¿‡æ—¶ä¼šåŒæ—¶å‘æ”¾ä¸¤ç§ç§¯åˆ†ï¼š

1. **POINTS**ï¼ˆç”¨æˆ·ç§¯åˆ†ï¼‰: ç”¨äºæŠ½å¥–æ¶ˆè´¹
2. **BUDGET_POINTS**ï¼ˆé¢„ç®—ç§¯åˆ†ï¼‰: ç”¨äºå¥–å“é¢„ç®—åˆ†é…

**è®¡ç®—å…¬å¼**ï¼ˆæ¥è‡ªä»£ç ï¼‰:

```javascript
// ç”¨æˆ·ç§¯åˆ† = æ¶ˆè´¹é‡‘é¢ Ã— å¥–åŠ±æ¯”ä¾‹ï¼ˆå¦‚ 1å…ƒ = 1åˆ†ï¼‰
const pointsToAward = consumption_amount * reward_ratio

// é¢„ç®—ç§¯åˆ† = æ¶ˆè´¹é‡‘é¢ Ã— é¢„ç®—ç³»æ•°ï¼ˆé»˜è®¤ 0.24ï¼‰
// ä¸šåŠ¡è§„åˆ™: å¹³å°æŠ½æˆ10% â†’ 80%ä½œä¸ºé¢„ç®— â†’ ä»·å€¼ç³»æ•°3å€
const budgetPointsToAllocate = consumption_amount * 0.24
```

---

## 6. æ²»ç†æ–¹æ¡ˆå»ºè®®

### 6.1 P0 - ç«‹å³æ‰§è¡Œï¼ˆå½±å“æ•°æ®ä¸€è‡´æ€§ï¼‰

> **å†³ç­–çŠ¶æ€**: âœ… å·²æ‹æ¿ï¼ˆ2026-01-04ï¼‰  
> **æˆ˜ç•¥é€‰æ‹©**: é‡‡ç”¨"å¼ºç¡¬æ¨¡å¼ + ç»Ÿä¸€å…¥å£"ç­–ç•¥

#### å»ºè®®1: äº‹åŠ¡è¾¹ç•Œè§„èŒƒåŒ– ã€âœ… å·²æ‹æ¿é‡‡ç”¨ã€‘

**ç›®æ ‡**: æ˜ç¡®"å…¥å£ç¼–æ’å±‚"æ¸…å•ï¼Œç»Ÿä¸€äº‹åŠ¡åˆ›å»ºä½ç½®

**å†³ç­–ç»“æœ**:
- âœ… é‡‡ç”¨**é€‰é¡¹Aï¼ˆç»Ÿä¸€å…¥å£ï¼‰**: è·¯ç”±/ä»»åŠ¡å…¥å£ç»Ÿä¸€ç”¨ `TransactionManager.execute()` å¼€äº‹åŠ¡
- âœ… æœåŠ¡å±‚é»˜è®¤ä¸è‡ªå»ºäº‹åŠ¡ï¼ˆé™¤å°‘æ•°"å…¥å£çº§æœåŠ¡"ï¼‰
- âš ï¸ ç ´åæ€§å˜æ›´ï¼šç°æœ‰æœåŠ¡å±‚è‡ªå»ºäº‹åŠ¡çš„ä»£ç éœ€è¦æ”¹é€ 

**å®æ–½æ­¥éª¤**:

1. åˆ—å‡ºæ‰€æœ‰"äº‹åŠ¡å…¥å£"ï¼ˆAPIè·¯ç”±ã€å®šæ—¶ä»»åŠ¡ã€æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è€…ï¼‰
2. å…¥å£å±‚ç»Ÿä¸€ä½¿ç”¨ `TransactionManager.execute()` åˆ›å»ºäº‹åŠ¡
3. æœåŠ¡å±‚é»˜è®¤ä¸è‡ªå»ºäº‹åŠ¡ï¼Œé™¤éå®ƒæœ¬èº«å°±æ˜¯å…¥å£

**ç¤ºä¾‹æ”¹é€ **:

```javascript
// âŒ æ”¹é€ å‰: æœåŠ¡å±‚è‡ªå»ºäº‹åŠ¡
class TradeOrderService {
  static async createOrder(params, options = {}) {
    const transaction = options.transaction || (await sequelize.transaction())
    // ...
  }
}

// âœ… æ”¹é€ å: å…¥å£å±‚ç»Ÿä¸€ç®¡ç†ï¼ˆå·²æ‹æ¿é‡‡ç”¨æ­¤æ–¹æ¡ˆï¼‰
// routes/v4/market/trade.js
router.post('/orders', async (req, res) => {
  const result = await TransactionManager.execute(async transaction => {
    return await TradeOrderService.createOrder(params, { transaction })
  })
  res.json(result)
})

// services/TradeOrderService.js
class TradeOrderService {
  static async createOrder(params, options = {}) {
    const transaction = options.transaction // å¼ºåˆ¶è¦æ±‚ä¼ å…¥
    if (!transaction) {
      throw new Error('createOrder å¿…é¡»åœ¨äº‹åŠ¡ä¸­è°ƒç”¨')
    }
    // ...
  }
}
```

#### å»ºè®®2: ç¦æ­¢"é™é»˜è„±ç¦»äº‹åŠ¡" ã€âœ… å·²æ‹æ¿é‡‡ç”¨ã€‘

**ç›®æ ‡**: è·¨è¡¨å†™å…¥ç±»æœåŠ¡æ–¹æ³•å¼ºåˆ¶è¦æ±‚ `transaction`

**å†³ç­–ç»“æœ**:
- âœ… é‡‡ç”¨**é€‰é¡¹Aï¼ˆå¼ºç¡¬ï¼Œæ¨èï¼‰**: å¯¹ `AssetService.*` è¿™ç±»è·¨è¡¨å†™å…¥æ–¹æ³•ï¼Œ**ä¸å†å…è®¸"æ²¡ä¼  transaction å°±è‡ªå»ºäº‹åŠ¡"**
- âœ… æ”¹ä¸ºå¿…é¡»åœ¨äº‹åŠ¡å†…è°ƒç”¨ï¼Œç¼ºå¤±å°±ç›´æ¥æŠ¥é”™
- âš ï¸ çŸ­æœŸé£é™©ï¼šå¯èƒ½æš´éœ²ç°æœ‰ä»£ç ä¸­éšè—çš„è°ƒç”¨ç‚¹ï¼Œéœ€è¦å…¨é¢æ’æŸ¥å’Œä¿®å¤

**å®æ–½æ­¥éª¤**:

1. è¯†åˆ«æ‰€æœ‰è·¨è¡¨å†™å…¥æ–¹æ³•ï¼ˆå¦‚ `AssetService.*`ï¼‰
2. ç§»é™¤ `options.transaction || (await sequelize.transaction())` çš„å…œåº•é€»è¾‘
3. æ”¹ä¸ºå¼ºåˆ¶è¦æ±‚ä¼ å…¥æˆ–ä» `TransactionContext` è·å–

**ç¤ºä¾‹æ”¹é€ **:

```javascript
// âŒ æ”¹é€ å‰: å¿˜ä¼ ä¼šè‡ªå»ºäº‹åŠ¡ï¼ˆå…è®¸é™é»˜è„±ç¦»ï¼‰
static async changeBalance(params, options = {}) {
  const transaction = options.transaction || (await sequelize.transaction())
  // ...
}

// âœ… æ”¹é€ å: å¼ºåˆ¶è¦æ±‚ä¼ å…¥ï¼ˆå·²æ‹æ¿é‡‡ç”¨æ­¤æ–¹æ¡ˆï¼‰
static async changeBalance(params, options = {}) {
  const transaction = options.transaction ||
    TransactionContext.getTransaction({ required: true })

  if (!transaction) {
    throw new Error('changeBalance å¿…é¡»åœ¨äº‹åŠ¡ä¸­è°ƒç”¨ï¼Œè¯·æ£€æŸ¥è°ƒç”¨é“¾')
  }
  // ...
}
```

**å®æ–½ä¼˜å…ˆçº§**: 
1. ğŸ”´ **HIGH**: `AssetService.*` (changeBalance, freeze, unfreeze, settleFromFrozen)
2. ğŸŸ¡ **MEDIUM**: `TradeOrderService.*`, `ExchangeService.*`
3. ğŸŸ  **LOW**: `PrizePoolService.*`

#### å»ºè®®3: èŠå¤©/å®¢æœé“¾è·¯çº³å…¥ç»Ÿä¸€ç¼–æ’ ã€âœ… å·²æ‹æ¿é‡‡ç”¨ã€‘

**ç›®æ ‡**: æ”¹é€  `CustomerServiceSessionService` ç­‰"å…¥å£çº§è‡ªç®¡ç†äº‹åŠ¡"æ–¹æ³•

**å†³ç­–ç»“æœ**:
- âœ… **èŠå¤©/å®¢æœé“¾è·¯éœ€è¦çº³å…¥ç»Ÿä¸€äº‹åŠ¡ç¼–æ’**
- âœ… `CustomerServiceSessionService.sendMessage()` æ”¹é€ ä¸ºæ”¯æŒå¤–éƒ¨äº‹åŠ¡
- âœ… ä¸å†ç»´æŒç‹¬ç«‹çš„è‡ªç®¡ç†äº‹åŠ¡ï¼ˆè™½ç„¶ä¼šå¢åŠ æ”¹é€ æˆæœ¬ï¼‰
- âŒ ä¸é‡‡ç”¨"æ˜ç¡®è§„å®šå®ƒæ˜¯å…¥å£çº§ã€ä¸Šå±‚æ°¸è¿œä¸åŒ…äº‹åŠ¡"çš„ä¿å®ˆæ–¹æ¡ˆ

**å®æ–½æ­¥éª¤**:

1. æ”¹é€ æ‰€æœ‰æ— æ¡ä»¶è‡ªå»ºäº‹åŠ¡çš„æ–¹æ³•ï¼ˆå¦‚ `CustomerServiceSessionService.sendMessage()`ï¼‰
2. ä»"è‡ªç®¡ç†äº‹åŠ¡"æ”¹ä¸º"å¯é€‰ä¼ é€’äº‹åŠ¡"æ¨¡å¼
3. ä¸Šå±‚è·¯ç”±ç»Ÿä¸€ç”¨ `TransactionManager.execute()` åŒ…è£¹

**ç¤ºä¾‹æ”¹é€ **:

```javascript
// âŒ æ”¹é€ å‰: æ— æ¡ä»¶è‡ªå»ºäº‹åŠ¡
static async sendMessage(session_id, data) {
  const transaction = await sequelize.transaction({ ... })
  try {
    // ...
    await transaction.commit()
  } catch (error) {
    await transaction.rollback()
    throw error
  }
}

// âœ… æ”¹é€ å: æ”¯æŒå¤–éƒ¨äº‹åŠ¡ï¼ˆå·²æ‹æ¿é‡‡ç”¨æ­¤æ–¹æ¡ˆï¼‰
static async sendMessage(session_id, data, options = {}) {
  const externalTransaction = options.transaction
  const transaction = externalTransaction || (await sequelize.transaction())

  try {
    // ...
    if (!externalTransaction) {
      await transaction.commit()
    }
    return result
  } catch (error) {
    if (!externalTransaction) {
      await transaction.rollback()
    }
    throw error
  }
}

// è·¯ç”±å±‚ç»Ÿä¸€ç¼–æ’
router.post('/sessions/:id/messages', async (req, res) => {
  const result = await TransactionManager.execute(async transaction => {
    return await CustomerServiceSessionService.sendMessage(
      req.params.id,
      req.body,
      { transaction }
    )
  })
  res.json(result)
})
```

**éœ€è¦æ”¹é€ çš„æ–¹æ³•æ¸…å•**:
- `CustomerServiceSessionService.sendMessage()`
- `CustomerServiceSessionService.transferSession()`
- `CustomerServiceSessionService.closeSession()`
- `CustomerServiceSessionService.markSessionAsRead()`
- `MaterialManagementService.createMaterialType()`
- `MaterialManagementService.updateMaterialType()`

### 6.2 P1 - è¿‘æœŸä¼˜åŒ–ï¼ˆæå‡ä»£ç è´¨é‡ï¼‰

#### å»ºè®®4: æ¨å¹¿ TransactionManager å’Œ TransactionContext

**ç›®æ ‡**: ç»Ÿä¸€äº‹åŠ¡ç®¡ç†æœºåˆ¶ï¼Œå‡å°‘æ ·æ¿ä»£ç 

**å®æ–½æ­¥éª¤**:

1. å®Œå–„ `TransactionManager.execute()` çš„é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘
2. åœ¨è·¯ç”±å±‚å…¨é¢æ¨å¹¿ä½¿ç”¨
3. æœåŠ¡å±‚é€šè¿‡ `TransactionContext.getTransaction()` è·å–äº‹åŠ¡

#### å»ºè®®5: æ·»åŠ é™æ€æ£€æŸ¥ï¼ˆESLintè§„åˆ™ï¼‰

**ç›®æ ‡**: é˜²æ­¢"å¿˜ä¼  transaction"

**å®æ–½æ­¥éª¤**:

1. ç¼–å†™è‡ªå®šä¹‰ ESLint è§„åˆ™ï¼Œæ£€æµ‹ä»¥ä¸‹æ¨¡å¼ï¼š

   ```javascript
   // æ£€æµ‹: AssetService.* è°ƒç”¨æ—¶ç¼ºå°‘ { transaction }
   await AssetService.changeBalance(params) // âŒ æŠ¥é”™
   await AssetService.changeBalance(params, { transaction }) // âœ… é€šè¿‡
   ```

2. åœ¨ CI/CD ä¸­å¼ºåˆ¶æ‰§è¡Œ

#### å»ºè®®6: å®Œå–„å•å…ƒæµ‹è¯•è¦†ç›–

**ç›®æ ‡**: éªŒè¯äº‹åŠ¡è¾¹ç•Œæ­£ç¡®æ€§

**æµ‹è¯•åœºæ™¯**:

1. äº‹åŠ¡æäº¤åœºæ™¯ï¼šå¤šè¡¨å†™å…¥æˆåŠŸï¼Œæ•°æ®ä¸€è‡´
2. äº‹åŠ¡å›æ»šåœºæ™¯ï¼šä¸­é—´æ­¥éª¤å¤±è´¥ï¼Œæ‰€æœ‰å†™å…¥å›æ»š
3. åµŒå¥—äº‹åŠ¡æ£€æµ‹ï¼šå¤–å±‚å›æ»šæ—¶ï¼Œå†…å±‚ä¸åº”å·²æäº¤
4. å¿˜ä¼  transactionï¼šåº”æŠ›å‡ºæ˜ç¡®é”™è¯¯è€Œéé™é»˜è‡ªå»ºäº‹åŠ¡

### 6.3 P2 - é•¿æœŸæ”¹è¿›ï¼ˆæŠ€æœ¯å€ºåŠ¡æ¸…ç†ï¼‰

#### å»ºè®®7: å†å²æ•°æ®æ¸…ç†ä¸é€»è¾‘å¤–é”®è¿ç§» ã€âœ… å·²æ‹æ¿é‡‡ç”¨ - ä¸ä¸Š FKã€‘

**ç›®æ ‡**: å»ºç«‹åº”ç”¨å±‚å¼ºä¸€è‡´æ€§ä¿è¯ï¼Œä¸ºæœªæ¥æ¼”è¿›ç•™å‡ºç©ºé—´

**å†³ç­–ç»“æœ**:
- âœ… é‡‡ç”¨**"æ¸…ç†åˆ é™¤"ç­–ç•¥**: ç›´æ¥åˆ é™¤ **2026-01-02 20:24:20** ä¹‹å‰çš„æ‰€æœ‰å†å²æ•°æ®
- âœ… é‡‡ç”¨**"é€»è¾‘å¤–é”®"æ¨¡å¼**: å…¨é‡å›å¡« + NOT NULL + ç´¢å¼•ï¼ˆ**ä¸åŠ  FK çº¦æŸ**ï¼‰
- âŒ ä¸å…¼å®¹è€æ•°æ®ï¼Œä¸ä¿ç•™å†å²è¡Œä¸ºè®°å½•
- âœ… åº”ç”¨å±‚å¼ºä¸€è‡´æ€§ä¿è¯ï¼ˆå¼ºåˆ¶äº‹åŠ¡ + åŒäº‹åŠ¡å†™å›å…³è”é”® + å®šæ—¶å¯¹è´¦å‘Šè­¦ï¼‰
- âœ… ä¸ºæœªæ¥åˆ†åº“åˆ†è¡¨/æœåŠ¡æ‹†åˆ†ç•™å‡ºæ¼”è¿›ç©ºé—´

**å†å²æ•°æ®å¤„ç†ç­–ç•¥**:

1. **æ—¶é—´åˆ†ç•Œçº¿**: `2026-01-02 20:24:20`ï¼ˆ`asset_transactions` è¡¨é¦–æ¡è®°å½•æ—¶é—´ï¼‰
2. **åˆ†ç•Œå‰æ•°æ®**: **ç›´æ¥åˆ é™¤**ï¼ˆå½»åº•æ¸…ç†ï¼‰
   - åˆ é™¤æ‰€æœ‰ `created_at < '2026-01-02 20:24:20'` çš„è®°å½•
   - æ¶‰åŠè¡¨ï¼š`lottery_draws`, `consumption_records`, `exchange_records`, `item_instances`, `item_instance_events` ç­‰
   - **ä¸ä¿ç•™**å†å²è¡Œä¸ºè®°å½•ï¼ˆæ¥å—æ•°æ®æŸå¤±ï¼‰
3. **åˆ†ç•Œåæ•°æ®**: **å¼ºçº¦æŸä¿è¯**
   - å…¨é‡å›å¡«å…³è”é”®ï¼ˆ`asset_transaction_id` ç­‰ï¼‰
   - å­—æ®µæ”¹ä¸º `NOT NULL`ï¼ˆå¼ºåˆ¶å¿…å¡«ï¼‰
   - æ·»åŠ å¤–é”®çº¦æŸ FKï¼ˆæ•°æ®åº“å±‚å…œåº•ï¼‰

**å®æ–½æ­¥éª¤**:

1. **å¤‡ä»½å½“å‰æ•°æ®åº“**ï¼ˆå®‰å…¨èµ·è§ï¼‰ï¼š
   ```bash
   mysqldump -h $DB_HOST -P $DB_PORT -u $DB_USER -p$DB_PASSWORD \
     $DB_NAME > backup_before_cleanup_$(date +%Y%m%d_%H%M%S).sql
   ```

2. **æ¸…ç†å†å²æ•°æ®**ï¼ˆæŒ‰ä¾èµ–é¡ºåºåˆ é™¤ï¼‰ï¼š
   ```sql
   -- æ—¶é—´åˆ†ç•Œçº¿
   SET @CUTOFF_DATE = '2026-01-02 20:24:20';
   
   -- åˆ é™¤å†å²æ•°æ®ï¼ˆæŒ‰å¤–é”®ä¾èµ–é¡ºåºï¼‰
   DELETE FROM item_instance_events WHERE created_at < @CUTOFF_DATE;
   DELETE FROM item_instances WHERE created_at < @CUTOFF_DATE;
   DELETE FROM exchange_records WHERE created_at < @CUTOFF_DATE;
   DELETE FROM content_review_records WHERE created_at < @CUTOFF_DATE;
   DELETE FROM consumption_records WHERE created_at < @CUTOFF_DATE;
   DELETE FROM lottery_draws WHERE created_at < @CUTOFF_DATE;
   
   -- éªŒè¯æ¸…ç†ç»“æœ
   SELECT 
     'lottery_draws' as table_name, 
     COUNT(*) as remaining_count, 
     MIN(created_at) as earliest_record
   FROM lottery_draws
   UNION ALL
   SELECT 'consumption_records', COUNT(*), MIN(created_at) FROM consumption_records
   UNION ALL
   SELECT 'exchange_records', COUNT(*), MIN(created_at) FROM exchange_records;
   ```

3. **å›å¡«å…³è”é”®**ï¼ˆæŒ‰ä¸šåŠ¡è§„åˆ™ç”Ÿæˆï¼‰ï¼š
   ```sql
   -- å›å¡« lottery_draws.asset_transaction_id
   -- å‡è®¾ï¼šä¸€ä¸ª lottery_session_id å¯¹åº”ä¸€æ¡æ‰£æ¬¾æµæ°´
   UPDATE lottery_draws ld
   INNER JOIN asset_transactions at 
     ON at.business_type = 'lottery_consume'
     AND at.idempotency_key = CONCAT('lottery_consume_', ld.lottery_session_id)
   SET ld.asset_transaction_id = at.transaction_id
   WHERE ld.created_at >= @CUTOFF_DATE;
   
   -- éªŒè¯å›å¡«ç»“æœ
   SELECT 
     COUNT(*) as total_draws,
     SUM(asset_transaction_id IS NOT NULL) as filled_count,
     SUM(asset_transaction_id IS NULL) as null_count
   FROM lottery_draws;
   ```

4. **æ·»åŠ  NOT NULL çº¦æŸå’Œç´¢å¼•**ï¼ˆç¡®ä¿å›å¡«å®Œæˆåæ‰§è¡Œï¼Œ**ä¸æ·»åŠ  FK**ï¼‰ï¼š
   ```sql
   -- ç¡®è®¤æ—  NULL å€¼åå†æ‰§è¡Œ
   SELECT COUNT(*) FROM lottery_draws WHERE asset_transaction_id IS NULL;
   -- å¦‚æœè¿”å› 0ï¼Œç»§ç»­æ‰§è¡Œ
   
   -- ä¿®æ”¹ä¸º NOT NULLï¼ˆå¼ºåˆ¶å¿…å¡«ï¼‰ã€âœ… å·²æ‹æ¿ï¼šæ–°è´¦æœ¬åˆ†ç•Œåæ•°æ®å…¨éƒ¨ NOT NULLã€‘
   ALTER TABLE lottery_draws 
     MODIFY COLUMN asset_transaction_id BIGINT NOT NULL COMMENT 'å…³è”çš„èµ„äº§æµæ°´IDï¼ˆé€»è¾‘å¤–é”®ï¼‰';
   
   -- âœ… æ·»åŠ ç´¢å¼•ï¼ˆæå‡æŸ¥è¯¢å’Œå¯¹è´¦æ€§èƒ½ï¼‰
   ALTER TABLE lottery_draws 
     ADD INDEX idx_asset_transaction_id (asset_transaction_id);
   
   -- âœ… æ·»åŠ ä¸šåŠ¡å”¯ä¸€é”®ï¼ˆå·²æ‹æ¿ï¼šå¿…é¡»åŠ ï¼‰
   ALTER TABLE lottery_draws 
     ADD UNIQUE INDEX uk_business_id (business_id) 
     COMMENT 'ä¸šåŠ¡å”¯ä¸€é”®ï¼Œé˜²æ­¢é‡å¤åˆ›å»ºæŠ½å¥–è®°å½•';
   
   -- âŒ ä¸æ·»åŠ å¤–é”®çº¦æŸï¼ˆå·²æ‹æ¿ï¼šå…¨åº“ä¸ä¸Š FKï¼‰
   -- æ”¹ç”¨åº”ç”¨å±‚ä¿è¯ï¼šå¼ºåˆ¶äº‹åŠ¡ + åŒäº‹åŠ¡å†™å›å…³è”é”® + å®šæ—¶å¯¹è´¦å‘Šè­¦
   ```

#### å»ºè®®8: é€»è¾‘å¤–é”®å…³è”é”®è®¾è®¡ ã€âœ… å·²æ‹æ¿é‡‡ç”¨ - æŒ‰ Session ç²’åº¦ï¼Œä¸ä¸Š FKã€‘

**ç›®æ ‡**: å»ºç«‹åº”ç”¨å±‚å¼ºä¸€è‡´æ€§ä¿è¯ï¼Œé€šè¿‡äº‹åŠ¡è¾¹ç•Œ + å¯¹è´¦å‘Šè­¦å…œåº•

**å†³ç­–ç»“æœ**:
- âœ… **æŠ½å¥–æ‰£æ¬¾å…³è”ç²’åº¦**: æŒ‰ **Session**ï¼ˆæ‰¹é‡æ‰£æ¬¾ï¼‰
  - ä¸€ä¸ª `lottery_session_id` å¯¹åº”ä¸€æ¡æ‰£æ¬¾æµæ°´ï¼ˆæ‰¹é‡æŠ½å¥–ä¸€æ¬¡æ€§æ‰£ NÃ—costï¼‰
  - å¤šæ¡ `lottery_draws` å…è®¸æŒ‡å‘åŒä¸€ä¸ª `asset_transaction_id`
  - **ä¸æ”¯æŒ**å•æŠ½æ’¤é”€ï¼ˆç®€åŒ–ä¸šåŠ¡é€»è¾‘ï¼‰
- âœ… **å…¨é‡å›å¡«** + **NOT NULL** + **ç´¢å¼•**ï¼ˆ**ä¸åŠ  FK çº¦æŸ**ï¼‰
- âœ… åº”ç”¨å±‚å…œåº•ï¼šå¼ºåˆ¶äº‹åŠ¡ + åŒäº‹åŠ¡å†™å›å…³è”é”® + å®šæ—¶å¯¹è´¦å‘Šè­¦ï¼ˆå‘ç°å·®å¼‚ï¼šå‘Šè­¦ + é˜»æ–­å‘å¸ƒ + è‡ªåŠ¨å†»ç»“å…¥å£ï¼‰

**å®æ–½æ­¥éª¤**:

1. **ç»™ `lottery_draws` å¢åŠ å¼ºçº¦æŸå…³è”é”®**:
   ```sql
   -- è¿ç§»æ–‡ä»¶: migrations/20260104_add_strong_constraints.js
   
   -- 1. æ·»åŠ å­—æ®µï¼ˆåˆå§‹å…è®¸ NULLï¼Œç”¨äºå›å¡«ï¼‰
   ALTER TABLE lottery_draws 
     ADD COLUMN asset_transaction_id BIGINT DEFAULT NULL 
       COMMENT 'å…³è”çš„èµ„äº§æµæ°´IDï¼ˆæŒ‰sessionæ‰¹é‡æ‰£æ¬¾ï¼‰',
     ADD COLUMN lottery_session_id VARCHAR(100) DEFAULT NULL 
       COMMENT 'æŠ½å¥–ä¼šè¯IDï¼ˆæ‰¹é‡æŠ½å¥–çš„å”¯ä¸€æ ‡è¯†ï¼‰';
   
   -- 2. å›å¡«æ•°æ®ï¼ˆæ ¹æ®å®é™…ä¸šåŠ¡é€»è¾‘ï¼‰
   -- ç¤ºä¾‹ï¼šæ ¹æ® idempotency_key å…³è”
   UPDATE lottery_draws ld
   INNER JOIN asset_transactions at 
     ON at.business_type = 'lottery_consume'
     AND at.idempotency_key = CONCAT('lottery_consume_', ld.lottery_session_id)
   SET ld.asset_transaction_id = at.transaction_id;
   
   -- 3. éªŒè¯å›å¡«å®Œæ•´æ€§
   SELECT COUNT(*) as null_count FROM lottery_draws 
   WHERE asset_transaction_id IS NULL OR lottery_session_id IS NULL;
   -- å¿…é¡»è¿”å› 0 æ‰èƒ½ç»§ç»­
   
   -- 4. æ”¹ä¸º NOT NULLï¼ˆå¼ºåˆ¶çº¦æŸï¼‰
   ALTER TABLE lottery_draws 
     MODIFY COLUMN asset_transaction_id BIGINT NOT NULL 
       COMMENT 'å…³è”çš„èµ„äº§æµæ°´IDï¼ˆæŒ‰sessionæ‰¹é‡æ‰£æ¬¾ï¼‰',
     MODIFY COLUMN lottery_session_id VARCHAR(100) NOT NULL 
       COMMENT 'æŠ½å¥–ä¼šè¯IDï¼ˆæ‰¹é‡æŠ½å¥–çš„å”¯ä¸€æ ‡è¯†ï¼‰';
   
   -- 5. æ·»åŠ ç´¢å¼•å’Œä¸šåŠ¡å”¯ä¸€é”®ï¼ˆæå‡æŸ¥è¯¢å’Œå¯¹è´¦æ€§èƒ½ï¼‰
   ALTER TABLE lottery_draws 
     ADD INDEX idx_asset_transaction_id (asset_transaction_id),
     ADD INDEX idx_lottery_session_id (lottery_session_id),
     ADD UNIQUE INDEX uk_business_id (business_id) 
       COMMENT 'ä¸šåŠ¡å”¯ä¸€é”®ï¼Œé˜²æ­¢é‡å¤åˆ›å»ºæŠ½å¥–è®°å½•';
   
   -- âŒ ä¸æ·»åŠ å¤–é”®çº¦æŸï¼ˆå·²æ‹æ¿ï¼šå…¨åº“ä¸ä¸Š FKï¼‰
   -- æ”¹ç”¨åº”ç”¨å±‚ä¿è¯ï¼š
   -- 1. å¼ºåˆ¶äº‹åŠ¡è¾¹ç•Œï¼ˆTransactionManager.executeï¼‰
   -- 2. åŒäº‹åŠ¡å†…å†™å›å…³è”é”®ï¼ˆå…ˆåˆ›å»ºæµæ°´ï¼Œå†å†™å› asset_transaction_idï¼‰
   -- 3. å®šæ—¶å¯¹è´¦å‘Šè­¦ï¼ˆæ¯å°æ—¶æ‰§è¡Œï¼›å‘ç°å·®å¼‚ï¼šå‘Šè­¦ + é˜»æ–­å‘å¸ƒ + è‡ªåŠ¨å†»ç»“å…¥å£ï¼‰
   -- 4. ä¸šåŠ¡å”¯ä¸€é”®é˜²æ­¢é‡å¤åˆ›å»ºï¼ˆå·²æ‹æ¿ï¼‰
   ```

2. **ç»™ `consumption_records` å¢åŠ å¼ºçº¦æŸå…³è”é”®**:
   ```sql
   -- 1. æ·»åŠ å­—æ®µ
   ALTER TABLE consumption_records
     ADD COLUMN reward_transaction_id BIGINT DEFAULT NULL 
       COMMENT 'å¥–åŠ±æµæ°´IDï¼ˆå®¡æ ¸é€šè¿‡åå‘æ”¾ï¼‰';
   
   -- 2. å›å¡«æ•°æ®ï¼ˆä»… status='approved' çš„è®°å½•ï¼‰
   UPDATE consumption_records cr
   INNER JOIN asset_transactions at 
     ON at.business_type = 'consumption_reward'
     AND at.idempotency_key = CONCAT('consumption_reward_', cr.consumption_record_id)
   SET cr.reward_transaction_id = at.transaction_id
   WHERE cr.status = 'approved';
   
   -- 3. éªŒè¯ï¼šapproved çŠ¶æ€å¿…é¡»æœ‰æµæ°´
   SELECT COUNT(*) FROM consumption_records 
   WHERE status = 'approved' AND reward_transaction_id IS NULL;
   -- å¿…é¡»è¿”å› 0
   
   -- 4. æ·»åŠ æ¡ä»¶çº¦æŸï¼ˆapproved å¿…é¡»æœ‰æµæ°´ï¼‰
   ALTER TABLE consumption_records
     ADD CONSTRAINT chk_approved_has_reward
     CHECK (status != 'approved' OR reward_transaction_id IS NOT NULL);
   
   -- 5. æ·»åŠ ç´¢å¼•å’Œä¸šåŠ¡å”¯ä¸€é”®ï¼ˆä¸æ·»åŠ å¤–é”®ï¼‰
   ALTER TABLE consumption_records
     ADD INDEX idx_reward_transaction_id (reward_transaction_id),
     ADD UNIQUE INDEX uk_business_id (business_id) 
       COMMENT 'ä¸šåŠ¡å”¯ä¸€é”®ï¼Œé˜²æ­¢é‡å¤åˆ›å»ºæ¶ˆè´¹è®°å½•';
   
   -- âŒ ä¸æ·»åŠ å¤–é”®çº¦æŸï¼ˆå·²æ‹æ¿ï¼šå…¨åº“ä¸ä¸Š FKï¼‰
   -- æ”¹ç”¨åº”ç”¨å±‚ä¿è¯ + å¯¹è´¦å‘Šè­¦
   ```

3. **ç»™ `exchange_records` å¢åŠ å¼ºçº¦æŸå…³è”é”®**:
   ```sql
   -- 1. æ·»åŠ å­—æ®µ
   ALTER TABLE exchange_records
     ADD COLUMN debit_transaction_id BIGINT DEFAULT NULL 
       COMMENT 'æ‰£æ¬¾æµæ°´IDï¼ˆå…‘æ¢æ—¶æ‰£å‡ææ–™ï¼‰';
   
   -- 2. å›å¡«æ•°æ®
   UPDATE exchange_records er
   INNER JOIN asset_transactions at 
     ON at.business_type = 'exchange_debit'
     AND at.idempotency_key = CONCAT('exchange_', er.exchange_record_id)
   SET er.debit_transaction_id = at.transaction_id;
   
   -- 3. éªŒè¯å›å¡«å®Œæ•´æ€§
   SELECT COUNT(*) FROM exchange_records WHERE debit_transaction_id IS NULL;
   -- å¿…é¡»è¿”å› 0
   
   -- 4. æ”¹ä¸º NOT NULL
   ALTER TABLE exchange_records
     MODIFY COLUMN debit_transaction_id BIGINT NOT NULL 
       COMMENT 'æ‰£æ¬¾æµæ°´IDï¼ˆå…‘æ¢æ—¶æ‰£å‡ææ–™ï¼‰';
   
   -- 5. æ·»åŠ ç´¢å¼•å’Œä¸šåŠ¡å”¯ä¸€é”®ï¼ˆä¸æ·»åŠ å¤–é”®ï¼‰
   ALTER TABLE exchange_records
     ADD INDEX idx_debit_transaction_id (debit_transaction_id),
     ADD UNIQUE INDEX uk_business_id (business_id) 
       COMMENT 'ä¸šåŠ¡å”¯ä¸€é”®ï¼Œé˜²æ­¢é‡å¤åˆ›å»ºå…‘æ¢è®°å½•';
   
   -- âŒ ä¸æ·»åŠ å¤–é”®çº¦æŸï¼ˆå·²æ‹æ¿ï¼šå…¨åº“ä¸ä¸Š FKï¼‰
   -- æ”¹ç”¨åº”ç”¨å±‚ä¿è¯ + å¯¹è´¦å‘Šè­¦
   ```

4. **ä»£ç é€»è¾‘æ”¹é€ ï¼ˆå¼ºåˆ¶å…³è”ï¼‰**:
   ```javascript
   // services/UnifiedLotteryEngine.js (æŠ½å¥–é€»è¾‘)
   
   // 1. ç”Ÿæˆ lottery_session_idï¼ˆæ‰¹é‡æŠ½å¥–çš„å”¯ä¸€æ ‡è¯†ï¼‰
   const lottery_session_id = `session_${user_id}_${Date.now()}_${randomString(8)}`
   
   // 2. åˆ›å»ºæ‰£æ¬¾æµæ°´ï¼ˆä¸€æ¬¡æ€§æ‰£ NÃ—costï¼‰
   const costTx = await AssetService.changeBalance({
     user_id: user_id,
     asset_code: 'POINTS',
     delta_amount: -totalCost,
     business_type: 'lottery_consume',
     idempotency_key: `lottery_consume_${lottery_session_id}`  // âœ… å…³é”®ï¼šä¸ session_id å…³è”
   }, { transaction })
   
   // 3. åˆ›å»ºæŠ½å¥–è®°å½•ï¼ˆå¤šæ¡ draws æŒ‡å‘åŒä¸€ä¸ªæµæ°´ï¼‰
   for (const drawResult of draws) {
     await LotteryDraw.create({
       user_id: user_id,
       lottery_session_id: lottery_session_id,  // âœ… å¿…å¡«
       asset_transaction_id: costTx.transaction_record.transaction_id,  // âœ… å¿…å¡«
       cost_points: costPerDraw,
       prize_id: drawResult.prize_id,
       // ...
     }, { transaction })
   }
   ```

5. **å¯¹è´¦è„šæœ¬ç®€åŒ–**ï¼ˆæ•°æ®åº“çº¦æŸå·²ä¿è¯ä¸€è‡´æ€§ï¼‰:
   ```javascript
   // scripts/diagnostic/check_transaction_consistency.js
   
   // ç”±äºæœ‰ FK çº¦æŸï¼Œç†è®ºä¸Šä¸ä¼šå‡ºç°ä¸ä¸€è‡´
   // ä½†ä»å¯åšå®šæœŸæ ¡éªŒï¼ˆæ£€æŸ¥ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼‰
   
   // æ£€æŸ¥ï¼šæ¯ä¸ª session çš„ draws æ•°é‡ Ã— cost æ˜¯å¦ç­‰äºæµæ°´é‡‘é¢
   const [inconsistent] = await sequelize.query(`
     SELECT 
       ld.lottery_session_id,
       COUNT(*) as draw_count,
       SUM(ld.cost_points) as total_cost,
       -at.delta_amount as transaction_amount,
       (SUM(ld.cost_points) + at.delta_amount) as diff
     FROM lottery_draws ld
     INNER JOIN asset_transactions at ON ld.asset_transaction_id = at.transaction_id
     GROUP BY ld.lottery_session_id, at.transaction_id
     HAVING diff != 0
   `)
   
   if (inconsistent.length > 0) {
     console.error('âš ï¸ å‘ç°é‡‘é¢ä¸ä¸€è‡´çš„æŠ½å¥–ä¼šè¯:', inconsistent)
     // è¿™ç§æƒ…å†µç†è®ºä¸Šä¸åº”è¯¥å‡ºç°ï¼ˆè¯´æ˜ä¸šåŠ¡é€»è¾‘æœ‰bugï¼‰
   }
   ```

**åº”ç”¨å±‚å¼ºä¸€è‡´ä¿è¯çš„æ•ˆæœ**:
- âœ… **å†™å…¥æ—¶ä¿è¯**: ä»»ä½•"æœ‰ä¸šåŠ¡è®°å½•æ²¡æµæ°´"éƒ½ä¼šå›  NOT NULL çº¦æŸå¤±è´¥
- âœ… **äº‹åŠ¡è¾¹ç•Œä¿è¯**: åŒä¸€äº‹åŠ¡å†…åˆ›å»ºæµæ°´åç«‹å³å†™å›å…³è”é”®ï¼Œä¿è¯åŸå­æ€§
- âœ… **å¯¹è´¦å…œåº•**: å®šæ—¶å¯¹è´¦å‘ç°å·®å¼‚ç«‹å³å‘Šè­¦ + é˜»æ–­å‘å¸ƒ + è‡ªåŠ¨å†»ç»“å…¥å£ï¼Œäººå·¥ä¿®å¤åå¤æ ¸
- âœ… **æ¼”è¿›å‹å¥½**: ä¸å— FK çº¦æŸé™åˆ¶ï¼Œæœªæ¥åˆ†åº“åˆ†è¡¨/æœåŠ¡æ‹†åˆ†æˆæœ¬ä½
- âš ï¸ **ä¾èµ–å·¥ç¨‹çºªå¾‹**: éœ€è¦ä¸¥æ ¼éµå®ˆäº‹åŠ¡è¾¹ç•Œè§„èŒƒï¼Œå®šæœŸå¯¹è´¦ä¸å¯ç¼ºå¤±

#### å»ºè®®9: æ›¿ä»£ FK çš„åº”ç”¨å±‚å¼ºä¸€è‡´æ€§ä¿è¯ä½“ç³» ã€âœ… å·²æ‹æ¿é‡‡ç”¨ã€‘

**ç›®æ ‡**: åœ¨ä¸ä½¿ç”¨æ•°æ®åº“ FK çš„å‰æä¸‹ï¼Œé€šè¿‡åº”ç”¨å±‚æœºåˆ¶ä¿è¯æ•°æ®å¼ºä¸€è‡´æ€§

**æ ¸å¿ƒæªæ–½**:

##### 9.1 åº”ç”¨å±‚å¼ºåˆ¶çº¦æŸ

**æªæ–½1: åŒä¸€äº‹åŠ¡å†…åˆ›å»ºæµæ°´å¹¶å†™å›å…³è”é”®**

```javascript
// services/UnifiedLotteryEngine.js (æŠ½å¥–é€»è¾‘)

static async execute_draw(params, options = {}) {
  // âœ… å¿…é¡»åœ¨äº‹åŠ¡å†…è°ƒç”¨ï¼ˆå·²æ‹æ¿ï¼šå¼ºåˆ¶äº‹åŠ¡è¾¹ç•Œï¼‰
  const transaction = options.transaction
  if (!transaction) {
    throw new Error('execute_draw å¿…é¡»åœ¨äº‹åŠ¡ä¸­è°ƒç”¨')
  }

  // 1. ç”Ÿæˆ lottery_session_idï¼ˆæ‰¹é‡æŠ½å¥–çš„å”¯ä¸€æ ‡è¯†ï¼‰
  const lottery_session_id = `session_${user_id}_${Date.now()}_${randomString(8)}`

  // 2. å…ˆåˆ›å»ºæ‰£æ¬¾æµæ°´ï¼ˆä¸€æ¬¡æ€§æ‰£ NÃ—costï¼‰
  const costTx = await AssetService.changeBalance({
    user_id: user_id,
    asset_code: 'POINTS',
    delta_amount: -totalCost,
    business_type: 'lottery_consume',
    idempotency_key: `lottery_consume_${lottery_session_id}`
  }, { transaction })  // âœ… ä¼ é€’äº‹åŠ¡

  // 3. ç«‹å³å†™å›å…³è”é”®åˆ°ä¸šåŠ¡è¡¨ï¼ˆåŒä¸€äº‹åŠ¡å†…ï¼‰
  for (const drawResult of draws) {
    await LotteryDraw.create({
      user_id: user_id,
      lottery_session_id: lottery_session_id,
      asset_transaction_id: costTx.transaction_record.transaction_id,  // âœ… ç«‹å³å†™å›
      cost_points: costPerDraw,
      prize_id: drawResult.prize_id,
      // ...
    }, { transaction })  // âœ… åŒä¸€äº‹åŠ¡
  }

  // 4. äº‹åŠ¡æäº¤åï¼Œæµæ°´å’Œå…³è”é”®è¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å›æ»š
  // ä¸ä¼šå‡ºç°"æœ‰æµæ°´æ²¡ä¸šåŠ¡è®°å½•"æˆ–"æœ‰ä¸šåŠ¡è®°å½•æ²¡æµæ°´"çš„æƒ…å†µ
}
```

**æªæ–½2: å¹‚ç­‰é”®å”¯ä¸€çº¦æŸï¼ˆé˜²æ­¢é‡å¤å†™å…¥ï¼‰** ã€âœ… å·²æ‹æ¿ã€‘

**å¹‚ç­‰é”®çº¦æŸç­–ç•¥**ï¼ˆå·²æ‹æ¿é‡‡ç”¨é€‰é¡¹B - æ›´å¼ºï¼‰:
- âœ… `asset_transactions.idempotency_key` å¿…é¡» UNIQUEï¼ˆåº•çº¿ï¼‰
- âœ… **ä¸šåŠ¡è¡¨ä¹ŸåŠ ä¸šåŠ¡å”¯ä¸€é”®**ï¼ˆæ›´å¼ºä¿è¯ï¼‰

```sql
-- 1. èµ„äº§æµæ°´è¡¨å¹‚ç­‰é”®ï¼ˆå¿…é¡»ï¼‰
ALTER TABLE asset_transactions
  ADD UNIQUE INDEX uk_idempotency_key (idempotency_key);

-- 2. ä¸šåŠ¡è¡¨ä¸šåŠ¡å”¯ä¸€é”®ï¼ˆå·²æ‹æ¿ï¼šä¹Ÿè¦åŠ ï¼‰
ALTER TABLE lottery_draws
  ADD UNIQUE INDEX uk_business_id (business_id)
  COMMENT 'ä¸šåŠ¡å”¯ä¸€é”®ï¼Œé˜²æ­¢é‡å¤åˆ›å»ºæŠ½å¥–è®°å½•';

ALTER TABLE consumption_records
  ADD UNIQUE INDEX uk_business_id (business_id)
  COMMENT 'ä¸šåŠ¡å”¯ä¸€é”®ï¼Œé˜²æ­¢é‡å¤åˆ›å»ºæ¶ˆè´¹è®°å½•';

ALTER TABLE exchange_records
  ADD UNIQUE INDEX uk_business_id (business_id)
  COMMENT 'ä¸šåŠ¡å”¯ä¸€é”®ï¼Œé˜²æ­¢é‡å¤åˆ›å»ºå…‘æ¢è®°å½•';

ALTER TABLE trade_orders
  ADD UNIQUE INDEX uk_business_id (business_id)
  COMMENT 'ä¸šåŠ¡å”¯ä¸€é”®ï¼Œé˜²æ­¢é‡å¤åˆ›å»ºè®¢å•';
```

**ä¸šåŠ¡å”¯ä¸€é”®ç”Ÿæˆè§„åˆ™**:

```javascript
// ç»Ÿä¸€çš„ä¸šåŠ¡å”¯ä¸€é”®ç”Ÿæˆå™¨
class BusinessIdGenerator {
  // æŠ½å¥–è®°å½•ä¸šåŠ¡å”¯ä¸€é”®
  static generateLotteryDrawId(userId, lotterySessionId, drawIndex) {
    return `lottery_draw_${userId}_${lotterySessionId}_${drawIndex}`
  }
  
  // æ¶ˆè´¹è®°å½•ä¸šåŠ¡å”¯ä¸€é”®
  static generateConsumptionId(merchantId, timestamp, randomSuffix) {
    return `consumption_${merchantId}_${timestamp}_${randomSuffix}`
  }
  
  // å…‘æ¢è®°å½•ä¸šåŠ¡å”¯ä¸€é”®
  static generateExchangeId(userId, exchangeItemId, timestamp) {
    return `exchange_${userId}_${exchangeItemId}_${timestamp}`
  }
  
  // äº¤æ˜“è®¢å•ä¸šåŠ¡å”¯ä¸€é”®
  static generateTradeOrderId(buyerId, listingId, timestamp) {
    return `trade_order_${buyerId}_${listingId}_${timestamp}`
  }
}

// åœ¨åˆ›å»ºä¸šåŠ¡è®°å½•æ—¶ä½¿ç”¨
await LotteryDraw.create({
  business_id: BusinessIdGenerator.generateLotteryDrawId(userId, sessionId, index),
  user_id: userId,
  lottery_session_id: sessionId,
  asset_transaction_id: txId,
  // ...
}, { transaction })
```

**æªæ–½3: å…³é”®å­—æ®µç´¢å¼•ï¼ˆæå‡å¯¹è´¦æ€§èƒ½ï¼‰**

```sql
-- é€»è¾‘å¤–é”®å­—æ®µå¿…é¡»æœ‰ç´¢å¼•
ALTER TABLE lottery_draws
  ADD INDEX idx_asset_transaction_id (asset_transaction_id),
  ADD INDEX idx_lottery_session_id (lottery_session_id);

ALTER TABLE consumption_records
  ADD INDEX idx_reward_transaction_id (reward_transaction_id);

ALTER TABLE exchange_records
  ADD INDEX idx_debit_transaction_id (debit_transaction_id);
```

##### 9.2 å®šæ—¶å¯¹è´¦ä¸å‘Šè­¦æœºåˆ¶

**å¯¹è´¦è„šæœ¬1: æŠ½å¥–æ‰£æ¬¾ä¸€è‡´æ€§æ£€æŸ¥**

```javascript
// scripts/monitoring/check_lottery_consistency.js

const CUTOFF_DATE = '2026-01-02 20:24:20'  // æ–°è´¦æœ¬å¯ç”¨æ—¶é—´

async function checkLotteryConsistency() {
  // æŒ‰ lottery_session_id èšåˆæ£€æŸ¥
  const [inconsistent] = await sequelize.query(`
    SELECT 
      ld.lottery_session_id,
      COUNT(*) as draw_count,
      SUM(ld.cost_points) as total_cost_in_draws,
      -at.delta_amount as transaction_amount,
      (SUM(ld.cost_points) + at.delta_amount) as diff
    FROM lottery_draws ld
    LEFT JOIN asset_transactions at 
      ON ld.asset_transaction_id = at.transaction_id
    WHERE ld.created_at >= ?
    GROUP BY ld.lottery_session_id, at.transaction_id
    HAVING diff != 0 OR at.transaction_id IS NULL
  `, { replacements: [CUTOFF_DATE] })

  if (inconsistent.length > 0) {
    // âœ… å·²æ‹æ¿ï¼ˆ2026-01-05ï¼‰ï¼šå‘Šè­¦ + é˜»æ–­å‘å¸ƒ + è‡ªåŠ¨å†»ç»“å…¥å£
    // 1. å‘é€å‘Šè­¦é€šçŸ¥
    // 2. è¿”å›éé›¶é€€å‡ºç ï¼ˆé˜»æ–­ CI/CD éƒ¨ç½²ï¼‰
    // 3. å†»ç»“ç›¸å…³ä¸šåŠ¡å…¥å£ï¼ˆé˜²æ­¢è„æ•°æ®æ‰©æ•£ï¼‰
    process.exitCode = 1
    
    return { status: 'FAILED', inconsistent }
  }

  return { status: 'PASSED', message: 'æŠ½å¥–æ‰£æ¬¾æ•°æ®ä¸€è‡´' }
}

// å®šæ—¶æ‰§è¡Œï¼ˆæ¯å°æ—¶ï¼‰
schedule.scheduleJob('0 * * * *', checkLotteryConsistency)
```

**å¯¹è´¦è„šæœ¬2: æ¶ˆè´¹å¥–åŠ±ä¸€è‡´æ€§æ£€æŸ¥**

```javascript
// scripts/monitoring/check_consumption_consistency.js

const CUTOFF_DATE = '2026-01-02 20:24:20'  // æ–°è´¦æœ¬å¯ç”¨æ—¶é—´

async function checkConsumptionConsistency() {
  // æ£€æŸ¥ï¼šæ‰€æœ‰ approved çŠ¶æ€çš„æ¶ˆè´¹è®°å½•å¿…é¡»æœ‰å¯¹åº”çš„å¥–åŠ±æµæ°´
  // å¹‚ç­‰é”®æ ¼å¼ï¼šconsumption_reward:approve:{record_id}ï¼ˆä¸ ConsumptionService.approveConsumption() ä»£ç ä¸€è‡´ï¼‰
  const [missing] = await sequelize.query(`
    SELECT 
      cr.record_id,
      cr.user_id,
      cr.consumption_amount,
      cr.points_to_award,
      cr.status,
      cr.idempotency_key,
      cr.created_at
    FROM consumption_records cr
    LEFT JOIN asset_transactions atx 
      ON atx.idempotency_key = CONCAT('consumption_reward:approve:', cr.record_id)
      AND atx.business_type = 'consumption_reward'
    WHERE cr.status = 'approved'
      AND cr.created_at >= ?
      AND atx.transaction_id IS NULL
  `, { replacements: [CUTOFF_DATE] })

  if (missing.length > 0) {
    // âœ… å·²æ‹æ¿ï¼ˆ2026-01-05ï¼‰ï¼šé˜»æ–­å‘å¸ƒ + è‡ªåŠ¨å†»ç»“å…¥å£
    // 1. è¿”å›éé›¶é€€å‡ºç ï¼ˆé˜»æ–­å‘å¸ƒï¼‰
    // 2. å†»ç»“ç›¸å…³ä¸šåŠ¡å…¥å£ï¼ˆé˜²æ­¢è„æ•°æ®æ‰©æ•£ï¼‰
    // æ³¨ï¼šå¹‚ç­‰é”®æ ¼å¼ consumption_reward:approve:{record_id}
    process.exitCode = 1
    
    return { status: 'FAILED', missing }
  }

  console.log('âœ… æ¶ˆè´¹å¥–åŠ±ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡ï¼ˆåˆ†ç•Œçº¿åæ•°æ®ï¼‰')
  return { status: 'PASSED' }
}

// å®šæ—¶æ‰§è¡Œï¼ˆæ¯å°æ—¶ï¼‰
schedule.scheduleJob('5 * * * *', checkConsumptionConsistency)  // æ¯å°æ—¶ç¬¬5åˆ†é’Ÿæ‰§è¡Œ
```

**å¯¹è´¦è„šæœ¬3: å…‘æ¢æ‰£æ¬¾ä¸€è‡´æ€§æ£€æŸ¥**

```javascript
// scripts/monitoring/check_exchange_consistency.js

async function checkExchangeConsistency() {
  const [inconsistent] = await sequelize.query(`
    SELECT 
      er.exchange_record_id,
      er.material_cost,
      er.debit_transaction_id,
      at.delta_amount
    FROM exchange_records er
    LEFT JOIN asset_transactions at 
      ON er.debit_transaction_id = at.transaction_id
    WHERE er.created_at >= ?
      AND (
        at.transaction_id IS NULL
        OR -at.delta_amount != er.material_cost
      )
  `, { replacements: [CUTOFF_DATE] })

  if (inconsistent.length > 0) {
    // âœ… å·²æ‹æ¿ï¼ˆ2026-01-05ï¼‰ï¼šå‘Šè­¦ + é˜»æ–­å‘å¸ƒ + è‡ªåŠ¨å†»ç»“å…¥å£
    // 1. å‘é€å‘Šè­¦é€šçŸ¥
    // 2. è¿”å›éé›¶é€€å‡ºç ï¼ˆé˜»æ–­ CI/CD éƒ¨ç½²ï¼‰
    // 3. å†»ç»“ç›¸å…³ä¸šåŠ¡å…¥å£ï¼ˆé˜²æ­¢è„æ•°æ®æ‰©æ•£ï¼‰
    process.exitCode = 1
    
    return { status: 'FAILED', inconsistent }
  }

  return { status: 'PASSED' }
}
```

##### 9.3 å‘Šè­¦ä¸å¤„ç½®æµç¨‹ã€âœ… å·²æ‹æ¿ã€‘

**å‘Šè­¦ç­–ç•¥**ï¼ˆ2026-01-05 å·²æ‹æ¿é‡‡ç”¨æœ€å¼ºå¤„ç½®ï¼‰:

| å‘Šè­¦çº§åˆ« | è§¦å‘æ¡ä»¶ | å¤„ç½®åŠ¨ä½œ |
|---------|---------|---------|
| **CRITICAL** | å‘ç°æ•°æ®ä¸ä¸€è‡´ | âœ… **å·²æ‹æ¿é‡‡ç”¨é€‰é¡¹Cï¼ˆæœ€å¼ºï¼‰**ï¼š<br>1. **é˜»æ–­å‘å¸ƒ**<br>2. **è‡ªåŠ¨å†»ç»“ç›¸å…³å…¥å£**ï¼ˆé˜²æ­¢è„æ•°æ®æ‰©æ•£ï¼‰<br>3. è§¦å‘äººå·¥ä»‹å…¥ä¿®å¤ |
| **WARNING** | å¯¹è´¦è„šæœ¬æ‰§è¡Œå¤±è´¥ | 1. è®°å½•æ—¥å¿—<br>2. é‡è¯•æ‰§è¡Œ |
| **INFO** | å¯¹è´¦é€šè¿‡ | è®°å½•æ—¥å¿— |

**å¯¹è´¦é¢‘ç‡**:
- âœ… **æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡**
- æ‰§è¡Œæ—¶é—´ï¼šæ¯å°æ—¶çš„ç¬¬5åˆ†é’Ÿï¼ˆå¦‚ 01:05, 02:05, ...ï¼‰
- è¦†ç›–çª—å£ï¼šæ£€æŸ¥è¿‡å»1å°æ—¶çš„æ•°æ®

**é˜»æ–­å‘å¸ƒæœºåˆ¶**ï¼ˆå·²æ‹æ¿ï¼šå¼ºåˆ¶é˜»æ–­ï¼‰:
- å¯¹è´¦æ£€æŸ¥å¤±è´¥æ—¶è¿”å›éé›¶é€€å‡ºç 
- éœ€è¦äººå·¥ä¿®å¤å¹¶éªŒè¯é€šè¿‡åæ‰èƒ½ç»§ç»­å‘å¸ƒ

**è‡ªåŠ¨å†»ç»“å…¥å£æœºåˆ¶**ï¼ˆå·²æ‹æ¿ï¼šå‘ç°ä¸ä¸€è‡´ç«‹å³å†»ç»“ï¼‰:

å¯¹è´¦è„šæœ¬å‘ç°æ•°æ®ä¸ä¸€è‡´æ—¶ï¼Œåº”è‡ªåŠ¨å†»ç»“ç›¸å…³ä¸šåŠ¡å…¥å£é˜²æ­¢è„æ•°æ®æ‰©æ•£ï¼š
- æŠ½å¥–æ•°æ®ä¸ä¸€è‡´ â†’ å†»ç»“æŠ½å¥–å…¥å£
- æ¶ˆè´¹å®¡æ ¸ä¸ä¸€è‡´ â†’ å†»ç»“æ¶ˆè´¹å®¡æ ¸å…¥å£
- å…‘æ¢æ•°æ®ä¸ä¸€è‡´ â†’ å†»ç»“å…‘æ¢å…¥å£
- éœ€äººå·¥ä¿®å¤åæ‰‹åŠ¨è§£å†»

##### 9.4 è¡¥å¿ä¿®å¤æœºåˆ¶ ã€âœ… å·²æ‹æ¿ï¼šä»…äººå·¥ä¿®å¤ã€‘

**è¡¥å¿ä¿®å¤ç­–ç•¥**ï¼ˆå·²æ‹æ¿é‡‡ç”¨é€‰é¡¹A - æœ€å®‰å…¨ï¼‰:
- âœ… **åªå…è®¸äººå·¥ä¿®å¤**ï¼ˆä¸å…è®¸è‡ªåŠ¨è¡¥å¿ï¼‰
- âœ… å‘ç°ä¸ä¸€è‡´åï¼šå‘Šè­¦ â†’ é˜»æ–­å‘å¸ƒ â†’ å†»ç»“å…¥å£ â†’ **äººå·¥ä»‹å…¥ä¿®å¤**
- âœ… ä¿®å¤å®Œæˆåï¼šäººå·¥éªŒè¯ â†’ æ‰‹åŠ¨è§£å†»å…¥å£ â†’ æ¢å¤å‘å¸ƒ
- âŒ ä¸å…è®¸è„šæœ¬è‡ªåŠ¨è¡¥å¿ï¼ˆé˜²æ­¢é”™è¯¯ä¿®å¤å¯¼è‡´æ›´å¤§é—®é¢˜ï¼‰

**äººå·¥ä¿®å¤æµç¨‹**:

```javascript
// scripts/repair/manual_repair_guide.js
// âœ… å·²æ‹æ¿ï¼šä¸å…è®¸è‡ªåŠ¨è¡¥å¿ï¼Œä»…æä¾›äººå·¥ä¿®å¤æŒ‡å¼•

async function generateRepairGuide() {
  console.log('ğŸ“‹ ç”Ÿæˆäººå·¥ä¿®å¤æŒ‡å¼•...')
  
  // 1. æ£€æŸ¥æ‰€æœ‰ä¸ä¸€è‡´æ•°æ®
  const [lotteryIssues] = await checkLotteryConsistency()
  const [consumptionIssues] = await checkConsumptionConsistency()
  const [exchangeIssues] = await checkExchangeConsistency()
  
  // 2. ç”Ÿæˆä¿®å¤æŒ‡å¼•æ–‡æ¡£
  const repairGuide = {
    timestamp: new Date().toISOString(),
    lottery: lotteryIssues.inconsistent?.map(issue => ({
      lottery_session_id: issue.lottery_session_id,
      issue_type: 'æŠ½å¥–æ‰£æ¬¾ä¸ä¸€è‡´',
      expected_amount: issue.total_cost_in_draws,
      actual_amount: issue.transaction_amount,
      diff: issue.diff,
      repair_steps: [
        '1. æŸ¥è¯¢è¯¥ session çš„æ‰€æœ‰ lottery_draws è®°å½•',
        '2. ç¡®è®¤å®é™…æ‰£æ¬¾é‡‘é¢æ˜¯å¦æ­£ç¡®',
        '3. å¦‚æœæµæ°´ç¼ºå¤±ï¼šåœ¨äº‹åŠ¡å†…è¡¥åˆ›å»ºæµæ°´å¹¶å†™å› asset_transaction_id',
        '4. å¦‚æœé‡‘é¢é”™è¯¯ï¼šäººå·¥åˆ¤æ–­æ˜¯å¦éœ€è¦è¡¥å¿/å›é€€',
        '5. ä¿®å¤å®ŒæˆåéªŒè¯å¯¹è´¦é€šè¿‡'
      ]
    })),
    consumption: consumptionIssues.missing?.map(issue => ({
      consumption_record_id: issue.consumption_record_id,
      issue_type: 'approved çŠ¶æ€ç¼ºå°‘å¥–åŠ±æµæ°´',
      repair_steps: [
        '1. ç¡®è®¤è¯¥æ¶ˆè´¹è®°å½•æ˜¯å¦åº”è¯¥å‘æ”¾å¥–åŠ±',
        '2. å¦‚æœåº”è¯¥å‘æ”¾ï¼šåœ¨äº‹åŠ¡å†…è¡¥åˆ›å»ºå¥–åŠ±æµæ°´å¹¶å†™å› reward_transaction_id',
        '3. å¦‚æœä¸åº”è¯¥å‘æ”¾ï¼šä¿®æ”¹ status ä¸º rejected',
        '4. ä¿®å¤å®ŒæˆåéªŒè¯å¯¹è´¦é€šè¿‡'
      ]
    })),
    exchange: exchangeIssues.inconsistent?.map(issue => ({
      exchange_record_id: issue.exchange_record_id,
      issue_type: 'å…‘æ¢æ‰£æ¬¾ä¸ä¸€è‡´',
      repair_steps: [
        '1. æŸ¥è¯¢è¯¥å…‘æ¢è®°å½•çš„è¯¦ç»†ä¿¡æ¯',
        '2. ç¡®è®¤å®é™…æ‰£æ¬¾é‡‘é¢æ˜¯å¦æ­£ç¡®',
        '3. å¦‚æœæµæ°´ç¼ºå¤±ï¼šåœ¨äº‹åŠ¡å†…è¡¥åˆ›å»ºæµæ°´å¹¶å†™å› debit_transaction_id',
        '4. ä¿®å¤å®ŒæˆåéªŒè¯å¯¹è´¦é€šè¿‡'
      ]
    }))
  }
  
  // 3. è¾“å‡ºä¿®å¤æŒ‡å¼•
  console.log('ğŸ“„ ä¿®å¤æŒ‡å¼•å·²ç”Ÿæˆ:')
  console.log(JSON.stringify(repairGuide, null, 2))
  
  // 4. å‘é€ç»™è´Ÿè´£äºº
  await sendRepairGuideToAdmin(repairGuide)
  
  return repairGuide
}

// âŒ å·²æ‹æ¿ï¼šç¦ç”¨è‡ªåŠ¨è¡¥å¿å‡½æ•°
// async function autoRepairMissingTransactions() {
//   throw new Error('å·²ç¦ç”¨è‡ªåŠ¨è¡¥å¿ï¼Œè¯·ä½¿ç”¨äººå·¥ä¿®å¤æµç¨‹')
// }
```

**äººå·¥ä¿®å¤SOP**ï¼ˆæ ‡å‡†æ“ä½œæµç¨‹ï¼‰:

1. **æ”¶åˆ°å‘Šè­¦** â†’ ç¡®è®¤ä¸ä¸€è‡´æ•°æ®è¯¦æƒ…
2. **åˆ†æåŸå› ** â†’ åˆ¤æ–­æ˜¯æµæ°´ç¼ºå¤±ã€é‡‘é¢é”™è¯¯è¿˜æ˜¯ä¸šåŠ¡é€»è¾‘bug
3. **åˆ¶å®šæ–¹æ¡ˆ** â†’ ç¡®å®šä¿®å¤SQLå’ŒéªŒè¯æ–¹æ³•
4. **æµ‹è¯•ç¯å¢ƒéªŒè¯** â†’ å…ˆåœ¨æµ‹è¯•ç¯å¢ƒæ‰§è¡Œä¿®å¤SQL
5. **ç”Ÿäº§ç¯å¢ƒä¿®å¤** â†’ åœ¨äº‹åŠ¡å†…æ‰§è¡Œä¿®å¤ï¼ˆå¿…é¡»åŒ…å«éªŒè¯æŸ¥è¯¢ï¼‰
6. **éªŒè¯å¯¹è´¦é€šè¿‡** â†’ é‡æ–°è¿è¡Œå¯¹è´¦è„šæœ¬ï¼Œç¡®è®¤é—®é¢˜å·²è§£å†³
7. **æ‰‹åŠ¨è§£å†»å…¥å£** â†’ æ¢å¤è¢«å†»ç»“çš„ä¸šåŠ¡å…¥å£
8. **è®°å½•ä¿®å¤æ—¥å¿—** â†’ è®°å½•é—®é¢˜åŸå› ã€ä¿®å¤æ–¹æ¡ˆã€éªŒè¯ç»“æœ

**ä¿®å¤ç¤ºä¾‹**ï¼ˆäººå·¥æ‰§è¡Œï¼‰:

```sql
-- ç¤ºä¾‹ï¼šä¿®å¤ç¼ºå¤±çš„æ¶ˆè´¹å¥–åŠ±æµæ°´

START TRANSACTION;

-- 1. è¡¥åˆ›å»ºå¥–åŠ±æµæ°´
INSERT INTO asset_transactions (
  user_id, asset_code, delta_amount, business_type, 
  idempotency_key, description, created_at
) VALUES (
  123, 'POINTS', 100, 'consumption_reward',
  'consumption_reward_456_manual_repair',
  'äººå·¥ä¿®å¤ï¼šæ¶ˆè´¹è®°å½• 456 ç¼ºå¤±å¥–åŠ±æµæ°´',
  NOW()
);

-- 2. è·å–åˆšåˆ›å»ºçš„æµæ°´ID
SET @new_tx_id = LAST_INSERT_ID();

-- 3. å†™å›å…³è”é”®
UPDATE consumption_records 
SET reward_transaction_id = @new_tx_id
WHERE consumption_record_id = 456;

-- 4. éªŒè¯ä¿®å¤ç»“æœ
SELECT 
  cr.consumption_record_id,
  cr.reward_transaction_id,
  at.transaction_id,
  at.delta_amount
FROM consumption_records cr
INNER JOIN asset_transactions at ON cr.reward_transaction_id = at.transaction_id
WHERE cr.consumption_record_id = 456;

-- 5. ç¡®è®¤æ— è¯¯åæäº¤
COMMIT;
```

##### 9.5 ä¸ FK æ–¹æ¡ˆçš„å¯¹æ¯”

| ç»´åº¦ | FK çº¦æŸæ–¹æ¡ˆ | ä¸ä¸Š FK æ–¹æ¡ˆï¼ˆæœ¬æ–¹æ¡ˆï¼‰ |
|-----|-----------|---------------------|
| **ä¸€è‡´æ€§ä¿è¯ç‚¹** | æ•°æ®åº“å±‚ï¼ˆå†™å…¥æ—¶æ‹¦æˆªï¼‰ | åº”ç”¨å±‚ï¼ˆäº‹åŠ¡è¾¹ç•Œ + å¯¹è´¦å…œåº•ï¼‰ |
| **å†™å…¥å¤±è´¥å½¢æ€** | ç«‹å³å¤±è´¥ï¼ˆFK è¿åï¼‰ | ç«‹å³å¤±è´¥ï¼ˆNOT NULL è¿åï¼‰æˆ–äº‹åå‘ç°ï¼ˆå¯¹è´¦ï¼‰ |
| **æ¼”è¿›æˆæœ¬** | é«˜ï¼ˆæ‹†åº“/æ‹†æœåŠ¡éœ€è¦å…ˆåˆ  FKï¼‰ | ä½ï¼ˆæ—  FK çº¦æŸï¼Œæ˜“æ‹†åˆ†ï¼‰ |
| **è¿ç»´æˆæœ¬** | ä½ï¼ˆæ•°æ®åº“è‡ªåŠ¨ä¿è¯ï¼‰ | ä¸­ï¼ˆéœ€è¦ç»´æŠ¤å¯¹è´¦è„šæœ¬å’Œå‘Šè­¦ï¼‰ |
| **æ€§èƒ½å½±å“** | å†™å…¥æ—¶æœ‰ FK æ£€æŸ¥å¼€é”€ | å†™å…¥æ— é¢å¤–å¼€é”€ï¼Œå¯¹è´¦æœ‰å®šæ—¶å¼€é”€ |
| **é€‚ç”¨åœºæ™¯** | é•¿æœŸå•ä½“å•åº“ï¼Œå›¢é˜ŸäººåŠ›æœ‰é™ | é¢„æœŸæ¼”è¿›/æ‹†åˆ†ï¼Œæ„¿æ„æŠ•å…¥æ²»ç†ä½“ç³» |

**æœ¬æ–¹æ¡ˆçš„æ ¸å¿ƒä¼˜åŠ¿**:
- âœ… æœªæ¥åˆ†åº“åˆ†è¡¨/æœåŠ¡æ‹†åˆ†æˆæœ¬ä½ï¼ˆæ— éœ€åˆ é™¤ FKï¼‰
- âœ… è¡¨ç»“æ„è°ƒæ•´/æ•°æ®è¿ç§»/æ‰¹å¤„ç†æ›´çµæ´»
- âœ… å†å²æ•°æ®æ¸…ç†/å½’æ¡£ä¸å— FK é™åˆ¶

**æœ¬æ–¹æ¡ˆçš„æ ¸å¿ƒè¦æ±‚**:
- âš ï¸ å¿…é¡»ä¸¥æ ¼éµå®ˆäº‹åŠ¡è¾¹ç•Œè§„èŒƒï¼ˆå·²æ‹æ¿ï¼šå¼ºåˆ¶äº‹åŠ¡ + ç»Ÿä¸€å…¥å£ï¼‰
- âš ï¸ å¿…é¡»è½åœ°å®šæ—¶å¯¹è´¦å’Œå‘Šè­¦æœºåˆ¶ï¼ˆä¸å¯ç¼ºå¤±ï¼‰
- âš ï¸ å¿…é¡»å»ºç«‹è¡¥å¿ä¿®å¤æµç¨‹ï¼ˆå‘ç°é—®é¢˜åçš„å¤„ç½®ï¼‰

#### å»ºè®®10: ç›‘æ§ä¸å‘Šè­¦ï¼ˆæŒç»­ä¼˜åŒ–ï¼‰

**ç›®æ ‡**: å®æ—¶å‘ç°äº‹åŠ¡ä¸€è‡´æ€§é—®é¢˜ï¼ŒæŒç»­ä¼˜åŒ–å¯¹è´¦è§„åˆ™

**æ‰©å±•ç›‘æ§æŒ‡æ ‡**ï¼ˆåœ¨å»ºè®®9åŸºç¡€ä¸Šå¢åŠ ï¼‰:

1. å¯¹è´¦è„šæœ¬æ‰§è¡ŒæˆåŠŸç‡ï¼ˆæ¯å°æ—¶ç»Ÿè®¡ï¼‰
2. å¯¹è´¦è„šæœ¬æ‰§è¡Œè€—æ—¶ï¼ˆç›‘æ§æ€§èƒ½ï¼‰
3. è¡¥å¿ä¿®å¤æˆåŠŸç‡
4. äº‹åŠ¡å›æ»šç‡ï¼ˆæŒ‰ `business_type` åˆ†ç»„ï¼‰
5. äº‹åŠ¡è¶…æ—¶æ¬¡æ•°

**ç›‘æ§é˜ˆå€¼**:

- å¯¹è´¦å·®å¼‚ > 0 â†’ **CRITICAL**ï¼ˆé˜»æ–­å‘å¸ƒ + è‡ªåŠ¨å†»ç»“å…¥å£ï¼‰
- å¯¹è´¦è„šæœ¬å¤±è´¥ â†’ **WARNING**ï¼ˆé‡è¯•ï¼‰
- äº‹åŠ¡å›æ»šç‡ > 5% â†’ **WARNING**
- äº‹åŠ¡è¶…æ—¶æ¬¡æ•° > 10æ¬¡/å°æ—¶ â†’ **WARNING**
- è¡¥å¿ä¿®å¤å¤±è´¥ â†’ **CRITICAL**ï¼ˆäººå·¥ä»‹å…¥ï¼‰

---

## 7. é™„å½•

### 7.1 å…¨ä»“è‡ªå»ºäº‹åŠ¡ç‚¹æ¸…å•

é€šè¿‡ `grep -RIn "await sequelize.transaction" services` ç»Ÿè®¡ï¼š

| æ–‡ä»¶                               | æ–¹æ³•                          | è¡Œå· | ç±»å‹     |
| ---------------------------------- | ----------------------------- | ---- | -------- |
| `TradeOrderService.js`             | `createOrder()`               | 179  | å¯é€‰ä¼ é€’ |
| `TradeOrderService.js`             | `completeOrder()`             | 434  | å¯é€‰ä¼ é€’ |
| `TradeOrderService.js`             | `cancelOrder()`               | 712  | å¯é€‰ä¼ é€’ |
| `UserService.js`                   | `createUser()`                | 46   | å¯é€‰ä¼ é€’ |
| `ContentAuditEngine.js`            | `submitForAudit()`            | 110  | å¯é€‰ä¼ é€’ |
| `ContentAuditEngine.js`            | `processAudit()`              | 178  | å¯é€‰ä¼ é€’ |
| `CustomerServiceSessionService.js` | `sendMessage()`               | 479  | è‡ªç®¡ç†   |
| `CustomerServiceSessionService.js` | `transferSession()`           | 631  | è‡ªç®¡ç†   |
| `CustomerServiceSessionService.js` | `closeSession()`              | 768  | è‡ªç®¡ç†   |
| `CustomerServiceSessionService.js` | `markSessionAsRead()`         | 862  | è‡ªç®¡ç†   |
| `MerchantReviewService.js`         | `submitMerchantForReview()`   | 73   | å¯é€‰ä¼ é€’ |
| `MerchantReviewService.js`         | `approveMerchant()`           | 189  | å¯é€‰ä¼ é€’ |
| `MerchantReviewService.js`         | `rejectMerchant()`            | 293  | å¯é€‰ä¼ é€’ |
| `MerchantReviewService.js`         | `updateMerchantInfo()`        | 363  | è‡ªç®¡ç†   |
| `ConsumptionService.js`            | `merchantSubmitConsumption()` | 199  | è‡ªç®¡ç†   |
| `ConsumptionService.js`            | `approveConsumption()`        | 357  | è‡ªç®¡ç†   |
| `ConsumptionService.js`            | `rejectConsumption()`         | 528  | è‡ªç®¡ç†   |
| `PrizePoolService.js`              | `batchAddPrizes()`            | 108  | å¯é€‰ä¼ é€’ |
| `AssetService.js`                  | `changeBalance()`             | 237  | å¯é€‰ä¼ é€’ |
| `AssetService.js`                  | `freeze()`                    | 438  | å¯é€‰ä¼ é€’ |
| `AssetService.js`                  | `unfreeze()`                  | 627  | å¯é€‰ä¼ é€’ |
| `AssetService.js`                  | `settleFromFrozen()`          | 816  | å¯é€‰ä¼ é€’ |
| `AssetService.js`                  | `transferItem()`              | 1267 | å¯é€‰ä¼ é€’ |
| `ExchangeService.js`               | `exchangeItem()`              | 352  | å¯é€‰ä¼ é€’ |
| `ExchangeService.js`               | `createListing()`             | 821  | å¯é€‰ä¼ é€’ |
| `RedemptionService.js`             | `redeemPrize()`               | 70   | å¯é€‰ä¼ é€’ |
| `MaterialManagementService.js`     | `createMaterialType()`        | 114  | è‡ªç®¡ç†   |
| `MaterialManagementService.js`     | `updateMaterialType()`        | 202  | è‡ªç®¡ç†   |

**ç»Ÿè®¡**:

- è‡ªç®¡ç†äº‹åŠ¡: 11å¤„
- å¯é€‰ä¼ é€’äº‹åŠ¡: 25å¤„
- **æ€»è®¡**: 36å¤„

### 7.2 æ ¸æŸ¥è„šæœ¬æ±‡æ€»

#### è„šæœ¬1: æ•°æ®åº“è¿æ¥ä¸è¡¨æšä¸¾

```bash
node -r dotenv/config -e "(async()=>{
  const {sequelize}=require('./config/database');
  await sequelize.authenticate();
  const [db]=await sequelize.query('SELECT DATABASE() db');
  console.log('Connected to:', db[0].db);
  const [tables]=await sequelize.query('SHOW TABLES');
  console.log('Table count:', tables.length);
  await sequelize.close();
})()"
```

#### è„šæœ¬2: æŠ½å¥–æ‰£æ¬¾ä¸€è‡´æ€§å¯¹è´¦

```bash
node -r dotenv/config -e '(async () => {
  const { sequelize } = require("./config/database");
  await sequelize.authenticate();

  const [[{ min_at: txStart }]] = await sequelize.query(
    "SELECT MIN(created_at) min_at FROM asset_transactions"
  );

  const [[drawAfter]] = await sequelize.query(
    "SELECT COUNT(*) cnt, SUM(cost_points) sum_cost FROM lottery_draws WHERE created_at >= ?",
    { replacements: [txStart] }
  );

  const [[consumeTx]] = await sequelize.query(
    "SELECT COUNT(*) cnt, SUM(delta_amount) sum_delta FROM asset_transactions WHERE business_type = ? AND created_at >= ?",
    { replacements: ["lottery_consume", txStart] }
  );

  console.log(JSON.stringify({
    asset_tx_start: txStart,
    draws_after_start: drawAfter,
    lottery_consume_txs_after_start: consumeTx
  }, null, 2));

  await sequelize.close();
})().catch(e => { console.error("ERR", e.message); process.exit(1); });'
```

#### è„šæœ¬3: èµ„äº§æµæ°´ç±»å‹åˆ†å¸ƒ

```bash
node -r dotenv/config -e '(async () => {
  const { sequelize } = require("./config/database");
  await sequelize.authenticate();

  const [types] = await sequelize.query(
    "SELECT business_type, COUNT(*) cnt, SUM(delta_amount) sum_delta FROM asset_transactions GROUP BY business_type ORDER BY cnt DESC"
  );

  console.log("asset_transactions.business_type");
  for (const r of types) {
    console.log(r.business_type, r.cnt, r.sum_delta);
  }

  await sequelize.close();
})().catch(e => { console.error("ERR", e.message); process.exit(1); });'
```

### 7.3 ç›¸å…³æ–‡æ¡£ç´¢å¼•

- **æŠ€æœ¯å€ºåŠ¡å…¨é¢åˆ†ææŠ¥å‘Š**: `docs/æŠ€æœ¯å€ºåŠ¡å…¨é¢åˆ†ææŠ¥å‘Š.md`
- **ç§¯åˆ†é¢„ç®—æ¶æ„çœŸå®çŠ¶æ€æ ¸æŸ¥æŠ¥å‘Š**: `docs/ç§¯åˆ†é¢„ç®—æ¶æ„çœŸå®çŠ¶æ€æ ¸æŸ¥æŠ¥å‘Š.md`
- **TransactionManager è®¾è®¡æ–‡æ¡£**: `utils/TransactionManager.js` (ä»£ç æ³¨é‡Š)
- **TransactionContext è®¾è®¡æ–‡æ¡£**: `utils/TransactionContext.js` (ä»£ç æ³¨é‡Š)

---

## ğŸ“ æ ¸æŸ¥ç»“è®º

### âœ… å·²ç¡®è®¤çš„äº‹å®ï¼ˆåŸºäº 2026-01-05 çœŸå®åº“éªŒè¯ï¼‰

1. **ä¸‰ç§äº‹åŠ¡æ¨¡å¼å¹¶å­˜** - ä»£ç å±‚é¢ç¡®è®¤å­˜åœ¨ï¼ˆ36å¤„è‡ªå»ºäº‹åŠ¡ç‚¹ï¼‰
2. **å…³é”®é“¾è·¯äº‹åŠ¡ä¼ é€’æ­£ç¡®** - æŠ½å¥–ã€å…‘æ¢ã€äº¤æ˜“é“¾è·¯å·²æ˜¾å¼ä¼ é€’ `transaction`
3. **æ–°è´¦æœ¬å¯ç”¨åæ•°æ®ä¸€è‡´** - æœªå‘ç°éƒ¨åˆ†æˆåŠŸè¯æ®ï¼ˆå¹‚ç­‰é”®æ— é‡å¤ï¼ŒæŠ½å¥–æ‰£æ¬¾é‡‘é¢ä¸€è‡´ï¼‰
4. **å†å²æ•°æ®å£å¾„ä¸åŒ** - éœ€æŒ‰è¿ç§»åˆ†ç•Œçº¿è§£è¯»ï¼ˆ**å·²æ‹æ¿ï¼šç›´æ¥åˆ é™¤å†å²æ•°æ®ï¼Œä¸å…¼å®¹è€æ•°æ®**ï¼‰
5. **å¹‚ç­‰é”®çº¦æŸå·²ç”Ÿæ•ˆ** - `asset_transactions`ã€`lottery_draws`ã€`consumption_records` å‡å·²æœ‰ UNIQUE çº¦æŸ
6. **æµ‹è¯•æ•°æ®æ··å…¥çœŸå®åº“** - èµ„äº§æµæ°´ä¸­æµ‹è¯•æ•°æ®å æ¯”é«˜ï¼ˆ`test_recharge` 110ç¬”ï¼‰ï¼Œéœ€è¦åœ¨å¯¹è´¦/ç»Ÿè®¡æ—¶æ’é™¤

### âš ï¸ éœ€è¦æ²»ç†çš„é£é™©

1. **ç¼ºå°‘é™æ€æ£€æŸ¥** - æ— æ³•é˜²æ­¢"å¿˜ä¼  transaction"ï¼ˆ**å·²æ‹æ¿ï¼šé‡‡ç”¨å¼ºåˆ¶æŠ¥é”™æ–¹å¼**ï¼‰
2. **TransactionManager æœªæ¨å¹¿** - æ ·æ¿ä»£ç é‡å¤ï¼ˆ**å·²æ‹æ¿ï¼šå…¨åŸŸæ¨å¹¿ç»Ÿä¸€å…¥å£**ï¼‰
3. **éƒ¨åˆ†æ–¹æ³•å­˜åœ¨åµŒå¥—é£é™©** - éœ€æ˜ç¡®æ ‡æ³¨å…¥å£çº§æ–¹æ³•ï¼ˆ**å·²æ‹æ¿ï¼šå…¨éƒ¨æ”¹é€ ä¸ºæ”¯æŒå¤–éƒ¨äº‹åŠ¡**ï¼‰
4. **å¯¹è´¦æœºåˆ¶ä¸å®Œå–„** - ç¼ºå°‘ç¨³å®šçš„å…³è”é”®ï¼ˆ**å·²æ‹æ¿ï¼šåº”ç”¨å±‚å¼ºä¸€è‡´ + DB çº¦æŸå…œåº•ï¼ˆUNIQUE/NOT NULL/CHECKï¼Œä¸åŠ  FKï¼‰+ å¯¹è´¦å·¡æ£€**ï¼‰
5. **ä¸ä¸Š FK çš„å·¥ç¨‹çºªå¾‹è¦æ±‚** - éœ€è¦ä¸¥æ ¼éµå®ˆäº‹åŠ¡è¾¹ç•Œè§„èŒƒå’Œå®šæœŸå¯¹è´¦ï¼ˆ**å·²æ‹æ¿ï¼šå»ºç«‹å®Œå–„çš„å¯¹è´¦å‘Šè­¦ä½“ç³»**ï¼‰
6. **æµ‹è¯•æ•°æ®æœªä¸¥æ ¼éš”ç¦»** - éœ€è¦å¼ºåˆ¶æ‰“æ ‡å¹¶åœ¨å¯¹è´¦/ç»Ÿè®¡æ—¶æ’é™¤ï¼ˆ**å·²æ‹æ¿ï¼šä¸åšç‰©ç†éš”ç¦»ï¼Œä½†å¿…é¡»å¯è¯†åˆ«**ï¼‰

### ğŸ¯ æ²»ç†å†³ç­–æ‰§è¡Œè®¡åˆ’ï¼ˆå·²æ‹æ¿ - æœ€ç»ˆç‰ˆï¼‰

**æ ¸å¿ƒç­–ç•¥æ€»ç»“**ï¼ˆ2026-01-05 æœ€ç»ˆæ‹æ¿ï¼ŒåŸºäºè¡Œä¸šå®è·µä¸çœŸå®åº“ç°çŠ¶ï¼‰:
- âœ… **æ¶æ„é€‰å‹**: å¤§å…¬å¸/æ¸¸æˆå…¬å¸æŠ˜ä¸­æ–¹æ¡ˆ - åº”ç”¨å±‚å¼ºä¸€è‡´ï¼ˆä¸»åŠ›ï¼‰+ DB çº¦æŸå…œåº•ï¼ˆä¸åŠ  FKï¼‰+ å¯¹è´¦å·¡æ£€ï¼ˆå…œåº•ï¼‰
- âœ… **å†å²æ•°æ®**: å½»åº•æ¸…ç†ï¼ˆåˆ†ç•Œç‚¹ 2026-01-02 20:24:20 ä¹‹å‰å…¨éƒ¨åˆ é™¤ï¼Œæ°¸ä¹…ä¸¢å¤±ï¼‰
- âœ… **äº‹åŠ¡è¾¹ç•Œ**: å¼ºç¡¬æ¨¡å¼ - `AssetService.*` ç­‰åº•å±‚æœåŠ¡æœªåœ¨äº‹åŠ¡å†…è°ƒç”¨ç›´æ¥æŠ¥é”™
- âœ… **äº‹åŠ¡ç¼–æ’**: ç»Ÿä¸€å…¥å£ - è·¯ç”±/ä»»åŠ¡å…¥å£ç”¨ `TransactionManager.execute()`ï¼ŒæœåŠ¡å±‚ç¦æ­¢è‡ªå»ºäº‹åŠ¡
- âœ… **DB çº¦æŸç­–ç•¥**: UNIQUEï¼ˆå¹‚ç­‰é”®ï¼‰+ NOT NULLï¼ˆå…³é”®å­—æ®µï¼‰+ CHECKï¼ˆè¡Œå†…è§„åˆ™ï¼‰+ ç´¢å¼•ï¼Œ**ä¸åŠ  FK**
- âœ… **å¼ºçº¦æŸè¡¨èŒƒå›´**: P0 æ ¸å¿ƒèµ„äº§/æƒç›Šè¡¨ï¼ˆ`asset_transactions`ã€`lottery_draws`ã€`consumption_records` ç­‰ï¼‰ï¼ŒP1/P2 æ—¥å¿—/é…ç½®è¡¨å¯å¼±çº¦æŸ
- âœ… **å¯¹è´¦ä¸å¤„ç½®**: å‘ç°å·®å¼‚ç«‹å³å‘Šè­¦ + é˜»æ–­å‘å¸ƒ + è‡ªåŠ¨å†»ç»“å…¥å£ï¼ˆä¸»åŠ¨æ­¢è¡€ï¼‰
- âœ… **æµ‹è¯•æ•°æ®**: ä¸åšç‰©ç†éš”ç¦»ï¼Œä½†å¿…é¡»å¯è¯†åˆ«ï¼ˆ`idempotency_key` å‰ç¼€ `test_` æˆ– `meta.source='test'`ï¼‰ä¸”åœ¨å¯¹è´¦/ç»Ÿè®¡ä¸­æ’é™¤

#### é˜¶æ®µ1: åŸºç¡€è®¾æ–½æ”¹é€ ï¼ˆ1-2å‘¨ï¼‰

**P0 - ç ´åæ€§å˜æ›´ï¼Œå¿…é¡»å…ˆå®Œæˆ**:

1. âœ… **å¼ºåˆ¶äº‹åŠ¡è¾¹ç•Œ**:
   - æ”¹é€  `AssetService.*` ç­‰åº•å±‚æœåŠ¡ï¼Œç§»é™¤è‡ªå»ºäº‹åŠ¡å…œåº•é€»è¾‘
   - ä¸ä¼  `transaction` ç›´æ¥æŠ¥é”™
   - é¢„è®¡å½±å“: 36ä¸ªæœåŠ¡æ–¹æ³•éœ€è¦æ”¹é€ 

2. âœ… **ç»Ÿä¸€å…¥å£ç¼–æ’**:
   - æ‰€æœ‰è·¯ç”±å±‚ç»Ÿä¸€ä½¿ç”¨ `TransactionManager.execute()`
   - é¢„è®¡å½±å“: çº¦80+ä¸ªè·¯ç”±ç«¯ç‚¹éœ€è¦æ”¹é€ 

3. âœ… **èŠå¤©/å®¢æœé“¾è·¯æ”¹é€ **:
   - `CustomerServiceSessionService` ç­‰6ä¸ªè‡ªç®¡ç†äº‹åŠ¡æ–¹æ³•æ”¹ä¸ºæ”¯æŒå¤–éƒ¨äº‹åŠ¡
   - é¢„è®¡å½±å“: 11ä¸ªè‡ªç®¡ç†äº‹åŠ¡æ–¹æ³•éœ€è¦æ”¹é€ 

#### é˜¶æ®µ2: æ•°æ®æ²»ç†ä¸ç›‘æ§ï¼ˆ2-3å‘¨ï¼‰

**P1 - è´¨é‡æå‡ï¼Œæ”¹é€ å®Œæˆåç«‹å³å®æ–½**:

1. âœ… **å†å²æ•°æ®æ¸…ç†**:
   - **åˆ é™¤** 2026-01-02 20:24:20 ä¹‹å‰çš„æ‰€æœ‰å†å²æ•°æ®
   - å¤‡ä»½åæ‰§è¡Œæ¸…ç†è„šæœ¬
   - éªŒè¯æ¸…ç†ç»“æœï¼ˆç¡®ä¿æ— å†å²æ®‹ç•™ï¼‰

2. âœ… **å¢åŠ é€»è¾‘å¤–é”®å…³è”é”® + ä¸šåŠ¡å”¯ä¸€é”®**ï¼ˆä¸ä¸Š FK çº¦æŸï¼‰:
   - `lottery_draws.asset_transaction_id` (NOT NULL + ç´¢å¼•ï¼Œ**ä¸åŠ  FK**)
   - `lottery_draws.lottery_session_id` (NOT NULL + ç´¢å¼•, æŒ‰ session æ‰¹é‡æ‰£æ¬¾)
   - `lottery_draws.business_id` (**UNIQUE ç´¢å¼•**ï¼Œå·²æ‹æ¿å¿…é¡»åŠ )
   - `consumption_records.reward_transaction_id` (æ¡ä»¶ NOT NULL + ç´¢å¼•ï¼Œ**ä¸åŠ  FK**)
   - `consumption_records.business_id` (**UNIQUE ç´¢å¼•**ï¼Œå·²æ‹æ¿å¿…é¡»åŠ )
   - `exchange_records.debit_transaction_id` (NOT NULL + ç´¢å¼•ï¼Œ**ä¸åŠ  FK**)
   - `exchange_records.business_id` (**UNIQUE ç´¢å¼•**ï¼Œå·²æ‹æ¿å¿…é¡»åŠ )
   - **å…¨é‡å›å¡«**æ–°è´¦æœ¬åçš„æ•°æ®ï¼Œç¡®ä¿æ—  NULL å€¼
   - æ”¹ç”¨åº”ç”¨å±‚ä¿è¯ + å®šæ—¶å¯¹è´¦å‘Šè­¦å…œåº•ï¼ˆæ¯å°æ—¶ï¼Œå‘ç°å·®å¼‚ï¼šå‘Šè­¦ + é˜»æ–­å‘å¸ƒ + è‡ªåŠ¨å†»ç»“å…¥å£ï¼‰

3. âœ… **é™æ€æ£€æŸ¥è§„åˆ™**:
   - ESLint è‡ªå®šä¹‰è§„åˆ™
   - CI/CD å¼ºåˆ¶æ£€æŸ¥
   
4. âœ… **å®šæ—¶å¯¹è´¦ä¸å¤„ç½®ç³»ç»Ÿ**ï¼ˆæ›¿ä»£ FK çš„å…œåº•æœºåˆ¶ï¼Œå·²æ‹æ¿æœ€å¼ºå¤„ç½®ï¼‰:
   - æŠ½å¥–æ‰£æ¬¾ä¸€è‡´æ€§æ£€æŸ¥ï¼ˆ**æ¯å°æ—¶**æ‰§è¡Œï¼‰
   - æ¶ˆè´¹å¥–åŠ±ä¸€è‡´æ€§æ£€æŸ¥ï¼ˆ**æ¯å°æ—¶**æ‰§è¡Œï¼‰
   - å…‘æ¢æ‰£æ¬¾ä¸€è‡´æ€§æ£€æŸ¥ï¼ˆ**æ¯å°æ—¶**æ‰§è¡Œï¼‰
   - å‘ç°å·®å¼‚ç«‹å³ï¼š**é˜»æ–­å‘å¸ƒ + è‡ªåŠ¨å†»ç»“å…¥å£**ï¼ˆå·²æ‹æ¿é€‰é¡¹Cï¼‰
   - å»ºç«‹äººå·¥ä¿®å¤æµç¨‹ï¼ˆ**ç¦æ­¢è‡ªåŠ¨è¡¥å¿**ï¼Œå·²æ‹æ¿é€‰é¡¹Aï¼‰

#### é˜¶æ®µ3: æŒç»­æ”¹è¿›ï¼ˆ3-4å‘¨ï¼‰

**P2 - é•¿æœŸä¼˜åŒ–**:

1. å®Œå–„å•å…ƒæµ‹è¯•è¦†ç›–
2. ç›‘æ§å‘Šè­¦ç³»ç»Ÿ
3. æ€§èƒ½ä¼˜åŒ–å’Œè°ƒä¼˜

### ğŸ“Š é¢„æœŸæ•ˆæœ

**æ”¹é€ å®Œæˆå**:

- âœ… **äº‹åŠ¡è¾¹ç•Œæ¸…æ™°**: å…¥å£å±‚ç»Ÿä¸€å¼€äº‹åŠ¡ï¼ŒæœåŠ¡å±‚ä¸è‡ªå»º
- âœ… **é›¶"å¿˜ä¼ "é£é™©**: å¼ºåˆ¶æŠ¥é”™æœºåˆ¶é˜²æ­¢é™é»˜è„±ç¦»äº‹åŠ¡
- âœ… **é›¶åµŒå¥—äº‹åŠ¡**: æ‰€æœ‰æ–¹æ³•æ”¯æŒå¤–éƒ¨äº‹åŠ¡ï¼Œä¸å†æ— æ¡ä»¶è‡ªå»º
- âœ… **åº”ç”¨å±‚å¼ºä¸€è‡´**: NOT NULL + ç´¢å¼• + åŒäº‹åŠ¡å†™å›å…³è”é”®ï¼Œä¿è¯åŸå­æ€§
- âœ… **å¯¹è´¦å…œåº•**: å®šæ—¶å¯¹è´¦å‘ç°å·®å¼‚ç«‹å³å‘Šè­¦ + é˜»æ–­å‘å¸ƒ + è‡ªåŠ¨å†»ç»“å…¥å£ï¼Œäººå·¥ä¿®å¤åå¤æ ¸
- âœ… **æ¶æ„ç»Ÿä¸€**: åŒ…æ‹¬èŠå¤©/å®¢æœåœ¨å†…çš„æ‰€æœ‰é“¾è·¯çº³å…¥ç»Ÿä¸€ç¼–æ’
- âœ… **æ•°æ®å£å¾„ç»Ÿä¸€**: åˆ é™¤å†å²æ•°æ®ï¼Œåªä¿ç•™æ–°è´¦æœ¬åçš„å¼ºä¸€è‡´æ•°æ®
- âœ… **æ¼”è¿›å‹å¥½**: ä¸å— FK çº¦æŸé™åˆ¶ï¼Œæœªæ¥åˆ†åº“åˆ†è¡¨/æœåŠ¡æ‹†åˆ†æˆæœ¬ä½

**é£é™©æ§åˆ¶**:

- âš ï¸ çŸ­æœŸå¯èƒ½æš´éœ²éšè—çš„è°ƒç”¨ç‚¹ï¼ˆéœ€è¦å…¨é¢æµ‹è¯•ï¼‰
- âš ï¸ ä»£ç æ”¹åŠ¨é‡å¤§ï¼ˆéœ€è¦åˆ†é˜¶æ®µä¸Šçº¿ï¼‰
- âš ï¸ **å†å²æ•°æ®æ°¸ä¹…ä¸¢å¤±**ï¼ˆéœ€è¦æå‰å¤‡ä»½ï¼Œç¡®è®¤å¯æ¥å—ï¼‰
- âš ï¸ **ä¾èµ–å·¥ç¨‹çºªå¾‹**: éœ€è¦ä¸¥æ ¼éµå®ˆäº‹åŠ¡è¾¹ç•Œè§„èŒƒï¼Œå®šæœŸå¯¹è´¦ä¸å¯ç¼ºå¤±
- âœ… é•¿æœŸä¿è¯æ•°æ®ä¸€è‡´æ€§å’Œæ¶æ„æ¸…æ™°
- âœ… åº”ç”¨å±‚ + å¯¹è´¦åŒé‡ä¿è¯ï¼Œä¸ä¾èµ–æ•°æ®åº“ FK
- âœ… æœªæ¥æ¼”è¿›æˆæœ¬ä½ï¼ˆæ—  FK çº¦æŸï¼Œæ˜“æ‹†åˆ†ï¼‰

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-03  
**å†³ç­–æ‹æ¿æ—¶é—´**: 2026-01-05ï¼ˆæœ€ç»ˆç‰ˆï¼Œè¡¥å……è¡Œä¸šå®è·µå‚è€ƒä¸çœŸå®åº“éªŒè¯ï¼‰  
**æ ¸æŸ¥æ–¹å¼**: Node.js + Sequelize + dotenv ç›´è¿çœŸå® MySQLï¼ˆtest-db-12-mysql-0:3306 / restaurant_points_devï¼‰  
**æ ¸æŸ¥äººå‘˜**: AI Assistant  
**å†³ç­–äºº**: é¡¹ç›®è´Ÿè´£äºº  
**å®¡æ ¸çŠ¶æ€**: âœ… å·²æ‹æ¿ï¼Œè¿›å…¥å®æ–½é˜¶æ®µ

**æ ¸æŸ¥æ•°æ®æ—¶æ•ˆæ€§**: åŸºäº 2026-01-05 03:34:39 çš„çœŸå®åº“å¿«ç…§ï¼ˆ252æ¡èµ„äº§æµæ°´ï¼Œ2841æ¡æŠ½å¥–è®°å½•ï¼Œ184æ¡æ¶ˆè´¹è®°å½•ï¼‰

---

## ğŸš¨ é‡è¦æé†’ï¼šä¸å…¼å®¹è€æ•°æ®çš„ç ´åæ€§å˜æ›´ï¼ˆåº”ç”¨å±‚å¼ºä¸€è‡´ + DB çº¦æŸå…œåº•ï¼Œä¸ä¸Š FKï¼‰

### æœ€ç»ˆæ‹æ¿å†³ç­–æ‘˜è¦ï¼ˆ2026-01-05ï¼ŒåŸºäºè¡Œä¸šå®è·µä¸çœŸå®åº“ç°çŠ¶ï¼‰

æœ¬æ¬¡æ²»ç†é‡‡ç”¨**"å¤§å…¬å¸/æ¸¸æˆå…¬å¸æŠ˜ä¸­æ–¹æ¡ˆ"**ï¼šåº”ç”¨å±‚å¼ºä¸€è‡´ï¼ˆä¸»åŠ›ï¼‰+ DB çº¦æŸå…œåº•ï¼ˆUNIQUE/NOT NULL/CHECKï¼Œä¸åŠ  FKï¼‰+ å¯¹è´¦å·¡æ£€ï¼ˆå…œåº•ï¼‰

#### æ ¸å¿ƒå†³ç­–ï¼ˆå·²å…¨éƒ¨æ‹æ¿ï¼‰

1. **âœ… åˆ é™¤æ‰€æœ‰å†å²æ•°æ®**ï¼ˆ2026-01-02 20:24:20 ä¹‹å‰ï¼‰
   - æ°¸ä¹…ä¸¢å¤±å†å²è¡Œä¸ºè®°å½•ï¼ˆå·²ç¡®è®¤å¯æ¥å—ï¼‰
   - éœ€è¦æå‰å¤‡ä»½å¹¶ç¡®è®¤å¯æ¥å—
   - **çœŸå®åº“å½±å“**: 2840æ¡æŠ½å¥–è®°å½•ã€184æ¡æ¶ˆè´¹è®°å½•å°†è¢«åˆ é™¤

2. **âœ… åº”ç”¨å±‚å¼ºä¸€è‡´ï¼ˆä¸»åŠ›ï¼‰+ DB çº¦æŸå…œåº•ï¼ˆä¸åŠ  FKï¼‰**
   - **åº”ç”¨å±‚**: åŒä¸€äº‹åŠ¡å†…åˆ›å»ºæµæ°´å¹¶å†™å›å…³è”é”®ï¼ˆå¼ºåˆ¶äº‹åŠ¡è¾¹ç•Œï¼‰
   - **DB çº¦æŸ**: UNIQUEï¼ˆå¹‚ç­‰é”®ï¼‰+ NOT NULLï¼ˆå…³é”®å­—æ®µï¼‰+ CHECKï¼ˆè¡Œå†…è§„åˆ™ï¼‰+ ç´¢å¼•
   - **ä¸åŠ  FK**: ä¸ºæœªæ¥åˆ†åº“åˆ†è¡¨/æœåŠ¡æ‹†åˆ†ç•™å‡ºç©ºé—´
   - **å¯¹è´¦å…œåº•**: å®šæ—¶æŸ¥ç¼ºå¤±/é‡‘é¢ä¸ç¬¦å¹¶å‘Šè­¦/å†»ç»“å…¥å£/äººå·¥ä¿®å¤
   - **å†³ç­–ä¾æ®**: å‚è€ƒå¤§å…¬å¸/æ¸¸æˆå…¬å¸å®è·µï¼Œå•æœåŠ¡å†…æœ¬åœ°äº‹åŠ¡ + å¯¹è´¦å…œåº•

3. **âœ… å¼ºçº¦æŸè¡¨èŒƒå›´ï¼ˆåˆ†å±‚ï¼Œä¸å…¨è¡¨ä¸€åˆ€åˆ‡ï¼‰**
   - **P0 æ ¸å¿ƒèµ„äº§/æƒç›Šè¡¨**: `asset_transactions`ã€`lottery_draws`ã€`consumption_records`ã€`exchange_records`ã€`trade_orders`ã€`market_listings`
   - **P1/P2 æ—¥å¿—/é…ç½®è¡¨**: å¯å¼±çº¦æŸï¼ˆåŸºç¡€ NOT NULL + å¿…è¦ç´¢å¼•ï¼‰
   - **å†³ç­–ä¾æ®**: èšç„¦æ ¸å¿ƒèµ„äº§/æƒç›Šè¡¨ï¼Œé™ä½å†å²æ•°æ®è¿ç§»æˆæœ¬

4. **âœ… æŠ½å¥–æŒ‰ Session æ‰¹é‡æ‰£æ¬¾**
   - ä¸€ä¸ª `lottery_session_id` å¯¹åº”ä¸€æ¡æµæ°´
   - å¤šæ¡ `lottery_draws` æŒ‡å‘åŒä¸€ä¸ª `asset_transaction_id`
   - ä¸æ”¯æŒå•æŠ½æ’¤é”€

5. **âœ… å¼ºåˆ¶äº‹åŠ¡è¾¹ç•Œï¼ˆå¼ºç¡¬æ¨¡å¼ï¼‰**
   - `AssetService.*` ç­‰åº•å±‚æœåŠ¡ä¸ä¼  transaction ç›´æ¥æŠ¥é”™
   - è·¯ç”±/ä»»åŠ¡å…¥å£ç»Ÿä¸€ç”¨ `TransactionManager.execute()` å¼€äº‹åŠ¡
   - æœåŠ¡å±‚ç¦æ­¢è‡ªå»ºäº‹åŠ¡
   - **ä»£ç æ”¹åŠ¨é‡**: 36ä¸ªæœåŠ¡æ–¹æ³• + 80+è·¯ç”±ç«¯ç‚¹ + 11ä¸ªè‡ªç®¡ç†äº‹åŠ¡æ–¹æ³•
   - çŸ­æœŸå¯èƒ½æš´éœ²éšè—è°ƒç”¨ç‚¹

6. **âœ… å¯¹è´¦ä¸å¤„ç½®ç­–ç•¥ï¼ˆä¸»åŠ¨æ­¢è¡€ï¼‰**
   - å¯¹è´¦å‘ç°æ•°æ®ä¸ä¸€è‡´ï¼š**å‘Šè­¦ + é˜»æ–­å‘å¸ƒ + è‡ªåŠ¨å†»ç»“å…¥å£**
   - åªå…è®¸äººå·¥ä¿®å¤ï¼ˆç¦æ­¢è‡ªåŠ¨è¡¥å¿ï¼‰
   - ä¿®å¤å®Œæˆåï¼šæ‰‹åŠ¨è§£å†»å…¥å£ â†’ é‡æ–°è·‘å¯¹è´¦éªŒè¯é€šè¿‡
   - **å¯¹è´¦æ ¼å¼**: æŒ‰ä»£ç å®é™…å¹‚ç­‰é”®æ ¼å¼ï¼ˆå¦‚ `consumption_reward:approve:{recordId}`ï¼‰

7. **âœ… æµ‹è¯•æ•°æ®ä¸åšç‰©ç†éš”ç¦»**
   - ä¸æ‹†åº“/ä¸åˆ† schema
   - æµ‹è¯•æ•°æ®å¿…é¡»å¯è¯†åˆ«ï¼ˆ`idempotency_key` ç»Ÿä¸€ `test_` å‰ç¼€æˆ– `meta.source='test'`ï¼‰
   - å¯¹è´¦ä¸ç»Ÿè®¡å¿…é¡»æ’é™¤æµ‹è¯•æ•°æ®ï¼Œé¿å…æ±¡æŸ“"çœŸå®ä¸šåŠ¡å£å¾„"
   - **çœŸå®åº“ç°çŠ¶**: æµ‹è¯•æ•°æ®å æ¯”é«˜ï¼ˆ`test_recharge` 110ç¬”ï¼‰ï¼Œéœ€è¦ä¸¥æ ¼æ‰§è¡Œæ ‡è®°è§„èŒƒ

### å®æ–½å‰å¿…é¡»ç¡®è®¤

- [ ] **å†å²æ•°æ®å·²å¤‡ä»½**ï¼ˆmysqldump å®Œæ•´å¤‡ä»½ï¼‰
- [ ] **ç¡®è®¤å¯æ¥å—å†å²æ•°æ®æ°¸ä¹…ä¸¢å¤±**ï¼ˆåˆ†ç•Œçº¿ 2026-01-02 20:24:20 ä¹‹å‰çš„æ‰€æœ‰æ•°æ®ï¼‰
- [ ] **å›¢é˜Ÿå·²ç†è§£"ä¸å…¼å®¹è€æ•°æ®"çš„å«ä¹‰**
- [ ] **æµ‹è¯•ç¯å¢ƒå·²å®Œæ•´éªŒè¯è¿ç§»æµç¨‹**
- [ ] **ç”Ÿäº§ç¯å¢ƒå·²è§„åˆ’åœæœºçª—å£**ï¼ˆæ¸…ç†å†å²æ•°æ® + å›å¡«å…³è”é”® + æ·»åŠ çº¦æŸï¼‰
- [ ] **å¯¹è´¦å‘Šè­¦ç³»ç»Ÿå·²éƒ¨ç½²**ï¼ˆå®šæ—¶å¯¹è´¦è„šæœ¬ + å‘Šè­¦é€šçŸ¥ + é˜»æ–­å‘å¸ƒæœºåˆ¶ + è‡ªåŠ¨å†»ç»“å…¥å£ï¼‰
- [ ] **è¡¥å¿ä¿®å¤æµç¨‹å·²å»ºç«‹**ï¼ˆå‘ç°å·®å¼‚åçš„å¤„ç½®SOPï¼‰
- [ ] **å›¢é˜Ÿå·²ç†è§£"ä¸ä¸Š FK"çš„å·¥ç¨‹çºªå¾‹è¦æ±‚**ï¼ˆä¸¥æ ¼äº‹åŠ¡è¾¹ç•Œ + å®šæœŸå¯¹è´¦ï¼‰
- [ ] **æµ‹è¯•æ•°æ®æ ‡è®°è§„èŒƒå·²è½åœ°**ï¼ˆæ‰€æœ‰æµ‹è¯•å†™å…¥å¿…é¡»å¯è¯†åˆ«ï¼Œå¯¹è´¦/ç»Ÿè®¡æ—¶æ’é™¤ï¼‰
- [ ] **çœŸå®æ•°æ®åº“ç°çŠ¶å·²æ ¸æŸ¥**ï¼ˆé€šè¿‡ Node.js + dotenv ç›´è¿çœŸå®åº“ï¼Œç¡®è®¤è¡¨ç»“æ„/æ•°æ®é‡/æ—¶é—´åˆ†å±‚ï¼‰

### å›æ»šæ–¹æ¡ˆ

å¦‚æœå®æ–½åå‘ç°é—®é¢˜ï¼š
- âœ… å¯ä»¥ä»å¤‡ä»½æ¢å¤å†å²æ•°æ®
- âš ï¸ ä½†éœ€è¦é‡æ–°æ‰§è¡Œ"æ˜ç¡®åˆ†ç•Œ"æ–¹æ¡ˆï¼ˆå…è®¸ NULLï¼Œä¸åŠ çº¦æŸï¼‰
- âš ï¸ å·²åˆ é™¤çš„å†å²æ•°æ®æ— æ³•æ¢å¤ï¼ˆé™¤éä»å¤‡ä»½ï¼‰
- âœ… ä¸ä¸Š FK çš„å¥½å¤„ï¼šå›æ»šæˆæœ¬ä½ï¼Œæ— éœ€åˆ é™¤å¤–é”®çº¦æŸ

### "ä¸ä¸Š FK"æ–¹æ¡ˆçš„é•¿æœŸç»´æŠ¤è¦æ±‚

**å¿…é¡»æŒç»­æŠ•å…¥çš„æœºåˆ¶**ï¼ˆå¦åˆ™æ•°æ®ä¸€è‡´æ€§æ— æ³•ä¿è¯ï¼‰ï¼š

1. **å®šæ—¶å¯¹è´¦è„šæœ¬**ï¼ˆâœ… å·²æ‹æ¿ï¼šæ¯å°æ—¶æ‰§è¡Œï¼‰
   - æŠ½å¥–æ‰£æ¬¾ä¸€è‡´æ€§æ£€æŸ¥ï¼ˆæ¯å°æ—¶ç¬¬5åˆ†é’Ÿï¼‰
   - æ¶ˆè´¹å¥–åŠ±ä¸€è‡´æ€§æ£€æŸ¥ï¼ˆæ¯å°æ—¶ç¬¬5åˆ†é’Ÿï¼‰
   - å…‘æ¢æ‰£æ¬¾ä¸€è‡´æ€§æ£€æŸ¥ï¼ˆæ¯å°æ—¶ç¬¬5åˆ†é’Ÿï¼‰
   - è¦†ç›–çª—å£ï¼šæ£€æŸ¥è¿‡å»1å°æ—¶çš„æ•°æ®

2. **å¯¹è´¦ä¸å¤„ç½®**ï¼ˆâœ… å·²æ‹æ¿ï¼šé€‰é¡¹C - æœ€å¼ºå¤„ç½®ï¼‰
   - å‘ç°å·®å¼‚ç«‹å³å¤„ç½®
   - **é˜»æ–­å‘å¸ƒ**ï¼ˆéƒ¨ç½²æµç¨‹ä¸­æ–­ï¼‰
   - **è‡ªåŠ¨å†»ç»“å…¥å£**ï¼ˆé˜²æ­¢è„æ•°æ®æ‰©æ•£ï¼‰
   - **è§¦å‘äººå·¥ä»‹å…¥**ï¼ˆç¦æ­¢è‡ªåŠ¨è¡¥å¿ï¼Œå·²æ‹æ¿é€‰é¡¹Aï¼‰

3. **ç›‘æ§ä»ªè¡¨æ¿**ï¼ˆå¿…é¡»å»ºç«‹ï¼‰
   - å¯¹è´¦è„šæœ¬æ‰§è¡ŒæˆåŠŸç‡ï¼ˆç›®æ ‡ >99%ï¼‰
   - ä¸ä¸€è‡´è®°å½•æ•°é‡è¶‹åŠ¿ï¼ˆç›®æ ‡ = 0ï¼‰
   - å‘Šè­¦è§¦å‘é¢‘ç‡ï¼ˆç›®æ ‡ = 0ï¼‰
   - å…¥å£å†»ç»“çŠ¶æ€ï¼ˆå®æ—¶ç›‘æ§ï¼‰
   - äººå·¥ä¿®å¤å“åº”æ—¶é—´ï¼ˆç›®æ ‡ <30åˆ†é’Ÿï¼‰

4. **äººå·¥ä¿®å¤æµç¨‹**ï¼ˆâœ… å·²æ‹æ¿ï¼šåªå…è®¸äººå·¥ä¿®å¤ï¼‰
   - æ˜ç¡®çš„ä¿®å¤ SOPï¼ˆ8æ­¥æ ‡å‡†æµç¨‹ï¼‰
   - ä¿®å¤å‰å¿…é¡»åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
   - ä¿®å¤åå¿…é¡»é‡æ–°å¯¹è´¦éªŒè¯
   - ä¿®å¤å®Œæˆåæ‰‹åŠ¨è§£å†»å…¥å£
   - è®°å½•ä¿®å¤æ—¥å¿—å’Œæ ¹å› åˆ†æ
   - è®°å½•ä¿®å¤æ—¥å¿—å’Œæ ¹å› åˆ†æ

5. **ä¸šåŠ¡å”¯ä¸€é”®ç”Ÿæˆå™¨**ï¼ˆâœ… å·²æ‹æ¿ï¼šå¿…é¡»å®ç°ï¼‰
   - ç»Ÿä¸€çš„ `BusinessIdGenerator` ç±»
   - æ‰€æœ‰ä¸šåŠ¡è®°å½•åˆ›å»ºæ—¶å¿…é¡»ç”Ÿæˆ `business_id`
   - é…åˆ UNIQUE ç´¢å¼•é˜²æ­¢é‡å¤åˆ›å»º

**å¦‚æœæ— æ³•æŒç»­æŠ•å…¥ä¸Šè¿°æœºåˆ¶ï¼Œå»ºè®®æ”¹ç”¨ FK æ–¹æ¡ˆ**ï¼ˆæ•°æ®åº“å±‚å…œåº•ï¼Œè¿ç»´æˆæœ¬ä½ï¼‰

**æœ¬æ–¹æ¡ˆçš„ä¸¥æ ¼ç¨‹åº¦**ï¼ˆ2026-01-05 å·²æ‹æ¿é‡‡ç”¨æœ€å¼ºç­–ç•¥ï¼‰:
- ğŸ”´ **å‘Šè­¦å¤„ç½®**: æœ€å¼ºï¼ˆCï¼‰- å‘Šè­¦ + é˜»æ–­å‘å¸ƒ + è‡ªåŠ¨å†»ç»“å…¥å£
- ğŸŸ¢ **å¯¹è´¦é¢‘ç‡**: é€‚ä¸­ï¼ˆAï¼‰- æ¯å°æ—¶
- ğŸ”´ **è¡¥å¿ä¿®å¤**: æœ€ä¸¥ï¼ˆAï¼‰- åªå…è®¸äººå·¥
- ğŸ”´ **å­—æ®µçº¦æŸ**: æœ€ä¸¥ï¼ˆAï¼‰- å…¨éƒ¨ NOT NULL
- ğŸ”´ **å¹‚ç­‰ä¿æŠ¤**: æœ€å¼ºï¼ˆBï¼‰- ä¸šåŠ¡å”¯ä¸€é”® + å¹‚ç­‰é”®
- ğŸŸ¢ **FK ç­–ç•¥**: æœ€çµæ´»ï¼ˆAï¼‰- å…¨åº“ä¸ä¸Š

**è¿™æ˜¯ä¸€å¥—"é«˜æŠ•å…¥ã€é«˜å®‰å…¨ã€é«˜çµæ´»"çš„æ–¹æ¡ˆ**ï¼Œé€‚åˆé¢„æœŸæ¼”è¿›çš„é¡¹ç›®ï¼Œä½†éœ€è¦å›¢é˜Ÿæœ‰è¶³å¤Ÿçš„è¿ç»´èƒ½åŠ›å’Œå·¥ç¨‹çºªå¾‹ã€‚

---

## ğŸ” çœŸå®æ•°æ®åº“éªŒè¯è®°å½•ï¼ˆ2026-01-05ï¼‰

### éªŒè¯æ–¹å¼
- **è¿æ¥æ–¹å¼**: Node.js + Sequelize + dotenvï¼ˆè¯»å– .env é…ç½®ï¼‰
- **éªŒè¯å‘½ä»¤**: `node -r dotenv/config -e "require('./config/database').sequelize.authenticate()"`
- **æ•°æ®åº“ä¿¡æ¯**: test-db-12-mysql-0:3306 / restaurant_points_dev (MySQL 8.0.30)

### æ ¸å¿ƒéªŒè¯ç»“æœ

#### 1. å¹‚ç­‰é”®å”¯ä¸€æ€§éªŒè¯
```sql
SELECT idempotency_key, COUNT(*) cnt 
FROM asset_transactions 
GROUP BY idempotency_key 
HAVING cnt > 1;
-- ç»“æœ: 0æ¡ï¼ˆæ— é‡å¤ï¼ŒUNIQUE çº¦æŸç”Ÿæ•ˆï¼‰
```

#### 2. æ¶ˆè´¹å®¡æ ¸ä¸€è‡´æ€§éªŒè¯ï¼ˆåˆ†ç•Œçº¿åï¼‰
```sql
-- æŸ¥è¯¢ï¼šapproved çŠ¶æ€ä½†ç¼ºå¤±å¥–åŠ±æµæ°´çš„è®°å½•
SELECT cr.record_id, cr.user_id, cr.status, cr.points_to_award
FROM consumption_records cr
LEFT JOIN asset_transactions atx 
  ON atx.idempotency_key = CONCAT('consumption_reward:approve:', cr.record_id)
  AND atx.business_type = 'consumption_reward'
WHERE cr.status = 'approved' 
  AND cr.created_at >= '2026-01-02 20:24:20'
  AND atx.transaction_id IS NULL;
-- ç»“æœ: 0æ¡ï¼ˆå› ä¸ºåˆ†ç•Œçº¿åæ— æ–°æ¶ˆè´¹è®°å½•äº§ç”Ÿï¼‰
```

#### 3. æµ‹è¯•æ•°æ®è¯†åˆ«éªŒè¯
```sql
SELECT business_type, COUNT(*) cnt
FROM asset_transactions
WHERE idempotency_key LIKE 'test_%'
GROUP BY business_type;
-- ç»“æœ: test_recharge (110ç¬”)

SELECT business_type, COUNT(*) cnt
FROM asset_transactions
WHERE JSON_EXTRACT(meta, '$.idempotency_key') LIKE 'test_%'
GROUP BY business_type;
-- ç»“æœ: exchange_debit (111ç¬”ï¼Œmeta å« test_* å‰ç¼€)
```

**éªŒè¯ç»“è®º**: 
- âœ… å¹‚ç­‰é”®çº¦æŸå·²ç”Ÿæ•ˆï¼ˆæ•°æ®åº“å±‚æ— é‡å¤ï¼‰
- âœ… åˆ†ç•Œçº¿åæ•°æ®ä¸€è‡´æ€§è‰¯å¥½ï¼ˆæ—  approved ç¼ºå¤±æµæ°´ï¼‰
- âš ï¸ æµ‹è¯•æ•°æ®å æ¯”é«˜ï¼ˆ221/252 = 87.7%ï¼‰ï¼Œéœ€è¦åœ¨å¯¹è´¦/ç»Ÿè®¡æ—¶æ’é™¤
