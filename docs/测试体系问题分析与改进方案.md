# æµ‹è¯•ä½“ç³»é—®é¢˜åˆ†æä¸æ”¹è¿›æ–¹æ¡ˆ

**åˆ†ææ—¥æœŸ**ï¼š2026å¹´1æœˆ30æ—¥  
**è§¦å‘äº‹ä»¶**ï¼šç”¨æˆ·é’»çŸ³å­¤å„¿å†»ç»“é—®é¢˜ï¼ˆæŒ‚ç‰Œæ’¤å›æ—¶ä¹°å®¶è®¢å•æœªå–æ¶ˆï¼‰  
**åˆ†æèŒƒå›´**ï¼š`/home/devbox/project/tests` ç›®å½•ï¼ˆ177ä¸ªæµ‹è¯•æ–‡ä»¶ï¼‰

---

## ğŸ“‹ ä»»åŠ¡æ¸…å•ï¼ˆTask Checklistï¼‰

> æœ¬ç« èŠ‚ä¸ºæµ‹è¯•ä½“ç³»æ”¹è¿›çš„è¯¦ç»†ä»»åŠ¡æ¸…å•ï¼ŒæŒ‰ä¼˜å…ˆçº§å’Œæ¨¡å—åˆ’åˆ†ï¼Œç”¨äºè·Ÿè¸ªæ‰§è¡Œè¿›åº¦ã€‚

### æ€»ä½“è¿›åº¦æ¦‚è§ˆ

| ä¼˜å…ˆçº§ | ä»»åŠ¡æ•° | å·²å®Œæˆ | è¿›è¡Œä¸­ | å¾…å¼€å§‹ | é¢„ä¼°æ€»å·¥æ—¶ |
|--------|--------|--------|--------|--------|-----------|
| P0-å…³é”® | 12 | 1 | 0 | 11 | 11å¤© |
| P1-é‡è¦ | 15 | 0 | 0 | 15 | 13.5å¤© |
| P2-æ”¹è¿› | 10 | 0 | 0 | 10 | 10å¤© |
| **åˆè®¡** | **37** | **1** | **0** | **36** | **34.5å¤©** |

---

### P0 çº§ä»»åŠ¡ï¼ˆç«‹å³è¡ŒåŠ¨ - å½±å“æ ¸å¿ƒä¸šåŠ¡ï¼‰

#### P0-1 APIå¥‘çº¦æµ‹è¯•è¡¥å……ï¼ˆ2å¤©ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | éªŒæ”¶æ ‡å‡† |
|------|--------|----------|------|----------|
| P0-1.1 | å¸‚åœºæŒ‚ç‰ŒAPIå¥‘çº¦æµ‹è¯• | `tests/api-contracts/market.contract.test.js` | â¬œ å¾…å¼€å§‹ | è¦†ç›–åˆ›å»º/ä¿®æ”¹/æ’¤å›/æŸ¥è¯¢æ¥å£ |
| P0-1.2 | å¸‚åœºäº¤æ˜“APIå¥‘çº¦æµ‹è¯• | `tests/api-contracts/market.contract.test.js` | â¬œ å¾…å¼€å§‹ | è¦†ç›–ä¸‹å•/å–æ¶ˆ/å®Œæˆæ¥å£ |
| P0-1.3 | èµ„äº§ä½™é¢APIå¥‘çº¦æµ‹è¯• | `tests/api-contracts/asset.contract.test.js` | â¬œ å¾…å¼€å§‹ | è¦†ç›–æŸ¥è¯¢/å†»ç»“/è§£å†»æ¥å£ |
| P0-1.4 | èµ„äº§äº¤æ˜“APIå¥‘çº¦æµ‹è¯• | `tests/api-contracts/asset.contract.test.js` | â¬œ å¾…å¼€å§‹ | è¦†ç›–è½¬è´¦/å…‘æ¢æ¥å£ |

#### P0-2 è·¨è§’è‰²äº¤äº’æµ‹è¯•ï¼ˆ3å¤©ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | éªŒæ”¶æ ‡å‡† |
|------|--------|----------|------|----------|
| P0-2.1 | å–å®¶æ’¤å›+ä¹°å®¶è®¢å•åœºæ™¯ | `tests/services/MarketListingService.withdraw-buyer-order.test.js` | âœ… å·²å®Œæˆ | éªŒè¯ä¹°å®¶èµ„äº§æ­£ç¡®è§£å†» |
| P0-2.2 | ä¹°å®¶å–æ¶ˆ+å–å®¶æŒ‚ç‰Œæ¢å¤ | `tests/scenario/market/cross-user-interaction.test.js` | â¬œ å¾…å¼€å§‹ | éªŒè¯æŒ‚ç‰ŒçŠ¶æ€æ¢å¤ |
| P0-2.3 | è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆåœºæ™¯ | `tests/scenario/market/cross-user-interaction.test.js` | â¬œ å¾…å¼€å§‹ | éªŒè¯åŒæ–¹èµ„äº§è§£å†» |
| P0-2.4 | å¤šä¹°å®¶æŠ¢è´­åŒä¸€æŒ‚ç‰Œ | `tests/scenario/market/cross-user-interaction.test.js` | â¬œ å¾…å¼€å§‹ | éªŒè¯ä¸è¶…å–+å¤±è´¥è€…è§£å†» |
| P0-2.5 | ç®¡ç†å‘˜å¼ºåˆ¶ä¸‹æ¶åœºæ™¯ | `tests/scenario/market/cross-user-interaction.test.js` | â¬œ å¾…å¼€å§‹ | éªŒè¯å…³è”è®¢å•å¤„ç† |

#### P0-3 çŠ¶æ€æœºæµ‹è¯•è¦†ç›–ï¼ˆ3å¤©ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | éªŒæ”¶æ ‡å‡† |
|------|--------|----------|------|----------|
| P0-3.1 | è®¢å•çŠ¶æ€è½¬æ¢å›¾æ–‡æ¡£ | `docs/test-matrices/order-state-machine.md` | â¬œ å¾…å¼€å§‹ | ç»˜åˆ¶å®Œæ•´çŠ¶æ€è½¬æ¢å›¾ |
| P0-3.2 | è®¢å•ç”Ÿå‘½å‘¨æœŸæµ‹è¯• | `tests/scenario/market/order-lifecycle.test.js` | â¬œ å¾…å¼€å§‹ | è¦†ç›–æ‰€æœ‰åˆæ³•è½¬æ¢è·¯å¾„ |
| P0-3.3 | è®¢å•ä¸­æ–­åœºæ™¯æµ‹è¯• | `tests/scenario/market/order-lifecycle.test.js` | â¬œ å¾…å¼€å§‹ | è¦†ç›–æ‰€æœ‰ä¸­æ–­åœºæ™¯ |
| P0-3.4 | æŒ‚ç‰ŒçŠ¶æ€è½¬æ¢å›¾æ–‡æ¡£ | `docs/test-matrices/listing-state-machine.md` | â¬œ å¾…å¼€å§‹ | ç»˜åˆ¶å®Œæ•´çŠ¶æ€è½¬æ¢å›¾ |
| P0-3.5 | æŒ‚ç‰Œç”Ÿå‘½å‘¨æœŸæµ‹è¯• | `tests/scenario/market/listing-lifecycle.test.js` | â¬œ å¾…å¼€å§‹ | è¦†ç›–æ‰€æœ‰åˆæ³•è½¬æ¢è·¯å¾„ |
| P0-3.6 | æŒ‚ç‰Œä¸­æ–­åœºæ™¯æµ‹è¯• | `tests/scenario/market/listing-lifecycle.test.js` | â¬œ å¾…å¼€å§‹ | è¦†ç›–æ‰€æœ‰ä¸­æ–­åœºæ™¯ |

#### P0-4 æµ‹è¯•åŸºç¡€è®¾æ–½ï¼ˆ2å¤©ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | éªŒæ”¶æ ‡å‡† |
|------|--------|----------|------|----------|
| P0-4.1 | Sequelizeäº‹åŠ¡éš”ç¦»Helper | `tests/helpers/sequelize-test-helper.js` | â¬œ å¾…å¼€å§‹ | æ”¯æŒæµ‹è¯•è‡ªåŠ¨å›æ»š |
| P0-4.2 | æ ¸å¿ƒæµ‹è¯•è¿ç§»åˆ°äº‹åŠ¡éš”ç¦» | å¤šä¸ªç°æœ‰æµ‹è¯•æ–‡ä»¶ | â¬œ å¾…å¼€å§‹ | å¸‚åœºç›¸å…³æµ‹è¯•ä½¿ç”¨äº‹åŠ¡éš”ç¦» |

#### P0-5 å›å½’æµ‹è¯•å¥—ä»¶ï¼ˆ1å¤©ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | éªŒæ”¶æ ‡å‡† |
|------|--------|----------|------|----------|
| P0-5.1 | P0çº§å›å½’æµ‹è¯•å…¥å£ | `tests/regression/p0-critical-paths.test.js` | â¬œ å¾…å¼€å§‹ | æ ¸å¿ƒä¸šåŠ¡è·¯å¾„å¯ä¸€é”®æ‰§è¡Œ |
| P0-5.2 | å­¤å„¿å†»ç»“é—®é¢˜å›å½’ | `tests/regression/bug-fixes/2026-01-30-orphan-frozen.test.js` | â¬œ å¾…å¼€å§‹ | æœ¬æ¬¡é—®é¢˜æ°¸ä¸å¤ç° |

---

### P1 çº§ä»»åŠ¡ï¼ˆçŸ­æœŸé‡ç‚¹ - æå‡è´¨é‡ï¼‰

#### P1-1 é…ç½®è¾¹ç•ŒéªŒè¯æµ‹è¯•ï¼ˆ2å¤©ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | éªŒæ”¶æ ‡å‡† |
|------|--------|----------|------|----------|
| P1-1.1 | æ•°æ®åº“è¿æ¥æ± è¾¹ç•Œæµ‹è¯• | `tests/stress/db-connection-pool.stress.test.js` | â¬œ å¾…å¼€å§‹ | éªŒè¯40è¿æ¥ä¸Šé™ç”Ÿæ•ˆ |
| P1-1.2 | é™æµé…ç½®è¾¹ç•Œæµ‹è¯• | `tests/stress/rate-limit-validation.stress.test.js` | â¬œ å¾…å¼€å§‹ | éªŒè¯å„åœºæ™¯é™æµç”Ÿæ•ˆ |
| P1-1.3 | å¹¶å‘æ§åˆ¶è¾¹ç•Œæµ‹è¯• | `tests/stress/concurrency-control.stress.test.js` | â¬œ å¾…å¼€å§‹ | éªŒè¯ç”¨æˆ·/IPå¹¶å‘é™åˆ¶ |
| P1-1.4 | ä¸šåŠ¡é™åˆ¶è¾¹ç•Œæµ‹è¯• | `tests/stress/business-limit-validation.stress.test.js` | â¬œ å¾…å¼€å§‹ | éªŒè¯æŠ½å¥–/ç§¯åˆ†/æ¶ˆæ¯ä¸Šé™ |

#### P1-2 å¹¶å‘åŸºå‡†æµ‹è¯•ï¼ˆ2å¤©ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | éªŒæ”¶æ ‡å‡† |
|------|--------|----------|------|----------|
| P1-2.1 | 1000ç”¨æˆ·å¹¶å‘æŠ½å¥– | `tests/stress/capacity-baseline.stress.test.js` | â¬œ å¾…å¼€å§‹ | P99å“åº”<500ms |
| P1-2.2 | 500ç”¨æˆ·å¹¶å‘ä¸‹å• | `tests/stress/capacity-baseline.stress.test.js` | â¬œ å¾…å¼€å§‹ | æ— è¶…å–+æ•°æ®ä¸€è‡´ |
| P1-2.3 | æ··åˆè´Ÿè½½åŸºå‡† | `tests/stress/capacity-baseline.stress.test.js` | â¬œ å¾…å¼€å§‹ | è®°å½•å„æ¥å£P50/P90/P99 |

#### P1-3 Joiå‚æ•°éªŒè¯æµ‹è¯•ï¼ˆ1.5å¤©ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | éªŒæ”¶æ ‡å‡† |
|------|--------|----------|------|----------|
| P1-3.1 | å¸‚åœºAPIå‚æ•°éªŒè¯ | `tests/unit/validators/market-validator.test.js` | â¬œ å¾…å¼€å§‹ | è¦†ç›–æ‰€æœ‰è¾¹ç•Œå€¼ |
| P1-3.2 | èµ„äº§APIå‚æ•°éªŒè¯ | `tests/unit/validators/asset-validator.test.js` | â¬œ å¾…å¼€å§‹ | è¦†ç›–æ‰€æœ‰è¾¹ç•Œå€¼ |
| P1-3.3 | è®¢å•APIå‚æ•°éªŒè¯ | `tests/unit/validators/order-validator.test.js` | â¬œ å¾…å¼€å§‹ | è¦†ç›–æ‰€æœ‰è¾¹ç•Œå€¼ |

#### P1-4 WebSocketé›†æˆæµ‹è¯•ï¼ˆ2å¤©ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | éªŒæ”¶æ ‡å‡† |
|------|--------|----------|------|----------|
| P1-4.1 | è¿æ¥ç”Ÿå‘½å‘¨æœŸæµ‹è¯• | `tests/integration/websocket/connection-lifecycle.integration.test.js` | â¬œ å¾…å¼€å§‹ | è¿æ¥/æ–­å¼€/é‡è¿ |
| P1-4.2 | èŠå¤©åŠŸèƒ½é›†æˆæµ‹è¯• | `tests/integration/websocket/chat-websocket.integration.test.js` | â¬œ å¾…å¼€å§‹ | æ¶ˆæ¯æ”¶å‘éªŒè¯ |
| P1-4.3 | ç®¡ç†å‘˜é€šçŸ¥æµ‹è¯• | `tests/integration/websocket/admin-notification.integration.test.js` | â¬œ å¾…å¼€å§‹ | é€šçŸ¥æ¨é€éªŒè¯ |

#### P1-5 å¹‚ç­‰æ€§æµ‹è¯•ï¼ˆ1å¤©ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | éªŒæ”¶æ ‡å‡† |
|------|--------|----------|------|----------|
| P1-5.1 | å¹‚ç­‰æ€§å•å…ƒæµ‹è¯• | `tests/services/IdempotencyService.unit.test.js` | â¬œ å¾…å¼€å§‹ | æ ¸å¿ƒé€»è¾‘éªŒè¯ |
| P1-5.2 | å¹‚ç­‰æ€§é›†æˆæµ‹è¯• | `tests/services/IdempotencyService.integration.test.js` | â¬œ å¾…å¼€å§‹ | å¹¶å‘å¹‚ç­‰éªŒè¯ |

#### P1-6 Redis Mockå®Œå–„ï¼ˆ1å¤©ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | éªŒæ”¶æ ‡å‡† |
|------|--------|----------|------|----------|
| P1-6.1 | å®Œå–„ioredisç‰¹æœ‰æ–¹æ³• | `tests/helpers/test-mock-redis.js` | â¬œ å¾…å¼€å§‹ | æ”¯æŒscanStream/defineCommand |
| P1-6.2 | åˆ†å¸ƒå¼é”Mock | `tests/helpers/distributed-lock-mock.js` | â¬œ å¾…å¼€å§‹ | æ”¯æŒé”è·å–/é‡Šæ”¾/è¶…æ—¶ |

#### P1-7 å®‰å…¨æµ‹è¯•è¡¥å……ï¼ˆ2å¤©ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | éªŒæ”¶æ ‡å‡† |
|------|--------|----------|------|----------|
| P1-7.1 | CSRFé˜²æŠ¤æµ‹è¯• | `tests/security/csrf-prevention.test.js` | â¬œ å¾…å¼€å§‹ | éªŒè¯CSRF Tokenæœºåˆ¶ |
| P1-7.2 | JWTå®‰å…¨æµ‹è¯• | `tests/security/jwt-security.test.js` | â¬œ å¾…å¼€å§‹ | è¿‡æœŸ/ç¯¡æ”¹/é‡æ”¾éªŒè¯ |
| P1-7.3 | æ•æ„Ÿæ“ä½œäºŒæ¬¡è®¤è¯ | `tests/security/sensitive-operation.test.js` | â¬œ å¾…å¼€å§‹ | å…³é”®æ“ä½œéœ€äºŒæ¬¡ç¡®è®¤ |

---

### P2 çº§ä»»åŠ¡ï¼ˆä¸­æœŸå®Œå–„ï¼‰

#### P2-1 æé™å‹åŠ›æµ‹è¯•ï¼ˆ2å¤©ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | éªŒæ”¶æ ‡å‡† |
|------|--------|----------|------|----------|
| P2-1.1 | 5000ç”¨æˆ·å‹æµ‹ | `tests/stress/capacity-extreme.stress.test.js` | â¬œ å¾…å¼€å§‹ | è®°å½•é™çº§è§¦å‘ç‚¹ |
| P2-1.2 | 10000ç”¨æˆ·æé™æµ‹è¯• | `tests/stress/capacity-extreme.stress.test.js` | â¬œ å¾…å¼€å§‹ | æ‰¾åˆ°ç³»ç»Ÿå´©æºƒç‚¹ |
| P2-1.3 | è¿æ¥æ± å´©æºƒç‚¹æµ‹è¯• | `tests/stress/capacity-extreme.stress.test.js` | â¬œ å¾…å¼€å§‹ | è¶…è¿‡40è¿æ¥çš„è¡Œä¸º |

#### P2-2 æ··åˆè´Ÿè½½æµ‹è¯•ï¼ˆ2å¤©ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | éªŒæ”¶æ ‡å‡† |
|------|--------|----------|------|----------|
| P2-2.1 | çœŸå®åœºæ™¯è´Ÿè½½åˆ†å¸ƒ | `tests/stress/mixed-workload.stress.test.js` | â¬œ å¾…å¼€å§‹ | æ¨¡æ‹Ÿ30%æµè§ˆ+20%æŠ½å¥–+... |
| P2-2.2 | å³°å€¼çªå‘æµ‹è¯• | `tests/stress/mixed-workload.stress.test.js` | â¬œ å¾…å¼€å§‹ | ç¬æ—¶æµé‡æ¿€å¢åœºæ™¯ |

#### P2-3 å¯è§‚æµ‹æ€§æµ‹è¯•ï¼ˆ1.5å¤©ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | éªŒæ”¶æ ‡å‡† |
|------|--------|----------|------|----------|
| P2-3.1 | Winstonæ—¥å¿—é…ç½®æµ‹è¯• | `tests/observability/winston-logger.test.js` | â¬œ å¾…å¼€å§‹ | çº§åˆ«/æ ¼å¼/è„±æ•éªŒè¯ |
| P2-3.2 | request_idä¼ é€’æµ‹è¯• | `tests/observability/request-id-propagation.test.js` | â¬œ å¾…å¼€å§‹ | å…¨é“¾è·¯è¿½è¸ªéªŒè¯ |
| P2-3.3 | æŒ‡æ ‡å¯¼å‡ºæµ‹è¯• | `tests/observability/metrics-export.test.js` | â¬œ å¾…å¼€å§‹ | PrometheusæŒ‡æ ‡éªŒè¯ |

#### P2-4 æµ‹è¯•ç›®å½•æ•´åˆï¼ˆ1.5å¤©ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | éªŒæ”¶æ ‡å‡† |
|------|--------|----------|------|----------|
| P2-4.1 | å‹åŠ›æµ‹è¯•ç›®å½•ç»Ÿä¸€ | `tests/stress/` | â¬œ å¾…å¼€å§‹ | åˆå¹¶åˆ†æ•£çš„å¹¶å‘æµ‹è¯• |
| P2-4.2 | åœºæ™¯æµ‹è¯•ç›®å½•å»ºç«‹ | `tests/scenario/` | â¬œ å¾…å¼€å§‹ | æŒ‰ä¸šåŠ¡æ¨¡å—ç»„ç»‡ |
| P2-4.3 | å›å½’æµ‹è¯•ç›®å½•å»ºç«‹ | `tests/regression/` | â¬œ å¾…å¼€å§‹ | P0/P1åˆ†çº§ç®¡ç† |

#### P2-5 æ··æ²Œå·¥ç¨‹æ‰©å±•ï¼ˆ2å¤©ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | éªŒæ”¶æ ‡å‡† |
|------|--------|----------|------|----------|
| P2-5.1 | çº§è”æ•…éšœæµ‹è¯• | `tests/chaos/cascade-failure.test.js` | â¬œ å¾…å¼€å§‹ | æœåŠ¡æ•…éšœä¼ æ’­éªŒè¯ |
| P2-5.2 | é™æµé™çº§æµ‹è¯• | `tests/chaos/rate-limit-degradation.test.js` | â¬œ å¾…å¼€å§‹ | é«˜è´Ÿè½½é™çº§è¡Œä¸º |
| P2-5.3 | æ•°æ®ä¸ä¸€è‡´æ¢å¤ | `tests/chaos/data-recovery.test.js` | â¬œ å¾…å¼€å§‹ | å¼‚å¸¸æ•°æ®ä¿®å¤æµç¨‹ |

---

### æ˜ç¡®æ’é™¤é¡¹ï¼ˆä¸åšï¼‰â­ 2026-01-30 ç”¨æˆ·æ‹æ¿

| æ’é™¤é¡¹ | åŸå›  | æ›¿ä»£æ–¹æ¡ˆ |
|--------|------|---------|
| âŒ æ•°æ®åº“è¿ç§»å›å½’æµ‹è¯• | ä¸€æ¬¡æ€§éƒ¨ç½²æ“ä½œ | Code Review + StagingéªŒè¯ |
| âŒ Webç®¡ç†å¹³å°å‰ç«¯æµ‹è¯• | ç‹¬ç«‹å‰ç«¯é¡¹ç›® | å‰ç«¯é¡¹ç›®è‡ªæœ‰E2Eæµ‹è¯• |
| âŒ ç¬¬ä¸‰æ–¹æœåŠ¡çœŸå®é›†æˆæµ‹è¯• | æœ‰ç‹¬ç«‹SLAä¿éšœ | Mockæµ‹è¯• + Stagingæ‰‹åŠ¨éªŒè¯ |

---

### æ‰§è¡Œå»ºè®®

**ç¬¬1å‘¨ï¼ˆP0-1~P0-3ï¼‰**ï¼š
1. å‘¨ä¸€-å‘¨äºŒï¼šå®Œæˆå¸‚åœº/èµ„äº§APIå¥‘çº¦æµ‹è¯•
2. å‘¨ä¸‰-å‘¨å››ï¼šå®Œæˆè·¨è§’è‰²äº¤äº’æµ‹è¯•æ ¸å¿ƒåœºæ™¯
3. å‘¨äº”ï¼šå¯åŠ¨çŠ¶æ€æœºæµ‹è¯•ï¼Œå®Œæˆæ–‡æ¡£

**ç¬¬2å‘¨ï¼ˆP0-3~P0-5 + P1å¯åŠ¨ï¼‰**ï¼š
1. å‘¨ä¸€-å‘¨äºŒï¼šå®ŒæˆçŠ¶æ€æœºæµ‹è¯•ç”¨ä¾‹
2. å‘¨ä¸‰ï¼šå®Œæˆæµ‹è¯•åŸºç¡€è®¾æ–½ï¼ˆäº‹åŠ¡éš”ç¦»Helperï¼‰
3. å‘¨å››-å‘¨äº”ï¼šå»ºç«‹å›å½’æµ‹è¯•å¥—ä»¶ + å¯åŠ¨P1é…ç½®è¾¹ç•Œæµ‹è¯•

**åç»­æŒ‰P1â†’P2é¡ºåºæ¨è¿›ï¼Œæ¯å‘¨è¯„å®¡è¿›åº¦ã€‚**

---

## 1. é—®é¢˜èƒŒæ™¯

### 1.1 è§¦å‘äº‹ä»¶

2026å¹´1æœˆ30æ—¥å‘ç°"å­¤å„¿å†»ç»“"é—®é¢˜ï¼š
- **ç°è±¡**ï¼šç”¨æˆ·31çš„12,700é’»çŸ³å…¨éƒ¨è¢«å†»ç»“ï¼Œæ— æ³•ä½¿ç”¨
- **æ ¹å› **ï¼šå–å®¶æ’¤å›æŒ‚ç‰Œæ—¶ï¼Œä¹°å®¶å·²ä¸‹å•çš„å†»ç»“èµ„äº§æ²¡æœ‰è§£å†»
- **å½±å“**ï¼šä¹°å®¶èµ„äº§æ°¸ä¹…è¢«å†»ç»“ï¼Œæ— æ³•è¿½æº¯

### 1.2 ä¸ºä»€ä¹ˆæµ‹è¯•æ²¡æœ‰å‘ç°ï¼Ÿ

ç°æœ‰æµ‹è¯•è¦†ç›–çš„åœºæ™¯ï¼š
```
âœ… å–å®¶åˆ›å»ºæŒ‚ç‰Œ â†’ æ’¤å›æŒ‚ç‰Œ â†’ éªŒè¯çŠ¶æ€
âœ… éå–å®¶å°è¯•æ’¤å› â†’ è¢«æ‹’ç»
âœ… å–å®¶æ’¤å›åèµ„äº§è§£å†»
```

**ç¼ºå¤±çš„å…³é”®åœºæ™¯**ï¼š
```
âŒ å–å®¶åˆ›å»ºæŒ‚ç‰Œ â†’ ä¹°å®¶ä¸‹å•ï¼ˆå†»ç»“èµ„äº§ï¼‰â†’ å–å®¶æ’¤å›æŒ‚ç‰Œ â†’ éªŒè¯ä¹°å®¶èµ„äº§æ˜¯å¦è§£å†»
```

---

## 2. æµ‹è¯•ä½“ç³»ç°çŠ¶åˆ†æ

### 2.1 æµ‹è¯•æ–‡ä»¶ç»Ÿè®¡

| ç›®å½• | æ–‡ä»¶æ•° | è¯´æ˜ |
|------|--------|------|
| services/ | 32 | æœåŠ¡å•å…ƒæµ‹è¯• |
| business/ | 34 | ä¸šåŠ¡æµ‹è¯•ï¼ˆå®šä½æ¨¡ç³Šï¼‰ |
| integration/ | 32 | é›†æˆæµ‹è¯• |
| market/ | 1 | å¸‚åœºæµ‹è¯•ï¼ˆ**ä¸¥é‡ä¸è¶³**ï¼‰ |
| e2e/ | 3 | ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆ**ä¸¥é‡ä¸è¶³**ï¼‰ |
| unit/ | 14 | å•å…ƒæµ‹è¯• |
| å…¶ä»– | 61 | åˆ†æ•£åœ¨å„å­ç›®å½• |
| **æ€»è®¡** | **177** | - |

### 2.2 å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°æ® | è¯„ä¼° |
|------|------|------|
| çŠ¶æ€è½¬æ¢æµ‹è¯• | 5 ä¸ªæ–‡ä»¶ | âŒ ä¸¥é‡ä¸è¶³ |
| è·¨è§’è‰²äº¤äº’æµ‹è¯• | ~11 ä¸ªæ–‡ä»¶ (6%) | âŒ ä¸è¶³ |
| è¾¹ç•Œ/å¼‚å¸¸æµ‹è¯• | 154 ä¸ªæ–‡ä»¶ | âš ï¸ æ•°é‡å¯è§‚ä½†æ·±åº¦ä¸å¤Ÿ |

---

## 3. ç³»ç»Ÿæ€§é—®é¢˜è¯†åˆ«

### 3.1 é—®é¢˜1ï¼šçŠ¶æ€æœºæµ‹è¯•ä¸¥é‡ç¼ºå¤±

**ç°è±¡**ï¼š
- è®¢å•æœ‰å¤šä¸ªçŠ¶æ€ï¼š`created â†’ frozen â†’ completed/cancelled`
- æŒ‚ç‰Œæœ‰å¤šä¸ªçŠ¶æ€ï¼š`on_sale â†’ locked â†’ withdrawn/sold`
- æµ‹è¯•åªéªŒè¯"èµ·ç‚¹â†’ç»ˆç‚¹"ï¼Œä¸éªŒè¯"ä¸­é—´çŠ¶æ€è¢«æ‰“æ–­"çš„åœºæ™¯

**æœ¬æ¬¡BUGæ¡ˆä¾‹**ï¼š
```
æ­£å¸¸æµç¨‹ï¼šæŒ‚ç‰Œ(on_sale) â†’ å®Œæˆäº¤æ˜“(sold)
è¾¹ç•Œåœºæ™¯ï¼šæŒ‚ç‰Œ(on_sale) â†’ è¢«é”å®š(locked) â†’ å–å®¶æ’¤å› â†’ ä¹°å®¶è®¢å•ï¼Ÿ
                                                         â†‘
                                                    æœªæµ‹è¯•ï¼
```

**å½±å“**ï¼š
- æ— æ³•å‘ç°"çŠ¶æ€ä¸­æ–­"å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´
- èµ„äº§å†»ç»“/è§£å†»çš„è¾¹ç•Œæƒ…å†µè¢«é—æ¼

### 3.2 é—®é¢˜2ï¼šè·¨è§’è‰²äº¤äº’æµ‹è¯•ä¸è¶³

**ç°è±¡**ï¼š

| æµ‹è¯•ç±»å‹ | æ–‡ä»¶æ•° | å æ¯” |
|----------|--------|------|
| å•è§’è‰²æ“ä½œï¼ˆå–å®¶/ä¹°å®¶ç‹¬ç«‹ï¼‰ | ~160 | 90% |
| åŒè§’è‰²äº¤äº’ï¼ˆä¹°å–åŒæ–¹ï¼‰ | ~11 | 6% |
| å¤šè§’è‰²äº¤äº’ï¼ˆä¹°å–+ç®¡ç†å‘˜ï¼‰ | ~6 | 3% |

**æ ¹å› **ï¼š
- æµ‹è¯•ç”¨ä¾‹è®¾è®¡ä¹ æƒ¯äº"å•ä¸€ç”¨æˆ·è§†è§’"
- æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹å‡†å¤‡æ•°æ®ï¼Œå¾ˆå°‘å¤ç”¨è·¨ç”¨æˆ·çš„æµ‹è¯•åœºæ™¯
- æ’¤å›æµ‹è¯•åªæœ‰å–å®¶å‚ä¸ï¼Œæ²¡æœ‰å…ˆè®©ä¹°å®¶ä¸‹å•

**å½±å“**ï¼š
- å¤šæ–¹ä¸šåŠ¡åœºæ™¯è¦†ç›–ä¸å…¨
- ä¸€æ–¹æ“ä½œå¯¹å¦ä¸€æ–¹çš„å½±å“æœªéªŒè¯

### 3.3 é—®é¢˜3ï¼šæµ‹è¯•åˆ†å±‚ä¸æ¸…æ™°

**ç°çŠ¶**ï¼š
```
tests/
â”œâ”€â”€ services/      # 32ä¸ª - æœåŠ¡å•å…ƒæµ‹è¯•
â”œâ”€â”€ business/      # 34ä¸ª - ä¸šåŠ¡æµ‹è¯•ï¼ˆå®šä½æ¨¡ç³Šï¼‰
â”œâ”€â”€ integration/   # 32ä¸ª - é›†æˆæµ‹è¯•
â”œâ”€â”€ market/        # 1ä¸ª  - å¸‚åœºæµ‹è¯•ï¼ˆå¤ªå°‘ï¼ï¼‰
â”œâ”€â”€ e2e/           # 3ä¸ª  - ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆå¤ªå°‘ï¼ï¼‰
â””â”€â”€ unit/          # 14ä¸ª - å•å…ƒæµ‹è¯•
```

**é—®é¢˜**ï¼š
- `market/` åªæœ‰ 1 ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œè€Œå¸‚åœºäº¤æ˜“æ˜¯æ ¸å¿ƒä¸šåŠ¡
- `e2e/` åªæœ‰ 3 ä¸ªï¼Œç«¯åˆ°ç«¯è¦†ç›–ä¸¥é‡ä¸è¶³
- `business/` å’Œ `services/` è¾¹ç•Œæ¨¡ç³Šï¼ŒèŒè´£é‡å 
- éš¾ä»¥å¿«é€Ÿå®šä½æŸä¸ªä¸šåŠ¡åœºæ™¯çš„æµ‹è¯•

### 3.4 é—®é¢˜4ï¼šæµ‹è¯•åœºæ™¯çŸ©é˜µç¼ºå¤±

ä»¥"æŒ‚ç‰Œæ’¤å›"ä¸ºä¾‹ï¼Œå®Œæ•´çš„æµ‹è¯•åœºæ™¯çŸ©é˜µåº”è¯¥æ˜¯ï¼š

| æ’¤å›æ—¶æœº | æŒ‚ç‰ŒçŠ¶æ€ | æ˜¯å¦æœ‰è®¢å• | è®¢å•çŠ¶æ€ | æ˜¯å¦æµ‹è¯• |
|----------|----------|------------|----------|----------|
| æ­£å¸¸æ’¤å› | on_sale | æ—  | - | âœ… æœ‰ |
| æƒé™æ ¡éªŒ | on_sale | æ—  | - | âœ… æœ‰ |
| **æœ‰å¾…å¤„ç†è®¢å•** | **locked** | **æœ‰** | **frozen** | **âŒ æ— ** |
| æœ‰å·²å®Œæˆè®¢å• | sold | æœ‰ | completed | âŒ æ—  |
| æœ‰å·²å–æ¶ˆè®¢å• | on_sale | æœ‰ | cancelled | âŒ æ—  |

**æ ¹å› **ï¼š
- æ²¡æœ‰ç³»ç»ŸåŒ–çš„"åœºæ™¯çŸ©é˜µ"æ€ç»´
- æµ‹è¯•é ç›´è§‰è€Œéç©·ä¸¾
- ç¼ºä¹ä¸šåŠ¡åœºæ™¯çš„ç³»ç»Ÿæ€§æ¢³ç†

### 3.5 é—®é¢˜5ï¼šæ•°æ®ä¾èµ–å…³ç³»æœªå»ºæ¨¡

**å®ä½“å…³ç³»**ï¼š
```
MarketListing 1 â†â†’ N TradeOrder
TradeOrder    1 â†â†’ 1 AssetTransaction (å†»ç»“)
User          1 â†â†’ N AccountAssetBalance
```

**é—®é¢˜**ï¼š
- æµ‹è¯•æ—¶åªéªŒè¯"å½“å‰å®ä½“"ï¼Œä¸éªŒè¯"å…³è”å®ä½“"çš„å‰¯ä½œç”¨
- åˆ é™¤ Listing æ—¶ï¼Œæ²¡æœ‰éªŒè¯å…³è”çš„ Order å’Œ Asset æ˜¯å¦æ­£ç¡®å¤„ç†
- ç¼ºä¹"çº§è”å½±å“"çš„æµ‹è¯•æ„è¯†

---

## 4. æ”¹è¿›æ–¹æ¡ˆ

### 4.1 æ–¹æ¡ˆ1ï¼šå»ºç«‹"çŠ¶æ€æœºæµ‹è¯•"æ ‡å‡†

**ç›®æ ‡**ï¼šæ¯ä¸ªæœ‰çŠ¶æ€çš„å®ä½“å¿…é¡»æœ‰å®Œæ•´çš„çŠ¶æ€æœºæµ‹è¯•

**è¦æ±‚**ï¼š
1. **çŠ¶æ€è½¬æ¢å›¾æ–‡æ¡£**ï¼šç»˜åˆ¶å®ä½“çš„å®Œæ•´çŠ¶æ€è½¬æ¢å›¾
2. **åˆæ³•è½¬æ¢æµ‹è¯•**ï¼šæ¯ä¸ªåˆæ³•çš„çŠ¶æ€è½¬æ¢éƒ½æœ‰æµ‹è¯•
3. **ä¸­é—´çŠ¶æ€ä¸­æ–­æµ‹è¯•**ï¼šæ¯ä¸ª"ä¸­é—´çŠ¶æ€è¢«æ‰“æ–­"çš„åœºæ™¯éƒ½æœ‰æµ‹è¯•

**ç¤ºä¾‹**ï¼ˆè®¢å•çŠ¶æ€æœºï¼‰ï¼š
```
çŠ¶æ€ï¼šcreated â†’ frozen â†’ completed
                  â†“
              cancelled

å¿…éœ€æµ‹è¯•ï¼š
- created â†’ frozenï¼ˆæ­£å¸¸ï¼‰
- frozen â†’ completedï¼ˆæ­£å¸¸ï¼‰
- frozen â†’ cancelledï¼ˆä¹°å®¶å–æ¶ˆï¼‰
- frozen â†’ cancelledï¼ˆå–å®¶æ’¤å›è§¦å‘ï¼‰  â† æœ¬æ¬¡ç¼ºå¤±çš„åœºæ™¯
- created â†’ cancelledï¼ˆè¶…æ—¶ï¼‰
```

**æ‰§è¡Œå»ºè®®**ï¼š
- åœ¨ `tests/scenario/` ä¸‹æŒ‰å®ä½“ç»„ç»‡çŠ¶æ€æœºæµ‹è¯•
- æ¯ä¸ªå®ä½“ä¸€ä¸ª `xxx-lifecycle.test.js` æ–‡ä»¶
- ä½¿ç”¨è¡¨æ ¼é©±åŠ¨æµ‹è¯•è¦†ç›–æ‰€æœ‰çŠ¶æ€è½¬æ¢

### 4.2 æ–¹æ¡ˆ2ï¼šå¼•å…¥"è§’è‰²äº¤äº’æµ‹è¯•æ¨¡æ¿"

**ç›®æ ‡**ï¼šæ¶‰åŠå¤šæ–¹çš„ä¸šåŠ¡å¿…é¡»æœ‰è·¨è§’è‰²æµ‹è¯•

**å¼ºåˆ¶è¦æ±‚**ï¼š
1. åŒæ–¹æ­£å¸¸å®Œæˆæµç¨‹
2. Aæ–¹ä¸­é€”é€€å‡ºï¼ŒBæ–¹å¦‚ä½•å¤„ç†
3. Aæ–¹æ“ä½œå¤±è´¥ï¼ŒBæ–¹çŠ¶æ€å›æ»š
4. å¹¶å‘æ“ä½œï¼ˆAã€BåŒæ—¶æ“ä½œï¼‰

**æ¨¡æ¿**ï¼š
```javascript
describe('è·¨è§’è‰²äº¤äº’ï¼šå¸‚åœºäº¤æ˜“', () => {
  describe('æ­£å¸¸æµç¨‹', () => {
    it('å–å®¶æŒ‚ç‰Œ â†’ ä¹°å®¶ä¸‹å• â†’ å®Œæˆäº¤æ˜“')
  })
  
  describe('å–å®¶ä¸­é€”é€€å‡º', () => {
    it('å–å®¶æŒ‚ç‰Œ â†’ ä¹°å®¶ä¸‹å• â†’ å–å®¶æ’¤å› â†’ ä¹°å®¶èµ„äº§è§£å†»')  // â† æœ¬æ¬¡ç¼ºå¤±
    it('å–å®¶æŒ‚ç‰Œ â†’ ä¹°å®¶ä¸‹å• â†’ å–å®¶è´¦å·è¢«ç¦ â†’ è®¢å•å¤„ç†')
  })
  
  describe('ä¹°å®¶ä¸­é€”é€€å‡º', () => {
    it('å–å®¶æŒ‚ç‰Œ â†’ ä¹°å®¶ä¸‹å• â†’ ä¹°å®¶å–æ¶ˆ â†’ æŒ‚ç‰Œæ¢å¤')
    it('å–å®¶æŒ‚ç‰Œ â†’ ä¹°å®¶ä¸‹å• â†’ è®¢å•è¶…æ—¶ â†’ è‡ªåŠ¨å–æ¶ˆ')
  })
  
  describe('å¹¶å‘åœºæ™¯', () => {
    it('å¤šä¸ªä¹°å®¶åŒæ—¶ä¸‹å•åŒä¸€æŒ‚ç‰Œ')
  })
})
```

### 4.3 æ–¹æ¡ˆ3ï¼šæµ‹è¯•åœºæ™¯çŸ©é˜µåŒ–

**ç›®æ ‡**ï¼šæ ¸å¿ƒä¸šåŠ¡ä½¿ç”¨åœºæ™¯çŸ©é˜µç³»ç»ŸåŒ–è¦†ç›–

**æ–¹æ³•**ï¼š
1. è¯†åˆ«è¾“å…¥ç»´åº¦
2. åˆ—å‡ºæ¯ä¸ªç»´åº¦çš„å¯èƒ½å€¼
3. ç”Ÿæˆç»„åˆçŸ©é˜µ
4. ç­›é€‰æœ‰æ•ˆç»„åˆ
5. ä¸ºæ¯ä¸ªæœ‰æ•ˆç»„åˆç¼–å†™æµ‹è¯•

**ç¤ºä¾‹**ï¼ˆæ’¤å›æŒ‚ç‰Œï¼‰ï¼š
```
åŠŸèƒ½: æ’¤å›æŒ‚ç‰Œ

è¾“å…¥ç»´åº¦:
  - æŒ‚ç‰ŒçŠ¶æ€: [on_sale, locked, withdrawn, sold]
  - æ˜¯å¦æœ‰è®¢å•: [æ— , æœ‰å¾…å¤„ç†, æœ‰å·²å®Œæˆ]
  - æ“ä½œè€…: [å–å®¶, éå–å®¶, ç®¡ç†å‘˜]

æœ‰æ•ˆç»„åˆæ•°: 4 Ã— 3 Ã— 3 = 36 ç§
ç­›é€‰åæœ‰æ•ˆåœºæ™¯: çº¦ 15 ç§
```

**æ‰§è¡Œå»ºè®®**ï¼š
- åœ¨ `docs/test-matrices/` ä¸‹ç»´æŠ¤åœºæ™¯çŸ©é˜µæ–‡æ¡£
- æ¯ä¸ªæ ¸å¿ƒåŠŸèƒ½ä¸€ä¸ªçŸ©é˜µ
- Code Review æ—¶æ£€æŸ¥çŸ©é˜µè¦†ç›–ç‡

### 4.4 æ–¹æ¡ˆ4ï¼šé‡ç»„æµ‹è¯•ç›®å½•ç»“æ„

**å»ºè®®ç»“æ„**ï¼š
```
tests/
â”œâ”€â”€ unit/              # çº¯å‡½æ•°ã€å·¥å…·ç±»ï¼ˆæ— å¤–éƒ¨ä¾èµ–ï¼‰
â”‚   â”œâ”€â”€ utils/
â”‚   â””â”€â”€ helpers/
â”‚
â”œâ”€â”€ service/           # å•æœåŠ¡æµ‹è¯•ï¼ˆmock å¤–éƒ¨ä¾èµ–ï¼‰
â”‚   â”œâ”€â”€ AssetService.test.js
â”‚   â””â”€â”€ MarketListingService.test.js
â”‚
â”œâ”€â”€ integration/       # è·¨æœåŠ¡é›†æˆï¼ˆçœŸå®ä¾èµ–ï¼Œæµ‹è¯•æ•°æ®åº“ï¼‰
â”‚   â”œâ”€â”€ asset-market-integration.test.js
â”‚   â””â”€â”€ order-asset-integration.test.js
â”‚
â”œâ”€â”€ scenario/          # ä¸šåŠ¡åœºæ™¯ï¼ˆæŒ‰ç”¨æˆ·æ•…äº‹ç»„ç»‡ï¼‰
â”‚   â”œâ”€â”€ market/
â”‚   â”‚   â”œâ”€â”€ listing-lifecycle.test.js      # æŒ‚ç‰Œç”Ÿå‘½å‘¨æœŸ
â”‚   â”‚   â”œâ”€â”€ order-lifecycle.test.js        # è®¢å•ç”Ÿå‘½å‘¨æœŸ
â”‚   â”‚   â””â”€â”€ cross-user-interaction.test.js # è·¨ç”¨æˆ·äº¤äº’
â”‚   â”œâ”€â”€ lottery/
â”‚   â””â”€â”€ backpack/
â”‚
â”œâ”€â”€ e2e/               # ç«¯åˆ°ç«¯ï¼ˆçœŸå®APIè°ƒç”¨ï¼‰
â”‚   â”œâ”€â”€ market-flow.e2e.test.js
â”‚   â””â”€â”€ lottery-flow.e2e.test.js
â”‚
â””â”€â”€ stress/            # å‹åŠ›æµ‹è¯•
    â””â”€â”€ concurrent-purchase.stress.test.js
```

**è¿ç§»ç­–ç•¥**ï¼š
1. æ–°æµ‹è¯•æŒ‰æ–°ç»“æ„åˆ›å»º
2. æ—§æµ‹è¯•é€æ­¥è¿ç§»
3. è®¾ç½® 6 ä¸ªæœˆè¿‡æ¸¡æœŸ

### 4.5 æ–¹æ¡ˆ5ï¼šå¼•å…¥"å…³è”å½±å“æ£€æŸ¥"è§„èŒƒ

**ç›®æ ‡**ï¼šæ¯ä¸ª"åˆ é™¤/å–æ¶ˆ/æ’¤å›"æ“ä½œçš„æµ‹è¯•å¿…é¡»éªŒè¯å…³è”å½±å“

**æ£€æŸ¥æ¸…å•**ï¼š
```
â–¡ ä¸»å®ä½“çŠ¶æ€æ­£ç¡®
â–¡ å…³è”å®ä½“çŠ¶æ€æ­£ç¡®
â–¡ èµ„äº§/ä½™é¢å˜åŠ¨æ­£ç¡®
â–¡ å®¡è®¡æ—¥å¿—å®Œæ•´
â–¡ é€šçŸ¥/æ¶ˆæ¯å‘é€æ­£ç¡®
â–¡ ç¼“å­˜å·²å¤±æ•ˆ
```

**ç¤ºä¾‹**ï¼ˆæ’¤å›æŒ‚ç‰Œï¼‰ï¼š
```javascript
it('æ’¤å›æŒ‚ç‰Œæ—¶åº”æ­£ç¡®å¤„ç†æ‰€æœ‰å…³è”æ•°æ®', async () => {
  // å‡†å¤‡ï¼šåˆ›å»ºæŒ‚ç‰Œå’Œè®¢å•
  
  // æ‰§è¡Œï¼šæ’¤å›æŒ‚ç‰Œ
  
  // éªŒè¯ï¼šä¸»å®ä½“
  expect(listing.status).toBe('withdrawn')
  
  // éªŒè¯ï¼šå…³è”è®¢å•
  expect(order.status).toBe('cancelled')
  
  // éªŒè¯ï¼šä¹°å®¶èµ„äº§
  expect(buyer_balance.frozen_amount).toBe(0)
  expect(buyer_balance.available_amount).toBe(åŸå€¼ + è§£å†»é‡‘é¢)
  
  // éªŒè¯ï¼šå®¡è®¡æ—¥å¿—
  const audit = await AuditLog.findOne({ where: { target_id: listing.listing_id } })
  expect(audit).toBeDefined()
  
  // éªŒè¯ï¼šç¼“å­˜
  const cached = await redis.get(`listing:${listing.listing_id}`)
  expect(cached).toBeNull()
})
```

---

## 5. å®æ–½è®¡åˆ’

### 5.1 ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | æ”¹è¿›é¡¹ | é¢„æœŸæ”¶ç›Š | å·¥ä½œé‡ |
|--------|--------|----------|--------|
| P0 | è¡¥å……"çŠ¶æ€ä¸­æ–­"æµ‹è¯• | é˜²æ­¢ç±»ä¼¼å­¤å„¿å†»ç»“é—®é¢˜ | 2-3å¤© |
| P0 | å¢åŠ è·¨è§’è‰²äº¤äº’æµ‹è¯• | è¦†ç›–å¤šæ–¹ä¸šåŠ¡åœºæ™¯ | 3-5å¤© |
| P1 | å»ºç«‹åœºæ™¯çŸ©é˜µæ¨¡æ¿ | ç³»ç»ŸåŒ–è¦†ç›–è¾¹ç•Œ | 1-2å¤© |
| P2 | é‡ç»„æµ‹è¯•ç›®å½• | æé«˜å¯ç»´æŠ¤æ€§ | 5-7å¤© |
| P2 | å…³è”å½±å“æ£€æŸ¥è§„èŒƒ | é˜²æ­¢æ•°æ®ä¸ä¸€è‡´ | 2-3å¤© |

### 5.2 çŸ­æœŸè¡ŒåŠ¨ï¼ˆ1-2å‘¨ï¼‰

1. **ç«‹å³è¡¥å……**ï¼šæŒ‚ç‰Œæ’¤å›+ä¹°å®¶è®¢å•çš„æµ‹è¯•ç”¨ä¾‹ï¼ˆå·²å®Œæˆï¼‰
2. **æ¢³ç†æ¸…å•**ï¼šåˆ—å‡ºæ‰€æœ‰"åˆ é™¤/å–æ¶ˆ/æ’¤å›"ç±»æ“ä½œ
3. **é€ä¸ªæ£€æŸ¥**ï¼šä¸ºæ¯ä¸ªæ“ä½œè¡¥å……å…³è”å½±å“æµ‹è¯•

### 5.3 ä¸­æœŸè¡ŒåŠ¨ï¼ˆ1ä¸ªæœˆï¼‰

1. **çŠ¶æ€æœºæ–‡æ¡£**ï¼šä¸ºè®¢å•ã€æŒ‚ç‰Œã€ç‰©å“ç»˜åˆ¶çŠ¶æ€è½¬æ¢å›¾
2. **åœºæ™¯çŸ©é˜µ**ï¼šä¸ºæ ¸å¿ƒä¸šåŠ¡å»ºç«‹æµ‹è¯•åœºæ™¯çŸ©é˜µ
3. **æ¨¡æ¿æ¨å¹¿**ï¼šåœ¨å›¢é˜Ÿæ¨å¹¿è§’è‰²äº¤äº’æµ‹è¯•æ¨¡æ¿

### 5.4 é•¿æœŸè¡ŒåŠ¨ï¼ˆ3ä¸ªæœˆï¼‰

1. **ç›®å½•é‡ç»„**ï¼šæŒ‰æ–°ç»“æ„ç»„ç»‡æµ‹è¯•æ–‡ä»¶
2. **è¦†ç›–ç‡ç›‘æ§**ï¼šå»ºç«‹åœºæ™¯è¦†ç›–ç‡æŒ‡æ ‡
3. **è‡ªåŠ¨åŒ–æ£€æŸ¥**ï¼šCI/CD ä¸­æ£€æŸ¥åœºæ™¯çŸ©é˜µè¦†ç›–

---

## 6. æ€»ç»“

### 6.1 æ ¸å¿ƒç»“è®º

æµ‹è¯•ä½“ç³»çš„æ ¹æœ¬é—®é¢˜ä¸æ˜¯"æµ‹è¯•æ•°é‡ä¸å¤Ÿ"ï¼ˆ177ä¸ªå·²ç»å¾ˆå¤šï¼‰ï¼Œè€Œæ˜¯ï¼š

1. **æµ‹è¯•æ€ç»´åå‘"æ­£å‘æµç¨‹éªŒè¯"**
2. **ç¼ºä¹"å¼‚å¸¸ä¸­æ–­"çš„ç³»ç»Ÿæ€§è¦†ç›–**
3. **ç¼ºä¹"å¤šæ–¹äº¤äº’"çš„æµ‹è¯•æ„è¯†**
4. **ç¼ºä¹"çŠ¶æ€æœº"çš„æµ‹è¯•æ–¹æ³•**

### 6.2 æ”¹è¿›åŸåˆ™

- **ä»"éªŒè¯åŠŸèƒ½"åˆ°"éªŒè¯è¾¹ç•Œ"**
- **ä»"å•ç”¨æˆ·è§†è§’"åˆ°"å¤šè§’è‰²äº¤äº’"**
- **ä»"ç›´è§‰é©±åŠ¨"åˆ°"çŸ©é˜µé©±åŠ¨"**
- **ä»"åªéªŒä¸»ä½“"åˆ°"éªŒè¯å…³è”"**

### 6.3 é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ |
|------|------|------|
| çŠ¶æ€æœºæµ‹è¯•è¦†ç›– | ~3% | >80% |
| è·¨è§’è‰²æµ‹è¯•å æ¯” | 6% | >30% |
| åœºæ™¯çŸ©é˜µè¦†ç›– | æ—  | æ ¸å¿ƒä¸šåŠ¡100% |
| å…³è”å½±å“æ£€æŸ¥ | éƒ¨åˆ† | 100% |

---

## 7. å®é™…ç›®å½•éªŒè¯ç»“æœ

### 7.1 æ–‡æ¡£åˆ†æå‡†ç¡®æ€§éªŒè¯

é€šè¿‡å¯¹ `tests/` ç›®å½•çš„æ·±åº¦æ¢ç´¢ï¼Œç¡®è®¤äº†ä¸Šè¿°åˆ†æçš„å‡†ç¡®æ€§ï¼š

| ç›®å½• | æ–‡æ¡£è®°å½• | å®é™…æƒ…å†µ | éªŒè¯ç»“æœ |
|------|----------|----------|----------|
| `market/` | 1ä¸ªæ–‡ä»¶ | 1ä¸ªæ–‡ä»¶ (`market-trade-flow.test.js`) | âœ… ç¡®è®¤ |
| `e2e/` | 3ä¸ªæ–‡ä»¶ | 3ä¸ªæ–‡ä»¶ (admin/merchant/user_journey) | âœ… ç¡®è®¤ |
| `services/` | 32ä¸ª | çº¦30+æ–‡ä»¶å’Œå­ç›®å½• | âœ… å¤§è‡´ç¬¦åˆ |
| `business/` | 34ä¸ª | å¤šä¸ªå­ç›®å½• (market/lottery/backpackç­‰) | âœ… ç¬¦åˆ |

### 7.2 å®Œæ•´ç›®å½•ç»“æ„

```
tests/
â”œâ”€â”€ api/                    # APIæµ‹è¯•ï¼ˆ2ä¸ªå­ç›®å½•ï¼‰
â”œâ”€â”€ api-contracts/          # APIå¥‘çº¦æµ‹è¯•ï¼ˆ8ä¸ªæ–‡ä»¶ï¼‰
â”œâ”€â”€ business/               # ä¸šåŠ¡æµ‹è¯•ï¼ˆ15ä¸ªå­ç›®å½•ï¼‰
â”œâ”€â”€ chaos/                  # æ··æ²Œå·¥ç¨‹æµ‹è¯•ï¼ˆ7ä¸ªæ–‡ä»¶ï¼‰
â”œâ”€â”€ config/                 # æµ‹è¯•é…ç½®ï¼ˆ1ä¸ªæ–‡ä»¶ï¼‰
â”œâ”€â”€ core/                   # æ ¸å¿ƒæµ‹è¯•ï¼ˆ7ä¸ªæ–‡ä»¶ï¼‰
â”œâ”€â”€ critical/               # å…³é”®æµ‹è¯•ï¼ˆ1ä¸ªæ–‡ä»¶ï¼‰
â”œâ”€â”€ e2e/                    # ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆ3ä¸ªæ–‡ä»¶ï¼‰
â”œâ”€â”€ helpers/                # æµ‹è¯•è¾…åŠ©ï¼ˆ11ä¸ªæ–‡ä»¶ï¼‰
â”œâ”€â”€ integration/            # é›†æˆæµ‹è¯•ï¼ˆ32ä¸ªæ–‡ä»¶ï¼‰
â”œâ”€â”€ jobs/                   # å®šæ—¶ä»»åŠ¡æµ‹è¯•ï¼ˆ11ä¸ªæ–‡ä»¶ï¼‰
â”œâ”€â”€ market/                 # å¸‚åœºæµ‹è¯•ï¼ˆ1ä¸ªæ–‡ä»¶ï¼‰
â”œâ”€â”€ middleware/             # ä¸­é—´ä»¶æµ‹è¯•ï¼ˆ4ä¸ªæ–‡ä»¶ï¼‰
â”œâ”€â”€ observability/          # å¯è§‚æµ‹æ€§æµ‹è¯•ï¼ˆ1ä¸ªæ–‡ä»¶ï¼‰
â”œâ”€â”€ security/               # å®‰å…¨æµ‹è¯•ï¼ˆ8ä¸ªæ–‡ä»¶ï¼‰
â”œâ”€â”€ services/               # æœåŠ¡æµ‹è¯•ï¼ˆå¤šä¸ªå­ç›®å½•ï¼‰
â”œâ”€â”€ shared/                 # å…±äº«æµ‹è¯•å¥—ä»¶ï¼ˆ7ä¸ªæ–‡ä»¶ï¼‰
â”œâ”€â”€ specialized/            # ä¸“é¡¹æµ‹è¯•ï¼ˆ12ä¸ªæ–‡ä»¶ï¼‰
â””â”€â”€ unit/                   # å•å…ƒæµ‹è¯•ï¼ˆ3ä¸ªå­ç›®å½•ï¼‰
```

---

## 8. å…¶ä»–å¯ä»¥å®Œå–„çš„æµ‹è¯•é¢†åŸŸ

### 8.1 å¯è§‚æµ‹æ€§æµ‹è¯•ä¸¥é‡ä¸è¶³ï¼ˆP1ä¼˜å…ˆçº§ï¼‰

**å½“å‰çŠ¶æ€**ï¼š`observability/` åªæœ‰ **1ä¸ªæ–‡ä»¶** (`log-format.test.js`)

**ç¼ºå¤±çš„æµ‹è¯•**ï¼š
- ğŸ“Š **æŒ‡æ ‡ç›‘æ§æµ‹è¯•**ï¼šPrometheus/ç›‘æ§æŒ‡æ ‡çš„æ­£ç¡®æ€§
- ğŸ” **é“¾è·¯è¿½è¸ªæµ‹è¯•**ï¼šrequest_id åœ¨å…¨é“¾è·¯çš„ä¼ é€’
- ğŸ“ˆ **æ€§èƒ½ç›‘æ§æµ‹è¯•**ï¼šå“åº”æ—¶é—´ã€ååé‡ç­‰æŒ‡æ ‡
- ğŸš¨ **å‘Šè­¦è§„åˆ™æµ‹è¯•**ï¼šå‘Šè­¦è§¦å‘æ¡ä»¶éªŒè¯

**å»ºè®®è¡¥å……**ï¼š
```
tests/observability/
â”œâ”€â”€ log-format.test.js        âœ… å·²æœ‰
â”œâ”€â”€ metrics-export.test.js    âŒ éœ€æ–°å»ºï¼ˆæŒ‡æ ‡å¯¼å‡ºéªŒè¯ï¼‰
â”œâ”€â”€ trace-propagation.test.js âŒ éœ€æ–°å»ºï¼ˆé“¾è·¯è¿½è¸ªï¼‰
â”œâ”€â”€ alert-rules.test.js       âŒ éœ€æ–°å»ºï¼ˆå‘Šè­¦è§„åˆ™ï¼‰
â””â”€â”€ health-check.test.js      âŒ éœ€æ–°å»ºï¼ˆå¥åº·æ£€æŸ¥å®Œæ•´æ€§ï¼‰
```

### 8.2 APIå¥‘çº¦æµ‹è¯•ç¼ºå°‘å¸‚åœºæ¨¡å—ï¼ˆP0ä¼˜å…ˆçº§ï¼‰

**å½“å‰çŠ¶æ€**ï¼š`api-contracts/` æœ‰ 8 ä¸ªæ–‡ä»¶ï¼Œä½†ç¼ºå°‘å…³é”®æ¨¡å—

| æ¨¡å— | æ˜¯å¦æœ‰å¥‘çº¦æµ‹è¯• | é‡è¦æ€§ |
|------|----------------|--------|
| auth-verify | âœ… æœ‰ | é«˜ |
| user | âœ… æœ‰ | é«˜ |
| lottery | âœ… æœ‰ | é«˜ |
| order | âœ… æœ‰ | é«˜ |
| **market** | âŒ **ç¼ºå¤±** | **æé«˜** |
| **asset** | âŒ **ç¼ºå¤±** | **é«˜** |
| merchant | âœ… æœ‰ | ä¸­ |
| admin | âœ… æœ‰ | ä¸­ |

**éœ€è¦è¡¥å……**ï¼š
```
tests/api-contracts/
â”œâ”€â”€ market.contract.test.js   âŒ éœ€æ–°å»ºï¼ˆæŒ‚ç‰Œ/äº¤æ˜“å¥‘çº¦ï¼‰
â””â”€â”€ asset.contract.test.js    âŒ éœ€æ–°å»ºï¼ˆèµ„äº§æ¥å£å¥‘çº¦ï¼‰
```

### 8.3 å®šæ—¶ä»»åŠ¡æµ‹è¯•è¦†ç›–ä¸å‡ï¼ˆP1ä¼˜å…ˆçº§ï¼‰

**å½“å‰çŠ¶æ€**ï¼š`jobs/` æœ‰ 11 ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œè¦†ç›–ä¸é”™

å·²æœ‰æµ‹è¯•ï¼š
- `daily-asset-reconciliation.test.js`
- `daily-orphan-frozen-check.test.js`
- `hourly-expire-fungible-asset-listings.test.js`
- `hourly-unlock-timeout-trade-orders.test.js`
- ç­‰å…± 11 ä¸ª

**ä½†ç¼ºå°‘**ï¼š
- â° **ä»»åŠ¡å¤±è´¥é‡è¯•æµ‹è¯•**
- ğŸ”„ **ä»»åŠ¡å¹‚ç­‰æ€§æµ‹è¯•**
- ğŸ“Š **ä»»åŠ¡æ‰§è¡ŒæŒ‡æ ‡æµ‹è¯•**
- ğŸš¨ **ä»»åŠ¡å¼‚å¸¸å‘Šè­¦æµ‹è¯•**

### 8.4 æ··æ²Œå·¥ç¨‹æµ‹è¯•éœ€è¦æ‰©å±•ï¼ˆP2ä¼˜å…ˆçº§ï¼‰

**å½“å‰çŠ¶æ€**ï¼š`chaos/` æœ‰ 7 ä¸ªæ–‡ä»¶ï¼Œè¦†ç›–äº†åŸºç¡€åœºæ™¯

**å·²æœ‰**ï¼š
- âœ… `db_pool_recovery.test.js` - DBè¿æ¥æ± æ¢å¤
- âœ… `deadlock_detection.test.js` - æ­»é”æ£€æµ‹
- âœ… `memory_leak_detection.test.js` - å†…å­˜æ³„æ¼æ£€æµ‹
- âœ… `mysql_fault_injection.test.js` - MySQLæ•…éšœæ³¨å…¥
- âœ… `redis_fault_injection.test.js` - Redisæ•…éšœæ³¨å…¥
- âœ… `network_fault_injection.test.js` - ç½‘ç»œæ•…éšœæ³¨å…¥
- âœ… `service_fault_injection.test.js` - æœåŠ¡æ•…éšœæ³¨å…¥

**ç¼ºå¤±**ï¼š
- âŒ **çº§è”æ•…éšœæµ‹è¯•**ï¼šä¸€ä¸ªæœåŠ¡æ•…éšœå¯¹å…¶ä»–æœåŠ¡çš„å½±å“
- âŒ **é™æµé™çº§æµ‹è¯•**ï¼šåœ¨é«˜è´Ÿè½½ä¸‹çš„é™çº§è¡Œä¸º
- âŒ **æ•°æ®ä¸ä¸€è‡´æ¢å¤æµ‹è¯•**ï¼šæ•°æ®å¼‚å¸¸åçš„ä¿®å¤æµç¨‹

### 8.5 æµ‹è¯•æ•°æ®ç®¡ç†éœ€è¦å¼ºåŒ–ï¼ˆP1ä¼˜å…ˆçº§ï¼‰

**å½“å‰é—®é¢˜**ï¼š

ä» `helpers/` çœ‹åˆ°æœ‰å¤šä¸ªæ•°æ®ç®¡ç†å·¥å…·ï¼Œä½†åˆ†æ•£ï¼š
- `test-data.js`
- `TestDataCleaner.js`
- `test-points-setup.js`
- `real-users-config.js`ï¼ˆåœ¨ config/ ä¸‹ï¼‰

**éœ€è¦æ”¹è¿›**ï¼š
- ğŸ”§ **ç»Ÿä¸€æµ‹è¯•æ•°æ®å·¥å‚**ï¼šé›†ä¸­ç®¡ç†æµ‹è¯•æ•°æ®åˆ›å»º
- ğŸ§¹ **æ•°æ®æ¸…ç†æ ‡å‡†åŒ–**ï¼šç¡®ä¿æµ‹è¯•åæ•°æ®å®Œå…¨æ¸…ç†
- ğŸ“‹ **æµ‹è¯•æ•°æ®ç‰ˆæœ¬æ§åˆ¶**ï¼šé¿å…æµ‹è¯•é—´æ•°æ®æ±¡æŸ“

### 8.6 å¹¶å‘/å‹åŠ›æµ‹è¯•åˆ†æ•£ï¼ˆP2ä¼˜å…ˆçº§ï¼‰

**å½“å‰çŠ¶æ€**ï¼š

å¹¶å‘æµ‹è¯•åˆ†æ•£åœ¨å¤šä¸ªä½ç½®ï¼š
- `specialized/high_concurrency_5000.test.js`
- `specialized/ultra_high_concurrency.test.js`
- `integration/concurrent_purchase.test.js`
- `business/market/concurrent_purchase.test.js`ï¼ˆé‡å¤ï¼Ÿï¼‰

**é—®é¢˜**ï¼š
- åŒç±»æµ‹è¯•é‡å¤
- éš¾ä»¥ç»Ÿä¸€æ‰§è¡Œå‹åŠ›æµ‹è¯•
- ç¼ºå°‘åŸºå‡†æ€§èƒ½æŒ‡æ ‡

**å»ºè®®**ï¼š
```
tests/stress/                        # ç»Ÿä¸€å‹åŠ›æµ‹è¯•ç›®å½•
â”œâ”€â”€ concurrent-purchase.stress.js    # åˆå¹¶å¹¶å‘è´­ä¹°æµ‹è¯•
â”œâ”€â”€ concurrent-lottery.stress.js     # åˆå¹¶å¹¶å‘æŠ½å¥–æµ‹è¯•
â”œâ”€â”€ websocket-load.stress.js         # åˆå¹¶WebSocketæµ‹è¯•
â””â”€â”€ baseline-metrics.json            # åŸºå‡†æ€§èƒ½æŒ‡æ ‡
```

### 8.7 å®‰å…¨æµ‹è¯•æ·±åº¦ä¸å¤Ÿï¼ˆP1ä¼˜å…ˆçº§ï¼‰

**å½“å‰çŠ¶æ€**ï¼š`security/` æœ‰ 8 ä¸ªæ–‡ä»¶ï¼Œè¦†ç›–äº†å¸¸è§åœºæ™¯

**å·²æœ‰**ï¼š
- âœ… `sql-injection.test.js` - SQLæ³¨å…¥é˜²æŠ¤
- âœ… `xss-prevention.test.js` - XSSé˜²æŠ¤
- âœ… `authorization-bypass.test.js` - æˆæƒç»•è¿‡æµ‹è¯•
- âœ… `data-masking-unit.test.js` - æ•°æ®è„±æ•æµ‹è¯•
- âœ… `pii-encryption.test.js` - PIIåŠ å¯†æµ‹è¯•
- âœ… `log-sanitization.test.js` - æ—¥å¿—è„±æ•æµ‹è¯•
- âœ… `api-response-masking.test.js` - APIå“åº”è„±æ•
- âœ… `business-data-sanitizer.test.js` - ä¸šåŠ¡æ•°æ®è„±æ•

**ç¼ºå¤±**ï¼š
- âŒ **CSRFé˜²æŠ¤æµ‹è¯•**
- âŒ **æ•æ„Ÿæ“ä½œäºŒæ¬¡è®¤è¯æµ‹è¯•**
- âŒ **æ¥å£é¢‘ç‡é™åˆ¶è¾¹ç•Œæµ‹è¯•**
- âŒ **JWT Tokenå®‰å…¨æµ‹è¯•**ï¼ˆè¿‡æœŸã€ç¯¡æ”¹ã€é‡æ”¾ï¼‰

### 8.8 æµ‹è¯•æŠ¥å‘Šå’Œè¦†ç›–ç‡å¯è§†åŒ–ï¼ˆP2ä¼˜å…ˆçº§ï¼‰

**å½“å‰çŠ¶æ€**ï¼š

`jest.config.js` é…ç½®äº†è¦†ç›–ç‡é˜ˆå€¼ï¼š
```javascript
coverageThreshold: {
  global: {
    branches: 60,
    functions: 70,
    lines: 70,
    statements: 70
  },
  './services/': {
    branches: 70,
    functions: 80,
    lines: 80,
    statements: 80
  }
}
```

**éœ€è¦è¡¥å……**ï¼š
- ğŸ“Š **è¦†ç›–ç‡è¶‹åŠ¿æŠ¥å‘Š**ï¼šè·Ÿè¸ªè¦†ç›–ç‡å˜åŒ–
- ğŸ¯ **å…³é”®è·¯å¾„è¦†ç›–æŠ¥å‘Š**ï¼šæ ‡è®°æ ¸å¿ƒä¸šåŠ¡è·¯å¾„çš„è¦†ç›–
- ğŸ“‹ **æµ‹è¯•å¥åº·åº¦ä»ªè¡¨æ¿**ï¼šå¯è§†åŒ–æµ‹è¯•çŠ¶æ€

### 8.9 å…±äº«æµ‹è¯•å¥—ä»¶æœªå……åˆ†åˆ©ç”¨ï¼ˆP2ä¼˜å…ˆçº§ï¼‰

**å½“å‰çŠ¶æ€**ï¼š`shared/` æœ‰ 7 ä¸ªè¾…åŠ©æ¨¡å—

```
shared/
â”œâ”€â”€ beijing_time.helper.js    # æ—¶é—´è¾…åŠ©
â”œâ”€â”€ idempotency.helper.js     # å¹‚ç­‰æ€§è¾…åŠ©
â”œâ”€â”€ pagination.helper.js      # åˆ†é¡µè¾…åŠ©
â”œâ”€â”€ service.helper.js         # æœåŠ¡è¾…åŠ©
â”œâ”€â”€ soft_delete.helper.js     # è½¯åˆ é™¤è¾…åŠ©
â”œâ”€â”€ transaction.helper.js     # äº‹åŠ¡è¾…åŠ©
â””â”€â”€ index.js
```

**é—®é¢˜**ï¼šè¿™äº›è¾…åŠ©æ¨¡å—çš„ä½¿ç”¨ä¸ç»Ÿä¸€ï¼Œå¾ˆå¤šæµ‹è¯•è‡ªå·±é‡å¤å®ç°ç±»ä¼¼é€»è¾‘ã€‚

**å»ºè®®**ï¼š
- ğŸ“š ç¼–å†™å…±äº«æµ‹è¯•å¥—ä»¶ä½¿ç”¨æŒ‡å—
- ğŸ”§ å¼ºåˆ¶æ–°æµ‹è¯•ä½¿ç”¨å…±äº«è¾…åŠ©
- âœ… ä»£ç å®¡æŸ¥æ—¶æ£€æŸ¥æ˜¯å¦å¤ç”¨

### 8.10 å›å½’æµ‹è¯•å¥—ä»¶ç¼ºå¤±ï¼ˆP1ä¼˜å…ˆçº§ï¼‰

**å½“å‰çŠ¶æ€**ï¼šæ²¡æœ‰ä¸“é—¨çš„å›å½’æµ‹è¯•ç›®å½•

**éœ€è¦å»ºç«‹**ï¼š
```
tests/regression/
â”œâ”€â”€ p0-critical-paths.test.js       # P0çº§åˆ«å›å½’ï¼ˆæ¯æ¬¡å‘å¸ƒå¿…è·‘ï¼‰
â”œâ”€â”€ p1-important-features.test.js   # P1çº§åˆ«å›å½’
â””â”€â”€ bug-fixes/                      # BUGä¿®å¤éªŒè¯æµ‹è¯•
    â””â”€â”€ 2026-01-30-orphan-frozen.test.js  # å­¤å„¿å†»ç»“é—®é¢˜
```

---

## 9. å®Œå–„ä¼˜å…ˆçº§æ±‡æ€»

### 9.1 æ€»ä½“ä¼˜å…ˆçº§çŸ©é˜µ

| ä¼˜å…ˆçº§ | æ”¹è¿›é¡¹ | é¢„ä¼°å·¥ä½œé‡ | æ”¶ç›Š |
|--------|--------|-----------|------|
| **P0** | è¡¥å…… market/asset APIå¥‘çº¦æµ‹è¯• | 2å¤© | é˜²æ­¢æ¥å£å˜æ›´å¯¼è‡´çš„é—®é¢˜ |
| **P0** | å»ºç«‹å›å½’æµ‹è¯•å¥—ä»¶ | 3å¤© | é˜²æ­¢é—®é¢˜å¤ç° |
| **P0** | è¡¥å……"çŠ¶æ€ä¸­æ–­"æµ‹è¯• | 2-3å¤© | é˜²æ­¢ç±»ä¼¼å­¤å„¿å†»ç»“é—®é¢˜ |
| **P0** | å¢åŠ è·¨è§’è‰²äº¤äº’æµ‹è¯• | 3-5å¤© | è¦†ç›–å¤šæ–¹ä¸šåŠ¡åœºæ™¯ |
| **P1** | æ‰©å±•å¯è§‚æµ‹æ€§æµ‹è¯• | 3å¤© | æå‡è¿ç»´å¯è§æ€§ |
| **P1** | ç»Ÿä¸€æµ‹è¯•æ•°æ®ç®¡ç† | 2å¤© | å‡å°‘æµ‹è¯•æ±¡æŸ“ |
| **P1** | è¡¥å……å®‰å…¨æµ‹è¯•æ·±åº¦ | 3å¤© | å¢å¼ºå®‰å…¨é˜²æŠ¤ |
| **P1** | å»ºç«‹åœºæ™¯çŸ©é˜µæ¨¡æ¿ | 1-2å¤© | ç³»ç»ŸåŒ–è¦†ç›–è¾¹ç•Œ |
| **P2** | æ•´åˆå‹åŠ›æµ‹è¯• | 2å¤© | ç»Ÿä¸€æ€§èƒ½åŸºå‡† |
| **P2** | æ‰©å±•æ··æ²Œå·¥ç¨‹ | 3å¤© | æå‡ç³»ç»ŸéŸ§æ€§ |
| **P2** | æµ‹è¯•è¦†ç›–ç‡å¯è§†åŒ– | 2å¤© | æå‡å¯è§æ€§ |
| **P2** | é‡ç»„æµ‹è¯•ç›®å½• | 5-7å¤© | æé«˜å¯ç»´æŠ¤æ€§ |
| **P2** | å…³è”å½±å“æ£€æŸ¥è§„èŒƒ | 2-3å¤© | é˜²æ­¢æ•°æ®ä¸ä¸€è‡´ |

### 9.2 æ ¸å¿ƒå»ºè®®

1. **ç«‹å³è¡ŒåŠ¨**ï¼š
   - è¡¥å…… `market.contract.test.js` å’Œ `asset.contract.test.js`
   - å°†æœ¬æ¬¡å­¤å„¿å†»ç»“é—®é¢˜çš„æµ‹è¯•çº³å…¥å›å½’å¥—ä»¶

2. **çŸ­æœŸé‡ç‚¹**ï¼š
   - å»ºç«‹ `tests/regression/` å›å½’æµ‹è¯•ç›®å½•
   - ç»Ÿä¸€æµ‹è¯•æ•°æ®ç®¡ç†ï¼Œå‡å°‘æµ‹è¯•é—´çš„æ•°æ®ä¾èµ–

3. **ä¸­æœŸç›®æ ‡**ï¼š
   - å¯è§‚æµ‹æ€§ä¼˜å…ˆï¼šæ—¥å¿—/æŒ‡æ ‡/é“¾è·¯è¿½è¸ªçš„æµ‹è¯•æ˜¯è¿ç»´çš„åŸºç¡€
   - å®‰å…¨æµ‹è¯•æ·±åº¦ï¼šè¡¥å……CSRFã€JWTå®‰å…¨ç­‰æµ‹è¯•

4. **é•¿æœŸè§„åˆ’**ï¼š
   - æ•´åˆå¹¶å‘/å‹åŠ›æµ‹è¯•åˆ°ç»Ÿä¸€ç›®å½•
   - å»ºç«‹æµ‹è¯•å¥åº·åº¦ä»ªè¡¨æ¿

---

## 10. åŸºäºé¡¹ç›®æŠ€æœ¯æ ˆçš„é’ˆå¯¹æ€§æ”¹è¿›

æœ¬ç« èŠ‚åŸºäºé¡¹ç›®å®é™…æŠ€æœ¯æ¡†æ¶ï¼Œæä¾›æ›´è´´åˆæŠ€æœ¯æ ˆç‰¹ç‚¹çš„æ”¹è¿›å»ºè®®ã€‚

### 10.1 é¡¹ç›®æŠ€æœ¯æ ˆæ¦‚è§ˆ

| å±‚æ¬¡ | æŠ€æœ¯é€‰å‹ | ç‰ˆæœ¬ | æµ‹è¯•ç›¸å…³èƒ½åŠ› |
|------|----------|------|--------------|
| **è¿è¡Œæ—¶** | Node.js | 20.18.0+ | åŸç”Ÿ async/await æ”¯æŒ |
| **Webæ¡†æ¶** | Express | 4.18.x | ä¸­é—´ä»¶æµ‹è¯• |
| **ORM** | Sequelize | 6.35.x | äº‹åŠ¡éš”ç¦»ã€æ¨¡å‹å…³è” |
| **æ•°æ®åº“** | MySQL | mysql2 3.6.x | å¤–é”®çº¦æŸã€ç´¢å¼•éªŒè¯ |
| **ç¼“å­˜** | Redis | ioredis 5.7.x | Pipelineã€Lua è„šæœ¬ |
| **æµ‹è¯•æ¡†æ¶** | Jest | 29.7.x | Mockã€Snapshotã€å¹¶è¡Œ |
| **HTTPæµ‹è¯•** | Supertest | 6.3.x | API ç«¯åˆ°ç«¯æµ‹è¯• |
| **WebSocket** | Socket.io | 4.8.x | å®¢æˆ·ç«¯æµ‹è¯•æ”¯æŒ |
| **è®¤è¯** | JWT | 9.0.x | Token éªŒè¯æµ‹è¯• |
| **éªŒè¯** | Joi | 17.11.x | Schema è¾¹ç•Œæµ‹è¯• |
| **æ—¥å¿—** | Winston | 3.11.x | æ—¥å¿—æ ¼å¼éªŒè¯ |
| **å®šæ—¶ä»»åŠ¡** | node-cron | 3.0.x | Handler å•ç‹¬æµ‹è¯• |

### 10.2 ä¹‹å‰å»ºè®®æœªå……åˆ†è€ƒè™‘æŠ€æœ¯æ ˆçš„é—®é¢˜

#### é—®é¢˜1ï¼šSequelize äº‹åŠ¡éš”ç¦»èƒ½åŠ›æœªåˆ©ç”¨

**å½“å‰é—®é¢˜**ï¼šæµ‹è¯•ä¸­ç›´æ¥æ“ä½œæ•°æ®åº“ï¼Œæµ‹è¯•é—´æ•°æ®æ±¡æŸ“

**æ”¹è¿›æ–¹æ¡ˆ**ï¼šåˆ©ç”¨ Sequelize äº‹åŠ¡å›æ»šå®ç°æµ‹è¯•éš”ç¦»

```javascript
// âœ… æ¨èï¼šæ¯ä¸ªæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹äº‹åŠ¡
describe('äº¤æ˜“æµ‹è¯•', () => {
  let transaction
  
  beforeEach(async () => {
    // æ¯ä¸ªæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹äº‹åŠ¡
    const { sequelize } = require('../../config/database')
    transaction = await sequelize.transaction()
  })
  
  afterEach(async () => {
    // è‡ªåŠ¨å›æ»šï¼Œä¸æ±¡æŸ“æ•°æ®åº“
    await transaction.rollback()
  })
  
  it('ä¹°å®¶å–æ¶ˆè®¢å•åº”è§£å†»èµ„äº§', async () => {
    // æµ‹è¯•åœ¨äº‹åŠ¡å†…æ‰§è¡Œï¼Œç»“æŸåè‡ªåŠ¨å›æ»š
    const order = await TradeOrder.create({...}, { transaction })
    await TradeOrderService.cancelOrder(order.order_id, { transaction })
  })
})
```

**éœ€è¦è¡¥å……**ï¼š
```
tests/helpers/
â”œâ”€â”€ sequelize-test-helper.js   âŒ éœ€æ–°å»ºï¼ˆäº‹åŠ¡éš”ç¦»å°è£…ï¼‰
â””â”€â”€ transaction-wrapper.js     âŒ éœ€æ–°å»ºï¼ˆè‡ªåŠ¨å›æ»šè£…é¥°å™¨ï¼‰
```

#### é—®é¢˜2ï¼šServiceManager æµ‹è¯•ä¸€è‡´æ€§ä¸è¶³

**å½“å‰é—®é¢˜**ï¼šéƒ¨åˆ†æµ‹è¯•ç›´æ¥ `require` æœåŠ¡ï¼Œæœªä½¿ç”¨ `UnifiedTestManager`

**æ”¹è¿›æ–¹æ¡ˆ**ï¼šå¼ºåˆ¶æ‰€æœ‰æµ‹è¯•é€šè¿‡ `UnifiedTestManager` è·å–æœåŠ¡

```javascript
// âœ… æ­£ç¡®åšæ³• - ä¸è·¯ç”±å±‚ä¿æŒä¸€è‡´çš„ snake_case key
const { getTestService } = require('../helpers/UnifiedTestManager')

const market_listing_service = getTestService('market_listing')
const trade_order_service = getTestService('trade_order')
const asset_service = getTestService('asset')

// âŒ é”™è¯¯åšæ³• - ç›´æ¥ requireï¼ˆç»•è¿‡ ServiceManagerï¼‰
const MarketListingService = require('../../services/MarketListingService')
```

**éœ€è¦è¡¥å……**ï¼š
- ğŸ“‹ æ·»åŠ  ESLint è§„åˆ™æ£€æŸ¥ç›´æ¥ require æœåŠ¡çš„ä»£ç 
- ğŸ”§ å°†ç°æœ‰æµ‹è¯•è¿ç§»åˆ° UnifiedTestManager

#### é—®é¢˜3ï¼šioredis Mock ä¸å®Œå–„

**å½“å‰é—®é¢˜**ï¼š`test-mock-redis.js` æœªè¦†ç›– ioredis ç‰¹æœ‰æ–¹æ³•

**æ”¹è¿›æ–¹æ¡ˆ**ï¼šå®Œå–„ ioredis Mockï¼Œæ”¯æŒåˆ†å¸ƒå¼é”æµ‹è¯•

```javascript
// tests/helpers/redis-test-mock.jsï¼ˆéœ€å®Œå–„ï¼‰
const { EventEmitter } = require('events')

class MockRedisClient extends EventEmitter {
  constructor() {
    super()
    this._store = new Map()
  }
  
  // ioredis ç‰¹æœ‰æ–¹æ³•
  defineCommand(name, config) { /* ... */ }
  scanStream(options) { /* ... */ }
  
  // Pipeline æ”¯æŒ
  multi() { return this }
  exec() { return Promise.resolve([]) }
  
  // UnifiedDistributedLock ä½¿ç”¨çš„æ–¹æ³•
  async set(key, value, mode, duration) {
    if (mode === 'EX') {
      this._store.set(key, { value, expires: Date.now() + duration * 1000 })
    }
    return 'OK'
  }
  
  // Lua è„šæœ¬æ‰§è¡Œï¼ˆåˆ†å¸ƒå¼é”é‡Šæ”¾ï¼‰
  async eval(script, numKeys, ...args) {
    const key = args[0]
    const token = args[1]
    const current = this._store.get(key)
    if (current?.value === token) {
      this._store.delete(key)
      return 1
    }
    return 0
  }
}
```

**éœ€è¦è¡¥å……**ï¼š
```
tests/helpers/
â”œâ”€â”€ test-mock-redis.js         âœ… å·²æœ‰ï¼ˆéœ€å®Œå–„ï¼‰
â””â”€â”€ distributed-lock-mock.js   âŒ éœ€æ–°å»ºï¼ˆåˆ†å¸ƒå¼é” Mockï¼‰
```

#### é—®é¢˜4ï¼šSocket.io æµ‹è¯•èƒ½åŠ›æœªåˆ©ç”¨

**å½“å‰é—®é¢˜**ï¼šWebSocket æµ‹è¯•æœªä½¿ç”¨ `socket.io-client` è¿›è¡ŒçœŸå®è¿æ¥

**æ”¹è¿›æ–¹æ¡ˆ**ï¼šä½¿ç”¨ socket.io-client è¿›è¡Œé›†æˆæµ‹è¯•

```javascript
// tests/integration/websocket/chat-websocket.integration.test.js
const { io } = require('socket.io-client')

describe('ChatWebSocketService é›†æˆæµ‹è¯•', () => {
  let clientSocket
  let testToken
  
  beforeAll(async () => {
    testToken = await generateTestToken({ user_id: 1, role: 'user' })
  })
  
  beforeEach((done) => {
    clientSocket = io('http://localhost:3000', {
      auth: { token: testToken }
    })
    clientSocket.on('connect', done)
    clientSocket.on('connect_error', done)
  })
  
  afterEach(() => {
    if (clientSocket.connected) {
      clientSocket.disconnect()
    }
  })
  
  it('åº”è¯¥æˆåŠŸå»ºç«‹è®¤è¯è¿æ¥', () => {
    expect(clientSocket.connected).toBe(true)
  })
  
  it('åº”è¯¥æ”¶åˆ°æ–°æ¶ˆæ¯é€šçŸ¥', (done) => {
    clientSocket.on('new_message', (data) => {
      expect(data.session_id).toBeDefined()
      expect(data.content).toBeDefined()
      done()
    })
    // é€šè¿‡ API è§¦å‘æ¶ˆæ¯å‘é€
  })
  
  it('æœªè®¤è¯è¿æ¥åº”è¢«æ‹’ç»', (done) => {
    const unauthSocket = io('http://localhost:3000')
    unauthSocket.on('connect_error', (error) => {
      expect(error.message).toContain('Authentication')
      done()
    })
  })
})
```

**éœ€è¦è¡¥å……**ï¼š
```
tests/integration/websocket/
â”œâ”€â”€ chat-websocket.integration.test.js   âŒ éœ€æ–°å»º
â”œâ”€â”€ admin-notification.integration.test.js   âŒ éœ€æ–°å»º
â””â”€â”€ connection-lifecycle.integration.test.js   âŒ éœ€æ–°å»º
```

#### é—®é¢˜5ï¼šJoi éªŒè¯æµ‹è¯•ç¼ºå¤±

**å½“å‰é—®é¢˜**ï¼šè¯·æ±‚å‚æ•°éªŒè¯ä½¿ç”¨ Joiï¼Œä½†æ²¡æœ‰å¯¹åº”çš„ Schema è¾¹ç•Œæµ‹è¯•

**æ”¹è¿›æ–¹æ¡ˆ**ï¼šä¸ºæ ¸å¿ƒ API çš„ Joi Schema æ·»åŠ è¾¹ç•Œæµ‹è¯•

```javascript
// tests/unit/validators/market-validator.test.js
const Joi = require('joi')
const { createListingSchema } = require('../../../validators/market')

describe('å¸‚åœºæŒ‚ç‰Œå‚æ•°éªŒè¯', () => {
  describe('createListingSchema', () => {
    it('æœ‰æ•ˆå‚æ•°åº”é€šè¿‡éªŒè¯', () => {
      const { error } = createListingSchema.validate({
        asset_code: 'DIAMOND',
        quantity: 100,
        unit_price: 10.5
      })
      expect(error).toBeUndefined()
    })
    
    it('æŒ‚ç‰Œæ•°é‡ä¸èƒ½ä¸ºè´Ÿæ•°', () => {
      const { error } = createListingSchema.validate({
        asset_code: 'DIAMOND',
        quantity: -1,
        unit_price: 100
      })
      expect(error).toBeDefined()
      expect(error.details[0].path).toContain('quantity')
    })
    
    it('æŒ‚ç‰Œæ•°é‡ä¸èƒ½ä¸º0', () => {
      const { error } = createListingSchema.validate({
        asset_code: 'DIAMOND',
        quantity: 0,
        unit_price: 100
      })
      expect(error).toBeDefined()
    })
    
    it('å•ä»·ç²¾åº¦ä¸èƒ½è¶…è¿‡2ä½å°æ•°', () => {
      const { error } = createListingSchema.validate({
        asset_code: 'DIAMOND',
        quantity: 10,
        unit_price: 10.123
      })
      expect(error).toBeDefined()
    })
    
    it('asset_code ä¸èƒ½ä¸ºç©º', () => {
      const { error } = createListingSchema.validate({
        quantity: 10,
        unit_price: 100
      })
      expect(error).toBeDefined()
      expect(error.details[0].path).toContain('asset_code')
    })
  })
})
```

**éœ€è¦è¡¥å……**ï¼š
```
tests/unit/validators/
â”œâ”€â”€ market-validator.test.js     âŒ éœ€æ–°å»º
â”œâ”€â”€ asset-validator.test.js      âŒ éœ€æ–°å»º
â”œâ”€â”€ order-validator.test.js      âŒ éœ€æ–°å»º
â””â”€â”€ auth-validator.test.js       âŒ éœ€æ–°å»º
```

#### é—®é¢˜6ï¼šWinston æ—¥å¿—æµ‹è¯•ä¸å®Œæ•´

**å½“å‰é—®é¢˜**ï¼š`observability/log-format.test.js` åªæµ‹äº†æ ¼å¼ï¼Œæœªæµ‹å®Œæ•´é…ç½®

**æ”¹è¿›æ–¹æ¡ˆ**ï¼šæµ‹è¯• Winston çš„å®Œæ•´åŠŸèƒ½

```javascript
// tests/observability/winston-logger.test.js
const logger = require('../../utils/logger')

describe('Winston æ—¥å¿—ç³»ç»Ÿæµ‹è¯•', () => {
  describe('æ—¥å¿—çº§åˆ«é…ç½®', () => {
    it('å¼€å‘ç¯å¢ƒæ—¥å¿—çº§åˆ«åº”è¯¥æ˜¯ debug', () => {
      process.env.NODE_ENV = 'development'
      // é‡æ–°åŠ è½½ logger
      expect(logger.level).toBe('debug')
    })
    
    it('ç”Ÿäº§ç¯å¢ƒæ—¥å¿—çº§åˆ«åº”è¯¥æ˜¯ info', () => {
      process.env.NODE_ENV = 'production'
      expect(logger.level).toBe('info')
    })
  })
  
  describe('æ•æ„Ÿä¿¡æ¯è„±æ•', () => {
    it('æ‰‹æœºå·åº”è¯¥è¢«è„±æ•', () => {
      const spy = jest.spyOn(logger.transports[0], 'log')
      logger.info('ç”¨æˆ·ç™»å½•', { phone: '13812345678' })
      
      const loggedData = spy.mock.calls[0][0]
      expect(loggedData.phone).toMatch(/138\*\*\*\*5678/)
    })
    
    it('å¯†ç å­—æ®µåº”è¯¥è¢«éšè—', () => {
      const spy = jest.spyOn(logger.transports[0], 'log')
      logger.info('ç™»å½•è¯·æ±‚', { password: 'secret123' })
      
      const loggedData = spy.mock.calls[0][0]
      expect(loggedData.password).toBe('******')
    })
  })
  
  describe('request_id ä¼ é€’', () => {
    it('æ—¥å¿—åº”åŒ…å« request_id', () => {
      const spy = jest.spyOn(logger.transports[0], 'log')
      logger.info('å¤„ç†è¯·æ±‚', { request_id: 'req-123-abc' })
      
      const loggedData = spy.mock.calls[0][0]
      expect(loggedData.request_id).toBe('req-123-abc')
    })
  })
})
```

**éœ€è¦è¡¥å……**ï¼š
```
tests/observability/
â”œâ”€â”€ log-format.test.js          âœ… å·²æœ‰
â”œâ”€â”€ winston-logger.test.js      âŒ éœ€æ–°å»ºï¼ˆå®Œæ•´é…ç½®æµ‹è¯•ï¼‰
â”œâ”€â”€ log-sanitization.test.js    âŒ éœ€æ–°å»ºï¼ˆè„±æ•æµ‹è¯•ï¼‰
â””â”€â”€ request-id-propagation.test.js   âŒ éœ€æ–°å»ºï¼ˆé“¾è·¯è¿½è¸ªï¼‰
```

#### é—®é¢˜7ï¼šnode-cron Job æµ‹è¯•æ–¹å¼ä¸æ­£ç¡®

**å½“å‰é—®é¢˜**ï¼šå®šæ—¶ä»»åŠ¡æµ‹è¯•å¯èƒ½åœ¨æµ‹è¯• cron è°ƒåº¦è€Œéä¸šåŠ¡é€»è¾‘

**æ”¹è¿›æ–¹æ¡ˆ**ï¼šJob åº”å¯¼å‡º handler å‡½æ•°ï¼Œæµ‹è¯• handler è€Œé cron

```javascript
// jobs/daily-orphan-frozen-check.jsï¼ˆæ¨èç»“æ„ï¼‰
const handler = async () => {
  // æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
  const result = await OrphanFrozenCleanupService.cleanupOrphanFrozen()
  return result
}

// ä»…åœ¨éæµ‹è¯•ç¯å¢ƒæ³¨å†Œ cron
if (process.env.NODE_ENV !== 'test') {
  const cron = require('node-cron')
  cron.schedule('0 3 * * *', handler)
}

module.exports = { handler, schedule: '0 3 * * *' }
```

```javascript
// tests/jobs/daily-orphan-frozen-check.test.js
describe('æ—¥å¸¸å­¤å„¿å†»ç»“æ£€æŸ¥ä»»åŠ¡', () => {
  const { handler } = require('../../jobs/daily-orphan-frozen-check')
  
  it('åº”è¯¥æ¸…ç†è¶…è¿‡24å°æ—¶çš„å­¤å„¿å†»ç»“', async () => {
    // å‡†å¤‡æµ‹è¯•æ•°æ®
    await createOrphanFrozenRecord({ created_at: dayjs().subtract(25, 'hour') })
    
    // æ‰§è¡Œ handlerï¼ˆè€Œéç­‰å¾… cron è§¦å‘ï¼‰
    const result = await handler()
    
    expect(result.cleaned_count).toBeGreaterThanOrEqual(1)
  })
  
  it('åº”è¯¥è·³è¿‡24å°æ—¶å†…çš„å†»ç»“è®°å½•', async () => {
    await createOrphanFrozenRecord({ created_at: dayjs().subtract(12, 'hour') })
    
    const result = await handler()
    
    expect(result.skipped_count).toBeGreaterThanOrEqual(1)
  })
  
  it('åº”è¯¥è®°å½•æ¸…ç†æ—¥å¿—', async () => {
    const logSpy = jest.spyOn(logger, 'info')
    
    await handler()
    
    expect(logSpy).toHaveBeenCalledWith(
      expect.stringContaining('å­¤å„¿å†»ç»“æ¸…ç†'),
      expect.any(Object)
    )
  })
})
```

**éœ€è¦æ”¹è¿›**ï¼š
- ğŸ”§ å°†ç°æœ‰ Job æ–‡ä»¶é‡æ„ä¸ºå¯¼å‡º handler æ¨¡å¼
- ğŸ“‹ æ›´æ–° Job æµ‹è¯•ä¸ºæµ‹è¯• handler å‡½æ•°

#### é—®é¢˜8ï¼šIdempotencyService æµ‹è¯•è¦†ç›–ä¸è¶³

**å½“å‰é—®é¢˜**ï¼šé¡¹ç›®æœ‰ `IdempotencyService` ä½†æµ‹è¯•è¦†ç›–ä¸å®Œæ•´

**æ”¹è¿›æ–¹æ¡ˆ**ï¼šè¡¥å……å¹‚ç­‰æ€§è¾¹ç•Œæµ‹è¯•

```javascript
// tests/services/IdempotencyService.integration.test.js
const { getTestService } = require('../helpers/UnifiedTestManager')

describe('IdempotencyService é›†æˆæµ‹è¯•', () => {
  const IdempotencyService = getTestService('idempotency')
  
  describe('é‡å¤è¯·æ±‚å¤„ç†', () => {
    it('é‡å¤è¯·æ±‚åº”è¿”å›é¦–æ¬¡ç»“æœ', async () => {
      const idempotencyKey = `test_${Date.now()}_${Math.random()}`
      let executionCount = 0
      
      const executor = async () => {
        executionCount++
        return { success: true, value: 123 }
      }
      
      // é¦–æ¬¡è¯·æ±‚
      const first = await IdempotencyService.executeWithIdempotency(
        idempotencyKey, executor
      )
      
      // é‡å¤è¯·æ±‚ï¼ˆexecutor ä¸åº”å†æ‰§è¡Œï¼‰
      const second = await IdempotencyService.executeWithIdempotency(
        idempotencyKey, executor
      )
      
      expect(first.value).toBe(123)
      expect(second.value).toBe(123)
      expect(executionCount).toBe(1)  // åªæ‰§è¡Œä¸€æ¬¡
    })
    
    it('ä¸åŒ key åº”è¯¥ç‹¬ç«‹æ‰§è¡Œ', async () => {
      const key1 = `test_${Date.now()}_1`
      const key2 = `test_${Date.now()}_2`
      
      const result1 = await IdempotencyService.executeWithIdempotency(
        key1, async () => ({ value: 'A' })
      )
      const result2 = await IdempotencyService.executeWithIdempotency(
        key2, async () => ({ value: 'B' })
      )
      
      expect(result1.value).toBe('A')
      expect(result2.value).toBe('B')
    })
  })
  
  describe('è¿‡æœŸå¤„ç†', () => {
    it('è¿‡æœŸååº”è¯¥é‡æ–°æ‰§è¡Œ', async () => {
      // æµ‹è¯•å¹‚ç­‰é”®è¿‡æœŸåçš„è¡Œä¸º
    })
  })
  
  describe('å¹¶å‘åœºæ™¯', () => {
    it('å¹¶å‘ç›¸åŒ key åªæ‰§è¡Œä¸€æ¬¡', async () => {
      const idempotencyKey = `concurrent_${Date.now()}`
      let executionCount = 0
      
      const executor = async () => {
        executionCount++
        await new Promise(r => setTimeout(r, 100))
        return { value: executionCount }
      }
      
      // å¹¶å‘ 5 ä¸ªç›¸åŒ key çš„è¯·æ±‚
      const results = await Promise.all([
        IdempotencyService.executeWithIdempotency(idempotencyKey, executor),
        IdempotencyService.executeWithIdempotency(idempotencyKey, executor),
        IdempotencyService.executeWithIdempotency(idempotencyKey, executor),
        IdempotencyService.executeWithIdempotency(idempotencyKey, executor),
        IdempotencyService.executeWithIdempotency(idempotencyKey, executor),
      ])
      
      // æ‰€æœ‰ç»“æœåº”è¯¥ç›¸åŒ
      const values = results.map(r => r.value)
      expect(new Set(values).size).toBe(1)
      expect(executionCount).toBe(1)
    })
  })
})
```

**éœ€è¦è¡¥å……**ï¼š
```
tests/services/
â”œâ”€â”€ IdempotencyService.unit.test.js         âŒ éœ€æ–°å»º
â””â”€â”€ IdempotencyService.integration.test.js  âŒ éœ€æ–°å»º
```

### 10.3 åŸºäºæŠ€æœ¯æ ˆçš„ä¼˜å…ˆçº§é‡æ’

| ä¼˜å…ˆçº§ | æ”¹è¿›é¡¹ | æŠ€æœ¯æ ˆä¾èµ– | å·¥ä½œé‡ | æ”¶ç›Š |
|--------|--------|-----------|--------|------|
| **P0** | Sequelize äº‹åŠ¡éš”ç¦»æµ‹è¯•æ¨¡å¼ | Sequelize 6.x | 1å¤© | æµ‹è¯•æ•°æ®éš”ç¦» |
| **P0** | å¸‚åœº/èµ„äº§ API å¥‘çº¦æµ‹è¯• | Supertest + Joi | 2å¤© | æ¥å£ç¨³å®šæ€§ |
| **P0** | ServiceManager æµ‹è¯•ç»Ÿä¸€æ€§ | UnifiedTestManager | 0.5å¤© | ä»£ç ä¸€è‡´æ€§ |
| **P1** | ioredis Mock å®Œå–„ | ioredis + åˆ†å¸ƒå¼é” | 1å¤© | ç¼“å­˜æµ‹è¯•å¯é æ€§ |
| **P1** | Socket.io é›†æˆæµ‹è¯• | socket.io-client | 2å¤© | WebSocket ç¨³å®šæ€§ |
| **P1** | Joi Schema è¾¹ç•Œæµ‹è¯• | Joi 17.x | 1.5å¤© | è¾“å…¥éªŒè¯å®Œæ•´æ€§ |
| **P1** | IdempotencyService æµ‹è¯• | é¡¹ç›®ç‰¹æœ‰ | 1å¤© | å¹‚ç­‰æ€§ä¿éšœ |
| **P2** | Winston æ—¥å¿—å®Œæ•´æµ‹è¯• | Winston + DataSanitizer | 1å¤© | å¯è§‚æµ‹æ€§ |
| **P2** | node-cron Job handler é‡æ„ | node-cron | 2å¤© | Job å¯æµ‹è¯•æ€§ |

### 10.4 éœ€è¦æ–°å»ºçš„æŠ€æœ¯æ ˆç›¸å…³æµ‹è¯•æ–‡ä»¶

```
tests/
â”œâ”€â”€ helpers/
â”‚   â”œâ”€â”€ sequelize-test-helper.js     âŒ éœ€æ–°å»ºï¼ˆäº‹åŠ¡éš”ç¦»ï¼‰
â”‚   â”œâ”€â”€ redis-test-mock.js           âœ… å·²æœ‰ï¼ˆéœ€å®Œå–„ ioredis æ–¹æ³•ï¼‰
â”‚   â””â”€â”€ distributed-lock-mock.js     âŒ éœ€æ–°å»º
â”‚
â”œâ”€â”€ unit/
â”‚   â””â”€â”€ validators/
â”‚       â”œâ”€â”€ market-validator.test.js   âŒ éœ€æ–°å»º
â”‚       â”œâ”€â”€ asset-validator.test.js    âŒ éœ€æ–°å»º
â”‚       â””â”€â”€ order-validator.test.js    âŒ éœ€æ–°å»º
â”‚
â”œâ”€â”€ integration/
â”‚   â””â”€â”€ websocket/
â”‚       â”œâ”€â”€ chat-websocket.integration.test.js      âŒ éœ€æ–°å»º
â”‚       â””â”€â”€ connection-lifecycle.integration.test.js âŒ éœ€æ–°å»º
â”‚
â”œâ”€â”€ observability/
â”‚   â”œâ”€â”€ log-format.test.js             âœ… å·²æœ‰
â”‚   â”œâ”€â”€ winston-logger.test.js         âŒ éœ€æ–°å»º
â”‚   â””â”€â”€ request-id-propagation.test.js âŒ éœ€æ–°å»º
â”‚
â”œâ”€â”€ api-contracts/
â”‚   â”œâ”€â”€ market.contract.test.js        âŒ éœ€æ–°å»º
â”‚   â””â”€â”€ asset.contract.test.js         âŒ éœ€æ–°å»º
â”‚
â””â”€â”€ services/
    â”œâ”€â”€ IdempotencyService.unit.test.js         âŒ éœ€æ–°å»º
    â””â”€â”€ IdempotencyService.integration.test.js  âŒ éœ€æ–°å»º
```

---

## 11. æ€»ç»“

### 11.1 æ ¸å¿ƒç»“è®º

æµ‹è¯•ä½“ç³»çš„æ ¹æœ¬é—®é¢˜ä¸æ˜¯"æµ‹è¯•æ•°é‡ä¸å¤Ÿ"ï¼ˆ177ä¸ªå·²ç»å¾ˆå¤šï¼‰ï¼Œè€Œæ˜¯ï¼š

1. **æµ‹è¯•æ€ç»´åå‘"æ­£å‘æµç¨‹éªŒè¯"**
2. **ç¼ºä¹"å¼‚å¸¸ä¸­æ–­"çš„ç³»ç»Ÿæ€§è¦†ç›–**
3. **ç¼ºä¹"å¤šæ–¹äº¤äº’"çš„æµ‹è¯•æ„è¯†**
4. **ç¼ºä¹"çŠ¶æ€æœº"çš„æµ‹è¯•æ–¹æ³•**
5. **å…³é”®æ¨¡å—ï¼ˆå¸‚åœº/èµ„äº§ï¼‰çš„APIå¥‘çº¦æµ‹è¯•ç¼ºå¤±**
6. **å¯è§‚æµ‹æ€§å’Œå›å½’æµ‹è¯•ä½“ç³»è–„å¼±**
7. **æœªå……åˆ†åˆ©ç”¨æŠ€æœ¯æ ˆç‰¹æ€§**ï¼ˆSequelizeäº‹åŠ¡ã€ioredisã€Socket.ioç­‰ï¼‰
8. **å‹åŠ›æµ‹è¯•æœªåŒºåˆ†"é…ç½®éªŒè¯"ä¸"æé™å‹æµ‹"ç›®çš„**
9. **å¹¶å‘æµ‹è¯•æœªå¯¹é½ç³»ç»Ÿè®¾è®¡å®¹é‡ï¼ˆ1000+ç”¨æˆ·ï¼‰**

### 11.2 æ”¹è¿›åŸåˆ™

- **ä»"éªŒè¯åŠŸèƒ½"åˆ°"éªŒè¯è¾¹ç•Œ"**
- **ä»"å•ç”¨æˆ·è§†è§’"åˆ°"å¤šè§’è‰²äº¤äº’"**
- **ä»"ç›´è§‰é©±åŠ¨"åˆ°"çŸ©é˜µé©±åŠ¨"**
- **ä»"åªéªŒä¸»ä½“"åˆ°"éªŒè¯å…³è”"**
- **ä»"åˆ†æ•£æµ‹è¯•"åˆ°"ç»Ÿä¸€ç®¡ç†"**
- **ä»"é€šç”¨æ–¹æ¡ˆ"åˆ°"æŠ€æœ¯æ ˆé€‚é…"**
- **ä»"éšæ„å‹æµ‹"åˆ°"ç›®çš„æ˜ç¡®"**ï¼ˆé…ç½®éªŒè¯ vs æé™å‹æµ‹ï¼‰
- **ä»"å¿½ç•¥é…ç½®"åˆ°"åŸºäºè®¾è®¡å®¹é‡"**

### 11.3 é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ |
|------|------|------|
| çŠ¶æ€æœºæµ‹è¯•è¦†ç›– | ~3% | >80% |
| è·¨è§’è‰²æµ‹è¯•å æ¯” | 6% | >30% |
| åœºæ™¯çŸ©é˜µè¦†ç›– | æ—  | æ ¸å¿ƒä¸šåŠ¡100% |
| å…³è”å½±å“æ£€æŸ¥ | éƒ¨åˆ† | 100% |
| APIå¥‘çº¦æµ‹è¯•è¦†ç›– | 8ä¸ªæ¨¡å— | å…¨éƒ¨æ ¸å¿ƒæ¨¡å— |
| å›å½’æµ‹è¯•å¥—ä»¶ | æ—  | P0/P1çº§åˆ«å®Œæ•´è¦†ç›– |
| å¯è§‚æµ‹æ€§æµ‹è¯• | 1ä¸ªæ–‡ä»¶ | 5+ä¸ªæ–‡ä»¶ |
| **Sequelizeäº‹åŠ¡éš”ç¦»æµ‹è¯•** | **æ— ** | **æ ¸å¿ƒä¸šåŠ¡100%** |
| **Joi Schemaè¾¹ç•Œæµ‹è¯•** | **æ— ** | **æ‰€æœ‰APIå…¥å‚** |
| **WebSocketé›†æˆæµ‹è¯•** | **éƒ¨åˆ†** | **å®Œæ•´ç”Ÿå‘½å‘¨æœŸ** |
| **é…ç½®è¾¹ç•ŒéªŒè¯æµ‹è¯•** | **æ— ** | **æ‰€æœ‰ç³»ç»Ÿé…ç½®** |
| **1000+ç”¨æˆ·å¹¶å‘æµ‹è¯•** | **åˆ†æ•£** | **ç»Ÿä¸€+åŸºå‡†æ˜ç¡®** |
| **æé™å‹æµ‹ï¼ˆæ‰¾å´©æºƒç‚¹ï¼‰** | **æ— ** | **5000/10000ç”¨æˆ·** |

---

## 12. åŸºäºç³»ç»Ÿè®¾è®¡å®¹é‡çš„æµ‹è¯•è§„åˆ’

æœ¬ç« èŠ‚åŸºäºé¡¹ç›®å®é™…é…ç½®å’Œç³»ç»Ÿé™åˆ¶ï¼Œåˆ¶å®šç¬¦åˆä¸šåŠ¡é€»è¾‘çš„æµ‹è¯•æ–¹æ¡ˆã€‚

### 12.1 ç³»ç»Ÿè®¾è®¡å®¹é‡å…¨æ™¯å›¾

é€šè¿‡åˆ†æé¡¹ç›®é…ç½®æ–‡ä»¶ï¼Œæå–å„æœåŠ¡çš„è®¾è®¡å®¹é‡ï¼š

#### 12.1.1 æ€§èƒ½ç›®æ ‡ï¼ˆpackage.json å£°æ˜ï¼‰

| æŒ‡æ ‡ | è®¾è®¡å€¼ | æµ‹è¯•éªŒè¯ç‚¹ |
|------|--------|-----------|
| APIå“åº”æ—¶é—´ | < 100ms | P90/P99 å“åº”æ—¶é—´ |
| æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ | < 50ms | æ…¢æŸ¥è¯¢ç›‘æ§ |
| æ–‡ä»¶ä¸Šä¼ æ—¶é—´ | < 2s | å¤§æ–‡ä»¶ä¸Šä¼ æµ‹è¯• |
| ç³»ç»Ÿå¯ç”¨æ€§ | > 99.95% | æ•…éšœæ¢å¤æµ‹è¯• |
| **å¹¶å‘ç”¨æˆ·æ•°** | **1000+** | **å¹¶å‘å‹åŠ›æµ‹è¯•** |
| å­˜å‚¨å®¹é‡ | 20M+ images | å­˜å‚¨å‹åŠ›æµ‹è¯• |

#### 12.1.2 æ•°æ®åº“è¿æ¥æ± é…ç½®ï¼ˆconfig/database.jsï¼‰

```javascript
pool: {
  max: 40,           // æœ€å¤§è¿æ¥æ•° â­ 2025-12-30 å·²æ‹æ¿
  min: 5,            // æœ€å°è¿æ¥æ•°
  acquire: 10000,    // è·å–è¿æ¥è¶…æ—¶ 10ç§’
  idle: 60000,       // ç©ºé—²å›æ”¶ 1åˆ†é’Ÿ
  evict: 30000       // æ¸…ç†é—´éš” 30ç§’
}
```

**æµ‹è¯•æ„ä¹‰**ï¼š
- **é…ç½®éªŒè¯æµ‹è¯•**ï¼šéªŒè¯ 40 å¹¶å‘æ•°æ®åº“è¿æ¥çš„ç¨³å®šæ€§
- **æé™å‹æµ‹**ï¼šè¶…è¿‡ 40 è¿æ¥æ—¶çš„æ’é˜Ÿå’Œè¶…æ—¶è¡Œä¸º
- **æ¢å¤æµ‹è¯•**ï¼šè¿æ¥æ± è€—å°½åçš„æ¢å¤èƒ½åŠ›

#### 12.1.3 ä»£ç çº§ä¸šåŠ¡é™åˆ¶ï¼ˆconfig/business.config.jsï¼‰

| æ¨¡å— | é…ç½®é¡¹ | é™åˆ¶å€¼ | æµ‹è¯•éªŒè¯ç‚¹ | æ‹æ¿çŠ¶æ€ |
|------|--------|--------|-----------|---------|
| æŠ½å¥– | max_draw_count | 20 | å•æ¬¡æœ€å¤§20è¿æŠ½ | â­ 2026-01-18 å·²æ‹æ¿ |
| ç§¯åˆ† | max_balance | 99,999,999.99 | ç§¯åˆ†ä¸Šé™éªŒè¯ | - |
| ç”¨æˆ·å | max_length | 50å­—ç¬¦ | è¾¹ç•Œè¾“å…¥éªŒè¯ | - |
| ä¸Šä¼  | max_size_bytes | 10MB | å¤§æ–‡ä»¶æ‹’ç» | - |
| èŠå¤© | max_length | 5000å­—ç¬¦ | è¶…é•¿æ¶ˆæ¯æ‹’ç» | - |
| èŠå¤© | max_messages_per_minute | 20 (user) / 30 (admin) | æ¶ˆæ¯é¢‘ç‡é™åˆ¶ | - |

#### 12.1.4 è¿ç»´å¯é…ç½®é™åˆ¶ï¼ˆconfig/system-settings-whitelist.jsï¼‰

| é…ç½®é”® | å…è®¸èŒƒå›´ | é»˜è®¤å€¼æ¨æµ‹ | æµ‹è¯•éªŒè¯ç‚¹ |
|--------|---------|-----------|-----------|
| points/daily_lottery_limit | 10-200 | éœ€æŸ¥æ•°æ®åº“ | æ¯æ—¥æŠ½å¥–ä¸Šé™ |
| marketplace/max_active_listings | 1-50 | éœ€æŸ¥æ•°æ®åº“ | ç”¨æˆ·æŒ‚ç‰Œæ•°é‡é™åˆ¶ |
| marketplace/max_price_red_shard | 1000-10000000 | éœ€æŸ¥æ•°æ®åº“ | å•ä»·ä¸Šé™ |
| security/max_login_attempts | 3-10 | éœ€æŸ¥æ•°æ®åº“ | ç™»å½•å¤±è´¥é”å®š |
| security/api_rate_limit | 10-1000 | éœ€æŸ¥æ•°æ®åº“ | APIå…¨å±€é™æµ |

#### 12.1.5 ä¸­é—´ä»¶é™æµé…ç½®ï¼ˆRateLimiterMiddleware.jsï¼‰

| é™æµåœºæ™¯ | æ—¶é—´çª—å£ | æœ€å¤§è¯·æ±‚æ•° | Keyç”Ÿæˆæ–¹å¼ |
|----------|---------|-----------|------------|
| global | 60ç§’ | 100 | IP |
| lottery | 60ç§’ | 20 | user_id |
| login | 60ç§’ | 10 | IP |
| chat | 60ç§’ | 10 | user_id |

#### 12.1.6 å¹¶å‘æ§åˆ¶é…ç½®ï¼ˆConcurrencyControlMiddleware.jsï¼‰

| æ§åˆ¶ç»´åº¦ | é»˜è®¤å¹¶å‘é™åˆ¶ |
|----------|-------------|
| å•ç”¨æˆ·å¹¶å‘ | 5 ä¸ªåŒæ—¶è¯·æ±‚ |
| å•IPå¹¶å‘ | 10 ä¸ªåŒæ—¶è¯·æ±‚ |

### 12.2 æµ‹è¯•ç›®çš„æ˜ç¡®åŒºåˆ†

**æ ¸å¿ƒåŸåˆ™**ï¼šæµ‹è¯•ç›®çš„å†³å®šæµ‹è¯•æ–¹æ³•ï¼Œä¸åŒç›®çš„çš„æµ‹è¯•æœ‰ä¸åŒçš„è¾¹ç•Œè®¾ç½®

#### 12.2.1 é…ç½®éªŒè¯æµ‹è¯•ï¼ˆéªŒè¯ä¸Šé™ç”Ÿæ•ˆï¼‰

**ç›®çš„**ï¼šç¡®è®¤ç³»ç»Ÿé…ç½®çš„é™åˆ¶æœºåˆ¶æ­£ç¡®ç”Ÿæ•ˆ

**æ–¹æ³•**ï¼šåˆšå¥½åˆ°è¾¾é…ç½®ä¸Šé™ï¼ŒéªŒè¯ç³»ç»Ÿè¡Œä¸ºç¬¦åˆé¢„æœŸ

```javascript
// âœ… æ­£ç¡®ï¼šé…ç½®éªŒè¯æµ‹è¯•
describe('é…ç½®éªŒè¯ï¼šæ•°æ®åº“è¿æ¥æ± ', () => {
  it('40ä¸ªå¹¶å‘è¿æ¥åº”æ­£å¸¸å¤„ç†', async () => {
    // åˆšå¥½ 40 ä¸ªå¹¶å‘ï¼ˆç­‰äº pool.maxï¼‰
    const promises = Array(40).fill().map(() => 
      sequelize.query('SELECT SLEEP(0.1)')
    )
    const results = await Promise.all(promises)
    
    // æ‰€æœ‰è¯·æ±‚åº”æˆåŠŸ
    expect(results.every(r => r)).toBe(true)
  })
})

describe('é…ç½®éªŒè¯ï¼šç”¨æˆ·æ¶ˆæ¯é¢‘ç‡', () => {
  it('20æ¡/åˆ†é’Ÿå†…çš„æ¶ˆæ¯åº”æ­£å¸¸å‘é€', async () => {
    // åˆšå¥½ 20 æ¡ï¼ˆç­‰äº rate_limit.user.max_messages_per_minuteï¼‰
    for (let i = 0; i < 20; i++) {
      const response = await sendMessage(user_id, `æ¶ˆæ¯${i}`)
      expect(response.success).toBe(true)
    }
  })
  
  it('ç¬¬21æ¡æ¶ˆæ¯åº”è¢«é™æµ', async () => {
    // å‘é€ 20 æ¡å
    const response = await sendMessage(user_id, 'ç¬¬21æ¡')
    expect(response.status).toBe(429)
    expect(response.body.code).toBe('RATE_LIMITED')
  })
})
```

#### 12.2.2 æé™å‹åŠ›æµ‹è¯•ï¼ˆæ‰¾ç³»ç»Ÿå´©æºƒç‚¹ï¼‰

**ç›®çš„**ï¼šæ‰¾åˆ°ç³»ç»Ÿçš„çœŸå®æ‰¿è½½æé™ï¼Œç¡®å®šå®‰å…¨è¾¹ç•Œ

**æ–¹æ³•**ï¼šé€æ­¥å¢åŠ è´Ÿè½½ï¼Œè¶…è¿‡é…ç½®ä¸Šé™ï¼Œè§‚å¯Ÿç³»ç»Ÿè¡Œä¸º

```javascript
// âœ… æ­£ç¡®ï¼šæé™å‹æµ‹
describe('æé™å‹æµ‹ï¼šæ•°æ®åº“è¿æ¥', () => {
  it('è¶…è¿‡è¿æ¥æ± ä¸Šé™æ—¶åº”æ’é˜Ÿç­‰å¾…', async () => {
    // è¶…è¿‡ pool.max (40)ï¼Œæµ‹è¯• 60 ä¸ªå¹¶å‘
    const promises = Array(60).fill().map(() => 
      sequelize.query('SELECT SLEEP(0.5)')
    )
    
    const startTime = Date.now()
    const results = await Promise.allSettled(promises)
    const duration = Date.now() - startTime
    
    // å‰40ä¸ªåº”ç«‹å³æ‰§è¡Œï¼Œå20ä¸ªåº”æ’é˜Ÿ
    // æ€»æ—¶é—´åº”çº¦ 1ç§’ï¼ˆä¸¤æ‰¹å„0.5ç§’ï¼‰
    expect(duration).toBeGreaterThan(500)
    expect(duration).toBeLessThan(2000)
    
    // éªŒè¯æœ€ç»ˆå…¨éƒ¨æˆåŠŸï¼ˆæœ‰äº›éœ€ç­‰å¾…acquireè¶…æ—¶10ç§’å†…ï¼‰
    const successCount = results.filter(r => r.status === 'fulfilled').length
    expect(successCount).toBe(60)
  })
  
  it('æ‰¾åˆ°è¿æ¥æ± å´©æºƒç‚¹', async () => {
    // æé™æµ‹è¯•ï¼šå°è¯• 200 ä¸ªå¹¶å‘ï¼ˆ5å€äºpool.maxï¼‰
    // ç›®çš„ï¼šæ‰¾åˆ°ç³»ç»Ÿå¼€å§‹æ‹’ç»è¿æ¥çš„ç‚¹
    const concurrencyLevels = [50, 80, 100, 150, 200]
    const results = {}
    
    for (const level of concurrencyLevels) {
      const start = Date.now()
      const promises = Array(level).fill().map(() => 
        sequelize.query('SELECT 1').catch(e => e)
      )
      const outcomes = await Promise.allSettled(promises)
      const duration = Date.now() - start
      
      results[level] = {
        success: outcomes.filter(o => o.status === 'fulfilled' && !(o.value instanceof Error)).length,
        failed: outcomes.filter(o => o.status === 'rejected' || o.value instanceof Error).length,
        duration
      }
    }
    
    console.log('è¿æ¥æ± å‹æµ‹ç»“æœ:', results)
    // è®°å½•å´©æºƒç‚¹ï¼Œç”¨äºè¿ç»´å®¹é‡è§„åˆ’
  })
})
```

#### 12.2.3 åŒºåˆ†çš„å…³é”®ç‚¹

| æµ‹è¯•ç±»å‹ | ç›®çš„ | è¾¹ç•Œè®¾ç½® | é¢„æœŸç»“æœ |
|----------|------|---------|----------|
| é…ç½®éªŒè¯ | ç¡®è®¤é…ç½®ç”Ÿæ•ˆ | = é…ç½®ä¸Šé™ | è¾¹ç•ŒæˆåŠŸï¼Œè¶…å‡ºå¤±è´¥ |
| æé™å‹æµ‹ | æ‰¾å´©æºƒç‚¹ | >> é…ç½®ä¸Šé™ | è®°å½•å´©æºƒé˜ˆå€¼ |
| æ€§èƒ½åŸºå‡† | å»ºç«‹baseline | æ­£å¸¸è´Ÿè½½ | è®°å½•å“åº”æ—¶é—´ |
| æ¢å¤æµ‹è¯• | éªŒè¯æ¢å¤èƒ½åŠ› | è§¦å‘é™åˆ¶å | è‡ªåŠ¨æ¢å¤ |

### 12.3 ç¬¦åˆä¸šåŠ¡é€»è¾‘çš„æµ‹è¯•åœºæ™¯è®¾è®¡

#### 12.3.1 å¸‚åœºäº¤æ˜“æ ¸å¿ƒä¸šåŠ¡åœºæ™¯çŸ©é˜µ

```
åŠŸèƒ½: å¸‚åœºäº¤æ˜“
è§’è‰²: å–å®¶(S) / ä¹°å®¶(B) / ç®¡ç†å‘˜(A)
èµ„äº§: DIAMOND / RED_SHARD / ITEM

å®Œæ•´ä¸šåŠ¡åœºæ™¯çŸ©é˜µ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ              â”‚ æ“ä½œè€…          â”‚ æ“ä½œ            â”‚ éªŒè¯ç‚¹       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. æŒ‚ç‰Œåˆ›å»º      â”‚ S               â”‚ åˆ›å»ºæŒ‚ç‰Œ        â”‚ èµ„äº§å†»ç»“     â”‚
â”‚ 2. æŒ‚ç‰Œä¿®æ”¹      â”‚ S               â”‚ ä¿®æ”¹ä»·æ ¼/æ•°é‡   â”‚ å†»ç»“è°ƒæ•´     â”‚
â”‚ 3. ä¹°å®¶æµè§ˆ      â”‚ B               â”‚ æŸ¥çœ‹æŒ‚ç‰Œåˆ—è¡¨    â”‚ å¯è§æ€§       â”‚
â”‚ 4. ä¹°å®¶ä¸‹å•      â”‚ B               â”‚ åˆ›å»ºè®¢å•        â”‚ ä¹°å®¶èµ„äº§å†»ç»“ â”‚
â”‚ 5a. å®Œæˆäº¤æ˜“     â”‚ ç³»ç»Ÿ            â”‚ è‡ªåŠ¨æˆäº¤        â”‚ åŒæ–¹èµ„äº§è½¬ç§» â”‚
â”‚ 5b. ä¹°å®¶å–æ¶ˆ     â”‚ B               â”‚ å–æ¶ˆè®¢å•        â”‚ ä¹°å®¶è§£å†»     â”‚
â”‚ 5c. è®¢å•è¶…æ—¶     â”‚ ç³»ç»Ÿ            â”‚ è‡ªåŠ¨å–æ¶ˆ        â”‚ ä¹°å®¶è§£å†»     â”‚
â”‚ 5d. å–å®¶æ’¤å›     â”‚ S               â”‚ æ’¤å›æŒ‚ç‰Œ        â”‚ å…¨éƒ¨è§£å†»     â”‚
â”‚ 6. ç®¡ç†å‘˜å¹²é¢„    â”‚ A               â”‚ ä¸‹æ¶/å–æ¶ˆ       â”‚ å¼ºåˆ¶è§£å†»     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æµ‹è¯•è¦†ç›–è¦æ±‚**ï¼šæ¯ä¸ªé˜¶æ®µç»„åˆéƒ½éœ€è¦æœ‰å¯¹åº”æµ‹è¯•

#### 12.3.2 é«˜å¹¶å‘ä¸šåŠ¡åœºæ™¯ï¼ˆ1000-10000ç”¨æˆ·ï¼‰

æ ¹æ® package.json å£°æ˜çš„ `concurrentUsers: 1000+` ç›®æ ‡ï¼š

```javascript
// åŸºäºç³»ç»Ÿè®¾è®¡å®¹é‡çš„å¹¶å‘æµ‹è¯•
describe('1000+ç”¨æˆ·å¹¶å‘åœºæ™¯', () => {
  
  describe('åœºæ™¯Aï¼š1000ç”¨æˆ·åŒæ—¶æŠ½å¥–', () => {
    // æ¯ç”¨æˆ· 1 æ¬¡æŠ½å¥– = 1000 æ¬¡æŠ½å¥–è¯·æ±‚
    // éœ€éªŒè¯ï¼šç§¯åˆ†æ‰£é™¤åŸå­æ€§ã€å¥–å“åº“å­˜ä¸€è‡´æ€§
  })
  
  describe('åœºæ™¯Bï¼š500ä¹°å®¶æŠ¢è´­åŒä¸€æŒ‚ç‰Œ', () => {
    // 1ä¸ªæŒ‚ç‰Œï¼Œ500ä¸ªå¹¶å‘ä¸‹å•
    // éœ€éªŒè¯ï¼šä¸è¶…å–ã€è®¢å•çŠ¶æ€ä¸€è‡´
  })
  
  describe('åœºæ™¯Cï¼šæ··åˆä¸šåŠ¡è´Ÿè½½', () => {
    // æ¨¡æ‹ŸçœŸå®åœºæ™¯ï¼š
    // - 30% ç”¨æˆ·åœ¨æµè§ˆï¼ˆåªè¯»ï¼‰
    // - 20% ç”¨æˆ·åœ¨æŠ½å¥–
    // - 20% ç”¨æˆ·åœ¨å¸‚åœºä¸‹å•
    // - 20% ç”¨æˆ·åœ¨èŠå¤©
    // - 10% ç”¨æˆ·åœ¨ç®¡ç†åå°
  })
  
  describe('åœºæ™¯Dï¼š5000ç”¨æˆ·å‹åŠ›æµ‹è¯•', () => {
    // è¶…è¿‡è®¾è®¡å®¹é‡ 5 å€
    // ç›®çš„ï¼šæ‰¾åˆ°é™çº§è§¦å‘ç‚¹å’Œç³»ç»Ÿè¡Œä¸º
  })
  
  describe('åœºæ™¯Eï¼š10000ç”¨æˆ·æé™æµ‹è¯•', () => {
    // 10 å€è®¾è®¡å®¹é‡
    // ç›®çš„ï¼šè®°å½•å´©æºƒç‚¹ï¼ŒéªŒè¯é™æµæœ‰æ•ˆæ€§
  })
})
```

#### 12.3.3 å¤æ‚ä¸šåŠ¡åœºæ™¯ç»„åˆ

```javascript
describe('å¤æ‚ä¸šåŠ¡åœºæ™¯', () => {
  
  describe('åœºæ™¯1ï¼šè·¨æ¨¡å—èµ„äº§æµè½¬', () => {
    // ç”¨æˆ·A å……å€¼ â†’ å…‘æ¢é’»çŸ³ â†’ å¸‚åœºæŒ‚ç‰Œ â†’ ç”¨æˆ·B è´­ä¹° â†’ ç”¨æˆ·B ç”¨é’»çŸ³æŠ½å¥–
    it('å…¨é“¾è·¯èµ„äº§è¿½è¸ª', async () => {
      // 1. ç”¨æˆ·A è·å¾— 1000 ç§¯åˆ†
      // 2. ç”¨æˆ·A å…‘æ¢ 100 é’»çŸ³
      // 3. ç”¨æˆ·A æŒ‚ç‰Œ 50 é’»çŸ³
      // 4. ç”¨æˆ·B è´­ä¹° 50 é’»çŸ³
      // 5. ç”¨æˆ·B ä½¿ç”¨é’»çŸ³æŠ½å¥–
      // éªŒè¯ï¼šæ¯ä¸€æ­¥çš„èµ„äº§å˜åŠ¨éƒ½æ­£ç¡®
    })
  })
  
  describe('åœºæ™¯2ï¼šå¹¶å‘å†²çªè§£å†³', () => {
    it('ä¸¤ä¸ªä¹°å®¶åŒæ—¶æŠ¢è´­åº“å­˜=1çš„æŒ‚ç‰Œ', async () => {
      // åˆ›å»ºåº“å­˜ä¸º 1 çš„æŒ‚ç‰Œ
      // ä¸¤ä¸ªä¹°å®¶åŒæ—¶ä¸‹å•
      // éªŒè¯ï¼šåªæœ‰ä¸€ä¸ªæˆåŠŸï¼Œå¦ä¸€ä¸ªå¤±è´¥ä½†èµ„äº§ä¸å—å½±å“
    })
    
    it('ä¹°å®¶ä¸‹å•åŒæ—¶å–å®¶æ’¤å›', async () => {
      // ç«æ€æ¡ä»¶æµ‹è¯•
      // éªŒè¯ï¼šæ— è®ºå“ªä¸ªå…ˆæ‰§è¡Œï¼Œéƒ½ä¸ä¼šäº§ç”Ÿå­¤å„¿å†»ç»“
    })
  })
  
  describe('åœºæ™¯3ï¼šçŠ¶æ€æœºè¾¹ç•Œ', () => {
    it('è®¢å•åœ¨æ¯ä¸ªçŠ¶æ€è¢«ä¸­æ–­çš„å¤„ç†', async () => {
      // created çŠ¶æ€è¢«å–æ¶ˆ
      // frozen çŠ¶æ€è¢«å–æ¶ˆ
      // frozen çŠ¶æ€è¶…æ—¶
      // frozen çŠ¶æ€å®Œæˆäº¤æ˜“
    })
  })
})
```

### 12.4 æµ‹è¯•æ’é™¤é¡¹å£°æ˜ â­ 2026-01-30 ç”¨æˆ·æ‹æ¿

ä»¥ä¸‹æµ‹è¯•ç±»å‹æ˜ç¡®ä¸åœ¨æœ¬æµ‹è¯•ä½“ç³»èŒƒå›´å†…ï¼ˆ**ç”¨æˆ·æ˜ç¡®æ‹æ¿ä¸åš**ï¼‰ï¼š

#### 12.4.1 æ•°æ®åº“è¿ç§»å›å½’æµ‹è¯• âŒ ä¸éœ€è¦ â­ ç”¨æˆ·æ‹æ¿

**åŸå› **ï¼š
- è¿ç§»è„šæœ¬æ˜¯ä¸€æ¬¡æ€§æ‰§è¡Œçš„éƒ¨ç½²æ“ä½œ
- ç”Ÿäº§ç¯å¢ƒè¿ç§»å‰ä¼šåœ¨ staging éªŒè¯
- è¿ç§»å›æ»šé€šè¿‡æ‰‹åŠ¨SQLå¤„ç†

**æ›¿ä»£æ–¹æ¡ˆ**ï¼šè¿ç§»è„šæœ¬ code review + staging ç¯å¢ƒéªŒè¯

#### 12.4.2 Webç«¯ç®¡ç†å¹³å°æµ‹è¯• âŒ ä¸éœ€è¦ â­ ç”¨æˆ·æ‹æ¿

**åŸå› **ï¼š
- ç®¡ç†å¹³å°æ˜¯ç‹¬ç«‹å‰ç«¯é¡¹ç›®
- API å±‚é¢å·²æœ‰å¥‘çº¦æµ‹è¯•è¦†ç›–
- å‰ç«¯æµ‹è¯•åº”åœ¨å‰ç«¯é¡¹ç›®ä¸­å®æ–½

**æ›¿ä»£æ–¹æ¡ˆ**ï¼šAPI å¥‘çº¦æµ‹è¯• + å‰ç«¯é¡¹ç›®çš„ E2E æµ‹è¯•

#### 12.4.3 ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆæµ‹è¯• âŒ ä¸éœ€è¦ â­ ç”¨æˆ·æ‹æ¿

**åŸå› **ï¼š
- ç¬¬ä¸‰æ–¹æœåŠ¡ï¼ˆæ”¯ä»˜ã€çŸ­ä¿¡ç­‰ï¼‰æœ‰è‡ªå·±çš„ SLA
- Mock ç¬¬ä¸‰æ–¹æœåŠ¡è¿›è¡Œæœ¬åœ°æµ‹è¯•å³å¯
- çœŸå®ç¬¬ä¸‰æ–¹è°ƒç”¨åœ¨ staging ç¯å¢ƒéªŒè¯

**æ›¿ä»£æ–¹æ¡ˆ**ï¼šMock é›†æˆ + staging ç¯å¢ƒæ‰‹åŠ¨éªŒè¯

### 12.5 æµ‹è¯•å¹¿åº¦ä¸æ·±åº¦å®šä¹‰

#### 12.5.1 å¹¿åº¦è¦æ±‚ï¼ˆè¦†ç›–èŒƒå›´ï¼‰

| ç»´åº¦ | è¦†ç›–è¦æ±‚ | å½“å‰çŠ¶æ€ | å·®è· |
|------|---------|---------|-----|
| æ ¸å¿ƒä¸šåŠ¡æ¨¡å— | 100% | ~70% | å¸‚åœº/èµ„äº§æ¨¡å—ä¸è¶³ |
| API ç«¯ç‚¹ | 100% å¥‘çº¦æµ‹è¯• | ~60% | ç¼º market/asset |
| çŠ¶æ€æœºè½¬æ¢ | 100% è·¯å¾„è¦†ç›– | ~20% | ä¸¥é‡ä¸è¶³ |
| è§’è‰²ç»„åˆ | æ‰€æœ‰ 2-3 è§’è‰²ç»„åˆ | ~10% | ä¸¥é‡ä¸è¶³ |
| å¼‚å¸¸åœºæ™¯ | æ¯ä¸ªæ­£å¸¸æµç¨‹é…å¥— | ~30% | ä¸è¶³ |

#### 12.5.2 æ·±åº¦è¦æ±‚ï¼ˆæµ‹è¯•å±‚æ¬¡ï¼‰

```
æµ‹è¯•é‡‘å­—å¡”ï¼ˆæœ¬é¡¹ç›®é€‚ç”¨ï¼‰:

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ E2E æµ‹è¯•  â”‚ 3-5ä¸ªæ ¸å¿ƒæµç¨‹
                   â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²
                  â”‚ åœºæ™¯/é›†æˆæµ‹è¯• â”‚ 50-80ä¸ªä¸šåŠ¡åœºæ™¯
                 â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²
                â”‚   æœåŠ¡å•å…ƒæµ‹è¯•   â”‚ æ¯ä¸ªæœåŠ¡çš„å…³é”®æ–¹æ³•
               â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²
              â”‚    çº¯å•å…ƒæµ‹è¯•       â”‚ å·¥å…·å‡½æ•°ã€éªŒè¯å™¨
             â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²
            â”‚     å‹åŠ›/æ€§èƒ½æµ‹è¯•       â”‚ å¹¶å‘ã€å®¹é‡éªŒè¯
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

#### 12.5.3 å¤æ‚åœºæ™¯æ·±åº¦è¦æ±‚

æ¯ä¸ªæ ¸å¿ƒä¸šåŠ¡åœºæ™¯åº”åŒ…å«ï¼š

1. **æ­£å‘æµç¨‹**ï¼ˆå¿…é¡»ï¼‰ï¼šHappy path å®Œæ•´éªŒè¯
2. **æƒé™è¾¹ç•Œ**ï¼ˆå¿…é¡»ï¼‰ï¼šéæˆæƒç”¨æˆ·çš„æ‹’ç»
3. **è¾“å…¥è¾¹ç•Œ**ï¼ˆå¿…é¡»ï¼‰ï¼šJoi schema è¾¹ç•Œå€¼
4. **çŠ¶æ€è¾¹ç•Œ**ï¼ˆå¿…é¡»ï¼‰ï¼šæ¯ä¸ªçŠ¶æ€è½¬æ¢ç‚¹
5. **å¹¶å‘è¾¹ç•Œ**ï¼ˆæ ¸å¿ƒåœºæ™¯å¿…é¡»ï¼‰ï¼šç«æ€æ¡ä»¶å¤„ç†
6. **é…ç½®è¾¹ç•Œ**ï¼ˆæ¶‰åŠé™åˆ¶çš„åœºæ™¯å¿…é¡»ï¼‰ï¼šä¸Šé™éªŒè¯
7. **æ¢å¤æµ‹è¯•**ï¼ˆå…³é”®åœºæ™¯å¿…é¡»ï¼‰ï¼šå¤±è´¥åçš„çŠ¶æ€å›æ»š

### 12.6 åŸºäºè®¾è®¡å®¹é‡çš„æµ‹è¯•ç”¨ä¾‹è¡¥å……

æ ¹æ®ä»¥ä¸Šåˆ†æï¼Œéœ€è¦è¡¥å……çš„å…·ä½“æµ‹è¯•ç”¨ä¾‹ï¼š

```
tests/stress/
â”œâ”€â”€ db-connection-pool.stress.test.js    âŒ éœ€æ–°å»º
â”‚   â”œâ”€â”€ éªŒè¯ 40 è¿æ¥é…ç½®æ­£ç¡®ç”Ÿæ•ˆ
â”‚   â”œâ”€â”€ è¶…è¿‡ 40 è¿æ¥çš„æ’é˜Ÿè¡Œä¸º
â”‚   â””â”€â”€ è¿æ¥æ± æ¢å¤æµ‹è¯•
â”‚
â”œâ”€â”€ rate-limit-validation.stress.test.js âŒ éœ€æ–°å»º
â”‚   â”œâ”€â”€ global: 100req/60s è¾¹ç•ŒéªŒè¯
â”‚   â”œâ”€â”€ lottery: 20req/60s è¾¹ç•ŒéªŒè¯
â”‚   â”œâ”€â”€ login: 10req/60s è¾¹ç•ŒéªŒè¯
â”‚   â””â”€â”€ chat: 10req/60s è¾¹ç•ŒéªŒè¯
â”‚
â”œâ”€â”€ concurrency-control.stress.test.js   âŒ éœ€æ–°å»º
â”‚   â”œâ”€â”€ å•ç”¨æˆ· 5 å¹¶å‘é™åˆ¶éªŒè¯
â”‚   â””â”€â”€ å• IP 10 å¹¶å‘é™åˆ¶éªŒè¯
â”‚
â”œâ”€â”€ business-limit-validation.stress.test.js âŒ éœ€æ–°å»º
â”‚   â”œâ”€â”€ æŠ½å¥–: max_draw_count=20 éªŒè¯
â”‚   â”œâ”€â”€ ç§¯åˆ†: max_balance=99999999.99 éªŒè¯
â”‚   â”œâ”€â”€ æ¶ˆæ¯: max_length=5000 éªŒè¯
â”‚   â””â”€â”€ ä¸Šä¼ : max_size_bytes=10MB éªŒè¯
â”‚
â””â”€â”€ capacity-extreme.stress.test.js      âŒ éœ€æ–°å»º
    â”œâ”€â”€ 1000 ç”¨æˆ·å¹¶å‘åŸºå‡†æµ‹è¯•
    â”œâ”€â”€ 5000 ç”¨æˆ·å‹åŠ›æµ‹è¯•
    â””â”€â”€ 10000 ç”¨æˆ·æé™æµ‹è¯•ï¼ˆæ‰¾å´©æºƒç‚¹ï¼‰
```

---

## 13. å®Œå–„åçš„ä¼˜å…ˆçº§æ€»è§ˆ

### 13.1 P0çº§ï¼ˆç«‹å³è¡ŒåŠ¨ï¼Œå½±å“æ ¸å¿ƒä¸šåŠ¡ï¼‰

| åºå· | æ”¹è¿›é¡¹ | å·¥ä½œé‡ | éªŒè¯æ ‡å‡† |
|------|--------|--------|---------|
| 1 | è¡¥å……å¸‚åœº/èµ„äº§ API å¥‘çº¦æµ‹è¯• | 2å¤© | è¦†ç›–æ‰€æœ‰æŒ‚ç‰Œå’Œäº¤æ˜“æ¥å£ |
| 2 | è·¨è§’è‰²äº¤äº’æµ‹è¯•ï¼ˆå–å®¶æ’¤å›+ä¹°å®¶ï¼‰ | 2å¤© | è¦†ç›–æœ¬æ¬¡å­¤å„¿å†»ç»“åœºæ™¯ |
| 3 | çŠ¶æ€æœºå®Œæ•´è·¯å¾„æµ‹è¯• | 3å¤© | è®¢å•/æŒ‚ç‰Œæ‰€æœ‰çŠ¶æ€è½¬æ¢ |
| 4 | Sequelize äº‹åŠ¡éš”ç¦»æµ‹è¯•æ¨¡å¼ | 1å¤© | æ ¸å¿ƒæµ‹è¯•ä½¿ç”¨äº‹åŠ¡éš”ç¦» |
| 5 | å›å½’æµ‹è¯•å¥—ä»¶å»ºç«‹ | 1å¤© | P0 çº§åœºæ™¯å¯ä¸€é”®å›å½’ |

### 13.2 P1çº§ï¼ˆçŸ­æœŸé‡ç‚¹ï¼Œæå‡è´¨é‡ï¼‰

| åºå· | æ”¹è¿›é¡¹ | å·¥ä½œé‡ | éªŒè¯æ ‡å‡† |
|------|--------|--------|---------|
| 1 | é…ç½®è¾¹ç•ŒéªŒè¯æµ‹è¯• | 2å¤© | è¦†ç›– 12.1 èŠ‚æ‰€æœ‰é…ç½® |
| 2 | 1000ç”¨æˆ·å¹¶å‘åŸºå‡†æµ‹è¯• | 2å¤© | æ»¡è¶³ package.json å£°æ˜ |
| 3 | Joi Schema è¾¹ç•Œæµ‹è¯• | 1.5å¤© | æ ¸å¿ƒ API å‚æ•°éªŒè¯ |
| 4 | Socket.io é›†æˆæµ‹è¯• | 2å¤© | WebSocket ç”Ÿå‘½å‘¨æœŸè¦†ç›– |
| 5 | IdempotencyService å®Œæ•´æµ‹è¯• | 1å¤© | å¹‚ç­‰æ€§æœºåˆ¶éªŒè¯ |

### 13.3 P2çº§ï¼ˆä¸­æœŸå®Œå–„ï¼‰

| åºå· | æ”¹è¿›é¡¹ | å·¥ä½œé‡ | éªŒè¯æ ‡å‡† |
|------|--------|--------|---------|
| 1 | 5000/10000ç”¨æˆ·æé™å‹æµ‹ | 2å¤© | æ‰¾åˆ°ç³»ç»Ÿå´©æºƒç‚¹ |
| 2 | æ··åˆä¸šåŠ¡è´Ÿè½½æµ‹è¯• | 2å¤© | æ¨¡æ‹ŸçœŸå®ç”¨æˆ·è¡Œä¸ºåˆ†å¸ƒ |
| 3 | å¯è§‚æµ‹æ€§æµ‹è¯•æ‰©å±• | 1.5å¤© | æ—¥å¿—/é“¾è·¯è¿½è¸ªéªŒè¯ |
| 4 | æ•´åˆå‹åŠ›æµ‹è¯•ç›®å½• | 1å¤© | ç»Ÿä¸€ stress/ ç›®å½• |

### 13.4 æ˜ç¡®ä¸åš

| ç±»å‹ | åŸå›  | æ›¿ä»£æ–¹æ¡ˆ |
|------|------|---------|
| æ•°æ®åº“è¿ç§»å›å½’æµ‹è¯• | ä¸€æ¬¡æ€§éƒ¨ç½²æ“ä½œ | Code Review + Staging |
| Webç®¡ç†å¹³å°æµ‹è¯• | ç‹¬ç«‹å‰ç«¯é¡¹ç›® | å‰ç«¯é¡¹ç›® E2E |
| ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆæµ‹è¯• | æœ‰ç‹¬ç«‹ SLA | Mock + Staging éªŒè¯ |

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv4.1  
**åˆ›å»ºæ—¶é—´**ï¼š2026-01-30  
**æ›´æ–°æ—¶é—´**ï¼š2026-01-30  
**å…³è”é—®é¢˜**ï¼šç”¨æˆ·é’»çŸ³å­¤å„¿å†»ç»“é—®é¢˜ï¼ˆç”¨æˆ·ID: 31ï¼‰  
**å…³è”ä¿®å¤**ï¼šæ–¹æ¡ˆA/B/Cï¼ˆè§ `ç”¨æˆ·é’»çŸ³å†»ç»“å¼‚å¸¸é—®é¢˜åˆ†ææŠ¥å‘Š.md`ï¼‰  
**æœ¬æ¬¡æ›´æ–°**ï¼šè¡¥å……"å·²æ‹æ¿å†³ç­–æ±‡æ€»"é™„å½•Eï¼Œæ ‡æ³¨é…ç½®/æ’é™¤é¡¹çš„æ‹æ¿çŠ¶æ€

### é™„å½•Aï¼šé¡¹ç›®æ ¸å¿ƒæŠ€æœ¯æ ˆé€ŸæŸ¥

| ç»„ä»¶ | åŒ…å | ç‰ˆæœ¬ | æµ‹è¯•å»ºè®® |
|------|------|------|----------|
| ORM | sequelize | 6.35.x | äº‹åŠ¡éš”ç¦»æµ‹è¯• |
| Redis | ioredis | 5.7.x | å®Œå–„ Mock + åˆ†å¸ƒå¼é”æµ‹è¯• |
| WebSocket | socket.io | 4.8.x | ä½¿ç”¨ socket.io-client é›†æˆæµ‹è¯• |
| éªŒè¯ | joi | 17.11.x | Schema è¾¹ç•Œæµ‹è¯• |
| æ—¥å¿— | winston | 3.11.x | é…ç½®+è„±æ•æµ‹è¯• |
| å®šæ—¶ä»»åŠ¡ | node-cron | 3.0.x | Handler å‡½æ•°æµ‹è¯• |
| æµ‹è¯•æ¡†æ¶ | jest | 29.7.x | å……åˆ†åˆ©ç”¨ Mock å’Œå¹¶è¡Œèƒ½åŠ› |
| HTTPæµ‹è¯• | supertest | 6.3.x | API å¥‘çº¦æµ‹è¯• |

### é™„å½•Bï¼šç³»ç»Ÿé…ç½®é™åˆ¶é€ŸæŸ¥

#### B.1 æ•°æ®åº“è¿æ¥æ± 

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| pool.max | 40 | æœ€å¤§è¿æ¥æ•° |
| pool.min | 5 | æœ€å°è¿æ¥æ•° |
| pool.acquire | 10000ms | è·å–è¶…æ—¶ |
| pool.idle | 60000ms | ç©ºé—²å›æ”¶ |

#### B.2 é™æµé…ç½®

| åœºæ™¯ | çª—å£ | ä¸Šé™ | Key |
|------|------|------|-----|
| global | 60s | 100 | IP |
| lottery | 60s | 20 | user_id |
| login | 60s | 10 | IP |
| chat | 60s | 10 | user_id |

#### B.3 å¹¶å‘æ§åˆ¶

| ç»´åº¦ | ä¸Šé™ |
|------|------|
| å•ç”¨æˆ·å¹¶å‘ | 5 |
| å•IPå¹¶å‘ | 10 |

#### B.4 ä¸šåŠ¡é™åˆ¶ï¼ˆä»£ç çº§ï¼‰

| é…ç½® | å€¼ | æ–‡ä»¶ä½ç½® |
|------|-----|---------|
| max_draw_count | 20 | business.config.js |
| max_balance | 99999999.99 | business.config.js |
| message.max_length | 5000 | business.config.js |
| upload.max_size_bytes | 10MB | business.config.js |
| user.nickname.max_length | 50 | business.config.js |

#### B.5 ä¸šåŠ¡é™åˆ¶ï¼ˆè¿ç»´å¯é…ç½®ï¼‰

| é…ç½®é”® | èŒƒå›´ | ä½ç½® |
|--------|------|------|
| points/daily_lottery_limit | 10-200 | system_settings è¡¨ |
| marketplace/max_active_listings | 1-50 | system_settings è¡¨ |
| security/max_login_attempts | 3-10 | system_settings è¡¨ |
| security/api_rate_limit | 10-1000 | system_settings è¡¨ |

### é™„å½•Cï¼šæµ‹è¯•ç±»å‹ä¸ç›®çš„å¯¹ç…§è¡¨

| æµ‹è¯•ç±»å‹ | ç›®çš„ | è¾¹ç•Œè®¾ç½® | é¢„æœŸç»“æœ |
|----------|------|---------|----------|
| é…ç½®éªŒè¯ | ç¡®è®¤é…ç½®ç”Ÿæ•ˆ | = é…ç½®ä¸Šé™ | è¾¹ç•ŒæˆåŠŸï¼Œè¶…å‡ºè¢«æ‹’ |
| æé™å‹æµ‹ | æ‰¾ç³»ç»Ÿå´©æºƒç‚¹ | >> é…ç½®ä¸Šé™ | è®°å½•å´©æºƒé˜ˆå€¼ |
| æ€§èƒ½åŸºå‡† | å»ºç«‹ baseline | æ­£å¸¸è´Ÿè½½ | P50/P90/P99 |
| æ¢å¤æµ‹è¯• | éªŒè¯æ¢å¤èƒ½åŠ› | è§¦å‘é™åˆ¶å | èƒ½è‡ªåŠ¨æ¢å¤ |
| å¹¶å‘æ­£ç¡®æ€§ | éªŒè¯æ•°æ®ä¸€è‡´ | é«˜å¹¶å‘å†™å…¥ | æ— è„è¯»/ä¸¢å¤±æ›´æ–° |
| å®¹é‡è§„åˆ’ | è§„åˆ’æ‰©å®¹ç‚¹ | é€çº§é€’å¢ | æ‰¾æ‹ç‚¹ |

### é™„å½•Dï¼šéœ€è¦æ–°å»ºçš„æµ‹è¯•æ–‡ä»¶æ¸…å•

```
æ–°å»ºæ–‡ä»¶ä¼˜å…ˆçº§æ’åºï¼š

P0ï¼ˆç«‹å³ï¼‰:
â”œâ”€â”€ tests/api-contracts/market.contract.test.js
â”œâ”€â”€ tests/api-contracts/asset.contract.test.js
â”œâ”€â”€ tests/services/MarketListingService.withdraw-buyer-order.test.js âœ… å·²åˆ›å»º
â”œâ”€â”€ tests/scenario/market/listing-lifecycle.test.js
â”œâ”€â”€ tests/scenario/market/order-lifecycle.test.js
â””â”€â”€ tests/regression/p0-critical-paths.test.js

P1ï¼ˆçŸ­æœŸï¼‰:
â”œâ”€â”€ tests/stress/db-connection-pool.stress.test.js
â”œâ”€â”€ tests/stress/rate-limit-validation.stress.test.js
â”œâ”€â”€ tests/stress/business-limit-validation.stress.test.js
â”œâ”€â”€ tests/unit/validators/market-validator.test.js
â”œâ”€â”€ tests/unit/validators/asset-validator.test.js
â”œâ”€â”€ tests/integration/websocket/chat-websocket.integration.test.js
â”œâ”€â”€ tests/services/IdempotencyService.integration.test.js
â””â”€â”€ tests/helpers/sequelize-test-helper.js

P2ï¼ˆä¸­æœŸï¼‰:
â”œâ”€â”€ tests/stress/capacity-extreme.stress.test.js
â”œâ”€â”€ tests/stress/mixed-workload.stress.test.js
â”œâ”€â”€ tests/observability/winston-logger.test.js
â”œâ”€â”€ tests/observability/request-id-propagation.test.js
â””â”€â”€ tests/helpers/distributed-lock-mock.js
```

### é™„å½•Eï¼šæµ‹è¯•ä½“ç³»ç›¸å…³çš„å·²æ‹æ¿å†³ç­–æ±‡æ€»

æœ¬é™„å½•æ±‡æ€»é¡¹ç›®ä¸­ä¸æµ‹è¯•ä½“ç³»ç›¸å…³çš„æ‰€æœ‰å·²æ‹æ¿å†³ç­–ï¼Œä½œä¸ºæµ‹è¯•è®¾è®¡çš„æƒå¨ä¾æ®ã€‚

#### E.1 ç³»ç»Ÿé…ç½®ç±»æ‹æ¿

| é…ç½®é¡¹ | æ‹æ¿å€¼ | æ‹æ¿æ—¥æœŸ | æ¥æºæ–‡ä»¶ | æµ‹è¯•å½±å“ |
|--------|-------|---------|---------|---------|
| æ•°æ®åº“è¿æ¥æ±  max | 40 | 2025-12-30 | config/database.js | å¹¶å‘æµ‹è¯•è¾¹ç•Œ |
| æŠ½å¥– max_draw_count | 20 | 2026-01-18 | TierPickStage.js | æŠ½å¥–APIéªŒè¯ |
| å­¤å„¿å†»ç»“æ£€æŸ¥æ—¶é—´ | æ¯å¤©å‡Œæ™¨2ç‚¹ | å·²æ‹æ¿ | daily-orphan-frozen-check.js | Jobæµ‹è¯•æ—¶é—´ |
| è¿æ¥æ± å‘Šè­¦é˜ˆå€¼ waiting | >5 | 2025-12-30 | app.js | å‹æµ‹å‘Šè­¦éªŒè¯ |
| è¿æ¥æ± å‘Šè­¦é˜ˆå€¼ usage_rate | >80% | 2025-12-30 | app.js | å‹æµ‹å‘Šè­¦éªŒè¯ |

#### E.2 æ¶æ„å†³ç­–ç±»æ‹æ¿

| å†³ç­–å†…å®¹ | æ‹æ¿æ—¥æœŸ | æ¥æºæ–‡ä»¶ | æµ‹è¯•å½±å“ |
|---------|---------|---------|---------|
| å›¾ç‰‡å­˜å‚¨åªå­˜å¯¹è±¡ keyï¼ˆéå®Œæ•´URLï¼‰ | 2026-01-08 | ImageUrlHelper.js / sealosStorage.js | ä¸Šä¼ æ¥å£å¥‘çº¦ |
| ç¼©ç•¥å›¾é¢„ç”Ÿæˆ3æ¡£è§„æ ¼ï¼ˆæ–¹æ¡ˆBï¼‰ | 2026-01-08 | sealosStorage.js | å›¾ç‰‡ä¸Šä¼ æµ‹è¯• |
| åˆ é™¤å³ç‰©ç†åˆ é™¤å¯¹è±¡ | 2026-01-09 | PopupBannerService.js | åˆ é™¤æ¥å£æµ‹è¯• |
| å¹‚ç­‰æ€§æ²»ç†å†³ç­– | 2026-01-05 | IdempotencyHelper.js | å¹‚ç­‰æ€§æµ‹è¯• |
| äº‹åŠ¡é”™è¯¯åˆ†ç±»è§„åˆ™ï¼ˆP0-3ï¼‰ | 2026-01-09 | TransactionManager.js | äº‹åŠ¡å¼‚å¸¸æµ‹è¯• |
| é”™è¯¯ç åˆ†ç±»è§„åˆ™ï¼ˆP0-3ï¼‰ | å·²æ‹æ¿ | ErrorCodes.js | APIé”™è¯¯ç å¥‘çº¦ |

#### E.3 ä¸šåŠ¡è§„åˆ™ç±»æ‹æ¿

| ä¸šåŠ¡è§„åˆ™ | æ‹æ¿æ—¥æœŸ | æ¥æºæ–‡ä»¶ | æµ‹è¯•å½±å“ |
|---------|---------|---------|---------|
| ä¿åº•è§„åˆ™ | å·²æ‹æ¿ | GuaranteeStage.js | æŠ½å¥–ä¿åº•æµ‹è¯• |
| æ¡£ä½æƒé‡é»˜è®¤é…ç½® | 0.10.2ç‰ˆæœ¬ | TierPickStage.js | æ¦‚ç‡åˆ†å¸ƒæµ‹è¯• |
| æ´»åŠ¨ä¸Šçº¿ä¸¥æ ¼æ ¡éªŒï¼ˆçº¯ä¸¥æ ¼æ¨¡å¼ï¼‰ | ç”¨æˆ·æ‹æ¿ | ActivityService.js | æ´»åŠ¨æ ¡éªŒæµ‹è¯• |
| æ•æ„Ÿæ“ä½œæ—¥å¿—è§„åˆ™ | 2026-01-21 | sensitiveOperation.js | å®¡è®¡æ—¥å¿—æµ‹è¯• |
| æ—¥å¿—ä¸¥æ ¼è„±æ•ç­–ç•¥ | 2026-01-13 | logger.js | æ—¥å¿—è„±æ•æµ‹è¯• |
| æƒé™è¾¹ç•Œè§„åˆ™ï¼ˆåªå…è®¸adminæˆ–æœ¬äººï¼‰ | 2026-01-08 | permissions.js | æƒé™æµ‹è¯•è¾¹ç•Œ |

#### E.4 æµ‹è¯•æ’é™¤é¡¹æ‹æ¿ â­ 2026-01-30 ç”¨æˆ·æ˜ç¡®æ‹æ¿

| æ’é™¤é¡¹ | æ‹æ¿æ—¥æœŸ | åŸå›  | æ›¿ä»£æ–¹æ¡ˆ |
|--------|---------|------|---------|
| æ•°æ®åº“è¿ç§»å›å½’æµ‹è¯• | 2026-01-30 | ä¸€æ¬¡æ€§éƒ¨ç½²æ“ä½œ | Code Review + Staging |
| Webç®¡ç†å¹³å°æµ‹è¯• | 2026-01-30 | ç‹¬ç«‹å‰ç«¯é¡¹ç›® | å‰ç«¯é¡¹ç›®E2E |
| ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆæµ‹è¯• | 2026-01-30 | æœ‰ç‹¬ç«‹SLA | Mock + Staging |

#### E.5 å…¶ä»–ç›¸å…³æ‹æ¿

| å†³ç­–å†…å®¹ | æ‹æ¿æ—¥æœŸ | æ¥æº |
|---------|---------|------|
| item_templates è¡¨ä¸åšæ¨¡æ¿åŒ– | æ–‡æ¡£æ‹æ¿ | verify_asset_domain.js |
| å¸‚åœºæŒ‚ç‰Œé»˜è®¤è¿‡æœŸ3å¤© | å…¨é‡æ‹æ¿ | 20260108230000è¿ç§» |
| å•†æˆ·å®¡æ ¸è¯­ä¹‰å‡çº§ | 2026-01-08 | 20260108000000è¿ç§» |
| æ—§æ•°æ®ç›´æ¥åˆ é™¤ä¸å¯¼å‡ºï¼ˆstoresè¡¨ï¼‰ | å·²æ‹æ¿ | 20260112210100è¿ç§» |

---

> **ä½¿ç”¨è¯´æ˜**ï¼šåœ¨è®¾è®¡å’Œç¼–å†™æµ‹è¯•ç”¨ä¾‹æ—¶ï¼Œå‡¡æ¶‰åŠä¸Šè¿°å·²æ‹æ¿å†³ç­–çš„è¾¹ç•Œå€¼ã€è¡Œä¸ºè§„åˆ™ï¼Œå‡ä»¥æœ¬é™„å½•ä¸ºå‡†ï¼Œæ— éœ€å†æ¬¡ç¡®è®¤ã€‚

