# ç›‘æ§å’Œè¿ç»´å¢å¼ºæ–¹æ¡ˆå¤šç»´åº¦åˆ†ææŠ¥å‘Š

> **ç”Ÿæˆæ—¶é—´**ï¼š2025å¹´11æœˆ24æ—¥ åŒ—äº¬æ—¶é—´  
> **åˆ†ææ¨¡å‹**ï¼šClaude 4 Sonnet  
> **åˆ†æä¾æ®**ï¼šé¡¹ç›®ç°æœ‰æŠ€æœ¯æ ˆ + å¤§å‚å®è·µ + å°å…¬å¸å®è·µ  
> **æ ¸å¿ƒåŸåˆ™**ï¼šä¸å¢åŠ æŠ€æœ¯å€ºåŠ¡ã€ç»´æŠ¤æˆæœ¬ä½ã€å­¦ä¹ æˆæœ¬ä½

---

## ğŸ“Š ä¸€ã€é¡¹ç›®ç°çŠ¶è¯„ä¼°

### 1.1 å·²å®ç°çš„ç›‘æ§èƒ½åŠ›

#### âœ… æ•°æ®åº“å±‚é¢
```javascript
// config/database.js - å·²å®ç°
{
  pool: {
    max: 40,           // æœ€å¤§è¿æ¥æ•°
    min: 5,            // æœ€å°è¿æ¥æ•°
    acquire: 30000,    // è·å–è¿æ¥è¶…æ—¶
    idle: 180000,      // ç©ºé—²è¿æ¥æ—¶é—´
    evict: 60000,      // æ¸…ç†é—´éš”
    handleDisconnects: true
  },
  benchmark: true,     // âœ… å¯ç”¨æŸ¥è¯¢æ—¶é—´è®°å½•
  logging: slowQueryLogger  // âœ… æ…¢æŸ¥è¯¢ç›‘æ§ï¼ˆ>1ç§’ï¼‰
}
```

**å·²é›†æˆåŠŸèƒ½**ï¼š
- âœ… æ…¢æŸ¥è¯¢ç›‘æ§ï¼ˆSLOW_QUERY_THRESHOLD: 1000msï¼‰
- âœ… æ€§èƒ½ç›‘æ§æ¨¡å—ï¼ˆ`database-performance-monitor.js`ï¼‰
- âœ… æŸ¥è¯¢æ—¶é—´è®°å½•ï¼ˆbenchmark: trueï¼‰

#### âœ… åº”ç”¨å¥åº·æ£€æŸ¥
```javascript
// app.js - å·²å®ç° /health ç«¯ç‚¹
{
  status: 'healthy',
  systems: {
    database: 'connected',  // âœ… æ•°æ®åº“è¿æ¥æ£€æŸ¥
    redis: 'connected',     // âœ… Redisè¿æ¥æ£€æŸ¥
    nodejs: 'v20.18.0'
  },
  memory: {
    used: '29MB',
    total: '30MB'
  },
  uptime: '54s'
}
```

#### âœ… RedisæœåŠ¡
- **å·²å®‰è£…**ï¼šredisã€ioredis
- **è¿è¡ŒçŠ¶æ€**ï¼šå®ˆæŠ¤è¿›ç¨‹æ¨¡å¼è¿è¡Œ
- **æŒä¹…åŒ–**ï¼šé»˜è®¤RDBï¼ˆRedis Databaseï¼‰å¿«ç…§

#### âœ… è¿›ç¨‹ç®¡ç†
- **PM2é…ç½®**ï¼šecosystem.config.jså®Œæ•´
- **è‡ªåŠ¨é‡å¯**ï¼šmax_restarts: 10
- **å†…å­˜ç®¡ç†**ï¼šmax_memory_restart: 512M
- **æ—¥å¿—ç³»ç»Ÿ**ï¼šå®Œæ•´çš„æ—¥å¿—è®°å½•

---

## ğŸ¯ äºŒã€4ä¸ªå»ºè®®æ–¹æ¡ˆçš„å¿…è¦æ€§åˆ†æ

### 2.1 æ–¹æ¡ˆ1ï¼šæ•°æ®åº“è¿æ¥æ± ç›‘æ§

#### ğŸ“‹ æ–¹æ¡ˆæè¿°
æ·»åŠ å®æ—¶çš„æ•°æ®åº“è¿æ¥æ± çŠ¶æ€ç›‘æ§ï¼ˆæ´»è·ƒè¿æ¥æ•°ã€ç©ºé—²è¿æ¥æ•°ã€ç­‰å¾…é˜Ÿåˆ—é•¿åº¦ï¼‰

#### âœ… é¡¹ç›®ç°çŠ¶
```javascript
// âœ… å·²æœ‰åŸºç¡€ï¼šæ…¢æŸ¥è¯¢ç›‘æ§
slowQueryLogger: (sql, timing) => {
  if (timing >= 1000ms) {
    console.warn('ğŸŒ æ…¢æŸ¥è¯¢æ£€æµ‹:', { sql, timing })
    performanceMonitor.recordSlowQuery(sql, timing)
  }
}
```

#### ğŸ“Š å¿…è¦æ€§è¯„åˆ†ï¼šâ˜…â˜…â˜…â˜†â˜†ï¼ˆä¸­ç­‰ï¼Œéå¿…éœ€ï¼‰

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **ä»£ç å¤æ‚åº¦** | â­â­â­â­ | ä½ï¼ˆSequelizeå·²æä¾›poolçŠ¶æ€ï¼‰ |
| **ç»´æŠ¤æˆæœ¬** | â­â­â­â­ | ä½ï¼ˆä»…éœ€è¯»å–çŠ¶æ€ï¼‰ |
| **æ–°äººå­¦ä¹ æˆæœ¬** | â­â­â­â­ | ä½ï¼ˆæ¦‚å¿µæ¸…æ™°ï¼‰ |
| **é‡æ„éš¾åº¦** | â­â­â­â­â­ | æä½ï¼ˆæ— éœ€é‡æ„ï¼‰ |
| **é•¿æœŸå€ºåŠ¡** | â­â­â­â­â­ | æä½ï¼ˆæ ‡å‡†ç›‘æ§ï¼‰ |
| **æ•°æ®åº“æ€§èƒ½** | â­â­â­ | ä¸­ç­‰æå‡ï¼ˆé¢„è­¦ä½œç”¨ï¼‰ |
| **ä¸šåŠ¡è¯­ä¹‰** | â­â­ | ä½ï¼ˆæŠ€æœ¯æŒ‡æ ‡ï¼Œéä¸šåŠ¡ï¼‰ |
| **æ–‡æ¡£ä¾èµ–åº¦** | â­â­â­â­ | ä½ï¼ˆæ ‡å‡†æ¦‚å¿µï¼‰ |

#### ğŸ¢ å¤§å…¬å¸å®è·µï¼ˆç¾å›¢ã€è…¾è®¯ã€é˜¿é‡Œï¼‰

**é˜¿é‡Œå·´å·´**ï¼ˆDruidè¿æ¥æ± ç›‘æ§ï¼‰ï¼š
```javascript
// â­ å¤§å‚æ–¹æ¡ˆï¼šä¸“ä¸šè¿æ¥æ± ç›‘æ§
{
  activeCount: 15,      // æ´»è·ƒè¿æ¥æ•°
  idleCount: 25,        // ç©ºé—²è¿æ¥æ•°
  waitThreadCount: 3,   // ç­‰å¾…çº¿ç¨‹æ•°
  createCount: 1234,    // ç´¯è®¡åˆ›å»ºè¿æ¥æ•°
  destroyCount: 100,    // ç´¯è®¡é”€æ¯è¿æ¥æ•°
  connectTime: 10ms,    // å¹³å‡è¿æ¥æ—¶é—´
  activeConnectionStack: []  // æ´»è·ƒè¿æ¥å †æ ˆ
}
```

**è…¾è®¯**ï¼ˆè‡ªç ”è¿æ¥æ± ç›‘æ§ï¼‰ï¼š
- å®æ—¶è¿æ¥æ± çœ‹æ¿
- è¿æ¥æ³„æ¼æ£€æµ‹
- æ…¢SQLå…³è”åˆ†æ
- è‡ªåŠ¨å‘Šè­¦å’Œæ‰©å®¹

**ç¾å›¢**ï¼ˆè¿æ¥æ± å¥åº·åº¦è¯„åˆ†ï¼‰ï¼š
- è¿æ¥æ± å¥åº·åº¦ï¼š0-100åˆ†
- è‡ªåŠ¨è°ƒæ•´poolé…ç½®
- æ™ºèƒ½é¢„æµ‹è¿æ¥éœ€æ±‚

#### ğŸª å°å…¬å¸å®è·µ

**åˆåˆ›å…¬å¸**ï¼š
```javascript
// â­ å°å…¬å¸æ–¹æ¡ˆï¼šç®€å•å¤Ÿç”¨
setInterval(() => {
  const pool = sequelize.connectionManager.pool
  console.log('ğŸ“Š è¿æ¥æ± çŠ¶æ€:', {
    size: pool.size,
    available: pool.available,
    using: pool.using,
    waiting: pool.waiting
  })
}, 60000)  // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
```

#### ğŸ’¡ æ¨èæ–¹æ¡ˆï¼ˆé€‚åˆå½“å‰é¡¹ç›®ï¼‰

**æ–¹æ¡ˆAï¼šè½»é‡çº§ç›‘æ§ï¼ˆæ¨èï¼‰**

```javascript
// scripts/monitor/pool-monitor.js
class DatabasePoolMonitor {
  constructor(sequelize) {
    this.sequelize = sequelize
    this.alertThresholds = {
      activeRatio: 0.8,    // 80%æ´»è·ƒè¿æ¥å‘Šè­¦
      waitingCount: 5      // 5ä¸ªç­‰å¾…è¿æ¥å‘Šè­¦
    }
  }

  // è·å–è¿æ¥æ± çŠ¶æ€
  getPoolStatus() {
    const pool = this.sequelize.connectionManager.pool
    return {
      size: pool.size,         // å½“å‰è¿æ¥æ•°
      available: pool.available, // å¯ç”¨è¿æ¥æ•°
      using: pool.using,       // ä½¿ç”¨ä¸­è¿æ¥æ•°
      waiting: pool.waiting,   // ç­‰å¾…ä¸­è¿æ¥æ•°
      max: pool.max,           // æœ€å¤§è¿æ¥æ•°
      min: pool.min            // æœ€å°è¿æ¥æ•°
    }
  }

  // æ£€æŸ¥æ˜¯å¦éœ€è¦å‘Šè­¦
  checkAlert(status) {
    const activeRatio = status.using / status.max
    if (activeRatio > this.alertThresholds.activeRatio) {
      console.warn(`âš ï¸ è¿æ¥æ± ä½¿ç”¨ç‡è¿‡é«˜: ${(activeRatio * 100).toFixed(1)}%`)
    }
    if (status.waiting > this.alertThresholds.waitingCount) {
      console.warn(`âš ï¸ è¿æ¥ç­‰å¾…é˜Ÿåˆ—è¿‡é•¿: ${status.waiting}ä¸ª`)
    }
  }

  // å¯åŠ¨ç›‘æ§ï¼ˆä»…åœ¨éœ€è¦æ—¶ï¼‰
  start(interval = 60000) {
    this.timer = setInterval(() => {
      const status = this.getPoolStatus()
      this.checkAlert(status)
    }, interval)
  }

  stop() {
    if (this.timer) clearInterval(this.timer)
  }
}

module.exports = DatabasePoolMonitor
```

**é›†æˆåˆ°å¥åº·æ£€æŸ¥**ï¼š
```javascript
// app.js - å¢å¼º /health ç«¯ç‚¹
app.get('/health', async (req, res) => {
  const pool = sequelize.connectionManager.pool
  const poolStatus = {
    active: pool.using,
    idle: pool.available,
    total: pool.size,
    max: pool.max,
    waiting: pool.waiting
  }

  res.json({
    // ... ç°æœ‰å­—æ®µ
    pool: poolStatus  // ğŸ†• æ·»åŠ è¿æ¥æ± çŠ¶æ€
  })
})
```

**æˆæœ¬åˆ†æ**ï¼š
- **å¼€å‘æˆæœ¬**ï¼š1-2å°æ—¶ï¼ˆ100è¡Œä»£ç ï¼‰
- **ç»´æŠ¤æˆæœ¬**ï¼šæä½ï¼ˆæ— å¤–éƒ¨ä¾èµ–ï¼‰
- **æ€§èƒ½å¼€é”€**ï¼šå¯å¿½ç•¥ï¼ˆä»…è¯»å–çŠ¶æ€ï¼‰
- **æŠ€æœ¯å€ºåŠ¡**ï¼šæ— 

#### âŒ ä¸æ¨èæ–¹æ¡ˆ

**è¿‡åº¦è®¾è®¡**ï¼š
- âŒ ç‹¬ç«‹çš„ç›‘æ§æœåŠ¡
- âŒ å®æ—¶å›¾è¡¨å±•ç¤º
- âŒ å¤æ‚çš„æœºå™¨å­¦ä¹ é¢„æµ‹
- âŒ åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿ

**åŸå› **ï¼š
1. é¡¹ç›®è§„æ¨¡ä¸éœ€è¦
2. å¢åŠ ç»´æŠ¤å¤æ‚åº¦
3. å¼•å…¥æ–°çš„æŠ€æœ¯æ ˆ
4. å­¦ä¹ æˆæœ¬é«˜

---

### 2.2 æ–¹æ¡ˆ2ï¼šRedisæŒä¹…åŒ–é…ç½®

#### ğŸ“‹ æ–¹æ¡ˆæè¿°
ç¡®è®¤å’Œä¼˜åŒ–Redisæ•°æ®æŒä¹…åŒ–ç­–ç•¥ï¼ˆRDB vs AOFï¼‰

#### âœ… é¡¹ç›®ç°çŠ¶
```bash
# Redisé»˜è®¤é…ç½®
save 900 1      # 900ç§’å†…è‡³å°‘1ä¸ªkeyå˜åŒ–
save 300 10     # 300ç§’å†…è‡³å°‘10ä¸ªkeyå˜åŒ–
save 60 10000   # 60ç§’å†…è‡³å°‘10000ä¸ªkeyå˜åŒ–
```

#### ğŸ“Š å¿…è¦æ€§è¯„åˆ†ï¼šâ˜…â˜…â˜…â˜…â˜†ï¼ˆé‡è¦ï¼Œå»ºè®®ä¼˜åŒ–ï¼‰

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **ä»£ç å¤æ‚åº¦** | â­â­â­â­â­ | æä½ï¼ˆé…ç½®æ–‡ä»¶ä¿®æ”¹ï¼‰ |
| **ç»´æŠ¤æˆæœ¬** | â­â­â­â­â­ | æä½ï¼ˆæ— éœ€ä»£ç ç»´æŠ¤ï¼‰ |
| **æ–°äººå­¦ä¹ æˆæœ¬** | â­â­â­â­ | ä½ï¼ˆæ ‡å‡†RedisçŸ¥è¯†ï¼‰ |
| **é‡æ„éš¾åº¦** | â­â­â­â­â­ | æä½ï¼ˆé…ç½®è°ƒæ•´ï¼‰ |
| **é•¿æœŸå€ºåŠ¡** | â­â­â­â­â­ | æ— ï¼ˆæ ‡å‡†é…ç½®ï¼‰ |
| **æ•°æ®åº“æ€§èƒ½** | â­â­â­â­ | é«˜ï¼ˆå½±å“æ•°æ®å®‰å…¨ï¼‰ |
| **ä¸šåŠ¡è¯­ä¹‰** | â­â­â­â­ | é«˜ï¼ˆé˜²æ­¢æ•°æ®ä¸¢å¤±ï¼‰ |
| **æ–‡æ¡£ä¾èµ–åº¦** | â­â­â­â­ | ä½ï¼ˆRediså®˜æ–¹æ–‡æ¡£ï¼‰ |

#### ğŸ¢ å¤§å…¬å¸å®è·µ

**é˜¿é‡Œäº‘Redis**ï¼š
```conf
# â­ å¤§å‚æ–¹æ¡ˆï¼šRDB + AOFæ··åˆæŒä¹…åŒ–
save 900 1
save 300 10
save 60 10000
appendonly yes                    # å¯ç”¨AOF
appendfsync everysec             # æ¯ç§’åŒæ­¥
auto-aof-rewrite-percentage 100  # è‡ªåŠ¨é‡å†™
auto-aof-rewrite-min-size 64mb
aof-use-rdb-preamble yes         # æ··åˆæŒä¹…åŒ–
```

**è…¾è®¯äº‘Redis**ï¼š
- **ä¸»ä»å¤åˆ¶** + **æŒä¹…åŒ–**
- **å®šæ—¶å¤‡ä»½**åˆ°å¯¹è±¡å­˜å‚¨
- **è‡ªåŠ¨æ•…éšœè½¬ç§»**

**ç¾å›¢Redis**ï¼š
- **RDBå¿«ç…§** + **AOFå¢é‡**
- **åˆ†å¸ƒå¼é›†ç¾¤**
- **ç›‘æ§å‘Šè­¦**

#### ğŸª å°å…¬å¸å®è·µ

```conf
# â­ å°å…¬å¸æ–¹æ¡ˆï¼šç®€å•å¯é 
# 1. è½»é‡çº§åœºæ™¯ï¼ˆç¼“å­˜ä¸ºä¸»ï¼‰
save ""              # å…³é—­RDBï¼ˆæ•°æ®ä¸¢å¤±å¯æ¥å—ï¼‰
maxmemory 256mb
maxmemory-policy allkeys-lru

# 2. æ•°æ®é‡è¦åœºæ™¯ï¼ˆä¼šè¯ã€é˜Ÿåˆ—ï¼‰
save 900 1
save 300 10
appendonly yes       # å¯ç”¨AOF
appendfsync everysec
```

#### ğŸ’¡ æ¨èæ–¹æ¡ˆï¼ˆé€‚åˆå½“å‰é¡¹ç›®ï¼‰

**æ–¹æ¡ˆAï¼šå¼€å‘ç¯å¢ƒï¼ˆé»˜è®¤RDBï¼‰**

```conf
# /etc/redis/redis.conf æˆ– redis.conf
# ğŸ“ é€‚ç”¨åœºæ™¯ï¼šå¼€å‘ã€æµ‹è¯•ç¯å¢ƒ

# RDBå¿«ç…§ï¼ˆå·²è¶³å¤Ÿï¼‰
save 900 1
save 300 10
save 60 10000
dbfilename dump.rdb
dir /var/lib/redis

# å†…å­˜ç®¡ç†
maxmemory 512mb
maxmemory-policy allkeys-lru

# æ—¥å¿—
loglevel notice
logfile /var/log/redis/redis-server.log
```

**æ–¹æ¡ˆBï¼šç”Ÿäº§ç¯å¢ƒï¼ˆRDB + AOFæ¨èï¼‰**

```conf
# ğŸ“ é€‚ç”¨åœºæ™¯ï¼šç”Ÿäº§ç¯å¢ƒï¼ˆæ•°æ®é‡è¦ï¼‰

# RDBå¿«ç…§
save 900 1
save 300 10
save 60 10000

# AOFæŒä¹…åŒ–ï¼ˆæ¨èï¼‰
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec        # æ€§èƒ½ä¸å®‰å…¨çš„å¹³è¡¡
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# æ··åˆæŒä¹…åŒ–ï¼ˆRedis 4.0+ï¼‰
aof-use-rdb-preamble yes   # RDB+AOFæ··åˆï¼Œæ¢å¤æ›´å¿«

# å†…å­˜ç®¡ç†
maxmemory 1gb
maxmemory-policy allkeys-lru

# æ…¢æŸ¥è¯¢æ—¥å¿—
slowlog-log-slower-than 10000  # 10ms
slowlog-max-len 128
```

**éªŒè¯è„šæœ¬**ï¼š
```bash
#!/bin/bash
# scripts/redis-check.sh

echo "ğŸ” RedisæŒä¹…åŒ–é…ç½®æ£€æŸ¥"
echo "======================================"

# æ£€æŸ¥RDBé…ç½®
echo "ğŸ“Š RDBé…ç½®:"
redis-cli CONFIG GET save

# æ£€æŸ¥AOFé…ç½®
echo "ğŸ“Š AOFé…ç½®:"
redis-cli CONFIG GET appendonly
redis-cli CONFIG GET appendfsync

# æ£€æŸ¥æŒä¹…åŒ–æ–‡ä»¶
echo "ğŸ“‚ æŒä¹…åŒ–æ–‡ä»¶:"
redis-cli CONFIG GET dir
ls -lh /var/lib/redis/dump.rdb 2>/dev/null || echo "RDBæ–‡ä»¶ä¸å­˜åœ¨"
ls -lh /var/lib/redis/appendonly.aof 2>/dev/null || echo "AOFæ–‡ä»¶ä¸å­˜åœ¨"

# æœ€åä¸€æ¬¡ä¿å­˜æ—¶é—´
echo "â° æœ€åRDBä¿å­˜:"
redis-cli LASTSAVE | xargs -I {} date -d @{}

echo "======================================"
```

**npmè„šæœ¬é›†æˆ**ï¼š
```json
{
  "scripts": {
    "redis:check": "bash scripts/redis-check.sh",
    "redis:save": "redis-cli BGSAVE",
    "redis:info": "redis-cli INFO persistence"
  }
}
```

**æˆæœ¬åˆ†æ**ï¼š
- **é…ç½®æˆæœ¬**ï¼š10-30åˆ†é’Ÿï¼ˆä¸€æ¬¡æ€§ï¼‰
- **ç»´æŠ¤æˆæœ¬**ï¼šæä½ï¼ˆé…ç½®ç¨³å®šï¼‰
- **æ€§èƒ½å¼€é”€**ï¼šRDBå‡ ä¹æ— ï¼ŒAOFè½»å¾®ï¼ˆeverysecæ¨¡å¼ï¼‰
- **æŠ€æœ¯å€ºåŠ¡**ï¼šæ— 

#### âœ… ç»“è®ºï¼š**å¿…è¦ä¸”ç®€å•**

---

### 2.3 æ–¹æ¡ˆ3ï¼šç³»ç»Ÿçº§å®ˆæŠ¤ï¼ˆsystemdæœåŠ¡ï¼‰

#### ğŸ“‹ æ–¹æ¡ˆæè¿°
é…ç½®systemdæœåŠ¡ï¼Œå®ç°ç³»ç»Ÿçº§å®ˆæŠ¤å’Œå¼€æœºè‡ªå¯

#### âœ… é¡¹ç›®ç°çŠ¶
- âœ… PM2å®ˆæŠ¤è¿›ç¨‹ç®¡ç†
- âœ… PM2é…ç½®æŒä¹…åŒ–
- âŒ æ— systemdé…ç½®ï¼ˆéœ€è¦sudoæƒé™ï¼‰

#### ğŸ“Š å¿…è¦æ€§è¯„åˆ†ï¼šâ˜…â˜…â˜†â˜†â˜†ï¼ˆä½ä¼˜å…ˆçº§ï¼ŒPM2å·²è¶³å¤Ÿï¼‰

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **ä»£ç å¤æ‚åº¦** | â­â­â­â­ | ä½ï¼ˆé…ç½®æ–‡ä»¶ï¼‰ |
| **ç»´æŠ¤æˆæœ¬** | â­â­â­ | ä¸­ï¼ˆéœ€è¦ç³»ç»Ÿæƒé™ï¼‰ |
| **æ–°äººå­¦ä¹ æˆæœ¬** | â­â­â­ | ä¸­ï¼ˆLinuxçŸ¥è¯†ï¼‰ |
| **é‡æ„éš¾åº¦** | â­â­â­â­ | ä½ï¼ˆæ— éœ€ä»£ç æ”¹åŠ¨ï¼‰ |
| **é•¿æœŸå€ºåŠ¡** | â­â­â­â­ | ä½ï¼ˆæ ‡å‡†é…ç½®ï¼‰ |
| **æ•°æ®åº“æ€§èƒ½** | â­â­â­â­â­ | æ— å½±å“ |
| **ä¸šåŠ¡è¯­ä¹‰** | â­â­ | ä½ï¼ˆè¿ç»´å±‚é¢ï¼‰ |
| **æ–‡æ¡£ä¾èµ–åº¦** | â­â­â­ | ä¸­ï¼ˆLinuxæ–‡æ¡£ï¼‰ |

#### ğŸ¢ å¤§å…¬å¸å®è·µ

**é˜¿é‡Œäº‘ã€è…¾è®¯äº‘**ï¼š
```ini
# â­ å¤§å‚æ–¹æ¡ˆï¼šKubernetes + Docker
# ä½¿ç”¨å®¹å™¨ç¼–æ’ï¼Œä¸ä¾èµ–systemd
apiVersion: apps/v1
kind: Deployment
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: app
        image: restaurant-lottery:v4
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
```

**ç¾å›¢**ï¼š
- **å®¹å™¨åŒ–éƒ¨ç½²**ï¼ˆDocker + Kubernetesï¼‰
- **æœåŠ¡ç½‘æ ¼**ï¼ˆIstioï¼‰
- **ä¸ä½¿ç”¨ä¼ ç»Ÿsystemd**

#### ğŸª å°å…¬å¸å®è·µ

**ä¼ ç»Ÿéƒ¨ç½²**ï¼š
```ini
# â­ å°å…¬å¸æ–¹æ¡ˆï¼šPM2 + systemd
[Unit]
Description=Restaurant Lottery Backend (PM2)
After=network.target

[Service]
Type=forking
User=devbox
WorkingDirectory=/home/devbox/project
ExecStart=/home/devbox/.nvm/versions/node/v20.18.0/bin/pm2 start ecosystem.config.js
ExecReload=/home/devbox/.nvm/versions/node/v20.18.0/bin/pm2 reload all
ExecStop=/home/devbox/.nvm/versions/node/v20.18.0/bin/pm2 stop all
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

**ç°ä»£éƒ¨ç½²**ï¼š
```bash
# ä½¿ç”¨PM2 startupï¼ˆæ— éœ€æ‰‹å†™systemdï¼‰
pm2 startup
pm2 save
```

#### ğŸ’¡ æ¨èæ–¹æ¡ˆ

**æ–¹æ¡ˆAï¼šç»§ç»­ä½¿ç”¨PM2ï¼ˆæ¨èï¼‰**

**ç†ç”±**ï¼š
1. âœ… PM2å·²æä¾›å®Œæ•´å®ˆæŠ¤è¿›ç¨‹åŠŸèƒ½
2. âœ… PM2 startupå·²æ”¯æŒsystemdé›†æˆ
3. âœ… æ— éœ€é¢å¤–çš„ç³»ç»Ÿæƒé™
4. âœ… å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒç»Ÿä¸€
5. âœ… æ›´å¥½çš„è¿›ç¨‹ç®¡ç†åŠŸèƒ½ï¼ˆç›‘æ§ã€æ—¥å¿—ã€é›†ç¾¤ï¼‰

**å½“å‰å·²å®ç°**ï¼š
```bash
# PM2å®ˆæŠ¤è¿›ç¨‹å·²é…ç½®
âœ… è‡ªåŠ¨é‡å¯ï¼šmax_restarts: 10
âœ… å†…å­˜ç®¡ç†ï¼šmax_memory_restart: 512M
âœ… æ—¥å¿—ç³»ç»Ÿï¼šå®Œæ•´çš„æ—¥å¿—è®°å½•
âœ… å¥åº·æ£€æŸ¥ï¼šhealth_check_grace_period: 3000
âœ… é…ç½®æŒä¹…åŒ–ï¼špm2 save
```

**æ–¹æ¡ˆBï¼šæ·»åŠ systemdï¼ˆå¯é€‰ï¼Œä»…åœ¨æœ‰sudoæƒé™æ—¶ï¼‰**

```bash
# scripts/setup-systemd.sh
#!/bin/bash
# ğŸ”´ éœ€è¦sudoæƒé™

if [ "$EUID" -ne 0 ]; then
  echo "âŒ æ­¤è„šæœ¬éœ€è¦sudoæƒé™"
  exit 1
fi

# ä½¿ç”¨PM2çš„systemdé›†æˆ
sudo env PATH=$PATH:/home/devbox/.nvm/versions/node/v20.18.0/bin \
  pm2 startup systemd -u devbox --hp /home/devbox

echo "âœ… systemdæœåŠ¡å·²é…ç½®"
echo "ğŸ“ ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç®¡ç†æœåŠ¡:"
echo "   sudo systemctl start pm2-devbox"
echo "   sudo systemctl status pm2-devbox"
echo "   sudo systemctl enable pm2-devbox"
```

**æˆæœ¬åˆ†æ**ï¼š
- **å¼€å‘æˆæœ¬**ï¼š30åˆ†é’Ÿï¼ˆä¸€æ¬¡æ€§ï¼‰
- **ç»´æŠ¤æˆæœ¬**ï¼šä½
- **æƒé™è¦æ±‚**ï¼šéœ€è¦sudo
- **æŠ€æœ¯å€ºåŠ¡**ï¼šæ— 
- **å®é™…æ”¶ç›Š**ï¼šç›¸æ¯”PM2ï¼Œæ”¶ç›Šä¸å¤§

#### âŒ ç»“è®ºï¼š**éå¿…éœ€ï¼ŒPM2å·²è¶³å¤Ÿ**

---

### 2.4 æ–¹æ¡ˆ4ï¼šç›‘æ§å‘Šè­¦ï¼ˆPM2 Plus / è‡ªå®šä¹‰ç›‘æ§ï¼‰

#### ğŸ“‹ æ–¹æ¡ˆæè¿°
æ·»åŠ ä¸“ä¸šçš„ç›‘æ§å‘Šè­¦ç³»ç»Ÿï¼ˆPM2 Pluså•†ä¸šç‰ˆ æˆ– è‡ªç ”ç›‘æ§ï¼‰

#### âœ… é¡¹ç›®ç°çŠ¶
```javascript
// âœ… å·²æœ‰åŸºç¡€ç›‘æ§
- /healthç«¯ç‚¹
- æ…¢æŸ¥è¯¢æ—¥å¿—
- PM2è¿›ç¨‹ç›‘æ§
- é”™è¯¯æ—¥å¿—ï¼ˆWinstonï¼‰
```

#### ğŸ“Š å¿…è¦æ€§è¯„åˆ†ï¼šâ˜…â˜…â˜†â˜†â˜†ï¼ˆä½ä¼˜å…ˆçº§ï¼Œæˆæœ¬è¾ƒé«˜ï¼‰

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **ä»£ç å¤æ‚åº¦** | â­â­ | é«˜ï¼ˆéœ€è¦é›†æˆç›‘æ§ç³»ç»Ÿï¼‰ |
| **ç»´æŠ¤æˆæœ¬** | â­â­ | é«˜ï¼ˆå•†ä¸šç‰ˆè´¹ç”¨æˆ–è‡ªç ”ç»´æŠ¤ï¼‰ |
| **æ–°äººå­¦ä¹ æˆæœ¬** | â­â­â­ | ä¸­ï¼ˆç›‘æ§å¹³å°å­¦ä¹ ï¼‰ |
| **é‡æ„éš¾åº¦** | â­â­â­ | ä¸­ï¼ˆéœ€è¦åŸ‹ç‚¹ï¼‰ |
| **é•¿æœŸå€ºåŠ¡** | â­â­ | ä¸­åˆ°é«˜ï¼ˆä¾èµ–å¤–éƒ¨æœåŠ¡ï¼‰ |
| **æ•°æ®åº“æ€§èƒ½** | â­â­â­â­â­ | æ— å½±å“ |
| **ä¸šåŠ¡è¯­ä¹‰** | â­â­ | ä½ï¼ˆè¿ç»´å±‚é¢ï¼‰ |
| **æ–‡æ¡£ä¾èµ–åº¦** | â­â­ | é«˜ï¼ˆå¹³å°ç‰¹å®šæ–‡æ¡£ï¼‰ |

#### ğŸ¢ å¤§å…¬å¸å®è·µ

**é˜¿é‡Œå·´å·´**ï¼š
```javascript
// â­ å¤§å‚æ–¹æ¡ˆï¼šå®Œæ•´ç›‘æ§ä½“ç³»
- ARMSï¼ˆåº”ç”¨å®æ—¶ç›‘æ§æœåŠ¡ï¼‰
- SLSï¼ˆæ—¥å¿—æœåŠ¡ï¼‰
- è‡ªç ”ç›‘æ§å¹³å°
- å‘Šè­¦è§„åˆ™å¼•æ“
- æ™ºèƒ½è¯Šæ–­
```

**è…¾è®¯**ï¼š
- **è“é²¸ç›‘æ§**
- **Prometheus + Grafana**
- **è‡ªç ”å‘Šè­¦å¹³å°**
- **AIOpsæ™ºèƒ½è¿ç»´**

**ç¾å›¢**ï¼š
- **CATï¼ˆåº”ç”¨æ€§èƒ½ç›‘æ§ï¼‰**
- **Prometheus + Thanos**
- **è‡ªç ”ç›‘æ§å¹³å°**

#### ğŸª å°å…¬å¸å®è·µ

**æ–¹æ¡ˆ1ï¼šå…è´¹å¼€æºæ–¹æ¡ˆ**
```javascript
// â­ å°å…¬å¸æ–¹æ¡ˆï¼šPrometheus + Grafana
// 1. å®‰è£…Node.js Exporter
npm install prom-client

// 2. æš´éœ²metricsç«¯ç‚¹
const promClient = require('prom-client')
const register = new promClient.Registry()

app.get('/metrics', (req, res) => {
  res.set('Content-Type', register.contentType)
  res.end(register.metrics())
})
```

**æ–¹æ¡ˆ2ï¼šSaaSç›‘æ§æœåŠ¡**
- **PM2 Plus**ï¼š$20/æœˆèµ·
- **New Relic**ï¼š$25/æœˆèµ·
- **Datadog**ï¼š$15/æœˆèµ·
- **é˜¿é‡Œäº‘ARMS**ï¼šæŒ‰é‡ä»˜è´¹

**æ–¹æ¡ˆ3ï¼šç®€å•è‡ªç ”**
```javascript
// è½»é‡çº§è‡ªç ”ç›‘æ§
class SimpleMonitor {
  constructor() {
    this.metrics = {
      requests: 0,
      errors: 0,
      slowQueries: 0
    }
  }

  // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
  async check() {
    const { sequelize } = require('./models')
    
    try {
      // æ£€æŸ¥æ•°æ®åº“
      await sequelize.authenticate()
      
      // æ£€æŸ¥Redis
      await redis.ping()
      
      // æ£€æŸ¥ç£ç›˜ç©ºé—´
      const diskUsage = await this.checkDisk()
      
      // å‘é€å‘Šè­¦ï¼ˆå¦‚æœéœ€è¦ï¼‰
      if (diskUsage > 90) {
        await this.sendAlert('ç£ç›˜ç©ºé—´ä¸è¶³')
      }
    } catch (error) {
      await this.sendAlert('ç³»ç»Ÿå¼‚å¸¸: ' + error.message)
    }
  }

  async sendAlert(message) {
    // å‘é€é’‰é’‰/ä¼ä¸šå¾®ä¿¡é€šçŸ¥
    // æˆ–å‘é€é‚®ä»¶
  }
}
```

#### ğŸ’¡ æ¨èæ–¹æ¡ˆ

**é˜¶æ®µ1ï¼šè½»é‡çº§ç›‘æ§ï¼ˆå½“å‰é˜¶æ®µæ¨èï¼‰**

```javascript
// scripts/simple-monitor.js
// æ— éœ€å¤–éƒ¨ä¾èµ–ï¼Œè½»é‡çº§ç›‘æ§

const { sequelize } = require('../models')
const axios = require('axios')

class LightweightMonitor {
  constructor() {
    this.checkInterval = 5 * 60 * 1000  // 5åˆ†é’Ÿ
    this.alertWebhook = process.env.ALERT_WEBHOOK_URL
  }

  // æ‰§è¡Œå¥åº·æ£€æŸ¥
  async performCheck() {
    const results = {
      timestamp: new Date().toISOString(),
      checks: {}
    }

    // 1. æ•°æ®åº“æ£€æŸ¥
    try {
      await sequelize.authenticate()
      results.checks.database = { status: 'ok' }
    } catch (error) {
      results.checks.database = { status: 'error', message: error.message }
      await this.sendAlert('æ•°æ®åº“è¿æ¥å¤±è´¥', error.message)
    }

    // 2. å†…å­˜æ£€æŸ¥
    const memUsage = process.memoryUsage()
    const memPercent = (memUsage.heapUsed / memUsage.heapTotal * 100).toFixed(1)
    results.checks.memory = {
      status: memPercent < 90 ? 'ok' : 'warning',
      usage: memPercent + '%'
    }

    // 3. æ…¢æŸ¥è¯¢æ£€æŸ¥ï¼ˆä»æ€§èƒ½ç›‘æ§æ¨¡å—è·å–ï¼‰
    // const slowQueries = await performanceMonitor.getSlowQueries()
    // if (slowQueries.length > 10) {
    //   await this.sendAlert('æ…¢æŸ¥è¯¢è¿‡å¤š', `${slowQueries.length}ä¸ª`)
    // }

    return results
  }

  // å‘é€å‘Šè­¦ï¼ˆé’‰é’‰/ä¼ä¸šå¾®ä¿¡ï¼‰
  async sendAlert(title, message) {
    if (!this.alertWebhook) return

    try {
      await axios.post(this.alertWebhook, {
        msgtype: 'text',
        text: {
          content: `ã€å‘Šè­¦ã€‘${title}\n${message}\næ—¶é—´: ${new Date().toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'})}`
        }
      })
    } catch (error) {
      console.error('å‘Šè­¦å‘é€å¤±è´¥:', error.message)
    }
  }

  // å¯åŠ¨ç›‘æ§
  start() {
    console.log('ğŸ” è½»é‡çº§ç›‘æ§å·²å¯åŠ¨')
    this.timer = setInterval(() => {
      this.performCheck()
    }, this.checkInterval)
  }

  stop() {
    if (this.timer) clearInterval(this.timer)
  }
}

// ä½¿ç”¨æ–¹å¼
if (require.main === module) {
  const monitor = new LightweightMonitor()
  monitor.start()
}

module.exports = LightweightMonitor
```

**.envé…ç½®**ï¼š
```env
# å¯é€‰ï¼šå‘Šè­¦Webhookï¼ˆé’‰é’‰/ä¼ä¸šå¾®ä¿¡ï¼‰
ALERT_WEBHOOK_URL=https://oapi.dingtalk.com/robot/send?access_token=xxx
```

**npmè„šæœ¬é›†æˆ**ï¼š
```json
{
  "scripts": {
    "monitor:start": "node scripts/simple-monitor.js",
    "monitor:check": "node scripts/simple-monitor.js --once"
  }
}
```

**æˆæœ¬åˆ†æ**ï¼š
- **å¼€å‘æˆæœ¬**ï¼š2-4å°æ—¶
- **ç»´æŠ¤æˆæœ¬**ï¼šæä½
- **è¿è¡Œæˆæœ¬**ï¼šå…è´¹
- **æŠ€æœ¯å€ºåŠ¡**ï¼šä½ï¼ˆæ— å¤–éƒ¨ä¾èµ–ï¼‰

**é˜¶æ®µ2ï¼šä¸“ä¸šç›‘æ§ï¼ˆä¸šåŠ¡æˆç†Ÿåï¼‰**

å½“æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶ï¼Œå†è€ƒè™‘ä¸“ä¸šç›‘æ§ï¼š
1. âœ… ç”¨æˆ·é‡ > 10000
2. âœ… QPS > 100
3. âœ… æœ‰è¿ç»´é¢„ç®—
4. âœ… å›¢é˜Ÿè§„æ¨¡ > 5äºº

æ¨èæ–¹æ¡ˆï¼š
- **ä¸­å°å‹**ï¼šPrometheus + Grafanaï¼ˆå¼€æºå…è´¹ï¼‰
- **å¤§å‹**ï¼šäº‘å‚å•†ç›‘æ§æœåŠ¡ï¼ˆé˜¿é‡Œäº‘ARMSã€è…¾è®¯äº‘ç›‘æ§ï¼‰

#### âŒ ç»“è®ºï¼š**éå¿…éœ€ï¼Œè½»é‡çº§ç›‘æ§è¶³å¤Ÿ**

---

## ğŸ¯ ä¸‰ã€ç»¼åˆè¯„ä¼°å’Œæœ€ç»ˆå»ºè®®

### 3.1 å¿…è¦æ€§æ’åº

| æ–¹æ¡ˆ | å¿…è¦æ€§ | å®æ–½æˆæœ¬ | ç»´æŠ¤æˆæœ¬ | æ¨èæŒ‡æ•° |
|------|--------|----------|----------|----------|
| **RedisæŒä¹…åŒ–é…ç½®** | â­â­â­â­â­ | æä½ | æä½ | â­â­â­â­â­ å¿…é¡»å®æ–½ |
| **æ•°æ®åº“è¿æ¥æ± ç›‘æ§** | â­â­â­ | ä½ | ä½ | â­â­â­â­ å»ºè®®å®æ–½ |
| **è½»é‡çº§ç›‘æ§å‘Šè­¦** | â­â­â­ | ä½ | ä½ | â­â­â­ å¯é€‰å®æ–½ |
| **systemdå®ˆæŠ¤æœåŠ¡** | â­â­ | ä½ | ä¸­ | â­â­ æš‚ä¸éœ€è¦ |
| **ä¸“ä¸šç›‘æ§å¹³å°** | â­ | é«˜ | é«˜ | â­ ä¸šåŠ¡æˆç†Ÿå |

### 3.2 å®æ–½è·¯çº¿å›¾

#### ğŸš€ ç¬¬ä¸€é˜¶æ®µï¼šç«‹å³å®æ–½ï¼ˆ0æˆæœ¬ï¼Œé«˜æ”¶ç›Šï¼‰

**1. RedisæŒä¹…åŒ–é…ç½®ï¼ˆ30åˆ†é’Ÿï¼‰**
```bash
# 1. ç¼–è¾‘Redisé…ç½®
sudo vim /etc/redis/redis.conf

# 2. å¯ç”¨AOFï¼ˆå¦‚æœæ•°æ®é‡è¦ï¼‰
appendonly yes
appendfsync everysec

# 3. é‡å¯Redis
sudo systemctl restart redis-server

# 4. éªŒè¯
redis-cli CONFIG GET appendonly
```

**2. å¢å¼ºå¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼ˆ1å°æ—¶ï¼‰**
```javascript
// app.js - æ·»åŠ è¿æ¥æ± çŠ¶æ€
app.get('/health', async (req, res) => {
  // ... ç°æœ‰ä»£ç 
  const pool = sequelize.connectionManager.pool
  healthData.data.pool = {
    active: pool.using,
    idle: pool.available,
    total: pool.size,
    max: pool.max
  }
  res.json(healthData)
})
```

**é¢„æœŸæ”¶ç›Š**ï¼š
- âœ… æ•°æ®å®‰å…¨æ€§æå‡
- âœ… ç›‘æ§å¯è§æ€§æå‡
- âœ… æ— é¢å¤–è¿ç»´æˆæœ¬

#### ğŸ“ˆ ç¬¬äºŒé˜¶æ®µï¼šå¯é€‰å®æ–½ï¼ˆä½æˆæœ¬ï¼Œä¸­æ”¶ç›Šï¼‰

**3. è½»é‡çº§ç›‘æ§è„šæœ¬ï¼ˆ2-4å°æ—¶ï¼‰**
```bash
# å®æ–½è½»é‡çº§ç›‘æ§
node scripts/simple-monitor.js

# PM2é›†æˆ
pm2 start scripts/simple-monitor.js --name monitor
```

**4. æ€§èƒ½ç›‘æ§ä»ªè¡¨æ¿ï¼ˆ4-8å°æ—¶ï¼‰**
```javascript
// å¯è§†åŒ–è¿æ¥æ± ã€æ…¢æŸ¥è¯¢ç»Ÿè®¡
// ä½¿ç”¨ç°æœ‰çš„ database-performance-monitor.js
```

**é¢„æœŸæ”¶ç›Š**ï¼š
- âœ… ä¸»åŠ¨å‘ç°é—®é¢˜
- âœ… åŠæ—¶å‘Šè­¦é€šçŸ¥
- âœ… æ€§èƒ½è¶‹åŠ¿åˆ†æ

#### ğŸ”® ç¬¬ä¸‰é˜¶æ®µï¼šä¸šåŠ¡æˆç†Ÿåï¼ˆé«˜æˆæœ¬ï¼Œé«˜æ”¶ç›Šï¼‰

**5. ä¸“ä¸šç›‘æ§å¹³å°ï¼ˆæ ¹æ®é¢„ç®—é€‰æ‹©ï¼‰**
- **å¼€æºå…è´¹**ï¼šPrometheus + Grafana
- **å•†ä¸šæœåŠ¡**ï¼šäº‘å‚å•†ç›‘æ§æœåŠ¡
- **æˆæœ¬è¯„ä¼°**ï¼š$0-$100/æœˆ

**å®æ–½æ¡ä»¶**ï¼š
- ç”¨æˆ·é‡ > 10000
- QPS > 100
- æœ‰ä¸“èŒè¿ç»´äººå‘˜

### 3.3 æŠ€æœ¯å€ºåŠ¡åˆ†æ

#### âœ… ä½æŠ€æœ¯å€ºåŠ¡æ–¹æ¡ˆ
1. **RedisæŒä¹…åŒ–é…ç½®** - æ ‡å‡†é…ç½®ï¼Œæ— å€ºåŠ¡
2. **å¢å¼ºå¥åº·æ£€æŸ¥** - ä»…è¯»å–çŠ¶æ€ï¼Œæ— å€ºåŠ¡
3. **è½»é‡çº§ç›‘æ§** - æ— å¤–éƒ¨ä¾èµ–ï¼Œä½å€ºåŠ¡

#### âš ï¸ ä¸­ç­‰æŠ€æœ¯å€ºåŠ¡æ–¹æ¡ˆ
1. **systemdæœåŠ¡** - éœ€è¦ç³»ç»Ÿæƒé™ï¼Œå¢åŠ éƒ¨ç½²å¤æ‚åº¦
2. **è‡ªç ”ç›‘æ§å¹³å°** - éœ€è¦æŒç»­ç»´æŠ¤

#### âŒ é«˜æŠ€æœ¯å€ºåŠ¡æ–¹æ¡ˆ
1. **ä¸“ä¸šç›‘æ§å¹³å°** - ä¾èµ–å¤–éƒ¨æœåŠ¡ï¼Œè¿ç§»æˆæœ¬é«˜
2. **å¤æ‚çš„ç›‘æ§ç³»ç»Ÿ** - ç»´æŠ¤æˆæœ¬é«˜ï¼Œå­¦ä¹ æ›²çº¿é™¡

---

## ğŸ“Š å››ã€æˆæœ¬æ”¶ç›Šåˆ†ææ€»ç»“

### 4.1 é‡åŒ–å¯¹æ¯”

| æ–¹æ¡ˆ | å¼€å‘æ—¶é—´ | ç»´æŠ¤æ—¶é—´/æœˆ | è¿è¡Œæˆæœ¬/æœˆ | æ”¶ç›Šè¯„åˆ† | ROI |
|------|----------|-------------|-------------|----------|-----|
| RedisæŒä¹…åŒ– | 0.5h | 0h | $0 | â­â­â­â­â­ | âˆ |
| è¿æ¥æ± ç›‘æ§ | 2h | 0.5h | $0 | â­â­â­â­ | é«˜ |
| è½»é‡çº§ç›‘æ§ | 4h | 1h | $0 | â­â­â­ | ä¸­ |
| systemdæœåŠ¡ | 1h | 0h | $0 | â­â­ | ä½ |
| ä¸“ä¸šç›‘æ§ | 40h | 8h | $50 | â­â­â­â­ | ä½ |

### 4.2 æœ€ç»ˆå»ºè®®

#### âœ… ç«‹å³å®æ–½ï¼ˆå¿…éœ€ï¼‰
1. **RedisæŒä¹…åŒ–é…ç½®**
   - æˆæœ¬ï¼š30åˆ†é’Ÿ
   - æ”¶ç›Šï¼šæ•°æ®å®‰å…¨ä¿éšœ
   - é£é™©ï¼šæä½

2. **å¥åº·æ£€æŸ¥å¢å¼º**
   - æˆæœ¬ï¼š1å°æ—¶
   - æ”¶ç›Šï¼šå¯è§æ€§æå‡
   - é£é™©ï¼šæ— 

#### ğŸŸ¡ å¯é€‰å®æ–½ï¼ˆå»ºè®®ï¼‰
3. **æ•°æ®åº“è¿æ¥æ± ç›‘æ§**
   - æˆæœ¬ï¼š2å°æ—¶
   - æ”¶ç›Šï¼šæ€§èƒ½é—®é¢˜é¢„è­¦
   - é£é™©ï¼šä½

4. **è½»é‡çº§ç›‘æ§å‘Šè­¦**
   - æˆæœ¬ï¼š4å°æ—¶
   - æ”¶ç›Šï¼šä¸»åŠ¨å‘ç°é—®é¢˜
   - é£é™©ï¼šä½

#### ğŸ”´ æš‚ä¸å®æ–½ï¼ˆå½“å‰é˜¶æ®µï¼‰
5. **systemdæœåŠ¡**
   - åŸå› ï¼šPM2å·²è¶³å¤Ÿ
   - ä½•æ—¶å®æ–½ï¼šæœ‰ç‰¹æ®Šéœ€æ±‚æ—¶

6. **ä¸“ä¸šç›‘æ§å¹³å°**
   - åŸå› ï¼šæˆæœ¬è¾ƒé«˜ï¼Œå½“å‰é˜¶æ®µè¿‡åº¦
   - ä½•æ—¶å®æ–½ï¼šä¸šåŠ¡è§„æ¨¡æ‰©å¤§å

---

## ğŸ“ äº”ã€å­¦ä¹ æˆæœ¬åˆ†æ

### 5.1 æ–°äººå­¦ä¹ æ—¶é—´

| æŠ€æœ¯ | åŸºç¡€å­¦ä¹  | ç†Ÿç»ƒæŒæ¡ | æ–‡æ¡£è´¨é‡ | ç¤¾åŒºæ”¯æŒ |
|------|----------|----------|----------|----------|
| RedisæŒä¹…åŒ– | 1å¤© | 3å¤© | â­â­â­â­â­ | â­â­â­â­â­ |
| Sequelize Pool | 2å¤© | 5å¤© | â­â­â­â­ | â­â­â­â­ |
| PM2 | 1å¤© | 2å¤© | â­â­â­â­ | â­â­â­â­ |
| Prometheus | 5å¤© | 15å¤© | â­â­â­â­ | â­â­â­â­ |
| systemd | 3å¤© | 7å¤© | â­â­â­ | â­â­â­ |

### 5.2 å›¢é˜Ÿèƒ½åŠ›è¦æ±‚

**RedisæŒä¹…åŒ–é…ç½®**ï¼š
- éœ€è¦ï¼šåŸºæœ¬LinuxçŸ¥è¯†
- éš¾åº¦ï¼šâ­ï¼ˆæä½ï¼‰
- æ–‡æ¡£ï¼šRediså®˜æ–¹æ–‡æ¡£å³å¯

**æ•°æ®åº“è¿æ¥æ± ç›‘æ§**ï¼š
- éœ€è¦ï¼šNode.js + Sequelize
- éš¾åº¦ï¼šâ­â­ï¼ˆä½ï¼‰
- æ–‡æ¡£ï¼šSequelizeæ–‡æ¡£

**è½»é‡çº§ç›‘æ§**ï¼š
- éœ€è¦ï¼šNode.js + Express
- éš¾åº¦ï¼šâ­â­ï¼ˆä½ï¼‰
- æ–‡æ¡£ï¼šé¡¹ç›®è‡ªå¸¦ä»£ç æ³¨é‡Š

**ä¸“ä¸šç›‘æ§å¹³å°**ï¼š
- éœ€è¦ï¼šè¿ç»´çŸ¥è¯† + å¹³å°ç‰¹å®šçŸ¥è¯†
- éš¾åº¦ï¼šâ­â­â­â­ï¼ˆé«˜ï¼‰
- æ–‡æ¡£ï¼šå¹³å°å®˜æ–¹æ–‡æ¡£ + åŸ¹è®­

---

## ğŸ’¡ å…­ã€æ ¸å¿ƒç»“è®º

### âœ… å»ºè®®å®æ–½ï¼ˆé«˜æ€§ä»·æ¯”ï¼‰

**1. RedisæŒä¹…åŒ–é…ç½® - å¿…é¡»å®æ–½**
- â±ï¸ æˆæœ¬ï¼š30åˆ†é’Ÿ
- ğŸ’° è´¹ç”¨ï¼š$0
- ğŸ¯ æ”¶ç›Šï¼šæ•°æ®å®‰å…¨ä¿éšœ
- ğŸ“ ç»´æŠ¤ï¼šæ— éœ€ç»´æŠ¤
- **å»ºè®®**ï¼šç«‹å³é…ç½®AOFæŒä¹…åŒ–

**2. å¥åº·æ£€æŸ¥å¢å¼º - å¼ºçƒˆå»ºè®®**
- â±ï¸ æˆæœ¬ï¼š1-2å°æ—¶
- ğŸ’° è´¹ç”¨ï¼š$0
- ğŸ¯ æ”¶ç›Šï¼šç›‘æ§å¯è§æ€§æå‡
- ğŸ“ ç»´æŠ¤ï¼šæä½
- **å»ºè®®**ï¼šæ·»åŠ è¿æ¥æ± çŠ¶æ€åˆ°/healthç«¯ç‚¹

**3. è½»é‡çº§ç›‘æ§ - å»ºè®®å®æ–½**
- â±ï¸ æˆæœ¬ï¼š2-4å°æ—¶
- ğŸ’° è´¹ç”¨ï¼š$0
- ğŸ¯ æ”¶ç›Šï¼šä¸»åŠ¨å‘ç°é—®é¢˜
- ğŸ“ ç»´æŠ¤ï¼šä½
- **å»ºè®®**ï¼šå®æ–½ç®€å•çš„ç›‘æ§è„šæœ¬

### âŒ æš‚ä¸å®æ–½ï¼ˆå½“å‰é˜¶æ®µè¿‡åº¦ï¼‰

**4. systemdæœåŠ¡ - éå¿…éœ€**
- **åŸå› **ï¼šPM2å·²æä¾›å®Œæ•´å®ˆæŠ¤è¿›ç¨‹åŠŸèƒ½
- **ä½•æ—¶éœ€è¦**ï¼šæœ‰ç‰¹æ®Šçš„ç³»ç»Ÿçº§é›†æˆéœ€æ±‚æ—¶

**5. ä¸“ä¸šç›‘æ§å¹³å° - ä¸šåŠ¡æˆç†Ÿå**
- **åŸå› **ï¼šæˆæœ¬è¾ƒé«˜ï¼Œå½“å‰é˜¶æ®µè¿‡åº¦è®¾è®¡
- **ä½•æ—¶éœ€è¦**ï¼šç”¨æˆ·é‡>10000ï¼ŒQPS>100ï¼Œæœ‰è¿ç»´é¢„ç®—æ—¶

---

## ğŸš€ ä¸ƒã€è¡ŒåŠ¨è®¡åˆ’

### ç«‹å³æ‰§è¡Œï¼ˆæœ¬å‘¨å®Œæˆï¼‰

```bash
# 1. RedisæŒä¹…åŒ–é…ç½®ï¼ˆ30åˆ†é’Ÿï¼‰
sudo vim /etc/redis/redis.conf
# å¯ç”¨ï¼šappendonly yes, appendfsync everysec
sudo systemctl restart redis-server
redis-cli CONFIG GET appendonly

# 2. å¢å¼ºå¥åº·æ£€æŸ¥ï¼ˆ1å°æ—¶ï¼‰
# ä¿®æ”¹ app.jsï¼Œæ·»åŠ è¿æ¥æ± çŠ¶æ€

# 3. æ·»åŠ ç›‘æ§è„šæœ¬ï¼ˆå¯é€‰ï¼Œ2å°æ—¶ï¼‰
# åˆ›å»º scripts/simple-monitor.js
npm run monitor:check
```

### çŸ­æœŸä¼˜åŒ–ï¼ˆæœ¬æœˆå®Œæˆï¼‰

```bash
# 4. æ€§èƒ½ç›‘æ§ä¼˜åŒ–
npm run monitor:db

# 5. æ–‡æ¡£æ›´æ–°
# æ›´æ–°è¿ç»´æ–‡æ¡£ï¼Œè®°å½•é…ç½®å˜æ›´
```

### é•¿æœŸè§„åˆ’ï¼ˆå­£åº¦è§„åˆ’ï¼‰

- **Q1**ï¼šç»§ç»­ä½¿ç”¨è½»é‡çº§æ–¹æ¡ˆ
- **Q2**ï¼šè¯„ä¼°ä¸šåŠ¡è§„æ¨¡ï¼Œå†³å®šæ˜¯å¦å‡çº§ç›‘æ§
- **Q3**ï¼šæ ¹æ®å®é™…éœ€æ±‚ï¼Œè€ƒè™‘ä¸“ä¸šç›‘æ§å¹³å°

---

## ğŸ“ å…«ã€é™„å½•ï¼šå‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£
- [RedisæŒä¹…åŒ–](https://redis.io/docs/management/persistence/)
- [Sequelizeè¿æ¥æ± ](https://sequelize.org/docs/v6/other-topics/connection-pool/)
- [PM2æ–‡æ¡£](https://pm2.keymetrics.io/docs/usage/quick-start/)

### å¤§å‚å®è·µ
- é˜¿é‡Œäº‘ARMSï¼šhttps://www.aliyun.com/product/arms
- è…¾è®¯äº‘ç›‘æ§ï¼šhttps://cloud.tencent.com/product/cm
- ç¾å›¢CATï¼šhttps://github.com/dianping/cat

### å¼€æºæ–¹æ¡ˆ
- Prometheusï¼šhttps://prometheus.io/
- Grafanaï¼šhttps://grafana.com/
- Node.js Exporterï¼šhttps://github.com/siimon/prom-client

---

**ç”Ÿæˆæ—¶é—´**ï¼š2025å¹´11æœˆ24æ—¥ åŒ—äº¬æ—¶é—´  
**ä¸‹æ¬¡å®¡æ ¸**ï¼šæ ¹æ®ä¸šåŠ¡å‘å±•æƒ…å†µï¼Œå»ºè®®3ä¸ªæœˆåé‡æ–°è¯„ä¼°

