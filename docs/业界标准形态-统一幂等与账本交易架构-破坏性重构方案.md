# ä¸šç•Œæ ‡å‡†å½¢æ€ï¼šç»Ÿä¸€å¹‚ç­‰ä¸è´¦æœ¬/äº¤æ˜“æ¶æ„ï¼ˆç ´åæ€§é‡æ„æ–¹æ¡ˆï¼‰

**é€‚ç”¨é¡¹ç›®**ï¼šé¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿï¼ˆåç«¯æœåŠ¡ï¼‰  
**ç›®æ ‡**ï¼šåœ¨ä¸æ”¹å˜ä¸šåŠ¡åŠŸèƒ½çš„å‰æä¸‹ï¼Œç›´æ¥ç ´åæ€§å‡çº§åˆ°â€œä¸šç•Œæ ‡å‡†å½¢æ€â€ï¼šè¯­ä¹‰ç»Ÿä¸€ã€çœŸç›¸æºå”¯ä¸€ã€å¹¶å‘å¯å¹‚ç­‰ã€å¯å¯¹è´¦å¯å®¡è®¡ã€‚  
**æ˜ç¡®ä¸åš**ï¼šä¸å…¼å®¹æ—§æ¥å£ã€ä¸åšè¿‡æ¸¡/åŒå†™ã€ä¸ä¿ç•™æ—§è¡¨/æ—§æ•°æ®ã€ä¸è€ƒè™‘æ—§å®¢æˆ·ç«¯ä»èƒ½è·‘ã€‚

---

## ä¸€ã€ä½ çš„ä¸šåŠ¡å±äºå“ªä¸€ç±»ç³»ç»Ÿï¼Ÿæœ€é€‚åˆå“ªç§ä¸šç•Œæ–¹æ¡ˆï¼Ÿ

ä½ çš„ç³»ç»Ÿæœ¬è´¨æ˜¯â€œ**æ¸¸æˆåŒ–ç»æµç³»ç»Ÿ + è™šæ‹Ÿèµ„äº§/ç§¯åˆ†è´¦æœ¬ + äº¤æ˜“/å…‘æ¢/æŠ½å¥–æ´»åŠ¨**â€ï¼Œå…¸å‹é£é™©ç‚¹æ˜¯ï¼š

- é‡è¯•/å¹¶å‘å¯¼è‡´ **é‡å¤æ‰£å‡/é‡å¤å‘æ”¾/é‡å¤å‘è´§**
- èµ„äº§ä¸è®¢å•æ— æ³•å¯¹è´¦ï¼ˆä¸çŸ¥é“æŸç¬”å˜åŠ¨æ¥è‡ªå“ªä¸ªä¸šåŠ¡åŠ¨ä½œï¼‰
- ç‰©å“æ‰€æœ‰æƒçŠ¶æ€ä¸ä¸€è‡´ï¼ˆä¸Šæ¶ã€é”å®šã€æˆäº¤ã€å›æ»šï¼‰

åœ¨ç¾å›¢/é˜¿é‡Œ/è…¾è®¯ã€æ¸¸æˆå…¬å¸ã€äºŒæ‰‹/è™šæ‹Ÿç‰©å“äº¤æ˜“å¹³å°é‡Œï¼Œè¿™ç±»ç³»ç»Ÿçš„å…±åŒâ€œç¨³å®šè§£æ³•â€åªæœ‰ä¸‰æ¡åŸåˆ™ï¼š

- **çœŸç›¸æºå”¯ä¸€**ï¼šä½™é¢çœŸç›¸ã€æµæ°´çœŸç›¸ã€ç‰©å“æ‰€æœ‰æƒçœŸç›¸ã€è®¢å•çŠ¶æ€çœŸç›¸å¿…é¡»å”¯ä¸€ã€‚
- **å†™å…¥å¤©ç„¶å¹‚ç­‰**ï¼šæ‰€æœ‰ä¼šæ‰£æ¬¾/å‘è´§/å‘å¥–/ä¸Šæ¶/è´­ä¹°çš„å†™å…¥å¿…é¡»å¯é‡è¯•ï¼Œä¸”å¹¶å‘ä¸‹åªèƒ½ç”Ÿæ•ˆä¸€æ¬¡ã€‚
- **è´¦æœ¬ä¸å¯ç¯¡æ”¹**ï¼šä»·å€¼å˜åŠ¨å¿…é¡»è¿½åŠ ä¸å¯å˜æµæ°´ï¼Œä¿è¯å®¡è®¡ä¸å¯¹è´¦ã€‚

ç»“åˆä½ å½“å‰æ˜¯**å•ä½“åç«¯ + å• MySQLï¼ˆå¼ºäº‹åŠ¡ï¼‰**çš„ç°å®ï¼Œæœ€é€‚åˆçš„æ–¹æ¡ˆä¸æ˜¯ä¸Šåˆ†å¸ƒå¼å¤æ‚åº¦ï¼Œè€Œæ˜¯ï¼š

> **å•åº“å¼ºä¸€è‡´ + æ•°æ®åº“å”¯ä¸€çº¦æŸå…œåº• + ç»Ÿä¸€å¹‚ç­‰å±‚ + ç»Ÿä¸€è´¦æœ¬å±‚ + ä¸¥æ ¼çŠ¶æ€æœº**

è¿™æ˜¯â€œå°å…¬å¸å¯è½åœ°çš„å·¥ä¸šæ ‡å‡†â€ï¼ŒåŒæ—¶ä¹Ÿç¬¦åˆå¤§å‚/æ¸¸æˆå…¬å¸åœ¨å•åœ°åŸŸå•åº“é˜¶æ®µçš„é€šè¡Œåšæ³•ã€‚

---

## äºŒã€ç»Ÿä¸€çœŸç›¸æºï¼ˆSingle Source of Truthï¼‰ï¼šæœ€ç»ˆé¢†åŸŸåˆ’åˆ†

### 2.1 ä»·å€¼ä½“ç³»ï¼ˆç§¯åˆ†/ææ–™/DIAMOND/é¢„ç®—ç§¯åˆ†ï¼‰

- **ä½™é¢çœŸç›¸**ï¼š`account_asset_balances`ï¼ˆè´¦æˆ·-èµ„äº§ç»´åº¦çš„ä½™é¢å¿«ç…§ï¼‰
- **æµæ°´çœŸç›¸**ï¼š`asset_transactions`ï¼ˆä¸å¯å˜è´¦æœ¬ï¼›ä»»ä½•ä»·å€¼å˜åŠ¨éƒ½å¿…é¡»è½æµæ°´ï¼‰

### 2.2 ç‰©å“æ‰€æœ‰æƒï¼ˆä¸å¯å åŠ ç‰©å“ï¼‰

- **æ‰€æœ‰æƒçœŸç›¸**ï¼š`item_instances`ï¼ˆownerã€status æ˜¯å”¯ä¸€çœŸç›¸ï¼‰
- **äº‹ä»¶å®¡è®¡ï¼ˆå¯é€‰ï¼‰**ï¼š`item_instance_events`ï¼ˆç”¨äºå®¡è®¡/è¿½è´£/å›æ”¾ï¼›è‹¥ä¿ç•™åˆ™å¿…é¡»å¼ºå¹‚ç­‰ï¼‰

### 2.3 äº¤æ˜“å¸‚åœºï¼ˆC2Cï¼‰

- **æŒ‚ç‰ŒçœŸç›¸**ï¼š`market_listings`ï¼ˆæŒ‚ç‰ŒçŠ¶æ€æœºï¼‰
- **è®¢å•çœŸç›¸**ï¼š`trade_orders`ï¼ˆäº¤æ˜“è®¢å•çŠ¶æ€æœºï¼‰
- **ç»“ç®—çœŸç›¸**ï¼šå…¨éƒ¨èµ° `asset_transactions`ï¼ˆå†»ç»“/è§£å†»/ç»“ç®—ä¸‰æ®µå¼ï¼‰

### 2.4 å®˜æ–¹å…‘æ¢ï¼ˆB2Cï¼‰

- **è®¢å•çœŸç›¸**ï¼š`exchange_records`
- **æ‰£å‡çœŸç›¸**ï¼šå…¨éƒ¨èµ° `asset_transactions`

### 2.5 æŠ½å¥–æ´»åŠ¨

- **æŠ½å¥–è®°å½•çœŸç›¸**ï¼š`lottery_draws`
- **æ‰£å‡/å‘æ”¾çœŸç›¸**ï¼šå…¨éƒ¨èµ° `asset_transactions`

---

## ä¸‰ã€ç»Ÿä¸€å¹‚ç­‰ï¼šæœ€ç»ˆåªä¿ç•™ä¸€ç§æ¥å£è¯­ä¹‰

### 3.1 API å¥‘çº¦ï¼ˆç ´åæ€§ï¼šå…¨é‡ç»Ÿä¸€ï¼‰

**å¼ºåˆ¶è§„åˆ™**ï¼ˆæ‰€æœ‰å†™æ¥å£ä¸€è‡´ï¼ŒPOST/PUT/PATCH/DELETEï¼‰ï¼š

- å®¢æˆ·ç«¯ **å¿…é¡»** ä¼  `Idempotency-Key`ï¼ˆHTTP Headerï¼‰
- ä¸å†æ¥å— body é‡Œçš„ `business_id`/`idempotency_key`ï¼ˆåˆ æ‰å‚æ•°ï¼Œç»Ÿä¸€å…¥å£ï¼‰
- æœåŠ¡ç«¯ä¸å…œåº•ç”Ÿæˆå¹‚ç­‰é”®ï¼šç¼ºå¤±å³ 400

**å†²çªä¸å›æ”¾è§„åˆ™**ï¼ˆç»Ÿä¸€è¿”å›è¯­ä¹‰ï¼‰ï¼š

- **é¦–æ¬¡æˆåŠŸ**ï¼šè¿”å›ä¸šåŠ¡ç»“æœ
- **å¹‚ç­‰å›æ”¾**ï¼ˆåŒ key åŒå‚æ•°é‡è¯•ï¼‰ï¼šè¿”å›é¦–æ¬¡ä¸šåŠ¡ç»“æœï¼Œå¹¶å¸¦ `is_duplicate: true`
- **å¹‚ç­‰å†²çª**ï¼ˆåŒ key ä¸åŒå‚æ•°ï¼‰ï¼šè¿”å› 409
- **å¤„ç†ä¸­é‡å¤è¯·æ±‚**ï¼šè¿”å› 409ï¼ˆæˆ–ç»Ÿä¸€ 202 + è½®è¯¢æ–¹æ¡ˆï¼Œä½†å¿…é¡»å…¨å±€ä¸€è‡´ï¼›å»ºè®® 409 ç®€æ´ï¼‰

### 3.2 å¹‚ç­‰â€œæƒå¨çœŸç›¸æºâ€ï¼ˆç»Ÿä¸€å¹‚ç­‰è¡¨ï¼‰

ç»Ÿä¸€ç”¨ä¸€å¼ è¡¨æ‰¿è½½è¯·æ±‚å¹‚ç­‰ï¼ˆå»ºè®®å‘½åä¸º `idempotency_requests`ï¼Œä¹Ÿå¯æ²¿ç”¨ `api_idempotency_requests` ä½†è¯­ä¹‰åº”å‡çº§ä¸ºâ€œå…¨ä¸šåŠ¡å†™å…¥å¹‚ç­‰â€ï¼‰ï¼š

- `scope`ï¼šå¹‚ç­‰ä½œç”¨åŸŸï¼ˆå»ºè®®è‡³å°‘åŒ…å« endpoint/ä¸šåŠ¡åŠ¨ä½œï¼›ä¹Ÿå¯åŒ…å« user_idï¼‰
- `idempotency_key`ï¼šå®¢æˆ·ç«¯æä¾›
- `request_fingerprint`ï¼šå‚æ•°æŒ‡çº¹ï¼ˆç”¨äºæ£€æµ‹åŒ key ä¸åŒå‚æ•° â†’ 409ï¼‰
- `status`ï¼šprocessing/completed/failed
- `result_snapshot`ï¼šå®Œæˆåçš„ä¸šåŠ¡ç»“æœå¿«ç…§ï¼ˆç”¨äºå›æ”¾ï¼‰
- `entity_ref_type/entity_ref_id`ï¼šæœ¬æ¬¡å†™å…¥å½±å“çš„ä¸šåŠ¡å®ä½“å¼•ç”¨ï¼ˆè®¢å•IDã€æŠ½å¥–ä¼šè¯IDç­‰ï¼‰

> Stripe/ç¾å›¢å¼å¹‚ç­‰æœ¬è´¨å°±æ˜¯ï¼šKey + Fingerprint + State + Replayã€‚

### 3.3 å¹¶å‘å®‰å…¨çš„â€œåº•çº¿è§„åˆ™â€

æ— è®ºåº”ç”¨å±‚å¦‚ä½•å†™ï¼Œ**å¹¶å‘çª—å£æ°¸è¿œå­˜åœ¨**ã€‚ä¸šç•Œæ ‡å‡†çš„åº•çº¿æ˜¯ï¼š

- å…³é”®ä¸šåŠ¡è¡¨å¿…é¡»æœ‰ **UNIQUE å…œåº•**ï¼ˆå¦åˆ™å¹¶å‘é‡è¯•å¿…ç„¶äº§ç”Ÿé‡å¤ï¼‰
- åº”ç”¨å±‚æ•è·å”¯ä¸€å†²çªåå›æŸ¥å¹¶å›æ”¾ï¼ˆè€Œä¸æ˜¯æŠŠ DB é”™è¯¯ç›´æ¥æŠ›ç»™ç”¨æˆ·ï¼‰

---

## å››ã€æ•°æ®æ¨¡å‹è¯­ä¹‰ç»Ÿä¸€ï¼šåªä¿ç•™ä¸€ä¸ªå¹‚ç­‰å­—æ®µå

ä½ ç°åœ¨åŒæ—¶å­˜åœ¨ `business_id` ä¸ `idempotency_key` ä¸¤å¥—å‘½åï¼Œä¼šé•¿æœŸæ±¡æŸ“è¯­ä¹‰ã€‚ç ´åæ€§é‡æ„çš„æ¨èæ˜¯ï¼š

### 4.1 ç»Ÿä¸€å­—æ®µåï¼š`idempotency_key`

- æ‰€æœ‰ä¸šåŠ¡è¡¨çš„å¹‚ç­‰é”®ç»Ÿä¸€å‘½åä¸º `idempotency_key`
- `business_id` æ¦‚å¿µä»ç³»ç»Ÿä¸­æ¶ˆå¤±
- ä¸šåŠ¡å•å·/å±•ç¤ºç¼–å·ç»§ç»­ä½¿ç”¨ `order_no`ã€`listing_id`ã€`draw_id` ç­‰ä¸šåŠ¡å­—æ®µæ‰¿æ‹…

### 4.2 å„è¡¨æœ€ç»ˆçº¦æŸå£å¾„ï¼ˆå¿…é¡»æ»¡è¶³ï¼‰

#### `asset_transactions`

- `idempotency_key`ï¼šNOT NULL + UNIQUEï¼ˆå…¨å±€å”¯ä¸€ï¼‰
- `business_type`ï¼šNOT NULLï¼ˆåˆ†ç±»/å®¡è®¡/ç»Ÿè®¡ï¼‰
- `meta`ï¼šJSONï¼ˆè®°å½•è®¢å•/æŒ‚ç‰Œ/æŠ½å¥–/æ¶ˆè´¹å®¡æ ¸çš„å¼•ç”¨ä¿¡æ¯ï¼‰
- è§„åˆ™ï¼šä¸å¯æ›´æ–°ï¼Œåªè¿½åŠ 

#### `trade_orders` / `market_listings` / `exchange_records` / `consumption_records` / `lottery_draws`

- `idempotency_key`ï¼šNOT NULL + UNIQUEï¼ˆè¡¨å†…å”¯ä¸€ï¼›å»ºè®®å…¨å±€å”¯ä¸€ä¹Ÿå¯ï¼Œä½†è¡¨å†…å”¯ä¸€æ˜¯åº•çº¿ï¼‰
- çŠ¶æ€å­—æ®µï¼šå¿…é¡»æ˜¯ä¸¥æ ¼çŠ¶æ€æœºï¼ˆç»ˆæ€ä¸å¯é€†ï¼‰
- ä¸è´¦æœ¬å…³è”ï¼šé€šè¿‡ `meta`ï¼ˆæˆ–æ˜¾å¼ ref å­—æ®µï¼‰èƒ½è¿½æº¯åˆ°ç›¸å…³æµæ°´

#### `item_instance_events`ï¼ˆå¦‚æœä¿ç•™ï¼‰

- `idempotency_key`ï¼šNOT NULLï¼ˆå¼ºåˆ¶ï¼‰
- UNIQUEï¼šå»ºè®® `(item_instance_id, idempotency_key)`ï¼ˆæ›´è´´è¿‘â€œå¯¹æŸç‰©å“çš„åŠ¨ä½œå¹‚ç­‰â€ï¼‰

---

## äº”ã€å¤§å‚/å°å‚/æ¸¸æˆå…¬å¸/äº¤æ˜“å¹³å°çš„å·®å¼‚ä¸å–èˆ

### 5.1 å¤§å‚ï¼ˆç¾å›¢/é˜¿é‡Œ/è…¾è®¯ï¼‰

å…¸å‹åšæ³•ï¼ˆé€‚åˆå¤šå›¢é˜Ÿ/åˆ†å¸ƒå¼/å¤šæœºæˆ¿ï¼‰ï¼š

- å¹‚ç­‰ï¼šç½‘å…³+å¹‚ç­‰æœåŠ¡+DBå…œåº•
- è´¦åŠ¡ï¼šç‹¬ç«‹è´¦åŠ¡ç³»ç»Ÿï¼ˆLedger Serviceï¼‰ï¼Œå¼ºå®¡è®¡å¼ºå¯¹è´¦
- ä¸€è‡´æ€§ï¼šSAGA/Outbox/æ¶ˆæ¯é˜Ÿåˆ—é©±åŠ¨

å¯¹ä½ å½“å‰é˜¶æ®µçš„ç»“è®ºï¼š**åŸåˆ™è¦å­¦ï¼Œå·¥ç¨‹å½¢æ€ä¸å¿…ç…§æ¬**ï¼ˆä¼šå¾’å¢å¤æ‚åº¦ï¼‰ã€‚

### 5.2 å°å…¬å¸ï¼ˆä½ ç°åœ¨æœ€åŒ¹é…ï¼‰

å…¸å‹åšæ³•ï¼ˆå•ä½“/å•åº“/è¿½æ±‚ç¨³å®šï¼‰ï¼š

- å¹‚ç­‰ï¼šç»Ÿä¸€å¹‚ç­‰è¡¨ + å”¯ä¸€çº¦æŸå…œåº•
- è´¦æœ¬ï¼šä½™é¢å¿«ç…§ + ä¸å¯å˜æµæ°´
- äº¤æ˜“ï¼šä¸¥æ ¼çŠ¶æ€æœº + å®šæ—¶ä»»åŠ¡å¤„ç†è¶…æ—¶/å›æ»š

### 5.3 æ¸¸æˆå…¬å¸ï¼ˆä¸ä½ ä¸šåŠ¡æœ€ç›¸ä¼¼ï¼‰

å…¸å‹åšæ³•ï¼š

- èµ„äº§è´¦æœ¬ä¸ºä¸­å¿ƒï¼ˆé‡‘å¸/é’»çŸ³/ææ–™/ç§¯åˆ†ï¼‰
- ç‰©å“æ‰€æœ‰æƒä¸ºä¸­å¿ƒï¼ˆå®ä¾‹è¡¨ï¼‰
- æ´»åŠ¨/æŠ½å¥–ä½œä¸ºâ€œç»“ç®—æŒ‡ä»¤â€ï¼Œæœ€ç»ˆéƒ½è½è´¦æœ¬æµæ°´

å¯¹ä½ é¡¹ç›®çš„ç»“è®ºï¼š**ä½ æœ€è¯¥å¯¹é½çš„æ˜¯æ¸¸æˆå…¬å¸çš„è´¦æœ¬ä¸å¹‚ç­‰çºªå¾‹**ï¼Œè€Œä¸æ˜¯ä¼ ç»Ÿç”µå•†çš„å¤æ‚å±¥çº¦é“¾è·¯ã€‚

### 5.4 äºŒæ‰‹/è™šæ‹Ÿç‰©å“äº¤æ˜“å¹³å°

å…¸å‹åšæ³•ï¼š

- æŒ‚ç‰Œ/è®¢å•çŠ¶æ€æœºä¸¥æ ¼
- æ”¯ä»˜/ç»“ç®—ä¸‰æ®µå¼ï¼šå†»ç»“â†’ç»“ç®—â†’è§£å†»/å›æ»š
- æ‰€æœ‰å…³é”®åŠ¨ä½œå¹‚ç­‰ï¼ˆä¸‹å•ã€æ‰£æ¬¾ã€å‘è´§ç¡®è®¤ã€é€€æ¬¾ï¼‰

---

## å…­ã€ä¸ºä»€ä¹ˆè¿™å¥—æ–¹æ¡ˆæœ€é€‚åˆä½ ï¼Ÿ

1. **ä¸ä½ å½“å‰æŠ€æœ¯æ ˆåŒ¹é…**ï¼šå•ä½“ Node + MySQL æœ€æ“…é•¿åšå¼ºäº‹åŠ¡ä¸å”¯ä¸€çº¦æŸå…œåº•ã€‚
2. **æ»¡è¶³ä½ æœ€æ ¸å¿ƒé£é™©æ§åˆ¶**ï¼šé‡å¤æ‰£æ¬¾/é‡å¤å‘è´§/é‡å¤å‘å¥–åœ¨è¿™ä¸€å¥—ä¸‹æ˜¯â€œç»“æ„æ€§ä¸å¯å‘ç”Ÿâ€ã€‚
3. **è¯­ä¹‰æ›´å¹²å‡€**ï¼šä¸€ä¸ªå¹‚ç­‰å…¥å£ï¼ˆIdempotency-Keyï¼‰ã€ä¸€ä¸ªå¹‚ç­‰å­—æ®µåï¼ˆidempotency_keyï¼‰ã€ä¸€å¥—å›æ”¾è§„åˆ™ã€‚
4. **å¯¹è´¦å¯è§£é‡Š**ï¼šä»»ä½•ä½™é¢å˜åŒ–éƒ½èƒ½ä»æµæ°´è¿½æº¯åˆ°ä¸šåŠ¡å•æ®ä¸å¹‚ç­‰é”®ã€‚
5. **ä¸ºæœªæ¥æ‰©å±•ç•™å£å­**ï¼šç­‰ä½ è¦æ‹†åˆ†æœåŠ¡æ—¶ï¼Œè¿™å¥—é¢†åŸŸè¾¹ç•Œä¸çœŸç›¸æºåˆ’åˆ†å°±æ˜¯å¤©ç„¶æ‹†åˆ†ç‚¹ã€‚

---

## ä¸ƒã€ç ´åæ€§æ”¹é€ æ¸…å•ï¼ˆä¸åšè¿‡æ¸¡ï¼Œç›´æ¥åˆ‡æ¢ï¼‰

> è¿™é‡Œåªç»™æœ€ç»ˆåŠ¨ä½œç±»åˆ«ä¸éªŒæ”¶å£å¾„ï¼ˆä¸åŒ…å«å¤‡ä»½ã€Gitã€å‰ç«¯æ”¹é€ ç»†èŠ‚ï¼‰ã€‚

### 7.1 APIï¼ˆç ´åæ€§å¥‘çº¦å˜æ›´ï¼‰

- æ‰€æœ‰å†™æ¥å£ç»Ÿä¸€è¦æ±‚ `Idempotency-Key`ï¼ˆHeaderï¼‰
- åˆ é™¤æ‰€æœ‰ body ä¸­çš„å¹‚ç­‰å…¥å‚ï¼ˆ`business_id` / `idempotency_key`ï¼‰
- ç¼ºå¤± keyï¼š400ï¼›å†²çªï¼š409ï¼›å›æ”¾ï¼šè¿”å›é¦–æ¬¡ç»“æœ + `is_duplicate: true`

### 7.2 æ•°æ®åº“ï¼ˆç ´åæ€§è¡¨è¯­ä¹‰å˜æ›´ï¼‰

- ç»Ÿä¸€æŠŠå„ä¸šåŠ¡è¡¨çš„å¹‚ç­‰åˆ—æ”¹ä¸º `idempotency_key`ï¼Œå¹¶è®¾ç½® NOT NULL + UNIQUE
- åˆ é™¤æ‰€æœ‰ä¸â€œä»·å€¼å˜åŠ¨â€é‡å¤è¡¨è¾¾çš„æ—§è¡¨/æ—§è¯­ä¹‰ï¼ˆä»¥ `asset_transactions` ä¸ºå”¯ä¸€ä»·å€¼æµæ°´çœŸç›¸ï¼‰
- ä»»ä½•â€œæ‰£å‡/å‘æ”¾/ç»“ç®—/é€€æ¬¾â€å¿…é¡»ä¸ä¸šåŠ¡å•æ®çŠ¶æ€å˜æ›´åœ¨åŒä¸€äº‹åŠ¡å†…å®Œæˆ

### 7.3 æœåŠ¡è¾¹ç•Œï¼ˆç»Ÿä¸€çœŸç›¸æºè°ƒç”¨è·¯å¾„ï¼‰

- èµ„äº§åŸŸï¼šå”¯ä¸€å…¥å£è´Ÿè´£å†»ç»“/è§£å†»/ç»“ç®—/å˜æ›´ä½™é¢ï¼ˆå¯¹å¤–ä¸å¯ç»•å¼€ï¼‰
- å¸‚åœº/å…‘æ¢/æŠ½å¥–/æ¶ˆè´¹å®¡æ ¸ï¼šåªè´Ÿè´£çŠ¶æ€æœºä¸ä¸šåŠ¡è§„åˆ™ï¼Œä»·å€¼å˜åŠ¨å…¨éƒ¨å§”æ‰˜èµ„äº§åŸŸ

---

## å…«ã€å½“å‰é¡¹ç›®ç°çŠ¶ vs ç›®æ ‡æ ‡å‡†çš„å·®è·åˆ†æï¼ˆåŸºäºçœŸå®æ•°æ®åº“æ ¸æŸ¥ï¼‰

> **æ ¸æŸ¥æ–¹å¼**ï¼šNode.js/Sequelize ç›´è¿çœŸå®æ•°æ®åº“ `restaurant_points_dev @ dbconn.sealosbja.site:42569`ï¼ˆéå¤‡ä»½æ–‡ä»¶ã€éå†å²æŠ¥å‘Šï¼‰  
> **æ ¸æŸ¥æ—¶é—´**ï¼š2026-01-02  
> **ä¸šåŠ¡æ¨¡å¼ç¡®è®¤**ï¼šæ¶ˆè´¹å®¡æ ¸å‘æ”¾ç§¯åˆ†/é¢„ç®—ç§¯åˆ† + æŠ½å¥– + C2Cäº¤æ˜“å¸‚åœºï¼ˆæŒ‚ç‰Œ/è´­ä¹°/å†»ç»“ç»“ç®—ï¼‰+ B2Cå®˜æ–¹å…‘æ¢ï¼ˆææ–™èµ„äº§æ‰£å‡+å‘è´§ï¼‰

### 8.1 âœ… å·²ç»å¯¹é½çš„éƒ¨åˆ†ï¼ˆçœŸç›¸æºæ–¹å‘æ­£ç¡®ï¼‰

#### ä»·å€¼æµæ°´çœŸç›¸æºå·²å­˜åœ¨

- `asset_transactions.idempotency_key`ï¼š**NOT NULL + UNIQUE**ï¼ˆå…¨å±€å”¯ä¸€çº¦æŸå·²åˆ°ä½ï¼‰
- `asset_transactions.lottery_session_id`ï¼š**å…è®¸ NULL**ï¼ˆç¬¦åˆ"æŠ½å¥–å¤šåˆ†å½•å…³è”"çš„å¸¸è§åšæ³•ï¼‰
- âœ… ç»“è®ºï¼š**ä»·å€¼æµæ°´è´¦æœ¬çš„å¹‚ç­‰ä¸å…³è”æœºåˆ¶å·²ç¬¦åˆä¸šç•Œæ ‡å‡†**

#### ä¸šåŠ¡å•æ®æ™®éå…·å¤‡å¹‚ç­‰å­—æ®µ + å”¯ä¸€çº¦æŸ

çœŸå®æ•°æ®åº“æ ¸æŸ¥ç»“æœï¼ˆæ‰€æœ‰è¡¨å‡ä¸º **NOT NULL + UNIQUE**ï¼‰ï¼š

- `consumption_records.business_id`ï¼šæ¶ˆè´¹å®¡æ ¸è®°å½•å¹‚ç­‰
- `exchange_records.business_id`ï¼šå®˜æ–¹å…‘æ¢è®¢å•å¹‚ç­‰
- `market_listings.business_id`ï¼šå¸‚åœºæŒ‚ç‰Œå¹‚ç­‰ï¼ˆè¿˜æœ‰ `seller_user_id + business_id` è”åˆå”¯ä¸€ï¼‰
- `trade_orders.business_id`ï¼šäº¤æ˜“è®¢å•å¹‚ç­‰
- `lottery_draws.business_id`ï¼šæŠ½å¥–è®°å½•å¹‚ç­‰
- `trade_records.business_id`ï¼šäº¤æ˜“æµæ°´å¹‚ç­‰
- `admin_operation_logs.business_id`ï¼šç®¡ç†æ“ä½œå®¡è®¡å¹‚ç­‰

âœ… ç»“è®ºï¼š**å¹¶å‘é˜²é‡çš„æ•°æ®åº“å…œåº•æœºåˆ¶å·²åˆ°ä½**

#### è¯·æ±‚çº§å¹‚ç­‰è¡¨å·²å­˜åœ¨

- `api_idempotency_requests.idempotency_key`ï¼š**NOT NULL + UNIQUE**
- å½“å‰å·²ç”¨äºæŠ½å¥–è·¯ç”±ï¼ˆ`routes/v4/lottery/draw.js`ï¼‰

âœ… ç»“è®ºï¼š**è¯·æ±‚å¹‚ç­‰åŸºç¡€è®¾æ–½å·²å­˜åœ¨ï¼Œä½†è¦†ç›–é¢ä¸è¶³**

---

### 8.2 âš ï¸ ä¸»è¦å·®è·ï¼ˆç¦»"çœŸæ­£ä¸šç•Œæ ‡å‡†å½¢æ€"è¿˜å·®çš„æ ¸å¿ƒé—®é¢˜ï¼‰

#### å·®è· 1ï¼šå¹‚ç­‰å…¥å£è¯­ä¹‰ä¸ç»Ÿä¸€ï¼ˆå¤šå…¥å£å¹¶å­˜ï¼‰

**æ ‡å‡†è¦æ±‚**ï¼šæ‰€æœ‰å†™æ¥å£åªæ¥å— `Idempotency-Key`ï¼ˆHTTP Headerï¼‰ï¼Œç¼ºå¤±â†’400

**å½“å‰å®é™…æƒ…å†µ**ï¼ˆä»£ç æ‰«æ + è·¯ç”±åˆ†æï¼‰ï¼š

| è·¯ç”±æ–‡ä»¶                              | æ¥å— Header | æ¥å— Body business_id | æœåŠ¡ç«¯å…œåº•ç”Ÿæˆ       | ç»“è®º          |
| ------------------------------------- | ----------- | --------------------- | -------------------- | ------------- |
| `routes/v4/lottery/draw.js`           | âœ…          | âŒ                    | âœ…ï¼ˆç¼ºå¤±æ—¶è‡ªåŠ¨ç”Ÿæˆï¼‰ | ğŸ”´ ä¸ç¬¦åˆæ ‡å‡† |
| `routes/v4/market/buy.js`             | âœ…          | âœ…                    | âŒ                   | ğŸ”´ å¤šå…¥å£å¹¶å­˜ |
| `routes/v4/market/sell.js`            | âœ…          | âœ…                    | âŒ                   | ğŸ”´ å¤šå…¥å£å¹¶å­˜ |
| `routes/v4/shop/exchange/exchange.js` | âœ…          | âœ…ï¼ˆäºŒé€‰ä¸€ï¼‰          | âŒ                   | ğŸ”´ å¤šå…¥å£å¹¶å­˜ |
| `routes/v4/shop/assets/convert.js`    | âœ…          | âœ…                    | âŒ                   | ğŸ”´ å¤šå…¥å£å¹¶å­˜ |

**é‡åŒ–å·®è·**ï¼š

- å½“å‰å¹‚ç­‰å…¥å£ç»Ÿä¸€åº¦ï¼š**â‰ˆ30%**ï¼ˆ5ä¸ªå…³é”®å†™å…¥è·¯ç”±ä¸­ï¼Œ0ä¸ªå®Œå…¨ç¬¦åˆæ ‡å‡†ï¼‰
- ç›®æ ‡ï¼š**100%**ï¼ˆæ‰€æœ‰å†™å…¥è·¯ç”±ç»Ÿä¸€ Header onlyï¼Œç¼ºå¤±å³ 400ï¼‰

**ç ´åæ€§æ”¹é€ æ–¹æ¡ˆ**ï¼š

1. åˆ é™¤æ‰€æœ‰è·¯ç”±ä¸­ body çš„ `business_id` / `idempotency_key` å‚æ•°æ¥æ”¶é€»è¾‘
2. ç»Ÿä¸€ä» `req.headers['idempotency-key']` è·å–ï¼Œç¼ºå¤±ç›´æ¥è¿”å› 400
3. åˆ é™¤æŠ½å¥–è·¯ç”±çš„"æœåŠ¡ç«¯å…œåº•ç”Ÿæˆ"é€»è¾‘ï¼ˆ`IdempotencyHelper.generateRequestIdempotencyKey()`ï¼‰

---

#### å·®è· 2ï¼šå¹‚ç­‰å­—æ®µå‘½åæœªç»Ÿä¸€ï¼ˆåŒè¯­ä¹‰å¹¶å­˜ï¼‰

**æ ‡å‡†è¦æ±‚**ï¼šæ‰€æœ‰ä¸šåŠ¡è¡¨ç»Ÿä¸€ä½¿ç”¨ `idempotency_key`ï¼Œæ¶ˆç­ `business_id` æ¦‚å¿µ

**å½“å‰å®é™…æƒ…å†µ**ï¼ˆçœŸå®æ•°æ®åº“å­—æ®µæ ¸æŸ¥ï¼‰ï¼š

**ä½¿ç”¨ `idempotency_key` çš„è¡¨**ï¼ˆå°‘æ•°ï¼Œç¬¦åˆæ ‡å‡†ï¼‰ï¼š

- `asset_transactions.idempotency_key`ï¼ˆä»·å€¼æµæ°´ï¼‰
- `api_idempotency_requests.idempotency_key`ï¼ˆè¯·æ±‚å¹‚ç­‰ï¼‰
- `merchant_points_reviews.idempotency_key`ï¼ˆå•†æˆ·å®¡æ ¸ï¼‰

**ä»ä½¿ç”¨ `business_id` çš„æ ¸å¿ƒä¸šåŠ¡è¡¨**ï¼ˆå¤šæ•°ï¼Œä¸ç¬¦åˆæ ‡å‡†ï¼‰ï¼š

- `consumption_records.business_id`
- `exchange_records.business_id`
- `market_listings.business_id`
- `trade_orders.business_id`
- `lottery_draws.business_id`
- `trade_records.business_id`
- `admin_operation_logs.business_id`

**é‡åŒ–å·®è·**ï¼š

- å½“å‰å­—æ®µå‘½åç»Ÿä¸€åº¦ï¼š**â‰ˆ20%**ï¼ˆ12å¼ å¹‚ç­‰ç›¸å…³è¡¨ä¸­ï¼Œä»…3å¼ ä½¿ç”¨æ ‡å‡†å‘½åï¼‰
- ç›®æ ‡ï¼š**100%**ï¼ˆæ‰€æœ‰ä¸šåŠ¡è¡¨ç»Ÿä¸€ `idempotency_key`ï¼‰

**ç ´åæ€§æ”¹é€ æ–¹æ¡ˆ**ï¼š

1. æ•°æ®åº“å±‚ï¼šæ‰§è¡Œ `ALTER TABLE` æŠŠæ‰€æœ‰ `business_id` åˆ—é‡å‘½åä¸º `idempotency_key`
2. Sequelize æ¨¡å‹å±‚ï¼šç»Ÿä¸€å­—æ®µå®šä¹‰ä¸º `idempotency_key`
3. æœåŠ¡/è·¯ç”±å±‚ï¼šå…¨å±€æœç´¢æ›¿æ¢ `business_id` â†’ `idempotency_key`
4. ä¸šåŠ¡å•å·/å±•ç¤ºç¼–å·æ”¹ç”¨ä¸“ç”¨å­—æ®µï¼ˆ`order_no`ã€`listing_no`ã€`draw_no` ç­‰ï¼‰

---

#### å·®è· 3ï¼šè¯·æ±‚çº§å¹‚ç­‰æœªè¦†ç›–æ‰€æœ‰å…³é”®å†™å…¥é“¾è·¯

**æ ‡å‡†è¦æ±‚**ï¼šæ‰€æœ‰å…³é”®å†™å…¥ç»Ÿä¸€æ¥å…¥è¯·æ±‚çº§å¹‚ç­‰ï¼ˆå›æ”¾/å†²çª/å¤„ç†ä¸­è¯­ä¹‰ä¸€è‡´ï¼‰

**å½“å‰å®é™…æƒ…å†µ**ï¼ˆä»£ç æ‰«æç»“æœï¼‰ï¼š

- âœ… **å·²æ¥å…¥è¯·æ±‚å¹‚ç­‰**ï¼šæŠ½å¥–ï¼ˆ`routes/v4/lottery/draw.js` ä½¿ç”¨ `IdempotencyService.getOrCreateRequest`ï¼‰
- âŒ **æœªæ¥å…¥è¯·æ±‚å¹‚ç­‰**ï¼ˆä»…é ä¸šåŠ¡è¡¨å”¯ä¸€çº¦æŸï¼‰ï¼š
  - å…‘æ¢ä¸‹å•ï¼ˆ`routes/v4/shop/exchange/exchange.js`ï¼‰
  - å¸‚åœºè´­ä¹°ï¼ˆ`routes/v4/market/buy.js`ï¼‰
  - å¸‚åœºä¸Šæ¶ï¼ˆ`routes/v4/market/sell.js`ï¼‰
  - æ¶ˆè´¹æäº¤/å®¡æ ¸å‘æ”¾ï¼ˆ`services/ConsumptionService.js`ï¼‰
  - èµ„äº§è½¬æ¢ï¼ˆ`routes/v4/shop/assets/convert.js`ï¼‰

**é‡åŒ–å·®è·**ï¼š

- å½“å‰è¯·æ±‚å¹‚ç­‰è¦†ç›–ç‡ï¼š**â‰ˆ30%**ï¼ˆ6ä¸ªå…³é”®å†™å…¥é“¾è·¯ä¸­ï¼Œä»…1ä¸ªæ¥å…¥ç»Ÿä¸€å¹‚ç­‰è¡¨ï¼‰
- ç›®æ ‡ï¼š**100%**ï¼ˆæ‰€æœ‰å…³é”®å†™å…¥ç»Ÿä¸€å›æ”¾/å†²çª/å¤„ç†ä¸­è¯­ä¹‰ï¼‰

**ç ´åæ€§æ”¹é€ æ–¹æ¡ˆ**ï¼š

1. å‡çº§ `api_idempotency_requests` è¡¨è¯­ä¹‰ä¸º"å…¨ä¸šåŠ¡å†™å…¥å¹‚ç­‰"ï¼ˆå¢åŠ  `scope`ã€`request_fingerprint` å­—æ®µï¼‰
2. æ‰€æœ‰å…³é”®å†™å…¥è·¯ç”±ç»Ÿä¸€æ¥å…¥ `IdempotencyService.getOrCreateRequest`
3. ç»Ÿä¸€å›æ”¾è§„åˆ™ï¼š
   - åŒ key åŒå‚æ•° â†’ 200 + `is_duplicate: true` + é¦–æ¬¡ç»“æœ
   - åŒ key ä¸åŒå‚æ•° â†’ 409 Conflict
   - å¤„ç†ä¸­é‡å¤è¯·æ±‚ â†’ 409 Conflict

---

#### å·®è· 4ï¼šé—ç•™çœŸç›¸æºæœªæ¸…ç†ï¼ˆç ´åæ€§æ¸…ç†ä¸å½»åº•ï¼‰

**æ ‡å‡†è¦æ±‚**ï¼šåˆ é™¤æ‰€æœ‰å½’æ¡£/é—ç•™è¡¨ï¼Œåªä¿ç•™ç»Ÿä¸€çœŸç›¸æº

**å½“å‰å®é™…æƒ…å†µ**ï¼ˆçœŸå®æ•°æ®åº“è¡¨æ ¸æŸ¥ï¼‰ï¼š

- âŒ å­˜åœ¨å½’æ¡£è¡¨ï¼š`asset_transactions_archive_20251226`ï¼ˆå« `business_id` + `idempotency_key` + `lottery_session_id`ï¼‰
- âš ï¸ é£é™©ï¼šæœªæ¥å¯èƒ½è¢«è¯¯ç”¨æˆ"ç¬¬äºŒçœŸç›¸æº"ï¼Œç ´åå¯¹è´¦ä¸€è‡´æ€§

**ç ´åæ€§æ”¹é€ æ–¹æ¡ˆ**ï¼š

1. ç›´æ¥ `DROP TABLE asset_transactions_archive_20251226`ï¼ˆä¸åšæ•°æ®è¿ç§»ã€ä¸åšå½’æ¡£ä¿ç•™ï¼‰
2. ç¡®ä¿ `asset_transactions` æ˜¯å”¯ä¸€ä»·å€¼æµæ°´çœŸç›¸æº
3. å¦‚éœ€å†å²æ•°æ®æŸ¥è¯¢ï¼Œæ”¹ç”¨æ•°æ®åº“å¤‡ä»½/å†·å­˜å‚¨æ–¹æ¡ˆï¼ˆè€Œéä¿ç•™åœ¨ä¸šåŠ¡åº“ï¼‰

---

### 8.3 é‡åŒ–é‡Œç¨‹ç¢‘è¿›åº¦

| é‡Œç¨‹ç¢‘                                                   | å½“å‰è¿›åº¦ | ç›®æ ‡ | å·®è·                       |
| -------------------------------------------------------- | -------- | ---- | -------------------------- |
| **M1 çœŸç›¸æºæ­£ç¡®**ï¼ˆè´¦æœ¬/æ‰€æœ‰æƒ/è®¢å•çŠ¶æ€ï¼‰                | **70%**  | 100% | éœ€æ¸…ç†å½’æ¡£è¡¨ã€ç»Ÿä¸€å­—æ®µå‘½å |
| **M2 å¹‚ç­‰å…¥å£ç»Ÿä¸€**ï¼ˆheader onlyï¼Œç¦æ­¢ body/æœåŠ¡ç«¯å…œåº•ï¼‰ | **30%**  | 100% | éœ€æ”¹é€ æ‰€æœ‰å†™å…¥è·¯ç”±         |
| **M3 å¹‚ç­‰å­—æ®µè¯­ä¹‰ç»Ÿä¸€**ï¼ˆå…¨è¡¨ç»Ÿä¸€ idempotency_keyï¼‰      | **20%**  | 100% | éœ€é‡å‘½å 9 å¼ æ ¸å¿ƒä¸šåŠ¡è¡¨    |
| **M4 è¯·æ±‚çº§å¹‚ç­‰å…¨è¦†ç›–**ï¼ˆå…³é”®å†™å…¥ç»Ÿä¸€å›æ”¾/å†²çª/å¤„ç†ä¸­ï¼‰  | **30%**  | 100% | éœ€æ¥å…¥ 5 ä¸ªå…³é”®å†™å…¥é“¾è·¯    |

**æ•´ä½“è¯„ä¼°**ï¼š

- âœ… **çœŸç›¸æºæ–¹å‘å·²ç»å¯¹**ï¼ˆä»·å€¼æµæ°´ã€ä¸šåŠ¡å•æ®å¹‚ç­‰æœºåˆ¶å·²åˆ°ä½ï¼‰
- âš ï¸ **æ ‡å‡†åŒ–ç»Ÿä¸€å·®åœ¨ä¸‰ä»¶äº‹**ï¼šå¹‚ç­‰å…¥å£è¯­ä¹‰ã€å­—æ®µå‘½åã€è¦†ç›–é¢

---

### 8.4 ç ´åæ€§æ”¹é€ ä¼˜å…ˆçº§ä¸è½åœ°é¡ºåº

#### é˜¶æ®µ 1ï¼šAPI ä¸€åˆ€åˆ‡ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼Œå½±å“æ‰€æœ‰å®¢æˆ·ç«¯ï¼‰

**æ”¹é€ èŒƒå›´**ï¼šæ‰€æœ‰å…³é”®å†™å…¥è·¯ç”±ï¼ˆæŠ½å¥–/å¸‚åœºè´­ä¹°/å¸‚åœºä¸Šæ¶/å…‘æ¢/èµ„äº§è½¬æ¢/æ¶ˆè´¹æäº¤ï¼‰

**æ”¹é€ å†…å®¹**ï¼š

1. æ‰€æœ‰å†™æ¥å£åªæ¥å— `Idempotency-Key`ï¼ˆHeaderï¼‰
2. ç¼ºå¤±â†’400ï¼›åŒ key å‚æ•°ä¸åŒâ†’409ï¼›é‡è¯•å›æ”¾â†’200 + `is_duplicate: true`ï¼›å¤„ç†ä¸­â†’409
3. åˆ é™¤æ‰€æœ‰ body ä¸­çš„ `business_id` / `idempotency_key` å‚æ•°
4. åˆ é™¤æ‰€æœ‰æœåŠ¡ç«¯å…œåº•ç”Ÿæˆé€»è¾‘ï¼ˆåŒ…æ‹¬æŠ½å¥–çš„ `generateRequestIdempotencyKey()`ï¼‰

**å…³é”®æ”¹é€ ç‚¹ï¼ˆåŸºäºçœŸå®ä»£ç ç°çŠ¶ï¼‰**ï¼š

| è·¯ç”±                                   | å½“å‰çŠ¶æ€                       | æ”¹é€ åŠ¨ä½œ                                                                                                     |
| -------------------------------------- | ------------------------------ | ------------------------------------------------------------------------------------------------------------ |
| `routes/v4/lottery/draw.js`            | æ”¶ Header/Bodyï¼Œç¼ºå¤±ä¼šå…œåº•ç”Ÿæˆ | âŒ åˆ é™¤ `\|\| generateRequestIdempotencyKey()`<br>âŒ åˆ é™¤ `\|\| req.body.idempotency_key`<br>âœ… ç¼ºå¤±ç›´æ¥ 400 |
| `routes/v4/market/buy.js`              | æ”¶ Header/Body äºŒé€‰ä¸€          | âŒ åˆ é™¤ `\|\| req.body.business_id`<br>âœ… åªä¿ç•™ `req.headers['idempotency-key']`                            |
| `routes/v4/market/sell.js`             | æ”¶ Header/Body äºŒé€‰ä¸€          | âŒ åˆ é™¤ `\|\| req.body.business_id`<br>âœ… åªä¿ç•™ `req.headers['idempotency-key']`                            |
| `routes/v4/shop/exchange/exchange.js`  | æ”¶ Header/Body äºŒé€‰ä¸€          | âŒ åˆ é™¤ `\|\| bodyBusinessId`<br>âœ… åªä¿ç•™ `req.headers['idempotency-key']`                                  |
| `routes/v4/shop/assets/convert.js`     | æ”¶ Header/Body äºŒé€‰ä¸€          | âŒ åˆ é™¤ `\|\| req.body.business_id`<br>âœ… åªä¿ç•™ `req.headers['idempotency-key']`                            |
| `routes/v4/shop/consumption/submit.js` | **ä¸æ”¶ä»»ä½•å¹‚ç­‰é”®**ï¼ŒæœåŠ¡ç«¯ç”Ÿæˆ | âœ… æ–°å¢å¼ºåˆ¶è¯»å– `req.headers['idempotency-key']`<br>âœ… ä¼ å…¥æœåŠ¡å±‚ï¼Œä¸å†æœåŠ¡ç«¯ç”Ÿæˆ                            |

**éªŒæ”¶æ ‡å‡†**ï¼š

- [ ] æ‰€æœ‰å†™å…¥è·¯ç”±ç»Ÿä¸€ä» `req.headers['idempotency-key']` è·å–
- [ ] ç¼ºå¤±å¹‚ç­‰é”®è¿”å› 400ï¼Œå“åº”ä½“åŒ…å«æ ‡å‡†é”™è¯¯ä¿¡æ¯
- [ ] åˆ é™¤æ‰€æœ‰æœåŠ¡ç«¯å…œåº•ç”Ÿæˆé€»è¾‘ï¼ˆåŒ…æ‹¬æŠ½å¥–/æ¶ˆè´¹æäº¤ï¼‰
- [ ] æ¶ˆè´¹æäº¤è·¯ç”±æ”¹é€ ï¼šå¼ºåˆ¶è¯»å– Headerï¼Œä¼ å…¥æœåŠ¡å±‚
- [ ] æ¶ˆè´¹æœåŠ¡æ”¹é€ ï¼šä½¿ç”¨ä¼ å…¥çš„ key ä½œä¸º `business_id`ï¼Œä¸å†è‡ªå·±ç”Ÿæˆ

---

#### é˜¶æ®µ 2ï¼šæ•°æ®åº“ä¸€åˆ€åˆ‡ï¼ˆç ´åæ€§è¡¨ç»“æ„å˜æ›´ï¼‰

**æ”¹é€ èŒƒå›´**ï¼š7 å¼ æ ¸å¿ƒä¸šåŠ¡è¡¨ + æ¸…ç†é‡å¤ç´¢å¼•

**æ”¹é€ å†…å®¹**ï¼š

1. **å­—æ®µé‡å‘½å**ï¼ˆ7 å¼ è¡¨ï¼‰ï¼š

   ```sql
   ALTER TABLE consumption_records RENAME COLUMN business_id TO idempotency_key;
   ALTER TABLE exchange_records RENAME COLUMN business_id TO idempotency_key;
   ALTER TABLE market_listings RENAME COLUMN business_id TO idempotency_key;
   ALTER TABLE trade_orders RENAME COLUMN business_id TO idempotency_key;
   ALTER TABLE trade_records RENAME COLUMN business_id TO idempotency_key;
   ALTER TABLE lottery_draws RENAME COLUMN business_id TO idempotency_key;
   ALTER TABLE admin_operation_logs RENAME COLUMN business_id TO idempotency_key;
   ```

2. **æ¸…ç†é‡å¤å”¯ä¸€ç´¢å¼•**ï¼š
   - `asset_transactions`ï¼šåˆ é™¤é‡å¤çš„ `uk_idempotency_key`ï¼ˆä¿ç•™ `idempotency_key` ç´¢å¼•ï¼‰
   - `trade_orders`ï¼šåˆ é™¤é‡å¤çš„ `idx_trade_orders_business_id`ï¼ˆä¿ç•™ `business_id` ç´¢å¼•ï¼Œæ”¹é€ åä¼šè‡ªåŠ¨é‡å‘½åï¼‰

3. **ç¡®ä¿å”¯ä¸€çº¦æŸ**ï¼šæ‰€æœ‰è¡¨çš„ `idempotency_key` ä¿æŒ NOT NULL + UNIQUE

**éªŒæ”¶æ ‡å‡†**ï¼š

- [ ] æ•°æ®åº“ä¸­ä¸å­˜åœ¨ä»»ä½• `business_id` åˆ—ï¼ˆ7 å¼ æ ¸å¿ƒä¸šåŠ¡è¡¨å·²å…¨éƒ¨é‡å‘½åï¼‰
- [ ] æ‰€æœ‰å¹‚ç­‰åˆ—ç»Ÿä¸€å‘½åä¸º `idempotency_key`
- [ ] æ¸…ç†æ‰€æœ‰é‡å¤çš„å”¯ä¸€ç´¢å¼•
- [ ] æ‰€æœ‰å½’æ¡£/é—ç•™è¡¨å·²åˆ é™¤ï¼ˆçœŸå®åº“æ ¸æŸ¥ï¼šå½“å‰æ— å½’æ¡£è¡¨ï¼Œæ— éœ€åˆ é™¤ï¼‰

---

#### é˜¶æ®µ 3ï¼šå¹‚ç­‰è¡¨å‡çº§ä¸º"å…¨ä¸šåŠ¡å†™å…¥å¹‚ç­‰"

**æ”¹é€ èŒƒå›´**ï¼š`IdempotencyService` + `api_idempotency_requests` è¡¨ + æ‰€æœ‰å…³é”®å†™å…¥è·¯ç”±

**æ”¹é€ å†…å®¹**ï¼š

1. **å‡çº§ `request_hash` ç®—æ³•**ï¼ˆå†³ç­– 4ï¼‰ï¼š

   ```javascript
   // IdempotencyService.generateRequestHash å‡çº§ä¸ºï¼š
   static generateRequestFingerprint(user_id, http_method, api_path, query, body) {
     // 1. è¿‡æ»¤ bodyï¼ˆå‰”é™¤éä¸šåŠ¡å­—æ®µï¼‰
     const body_filtered = this.filterBodyForFingerprint(body)

     // 2. è§„èŒƒåŒ–è·¯å¾„ï¼ˆå»æ‰èµ„æºIDï¼‰
     const normalized_path = this.normalizePath(api_path)

     // 3. ç”Ÿæˆç¨³å®šçš„ canonical JSON
     const canonical = JSON.stringify({
       user_id,
       method: http_method,
       path: normalized_path,
       query: query || {},
       body: body_filtered
     }, Object.keys({user_id, method: http_method, path: normalized_path, query: query || {}, body: body_filtered}).sort())

     // 4. SHA-256 å“ˆå¸Œ
     return crypto.createHash('sha256').update(canonical).digest('hex')
   }
   ```

2. **å‡çº§ TTL ä¸º 7 å¤©**ï¼ˆå†³ç­– 5ï¼‰ï¼š

   ```javascript
   // IdempotencyService.getOrCreateRequest
   const expires_at = new Date()
   expires_at.setDate(expires_at.getDate() + 7) // ä» 24h æ”¹ä¸º 7 å¤©
   ```

3. **æ‰€æœ‰å…³é”®å†™å…¥è·¯ç”±æ¥å…¥**ï¼ˆå†³ç­– 1 + å†³ç­– 6ï¼‰ï¼š
   - âœ… å·²æ¥å…¥ï¼š`routes/v4/lottery/draw.js`ï¼ˆä½†éœ€åˆ é™¤å…œåº•ç”Ÿæˆé€»è¾‘ï¼‰
   - ğŸ”´ éœ€æ¥å…¥ï¼š`routes/v4/market/buy.js`
   - ğŸ”´ éœ€æ¥å…¥ï¼š`routes/v4/market/sell.js`
   - ğŸ”´ éœ€æ¥å…¥ï¼š`routes/v4/shop/exchange/exchange.js`
   - ğŸ”´ éœ€æ¥å…¥ï¼š`routes/v4/shop/assets/convert.js`
   - ğŸ”´ éœ€æ¥å…¥ï¼š`routes/v4/shop/consumption/submit.js`

4. **ç»Ÿä¸€å›æ”¾/å†²çª/å¤„ç†ä¸­è¯­ä¹‰**ï¼ˆå†³ç­– 2ï¼‰ï¼š
   - é¦–æ¬¡è¯·æ±‚ â†’ 200 + ä¸šåŠ¡ç»“æœ
   - åŒ key åŒå‚æ•°é‡è¯• â†’ 200 + `is_duplicate: true` + é¦–æ¬¡ç»“æœ
   - åŒ key ä¸åŒå‚æ•° â†’ 409 + IDEMPOTENCY_KEY_CONFLICT
   - å¤„ç†ä¸­é‡å¤è¯·æ±‚ â†’ 409 + REQUEST_PROCESSING + `Retry-After: 1`

**éªŒæ”¶æ ‡å‡†**ï¼š

- [ ] `IdempotencyService.generateRequestHash` å‡çº§ä¸º `generateRequestFingerprint`ï¼ˆåŒ…å« user_id/method/path/query/bodyï¼‰
- [ ] TTL ä» 24h æ”¹ä¸º 7 å¤©
- [ ] æ‰€æœ‰ 6 ä¸ªå…³é”®å†™å…¥è·¯ç”±æ¥å…¥ `IdempotencyService.getOrCreateRequest`
- [ ] ç»Ÿä¸€è¿”å›è¯­ä¹‰ï¼šé¦–æ¬¡æˆåŠŸã€å¹‚ç­‰å›æ”¾ã€å¹‚ç­‰å†²çªã€å¤„ç†ä¸­é‡å¤
- [ ] è¯·æ±‚å¹‚ç­‰è¦†ç›–ç‡è¾¾åˆ° 100%

---

#### é˜¶æ®µ 4ï¼šæœåŠ¡è¾¹ç•Œç»Ÿä¸€çœŸç›¸æºè°ƒç”¨è·¯å¾„

1. èµ„äº§åŸŸï¼šå”¯ä¸€å…¥å£è´Ÿè´£å†»ç»“/è§£å†»/ç»“ç®—/å˜æ›´ä½™é¢ï¼ˆå¯¹å¤–ä¸å¯ç»•å¼€ï¼‰
2. å¸‚åœº/å…‘æ¢/æŠ½å¥–/æ¶ˆè´¹å®¡æ ¸ï¼šåªè´Ÿè´£çŠ¶æ€æœºä¸ä¸šåŠ¡è§„åˆ™ï¼Œä»·å€¼å˜åŠ¨å…¨éƒ¨å§”æ‰˜èµ„äº§åŸŸ

**éªŒæ”¶æ ‡å‡†**ï¼š

- [ ] æ‰€æœ‰ä»·å€¼å˜åŠ¨å¿…é¡»é€šè¿‡ `AssetService` ç»Ÿä¸€å…¥å£
- [ ] ä»»ä½•ä¸šåŠ¡æœåŠ¡ä¸å¾—ç›´æ¥æ“ä½œ `asset_transactions` è¡¨
- [ ] ä»·å€¼å˜åŠ¨ä¸ä¸šåŠ¡å•æ®çŠ¶æ€å˜æ›´åœ¨åŒä¸€äº‹åŠ¡å†…å®Œæˆ

---

### 8.5 å†³ç­–æ¸…å•ï¼ˆå·²å…¨éƒ¨æ‹æ¿ï¼‰

> ä»¥ä¸‹æ‰€æœ‰å†³ç­–å·²ç”±ä½ ç¡®è®¤ï¼Œä½œä¸ºæœ€ç»ˆå·¥ç¨‹å£å¾„ï¼ˆç ´åæ€§æ”¹é€ ä¸åšå…¼å®¹ï¼Œè¿™äº›å†³å®šç›´æ¥å˜æˆæ–°ç³»ç»Ÿå¥‘çº¦ï¼‰ã€‚

#### å†³ç­– 1ï¼šå¹‚ç­‰å…¥å£ç»Ÿä¸€ âœ… **å·²æ‹æ¿**

**ä½ çš„å†³ç­–**ï¼š**é€‰æ‹©æ–¹æ¡ˆ Aï¼ˆæ‰€æœ‰å†™æ¥å£ç»Ÿä¸€åªæ”¶ `Idempotency-Key`ï¼ˆHeaderï¼‰ï¼Œç¼ºå¤±=400ï¼Œç¦æ­¢æœåŠ¡ç«¯ç”Ÿæˆï¼‰**

**æœ€ç»ˆå£å¾„**ï¼š

- æ‰€æœ‰å…³é”®å†™å…¥è·¯ç”±ï¼ˆæŠ½å¥–/å¸‚åœºè´­ä¹°/å¸‚åœºä¸Šæ¶/å…‘æ¢/èµ„äº§è½¬æ¢/æ¶ˆè´¹æäº¤ï¼‰ç»Ÿä¸€ä» `req.headers['idempotency-key']` è·å–
- ç¼ºå¤±å¹‚ç­‰é”® â†’ 400 Bad Request
- åˆ é™¤æ‰€æœ‰ body ä¸­çš„ `business_id` / `idempotency_key` å‚æ•°æ¥æ”¶é€»è¾‘
- åˆ é™¤æ‰€æœ‰æœåŠ¡ç«¯å…œåº•ç”Ÿæˆé€»è¾‘ï¼ˆåŒ…æ‹¬æŠ½å¥–çš„ `generateRequestIdempotencyKey()`ã€æ¶ˆè´¹æäº¤çš„æœåŠ¡ç«¯ç”Ÿæˆï¼‰

**æ”¹é€ å½±å“**ï¼š

- âŒ åˆ é™¤ï¼š`routes/v4/lottery/draw.js` çš„ `|| req.body.idempotency_key || generateRequestIdempotencyKey()`
- âŒ åˆ é™¤ï¼šæ‰€æœ‰è·¯ç”±çš„ `|| req.body.business_id` é€»è¾‘
- âœ… ç»Ÿä¸€ï¼šåªä¿ç•™ `req.headers['idempotency-key']`ï¼Œç¼ºå¤±ç›´æ¥è¿”å› 400

---

#### å†³ç­– 2ï¼šå¤„ç†ä¸­é‡å¤è¯·æ±‚çš„ç»Ÿä¸€è¯­ä¹‰ âœ… **å·²æ‹æ¿**

**ä½ çš„å†³ç­–**ï¼š**é€‰æ‹©æ–¹æ¡ˆ Aï¼ˆ409 Conflictï¼‰**

**ç†ç”±ï¼ˆåŸºäºçœŸå®æ•°æ®åº“æ ¸æŸ¥ï¼‰**ï¼š

- å½“å‰ `IdempotencyService.js` å·²å®ç° 409 + REQUEST_PROCESSING è¯­ä¹‰
- çœŸå®åº“ç»Ÿè®¡ï¼ˆ`restaurant_points_dev`ï¼‰ï¼štotal=48ï¼Œprocessing=0ï¼Œcompleted=28ï¼Œfailed=20
- æ— é•¿æœŸ processing å‹åŠ›åœºæ™¯ï¼Œæ— éœ€å¼•å…¥ 202+è½®è¯¢å¤æ‚åº¦
- ä¸šåŠ¡å½¢æ€ï¼ˆæ¸¸æˆèµ„äº§/äº¤æ˜“è´¦æœ¬ï¼‰æ›´é€‚åˆåŒæ­¥å®Œæˆ + 409 é‡è¯•å›æ”¾

**è¡¥å……ä½“éªŒä¼˜åŒ–æœºåˆ¶**ï¼š

1. **409 å“åº”æ˜ç¡®å­—æ®µ**ï¼š

   ```json
   {
     "success": false,
     "code": "REQUEST_PROCESSING",
     "message": "è¯·æ±‚æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨åé‡è¯•",
     "data": {},
     "headers": {
       "Retry-After": "1" // å»ºè®®1ç§’åé‡è¯•
     }
   }
   ```

2. **processing è¶…æ—¶è‡ªåŠ¨æ ‡è®° failed**ï¼š
   - å®šä¹‰è¶…æ—¶ä¸Šé™ï¼š**60ç§’**ï¼ˆå¯é…ç½®ï¼Œå»ºè®® 30-120 ç§’ï¼‰
   - å®šæ—¶ä»»åŠ¡ï¼ˆæ¯åˆ†é’Ÿæ‰§è¡Œï¼‰ï¼š
     ```sql
     UPDATE api_idempotency_requests
     SET status = 'failed',
         response_snapshot = JSON_OBJECT('error', 'Processing timeout'),
         completed_at = NOW()
     WHERE status = 'processing'
       AND TIMESTAMPDIFF(SECOND, updated_at, NOW()) > 60;
     ```
   - å…è®¸å®¢æˆ·ç«¯é‡è¯•åŒ keyï¼ˆfailed çŠ¶æ€å¯é‡æ–°è¿›å…¥ processingï¼‰

**æœ€ç»ˆè¯­ä¹‰**ï¼š

- é¦–æ¬¡è¯·æ±‚ â†’ 200 + ä¸šåŠ¡ç»“æœ
- åŒ key åŒå‚æ•°é‡è¯• â†’ 200 + `is_duplicate: true` + é¦–æ¬¡ç»“æœ
- åŒ key ä¸åŒå‚æ•° â†’ 409 + IDEMPOTENCY_KEY_CONFLICT
- å¤„ç†ä¸­é‡å¤è¯·æ±‚ â†’ 409 + REQUEST_PROCESSING + `Retry-After: 1`
- è¶…æ—¶æœªå®Œæˆ â†’ è‡ªåŠ¨æ ‡è®° failedï¼Œå…è®¸é‡è¯•

#### å†³ç­– 3ï¼šå¹‚ç­‰ Key çš„ä½œç”¨åŸŸï¼ˆscopeï¼‰æ€ä¹ˆå®šä¹‰ âœ… **å·²æ‹æ¿**

**ä½ çš„å†³ç­–**ï¼š**é€‰æ‹©æ–¹æ¡ˆ Aï¼ˆç»§ç»­å…¨å±€å”¯ä¸€ï¼Œä½†æ¥å—"åŒä¸€ä¸ª key è¢«é”™ç”¨åˆ°å¦ä¸€ä¸ªæ¥å£ä¼šæ’è½¦"çš„é£é™©ï¼‰**

**è¯´æ˜**ï¼š

- å½“å‰ `api_idempotency_requests.idempotency_key` æ˜¯å…¨å±€å”¯ä¸€ï¼ˆå•åˆ— UNIQUEï¼‰
- ä¸å¼•å…¥ `scope` å­—æ®µï¼Œä¿æŒå®ç°ç®€å•
- ä¾èµ–å®¢æˆ·ç«¯æ­£ç¡®ä½¿ç”¨å¹‚ç­‰é”®ï¼ˆä¸è·¨æ¥å£å¤ç”¨ï¼‰
- å¦‚æœè¯¯ç”¨ï¼Œä¼šè§¦å‘ 409 å†²çªï¼ˆå› ä¸º `request_hash` ä¸åŒï¼‰

**æœ€ç»ˆå£å¾„**ï¼š

- `api_idempotency_requests.idempotency_key` ä¿æŒå…¨å±€å”¯ä¸€çº¦æŸ
- ä¸æ–°å¢ `scope` å­—æ®µ
- `request_hash` ä»åŸºäºè¯·æ±‚å‚æ•°è®¡ç®—ï¼ˆå†³ç­– 4 ä¼šå‡çº§ fingerprint ç®—æ³•ï¼‰

---

#### å†³ç­– 4ï¼šå¹‚ç­‰ Key çš„ä½œç”¨åŸŸï¼ˆscopeï¼‰æ€ä¹ˆå®šä¹‰ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼Œæœªé‡‡ç”¨ï¼‰

**å¤‡é€‰æ–¹æ¡ˆ Aï¼ˆæœªé‡‡ç”¨ï¼‰**ï¼š`user_id + method + normalized_path + business_action`

**ç†ç”±ï¼ˆä¸å½“å‰ä»£ç /çœŸå®åº“å¯¹é½ï¼‰**ï¼š

- å½“å‰ `api_idempotency_requests` å½“å‰å­—æ®µå·²åŒ…å« `api_path/http_method/user_id`ï¼Œä½†ç›®å‰å†²çªæ£€æµ‹çš„ `request_hash` åªåŸºäº `request_params`ï¼ˆè§ `services/IdempotencyService.js`ï¼‰ï¼Œ**ä¸åŒ…å« api_path/http_method/user_id**ã€‚
  - è¿™æ„å‘³ç€ï¼šå¦‚æœå®¢æˆ·ç«¯è¯¯æŠŠåŒä¸€ä¸ª `Idempotency-Key` ç”¨åœ¨"ä¸åŒæ¥å£/ä¸åŒåŠ¨ä½œ"ä¸Šï¼Œåªè¦å‚æ•°å½¢çŠ¶ç›¸è¿‘ï¼Œå°±å¯èƒ½è¢«å½“æˆ"åŒè¯·æ±‚é‡è¯•"è€Œç›´æ¥å›æ”¾é”™è¯¯ç»“æœã€‚
- çœŸå®åº“ç»Ÿè®¡ï¼ˆ`restaurant_points_dev`ï¼‰ï¼š`api_idempotency_requests` å…± 48 æ¡ï¼ˆprocessing=0/completed=28/failed=20ï¼‰ï¼Œè¯´æ˜å½“å‰ä¸»è¦æ˜¯åŒæ­¥å†™å…¥+å›æ”¾æ¨¡å‹ã€‚

**æœ€ç»ˆ scope ç»„æˆï¼ˆç ´åæ€§æ”¹é€ åï¼‰**ï¼š

```javascript
// ç¤ºä¾‹ï¼š
// - ç”¨æˆ·123æŠ½å¥–ï¼š      "123:POST:/api/v4/lottery/draw:lottery_draw"
// - ç”¨æˆ·123å¸‚åœºè´­ä¹°ï¼š  "123:POST:/api/v4/market/buy:market_purchase"
// - ç”¨æˆ·456æŠ½å¥–ï¼š      "456:POST:/api/v4/lottery/draw:lottery_draw"
```

---

#### å†³ç­– 4ï¼šè¯·æ±‚æŒ‡çº¹ï¼ˆrequest_fingerprintï¼‰åŒ…å«å“ªäº›å­—æ®µ âœ… **å·²æ‹æ¿**

**ä½ çš„å†³ç­–**ï¼š**é€‰æ‹©æ–¹æ¡ˆ Aï¼ˆfingerprint = canonicalize({user_id, method, api_path, query, body_filtered}) å† sha256ï¼‰**

**å½“å‰ä»£ç ç°çŠ¶**ï¼š

- `services/IdempotencyService.js` çš„ `request_hash` ä»…å¯¹ `request_params` åš hashï¼ˆä¸”åªå¯¹é¡¶å±‚ key æ’åºï¼‰
- **å¯¹ query/path/method/user_id çš„å˜åŒ–ä¸æ•æ„Ÿ**
- å¯¹åµŒå¥—ç»“æ„çš„ç¨³å®šæ€§ä¸è¶³ï¼ˆåµŒå¥—å¯¹è±¡/æ•°ç»„é¡ºåºå˜åŒ–ä¼šå¯¼è‡´ä¸åŒ hashï¼‰

**æœ€ç»ˆå£å¾„ï¼ˆç ´åæ€§æ”¹é€ åï¼‰**ï¼š

```javascript
// IdempotencyService.generateRequestHash å‡çº§ä¸ºï¼š
request_fingerprint = sha256(
  canonical_json({
    user_id: user_id,
    method: http_method,
    path: normalized_path, // å»æ‰è·¯å¾„å‚æ•°ä¸­çš„èµ„æºID
    query: query_params,
    body: body_filtered // å‰”é™¤éä¸šåŠ¡å­—æ®µ
  })
)
```

**body_filtered è¿‡æ»¤è§„åˆ™**ï¼ˆå¿…é¡»ç»Ÿä¸€ï¼Œå¦åˆ™ä¼šè¯¯å†²çª/è¯¯å›æ”¾ï¼‰ï¼š

- **å¿…é¡»å‰”é™¤**ï¼š`idempotency_key`ã€`business_id`ã€`timestamp`ã€`nonce`ã€`signature`ã€å®¢æˆ·ç«¯ trace å­—æ®µç­‰"éä¸šåŠ¡è¯­ä¹‰å­—æ®µ"
- **å¿…é¡»ä¿ç•™**ï¼šèƒ½æ”¹å˜ä¸šåŠ¡ç»“æœçš„å­—æ®µï¼ˆæ‰£å‡é‡‘é¢ã€å‘è´§å¯¹è±¡ã€èµ„äº§ç±»å‹ã€æ•°é‡ã€ä»·æ ¼ã€æŠ˜æ‰£ã€æ´»åŠ¨IDã€å•†å“ID ç­‰ï¼‰

**normalized_path è§„åˆ™**ï¼š

- å»æ‰çº¯æ•°å­—/UUID è¿™ç±» path å‚æ•°ï¼ˆä¾‹å¦‚ `/orders/123` å½’ä¸€åˆ° `/orders/:id`ï¼‰
- é¿å…èµ„æºIDå¯¼è‡´çš„"åŒåŠ¨ä½œä¸åŒèµ„æº"è¯¯åˆ¤
- å¦‚æœèµ„æºIDæœ¬èº«å°±æ˜¯ä¸šåŠ¡è¯­ä¹‰ï¼ˆå¦‚ listing_id/order_idï¼‰ï¼Œåº”æ”¾è¿› `body_filtered`ï¼ˆè€Œä¸æ˜¯ä¾èµ– pathï¼‰

#### å†³ç­– 4ï¼šå¹‚ç­‰è¡¨å›æ”¾ç»“æœè¦å­˜ä»€ä¹ˆï¼ˆresult_snapshotï¼‰

- é€‰é¡¹ Aï¼ˆæ¨èï¼Œç®€å•ï¼‰ï¼šå­˜ **å®Œæ•´ä¸šåŠ¡å“åº” JSON**ï¼ˆå›æ”¾å®Œå…¨ä¸€è‡´ï¼Œä»£ä»·æ˜¯å­˜å‚¨å¢é•¿ï¼‰
- é€‰é¡¹ Bï¼ˆæ›´çœï¼‰ï¼šåªå­˜ `entity_ref_type/entity_ref_id`ï¼Œå›æ”¾æ—¶å†æŸ¥åº“æ‹¼è£…ï¼ˆä»£ä»·æ˜¯å›æ”¾ç»“æœéšæ•°æ®å˜åŒ–å¯èƒ½ä¸å®Œå…¨ä¸€è‡´ï¼‰

** æˆ‘é€‰æ‹© é€‰é¡¹ A**ï¼ˆå¯¹ä½ è¿™ä¸ªâ€œæ¸¸æˆåŒ–ç»æµ/è™šæ‹Ÿèµ„äº§ + äº¤æ˜“ + å…‘æ¢ + æŠ½å¥–â€çš„ä¸šåŠ¡æœ€ç¨³ï¼‰ã€‚

**ç†ç”±ï¼ˆä¸å½“å‰ä»£ç /çœŸå®åº“å¯¹é½ï¼‰**ï¼š

- **ä½ å½“å‰å®ç°å·²ç»åœ¨ç”¨ A çš„è¯­ä¹‰**ï¼š`services/IdempotencyService.js` åœ¨é‡å¤è¯·æ±‚æ—¶ç›´æ¥è¿”å› `response_snapshot`ï¼›åœ¨ `markAsCompleted` æ—¶å†™å…¥ `response_snapshot=response_data`ï¼Œå¤±è´¥ä¹Ÿä¼šå†™ `{error: ...}`ã€‚
- **çœŸå®åº“ï¼ˆ`.env` æŒ‡å‘çš„ `restaurant_points_dev`ï¼‰å½“å‰ä½“é‡éå¸¸å¯æ§**ï¼š`api_idempotency_requests` å…± 48 æ¡ï¼Œ`response_snapshot` **48/48 å…¨éƒ½æœ‰**ï¼›`avg_snapshot_charsâ‰ˆ632`ï¼Œ`max_snapshot_charsâ‰ˆ2574`ã€‚ä»¥ä½ åç»­é»˜è®¤ TTLï¼ˆå†³ç­–5ï¼‰ä¸º 7 å¤©ä¼°ç®—ï¼Œå­˜å‚¨å‹åŠ›è¿œå°äºé”™å›æ”¾/é”™å•çš„é£é™©æˆæœ¬ã€‚

**è¡Œä¸šé‡Œé€šå¸¸æ€ä¹ˆåšï¼ˆåªè®²æ¨¡å¼ï¼Œä¸å¼•ç”¨ä»»ä½•å¤–éƒ¨æ–‡æ¡£ï¼‰**ï¼š

- **å¤§å‚ï¼ˆç¾å›¢/é˜¿é‡Œ/è…¾è®¯ï¼‰**ï¼š
  - å¸¸è§ä¸¤æ´¾ï¼š**å…¨é‡å¿«ç…§å›æ”¾**ï¼ˆæ›´å¼ºç¡®å®šæ€§ã€æ’éšœç®€å•ï¼‰ vs **åªå­˜å®ä½“å¼•ç”¨å†é‡ç®—**ï¼ˆçœå­˜å‚¨ã€ä½†è¦æ±‚å¼ºç‰ˆæœ¬åŒ–/å¼ºå¥‘çº¦ï¼Œä¸”å›æ”¾ç»“æœå¯èƒ½éšæ•°æ®å˜åŒ–ï¼‰ã€‚
  - åœ¨â€œé’±/èµ„äº§/è®¢å•çŠ¶æ€æœºâ€è¿™ç±»å…³é”®å†™å…¥é“¾è·¯é‡Œï¼Œæ›´åå‘ **ç¡®å®šæ€§ä¼˜å…ˆ**ï¼šè¦ä¹ˆå­˜å…¨é‡å¿«ç…§ï¼Œè¦ä¹ˆå­˜èƒ½ç¡®å®šæ€§é‡å»ºçš„â€œä¸å¯å˜æŠ•å½±ï¼ˆimmutable projectionï¼‰+ ç‰ˆæœ¬å·â€ã€‚
- **å°å…¬å¸ï¼ˆå•ä½“/å•åº“ï¼‰**ï¼šé€šå¸¸ç›´æ¥é€‰ Aï¼ˆå®ç°æˆæœ¬æœ€ä½ï¼Œè¯­ä¹‰æœ€ç¨³å®šï¼‰ã€‚
- **æ¸¸æˆå…¬å¸/æ´»åŠ¨ç³»ç»Ÿ**ï¼šä¸ºäº†å®¢æœ/å®¡è®¡/è¡¥å•ï¼Œæ™®éå€¾å‘ Aï¼ˆå°¤å…¶æ˜¯æŠ½å¥–ã€å‘å¥–ã€æ‰£å‡ã€å‘è´§åœºæ™¯ï¼‰ï¼Œå› ä¸ºâ€œå›æ”¾ä¸€è‡´â€æ¯”â€œçœä¸€ç‚¹å­˜å‚¨â€æ›´é‡è¦ã€‚
- **è™šæ‹Ÿç‰©å“äº¤æ˜“/å°ä¼—äºŒæ‰‹å¹³å°**ï¼šå¼ºçƒˆåå‘ Aï¼ŒåŸå› æ˜¯äº¤æ˜“é“¾è·¯çš„å›æ”¾ä¸€æ—¦æ‹¼è£…å‡ºä¸åŒç»“æœï¼Œç­‰åŒäºâ€œé”™å‘è´§/é”™æ‰£æ¬¾/é”™æˆäº¤â€ï¼Œä»£ä»·æé«˜ã€‚

#### å†³ç­– 5ï¼šå¹‚ç­‰è®°å½•ä¿ç•™å¤šä¹…ï¼ˆTTL/æ¸…ç†ç­–ç•¥ï¼‰ âœ… **å·²æ‹æ¿**

**ä½ çš„å†³ç­–**ï¼š**é€‰é¡¹ Aï¼ˆTTL=7å¤©ï¼›æ¸…ç† completed/failedï¼›processing è¶…æ—¶è‡ªåŠ¨è½¬ failedï¼Œè¶…æ—¶é˜ˆå€¼=60ç§’ï¼‰**

**å½“å‰ä»£ç ç°çŠ¶**ï¼š

- `services/IdempotencyService.js` åˆ›å»ºè®°å½•æ—¶ `expires_at = now + 24h`
- çœŸå®åº“ï¼ˆ2026-01-02 æ ¸æŸ¥ï¼‰ï¼š`api_idempotency_requests` å…± 48 æ¡ï¼Œ`expired=42`ï¼ˆå…¶ä¸­ `completed_expired=28`ã€`failed_expired=14`ï¼‰
- å½“å‰ `cleanupExpired()` åªåˆ é™¤ `status='completed'` çš„è¿‡æœŸè®°å½•ï¼Œ**failed è®°å½•ä¼šé•¿æœŸç´¯ç§¯**

**æœ€ç»ˆå£å¾„ï¼ˆç ´åæ€§æ”¹é€ åï¼‰**ï¼š

1. **TTL ç»Ÿä¸€ä¸º 7 å¤©**ï¼š

   ```javascript
   // IdempotencyService.getOrCreateRequest
   const expires_at = new Date()
   expires_at.setDate(expires_at.getDate() + 7) // æ”¹ä¸º 7 å¤©
   ```

2. **æ¸…ç†ç­–ç•¥**ï¼š
   - æ¸…ç† `completed` ä¸”è¿‡æœŸçš„è®°å½•
   - æ¸…ç† `failed` ä¸”è¿‡æœŸçš„è®°å½•
   - `processing` è¶…æ—¶è‡ªåŠ¨è½¬ `failed`ï¼ˆè¶…æ—¶é˜ˆå€¼=60ç§’ï¼‰

3. **processing è¶…æ—¶è‡ªåŠ¨è½¬ failed**ï¼š

   ```javascript
   // å®šæ—¶ä»»åŠ¡ï¼ˆæ¯åˆ†é’Ÿæ‰§è¡Œï¼‰
   UPDATE api_idempotency_requests
   SET status = 'failed',
       response_snapshot = JSON_OBJECT('error', 'Processing timeout'),
       completed_at = NOW()
   WHERE status = 'processing'
     AND TIMESTAMPDIFF(SECOND, created_at, NOW()) > 60;
   ```

4. **å®šæ—¶æ¸…ç†ä»»åŠ¡**ï¼š
   ```javascript
   // æ¸…ç†è¿‡æœŸçš„ completed/failed è®°å½•
   DELETE FROM api_idempotency_requests
   WHERE status IN ('completed', 'failed')
     AND expires_at < NOW();
   ```

#### å†³ç­– 6ï¼šæ¶ˆè´¹æäº¤ï¼ˆmerchant submitï¼‰çš„å¹‚ç­‰å£å¾„ âœ… **å·²æ‹æ¿**

**ä½ çš„å†³ç­–**ï¼š**é€‰æ‹©æ–¹æ¡ˆ Aï¼ˆå¼ºåˆ¶ `Idempotency-Key`ï¼‰+ å åŠ æ–¹æ¡ˆ B ä½œä¸ºè¯¯æ“ä½œæŠ¤æ **

**å½“å‰ä»£ç ç°çŠ¶ï¼ˆä¸ºä»€ä¹ˆ"é˜²é‡å¤æ°¸è¿œ miss"ï¼‰**ï¼š

- è·¯ç”±å±‚ï¼ˆ`routes/v4/shop/consumption/submit.js`ï¼‰**ä¸æ¥æ”¶ä»»ä½•å¹‚ç­‰é”®**ï¼ˆæ—¢ä¸æ”¶ Header ä¹Ÿä¸æ”¶ Bodyï¼‰
- æœåŠ¡å±‚ï¼ˆ`ConsumptionService.merchantSubmitConsumption`ï¼‰**æ¯æ¬¡éƒ½ç”Ÿæˆæ–° `business_id`**ï¼š`consumption_${userId}_${merchantId}_${timestamp}`
- ç»“æœï¼šå¹‚ç­‰æ£€æŸ¥ä»£ç è™½ç„¶å­˜åœ¨ï¼ˆ`findOne({ where: { business_id } })`ï¼‰ï¼Œä½†å› ä¸º `business_id` æ¯æ¬¡éƒ½æ˜¯æ–°å€¼ï¼Œ**å®é™…ä¸Šæ°¸è¿œä¸ä¼šå‘½ä¸­**
- çœŸå®åº“éªŒè¯ï¼ˆ2026-01-02ï¼‰ï¼š`consumption_records` å…± **184 æ¡**ï¼Œ`business_id` æœ‰å”¯ä¸€çº¦æŸï¼ˆ`uk_consumption_records_business_id`ï¼‰ï¼Œä½†å› ä¸ºæœåŠ¡ç«¯æ¯æ¬¡ç”Ÿæˆæ–°å€¼ï¼Œè¿™ä¸ªçº¦æŸå¹¶ä¸èƒ½é˜²é‡å¤æäº¤

**è¡Œä¸šå¸¸è§åšæ³•ï¼ˆåªè®²æ¨¡å¼ï¼‰**ï¼š

- **å¤§å‚ï¼ˆç¾å›¢/é˜¿é‡Œ/è…¾è®¯ï¼‰**ï¼šé€šå¸¸é‡‡ç”¨ **"å®¢æˆ·ç«¯å¹‚ç­‰é”® + æœåŠ¡ç«¯é£æ§å»é‡çª—å£ + DB å”¯ä¸€çº¦æŸå…œåº•"** ä¸‰å±‚å åŠ ï¼›åœ¨"ç§¯åˆ†å‘æ”¾/èµ„äº§å˜åŠ¨"è¿™ç±»å…³é”®å†™å…¥é‡Œï¼Œ**å¼ºå¹‚ç­‰é”®ï¼ˆæ–¹æ¡ˆ Aï¼‰æ˜¯ä¸»è¦æœºåˆ¶**ï¼Œé£æ§çª—å£æ˜¯è¾…åŠ©
- **å°å…¬å¸ï¼ˆå•ä½“å•åº“ï¼‰**ï¼šæœ€ç¨³çš„æ˜¯ç›´æ¥åš **æ–¹æ¡ˆ A**ï¼ˆå¼ºåˆ¶ `Idempotency-Key`ï¼‰ï¼Œç®€å•å¯æ§ï¼›åªåšæ–¹æ¡ˆ Bï¼ˆæ—¶é—´çª—å£ï¼‰å¾€å¾€ä¼šåœ¨"è·¨åˆ†é’Ÿé‡è¯•/å¼±ç½‘é‡æ”¾"åœºæ™¯æ¼æ‰
- **æ¸¸æˆå…¬å¸/æ´»åŠ¨ç³»ç»Ÿ**ï¼šå¸¸ç”¨ **action_id/sequenceï¼ˆç­‰ä»·äº Idempotency-Keyï¼‰** æ¥ä¿è¯"åŒä¸€æ¬¡åŠ¨ä½œåªç”Ÿæ•ˆä¸€æ¬¡"ï¼ŒåŒæ—¶ä¼šåŠ çŸ­çª—å£é˜²è¯¯ç‚¹ï¼›æœ¬è´¨ä»æ˜¯ A ä¸ºä¸»
- **è™šæ‹Ÿç‰©å“äº¤æ˜“/å°ä¼—äºŒæ‰‹å¹³å°**ï¼šå› ä¸ºæ¶‰åŠèµ„äº§/äº¤æ˜“ç»“æœï¼Œé€šå¸¸æ›´åå‘ **å¼ºå¹‚ç­‰é”®ï¼ˆæ–¹æ¡ˆ Aï¼‰**ï¼Œå†å åŠ é£æ§ï¼›åªåšæ—¶é—´çª—å£ä¼šç•™ä¸‹å¯è¢«é‡æ”¾çš„ç¼éš™

**æœ€ç»ˆå£å¾„ï¼ˆç ´åæ€§æ”¹é€ åï¼‰**ï¼š

1. **ä¸»è¦æœºåˆ¶ï¼ˆæ–¹æ¡ˆ Aï¼‰**ï¼šå•†å®¶ç«¯å¿…é¡»ä¼  `Idempotency-Key`ï¼ˆHeaderï¼‰ï¼Œç¼ºå¤±â†’400
   - è·¯ç”±å±‚ï¼š`routes/v4/shop/consumption/submit.js` å¼ºåˆ¶è¯»å– `req.headers['idempotency-key']`
   - æœåŠ¡å±‚ï¼š`ConsumptionService.merchantSubmitConsumption` ä½¿ç”¨è¯¥ key ä½œä¸º `business_id`ï¼ˆä¸å†æœåŠ¡ç«¯ç”Ÿæˆï¼‰
   - å¹‚ç­‰æ£€æŸ¥ï¼š`findOne({ where: { business_id: idempotency_key } })` èƒ½çœŸæ­£å‘½ä¸­é‡å¤è¯·æ±‚

2. **è¾…åŠ©æŠ¤æ ï¼ˆæ–¹æ¡ˆ Bï¼Œå¯é€‰å åŠ ï¼‰**ï¼š3åˆ†é’Ÿé˜²è¯¯æ“ä½œçª—å£
   - æŒ‡çº¹å®šä¹‰ï¼š`merchant_id + user_uuid + rounded_amount + time_window_3min`
   - å®ç°æ–¹å¼ï¼šåœ¨ `consumption_records` è¡¨å¢åŠ å¤åˆç´¢å¼•ï¼ˆæˆ–ç”¨ Redis åšçŸ­æœŸå»é‡ï¼‰
   - ä½œç”¨ï¼šæ‹¦æˆª"åŒå•†å®¶å¯¹åŒç”¨æˆ·åœ¨çŸ­æ—¶é—´å†…çš„é‡å¤æäº¤"ï¼ˆè¯¯è§¦å‘åœºæ™¯ï¼‰
   - **ä¸ä½œä¸ºå”¯ä¸€å¹‚ç­‰æœºåˆ¶**ï¼šæ— æ³•é˜²æ­¢è·¨æ—¶æ®µé‡è¯•ã€ç½‘ç»œé‡æ”¾

3. **å”¯ä¸€çº¦æŸå…œåº•**ï¼š`consumption_records.business_id` ä¿æŒ UNIQUEï¼ˆæ”¹é€ åæ”¹åä¸º `idempotency_key`ï¼‰

---

#### å†³ç­– 7ï¼š`idempotency_key` çš„å”¯ä¸€æ€§å£å¾„ï¼ˆä¸šåŠ¡å•æ®å±‚ï¼‰ âœ… **å·²æ‹æ¿**

**ä½ çš„å†³ç­–**ï¼š**é€‰é¡¹ Aï¼ˆå…¨ç³»ç»Ÿå…¨å±€å”¯ä¸€ï¼‰+ æ‰§è¡Œç ´åæ€§å­—æ®µé‡å‘½åï¼ˆæ‰€æœ‰ä¸šåŠ¡è¡¨ `business_id` â†’ `idempotency_key`ï¼‰**

**å½“å‰ä»£ç /çœŸå®åº“ç°çŠ¶ï¼ˆ2026-01-02 æ ¸æŸ¥ï¼‰**ï¼š

- çœŸå®åº“å½“å‰"ä¸šåŠ¡å•æ®å¹‚ç­‰"è¿˜æ˜¯ **åˆ†è¡¨å‘½åç©ºé—´**ï¼ˆè¡¨å†…å”¯ä¸€ï¼‰ï¼š
  - `consumption_records.business_id`ï¼šNOT NULL + UNIQUEï¼ˆ`uk_consumption_records_business_id`ï¼‰
  - `exchange_records.business_id`ï¼šNOT NULL + UNIQUEï¼ˆ`idx_business_id_unique`ï¼‰
  - `market_listings.business_id`ï¼šNOT NULL + UNIQUEï¼ˆ`uk_market_listings_business_id`ï¼‰
  - `trade_orders.business_id`ï¼šNOT NULL + UNIQUEï¼ˆå­˜åœ¨ä¸¤ä¸ªé‡å¤ unique ç´¢å¼•ï¼š`business_id`ã€`idx_trade_orders_business_id`ï¼‰
  - `trade_records.business_id`ï¼šNOT NULL + UNIQUEï¼ˆ`uk_trade_records_business_id`ï¼‰
  - `lottery_draws.business_id`ï¼šNOT NULL + UNIQUEï¼ˆ`uk_lottery_draws_business_id`ï¼‰
  - `admin_operation_logs.business_id`ï¼šNOT NULL + UNIQUEï¼ˆ`business_id` ç´¢å¼•ï¼‰
- çœŸå®åº“çš„"ä»·å€¼æµæ°´å¹‚ç­‰"å·²ç»æ˜¯ **å¼ºå…¨å±€å”¯ä¸€**ï¼š`asset_transactions.idempotency_key` NOT NULL + UNIQUEï¼ˆå­˜åœ¨ä¸¤ä¸ªé‡å¤ unique ç´¢å¼•ï¼š`idempotency_key`ã€`uk_idempotency_key`ï¼‰

**æœ€ç»ˆå£å¾„ï¼ˆç ´åæ€§æ”¹é€ åï¼‰**ï¼š

1. **å­—æ®µé‡å‘½åï¼ˆç ´åæ€§ï¼‰**ï¼šæ‰€æœ‰ä¸šåŠ¡è¡¨ `business_id` â†’ `idempotency_key`
   - æ•°æ®åº“å±‚ï¼šæ‰§è¡Œ `ALTER TABLE ... RENAME COLUMN business_id TO idempotency_key`
   - Sequelize æ¨¡å‹å±‚ï¼šç»Ÿä¸€å­—æ®µå®šä¹‰ä¸º `idempotency_key`
   - æœåŠ¡/è·¯ç”±å±‚ï¼šå…¨å±€æœç´¢æ›¿æ¢ `business_id` â†’ `idempotency_key`

2. **å”¯ä¸€æ€§ä¿è¯**ï¼š
   - æ¯å¼ ä¸šåŠ¡å•æ®è¡¨ `idempotency_key` ä¿æŒæœ¬è¡¨ UNIQUEï¼ˆå¿…éœ€ï¼Œé˜²æ­¢å¹¶å‘ï¼‰
   - å…¨å±€å”¯ä¸€é€šè¿‡"å®¢æˆ·ç«¯ç”Ÿæˆè§„èŒƒ"ä¿è¯ï¼ˆå»ºè®® key å½¢å¦‚ï¼š`{business_action}_{ulid/uuid}` æˆ– `req_{...}` æ´¾ç”Ÿï¼‰
   - ä¸æ–°å¢å…¨å±€æ³¨å†Œè¡¨ï¼ˆä¿æŒå®ç°ç®€å•ï¼‰

3. **éœ€è¦é‡å‘½åçš„è¡¨**ï¼ˆå…± 7 å¼ æ ¸å¿ƒä¸šåŠ¡è¡¨ï¼‰ï¼š
   - `consumption_records.business_id` â†’ `idempotency_key`
   - `exchange_records.business_id` â†’ `idempotency_key`
   - `market_listings.business_id` â†’ `idempotency_key`
   - `trade_orders.business_id` â†’ `idempotency_key`
   - `trade_records.business_id` â†’ `idempotency_key`
   - `lottery_draws.business_id` â†’ `idempotency_key`
   - `admin_operation_logs.business_id` â†’ `idempotency_key`

---

#### å†³ç­– 8ï¼šä¸€ä¸ªè¯·æ±‚æ˜¯å¦å…è®¸äº§ç”Ÿå¤šæ¡ `asset_transactions` âœ… **å·²æ‹æ¿**

- é€‰é¡¹ Aï¼ˆæ¨èï¼‰ï¼šå…è®¸ï¼ˆæŠ½å¥–/äº¤æ˜“/å…‘æ¢å¤©ç„¶ä¼šå¤šåˆ†å½•ï¼‰ï¼Œä½†è¦æ±‚ **æ¯æ¡æµæ°´éƒ½æœ‰å”¯ä¸€ `asset_transactions.idempotency_key`**ï¼Œå¹¶ç”±"è¯·æ±‚ key æ´¾ç”Ÿ"å¾—åˆ°ï¼ˆä¾‹å¦‚ `reqKey:freeze`ã€`reqKey:settle`ã€`reqKey:refund`ï¼‰
- é€‰é¡¹ Bï¼šä¸å…è®¸ï¼ˆå¼ºåˆ¶ä¸€è¯·æ±‚ä¸€æµæ°´ï¼‰ï¼Œä¼šæ‰­æ›²è´¦åŠ¡è¡¨è¾¾ï¼Œä¸å»ºè®®

**ä½ çš„å†³ç­–**ï¼š**é€‰é¡¹ Aï¼ˆå…è®¸å¤šåˆ†å½•ï¼‰**ï¼ˆè¿™æ˜¯"ç»Ÿä¸€è´¦æœ¬/ä»·å€¼æµæ°´çœŸç›¸æº"é‡Œæœ€æ ‡å‡†ã€ä¹Ÿæœ€é€‚åˆä½ ä¸šåŠ¡å½¢æ€çš„åšæ³•ï¼‰ã€‚

**ç†ç”±ï¼ˆä¸å½“å‰ä»£ç /çœŸå®åº“å¯¹é½ï¼‰**ï¼š

- **çœŸå®åº“ç°çŠ¶**ï¼š`.env` æŒ‡å‘çš„çœŸå®åº“é‡Œ `asset_transactions` å½“å‰æ˜¯ç©ºè¡¨ï¼ˆ`COUNT(*)=0`ï¼‰ï¼Œæ‰€ä»¥æš‚æ—¶æ— æ³•ç”¨å†å²æ•°æ®è¯æ˜â€œåŒä¸€è¯·æ±‚å¤šåˆ†å½•â€çš„æ—¢æˆäº‹å®ï¼›ä½†è¡¨ç»“æ„å·²ç»é¢„ç•™äº† `lottery_session_id`ï¼ˆå¯ä¸ºç©ºï¼‰æ¥åšâ€œå¤šåˆ†å½•å…³è”â€ã€‚
- **ä»£ç å±‚å·²ç»æ˜ç¡®é‡‡ç”¨å¤šåˆ†å½•æ€æƒ³**ï¼š
  - `services/AssetConversionService.js` åœ¨æ³¨é‡Šä¸è¿”å›ç»“æ„ä¸­æ˜ç¡®äº† **åŒåˆ†å½•æ¨¡å‹**ï¼š`material_convert_debit`ï¼ˆæ‰£å‡ï¼‰+ `material_convert_credit`ï¼ˆå…¥è´¦ï¼‰ï¼Œå¹¶è¿”å› `from_tx_id/to_tx_id` ä¸¤ä¸ªæµæ°´IDã€‚
  - `services/AssetService.js` çš„å†»ç»“/è§£å†»/ç»“ç®—èƒ½åŠ›ï¼ˆ`freeze/unfreeze/settleFromFrozen` ç­‰ï¼‰å¤©ç„¶ä¼šè®©â€œä¸€ä¸ªä¸šåŠ¡åŠ¨ä½œâ€åœ¨ç”Ÿå‘½å‘¨æœŸå†…äº§ç”Ÿå¤šæ¡æµæ°´ï¼ˆä¾‹å¦‚ï¼šè´­ä¹°=å†»ç»“â†’ç»“ç®—ï¼Œå–æ¶ˆ=å†»ç»“â†’è§£å†»ï¼‰ã€‚
  - æŠ½å¥–è·¯ç”±ä¸å¹‚ç­‰è®¾è®¡é‡Œä¹Ÿå·²ç»æ‰¿è®¤â€œæŠ½å¥–å¤šåˆ†å½•å…³è”â€ï¼š`lottery_session_id` å¯ä¸ºç©ºä½†ç”¨äºæŠ½å¥–ï¼›è¯·æ±‚å¹‚ç­‰é”®ç”¨äºæ´¾ç”Ÿäº‹åŠ¡çº§å¹‚ç­‰é”®ï¼ˆè§ `routes/v4/lottery/draw.js` æ³¨é‡Šä¸å‚æ•°ä¼ é€’æ–¹å¼ï¼‰ã€‚

**è¡Œä¸šå¸¸è§åšæ³•ï¼ˆåªè®²æ¨¡å¼ï¼‰**ï¼š

- **å¤§å‚ï¼ˆç¾å›¢/é˜¿é‡Œ/è…¾è®¯ï¼‰**ï¼šåœ¨â€œèµ„é‡‘/èµ„äº§/åº“å­˜â€åŸŸé€šå¸¸é‡‡ç”¨â€œå¤šåˆ†å½•/å¤špostingâ€çš„è´¦æœ¬è¡¨è¾¾ï¼ˆåŒä¸€ä¸šåŠ¡äº‹ä»¶å¯äº§ç”Ÿå¤šæ¡ ledger entryï¼‰ï¼Œç”¨ `event_id/trace_id` å…³è”ï¼Œç¡®ä¿å®¡è®¡ä¸å¯¹è´¦å¯è¿½æº¯ã€‚
- **å°å…¬å¸**ï¼šæœ€å®¹æ˜“å‡ºäº‹æ•…çš„å°±æ˜¯â€œä¸€è¯·æ±‚ä¸€æµæ°´â€çš„å¼ºçº¦æŸï¼Œæœ€åä¼šè¢«ä¸šåŠ¡é€¼ç€åœ¨ `meta` é‡Œå¡çŠ¶æ€ï¼›å› æ­¤åªè¦ä½ æœ‰äº¤æ˜“/å†»ç»“/ç»“ç®—/é€€æ¬¾ï¼ŒåŸºæœ¬éƒ½ä¼šèµ°å‘é€‰é¡¹ Aã€‚
- **æ¸¸æˆå…¬å¸/æ´»åŠ¨ç³»ç»Ÿ**ï¼šæŠ½å¥–ã€å‘å¥–ã€æ‰£å‡ã€è¡¥å¿ã€å›æ»šéƒ½ä¾èµ–å¤šåˆ†å½•ï¼›â€œä¸€æ¬¡åŠ¨ä½œä¸€ä¸ªæµæ°´â€ä¼šæŠŠè¡¥å¿/å›æ»šè¡¨è¾¾å¾—å¾ˆè„†å¼±ï¼ˆæœ€ååªèƒ½æ”¹å†å²æµæ°´ï¼Œç ´åå®¡è®¡ï¼‰ã€‚
- **è™šæ‹Ÿç‰©å“äº¤æ˜“/å°ä¼—äºŒæ‰‹å¹³å°**ï¼šå†»ç»“â†’ç»“ç®—â†’é€€æ¬¾/è§£å†»æ˜¯åŸºæœ¬ç›˜ï¼Œå¤šåˆ†å½•æ˜¯è¡Œä¸šé»˜è®¤ï¼›å¦åˆ™æ— æ³•æŠŠâ€œå·²å†»ç»“ä½†æœªæˆäº¤â€â€œå·²æˆäº¤â€â€œå·²é€€æ¬¾â€è¿™äº›çŠ¶æ€åœ¨è´¦æœ¬ä¸Šå¹²å‡€è¡¨è¾¾å‡ºæ¥ã€‚

**ä½ é¡¹ç›®çš„æœ€ç»ˆå£å¾„ï¼ˆç ´åæ€§æ”¹é€ åï¼‰**ï¼š

- å…è®¸ä¸€ä¸ªè¯·æ±‚äº§ç”Ÿå¤šæ¡ `asset_transactions`ï¼Œä½†è¦æ±‚ï¼š
  - æ¯æ¡æµæ°´ **ç‹¬ç«‹å”¯ä¸€** `asset_transactions.idempotency_key`
  - ç”±â€œè¯·æ±‚å¹‚ç­‰é”® + posting_typeâ€ç¨³å®šæ´¾ç”Ÿï¼ˆä¾‹å¦‚ `reqKey:debit_points`ã€`reqKey:credit_item`ã€`reqKey:freeze`ã€`reqKey:settle`ï¼‰
  - ç”¨ `lottery_session_id` æˆ–æ›´é€šç”¨çš„ `business_event_id`ï¼ˆä½ å·²åœ¨è¯·æ±‚å¹‚ç­‰è¡¨é‡Œæœ‰ï¼‰æ¥åšâ€œåŒä¸€ä¸šåŠ¡äº‹ä»¶çš„å¤šåˆ†å½•å…³è”â€

#### å†³ç­– 6ï¼šæ¶ˆè´¹æäº¤ï¼ˆmerchant submitï¼‰çš„å¹‚ç­‰å£å¾„ âœ… **å·²æ‹æ¿**

**ä½ çš„å†³ç­–**ï¼š**é€‰æ‹©æ–¹æ¡ˆ Aï¼ˆå¼ºåˆ¶ `Idempotency-Key`ï¼‰+ å åŠ æ–¹æ¡ˆ B ä½œä¸ºè¯¯æ“ä½œæŠ¤æ **

**ç†ç”±ï¼ˆä¸å½“å‰ä»£ç /çœŸå®åº“å¯¹é½ï¼‰**ï¼š

- **å½“å‰ä»£ç ç°çŠ¶ï¼ˆä¸ºä»€ä¹ˆ"é˜²é‡å¤æ°¸è¿œ miss"ï¼‰**ï¼š
  - è·¯ç”±å±‚ï¼ˆ`routes/v4/shop/consumption/submit.js`ï¼‰**ä¸æ¥æ”¶ä»»ä½•å¹‚ç­‰é”®**ï¼ˆæ—¢ä¸æ”¶ Header ä¹Ÿä¸æ”¶ Bodyï¼‰
  - æœåŠ¡å±‚ï¼ˆ`ConsumptionService.merchantSubmitConsumption`ï¼‰**æ¯æ¬¡éƒ½ç”Ÿæˆæ–° `business_id`**ï¼š`consumption_${userId}_${merchantId}_${timestamp}`
  - ç»“æœï¼šå¹‚ç­‰æ£€æŸ¥ä»£ç è™½ç„¶å­˜åœ¨ï¼ˆ`findOne({ where: { business_id } })`ï¼‰ï¼Œä½†å› ä¸º `business_id` æ¯æ¬¡éƒ½æ˜¯æ–°å€¼ï¼Œ**å®é™…ä¸Šæ°¸è¿œä¸ä¼šå‘½ä¸­**
  - çœŸå®åº“éªŒè¯ï¼š`consumption_records` å…± **184 æ¡**ï¼Œ`business_id` æœ‰å”¯ä¸€çº¦æŸï¼ˆ`uk_consumption_records_business_id`ï¼‰ï¼Œä½†å› ä¸ºæœåŠ¡ç«¯æ¯æ¬¡ç”Ÿæˆæ–°å€¼ï¼Œè¿™ä¸ªçº¦æŸå¹¶ä¸èƒ½é˜²é‡å¤æäº¤

- **ä½ çš„ä¸šåŠ¡é“¾è·¯ç‰¹ç‚¹**ï¼šå•†å®¶æ‰«ç å½•å…¥ â†’ åˆ›å»º `status=pending` è®°å½• â†’ ç®¡ç†å‘˜å®¡æ ¸ â†’ å®¡æ ¸é€šè¿‡åå‘æ”¾ç§¯åˆ†ï¼ˆèµ° `AssetService.changeBalance`ï¼‰
  - è¿™æ˜¯**èµ„äº§/ç§¯åˆ†ç»æµç³»ç»Ÿçš„å†™å…¥å…¥å£**ï¼Œä¸€æ—¦é‡å¤æäº¤ä¼šå¯¼è‡´ï¼šé‡å¤å‘æ”¾ç§¯åˆ†ã€å¯¹è´¦å›°éš¾ã€å®¢æœæˆæœ¬
  - å•†å®¶ç«¯å¯èƒ½å­˜åœ¨çš„é‡å¤åœºæ™¯ï¼šç½‘ç»œè¶…æ—¶é‡è¯•ã€å¼±ç½‘é‡æ”¾ã€è¯¯ç‚¹å‡»ã€å¹¶å‘æäº¤

**è¡Œä¸šå¸¸è§åšæ³•ï¼ˆåªè®²æ¨¡å¼ï¼‰**ï¼š

- **å¤§å‚ï¼ˆç¾å›¢/é˜¿é‡Œ/è…¾è®¯ï¼‰**ï¼š
  - é€šå¸¸é‡‡ç”¨ **"å®¢æˆ·ç«¯å¹‚ç­‰é”® + æœåŠ¡ç«¯é£æ§å»é‡çª—å£ + DB å”¯ä¸€çº¦æŸå…œåº•"** ä¸‰å±‚å åŠ 
  - å®¢æˆ·ç«¯å¹‚ç­‰é”®ï¼šé˜²æ­¢ç½‘ç»œé‡è¯•ã€å¹¶å‘ã€è·¨æ—¶æ®µé‡æ”¾
  - é£æ§çª—å£ï¼šé˜²æ­¢è¯¯è§¦å‘ã€çŸ­æ—¶é—´å†…çš„é‡å¤ç‚¹å‡»
  - DB å…œåº•ï¼šæœ€åä¸€é“é˜²çº¿ï¼Œç¡®ä¿å¹¶å‘åœºæ™¯ä¸‹çš„æ•°æ®ä¸€è‡´æ€§
  - åœ¨"ç§¯åˆ†å‘æ”¾/èµ„äº§å˜åŠ¨"è¿™ç±»å…³é”®å†™å…¥é‡Œï¼Œ**å¼ºå¹‚ç­‰é”®ï¼ˆæ–¹æ¡ˆ Aï¼‰æ˜¯ä¸»è¦æœºåˆ¶**ï¼Œé£æ§çª—å£æ˜¯è¾…åŠ©

- **å°å…¬å¸ï¼ˆå•ä½“å•åº“ï¼Œè¿½æ±‚è½åœ°ï¼‰**ï¼š
  - æœ€ç¨³çš„æ˜¯ç›´æ¥åš **æ–¹æ¡ˆ A**ï¼ˆå¼ºåˆ¶ `Idempotency-Key`ï¼‰ï¼Œç®€å•å¯æ§
  - åªåšæ–¹æ¡ˆ Bï¼ˆæ—¶é—´çª—å£ï¼‰å¾€å¾€ä¼šåœ¨"è·¨åˆ†é’Ÿé‡è¯•/å¼±ç½‘é‡æ”¾"åœºæ™¯æ¼æ‰
  - å¦‚æœè¦åŠ æ–¹æ¡ˆ Bï¼Œé€šå¸¸æ˜¯ä½œä¸º"è¯¯æ“ä½œæŠ¤æ "å åŠ åœ¨ A ä¹‹ä¸Šï¼Œè€Œä¸æ˜¯æ›¿ä»£ A

- **æ¸¸æˆå…¬å¸/æ´»åŠ¨ç³»ç»Ÿ**ï¼š
  - å¸¸ç”¨ **action_id/sequenceï¼ˆç­‰ä»·äº Idempotency-Keyï¼‰** æ¥ä¿è¯"åŒä¸€æ¬¡åŠ¨ä½œåªç”Ÿæ•ˆä¸€æ¬¡"
  - åŒæ—¶ä¼šåŠ çŸ­çª—å£é˜²è¯¯ç‚¹ï¼ˆå¦‚"5ç§’å†…åŒåŠ¨ä½œæ‹¦æˆª"ï¼‰ï¼Œä½†æœ¬è´¨ä»æ˜¯ A ä¸ºä¸»
  - åœ¨"å‘å¥–/æ‰£å‡/è¡¥å¿"é“¾è·¯é‡Œï¼Œå¼ºå¹‚ç­‰é”®æ˜¯æ ‡é…

- **è™šæ‹Ÿç‰©å“äº¤æ˜“/å°ä¼—äºŒæ‰‹å¹³å°**ï¼š
  - å› ä¸ºæ¶‰åŠèµ„äº§/äº¤æ˜“ç»“æœï¼Œé€šå¸¸æ›´åå‘ **å¼ºå¹‚ç­‰é”®ï¼ˆæ–¹æ¡ˆ Aï¼‰**ï¼Œå†å åŠ é£æ§
  - åªåšæ—¶é—´çª—å£ä¼šç•™ä¸‹å¯è¢«é‡æ”¾çš„ç¼éš™ï¼ˆå°¤å…¶æ˜¯è·¨æ—¶æ®µçš„ç½‘ç»œé‡è¯•ï¼‰
  - åœ¨"ä¸‹å•/æ‰£æ¬¾/å‘è´§"é“¾è·¯é‡Œï¼Œå¹‚ç­‰é”®æ˜¯åº•çº¿

**æœ€ç»ˆå£å¾„ï¼ˆç ´åæ€§æ”¹é€ åï¼‰**ï¼š

1. **ä¸»è¦æœºåˆ¶ï¼ˆæ–¹æ¡ˆ Aï¼‰**ï¼šå•†å®¶ç«¯å¿…é¡»ä¼  `Idempotency-Key`ï¼ˆHeaderï¼‰ï¼Œç¼ºå¤±â†’400
   - è·¯ç”±å±‚ï¼š`routes/v4/shop/consumption/submit.js` å¼ºåˆ¶è¯»å– `req.headers['idempotency-key']`
   - æœåŠ¡å±‚ï¼š`ConsumptionService.merchantSubmitConsumption` ä½¿ç”¨è¯¥ key ä½œä¸º `business_id`ï¼ˆä¸å†æœåŠ¡ç«¯ç”Ÿæˆï¼‰
   - å¹‚ç­‰æ£€æŸ¥ï¼š`findOne({ where: { business_id: idempotency_key } })` èƒ½çœŸæ­£å‘½ä¸­é‡å¤è¯·æ±‚

2. **è¾…åŠ©æŠ¤æ ï¼ˆæ–¹æ¡ˆ Bï¼Œå¯é€‰å åŠ ï¼‰**ï¼š3åˆ†é’Ÿé˜²è¯¯æ“ä½œçª—å£
   - æŒ‡çº¹å®šä¹‰ï¼š`merchant_id + user_uuid + rounded_amount + time_window_3min`
   - å®ç°æ–¹å¼ï¼šåœ¨ `consumption_records` è¡¨å¢åŠ å¤åˆç´¢å¼•ï¼ˆæˆ–ç”¨ Redis åšçŸ­æœŸå»é‡ï¼‰
   - ä½œç”¨ï¼šæ‹¦æˆª"åŒå•†å®¶å¯¹åŒç”¨æˆ·åœ¨çŸ­æ—¶é—´å†…çš„é‡å¤æäº¤"ï¼ˆè¯¯è§¦å‘åœºæ™¯ï¼‰
   - **ä¸ä½œä¸ºå”¯ä¸€å¹‚ç­‰æœºåˆ¶**ï¼šæ— æ³•é˜²æ­¢è·¨æ—¶æ®µé‡è¯•ã€ç½‘ç»œé‡æ”¾

3. **å”¯ä¸€çº¦æŸå…œåº•**ï¼š`consumption_records.business_id` ä¿æŒ UNIQUEï¼ˆæ”¹é€ åæ”¹åä¸º `idempotency_key`ï¼‰

---

#### å†³ç­– 7ï¼šä¸€ä¸ªè¯·æ±‚æ˜¯å¦å…è®¸äº§ç”Ÿå¤šæ¡ `asset_transactions`

- é€‰é¡¹ Aï¼ˆæ¨èï¼‰ï¼šå…è®¸ï¼ˆæŠ½å¥–/äº¤æ˜“/å…‘æ¢å¤©ç„¶ä¼šå¤šåˆ†å½•ï¼‰ï¼Œä½†è¦æ±‚ **æ¯æ¡æµæ°´éƒ½æœ‰å”¯ä¸€ `asset_transactions.idempotency_key`**ï¼Œå¹¶ç”±"è¯·æ±‚ key æ´¾ç”Ÿ"å¾—åˆ°ï¼ˆä¾‹å¦‚ `reqKey:freeze`ã€`reqKey:settle`ã€`reqKey:refund`ï¼‰
- é€‰é¡¹ Bï¼šä¸å…è®¸ï¼ˆå¼ºåˆ¶ä¸€è¯·æ±‚ä¸€æµæ°´ï¼‰ï¼Œä¼šæ‰­æ›²è´¦åŠ¡è¡¨è¾¾ï¼Œä¸å»ºè®®

**æˆ‘é€‰æ‹©ï¼šé€‰é¡¹ Aï¼ˆå…è®¸å¤šåˆ†å½•ï¼‰**ï¼ˆè¿™æ˜¯"ç»Ÿä¸€è´¦æœ¬/ä»·å€¼æµæ°´çœŸç›¸æº"é‡Œæœ€æ ‡å‡†ã€ä¹Ÿæœ€é€‚åˆä½ ä¸šåŠ¡å½¢æ€çš„åšæ³•ï¼‰ã€‚

**ç†ç”±ï¼ˆä¸å½“å‰ä»£ç /çœŸå®åº“å¯¹é½ï¼‰**ï¼š

- **çœŸå®åº“ç°çŠ¶**ï¼š`.env` æŒ‡å‘çš„çœŸå®åº“é‡Œ `asset_transactions` å½“å‰æ˜¯ç©ºè¡¨ï¼ˆ`COUNT(*)=0`ï¼‰ï¼Œæ‰€ä»¥æš‚æ—¶æ— æ³•ç”¨å†å²æ•°æ®è¯æ˜"åŒä¸€è¯·æ±‚å¤šåˆ†å½•"çš„æ—¢æˆäº‹å®ï¼›ä½†è¡¨ç»“æ„å·²ç»é¢„ç•™äº† `lottery_session_id`ï¼ˆå¯ä¸ºç©ºï¼‰æ¥åš"å¤šåˆ†å½•å…³è”"ã€‚
- **ä»£ç å±‚å·²ç»æ˜ç¡®é‡‡ç”¨å¤šåˆ†å½•æ€æƒ³**ï¼š
  - `services/AssetConversionService.js` åœ¨æ³¨é‡Šä¸è¿”å›ç»“æ„ä¸­æ˜ç¡®äº† **åŒåˆ†å½•æ¨¡å‹**ï¼š`material_convert_debit`ï¼ˆæ‰£å‡ï¼‰+ `material_convert_credit`ï¼ˆå…¥è´¦ï¼‰ï¼Œå¹¶è¿”å› `from_tx_id/to_tx_id` ä¸¤ä¸ªæµæ°´IDã€‚
  - `services/AssetService.js` çš„å†»ç»“/è§£å†»/ç»“ç®—èƒ½åŠ›ï¼ˆ`freeze/unfreeze/settleFromFrozen` ç­‰ï¼‰å¤©ç„¶ä¼šè®©"ä¸€ä¸ªä¸šåŠ¡åŠ¨ä½œ"åœ¨ç”Ÿå‘½å‘¨æœŸå†…äº§ç”Ÿå¤šæ¡æµæ°´ï¼ˆä¾‹å¦‚ï¼šè´­ä¹°=å†»ç»“â†’ç»“ç®—ï¼Œå–æ¶ˆ=å†»ç»“â†’è§£å†»ï¼‰ã€‚
  - æŠ½å¥–è·¯ç”±ä¸å¹‚ç­‰è®¾è®¡é‡Œä¹Ÿå·²ç»æ‰¿è®¤"æŠ½å¥–å¤šåˆ†å½•å…³è”"ï¼š`lottery_session_id` å¯ä¸ºç©ºä½†ç”¨äºæŠ½å¥–ï¼›è¯·æ±‚å¹‚ç­‰é”®ç”¨äºæ´¾ç”Ÿäº‹åŠ¡çº§å¹‚ç­‰é”®ï¼ˆè§ `routes/v4/lottery/draw.js` æ³¨é‡Šä¸å‚æ•°ä¼ é€’æ–¹å¼ï¼‰ã€‚

**è¡Œä¸šå¸¸è§åšæ³•ï¼ˆåªè®²æ¨¡å¼ï¼‰**ï¼š

- **å¤§å‚ï¼ˆç¾å›¢/é˜¿é‡Œ/è…¾è®¯ï¼‰**ï¼šåœ¨"èµ„é‡‘/èµ„äº§/åº“å­˜"åŸŸé€šå¸¸é‡‡ç”¨"å¤šåˆ†å½•/å¤šposting"çš„è´¦æœ¬è¡¨è¾¾ï¼ˆåŒä¸€ä¸šåŠ¡äº‹ä»¶å¯äº§ç”Ÿå¤šæ¡ ledger entryï¼‰ï¼Œç”¨ `event_id/trace_id` å…³è”ï¼Œç¡®ä¿å®¡è®¡ä¸å¯¹è´¦å¯è¿½æº¯ã€‚
- **å°å…¬å¸**ï¼šæœ€å®¹æ˜“å‡ºäº‹æ•…çš„å°±æ˜¯"ä¸€è¯·æ±‚ä¸€æµæ°´"çš„å¼ºçº¦æŸï¼Œæœ€åä¼šè¢«ä¸šåŠ¡é€¼ç€åœ¨ `meta` é‡Œå¡çŠ¶æ€ï¼›å› æ­¤åªè¦ä½ æœ‰äº¤æ˜“/å†»ç»“/ç»“ç®—/é€€æ¬¾ï¼ŒåŸºæœ¬éƒ½ä¼šèµ°å‘é€‰é¡¹ Aã€‚
- **æ¸¸æˆå…¬å¸/æ´»åŠ¨ç³»ç»Ÿ**ï¼šæŠ½å¥–ã€å‘å¥–ã€æ‰£å‡ã€è¡¥å¿ã€å›æ»šéƒ½ä¾èµ–å¤šåˆ†å½•ï¼›"ä¸€æ¬¡åŠ¨ä½œä¸€ä¸ªæµæ°´"ä¼šæŠŠè¡¥å¿/å›æ»šè¡¨è¾¾å¾—å¾ˆè„†å¼±ï¼ˆæœ€ååªèƒ½æ”¹å†å²æµæ°´ï¼Œç ´åå®¡è®¡ï¼‰ã€‚
- **è™šæ‹Ÿç‰©å“äº¤æ˜“/å°ä¼—äºŒæ‰‹å¹³å°**ï¼šå†»ç»“â†’ç»“ç®—â†’é€€æ¬¾/è§£å†»æ˜¯åŸºæœ¬ç›˜ï¼Œå¤šåˆ†å½•æ˜¯è¡Œä¸šé»˜è®¤ï¼›å¦åˆ™æ— æ³•æŠŠ"å·²å†»ç»“ä½†æœªæˆäº¤""å·²æˆäº¤""å·²é€€æ¬¾"è¿™äº›çŠ¶æ€åœ¨è´¦æœ¬ä¸Šå¹²å‡€è¡¨è¾¾å‡ºæ¥ã€‚

**ä½ é¡¹ç›®çš„æœ€ç»ˆå£å¾„ï¼ˆç ´åæ€§æ”¹é€ åï¼‰**ï¼š

- å…è®¸ä¸€ä¸ªè¯·æ±‚äº§ç”Ÿå¤šæ¡ `asset_transactions`ï¼Œä½†è¦æ±‚ï¼š
  - æ¯æ¡æµæ°´ **ç‹¬ç«‹å”¯ä¸€** `asset_transactions.idempotency_key`
  - ç”±"è¯·æ±‚å¹‚ç­‰é”® + posting_type"ç¨³å®šæ´¾ç”Ÿï¼ˆä¾‹å¦‚ `reqKey:debit_points`ã€`reqKey:credit_item`ã€`reqKey:freeze`ã€`reqKey:settle`ï¼‰
  - ç”¨ `lottery_session_id` æˆ–æ›´é€šç”¨çš„ `business_event_id`ï¼ˆä½ å·²åœ¨è¯·æ±‚å¹‚ç­‰è¡¨é‡Œæœ‰ï¼‰æ¥åš"åŒä¸€ä¸šåŠ¡äº‹ä»¶çš„å¤šåˆ†å½•å…³è”"

#### å†³ç­– 8ï¼šæ˜¯å¦å½»åº•åˆ é™¤é—ç•™/å½’æ¡£è¡¨ï¼ˆæŒ‰ä½ çš„"ç ´åæ€§ä¸ä¿ç•™æ—§æ•°æ®"åŸåˆ™ï¼‰

- é€‰é¡¹ Aï¼ˆæ¨èï¼‰ï¼š**åˆ é™¤**ï¼ˆ`DROP TABLE asset_transactions_archive_20251226` ç­‰ä¸€åˆ‡æ—§è¡¨/æ—§æ•°æ®ï¼‰
- é€‰é¡¹ Bï¼šä¿ç•™ä½†ä¸šåŠ¡å®Œå…¨ä¸è¯»å–ï¼ˆä¼šç•™ä¸‹"ç¬¬äºŒçœŸç›¸æº"çš„éšæ‚£ï¼Œä¸”è¿èƒŒä½ çš„ç›®æ ‡ï¼‰

\***\*æˆ‘é€‰æ‹©æ–¹æ¡ˆA ï¼šé€‰é¡¹ Aï¼ˆåˆ é™¤ï¼‰**ï¼ˆå®Œå…¨ç¬¦åˆä½ "ç ´åæ€§ã€ä¸ä¿ç•™æ—§æ•°æ®ã€å•ä¸€çœŸç›¸æº"çš„è¦æ±‚ï¼‰ã€‚

**ç†ç”±ï¼ˆä¸çœŸå®åº“/å½“å‰ä»£ç å¯¹é½ï¼‰**ï¼š

- çœŸå®åº“ï¼ˆ`.env` æŒ‡å‘çš„ `restaurant_points_dev`ï¼‰é‡Œï¼Œç¡®å®å­˜åœ¨é—ç•™è¡¨ï¼š`asset_transactions_archive_20251226`ï¼Œä¸”è¡Œæ•° **1174**ã€‚
- åŒæ—¶ï¼ŒçœŸå®åº“çš„ `asset_transactions` å½“å‰æ˜¯ç©ºè¡¨ï¼ˆå‰é¢å†³ç­–7çš„ DB æŸ¥è¯¢å·²éªŒè¯ `COUNT(*)=0`ï¼‰ï¼Œè¯´æ˜è¿™å¼  archive è¡¨éå¸¸å®¹æ˜“è¢«è¯¯å½“ä½œ"çœŸå®å†å²è´¦æœ¬"ç»§ç»­è¢«è¯»/è¢«å¯¹è´¦ä½¿ç”¨ï¼Œå½¢æˆ**ç¬¬äºŒçœŸç›¸æº**ã€‚
- å…¨ä»“æ‰«æï¼ˆå½“å‰ä»£ç çŠ¶æ€ï¼‰æœªå‘ç°ä»»ä½•è¿è¡Œæ—¶ä»£ç ï¼ˆroutes/services/jobsï¼‰åœ¨æŸ¥è¯¢ `asset_transactions_archive_20251226`ï¼›å®ƒä¸»è¦æ¥è‡ªï¼š
  - è¿ç§»è„šæœ¬ï¼š`migrations/20251226150000-breaking-upgrade-idempotency-architecture-standard.js`ï¼ˆå‡çº§æ—¶å½’æ¡£æ—§è¡¨æ•°æ®ï¼‰
  - æ–‡æ¡£/å¤‡ä»½æ–‡ä»¶ï¼ˆä¸å±äºçº¿ä¸Šè¯»è·¯å¾„ï¼‰
    â‡’ è¿™æ„å‘³ç€ï¼š**åˆ é™¤è¯¥è¡¨ä¸ä¼šå½±å“å½“å‰ä¸šåŠ¡è¯»å†™é€»è¾‘**ï¼Œåè€Œä¼šé™ä½æœªæ¥è¯¯ç”¨é£é™©ã€‚

**è¡Œä¸šå¸¸è§åšæ³•ï¼ˆåªè®²æ¨¡å¼ï¼‰**ï¼š

- **å¤§å‚ï¼ˆç¾å›¢/é˜¿é‡Œ/è…¾è®¯ï¼‰**ï¼šä¼šæŠŠ"å½’æ¡£"çº³å…¥æ•°æ®ç”Ÿå‘½å‘¨æœŸæ²»ç†ï¼ˆå†·çƒ­åˆ†å±‚ã€æ•°ä»“å½’æ¡£ï¼‰ï¼Œä½†**çº¿ä¸Šäº¤æ˜“ç³»ç»Ÿ**ä¸€å®šä¿è¯"åœ¨çº¿çœŸç›¸æºå”¯ä¸€"ã€‚å¦‚æœå­˜åœ¨ archive è¡¨ï¼Œä¹Ÿä¼šåšåˆ°ï¼šæƒé™éš”ç¦» + ä¸åœ¨åœ¨çº¿æœåŠ¡è¿æ¥æƒé™èŒƒå›´å†… + æ˜ç¡®ä¸å¯è¯»/ä¸å¯å†™ã€‚
- **å°å…¬å¸**ï¼šæœ€å®¹æ˜“è¸©å‘çš„æ˜¯"ç•™ä¸€ä¸ª archive è¡¨ä»¥é˜²ä¸‡ä¸€"ï¼Œç»“æœåŠå¹´åè¢«æ–°åŒå­¦/è„šæœ¬è¯¯ç”¨ï¼Œå½¢æˆåŒè´¦æœ¬ï¼›æ‰€ä»¥åœ¨ä½ è¿™ç§"ç ´åæ€§é‡æ„"ç›®æ ‡ä¸‹ï¼Œæœ€ä½³åšæ³•å°±æ˜¯åˆ é™¤ã€‚
- **æ¸¸æˆ/æ´»åŠ¨ç³»ç»Ÿ**ï¼šçº¿ä¸Šè´¦æœ¬/èµ„äº§çœŸç›¸æºå¿…é¡»å”¯ä¸€ï¼Œå¦åˆ™è¡¥å¿ã€å›æ»šã€å®¡è®¡ä¼šæ··ä¹±ï¼›å†å²æ•°æ®å¦‚æœè¦ç•™ï¼Œé€šå¸¸è¿›ç¦»çº¿ç³»ç»Ÿï¼ˆæŠ¥è¡¨/å®¡è®¡åº“ï¼‰ï¼Œè€Œä¸æ˜¯ç•™åœ¨åŒä¸€ä¸ªçº¿ä¸Šåº“é‡Œå½“"åŠçœŸç›¸"ã€‚
- **è™šæ‹Ÿç‰©å“äº¤æ˜“/å°ä¼—äºŒæ‰‹å¹³å°**ï¼šå¯¹è´¦ã€çº çº·ã€å®¡è®¡å¼ºä¾èµ–"å•ä¸€å¯è¿½æº¯è´¦æœ¬"ï¼›ç•™ä¸‹ archive ä¼šè®©çº çº·å¤„ç†æ—¶å‡ºç°"åˆ°åº•ä¿¡å“ªå¼ è¡¨"çš„ä¸å¯æ§é£é™©ã€‚

**æœ€ç»ˆå£å¾„ï¼ˆä½ æ‹æ¿åå°±æŒ‰è¿™ä¸ªæ‰§è¡Œï¼‰**ï¼š

- çœŸå®åº“æ ¸æŸ¥ï¼ˆ2026-01-02ï¼‰ï¼š`.env` æŒ‡å‘çš„ `restaurant_points_dev` é‡Œ **ä¸å­˜åœ¨ä»»ä½• `asset_transactions_archive_*` å½’æ¡£è¡¨**
- è‹¥æœªæ¥ç¡®å®éœ€è¦ç•™å†å²ï¼šä¹Ÿåº”èµ°**ç¦»çº¿å­˜å‚¨/æŠ¥è¡¨åº“**ï¼ˆä½†ä½ å½“å‰æ˜ç¡®"ä¸ä¿ç•™æ—§æ•°æ®"ï¼Œå› æ­¤æ— éœ€å½’æ¡£ï¼‰

#### å†³ç­– 9ï¼šæ˜¯å¦å½»åº•åˆ é™¤é—ç•™/å½’æ¡£è¡¨ï¼ˆæŒ‰ä½ çš„"ç ´åæ€§ä¸ä¿ç•™æ—§æ•°æ®"åŸåˆ™ï¼‰ âœ… **å·²æ‹æ¿**

**ä½ çš„å†³ç­–**ï¼š**é€‰é¡¹ Aï¼ˆåˆ é™¤ï¼‰**

**çœŸå®åº“æ ¸æŸ¥ç»“æœï¼ˆ2026-01-02ï¼‰**ï¼š

- è¿æ¥ç›®æ ‡ï¼š`dbconn.sealosbja.site:42569 / restaurant_points_dev`ï¼ˆNode.js + Sequelize ç›´è¿ï¼‰
- å½’æ¡£è¡¨æŸ¥è¯¢ç»“æœï¼š**ä¸å­˜åœ¨ä»»ä½• `asset_transactions_archive_*` è¡¨**
- ç»“è®ºï¼šå½“å‰çœŸå®åº“å·²ç»æ˜¯"å•ä¸€çœŸç›¸æº"çŠ¶æ€ï¼Œæ— éœ€æ‰§è¡Œåˆ é™¤æ“ä½œ

**æœ€ç»ˆå£å¾„**ï¼š

- çº¿ä¸Š DB é‡Œ **ä¸å…è®¸å­˜åœ¨**ä»»ä½•"å¯èƒ½è¢«å½“çœŸç›¸æº"çš„å½’æ¡£è¡¨
- è‹¥æœªæ¥ç¡®å®éœ€è¦ç•™å†å²ï¼šä¹Ÿåº”èµ°**ç¦»çº¿å­˜å‚¨/æŠ¥è¡¨åº“**ï¼ˆä½†ä½ å½“å‰æ˜ç¡®"ä¸ä¿ç•™æ—§æ•°æ®"ï¼Œå› æ­¤æ— éœ€å½’æ¡£ï¼‰

---

#### å†³ç­– 10ï¼šç ´åæ€§åˆ‡æ¢çš„ä¸Šçº¿æ–¹å¼ âœ… **å·²æ‹æ¿**

**ä½ çš„å†³ç­–**ï¼š**é€‰é¡¹ Aï¼ˆä¸€æ¬¡æ€§åœæœºçª—å£ï¼‰**

---

## ä¹ã€æœ€ç»ˆéªŒæ”¶æ ‡å‡†ï¼ˆä½ è¦çš„"å¹²å‡€ç»Ÿä¸€"å¦‚ä½•éªŒè¯ï¼Ÿï¼‰

1. **å¹‚ç­‰ç»Ÿä¸€**ï¼šå…¨ç³»ç»Ÿåªæœ‰ `Idempotency-Key` ä¸€ç§å¹‚ç­‰å…¥å£ï¼›æ²¡æœ‰ `business_id` æ¦‚å¿µæ®‹ç•™ã€‚
2. **çœŸç›¸æºå”¯ä¸€**ï¼šä»·å€¼çœ‹ `asset_transactions`ï¼›ä½™é¢çœ‹ `account_asset_balances`ï¼›ç‰©å“æ‰€æœ‰æƒçœ‹ `item_instances`ï¼›è®¢å•çŠ¶æ€çœ‹å¯¹åº”è®¢å•è¡¨ã€‚
3. **å¹¶å‘å¯è¯æ˜å®‰å…¨**ï¼šå¹¶å‘é‡è¯•ä¸ä¼šäº§ç”Ÿé‡å¤æ‰£å‡/é‡å¤å‘è´§/é‡å¤å‘å¥–ã€‚
4. **å¯¹è´¦ä¸å®¡è®¡é—­ç¯**ï¼šä»»æ„ä¸€ç¬”èµ„äº§å˜åŠ¨éƒ½èƒ½è¿½æº¯åˆ°å¯¹åº”ä¸šåŠ¡å®ä½“ä¸å¹‚ç­‰é”®ã€‚
5. **å­—æ®µå‘½åä¸€è‡´**ï¼šæ‰€æœ‰ä¸šåŠ¡è¡¨å¹‚ç­‰åˆ—ç»Ÿä¸€ä¸º `idempotency_key`ï¼Œæ•°æ®åº“ä¸­ä¸å­˜åœ¨ `business_id` åˆ—ï¼ˆä¸šåŠ¡å•å·é™¤å¤–ï¼‰ã€‚
6. **è¯·æ±‚å¹‚ç­‰å…¨è¦†ç›–**ï¼šæ‰€æœ‰å…³é”®å†™å…¥ç»Ÿä¸€æ¥å…¥è¯·æ±‚çº§å¹‚ç­‰ï¼Œå›æ”¾/å†²çª/å¤„ç†ä¸­è¯­ä¹‰ä¸€è‡´ã€‚
