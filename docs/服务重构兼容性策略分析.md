# 服务重构兼容性策略分析

> **创建日期**：2026年1月31日  
> **最后更新**：2026年2月2日  
> **背景**：后端服务层大文件拆分重构（V4.7.0）  
> **核心问题**：服务拆分后路由层调用的服务键是否与方法所在子服务匹配？

---

## 技术架构概览

### 项目技术栈（2026-02-02 实际验证）

| 技术 | 版本/说明 | 用途 | 验证来源 |
|-----|---------|------|---------|
| **Node.js** | v20.18.0+ | 运行时环境 | `package.json:engines` |
| **Express** | v4.18.2 | Web 框架 | `package.json:dependencies` |
| **Sequelize** | v6.35.2 | ORM 框架 | `package.json:dependencies` |
| **MySQL** | 8.0+ | 关系型数据库 | `mysql2: ^3.6.5` |
| **Redis** | 6.0+ | 缓存/会话存储 | `ioredis: ^5.7.0` |
| **JWT** | v9.0.2 | 身份认证 | `jsonwebtoken` |
| **RBAC** | - | 权限控制 | 自定义实现 |
| **Socket.io** | v4.8.1 | WebSocket | `package.json:dependencies` |
| **Winston** | v3.11.0 | 日志系统 | `package.json:dependencies` |

### 服务调用架构（核心设计模式）

```javascript
// 🔹 ServiceManager 单例模式（services/index.js）
class ServiceManager {
  constructor() {
    this._services = new Map()
  }
  
  getService(key) {
    return this._services.get(key)
  }
}

// 🔹 路由层服务获取模式
router.get('/endpoint', async (req, res) => {
  const Service = req.app.locals.services.getService('service_key')
  const result = await Service.methodName()
})

// 🔹 服务注册模式（snake_case 键名）
this._services.set('reporting_stats', StatsService)       // 静态类
this._services.set('reporting_analytics', AnalyticsService) // 静态类
```

### 可复用架构组件

| 组件 | 位置 | 可复用场景 |
|-----|------|----------|
| **ServiceManager** | `services/index.js` | 任何需要依赖注入的新服务 |
| **静态类服务模式** | `services/*/*.js` | 无状态业务逻辑封装 |
| **TransactionManager** | `utils/TransactionManager.js` | 跨服务事务处理 |
| **BeijingTimeHelper** | `utils/timeHelper.js` | 北京时间处理 |
| **BusinessCacheHelper** | `utils/BusinessCacheHelper.js` | Redis 缓存封装 |

### 可扩展点

| 扩展点 | 扩展方式 | 示例 |
|-------|---------|------|
| **添加新子服务** | 创建静态类 → ServiceManager 注册 → 路由层获取 | 新增 `ExportService` |
| **服务内部互调** | 通过 ServiceManager 获取，不直接 require | 避免循环依赖 |
| **批量操作扩展** | 继承现有服务，添加批量方法 | `ConsumptionBatchService` |

---

## 1. 当前重构现状

### 1.1 已完成的服务拆分

| 原服务文件 | 原代码行数 | 拆分后结构 | 拆分方式 | 当前状态 |
|-----------|-----------|-----------|---------|---------|
| `ReportingService.js` | 1820行 | `services/reporting/` | 4个子服务 + index.js | ✅ 已删除原文件 |
| `ConsumptionService.js` | 1826行 | `services/consumption/` | 4个子服务 + index.js | ✅ 已删除原文件 |
| `CustomerService` | - | `services/customer-service/` | 模块化目录 | ✅ 已完成 |

### 1.2 当前服务结构（2026-02-02 实际状态）

**reporting 子服务**（4个）：
- `StatsService` - 统计概览、用户画像、库存统计
- `AnalyticsService` - 决策分析、趋势分析
- `ChartsService` - 图表数据生成
- `MultiDimensionStatsService` - 多维度组合统计、下钻明细（B-25/B-27）

**consumption 子服务**（4个）：
- `CoreService` - 核心操作（提交/审核/删除/恢复）
- `QueryService` - 查询服务（用户/管理员/待审核列表）
- `MerchantService` - 商家侧服务（商家员工专用查询）
- `AnomalyService` - 消费异常检测服务（P1 B-25）

```javascript
// services/reporting/index.js（实际代码）
const AnalyticsService = require('./AnalyticsService')
const ChartsService = require('./ChartsService')
const StatsService = require('./StatsService')
const MultiDimensionStatsService = require('./MultiDimensionStatsService')

module.exports = {
  AnalyticsService,
  ChartsService,
  StatsService,
  MultiDimensionStatsService
}
```

---

## 2. 两种策略对比

### 策略 A：保持兼容（当前方案）

**实现方式**：通过 `index.js` 模拟旧接口

```javascript
// 兼容层示例
const ReportingService = {
  getTodayStats: (...args) => StatsService.getTodayStats(...args),
  getDecisionAnalytics: (...args) => AnalyticsService.getDecisionAnalytics(...args),
  getChartsData: (...args) => ChartsService.getChartsData(...args),
  // ...其他方法映射
}
module.exports = { ReportingService, StatsService, AnalyticsService, ChartsService }
```

| 优点 | 缺点 |
|------|------|
| ✅ 零改动成本，立即可用 | ❌ 技术债务累积 |
| ✅ 降低引入 bug 风险 | ❌ 新开发者困惑（两套调用方式） |
| ✅ 渐进式迁移，风险可控 | ❌ 兼容层代码需长期维护 |
| ✅ 不影响正在进行的开发 | ❌ 代码库一致性差 |

### 策略 B：不保持兼容（直接迁移）

**实现方式**：删除旧接口，强制使用新的子服务

```javascript
// 直接引用新服务
const { StatsService } = require('./services/reporting')
const stats = await StatsService.getTodayStats()

// 或
const StatsService = require('./services/reporting/StatsService')
const stats = await StatsService.getTodayStats()
```

| 优点 | 缺点 |
|------|------|
| ✅ 代码库一致性高 | ❌ 需要批量修改调用方 |
| ✅ 新开发者认知负担低 | ❌ 迁移期间可能引入 bug |
| ✅ 无技术债务累积 | ❌ 需要完整的回归测试 |
| ✅ 明确的职责边界 | ❌ 阻塞其他并行开发 |

---

## 3. 决策维度分析

### 3.1 项目阶段考量

| 项目阶段 | 推荐策略 | 理由 |
|---------|---------|------|
| **早期开发阶段** | 策略 B（不兼容） | 代码量少，迁移成本低 |
| **中期迭代阶段** | 策略 A+期限（兼容+废弃计划） | 平衡开发效率和技术债务 |
| **成熟稳定阶段** | 策略 A（兼容） | 稳定性优先，避免风险 |

**本项目当前阶段**：中期迭代阶段（V4.7.0，功能持续迭代中）

### 3.2 团队规模考量

| 团队规模 | 推荐策略 | 理由 |
|---------|---------|------|
| **1-3人小团队** | 策略 B | 沟通成本低，快速统一 |
| **4-10人中团队** | 策略 A+期限 | 需要协调，渐进式迁移 |
| **10+人大团队** | 策略 A | 并行开发需求高 |

### 3.3 调用方数量考量（2026-02-02 实际统计）

| 指标 | 实际调用点 | 涉及文件 | 迁移影响评估 |
|------|-----------|---------|-------------|
| **ReportingService 调用点** | 11 处 | 5 个文件 | 中等工作量（0.5天） |
| **ConsumptionService 调用点** | 13 处 | 5 个文件 | 中等工作量（0.5天） |
| **合计** | 24 处 | 10 个文件 | 总计约 1 天 |

### 3.4 长期维护成本对比

| 维护项 | 策略 A（兼容） | 策略 B（不兼容） |
|-------|--------------|----------------|
| **首次迁移成本** | 0 | 1.5-2天 |
| **每年维护成本** | 0.5天/年（兼容层维护） | 0 |
| **新人培训成本** | +0.5天（需解释两套方式） | 0 |
| **3年总成本** | 1.5天 | 1.5-2天 |
| **代码质量债务** | 持续累积 | 一次性清零 |

---

## 4. 推荐方案：策略 A+ （兼容 + 废弃计划）

### 4.1 核心思路

**短期兼容，长期迁移**：保持兼容层运行，同时制定明确的废弃时间表。

### 4.2 实施步骤

#### 阶段一：添加废弃警告（立即执行）

```javascript
// services/reporting/index.js - 添加废弃警告

// ⚠️ 废弃兼容层 - 将于 2026-03-01 移除
const ReportingService = {
  /** @deprecated 使用 StatsService.getTodayStats() 替代 */
  getTodayStats: (...args) => {
    console.warn('[DEPRECATED] ReportingService.getTodayStats() 已废弃，请使用 StatsService.getTodayStats()')
    return StatsService.getTodayStats(...args)
  },
  // ...
}
```

#### 阶段二：新代码强制使用新接口（即日起）

**代码审查规则**：
- ❌ 禁止新代码使用 `ReportingService.xxx()`
- ✅ 必须使用 `StatsService.xxx()` / `AnalyticsService.xxx()` / `ChartsService.xxx()`

#### 阶段三：存量代码逐步迁移（2周内完成）

| 周次 | 迁移范围 | 负责人 | 预计工时 |
|------|---------|-------|---------|
| 第1周 | `routes/v4/console/` 下所有调用 | - | 1天 |
| 第2周 | `services/` 内部互调用 | - | 0.5天 |
| 第2周 | 其他调用点 + 回归测试 | - | 0.5天 |

#### 阶段四：移除兼容层（2026-03-01）

- 删除 `index.js` 中的 `ReportingService` 兼容导出
- 保留 `StatsService`、`AnalyticsService`、`ChartsService` 导出

### 4.3 废弃时间表

| 服务 | 废弃警告生效 | 停止兼容 | 移除兼容层 |
|------|-------------|---------|-----------|
| **ReportingService** | 2026-01-31 | 2026-02-15 | 2026-03-01 |
| **ConsumptionService** | 2026-01-31 | 2026-02-15 | 2026-03-01 |
| **CustomerService** | 当前已是新结构 | - | - |

---

## 5. 迁移代码示例

### 5.1 ReportingService 迁移

```javascript
// ❌ 旧代码（废弃）
const ReportingService = require('../services/ReportingService')
const stats = await ReportingService.getTodayStats()
const analytics = await ReportingService.getDecisionAnalytics(7)
const charts = await ReportingService.getChartsData(30)

// ✅ 新代码（推荐）
const { StatsService, AnalyticsService, ChartsService, MultiDimensionStatsService } = require('../services/reporting')
const stats = await StatsService.getTodayStats()
const analytics = await AnalyticsService.getDecisionAnalytics(7)
const charts = await ChartsService.getChartsData(30)
const multiStats = await MultiDimensionStatsService.getMultiDimensionStats(options)
```

### 5.2 ConsumptionService 迁移

```javascript
// ❌ 旧代码（废弃）
const ConsumptionService = require('../services/ConsumptionService')
const pending = await ConsumptionService.getPendingConsumptionRecords()
await ConsumptionService.approveConsumption(id, adminId)

// ✅ 新代码（推荐）
const { QueryService, CoreService, MerchantService, AnomalyService } = require('../services/consumption')
const pending = await QueryService.getPendingConsumptionRecords()
await CoreService.approveConsumption(id, adminId)
const merchantRecords = await MerchantService.getMerchantRecords(merchantId)
const anomalies = await AnomalyService.detectAnomalies(records)
```

---

## 6. 风险控制

### 6.1 迁移前检查清单

- [ ] 使用 `grep` 确认所有调用点
- [ ] 确认单元测试覆盖关键路径
- [ ] 准备回滚方案（保留旧文件副本）

### 6.2 迁移期间监控

```bash
# 监控废弃警告日志
grep -r "DEPRECATED" logs/app.log | wc -l
```

### 6.3 回滚方案

如迁移过程中发现严重问题：
1. 恢复 `index.js` 中的兼容层导出
2. 还原已修改的调用方代码
3. 延长废弃时间表

---

## 7. 最终决策

### ✅ 采用策略 B（不保持兼容，直接迁移）

| 决策点 | 结论 |
|-------|------|
| **是否保持兼容？** | ❌ 不保持，直接迁移 |
| **迁移方式** | 一次性批量修改所有调用点 |
| **预计工时** | 1-2 天 |
| **执行时间** | 2026-02-02 起 |

### 选择理由

1. **代码库一致性**：避免新旧两套调用方式并存
2. **零技术债务**：不引入兼容层维护成本
3. **调用点可控**：实际调用点 24 处，迁移工作量可接受（约 1 天）
4. **新人友好**：无需解释历史兼容逻辑
5. **已删除原文件**：旧服务文件已删除，兼容层已移除，迁移是必要的

### 实际调用点统计（2026-02-02 grep 验证）

| 服务 | 调用点数量 | 涉及文件 |
|-----|-----------|---------|
| **ReportingService** | 11 处 | 5 个文件 |
| **ConsumptionService** | 13 处 | 5 个文件 |
| **合计** | 24 处 | 10 个文件 |

### 当前服务状态

| 状态项 | 状态 |
|-------|------|
| 旧服务文件 `ReportingService.js` | ✅ 已删除 |
| 旧服务文件 `ConsumptionService.js` | ✅ 已删除 |
| `services/index.js` 兼容层 | ✅ 已移除 |
| 新子服务目录 `services/reporting/` | ✅ 已创建（4个子服务） |
| 新子服务目录 `services/consumption/` | ✅ 已创建（4个子服务） |
| ServiceManager 子服务注册 | ✅ 已完成 |
| 路由层调用迁移 | ⏳ 待执行（24处） |

---

## 8. 迁移执行计划

### 8.1 ReportingService 迁移清单

| 文件 | 调用方法 | 迁移目标 |
|-----|---------|---------|
| `routes/v4/system/user-stats.js` | `getUserStatistics()` | `StatsService.getUserStatistics()` |
| `routes/v4/system/user-stats.js` | `getSystemOverview()` | `StatsService.getSystemOverview()` |
| `routes/v4/system/statistics.js` | `getChartsData()` ×3 | `ChartsService.getChartsData()` |
| `routes/v4/system/status.js` | `getSystemOverview()` | `StatsService.getSystemOverview()` |
| `routes/v4/console/shared/middleware.js` | `getSimpleSystemStats()` | `StatsService.getSimpleSystemStats()` |
| `routes/v4/console/analytics.js` | `getDecisionAnalytics()` | `AnalyticsService.getDecisionAnalytics()` |
| `routes/v4/console/analytics.js` | `getLotteryTrends()` | `AnalyticsService.getLotteryTrends()` |
| `routes/v4/console/analytics.js` | `getPerformanceReport()` | `AnalyticsService.getPerformanceReport()` |

### 8.2 ConsumptionService 迁移清单

| 文件 | 调用方法 | 迁移目标 |
|-----|---------|---------|
| `routes/v4/shop/consumption/qrcode.js` | `getUserInfoByQRCode()` | `QueryService.getUserInfoByQRCode()` |
| `routes/v4/shop/consumption/submit.js` | `merchantSubmitConsumption()` | `CoreService.merchantSubmitConsumption()` |
| `routes/v4/shop/consumption/merchant-query.js` | `getMerchantRecords()` | `MerchantService.getMerchantRecords()` |
| `routes/v4/shop/consumption/merchant-query.js` | `getMerchantRecordDetail()` | `MerchantService.getMerchantRecordDetail()` |
| `routes/v4/shop/consumption/merchant-query.js` | `getMerchantStats()` | `MerchantService.getMerchantStats()` |
| `routes/v4/shop/consumption/query.js` | `getUserConsumptionRecords()` | `QueryService.getUserConsumptionRecords()` |
| `routes/v4/shop/consumption/query.js` | `getConsumptionDetailWithAuth()` | `QueryService.getConsumptionDetailWithAuth()` |
| `routes/v4/shop/consumption/query.js` | `softDeleteRecord()` | `CoreService.softDeleteRecord()` |
| `routes/v4/shop/consumption/query.js` | `restoreRecord()` | `CoreService.restoreRecord()` |
| `routes/v4/console/consumption.js` | `getPendingConsumptionRecords()` | `QueryService.getPendingConsumptionRecords()` |
| `routes/v4/console/consumption.js` | `getAdminRecords()` | `QueryService.getAdminRecords()` |
| `routes/v4/console/consumption.js` | `approveConsumption()` | `CoreService.approveConsumption()` |
| `routes/v4/console/consumption.js` | `rejectConsumption()` | `CoreService.rejectConsumption()` |

### 8.3 迁移步骤

```bash
# 步骤 1：修改 import 语句
# 旧：const ReportingService = require('../services/ReportingService')
# 新：const { StatsService, AnalyticsService, ChartsService } = require('../services/reporting')

# 步骤 2：替换方法调用
# 旧：ReportingService.getChartsData()
# 新：ChartsService.getChartsData()

# 步骤 3：运行测试验证
npm test

# 步骤 4：删除兼容层（如有）
# 删除 services/index.js 中的 ReportingService 兼容导出
```

### 8.4 验收标准

- [ ] 所有调用点已迁移（24处）
- [ ] 无 `ReportingService.` 或 `ConsumptionService.` 旧调用
- [ ] 服务启动正常，无报错
- [ ] 核心功能回归测试通过

### 8.5 迁移后 ServiceManager 键名对照

| 旧调用方式 | 新 ServiceManager 键 | 新子服务类 |
|-----------|---------------------|-----------|
| `ReportingService.getTodayStats()` | `reporting_stats` | `StatsService` |
| `ReportingService.getDecisionAnalytics()` | `reporting_analytics` | `AnalyticsService` |
| `ReportingService.getChartsData()` | `reporting_charts` | `ChartsService` |
| `ConsumptionService.getPendingConsumptionRecords()` | `consumption_query` | `QueryService` |
| `ConsumptionService.approveConsumption()` | `consumption_core` | `CoreService` |
| `ConsumptionService.getMerchantRecords()` | `consumption_merchant` | `MerchantService` |

---

## 附录：快速迁移脚本参考

```bash
#!/bin/bash
# 查找所有需要迁移的调用点

echo "=== ReportingService 调用点 ==="
grep -rn "ReportingService\." --include="*.js" routes/ services/ | grep -v "node_modules"

echo ""
echo "=== ConsumptionService 调用点 ==="
grep -rn "ConsumptionService\." --include="*.js" routes/ services/ | grep -v "node_modules"

echo ""
echo "=== 统计 ==="
echo "ReportingService: $(grep -rn "ReportingService\." --include="*.js" routes/ services/ | grep -v "node_modules" | wc -l) 处"
echo "ConsumptionService: $(grep -rn "ConsumptionService\." --include="*.js" routes/ services/ | grep -v "node_modules" | wc -l) 处"
```

---

---

## 9. 2026-02-02 代码审计发现

### 🔍 重大发现：路由层已使用 ServiceManager

经过对项目代码的深入审计，发现路由层**已经**通过 ServiceManager 获取新的子服务：

```javascript
// 实际路由代码示例 (routes/v4/console/analytics.js)
const ReportingService = req.app.locals.services.getService('reporting_analytics')
const analyticsData = await ReportingService.getDecisionAnalytics(...)

// 实际路由代码示例 (routes/v4/console/consumption.js)
const ConsumptionService = req.app.locals.services.getService('consumption_query')
const result = await ConsumptionService.getPendingConsumptionRecords(...)
```

**结论**：变量名虽然仍叫 `ReportingService`/`ConsumptionService`，但实际获取的是新的子服务，不存在对旧服务文件的 `require()` 引用。

### ❌ 发现的问题：7 处服务键与方法不匹配

| # | 文件 | 行号 | 当前服务键 | 调用方法 | 正确服务键 | 问题说明 |
|---|-----|-----|---------|--------|---------|---------|
| 1 | `routes/v4/console/analytics.js` | 97 | `reporting_analytics` | `getPerformanceReport()` | `reporting_stats` | 方法在 StatsService |
| 2 | `routes/v4/system/statistics.js` | 56 | `reporting_stats` | `getChartsData()` | `reporting_charts` | 方法在 ChartsService |
| 3 | `routes/v4/system/statistics.js` | 90 | `reporting_stats` | `getChartsData()` | `reporting_charts` | 方法在 ChartsService |
| 4 | `routes/v4/system/statistics.js` | 134 | `reporting_stats` | `getChartsData()` | `reporting_charts` | 方法在 ChartsService |
| 5 | `routes/v4/shop/consumption/query.js` | 153 | `consumption_query` | `softDeleteRecord()` | `consumption_core` | 方法在 CoreService |
| 6 | `routes/v4/shop/consumption/query.js` | 216 | `consumption_query` | `restoreRecord()` | `consumption_core` | 方法在 CoreService |
| 7 | `routes/v4/shop/consumption/qrcode.js` | 187 | `consumption_core` | `getUserInfoByQRCode()` | `consumption_query` | 方法在 QueryService |

### ✅ 已正确配置的调用点（17 处）

| 文件 | 服务键 | 调用方法 | 状态 |
|-----|-------|--------|------|
| `analytics.js:33` | `reporting_analytics` | `getDecisionAnalytics()` | ✅ |
| `analytics.js:71` | `reporting_analytics` | `getLotteryTrends()` | ✅ |
| `analytics.js:130` | `reporting_stats` | `getTodayStats()` | ✅ |
| `middleware.js:133` | `reporting_stats` | `getSimpleSystemStats()` | ✅ |
| `status.js:49` | `reporting_stats` | `getSystemOverview()` | ✅ |
| `user-stats.js:61` | `reporting_stats` | `getUserStatistics()` | ✅ |
| `user-stats.js:105` | `reporting_stats` | `getSystemOverview()` | ✅ |
| `consumption.js:50` | `consumption_query` | `getPendingConsumptionRecords()` | ✅ |
| `consumption.js:97` | `consumption_query` | `getAdminRecords()` | ✅ |
| `consumption.js:153` | `consumption_core` | `approveConsumption()` | ✅ |
| `consumption.js:301` | `consumption_core` | `rejectConsumption()` | ✅ |
| `submit.js:91` | `consumption_core` | `merchantSubmitConsumption()` | ✅ |
| `query.js:43` | `consumption_query` | `getUserConsumptionRecords()` | ✅ |
| `query.js:95` | `consumption_query` | `getConsumptionDetailWithAuth()` | ✅ |
| `merchant-query.js:72` | `consumption_merchant` | `getMerchantRecords()` | ✅ |
| `merchant-query.js:152` | `consumption_merchant` | `getMerchantRecordDetail()` | ✅ |
| `merchant-query.js:226` | `consumption_merchant` | `getMerchantStats()` | ✅ |

---

## 10. 零技术债务修复方案

### 10.1 服务方法分布对照表

#### Reporting 服务

| 子服务 | ServiceManager 键 | 包含方法 |
|-------|------------------|---------|
| **StatsService** | `reporting_stats` | `getPerformanceReport`, `getTodayStats`, `getSimpleSystemStats`, `getUserStatistics`, `getSystemOverview`, `getInventoryAdminStatistics` |
| **AnalyticsService** | `reporting_analytics` | `getDecisionAnalytics`, `getLotteryTrends` |
| **ChartsService** | `reporting_charts` | `getChartsData`, 及内部图表生成方法 |
| **MultiDimensionStatsService** | `reporting_multi_dimension` | `getMultiDimensionStats`, `getDrilldownDetail` |

#### Consumption 服务

| 子服务 | ServiceManager 键 | 包含方法 |
|-------|------------------|---------|
| **CoreService** | `consumption_core` | `merchantSubmitConsumption`, `approveConsumption`, `rejectConsumption`, `softDeleteRecord`, `restoreRecord`, `getBudgetRatio` |
| **QueryService** | `consumption_query` | `getUserConsumptionRecords`, `getUserConsumptionStats`, `getPendingConsumptionRecords`, `getAdminRecords`, `getConsumptionDetailWithAuth`, `getConsumptionRecordDetail`, `getRecordById`, `getUserInfoByQRCode` |
| **MerchantService** | `consumption_merchant` | `getMerchantRecords`, `getMerchantRecordDetail`, `getMerchantStats` |
| **AnomalyService** | `consumption_anomaly` | `detectAnomalies`, `getAnomalyStats` |

### 10.2 修复步骤（7 处代码变更）

#### 修复 1: analytics.js:97 - getPerformanceReport

```javascript
// ❌ 当前代码（服务键错误）
const ReportingService = req.app.locals.services.getService('reporting_analytics')
const performanceReport = await ReportingService.getPerformanceReport(...)

// ✅ 修复后代码
const StatsService = req.app.locals.services.getService('reporting_stats')
const performanceReport = await StatsService.getPerformanceReport(...)
```

#### 修复 2-4: statistics.js:56,90,134 - getChartsData

```javascript
// ❌ 当前代码（3处相同问题）
const ReportingService = req.app.locals.services.getService('reporting_stats')
const statistics_data = await ReportingService.getChartsData(days)

// ✅ 修复后代码
const ChartsService = req.app.locals.services.getService('reporting_charts')
const statistics_data = await ChartsService.getChartsData(days)
```

#### 修复 5: query.js:153 - softDeleteRecord

```javascript
// ❌ 当前代码（服务键错误）
const ConsumptionService = req.app.locals.services.getService('consumption_query')
const result = await ConsumptionService.softDeleteRecord(recordId, userId, ...)

// ✅ 修复后代码
const CoreService = req.app.locals.services.getService('consumption_core')
const result = await CoreService.softDeleteRecord(recordId, userId, ...)
```

#### 修复 6: query.js:216 - restoreRecord

```javascript
// ❌ 当前代码（服务键错误）
const ConsumptionService = req.app.locals.services.getService('consumption_query')
const result = await ConsumptionService.restoreRecord(recordId, adminId)

// ✅ 修复后代码
const CoreService = req.app.locals.services.getService('consumption_core')
const result = await CoreService.restoreRecord(recordId, adminId)
```

#### 修复 7: qrcode.js:187 - getUserInfoByQRCode

```javascript
// ❌ 当前代码（服务键错误）
const ConsumptionService = req.app.locals.services.getService('consumption_core')
const userInfo = await ConsumptionService.getUserInfoByQRCode(qr_code)

// ✅ 修复后代码
const QueryService = req.app.locals.services.getService('consumption_query')
const userInfo = await QueryService.getUserInfoByQRCode(qr_code)
```

### 10.3 可选优化：变量命名规范化

为了提高代码可读性，建议将变量名与实际服务名称对齐：

```javascript
// 🔹 规范命名示例
const StatsService = req.app.locals.services.getService('reporting_stats')
const AnalyticsService = req.app.locals.services.getService('reporting_analytics')
const ChartsService = req.app.locals.services.getService('reporting_charts')

const CoreService = req.app.locals.services.getService('consumption_core')
const QueryService = req.app.locals.services.getService('consumption_query')
const MerchantService = req.app.locals.services.getService('consumption_merchant')
```

---

## 11. 执行计划

### 11.1 修复工作量评估

| 任务 | 文件数 | 变更点 | 预计工时 |
|-----|-------|-------|---------|
| 修复服务键不匹配 | 4 个 | 7 处 | 30 分钟 |
| 变量命名规范化（可选） | 10 个 | 24 处 | 1 小时 |
| 回归测试 | - | - | 1 小时 |
| **合计** | - | - | **2.5 小时** |

### 11.2 执行命令

```bash
# 步骤 1: 修复前验证服务启动
npm run start:dev

# 步骤 2: 执行代码修复（见 10.2 节）

# 步骤 3: 语法检查
npm run lint

# 步骤 4: 运行测试
npm test

# 步骤 5: 服务健康检查
npm run pm:health

# 步骤 6: API 完整性验证
npm run check:all
```

### 11.3 验收标准

- [ ] 7 处服务键不匹配已修复
- [ ] `npm run lint` 无错误
- [ ] `npm run start:dev` 启动正常
- [ ] 涉及的 7 个 API 端点功能正常

---

## 12. 待完成工作清单

### 🔴 P0 - 紧急（影响服务正常运行）

| 任务 | 状态 | 涉及范围 | 预计工时 |
|-----|------|---------|---------|
| **修复服务键不匹配** | ⏳ 待执行 | 4 个文件，7 处变更 | 30 分钟 |

**问题详情**：路由层获取的服务键与调用方法所在的子服务不匹配，会导致 `TypeError: xxx is not a function` 运行时错误。

**涉及文件**：
- `routes/v4/console/analytics.js` (1 处)
- `routes/v4/system/statistics.js` (3 处)
- `routes/v4/shop/consumption/query.js` (2 处)
- `routes/v4/shop/consumption/qrcode.js` (1 处)

---

### 🟡 P1 - 重要（代码质量）

| 任务 | 位置 | 描述 |
|-----|------|------|
| 变量命名规范化 | 10 个路由文件 | 将变量名与实际服务名称对齐 |
| ✅ ~~TODO: 推送报表~~ | `services/CustomReportService.js:665` | 已完成：推送逻辑由 jobs/scheduled-report-push.js 实现（2026-02-01） |
| ✅ ~~TODO: 资产名称~~ | `services/asset/QueryService.js:483` | 已完成：从 MaterialAssetType 获取 display_name（2026-02-01） |

---

### 🟢 P2 - 建议检查

| 检查项 | 命令 | 上次状态 |
|-------|------|---------|
| API 完整性测试 | `npm run check:all` | 57/431 有错误（2026-01-27） |
| 数据库迁移状态 | `npm run migration:status` | 最新迁移 20260202 |
| 服务健康检查 | `npm run pm:health` | 需验证 |

---

### 📊 项目概况

| 指标 | 数值 |
|-----|------|
| 项目版本 | V4.0.0 |
| 数据库迁移文件 | 100+ 个 |
| 注册服务数 | 80+ 个 |
| API 端点 | 431 个 |

---

### 🎯 建议执行顺序

1. **立即执行**：修复 7 处服务键不匹配问题
2. **修复后验证**：启动服务，测试涉及的 API 端点
3. **可选**：变量命名规范化
4. **可选**：处理 2 个 TODO 项
5. **可选**：重新运行 API 完整性测试

---

## 13. 执行步骤与代码更新（详细版）

### 13.1 修复文件清单

| 序号 | 文件路径 | 修改行号 | 修复内容 |
|-----|---------|---------|---------|
| 1 | `routes/v4/console/analytics.js` | 97 | `reporting_analytics` → `reporting_stats` |
| 2 | `routes/v4/system/statistics.js` | 56 | `reporting_stats` → `reporting_charts` |
| 3 | `routes/v4/system/statistics.js` | 90 | `reporting_stats` → `reporting_charts` |
| 4 | `routes/v4/system/statistics.js` | 134 | `reporting_stats` → `reporting_charts` |
| 5 | `routes/v4/shop/consumption/query.js` | 153 | `consumption_query` → `consumption_core` |
| 6 | `routes/v4/shop/consumption/query.js` | 216 | `consumption_query` → `consumption_core` |
| 7 | `routes/v4/shop/consumption/qrcode.js` | 187 | `consumption_core` → `consumption_query` |

---

### 13.2 详细代码更新

#### 修复 1: `routes/v4/console/analytics.js` 行 97

**位置**：`/performance/report` 路由

```javascript
// ❌ 修复前 (行 97)
const ReportingService = req.app.locals.services.getService('reporting_analytics')

// ✅ 修复后
const StatsService = req.app.locals.services.getService('reporting_stats')
```

**完整上下文**：
```javascript
router.get(
  '/performance/report',
  adminAuthMiddleware,
  asyncHandler(async (req, res) => {
    try {
      // ✅ getPerformanceReport() 在 StatsService 中
      const StatsService = req.app.locals.services.getService('reporting_stats')

      const performanceReport = await StatsService.getPerformanceReport(
        sharedComponents.performanceMonitor,
        sharedComponents.lotteryEngine
      )
      // ...
    }
  })
)
```

---

#### 修复 2: `routes/v4/system/statistics.js` 行 56

**位置**：`GET /charts` 路由

```javascript
// ❌ 修复前 (行 55-56)
// 1. 通过 ServiceManager 获取 ReportingService（P2-C架构重构：合并StatisticsService）
const ReportingService = req.app.locals.services.getService('reporting_stats')

// ✅ 修复后
// 1. 通过 ServiceManager 获取 ChartsService（getChartsData 在 ChartsService 中）
const ChartsService = req.app.locals.services.getService('reporting_charts')
```

**调用代码也需同步更新**：
```javascript
// ❌ 修复前 (行 62)
const statistics_data = await ReportingService.getChartsData(days)

// ✅ 修复后
const statistics_data = await ChartsService.getChartsData(days)
```

---

#### 修复 3: `routes/v4/system/statistics.js` 行 90

**位置**：`GET /report` 路由

```javascript
// ❌ 修复前 (行 89-90)
// 1. 通过 ServiceManager 获取 ReportingService（P2-C架构重构）
const ReportingService = req.app.locals.services.getService('reporting_stats')

// ✅ 修复后
// 1. 通过 ServiceManager 获取 ChartsService（getChartsData 在 ChartsService 中）
const ChartsService = req.app.locals.services.getService('reporting_charts')
```

**调用代码也需同步更新**：
```javascript
// ❌ 修复前 (行 99)
const report_data = await ReportingService.getChartsData(...)

// ✅ 修复后
const report_data = await ChartsService.getChartsData(...)
```

---

#### 修复 4: `routes/v4/system/statistics.js` 行 134

**位置**：`GET /export` 路由

```javascript
// ❌ 修复前 (行 133-134)
// 1. 通过 ServiceManager 获取 ReportingService（P2-C架构重构）
const ReportingService = req.app.locals.services.getService('reporting_stats')

// ✅ 修复后
// 1. 通过 ServiceManager 获取 ChartsService（getChartsData 在 ChartsService 中）
const ChartsService = req.app.locals.services.getService('reporting_charts')
```

**调用代码也需同步更新**：
```javascript
// ❌ 修复前 (行 143)
const { user_growth, ... } = await ReportingService.getChartsData(days)

// ✅ 修复后
const { user_growth, ... } = await ChartsService.getChartsData(days)
```

---

#### 修复 5: `routes/v4/shop/consumption/query.js` 行 153

**位置**：`DELETE /:id` 路由（软删除）

```javascript
// ❌ 修复前 (行 152-153)
// 🔄 通过 ServiceManager 获取 ConsumptionService（符合TR-005规范）
const ConsumptionService = req.app.locals.services.getService('consumption_query')

// ✅ 修复后
// 🔄 通过 ServiceManager 获取 CoreService（softDeleteRecord 在 CoreService 中）
const CoreService = req.app.locals.services.getService('consumption_core')
```

**调用代码也需同步更新**：
```javascript
// ❌ 修复前 (行 170)
const result = await ConsumptionService.softDeleteRecord(recordId, userId, {...})

// ✅ 修复后
const result = await CoreService.softDeleteRecord(recordId, userId, {...})
```

---

#### 修复 6: `routes/v4/shop/consumption/query.js` 行 216

**位置**：`POST /:id/restore` 路由（恢复）

```javascript
// ❌ 修复前 (行 215-216)
// 🔄 通过 ServiceManager 获取 ConsumptionService（符合TR-005规范）
const ConsumptionService = req.app.locals.services.getService('consumption_query')

// ✅ 修复后
// 🔄 通过 ServiceManager 获取 CoreService（restoreRecord 在 CoreService 中）
const CoreService = req.app.locals.services.getService('consumption_core')
```

**调用代码也需同步更新**：
```javascript
// ❌ 修复前 (行 231)
const result = await ConsumptionService.restoreRecord(recordId, adminId)

// ✅ 修复后
const result = await CoreService.restoreRecord(recordId, adminId)
```

---

#### 修复 7: `routes/v4/shop/consumption/qrcode.js` 行 187

**位置**：`GET /user-info` 路由

```javascript
// ❌ 修复前 (行 186-187)
// 🔄 通过 ServiceManager 获取 ConsumptionService（符合TR-005规范）
const ConsumptionService = req.app.locals.services.getService('consumption_core')

// ✅ 修复后
// 🔄 通过 ServiceManager 获取 QueryService（getUserInfoByQRCode 在 QueryService 中）
const QueryService = req.app.locals.services.getService('consumption_query')
```

**调用代码也需同步更新**：
```javascript
// ❌ 修复前 (行 252)
const userInfo = await ConsumptionService.getUserInfoByQRCode(qr_code)

// ✅ 修复后
const userInfo = await QueryService.getUserInfoByQRCode(qr_code)
```

---

### 13.3 执行脚本

```bash
#!/bin/bash
# 服务键修复执行脚本

echo "🔧 开始执行 7 处服务键修复..."

# 步骤 1: 备份原文件
echo "📦 步骤 1: 备份原文件..."
cp routes/v4/console/analytics.js routes/v4/console/analytics.js.bak
cp routes/v4/system/statistics.js routes/v4/system/statistics.js.bak
cp routes/v4/shop/consumption/query.js routes/v4/shop/consumption/query.js.bak
cp routes/v4/shop/consumption/qrcode.js routes/v4/shop/consumption/qrcode.js.bak
echo "✅ 备份完成"

# 步骤 2: 执行修复（使用 sed 或手动修改）
echo "🔨 步骤 2: 执行代码修复..."
# 此处需要手动修改代码，或使用 Cursor AI 工具

# 步骤 3: 验证语法
echo "🔍 步骤 3: 语法检查..."
npm run lint

# 步骤 4: 启动测试
echo "🚀 步骤 4: 启动服务..."
npm run start:dev

# 步骤 5: 健康检查
echo "🏥 步骤 5: 服务健康检查..."
npm run pm:health

echo "✅ 修复完成！"
```

---

### 13.4 回滚方案

如修复后发现问题，执行以下回滚命令：

```bash
# 恢复备份文件
mv routes/v4/console/analytics.js.bak routes/v4/console/analytics.js
mv routes/v4/system/statistics.js.bak routes/v4/system/statistics.js
mv routes/v4/shop/consumption/query.js.bak routes/v4/shop/consumption/query.js
mv routes/v4/shop/consumption/qrcode.js.bak routes/v4/shop/consumption/qrcode.js

echo "✅ 回滚完成"
```

---

### 13.5 验证清单

| 修复项 | API 端点 | 验证方法 |
|-------|---------|---------|
| 修复 1 | `GET /api/v4/console/analytics/performance/report` | curl 请求验证 |
| 修复 2 | `GET /api/v4/statistics/charts` | curl 请求验证 |
| 修复 3 | `GET /api/v4/statistics/report` | curl 请求验证 |
| 修复 4 | `GET /api/v4/statistics/export` | curl 请求验证 |
| 修复 5 | `DELETE /api/v4/shop/consumption/:id` | 功能测试 |
| 修复 6 | `POST /api/v4/shop/consumption/:id/restore` | 功能测试 |
| 修复 7 | `GET /api/v4/shop/consumption/qrcode/user-info` | 功能测试 |

---

## 14. 执行状态记录

| 日期 | 执行人 | 操作 | 状态 |
|-----|-------|------|------|
| 2026-02-02 | - | 代码审计完成，发现 7 处问题 | ✅ 完成 |
| 2026-02-02 | - | 方案文档更新 | ✅ 完成 |
| 2026-02-02 | 用户拍板 | 决策确认（见第15节） | ✅ 已拍板 |
| 2026-02-02 | Cursor AI | 执行 7 处服务键修复 | ✅ 完成 |
| 2026-02-02 | Cursor AI | 执行 24 处变量命名规范化 | ✅ 完成 |
| 2026-02-02 | Cursor AI | ESLint 语法检查通过 | ✅ 完成 |
| 2026-02-02 | Cursor AI | 服务启动验证（PM2 + 健康检查） | ✅ 完成 |
| 2026-02-02 | Cursor AI | API 端点功能验证（6/6 通过） | ✅ 完成 |

---

## 15. 用户拍板决策记录（2026-02-02）

### 15.1 决策背景

经代码审计和数据库真实数据验证，确认以下问题真实存在：
- **7 处服务键不匹配**：路由层获取的服务键与调用方法所在的子服务不匹配
- **24 处变量命名不规范**：变量名仍使用旧服务名（如 `ReportingService`），与实际获取的子服务不对应

### 15.2 用户决策

| 决策项 | 用户选择 | 说明 |
|--------|----------|------|
| **决策1：7处服务键修复** | ✅ **A. 立即修复** | 消除运行时错误风险，预计30分钟 |
| **决策2：24处变量命名规范化** | ✅ **A. 同步执行** | 与7处修复一起做，代码一致性更高，更清晰 |

### 15.3 最终执行范围

| 任务 | 涉及文件 | 变更点 | 优先级 |
|-----|---------|-------|-------|
| 服务键修复 | 4 个 | 7 处 | P0 |
| 变量命名规范化 | 10 个 | 24 处 | P0（与服务键修复合并） |
| **合计** | **10 个文件** | **31 处变更** | - |

### 15.4 变量命名规范化标准

```javascript
// 🔴 修复前：变量名与服务键不对应
const ReportingService = req.app.locals.services.getService('reporting_stats')
const ConsumptionService = req.app.locals.services.getService('consumption_query')

// ✅ 修复后：变量名与服务类名一致
const StatsService = req.app.locals.services.getService('reporting_stats')
const QueryService = req.app.locals.services.getService('consumption_query')
```

### 15.5 预期效果

- ✅ 消除 7 处运行时 `TypeError` 风险
- ✅ 代码可读性提升（变量名即服务名）
- ✅ 新人理解成本降低（无需解释历史命名）
- ✅ IDE 代码补全更准确

---

## 16. 执行步骤与代码更新（符合项目技术规范）

### 16.1 可复用架构组件（项目实际）

基于 `services/index.js` 和 `package.json` 验证的可复用组件：

| 组件 | 位置 | 可复用场景 | 扩展方式 |
|-----|------|----------|---------|
| **ServiceManager** | `services/index.js` | 任何需要依赖注入的新服务 | `this._services.set('key', Service)` |
| **静态类服务模式** | `services/*/*.js` | 无状态业务逻辑封装 | 创建 `static async method()` |
| **子服务目录模式** | `services/{domain}/index.js` | 大文件拆分后的统一入口 | 新增子服务 → index.js 导出 |
| **路由层获取服务** | `req.app.locals.services.getService()` | 所有路由文件 | 标准调用模式 |
| **getService 辅助函数** | 各路由文件顶部定义 | 简化服务获取代码 | 封装错误处理 |

### 16.2 可扩展点

| 扩展点 | 扩展方式 | 实际示例 |
|-------|---------|---------|
| **新增子服务** | 创建静态类 → index.js 导出 → ServiceManager 注册 | `ConsumptionBatchService`、`AnomalyService` |
| **服务键命名** | `{业务域}_{功能}` snake_case 格式 | `consumption_core`、`reporting_stats` |
| **跨服务调用** | 通过 ServiceManager 获取，不直接 require | 避免循环依赖 |

### 16.3 服务键与子服务对照表（权威参考）

**Reporting 服务**（`services/reporting/`）：

| ServiceManager 键 | 子服务类 | 包含方法 |
|------------------|---------|---------|
| `reporting_stats` | `StatsService` | `getPerformanceReport`, `getTodayStats`, `getSimpleSystemStats`, `getUserStatistics`, `getSystemOverview` |
| `reporting_analytics` | `AnalyticsService` | `getDecisionAnalytics`, `getLotteryTrends` |
| `reporting_charts` | `ChartsService` | `getChartsData` |
| `reporting_multi_dimension` | `MultiDimensionStatsService` | `getMultiDimensionStats`, `getDrilldownDetail` |

**Consumption 服务**（`services/consumption/`）：

| ServiceManager 键 | 子服务类 | 包含方法 |
|------------------|---------|---------|
| `consumption_core` | `CoreService` | `merchantSubmitConsumption`, `approveConsumption`, `rejectConsumption`, `softDeleteRecord`, `restoreRecord` |
| `consumption_query` | `QueryService` | `getUserConsumptionRecords`, `getPendingConsumptionRecords`, `getAdminRecords`, `getConsumptionDetailWithAuth`, `getUserInfoByQRCode` |
| `consumption_merchant` | `MerchantService` | `getMerchantRecords`, `getMerchantRecordDetail`, `getMerchantStats` |
| `consumption_anomaly` | `AnomalyService` | `detectAnomalies`, `getAnomalyStats` |

### 16.4 完整变更清单（31 处）

#### 16.4.1 服务键修复（7 处 P0）

| # | 文件 | 行号 | 当前代码 | 修复后代码 |
|---|-----|-----|---------|-----------|
| 1 | `routes/v4/console/analytics.js` | 97 | `getService('reporting_analytics')` | `getService('reporting_stats')` |
| 2 | `routes/v4/system/statistics.js` | 56 | `getService('reporting_stats')` | `getService('reporting_charts')` |
| 3 | `routes/v4/system/statistics.js` | 90 | `getService('reporting_stats')` | `getService('reporting_charts')` |
| 4 | `routes/v4/system/statistics.js` | 134 | `getService('reporting_stats')` | `getService('reporting_charts')` |
| 5 | `routes/v4/shop/consumption/query.js` | 153 | `getService('consumption_query')` | `getService('consumption_core')` |
| 6 | `routes/v4/shop/consumption/query.js` | 216 | `getService('consumption_query')` | `getService('consumption_core')` |
| 7 | `routes/v4/shop/consumption/qrcode.js` | 187 | `getService('consumption_core')` | `getService('consumption_query')` |

#### 16.4.2 变量命名规范化（24 处 P0）

**规范：变量名与服务类名一致**

| 文件 | 当前变量名 | 服务键 | 规范变量名 |
|-----|----------|-------|-----------|
| `analytics.js:33` | `ReportingService` | `reporting_analytics` | `AnalyticsService` |
| `analytics.js:71` | `ReportingService` | `reporting_analytics` | `AnalyticsService` |
| `analytics.js:97` | `ReportingService` | `reporting_stats` | `StatsService` |
| `middleware.js:133` | `ReportingService` | `reporting_stats` | `StatsService` |
| `status.js:49` | `ReportingService` | `reporting_stats` | `StatsService` |
| `statistics.js:56` | `ReportingService` | `reporting_charts` | `ChartsService` |
| `statistics.js:90` | `ReportingService` | `reporting_charts` | `ChartsService` |
| `statistics.js:134` | `ReportingService` | `reporting_charts` | `ChartsService` |
| `user-stats.js:61` | `ReportingService` | `reporting_stats` | `StatsService` |
| `user-stats.js:105` | `ReportingService` | `reporting_stats` | `StatsService` |
| `submit.js:91` | `ConsumptionService` | `consumption_core` | `CoreService` |
| `consumption.js:50` | `ConsumptionService` | `consumption_query` | `QueryService` |
| `consumption.js:97` | `ConsumptionService` | `consumption_query` | `QueryService` |
| `consumption.js:153` | `ConsumptionService` | `consumption_core` | `CoreService` |
| `consumption.js:301` | `ConsumptionService` | `consumption_core` | `CoreService` |
| `query.js:43` | `ConsumptionService` | `consumption_query` | `QueryService` |
| `query.js:95` | `ConsumptionService` | `consumption_query` | `QueryService` |
| `query.js:153` | `ConsumptionService` | `consumption_core` | `CoreService` |
| `query.js:216` | `ConsumptionService` | `consumption_core` | `CoreService` |
| `qrcode.js:187` | `ConsumptionService` | `consumption_query` | `QueryService` |
| `merchant-query.js:72` | `ConsumptionService` | `consumption_merchant` | `MerchantService` |
| `merchant-query.js:152` | `ConsumptionService` | `consumption_merchant` | `MerchantService` |
| `merchant-query.js:226` | `ConsumptionService` | `consumption_merchant` | `MerchantService` |

> **注意**：`analytics.js:130` 已正确使用 `StatsService`，无需修改

### 16.5 代码修复示例（符合项目规范）

#### 修复模式 1：Reporting 服务

```javascript
// ❌ 修复前：变量名与服务键不对应
const ReportingService = req.app.locals.services.getService('reporting_stats')
const data = await ReportingService.getChartsData(days)

// ✅ 修复后：变量名与服务类名一致
const ChartsService = req.app.locals.services.getService('reporting_charts')
const data = await ChartsService.getChartsData(days)
```

#### 修复模式 2：Consumption 服务

```javascript
// ❌ 修复前：服务键错误 + 变量名不对应
const ConsumptionService = req.app.locals.services.getService('consumption_query')
const result = await ConsumptionService.softDeleteRecord(recordId, userId, options)

// ✅ 修复后：服务键正确 + 变量名与服务类名一致
const CoreService = req.app.locals.services.getService('consumption_core')
const result = await CoreService.softDeleteRecord(recordId, userId, options)
```

### 16.6 执行命令（标准流程）

```bash
#!/bin/bash
# 步骤 1: 备份原文件
echo "📦 备份原文件..."
mkdir -p backups/2026-02-02-service-key-fix
cp routes/v4/console/analytics.js backups/2026-02-02-service-key-fix/
cp routes/v4/system/statistics.js backups/2026-02-02-service-key-fix/
cp routes/v4/system/status.js backups/2026-02-02-service-key-fix/
cp routes/v4/system/user-stats.js backups/2026-02-02-service-key-fix/
cp routes/v4/console/shared/middleware.js backups/2026-02-02-service-key-fix/
cp routes/v4/console/consumption.js backups/2026-02-02-service-key-fix/
cp routes/v4/shop/consumption/query.js backups/2026-02-02-service-key-fix/
cp routes/v4/shop/consumption/submit.js backups/2026-02-02-service-key-fix/
cp routes/v4/shop/consumption/qrcode.js backups/2026-02-02-service-key-fix/
cp routes/v4/shop/consumption/merchant-query.js backups/2026-02-02-service-key-fix/

# 步骤 2: 执行代码修复（通过 Cursor AI 或手动）

# 步骤 3: 语法检查
echo "🔍 ESLint 检查..."
npm run lint

# 步骤 4: 启动服务验证
echo "🚀 启动服务..."
npm run pm:start:dev

# 步骤 5: 健康检查
echo "🏥 健康检查..."
npm run pm:health

# 步骤 6: API 端点验证
echo "🧪 验证涉及的 API 端点..."
curl -s http://localhost:3000/health | jq .
```

### 16.7 验收标准

| 验收项 | 验证方法 | 预期结果 |
|-------|---------|---------|
| ESLint 通过 | `npm run lint` | 无 error |
| 服务启动正常 | `npm run pm:start:dev` | 无报错 |
| 健康检查通过 | `npm run pm:health` | 状态 healthy |
| `/api/v4/console/analytics/performance/report` | curl 请求 | 200 OK |
| `/api/v4/statistics/charts` | curl 请求 | 200 OK |
| `/api/v4/statistics/report` | curl 请求 | 200 OK |
| `/api/v4/shop/consumption/:id` DELETE | 功能测试 | 正常删除 |
| `/api/v4/shop/consumption/:id/restore` POST | 功能测试 | 正常恢复 |
| `/api/v4/shop/consumption/qrcode/user-info` | curl 请求 | 200 OK |

### 16.8 回滚方案

```bash
# 如修复后发现问题，执行回滚
cd /home/devbox/project
cp backups/2026-02-02-service-key-fix/* routes/v4/console/
cp backups/2026-02-02-service-key-fix/middleware.js routes/v4/console/shared/
cp backups/2026-02-02-service-key-fix/*.js routes/v4/system/
cp backups/2026-02-02-service-key-fix/*.js routes/v4/shop/consumption/

npm run pm:restart
echo "✅ 回滚完成"
```

---

> **文档版本**：v2.4  
> **最后更新**：2026-02-02  
> **决策状态**：✅ 已完成执行  
> **当前进度**：✅ 31 处变更全部完成（7 处服务键修复 + 24 处变量命名规范化）  
> **技术规范**：符合项目 V4.7.0 ServiceManager 架构，使用 snake_case 服务键命名  
> **验证结果**：ESLint 通过 | 健康检查 healthy | 6/6 API 端点验证通过
