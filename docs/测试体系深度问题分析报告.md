# ğŸ” æµ‹è¯•ä½“ç³»æ·±åº¦é—®é¢˜åˆ†ææŠ¥å‘Š

> **æ–‡æ¡£ç±»å‹**ï¼šæŠ€æœ¯å€ºåŠ¡åˆ†æ  
> **ç”Ÿæˆæ—¶é—´**ï¼š2026-01-28  
> **åˆ†æèŒƒå›´**ï¼š`/tests` ç›®å½•ä¸‹å…¨éƒ¨æµ‹è¯•æ–‡ä»¶  
> **æ ¸å¿ƒé—®é¢˜**ï¼šæµ‹è¯•ç¼ºä¹å¹¿åº¦å’Œæ·±åº¦ï¼Œæ— æ³•éªŒè¯å¤æ‚ä¸šåŠ¡åœºæ™¯

---

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

### å‘ç°çš„å…³é”®ç¼ºå¤±

| ç¼ºå¤±åœºæ™¯ | ä¸¥é‡ç¨‹åº¦ | å½±å“èŒƒå›´ |
|----------|---------|---------|
| è¿æŠ½ä¸­é¢„ç®—åˆ†å±‚åŠ¨æ€å˜åŒ– | ğŸ”´ é«˜ | BxPx çŸ©é˜µè®¡ç®—æ­£ç¡®æ€§ |
| è¿æŠ½ä¸²è¡Œæ‰§è¡Œé¡ºåºéªŒè¯ | ğŸ”´ é«˜ | çŠ¶æ€ä¼ é€’ä¸€è‡´æ€§ |
| å¤šæ¬¡æŠ½å¥–åçŠ¶æ€ç´¯ç§¯éªŒè¯ | ğŸŸ¡ ä¸­ | Pity/LuckDebt æœºåˆ¶ |
| è·¨ç»„ä»¶çŠ¶æ€ä¼ é€’éªŒè¯ | ğŸŸ¡ ä¸­ | Pipeline Stage äº¤äº’ |

### å…·ä½“æ¡ˆä¾‹ï¼šè¿æŠ½10æ¬¡çš„ BxPx çŸ©é˜µé—®é¢˜

**ä¸šåŠ¡é€»è¾‘**ï¼šç”¨æˆ·æ‰§è¡Œ10è¿æŠ½æ—¶ï¼Œç³»ç»Ÿåº”è¯¥ï¼š
1. ç¬¬1æ¬¡æŠ½å¥–ï¼šè®¡ç®— budget_tier=B3, pressure_tier=P0
2. è‹¥ç¬¬1æ¬¡æŠ½ä¸­é«˜æ¡£ï¼ˆæ¶ˆè€—é¢„ç®—ï¼‰ï¼Œç¬¬2æ¬¡çš„ budget_tier å¯èƒ½é™ä¸º B2
3. è‹¥è¿ç»­ç©ºå¥–ï¼Œpity_counter ç´¯ç§¯ï¼Œåç»­æŠ½å¥–æ¦‚ç‡åº”æå‡
4. 10æ¬¡æŠ½å¥–åº”ä¸²è¡Œæ‰§è¡Œï¼Œæ¯æ¬¡ä½¿ç”¨æœ€æ–°çŠ¶æ€

**æµ‹è¯•ç°çŠ¶**ï¼š
- âœ… æœ‰æµ‹è¯•éªŒè¯ "10è¿æŠ½è¿”å›10ä¸ªç»“æœ"
- âŒ æ²¡æœ‰æµ‹è¯•éªŒè¯ "æ¯æ¬¡æŠ½å¥–çš„ budget_tier æ˜¯å¦æ­£ç¡®å˜åŒ–"
- âŒ æ²¡æœ‰æµ‹è¯•éªŒè¯ "çŠ¶æ€æ˜¯å¦æ­£ç¡®ä¼ é€’åˆ°ä¸‹ä¸€æ¬¡æŠ½å¥–"

---

## ğŸ“Š æµ‹è¯•ä½“ç³»ä¸è¶³å…¨é¢æ€»ç»“

åŸºäºå¯¹ `/tests` ç›®å½•çš„å…¨é¢åˆ†æï¼Œå­˜åœ¨ä»¥ä¸‹ **6 å¤§ç±»ä¸è¶³**ï¼š

### 1ï¸âƒ£ æ·±åº¦ä¸è¶³ï¼šç¼ºå°‘çŠ¶æ€æ¼”å˜éªŒè¯

| ç°çŠ¶ | é—®é¢˜ |
|------|------|
| åªæµ‹å•æ¬¡è°ƒç”¨çš„è¾“å…¥è¾“å‡º | ä¸éªŒè¯å¤šæ¬¡è°ƒç”¨æ—¶çŠ¶æ€å¦‚ä½•ä¼ é€’å’Œç´¯ç§¯ |

**å…·ä½“ç¼ºå¤±**ï¼š
- âŒ è¿æŠ½10æ¬¡æ—¶æ¯æ¬¡çš„ `budget_tier` å˜åŒ–
- âŒ è¿ç»­ç©ºå¥–å `pity_counter` ç´¯ç§¯éªŒè¯
- âŒ `luck_debt` éšå†å²è®°å½•å˜åŒ–çš„éªŒè¯
- âŒ é¢„ç®—æ¶ˆè€—ååˆ†å±‚é™çº§çš„éªŒè¯

### 2ï¸âƒ£ å¹¿åº¦ä¸è¶³ï¼šæ ¸å¿ƒä¸šåŠ¡åœºæ™¯è¦†ç›–ç¼ºå¤±

| ä¸šåŠ¡åœºæ™¯ | æµ‹è¯•è¦†ç›– |
|---------|---------|
| å•æ¬¡æŠ½å¥–åŸºç¡€æµç¨‹ | âœ… å®Œæ•´ |
| è¿æŠ½æ‰¹é‡å¤„ç† | âš ï¸ åªéªŒè¯è¿”å›æ•°é‡ |
| ä¿åº•æœºåˆ¶è§¦å‘ | âš ï¸ åªéªŒè¯æ•°æ®ç»“æ„ |
| é¢„ç®—è€—å°½é™çº§ | âŒ æ—  |
| BxPx çŸ©é˜µåŠ¨æ€è°ƒæ•´ | âŒ æ—  |
| è·¨ç»„ä»¶çŠ¶æ€ä¼ é€’ | âŒ æ—  |
| å¹¶å‘æŠ½å¥–ç«æ€ | âš ï¸ æµ…å±‚ |

### 3ï¸âƒ£ æ¶æ„ä¸åŒ¹é…ï¼šæµ‹è¯•æ»åäºä»£ç æ¼”è¿›

| ç»´åº¦ | æ•°æ® |
|------|------|
| ä»£ç æ¼”è¿› | 16ä¸ªPhaseï¼Œ224å¤„é‡æ„æ³¨é‡Š |
| æµ‹è¯•æ›´æ–° | 158å¤„å¯¹åº”æ³¨é‡Š |
| å·®è· | çº¦30%çš„ä»£ç å˜æ›´æ²¡æœ‰å¯¹åº”æµ‹è¯• |

**å…·ä½“è¡¨ç°**ï¼š
- Phase 9-16 æ–°å¢çš„7ä¸ªè®¡ç®—å™¨æœ‰å•å…ƒæµ‹è¯•
- ä½†å®ƒä»¬åœ¨ Pipeline ä¸­çš„åä½œæ²¡æœ‰é›†æˆæµ‹è¯•
- `LotteryComputeEngine` ä½œä¸º Facade çš„é›†æˆéªŒè¯ä¸è¶³

### 4ï¸âƒ£ æµ‹è¯•ç±»å‹å¤±è¡¡

| æµ‹è¯•ç±»å‹ | æ•°é‡ | è´¨é‡ |
|---------|------|------|
| å•å…ƒæµ‹è¯• | å¤š | â­â­â­ |
| API æµ‹è¯• | å¤š | â­â­â­ |
| é›†æˆæµ‹è¯• | ä¸­ | â­â­ æµ…å±‚ |
| åœºæ™¯æµ‹è¯• | æ—  | âŒ ç¼ºå¤± |
| ç«¯åˆ°ç«¯æµ‹è¯• | å°‘ | â­ ä¸è¶³ |

**é—®é¢˜**ï¼š
- æ²¡æœ‰ `tests/scenarios/` ç›®å½•
- æ²¡æœ‰éªŒè¯å®Œæ•´ä¸šåŠ¡æµç¨‹çš„æµ‹è¯•å¥—ä»¶

### 5ï¸âƒ£ å…³é”®æœºåˆ¶æµ‹è¯•ä¸è¶³

| æœºåˆ¶ | å•å…ƒæµ‹è¯• | é›†æˆæµ‹è¯• | åœºæ™¯æµ‹è¯• |
|------|---------|---------|---------|
| BxPx çŸ©é˜µ | âœ… | âŒ | âŒ |
| Pity ç³»ç»Ÿ | âœ… | âš ï¸ | âŒ |
| Luck Debt | âœ… | âŒ | âŒ |
| Anti-Empty Streak | âœ… | âŒ | âŒ |
| Anti-High Streak | âœ… | âŒ | âŒ |
| é¢„ç®—æä¾›è€… | âŒ | âŒ | âŒ |
| é…é¢æ§åˆ¶ | âš ï¸ | âš ï¸ | âŒ |

### 6ï¸âƒ£ æµ‹è¯•åŸºç¡€è®¾æ–½ä¸è¶³

| ç¼ºå¤±é¡¹ | å½±å“ |
|--------|------|
| çŠ¶æ€å¿«ç…§å·¥å…· | æ— æ³•å¯¹æ¯”æŠ½å¥–å‰åçŠ¶æ€å˜åŒ– |
| æµ‹è¯•æ•°æ®å·¥å‚ | æ¯ä¸ªæµ‹è¯•éƒ½é‡å¤åˆ›å»ºæµ‹è¯•æ•°æ® |
| Mock ç­–ç•¥ä¸ç»Ÿä¸€ | æœ‰äº›æµ‹è¯•ç”¨çœŸå®æ•°æ®åº“ï¼Œæœ‰äº›ç”¨ Mock |
| è¦†ç›–åº¦ç›‘æ§ | ä¸çŸ¥é“å“ªäº›åœºæ™¯æ²¡æœ‰è¢«æµ‹è¯• |

### ğŸ“ˆ æµ‹è¯•ä½“ç³»æˆç†Ÿåº¦è¯„ä¼°

```
å•å…ƒæµ‹è¯•è¦†ç›–   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 90%  âœ…
API æµ‹è¯•è¦†ç›–   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 85%  âœ…
ç»„ä»¶æµ‹è¯•è¦†ç›–   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 75%  âš ï¸
é›†æˆæµ‹è¯•æ·±åº¦   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 50%  âš ï¸
åœºæ™¯æµ‹è¯•è¦†ç›–   â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 10%  âŒ
ç«¯åˆ°ç«¯æµ‹è¯•     â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 20%  âŒ
æµ‹è¯•åŸºç¡€è®¾æ–½   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 30%  âŒ
```

---

## ğŸ”¬ ç°æœ‰æµ‹è¯•è¦†ç›–åˆ†æ

### æµ‹è¯•æ–‡ä»¶åˆ†å¸ƒç»Ÿè®¡

```
tests/
â”œâ”€â”€ unit/           # å•å…ƒæµ‹è¯• - è¦†ç›–ç»„ä»¶ç‹¬ç«‹é€»è¾‘
â”‚   â””â”€â”€ compute/    # 7ä¸ªæ–‡ä»¶ï¼Œè¦†ç›–7ä¸ªè®¡ç®—å™¨
â”œâ”€â”€ integration/    # é›†æˆæµ‹è¯• - è¦†ç›–è·¨ç»„ä»¶äº¤äº’ï¼ˆæµ…å±‚ï¼‰
â”‚   â””â”€â”€ 8ä¸ªæ–‡ä»¶
â”œâ”€â”€ business/       # ä¸šåŠ¡æµ‹è¯• - è¦†ç›–APIå±‚åŠŸèƒ½
â”‚   â””â”€â”€ 12ä¸ªæ–‡ä»¶
â”œâ”€â”€ specialized/    # ä¸“é¡¹æµ‹è¯• - è¦†ç›–ç‰¹å®šæœºåˆ¶
â”‚   â””â”€â”€ 5ä¸ªæ–‡ä»¶
â””â”€â”€ ...
```

### æŒ‰æµ‹è¯•æ·±åº¦åˆ†ç±»

| æ·±åº¦å±‚çº§ | æè¿° | ç°æœ‰è¦†ç›– | ç¼ºå¤±ç¨‹åº¦ |
|---------|------|---------|---------|
| L1 å•å…ƒæµ‹è¯• | å•ä¸ªå‡½æ•°/ç±»çš„è¾“å…¥è¾“å‡º | â­â­â­ å®Œæ•´ | ä½ |
| L2 ç»„ä»¶æµ‹è¯• | å•ä¸ªç»„ä»¶çš„å®Œæ•´é€»è¾‘ | â­â­â­ å®Œæ•´ | ä½ |
| L3 é›†æˆæµ‹è¯• | å¤šç»„ä»¶åä½œï¼ˆå•æ¬¡è°ƒç”¨ï¼‰ | â­â­ éƒ¨åˆ† | ä¸­ |
| L4 åœºæ™¯æµ‹è¯• | å¤šæ¬¡è°ƒç”¨çš„çŠ¶æ€æ¼”å˜ | â­ ç¼ºå¤± | ğŸ”´ é«˜ |
| L5 ç«¯åˆ°ç«¯æµ‹è¯• | å®Œæ•´ä¸šåŠ¡æµç¨‹éªŒè¯ | â­ ç¼ºå¤± | ğŸ”´ é«˜ |

---

## ğŸ“Š å…·ä½“ç¼ºå¤±åœºæ™¯æ¸…å•

### 1. BxPx é¢„ç®—å‹åŠ›çŸ©é˜µåŠ¨æ€å˜åŒ–

**ç°æœ‰æµ‹è¯•**ï¼š
```javascript
// TierMatrixCalculator.test.js - åªæµ‹è¯•å•æ¬¡è®¡ç®—
test('B3xP1 æ‰€æœ‰æ¡£ä½å¯ç”¨', () => {
  const result = calculator.calculate({
    budget_tier: 'B3',    // â† å›ºå®šè¾“å…¥
    pressure_tier: 'P1',  // â† å›ºå®šè¾“å…¥
    base_weights: baseWeights
  })
  expect(result.available_tiers).toContain('high')
})
```

**ç¼ºå¤±æµ‹è¯•**ï¼š
```javascript
// åº”è¯¥æœ‰ä½†æ²¡æœ‰çš„æµ‹è¯•
test('è¿æŠ½æ—¶ budget_tier åº”éšé¢„ç®—æ¶ˆè€—åŠ¨æ€é™çº§', async () => {
  // åˆå§‹é¢„ç®— 500ï¼Œé«˜æ¡£å¥–å“æˆæœ¬ 100
  // ç¬¬1æ¬¡æŠ½ä¸­ high â†’ é¢„ç®—é™ä¸º 400 â†’ budget_tier åº”ä» B3 é™ä¸º B2
  // ç¬¬2æ¬¡æŠ½ä¸­ high â†’ é¢„ç®—é™ä¸º 300 â†’ budget_tier åº”ä» B2 é™ä¸º B1
  // ...éªŒè¯æ¯æ¬¡æŠ½å¥–çš„ budget_tier å˜åŒ–
})
```

### 2. è¿æŠ½ä¸²è¡Œæ‰§è¡Œé¡ºåº

**ä¸šåŠ¡è¦æ±‚**ï¼š10è¿æŠ½å¿…é¡»ä¸²è¡Œæ‰§è¡Œï¼Œæ¯æ¬¡ä½¿ç”¨å‰ä¸€æ¬¡çš„æœ€æ–°çŠ¶æ€

**ç°æœ‰æµ‹è¯•**ï¼š
```javascript
// pipeline_full_flow.test.js - åªéªŒè¯ç»“æœæ•°é‡
test('10è¿æŠ½åº”è¯¥è¿”å›10ä¸ªç»“æœ', async () => {
  const response = await request(app)
    .post('/api/v4/lottery/draw')
    .send({ campaign_code, draw_count: 10 })
  
  expect(response.body.data.prizes.length).toBe(10)  // â† åªéªŒè¯æ•°é‡
  // âŒ æ²¡æœ‰éªŒè¯æ‰§è¡Œé¡ºåº
  // âŒ æ²¡æœ‰éªŒè¯çŠ¶æ€ä¼ é€’
})
```

**ç¼ºå¤±æµ‹è¯•**ï¼š
```javascript
// åº”è¯¥æœ‰ä½†æ²¡æœ‰çš„æµ‹è¯•
test('10è¿æŠ½åº”ä¸²è¡Œæ‰§è¡Œä¸”æ¯æ¬¡ä½¿ç”¨æœ€æ–°çŠ¶æ€', async () => {
  const results = await executeTenDraw(userId, campaignId)
  
  for (let i = 1; i < 10; i++) {
    // éªŒè¯ç¬¬ i æ¬¡æŠ½å¥–ä½¿ç”¨çš„æ˜¯ç¬¬ i-1 æ¬¡ä¹‹åçš„çŠ¶æ€
    expect(results[i].input_state.pity_counter).toBe(
      results[i-1].output_state.pity_counter
    )
  }
})
```

### 3. ç”¨æˆ·ä½“éªŒçŠ¶æ€ç´¯ç§¯

**ä¸šåŠ¡è¦æ±‚**ï¼š
- `pity_counter`ï¼šè¿ç»­æœªä¸­é«˜æ¡£æ—¶é€’å¢
- `empty_streak`ï¼šè¿ç»­ç©ºå¥–æ—¶é€’å¢
- `luck_debt`ï¼šæ ¹æ®å†å²ç©ºå¥–ç‡è®¡ç®—å€ºåŠ¡

**ç°æœ‰æµ‹è¯•**ï¼š
```javascript
// pity_mechanism.test.js - éªŒè¯å•æ¬¡æ›´æ–°
test('å¤šæ¬¡æŠ½å¥–åä½“éªŒçŠ¶æ€åº”è¯¥ç´¯ç§¯', async () => {
  // ä½†æµ‹è¯•å†…å®¹åªæ˜¯éªŒè¯ API å“åº”æˆåŠŸ
  // æ²¡æœ‰éªŒè¯å…·ä½“çš„çŠ¶æ€å€¼å˜åŒ–
})
```

**ç¼ºå¤±æµ‹è¯•**ï¼š
```javascript
// åº”è¯¥æœ‰ä½†æ²¡æœ‰çš„æµ‹è¯•
test('è¿ç»­5æ¬¡ç©ºå¥–å pity_counter åº”ä¸º5', async () => {
  // æ¨¡æ‹Ÿè¿ç»­5æ¬¡ç©ºå¥–
  for (let i = 0; i < 5; i++) {
    await forceEmptyDraw(userId, campaignId)
  }
  
  const state = await getUserExperienceState(userId, campaignId)
  expect(state.pity_counter).toBe(5)
  expect(state.empty_streak).toBe(5)
})
```

### 4. é¢„ç®—æä¾›è€…çŠ¶æ€åŒæ­¥

**ä¸šåŠ¡è¦æ±‚**ï¼š`UserBudgetProvider` / `PoolBudgetProvider` çš„é¢„ç®—åº”åœ¨æ¯æ¬¡æŠ½å¥–åæ›´æ–°

**ç°æœ‰æµ‹è¯•**ï¼šæ— 

**ç¼ºå¤±æµ‹è¯•**ï¼š
```javascript
test('æŠ½å¥–åé¢„ç®—æä¾›è€…çš„ä½™é¢åº”æ­£ç¡®æ‰£å‡', async () => {
  const beforeBudget = await getBudgetProviderBalance(userId)
  
  await executeDraw(userId, campaignId, { prizeCost: 100 })
  
  const afterBudget = await getBudgetProviderBalance(userId)
  expect(afterBudget).toBe(beforeBudget - 100)
})
```

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### åŸå›  1ï¼šæ¶æ„ç»å†äº†æ¿€è¿›çš„é‡æ„å‘¨æœŸ

| æ—¶é—´ | ç‰ˆæœ¬ | å˜åŒ– |
|------|------|------|
| 2025-12 | V4.0 | åˆç‰ˆç­–ç•¥é“¾æ¨¡å¼ |
| 2026-01-18 | V4.5 | Pipeline é‡æ„ï¼ˆ11ä¸ªStageï¼‰ |
| 2026-01-19 | V4.6 | ç»Ÿä¸€ç®¡çº¿åˆå¹¶ |
| 2026-01-20 | Phase 9-16 | æ–°å¢7ä¸ªè®¡ç®—å™¨ |

**å½±å“**ï¼šç³»ç»Ÿåœ¨ **ä¸åˆ°2ä¸ªæœˆå†…ç»å†äº†16ä¸ªPhaseçš„é‡æ„**ï¼Œæµ‹è¯•æ›´æ–°æ»åäºä»£ç å˜æ›´ã€‚

**è¯æ®**ï¼š
```
ä»£ç ä¸­ Phase/é‡æ„ ç›¸å…³æ³¨é‡Š: 224 å¤„
æµ‹è¯•ä¸­ Phase/é‡æ„ ç›¸å…³æ³¨é‡Š: 158 å¤„
å·®è·: çº¦ 30% çš„ä»£ç å˜æ›´æ²¡æœ‰å¯¹åº”æµ‹è¯•æ›´æ–°
```

### åŸå›  2ï¼šæµ‹è¯•ç­–ç•¥åå‘å•å…ƒæµ‹è¯•

| æµ‹è¯•ç±»å‹ | æ–‡ä»¶æ•° | è¦†ç›–æ·±åº¦ |
|----------|--------|---------|
| å•å…ƒæµ‹è¯• | 7+ | â­â­â­ å®Œæ•´ |
| é›†æˆæµ‹è¯• | 8 | â­â­ æµ…å±‚ |
| åœºæ™¯æµ‹è¯• | 0 | â­ ç¼ºå¤± |

**é—®é¢˜**ï¼šå•å…ƒæµ‹è¯•åªéªŒè¯ "ç»™å®šè¾“å…¥Xï¼Œè¾“å‡ºæ˜¯å¦ä¸ºY"ï¼Œä¸éªŒè¯ "è¿ç»­è°ƒç”¨æ—¶çŠ¶æ€å¦‚ä½•æ¼”å˜"ã€‚

### åŸå›  3ï¼šè®¤çŸ¥ç®€åŒ–å‡è®¾

å¼€å‘è€…åŸºäºä»¥ä¸‹å‡è®¾ç¼–å†™æµ‹è¯•ï¼š

> "æ—¢ç„¶å•æ¬¡æŠ½å¥–é€»è¾‘æ­£ç¡®ï¼ŒNæ¬¡å¾ªç¯è°ƒç”¨å°±è‡ªç„¶æ­£ç¡®"

**è¿™ä¸ªå‡è®¾å¿½ç•¥äº†**ï¼š

| è¢«å¿½ç•¥çš„å¤æ‚æ€§ | å®é™…å½±å“ |
|---------------|---------|
| çŠ¶æ€ç´¯ç§¯ | ç¬¬Næ¬¡ä¾èµ–å‰N-1æ¬¡çš„ç»“æœ |
| é¢„ç®—æ¶ˆè€— | budget_tier å¯èƒ½åŠ¨æ€é™çº§ |
| ç«æ€æ¡ä»¶ | äº‹åŠ¡è¾¹ç•Œå’Œé”çš„æ­£ç¡®æ€§ |

### åŸå›  4ï¼šæµ‹è¯•ç¯å¢ƒæ­å»ºæˆæœ¬é«˜

è¦æµ‹è¯• "è¿æŠ½ä¸­ BxPx åŠ¨æ€å˜åŒ–"ï¼Œéœ€è¦ï¼š

| å‰ç½®æ¡ä»¶ | å¤æ‚åº¦ |
|---------|--------|
| åˆ›å»ºæµ‹è¯•æ´»åŠ¨ï¼ˆç‰¹å®šé¢„ç®—å‚æ•°ï¼‰ | é«˜ |
| åˆ›å»ºæµ‹è¯•ç”¨æˆ·ï¼ˆè¶³å¤Ÿç§¯åˆ†ï¼‰ | ä¸­ |
| æ¨¡æ‹Ÿç²¾ç¡®çš„æ—¶é—´è¿›åº¦ | é«˜ |
| æ§åˆ¶å¥–å“æˆæœ¬ | ä¸­ |
| è§‚æµ‹æ¯æ¬¡æŠ½å¥–çš„å†…éƒ¨çŠ¶æ€ | é«˜ |

**ç»“æœ**ï¼šå›¢é˜Ÿé€‰æ‹©äº†æ›´å®¹æ˜“ç¼–å†™çš„å•å…ƒæµ‹è¯•ã€‚

### åŸå›  5ï¼šæµ‹è¯•ä¸ä»£ç æ¼”è¿›è„±èŠ‚

ä»£ç å¿«é€Ÿè¿­ä»£æ—¶ï¼Œæµ‹è¯•æ›´æ–°ä¼˜å…ˆçº§è¢«é™ä½ï¼š

```javascript
// ä»£ç ä¸­çš„å…¸å‹æ³¨é‡Š
* âš ï¸ å…³é”®çº¦æŸï¼ˆPhase 2 å¢å¼º - 2026-01-18ï¼‰
* @updated 2026-01-19 - Phase 2 å¢å¼º
* ğŸ”§ 2026-01-28 ä¿®å¤ï¼šåŒºåˆ† draw_cost å’Œ per_draw_cost
```

ä½†å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶æ²¡æœ‰åŒæ­¥æ›´æ–°ã€‚

---

## ğŸ“ˆ é—®é¢˜å½±å“è¯„ä¼°

### æ½œåœ¨é£é™©

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ä¼˜å…ˆçº§ |
|------|--------|------|--------|
| è¿æŠ½æ—¶é¢„ç®—è®¡ç®—é”™è¯¯ | ä¸­ | é«˜ | P1 |
| çŠ¶æ€ä¼ é€’ä¸¢å¤±å¯¼è‡´ pity å¤±æ•ˆ | ä½ | é«˜ | P1 |
| å¹¶å‘æŠ½å¥–æ—¶çŠ¶æ€ç«äº‰ | ä½ | é«˜ | P2 |
| é¢„ç®—è€—å°½åä»å‘æ”¾é«˜æ¡£å¥–å“ | ä½ | ä¸¥é‡ | P0 |

### å·²çŸ¥é—®é¢˜è®°å½•

ç›®å‰æ²¡æœ‰å‘ç°å› æµ‹è¯•ç¼ºå¤±å¯¼è‡´çš„ç”Ÿäº§é—®é¢˜ï¼Œä½†å­˜åœ¨ä»¥ä¸‹éšæ‚£ï¼š

1. **æ— æ³•éªŒè¯é‡æ„æ­£ç¡®æ€§**ï¼šæ¶æ„å˜æ›´åæ— æ³•ç¡®è®¤ä¸šåŠ¡è¡Œä¸ºä¸€è‡´
2. **å›å½’é£é™©é«˜**ï¼šä¿®å¤ä¸€ä¸ª bug å¯èƒ½å¼•å…¥å¦ä¸€ä¸ª
3. **æ–°äººç†è§£æˆæœ¬é«˜**ï¼šç¼ºå°‘æµ‹è¯•ä½œä¸º"æ´»æ–‡æ¡£"

---

## ğŸ’¡ æ”¹è¿›å»ºè®®

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰

#### 1. è¡¥å……è¿æŠ½çŠ¶æ€ä¼ é€’æµ‹è¯•

```javascript
// tests/integration/multi_draw_state_flow.test.js
describe('è¿æŠ½åœºæ™¯ä¸‹çš„çŠ¶æ€ä¼ é€’éªŒè¯', () => {
  test('10è¿æŠ½æ—¶æ¯æ¬¡æŠ½å¥–åº”ä½¿ç”¨å‰ä¸€æ¬¡çš„æœ€æ–°çŠ¶æ€', async () => {
    const snapshots = []
    
    // Mock executeLottery ä»¥æ•è·æ¯æ¬¡è°ƒç”¨çš„ä¸Šä¸‹æ–‡
    const originalExecuteLottery = engine.executeLottery
    engine.executeLottery = async (context, tx) => {
      snapshots.push({
        draw_number: context.draw_number,
        budget_tier: context.budget_tier,
        pity_counter: context.user_state?.pity_counter
      })
      return originalExecuteLottery.call(engine, context, tx)
    }
    
    await engine.execute_draw(userId, campaignId, 10, { ... })
    
    // éªŒè¯çŠ¶æ€ä¼ é€’
    for (let i = 1; i < 10; i++) {
      // å¦‚æœå‰ä¸€æ¬¡æ˜¯ç©ºå¥–ï¼Œpity_counter åº”è¯¥ +1
      if (snapshots[i-1].result_tier === 'fallback') {
        expect(snapshots[i].pity_counter).toBe(snapshots[i-1].pity_counter + 1)
      }
    }
  })
})
```

#### 2. è¡¥å…… BxPx åŠ¨æ€å˜åŒ–æµ‹è¯•

```javascript
// tests/integration/bxpx_dynamic_change.test.js
describe('BxPx é¢„ç®—å‹åŠ›çŸ©é˜µåŠ¨æ€å˜åŒ–', () => {
  test('é¢„ç®—æ¶ˆè€—å budget_tier åº”æ­£ç¡®é™çº§', async () => {
    // è®¾ç½®åˆå§‹é¢„ç®— = 250ï¼ˆä»‹äº B2 å’Œ B3 é˜ˆå€¼ä¹‹é—´ï¼‰
    await setupTestBudget(userId, 250)
    
    // ç¬¬1æ¬¡æŠ½å¥–æ¶ˆè€— 100
    const draw1 = await executeDraw(userId, { forcePrizeCost: 100 })
    expect(draw1.decision_snapshot.budget_tier).toBe('B3')
    
    // ç¬¬2æ¬¡æŠ½å¥–æ—¶é¢„ç®— = 150ï¼Œåº”é™çº§åˆ° B2
    const draw2 = await executeDraw(userId, { forcePrizeCost: 100 })
    expect(draw2.decision_snapshot.budget_tier).toBe('B2')
    
    // ç¬¬3æ¬¡æŠ½å¥–æ—¶é¢„ç®— = 50ï¼Œåº”é™çº§åˆ° B1
    const draw3 = await executeDraw(userId, { forcePrizeCost: 0 })
    expect(draw3.decision_snapshot.budget_tier).toBe('B1')
  })
})
```

### ä¸­æœŸï¼ˆ2-4å‘¨ï¼‰

#### 3. å»ºç«‹çŠ¶æ€å¿«ç…§å¯¹æ¯”æ¡†æ¶

```javascript
// tests/helpers/state-snapshot-helper.js
class StateSnapshotHelper {
  async captureBeforeDraw(userId, campaignId) {
    return {
      budget: await this.getBudget(userId),
      experience: await this.getExperienceState(userId, campaignId),
      quota: await this.getQuota(userId, campaignId),
      timestamp: Date.now()
    }
  }
  
  async captureAfterDraw(userId, campaignId) {
    // åŒä¸Š
  }
  
  compareSnapshots(before, after, drawResult) {
    const diffs = []
    
    // éªŒè¯é¢„ç®—å˜åŒ–
    const expectedBudgetChange = -drawResult.prize_cost
    if (after.budget - before.budget !== expectedBudgetChange) {
      diffs.push({
        field: 'budget',
        expected: expectedBudgetChange,
        actual: after.budget - before.budget
      })
    }
    
    // éªŒè¯ pity_counter å˜åŒ–
    // ...
    
    return diffs
  }
}
```

#### 4. æ·»åŠ åœºæ™¯æµ‹è¯•ç›®å½•

```
tests/
â”œâ”€â”€ scenarios/                    # æ–°å¢ï¼šåœºæ™¯æµ‹è¯•
â”‚   â”œâ”€â”€ multi_draw_budget_flow/   # è¿æŠ½é¢„ç®—å˜åŒ–
â”‚   â”œâ”€â”€ pity_accumulation/        # Pity ç´¯ç§¯
â”‚   â”œâ”€â”€ luck_debt_compensation/   # è¿æ°”å€ºåŠ¡è¡¥å¿
â”‚   â””â”€â”€ guarantee_trigger/        # ä¿åº•è§¦å‘
```

### é•¿æœŸï¼ˆ1-2æœˆï¼‰

#### 5. å»ºç«‹æµ‹è¯•è¦†ç›–åº¦ç›‘æ§

```yaml
# .github/workflows/test-coverage.yml
- name: Check scenario test coverage
  run: |
    # ç»Ÿè®¡å„ç±»æµ‹è¯•æ•°é‡
    unit_count=$(find tests/unit -name "*.test.js" | wc -l)
    integration_count=$(find tests/integration -name "*.test.js" | wc -l)
    scenario_count=$(find tests/scenarios -name "*.test.js" | wc -l)
    
    # è¦æ±‚åœºæ™¯æµ‹è¯•è‡³å°‘å  20%
    if [ $scenario_count -lt $(($unit_count / 5)) ]; then
      echo "âŒ åœºæ™¯æµ‹è¯•æ•°é‡ä¸è¶³"
      exit 1
    fi
```

#### 6. å°†æµ‹è¯•ä½œä¸ºæ¶æ„æ–‡æ¡£

æ¯ä¸ªæ ¸å¿ƒä¸šåŠ¡æµç¨‹åº”æœ‰å¯¹åº”çš„åœºæ™¯æµ‹è¯•ï¼Œä½œä¸º"æ´»æ–‡æ¡£"ï¼š

| ä¸šåŠ¡æµç¨‹ | å¯¹åº”æµ‹è¯• | çŠ¶æ€ |
|---------|---------|------|
| å•æ¬¡æŠ½å¥– | `unit/compute/*.test.js` | âœ… |
| è¿æŠ½çŠ¶æ€ä¼ é€’ | `scenarios/multi_draw_state.test.js` | âŒ ç¼ºå¤± |
| ä¿åº•è§¦å‘ | `specialized/pity_mechanism.test.js` | âš ï¸ éƒ¨åˆ† |
| é¢„ç®—è€—å°½é™çº§ | `scenarios/budget_exhaustion.test.js` | âŒ ç¼ºå¤± |

---

## ğŸ“‹ è¡ŒåŠ¨è®¡åˆ’

### Phase 1: ç´§æ€¥è¡¥å……ï¼ˆæœ¬å‘¨ï¼‰

- [ ] åˆ›å»º `tests/scenarios/` ç›®å½•
- [ ] å®ç°è¿æŠ½çŠ¶æ€ä¼ é€’æµ‹è¯•
- [ ] å®ç° BxPx åŠ¨æ€å˜åŒ–æµ‹è¯•

### Phase 2: æ¡†æ¶å»ºè®¾ï¼ˆä¸‹å‘¨ï¼‰

- [ ] å®ç° StateSnapshotHelper
- [ ] æ·»åŠ æµ‹è¯•æ•°æ®ç”Ÿæˆå·¥å…·
- [ ] è¡¥å……é¢„ç®—æä¾›è€…æµ‹è¯•

### Phase 3: æŒç»­æ”¹è¿›ï¼ˆåç»­ï¼‰

- [ ] å»ºç«‹æµ‹è¯•è¦†ç›–åº¦ CI æ£€æŸ¥
- [ ] æ¯ä¸ª Phase å¿…é¡»åŒæ­¥æ›´æ–°æµ‹è¯•
- [ ] å®šæœŸå®¡æŸ¥æµ‹è¯•æ·±åº¦

---

## ğŸ“Œ ç»“è®º

å½“å‰æµ‹è¯•ä½“ç³»å­˜åœ¨ **"å¹¿åº¦è¶³å¤Ÿä½†æ·±åº¦ä¸è¶³"** çš„é—®é¢˜ï¼š

| ç»´åº¦ | ç°çŠ¶ | ç›®æ ‡ |
|------|------|------|
| å•å…ƒæµ‹è¯•è¦†ç›– | â­â­â­ | ä¿æŒ |
| ç»„ä»¶æµ‹è¯•è¦†ç›– | â­â­â­ | ä¿æŒ |
| é›†æˆæµ‹è¯•æ·±åº¦ | â­â­ | æå‡åˆ° â­â­â­ |
| åœºæ™¯æµ‹è¯•è¦†ç›– | â­ | æ–°å»ºï¼Œç›®æ ‡ â­â­â­ |

**æ ¸å¿ƒé—®é¢˜**ï¼šæµ‹è¯•åªéªŒè¯äº† "å•æ¬¡è°ƒç”¨çš„æ­£ç¡®æ€§"ï¼Œæ²¡æœ‰éªŒè¯ "å¤šæ¬¡è°ƒç”¨çš„çŠ¶æ€æ¼”å˜æ­£ç¡®æ€§"ã€‚

**æ ¹æœ¬åŸå› **ï¼šæ¶æ„å¿«é€Ÿæ¼”è¿› + æµ‹è¯•ç­–ç•¥åå‘å•å…ƒæµ‹è¯• + è®¤çŸ¥ç®€åŒ–å‡è®¾ + ç¯å¢ƒæ­å»ºæˆæœ¬é«˜ã€‚

**æ”¹è¿›æ–¹å‘**ï¼šè¡¥å……åœºæ™¯æµ‹è¯•ï¼Œå»ºç«‹çŠ¶æ€å¿«ç…§å¯¹æ¯”æ¡†æ¶ï¼Œå°†æµ‹è¯•ä½œä¸ºæ¶æ„çš„æ´»æ–‡æ¡£ã€‚

