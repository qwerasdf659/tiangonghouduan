# 图片管理体系设计方案

> **文档状态**：已拍板（2026-02-21）
> **创建日期**：2026-02-21
> **数据来源**：代码仓库实际代码 + 生产数据库实查（restaurant_points_dev）
> **适用范围**：餐厅积分抽奖系统 V4.0 全端（管理台 / 微信小程序 / 后端 API）

---

## 一、项目业务模型概述

餐厅积分抽奖系统 V4.0 的核心业务链路：

```
用户餐厅消费 → 获得积分 → 积分抽奖 → 获得材料资产（碎片/水晶/钻石）
                                         ↓
                              材料可在兑换商城换实物商品
                              材料可在 C2C 交易市场挂单买卖
                              材料之间可按规则相互合成转换
```

**本质**：一个积分驱动的虚拟资产经济体系，融合抽奖、商城、交易三大模块。

**技术栈**：Node.js + Express + Sequelize + MySQL (Sealos) | Sealos Object Storage (S3) | Sharp 图片处理 | Vite + Alpine.js + Tailwind (管理台) | 微信小程序 (C端)

---

## 二、图片管理现状实查报告

### 2.1 代码架构层（已搭建完成）

| 组件 | 文件位置 | 职责 |
|---|---|---|
| ImageResources 模型 | `models/ImageResources.js` | 中心化图片资源管理表 |
| ImageService | `services/ImageService.js` | 图片上传、校验、绑定业务逻辑 |
| SealosStorageService | `services/sealosStorage.js` | S3 兼容存储上传 + Sharp 缩略图预生成 |
| ImageUrlHelper | `utils/ImageUrlHelper.js` | 对象 key → 公网 URL 转换 |
| 图片路由 | `routes/v4/console/images.js` | 上传/查询/绑定/删除 API |

**架构决策（已拍板）**：
- 数据库只存对象 key（如 `prizes/20260108_abc123.jpg`），不存完整 URL
- API 层通过 `ImageUrlHelper.getImageUrl()` 动态拼接：`${SEALOS_ENDPOINT}/${SEALOS_BUCKET}/${objectKey}`
- 上传时 Sharp 预生成 3 级缩略图：small (150x150) / medium (300x300) / large (600x600)
- 缩略图存储路径：`{folder}/thumbnails/{size}/{filename}`
- 缺图降级：返回对应业务类型的占位图 URL

**业务表关联方式**：
- `lottery_prizes.image_resource_id` → `image_resources.image_resource_id`（外键）
- `exchange_items.primary_image_id` → `image_resources.image_resource_id`（外键）
- `item_templates.image_url` / `thumbnail_url`（遗留字段，字符串直存）
- `material_asset_types.icon_url`（字符串直存）
- `popup_banners.image_url` / `carousel_items.image_url`（字符串直存）

### 2.2 数据库真实数据（2026-02-20 实查校正）

| 业务实体 | 总记录数 | 有图片 | 无图片 | 图片覆盖率 | 字段/存储方式 |
|---|---|---|---|---|---|
| 抽奖奖品 lottery_prizes | 15（points:3 coupon:2 physical:4 virtual:6） | 0 | 15 | **0%** | `image_resource_id` FK |
| 兑换商品 exchange_items | 89（active:44 inactive:45） | 0 | 89 | **0%** | `primary_image_id` FK |
| 物品模板 item_templates | 16 | 1（值为 `test/image.png`，测试数据） | 15 | **6%** | `image_url` / `thumbnail_url` 字符串直存 |
| 图片资源表 image_resources | **0 条** | - | - | **空表** | 15 字段，无 `sort_order` |
| 材料资产类型 material_asset_types | **15** | 15（种子路径 `test-seeds/icons/asset-*.png`） | 0 | 100%（路径无效） | `icon_url` 字符串直存 |
| 弹窗广告 popup_banners | **2** | **2**（对象 key 如 `popup-banners/177...jpg`） | 0 | **100%** | `image_url` 字符串直存 + `is_active` 布尔 |
| 轮播图 carousel_items | **1** | **1**（对象 key 如 `carousel/177...png`） | 0 | **100%** | `image_url` 字符串直存 + `is_active` 布尔 |
| C2C 挂单 market_listings | 294 | 0 | 294 | **0%** | 无图片字段（决策 5 已拍板不允许上传） |

**关键发现**：
- popup_banners / carousel_items 使用 `is_active` 布尔字段控制启停，**不是** `status` 枚举
- popup_banners / carousel_items 的 `image_url` 直存对象 key（非 FK 关联 image_resources），上传流程独立于 ImageService
- image_resources 表当前无 `sort_order` 字段，多图排序功能需要迁移脚本新增
- 整个 image_resources 表 0 条记录，所有现有图片（弹窗/轮播）走的是各自模块独立上传，未纳入统一图片管理

**结论**：图片管理的代码架构已完整搭建，但存在「双轨并存」现象——popup_banners / carousel_items 走独立上传，prize / exchange_item 走 image_resources 统一管理但 0 实际数据。

### 2.3 材料资产图标现状（2026-02-20 实查校正）

当前数据库 15 种材料资产（按 tier 排序）：

| tier | asset_code | display_name | icon_url |
|---|---|---|---|
| 0 | BUDGET_POINTS | 预算积分 | `test-seeds/icons/asset-budget.png` |
| 0 | POINTS | 普通积分 | `test-seeds/icons/asset-points.png` |
| 1 | red_shard | 红水晶碎片 | `test-seeds/icons/asset-red-shard.png` |
| 1 | orange_shard | 橙水晶碎片 | `test-seeds/icons/asset-orange-shard.png` |
| 1 | yellow_shard | 黄水晶碎片 | `test-seeds/icons/asset-yellow-shard.png` |
| 1 | green_shard | 绿水晶碎片 | `test-seeds/icons/asset-green-shard.png` |
| 1 | blue_shard | 蓝水晶碎片 | `test-seeds/icons/asset-blue-shard.png` |
| 1 | purple_shard | 紫水晶碎片 | `test-seeds/icons/asset-purple-shard.png` |
| 2 | red_crystal | 红水晶 | `test-seeds/icons/asset-red-crystal.png` |
| 2 | orange_crystal | 橙水晶 | `test-seeds/icons/asset-orange-crystal.png` |
| 2 | yellow_crystal | 黄水晶 | `test-seeds/icons/asset-yellow-crystal.png` |
| 2 | green_crystal | 绿水晶 | `test-seeds/icons/asset-green-crystal.png` |
| 2 | blue_crystal | 蓝水晶 | `test-seeds/icons/asset-blue-crystal.png` |
| 2 | purple_crystal | 紫水晶 | `test-seeds/icons/asset-purple-crystal.png` |
| 10 | DIAMOND | 钻石 | `test-seeds/icons/asset-diamond.png` |

这些 `test-seeds/icons/` 路径是种子脚本写入的，Sealos 存储中不存在真实文件。

### 2.4 category_defs 图标现状（2026-02-20 实查）

12 个分类定义中仅 3 个有种子 `icon_url`，9 个为 NULL：

| category_code | display_name | icon_url |
|---|---|---|
| collectible | 收藏品 | `test-seeds/icons/cat-collectible.png` |
| food | 美食饮品 | `test-seeds/icons/cat-food.png` |
| lifestyle | 生活日用 | `test-seeds/icons/cat-lifestyle.png` |
| auto / beauty / electronics / food_drink / gift_card / home_life / other / voucher / chen112 | — | NULL |

**注意**：`chen112`（斤斤计较）疑似测试数据，建议清理。

---

## 三、图片分类：前端放 vs 后端放

### 3.1 分类标准

**前端静态资源**：数量固定、不会被运营频繁更换、需要离线可用、需要毫秒级加载
**后端对象存储**：运营动态上传、数量不可预测、需要缩略图处理、需要审核管理

### 3.2 分类结果

| 图片类型 | 推荐位置 | 理由 |
|---|---|---|
| **材料资产图标**（钻石/水晶/碎片/积分） | 前端静态资源 | 固定 15 种，高频引用，需要极快加载 |
| **稀有度标识**（普通/稀有/精良/史诗/传说） | 前端静态资源 | 固定 5 种，颜色已在 rarity_defs.color_hex 定义 |
| **分类图标**（电子产品/美食/家居等） | 前端静态资源 | 数量有限且相对固定 |
| **UI 框架图片**（Logo/空状态/加载动画） | 前端静态资源 | 与代码强绑定 |
| **占位图/默认头像** | 两处都放 | Sealos 放生产用图，前端放降级兜底 |
| **商品实拍图** | 后端 Sealos | 运营动态上传，需要缩略图 |
| **轮播广告图/弹窗 Banner** | 后端 Sealos | 运营内容，频繁更换 |
| **用户头像** | 后端 Sealos | UGC 内容 |
| **聊天图片** | 后端 Sealos | UGC 内容 |
| **C2C 交易截图** | 后端 Sealos | UGC 内容 |

---

## 四、商品—图片正确性保障机制

### 4.1 现有机制

| 机制 | 状态 | 说明 |
|---|---|---|
| 外键关联 | 已实现 | prize.image_resource_id / item.primary_image_id |
| 业务类型标记 | 已实现 | image_resources.business_type + category + context_id |
| 绑定 API | 已实现 | `PATCH /api/v4/console/images/:id/bind` |
| 占位图降级 | 已实现 | 缺图时按 business_type 返回占位图 |
| upload_id 追踪 | 已实现 | image_resources.upload_id 字段 |

### 4.2 缺失机制（建议补充）

| 缺失项 | 风险 | 建议方案 | 优先级 |
|---|---|---|---|
| 商品上架图片校验 | 无图商品面向用户 | 商品 status → active 时强制校验图片字段非空 | P0 |
| 图片存储一致性检查 | DB 有记录但文件已丢 | 定时任务 HEAD 请求验证 Sealos 文件真实存在 | P1 |
| 孤儿图片清理 | 存储浪费 | 基于 upload_id 清理超过 24h 未绑定的图片 | P2 |
| 图片引用计数 | 共享图片误删 | 删除前检查是否被多个业务实体引用 | P2 |
| 商品图片审核流 | 不合规图片上线 | 上传 → pending → 审核通过 → active | P3 |

---

## 五、材料资产图标管理方案

### 5.1 推荐方案：前端静态映射（学游戏公司做法）

**核心思路**：材料资产图标 = 游戏道具图标，应该内嵌前端，通过 `asset_code` 直接映射本地文件。

**前端目录结构**（小程序端 + 管理台共用一套）：

**已生成 & 存放位置**：`admin/public/assets/icons/materials/`（暗黑奢华风 256×256 PNG）

```
admin/public/assets/icons/materials/
├── diamond.png          # 钻石           37.4 KB
├── points.png           # 普通积分       44.8 KB
├── budget-points.png    # 预算积分       44.8 KB
├── red-shard.png        # 红水晶碎片     34.6 KB
├── red-crystal.png      # 红水晶         37.7 KB
├── orange-shard.png     # 橙水晶碎片     39.4 KB
├── orange-crystal.png   # 橙水晶         38.9 KB
├── yellow-shard.png     # 黄水晶碎片     27.7 KB
├── yellow-crystal.png   # 黄水晶         37.0 KB
├── green-shard.png      # 绿水晶碎片     31.4 KB
├── green-crystal.png    # 绿水晶         42.4 KB
├── blue-shard.png       # 蓝水晶碎片     31.8 KB
├── blue-crystal.png     # 蓝水晶         39.6 KB
├── purple-shard.png     # 紫水晶碎片     32.5 KB
├── purple-crystal.png   # 紫水晶         34.9 KB
│                        ────────────────────────
│                        总计: ~555 KB（15 个文件）
└── _mapping.js          # asset_code → 文件路径映射表（待创建）
```

**映射表示例**（`_mapping.js`）：

```javascript
const MATERIAL_ICONS = {
  DIAMOND:       '/assets/icons/materials/diamond.png',
  POINTS:        '/assets/icons/materials/points.png',
  BUDGET_POINTS: '/assets/icons/materials/budget-points.png',
  red_shard:     '/assets/icons/materials/red-shard.png',
  red_crystal:   '/assets/icons/materials/red-crystal.png',
  orange_shard:  '/assets/icons/materials/orange-shard.png',
  orange_crystal:'/assets/icons/materials/orange-crystal.png',
  yellow_shard:  '/assets/icons/materials/yellow-shard.png',
  yellow_crystal:'/assets/icons/materials/yellow-crystal.png',
  green_shard:   '/assets/icons/materials/green-shard.png',
  green_crystal: '/assets/icons/materials/green-crystal.png',
  blue_shard:    '/assets/icons/materials/blue-shard.png',
  blue_crystal:  '/assets/icons/materials/blue-crystal.png',
  purple_shard:  '/assets/icons/materials/purple-shard.png',
  purple_crystal:'/assets/icons/materials/purple-crystal.png',
}
```

**前端使用方式**：

```javascript
const iconUrl = MATERIAL_ICONS[item.asset_code] || '/assets/icons/materials/diamond.png'
```

**数据库 icon_url 字段**：上传真实图标到 Sealos，更新 icon_url 为真实对象 key（决策 6 已拍板）。管理台通过 Sealos URL 显示，运营可在管理台随时上传替换。

### 5.2 稀有度图标方案

稀有度已有 `color_hex` 字段，建议前端用纯 CSS 实现（颜色边框/光晕），不需要额外图标文件：

| rarity_code | display_name | color_hex | 前端表现 |
|---|---|---|---|
| common | 普通 | #9E9E9E | 灰色边框 |
| uncommon | 稀有 | #4CAF50 | 绿色边框 + 微光 |
| rare | 精良 | #2196F3 | 蓝色边框 + 光晕 |
| epic | 史诗 | #9C27B0 | 紫色边框 + 闪烁 |
| legendary | 传说 | #FF9800 | 金色边框 + 动画光效 |

### 5.3 分类图标方案

当前 `category_defs` 共 12 条，其中 3 条有种子数据 `icon_url`。建议同样走前端静态资源。

---

## 六、行业方案对比

### 6.1 大厂电商（美团/阿里/腾讯）

| 维度 | 做法 |
|---|---|
| 存储 | 自建分布式对象存储（OSS/COS），多区域多副本 |
| CDN | 全国 CDN 加速，图片带 CDN 域名 |
| 缩略图 | **URL 参数实时处理**（如 `?x-oss-process=image/resize,w_300`） |
| 格式 | WebP/AVIF 自适应（根据 Accept header 判断） |
| 商品图 | 多图体系（主图+详情图+SKU图），审核流程，版本管理 |
| 一致性 | 图片与商品同事务绑定，草稿/发布态分离 |
| 成本 | 月费万元级，专职图片工程团队 |
| 适合 | DAU 百万+、SKU 十万+、专业技术团队 |

### 6.2 游戏公司（网易/米哈游/腾讯游戏）

| 维度 | 做法 |
|---|---|
| 虚拟道具图标 | **全部内嵌客户端资源包**，不走网络请求 |
| 资源管理 | Asset Bundle / Sprite Atlas 机制 |
| 命名规范 | `icon_{asset_type}_{rarity}_{size}.png` |
| 映射方式 | 通过 item_code 映射本地文件，不存数据库 URL |
| 实物商城图 | 走 CDN + 对象存储（和电商一样） |
| 适合 | 虚拟道具数量固定、极致加载速度 |

### 6.3 活动策划公司（有赞/微盟/互动吧）

| 维度 | 做法 |
|---|---|
| 存储 | 云厂商 OSS（阿里云/七牛） |
| CDN | 基础 CDN |
| 缩略图 | 云厂商自带图片处理 |
| 模板 | 活动模板内置素材包，运营只上传商品图 |
| 成本 | 月费百元到千元级 |
| 适合 | 中小活动运营，商品百级 |

### 6.4 小公司 / 创业项目

| 维度 | 做法 |
|---|---|
| 存储 | 云厂商 OSS 或 BaaS（Sealos/Supabase） |
| 缩略图 | **上传时预生成固定尺寸**（你项目的现有方案） |
| 图标 | 前端内置 SVG 或开源图标库 |
| 成本 | 月费几十到几百元 |
| 适合 | 商品千级以内，1-3 人团队 |

### 6.5 虚拟物品交易平台（Steam/BUFF/C5Game）

| 维度 | 做法 |
|---|---|
| 官方道具图 | 从游戏 API 拉取并缓存，保证权威性 |
| 用户截图 | UGC 存对象存储 + CDN |
| 水印 | 用户上传图自动打水印 |
| 适合 | 道具图来源于游戏方的交易平台 |

### 6.6 各方案核心差异一览

| 维度 | 大厂 | 游戏公司 | 活动公司 | 小公司 | **你项目** |
|---|---|---|---|---|---|
| 缩略图策略 | URL 参数实时 | 客户端内嵌 | 云端处理 | 上传预生成 | **上传预生成 3 级** |
| 虚拟道具图标 | CDN | 客户端内嵌 | 模板内置 | 前端静态 | **需改为前端静态** |
| 实物商品图 | OSS+CDN | OSS+CDN | OSS | OSS/BaaS | **Sealos S3** |
| 图片格式 | WebP/AVIF | 引擎原生 | JPEG/PNG | JPEG/PNG | **JPEG/PNG** |
| 一致性保障 | 事务+版本 | 资源包版本 | 外键 | 外键 | **外键** |
| 月成本 | 万+ | 千~万 | 百~千 | 十~百 | **十~百** |

---

## 七、推荐方案：两层分离架构

### 7.1 总体设计

```
┌─────────────────────────────────────────────────┐
│                   图片管理体系                    │
├─────────────────────┬───────────────────────────┤
│   第一层：前端静态    │   第二层：后端动态管理       │
│   （游戏公司模式）    │   （小公司最佳实践）        │
├─────────────────────┼───────────────────────────┤
│ 材料资产图标 (15种)  │ 商品实拍图                  │
│ 稀有度标识 (5种)     │ 轮播广告 / 弹窗 Banner      │
│ 分类图标 (~12种)     │ 用户头像                    │
│ UI 框架图片          │ 聊天图片                    │
│ 占位图（降级用）      │ C2C 交易截图                │
├─────────────────────┼───────────────────────────┤
│ PNG @2x 格式          │ JPEG/PNG/WebP              │
│ 前端 assets/ 目录    │ Sealos S3 对象存储          │
│ asset_code 直接映射   │ image_resources 表管理      │
│ 零网络请求            │ 上传预生成 3 级缩略图        │
│ 设计师统一出图        │ 运营人员管理台上传           │
└─────────────────────┴───────────────────────────┘
```

### 7.2 不需要做的事（避免过度设计）

| 不需要做 | 原因 |
|---|---|
| URL 参数化缩略图 | 商品量级不需要，预生成 3 级够用 |
| AVIF 格式自适应 | 微信小程序支持有限 |
| 自建 CDN | 当前用户量级不需要，未来加云厂商 CDN 即可 |
| 图片版本管理 | 运营频率不需要 |
| AI 鉴黄审核 | 商品图由运营上传，非 UGC 场景 |

### 7.3 未来扩展路径

当业务增长到一定阶段时可依次加入：

1. **CDN 加速**（小程序上线、用户量破千时）—— 加一层 CDN 域名，代码改动极小
2. **WebP 输出**（降低流量成本）—— Sharp 已支持，只需改上传配置
3. **图片审核流**（开放 UGC 上传时）—— 利用已有的 status 字段做状态机
4. **多图支持**（商品需要详情图时）—— image_resources 已支持多条记录关联同一 context_id

---

## 八、拍板决策记录（2026-02-21）

| 决策项 | 选择 | 说明 |
|---|---|---|
| **决策 1：图标来源** | AI 生成（暗黑奢华风） | 风格 3 已拍板：类似《暗黑破坏神 不朽》《崩铁》高端手游风格，带卡片边框、魔法粒子、戏剧性光影 |
| **决策 2：图标格式** | **C. PNG 256×256** | 材料图标全部使用 PNG @2x（256×256），15 个图标总计 ~555KB |
| **决策 3：上架图片校验** | **A. 强制要求** | 商品 status → active 时校验 primary_image_id 非空；虚拟奖品（积分券/材料）用前端静态图标 |
| **决策 4：CDN** | **B. 暂不加** | 等小程序上线后再加，代码已预留 CDN_DOMAIN |
| **决策 5：C2C 交易图片** | **B. 不允许上传** | 交易市场只显示系统资产图标，不支持用户上传 |
| **决策 6：icon_url 处理** | **A. 上传真实图标到 Sealos** | 制作好图标后上传 Sealos，更新 icon_url 为真实对象 key |
| **多图支持** | **需实现** | 商品支持主图 + 详情图，基于 image_resources 多条记录关联 |

---

## 九、商品—图片正确性保障机制（详解）

> 运营人员日常操作：在管理台上传图片、创建/编辑商品、上下架商品。
> 核心问题：系统如何保证"商品 A 的图片就是商品 A 的"，而不是张冠李戴？

### 9.1 全链路正确性保障（当前已有 + 需补充）

```
运营上传图片 ──→ 图片绑定商品 ──→ 商品上架校验 ──→ 用户看到商品
     │                │                │                │
     ▼                ▼                ▼                ▼
  [上传阶段]      [绑定阶段]       [上架阶段]       [展示阶段]
  保障机制 ①      保障机制 ②       保障机制 ③       保障机制 ④
```

#### 保障机制 ① 上传阶段（已实现）

运营在管理台上传一张图片时：

1. **Multer 内存上传** → 不落盘，直传 Sealos
2. **文件校验**：MIME 类型白名单（jpeg/png/gif/webp）、5MB 大小限制、最大 4096px 尺寸
3. **Sharp 处理**：预生成 3 级缩略图（150/300/600px）
4. **写入 image_resources 表**：记录 `business_type`（用途标记）、`category`（分类）、`context_id`（关联 ID）、`user_id`（操作人）、`upload_id`（上传批次号）、`ip_address`
5. **返回 `image_resource_id`** 给前端

此时图片只是"上传了"，还没有绑定到任何商品。

#### 保障机制 ② 绑定阶段（已实现 + 需加强）

运营在编辑商品时选择图片或上传新图片：

**已实现**：
- 商品保存时，将 `image_resource_id` 写入 `exchange_items.primary_image_id` 或 `lottery_prizes.image_resource_id`（外键约束）
- 绑定 API `PATCH /api/v4/console/images/:id/bind` 更新 `image_resources.context_id`

**绑定关系的正确性保障**：
- **外键约束**：`primary_image_id` 必须指向 `image_resources` 表中真实存在的记录，数据库层面杜绝了指向不存在图片的情况
- **操作人追踪**：`image_resources.user_id` 记录谁上传的，`context_id` 记录关联到哪个商品，形成完整审计链
- **一对一绑定**：一个 `primary_image_id` 只指向一条 `image_resources` 记录，不会出现"一张图被多个商品抢夺"的问题

**需补充的加强机制**：
- 商品保存时，校验 `image_resource_id` 对应的图片 `status` 是否为 `active`（防止引用已删除的图片）
- 商品换图时，记录"旧图 → 新图"的变更日志

#### 保障机制 ③ 上架阶段（需实现 —— 已拍板决策 3）

**强制校验规则**（商品 `status` 从非 active 变为 `active` 时触发）：

```
兑换商品上架校验：
  ├── primary_image_id 非空                    → 否则拒绝上架
  ├── primary_image_id 对应的 image_resources 记录存在  → 否则拒绝上架
  ├── 该图片记录 status = 'active'              → 否则拒绝上架
  └── （可选）HEAD 请求验证 Sealos 文件真实存在    → 否则告警但不阻断

抽奖奖品上架校验：
  ├── 实物奖品（physical）→ 同上，强制要求图片
  ├── 积分/材料类奖品 → 不要求图片，前端用 asset_code 映射静态图标
  └── 虚拟奖品（优惠券等）→ 不要求图片，前端用分类图标
```

#### 保障机制 ④ 展示阶段（已实现）

用户在小程序或 Web 看到商品时：

1. API 返回商品数据时，通过 Sequelize 关联查询 `include: ImageResources`
2. `ImageResources.toSafeJSON()` 自动将对象 key 转为公网 URL
3. 缩略图优先使用预生成的 `thumbnail_paths`
4. **降级链**：预生成缩略图 → 原图 → 业务类型占位图 → 通用占位图

### 9.2 运营可动态调整的能力

| 运营操作 | 实现方式 | 影响范围 |
|---|---|---|
| **更换商品主图** | 管理台编辑商品 → 上传新图 → 保存（更新 primary_image_id） | 即时生效，用户立即看到新图 |
| **更换奖品图片** | 管理台编辑奖品 → 上传新图 → 保存（更新 image_resource_id） | 即时生效 |
| **批量更换材料图标** | 管理台「材料资产类型」→ 编辑 → 上传新 icon → 保存（更新 icon_url） | 即时生效（Sealos URL 不变，仅替换文件） |
| **商品临时下架** | 管理台将 status 改为 inactive | 用户端不再显示，图片关联保持不变 |
| **添加商品详情图** | 管理台上传多张图片并绑定同一商品（多图功能） | 即时生效 |
| **更换占位图** | 上传新占位图到 Sealos `defaults/` 目录，同 key 覆盖 | 全局生效 |
| **更换轮播/Banner** | 管理台内容管理模块操作 | 即时生效 |

**关键设计**：所有图片变更都是**即时生效**的，因为数据库存的是对象 key，URL 是 API 层动态拼接的，不存在缓存过期问题。如果未来加了 CDN，需要配置合理的缓存策略（如 max-age=3600 + 手动刷新）。

### 9.3 防止运营误操作的安全机制

| 风险场景 | 防护措施 |
|---|---|
| 运营删除了正在使用的图片 | 删除前检查该图片是否被 prize/item 引用，有引用则拒绝删除 |
| 运营上传了错误格式的文件 | Multer 文件过滤 + MIME 白名单（服务端校验，不信任前端） |
| 运营上传了超大图片 | 5MB 大小限制 + 4096px 最大尺寸限制 |
| 运营把 A 商品的图绑到 B 商品 | 操作日志记录，admin_operation_logs 表追踪（已有） |
| Sealos 存储文件意外丢失 | 定时任务 HEAD 检测（建议 P1 实现）+ 占位图降级兜底 |

---

## 十、多图支持设计方案（需实现）

### 10.1 需求场景

当前商品只支持一张主图（`primary_image_id`），实际运营中需要：
- **主图**：商品列表页展示，1 张
- **详情图**：商品详情页展示，1~9 张（类似淘宝商品详情）
- **SKU 图**：不同规格对应不同图片（当前不需要，预留）

### 10.2 数据模型（无需新建表）

`image_resources` 表已天然支持多图，通过 `context_id` + `category` 组合关联：

```
商品 exchange_item_id = 17 的图片：
  image_resources 中：
    ├── context_id=17, category='primary',  sort=0  → 主图（同时更新到 exchange_items.primary_image_id）
    ├── context_id=17, category='detail',   sort=1  → 详情图 1
    ├── context_id=17, category='detail',   sort=2  → 详情图 2
    └── context_id=17, category='detail',   sort=3  → 详情图 3
```

### 10.3 API 设计

```
# 上传商品详情图
POST /api/v4/console/images/upload
  body: { business_type: 'exchange', category: 'detail', context_id: 17 }

# 查询商品所有图片（含主图 + 详情图）
GET /api/v4/console/images?business_type=exchange&context_id=17
  返回: [{ category: 'primary', ... }, { category: 'detail', sort: 1, ... }, ...]

# 调整详情图顺序
PATCH /api/v4/console/images/:id
  body: { sort_order: 3 }

# 删除某张详情图
DELETE /api/v4/console/images/:id
```

### 10.4 前端交互

管理台商品编辑页面：
- 主图区域：单图上传/替换（必填）
- 详情图区域：支持拖拽排序的多图上传（选填，最多 9 张）
- 每张详情图支持：预览、排序、删除

### 10.5 image_resources 表改动

需要新增 `sort_order` 字段（现有表结构中无此字段）：

```sql
ALTER TABLE image_resources ADD COLUMN sort_order INT DEFAULT 0 COMMENT '排序序号（同一 context_id 内排序）';
```

---

## 十一、执行优先级排序

| 优先级 | 任务 | 依赖 | 预估工时 |
|---|---|---|---|
| ~~P0~~ | ~~制作 15 个材料资产图标~~ | ~~决策 1~~ | **已完成** — 暗黑奢华风 256×256 PNG，存放于 `admin/public/assets/icons/materials/` |
| P0 | 图标上传 Sealos + 更新 material_asset_types.icon_url | 决策 6 | 2 小时 |
| P0 | 为现有商品和奖品上传真实图片 | 无 | 取决于商品数量 |
| P1 | 商品上架强制图片校验逻辑 | 决策 3 | 4 小时 |
| P1 | 多图支持（sort_order 字段 + API + 管理台 UI） | 十、多图 | 1~2 天 |
| P1 | 图片删除保护（引用检查） | 无 | 2 小时 |
| P2 | 稀有度 CSS 光效实现 | 无 | 4 小时 |
| P2 | 孤儿图片定时清理 | 无 | 4 小时 |
| P2 | 图片存储一致性 HEAD 检测定时任务 | 无 | 4 小时 |
| P3 | 加入 CDN | 决策 4 | 1 小时（仅改配置）|

---

## 十、附录

### A. 当前 Sealos 存储配置

```
Endpoint:  https://objectstorageapi.bja.sealos.run
Bucket:    br0za7uc-tiangong
Region:    bja
```

公网访问 URL 格式：`https://objectstorageapi.bja.sealos.run/br0za7uc-tiangong/{object_key}`

### B. 占位图配置

```
默认占位图:   defaults/placeholder.png
奖品占位图:   defaults/prize-placeholder.png
商品占位图:   defaults/product-placeholder.png
```

### C. 材料资产体系全貌

```
系统货币:
  DIAMOND (钻石)     - tier 10 - 100 value_points - 可交易
  POINTS  (普通积分)  - tier 10 - 1 value_point   - 不可交易
  BUDGET_POINTS (预算积分) - tier 10 - 1 value_point - 不可交易

材料资产 (6色 × 碎片/水晶):
  red_shard    (红碎片)  - tier 1 - 10 pts  │  red_crystal    (红水晶)  - tier 2 - 100 pts
  orange_shard (橙碎片)  - tier 1 - 20 pts  │  orange_crystal (橙水晶)  - tier 2 - 200 pts
  yellow_shard (黄碎片)  - tier 1 - 40 pts  │  yellow_crystal (黄水晶)  - tier 2 - 400 pts
  green_shard  (绿碎片)  - tier 1 - 80 pts  │  green_crystal  (绿水晶)  - tier 2 - 800 pts
  blue_shard   (蓝碎片)  - tier 1 - 160 pts │  blue_crystal   (蓝水晶)  - tier 2 - 1600 pts
  purple_shard (紫碎片)  - tier 1 - 320 pts │  purple_crystal (紫水晶)  - tier 2 - 3200 pts
```

---

## 十二、问题归属分析（后端 / Web管理台前端 / 微信小程序前端）

> 基于 2026-02-20 代码仓库 + 真实数据库实查，按责任方分类。

### 12.1 后端数据库项目的问题

| # | 问题 | 现状 | 影响 | 对应执行步骤 |
|---|---|---|---|---|
| B1 | image_resources 表缺少 `sort_order` 字段 | 表中 15 个字段不含 sort_order | 多图排序无法实现 | 步骤 1 |
| B2 | 商品上架无图片校验逻辑 | exchange_items 44 条 active 记录全部 `primary_image_id=NULL` | 无图商品可直接上架面向用户 | 步骤 2 |
| B3 | material_asset_types.icon_url 指向不存在的路径 | 15 条全部为 `test-seeds/icons/asset-*.png`，Sealos 无真实文件 | 前端显示缺图 | 步骤 3 |
| B4 | category_defs 图标不完整 | 12 条中仅 3 条有种子 icon_url，9 条 NULL | 分类图标缺失 | 步骤 4 |
| B5 | popup_banners / carousel_items 未纳入 image_resources 统一管理 | 各自 `image_url` 字符串直存，独立上传流程 | 图片管理双轨并存，无法统一查询/清理/引用计数 | 步骤 5（需拍板） |
| B6 | item_templates 使用遗留字段 `image_url` / `thumbnail_url` | 字符串直存，不走 image_resources FK | 与统一图片管理体系不一致 | 步骤 6 |
| B7 | category_defs 存在脏数据 | `chen112`（斤斤计较）疑似测试数据 | 生产数据不干净 | 步骤 7 |
| B8 | 图片删除保护未实现 | 删除 image_resources 记录未检查 prize/item 引用 | 可能删除正在使用的图片 | 步骤 8 |
| B9 | 孤儿图片清理逻辑已编码但未调度 | `cleanupUnboundImages(hours=24)` 方法存在，但无 cron job | 未绑定图片不会自动清理 | 步骤 9 |

### 12.2 Web 管理台前端项目的问题

| # | 问题 | 现状 | 影响 | 对应执行步骤 |
|---|---|---|---|---|
| W1 | 材料资产图标映射表未创建 | `admin/public/assets/icons/materials/` 有 15 个 PNG 文件，但无 `_mapping.js` | 前端无法通过 asset_code 映射本地图标 | 步骤 10 |
| W2 | 图片上传组件分散，未统一封装 | content/banners/carousel/exchange/item-templates 各自实现上传逻辑 | 代码重复、维护成本高、行为不一致 | 步骤 11 |
| W3 | 商品编辑页无多图上传 UI | 当前只支持单张主图 `primary_image_id` | 无法添加商品详情图 | 步骤 12 |
| W4 | banner 上传走独立流程不走 ImageService | banners.js / carousel-items.js 各自 fetch 上传 | 与后端统一图片管理不一致 | 与 B5 联动 |
| W5 | 分类图标 / 稀有度 CSS 光效未实现 | category_defs 仅 3 个有种子图标，稀有度无 CSS 效果 | 前端展示不完整 | 步骤 13 |

### 12.3 微信小程序前端项目的问题

| # | 问题 | 现状 | 影响 | 对应执行步骤 |
|---|---|---|---|---|
| M1 | 材料资产图标需要本地内嵌 | 小程序需要本地 assets 目录放置 15 个图标 + 映射表 | 网络请求延迟影响体验 | 步骤 14 |
| M2 | 商品列表/详情页缺图降级处理 | 当前 89 个商品全部无图 | 用户看到空白图片或破图 | 步骤 15 |
| M3 | 稀有度视觉效果需实现 | 需要根据 `rarity_defs.color_hex` 实现边框/光效 | 虚拟资产无品质感 | 步骤 16 |
| M4 | C2C 交易市场商品展示 | 294 条挂单无图，需用材料资产图标代替 | 交易列表视觉单调 | 步骤 17 |
| M5 | 弹窗/轮播图片加载 | 图片 URL 由后端 `ImageUrlHelper.getImageUrl()` 拼接，小程序需适配 | 小程序 image 组件需要完整 URL | 步骤 18 |

---

## 十三、基于现有技术栈的可复用性与可扩展性分析

### 13.1 后端已搭建、可直接复用的能力

| 能力 | 代码位置 | 可复用程度 | 说明 |
|---|---|---|---|
| 图片上传 + 缩略图预生成 | `ImageService.uploadImage()` + `SealosStorageService.uploadImageWithThumbnails()` | **100% 可复用** | 3 级缩略图（150/300/600）、MIME 校验、尺寸限制均已实现 |
| 对象 key → 公网 URL 转换 | `ImageUrlHelper.getImageUrl()` | **100% 可复用** | 支持批量转换、缩略图 URL、占位图降级 |
| image_resources CRUD API | `routes/v4/console/images.js` | **100% 可复用** | 上传/查询/绑定/删除全套 RESTful 接口 |
| 外键关联绑定 | `exchange_items.primary_image_id` / `lottery_prizes.image_resource_id` | **100% 可复用** | FK + CASCADE 已定义 |
| Sequelize 模型关联 | `ImageResources.belongsTo(User)` | **80% 可复用** | 需扩展 hasMany 关联支持多图 |
| 占位图降级链 | `ImageUrlHelper.getPlaceholderImageUrl()` | **100% 可复用** | 按 business_type 返回对应占位图 |
| Admin 认证中间件 | `authenticateToken` + `requireRoleLevel(100)` | **100% 可复用** | 所有图片管理 API 已接入 |

### 13.2 后端需要扩展/新增的能力

| 能力 | 工作量 | 扩展方式 |
|---|---|---|
| sort_order 字段 | 迁移脚本 + 模型更新 | `ALTER TABLE image_resources ADD COLUMN sort_order INT DEFAULT 0` |
| 商品上架图片校验 | 业务逻辑层 | 在 exchange_items / lottery_prizes 的 status 变更 hook 中校验 |
| 图片删除引用保护 | ImageService.deleteImage() 增强 | 删除前查询 prize/item 是否引用该 image_resource_id |
| 孤儿图片定时清理 | node-cron 调度 | 已有 `cleanupUnboundImages()` 方法，只需加 cron 调度 |
| popup_banners / carousel_items 纳入统一管理 | 迁移 + 路由改造 | **需拍板**（见决策项） |

### 13.3 Web 管理台前端已有、可复用的能力

| 能力 | 代码位置 | 可复用程度 |
|---|---|---|
| Alpine.js 文件上传组件 | `admin/src/alpine/components/file-upload.js` | **80% 可复用** — 支持拖拽、多文件、预览，可封装为统一上传组件 |
| 图片懒加载 | `admin/src/alpine/components/image-loader.js` | **100% 可复用** — IntersectionObserver + 渐进加载 |
| API 集成模式 | `admin/src/api/system/admin.js` 定义端点 | **100% 可复用** — 标准 fetch + token 认证 |
| 内容管理模块 | `admin/src/modules/content/` | **70% 可复用** — 图片列表/删除已实现，多图上传需扩展 |
| 材料图标 PNG 文件 | `admin/public/assets/icons/materials/` 15 个文件 | **100% 可复用** — 暗黑奢华风 256×256 已生成 |

### 13.4 Web 管理台前端技术栈兼容性

| 技术点 | 管理台现有技术栈 | 是否兼容本方案 | 说明 |
|---|---|---|---|
| 构建工具 | Vite 6.4.1 | 兼容 | 静态资源自动处理 |
| UI 框架 | Alpine.js 3.15.4 | 兼容 | composable 模式可封装上传组件 |
| 样式 | Tailwind CSS 3.4.19 | 兼容 | 稀有度光效可用 Tailwind + CSS animation |
| 多页应用 | Vite 多入口 HTML | 兼容 | 新增商品编辑多图区域无需改架构 |
| 图表 | ECharts 6.0.0 | 无关 | 图片管理不涉及图表 |
| 实时通信 | Socket.io 4.8.3 | 可选扩展 | 可用于图片上传进度推送，非必须 |

---

## 十四、执行步骤（以后端数据库项目为权威，前端适配后端）

> 每个步骤标注责任方（后端 B / Web 前端 W / 小程序 M）和优先级。

### 步骤 1：image_resources 表新增 sort_order 字段 [B] [P1]

**责任方**：后端

**操作**：
1. 创建 Sequelize 迁移文件 `migrations/xxx-add-sort-order-to-image-resources.js`
2. 新增 `sort_order INT DEFAULT 0 COMMENT '同一 context_id 内的排序序号'`
3. 更新 `models/ImageResources.js` 添加 sort_order 字段定义
4. 执行 `npm run db:migrate`

**可复用**：Sequelize CLI 迁移体系已完善（项目已有多个迁移文件），直接复用 `npm run migration:create` 脚手架。

### 步骤 2：商品上架强制图片校验 [B] [P0]

**责任方**：后端

**操作**：
1. 在 `services/exchange/AdminService.js` 的状态变更逻辑中，当 `status` 从非 active → active 时校验 `primary_image_id` 非空
2. 同理在奖品管理中，physical 类型奖品上架时校验 `image_resource_id` 非空
3. points / coupon / virtual 类型奖品豁免图片校验（使用前端静态图标）
4. 返回标准 ApiResponse 错误格式：`{ success: false, code: 'IMAGE_REQUIRED', message: '实物商品上架必须上传图片' }`

**可复用**：项目已有 ApiResponse 标准响应格式、Sequelize hooks 机制。

### 步骤 3：材料资产图标上传 Sealos + 更新 icon_url [B] [P0]

**责任方**：后端

**操作**：
1. 编写一次性脚本，读取 `admin/public/assets/icons/materials/` 下 15 个 PNG
2. 通过 `SealosStorageService.uploadImage()` 上传到 Sealos `materials/` 目录
3. 更新 `material_asset_types.icon_url` 为真实对象 key（如 `materials/diamond.png`）
4. 脚本执行后验证所有 15 条记录 icon_url 指向可访问的 URL

**可复用**：`SealosStorageService` 上传能力 100% 复用。

### 步骤 4：category_defs 图标补充 [B] [P2]

**责任方**：后端 + Web 前端设计

**操作**：
1. 为缺失图标的 9 个分类设计/生成图标
2. 上传到 Sealos `categories/` 目录
3. 更新 `category_defs.icon_url`
4. 或者走前端静态资源方案（分类图标数量有限且固定），前端通过 `category_code` 映射本地文件

### 步骤 5：popup_banners / carousel_items 图片管理统一化 [B] [需拍板]

**责任方**：后端

**方案 A（推荐）—— 保持现状，不纳入 image_resources**：
- popup_banners / carousel_items 已有独立上传流程且工作正常（2 条弹窗 + 1 条轮播均有图）
- 它们的生命周期独立（有 start_time / end_time 时间控制）
- 不需要多图、不需要缩略图、不需要引用计数
- 保持 `image_url` 字符串直存，简单可控

**方案 B —— 纳入 image_resources 统一管理**：
- 需要迁移脚本将现有 image_url 转为 image_resources 记录
- 需要改造弹窗/轮播的上传 API 走 ImageService
- 好处是统一管理、统一清理
- 代价是增加复杂度，对仅 2-3 条记录的表过度设计

### 步骤 6：item_templates 遗留字段处理 [B] [P2]

**责任方**：后端

**操作**：
1. item_templates 当前仅 1 条有 `image_url`（值为测试数据 `test/image.png`）
2. 方案：新增 `image_resource_id` FK 字段，废弃 `image_url` / `thumbnail_url`
3. 迁移脚本：`ALTER TABLE item_templates ADD COLUMN image_resource_id INT REFERENCES image_resources(image_resource_id)`
4. 模型更新：添加 belongsTo 关联
5. 清理测试数据

### 步骤 7：清理 category_defs 脏数据 [B] [P2]

**责任方**：后端

**操作**：确认 `chen112`（斤斤计较）是否为测试数据，如是则删除。同时检查 `auto`、`beauty` 等分类是否为正式业务分类。

### 步骤 8：图片删除引用保护 [B] [P1]

**责任方**：后端

**操作**：
1. 在 `ImageService.deleteImage()` 中增加引用检查
2. 查询 `lottery_prizes` / `exchange_items` 是否有 FK 指向该 `image_resource_id`
3. 有引用则返回 `{ success: false, code: 'IMAGE_IN_USE', message: '图片正在被 N 个商品/奖品使用，无法删除' }`
4. 可复用：Sequelize 关联查询能力

### 步骤 9：孤儿图片定时清理调度 [B] [P2]

**责任方**：后端

**操作**：
1. 已有 `ImageService.cleanupUnboundImages(hours=24)` 方法
2. 在 `services/index.js` 或 cron 配置中添加 node-cron 调度（如每日凌晨 2 点执行）
3. 项目已有 node-cron 依赖且已用于广告系统定时任务，直接复用

### 步骤 10：Web 管理台材料图标映射表 [W] [P0]

**责任方**：Web 管理台前端

**操作**：
1. 在 `admin/public/assets/icons/materials/` 创建 `_mapping.js`
2. 导出 `MATERIAL_ICONS` 对象：`{ DIAMOND: '/assets/icons/materials/diamond.png', ... }`
3. 所有使用 `icon_url` 的地方，优先查本地映射，后端 `icon_url` 作为 fallback

### 步骤 11：统一图片上传组件封装 [W] [P1]

**责任方**：Web 管理台前端

**操作**：
1. 基于现有 `admin/src/alpine/components/file-upload.js` 封装统一的 `ImageUploader` Alpine.js composable
2. 统一调用 `SYSTEM_ADMIN_ENDPOINTS.IMAGE_UPLOAD`，统一返回 `image_resource_id`
3. 各模块（exchange-items / item-templates / content）复用该组件，删除重复上传代码
4. 可复用：现有 file-upload.js 已支持拖拽、预览、校验

### 步骤 12：商品编辑多图上传 UI [W] [P1]

**责任方**：Web 管理台前端

**操作**：
1. 商品编辑页增加「详情图」区域（最多 9 张）
2. 支持拖拽排序（更新 `sort_order`）
3. 每张图调用后端 `POST /api/v4/console/images/upload` + `PATCH /api/v4/console/images/:id/bind`
4. 用后端返回的 `image_resource_id` 和 `sort_order` 管理顺序

### 步骤 13：稀有度 CSS 光效 [W] [P2]

**责任方**：Web 管理台前端 + 小程序前端

**操作**：
1. 基于 `rarity_defs.color_hex`（common:#9E9E9E / uncommon:#4CAF50 / rare:#2196F3 / epic:#9C27B0 / legendary:#FF9800）
2. Tailwind CSS + CSS animation 实现边框颜色 + 光晕效果
3. 小程序用 WXSS 实现同等效果

### 步骤 14-18：微信小程序前端适配

**步骤 14 [M] [P0]**：小程序 assets 目录放置 15 个材料图标 + 映射表
**步骤 15 [M] [P0]**：商品列表/详情页实现缺图降级（占位图 → 分类图标 → 通用占位）
**步骤 16 [M] [P2]**：稀有度视觉效果（WXSS 实现边框 + 光效）
**步骤 17 [M] [P1]**：C2C 交易市场用 `asset_code` 映射本地图标展示
**步骤 18 [M] [P0]**：后端 API 返回的图片 URL 直接使用（后端 `ImageUrlHelper` 已拼接完整 URL），小程序 `<image>` 组件 `src` 直接绑定

---

## 十五、需要拍板的决策

| # | 决策项 | 选项 | 推荐 | 影响范围 |
|---|---|---|---|---|
| **决策 7** | popup_banners / carousel_items 是否纳入 image_resources 统一管理 | A. 保持现状（推荐）/ B. 纳入统一管理 | A | 后端迁移工作量 + 前端上传流程改造 |
| **决策 8** | item_templates 是否迁移到 image_resource_id FK | A. 迁移（推荐）/ B. 保持遗留字段 | A | 后端迁移脚本 + 模型更新 |
| **决策 9** | category_defs 图标方案 | A. 前端静态（推荐）/ B. 后端 Sealos 动态 | A | 设计师出图 + 前端映射表 |
| **决策 10** | category_defs 脏数据 `chen112` 是否删除 | A. 删除 / B. 保留 | A | 一条 SQL |
| **决策 11** | 孤儿图片清理频率 | A. 每日凌晨 2 点 / B. 每 6 小时 / C. 手动触发 | A | cron 配置 |
| **决策 12** | 图片上传组件是否统一封装 | A. 统一封装（推荐）/ B. 保持各模块独立 | A | Web 前端重构工作量 |
