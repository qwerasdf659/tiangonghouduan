# 积分预算架构真实状态核查报告

**核查时间**：2025年1月3日  
**核查方式**：Node.js 直连真实 MySQL 数据库（读取 `.env` 配置）  
**核查范围**：积分账户/资产余额/账本流水表结构与数据一致性  
**核查目标**：验证"技术债务全面分析报告.md"中描述的"预算积分架构设计问题"是否存在于当前真实系统

---

## 📊 一、真实数据库现状

### 1.1 数据库基础信息

```
数据库名称：restaurant_points_dev
MySQL版本：8.0.30
连接状态：✅ 正常
```

### 1.2 表存在性检查（针对积分/资产相关表）

| 表名                     | 真实库状态    | 说明                   |
| ------------------------ | ------------- | ---------------------- |
| `user_points_accounts`   | ❌ **不存在** | 旧积分账户表，已被删除 |
| `points_transactions`    | ❌ **不存在** | 旧积分流水表，已被删除 |
| `accounts`               | ✅ **存在**   | 新账户主体表           |
| `account_asset_balances` | ✅ **存在**   | 新资产余额表           |
| `asset_transactions`     | ✅ **存在**   | 新资产流水表（账本）   |

### 1.3 迁移执行状态

```
迁移记录：20251230200000-drop-deprecated-points-tables.js
执行状态：✅ 已执行
结论：旧积分表删除迁移已在真实库完成
```

---

## 🔍 二、关键表结构核查

### 2.1 `account_asset_balances` 表结构（余额真相源）

```sql
字段列表：
- balance_id          (主键)
- account_id          (外键 → accounts)
- asset_code          (资产代码：POINTS/BUDGET_POINTS/DIAMOND等)
- available_amount    (可用余额)
- frozen_amount       (冻结余额)
- campaign_id         (✅ 活动ID字段 - 已存在)
- created_at
- updated_at

唯一约束：(account_id, asset_code, campaign_id)
```

**关键发现**：`campaign_id` 字段在真实表结构中**已存在**，并且是唯一约束的一部分。

### 2.2 `asset_transactions` 表结构（账本流水）

```sql
字段列表：
- transaction_id      (主键)
- account_id          (外键 → accounts)
- asset_code          (资产代码)
- delta_amount        (变动金额：正数增加/负数扣减)
- balance_before      (变动前余额)
- balance_after       (变动后余额)
- business_type       (业务类型)
- idempotency_key     (幂等键 - 唯一约束)
- lottery_session_id  (抽奖会话ID)
- meta                (扩展信息 JSON)
- created_at
```

---

## 🎯 三、user_id=31 的真实数据核查

### 3.1 账户与余额状态

```javascript
// accounts 表
{
  account_id: 5,
  account_type: 'user',
  status: 'active'
}

// account_asset_balances 表（POINTS）
{
  balance_id: 29,
  account_id: 5,
  asset_code: 'POINTS',
  campaign_id: null,          // ⚠️ POINTS 的 campaign_id 为 NULL
  available_amount: 48352,    // 当前可用积分：48352
  frozen_amount: 0,
  created_at: '2025-12-20 19:53:46',
  updated_at: '2026-01-02 17:50:21'
}

// account_asset_balances 表（BUDGET_POINTS）
查询结果：❌ 无记录
```

### 3.2 流水记录核查（account_id=5）

```javascript
// POINTS 流水统计
{
  asset_code: 'POINTS',
  txn_count: 1,              // ⚠️ 仅 1 条流水
  delta_sum: '-100',         // 累计变动：-100
  last_tx_at: '2026-01-02 17:50:21'
}

// BUDGET_POINTS 流水统计
查询结果：❌ 无记录

// 最近 5 条 POINTS 流水
[
  {
    transaction_id: 294,
    asset_code: 'POINTS',
    delta_amount: -100,
    balance_before: 48452,
    balance_after: 48352,
    business_type: 'lottery_consume',
    idempotency_key: 'verify_ledger_1767376221824:consume',
    created_at: '2026-01-02 17:50:21'
  }
]
```

### 3.3 数据一致性分析

**严重问题**：余额与流水不匹配

- **余额表显示**：`available_amount = 48352`
- **流水显示**：最新 `balance_after = 48352`（一致✅）
- **流水覆盖率**：仅 1 条流水，累计变动 `-100`
- **推算初始余额**：`48352 - (-100) = 48452`

**核心矛盾**：

- 如果流水是真相源，用户应该只有 48452 积分，且只发生过 1 次扣减操作
- 但余额表显示用户有 48352 积分，这意味着：
  - **要么**：历史流水已被清理/丢失（余额是对的，流水不全）
  - **要么**：余额是手工调整的（流水未记录）
  - **要么**：系统在迁移前后存在数据不一致

---

## 🔴 四、全库层面的 POINTS/BUDGET_POINTS 分布

### 4.1 余额表全局统计

```javascript
// POINTS 余额统计
{
  asset_code: 'POINTS',
  row_count: 7,              // 7 个账户有 POINTS 余额
  sum_available: '48352',    // 全库可用 POINTS 总和
  sum_frozen: '0'            // 无冻结
}

// BUDGET_POINTS 余额统计
查询结果：❌ 无记录（全库 0 个账户有 BUDGET_POINTS）
```

### 4.2 流水表全局统计

```javascript
// POINTS 流水统计
{
  asset_code: 'POINTS',
  row_count: 1,              // ⚠️ 全库仅 1 条 POINTS 流水
  delta_sum: '-100'          // 累计变动：-100
}

// BUDGET_POINTS 流水统计
查询结果：❌ 无记录（全库 0 条 BUDGET_POINTS 流水）
```

### 4.3 BUDGET_POINTS 按 campaign_id 分布

```
查询结果：❌ 空结果集
结论：真实库中不存在任何 BUDGET_POINTS 数据
```

---

## 🚨 五、核心问题判定

### 5.1 关于"技术债务报告"描述的问题

**报告原文**：

> - user_points_accounts 同时存储两类积分(available_points + budget_points)
> - 抽奖策略实际使用 account_asset_balances(POINTS) 做扣减和预算筛奖
> - 真实数据库已出现不一致: user_id=31: available_points=10000 但 ledger POINTS=42352
> - 预算积分缺少campaign维度，无法按活动独立控制

**真实状态判定**：

| 问题描述                                  | 真实库状态               | 判定结论                                                    |
| ----------------------------------------- | ------------------------ | ----------------------------------------------------------- |
| `user_points_accounts` 同时存两类积分     | 表已不存在               | ❌ **不成立**（表已删除）                                   |
| 抽奖使用 `account_asset_balances(POINTS)` | 代码确实如此             | ✅ **成立**                                                 |
| user_id=31 余额与账本不一致               | 余额48352，流水仅1条     | ⚠️ **部分成立**（数据不一致存在，但不是报告描述的那组数字） |
| 预算缺少 campaign 维度                    | `campaign_id` 字段已存在 | ❌ **不成立**（字段存在，但未被使用）                       |

### 5.2 真实存在的核心问题

#### 问题 A：账本覆盖率严重不足（🔴 严重）

- **现象**：全库 7 个账户有 POINTS 余额（总和 48352），但流水表仅 1 条记录
- **影响**：
  - 无法审计余额来源
  - 无法追溯历史交易
  - 无法做财务对账
  - 运营/客服无法解释用户余额从何而来
- **根本原因**：
  - 可能是迁移前的历史数据未迁移流水
  - 可能是部分业务操作直接修改余额表，未写流水
  - 可能是流水表被清理过

#### 问题 B：BUDGET_POINTS 概念在代码与数据层面完全脱节（🔴 严重）

- **代码层面**：
  - `ConsumptionService.approveConsumption()` 会发放 `BUDGET_POINTS`（代码存在）
  - `BasicGuaranteeStrategy.getAvailablePrizes()` 的"预算过滤"用的是 `POINTS`（不是 `BUDGET_POINTS`）
  - `account_asset_balances.campaign_id` 字段已存在，注释明确说"仅 BUDGET_POINTS 需要"
- **真实库状态**：
  - 全库 0 条 `BUDGET_POINTS` 余额记录
  - 全库 0 条 `BUDGET_POINTS` 流水记录
- **结论**：
  - **要么**：消费审核业务从未在真实环境执行过
  - **要么**：`BUDGET_POINTS` 发放逻辑被条件挡住（如 `budgetPointsToAllocate <= 0`）
  - **要么**：`BUDGET_POINTS` 被后续清理/未落库

#### 问题 C：UnifiedDatabaseHelper 的核心表清单已过期（⚠️ 中等）

- **代码定义**：`coreTables = ['users', 'lottery_draws', 'lottery_prizes', 'user_points_accounts']`
- **真实库状态**：`user_points_accounts` 已不存在
- **影响**：
  - 健康检查会误报"缺少核心表"
  - 诊断脚本会产生假阴性
  - 运维监控会持续产生噪音

---

## 💡 六、整改方案建议

### 方案 A：明确"账本为真相源"的审计架构（推荐）

**目标**：让 `asset_transactions` 成为可信的审计真相源

**落地步骤**：

1. **全库资产对账体检**（用 Node.js 脚本直连真实库）

   ```javascript
   // 检查每个 account_id 的每个 asset_code：
   // - 余额表 available_amount 是否等于流水表最新 balance_after
   // - 余额表 available_amount 是否等于流水表累计 delta_amount（从0开始）
   // - 找出所有"有余额但无流水"的记录
   ```

2. **决策：历史余额如何处理**
   - **选项 1（推荐）**：为所有现存余额补录"期初余额"流水
     ```sql
     -- 为每个非零余额创建一条 business_type='balance_migration' 的流水
     INSERT INTO asset_transactions (
       account_id, asset_code, delta_amount, balance_before, balance_after,
       business_type, idempotency_key, created_at
     )
     SELECT
       account_id, asset_code, available_amount, 0, available_amount,
       'balance_migration',
       CONCAT('migration_init_', account_id, '_', asset_code, '_', UNIX_TIMESTAMP()),
       '2025-12-30 00:00:00'
     FROM account_asset_balances
     WHERE available_amount > 0
       AND NOT EXISTS (
         SELECT 1 FROM asset_transactions t
         WHERE t.account_id = account_asset_balances.account_id
           AND t.asset_code = account_asset_balances.asset_code
       );
     ```
   - **选项 2（激进）**：清零所有无流水支撑的余额（⚠️ 破坏性）

3. **强制规则：所有余额变更必须写流水**
   - 在 `AssetService.changeBalance()` 里已有幂等保护
   - 需要代码审查：确保没有任何地方直接 `UPDATE account_asset_balances`（绕过 `AssetService`）

### 方案 B：明确 BUDGET_POINTS 的商业语义与技术实现

**问题根源**：代码里有三种"钱"的语义混在一起

**决策点 1：预算到底属于谁？**

| 方案       | 预算归属     | campaign_id 用法       | 抽奖筛奖逻辑             | 适用场景         |
| ---------- | ------------ | ---------------------- | ------------------------ | ---------------- |
| **方案 1** | 活动/平台    | 系统账户 + campaign_id | 查活动预算账户余额       | 平台控制奖池成本 |
| **方案 2** | 用户×活动    | 用户账户 + campaign_id | 查用户在该活动的预算余额 | 用户分活动额度   |
| **方案 3** | 废弃预算概念 | 删除 BUDGET_POINTS     | 直接用 POINTS 筛奖       | 简化架构         |

**当前代码的混乱状态**：

- 消费审核发放 `BUDGET_POINTS` → 暗示"方案 2"（用户×活动）
- 抽奖筛奖用 `POINTS` → 暗示"方案 3"（废弃预算）
- 表结构有 `campaign_id` → 暗示"方案 1 或 2"
- 真实库无任何 `BUDGET_POINTS` → 暗示"方案 3"或"代码未跑通"

**建议决策流程**：

1. **先确认商业模式**：
   - 如果你的商业目标是"平台控制每个活动的奖池成本"，选**方案 1**
   - 如果你的商业目标是"用户在不同活动有独立的抽奖额度"，选**方案 2**
   - 如果预算概念对你的业务没有实际价值，选**方案 3**

2. **按决策对齐代码**：
   - **方案 1**：
     - 创建系统账户（如 `SYSTEM_CAMPAIGN_BUDGET`）
     - 消费审核改为给系统账户充 `BUDGET_POINTS`（带 `campaign_id`）
     - 抽奖筛奖改为查系统账户的 `BUDGET_POINTS` 余额
   - **方案 2**：
     - 消费审核发放 `BUDGET_POINTS` 时必须带 `campaign_id`（当前代码未传）
     - 抽奖筛奖改为查用户在该 `campaign_id` 的 `BUDGET_POINTS` 余额
   - **方案 3**：
     - 删除 `ConsumptionService` 里发放 `BUDGET_POINTS` 的代码
     - 删除 `BasicGuaranteeStrategy` 里"预算过滤"的逻辑
     - 文档明确说明"抽奖仅受用户 POINTS 余额约束"

### 方案 C：修复 UnifiedDatabaseHelper 的核心表清单

**当前问题**：

```javascript
// utils/UnifiedDatabaseHelper.js:160
this.coreTables = ['users', 'lottery_draws', 'lottery_prizes', 'user_points_accounts']
```

**真实库状态**：`user_points_accounts` 已不存在

**影响**：

- `healthCheck()` 会误报"缺少核心表"
- 诊断脚本会产生假阴性
- 运维监控会持续噪音

**修复方案**：

```javascript
// 对齐到新架构
this.coreTables = [
  'users',
  'lottery_draws',
  'lottery_prizes',
  'accounts', // 新增
  'account_asset_balances', // 新增
  'asset_transactions' // 新增
]
```

---

## 📋 七、核查结论总结

### 7.1 关于"技术债务报告"描述问题的判定

| 报告描述                                | 真实状态             | 判定                                  |
| --------------------------------------- | -------------------- | ------------------------------------- |
| `user_points_accounts` 同时存两类积分   | 表已删除             | ❌ 不成立                             |
| 抽奖用 `account_asset_balances(POINTS)` | 代码确实如此         | ✅ 成立                               |
| user_id=31 余额与账本不一致             | 余额48352，流水仅1条 | ⚠️ 数据不一致存在（但不是报告的数字） |
| 预算缺少 campaign 维度                  | 字段已存在但未使用   | ⚠️ 字段存在，业务未用                 |

### 7.2 真实存在的核心问题（按严重程度排序）

**🔴 P0 严重问题**：

1. **账本覆盖率严重不足**：全库 7 个账户有 POINTS 余额（总和 48352），但流水表仅 1 条记录
   - 影响：无法审计、无法追溯、无法对账
   - 建议：立即执行全库对账体检 + 补录期初流水

2. **BUDGET_POINTS 概念完全脱节**：代码有发放逻辑，真实库无任何数据
   - 影响：预算控制/活动隔离功能实际未生效
   - 建议：明确商业模式 → 对齐代码 → 验证落地

**⚠️ P1 中等问题**：3. **UnifiedDatabaseHelper 核心表清单过期**：仍要求已删除的 `user_points_accounts`

- 影响：健康检查误报、诊断噪音
- 建议：更新核心表清单到新架构

### 7.3 风险评估

**数据一致性风险**：🔴 高

- 余额与流水严重不匹配
- 无法保证余额的准确性和可追溯性
- 财务对账/审计/客诉处理会遇到困难

**业务逻辑风险**：🔴 高

- BUDGET_POINTS 概念在代码与数据层面完全脱节
- 预算控制功能实际未生效
- campaign 维度的活动隔离未落地

**运维监控风险**：⚠️ 中

- 健康检查会持续误报
- 诊断工具会产生假阴性

---

## 🎯 八、下一步行动建议

### 立即执行（本周内）

1. **全库资产对账体检**（用 Node.js 脚本）
   - 检查所有 `account_asset_balances` 非零余额
   - 对比流水表的 `balance_after` 与累计 `delta_amount`
   - 输出：哪些账户/资产存在余额≠流水的情况

2. **明确 BUDGET_POINTS 的商业决策**
   - 召集业务/产品/技术讨论：预算到底要不要？属于谁？
   - 如果要：选择方案 1 或 2，并对齐代码
   - 如果不要：删除相关代码，简化架构

3. **修复 UnifiedDatabaseHelper 核心表清单**
   - 从 `user_points_accounts` 改为 `accounts/account_asset_balances/asset_transactions`
   - 验证健康检查不再误报

### 中期优化（2周内）

4. **补录历史余额的期初流水**（如果选择"账本为真相源"）
   - 为所有现存余额创建 `business_type='balance_migration'` 的流水
   - 确保余额表的每一分钱都能在流水表找到来源

5. **代码审查：禁止绕过 AssetService**
   - 全局搜索 `UPDATE account_asset_balances`
   - 确保所有余额变更都走 `AssetService.changeBalance()`

6. **建立余额-流水一致性监控**
   - 定时任务：每日对账检查
   - 告警机制：发现不一致立即通知

---

## 📎 附录：核查脚本

### A.1 真实库连接与表结构核查脚本

```javascript
// 用法：cd /home/devbox/project && node check_real_db.js
require('dotenv').config({ path: '.env' })
const mysql = require('mysql2/promise')

;(async () => {
  const conn = await mysql.createConnection({
    host: process.env.DB_HOST,
    port: Number(process.env.DB_PORT || 3306),
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    database: process.env.DB_NAME
  })

  // 检查表存在性
  const [tables] = await conn.query(
    "SELECT TABLE_NAME FROM information_schema.tables WHERE table_schema=? AND TABLE_NAME IN ('user_points_accounts','accounts','account_asset_balances','asset_transactions')",
    [process.env.DB_NAME]
  )
  console.log(
    '存在的表:',
    tables.map(r => r.TABLE_NAME)
  )

  // 检查 POINTS/BUDGET_POINTS 分布
  const [balances] = await conn.query(
    "SELECT asset_code, COUNT(*) AS cnt, SUM(available_amount) AS total FROM account_asset_balances WHERE asset_code IN ('POINTS','BUDGET_POINTS') GROUP BY asset_code"
  )
  console.log('余额分布:', balances)

  const [txns] = await conn.query(
    "SELECT asset_code, COUNT(*) AS cnt, SUM(delta_amount) AS total FROM asset_transactions WHERE asset_code IN ('POINTS','BUDGET_POINTS') GROUP BY asset_code"
  )
  console.log('流水分布:', txns)

  await conn.end()
})()
```

### A.2 全库对账体检脚本（待执行）

```javascript
// 用法：cd /home/devbox/project && node full_reconciliation_check.js
require('dotenv').config({ path: '.env' })
const mysql = require('mysql2/promise')

;(async () => {
  const conn = await mysql.createConnection({
    host: process.env.DB_HOST,
    port: Number(process.env.DB_PORT || 3306),
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    database: process.env.DB_NAME
  })

  // 查询所有非零余额
  const [balances] = await conn.query(
    'SELECT balance_id, account_id, asset_code, campaign_id, available_amount, frozen_amount FROM account_asset_balances WHERE available_amount > 0 OR frozen_amount > 0'
  )

  console.log(`检查 ${balances.length} 个非零余额...`)

  const issues = []

  for (const bal of balances) {
    // 查询该账户该资产的流水
    const [txns] = await conn.query(
      'SELECT transaction_id, delta_amount, balance_after FROM asset_transactions WHERE account_id=? AND asset_code=? ORDER BY transaction_id DESC LIMIT 1',
      [bal.account_id, bal.asset_code]
    )

    if (txns.length === 0) {
      issues.push({
        type: '无流水支撑',
        account_id: bal.account_id,
        asset_code: bal.asset_code,
        available_amount: bal.available_amount,
        frozen_amount: bal.frozen_amount
      })
    } else {
      const lastTx = txns[0]
      if (Number(lastTx.balance_after) !== Number(bal.available_amount)) {
        issues.push({
          type: '余额与流水不一致',
          account_id: bal.account_id,
          asset_code: bal.asset_code,
          balance_table: bal.available_amount,
          ledger_balance_after: lastTx.balance_after,
          diff: Number(bal.available_amount) - Number(lastTx.balance_after)
        })
      }
    }
  }

  console.log(`\n发现 ${issues.length} 个问题：`)
  console.log(JSON.stringify(issues, null, 2))

  await conn.end()
})()
```

---

## 📌 核心结论

1. **"技术债务报告"描述的问题在当前真实库中不完全成立**：
   - `user_points_accounts` 表已删除（不存在"两类积分同时存储"）
   - `campaign_id` 字段已存在（不存在"缺少 campaign 维度"）

2. **真实存在的核心问题更严重**：
   - **账本覆盖率不足**：余额有值但流水几乎没有（无法审计）
   - **BUDGET_POINTS 完全脱节**：代码有逻辑，真实库无数据（功能未生效）
   - **核心表清单过期**：健康检查仍要求已删除的旧表（误报）

3. **建议优先级**：
   - **P0**：全库对账体检 + 补录期初流水（解决审计问题）
   - **P0**：明确 BUDGET_POINTS 商业语义 + 对齐代码（解决功能脱节）
   - **P1**：修复核心表清单（消除监控噪音）

---

**核查人员**：AI Assistant  
**核查方法**：Node.js + mysql2 直连真实数据库（不依赖备份文件）  
**数据来源**：`/home/devbox/project/.env` 配置的真实 MySQL 数据库  
**报告生成时间**：2025年1月3日
