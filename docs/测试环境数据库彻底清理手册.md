# 测试环境数据库彻底清理手册

**生成时间**: 2025-01-30（基于真实数据库状态更新）  
**数据库**: restaurant_lottery (测试环境)  
**总表数**: 72 张表（另有1张测试垃圾表需删除）  
**文档用途**: 通用的测试环境数据清理标准操作手册（纯清单格式）

> ⚠️ **测试垃圾表**：`deadlock_test_1769781752856` 是测试过程中产生的临时表，清理时需 `DROP TABLE` 删除。

---

## 🔴 已选定：方案 B（激进清理）

> **决策时间**：2025-01-30  
> **清理范围**：约69张表（仅保留表结构 + 迁移记录 + 行政区划字典）  
> **恢复时间**：2-4 小时（需重建所有配置、用户、活动）

### ⚠️ 方案B会清空的配置表（共21个，约420+条数据）

| 表名 | 数据量 | 重要性 | 说明 |
|------|--------|--------|------|
| `roles` | 11 条 | 🔴 必需 | 角色定义 |
| `system_settings` | 39 条 | 🔴 必需 | 系统配置（含严格模式配置） |
| `material_asset_types` | 4 条 | 🔴 必需 | 资产类型定义 |
| `feature_flags` | 7 条 | 🔴 必需 | 功能开关（抽奖策略） |
| `lottery_campaigns` | 4 条 | 🔴 必需 | 活动配置 |
| `lottery_prizes` | 30 条 | 🔴 必需 | 奖品池定义 |
| `lottery_tier_rules` | 9 条 | 🟡 建议 | 档位概率规则 |
| `lottery_strategy_config` | 17 条 | 🟡 建议 | 策略全局配置 |
| `lottery_tier_matrix_config` | 12 条 | 🟡 建议 | BxPx矩阵配置 |
| `lottery_draw_quota_rules` | 7 条 | 🟡 建议 | 配额规则 |
| `preset_debt_limits` | 1 条 | 🟡 建议 | 欠账上限 |
| `item_templates` | 16 条 | 🟡 建议 | 物品模板（物品奖品需要） |
| `category_defs` | 8 条 | 🟡 建议 | 类目字典 |
| `rarity_defs` | 6 条 | 🟡 建议 | 稀有度字典 |
| `asset_group_defs` | 8 条 | 🟡 建议 | 资产组字典 |
| `stores` | 5 条 | 🟡 建议 | 门店配置（消费功能需要） |
| `products` | 52 条 | 🟡 建议 | 商品配置（消费功能需要） |
| `exchange_items` | 35 条 | 🟡 建议 | 兑换商品（兑换功能需要） |
| `system_dictionaries` | 244 条 | 🟡 建议 | 系统字典（中文映射） |
| `system_configs` | 6 条 | 🟡 建议 | 系统配置（批量限流等） |
| `lottery_campaign_pricing_config` | 11 条 | 🟡 建议 | 活动定价配置 |
| `user_risk_profiles` | 3 条 | 🟡 建议 | 风控级别配置（非用户个人） |
| `material_conversion_rules` | 1 条 | 🟡 建议 | 资产转换规则 |

**🟡 建议数据不配置的后果**：
| 缺失数据 | 影响 |
|----------|------|
| 抽奖策略配置 | 抽奖仅使用基础概率，无Pity/LuckDebt等高级策略 |
| 物品模板 | 无法发放物品类型奖品，只能发放资产 |
| 门店/商品 | 消费功能不可用，用户无法通过消费获得积分 |
| 兑换商品 | 兑换功能不可用 |
| 系统字典 | 部分界面显示英文代码而非中文 |
| 系统配置 | 批量操作限流等配置丢失 |
| 活动定价 | 抽奖定价配置丢失 |
| 风控配置 | 风控级别规则丢失 |
| 转换规则 | 资产转换功能不可用 |

---

### ⚠️ 重建数据的执行顺序（有外键依赖）

```
1. roles              ← 最先插入（user_roles 依赖它）
2. material_asset_types ← 资产类型
3. system_settings    ← 系统配置
4. feature_flags      ← 功能开关
5. lottery_campaigns  ← 活动配置（lottery_prizes 依赖它）
6. lottery_prizes     ← 奖品池（依赖 lottery_campaigns）
7. [用户登录]         ← 系统自动创建 users 记录
8. accounts           ← 系统账户（依赖 users）
9. user_roles         ← 关联管理员角色（依赖 users 和 roles）
```

---

### 🔴 必须准备的数据（否则系统无法启动）

#### 1️⃣ 管理员手机号
`____________`

⚠️ **重要**：用户登录会自动创建 `users` 记录，但**不会自动赋予admin角色**！

**清空后授权管理员的完整步骤**：
```bash
# 步骤1：管理员用手机号登录系统（验证码123456），系统自动创建用户

# 步骤2：查询新建用户的user_id和admin角色的role_id
node -e "
require('dotenv').config();
const { sequelize } = require('./config/database');
(async () => {
  const [[user]] = await sequelize.query(\"SELECT user_id FROM users WHERE mobile='你的手机号'\");
  const [[role]] = await sequelize.query(\"SELECT role_id FROM roles WHERE role_name='admin'\");
  console.log('user_id:', user?.user_id, 'role_id:', role?.role_id);
  if (user && role) {
    console.log('执行SQL: INSERT INTO user_roles (user_id, role_id) VALUES (' + user.user_id + ', ' + role.role_id + ');');
  }
  await sequelize.close();
})();
"

# 步骤3：执行INSERT关联用户和角色
node -e "
require('dotenv').config();
const { sequelize } = require('./config/database');
(async () => {
  await sequelize.query('INSERT INTO user_roles (user_id, role_id) SELECT u.user_id, r.role_id FROM users u, roles r WHERE u.mobile=\"你的手机号\" AND r.role_name=\"admin\"');
  console.log('✅ 管理员角色已授权');
  await sequelize.close();
})();
"
```

#### 2️⃣ 角色定义（11条）

**字段说明**：
- `role_name`：角色唯一标识（代码中用此值判断权限）
- `role_level`：角色等级数值（数值越高权限越大，用于权限层级判断）

| role_name | role_level | 说明 |
|-----------|------------|------|
| `admin` | 100 | 管理员（最高权限） |
| `regional_manager` | 80 | 区域经理 |
| `business_manager` | 60 | 业务经理 |
| `merchant_manager` | 40 | 商户管理 |
| `sales_staff` | 40 | 业务员 |
| `ops` | 30 | 运营 |
| `merchant_staff` | 20 | 商户员工 |
| `user` | 0 | 普通用户（默认角色） |
| `system_job` | -1 | 系统作业（后台定时任务专用） |

#### 3️⃣ 关键系统配置（严格模式，缺失会报错）

**字段说明**：
- `setting_key`：配置项唯一标识（代码中通过此key读取配置值）
- `setting_value`：配置值（字符串格式存储，代码中会转换类型）

| setting_key | setting_value | 说明 |
|-------------|---------------|------|
| `lottery_cost_points` | `100` | 抽奖一次消耗100积分 |
| `budget_allocation_ratio` | `0.22` | 用户消费金额的22%转为预算积分 |
| `daily_lottery_limit` | `10` | 每个用户每天最多抽10次 |

#### 4️⃣ 资产类型定义（4条）

**字段说明**：
- `asset_code`：资产唯一标识（代码中引用此值）
- `display_name`：前端显示的中文名称
- `is_tradable`：是否可在市场交易（`true`=可交易，`false`=不可交易）

| asset_code | display_name | is_tradable | 说明 |
|------------|--------------|-------------|------|
| `POINTS` | 普通积分 | `false` | 消费获得，用于抽奖，不可交易 |
| `BUDGET_POINTS` | 预算积分 | `false` | 预算池积分，不可交易 |
| `DIAMOND` | 钻石 | `true` | 抽奖获得，可在市场挂单交易 |
| `red_shard` | 红色碎片 | `true` | 抽奖获得，可交易，可合成 |

#### 5️⃣ 功能开关（7条，控制抽奖策略）

**字段说明**：
- `flag_key`：功能开关唯一标识
- `is_enabled`：是否启用（`true`=启用，`false`=禁用）

| flag_key | is_enabled | 说明 |
|----------|------------|------|
| `lottery_pity_system` | `true` | **Pity保底**：连续N次不中奖后提高概率 |
| `lottery_luck_debt` | `true` | **运气债务**：中大奖后降低后续概率 |
| `lottery_anti_streak` | `true` | **防连击**：防止连续中同类型奖品 |
| `lottery_bxpx_matrix` | `true` | **BxPx矩阵**：按用户消费/抽奖次数分层控制概率 |
| `lottery_dynamic_probability` | `true` | **动态概率**：根据奖池剩余自动调整 |
| `lottery_budget_filter` | `true` | **预算过滤**：按用户预算余额过滤奖品 |
| `lottery_quota_system` | `true` | **配额系统**：限制高价值奖品发放数量 |

#### 6️⃣ 活动与奖品（至少1套）

**活动配置字段说明**：
- `campaign_code`：活动唯一标识（代码中引用此值）
- `campaign_name`：活动显示名称
- `budget_mode`：预算模式
  - `none`：无预算限制（纯概率抽奖）
  - `user`：用户预算模式（消耗用户个人预算积分）
  - `pool`：池预算模式（消耗活动公共预算池）
- `draw_cost`：单次抽奖消耗的积分数
- `status`：活动状态（`active`=进行中，`inactive`=已停止）

**活动配置**：
| 字段 | 值 | 说明 |
|------|---|------|
| campaign_code | `____________` | 如：`main_lottery` |
| campaign_name | `____________` | 如：`主抽奖活动` |
| budget_mode | `none` / `user` / `pool` | 选择一种预算模式 |
| draw_cost | `100` | 单抽消耗100积分 |
| status | `active` | 设为进行中 |

**奖品池字段说明**：
- `prize_type`：奖品类型
  - `empty`：空奖（谢谢参与）
  - `asset`：资产奖品（发放钻石、碎片等）
  - `item`：物品奖品（发放道具物品）
- `budget_cost`：该奖品消耗的预算点数（0表示不消耗预算）
- `probability`：基础中奖概率（0-1之间，所有奖品概率之和应=1）

**奖品池**（至少5个）：
| 奖品名称 | prize_type | budget_cost | probability | 说明 |
|----------|------------|-------------|-------------|------|
| 谢谢参与 | `empty` | 0 | 0.70 | 70%概率空奖 |
| 钻石×10 | `asset` | 10 | 0.15 | 15%概率，消耗10预算 |
| 钻石×50 | `asset` | 50 | 0.08 | 8%概率，消耗50预算 |
| 钻石×100 | `asset` | 100 | 0.05 | 5%概率，消耗100预算 |
| 钻石×500 | `asset` | 500 | 0.02 | 2%概率，消耗500预算 |

#### 7️⃣ 系统账户（迁移脚本自动创建，或手动插入）

**说明**：系统账户是资产流转的"对手方"，用于记账和审计。例如用户抽奖获得钻石，流水记录为"从 SYSTEM_MINT 转入用户账户"。

| system_code | 说明 | 用途场景 |
|-------------|------|----------|
| `SYSTEM_PLATFORM_FEE` | 平台手续费账户 | 市场交易抽取手续费时记入 |
| `SYSTEM_MINT` | 系统发放账户 | 抽奖发放奖品、活动赠送资产时作为来源 |
| `SYSTEM_BURN` | 系统销毁账户 | 资产销毁、过期回收时作为去向 |
| `SYSTEM_ESCROW` | 托管账户 | 市场挂单冻结资产时暂存 |
| `SYSTEM_RESERVE` | 储备金账户 | 系统预留资产池 |
| `SYSTEM_CAMPAIGN_POOL` | 活动池预算账户 | 活动预算池模式下的预算来源 |

---

## 📋 使用场景

本文档适用于以下任何需要"恢复干净测试环境"的场景：

1. **架构重构前**：如实施预算积分体系、资产体系升级等
2. **脏数据清理**：测试过程中产生大量脏数据，影响后续测试
3. **功能验证准备**：需要干净的初始状态验证新功能
4. **环境重置**：定期恢复测试环境到已知状态
5. **性能测试准备**：清理历史数据，从已知基线开始测试

---

## 🔴 方案B必需信息速查（激进清理）

> 如果选择方案B（激进清理），执行前必须准备以下信息，否则系统无法正常运行。

### 1️⃣ 管理员账号（必需）

> 项目使用**手机号+验证码**登录。开发环境验证码固定为 `123456`。

| 字段 | 你的输入 | 是否必填 | 默认值 |
|------|----------|----------|--------|
| 手机号 | `____________` | ✅ 必填 | - |
| 昵称 | `____________` | ⚪ 可选 | `用户` + 手机号后4位 |
| 角色 | `____________` | ✅ 必填 | 普通用户需手动授权为 `admin` |

### 2️⃣ 关键配置参数（必需）

| 配置项 | 你的输入 | 推荐值 | 说明 |
|--------|----------|--------|------|
| `lottery_cost_points` | `____________` | `100` | 单抽消耗积分 |
| `budget_allocation_ratio` | `____________` | `0.22` | 消费返预算比例(22%) |
| `daily_lottery_limit` | `____________` | `10` | 每日抽奖上限 |

### 3️⃣ 活动配置（必需）

| 字段 | 你的输入 | 示例 |
|------|----------|------|
| 活动代码 | `____________` | `BASIC_LOTTERY` |
| 活动名称 | `____________` | `基础抽奖活动` |
| 预算模式 | `____________` | `none` / `user` / `pool` |
| 单抽消耗 | `____________` | `100` |

### 4️⃣ 奖品池配置（必需，至少5个）

| 奖品名称 | 类型 | 预算成本 | 库存 | 概率 |
|----------|------|----------|------|------|
| `____________` | `empty` | `0` | `999999` | `0.70` |
| `____________` | `asset` | `10` | `1000` | `0.15` |
| `____________` | `asset` | `50` | `500` | `0.08` |
| `____________` | `asset` | `100` | `200` | `0.05` |
| `____________` | `asset` | `500` | `50` | `0.02` |

### 5️⃣ 资产类型（必需）

| asset_code | 显示名称 | 是否必需 |
|------------|----------|----------|
| `POINTS` | 普通积分 | ✅ 必需 |
| `BUDGET_POINTS` | 预算积分 | ✅ 必需 |
| `DIAMOND` | 钻石 | ⚠️ 有交易市场则必需 |

### 6️⃣ 系统账户（自动重建）

执行以下命令重建系统账户：
```bash
npx sequelize-cli db:migrate --name 20251215160000-create-accounts-table.js
```

---

## 🎯 方案选择

### 方案 A：保守清理（日常推荐）

**保留**：配置数据、管理员账号、活动配置、用户基础信息、系统账户、策略配置、功能开关、字典数据  
**清理**：用户资产余额/流水、抽奖记录、消费记录、交易记录、监控指标、操作日志、**运营内容**（公告/Banner）、**用户关系数据**（层级/员工）

**适合场景**：

- 日常测试后恢复干净环境
- 验证新功能但不想重新配置系统
- 保留测试账号和系统配置

**执行时间**：5-10 分钟  
**恢复时间**：无需恢复（配置和账号都保留）

---

### 方案 B：激进清理（深度重置）

**保留**：仅保留数据库结构（72 张表的 schema）和行政区划字典  
**清理**：所有业务数据（包括配置、管理员、用户、活动）

**适合场景**：

- 完全从零开始
- 系统配置本身有问题需要重建
- 模拟"新系统首次启动"

**执行时间**：10-15 分钟  
**恢复时间**：2-4 小时（需要重建所有配置、用户、活动）

---

## 📊 数据库表分类概览（72张表）

### 🏗️ 表分类速查

#### 一、账户与资产体系（6张）
| 表名 | 说明 | 方案A | 方案B |
|------|------|-------|-------|
| `users` | 用户基础信息 | 保留 | 清空 |
| `accounts` | 账户主体（用户+系统） | 保留系统账户 | 清空 |
| `account_asset_balances` | 资产余额 | 清空 | 清空 |
| `asset_transactions` | 资产流水 | 清空 | 清空 |
| `user_premium_status` | 高级空间状态 | 清空 | 清空 |
| `user_risk_profiles` | 风控配置 | 保留 | 清空 |

#### 二、角色权限体系（4张）
| 表名 | 说明 | 方案A | 方案B |
|------|------|-------|-------|
| `roles` | 角色定义 | 保留 | 清空 |
| `user_roles` | 用户角色关系 | 保留 | 清空 |
| `user_role_change_records` | 角色变更记录 | 清空 | 清空 |
| `user_status_change_records` | 状态变更记录 | 清空 | 清空 |

#### 三、抽奖核心系统（8张）
| 表名 | 说明 | 方案A | 方案B |
|------|------|-------|-------|
| `lottery_campaigns` | 活动配置 | 保留 | 清空 |
| `lottery_prizes` | 奖品池定义 | 保留 | 清空 |
| `lottery_draws` | 抽奖记录 | 清空 | 清空 |
| `lottery_draw_decisions` | 抽奖决策快照 | 清空 | 清空 |
| `lottery_presets` | 预设配置 | **清空** | 清空 |
| `lottery_management_settings` | 管理员干预规则 | 清空 | 清空 |
| `lottery_clear_setting_records` | 清除设置记录 | 清空 | 清空 |
| `lottery_campaign_pricing_config` | 活动定价配置 | 保留 | 清空 |

#### 四、抽奖策略引擎（10张）
| 表名 | 说明 | 方案A | 方案B |
|------|------|-------|-------|
| `lottery_tier_rules` | 档位概率规则 | 保留 | 清空 |
| `lottery_strategy_config` | 策略全局配置 | 保留 | 清空 |
| `lottery_tier_matrix_config` | BxPx矩阵配置 | 保留 | 清空 |
| `lottery_draw_quota_rules` | 配额规则 | 保留 | 清空 |
| `lottery_user_daily_draw_quota` | 每日抽奖配额 | 清空 | 清空 |
| `lottery_campaign_user_quota` | 活动用户配额 | 清空 | 清空 |
| `lottery_campaign_quota_grants` | 配额赠送记录 | 清空 | 清空 |
| `lottery_user_experience_state` | 用户体验状态(Pity) | 清空 | 清空 |
| `lottery_user_global_state` | 全局统计(LuckDebt) | 清空 | 清空 |
| `feature_flags` | 功能开关 | 保留 | 清空 |

#### 五、抽奖监控告警（4张）
| 表名 | 说明 | 方案A | 方案B |
|------|------|-------|-------|
| `lottery_hourly_metrics` | 小时级监控指标 | 清空 | 清空 |
| `lottery_daily_metrics` | 日报统计 | 清空 | 清空 |
| `lottery_alerts` | 抽奖系统告警 | 清空 | 清空 |
| `preset_debt_limits` | 欠账上限配置 | 保留 | 清空 |

#### 六、系统垫付（欠账）（2张）
| 表名 | 说明 | 方案A | 方案B |
|------|------|-------|-------|
| `preset_inventory_debt` | 库存欠账 | 清空 | 清空 |
| `preset_budget_debt` | 预算欠账 | 清空 | 清空 |

#### 七、物品与背包系统（6张）
| 表名 | 说明 | 方案A | 方案B |
|------|------|-------|-------|
| `item_templates` | 物品模板定义 | 保留 | 清空 |
| `item_instances` | 物品实例 | 清空 | 清空 |
| `item_instance_events` | 物品事件溯源 | 清空 | 清空 |
| `category_defs` | 类目字典 | 保留 | 清空 |
| `rarity_defs` | 稀有度字典 | 保留 | 清空 |
| `asset_group_defs` | 资产组字典 | 保留 | 清空 |

#### 八、交易市场系统（3张）
| 表名 | 说明 | 方案A | 方案B |
|------|------|-------|-------|
| `market_listings` | 市场挂牌 | 清空 | 清空 |
| `trade_orders` | 交易订单 | 清空 | 清空 |
| `redemption_orders` | 核销订单 | 清空 | 清空 |

#### 九、兑换与消费系统（4张）
| 表名 | 说明 | 方案A | 方案B |
|------|------|-------|-------|
| `exchange_items` | 兑换商品配置 | 保留 | 清空 |
| `exchange_records` | 兑换记录 | 清空 | 清空 |
| `consumption_records` | 消费记录 | 清空 | 清空 |
| `content_review_records` | 内容审核记录 | 清空 | 清空 |

#### 十、商户与门店系统（5张）
| 表名 | 说明 | 方案A | 方案B |
|------|------|-------|-------|
| `stores` | 门店配置 | 保留 | 清空 |
| `store_staff` | 门店员工关系 | **清空** | 清空 |
| `products` | 商品配置 | 保留 | 清空 |
| `user_hierarchy` | 用户层级关系 | **清空** | 清空 |
| `administrative_regions` | 行政区划字典 | 保留 | **保留** |

#### 十一、材料资产系统（2张）
| 表名 | 说明 | 方案A | 方案B |
|------|------|-------|-------|
| `material_asset_types` | 资产类型定义 | 保留 | 清空 |
| `material_conversion_rules` | 资产转换规则 | 保留 | 清空 |

#### 十二、系统配置（5张）
| 表名 | 说明 | 方案A | 方案B |
|------|------|-------|-------|
| `system_settings` | 系统设置 | 保留 | 清空 |
| `system_configs` | 系统配置 | 保留 | 清空 |
| `system_dictionaries` | 系统字典 | 保留 | 清空 |
| `system_dictionary_history` | 字典变更历史 | 清空 | 清空 |
| `system_announcements` | 系统公告 | **清空** | 清空 |

#### 十三、客服聊天系统（2张）
| 表名 | 说明 | 方案A | 方案B |
|------|------|-------|-------|
| `customer_service_sessions` | 客服会话 | 清空 | 清空 |
| `chat_messages` | 聊天消息 | 清空 | 清空 |

#### 十四、审计与日志系统（7张）
| 表名 | 说明 | 方案A | 方案B |
|------|------|-------|-------|
| `admin_operation_logs` | 管理员操作日志 | 清空 | 清空 |
| `merchant_operation_logs` | 商户操作日志 | 清空 | 清空 |
| `batch_operation_logs` | 批量操作日志 | 清空 | 清空 |
| `risk_alerts` | 风控告警 | 清空 | 清空 |
| `api_idempotency_requests` | 幂等请求记录 | 清空 | 清空 |
| `authentication_sessions` | 认证会话 | 清空 | 清空 |
| `websocket_startup_logs` | WebSocket启动日志 | 清空 | 清空 |

#### 十五、其他（4张）
| 表名 | 说明 | 方案A | 方案B |
|------|------|-------|-------|
| `feedbacks` | 用户反馈 | 清空 | 清空 |
| `popup_banners` | 弹窗Banner | **清空** | 清空 |
| `image_resources` | 图片资源 | **清空** | 清空 |
| `sequelizemeta` | 迁移记录 | **保留** | **保留** |

---

## 📊 方案 A：保守清理（详细清单）

### ✅ 会保留的数据（约29张表）

#### 1. 账号与权限体系（保留）

| 表名 | 说明 | 清理规则 |
|------|------|----------|
| `users` | 用户基础信息 | 全部保留 |
| `roles` | 角色定义（11个角色） | 全部保留 |
| `user_roles` | 用户角色关系 | 全部保留 |
| `accounts` | 账户主体 | **仅保留系统账户**（删除用户账户） |

**系统账户清单（6个，必须保留）**：

| system_code | 说明 | 用途 |
|-------------|------|------|
| `SYSTEM_PLATFORM_FEE` | 平台手续费账户 | 交易手续费入账 |
| `SYSTEM_MINT` | 系统发放账户 | 积分发放源头 |
| `SYSTEM_BURN` | 系统销毁账户 | 积分销毁目标 |
| `SYSTEM_ESCROW` | 托管账户 | 交易托管/争议 |
| `SYSTEM_RESERVE` | 储备金账户 | 系统储备 |
| `SYSTEM_CAMPAIGN_POOL` | 活动池预算账户 | pool预算模式 |

**为什么保留系统账户**：

- `AssetService.getOrCreateAccount({system_code})` **不会自动创建**系统账户，缺失会直接报错：`系统账户不存在：system_code=xxx，请检查数据库初始化`
- 系统账户是迁移时通过 `20251215160000-create-accounts-table.js` 初始化的，清空后需要重跑迁移才能恢复

---

#### 2. 系统配置（保留）

| 表名 | 说明 | 清理规则 |
|------|------|----------|
| `system_settings` | 核心配置参数 | 全部保留 |
| `system_configs` | 系统配置 | 全部保留 |
| `system_dictionaries` | 系统字典（中文映射） | 全部保留 |

> ⚠️ `system_announcements`（系统公告）已移至清空列表，因为它是运营内容数据而非系统配置。

**关键配置项**（清理后必须仍存在）：

| 配置项 | 当前值 | 说明 | 是否严格模式 |
|--------|--------|------|--------------|
| `lottery_cost_points` | 100 | 单抽积分消耗 | ✅ 严格模式 |
| `budget_allocation_ratio` | 0.22 | 消费返预算比例(22%) | ✅ 严格模式 |
| `daily_lottery_limit` | 10 | 每日抽奖次数上限 | ⚠️ 建议 |

**验证命令**：

```bash
node -e "
require('dotenv').config();
const { sequelize } = require('./config/database');
(async () => {
  const [rows] = await sequelize.query(
    \"SELECT setting_key, setting_value FROM system_settings WHERE setting_key IN ('lottery_cost_points', 'budget_allocation_ratio', 'daily_lottery_limit')\"
  );
  console.table(rows);
  await sequelize.close();
})();
"
```

---

#### 3. 活动与奖品定义（保留）

| 表名 | 说明 | 清理规则 |
|------|------|----------|
| `lottery_campaigns` | 活动配置 | 全部保留 |
| `lottery_prizes` | 奖品池定义 | 全部保留 |
| `lottery_campaign_pricing_config` | 定价配置 | 全部保留 |

> ⚠️ `lottery_presets`（预设配置）已移至清空列表，因为它是针对特定用户的业务数据而非系统配置。

**清理后状态**：

- 活动配置保留，但相关的抽奖记录会被清空
- 奖品定义保留，但用户获得的物品实例会被清空

---

#### 4. 抽奖策略配置（保留）

| 表名 | 说明 | 清理规则 |
|------|------|----------|
| `lottery_tier_rules` | 档位概率规则 | 全部保留 |
| `lottery_strategy_config` | 策略全局配置 | 全部保留 |
| `lottery_tier_matrix_config` | BxPx矩阵配置 | 全部保留 |
| `lottery_draw_quota_rules` | 配额规则 | 全部保留 |
| `feature_flags` | 功能开关 | 全部保留 |
| `preset_debt_limits` | 欠账上限配置 | 全部保留 |

**关于抽奖策略引擎**：

系统引入了复杂的策略引擎，清理后策略**状态**会重置，但**配置**保留：
- **Pity保底机制** - `lottery_user_experience_state.empty_streak` 会清零
- **运气债务机制** - `lottery_user_global_state.luck_debt_multiplier` 会清零
- **功能开关** - `feature_flags` 控制策略启用（7个开关全部保留）

---

#### 5. 字典与模板定义（保留）

| 表名 | 说明 |
|------|------|
| `item_templates` | 物品模板定义 |
| `category_defs` | 类目字典 |
| `rarity_defs` | 稀有度字典 |
| `asset_group_defs` | 资产组字典 |
| `material_asset_types` | 资产类型定义 |
| `material_conversion_rules` | 资产转换规则 |

**资产类型清单（4种）**：

| asset_code | display_name | 说明 |
|------------|--------------|------|
| `POINTS` | 普通积分 | 抽奖门票 |
| `BUDGET_POINTS` | 预算积分 | 预算约束抽奖 |
| `DIAMOND` | 钻石 | 交易市场货币 |
| `red_shard` | 红色碎片 | 材料资产 |

---

#### 6. 商户与门店（保留）

| 表名 | 说明 |
|------|------|
| `stores` | 门店配置 |
| `products` | 商品配置 |
| `exchange_items` | 兑换商品配置 |
| `administrative_regions` | 行政区划字典（只读） |
| `user_risk_profiles` | 用户风控配置（级别配置，非用户个人配置） |

> ⚠️ `store_staff`（门店员工关系）和 `user_hierarchy`（用户层级关系）已移至清空列表，因为它们有外键依赖用户表。

---

### 🗑️ 会清空的数据（约43张表）

#### 1. 资产账本（核心清理）

| 表名 | 说明 | 影响 |
|------|------|------|
| `accounts` | 账户主体 | **仅删除用户账户**，保留系统账户 |
| `account_asset_balances` | 资产余额 | 所有余额清零 |
| `asset_transactions` | 资产流水 | 所有流水清空 |
| `user_premium_status` | 高级空间状态 | 清空 |

**清理后影响**：

- 所有用户的 POINTS/DIAMOND/BUDGET_POINTS 余额归零
- 用户的 `account_id` 会丢失（但 `user_id` 保留）
- 系统账户的 `account_id` 保留，但余额需要确认

---

#### 2. 抽奖记录与状态

| 表名 | 说明 |
|------|------|
| `lottery_draws` | 抽奖记录 |
| `lottery_draw_decisions` | 抽奖决策快照 |
| `lottery_management_settings` | 管理员干预规则 |
| `lottery_clear_setting_records` | 清除设置记录 |
| `lottery_user_daily_draw_quota` | 每日抽奖配额 |
| `lottery_campaign_user_quota` | 活动用户配额 |
| `lottery_campaign_quota_grants` | 配额赠送记录 |
| `lottery_user_experience_state` | 用户体验状态 |
| `lottery_user_global_state` | 全局统计 |

---

#### 3. 监控指标与告警

| 表名 | 说明 |
|------|------|
| `lottery_hourly_metrics` | 小时级监控指标 |
| `lottery_daily_metrics` | 日报统计 |
| `lottery_alerts` | 抽奖系统告警 |
| `preset_inventory_debt` | 库存欠账 |
| `preset_budget_debt` | 预算欠账 |

---

#### 4. 物品与交易

| 表名 | 说明 |
|------|------|
| `item_instances` | 物品实例 |
| `item_instance_events` | 物品事件溯源 |
| `market_listings` | 市场挂牌 |
| `trade_orders` | 交易订单 |
| `redemption_orders` | 核销订单 |
| `exchange_records` | 兑换记录 |

---

#### 5. 消费与审核

| 表名 | 说明 |
|------|------|
| `consumption_records` | 消费记录 |
| `content_review_records` | 内容审核记录 |

---

#### 6. 客服聊天

| 表名 | 说明 |
|------|------|
| `chat_messages` | 聊天消息 |
| `customer_service_sessions` | 客服会话 |

---

#### 7. 审计与日志

| 表名 | 说明 |
|------|------|
| `admin_operation_logs` | 管理员操作日志 |
| `merchant_operation_logs` | 商户操作日志 |
| `batch_operation_logs` | 批量操作日志 |
| `risk_alerts` | 风控告警 |
| `api_idempotency_requests` | 幂等请求记录 |
| `authentication_sessions` | 认证会话 |
| `websocket_startup_logs` | WebSocket启动日志 |
| `user_role_change_records` | 角色变更记录 |
| `user_status_change_records` | 状态变更记录 |
| `system_dictionary_history` | 字典变更历史 |

---

#### 8. 运营内容与反馈

| 表名 | 说明 |
|------|------|
| `feedbacks` | 用户反馈 |
| `system_announcements` | 系统公告（运营内容，非配置） |
| `popup_banners` | 弹窗Banner（运营内容，非配置） |
| `image_resources` | 图片资源（用户上传内容） |

---

#### 9. 用户关系与预设数据

| 表名 | 说明 |
|------|------|
| `store_staff` | 门店员工关系（外键依赖users） |
| `user_hierarchy` | 用户层级关系（外键依赖users） |
| `lottery_presets` | 预设配置（针对特定用户的业务数据） |

---

### ⚠️ 方案 A 清理后需要你提供的数据

#### 🎯 必需提供（否则无法验证）

1. **测试用户信息**：
   - 提供 1-2 个用户的 `user_id` 或 `mobile`（从保留的用户中选）
   - 推荐：`user_id=31`（管理员用户）或 `user_id=32`（测试用户）
   - 用途：用于验证"消费→审批→发放→抽奖"完整流程

2. **确认系统账户存在**：
   ```bash
   node -e "
   require('dotenv').config();
   const { sequelize } = require('./config/database');
   (async () => {
     const [rows] = await sequelize.query(\"SELECT system_code FROM accounts WHERE account_type='system'\");
     console.log('系统账户:', rows.map(r => r.system_code));
     await sequelize.close();
   })();
   "
   ```
   - 预期结果：至少包含 6 个系统账户

3. **确认关键配置存在**：
   - 执行上方验证命令
   - 预期结果：`lottery_cost_points=100`、`budget_allocation_ratio=0.22`

---

#### 🔧 可选提供（快速恢复测试环境）

1. **初始资产充值金额**：
   - 给测试用户充值多少 POINTS？（建议 1000-5000）
   - 给测试用户充值多少 DIAMOND？（建议 500-2000）

2. **活动预算模式确认**：
   - 当前活动（campaign_id=1）预算模式为 `none`
   - 如需测试预算模式，可选：`user`/`pool`/`none`

---

### 🔍 方案 A 清理后验证清单

#### 必需检查项（清理立即后）

- [ ] 数据库连接正常
- [ ] 表结构完整（72 张表）
- [ ] 系统账户存在（6 个：PLATFORM_FEE/MINT/BURN/ESCROW/RESERVE/CAMPAIGN_POOL）
- [ ] 用户账号存在
- [ ] 管理员权限正常（user_roles 保留）
- [ ] 系统配置存在（system_settings 保留）
- [ ] 活动奖品配置存在
- [ ] 功能开关配置存在（feature_flags 7个）
- [ ] 策略配置存在（lottery_strategy_config、lottery_tier_matrix_config）

#### 资产域验证（可选）

- [ ] 用户账户已重建（`accounts` 表 `account_type='user'` 的记录）
- [ ] 用户资产余额已初始化
- [ ] 资产流水与余额一致

#### 功能验证（可选）

- [ ] 用户可登录（需重新登录，因 authentication_sessions 被清空）
- [ ] 消费审批可发放积分
- [ ] 抽奖功能可正常使用

---

## 📊 方案 B：激进清理（详细清单）

### ✅ 会保留的数据（仅表结构+字典）

| 保留内容 | 说明 |
|----------|------|
| 数据库结构 | 72 张表的 schema 保留 |
| 迁移记录 | `sequelizemeta` 表保留（记录已执行的迁移） |
| 行政区划 | `administrative_regions` 表保留（44703条，只读字典） |

**其余所有业务数据表的数据全部清空**。

---

### 🗑️ 会清空的数据（约69张表）

在方案 A 的约43张表基础上，额外清空以下约26张表：

| 表名 | 说明 | 影响 |
|------|------|------|
| `users` | 用户基础信息 | 所有用户需重新注册 |
| `user_roles` | 用户角色关系 | 管理员需重新授权 |
| `roles` | 角色定义 | 角色需重新创建 |
| `accounts`（全部） | 账户主体 | 系统账户也清空，需重跑迁移 |
| `system_settings` | 系统配置参数 | 关键配置需重新写入 |
| `system_configs` | 系统配置 | 需重新配置 |
| `system_dictionaries` | 系统字典 | 中文映射丢失 |
| `lottery_campaigns` | 活动配置 | 需重新创建活动 |
| `lottery_prizes` | 奖品池定义 | 需重新配置奖品 |
| `lottery_presets` | 预设配置 | 需重新配置 |
| `lottery_campaign_pricing_config` | 定价配置 | 需重新配置 |
| `lottery_tier_rules` | 档位概率规则 | 需重新配置 |
| `lottery_strategy_config` | 策略全局配置 | 需重新配置 |
| `lottery_tier_matrix_config` | BxPx矩阵配置 | 需重新配置 |
| `lottery_draw_quota_rules` | 配额规则 | 需重新配置 |
| `feature_flags` | 功能开关 | 需重新配置 |
| `preset_debt_limits` | 欠账上限配置 | 需重新配置 |
| `item_templates` | 物品模板定义 | 需重新配置 |
| `category_defs` | 类目字典 | 需重新初始化 |
| `rarity_defs` | 稀有度字典 | 需重新初始化 |
| `asset_group_defs` | 资产组字典 | 需重新初始化 |
| `material_asset_types` | 资产类型定义 | 需重新配置 |
| `material_conversion_rules` | 资产转换规则 | 需重新配置 |
| `stores` | 门店配置 | 需重新配置 |
| `store_staff` | 门店员工关系 | 需重新配置 |
| `products` | 商品配置 | 需重新配置 |
| `exchange_items` | 兑换商品配置 | 需重新配置 |
| `user_hierarchy` | 用户层级关系 | 需重新配置 |
| `user_risk_profiles` | 用户风控配置 | 需重新配置 |
| `popup_banners` | 弹窗Banner | 需重新配置 |
| `image_resources` | 图片资源 | 需重新上传 |
| `system_announcements` | 系统公告 | 需重新发布 |

---

### ⚠️ 方案 B 清理后需要你提供的数据（完整重建包）

#### 🔴 必需提供（否则系统无法启动）

##### 1. 管理员账号信息（至少 1 个）

> 项目使用**手机号+验证码**登录。开发环境验证码固定为 `123456`。

| 字段 | 说明 | 是否必填 | 默认值 |
|------|------|----------|--------|
| mobile | 管理员手机号 | ✅ 必填 | - |
| nickname | 显示名称 | ⚪ 可选 | `用户` + 手机号后4位 |
| role | 管理员角色 | ✅ 必填 | 新用户默认 `user`，需手动授权 `admin` |

**重建步骤**：
1. 用管理员手机号登录（自动注册）
2. 通过数据库或迁移脚本将该用户授权为 `admin` 角色

---

##### 2. 系统配置参数（关键配置项）

| 配置项 | 推荐值 | 值类型 | 说明 | 是否严格 |
|--------|--------|--------|------|----------|
| `lottery_cost_points` | `100` | number | 单抽积分消耗 | ✅ 严格模式 |
| `budget_allocation_ratio` | `0.22` | number | 消费返预算比例(22%) | ✅ 严格模式 |
| `daily_lottery_limit` | `10` | number | 每日抽奖次数上限 | ⚠️ 建议 |

---

##### 3. 活动与奖品定义（至少 1 套）

**活动定义**（`lottery_campaigns` 表）：

| 字段 | 格式 | 示例 |
|------|------|------|
| campaign_code | 字符串（唯一） | `BASIC_LOTTERY` |
| campaign_name | 字符串 | `基础抽奖活动` |
| start_time | 日期时间 | `2025-01-01 00:00:00` |
| end_time | 日期时间 | `2025-12-31 23:59:59` |
| status | 枚举 | `active` |
| budget_mode | 枚举 | `'user'`/`'pool'`/`'none'` |
| draw_cost | 数字 | `100` |

**奖品定义**（`lottery_prizes` 表，至少 5-10 个）：

| 奖品名称 | 奖品类型 | 预算成本 | 库存 | 概率 |
|----------|----------|----------|------|------|
| 空奖 | `empty` | `0` | `999999` | `0.70` |
| 钻石×10 | `asset` | `10` | `1000` | `0.15` |
| 钻石×50 | `asset` | `50` | `500` | `0.08` |
| 钻石×100 | `asset` | `100` | `200` | `0.05` |
| 钻石×500 | `asset` | `500` | `50` | `0.015` |
| 钻石×1000 | `asset` | `1000` | `10` | `0.005` |

---

##### 4. 资产类型定义（必需）

| asset_code | display_name | 用途 | 是否必需 |
|------------|--------------|------|----------|
| `POINTS` | 普通积分 | 抽奖门票、消费返还 | ✅ 必需 |
| `BUDGET_POINTS` | 预算积分 | 预算约束抽奖 | ✅ 必需 |
| `DIAMOND` | 钻石 | 交易市场货币 | ⚠️ 如有交易市场功能必需 |

---

##### 5. 系统账户（清理后必须重建）

清理后需要重跑迁移重建系统账户：

```bash
npx sequelize-cli db:migrate --name 20251215160000-create-accounts-table.js
```

或手动插入 6 个系统账户。

---

##### 6. 角色定义（必需）

| role_name | description | role_level |
|-----------|-------------|------------|
| `admin` | 管理员 | 100 |
| `regional_manager` | 区域经理 | 80 |
| `business_manager` | 业务经理 | 60 |
| `sales_staff` | 业务员 | 40 |
| `merchant_manager` | 商户管理 | 40 |
| `ops` | 运营 | 30 |
| `merchant_staff` | 商户员工 | 20 |
| `user` | 普通用户 | 0 |
| `system_job` | 系统作业 | -1 |

---

### 🔍 方案 B 清理后验证清单

#### 必需检查项（提供数据并重建后）

- [ ] 数据库连接正常
- [ ] 表结构完整（72 张表）
- [ ] **系统账户已重建**（6 个）
- [ ] **管理员账号已创建**（至少 1 个）
- [ ] **系统配置已写入**（至少 2 项关键配置）
- [ ] **活动奖品已配置**（至少 1 个活动 + 奖品池）
- [ ] **资产类型已定义**（至少 POINTS/BUDGET_POINTS）
- [ ] **角色定义已创建**
- [ ] **功能开关已配置**（7个抽奖策略开关）

#### 功能验证（必需）

- [ ] 管理员可登录管理后台
- [ ] 用户可注册新账号
- [ ] 消费审批可发放积分
- [ ] 抽奖功能可正常使用
- [ ] 交易市场可正常使用（如果有此功能）

---

## 📋 方案 A vs 方案 B 对比清单

| 维度 | 方案 A（保守） | 方案 B（激进） |
|------|----------------|----------------|
| **清理表数** | 约43张（只清业务数据） | 约69张（清配置+业务） |
| **保留用户账号** | ✅ 是 | ❌ 否 |
| **保留管理员** | ✅ 是 | ❌ 否 |
| **保留系统账户** | ✅ 是（6 个） | ❌ 否 |
| **保留系统配置** | ✅ 是 | ❌ 否 |
| **保留活动配置** | ✅ 是 | ❌ 否 |
| **保留策略配置** | ✅ 是 | ❌ 否 |
| **保留功能开关** | ✅ 是（7个） | ❌ 否 |
| **清理用户资产** | ✅ 是 | ✅ 是 |
| **清理抽奖记录** | ✅ 是 | ✅ 是 |
| **清理操作日志** | ✅ 是 | ✅ 是 |
| **执行后可登录** | ✅ 是（需重新登录） | ❌ 否（需重建管理员） |
| **执行后可抽奖** | ✅ 是（需充值资产） | ❌ 否（需重建活动） |
| **恢复成本** | 无（配置都保留） | 极高（2-4 小时） |

---

## 🛠️ 项目已有的清理脚本

### 历史数据清理脚本

项目中已存在 `scripts/database/cleanup_historical_data.js`，功能如下：

- **用途**：按时间分界线清理历史数据
- **支持预览模式**：`DRY_RUN=true` 查看影响但不实际删除
- **按外键依赖顺序删除**：避免外键约束报错

**使用方式**：

```bash
# 预览模式（查看影响）
DRY_RUN=true node scripts/database/cleanup_historical_data.js

# 实际执行
node scripts/database/cleanup_historical_data.js
```

**涉及表**：
- `item_instance_events`
- `redemption_orders`
- `market_listings`
- `trade_orders`
- `item_instances`
- `exchange_records`
- `content_review_records`
- `consumption_records`
- `lottery_draws`

---

## 🚨 风险提示

### 方案 A 的风险

| 风险类型 | 影响 | 说明 |
|----------|------|------|
| 资产数据丢失 | ⚠️ 中等 | 所有用户的资产余额和流水清零 |
| 历史记录丢失 | ⚠️ 中等 | 抽奖/消费/交易/聊天的历史记录丢失 |
| 策略状态重置 | ⚠️ 低 | Pity计数器、LuckDebt乘数重置 |
| 账户关联重建 | ⚠️ 低 | 用户的 `account_id` 会变化 |
| 会话失效 | ⚠️ 低 | 用户需要重新登录 |
| 系统账户丢失 | ❌ 无 | **系统账户保留**，不受影响 |

**适合人群**：能接受"用户历史清零"但想保留"系统配置和账号"。

---

### 方案 B 的额外风险

| 风险类型 | 影响 | 说明 |
|----------|------|------|
| 无法登录管理后台 | 🔴 高 | 管理员账号被清空，必须重建 |
| 系统配置丢失 | 🔴 高 | 所有配置参数丢失，必须重新写入 |
| 活动奖品丢失 | 🔴 高 | 所有活动和奖品定义丢失，必须重新创建 |
| 策略配置丢失 | 🔴 高 | 抽奖策略配置丢失，必须重新配置 |
| 功能开关丢失 | 🔴 高 | 7个功能开关丢失，必须重新配置 |
| 系统账户丢失 | 🔴 高 | 系统账户被清空，必须重跑迁移 |
| 恢复成本 | 🔴 极高 | 需要 2-4 小时重建整个系统 |

**适合人群**：能接受"完全重建系统"的代价，且有完整的数据重建包。

---

## 📝 执行清理的方式（Node.js only）

### 执行约束

1. **不使用 mysql 客户端**：所有操作通过 Node.js 执行
2. **连接真实 `.env` 库**：使用 `require('dotenv').config()` + `require('./config/database').sequelize`
3. **执行前核对**：先运行数据库连接测试确认连接的是测试库

### 执行原则（不含代码实现）

**方案 A 执行步骤**：

1. 连接 `.env` 指向的真实数据库
2. 执行 `SET FOREIGN_KEY_CHECKS = 0;`
3. 对约43张业务表执行 `TRUNCATE TABLE`（但 `accounts` 只删 `account_type='user'` 的记录）
4. 执行 `SET FOREIGN_KEY_CHECKS = 1;`
5. 验证系统账户仍存在（6 个）
6. 验证系统配置仍存在（关键配置）

**方案 B 执行步骤**：

1. 连接 `.env` 指向的真实数据库
2. 删除测试垃圾表：`DROP TABLE IF EXISTS deadlock_test_1769781752856;`
3. 执行 `SET FOREIGN_KEY_CHECKS = 0;`
4. 对约69张表执行 `TRUNCATE TABLE`（保留 `sequelizemeta` 和 `administrative_regions`）
5. 执行 `SET FOREIGN_KEY_CHECKS = 1;`
6. 重跑迁移重建系统账户
7. 根据你提供的数据重建：管理员、配置、活动、奖品、资产类型

---

### 验证脚本命令

```bash
# 1. 检查数据库连接和表数量
node -e "
require('dotenv').config();
const { sequelize } = require('./config/database');
(async () => {
  await sequelize.authenticate();
  const [tables] = await sequelize.query('SHOW TABLES');
  console.log('✅ 数据库连接成功，表数量:', tables.length);
  await sequelize.close();
})();
"

# 2. 检查系统账户完整性
node -e "
require('dotenv').config();
const { sequelize } = require('./config/database');
(async () => {
  const [rows] = await sequelize.query(\"SELECT system_code FROM accounts WHERE account_type='system'\");
  console.log('系统账户:', rows.map(r => r.system_code));
  await sequelize.close();
})();
"

# 3. 检查关键配置
node -e "
require('dotenv').config();
const { sequelize } = require('./config/database');
(async () => {
  const [rows] = await sequelize.query(\"SELECT setting_key, setting_value FROM system_settings WHERE setting_key IN('lottery_cost_points','budget_allocation_ratio','daily_lottery_limit')\");
  console.table(rows);
  await sequelize.close();
})();
"

# 4. 检查功能开关
node -e "
require('dotenv').config();
const { sequelize } = require('./config/database');
(async () => {
  const [rows] = await sequelize.query('SELECT flag_key, is_enabled FROM feature_flags');
  console.table(rows);
  await sequelize.close();
})();
"

# 5. 资产域一致性验证
node scripts/verify-asset-domain.js

# 6. 抽奖账本一致性验证
node scripts/diagnostic/verify_lottery_ledger.js
```

---

## 🎯 快速决策指南

### 场景 1：日常测试后恢复环境

**推荐方案**：方案 A  
**理由**：保留配置和用户，只清理业务数据  
**你需要提供**：测试用户 ID（推荐 `user_id=31` 或 `user_id=32`）

---

### 场景 2：重大架构重构（如预算积分体系实施）

**推荐方案**：方案 A  
**理由**：清理资产和业务数据，为新架构提供干净基础  
**你需要提供**：测试用户 ID、活动预算模式确认

---

### 场景 3：系统配置本身有问题

**推荐方案**：方案 B  
**理由**：完全重置，重新配置所有参数  
**你需要提供**：完整重建包（管理员、配置、活动、奖品、资产类型、功能开关）

---

## 🔑 核心要点总结

### 方案 A（保守清理）

**清理对象**：约43张业务数据表  
**保留对象**：配置、用户、系统账户、活动定义、策略配置、功能开关、字典数据（不含运营内容和用户关系数据）

**你需要提供**：
- ✅ 测试用户 ID（1-2 个，推荐 `user_id=31` 或 `user_id=32`）
- 可选：初始资产充值金额
- 可选：活动预算模式确认

**清理后状态**：
- ✅ 可以登录（需重新登录）
- ✅ 可以抽奖（需先充值资产）
- ✅ 配置完整（无需重建）
- ✅ 策略配置保留（用户体验状态重置）

---

### 方案 B（激进清理）

**清理对象**：约69张表（配置+业务）  
**保留对象**：仅表结构 + 迁移记录 + 行政区划字典

**你需要提供**：
- ✅ 管理员账号（mobile/nickname/role，验证码登录无需密码）
- ✅ 关键配置（lottery_cost_points / budget_allocation_ratio）
- ✅ 活动与奖品（至少 1 套完整定义）
- ✅ 资产类型（POINTS/BUDGET_POINTS/DIAMOND）
- ✅ 角色定义
- ✅ 功能开关配置（7个抽奖策略开关）

**清理后状态**：
- ❌ 无法登录（需重建管理员）
- ❌ 无法抽奖（需重建活动）
- ❌ 配置丢失（需全部重建）

---

## 📌 你的决策

**请明确告知以下信息**：

### 1. 选择方案

- [ ] 方案 A（保守清理）
- [ ] 方案 B（激进清理）

---

### 2. 如果选方案 A，提供以下信息：

**必需提供**：

- 测试用户 ID 或 mobile：`_____________`
  - **推荐**：`31`（管理员用户）或 `32`（测试用户）

**可选提供**：

- 初始 POINTS 充值：`_____________`（建议 1000-5000）
- 初始 DIAMOND 充值：`_____________`（建议 500-2000）
- 活动预算模式：`_____________`（当前为 `'none'`）

---

### 3. 如果选方案 B，提供完整重建包

（见上方详细清单）

---

**提供以上信息后，我会生成精确的清理脚本和验证步骤。**
