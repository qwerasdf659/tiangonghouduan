# 测试环境数据库彻底清理手册

**生成时间**: 2025-01-04  
**数据库**: restaurant_lottery (测试环境)  
**总表数**: 45 张表  
**文档用途**: 通用的测试环境数据清理标准操作手册（纯清单格式）

---

## 📋 使用场景

本文档适用于以下任何需要"恢复干净测试环境"的场景：

1. **架构重构前**：如实施预算积分体系、资产体系升级等
2. **脏数据清理**：测试过程中产生大量脏数据，影响后续测试
3. **功能验证准备**：需要干净的初始状态验证新功能
4. **环境重置**：定期恢复测试环境到已知状态
5. **性能测试准备**：清理历史数据，从已知基线开始测试

---

## 🎯 方案选择

### 方案 A：保守清理（日常推荐）

**保留**：配置数据、管理员账号、活动配置、用户基础信息、系统账户  
**清理**：用户资产余额/流水、抽奖记录、消费记录、交易记录

**适合场景**：

- 日常测试后恢复干净环境
- 验证新功能但不想重新配置系统
- 保留测试账号和系统配置

**执行时间**：3 分钟  
**恢复时间**：无需恢复（配置和账号都保留）

---

### 方案 B：激进清理（深度重置）

**保留**：仅保留数据库结构（45 张表的 schema）  
**清理**：所有业务数据（包括配置、管理员、用户、活动）

**适合场景**：

- 完全从零开始
- 系统配置本身有问题需要重建
- 模拟"新系统首次启动"

**执行时间**：5 分钟  
**恢复时间**：2-4 小时（需要重建所有配置、用户、活动）

---

## 📊 方案 A：保守清理（详细清单）

### ✅ 会保留的数据（13 张表 + 系统账户）

#### 1. 账号与权限体系（保留）

| 表名         | 当前数据量 | 清理后数量                    | 说明                                     |
| ------------ | ---------- | ----------------------------- | ---------------------------------------- |
| `users`      | 22 条      | 22 条（保留）                 | 用户基础信息（user_id/mobile/nickname）  |
| `roles`      | 存在       | 保留                          | 角色定义（admin/user等）                 |
| `user_roles` | 13 条      | 13 条（保留）                 | 用户角色关系（管理员权限）               |
| `accounts`   | 13 条      | **约 5 条**（仅保留系统账户） | ⚠️ 只保留 `account_type='system'` 的账户 |

**关键说明**：

- `accounts` 表会删除所有 `account_type='user'` 的记录（约 8-10 条）
- 保留 `account_type='system'` 的系统账户（约 5 条）：
  - `SYSTEM_PLATFORM_FEE`（平台手续费）
  - `SYSTEM_MINT`（系统发放）
  - `SYSTEM_BURN`（系统销毁）
  - `SYSTEM_ESCROW`（托管账户）
  - `SYSTEM_RESERVE`（储备金，如果有）

**为什么保留系统账户**：

- 你的 `AssetService.getOrCreateAccount({system_code})` **不会自动创建**系统账户，缺失会直接报错：`系统账户不存在：system_code=xxx，请检查数据库初始化`
- 系统账户是迁移时通过 `20251215160000-create-accounts-table.js` 初始化的，清空后需要重跑迁移才能恢复

---

#### 2. 系统配置（保留）

| 表名                          | 当前数据量 | 清理后数量    | 说明         |
| ----------------------------- | ---------- | ------------- | ------------ |
| `system_settings`             | 18 条      | 18 条（保留） | 核心配置参数 |
| `lottery_management_settings` | 存在       | 保留          | 抽奖管理配置 |

**关键配置项**（清理后必须仍存在，否则业务报错）：

- `points/lottery_cost_points`：抽奖定价（严格模式读取）
- `points/budget_allocation_ratio`：消费返预算比例（严格模式读取，你真实库=0.24）

**验证命令**：

```
node -e "
require('dotenv').config();
const { sequelize } = require('./config/database');
(async () => {
  const [rows] = await sequelize.query(
    \"SELECT setting_key, setting_value FROM system_settings WHERE setting_key IN ('lottery_cost_points', 'budget_allocation_ratio')\"
  );
  console.log('关键配置:', rows);
  await sequelize.close();
})();
"
```

---

#### 3. 活动与奖品定义（保留）

| 表名                | 当前数据量 | 清理后数量   | 说明                      |
| ------------------- | ---------- | ------------ | ------------------------- |
| `lottery_campaigns` | 1 条       | 1 条（保留） | 活动配置（campaign_id=1） |
| `lottery_prizes`    | 9 条       | 9 条（保留） | 奖品池定义                |

**清理后状态**：

- 活动配置保留，但相关的抽奖记录会被清空
- 奖品定义保留，但用户获得的物品实例会被清空

---

#### 4. 业务定义类表（保留）

| 表名                        | 说明                                           |
| --------------------------- | ---------------------------------------------- |
| `material_asset_types`      | 资产类型定义（POINTS/BUDGET_POINTS/DIAMOND等） |
| `material_conversion_rules` | 资产转换规则                                   |
| `stores`                    | 门店配置                                       |
| `products`                  | 商品配置                                       |
| `exchange_items`            | 可兑换商品定义                                 |

---

### 🗑️ 会清空的数据（17 张表）

#### 1. 资产账本（核心清理）

| 表名                     | 当前数据量 | 清理后数量  | 影响                       |
| ------------------------ | ---------- | ----------- | -------------------------- |
| `accounts`               | 13 条      | **约 5 条** | 删除用户账户，保留系统账户 |
| `account_asset_balances` | 11 条      | 0 条        | 所有资产余额清零           |
| `asset_transactions`     | 216 条     | 0 条        | 所有资产流水清空           |

**清理后影响**：

- 所有用户的 POINTS/DIAMOND/BUDGET_POINTS 余额归零
- 用户的 `account_id` 会丢失（但 `user_id` 保留）
- 系统账户的 `account_id` 保留，但余额清零

---

#### 2. 抽奖记录

| 表名                            | 当前数据量 | 清理后数量 |
| ------------------------------- | ---------- | ---------- |
| `lottery_draws`                 | 2841 条    | 0 条       |
| `lottery_user_daily_draw_quota` | 存在       | 0 条       |

---

#### 3. 消费与审核

| 表名                      | 当前数据量 | 清理后数量 |
| ------------------------- | ---------- | ---------- |
| `consumption_records`     | 184 条     | 0 条       |
| `merchant_points_reviews` | 存在       | 0 条       |

---

#### 4. 交易/兑换/市场

| 表名                | 清理后数量 |
| ------------------- | ---------- |
| `exchange_records`  | 0 条       |
| `trade_orders`      | 0 条       |
| `trade_records`     | 0 条       |
| `market_listings`   | 0 条       |
| `redemption_orders` | 0 条       |

---

#### 5. 背包与物品

| 表名                   | 清理后数量 |
| ---------------------- | ---------- |
| `item_instances`       | 0 条       |
| `item_instance_events` | 0 条       |

---

#### 6. 客服聊天

| 表名                        | 清理后数量 |
| --------------------------- | ---------- |
| `chat_messages`             | 0 条       |
| `customer_service_sessions` | 0 条       |

---

#### 7. 审计/幂等/会话

| 表名                       | 清理后数量 |
| -------------------------- | ---------- |
| `audit_records`            | 0 条       |
| `admin_operation_logs`     | 0 条       |
| `role_change_logs`         | 0 条       |
| `api_idempotency_requests` | 0 条       |
| `authentication_sessions`  | 0 条       |

---

### ⚠️ 方案 A 清理后需要你提供的数据

#### 🎯 必需提供（否则无法验证）

1. **测试用户信息**：
   - 提供 1-2 个用户的 `user_id` 或 `mobile`（从保留的 22 个用户中选）
   - 用途：用于验证"消费→审批→发放→抽奖"完整流程

2. **确认系统账户存在**：
   - 执行验证：`SELECT system_code FROM accounts WHERE account_type='system'`
   - 预期结果：至少包含 `SYSTEM_PLATFORM_FEE`、`SYSTEM_MINT`、`SYSTEM_BURN`、`SYSTEM_ESCROW`

3. **确认关键配置存在**：
   - 执行验证：`SELECT setting_key, setting_value FROM system_settings WHERE setting_key IN ('lottery_cost_points', 'budget_allocation_ratio')`
   - 预期结果：两条记录都存在，且 `budget_allocation_ratio=0.24`

---

#### 🔧 可选提供（快速恢复测试环境）

1. **初始资产充值金额**：
   - 给测试用户充值多少 POINTS？（建议 1000-5000）
   - 给测试用户充值多少 DIAMOND？（建议 500-2000）

2. **活动预算模式确认**：
   - 你保留的活动（campaign_id=1）应该是什么预算模式？
     - `user`（用户维度预算）
     - `pool`（活动池预算）
     - `none`（无预算约束）
   - 如果选 `pool`，初始池子预算是多少？（建议 10000-50000）

---

### 🔍 方案 A 清理后验证清单

#### 必需检查项（清理立即后）

- [ ] 数据库连接正常
- [ ] 表结构完整（45 张表）
- [ ] 系统账户存在（至少 4 个：PLATFORM_FEE/MINT/BURN/ESCROW）
- [ ] 用户账号存在（22 个用户保留）
- [ ] 管理员权限正常（user_roles 保留）
- [ ] 系统配置存在（system_settings 18 条保留）
- [ ] 活动奖品配置存在（lottery_campaigns 1 条、lottery_prizes 9 条）

#### 资产域验证（可选）

- [ ] 用户账户已重建（`accounts` 表 `account_type='user'` 的记录）
- [ ] 用户资产余额已初始化（`account_asset_balances` 有记录）
- [ ] 资产流水与余额一致（余额 = 流水累加）

#### 功能验证（可选）

- [ ] 用户可登录（需重新登录，因 authentication_sessions 被清空）
- [ ] 消费审批可发放积分（测试 ConsumptionService.approveConsumption）
- [ ] 抽奖可扣减积分（测试 UnifiedLotteryEngine.execute_draw）

---

## 📊 方案 B：激进清理（详细清单）

### ✅ 会保留的数据（仅表结构）

| 保留内容   | 说明                                       |
| ---------- | ------------------------------------------ |
| 数据库结构 | 45 张表的 schema 保留                      |
| 迁移记录   | `sequelizemeta` 表保留（记录已执行的迁移） |

**其余所有业务数据表的数据全部清空**。

---

### 🗑️ 会清空的数据（29 张表）

#### 在方案 A 的 17 张表基础上，额外清空以下 12 张表：

| 表名                          | 当前数据量 | 清理原因                           |
| ----------------------------- | ---------- | ---------------------------------- |
| `users`                       | 22 条      | 用户基础信息（所有用户需重新注册） |
| `user_roles`                  | 13 条      | 用户角色关系（管理员需重新授权）   |
| `roles`                       | 存在       | 角色定义                           |
| `system_settings`             | 18 条      | 系统配置参数                       |
| `lottery_campaigns`           | 1 条       | 活动配置                           |
| `lottery_prizes`              | 9 条       | 奖品池定义                         |
| `lottery_management_settings` | 存在       | 抽奖管理配置                       |
| `material_asset_types`        | 存在       | 资产类型定义                       |
| `material_conversion_rules`   | 存在       | 资产转换规则                       |
| `products`                    | 存在       | 商品配置                           |
| `stores`                      | 存在       | 门店配置                           |
| `exchange_items`              | 存在       | 可兑换商品定义                     |

---

### ⚠️ 方案 B 清理后需要你提供的数据（完整重建包）

#### 🔴 必需提供（否则系统无法启动）

#### 1. 管理员账号信息（至少 1 个）

| 字段     | 说明         | 示例                     |
| -------- | ------------ | ------------------------ |
| mobile   | 管理员手机号 | `13800138000`            |
| password | 管理员密码   | `Admin@123`              |
| nickname | 管理员昵称   | `系统管理员`             |
| role     | 管理员角色   | `super_admin` 或 `admin` |

**用途**：清理后无法登录管理后台，必须重建管理员账号。

---

#### 2. 系统配置参数（关键配置项）

| 配置项                            | 当前值（真实库） | 说明             | 是否强制          |
| --------------------------------- | ---------------- | ---------------- | ----------------- |
| `points/lottery_cost_points`      | ?                | 单抽积分消耗     | ✅ 严格模式，必需 |
| `points/budget_allocation_ratio`  | 0.24             | 消费返预算比例   | ✅ 严格模式，必需 |
| `points/daily_lottery_limit`      | ?                | 每日抽奖次数上限 | ⚠️ 建议提供       |
| `marketplace/max_active_listings` | ?                | 市场挂单上限     | ⚠️ 建议提供       |

**关键说明**：

- 前两项（`lottery_cost_points` / `budget_allocation_ratio`）是**严格模式配置**，缺失会导致：
  - 抽奖时报错：`关键配置缺失: points/lottery_cost_points`
  - 消费审批时报错：`关键配置缺失: points/budget_allocation_ratio`
- 你真实库当前 `budget_allocation_ratio=0.24`（24%），清理后需要重新写入这个值

---

#### 3. 活动与奖品定义（至少 1 套）

| 数据类型     | 需要提供的字段                                                                                                   | 说明                                 |
| ------------ | ---------------------------------------------------------------------------------------------------------------- | ------------------------------------ |
| **活动定义** | `campaign_code`, `campaign_name`, `start_time`, `end_time`, `status`, `budget_mode`, `prize_distribution_config` | 至少 1 个活动                        |
| **奖品定义** | `campaign_id`, `prize_name`, `prize_type`, `prize_value_points`, `stock`, `probability`                          | 对应活动的奖品池（建议 5-10 个奖品） |

**关键字段说明**：

- `budget_mode`：必须明确指定 `'user'` / `'pool'` / `'none'`（根据你的业务决策）
- `prize_value_points`：奖品的预算成本（用于预算过滤）

---

#### 4. 资产类型定义（必需）

| 资产代码        | 资产名称 | 用途         | 是否必需 |
| --------------- | -------- | ------------ | -------- |
| `POINTS`        | 普通积分 | 抽奖门票     | ✅ 必需  |
| `BUDGET_POINTS` | 预算积分 | 预算约束抽奖 | ✅ 必需  |
| `DIAMOND`       | 钻石     | 交易市场货币 | ⚠️ 建议  |

**清理后必须重新写入 `material_asset_types` 表**。

---

#### 5. 系统账户确认（清理后必须存在）

| system_code           | 说明           | 用途           |
| --------------------- | -------------- | -------------- |
| `SYSTEM_PLATFORM_FEE` | 平台手续费账户 | 交易手续费入账 |
| `SYSTEM_MINT`         | 系统发放账户   | 积分发放源头   |
| `SYSTEM_BURN`         | 系统销毁账户   | 积分销毁目标   |
| `SYSTEM_ESCROW`       | 托管账户       | 交易托管       |

**⚠️ 注意**：如果你选择清理 `accounts` 表（包括系统账户），清理后需要重跑迁移：

```
node -e "require('dotenv').config(); require('./migrations/20251215160000-create-accounts-table').up(require('./config/database').sequelize.getQueryInterface(), require('sequelize'));"
```

---

### 🔍 方案 B 清理后验证清单

#### 必需检查项（清理立即后）

- [ ] 数据库连接正常
- [ ] 表结构完整（45 张表）
- [ ] **系统账户已重建**（4-5 个系统账户）
- [ ] **管理员账号已创建**（至少 1 个）
- [ ] **系统配置已写入**（至少 2 项关键配置）
- [ ] **活动奖品已配置**（至少 1 个活动 + 奖品池）
- [ ] **资产类型已定义**（至少 POINTS/BUDGET_POINTS/DIAMOND）

#### 功能验证（必需）

- [ ] 管理员可登录管理后台
- [ ] 用户可注册/登录
- [ ] 消费审批可发放积分
- [ ] 抽奖功能可正常使用

---

## 📋 方案 A vs 方案 B 对比清单

| 维度                 | 方案 A（保守）               | 方案 B（激进）        |
| -------------------- | ---------------------------- | --------------------- |
| **清理表数**         | 17 张（只清业务数据）        | 29 张（清配置+业务）  |
| **保留用户账号**     | ✅ 是（22 个）               | ❌ 否（0 个）         |
| **保留管理员**       | ✅ 是                        | ❌ 否                 |
| **保留系统账户**     | ✅ 是（5 个）                | ❌ 否（0 个）         |
| **保留系统配置**     | ✅ 是（18 条）               | ❌ 否（0 条）         |
| **保留活动配置**     | ✅ 是（1 个活动 + 9 个奖品） | ❌ 否（0 个）         |
| **清理用户资产**     | ✅ 是                        | ✅ 是                 |
| **清理抽奖记录**     | ✅ 是                        | ✅ 是                 |
| **清理消费记录**     | ✅ 是                        | ✅ 是                 |
| **执行后可登录**     | ✅ 是（需重新登录）          | ❌ 否（需重建管理员） |
| **执行后可抽奖**     | ✅ 是（需充值资产）          | ❌ 否（需重建活动）   |
| **恢复成本**         | 无（配置都保留）             | 极高（2-4 小时）      |
| **需要你提供的数据** | 测试用户 ID                  | 完整重建包（见下表）  |

---

## 📝 方案 A 清理后你需要提供的输入清单

### 🎯 必需提供

| 输入项      | 格式                  | 示例                         | 用途                 |
| ----------- | --------------------- | ---------------------------- | -------------------- |
| 测试用户 ID | `user_id` 或 `mobile` | `31` 或 `13612227930`        | 用于验证完整业务流程 |
| 确认 `.env` | 确认指向测试库        | `DB_NAME=restaurant_lottery` | 防止误清生产库       |

### 🔧 可选提供（快速验证）

| 输入项            | 格式                       | 示例     | 用途                                            |
| ----------------- | -------------------------- | -------- | ----------------------------------------------- |
| 初始 POINTS 充值  | 数字                       | `1000`   | 给测试用户充值初始积分                          |
| 初始 DIAMOND 充值 | 数字                       | `500`    | 给测试用户充值初始钻石                          |
| 活动预算模式      | `'user'`/`'pool'`/`'none'` | `'user'` | 确认活动的预算模式（需补充 `budget_mode` 字段） |
| 活动池初始预算    | 数字                       | `10000`  | 如果选 `pool` 模式，池子初始预算                |

---

## 📝 方案 B 清理后你需要提供的输入清单

### 🎯 必需提供（完整重建包）

#### 1. 管理员账号信息

| 字段     | 格式            | 示例          | 说明                           |
| -------- | --------------- | ------------- | ------------------------------ |
| mobile   | 手机号（11 位） | `13800138000` | 管理员登录账号                 |
| password | 明文密码        | `Admin@123`   | 登录密码（会自动 bcrypt 加密） |
| nickname | 字符串          | `系统管理员`  | 显示名称                       |
| role     | 角色代码        | `super_admin` | 管理员角色                     |

---

#### 2. 系统配置参数（关键配置）

| 配置项                            | 配置值               | 值类型 | 说明                  | 是否严格    |
| --------------------------------- | -------------------- | ------ | --------------------- | ----------- |
| `points/lottery_cost_points`      | 提供具体数值         | number | 单抽积分消耗          | ✅ 严格模式 |
| `points/budget_allocation_ratio`  | `0.24`（你真实库值） | number | 消费返预算比例（24%） | ✅ 严格模式 |
| `points/daily_lottery_limit`      | 提供具体数值         | number | 每日抽奖次数上限      | ⚠️ 建议     |
| `points/consumption_points_ratio` | 提供具体数值         | number | 消费返普通积分比例    | ⚠️ 建议     |

**格式要求**：

```
INSERT INTO system_settings (setting_key, setting_value, value_type, category) VALUES
('lottery_cost_points', '你提供的值', 'number', 'points'),
('budget_allocation_ratio', '0.24', 'number', 'points');
```

---

#### 3. 活动与奖品定义（至少 1 套）

**活动定义**（`lottery_campaigns` 表）：

| 字段                  | 格式           | 示例                       | 说明                              |
| --------------------- | -------------- | -------------------------- | --------------------------------- |
| campaign_code         | 字符串（唯一） | `BASIC_LOTTERY`            | 活动代码                          |
| campaign_name         | 字符串         | `基础抽奖活动`             | 活动名称                          |
| start_time            | 日期时间       | `2025-01-01 00:00:00`      | 开始时间                          |
| end_time              | 日期时间       | `2025-12-31 23:59:59`      | 结束时间                          |
| status                | 枚举           | `active`                   | 活动状态                          |
| budget_mode           | 枚举           | `'user'`/`'pool'`/`'none'` | 预算模式（必需明确）              |
| pool_budget_total     | 数字           | `10000`                    | 活动池总预算（`pool` 模式必需）   |
| pool_budget_remaining | 数字           | `10000`                    | 活动池剩余预算（`pool` 模式必需） |
| draw_cost             | 数字           | `10`                       | 抽奖消耗积分                      |

---

**奖品定义**（`lottery_prizes` 表，至少 5-10 个）：

| 字段               | 格式   | 示例                        | 说明                         |
| ------------------ | ------ | --------------------------- | ---------------------------- |
| campaign_id        | 数字   | `1`                         | 关联活动ID                   |
| prize_name         | 字符串 | `钻石×100`                  | 奖品名称                     |
| prize_type         | 枚举   | `asset` / `item` / `coupon` | 奖品类型                     |
| prize_value_points | 数字   | `100`                       | 奖品预算成本（用于预算过滤） |
| stock              | 数字   | `1000`                      | 库存数量                     |
| probability        | 小数   | `0.05`                      | 中奖概率（5%）               |

**注意事项**：

- 至少需要 1 个"空奖"（`prize_type='empty'`, `probability` 较高）
- 奖品概率总和建议 ≤ 1.0（100%）
- `prize_value_points` 用于预算过滤，必须≥0

---

#### 4. 资产类型定义（必需）

| asset_code      | asset_name | 说明               | 是否必需                  |
| --------------- | ---------- | ------------------ | ------------------------- |
| `POINTS`        | 普通积分   | 抽奖门票、消费返还 | ✅ 必需                   |
| `BUDGET_POINTS` | 预算积分   | 预算约束抽奖       | ✅ 必需                   |
| `DIAMOND`       | 钻石       | 交易市场货币       | ⚠️ 如果有交易市场功能必需 |

**格式要求**：

```
INSERT INTO material_asset_types (asset_code, asset_name, description, is_tradable) VALUES
('POINTS', '普通积分', '抽奖门票', false),
('BUDGET_POINTS', '预算积分', '预算约束抽奖', false),
('DIAMOND', '钻石', '交易市场货币', true);
```

---

#### 5. 系统账户信息（必需确认）

清理后需要重跑迁移或手动插入以下系统账户：

| system_code            | 说明                   | 用途               |
| ---------------------- | ---------------------- | ------------------ |
| `SYSTEM_PLATFORM_FEE`  | 平台手续费账户         | 交易手续费入账     |
| `SYSTEM_MINT`          | 系统发放账户           | 积分发放源头       |
| `SYSTEM_BURN`          | 系统销毁账户           | 积分销毁目标       |
| `SYSTEM_ESCROW`        | 托管账户               | 交易托管/争议      |
| `SYSTEM_RESERVE`       | 储备金账户（可选）     | 系统储备           |
| `SYSTEM_CAMPAIGN_POOL` | 活动池预算账户（可选） | 活动池预算模式需要 |

**重建方式**：重跑迁移 `20251215160000-create-accounts-table.js`

---

#### 6. 角色定义（必需）

| role_name     | description | role_level |
| ------------- | ----------- | ---------- |
| `super_admin` | 超级管理员  | 100        |
| `admin`       | 管理员      | 80         |
| `merchant`    | 商户        | 50         |
| `user`        | 普通用户    | 10         |

---

### 🔍 方案 B 清理后验证清单

#### 必需检查项（提供数据并重建后）

- [ ] 数据库连接正常
- [ ] 表结构完整（45 张表）
- [ ] **系统账户已重建**（至少 4 个）
- [ ] **管理员账号已创建**（至少 1 个）
- [ ] **系统配置已写入**（至少 2 项关键配置）
- [ ] **活动奖品已配置**（至少 1 个活动 + 奖品池）
- [ ] **资产类型已定义**（至少 POINTS/BUDGET_POINTS）
- [ ] **角色定义已创建**（至少 4 个角色）

#### 功能验证（必需）

- [ ] 管理员可登录管理后台
- [ ] 用户可注册新账号
- [ ] 消费审批可发放积分（验证 `budget_allocation_ratio` 配置生效）
- [ ] 抽奖功能可正常使用（验证 `lottery_cost_points` 配置生效）
- [ ] 交易市场可正常使用（如果有此功能）

---

## 🚨 风险提示

### 方案 A 的风险

| 风险类型     | 影响    | 说明                              |
| ------------ | ------- | --------------------------------- |
| 资产数据丢失 | ⚠️ 中等 | 所有用户的资产余额和流水清零      |
| 历史记录丢失 | ⚠️ 中等 | 抽奖/消费/交易/聊天的历史记录丢失 |
| 账户关联重建 | ⚠️ 低   | 用户的 `account_id` 会变化        |
| 会话失效     | ⚠️ 低   | 用户需要重新登录                  |
| 系统账户丢失 | ❌ 无   | **系统账户保留**，不受影响        |

**适合人群**：能接受"用户历史清零"但想保留"系统配置和账号"。

---

### 方案 B 的额外风险（在方案 A 基础上）

| 风险类型         | 影响    | 说明                                        |
| ---------------- | ------- | ------------------------------------------- |
| 无法登录管理后台 | 🔴 高   | 管理员账号被清空，必须重建                  |
| 系统配置丢失     | 🔴 高   | 所有配置参数丢失，必须重新写入              |
| 活动奖品丢失     | 🔴 高   | 所有活动和奖品定义丢失，必须重新创建        |
| 用户账号丢失     | 🔴 高   | 所有测试用户丢失，必须重新注册              |
| 系统账户丢失     | 🔴 高   | 系统账户被清空，必须重跑迁移                |
| 资产类型丢失     | 🔴 高   | POINTS/BUDGET_POINTS 定义丢失，必须重新写入 |
| 恢复成本         | 🔴 极高 | 需要 2-4 小时重建整个系统                   |

**适合人群**：能接受"完全重建系统"的代价，且有完整的数据重建包。

---

## 📋 清理前后数据对比

### 清理前（当前真实库状态）

```
总表数: 45 张
用户: 22 个
系统账户: 约 5 个（PLATFORM_FEE/MINT/BURN/ESCROW 等）
用户账户: 约 8 个
资产余额: 11 条（POINTS: 7 条，BUDGET_POINTS: 0 条）
资产流水: 216 条
抽奖记录: 2841 条
消费记录: 184 条
活动配置: 1 个（campaign_id=1）
奖品定义: 9 个
系统配置: 18 条（包括 budget_allocation_ratio=0.24）
```

---

### 清理后（方案 A）

```
总表数: 45 张（表结构保留）
用户: 22 个（✅ 保留）
系统账户: 约 5 个（✅ 保留）
用户账户: 0 个（🗑️ 清空）
资产余额: 0 条（🗑️ 清空）
资产流水: 0 条（🗑️ 清空）
抽奖记录: 0 条（🗑️ 清空）
消费记录: 0 条（🗑️ 清空）
活动配置: 1 个（✅ 保留）
奖品定义: 9 个（✅ 保留）
系统配置: 18 条（✅ 保留）

【需要你提供】：
- 测试用户 ID（1-2 个）
- 可选：初始资产充值金额
```

---

### 清理后（方案 B）

```
总表数: 45 张（表结构保留）
用户: 0 个（🗑️ 清空）
系统账户: 0 个（🗑️ 清空）
用户账户: 0 个（🗑️ 清空）
资产余额: 0 条（🗑️ 清空）
资产流水: 0 条（🗑️ 清空）
抽奖记录: 0 条（🗑️ 清空）
消费记录: 0 条（🗑️ 清空）
活动配置: 0 个（🗑️ 清空）
奖品定义: 0 个（🗑️ 清空）
系统配置: 0 条（🗑️ 清空）

【需要你提供】：
- 管理员账号信息（mobile/password/nickname/role）
- 系统配置参数（至少 2 项关键配置）
- 活动与奖品定义（至少 1 套）
- 资产类型定义（POINTS/BUDGET_POINTS/DIAMOND）
- 角色定义（至少 4 个角色）
```

---

## 🎯 快速决策指南

### 场景 1：日常测试后恢复环境

**推荐方案**：方案 A  
**理由**：保留配置和用户，只清理业务数据  
**你需要提供**：测试用户 ID（1-2 个）

---

### 场景 2：重大架构重构（如预算积分体系实施）

**推荐方案**：方案 A  
**理由**：清理资产和业务数据，为新架构提供干净基础  
**你需要提供**：测试用户 ID、活动预算模式确认

---

### 场景 3：系统配置本身有问题

**推荐方案**：方案 B  
**理由**：完全重置，重新配置所有参数  
**你需要提供**：完整重建包（管理员、配置、活动、奖品、资产类型）

---

## 📝 执行清理的方式（Node.js only）

### 执行约束

1. **不使用 mysql 客户端**：所有操作通过 Node.js 执行
2. **连接真实 `.env` 库**：使用 `require('dotenv').config()` + `require('./config/database').sequelize`
3. **执行前核对**：先运行 `node scripts/diagnostic/live_db_reality_check.js` 确认连接的是测试库

---

### 执行原则（不含代码实现）

**方案 A 执行步骤**：

1. 连接 `.env` 指向的真实数据库
2. 执行 `SET FOREIGN_KEY_CHECKS = 0;`
3. 对 17 张业务表执行 `TRUNCATE TABLE`（但 `accounts` 只删 `account_type='user'` 的记录）
4. 执行 `SET FOREIGN_KEY_CHECKS = 1;`
5. 验证系统账户仍存在（至少 4 个）
6. 验证系统配置仍存在（至少 2 项关键配置）

---

**方案 B 执行步骤**：

1. 连接 `.env` 指向的真实数据库
2. 执行 `SET FOREIGN_KEY_CHECKS = 0;`
3. 对 29 张表执行 `TRUNCATE TABLE`
4. 执行 `SET FOREIGN_KEY_CHECKS = 1;`
5. 重跑迁移重建系统账户（或手动插入）
6. 根据你提供的数据重建：管理员、配置、活动、奖品、资产类型

---

### 清理后验证脚本（仓库真实存在）

| 脚本路径                                      | 用途                 | 执行命令                                           |
| --------------------------------------------- | -------------------- | -------------------------------------------------- |
| `scripts/diagnostic/live_db_reality_check.js` | 核对真实库表与数据量 | `node scripts/diagnostic/live_db_reality_check.js` |
| `scripts/validation/check-db-connections.js`  | 数据库连接健康检查   | `node scripts/validation/check-db-connections.js`  |
| `scripts/verify-asset-domain.js`              | 资产域一致性验证     | `node scripts/verify-asset-domain.js`              |
| `scripts/diagnostic/verify_lottery_ledger.js` | 抽奖账本一致性验证   | `node scripts/diagnostic/verify_lottery_ledger.js` |

---

## 🔑 核心要点总结

### 方案 A（保守清理）

**清理对象**：17 张业务数据表  
**保留对象**：配置、用户、系统账户、活动定义  
**你需要提供**：

- ✅ 测试用户 ID（1-2 个）
- 可选：初始资产充值金额
- 可选：活动预算模式确认

**清理后状态**：

- ✅ 可以登录（需重新登录）
- ✅ 可以抽奖（需先充值资产）
- ✅ 配置完整（无需重建）

---

### 方案 B（激进清理）

**清理对象**：29 张表（配置+业务）  
**保留对象**：仅表结构  
**你需要提供**：

- ✅ 管理员账号（mobile/password/nickname/role）
- ✅ 关键配置（lottery_cost_points / budget_allocation_ratio=0.24）
- ✅ 活动与奖品（至少 1 套完整定义）
- ✅ 资产类型（POINTS/BUDGET_POINTS/DIAMOND）
- ✅ 角色定义（至少 4 个）

**清理后状态**：

- ❌ 无法登录（需重建管理员）
- ❌ 无法抽奖（需重建活动）
- ❌ 配置丢失（需全部重建）

---

## 📌 你的决策

**请明确告知以下信息**：

### 1. 选择方案

- [ ] 方案 A（保守清理）
- [ ] 方案 B（激进清理）

---

### 2. 如果选方案 A，提供以下信息：

**必需提供**：

- 测试用户 ID 或 mobile：`_____________`（从你真实库的 22 个用户中选 1-2 个）
  - **示例**：`31` 或 `13612227930`

**可选提供**：

- 初始 POINTS 充值：`_____________`（建议 1000-5000）
  - **示例**：`2000`（充值 2000 积分，可抽 200 次，单抽 10 积分）
- 初始 DIAMOND 充值：`_____________`（建议 500-2000）
  - **示例**：`1000`（充值 1000 钻石，用于交易市场测试）
- 活动预算模式：`_____________`（`'user'` / `'pool'` / `'none'`）
  - **示例**：`'user'`（用户维度预算，消费返的 BUDGET_POINTS 用于该活动）
- 活动池初始预算（如选 `pool`）：`_____________`（建议 10000-50000）
  - **示例**：`20000`（活动池总预算 20000 BUDGET_POINTS，先到先得）

---

### 3. 如果选方案 B，提供以下完整重建包：

#### 管理员账号

| 字段     | 你的输入                | 示例          |
| -------- | ----------------------- | ------------- |
| mobile   | `_____________`         | `13800138000` |
| password | `_____________`         | `Admin@2025`  |
| nickname | `_____________`         | `系统管理员`  |
| role     | `super_admin` / `admin` | `super_admin` |

---

#### 关键配置

| 配置项                    | 你的输入                  | 示例   | 说明                |
| ------------------------- | ------------------------- | ------ | ------------------- |
| `lottery_cost_points`     | `_____________`           | `10`   | 单抽消耗 10 积分    |
| `budget_allocation_ratio` | `0.24` 或 `_____________` | `0.24` | 消费返 24% 预算积分 |

---

#### 活动与奖品（示例：基础抽奖活动）

**活动定义**：

| 字段                                 | 你的输入                       | 示例            |
| ------------------------------------ | ------------------------------ | --------------- |
| campaign_code                        | `_____________`                | `BASIC_LOTTERY` |
| campaign_name                        | `_____________`                | `基础抽奖活动`  |
| budget_mode                          | `'user'` / `'pool'` / `'none'` | `'user'`        |
| pool_budget_total（如选 `pool`）     | `_____________`                | `50000`         |
| pool_budget_remaining（如选 `pool`） | `_____________`                | `50000`         |
| draw_cost                            | `_____________`                | `10`            |

---

**奖品定义示例**（至少 5-10 个）：

| 奖品名称  | 奖品类型 | 预算成本 | 库存     | 概率    | 说明                    |
| --------- | -------- | -------- | -------- | ------- | ----------------------- |
| 空奖      | `empty`  | `0`      | `999999` | `0.70`  | 70% 概率空奖            |
| 钻石×10   | `asset`  | `10`     | `1000`   | `0.15`  | 15% 概率获得 10 钻石    |
| 钻石×50   | `asset`  | `50`     | `500`    | `0.08`  | 8% 概率获得 50 钻石     |
| 钻石×100  | `asset`  | `100`    | `200`    | `0.05`  | 5% 概率获得 100 钻石    |
| 钻石×500  | `asset`  | `500`    | `50`     | `0.015` | 1.5% 概率获得 500 钻石  |
| 钻石×1000 | `asset`  | `1000`   | `10`     | `0.005` | 0.5% 概率获得 1000 钻石 |

**注意事项**：

- 概率总和 = 1.0（100%）
- `prize_value_points` 用于预算过滤（BUDGET_POINTS 不足时自动排除该奖品）
- 至少需要 1 个"空奖"（`prize_type='empty'`）

---

**提供以上信息后，我会生成精确的重建脚本和验证步骤。**
