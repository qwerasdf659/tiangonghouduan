# 测试环境数据库彻底清理手册

**生成时间**: 2026-02-16（基于真实数据库实时查询更新，二次校验 2026-02-16 21:00）  
**数据库**: restaurant_points_dev (测试环境，远程 dbconn.sealosbja.site:42569)  
**总表数**: 80 张表  
**数据库大小**: 118.83 MB  
**外键约束**: 114 条  
**迁移记录**: 332 条（sequelizemeta，方案B保留）  
**文档用途**: 通用的测试环境数据清理标准操作手册（纯清单格式）

---

## 📝 2026-02-16 更新记录（与旧文档差异）

> 本次更新通过 Node.js 连接真实数据库 `restaurant_points_dev` 实时查询，修正了旧文档中所有不准确的数据。

### 二次校验修正（2026-02-16 21:00）

| 维度 | 初版值 | 二次校验实际值 | 修正 |
|------|--------|---------------|------|
| `system_dictionaries` 字典类型数 | 69种 | **73种** | +4种新增字典类型 |
| `authentication_sessions` | 2 | **5** | 运行时累增 |
| `chat_messages` | 446 | **448** | 运行时累增 |
| `websocket_startup_logs` | 1,920 | **1,921** | 运行时累增 |
| marketplace 配置项 | 仅列1条 | **实际20条** | 补全完整列表 |
| 奖品池速查模板 prize_type | `empty`/`asset` | `virtual`/`points`/`coupon`/`physical` | 修正为实际枚举 |
| 系统账户重建方式 | 可重跑迁移 | **不可重跑**（sequelizemeta已记录） | 必须手动INSERT |
| `preset_debt_limits` 预算描述 | 预算10000元 | `budget_debt_limit=1000000` | 修正为实际值 |
| 活动1 budget_mode | 某处暗示`none` | 实际为 **`user`** | 修正 |
| `material_asset_types` 字段名 | `asset_name` | 实际为 **`display_name`** | 修正字段名 |

### 数据库结构变更

| 维度 | 旧文档(2025-01-30) | 实际数据库(2026-02-16) |
|------|---------------------|----------------------|
| 总表数 | 72 张 | **80 张**（新增8张） |
| 数据库名 | restaurant_lottery | **restaurant_points_dev** |
| 外键约束 | 未记录 | **114 条** |
| 数据库大小 | 未记录 | **118.83 MB** |
| 垃圾表 `deadlock_test_1769781752856` | 标记为需删除 | **已不存在**（已清理） |
| 方案B清空表数 | 69 张 | **78 张** |
| 方案A清空表数 | 43 张 | **49 张** |

### 新增8张表（旧文档中未收录）

| 表名 | 实际行数 | 归类 | 方案B处理 |
|------|----------|------|-----------|
| `admin_notifications` | 0 | 管理员通知 | 清空 |
| `alert_silence_rules` | 0 | 告警静默规则 | 清空 |
| `bid_products` | 0 | 竞拍商品 | 清空 |
| `bid_records` | 0 | 竞拍记录 | 清空 |
| `reminder_rules` | 3 | 提醒规则配置 | 清空 |
| `reminder_history` | 357 | 提醒历史 | 清空 |
| `report_templates` | 2 | 报告模板 | 清空 |
| `user_behavior_tracks` | 0 | 用户行为追踪 | 清空 |

### 数据量修正

| 表名 | 旧值 | 实际值 | 变化 |
|------|------|--------|------|
| `system_settings` | 39 | **42** | +3 |
| `system_dictionaries` | 244 | **369** | +125（73种字典类型） |
| `system_configs` | 6 | **9** | +3 |
| `lottery_draw_quota_rules` | 7 | **11** | +4 |
| `category_defs` | 8 | **9** | +1 |
| `rarity_defs` | 6 | **5** | -1 |
| `exchange_items` | 35 | **77** | +42 |
| `lottery_campaign_pricing_config` | 11 | **13** | +2 |

### 功能开关 `feature_flags` 修正（flag_key 完全不同）

| 旧文档 flag_key（错误） | 实际数据库 flag_key（正确） | 说明 |
|------------------------|---------------------------|------|
| `lottery_anti_streak` | **`lottery_anti_empty_streak`** | 防连续空奖 |
| _(无)_ | **`lottery_anti_high_streak`** | 防连续高价值（旧文档漏掉） |
| `lottery_dynamic_probability` | _(已不存在)_ | 旧文档有，实际库中无 |
| `lottery_budget_filter` | **`lottery_budget_tier`** | 预算分层控制 |
| `lottery_quota_system` | **`lottery_pressure_tier`** | 活动压力分层 |

### 其他关键修正

- **角色数据**：实际含11条（9条正式 + `campaign_2` + `test_role_api` 两条测试数据）
- **管理员用户**：实际有4个 admin 角色用户（user_id=31, 135, 11114, 11132）
- **活动数据**：活动ID实际为 1/25/26/27（非连续1-4），仅活动1为正式数据
- **奖品类型**：实际 prize_type 枚举为 `points/coupon/physical/virtual/service/product/special`（旧文档写的 `empty/asset/item` 不正确）

---

## 🔴 已选定：方案 B（激进清理）

> **决策时间**：2026-02-16  
> **清理范围**：78 张表 TRUNCATE（仅保留 `sequelizemeta` + `administrative_regions`）  
> **恢复时间**：2-4 小时（需重建所有配置、用户、活动）

### ⚠️ 方案B会清空的配置表（共24个，含业务核心配置数据）

| 表名 | 实际数据量 | 重要性 | 说明 |
|------|-----------|--------|------|
| `roles` | 11 条 | 🔴 必需 | 角色定义（含1条测试角色 `test_role_api`） |
| `system_settings` | 42 条 | 🔴 必需 | 系统配置（积分/安全/通知/市场等） |
| `system_configs` | 9 条 | 🔴 必需 | 批量限流/活动位置/商品筛选/反馈配置 |
| `material_asset_types` | 4 条 | 🔴 必需 | 资产类型定义（POINTS/BUDGET_POINTS/DIAMOND/red_shard） |
| `feature_flags` | 7 条 | 🔴 必需 | 功能开关（抽奖策略引擎） |
| `lottery_campaigns` | 4 条 | 🔴 必需 | 活动配置（ID=1 active，25/27 ended，26 paused） |
| `lottery_prizes` | 30 条 | 🔴 必需 | 奖品池定义（15个属于活动1，7+8个属于测试活动） |
| `category_defs` | 9 条 | 🟡 建议 | 物品类目字典 |
| `rarity_defs` | 5 条 | 🟡 建议 | 稀有度字典（common/uncommon/rare/epic/legendary） |
| `asset_group_defs` | 8 条 | 🟡 建议 | 资产组字典 |
| `lottery_tier_rules` | 9 条 | 🟡 建议 | 档位概率规则 |
| `lottery_strategy_config` | 17 条 | 🟡 建议 | 策略全局配置 |
| `lottery_tier_matrix_config` | 12 条 | 🟡 建议 | BxPx矩阵配置 |
| `lottery_draw_quota_rules` | 11 条 | 🟡 建议 | 配额规则 |
| `preset_debt_limits` | 1 条 | 🟡 建议 | 欠账上限（全局默认：库存1000件，预算1000000分） |
| `item_templates` | 16 条 | 🟡 建议 | 物品模板（物品奖品需要） |
| `stores` | 5 条 | 🟡 建议 | 门店配置（全部为测试门店） |
| `products` | 52 条 | 🟡 建议 | 商品配置 |
| `exchange_items` | 77 条 | 🟡 建议 | 兑换商品 |
| `system_dictionaries` | 369 条 | 🟡 建议 | 系统字典（73种字典类型的中文映射） |
| `lottery_campaign_pricing_config` | 13 条 | 🟡 建议 | 活动定价配置 |
| `material_conversion_rules` | 1 条 | 🟡 建议 | 资产转换规则（红晶片→钻石 1:20） |
| `user_risk_profiles` | 3 条 | 🟡 建议 | 风控级别配置 |
| `reminder_rules` | 3 条 | 🟡 建议 | 提醒规则配置 |

**🟡 建议数据不配置的后果**：
| 缺失数据 | 影响 |
|----------|------|
| 抽奖策略配置 | 抽奖仅使用基础概率，无Pity/LuckDebt等高级策略 |
| 物品模板 | 无法发放物品类型奖品，只能发放资产 |
| 门店/商品 | 消费功能不可用，用户无法通过消费获得积分 |
| 兑换商品 | 兑换功能不可用 |
| 系统字典 | 部分界面显示英文代码而非中文（73种字典类型丢失） |
| 系统配置 | 批量操作限流/活动位置/商品筛选等配置丢失 |
| 活动定价 | 抽奖定价配置丢失 |
| 风控配置 | 风控级别规则丢失 |
| 转换规则 | 红晶片→钻石转换功能不可用 |
| 提醒规则 | 系统提醒功能不可用 |

---

### ⚠️ 重建数据的执行顺序（有外键依赖，114条FK约束）

```
第一批：无外键依赖的基础字典（可并行）
  1. roles              ← 最先插入（user_roles、user_hierarchy 依赖它）
  2. asset_group_defs   ← 资产组字典（material_asset_types 依赖它）
  3. rarity_defs        ← 稀有度字典（item_templates、lottery_prizes 依赖它）
  4. category_defs      ← 类目字典（item_templates 依赖它）
  5. system_settings    ← 系统配置（42条）
  6. system_configs     ← 系统配置（9条JSON）
  7. feature_flags      ← 功能开关（7条）
  8. system_dictionaries ← 系统字典（369条/73种类型，可选但推荐）
  9. user_risk_profiles ← 风控级别（3条）

第二批：依赖第一批的配置表
  10. material_asset_types ← 资产类型（依赖 asset_group_defs.group_code）
  11. accounts           ← 🔴 手动INSERT 6个系统账户（不可迁移重建）
  12. lottery_campaigns  ← 活动配置（lottery_prizes 依赖它）
  13. lottery_strategy_config ← 策略配置（17条）
  14. lottery_tier_matrix_config ← BxPx矩阵（12条）
  15. lottery_draw_quota_rules ← 配额规则（11条）
  16. preset_debt_limits ← 欠账上限（1条）

第三批：依赖第二批的业务数据
  17. lottery_prizes    ← 奖品池（依赖 lottery_campaigns + rarity_defs）
  18. lottery_campaign_pricing_config ← 定价配置（依赖 lottery_campaigns）
  19. item_templates    ← 物品模板（依赖 category_defs + rarity_defs）
  20. material_conversion_rules ← 转换规则（依赖 material_asset_types）
  21. stores            ← 门店配置（可选）
  22. lottery_tier_rules ← 档位规则（依赖 lottery_campaigns）

第四批：用户数据
  23. [管理员手机号登录] ← 系统自动创建 users 记录
  24. user_roles        ← 关联管理员角色（依赖 users 和 roles）
```

---

### 🔴 必须准备的数据（否则系统无法启动）

#### 1️⃣ 管理员手机号
`____________`

⚠️ **重要**：用户登录会自动创建 `users` 记录，但**不会自动赋予admin角色**！

**当前数据库中的管理员**（清理后全部丢失）：
- user_id=31, 135, 11114, 11132（共4个admin角色用户）

**清空后授权管理员的完整步骤**：
```bash
# 步骤1：管理员用手机号登录系统（验证码123456），系统自动创建用户

# 步骤2：查询新建用户的user_id和admin角色的role_id
node -e "
require('dotenv').config();
const { sequelize } = require('./config/database');
(async () => {
  const [[user]] = await sequelize.query(\"SELECT user_id FROM users WHERE mobile='你的手机号'\");
  const [[role]] = await sequelize.query(\"SELECT role_id FROM roles WHERE role_name='admin'\");
  console.log('user_id:', user?.user_id, 'role_id:', role?.role_id);
  if (user && role) {
    console.log('执行SQL: INSERT INTO user_roles (user_id, role_id) VALUES (' + user.user_id + ', ' + role.role_id + ');');
  }
  await sequelize.close();
})();
"

# 步骤3：执行INSERT关联用户和角色
node -e "
require('dotenv').config();
const { sequelize } = require('./config/database');
(async () => {
  await sequelize.query('INSERT INTO user_roles (user_id, role_id) SELECT u.user_id, r.role_id FROM users u, roles r WHERE u.mobile=\"你的手机号\" AND r.role_name=\"admin\"');
  console.log('✅ 管理员角色已授权');
  await sequelize.close();
})();
"
```

#### 2️⃣ 角色定义（9条正式角色 + 2条其他，清理后需重建9条正式角色）

**字段说明**：
- `role_name`：角色唯一标识（代码中用此值判断权限）
- `role_level`：角色等级数值（数值越高权限越大，用于权限层级判断）

| role_name | role_level | 说明 |
|-----------|------------|------|
| `admin` | 100 | 管理员（最高权限） |
| `regional_manager` | 80 | 区域经理 |
| `business_manager` | 60 | 业务经理 |
| `merchant_manager` | 40 | 商户管理 |
| `sales_staff` | 40 | 业务员 |
| `ops` | 30 | 运营（只读） |
| `merchant_staff` | 20 | 商户员工 |
| `user` | 0 | 普通用户（默认角色） |
| `system_job` | -1 | 系统作业（后台定时任务专用，role_id=100） |

> ⚠️ 当前数据库还有: `campaign_2`(level=10, id=5) 和 `test_role_api`(level=15, id=107)，均为测试数据，重建时可忽略。

#### 3️⃣ 关键系统配置（严格模式，缺失会报错）

**`system_settings` 表当前实际数据（42条，按category分组）**：

**basic 基础配置**：
| setting_key | setting_value | 说明 |
|-------------|---------------|------|
| `system_name` | `测试` | 系统名称 |
| `system_version` | `v1.0.0` | 系统版本 |
| `customer_phone` | `400-999-8888` | 客服电话 |
| `customer_email` | `support@example.com` | 客服邮箱 |

**points 积分配置（核心）**：
| setting_key | setting_value | 说明 | 严格模式 |
|-------------|---------------|------|----------|
| `lottery_cost_points` | `100` | 单抽消耗100积分 | ✅ |
| `budget_allocation_ratio` | `0.22` | 消费返预算比例22% | ✅ |
| `daily_lottery_limit` | `10` | 每日抽奖上限 | ⚠️ 建议 |
| `initial_points` | `200` | 新用户初始积分 | |
| `sign_in_points` | `0` | 签到获得积分 | |
| `points_expire_days` | `365` | 积分有效天数 | |
| `merchant_review_budget_ratio` | `0.24` | 商户审核预算比例 | |
| `merchant_review_campaign_id` | `MERCHANT_REVIEW_DEFAULT` | 商户审核活动ID | |

**notification 通知配置**：
| setting_key | setting_value | 说明 |
|-------------|---------------|------|
| `sms_enabled` | `true` | 短信通知 |
| `email_enabled` | `false` | 邮件通知 |
| `app_notification_enabled` | `true` | APP通知 |

**security 安全配置**：
| setting_key | setting_value | 说明 |
|-------------|---------------|------|
| `max_login_attempts` | `5` | 最大登录尝试 |
| `lockout_duration` | `30` | 锁定时间(分钟) |
| `password_min_length` | `6` | 密码最小长度 |
| `api_rate_limit` | `100` | API限流 |

**marketplace 市场配置（20条）**：
| setting_key | setting_value | 说明 |
|-------------|---------------|------|
| `allowed_listing_assets` | `["DIAMOND","red_shard"]` | 允许挂牌的资产类型 |
| `allowed_settlement_assets` | `["DIAMOND","red_shard"]` | 允许结算的资产类型 |
| `max_active_listings` | `10` | 最大同时挂单数 |
| `listing_expiry_days` | `3` | 挂牌过期天数 |
| `fee_rate_DIAMOND` | `0.05` | 钻石手续费率(5%) |
| `fee_rate_red_shard` | `0.05` | 红晶片手续费率(5%) |
| `fee_min_DIAMOND` | `1` | 钻石最低手续费 |
| `fee_min_red_shard` | `1` | 红晶片最低手续费 |
| `daily_max_listings_DIAMOND` | `20` | 钻石每日最大挂牌数 |
| `daily_max_listings_red_shard` | `20` | 红晶片每日最大挂牌数 |
| `daily_max_trades_DIAMOND` | `10` | 钻石每日最大交易数 |
| `daily_max_trades_red_shard` | `10` | 红晶片每日最大交易数 |
| `daily_max_amount_DIAMOND` | `100000` | 钻石每日最大交易量 |
| `daily_max_amount_red_shard` | `50000` | 红晶片每日最大交易量 |
| `min_price_red_shard` | `1` | 红晶片最低价格 |
| `max_price_red_shard` | `1000000` | 红晶片最高价格 |
| `monitor_alert_enabled` | `true` | 市场监控告警开关 |
| `monitor_long_listing_days` | `7` | 长期挂牌告警天数 |
| `monitor_price_high_threshold` | `3.0` | 价格偏高告警阈值 |
| `monitor_price_low_threshold` | `0.1` | 价格偏低告警阈值 |

> 总计42条：basic(7) + points(8) + notification(3) + security(4) + marketplace(20)。

#### 4️⃣ 资产类型定义（4条）

**字段说明**：
- `asset_code`：资产唯一标识（代码中引用此值）
- `display_name`：中文显示名称
- `group_code`：所属资产组（FK → `asset_group_defs.group_code`）
- `is_tradable`：是否可交易（1=是，0=否）

| asset_code | display_name | group_code | is_tradable | 用途 |
|------------|-------------|------------|-------------|------|
| `POINTS` | 普通积分 | `points` | 0 | 消费获得，用于抽奖，is_enabled=0（通过system_settings控制） |
| `BUDGET_POINTS` | 预算积分 | `points` | 0 | 预算约束抽奖，按活动隔离 |
| `DIAMOND` | 钻石 | `currency` | 1 | 抽奖获得，可在市场挂单交易 |
| `red_shard` | 红色碎片 | `red` | 1 | 抽奖获得，可交易，可合成（1:20→钻石） |

#### 5️⃣ 功能开关（7条，控制抽奖策略引擎）

**字段说明**：
- `flag_key`：功能开关唯一标识
- `is_enabled`：是否启用（`1`=启用，`0`=禁用）
- `rollout_strategy`：当前全部为 `all`（全量发布）

| flag_key | is_enabled | related_config_group | 说明 |
|----------|------------|---------------------|------|
| `lottery_pity_system` | `1` | `pity` | **Pity保底**：连续空奖时逐步提升非空奖概率 |
| `lottery_luck_debt` | `1` | `luck_debt` | **运气债务**：基于用户历史空奖率的长期平衡调整 |
| `lottery_anti_empty_streak` | `1` | `anti_empty` | **防连续空奖**：连续K次空奖后强制发放非空奖 |
| `lottery_anti_high_streak` | `1` | `anti_high` | **防连续高价值**：防止短时间内连续获得高价值奖品 |
| `lottery_bxpx_matrix` | `1` | (null) | **BxPx矩阵调权**：根据预算分层和活动压力动态调整权重 |
| `lottery_budget_tier` | `1` | `budget_tier` | **预算分层控制**：B0-B3 四层预算分层机制 |
| `lottery_pressure_tier` | `1` | `pressure_tier` | **活动压力分层**：P0-P2 三层活动压力控制 |

#### 6️⃣ 活动与奖品

**当前活动数据（`lottery_campaigns`，4条）**：
| lottery_campaign_id | campaign_name | status | 奖品数 | 抽奖记录数 |
|---------------------|---------------|--------|--------|------------|
| 1 | 餐厅积分抽奖 | `active`（budget_mode=`user`） | 15 | 2177 |
| 25 | 走走走 | `ended` | 0 | 0 |
| 26 | 再找找 | `paused` | 7 | 0 |
| 27 | 12312 | `ended` | 8 | 0 |

> 活动1是主活动，ID 25/26/27 均为测试活动。重建时仅需创建主活动。

**活动1的奖品池（`lottery_prizes`，15条）**：
| lottery_prize_id | prize_name | prize_type | reward_tier | 说明 |
|-----------------|------------|------------|-------------|------|
| 1 | 八八折 | coupon | high | 优惠券 |
| 2 | 100积分 | points | mid | 积分奖品 |
| 3 | 甜品1份 | physical | mid | 实物 |
| 4 | 青菜1份 | physical | low | 实物 |
| 5 | 2000积分券 | points | high | 高价值积分 |
| 6 | 500积分券 | points | high | 中价值积分 |
| 7 | 精品首饰一个 | physical | mid | 实物 |
| 8 | 生腌拼盘158 | physical | mid | 实物 |
| 9 | 九八折券 | coupon | high | 优惠券 |
| 114 | 神秘彩蛋 | virtual | low | 虚拟空奖 |
| 115 | 好运加持 | virtual | low | 虚拟空奖 |
| 116 | 美食推荐 | virtual | low | 虚拟空奖 |
| 117 | 厨师祝福 | virtual | low | 虚拟空奖 |
| 118 | 下次好运 | virtual | low | 虚拟空奖 |
| 119 | 参与有礼 | virtual | low | 虚拟空奖 |

> 测试活动 26/27 的奖品（15条）均为测试数据（"测试奖品""自治州""123"等），重建时可忽略。

**重建活动配置字段说明**：
- `campaign_code`：活动唯一标识
- `campaign_type`：活动类型（当前均为 `event`）
- `budget_mode`：预算模式（`none`/`user`/`pool`）
- `status`：活动状态（`active`/`paused`/`ended`）

#### 7️⃣ 系统账户（迁移脚本自动创建）

**说明**：系统账户是资产流转的"对手方"，用于记账和审计。

| system_code | 说明 | 用途场景 |
|-------------|------|----------|
| `SYSTEM_PLATFORM_FEE` | 平台手续费账户 | 市场交易抽取手续费时记入 |
| `SYSTEM_MINT` | 系统发放账户 | 抽奖发放奖品、活动赠送资产时作为来源 |
| `SYSTEM_BURN` | 系统销毁账户 | 资产销毁、过期回收时作为去向 |
| `SYSTEM_ESCROW` | 托管账户 | 市场挂单冻结资产时暂存 |
| `SYSTEM_RESERVE` | 储备金账户 | 系统预留资产池 |
| `SYSTEM_CAMPAIGN_POOL` | 活动池预算账户 | 活动预算池模式下的预算来源 |

---

## 📋 使用场景

本文档适用于以下任何需要"恢复干净测试环境"的场景：

1. **架构重构前**：如实施预算积分体系、资产体系升级等
2. **脏数据清理**：测试过程中产生大量脏数据，影响后续测试
3. **功能验证准备**：需要干净的初始状态验证新功能
4. **环境重置**：定期恢复测试环境到已知状态
5. **性能测试准备**：清理历史数据，从已知基线开始测试

---

## 🔴 方案B必需信息速查（激进清理）

> 如果选择方案B（激进清理），执行前必须准备以下信息，否则系统无法正常运行。

### 1️⃣ 管理员账号（必需）

> 项目使用**手机号+验证码**登录。开发环境验证码固定为 `123456`。

| 字段 | 你的输入 | 是否必填 | 默认值 |
|------|----------|----------|--------|
| 手机号 | `____________` | ✅ 必填 | - |
| 昵称 | `____________` | ⚪ 可选 | `用户` + 手机号后4位 |
| 角色 | `____________` | ✅ 必填 | 普通用户需手动授权为 `admin` |

### 2️⃣ 关键配置参数（必需）

| 配置项 | 你的输入 | 推荐值 | 说明 |
|--------|----------|--------|------|
| `lottery_cost_points` | `____________` | `100` | 单抽消耗积分 |
| `budget_allocation_ratio` | `____________` | `0.22` | 消费返预算比例(22%) |
| `daily_lottery_limit` | `____________` | `10` | 每日抽奖上限 |

### 3️⃣ 活动配置（必需）

| 字段 | 你的输入 | 示例 |
|------|----------|------|
| 活动代码 | `____________` | `BASIC_LOTTERY` |
| 活动名称 | `____________` | `基础抽奖活动` |
| 预算模式 | `____________` | `none` / `user` / `pool` |
| 单抽消耗 | `____________` | `100` |

### 4️⃣ 奖品池配置（必需，至少5个）

> ⚠️ **prize_type 实际枚举**：`points`/`coupon`/`physical`/`virtual`/`service`/`product`/`special`

| 奖品名称 | prize_type | reward_tier | 说明 |
|----------|-----------|-------------|------|
| `____________` | `virtual` | `low` | 空奖/安慰奖（必需，占大比例） |
| `____________` | `points` | `mid` | 积分奖品 |
| `____________` | `points` | `high` | 高价值积分 |
| `____________` | `coupon` | `high` | 优惠券 |
| `____________` | `physical` | `mid` | 实物奖品 |

### 5️⃣ 资产类型（必需）

| asset_code | 显示名称 | 是否必需 |
|------------|----------|----------|
| `POINTS` | 普通积分 | ✅ 必需 |
| `BUDGET_POINTS` | 预算积分 | ✅ 必需 |
| `DIAMOND` | 钻石 | ⚠️ 有交易市场则必需 |
| `red_shard` | 红色碎片 | ⚠️ 有合成功能则必需 |

### 6️⃣ 系统账户（⚠️ 必须手动重建，不可重跑迁移）

> 🔴 **关键警告**：`sequelizemeta` 保留了 332 条迁移记录，Sequelize 认为所有迁移已执行过，`db:migrate` 不会重新创建系统账户。  
> 原始迁移文件已归档到 `migrations/archive/v1-legacy/`。  
> `BalanceService.getOrCreateAccount({system_code})` **不会自动创建**系统账户，缺失会直接报错：  
> `系统账户不存在：system_code=xxx，请检查数据库初始化`

**必须手动 INSERT 6 个系统账户**（account_id 让数据库自增）：

| system_code | account_type | 说明 |
|-------------|-------------|------|
| `SYSTEM_PLATFORM_FEE` | `system` | 平台手续费账户（交易手续费入账） |
| `SYSTEM_MINT` | `system` | 系统发放账户（抽奖发放、活动赠送来源） |
| `SYSTEM_BURN` | `system` | 系统销毁账户（过期回收去向） |
| `SYSTEM_ESCROW` | `system` | 托管账户（市场挂单冻结暂存） |
| `SYSTEM_RESERVE` | `system` | 储备金账户（系统预留资产池） |
| `SYSTEM_CAMPAIGN_POOL` | `system` | 活动池预算账户（pool预算模式来源） |

---

## 🎯 方案选择

### 方案 A：保守清理（日常推荐）

**保留**：配置数据、管理员账号、活动配置、用户基础信息、系统账户、策略配置、功能开关、字典数据  
**清理**：用户资产余额/流水、抽奖记录、消费记录、交易记录、监控指标、操作日志、**运营内容**（公告/Banner）、**用户关系数据**（层级/员工）

**适合场景**：

- 日常测试后恢复干净环境
- 验证新功能但不想重新配置系统
- 保留测试账号和系统配置

**执行时间**：5-10 分钟  
**恢复时间**：无需恢复（配置和账号都保留）

---

### 方案 B：激进清理（深度重置）

**保留**：仅保留数据库结构（80 张表的 schema）+ 迁移记录 + 行政区划字典  
**清理**：所有业务数据（包括配置、管理员、用户、活动）

**适合场景**：

- 完全从零开始
- 系统配置本身有问题需要重建
- 模拟"新系统首次启动"

**执行时间**：10-15 分钟  
**恢复时间**：2-4 小时（需要重建所有配置、用户、活动）

---

## 📊 数据库表分类概览（80张表）

### 🏗️ 表分类速查

#### 一、账户与资产体系（6张）
| 表名 | 说明 | 实际行数 | 方案A | 方案B |
|------|------|----------|-------|-------|
| `users` | 用户基础信息 | 60 | 保留 | 清空 |
| `accounts` | 账户主体（用户56+系统） | 56 | 保留系统账户 | 清空 |
| `account_asset_balances` | 资产余额 | 42 | 清空 | 清空 |
| `asset_transactions` | 资产流水 | 24,991 | 清空 | 清空 |
| `user_premium_status` | 高级空间状态 | 1 | 清空 | 清空 |
| `user_risk_profiles` | 风控配置 | 3 | 保留 | 清空 |

#### 二、角色权限体系（4张）
| 表名 | 说明 | 实际行数 | 方案A | 方案B |
|------|------|----------|-------|-------|
| `roles` | 角色定义 | 11 | 保留 | 清空 |
| `user_roles` | 用户角色关系 | 53 | 保留 | 清空 |
| `user_role_change_records` | 角色变更记录 | 237 | 清空 | 清空 |
| `user_status_change_records` | 状态变更记录 | 237 | 清空 | 清空 |

#### 三、抽奖核心系统（8张）
| 表名 | 说明 | 实际行数 | 方案A | 方案B |
|------|------|----------|-------|-------|
| `lottery_campaigns` | 活动配置 | 4 | 保留 | 清空 |
| `lottery_prizes` | 奖品池定义 | 30 | 保留 | 清空 |
| `lottery_draws` | 抽奖记录 | 2,177 | 清空 | 清空 |
| `lottery_draw_decisions` | 抽奖决策快照 | 2,177 | 清空 | 清空 |
| `lottery_presets` | 预设配置 | 3 | 清空 | 清空 |
| `lottery_management_settings` | 管理员干预规则 | 2,814 | 清空 | 清空 |
| `lottery_clear_setting_records` | 清除设置记录 | 634 | 清空 | 清空 |
| `lottery_campaign_pricing_config` | 活动定价配置 | 13 | 保留 | 清空 |

#### 四、抽奖策略引擎（10张）
| 表名 | 说明 | 实际行数 | 方案A | 方案B |
|------|------|----------|-------|-------|
| `lottery_tier_rules` | 档位概率规则 | 9 | 保留 | 清空 |
| `lottery_strategy_config` | 策略全局配置 | 17 | 保留 | 清空 |
| `lottery_tier_matrix_config` | BxPx矩阵配置 | 12 | 保留 | 清空 |
| `lottery_draw_quota_rules` | 配额规则 | 11 | 保留 | 清空 |
| `lottery_user_daily_draw_quota` | 每日抽奖配额 | 16 | 清空 | 清空 |
| `lottery_campaign_user_quota` | 活动用户配额 | 0 | 清空 | 清空 |
| `lottery_campaign_quota_grants` | 配额赠送记录 | 0 | 清空 | 清空 |
| `lottery_user_experience_state` | 用户体验状态(Pity) | 1 | 清空 | 清空 |
| `lottery_user_global_state` | 全局统计(LuckDebt) | 1 | 清空 | 清空 |
| `feature_flags` | 功能开关 | 7 | 保留 | 清空 |

#### 五、抽奖监控告警（4张）
| 表名 | 说明 | 实际行数 | 方案A | 方案B |
|------|------|----------|-------|-------|
| `lottery_hourly_metrics` | 小时级监控指标 | 64 | 清空 | 清空 |
| `lottery_daily_metrics` | 日报统计 | 11 | 清空 | 清空 |
| `lottery_alerts` | 抽奖系统告警 | 3 | 清空 | 清空 |
| `preset_debt_limits` | 欠账上限配置 | 1 | 保留 | 清空 |

#### 六、系统垫付（欠账）（2张）
| 表名 | 说明 | 实际行数 | 方案A | 方案B |
|------|------|----------|-------|-------|
| `preset_inventory_debt` | 库存欠账 | 0 | 清空 | 清空 |
| `preset_budget_debt` | 预算欠账 | 0 | 清空 | 清空 |

#### 七、物品与背包系统（6张）
| 表名 | 说明 | 实际行数 | 方案A | 方案B |
|------|------|----------|-------|-------|
| `item_templates` | 物品模板定义 | 16 | 保留 | 清空 |
| `item_instances` | 物品实例 | 6,144 | 清空 | 清空 |
| `item_instance_events` | 物品事件溯源 | 4,796 | 清空 | 清空 |
| `category_defs` | 类目字典 | 9 | 保留 | 清空 |
| `rarity_defs` | 稀有度字典 | 5 | 保留 | 清空 |
| `asset_group_defs` | 资产组字典 | 8 | 保留 | 清空 |

#### 八、交易市场系统（3张）
| 表名 | 说明 | 实际行数 | 方案A | 方案B |
|------|------|----------|-------|-------|
| `market_listings` | 市场挂牌 | 275 | 清空 | 清空 |
| `trade_orders` | 交易订单 | 118 | 清空 | 清空 |
| `redemption_orders` | 核销订单 | 1,184 | 清空 | 清空 |

#### 九、兑换与消费系统（4张）
| 表名 | 说明 | 实际行数 | 方案A | 方案B |
|------|------|----------|-------|-------|
| `exchange_items` | 兑换商品配置 | 77 | 保留 | 清空 |
| `exchange_records` | 兑换记录 | 0 | 清空 | 清空 |
| `consumption_records` | 消费记录 | 48 | 清空 | 清空 |
| `content_review_records` | 内容审核记录 | 422 | 清空 | 清空 |

#### 十、商户与门店系统（5张）
| 表名 | 说明 | 实际行数 | 方案A | 方案B |
|------|------|----------|-------|-------|
| `stores` | 门店配置 | 5 | 保留 | 清空 |
| `store_staff` | 门店员工关系 | 3 | 清空 | 清空 |
| `products` | 商品配置 | 52 | 保留 | 清空 |
| `user_hierarchy` | 用户层级关系 | 9 | 清空 | 清空 |
| `administrative_regions` | 行政区划字典（只读） | 44,703 | 保留 | **保留** |

#### 十一、材料资产系统（2张）
| 表名 | 说明 | 实际行数 | 方案A | 方案B |
|------|------|----------|-------|-------|
| `material_asset_types` | 资产类型定义 | 4 | 保留 | 清空 |
| `material_conversion_rules` | 资产转换规则 | 1 | 保留 | 清空 |

#### 十二、系统配置（5张）
| 表名 | 说明 | 实际行数 | 方案A | 方案B |
|------|------|----------|-------|-------|
| `system_settings` | 系统设置 | 42 | 保留 | 清空 |
| `system_configs` | 系统配置 | 9 | 保留 | 清空 |
| `system_dictionaries` | 系统字典 | 369 | 保留 | 清空 |
| `system_dictionary_history` | 字典变更历史 | 0 | 清空 | 清空 |
| `system_announcements` | 系统公告 | 73 | 清空 | 清空 |

#### 十三、客服聊天系统（2张）
| 表名 | 说明 | 实际行数 | 方案A | 方案B |
|------|------|----------|-------|-------|
| `customer_service_sessions` | 客服会话 | 15 | 清空 | 清空 |
| `chat_messages` | 聊天消息 | 448 | 清空 | 清空 |

#### 十四、审计与日志系统（7张）
| 表名 | 说明 | 实际行数 | 方案A | 方案B |
|------|------|----------|-------|-------|
| `admin_operation_logs` | 管理员操作日志 | 5,540 | 清空 | 清空 |
| `merchant_operation_logs` | 商户操作日志 | 97 | 清空 | 清空 |
| `batch_operation_logs` | 批量操作日志 | 11 | 清空 | 清空 |
| `risk_alerts` | 风控告警 | 9 | 清空 | 清空 |
| `api_idempotency_requests` | 幂等请求记录 | 29,285 | 清空 | 清空 |
| `authentication_sessions` | 认证会话 | 5 | 清空 | 清空 |
| `websocket_startup_logs` | WebSocket启动日志 | 1,921 | 清空 | 清空 |

#### 十五、提醒与报告系统（4张，新增）
| 表名 | 说明 | 实际行数 | 方案A | 方案B |
|------|------|----------|-------|-------|
| `reminder_rules` | 提醒规则配置 | 3 | 保留 | 清空 |
| `reminder_history` | 提醒历史记录 | 357 | 清空 | 清空 |
| `report_templates` | 报告模板 | 2 | 保留 | 清空 |
| `alert_silence_rules` | 告警静默规则 | 0 | 清空 | 清空 |

#### 十六、竞拍系统（2张，新增，空表）
| 表名 | 说明 | 实际行数 | 方案A | 方案B |
|------|------|----------|-------|-------|
| `bid_products` | 竞拍商品 | 0 | 清空 | 清空 |
| `bid_records` | 竞拍记录 | 0 | 清空 | 清空 |

#### 十七、其他（6张）
| 表名 | 说明 | 实际行数 | 方案A | 方案B |
|------|------|----------|-------|-------|
| `feedbacks` | 用户反馈 | 153 | 清空 | 清空 |
| `popup_banners` | 弹窗Banner | 2 | 清空 | 清空 |
| `image_resources` | 图片资源 | 0 | 清空 | 清空 |
| `admin_notifications` | 管理员通知 | 0 | 清空 | 清空 |
| `user_behavior_tracks` | 用户行为追踪 | 0 | 清空 | 清空 |
| `sequelizemeta` | 迁移记录（332条） | 332 | **保留** | **保留** |

---

## 📊 方案 A：保守清理（详细清单）

### ✅ 会保留的数据（约31张表）

#### 1. 账号与权限体系（保留）

| 表名 | 说明 | 清理规则 |
|------|------|----------|
| `users` | 用户基础信息（60条） | 全部保留 |
| `roles` | 角色定义（11个角色） | 全部保留 |
| `user_roles` | 用户角色关系（53条） | 全部保留 |
| `accounts` | 账户主体（56条） | **仅保留系统账户**（删除用户账户） |

**系统账户清单（6个，必须保留）**：

| system_code | 说明 | 用途 |
|-------------|------|------|
| `SYSTEM_PLATFORM_FEE` | 平台手续费账户 | 交易手续费入账 |
| `SYSTEM_MINT` | 系统发放账户 | 积分发放源头 |
| `SYSTEM_BURN` | 系统销毁账户 | 积分销毁目标 |
| `SYSTEM_ESCROW` | 托管账户 | 交易托管/争议 |
| `SYSTEM_RESERVE` | 储备金账户 | 系统储备 |
| `SYSTEM_CAMPAIGN_POOL` | 活动池预算账户 | pool预算模式 |

**为什么保留系统账户**：

- `AssetService.getOrCreateAccount({system_code})` **不会自动创建**系统账户，缺失会直接报错：`系统账户不存在：system_code=xxx，请检查数据库初始化`
- 系统账户是迁移时通过 `20251215160000-create-accounts-table.js` 初始化的（已归档到 `migrations/archive/v1-legacy/`），清空后必须手动INSERT重建（sequelizemeta已有记录，不可通过 `db:migrate` 重建）

---

#### 2. 系统配置（保留）

| 表名 | 说明 | 清理规则 |
|------|------|----------|
| `system_settings` | 核心配置参数（42条） | 全部保留 |
| `system_configs` | 系统配置（9条） | 全部保留 |
| `system_dictionaries` | 系统字典（369条，73种类型） | 全部保留 |

> ⚠️ `system_announcements`（73条系统公告）已移至清空列表，因为它是运营内容数据而非系统配置。

---

#### 3. 活动与奖品定义（保留）

| 表名 | 说明 | 清理规则 |
|------|------|----------|
| `lottery_campaigns` | 活动配置（4条） | 全部保留 |
| `lottery_prizes` | 奖品池定义（30条） | 全部保留 |
| `lottery_campaign_pricing_config` | 定价配置（13条） | 全部保留 |

---

#### 4. 抽奖策略配置（保留）

| 表名 | 说明 | 清理规则 |
|------|------|----------|
| `lottery_tier_rules` | 档位概率规则（9条） | 全部保留 |
| `lottery_strategy_config` | 策略全局配置（17条） | 全部保留 |
| `lottery_tier_matrix_config` | BxPx矩阵配置（12条） | 全部保留 |
| `lottery_draw_quota_rules` | 配额规则（11条） | 全部保留 |
| `feature_flags` | 功能开关（7条） | 全部保留 |
| `preset_debt_limits` | 欠账上限配置（1条） | 全部保留 |

---

#### 5. 字典与模板定义（保留）

| 表名 | 说明 |
|------|------|
| `item_templates` | 物品模板定义（16条） |
| `category_defs` | 类目字典（9条） |
| `rarity_defs` | 稀有度字典（5条） |
| `asset_group_defs` | 资产组字典（8条） |
| `material_asset_types` | 资产类型定义（4条） |
| `material_conversion_rules` | 资产转换规则（1条） |

---

#### 6. 商户与门店（保留）

| 表名 | 说明 |
|------|------|
| `stores` | 门店配置（5条） |
| `products` | 商品配置（52条） |
| `exchange_items` | 兑换商品配置（77条） |
| `administrative_regions` | 行政区划字典（44,703条，只读） |
| `user_risk_profiles` | 用户风控配置（3条） |

#### 7. 提醒与报告（保留）

| 表名 | 说明 |
|------|------|
| `reminder_rules` | 提醒规则配置（3条） |
| `report_templates` | 报告模板（2条） |

---

### 🗑️ 会清空的数据（约49张表）

#### 1. 资产账本（核心清理）

| 表名 | 说明 | 实际行数 | 影响 |
|------|------|----------|------|
| `accounts` | 账户主体 | 56 | **仅删除用户账户**，保留系统账户 |
| `account_asset_balances` | 资产余额 | 42 | 所有余额清零 |
| `asset_transactions` | 资产流水 | 24,991 | 所有流水清空 |
| `user_premium_status` | 高级空间状态 | 1 | 清空 |

---

#### 2. 抽奖记录与状态

| 表名 | 实际行数 |
|------|----------|
| `lottery_draws` | 2,177 |
| `lottery_draw_decisions` | 2,177 |
| `lottery_management_settings` | 2,814 |
| `lottery_clear_setting_records` | 634 |
| `lottery_presets` | 3 |
| `lottery_user_daily_draw_quota` | 16 |
| `lottery_campaign_user_quota` | 0 |
| `lottery_campaign_quota_grants` | 0 |
| `lottery_user_experience_state` | 1 |
| `lottery_user_global_state` | 1 |

---

#### 3. 监控指标与告警

| 表名 | 实际行数 |
|------|----------|
| `lottery_hourly_metrics` | 64 |
| `lottery_daily_metrics` | 11 |
| `lottery_alerts` | 3 |
| `preset_inventory_debt` | 0 |
| `preset_budget_debt` | 0 |

---

#### 4. 物品与交易

| 表名 | 实际行数 |
|------|----------|
| `item_instances` | 6,144 |
| `item_instance_events` | 4,796 |
| `market_listings` | 275 |
| `trade_orders` | 118 |
| `redemption_orders` | 1,184 |
| `exchange_records` | 0 |

---

#### 5. 消费与审核

| 表名 | 实际行数 |
|------|----------|
| `consumption_records` | 48 |
| `content_review_records` | 422 |

---

#### 6. 客服聊天

| 表名 | 实际行数 |
|------|----------|
| `chat_messages` | 448 |
| `customer_service_sessions` | 15 |

---

#### 7. 审计与日志

| 表名 | 实际行数 |
|------|----------|
| `admin_operation_logs` | 5,540 |
| `merchant_operation_logs` | 97 |
| `batch_operation_logs` | 11 |
| `risk_alerts` | 9 |
| `api_idempotency_requests` | 29,285 |
| `authentication_sessions` | 5 |
| `websocket_startup_logs` | 1,921 |
| `user_role_change_records` | 237 |
| `user_status_change_records` | 237 |
| `system_dictionary_history` | 0 |

---

#### 8. 运营内容与反馈

| 表名 | 实际行数 |
|------|----------|
| `feedbacks` | 153 |
| `system_announcements` | 73 |
| `popup_banners` | 2 |
| `image_resources` | 0 |
| `admin_notifications` | 0 |

---

#### 9. 用户关系、提醒、竞拍与行为追踪

| 表名 | 实际行数 |
|------|----------|
| `store_staff` | 3 |
| `user_hierarchy` | 9 |
| `reminder_history` | 357 |
| `alert_silence_rules` | 0 |
| `bid_products` | 0 |
| `bid_records` | 0 |
| `user_behavior_tracks` | 0 |

---

### ⚠️ 方案 A 清理后需要你提供的数据

#### 🎯 必需提供（否则无法验证）

1. **测试用户信息**：
   - 提供 1-2 个用户的 `user_id` 或 `mobile`（从保留的用户中选）
   - 当前管理员用户：`user_id=31, 135, 11114, 11132`
   - 用途：用于验证"消费→审批→发放→抽奖"完整流程

2. **确认系统账户存在**：
   ```bash
   node -e "
   require('dotenv').config();
   const { sequelize } = require('./config/database');
   (async () => {
     const [rows] = await sequelize.query(\"SELECT system_code FROM accounts WHERE account_type='system'\");
     console.log('系统账户:', rows.map(r => r.system_code));
     await sequelize.close();
   })();
   "
   ```
   - 预期结果：至少包含 6 个系统账户

---

### 🔍 方案 A 清理后验证清单

#### 必需检查项（清理立即后）

- [ ] 数据库连接正常
- [ ] 表结构完整（80 张表）
- [ ] 系统账户存在（6 个：PLATFORM_FEE/MINT/BURN/ESCROW/RESERVE/CAMPAIGN_POOL）
- [ ] 用户账号存在
- [ ] 管理员权限正常（user_roles 保留）
- [ ] 系统配置存在（system_settings 42条）
- [ ] 活动奖品配置存在
- [ ] 功能开关配置存在（feature_flags 7个）
- [ ] 策略配置存在（lottery_strategy_config、lottery_tier_matrix_config）

---

## 📊 方案 B：激进清理（详细清单）

### ✅ 会保留的数据（仅2张表的数据）

| 保留内容 | 说明 |
|----------|------|
| 数据库结构 | 80 张表的 schema 保留 |
| 迁移记录 | `sequelizemeta` 表保留（332条已执行的迁移记录） |
| 行政区划 | `administrative_regions` 表保留（44,703条，只读字典） |

**其余所有 78 张业务数据表的数据全部清空**。

---

### 🗑️ 会清空的数据（78张表）

在方案 A 的约49张表基础上，额外清空以下约29张配置/定义表：

| 表名 | 说明 | 实际行数 | 影响 |
|------|------|----------|------|
| `users` | 用户基础信息 | 60 | 所有用户需重新注册 |
| `user_roles` | 用户角色关系 | 53 | 管理员需重新授权 |
| `roles` | 角色定义 | 11 | 角色需重新创建 |
| `accounts`（全部） | 账户主体 | 56 | 系统账户也清空，需手动INSERT重建（不可重跑迁移） |
| `system_settings` | 系统配置参数 | 42 | 关键配置需重新写入 |
| `system_configs` | 系统配置 | 9 | 需重新配置 |
| `system_dictionaries` | 系统字典 | 369 | 73种类型的中文映射丢失 |
| `lottery_campaigns` | 活动配置 | 4 | 需重新创建活动 |
| `lottery_prizes` | 奖品池定义 | 30 | 需重新配置奖品 |
| `lottery_presets` | 预设配置 | 3 | 需重新配置 |
| `lottery_campaign_pricing_config` | 定价配置 | 13 | 需重新配置 |
| `lottery_tier_rules` | 档位概率规则 | 9 | 需重新配置 |
| `lottery_strategy_config` | 策略全局配置 | 17 | 需重新配置 |
| `lottery_tier_matrix_config` | BxPx矩阵配置 | 12 | 需重新配置 |
| `lottery_draw_quota_rules` | 配额规则 | 11 | 需重新配置 |
| `feature_flags` | 功能开关 | 7 | 需重新配置 |
| `preset_debt_limits` | 欠账上限配置 | 1 | 需重新配置 |
| `item_templates` | 物品模板定义 | 16 | 需重新配置 |
| `category_defs` | 类目字典 | 9 | 需重新初始化 |
| `rarity_defs` | 稀有度字典 | 5 | 需重新初始化 |
| `asset_group_defs` | 资产组字典 | 8 | 需重新初始化 |
| `material_asset_types` | 资产类型定义 | 4 | 需重新配置 |
| `material_conversion_rules` | 资产转换规则 | 1 | 需重新配置 |
| `stores` | 门店配置 | 5 | 需重新配置 |
| `products` | 商品配置 | 52 | 需重新配置 |
| `exchange_items` | 兑换商品配置 | 77 | 需重新配置 |
| `user_risk_profiles` | 用户风控配置 | 3 | 需重新配置 |
| `reminder_rules` | 提醒规则 | 3 | 需重新配置 |
| `report_templates` | 报告模板 | 2 | 需重新配置 |

---

### ⚠️ 方案 B 清理后需要你提供的数据（完整重建包）

#### 🔴 必需提供（否则系统无法启动）

##### 1. 管理员账号信息（至少 1 个）

> 项目使用**手机号+验证码**登录。开发环境验证码固定为 `123456`。

| 字段 | 说明 | 是否必填 | 默认值 |
|------|------|----------|--------|
| mobile | 管理员手机号 | ✅ 必填 | - |
| nickname | 显示名称 | ⚪ 可选 | `用户` + 手机号后4位 |
| role | 管理员角色 | ✅ 必填 | 新用户默认 `user`，需手动授权 `admin` |

**重建步骤**：
1. 用管理员手机号登录（自动注册）
2. 通过数据库或迁移脚本将该用户授权为 `admin` 角色

---

##### 2. 系统配置参数（关键配置项）

**`system_settings` 表（42条）— 关键项**：

| 配置项 | 推荐值 | 值类型 | 说明 | 是否严格 |
|--------|--------|--------|------|----------|
| `lottery_cost_points` | `100` | number | 单抽积分消耗 | ✅ 严格模式 |
| `budget_allocation_ratio` | `0.22` | number | 消费返预算比例(22%) | ✅ 严格模式 |
| `daily_lottery_limit` | `10` | number | 每日抽奖次数上限 | ⚠️ 建议 |
| `initial_points` | `200` | number | 新用户初始积分 | ⚠️ 建议 |

> 完整42条配置按category分组：basic(7) + points(8) + notification(3) + security(4) + marketplace(20)，详见上方"关键系统配置"章节。

**`system_configs` 表（9条JSON配置）— 全部需重建**：

| config_key | config_category | 说明 |
|-----------|-----------------|------|
| `batch_rate_limit_quota_grant` | batch_operation | 批量赠送抽奖次数限流 |
| `batch_rate_limit_preset` | batch_operation | 批量设置干预规则限流 |
| `batch_rate_limit_redemption` | batch_operation | 批量核销确认限流 |
| `batch_rate_limit_campaign_status` | batch_operation | 批量活动状态切换限流 |
| `batch_rate_limit_budget` | batch_operation | 批量预算调整限流 |
| `batch_operation_global` | batch_operation | 批量操作全局配置（并发/重试/幂等键） |
| `campaign_placement` | feature | 活动位置配置（小程序展示位置） |
| `product_filter` | general | 兑换商品筛选配置（价格区间/排序/库存状态） |
| `feedback_config` | general | 反馈表单配置（类别/优先级/内容限制/附件） |

> ⚠️ `system_configs.config_value` 字段类型为 **JSON**（非纯字符串），重建时需用完整JSON对象。

---

##### 3. 活动与奖品定义（至少 1 套）

**活动定义**（`lottery_campaigns` 表）：

| 字段 | 格式 | 示例 |
|------|------|------|
| campaign_code | 字符串（唯一） | `BASIC_LOTTERY` |
| campaign_name | 字符串 | `基础抽奖活动` |
| campaign_type | 枚举 | `event` |
| start_time | 日期时间 | `2026-01-01 00:00:00` |
| end_time | 日期时间 | `2026-12-31 23:59:59` |
| status | 枚举 | `active` |
| budget_mode | 枚举 | `'user'`/`'pool'`/`'none'` |

**奖品定义**（`lottery_prizes` 表，至少 5-10 个）：

| 奖品名称 | prize_type | reward_tier | 说明 |
|----------|------------|-------------|------|
| 谢谢参与 | `virtual` | `low` | 空奖类型 |
| 100积分 | `points` | `mid` | 积分奖品 |
| 500积分券 | `points` | `high` | 高价值积分 |
| 八八折券 | `coupon` | `high` | 优惠券 |
| 甜品1份 | `physical` | `mid` | 实物奖品 |

> 参考当前活动1的15个奖品配置（见上方"活动1的奖品池"表格）。

---

##### 4. 资产类型定义（必需4条）

| asset_code | 用途 | 是否必需 |
|------------|------|----------|
| `POINTS` | 抽奖门票、消费返还 | ✅ 必需 |
| `BUDGET_POINTS` | 预算约束抽奖 | ✅ 必需 |
| `DIAMOND` | 交易市场货币 | ⚠️ 如有交易市场功能必需 |
| `red_shard` | 材料资产、可合成 | ⚠️ 如有合成功能必需 |

---

##### 5. 系统账户（清理后必须手动重建）

> 🔴 **不可重跑迁移**：`sequelizemeta` 表保留（332条记录），Sequelize CLI 认为迁移已执行过。  
> 原始迁移文件 `20251215160000-create-accounts-table.js` 已归档到 `migrations/archive/v1-legacy/`。  
> **必须通过 Node.js 脚本手动 INSERT 6 个系统账户**（SYSTEM_PLATFORM_FEE / SYSTEM_MINT / SYSTEM_BURN / SYSTEM_ESCROW / SYSTEM_RESERVE / SYSTEM_CAMPAIGN_POOL）。

---

##### 6. 角色定义（必需9条正式角色）

| role_name | description | role_level |
|-----------|-------------|------------|
| `admin` | 管理员 | 100 |
| `regional_manager` | 区域经理 | 80 |
| `business_manager` | 业务经理 | 60 |
| `sales_staff` | 业务员 | 40 |
| `merchant_manager` | 商户管理 | 40 |
| `ops` | 运营（只读） | 30 |
| `merchant_staff` | 商户员工 | 20 |
| `user` | 普通用户 | 0 |
| `system_job` | 系统作业（role_id 建议设为100） | -1 |

---

##### 7. 功能开关（7条抽奖策略开关）

| flag_key | flag_name | is_enabled | related_config_group |
|----------|-----------|------------|---------------------|
| `lottery_pity_system` | Pity 软保底机制 | `1` | `pity` |
| `lottery_luck_debt` | 运气债务机制 | `1` | `luck_debt` |
| `lottery_anti_empty_streak` | 防连续空奖机制 | `1` | `anti_empty` |
| `lottery_anti_high_streak` | 防连续高价值机制 | `1` | `anti_high` |
| `lottery_bxpx_matrix` | BxPx 矩阵调权 | `1` | (null) |
| `lottery_budget_tier` | 预算分层控制 | `1` | `budget_tier` |
| `lottery_pressure_tier` | 活动压力分层 | `1` | `pressure_tier` |

##### 8. 抽奖策略配置（17条，功能开关依赖的详细参数）

**`lottery_strategy_config` 表（17条，按 config_group 分组）**：

| config_group | config_key | config_value | 说明 |
|-------------|-----------|-------------|------|
| `budget_tier` | `threshold_high` | `1000` | 预算高阈值 |
| `budget_tier` | `threshold_mid` | `500` | 预算中阈值 |
| `budget_tier` | `threshold_low` | `100` | 预算低阈值 |
| `pressure_tier` | `threshold_high` | `0.8` | 压力高阈值 |
| `pressure_tier` | `threshold_low` | `0.5` | 压力低阈值 |
| `pity` | `enabled` | `true` | Pity开关 |
| `pity` | `hard_guarantee_threshold` | `10` | 硬保底阈值（连续10次空奖必中） |
| `pity` | `min_non_empty_cost` | `10` | 最低非空奖成本 |
| `pity` | `multiplier_table` | `{"0":1,"1":1,"2":1.2,...,"9":10}` | 连续空奖概率提升表 |
| `luck_debt` | `enabled` | `true` | 运气债务开关 |
| `luck_debt` | `expected_empty_rate` | `0.3` | 预期空奖率(30%) |
| `luck_debt` | `min_draw_count` | `10` | 最少抽奖次数（低于此数不触发） |
| `anti_empty` | `enabled` | `true` | 防连续空奖开关 |
| `anti_empty` | `empty_streak_threshold` | `3` | 连续空奖阈值（3次后强制非空） |
| `anti_high` | `enabled` | `true` | 防连续高价值开关 |
| `anti_high` | `recent_draw_window` | `5` | 近期抽奖窗口(5次) |
| `anti_high` | `high_streak_threshold` | `2` | 高价值连续阈值(2次) |

> ⚠️ 缺少策略配置不会导致系统崩溃，但抽奖仅使用基础概率，无 Pity/LuckDebt/防连续空奖等高级策略。

---

### 🔍 方案 B 清理后验证清单

#### 必需检查项（提供数据并重建后）

- [ ] 数据库连接正常
- [ ] 表结构完整（80 张表）
- [ ] **系统账户已手动INSERT重建**（6 个，不可通过db:migrate重建）
- [ ] **管理员账号已创建**（至少 1 个）
- [ ] **系统配置已写入**（至少 lottery_cost_points + budget_allocation_ratio）
- [ ] **活动奖品已配置**（至少 1 个活动 + 奖品池）
- [ ] **资产类型已定义**（至少 POINTS/BUDGET_POINTS）
- [ ] **角色定义已创建**（至少9条正式角色）
- [ ] **功能开关已配置**（7个抽奖策略开关）
- [ ] 迁移记录完整（`sequelizemeta` 332条）
- [ ] 行政区划完整（`administrative_regions` 44,703条）

#### 功能验证（必需）

- [ ] 管理员可登录管理后台
- [ ] 用户可注册新账号
- [ ] 消费审批可发放积分
- [ ] 抽奖功能可正常使用
- [ ] 交易市场可正常使用（如果有此功能）

---

## 📋 方案 A vs 方案 B 对比清单

| 维度 | 方案 A（保守） | 方案 B（激进） |
|------|----------------|----------------|
| **清理表数** | 约49张（只清业务数据） | 78张（清配置+业务） |
| **保留用户账号** | ✅ 是（60个用户） | ❌ 否 |
| **保留管理员** | ✅ 是（4个admin） | ❌ 否 |
| **保留系统账户** | ✅ 是（6 个） | ❌ 否 |
| **保留系统配置** | ✅ 是（42+9条） | ❌ 否 |
| **保留活动配置** | ✅ 是（4活动30奖品） | ❌ 否 |
| **保留策略配置** | ✅ 是 | ❌ 否 |
| **保留功能开关** | ✅ 是（7个） | ❌ 否 |
| **保留字典数据** | ✅ 是（369条/73种类型） | ❌ 否 |
| **清理用户资产** | ✅ 是 | ✅ 是 |
| **清理抽奖记录** | ✅ 是（2177条） | ✅ 是 |
| **清理操作日志** | ✅ 是（5540+条） | ✅ 是 |
| **执行后可登录** | ✅ 是（需重新登录） | ❌ 否（需重建管理员） |
| **执行后可抽奖** | ✅ 是（需充值资产） | ❌ 否（需重建活动） |
| **恢复成本** | 无（配置都保留） | 极高（2-4 小时） |

---

## 🛠️ 项目已有的清理脚本

### 历史数据清理脚本

项目中已存在 `scripts/database/cleanup_historical_data.js`，功能如下：

- **用途**：按时间分界线清理历史数据
- **支持预览模式**：`DRY_RUN=true` 查看影响但不实际删除
- **按外键依赖顺序删除**：避免外键约束报错

**使用方式**：

```bash
# 预览模式（查看影响）
DRY_RUN=true node scripts/database/cleanup_historical_data.js

# 实际执行
node scripts/database/cleanup_historical_data.js
```

**涉及表**：
- `item_instance_events`
- `redemption_orders`
- `market_listings`
- `trade_orders`
- `item_instances`
- `exchange_records`
- `content_review_records`
- `consumption_records`
- `lottery_draws`

---

## 🚨 风险提示

### 方案 A 的风险

| 风险类型 | 影响 | 说明 |
|----------|------|------|
| 资产数据丢失 | ⚠️ 中等 | 所有用户的资产余额和流水清零（24,991条流水） |
| 历史记录丢失 | ⚠️ 中等 | 抽奖/消费/交易/聊天的历史记录丢失 |
| 策略状态重置 | ⚠️ 低 | Pity计数器、LuckDebt乘数重置 |
| 账户关联重建 | ⚠️ 低 | 用户的 `account_id` 会变化 |
| 会话失效 | ⚠️ 低 | 用户需要重新登录 |
| 系统账户丢失 | ❌ 无 | **系统账户保留**，不受影响 |

---

### 方案 B 的额外风险

| 风险类型 | 影响 | 说明 |
|----------|------|------|
| 无法登录管理后台 | 🔴 高 | 管理员账号被清空，必须重建 |
| 系统配置丢失 | 🔴 高 | 42+9条配置参数丢失，必须重新写入 |
| 活动奖品丢失 | 🔴 高 | 4个活动和30个奖品定义丢失，必须重新创建 |
| 策略配置丢失 | 🔴 高 | 抽奖策略配置丢失（17+12+11+9条），必须重新配置 |
| 功能开关丢失 | 🔴 高 | 7个功能开关丢失，必须重新配置 |
| 系统账户丢失 | 🔴 高 | 系统账户被清空，必须手动INSERT重建（不可重跑迁移） |
| 系统字典丢失 | 🔴 高 | 73种字典类型（369条）丢失，界面显示英文代码 |
| 恢复成本 | 🔴 极高 | 需要 2-4 小时重建整个系统 |

---

## 📝 执行清理的方式（Node.js only）

### 执行约束

1. **不使用 mysql 客户端**：所有操作通过 Node.js 执行
2. **连接真实 `.env` 库**：使用 `require('dotenv').config()` + `require('./config/database').sequelize`
3. **执行前核对**：先运行数据库连接测试确认连接的是测试库

### 执行原则（不含代码实现）

**方案 A 执行步骤**：

1. 连接 `.env` 指向的真实数据库
2. 执行 `SET FOREIGN_KEY_CHECKS = 0;`
3. 对约49张业务表执行 `TRUNCATE TABLE`（但 `accounts` 只删 `account_type='user'` 的记录）
4. 执行 `SET FOREIGN_KEY_CHECKS = 1;`
5. 验证系统账户仍存在（6 个）
6. 验证系统配置仍存在（关键配置）

**方案 B 执行步骤**：

1. 连接 `.env` 指向的真实数据库（`restaurant_points_dev @ dbconn.sealosbja.site:42569`）
2. 执行 `SET FOREIGN_KEY_CHECKS = 0;`
3. 对 78 张表执行 `TRUNCATE TABLE`（保留 `sequelizemeta` 和 `administrative_regions`）
4. 执行 `SET FOREIGN_KEY_CHECKS = 1;`
5. **手动 INSERT 系统账户**（⚠️ 不可重跑迁移，sequelizemeta 已记录 332 条迁移）
6. 根据你提供的数据按外键依赖顺序重建：角色 → 资产组字典 → 稀有度字典 → 类目字典 → 资产类型 → 系统配置 → 功能开关 → 活动 → 奖品 → 管理员登录+授权

> ⚠️ 注意外键依赖顺序：数据库有 114 条 FK 约束，TRUNCATE 前必须禁用 FK 检查。

---

### 验证脚本命令

```bash
# 1. 检查数据库连接和表数量
node -e "
require('dotenv').config();
const { sequelize } = require('./config/database');
(async () => {
  await sequelize.authenticate();
  const [tables] = await sequelize.query('SHOW TABLES');
  console.log('✅ 数据库连接成功，表数量:', tables.length);
  await sequelize.close();
})();
"

# 2. 检查系统账户完整性
node -e "
require('dotenv').config();
const { sequelize } = require('./config/database');
(async () => {
  const [rows] = await sequelize.query(\"SELECT system_code FROM accounts WHERE account_type='system'\");
  console.log('系统账户:', rows.map(r => r.system_code));
  await sequelize.close();
})();
"

# 3. 检查关键配置
node -e "
require('dotenv').config();
const { sequelize } = require('./config/database');
(async () => {
  const [rows] = await sequelize.query(\"SELECT setting_key, setting_value FROM system_settings WHERE setting_key IN('lottery_cost_points','budget_allocation_ratio','daily_lottery_limit')\");
  console.table(rows);
  await sequelize.close();
})();
"

# 4. 检查功能开关
node -e "
require('dotenv').config();
const { sequelize } = require('./config/database');
(async () => {
  const [rows] = await sequelize.query('SELECT flag_key, is_enabled FROM feature_flags');
  console.table(rows);
  await sequelize.close();
})();
"

# 5. 资产域一致性验证
node scripts/verify-asset-domain.js

# 6. 抽奖账本一致性验证
node scripts/diagnostic/verify_lottery_ledger.js
```

---

## 🎯 快速决策指南

### 场景 1：日常测试后恢复环境

**推荐方案**：方案 A  
**理由**：保留配置和用户，只清理业务数据  
**你需要提供**：测试用户 ID（当前管理员：`user_id=31, 135, 11114, 11132`）

---

### 场景 2：重大架构重构

**推荐方案**：方案 A  
**理由**：清理资产和业务数据，为新架构提供干净基础  
**你需要提供**：测试用户 ID、活动预算模式确认

---

### 场景 3：系统配置本身有问题

**推荐方案**：方案 B  
**理由**：完全重置，重新配置所有参数  
**你需要提供**：完整重建包（管理员、角色、配置、功能开关、活动、奖品、资产类型）

---

## 🔑 核心要点总结

### 方案 A（保守清理）

**清理对象**：约49张业务数据表  
**保留对象**：配置、用户、系统账户、活动定义、策略配置、功能开关、字典数据（不含运营内容和用户关系数据）

**你需要提供**：
- ✅ 测试用户 ID（1-2 个，当前管理员 `user_id=31, 135, 11114, 11132`）
- 可选：初始资产充值金额
- 可选：活动预算模式确认

**清理后状态**：
- ✅ 可以登录（需重新登录）
- ✅ 可以抽奖（需先充值资产）
- ✅ 配置完整（无需重建）
- ✅ 策略配置保留（用户体验状态重置）

---

### 方案 B（激进清理）

**清理对象**：78张表（配置+业务）  
**保留对象**：仅表结构 + 迁移记录(332条) + 行政区划字典(44,703条)

**你需要提供**：
- ✅ 管理员账号（mobile/nickname/role，验证码登录无需密码）
- ✅ 角色定义（9条正式角色）
- ✅ 关键配置（lottery_cost_points / budget_allocation_ratio 等42条，含20条marketplace配置）
- ✅ 功能开关配置（7个抽奖策略开关）
- ✅ 活动与奖品（至少 1 套完整定义）
- ✅ 资产类型（POINTS/BUDGET_POINTS/DIAMOND/red_shard 共4条）

**清理后状态**：
- ❌ 无法登录（需重建管理员）
- ❌ 无法抽奖（需重建活动）
- ❌ 配置丢失（需全部重建）

---

## 📌 你的决策

**请明确告知以下信息**：

### 1. 选择方案

- [ ] 方案 A（保守清理）
- [x] 方案 B（激进清理）

---

### 2. 如果选方案 A，提供以下信息：

**必需提供**：

- 测试用户 ID 或 mobile：`_____________`
  - **推荐**：`31`（管理员用户）或 `135`（管理员用户）

**可选提供**：

- 初始 POINTS 充值：`_____________`（建议 1000-5000）
- 初始 DIAMOND 充值：`_____________`（建议 500-2000）
- 活动预算模式：`_____________`（当前活动1为 `'user'`）

---

### 3. 如果选方案 B，提供完整重建包

（见上方详细清单）

---

**提供以上信息后，我会生成精确的清理脚本和验证步骤。**
