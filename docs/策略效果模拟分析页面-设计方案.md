# 策略效果模拟分析页面 — 设计方案

> 生成日期：2026-02-20
> 决策确认日期：2026-02-20
> 数据库真实数据校验日期：2026-02-20（初始） → 2026-02-20（二次校验，数据已更新至 total_draws=2,634）
> 基于项目实际代码和数据库真实数据编写
> 状态：**全部 18 项决策已确认，待实施**

---

## 〇、数据库真实校验报告与字段勘误

> 以下为 2026-02-20 通过 Node.js 连接真实数据库 `restaurant_points_dev`（dbconn.sealosbja.site:42569）逐表校验的结果。

### 0.1 字段名勘误（文档原稿 → 数据库实际）

| 表 | 文档用名 | 数据库实际字段 | 说明 |
|---|---|---|---|
| `lottery_campaigns` | `name` | `campaign_name` | 主键 `lottery_campaign_id` |
| `lottery_tier_rules` | `weight` | `tier_weight` | INT UNSIGNED |
| `lottery_strategy_config` | `strategy_group` | `config_group` | VARCHAR(50) |
| `lottery_prizes` | `tier_name` | `reward_tier` | ENUM('high','mid','low') |
| `lottery_prizes` | `remaining_stock` | 需计算: `stock_quantity - total_win_count` | 无此物理列 |
| `lottery_user_experience_state` | `current_empty_streak` | `empty_streak` | INT |
| `lottery_prizes` | 九八折券 type=points | 实际 type=`coupon` | 类型写错 |

### 0.2 关键架构发现

| 发现 | 影响 | 决策 |
|---|---|---|
| `lottery_tier_matrix_config` **无 `lottery_campaign_id` 列**，是全局配置表 | 多活动场景无法隔离矩阵配置 | ✅ **决策已确认：加 `lottery_campaign_id` 列**（详见 Section 十六） |
| `lottery_strategy_config` **无 `lottery_campaign_id` 列**，也是全局配置表 | 多活动场景无法隔离策略配置 | ✅ **决策已确认：加 `lottery_campaign_id` 列**（详见 Section 十六） |
| `lottery_tier_rules` **有 `lottery_campaign_id` 列** | 基础权重已按活动隔离 | 无需改动 |
| `lottery_simulation_records` 表 **不存在** | 需新建 migration | Phase 1 新建 |
| `lottery_user_experience_state` 实际字段名 `empty_streak`（不是 `current_empty_streak`） | 用户旅程模拟需对齐 | 代码中使用正确字段名 |

### 0.3 数据准确性校验

> ⚠️ **数据漂移说明**：本文档初始校验时 total_draws=2,400，后续系统持续运行，截至最新校验 total_draws=2,634（+234 次抽奖）。Section 1 中所有数据已更新至最新值。策略配置(1.7)、矩阵配置(1.4)、基础权重(1.3) 未发生变化，无需更新。

最新校验状态：
- 档位分布(1.2)：**已更新**至 total_draws=2,634 ✅
- BxPx 命中(1.5)：**已更新**，B3×P2 从 322 增至 556 ✅
- 档位跃迁(1.6)：**已更新**至 6 行最新数据 ✅
- 策略配置(1.7)：17 条配置项值全部匹配 ✅（无变化）
- 用户体验状态(1.8)：**已更新**至 user_31 最新状态 ✅
- 矩阵配置(1.4)：12 格数据全部匹配 ✅（无变化）
- 基础权重(1.3)：9 条规则全部匹配 ✅（无变化）

**"平均消耗积分"数据溯源（✅ 已确认）**

原文 1.2 的"平均消耗积分"来自 `lottery_draws.cost_points`（用户每次抽奖花费的积分），NOT `lottery_draw_decisions.budget_deducted`。两者是完全不同的成本维度：

| 档位 | `AVG(cost_points)` 用户侧消耗 | `AVG(budget_deducted)` 平台侧预算 | `AVG(prize_value)` 奖品发放价值 |
|---|---|---|---|
| high | 12.01 | 199.71 | 1,471.05 |
| mid | 34.44 | 2,005.51 | 367.62 |
| low | 78.58 | 5,192.83 | 28.30 |
| fallback | 9.85 | 0.00 | 27.00 |

> **决策已确认（A+B 混合方案）**：保留 `cost_points` 数据（用户侧成本），模拟输出同时展示三维成本矩阵。详见 Section 4.3 对比分析面板。

### 0.4 二次校验新发现的架构问题（需要拍板）

| 发现 | 影响 | 决策状态 |
|---|---|---|
| `admin_operation_logs.operation_type` 是 **ENUM 类型**（~35 个固定值），不含 `simulation_apply` / `config_rollback` / `strategy_config_update` 等值 | 增强模块 10/12 的审计日志无法写入新 operation_type | ✅ **决策已确认：转 VARCHAR(50)**（详见 Section 十八） |
| `lottery_alerts.alert_type` 是 **ENUM 类型**（5 个值：win_rate/budget/inventory/user/system），不含 `simulation_bound` | 运维模块 14 熔断联动无法写入新 alert_type | ✅ **决策已确认：转 VARCHAR(50)**（详见 Section 十八） |
| 系统持续运行中，数据持续累积（+234 draws），三维成本指标有偏移 | baseline API 每次返回最新实时统计，无需在文档中固定静态快照 | ✅ 无需决策，API 实时查询即可 |

---

## 一、当前系统现状

### 1.1 活跃活动数据

| 数据库字段 | 值 |
|---|---|
| `campaign_name` | 餐厅积分抽奖 (`lottery_campaign_id`=1) |
| `status` | active |
| `campaign_type` | event |
| `pick_method` | tier_first |
| `budget_mode` | user（用户预算） |
| `total_draws` | 2,634 |
| `total_participants` | 1,570 |
| `total_prizes_awarded` | 2,634 |
| `guarantee_enabled` | 0（未启用），`guarantee_threshold`=10 |

### 1.2 实际档位分布（真实数据，三维成本矩阵）

| `final_tier` | 次数 | 占比 | AVG(`cost_points`) 用户侧 | AVG(`budget_deducted`) 平台侧 | AVG(`prize_value`) 奖品价值 |
|---|---|---|---|---|---|
| high | 1,399 | 53.11% | 12.01 | 199.71 | 1,471.05 |
| mid | 202 | 7.67% | 34.44 | 2,005.51 | 367.62 |
| low | 424 | 16.10% | 78.58 | 5,192.83 | 28.30 |
| fallback | 609 | 23.12% | 9.85 | 0.00 | 27.00 |

### 1.3 基础档位权重配置（`lottery_tier_rules`，字段 `tier_weight`）

| `segment_key` | high | mid | low | 合计 |
|---|---|---|---|---|
| default | 50,000 (5%) | 150,000 (15%) | 800,000 (80%) | 1,000,000 |
| new_user | 100,000 (10%) | 200,000 (20%) | 700,000 (70%) | 1,000,000 |
| vip_user | 80,000 (8%) | 220,000 (22%) | 700,000 (70%) | 1,000,000 |

> `lottery_tier_rules` 有 `lottery_campaign_id` 列，权重按活动隔离。

### 1.4 BxPx 矩阵配置（`lottery_tier_matrix_config`，⚠️ 全局表，无 campaign_id）

12 个格子（4 `budget_tier` × 3 `pressure_tier`），以下为当前生产数据：

| 格子 | `cap_multiplier` | `empty_weight_multiplier` | `high_multiplier` | `mid_multiplier` | `low_multiplier` | `fallback_multiplier` | 说明 |
|---|---|---|---|---|---|---|---|
| B0×P0 | 0.00 | 10.00 | 0.00 | 0.00 | 0.00 | 1.00 | 预算不足，强制空奖 |
| B0×P1 | 0.00 | 10.00 | 0.00 | 0.00 | 0.00 | 1.00 | 预算不足，强制空奖 |
| B0×P2 | 0.30 | 10.00 | 0.00 | 0.00 | 0.00 | 1.00 | 预算不足，强制空奖 |
| B1×P0 | 1.00 | 1.20 | 0.00 | 0.00 | 1.20 | 0.90 | 低预算+低压，略增空奖 |
| B1×P1 | 1.00 | 1.00 | 0.00 | 0.00 | 1.00 | 1.00 | 低预算+中压，正常 |
| B1×P2 | 0.80 | 0.80 | 0.00 | 0.00 | 0.80 | 1.20 | 低预算+高压，抑制空奖 |
| B2×P0 | 1.00 | 1.00 | 0.00 | 1.30 | 1.10 | 0.80 | 中预算+低压，正常 |
| B2×P1 | 1.30 | 0.90 | 0.00 | 1.00 | 1.00 | 1.00 | 中预算+中压，略抑空奖 |
| B2×P2 | 0.90 | 0.70 | 0.00 | 0.70 | 1.10 | 1.30 | 中预算+高压，抑制空奖 |
| B3×P0 | 1.00 | 0.80 | 1.50 | 1.20 | 0.90 | 0.70 | 高预算+低压，抑制空奖 |
| B3×P1 | 1.00 | 0.70 | 1.00 | 1.00 | 1.00 | 1.00 | 高预算+中压，显著抑制 |
| B3×P2 | 1.00 | 0.60 | 0.60 | 0.80 | 1.20 | 1.50 | 高预算+高压，强烈抑制 |

### 1.5 BxPx 实际命中分布（`lottery_draw_decisions` JOIN `lottery_draws`）

| BxPx 格子 | 命中次数 | 占比 |
|---|---|---|
| B3×P1 | 2,078 | 78.89% |
| B3×P2 | 556 | 21.11% |
| 其他格子 | 0 | 0% |

> 关键发现：100% 的用户仍然落在 B3 层（高预算），但 P2（高压力）占比从 13.4% 升至 21.11%，说明系统运行中用户整体压力指数在上升。

### 1.6 档位跃迁记录（`lottery_draw_decisions`，字段 `original_tier` → `final_tier`）

| `original_tier` | `final_tier` | 次数 | 说明 |
|---|---|---|---|
| high | high | 1,399 | 正常出 high |
| low | low | 424 | 正常出 low |
| NULL | fallback | 374 | 空选择走 fallback |
| low | fallback | 235 | low 降级到 fallback |
| mid | mid | 188 | 正常出 mid |
| high | mid | 14 | high 被降级到 mid（AntiHigh 触发） |

### 1.7 策略配置项（`lottery_strategy_config`，字段 `config_group`/`config_key`/`config_value`，⚠️ 全局表）

**anti_empty（防连空）**
| `config_key` | `config_value` | 说明 |
|---|---|---|
| enabled | true | 启用 |
| empty_streak_threshold | 3 | 连续空奖 3 次触发 |

**anti_high（防连高）**
| `config_key` | `config_value` | 说明 |
|---|---|---|
| enabled | true | 启用 |
| high_streak_threshold | 2 | 连续高档位 2 次触发 |
| recent_draw_window | 5 | 统计窗口 5 次 |

**pity（保底机制）**
| `config_key` | `config_value` | 说明 |
|---|---|---|
| enabled | true | 启用 |
| hard_guarantee_threshold | 10 | 硬保底：连空 10 次必出 |
| min_non_empty_cost | 10 | 最低非空奖成本 |
| multiplier_table | {0:1, 1:1, 2:1.2, 3:1.5, 4:1.8, 5:2.2, 6:2.8, 7:3.5, 8:5, 9:10} | Pity 累积乘数表 |

**luck_debt（运气债务）**
| `config_key` | `config_value` | 说明 |
|---|---|---|
| enabled | true | 启用 |
| expected_empty_rate | 0.3 | 期望空奖率 30% |
| min_draw_count | 10 | 最小样本量 10 次 |

**budget_tier（预算层级阈值）**
| `config_key` | `config_value` | 说明 |
|---|---|---|
| threshold_high | 1000 | B3 阈值：预算>=1000 |
| threshold_mid | 500 | B2 阈值：预算>=500 |
| threshold_low | 100 | B1 阈值：预算>=100 |

**pressure_tier（压力层级阈值）**
| `config_key` | `config_value` | 说明 |
|---|---|---|
| threshold_high | 0.8 | P2 阈值：压力指数>=0.8 |
| threshold_low | 0.5 | P1 阈值：压力指数>=0.5 |

### 1.8 用户体验状态样本（`lottery_user_experience_state`）

| user_id | lottery_campaign_id | `empty_streak` | `recent_high_count` | `total_draw_count` | `total_empty_count` | `pity_trigger_count` | `max_empty_streak` |
|---|---|---|---|---|---|---|---|
| 31 | 1 | 0 | 0 | 51 | 21 | 0 | 6 |

> Pity 硬保底（阈值=10）从未触发过，最大连空为 6 次。user_31 的 `total_draw_count` 已更新至最新值。

### 1.9 奖品配置（`lottery_prizes`，字段 `reward_tier`，库存需计算 `stock_quantity - total_win_count`）

| prize_name | `reward_tier` | `prize_type` | `prize_value` | 剩余库存 | `is_fallback` |
|---|---|---|---|---|---|
| 八八折 | high | coupon | 150 | 8,870 | 0 |
| 2000积分券 | high | points | 2,000 | 7,652 | 0 |
| 500积分券 | high | points | 500 | 0（已耗尽） | 0 |
| 九八折券 | high | coupon | 98 | 0（已耗尽） | 0 |
| 100积分 | mid | points | 100 | 296 | 0 |
| 甜品1份 | mid | physical | 150 | 537 | 0 |
| 精品首饰一个 | mid | physical | 800 | 9,931 | 0 |
| 生腌拼盘158 | mid | physical | 1,580 | 9,951 | 0 |
| 青菜1份 | low | physical | 120 | 9,380 | 0 |
| 神秘彩蛋 | low | virtual | 0 | 49,632 | 1 |
| 好运加持 | low | virtual | 0 | 49,617 | 1 |
| 美食推荐 | low | virtual | 0 | 49,683 | 1 |
| 厨师祝福 | low | virtual | 0 | 49,677 | 1 |
| 下次好运 | low | virtual | 0 | 49,630 | 1 |
| 参与有礼 | low | virtual | 0 | 49,641 | 1 |

> `is_fallback=1` 的奖品在 `reward_tier=low` 下，引擎会将它们视为空奖/安慰奖。

---

## 二、现有系统的功能差距

当前"策略管理"页面（`lottery-management.html?page=lottery-strategy`）已有功能：

- 查看和编辑策略配置（6 组参数）
- 查看和编辑 BxPx 矩阵（12 个格子）
- 查看策略效果分析面板（**历史数据**回看）
- 查看策略触发热力图（按天统计）
- 查看配置总览（BxPx 命中分布、近 24 小时执行摘要）

**缺失的关键能力**：操作者修改参数后**无法预览效果**，只能直接保存到数据库，等线上运行后才能看到结果。这意味着：
1. 参数调整是"盲调"，试错成本高
2. 无法回答"如果我把 X 改成 Y，结果会怎样？"
3. 无法在不影响线上的情况下评估不同配置方案

---

## 三、页面架构设计

### 3.1 页面放置（决策点 1）— 已确认：方案 A

> **决定**：作为 `lottery-management.html` 的新 Tab，URL: `?page=strategy-simulation`

与现有的 lottery-strategy、campaigns、quota 等 Tab 并列，操作者可随时切换对比。

### 3.2 模拟引擎执行位置（决策点 2）— 已确认：方案 A

> **决定**：后端 Node.js 服务端计算

在 `services/lottery-analytics/StrategySimulationService.js` 中实现，从 TierPickStage、PityCalculator 等提取纯函数复用。前端通过 API 调用，10,000 次模拟约 2-5 秒，完整复制生产逻辑，不卡浏览器。

---

## 四、功能模块设计

### 4.1 功能模块取舍（决策点 3）— 已确认：全量方案 + 6 项增强

> **决定**：4 个核心模块 + 6 个增强模块全部实现

**核心模块（Phase 2-4）：**

| 模块 | 复杂度 | 状态 |
|---|---|---|
| 1. 参数沙盒（Parameter Sandbox） | 中 | 确认实现 |
| 2. Monte Carlo 模拟引擎（含库存约束） | 高 | 确认实现 |
| 3. 对比分析面板（Side-by-Side） | 中 | 确认实现 |
| 4. 用户旅程模拟（User Journey） | 中 | 确认实现 |

**增强模块（Phase 5-6，对标美团/游戏公司实践）：**

| 模块 | 复杂度 | 对标来源 | 状态 |
|---|---|---|---|
| 5. 灵敏度分析（Sensitivity Analysis） | 中 | 美团 BETA 引擎 + gcsim 参数扫射 | 确认实现 |
| 6. 目标反推（Goal Seek / Auto-Recommend） | 高 | 阿里云智能增长 + 腾讯贝叶斯优化 | 确认实现 |
| 7. 多方案并排比较（Multi-Scenario Ranking） | 中 | 美团 A/B 平台 + gcsim 配队对比 | 确认实现 |
| 8. 库存约束建模（Inventory Constraint） | 中 | 美团/阿里抽奖平台 + 原神限定池 | 确认实现（融入模块 2） |
| 9. 模拟→实际偏差追踪（Prediction Drift） | 低 | 美团实验报表 + paimon.moe | 确认实现 |
| 10. 配置一键应用（Simulation → Production） | 低 | 美团实验"推全"按钮 | 确认实现 |

**运维闭环模块（Phase 7，利用 DB 已有字段/表，对标大厂配置管理实践）：**

| 模块 | 复杂度 | 对标来源 | DB 已有基础 | 状态 |
|---|---|---|---|---|
| 11. 定时生效（Scheduled Activation） | 低 | LaunchDarkly Scheduled Changes + 美团定时生效 | `lottery_strategy_config.effective_start`/`effective_end` 已存在 | 确认实现 |
| 12. 配置版本回滚（Version Rollback） | 中 | LaunchDarkly 版本历史 + 美团配置回滚 + 游戏热更回滚 | `AdminOperationLog.before_data`/`after_data` 已存在 | 确认实现 |
| 13. 预算节奏预测（Budget Pacing Forecast） | 中 | 阿里 RCPacing + eBay AdaptivePacing + 美团预算监控 | `lottery_draws.created_at` + `lottery_hourly_metrics` 已存在 | 确认实现 |
| 14. 异常熔断联动（Anomaly Circuit Breaker） | 中 | 美团实时监控熔断 + 游戏 LiveOps 自动降级 | `lottery_alerts` + `alert_silence_rules` 已存在 | 确认实现 |
| 15. 模拟报告导出（Export Report） | 低 | 全行业标配 | 纯前端，无 DB 依赖 | 确认实现 |

---

### 4.2 模块 1：参数沙盒

操作者可以调整任意策略参数，不保存到数据库。沙盒预加载当前线上配置作为基线。

**可编辑参数组（字段已对齐数据库实际列名）：**

| 参数组 | 可编辑字段（DB 列名） | 来源表 | 表作用域 |
|---|---|---|---|
| 基础档位权重 | `tier_weight`（按 `segment_key` + `tier_name` 组合） | `lottery_tier_rules` | 按活动隔离 |
| BxPx 矩阵 | 12格 × `high_multiplier`/`mid_multiplier`/`low_multiplier`/`fallback_multiplier`/`cap_multiplier`/`empty_weight_multiplier` | `lottery_tier_matrix_config` | ⚠️ 全局 |
| Pity 系统 | `config_value`（config_key: enabled, hard_guarantee_threshold, multiplier_table） | `lottery_strategy_config` | ⚠️ 全局 |
| 防连空 | `config_value`（config_key: enabled, empty_streak_threshold） | `lottery_strategy_config` | ⚠️ 全局 |
| 防连高 | `config_value`（config_key: enabled, high_streak_threshold, recent_draw_window） | `lottery_strategy_config` | ⚠️ 全局 |
| 运气债务 | `config_value`（config_key: enabled, expected_empty_rate, min_draw_count） | `lottery_strategy_config` | ⚠️ 全局 |
| 预算层级阈值 | `config_value`（config_key: threshold_high/threshold_mid/threshold_low） | `lottery_strategy_config` | ⚠️ 全局 |
| 压力层级阈值 | `config_value`（config_key: threshold_high/threshold_low） | `lottery_strategy_config` | ⚠️ 全局 |

**UI 形式（决策点 4）— 已确认：方案 A**

> **决定**：左右对比布局

左列当前值（只读灰色）+ 右列模拟值（可编辑），修改的值高亮黄色。每个参数组一个 Tab 或折叠面板。

**BxPx 矩阵编辑方式（决策点 5）— 已确认：方案 A + B 双模式切换**

> **决定**：热力图和全矩阵表格两种视图，提供切换按钮

- **热力图模式（默认）**：4×3 热力图显示乘数强度，点击格子弹出编辑面板，修改后格子边框变黄
- **表格模式**：12 行 × 6 列可编辑大表格，一次性看到所有值
- 右上角提供"热力图 / 表格"切换按钮，两种视图数据实时同步

---

### 4.3 模块 2：Monte Carlo 模拟引擎

给定提议参数，模拟 N 次抽奖，计算预期分布。

**模拟输入（操作者可配置）：**
- 模拟次数：1,000 / 5,000 / 10,000 / 50,000
- 用户预算分布：按真实数据预设 或 自定义各 B 层占比
- 压力分布：按真实数据预设 或 自定义各 P 层占比
- 用户分群混合：default / new_user / vip_user 各占比

**模拟输出（三维成本矩阵 + 体验指标）：**

*档位分布指标：*
- 各档位预测分布（high/mid/low/fallback 百分比）
- 预测空奖率

*三维成本指标（对标美团+游戏公司混合方案）：*
- 用户每次抽奖消耗：按档位的 AVG(`cost_points`)（用户体验视角）
- 每千次预估奖品发放价值：`SUM(prize_value) / draws × 1000`（平台实际成本）
- 每千次预估预算消耗：`SUM(budget_deducted) / draws × 1000`（预算耗尽预警）
- 奖品成本率：奖品发放总价值 / 用户消耗总积分（盈亏平衡红线）

*体验机制指标：*
- Pity 触发率预估
- AntiEmpty 触发次数预估
- AntiHigh 触发次数预估
- 平均首次非空所需抽奖次数

**核心算法流程：**

```
输入：proposed_config + scenario

1. 从数据库加载当前配置作为 baseline
2. 将 proposed_config 合并覆盖 baseline（仅在内存中）
3. 循环 N 次：
   a. 按 scenario.budget_distribution 概率随机选择 budget_tier
   b. 按 scenario.pressure_distribution 概率随机选择 pressure_tier
   c. 按 scenario.segment_distribution 概率随机选择 user_segment
   d. 初始化用户状态（empty_streak=0, high_count=0）
   e. 执行一次概率计算：
      - 获取该 segment 的 base_weights
      - 应用 BxPx[budget_tier][pressure_tier] 乘数
      - 归一化到 1,000,000
      - 执行 8% high 硬顶
      - 如果 Pity 启用，根据 empty_streak 应用 pity 乘数
      - 随机数选档位
      - 如果 AntiEmpty 启用且 empty_streak >= 阈值，强制非空
      - 如果 AntiHigh 启用且 recent_high >= 阈值，降级 high→mid
   f. 记录结果，更新用户状态
4. 聚合所有结果
5. 与当前真实数据对比，计算 delta
6. 评估风险等级
7. 返回结果
```

**可复用的现有纯函数（已验证存在于代码库中的实际路径）：**

| 实际文件路径 | 可复用方法 | 行号范围 | 用途 | 纯函数？ |
|---|---|---|---|---|
| `services/UnifiedLotteryEngine/pipeline/stages/TierPickStage.js` | `_enforceHighTierCap(weights, maxRatio)` | L591-623 | 8% 硬顶：超出部分 80%→low, 20%→mid | ✅ 纯函数 |
| `services/UnifiedLotteryEngine/pipeline/stages/TierPickStage.js` | `_pickTier(weights, random_value)` | L559-578 | 按权重随机选档位 | ✅ 纯函数 |
| `services/UnifiedLotteryEngine/compute/calculators/TierMatrixCalculator.js` | `_applyMultipliers(base_weights, multipliers)` | L207-221 | BxPx 乘数 × base_weight | ✅ 纯函数 |
| `services/UnifiedLotteryEngine/compute/calculators/TierMatrixCalculator.js` | `_normalizeWeights(weights)` | L256-282 | 归一化到 WEIGHT_SCALE=1,000,000 | ✅ 纯函数 |
| `services/UnifiedLotteryEngine/compute/calculators/TierMatrixCalculator.js` | `_getMatrixMultipliers(budget_tier, pressure_tier)` | L175-197 | 矩阵查表 | ✅ 纯函数（需传入配置） |
| `services/UnifiedLotteryEngine/compute/calculators/PityCalculator.js` | `_adjustWeights(tier_weights, multiplier)` | L223-250 | Pity 乘数应用（boost 非空，reduce fallback） | ✅ 纯函数 |
| `services/UnifiedLotteryEngine/compute/calculators/PityCalculator.js` | `calculate({ empty_streak, tier_weights })` | L125-210 | 查 multiplier_table 并应用 | ✅（需传入 config） |
| `services/UnifiedLotteryEngine/compute/calculators/AntiEmptyStreakHandler.js` | `handle()` | L126-247 | empty_streak >= threshold 时强制非空 | ⚠️ 需传入 budget/prizes |
| `services/UnifiedLotteryEngine/compute/calculators/AntiHighStreakHandler.js` | `handle()` | L138-262 | recent_high >= threshold 时 high→mid | ⚠️ 需传入 cooldown 状态 |
| `services/UnifiedLotteryEngine/compute/calculators/BudgetTierCalculator.js` | 预算分层逻辑 | — | 根据阈值判断 B0-B3 | ✅ 纯函数 |
| `services/UnifiedLotteryEngine/compute/calculators/PressureTierCalculator.js` | 压力分层逻辑 | — | 根据阈值判断 P0-P2 | ✅ 纯函数 |

> **复用策略**：`StrategySimulationService` 直接 `require()` 这些 calculator 类，构造时注入模拟配置而非数据库配置，无需提取或拷贝代码。`compute/calculators/` 目录下的类已经是「配置注入、无 DB 依赖」的设计，天然适合模拟场景。

**模拟精度选择（决策点 11）：**

| 迭代次数 | 精度（置信区间） | 预估耗时 | 适用场景 |
|---|---|---|---|
| 1,000 | ±3% | <0.5s | 快速预览 |
| 5,000 | ±1.5% | 1-2s | 常规模拟 |
| 10,000 | ±1% | 2-5s | 正式决策前 |
| 50,000 | ±0.5% | 10-20s | 高精度需求 |

精度选择（决策点 11）— 已确认：方案 B

> **决定**：操作者可选，下拉选择：快速(1K) / 标准(10K) / 精确(50K)，默认"标准"。50K 时显示进度条。

---

### 4.4 模块 3：对比分析面板

当前配置效果 vs 模拟配置效果，并排对比。

**图表选择（决策点 6）— 已确认：7 项全部实现**

| 图表 | 类型 | 展示内容 | 状态 |
|---|---|---|---|
| 档位分布对比 | 双柱状图 | 当前 vs 模拟的 high/mid/low/fallback 比例 | 确认实现 |
| BxPx 命中热力图 | 双热力图 | 当前矩阵 vs 模拟矩阵效果 | 确认实现 |
| 体验机制触发率 | 指标卡片组 | Pity/AntiEmpty/AntiHigh 触发次数和比例 | 确认实现 |
| 三维成本摘要 | 数字摘要卡组 | 用户侧消耗 / 平台预算消耗 / 奖品发放价值 / 奖品成本率 | 确认实现 |
| 风险评估仪表盘 | 红绿灯指示器 | high 比例风险/空奖率风险/预算耗尽风险/奖品成本率风险 | 确认实现 |
| 空奖连击分布 | 直方图 | 模拟中连续空奖的长度分布 | 确认实现 |
| 累积概率曲线 | 折线图 | N 次抽奖后各档位累计获得次数趋势 | 确认实现 |

**风险评估阈值：**

| 风险项 | 绿色（安全） | 黄色（关注） | 红色（危险） |
|---|---|---|---|
| high 档位比例 | <5% | 5%-8% | >8%（超硬顶） |
| 空奖率 | <30% | 30%-50% | >50% |
| 预算耗尽风险 | >30 天 | 7-30 天 | <7 天 |
| 奖品成本率 | <0.5 | 0.5-0.8 | >0.8（接近亏损） |

---

### 4.5 模块 4：用户旅程模拟

模拟单个用户的连续抽奖体验，逐步展示策略机制如何触发。

**可配置用户画像：**
- 起始预算（决定 budget_tier）
- 用户分群（default / new_user / vip_user）
- 起始连空次数（0 或自定义）
- 模拟抽奖次数（10 / 20 / 50）

**旅程深度（决策点 8）— 已确认：方案 B 完整版**

> **决定**：每次抽奖展示完整权重变化链，操作者可以完全透视策略引擎的决策过程

每一抽展示示例：
```
第5次抽奖:
  基础权重: high=5% mid=15% low=80%
  → BxPx调整(B3P1): high=5% mid=15% low=80% fallback=0%
  → 8%硬顶: 不触发
  → Pity调整(连空3次, ×1.5): high=7.3% mid=21.9% low=70.8%
  → 最终选择: mid
  → 奖品: 100积分
  → 连空次数重置: 0
```

---

### 4.6 增强模块 5：灵敏度分析（Sensitivity Analysis）

> 对标：美团 BETA 实验引擎 + 游戏公司 gcsim 参数扫射

**解决的核心问题**：运营者不知道"改哪个参数、改多少"。灵敏度分析固定其他参数，对一个参数从 A 扫到 B，输出"参数值 → 结果指标"曲线。

**操作流程**：
1. 选择目标参数（下拉菜单，如 `matrix_config.B3_P1.high_multiplier`）
2. 设置扫射范围（如 0.0 ~ 1.5）和步数（如 10 步）
3. 点击"运行灵敏度分析"
4. 后端对每个步进值跑一次 Monte Carlo（10 步 × 5000 次 = 50,000 次模拟，约 10 秒）
5. 前端渲染折线图：X 轴参数值，Y 轴多条指标线（high%、空奖率、奖品成本率等）

**可扫射的参数列表**（基于数据库实际字段）：

| 参数分类 | 可扫射字段 | 典型扫射范围 |
|---|---|---|
| BxPx 矩阵乘数 | `high_multiplier` / `mid_multiplier` / `low_multiplier` / `fallback_multiplier` / `empty_weight_multiplier`（指定格子） | 0.0 ~ 2.0 |
| 基础权重 | `tier_weight`（指定 segment + tier） | 0 ~ 500,000 |
| Pity 阈值 | `hard_guarantee_threshold` | 3 ~ 20 |
| 防连空阈值 | `empty_streak_threshold` | 1 ~ 10 |
| 防连高阈值 | `high_streak_threshold` | 1 ~ 5 |
| 预算层级 | `threshold_high` / `threshold_mid` / `threshold_low` | 50 ~ 5000 |

**输出图表**：
- 多指标折线图（ECharts LineChart，X 轴参数值，Y 轴左侧百分比 + Y 轴右侧成本值）
- 每条线对应一个指标（high%、mid%、空奖率、奖品成本率）
- 高亮安全区间（绿色背景带）和危险区间（红色背景带）

---

### 4.7 增强模块 6：目标反推（Goal Seek / Auto-Recommend）

> 对标：阿里云智能用户增长"自动计算中奖概率" + 腾讯贝叶斯多目标优化

**解决的核心问题**：运营者说"我希望 high 档位比例控制在 5-8%，空奖率低于 30%"，系统自动搜索满足约束的参数组合。

**操作流程**：
1. 设置目标约束（表单输入）：
   - high 档位比例：最小值 / 最大值（如 0.02 ~ 0.08）
   - 空奖率：最大值（如 0.30）
   - 奖品成本率：最大值（如 0.80）
2. 选择可调整的参数范围（勾选哪些参数允许系统修改）
3. 点击"搜索推荐方案"
4. 后端用网格搜索在参数空间中搜索（优先调整 BxPx 矩阵乘数，影响最直接）
5. 返回 Top 3 满足约束的参数方案，每个方案附带完整模拟结果

**搜索策略**（适合当前项目规模）：
- 使用网格搜索（Grid Search）而非贝叶斯优化 — 参数空间有限（12 格矩阵 × 6 个乘数），网格搜索足够
- 搜索优先级：先调 `high_multiplier` → 再调 `empty_weight_multiplier` → 再调基础权重
- 每组参数跑 1000 次快速模拟，筛选后对 Top 候选跑 10000 次精确验证

---

### 4.8 增强模块 7：多方案并排比较（Multi-Scenario Ranking）

> 对标：美团 A/B 测试平台多分支并排 + gcsim 配队对比

**解决的核心问题**：当前只能"当前配置 vs 一个模拟配置"两两对比，无法同时比较 3-5 个方案。

**操作流程**：
1. 在参数沙盒中调整参数后，点击"保存为方案 A"
2. 修改参数，点击"保存为方案 B"（最多 5 个方案）
3. 点击"并排比较"，后端批量跑模拟
4. 对比面板从双列变成多列表格，按指标排序
5. 自动高亮每行的最优值（绿色）和最差值（红色）

**数据结构**：方案保存在前端 Alpine.js 状态中（不持久化到数据库），每个方案是一个 `proposed_config` 对象。批量模拟调用现有 `/run` API 多次（或新增批量 API）。

---

### 4.9 增强模块 8：库存约束建模（融入模块 2）

> 对标：美团/阿里抽奖平台库存联动 + 原神限定卡池

**解决的核心问题**：当前模拟不考虑奖品库存耗尽。数据库实际显示 `500积分券`（stock=0）和 `九八折券`（stock=0）已经耗尽，模拟结果会高估 high 档位命中率。

**实现方式（融入 Monte Carlo 循环）**：
1. baseline 加载时读取 `lottery_prizes` 的 `stock_quantity - total_win_count` 作为模拟初始库存
2. 模拟循环中，选出档位后按 `win_weight` 选奖品，如果该奖品模拟库存为 0：
   - 尝试同档位其他奖品
   - 同档位全部耗尽 → 触发降级（复用现有 `TierPickStage._applyDowngrade` 逻辑）
3. 输出新增指标：
   - 各奖品预计耗尽的模拟轮次（"第 N 次抽奖时 X 奖品耗尽"）
   - 库存耗尽后的实际档位分布偏移量

---

### 4.10 增强模块 9：模拟→实际偏差追踪（Prediction Drift）

> 对标：美团实验平台"预期 vs 实际"报表 + paimon.moe 社区统计

**解决的核心问题**：模拟完后保存了记录，但参数上线后实际效果是否与模拟一致，没有自动追踪。运营者无法建立对模拟工具的信任度。

**实现方式**：
1. `lottery_simulation_records` 表已有 `simulation_result` JSON 字段存放预测快照
2. 新增手动触发按钮："对比实际数据"
3. 点击后，后端用模拟记录的 `created_at` 时间之后的实际 `lottery_draw_decisions` 数据统计真实分布
4. 计算偏差：每个指标的 `|预测值 - 实际值|` 和偏差百分比
5. 在历史记录列表中新增"偏差率"列，颜色编码：<5% 绿色，5-15% 黄色，>15% 红色

**新增字段**（追加到 `lottery_simulation_records` 表）：

| 字段 | 类型 | 说明 |
|---|---|---|
| `actual_result` | JSON, NULL | 实际数据统计结果（手动触发填充） |
| `drift_metrics` | JSON, NULL | 偏差指标（各维度偏差百分比） |
| `drift_calculated_at` | DATETIME, NULL | 偏差计算时间 |

---

### 4.11 增强模块 10：配置一键应用（Simulation → Production）

> 对标：美团实验平台"推全"按钮

**解决的核心问题**：模拟完全是只读的，运营者需要手动到策略管理页面逐个改参数，存在操作断层和人为错误风险。

**实现方式**：
1. 对比分析面板增加"应用此配置到线上"按钮
2. 点击后弹出确认对话框，显示即将修改的具体字段和值（diff 视图）
3. 确认后调用现有的策略管理写入 API：
   - `lottery_tier_rules` → 更新 `tier_weight`
   - `lottery_tier_matrix_config` → 更新乘数字段
   - `lottery_strategy_config` → 更新 `config_value`
4. 所有写入在一个数据库事务内完成
5. 自动创建 `AdminOperationLog` 审计记录（`operation_type: 'simulation_apply'`），`before_data` / `after_data` 记录完整变更
6. 成功后模拟记录状态标记为 `applied`

**权限要求**：复用 `requireRoleLevel(100)` 管理员权限（与模拟本身一致）

---

### 4.12 运维模块 11：定时生效（Scheduled Config Activation）

> 对标：LaunchDarkly Scheduled Changes + 美团定时生效 + 游戏赛季自动切换
> DB 已有基础：`lottery_strategy_config` 表的 `effective_start` / `effective_end` 列（DATETIME，已存在但未利用）

**解决的核心问题**：运营者模拟完一套新参数后，不想半夜手动改，而是"这套配置明天早上 8 点生效"。

**实现方式**（基于已有字段，几乎 0 后端新字段成本）：
1. 增强 10"一键应用"按钮旁增加"定时应用"选项，弹出日期时间选择器
2. 选择生效时间后，写入新的配置行并设置 `effective_start` 为指定时间
3. `compute/config/StrategyConfig.js` 的配置加载逻辑加上时间条件：`WHERE effective_start <= NOW() AND (effective_end IS NULL OR effective_end >= NOW()) AND is_active = 1 ORDER BY priority DESC, effective_start DESC LIMIT 1`
4. 前端在参数沙盒显示"待生效配置"黄色标签，倒计时显示距生效还有多久
5. 对 `lottery_tier_matrix_config` 和 `lottery_tier_rules` 表的定时生效：由于这两张表没有 `effective_start`/`effective_end` 字段，采用"到时间后由后端定时任务触发写入"的方式（复用 Node.js 的 `node-cron` 或系统 crontab）

---

### 4.13 运维模块 12：配置版本历史 + 一键回滚（Version Rollback）

> 对标：LaunchDarkly 版本历史 + 美团配置版本管理 + 游戏热更回滚
> DB 已有基础：`AdminOperationLog` 表的 `before_data` / `after_data` JSON 字段，每次策略修改都有完整变更快照

**解决的核心问题**：运营者改了参数后发现线上效果不对，需要立即回滚到上一版配置。当前只能看 `AdminOperationLog` 的 JSON 数据手动恢复。

**实现方式**：
1. 策略管理页面 / 模拟页面新增"变更历史"面板
2. 从 `AdminOperationLog` 查询 `operation_type` IN ('strategy_config_update', 'matrix_config_update', 'tier_rules_update', 'simulation_apply', 'config_rollback') 的记录
3. 展示时间线列表：谁在什么时间改了什么（diff 视图，左列 `before_data` 灰色，右列 `after_data` 绿色/红色）
4. 每条记录有"回滚到此版本"按钮：
   - 点击后用该记录的 `before_data` 覆盖写回对应表（在事务内完成）
   - 回滚操作本身也记录到 `AdminOperationLog`（`operation_type: 'config_rollback'`，`before_data` = 当前值，`after_data` = 回滚目标值）
5. 最近 50 条变更历史，按时间倒序

---

### 4.14 运维模块 13：预算节奏预测（Budget Pacing Forecast）

> 对标：阿里 RCPacing + eBay AdaptivePacing + 美团预算消耗监控
> DB 已有基础：`lottery_draws.created_at` + `lottery_draw_decisions.budget_deducted` + `lottery_campaigns.remaining_prize_pool` + `lottery_hourly_metrics`

**解决的核心问题**：当前只有"预算耗尽风险"红绿灯（一个数字），运营者无法看到预算消耗的时间走势和不同参数方案对耗尽速率的影响。

**实现方式**：
1. baseline API 新增返回字段：最近 30 天的每日预算消耗趋势
   ```sql
   SELECT DATE(ld.created_at) as dt, SUM(d.budget_deducted) as daily_budget
   FROM lottery_draw_decisions d
   JOIN lottery_draws ld ON d.lottery_draw_id = ld.lottery_draw_id
   WHERE ld.lottery_campaign_id = :id
   GROUP BY DATE(ld.created_at)
   ORDER BY dt DESC LIMIT 30
   ```
2. 模拟结果新增指标：
   - `daily_budget_consumption` = (每千次预算消耗 / 1000) × 日均抽奖次数
   - `estimated_depletion_date` = 当前剩余预算 / daily_budget_consumption
3. 前端新增 ECharts 折线图（纳入对比面板）：
   - X 轴：日期（历史实线 + 预测虚线）
   - Y 轴：剩余预算
   - 当前参数：蓝色虚线延伸
   - 模拟参数：橙色虚线延伸
   - 红色垂直线标注"预计耗尽日期"
   - 两条线的差异直观展示参数调整对预算寿命的影响

---

### 4.15 运维模块 14：异常熔断联动（Anomaly Circuit Breaker）

> 对标：美团实时监控自动熔断 + 游戏 LiveOps 自动降级
> DB 已有基础：`lottery_alerts` 表 + `alert_silence_rules` 表 + `lottery_hourly_metrics` 表

**解决的核心问题**：告警系统和模拟系统割裂。模拟预测"high 应在 5-8%"，但上线后如果 high 突然飙到 20%，告警系统不知道预期目标是多少，也无法自动暂停。

**实现方式**：
1. 增强 10"一键应用"执行时，自动写入 `lottery_alerts` 监控规则：
   - `alert_type: 'simulation_bound'`
   - `threshold_config` JSON 存放模拟预测值 ± 容差（如 `{ "high_rate": { "expected": 0.052, "tolerance": 0.03 }, "empty_rate": { "expected": 0.244, "tolerance": 0.05 } }`）
   - `lottery_campaign_id` 关联活动
2. 现有的 `LotteryHourlyMetrics` 定时聚合任务中增加检查：
   - 如果最近 1 小时实际指标超出 simulation_bound 的容差范围 → 触发 `lottery_alerts` 告警
   - 连续 3 小时超出 → 自动将活动状态改为 `paused`（熔断），写入 `AdminOperationLog`
3. 前端模拟页面显示"监控绑定状态"标签：
   - 绿色"监控中" — 实际指标在预测容差内
   - 黄色"偏离" — 部分指标超出容差
   - 红色"已熔断" — 活动被自动暂停

---

### 4.16 运维模块 15：模拟报告导出（Export Report）

> 对标：全行业标配（美团/阿里/游戏公司/LaunchDarkly 全部支持导出）

**解决的核心问题**：模拟结果只能在页面上看，无法分享给不登录后台的决策者（如餐厅老板）。

**实现方式**（纯前端，0 后端工作量）：
1. 对比面板增加"导出报告"按钮（下拉：PDF / Excel）
2. PDF 导出：用 `html2canvas` 截取图表区域 + `jspdf` 生成文档
   - 封面：模拟名称、操作者、时间、活动名称
   - 第一页：参数变更 diff 表格
   - 第二页：档位分布对比柱状图 + 三维成本对比卡片
   - 第三页：风险评估仪表盘 + 灵敏度曲线图
   - 页脚：自动生成时间戳 + "本报告由策略模拟系统自动生成"
3. Excel 导出：用 `SheetJS`（xlsx 库）生成
   - Sheet 1：模拟参数和场景配置
   - Sheet 2：模拟结果数据表
   - Sheet 3：与当前配置的对比 delta
4. 前端依赖：`npm install html2canvas jspdf xlsx`（或 CDN 加载）

---

## 五、场景预设能力（决策点 7）— 已确认：方案 C 预设场景库

> **决定**：提供预设场景下拉菜单，操作者选择后可在此基础上微调

**预设场景定义：**

| 场景名 | budget 分布 | pressure 分布 | segment 分布 | 说明 |
|---|---|---|---|---|
| 当前真实 | B3=100% | P1=86.6%, P2=13.4% | 从数据库统计 | 基于 lottery_draw_decisions 实时统计 |
| 均匀分布 | B0-B3 各25% | P0-P2 各33.3% | default=100% | 测试用，覆盖所有矩阵格子 |
| 低预算增多 | B1=20%, B2=30%, B3=50% | P1=70%, P2=30% | default=80%, new_user=20% | 模拟用户预算下降场景 |
| 高压力场景 | B2=30%, B3=70% | P0=10%, P1=40%, P2=50% | default=70%, vip_user=30% | 模拟活动高峰/预算吃紧 |

操作者选择预设后，所有数值均可手动微调。

---

## 六、后端 API 设计（对齐后端实际技术体系）

### 6.1 路由组织（决策点 10）— 已确认：方案 B 独立路由文件

> **决定**：新建 `routes/v4/console/lottery-simulation.js`，在 `routes/v4/console/index.js` 中注册。

**路由注册方式**（对齐现有 `lottery-strategy-stats` 模式）：
- 中间件链：`authenticateToken` → `requireRoleLevel(100)`（复用现有管理员鉴权）
- 路由前缀：`/api/v4/console/lottery-simulation/...`
- 响应格式：统一使用 `res.apiSuccess(data, message)` / `res.apiError(message, code, details, status)`
- 服务获取：`req.app.locals.services.getService('strategy_simulation')`

### 6.2 接口列表（7 个 API，字段全部对齐数据库实际列名）

| API | 方法 | 归属模块 |
|---|---|---|
| `/baseline/:lottery_campaign_id` | GET | 核心 |
| `/run` | POST | 核心（模块 2） |
| `/user-journey` | POST | 核心（模块 4） |
| `/sensitivity` | POST | 增强（模块 5） |
| `/recommend` | POST | 增强（模块 6） |
| `/apply/:lottery_simulation_record_id` | POST | 增强（模块 10） |
| `/drift/:lottery_simulation_record_id` | POST | 增强（模块 9） |

#### GET /api/v4/console/lottery-simulation/baseline/:lottery_campaign_id

加载模拟基线数据。需要从三个作用域不同的表读取：

**数据来源（加 `lottery_campaign_id` 列后，全部按活动过滤）：**
- `lottery_tier_rules`（WHERE `lottery_campaign_id` = :id） → 基础权重
- `lottery_tier_matrix_config`（WHERE `lottery_campaign_id` = :id） → BxPx 矩阵（已加 campaign_id 列）
- `lottery_strategy_config`（WHERE `lottery_campaign_id` = :id AND `is_active` = 1） → 策略配置（已加 campaign_id 列）
- `lottery_draw_decisions` JOIN `lottery_draws`（WHERE campaign_id = :id） → 历史 BxPx 分布统计
- `lottery_prizes`（WHERE `lottery_campaign_id` = :id） → 奖品配置（用于 cost_points/prize_value 计算）

**响应体**（`res.apiSuccess(data)` 的 `data` 部分）：
```json
{
  "tier_rules": [
    { "segment_key": "default", "tier_name": "high", "tier_weight": 50000 },
    { "segment_key": "default", "tier_name": "mid", "tier_weight": 150000 },
    { "segment_key": "default", "tier_name": "low", "tier_weight": 800000 }
  ],
  "matrix_config": [
    {
      "budget_tier": "B3", "pressure_tier": "P1",
      "high_multiplier": 1.00, "mid_multiplier": 1.00,
      "low_multiplier": 1.00, "fallback_multiplier": 1.00,
      "cap_multiplier": 1.00, "empty_weight_multiplier": 0.70
    }
  ],
  "strategy_config": {
    "pity": { "enabled": true, "hard_guarantee_threshold": 10, "multiplier_table": {} },
    "anti_empty": { "enabled": true, "empty_streak_threshold": 3 },
    "anti_high": { "enabled": true, "high_streak_threshold": 2, "recent_draw_window": 5 },
    "luck_debt": { "enabled": true, "expected_empty_rate": 0.3, "min_draw_count": 10 },
    "budget_tier": { "threshold_high": 1000, "threshold_mid": 500, "threshold_low": 100 },
    "pressure_tier": { "threshold_high": 0.8, "threshold_low": 0.5 }
  },
  "actual_distribution": {
    "tier_distribution": { "high": 1393, "mid": 165, "low": 233, "fallback": 609 },
    "bxpx_distribution": { "B3_P1": 2078, "B3_P2": 322 },
    "total_draws": 2400
  }
}
```

#### POST /api/v4/console/lottery-simulation/run

执行 Monte Carlo 模拟。

**请求体**（字段名直接使用 DB 列名，前端不做映射）：
```json
{
  "lottery_campaign_id": 1,
  "simulation_count": 10000,
  "proposed_config": {
    "tier_rules": [
      { "segment_key": "default", "tier_name": "high", "tier_weight": 50000 },
      { "segment_key": "default", "tier_name": "mid", "tier_weight": 150000 },
      { "segment_key": "default", "tier_name": "low", "tier_weight": 800000 }
    ],
    "matrix_config": [
      {
        "budget_tier": "B3", "pressure_tier": "P1",
        "high_multiplier": 0.5, "mid_multiplier": 1.0,
        "low_multiplier": 1.0, "fallback_multiplier": 1.0,
        "cap_multiplier": 1.0, "empty_weight_multiplier": 0.7
      }
    ],
    "strategy_config": {
      "pity": { "hard_guarantee_threshold": 8 },
      "anti_empty": { "empty_streak_threshold": 5 }
    }
  },
  "scenario": {
    "budget_distribution": { "B0": 0, "B1": 0, "B2": 0, "B3": 100 },
    "pressure_distribution": { "P0": 0, "P1": 86.6, "P2": 13.4 },
    "segment_distribution": { "default": 80, "new_user": 15, "vip_user": 5 }
  }
}
```

**响应体**（`res.apiSuccess(data)` 的 `data` 部分）：
```json
{
  "simulation_result": {
    "tier_distribution": { "high": 32.5, "mid": 18.7, "low": 28.3, "fallback": 20.5 },
    "empty_rate": 20.5,
    "cost_metrics": {
      "avg_cost_points_by_tier": { "high": 11.76, "mid": 20.11, "low": 63.88, "fallback": 9.85 },
      "prize_value_per_1000_draws": 85200,
      "budget_deducted_per_1000_draws": 28500,
      "prize_cost_rate": 0.72
    },
    "experience_metrics": {
      "pity_trigger_rate": 2.3,
      "anti_empty_trigger_count": 45,
      "anti_high_trigger_count": 120,
      "avg_draws_to_first_non_empty": 1.8
    }
  },
  "comparison": {
    "tier_delta": { "high": -25.54, "mid": 11.82, "low": 18.59, "fallback": -4.88 },
    "empty_rate_delta": -4.88,
    "cost_delta": {
      "prize_value_per_1000_draws_delta": -12300,
      "budget_deducted_per_1000_draws_delta": -5200,
      "prize_cost_rate_delta": -0.08
    }
  },
  "risk_assessment": {
    "high_tier_risk": "green",
    "empty_rate_risk": "green",
    "budget_depletion_risk": "green",
    "prize_cost_rate_risk": "green"
  }
}
```

#### POST /api/v4/console/lottery-simulation/user-journey

模拟单个用户的连续抽奖旅程。

**请求体：**
```json
{
  "lottery_campaign_id": 1,
  "proposed_config": { "...同 /run 接口..." },
  "user_profile": {
    "budget": 2000,
    "segment_key": "default",
    "initial_empty_streak": 0
  },
  "draw_count": 20
}
```

**响应体**（`res.apiSuccess(data)` 的 `data` 部分）：
```json
{
  "draws": [
    {
      "draw_number": 1,
      "budget_tier": "B3",
      "pressure_tier": "P1",
      "base_weights": { "high": 50000, "mid": 150000, "low": 800000 },
      "bxpx_adjusted": { "high": 50000, "mid": 150000, "low": 800000, "fallback": 0 },
      "after_high_cap": { "high": 50000, "mid": 150000, "low": 800000, "fallback": 0 },
      "after_pity": { "high": 50000, "mid": 150000, "low": 800000, "fallback": 0 },
      "final_weights": { "high": 50000, "mid": 150000, "low": 800000, "fallback": 0 },
      "final_tier": "low",
      "triggers": [],
      "user_state_after": { "empty_streak": 0, "recent_high_count": 0 }
    }
  ]
}
```

#### POST /api/v4/console/lottery-simulation/sensitivity

灵敏度分析：扫射一个参数，输出指标变化曲线。

**请求体：**
```json
{
  "lottery_campaign_id": 1,
  "target_param": {
    "group": "matrix_config",
    "key": "B3_P1.high_multiplier"
  },
  "range": { "min": 0.0, "max": 1.5, "steps": 10 },
  "simulation_count_per_step": 5000,
  "scenario": {
    "budget_distribution": { "B0": 0, "B1": 0, "B2": 0, "B3": 100 },
    "pressure_distribution": { "P0": 0, "P1": 86.6, "P2": 13.4 },
    "segment_distribution": { "default": 80, "new_user": 15, "vip_user": 5 }
  }
}
```

**响应体**（`res.apiSuccess(data)` 的 `data` 部分）：
```json
{
  "param_path": "matrix_config.B3_P1.high_multiplier",
  "data_points": [
    {
      "param_value": 0.0,
      "tier_distribution": { "high": 0.0, "mid": 25.3, "low": 52.1, "fallback": 22.6 },
      "empty_rate": 22.6,
      "prize_cost_rate": 0.31
    },
    {
      "param_value": 0.15,
      "tier_distribution": { "high": 3.2, "mid": 22.1, "low": 49.8, "fallback": 24.9 },
      "empty_rate": 24.9,
      "prize_cost_rate": 0.45
    }
  ]
}
```

#### POST /api/v4/console/lottery-simulation/recommend

目标反推：给定约束条件，搜索满足条件的参数组合。

**请求体：**
```json
{
  "lottery_campaign_id": 1,
  "constraints": {
    "high_rate": { "min": 0.02, "max": 0.08 },
    "empty_rate": { "max": 0.30 },
    "prize_cost_rate": { "max": 0.80 }
  },
  "adjustable_params": [
    "matrix_config.B3_P1.high_multiplier",
    "matrix_config.B3_P1.empty_weight_multiplier",
    "matrix_config.B3_P2.high_multiplier"
  ],
  "scenario": {
    "budget_distribution": { "B0": 0, "B1": 0, "B2": 0, "B3": 100 },
    "pressure_distribution": { "P0": 0, "P1": 86.6, "P2": 13.4 },
    "segment_distribution": { "default": 80, "new_user": 15, "vip_user": 5 }
  }
}
```

**响应体**（`res.apiSuccess(data)` 的 `data` 部分）：
```json
{
  "recommendations": [
    {
      "rank": 1,
      "proposed_changes": {
        "matrix_config.B3_P1.high_multiplier": 0.15,
        "matrix_config.B3_P1.empty_weight_multiplier": 0.50,
        "matrix_config.B3_P2.high_multiplier": 0.10
      },
      "simulation_result": {
        "tier_distribution": { "high": 5.2, "mid": 22.1, "low": 48.3, "fallback": 24.4 },
        "empty_rate": 24.4,
        "prize_cost_rate": 0.52
      },
      "constraints_met": true
    }
  ],
  "search_stats": { "combinations_tested": 1000, "solutions_found": 12, "elapsed_ms": 8500 }
}
```

#### POST /api/v4/console/lottery-simulation/apply/:lottery_simulation_record_id

一键应用模拟配置到线上。

**响应体**（`res.apiSuccess(data)` 的 `data` 部分）：
```json
{
  "applied": true,
  "changes": [
    { "table": "lottery_tier_matrix_config", "field": "high_multiplier", "where": "B3_P1", "old": 1.00, "new": 0.15 },
    { "table": "lottery_tier_matrix_config", "field": "empty_weight_multiplier", "where": "B3_P1", "old": 0.70, "new": 0.50 }
  ],
  "admin_operation_log_id": 12345
}
```

#### POST /api/v4/console/lottery-simulation/drift/:lottery_simulation_record_id

计算模拟预测与实际数据的偏差。

**响应体**（`res.apiSuccess(data)` 的 `data` 部分）：
```json
{
  "predicted": { "high": 5.2, "mid": 22.1, "low": 48.3, "fallback": 24.4, "empty_rate": 24.4 },
  "actual": { "high": 6.1, "mid": 20.8, "low": 46.9, "fallback": 26.2, "empty_rate": 26.2 },
  "drift": { "high": 0.9, "mid": -1.3, "low": -1.4, "fallback": 1.8, "empty_rate": 1.8 },
  "drift_percentage": { "high": 17.3, "mid": 5.9, "low": 2.9, "fallback": 7.4, "empty_rate": 7.4 },
  "actual_draws_count": 350,
  "period": "2026-02-20T10:00:00+08:00 ~ 2026-02-21T10:00:00+08:00"
}
```

---

## 七、数据流架构

```
┌──────────────────────────────────────────────────────┐
│                 前端 (Alpine.js Composable)            │
│                                                       │
│  参数沙盒 ──→ 运行模拟按钮 ──→ POST /simulation/run  │
│                                   │                   │
│              ┌────────────────────┘                   │
│              ↓                                        │
│  对比分析面板 ←── 模拟结果                             │
│  (ECharts 双柱状图、热力图、指标卡片、风险灯)          │
│                                                       │
│  参数沙盒 ──→ POST /simulation/user-journey           │
│                       │                               │
│                       ↓                               │
│  用户旅程时间线 ←── 逐次抽奖详情                       │
└───────────────────────┬──────────────────────────────┘
                        │
                        ↓
┌──────────────────────────────────────────────────────┐
│            后端 (StrategySimulationService)            │
│                                                       │
│  加载当前配置 ──→ 合并提议参数（仅内存中）              │
│       │                                               │
│       ↓                                               │
│  Monte Carlo 引擎                                     │
│  (复用 TierPickStage / PityCalculator 等纯函数)        │
│       │                                               │
│       ↓                                               │
│  聚合 N 次结果 ──→ 对比分析 ──→ 风险评估              │
│       │                                               │
│       ↓                                               │
│  返回结果（不写数据库）                                │
└───────────────────────┬──────────────────────────────┘
                        │
                        ↓ (只读)
┌──────────────────────────────────────────────────────┐
│                   数据库（只读访问）                    │
│                                                       │
│  lottery_tier_rules          → 基础权重               │
│  lottery_tier_matrix_config  → BxPx 矩阵             │
│  lottery_strategy_config     → 策略参数               │
│  lottery_draws               → 历史真实分布            │
│  lottery_draw_decisions      → BxPx 命中分布          │
└──────────────────────────────────────────────────────┘
```

---

## 八、其他决策点

### 8.1 模拟历史保存（决策点 9）— 已确认：方案 C 服务端保存

> **决定**：新建 `lottery_simulation_records` 表，保存模拟参数 + 结果快照，支持多人协作回溯。

**新增数据库表设计（对齐项目现有 Sequelize Model 规范）：**

| 字段 | 类型 | 说明 |
|---|---|---|
| `lottery_simulation_record_id` | INT AUTO_INCREMENT | 主键（对齐项目命名规范：表名单数 + `_id`） |
| `lottery_campaign_id` | INT, NOT NULL | 关联活动 ID，外键 → `lottery_campaigns` |
| `simulation_name` | VARCHAR(100), NULL | 操作者给模拟取的名称（可选） |
| `simulation_count` | INT, NOT NULL | 模拟迭代次数 |
| `proposed_config` | JSON, NOT NULL | 模拟使用的提议参数快照 |
| `scenario` | JSON, NOT NULL | 场景配置（预算/压力/分群分布） |
| `simulation_result` | JSON | 模拟结果（档位分布、触发率等） |
| `comparison` | JSON | 与当前配置的对比 delta |
| `risk_assessment` | JSON | 风险评估结果 |
| `created_by` | INT | 操作者用户 ID，外键 → `users` |
| `status` | ENUM('draft','applied','archived'), DEFAULT 'draft' | 模拟记录状态（一键应用后标记 `applied`） |
| `applied_at` | DATETIME, NULL | 配置应用到线上的时间 |
| `applied_by` | INT, NULL | 执行应用操作的用户 ID |
| `actual_result` | JSON, NULL | 偏差追踪：实际数据统计结果（手动触发填充） |
| `drift_metrics` | JSON, NULL | 偏差追踪：各维度偏差百分比 |
| `drift_calculated_at` | DATETIME, NULL | 偏差计算时间 |
| `created_at` | DATETIME | 创建时间 |
| `updated_at` | DATETIME | 更新时间 |

> 数据库已确认该表 **不存在**（2026-02-20 校验），需新建 migration。
> Model 文件放 `models/LotterySimulationRecord.js`，在 `models/index.js` 中注册。

### 8.2 权限控制（决策点 12）— 已确认：方案 A

> **决定**：复用策略管理权限，能看到"策略管理"Tab 的人就能使用模拟。模拟是只读操作，不需要额外权限项。

---

## 九、涉及文件清单（对齐项目实际结构）

### 新建文件

| 文件路径 | 说明 | 责任端 |
|---|---|---|
| `services/lottery-analytics/StrategySimulationService.js` | Monte Carlo 引擎 + 三维成本分析 + 对比分析，复用 `compute/calculators/` | 后端 |
| `routes/v4/console/lottery-simulation.js` | 独立路由文件（7 个 simulation API：baseline/run/user-journey/sensitivity/recommend/apply/drift + 历史记录 CRUD），中间件链: `authenticateToken` + `requireRoleLevel(100)` | 后端 |
| `models/LotterySimulationRecord.js` | 模拟记录 Sequelize Model（`lottery_simulation_records` 表） | 后端 |
| `migrations/xxxxxxxx-add-lottery-simulation-records.js` | 创建 `lottery_simulation_records` 表 | 后端 |
| `migrations/xxxxxxxx-add-campaign-id-to-matrix-and-strategy-config.js` | 给 `lottery_tier_matrix_config` 和 `lottery_strategy_config` 加 `lottery_campaign_id` 列 + 回填 + 索引 | 后端 |
| `migrations/xxxxxxxx-convert-admin-operation-log-type-to-varchar.js` | `admin_operation_logs.operation_type` ENUM 转 VARCHAR(50)，Model 层改 `DataTypes.STRING(50)` | 后端 |
| `migrations/xxxxxxxx-convert-lottery-alert-type-to-varchar.js` | `lottery_alerts.alert_type` ENUM 转 VARCHAR(50)，Model 层改 `DataTypes.STRING(50)` | 后端 |
| `admin/src/modules/lottery/composables/strategy-simulation.js` | 页面状态（`useStrategySimulationState()` + `useStrategySimulationMethods()`），对齐现有 `strategy.js` composable 模式 | Web 前端 |

### 修改文件

| 文件路径 | 改动内容 | 责任端 |
|---|---|---|
| `routes/v4/console/index.js` | `router.use('/lottery-simulation', require('./lottery-simulation'))` | 后端 |
| `models/index.js` | `models.LotterySimulationRecord = require('./LotterySimulationRecord')(sequelize, DataTypes)` | 后端 |
| `models/LotteryTierMatrixConfig.js` | 加 `lottery_campaign_id` 字段 + 外键关联 | 后端 |
| `models/LotteryStrategyConfig.js` | 加 `lottery_campaign_id` 字段 + 外键关联 | 后端 |
| `services/index.js` | 在 ServiceManager 注册 `strategy_simulation` 服务 | 后端 |
| `services/UnifiedLotteryEngine/compute/config/StrategyConfig.js` | 配置加载逻辑加 `lottery_campaign_id` 过滤 | 后端 |
| `routes/v4/console/lottery-strategy-stats.js` | 现有 config-summary 接口加 `lottery_campaign_id` 过滤 | 后端 |
| `admin/src/modules/lottery/composables/index.js` | 导出新 composable | Web 前端 |
| `admin/src/modules/lottery/composables/strategy.js` | 策略管理 API 调用加 `lottery_campaign_id` 参数 | Web 前端 |
| `admin/src/modules/lottery/pages/lottery-management.js` | 在 `categoryTabs` 中添加 `{ id: 'strategy-simulation', title: '策略模拟', icon: '🧪' }` | Web 前端 |
| `admin/lottery-management.html` | 添加 `x-show="current_page === 'strategy-simulation'"` 的 HTML 模板区域 | Web 前端 |
| `admin/src/utils/echarts-lazy.js` | 添加 `HeatmapChart` 导入 | Web 前端 |

> 注意：**不需要修改 `sidebar-nav.js`**，因为模拟页面是 `lottery-management.html` 内的 Tab，不是独立菜单项。

---

## 十、基于真实数据的模拟效果预期

当前核心问题：base weight 设定 high=5%，但实际出高档位 58.04%。原因是 100% 用户都在 B3 层，BxPx 矩阵和 tier_first 模式下权重归一化放大了 high 档位。

模拟页面能回答的典型问题：

| 问题 | 操作 | 预期 |
|---|---|---|
| B3P1 的 high_multiplier 从 1.0 降到 0.3，high 比例会降多少？ | 修改矩阵参数 → 跑模拟 | 得到精确预测 |
| base weight 中 high 从 50,000 降到 20,000，最终分布如何？ | 修改基础权重 → 跑模拟 | 得到精确预测 |
| pity 硬保底阈值从 10 降到 5，触发率增加多少？空奖率改善多大？ | 修改 pity 参数 → 跑模拟 | 得到触发率和空奖率预估 |
| 30% 用户预算下降到 B2，整体出奖分布怎么变？ | 自定义场景分布 → 跑模拟 | 得到新分布预测 |

---

## 十一、风险和局限性

以下局限性需要在页面 UI 中明确提示操作者：

1. **模拟假设均匀随机**：真实用户行为有时段规律、流失倾向、预算变化，模拟无法建模
2. **体验状态是累积的**：Pity/AntiEmpty/AntiHigh 是按用户累积的。Monte Carlo 模拟的是独立用户会话，不是全量用户群的状态机
3. **预算分布是关键输入**：如果真实分布变化（如大量用户从 B3 降到 B2），实际结果会偏离模拟
4. **8% 硬顶始终生效**：模拟中与生产一致，high 档位概率不会超过 8%
5. ~~**库存约束未建模**~~ → **已通过增强模块 8 解决**：模拟循环内跟踪每个奖品的模拟库存，库存为 0 时触发降级，与生产逻辑对齐（`500积分券` 和 `九八折券` 已耗尽的情况会被正确模拟）

---

## 十二、工作量估算（全量方案 + 6 项增强 + 5 项运维闭环 + 服务端保存）

**核心模块（Phase 2-4）：**

| 模块 | 后端 | 前端 | 合计 |
|---|---|---|---|
| baseline API + SimulationService 基础框架 | 1 天 | - | 1 天 |
| Monte Carlo 引擎（含库存约束建模，增强 8） | 2 天 | - | 2 天 |
| 参数沙盒 UI（含 BxPx 双模式切换） | - | 2 天 | 2 天 |
| 对比分析面板（7 项图表 + 三维成本卡片） | - | 2 天 | 2 天 |
| 用户旅程模拟（完整版权重变化链） | 0.5 天 | 1 天 | 1.5 天 |
| 模拟历史保存（Model + Migration + CRUD API + 前端列表） | 0.5 天 | 0.5 天 | 1 天 |
| 场景预设库（4 个预设 + 微调 UI） | - | 0.5 天 | 0.5 天 |
| **核心小计** | **4 天** | **6 天** | **10 天** |

**增强模块（Phase 5-6）：**

| 模块 | 后端 | 前端 | 合计 |
|---|---|---|---|
| 增强 5：灵敏度分析（API + 扫射循环） | 0.5 天 | 1 天 | 1.5 天 |
| 增强 6：目标反推（网格搜索 + Top3 返回） | 1 天 | 0.5 天 | 1.5 天 |
| 增强 7：多方案并排（前端多方案状态 + 批量调用） | - | 1 天 | 1 天 |
| 增强 9：偏差追踪（drift API + 历史列表偏差列） | 0.5 天 | 0.5 天 | 1 天 |
| 增强 10：一键应用（apply API + 事务写入 + 审计） | 0.5 天 | 0.5 天 | 1 天 |
| **增强小计** | **2.5 天** | **3.5 天** | **6 天** |

**运维闭环模块（Phase 7）：**

| 模块 | 后端 | 前端 | 合计 |
|---|---|---|---|
| 运维 11：定时生效（利用已有 `effective_start`/`effective_end` 字段） | 0.5 天 | 0.5 天 | 1 天 |
| 运维 12：配置版本回滚（利用已有 `AdminOperationLog.before_data`） | 0.5 天 | 1 天 | 1.5 天 |
| 运维 13：预算节奏预测（利用已有 `lottery_draws` + `hourly_metrics`） | 0.5 天 | 1 天 | 1.5 天 |
| 运维 14：异常熔断联动（利用已有 `lottery_alerts` + `alert_silence_rules`） | 1 天 | 0.5 天 | 1.5 天 |
| 运维 15：模拟报告导出（纯前端 `html2canvas` + `jspdf` + `xlsx`） | - | 0.5 天 | 0.5 天 |
| **运维小计** | **2.5 天** | **3.5 天** | **6 天** |

**基础设施 + 联调：**

| 模块 | 后端 | 前端 | 合计 |
|---|---|---|---|
| campaign_id 迁移（2 张表加列 + 回填 + 现有逻辑修改） | 1.5 天 | 0.5 天 | 2 天 |
| ENUM 扩展迁移（admin_operation_logs + lottery_alerts） | 0.5 天 | - | 0.5 天 |
| 联调 + 测试 | 1.5 天 | 1.5 天 | 3 天 |
| **基础设施小计** | **3.5 天** | **2 天** | **5.5 天** |

| | 后端 | 前端 | 合计 |
|---|---|---|---|
| **总计** | **12.5 天** | **15 天** | **27.5 天** |

---

## 十三、决策清单汇总（全部已确认）

| # | 决策点 | 确认方案 |
|---|---|---|
| 1 | 页面放置位置 | **A** — lottery-management 新 Tab (`?page=strategy-simulation`) |
| 2 | 模拟引擎执行位置 | **A** — 后端 Node.js 服务端计算 |
| 3 | 功能模块取舍 | **全量方案 + 6 项增强** — 4 核心 + 6 增强全部实现 |
| 4 | 参数沙盒 UI 形式 | **A** — 左右对比布局（当前值只读 + 模拟值可编辑） |
| 5 | BxPx 矩阵编辑方式 | **A+B 双模式** — 热力图 + 全矩阵表格，提供切换按钮 |
| 6 | 对比分析图表选择 | **7 项全做** — 双柱状图、双热力图、触发率卡片、三维成本卡、风险灯、连击直方图、累积曲线 |
| 7 | 场景预设能力 | **C** — 预设场景库（当前真实/均匀分布/低预算增多/高压力场景）+ 可微调 |
| 8 | 用户旅程深度 | **B** — 完整版（每抽展示完整权重变化链） |
| 9 | 模拟历史保存 | **C** — 服务端保存（新建 lottery_simulation_records 表，含偏差追踪字段） |
| 10 | 后端路由组织 | **B** — 独立路由文件 `routes/v4/console/lottery-simulation.js`（7 个 API） |
| 11 | 模拟精度选择 | **B** — 操作者可选：快速(1K) / 标准(10K) / 精确(50K) |
| 12 | 权限控制 | **A** — 复用策略管理权限（`requireRoleLevel(100)`） |
| 13 | 成本指标维度 | **A+B 混合** — 三维成本矩阵：用户侧(`cost_points`) + 平台侧(`budget_deducted`) + 奖品价值(`prize_value`) |
| 14 | 矩阵/策略配置作用域 | **B** — 现在就加 `lottery_campaign_id` 列，提前做好多活动准备 |
| 15 | 增强模块范围 | **全量** — 6 项增强全部实现（灵敏度/目标反推/多方案/库存/偏差/一键应用） |
| 16 | 运维闭环模块范围 | **全量** — 5 项运维闭环全部实现（定时生效/版本回滚/预算节奏/异常熔断/报告导出） |
| 17 | `admin_operation_logs.operation_type` ENUM 处理 | ✅ **B** — 转 VARCHAR(50)，一次性改完，后续新增类型只改代码 |
| 18 | `lottery_alerts.alert_type` ENUM 处理 | ✅ **B** — 转 VARCHAR(50)，与决策 17 保持一致 |

---

## 十四、后端技术栈可复用/可扩展分析

### 14.1 可直接复用（无需修改）

| 现有组件 | 复用方式 | 节省工作量 |
|---|---|---|
| `compute/calculators/TierMatrixCalculator` | 构造时注入模拟矩阵配置，调用 `calculate()` 得到调整后权重 | 矩阵乘数计算不用重写 |
| `compute/calculators/PityCalculator` | 构造时注入模拟 pity 配置，调用 `calculate()` 得到 pity 调整后权重 | Pity 乘数逻辑不用重写 |
| `compute/calculators/BudgetTierCalculator` | 注入阈值配置，判断 B0-B3 | 预算分层不用重写 |
| `compute/calculators/PressureTierCalculator` | 注入阈值配置，判断 P0-P2 | 压力分层不用重写 |
| `TierPickStage._enforceHighTierCap()` | 直接调用静态方法 | 8% 硬顶不用重写 |
| `TierPickStage._pickTier()` | 直接调用静态方法 | 随机选档位不用重写 |
| `admin/src/utils/echarts-lazy.js` | 前端图表渲染基础设施已就绪 | 不用配置 ECharts |
| `admin/src/api/base.js` | API 请求基础设施（fetch + token + 标准响应处理） | 不用写 HTTP 层 |
| 现有 composable 模式 (`useXxxState()` + `useXxxMethods()`) | 前端状态管理模式一致 | 架构一致性 |
| `authenticateToken` + `requireRoleLevel(100)` 中间件链 | 路由鉴权直接复用 | 不用写权限逻辑 |
| `res.apiSuccess()` / `res.apiError()` 响应工具 | 标准响应格式 | 不用定义响应结构 |
| ServiceManager 注册模式 | `req.app.locals.services.getService()` | 服务发现一致 |

### 14.2 需要新建但可扩展

| 新建组件 | 扩展性设计 |
|---|---|
| `StrategySimulationService` | 未来可支持多活动对比、A/B 测试模拟、定时自动模拟 |
| `LotterySimulationRecord` Model | JSON 字段（proposed_config/scenario/result）天然支持配置结构变化 |
| 前端 composable `strategy-simulation.js` | 可扩展更多图表类型、场景预设 |

### 14.3 Web 管理后台前端技术栈兼容性确认

| 技术项 | 项目现有 | 模拟页面需要 | 兼容性 |
|---|---|---|---|
| 框架 | Alpine.js (ES Module) | Alpine.js composable | ✅ 完全兼容 |
| CSS | Tailwind + themed-* 自定义类 | 同上 | ✅ 完全兼容 |
| 图表 | ECharts (tree-shaken lazy load) | 双柱状图、热力图、折线图、直方图 | ✅ 已支持 BarChart/LineChart，需新增 HeatmapChart 导入 |
| API | native fetch + base.js wrapper | apiGet/apiCall | ✅ 完全兼容 |
| 页面注册 | categoryTabs + x-show + loadPageData() | 新增 Tab 入口 | ✅ 完全兼容 |
| 状态管理 | useXxxState() + useXxxMethods() + spread | 同上 | ✅ 完全兼容 |

> ECharts 需额外导入 `HeatmapChart` 组件到 `echarts-lazy.js`（当前未导入），这是唯一的前端依赖变更。

---

## 十五、问题归属分类

### 15.1 后端数据库项目的问题（需后端实施）

| # | 问题 | 具体内容 |
|---|---|---|
| B1 | 新建 migration | 创建 `lottery_simulation_records` 表（DB 已确认不存在） |
| B2 | 新建 Model | `models/LotterySimulationRecord.js` + 注册到 `models/index.js` |
| B3 | 新建 Service | `services/lottery-analytics/StrategySimulationService.js`，复用 `compute/calculators/*` |
| B4 | 新建路由 | `routes/v4/console/lottery-simulation.js`，7 个 API + 历史记录 CRUD |
| B5 | 注册路由 | `routes/v4/console/index.js` 添加挂载 |
| B6 | 注册服务 | `services/index.js` 的 ServiceManager 中注册 |
| B7 | 矩阵/策略加 campaign_id | 给 `lottery_tier_matrix_config` 和 `lottery_strategy_config` 加 `lottery_campaign_id` 列，回填现有数据为 campaign_id=1 |
| B8 | 更新配置加载逻辑 | `compute/config/StrategyConfig.js` 按 campaign_id 过滤 |
| B9 | 更新现有策略接口 | `lottery-strategy-stats.js` 的 config-summary 加 campaign_id |
| B10 | 增强：灵敏度分析 API | `StrategySimulationService.runSensitivityAnalysis()` + 路由 `/sensitivity` |
| B11 | 增强：目标反推 API | `StrategySimulationService.recommendConfig()` 网格搜索 + 路由 `/recommend` |
| B12 | 增强：偏差追踪 API | `StrategySimulationService.calculateDrift()` + 路由 `/drift/:id` |
| B13 | 增强：一键应用 API | `StrategySimulationService.applySimulation()` 事务写入 + 审计 + 路由 `/apply/:id` |
| B14 | 增强：库存约束建模 | Monte Carlo 循环内跟踪模拟库存，复用 `TierPickStage._applyDowngrade` 降级逻辑 |
| B15 | 运维：定时生效 | 利用已有 `effective_start`/`effective_end`，配置加载加时间条件 |
| B16 | 运维：版本回滚 | 从 `AdminOperationLog.before_data` 回写配置表，事务内完成 |
| B17 | 运维：预算节奏预测 | baseline API 新增每日预算消耗趋势 + 耗尽日期预测 |
| B18 | 运维：异常熔断联动 | 一键应用时写入 `lottery_alerts` 监控规则，hourly_metrics 检查时触发熔断 |
| B19 | ENUM → VARCHAR：`admin_operation_logs.operation_type` | ENUM 转 VARCHAR(50) + Model 层改 `DataTypes.STRING(50)` + Service/Model 层值校验 |
| B20 | ENUM → VARCHAR：`lottery_alerts.alert_type` | ENUM 转 VARCHAR(50) + Model 层改 `DataTypes.STRING(50)` + Service/Model 层值校验 |

### 15.2 Web 管理后台前端项目的问题（需 Web 前端实施）

| # | 问题 | 具体内容 |
|---|---|---|
| W1 | 新建 composable | `admin/src/modules/lottery/composables/strategy-simulation.js` |
| W2 | 注册 Tab | `lottery-management.js` 的 `categoryTabs` 添加入口 |
| W3 | HTML 模板 | `lottery-management.html` 添加 `x-show` 区域 |
| W4 | ECharts 扩展 | `echarts-lazy.js` 添加 `HeatmapChart` 导入 |
| W5 | 导出 composable | `composables/index.js` 导出新 composable |
| W6 | 字段名对齐 | 前端直接使用后端 DB 字段名（`tier_weight`/`config_group`/`reward_tier` 等），不做映射 |
| W7 | 现有策略管理适配 | `strategy.js` composable 的 API 调用加 `lottery_campaign_id` 参数 |
| W8 | 增强：灵敏度分析 UI | 参数选择器 + ECharts 多指标折线图 + 安全/危险区间背景色 |
| W9 | 增强：目标反推 UI | 约束输入表单 + Top3 推荐方案卡片 |
| W10 | 增强：多方案并排 UI | 方案保存/命名 + 多列对比表格 + 最优值高亮 |
| W11 | 增强：偏差追踪 UI | 历史列表"对比实际"按钮 + 偏差率颜色编码列 |
| W12 | 增强：一键应用 UI | 对比面板"应用到线上"按钮 + diff 确认对话框 |
| W13 | 运维：定时生效 UI | "定时应用"选项 + 日期时间选择器 + "待生效"标签倒计时 |
| W14 | 运维：版本回滚 UI | 变更历史时间线面板 + diff 视图 + "回滚到此版本"按钮 |
| W15 | 运维：预算节奏预测 UI | ECharts 折线图（历史实线+预测虚线+耗尽红线） |
| W16 | 运维：异常熔断 UI | "监控绑定状态"标签（绿/黄/红） |
| W17 | 运维：报告导出 | "导出报告"按钮 + `html2canvas`/`jspdf`/`xlsx` 前端依赖 |

### 15.3 微信小程序前端项目的问题

| # | 结论 |
|---|---|
| 无 | 策略模拟分析是纯后台管理功能，微信小程序端 **无任何改动需求** |

---

## 十六、决策确认记录

### 16.1 ✅ 已确认：Section 1.2 "平均消耗积分" 数据来源与三维成本方案

**数据溯源结论**：原稿的"平均消耗积分"来自 `lottery_draws.cost_points`（用户每次抽奖花费的积分），与 `lottery_draw_decisions.budget_deducted`（平台侧预算消耗）是完全不同的成本维度。

**确认方案：A+B 混合（三维成本矩阵）**

保留原稿 `cost_points` 数据（用户侧成本），模拟输出同时展示三个维度：

| 指标 | DB 来源 | 用途 | 行业对标 |
|---|---|---|---|
| 用户每次抽奖消耗 | `AVG(lottery_draws.cost_points)` 按档位 | 用户体验是否合理 | 游戏公司视角 |
| 每千次预估奖品发放价值 | `SUM(lottery_draws.prize_value) / draws × 1000` | 平台实际成本 | 美团核心指标 |
| 每千次预估预算消耗 | `SUM(lottery_draw_decisions.budget_deducted) / draws × 1000` | 预算耗尽预警 | 美团预算控制 |
| 奖品成本率 | 奖品发放总价值 / 用户消耗总积分 | 盈亏平衡红线 | 美团关键红线 |
| Pity/AntiEmpty/AntiHigh 触发率 | 模拟统计 | 用户体验保障 | 游戏公司核心 |
| 平均首次非空所需抽数 | 模拟统计 | 新用户体验 | 游戏公司视角 |

### 16.2 ✅ 已确认：矩阵/策略配置加 `lottery_campaign_id` 列

**确认方案：B — 现在就加 `lottery_campaign_id` 列**

对 `lottery_tier_matrix_config` 和 `lottery_strategy_config` 两张表新增 `lottery_campaign_id` 列，提前做好多活动准备。

**实施要点：**
- 新增 migration：给两张表加 `lottery_campaign_id` 列（INT, NULL，外键 → `lottery_campaigns`）
- 数据回填：现有数据全部回填 `lottery_campaign_id = 1`（当前唯一活动）
- 回填后改为 NOT NULL + 添加索引
- 修改 baseline 查询逻辑：改为 `WHERE lottery_campaign_id = :id`
- 修改现有策略管理页面的读写逻辑：加上 campaign_id 过滤
- 修改 `compute/calculators/` 中的配置加载逻辑：按 campaign_id 查询

**新增 migration 文件**（追加到 Phase 1）：
- `migrations/xxxxxxxx-add-campaign-id-to-matrix-and-strategy-config.js`

**受影响的现有文件**（追加到修改文件清单）：
- `models/LotteryTierMatrixConfig.js` — Model 加字段 + 外键
- `models/LotteryStrategyConfig.js` — Model 加字段 + 外键
- `services/UnifiedLotteryEngine/compute/config/StrategyConfig.js` — 配置加载加 campaign_id 过滤
- `routes/v4/console/lottery-strategy-stats.js` — 现有 config-summary 接口加 campaign_id
- `admin/src/modules/lottery/composables/strategy.js` — 前端策略管理加 campaign_id 参数

---

## 十七、实施步骤（按依赖顺序）

### Phase 1: 后端基础设施（预计 3 天）

| 步骤 | 操作 | 文件 |
|---|---|---|
| 1 | 创建 migration：`lottery_simulation_records` 表 | `migrations/xxxxxxxx-add-lottery-simulation-records.js` |
| 2 | 创建 migration：给 `lottery_tier_matrix_config` 和 `lottery_strategy_config` 加 `lottery_campaign_id` 列 + 回填 + NOT NULL + 索引 | `migrations/xxxxxxxx-add-campaign-id-to-matrix-and-strategy-config.js` |
| 2.1 | 创建 migration：`admin_operation_logs.operation_type` ENUM → VARCHAR(50)，同步修改 `models/AdminOperationLog.js` 的 `DataTypes.ENUM` → `DataTypes.STRING(50)` | `migrations/xxxxxxxx-convert-admin-operation-log-type-to-varchar.js` |
| 2.2 | 创建 migration：`lottery_alerts.alert_type` ENUM → VARCHAR(50)，同步修改 `models/LotteryAlert.js` 的 `DataTypes.ENUM` → `DataTypes.STRING(50)` | `migrations/xxxxxxxx-convert-lottery-alert-type-to-varchar.js` |
| 3 | 创建 Model：`LotterySimulationRecord` | `models/LotterySimulationRecord.js` |
| 4 | 更新 Model：`LotteryTierMatrixConfig` 加 `lottery_campaign_id` 字段 + 外键 | `models/LotteryTierMatrixConfig.js` |
| 5 | 更新 Model：`LotteryStrategyConfig` 加 `lottery_campaign_id` 字段 + 外键 | `models/LotteryStrategyConfig.js` |
| 6 | 注册 Model | `models/index.js` 添加 `LotterySimulationRecord` |
| 7 | 运行 migration | `npx sequelize-cli db:migrate` |
| 8 | 更新配置加载逻辑：按 `lottery_campaign_id` 过滤 | `compute/config/StrategyConfig.js` |
| 9 | 更新现有策略管理接口：加 `campaign_id` 过滤 | `routes/v4/console/lottery-strategy-stats.js` |

### Phase 2: 后端模拟引擎（预计 2 天）

| 步骤 | 操作 | 文件 |
|---|---|---|
| 10 | 创建 StrategySimulationService，require 并复用 `TierMatrixCalculator`、`PityCalculator`、`AntiEmptyStreakHandler`、`AntiHighStreakHandler`、`TierPickStage._enforceHighTierCap` | `services/lottery-analytics/StrategySimulationService.js` |
| 11 | 实现 `loadBaseline(lottery_campaign_id)` — 3 个表查询全部按 `lottery_campaign_id` 过滤 + draws 统计 | 同上 |
| 12 | 实现 `runSimulation(proposed_config, scenario, count)` — Monte Carlo 循环，每轮调用 calculator 纯函数，输出三维成本矩阵 | 同上 |
| 13 | 实现 `simulateUserJourney(proposed_config, user_profile, draw_count)` — 单用户连续模拟 | 同上 |
| 14 | 实现对比分析（含 cost_delta）和风险评估逻辑（含奖品成本率风险） | 同上 |

### Phase 3: 后端路由 — 核心 API（预计 0.5 天）

| 步骤 | 操作 | 文件 |
|---|---|---|
| 15 | 创建路由文件，3 个核心 API（baseline/run/user-journey）+ 历史记录 CRUD | `routes/v4/console/lottery-simulation.js` |
| 16 | 注册路由到 console/index.js | `routes/v4/console/index.js` |
| 17 | 注册服务到 ServiceManager | `services/index.js` |

### Phase 4: Web 前端 — 核心模块（预计 6 天）

| 步骤 | 操作 | 文件 |
|---|---|---|
| 18 | `echarts-lazy.js` 添加 HeatmapChart 导入 | `admin/src/utils/echarts-lazy.js` |
| 19 | 创建 composable（`useStrategySimulationState()` + `useStrategySimulationMethods()`） | `admin/src/modules/lottery/composables/strategy-simulation.js` |
| 20 | 注册 Tab 入口到 categoryTabs | `admin/src/modules/lottery/pages/lottery-management.js` |
| 21 | 创建 HTML 模板区域（参数沙盒 + 三维成本卡片 + 对比面板 + 用户旅程 + 历史记录） | `admin/lottery-management.html` |
| 22 | 导出 composable | `admin/src/modules/lottery/composables/index.js` |
| 23 | 更新现有策略管理 composable：API 调用加 `lottery_campaign_id` 参数 | `admin/src/modules/lottery/composables/strategy.js` |

### Phase 5: 后端增强 API（预计 2.5 天）

| 步骤 | 操作 | 文件 |
|---|---|---|
| 24 | 增强 5 — 灵敏度分析：`runSensitivityAnalysis()`，循环调用 `runSimulation()` 每步一次 | `services/lottery-analytics/StrategySimulationService.js` |
| 25 | 增强 6 — 目标反推：`recommendConfig()`，网格搜索 + 快速模拟筛选 + 精确验证 | 同上 |
| 26 | 增强 9 — 偏差追踪：`calculateDrift()`，查询模拟后的实际 `lottery_draw_decisions` 数据 | 同上 |
| 27 | 增强 10 — 一键应用：`applySimulation()`，事务写入 + `AdminOperationLog` 审计 | 同上 |
| 28 | 路由注册：4 个增强 API（sensitivity/recommend/apply/drift） | `routes/v4/console/lottery-simulation.js` |

### Phase 6: Web 前端增强模块（预计 3.5 天）

| 步骤 | 操作 | 文件 |
|---|---|---|
| 29 | 增强 5 — 灵敏度分析 UI：参数选择器 + ECharts 多指标折线图（含安全/危险区间背景色） | composable + HTML |
| 30 | 增强 6 — 目标反推 UI：约束输入表单 + Top3 推荐方案卡片 | composable + HTML |
| 31 | 增强 7 — 多方案并排：方案保存按钮 + 多列对比表格 + 最优值高亮 | composable + HTML |
| 32 | 增强 9 — 偏差追踪 UI：历史列表"对比实际"按钮 + 偏差率颜色编码列 | composable + HTML |
| 33 | 增强 10 — 一键应用 UI：对比面板"应用到线上"按钮 + diff 确认对话框 | composable + HTML |

### Phase 7: 运维闭环 — 后端（预计 2.5 天）

| 步骤 | 操作 | 文件 |
|---|---|---|
| 34 | 运维 11 — 定时生效：`StrategyConfig.js` 配置加载加 `effective_start`/`effective_end` 时间条件 | `compute/config/StrategyConfig.js` |
| 35 | 运维 12 — 版本回滚：`rollbackConfig()` 从 `AdminOperationLog.before_data` 回写，事务内完成 | `StrategySimulationService.js` |
| 36 | 运维 13 — 预算节奏预测：baseline API 新增每日消耗趋势 + 耗尽日期预测 | `StrategySimulationService.js` |
| 37 | 运维 14 — 异常熔断：`applySimulation()` 时写入 `lottery_alerts` 监控规则，hourly_metrics 检查时比对触发 | `StrategySimulationService.js` + 现有定时任务 |

### Phase 8: 运维闭环 — 前端（预计 3.5 天）

| 步骤 | 操作 | 文件 |
|---|---|---|
| 38 | 运维 11 — 定时生效 UI：日期时间选择器 + "待生效"倒计时标签 | composable + HTML |
| 39 | 运维 12 — 版本回滚 UI：变更历史时间线 + diff 视图 + "回滚"按钮 | composable + HTML |
| 40 | 运维 13 — 预算节奏 UI：ECharts 折线图（历史实线 + 预测虚线 + 耗尽红线） | composable + HTML |
| 41 | 运维 14 — 异常熔断 UI："监控绑定状态"标签（绿/黄/红） | composable + HTML |
| 42 | 运维 15 — 报告导出：`html2canvas` + `jspdf`（PDF）+ `xlsx`（Excel） | composable + HTML |

### Phase 9: 联调 + 测试（预计 3 天）

| 步骤 | 操作 |
|---|---|
| 43 | 核心 API 单元测试（baseline 加载、campaign_id 过滤、模拟结果一致性、库存约束效果） |
| 44 | 增强 API 单元测试（灵敏度扫射收敛性、目标反推约束满足率、一键应用事务完整性） |
| 45 | 运维模块测试（定时生效时间窗口、回滚完整性、熔断触发条件、PDF/Excel 导出完整性） |
| 46 | 前后端联调（全 15 模块端到端验证） |
| 47 | 对比真实数据验证模拟精度 |

**总工时：Phase 1(3d) + Phase 2(2d) + Phase 3(0.5d) + Phase 4(6d) + Phase 5(2.5d) + Phase 6(3.5d) + Phase 7(2.5d) + Phase 8(3.5d) + Phase 9(3d) = 27 天**

> Phase 1 从 2.5d 增至 3d，因新增 ENUM 扩展迁移（步骤 2.1、2.2）。

---

## 十八、需要拍板的新决策（二次校验发现）

> 以下决策是通过 Node.js 连接真实数据库、逐表校验 DESCRIBE 后发现的新问题，原始文档未覆盖。

### 18.1 ✅ `admin_operation_logs.operation_type` — 已确认：转 VARCHAR(50)

**现状**：`operation_type` 列是 ENUM 类型，当前包含约 35 个固定值（如 `points_adjust`、`campaign_config`、`lottery_force_win` 等）。

**问题**：本方案需要新增 5 个操作类型值：
- `simulation_apply` — 一键应用模拟配置到线上（模块 10）
- `config_rollback` — 配置版本回滚（模块 12）
- `strategy_config_update` — 策略配置更新（版本历史查询用）
- `matrix_config_update` — 矩阵配置更新（版本历史查询用）
- `tier_rules_update` — 基础权重更新（版本历史查询用）

| 方案 | 做法 | 优点 | 缺点 | 长期维护成本 |
|---|---|---|---|---|
| ~~A：扩展 ENUM~~ | ~~ALTER TABLE 加新值~~ | ~~数据库层类型安全~~ | ~~每次新增要写 migration~~ | ~~中~~ |
| **B：转 VARCHAR(50)** ✅ | `ALTER TABLE admin_operation_logs MODIFY operation_type VARCHAR(50) NOT NULL` | 无需后续 migration；新增类型只改代码 | 失去数据库层校验（Model/Service 层补偿） | 低（一次性改完） |

> **决策已确认：方案 B（转 VARCHAR）**。Migration 将 `DataTypes.ENUM(...)` 改为 `DataTypes.STRING(50)`，同时在 Model 的 `validate` 或 Service 层做值校验。后续任何模块新增操作类型只需改代码常量，不用写 migration。

### 18.2 ✅ `lottery_alerts.alert_type` — 已确认：转 VARCHAR(50)

**现状**：`alert_type` 列是 ENUM 类型，当前 5 个值：`win_rate`、`budget`、`inventory`、`user`、`system`。

**问题**：运维模块 14（异常熔断联动）需要新增 `simulation_bound` 类型。

> **决策已确认：方案 B（转 VARCHAR）**，与 18.1 保持一致。Migration 将 ENUM 转为 `VARCHAR(50) NOT NULL`，Model 层改 `DataTypes.STRING(50)`。

### 18.3 数据漂移说明（无需拍板，仅告知）

系统持续运行中，自初始校验以来新增 234 次抽奖（2,400 → 2,634）。关键变化：
- **low 档位占比显著上升**：9.71% → 16.10%（+6.39%），low→low 从 233 增至 424
- **P2（高压力）占比上升**：13.4% → 21.11%（+7.71%）
- **mid 平均用户成本上升**：20.11 → 34.44 积分
- **AntiHigh 触发次数增加**：9 → 14 次

这些变化不影响设计方案，baseline API 始终从数据库实时查询最新值。但说明模拟工具的价值 — 运营者可以在参数调整前预测这些趋势变化的影响。
