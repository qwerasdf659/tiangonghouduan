# ç­–ç•¥æ•ˆæœæ¨¡æ‹Ÿåˆ†æé¡µé¢ â€” è®¾è®¡æ–¹æ¡ˆ

> ç”Ÿæˆæ—¥æœŸï¼š2026-02-20
> å†³ç­–ç¡®è®¤æ—¥æœŸï¼š2026-02-20
> æ•°æ®åº“çœŸå®æ•°æ®æ ¡éªŒæ—¥æœŸï¼š2026-02-20
> åŸºäºé¡¹ç›®å®é™…ä»£ç å’Œæ•°æ®åº“çœŸå®æ•°æ®ç¼–å†™
> çŠ¶æ€ï¼š**å†³ç­–å·²ç¡®è®¤ï¼Œå¾…å®æ–½**

---

## ã€‡ã€æ•°æ®åº“çœŸå®æ ¡éªŒæŠ¥å‘Šä¸å­—æ®µå‹˜è¯¯

> ä»¥ä¸‹ä¸º 2026-02-20 é€šè¿‡ Node.js è¿æ¥çœŸå®æ•°æ®åº“ `restaurant_points_dev`ï¼ˆdbconn.sealosbja.site:42569ï¼‰é€è¡¨æ ¡éªŒçš„ç»“æœã€‚

### 0.1 å­—æ®µåå‹˜è¯¯ï¼ˆæ–‡æ¡£åŸç¨¿ â†’ æ•°æ®åº“å®é™…ï¼‰

| è¡¨ | æ–‡æ¡£ç”¨å | æ•°æ®åº“å®é™…å­—æ®µ | è¯´æ˜ |
|---|---|---|---|
| `lottery_campaigns` | `name` | `campaign_name` | ä¸»é”® `lottery_campaign_id` |
| `lottery_tier_rules` | `weight` | `tier_weight` | INT UNSIGNED |
| `lottery_strategy_config` | `strategy_group` | `config_group` | VARCHAR(50) |
| `lottery_prizes` | `tier_name` | `reward_tier` | ENUM('high','mid','low') |
| `lottery_prizes` | `remaining_stock` | éœ€è®¡ç®—: `stock_quantity - total_win_count` | æ— æ­¤ç‰©ç†åˆ— |
| `lottery_user_experience_state` | `current_empty_streak` | `empty_streak` | INT |
| `lottery_prizes` | ä¹å…«æŠ˜åˆ¸ type=points | å®é™… type=`coupon` | ç±»å‹å†™é”™ |

### 0.2 å…³é”®æ¶æ„å‘ç°

| å‘ç° | å½±å“ | å†³ç­– |
|---|---|---|
| `lottery_tier_matrix_config` **æ—  `lottery_campaign_id` åˆ—**ï¼Œæ˜¯å…¨å±€é…ç½®è¡¨ | å¤šæ´»åŠ¨åœºæ™¯æ— æ³•éš”ç¦»çŸ©é˜µé…ç½® | âœ… **å†³ç­–å·²ç¡®è®¤ï¼šåŠ  `lottery_campaign_id` åˆ—**ï¼ˆè¯¦è§ Section åå…­ï¼‰ |
| `lottery_strategy_config` **æ—  `lottery_campaign_id` åˆ—**ï¼Œä¹Ÿæ˜¯å…¨å±€é…ç½®è¡¨ | å¤šæ´»åŠ¨åœºæ™¯æ— æ³•éš”ç¦»ç­–ç•¥é…ç½® | âœ… **å†³ç­–å·²ç¡®è®¤ï¼šåŠ  `lottery_campaign_id` åˆ—**ï¼ˆè¯¦è§ Section åå…­ï¼‰ |
| `lottery_tier_rules` **æœ‰ `lottery_campaign_id` åˆ—** | åŸºç¡€æƒé‡å·²æŒ‰æ´»åŠ¨éš”ç¦» | æ— éœ€æ”¹åŠ¨ |
| `lottery_simulation_records` è¡¨ **ä¸å­˜åœ¨** | éœ€æ–°å»º migration | Phase 1 æ–°å»º |
| `lottery_user_experience_state` å®é™…å­—æ®µå `empty_streak`ï¼ˆä¸æ˜¯ `current_empty_streak`ï¼‰ | ç”¨æˆ·æ—…ç¨‹æ¨¡æ‹Ÿéœ€å¯¹é½ | ä»£ç ä¸­ä½¿ç”¨æ­£ç¡®å­—æ®µå |

### 0.3 æ•°æ®å‡†ç¡®æ€§æ ¡éªŒ

æ‰€æœ‰ Section 1 çš„ç»Ÿè®¡æ•°æ®å·²é€šè¿‡ SQL é€é¡¹æ¯”å¯¹ï¼š
- æ¡£ä½åˆ†å¸ƒ(1.2)ï¼šhigh=1393, mid=165, low=233, fallback=609 âœ…
- BxPx å‘½ä¸­(1.5)ï¼šB3Ã—P1=2078, B3Ã—P2=322 âœ…
- æ¡£ä½è·ƒè¿(1.6)ï¼šå…¨éƒ¨ 6 è¡Œæ•°æ®ç²¾ç¡®åŒ¹é… âœ…
- ç­–ç•¥é…ç½®(1.7)ï¼š17 æ¡é…ç½®é¡¹å€¼å…¨éƒ¨åŒ¹é… âœ…
- ç”¨æˆ·ä½“éªŒçŠ¶æ€(1.8)ï¼šuser_31 æ•°æ®åŒ¹é… âœ…
- çŸ©é˜µé…ç½®(1.4)ï¼š12 æ ¼æ•°æ®å…¨éƒ¨åŒ¹é… âœ…
- åŸºç¡€æƒé‡(1.3)ï¼š9 æ¡è§„åˆ™å…¨éƒ¨åŒ¹é… âœ…

**"å¹³å‡æ¶ˆè€—ç§¯åˆ†"æ•°æ®æº¯æºï¼ˆâœ… å·²ç¡®è®¤ï¼‰**

åŸæ–‡ 1.2 çš„"å¹³å‡æ¶ˆè€—ç§¯åˆ†"æ¥è‡ª `lottery_draws.cost_points`ï¼ˆç”¨æˆ·æ¯æ¬¡æŠ½å¥–èŠ±è´¹çš„ç§¯åˆ†ï¼‰ï¼ŒNOT `lottery_draw_decisions.budget_deducted`ã€‚ä¸¤è€…æ˜¯å®Œå…¨ä¸åŒçš„æˆæœ¬ç»´åº¦ï¼š

| æ¡£ä½ | `AVG(cost_points)` ç”¨æˆ·ä¾§æ¶ˆè€— | `AVG(budget_deducted)` å¹³å°ä¾§é¢„ç®— | `AVG(prize_value)` å¥–å“å‘æ”¾ä»·å€¼ |
|---|---|---|---|
| high | 11.76 â† åŸç¨¿æ¥æº | 185.33 | 1,469.53 |
| mid | 20.11 â† åŸç¨¿æ¥æº | 1,285.36 | 375.45 |
| low | 63.88 â† åŸç¨¿æ¥æº | 5,175.17 | 27.43 |
| fallback | 9.85 â† åŸç¨¿æ¥æº | 0.00 | 27.00 |

> **å†³ç­–å·²ç¡®è®¤ï¼ˆA+B æ··åˆæ–¹æ¡ˆï¼‰**ï¼šä¿ç•™åŸç¨¿ `cost_points` æ•°æ®ï¼ˆç”¨æˆ·ä¾§æˆæœ¬ï¼‰ï¼Œæ¨¡æ‹Ÿè¾“å‡ºåŒæ—¶å±•ç¤ºä¸‰ç»´æˆæœ¬çŸ©é˜µã€‚è¯¦è§ Section 4.3 å¯¹æ¯”åˆ†æé¢æ¿ã€‚

---

## ä¸€ã€å½“å‰ç³»ç»Ÿç°çŠ¶

### 1.1 æ´»è·ƒæ´»åŠ¨æ•°æ®

| æ•°æ®åº“å­—æ®µ | å€¼ |
|---|---|
| `campaign_name` | é¤å…ç§¯åˆ†æŠ½å¥– (`lottery_campaign_id`=1) |
| `status` | active |
| `campaign_type` | event |
| `pick_method` | tier_first |
| `budget_mode` | userï¼ˆç”¨æˆ·é¢„ç®—ï¼‰ |
| `total_draws` | 2,400 |
| `total_participants` | 1,570 |
| `total_prizes_awarded` | 2,400 |
| `guarantee_enabled` | 0ï¼ˆæœªå¯ç”¨ï¼‰ï¼Œ`guarantee_threshold`=10 |

### 1.2 å®é™…æ¡£ä½åˆ†å¸ƒï¼ˆçœŸå®æ•°æ®ï¼Œä¸‰ç»´æˆæœ¬çŸ©é˜µï¼‰

| `final_tier` | æ¬¡æ•° | å æ¯” | AVG(`cost_points`) ç”¨æˆ·ä¾§ | AVG(`budget_deducted`) å¹³å°ä¾§ | AVG(`prize_value`) å¥–å“ä»·å€¼ |
|---|---|---|---|---|---|
| high | 1,393 | 58.04% | 11.76 | 185.33 | 1,469.53 |
| mid | 165 | 6.88% | 20.11 | 1,285.36 | 375.45 |
| low | 233 | 9.71% | 63.88 | 5,175.17 | 27.43 |
| fallback | 609 | 25.38% | 9.85 | 0.00 | 27.00 |

### 1.3 åŸºç¡€æ¡£ä½æƒé‡é…ç½®ï¼ˆ`lottery_tier_rules`ï¼Œå­—æ®µ `tier_weight`ï¼‰

| `segment_key` | high | mid | low | åˆè®¡ |
|---|---|---|---|---|
| default | 50,000 (5%) | 150,000 (15%) | 800,000 (80%) | 1,000,000 |
| new_user | 100,000 (10%) | 200,000 (20%) | 700,000 (70%) | 1,000,000 |
| vip_user | 80,000 (8%) | 220,000 (22%) | 700,000 (70%) | 1,000,000 |

> `lottery_tier_rules` æœ‰ `lottery_campaign_id` åˆ—ï¼Œæƒé‡æŒ‰æ´»åŠ¨éš”ç¦»ã€‚

### 1.4 BxPx çŸ©é˜µé…ç½®ï¼ˆ`lottery_tier_matrix_config`ï¼Œâš ï¸ å…¨å±€è¡¨ï¼Œæ—  campaign_idï¼‰

12 ä¸ªæ ¼å­ï¼ˆ4 `budget_tier` Ã— 3 `pressure_tier`ï¼‰ï¼Œä»¥ä¸‹ä¸ºå½“å‰ç”Ÿäº§æ•°æ®ï¼š

| æ ¼å­ | `cap_multiplier` | `empty_weight_multiplier` | `high_multiplier` | `mid_multiplier` | `low_multiplier` | `fallback_multiplier` | è¯´æ˜ |
|---|---|---|---|---|---|---|---|
| B0Ã—P0 | 0.00 | 10.00 | 0.00 | 0.00 | 0.00 | 1.00 | é¢„ç®—ä¸è¶³ï¼Œå¼ºåˆ¶ç©ºå¥– |
| B0Ã—P1 | 0.00 | 10.00 | 0.00 | 0.00 | 0.00 | 1.00 | é¢„ç®—ä¸è¶³ï¼Œå¼ºåˆ¶ç©ºå¥– |
| B0Ã—P2 | 0.30 | 10.00 | 0.00 | 0.00 | 0.00 | 1.00 | é¢„ç®—ä¸è¶³ï¼Œå¼ºåˆ¶ç©ºå¥– |
| B1Ã—P0 | 1.00 | 1.20 | 0.00 | 0.00 | 1.20 | 0.90 | ä½é¢„ç®—+ä½å‹ï¼Œç•¥å¢ç©ºå¥– |
| B1Ã—P1 | 1.00 | 1.00 | 0.00 | 0.00 | 1.00 | 1.00 | ä½é¢„ç®—+ä¸­å‹ï¼Œæ­£å¸¸ |
| B1Ã—P2 | 0.80 | 0.80 | 0.00 | 0.00 | 0.80 | 1.20 | ä½é¢„ç®—+é«˜å‹ï¼ŒæŠ‘åˆ¶ç©ºå¥– |
| B2Ã—P0 | 1.00 | 1.00 | 0.00 | 1.30 | 1.10 | 0.80 | ä¸­é¢„ç®—+ä½å‹ï¼Œæ­£å¸¸ |
| B2Ã—P1 | 1.30 | 0.90 | 0.00 | 1.00 | 1.00 | 1.00 | ä¸­é¢„ç®—+ä¸­å‹ï¼Œç•¥æŠ‘ç©ºå¥– |
| B2Ã—P2 | 0.90 | 0.70 | 0.00 | 0.70 | 1.10 | 1.30 | ä¸­é¢„ç®—+é«˜å‹ï¼ŒæŠ‘åˆ¶ç©ºå¥– |
| B3Ã—P0 | 1.00 | 0.80 | 1.50 | 1.20 | 0.90 | 0.70 | é«˜é¢„ç®—+ä½å‹ï¼ŒæŠ‘åˆ¶ç©ºå¥– |
| B3Ã—P1 | 1.00 | 0.70 | 1.00 | 1.00 | 1.00 | 1.00 | é«˜é¢„ç®—+ä¸­å‹ï¼Œæ˜¾è‘—æŠ‘åˆ¶ |
| B3Ã—P2 | 1.00 | 0.60 | 0.60 | 0.80 | 1.20 | 1.50 | é«˜é¢„ç®—+é«˜å‹ï¼Œå¼ºçƒˆæŠ‘åˆ¶ |

### 1.5 BxPx å®é™…å‘½ä¸­åˆ†å¸ƒï¼ˆ`lottery_draw_decisions` JOIN `lottery_draws`ï¼‰

| BxPx æ ¼å­ | å‘½ä¸­æ¬¡æ•° | å æ¯” |
|---|---|---|
| B3Ã—P1 | 2,078 | 86.6% |
| B3Ã—P2 | 322 | 13.4% |
| å…¶ä»–æ ¼å­ | 0 | 0% |

> å…³é”®å‘ç°ï¼š100% çš„ç”¨æˆ·éƒ½è½åœ¨ B3 å±‚ï¼ˆé«˜é¢„ç®—ï¼‰ï¼Œæ‰€æœ‰æŠ½å¥–éƒ½èµ° B3P1 æˆ– B3P2 çš„é…ç½®ã€‚

### 1.6 æ¡£ä½è·ƒè¿è®°å½•ï¼ˆ`lottery_draw_decisions`ï¼Œå­—æ®µ `original_tier` â†’ `final_tier`ï¼‰

| `original_tier` | `final_tier` | æ¬¡æ•° | è¯´æ˜ |
|---|---|---|---|
| high | high | 1,393 | æ­£å¸¸å‡º high |
| NULL | fallback | 374 | ç©ºé€‰æ‹©èµ° fallback |
| low | fallback | 235 | low é™çº§åˆ° fallback |
| low | low | 233 | æ­£å¸¸å‡º low |
| mid | mid | 156 | æ­£å¸¸å‡º mid |
| high | mid | 9 | high è¢«é™çº§åˆ° midï¼ˆAntiHigh è§¦å‘ï¼‰ |

### 1.7 ç­–ç•¥é…ç½®é¡¹ï¼ˆ`lottery_strategy_config`ï¼Œå­—æ®µ `config_group`/`config_key`/`config_value`ï¼Œâš ï¸ å…¨å±€è¡¨ï¼‰

**anti_emptyï¼ˆé˜²è¿ç©ºï¼‰**
| `config_key` | `config_value` | è¯´æ˜ |
|---|---|---|
| enabled | true | å¯ç”¨ |
| empty_streak_threshold | 3 | è¿ç»­ç©ºå¥– 3 æ¬¡è§¦å‘ |

**anti_highï¼ˆé˜²è¿é«˜ï¼‰**
| `config_key` | `config_value` | è¯´æ˜ |
|---|---|---|
| enabled | true | å¯ç”¨ |
| high_streak_threshold | 2 | è¿ç»­é«˜æ¡£ä½ 2 æ¬¡è§¦å‘ |
| recent_draw_window | 5 | ç»Ÿè®¡çª—å£ 5 æ¬¡ |

**pityï¼ˆä¿åº•æœºåˆ¶ï¼‰**
| `config_key` | `config_value` | è¯´æ˜ |
|---|---|---|
| enabled | true | å¯ç”¨ |
| hard_guarantee_threshold | 10 | ç¡¬ä¿åº•ï¼šè¿ç©º 10 æ¬¡å¿…å‡º |
| min_non_empty_cost | 10 | æœ€ä½éç©ºå¥–æˆæœ¬ |
| multiplier_table | {0:1, 1:1, 2:1.2, 3:1.5, 4:1.8, 5:2.2, 6:2.8, 7:3.5, 8:5, 9:10} | Pity ç´¯ç§¯ä¹˜æ•°è¡¨ |

**luck_debtï¼ˆè¿æ°”å€ºåŠ¡ï¼‰**
| `config_key` | `config_value` | è¯´æ˜ |
|---|---|---|
| enabled | true | å¯ç”¨ |
| expected_empty_rate | 0.3 | æœŸæœ›ç©ºå¥–ç‡ 30% |
| min_draw_count | 10 | æœ€å°æ ·æœ¬é‡ 10 æ¬¡ |

**budget_tierï¼ˆé¢„ç®—å±‚çº§é˜ˆå€¼ï¼‰**
| `config_key` | `config_value` | è¯´æ˜ |
|---|---|---|
| threshold_high | 1000 | B3 é˜ˆå€¼ï¼šé¢„ç®—>=1000 |
| threshold_mid | 500 | B2 é˜ˆå€¼ï¼šé¢„ç®—>=500 |
| threshold_low | 100 | B1 é˜ˆå€¼ï¼šé¢„ç®—>=100 |

**pressure_tierï¼ˆå‹åŠ›å±‚çº§é˜ˆå€¼ï¼‰**
| `config_key` | `config_value` | è¯´æ˜ |
|---|---|---|
| threshold_high | 0.8 | P2 é˜ˆå€¼ï¼šå‹åŠ›æŒ‡æ•°>=0.8 |
| threshold_low | 0.5 | P1 é˜ˆå€¼ï¼šå‹åŠ›æŒ‡æ•°>=0.5 |

### 1.8 ç”¨æˆ·ä½“éªŒçŠ¶æ€æ ·æœ¬ï¼ˆ`lottery_user_experience_state`ï¼‰

| user_id | lottery_campaign_id | `empty_streak` | `recent_high_count` | `total_draw_count` | `total_empty_count` | `pity_trigger_count` | `max_empty_streak` |
|---|---|---|---|---|---|---|---|
| 31 | 1 | 0 | 0 | 291 | 181 | 0 | 6 |

> Pity ç¡¬ä¿åº•ï¼ˆé˜ˆå€¼=10ï¼‰ä»æœªè§¦å‘è¿‡ï¼Œæœ€å¤§è¿ç©ºä¸º 6 æ¬¡ã€‚

### 1.9 å¥–å“é…ç½®ï¼ˆ`lottery_prizes`ï¼Œå­—æ®µ `reward_tier`ï¼Œåº“å­˜éœ€è®¡ç®— `stock_quantity - total_win_count`ï¼‰

| prize_name | `reward_tier` | `prize_type` | `prize_value` | å‰©ä½™åº“å­˜ | `is_fallback` |
|---|---|---|---|---|---|
| å…«å…«æŠ˜ | high | coupon | 150 | 8,870 | 0 |
| 2000ç§¯åˆ†åˆ¸ | high | points | 2,000 | 7,664 | 0 |
| 500ç§¯åˆ†åˆ¸ | high | points | 500 | 0ï¼ˆå·²è€—å°½ï¼‰ | 0 |
| ä¹å…«æŠ˜åˆ¸ | high | coupon | 98 | 0ï¼ˆå·²è€—å°½ï¼‰ | 0 |
| 100ç§¯åˆ† | mid | points | 100 | 322 | 0 |
| ç”œå“1ä»½ | mid | physical | 150 | 567 | 0 |
| ç²¾å“é¦–é¥°ä¸€ä¸ª | mid | physical | 800 | 9,945 | 0 |
| ç”Ÿè…Œæ‹¼ç›˜158 | mid | physical | 1,580 | 9,955 | 0 |
| é’èœ1ä»½ | low | physical | 120 | 9,476 | 0 |
| ç¥ç§˜å½©è›‹ | low | virtual | 0 | 49,688 | 1 |
| å¥½è¿åŠ æŒ | low | virtual | 0 | 49,671 | 1 |
| ç¾é£Ÿæ¨è | low | virtual | 0 | 49,723 | 1 |
| å¨å¸ˆç¥ç¦ | low | virtual | 0 | 49,709 | 1 |
| ä¸‹æ¬¡å¥½è¿ | low | virtual | 0 | 49,682 | 1 |
| å‚ä¸æœ‰ç¤¼ | low | virtual | 0 | 49,693 | 1 |

> `is_fallback=1` çš„å¥–å“åœ¨ `reward_tier=low` ä¸‹ï¼Œå¼•æ“ä¼šå°†å®ƒä»¬è§†ä¸ºç©ºå¥–/å®‰æ…°å¥–ã€‚

---

## äºŒã€ç°æœ‰ç³»ç»Ÿçš„åŠŸèƒ½å·®è·

å½“å‰"ç­–ç•¥ç®¡ç†"é¡µé¢ï¼ˆ`lottery-management.html?page=lottery-strategy`ï¼‰å·²æœ‰åŠŸèƒ½ï¼š

- æŸ¥çœ‹å’Œç¼–è¾‘ç­–ç•¥é…ç½®ï¼ˆ6 ç»„å‚æ•°ï¼‰
- æŸ¥çœ‹å’Œç¼–è¾‘ BxPx çŸ©é˜µï¼ˆ12 ä¸ªæ ¼å­ï¼‰
- æŸ¥çœ‹ç­–ç•¥æ•ˆæœåˆ†æé¢æ¿ï¼ˆ**å†å²æ•°æ®**å›çœ‹ï¼‰
- æŸ¥çœ‹ç­–ç•¥è§¦å‘çƒ­åŠ›å›¾ï¼ˆæŒ‰å¤©ç»Ÿè®¡ï¼‰
- æŸ¥çœ‹é…ç½®æ€»è§ˆï¼ˆBxPx å‘½ä¸­åˆ†å¸ƒã€è¿‘ 24 å°æ—¶æ‰§è¡Œæ‘˜è¦ï¼‰

**ç¼ºå¤±çš„å…³é”®èƒ½åŠ›**ï¼šæ“ä½œè€…ä¿®æ”¹å‚æ•°å**æ— æ³•é¢„è§ˆæ•ˆæœ**ï¼Œåªèƒ½ç›´æ¥ä¿å­˜åˆ°æ•°æ®åº“ï¼Œç­‰çº¿ä¸Šè¿è¡Œåæ‰èƒ½çœ‹åˆ°ç»“æœã€‚è¿™æ„å‘³ç€ï¼š
1. å‚æ•°è°ƒæ•´æ˜¯"ç›²è°ƒ"ï¼Œè¯•é”™æˆæœ¬é«˜
2. æ— æ³•å›ç­”"å¦‚æœæˆ‘æŠŠ X æ”¹æˆ Yï¼Œç»“æœä¼šæ€æ ·ï¼Ÿ"
3. æ— æ³•åœ¨ä¸å½±å“çº¿ä¸Šçš„æƒ…å†µä¸‹è¯„ä¼°ä¸åŒé…ç½®æ–¹æ¡ˆ

---

## ä¸‰ã€é¡µé¢æ¶æ„è®¾è®¡

### 3.1 é¡µé¢æ”¾ç½®ï¼ˆå†³ç­–ç‚¹ 1ï¼‰â€” å·²ç¡®è®¤ï¼šæ–¹æ¡ˆ A

> **å†³å®š**ï¼šä½œä¸º `lottery-management.html` çš„æ–° Tabï¼ŒURL: `?page=strategy-simulation`

ä¸ç°æœ‰çš„ lottery-strategyã€campaignsã€quota ç­‰ Tab å¹¶åˆ—ï¼Œæ“ä½œè€…å¯éšæ—¶åˆ‡æ¢å¯¹æ¯”ã€‚

### 3.2 æ¨¡æ‹Ÿå¼•æ“æ‰§è¡Œä½ç½®ï¼ˆå†³ç­–ç‚¹ 2ï¼‰â€” å·²ç¡®è®¤ï¼šæ–¹æ¡ˆ A

> **å†³å®š**ï¼šåç«¯ Node.js æœåŠ¡ç«¯è®¡ç®—

åœ¨ `services/lottery-analytics/StrategySimulationService.js` ä¸­å®ç°ï¼Œä» TierPickStageã€PityCalculator ç­‰æå–çº¯å‡½æ•°å¤ç”¨ã€‚å‰ç«¯é€šè¿‡ API è°ƒç”¨ï¼Œ10,000 æ¬¡æ¨¡æ‹Ÿçº¦ 2-5 ç§’ï¼Œå®Œæ•´å¤åˆ¶ç”Ÿäº§é€»è¾‘ï¼Œä¸å¡æµè§ˆå™¨ã€‚

---

## å››ã€åŠŸèƒ½æ¨¡å—è®¾è®¡

### 4.1 åŠŸèƒ½æ¨¡å—å–èˆï¼ˆå†³ç­–ç‚¹ 3ï¼‰â€” å·²ç¡®è®¤ï¼šå…¨é‡æ–¹æ¡ˆ + 6 é¡¹å¢å¼º

> **å†³å®š**ï¼š4 ä¸ªæ ¸å¿ƒæ¨¡å— + 6 ä¸ªå¢å¼ºæ¨¡å—å…¨éƒ¨å®ç°

**æ ¸å¿ƒæ¨¡å—ï¼ˆPhase 2-4ï¼‰ï¼š**

| æ¨¡å— | å¤æ‚åº¦ | çŠ¶æ€ |
|---|---|---|
| 1. å‚æ•°æ²™ç›’ï¼ˆParameter Sandboxï¼‰ | ä¸­ | ç¡®è®¤å®ç° |
| 2. Monte Carlo æ¨¡æ‹Ÿå¼•æ“ï¼ˆå«åº“å­˜çº¦æŸï¼‰ | é«˜ | ç¡®è®¤å®ç° |
| 3. å¯¹æ¯”åˆ†æé¢æ¿ï¼ˆSide-by-Sideï¼‰ | ä¸­ | ç¡®è®¤å®ç° |
| 4. ç”¨æˆ·æ—…ç¨‹æ¨¡æ‹Ÿï¼ˆUser Journeyï¼‰ | ä¸­ | ç¡®è®¤å®ç° |

**å¢å¼ºæ¨¡å—ï¼ˆPhase 5-6ï¼Œå¯¹æ ‡ç¾å›¢/æ¸¸æˆå…¬å¸å®è·µï¼‰ï¼š**

| æ¨¡å— | å¤æ‚åº¦ | å¯¹æ ‡æ¥æº | çŠ¶æ€ |
|---|---|---|---|
| 5. çµæ•åº¦åˆ†æï¼ˆSensitivity Analysisï¼‰ | ä¸­ | ç¾å›¢ BETA å¼•æ“ + gcsim å‚æ•°æ‰«å°„ | ç¡®è®¤å®ç° |
| 6. ç›®æ ‡åæ¨ï¼ˆGoal Seek / Auto-Recommendï¼‰ | é«˜ | é˜¿é‡Œäº‘æ™ºèƒ½å¢é•¿ + è…¾è®¯è´å¶æ–¯ä¼˜åŒ– | ç¡®è®¤å®ç° |
| 7. å¤šæ–¹æ¡ˆå¹¶æ’æ¯”è¾ƒï¼ˆMulti-Scenario Rankingï¼‰ | ä¸­ | ç¾å›¢ A/B å¹³å° + gcsim é…é˜Ÿå¯¹æ¯” | ç¡®è®¤å®ç° |
| 8. åº“å­˜çº¦æŸå»ºæ¨¡ï¼ˆInventory Constraintï¼‰ | ä¸­ | ç¾å›¢/é˜¿é‡ŒæŠ½å¥–å¹³å° + åŸç¥é™å®šæ±  | ç¡®è®¤å®ç°ï¼ˆèå…¥æ¨¡å— 2ï¼‰ |
| 9. æ¨¡æ‹Ÿâ†’å®é™…åå·®è¿½è¸ªï¼ˆPrediction Driftï¼‰ | ä½ | ç¾å›¢å®éªŒæŠ¥è¡¨ + paimon.moe | ç¡®è®¤å®ç° |
| 10. é…ç½®ä¸€é”®åº”ç”¨ï¼ˆSimulation â†’ Productionï¼‰ | ä½ | ç¾å›¢å®éªŒ"æ¨å…¨"æŒ‰é’® | ç¡®è®¤å®ç° |

---

### 4.2 æ¨¡å— 1ï¼šå‚æ•°æ²™ç›’

æ“ä½œè€…å¯ä»¥è°ƒæ•´ä»»æ„ç­–ç•¥å‚æ•°ï¼Œä¸ä¿å­˜åˆ°æ•°æ®åº“ã€‚æ²™ç›’é¢„åŠ è½½å½“å‰çº¿ä¸Šé…ç½®ä½œä¸ºåŸºçº¿ã€‚

**å¯ç¼–è¾‘å‚æ•°ç»„ï¼ˆå­—æ®µå·²å¯¹é½æ•°æ®åº“å®é™…åˆ—åï¼‰ï¼š**

| å‚æ•°ç»„ | å¯ç¼–è¾‘å­—æ®µï¼ˆDB åˆ—åï¼‰ | æ¥æºè¡¨ | è¡¨ä½œç”¨åŸŸ |
|---|---|---|---|
| åŸºç¡€æ¡£ä½æƒé‡ | `tier_weight`ï¼ˆæŒ‰ `segment_key` + `tier_name` ç»„åˆï¼‰ | `lottery_tier_rules` | æŒ‰æ´»åŠ¨éš”ç¦» |
| BxPx çŸ©é˜µ | 12æ ¼ Ã— `high_multiplier`/`mid_multiplier`/`low_multiplier`/`fallback_multiplier`/`cap_multiplier`/`empty_weight_multiplier` | `lottery_tier_matrix_config` | âš ï¸ å…¨å±€ |
| Pity ç³»ç»Ÿ | `config_value`ï¼ˆconfig_key: enabled, hard_guarantee_threshold, multiplier_tableï¼‰ | `lottery_strategy_config` | âš ï¸ å…¨å±€ |
| é˜²è¿ç©º | `config_value`ï¼ˆconfig_key: enabled, empty_streak_thresholdï¼‰ | `lottery_strategy_config` | âš ï¸ å…¨å±€ |
| é˜²è¿é«˜ | `config_value`ï¼ˆconfig_key: enabled, high_streak_threshold, recent_draw_windowï¼‰ | `lottery_strategy_config` | âš ï¸ å…¨å±€ |
| è¿æ°”å€ºåŠ¡ | `config_value`ï¼ˆconfig_key: enabled, expected_empty_rate, min_draw_countï¼‰ | `lottery_strategy_config` | âš ï¸ å…¨å±€ |
| é¢„ç®—å±‚çº§é˜ˆå€¼ | `config_value`ï¼ˆconfig_key: threshold_high/threshold_mid/threshold_lowï¼‰ | `lottery_strategy_config` | âš ï¸ å…¨å±€ |
| å‹åŠ›å±‚çº§é˜ˆå€¼ | `config_value`ï¼ˆconfig_key: threshold_high/threshold_lowï¼‰ | `lottery_strategy_config` | âš ï¸ å…¨å±€ |

**UI å½¢å¼ï¼ˆå†³ç­–ç‚¹ 4ï¼‰â€” å·²ç¡®è®¤ï¼šæ–¹æ¡ˆ A**

> **å†³å®š**ï¼šå·¦å³å¯¹æ¯”å¸ƒå±€

å·¦åˆ—å½“å‰å€¼ï¼ˆåªè¯»ç°è‰²ï¼‰+ å³åˆ—æ¨¡æ‹Ÿå€¼ï¼ˆå¯ç¼–è¾‘ï¼‰ï¼Œä¿®æ”¹çš„å€¼é«˜äº®é»„è‰²ã€‚æ¯ä¸ªå‚æ•°ç»„ä¸€ä¸ª Tab æˆ–æŠ˜å é¢æ¿ã€‚

**BxPx çŸ©é˜µç¼–è¾‘æ–¹å¼ï¼ˆå†³ç­–ç‚¹ 5ï¼‰â€” å·²ç¡®è®¤ï¼šæ–¹æ¡ˆ A + B åŒæ¨¡å¼åˆ‡æ¢**

> **å†³å®š**ï¼šçƒ­åŠ›å›¾å’Œå…¨çŸ©é˜µè¡¨æ ¼ä¸¤ç§è§†å›¾ï¼Œæä¾›åˆ‡æ¢æŒ‰é’®

- **çƒ­åŠ›å›¾æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰**ï¼š4Ã—3 çƒ­åŠ›å›¾æ˜¾ç¤ºä¹˜æ•°å¼ºåº¦ï¼Œç‚¹å‡»æ ¼å­å¼¹å‡ºç¼–è¾‘é¢æ¿ï¼Œä¿®æ”¹åæ ¼å­è¾¹æ¡†å˜é»„
- **è¡¨æ ¼æ¨¡å¼**ï¼š12 è¡Œ Ã— 6 åˆ—å¯ç¼–è¾‘å¤§è¡¨æ ¼ï¼Œä¸€æ¬¡æ€§çœ‹åˆ°æ‰€æœ‰å€¼
- å³ä¸Šè§’æä¾›"çƒ­åŠ›å›¾ / è¡¨æ ¼"åˆ‡æ¢æŒ‰é’®ï¼Œä¸¤ç§è§†å›¾æ•°æ®å®æ—¶åŒæ­¥

---

### 4.3 æ¨¡å— 2ï¼šMonte Carlo æ¨¡æ‹Ÿå¼•æ“

ç»™å®šæè®®å‚æ•°ï¼Œæ¨¡æ‹Ÿ N æ¬¡æŠ½å¥–ï¼Œè®¡ç®—é¢„æœŸåˆ†å¸ƒã€‚

**æ¨¡æ‹Ÿè¾“å…¥ï¼ˆæ“ä½œè€…å¯é…ç½®ï¼‰ï¼š**
- æ¨¡æ‹Ÿæ¬¡æ•°ï¼š1,000 / 5,000 / 10,000 / 50,000
- ç”¨æˆ·é¢„ç®—åˆ†å¸ƒï¼šæŒ‰çœŸå®æ•°æ®é¢„è®¾ æˆ– è‡ªå®šä¹‰å„ B å±‚å æ¯”
- å‹åŠ›åˆ†å¸ƒï¼šæŒ‰çœŸå®æ•°æ®é¢„è®¾ æˆ– è‡ªå®šä¹‰å„ P å±‚å æ¯”
- ç”¨æˆ·åˆ†ç¾¤æ··åˆï¼šdefault / new_user / vip_user å„å æ¯”

**æ¨¡æ‹Ÿè¾“å‡ºï¼ˆä¸‰ç»´æˆæœ¬çŸ©é˜µ + ä½“éªŒæŒ‡æ ‡ï¼‰ï¼š**

*æ¡£ä½åˆ†å¸ƒæŒ‡æ ‡ï¼š*
- å„æ¡£ä½é¢„æµ‹åˆ†å¸ƒï¼ˆhigh/mid/low/fallback ç™¾åˆ†æ¯”ï¼‰
- é¢„æµ‹ç©ºå¥–ç‡

*ä¸‰ç»´æˆæœ¬æŒ‡æ ‡ï¼ˆå¯¹æ ‡ç¾å›¢+æ¸¸æˆå…¬å¸æ··åˆæ–¹æ¡ˆï¼‰ï¼š*
- ç”¨æˆ·æ¯æ¬¡æŠ½å¥–æ¶ˆè€—ï¼šæŒ‰æ¡£ä½çš„ AVG(`cost_points`)ï¼ˆç”¨æˆ·ä½“éªŒè§†è§’ï¼‰
- æ¯åƒæ¬¡é¢„ä¼°å¥–å“å‘æ”¾ä»·å€¼ï¼š`SUM(prize_value) / draws Ã— 1000`ï¼ˆå¹³å°å®é™…æˆæœ¬ï¼‰
- æ¯åƒæ¬¡é¢„ä¼°é¢„ç®—æ¶ˆè€—ï¼š`SUM(budget_deducted) / draws Ã— 1000`ï¼ˆé¢„ç®—è€—å°½é¢„è­¦ï¼‰
- å¥–å“æˆæœ¬ç‡ï¼šå¥–å“å‘æ”¾æ€»ä»·å€¼ / ç”¨æˆ·æ¶ˆè€—æ€»ç§¯åˆ†ï¼ˆç›ˆäºå¹³è¡¡çº¢çº¿ï¼‰

*ä½“éªŒæœºåˆ¶æŒ‡æ ‡ï¼š*
- Pity è§¦å‘ç‡é¢„ä¼°
- AntiEmpty è§¦å‘æ¬¡æ•°é¢„ä¼°
- AntiHigh è§¦å‘æ¬¡æ•°é¢„ä¼°
- å¹³å‡é¦–æ¬¡éç©ºæ‰€éœ€æŠ½å¥–æ¬¡æ•°

**æ ¸å¿ƒç®—æ³•æµç¨‹ï¼š**

```
è¾“å…¥ï¼šproposed_config + scenario

1. ä»æ•°æ®åº“åŠ è½½å½“å‰é…ç½®ä½œä¸º baseline
2. å°† proposed_config åˆå¹¶è¦†ç›– baselineï¼ˆä»…åœ¨å†…å­˜ä¸­ï¼‰
3. å¾ªç¯ N æ¬¡ï¼š
   a. æŒ‰ scenario.budget_distribution æ¦‚ç‡éšæœºé€‰æ‹© budget_tier
   b. æŒ‰ scenario.pressure_distribution æ¦‚ç‡éšæœºé€‰æ‹© pressure_tier
   c. æŒ‰ scenario.segment_distribution æ¦‚ç‡éšæœºé€‰æ‹© user_segment
   d. åˆå§‹åŒ–ç”¨æˆ·çŠ¶æ€ï¼ˆempty_streak=0, high_count=0ï¼‰
   e. æ‰§è¡Œä¸€æ¬¡æ¦‚ç‡è®¡ç®—ï¼š
      - è·å–è¯¥ segment çš„ base_weights
      - åº”ç”¨ BxPx[budget_tier][pressure_tier] ä¹˜æ•°
      - å½’ä¸€åŒ–åˆ° 1,000,000
      - æ‰§è¡Œ 8% high ç¡¬é¡¶
      - å¦‚æœ Pity å¯ç”¨ï¼Œæ ¹æ® empty_streak åº”ç”¨ pity ä¹˜æ•°
      - éšæœºæ•°é€‰æ¡£ä½
      - å¦‚æœ AntiEmpty å¯ç”¨ä¸” empty_streak >= é˜ˆå€¼ï¼Œå¼ºåˆ¶éç©º
      - å¦‚æœ AntiHigh å¯ç”¨ä¸” recent_high >= é˜ˆå€¼ï¼Œé™çº§ highâ†’mid
   f. è®°å½•ç»“æœï¼Œæ›´æ–°ç”¨æˆ·çŠ¶æ€
4. èšåˆæ‰€æœ‰ç»“æœ
5. ä¸å½“å‰çœŸå®æ•°æ®å¯¹æ¯”ï¼Œè®¡ç®— delta
6. è¯„ä¼°é£é™©ç­‰çº§
7. è¿”å›ç»“æœ
```

**å¯å¤ç”¨çš„ç°æœ‰çº¯å‡½æ•°ï¼ˆå·²éªŒè¯å­˜åœ¨äºä»£ç åº“ä¸­çš„å®é™…è·¯å¾„ï¼‰ï¼š**

| å®é™…æ–‡ä»¶è·¯å¾„ | å¯å¤ç”¨æ–¹æ³• | è¡Œå·èŒƒå›´ | ç”¨é€” | çº¯å‡½æ•°ï¼Ÿ |
|---|---|---|---|---|
| `services/UnifiedLotteryEngine/pipeline/stages/TierPickStage.js` | `_enforceHighTierCap(weights, maxRatio)` | L591-623 | 8% ç¡¬é¡¶ï¼šè¶…å‡ºéƒ¨åˆ† 80%â†’low, 20%â†’mid | âœ… çº¯å‡½æ•° |
| `services/UnifiedLotteryEngine/pipeline/stages/TierPickStage.js` | `_pickTier(weights, random_value)` | L559-578 | æŒ‰æƒé‡éšæœºé€‰æ¡£ä½ | âœ… çº¯å‡½æ•° |
| `services/UnifiedLotteryEngine/compute/calculators/TierMatrixCalculator.js` | `_applyMultipliers(base_weights, multipliers)` | L207-221 | BxPx ä¹˜æ•° Ã— base_weight | âœ… çº¯å‡½æ•° |
| `services/UnifiedLotteryEngine/compute/calculators/TierMatrixCalculator.js` | `_normalizeWeights(weights)` | L256-282 | å½’ä¸€åŒ–åˆ° WEIGHT_SCALE=1,000,000 | âœ… çº¯å‡½æ•° |
| `services/UnifiedLotteryEngine/compute/calculators/TierMatrixCalculator.js` | `_getMatrixMultipliers(budget_tier, pressure_tier)` | L175-197 | çŸ©é˜µæŸ¥è¡¨ | âœ… çº¯å‡½æ•°ï¼ˆéœ€ä¼ å…¥é…ç½®ï¼‰ |
| `services/UnifiedLotteryEngine/compute/calculators/PityCalculator.js` | `_adjustWeights(tier_weights, multiplier)` | L223-250 | Pity ä¹˜æ•°åº”ç”¨ï¼ˆboost éç©ºï¼Œreduce fallbackï¼‰ | âœ… çº¯å‡½æ•° |
| `services/UnifiedLotteryEngine/compute/calculators/PityCalculator.js` | `calculate({ empty_streak, tier_weights })` | L125-210 | æŸ¥ multiplier_table å¹¶åº”ç”¨ | âœ…ï¼ˆéœ€ä¼ å…¥ configï¼‰ |
| `services/UnifiedLotteryEngine/compute/calculators/AntiEmptyStreakHandler.js` | `handle()` | L126-247 | empty_streak >= threshold æ—¶å¼ºåˆ¶éç©º | âš ï¸ éœ€ä¼ å…¥ budget/prizes |
| `services/UnifiedLotteryEngine/compute/calculators/AntiHighStreakHandler.js` | `handle()` | L138-262 | recent_high >= threshold æ—¶ highâ†’mid | âš ï¸ éœ€ä¼ å…¥ cooldown çŠ¶æ€ |
| `services/UnifiedLotteryEngine/compute/calculators/BudgetTierCalculator.js` | é¢„ç®—åˆ†å±‚é€»è¾‘ | â€” | æ ¹æ®é˜ˆå€¼åˆ¤æ–­ B0-B3 | âœ… çº¯å‡½æ•° |
| `services/UnifiedLotteryEngine/compute/calculators/PressureTierCalculator.js` | å‹åŠ›åˆ†å±‚é€»è¾‘ | â€” | æ ¹æ®é˜ˆå€¼åˆ¤æ–­ P0-P2 | âœ… çº¯å‡½æ•° |

> **å¤ç”¨ç­–ç•¥**ï¼š`StrategySimulationService` ç›´æ¥ `require()` è¿™äº› calculator ç±»ï¼Œæ„é€ æ—¶æ³¨å…¥æ¨¡æ‹Ÿé…ç½®è€Œéæ•°æ®åº“é…ç½®ï¼Œæ— éœ€æå–æˆ–æ‹·è´ä»£ç ã€‚`compute/calculators/` ç›®å½•ä¸‹çš„ç±»å·²ç»æ˜¯ã€Œé…ç½®æ³¨å…¥ã€æ—  DB ä¾èµ–ã€çš„è®¾è®¡ï¼Œå¤©ç„¶é€‚åˆæ¨¡æ‹Ÿåœºæ™¯ã€‚

**æ¨¡æ‹Ÿç²¾åº¦é€‰æ‹©ï¼ˆå†³ç­–ç‚¹ 11ï¼‰ï¼š**

| è¿­ä»£æ¬¡æ•° | ç²¾åº¦ï¼ˆç½®ä¿¡åŒºé—´ï¼‰ | é¢„ä¼°è€—æ—¶ | é€‚ç”¨åœºæ™¯ |
|---|---|---|---|
| 1,000 | Â±3% | <0.5s | å¿«é€Ÿé¢„è§ˆ |
| 5,000 | Â±1.5% | 1-2s | å¸¸è§„æ¨¡æ‹Ÿ |
| 10,000 | Â±1% | 2-5s | æ­£å¼å†³ç­–å‰ |
| 50,000 | Â±0.5% | 10-20s | é«˜ç²¾åº¦éœ€æ±‚ |

ç²¾åº¦é€‰æ‹©ï¼ˆå†³ç­–ç‚¹ 11ï¼‰â€” å·²ç¡®è®¤ï¼šæ–¹æ¡ˆ B

> **å†³å®š**ï¼šæ“ä½œè€…å¯é€‰ï¼Œä¸‹æ‹‰é€‰æ‹©ï¼šå¿«é€Ÿ(1K) / æ ‡å‡†(10K) / ç²¾ç¡®(50K)ï¼Œé»˜è®¤"æ ‡å‡†"ã€‚50K æ—¶æ˜¾ç¤ºè¿›åº¦æ¡ã€‚

---

### 4.4 æ¨¡å— 3ï¼šå¯¹æ¯”åˆ†æé¢æ¿

å½“å‰é…ç½®æ•ˆæœ vs æ¨¡æ‹Ÿé…ç½®æ•ˆæœï¼Œå¹¶æ’å¯¹æ¯”ã€‚

**å›¾è¡¨é€‰æ‹©ï¼ˆå†³ç­–ç‚¹ 6ï¼‰â€” å·²ç¡®è®¤ï¼š7 é¡¹å…¨éƒ¨å®ç°**

| å›¾è¡¨ | ç±»å‹ | å±•ç¤ºå†…å®¹ | çŠ¶æ€ |
|---|---|---|---|
| æ¡£ä½åˆ†å¸ƒå¯¹æ¯” | åŒæŸ±çŠ¶å›¾ | å½“å‰ vs æ¨¡æ‹Ÿçš„ high/mid/low/fallback æ¯”ä¾‹ | ç¡®è®¤å®ç° |
| BxPx å‘½ä¸­çƒ­åŠ›å›¾ | åŒçƒ­åŠ›å›¾ | å½“å‰çŸ©é˜µ vs æ¨¡æ‹ŸçŸ©é˜µæ•ˆæœ | ç¡®è®¤å®ç° |
| ä½“éªŒæœºåˆ¶è§¦å‘ç‡ | æŒ‡æ ‡å¡ç‰‡ç»„ | Pity/AntiEmpty/AntiHigh è§¦å‘æ¬¡æ•°å’Œæ¯”ä¾‹ | ç¡®è®¤å®ç° |
| ä¸‰ç»´æˆæœ¬æ‘˜è¦ | æ•°å­—æ‘˜è¦å¡ç»„ | ç”¨æˆ·ä¾§æ¶ˆè€— / å¹³å°é¢„ç®—æ¶ˆè€— / å¥–å“å‘æ”¾ä»·å€¼ / å¥–å“æˆæœ¬ç‡ | ç¡®è®¤å®ç° |
| é£é™©è¯„ä¼°ä»ªè¡¨ç›˜ | çº¢ç»¿ç¯æŒ‡ç¤ºå™¨ | high æ¯”ä¾‹é£é™©/ç©ºå¥–ç‡é£é™©/é¢„ç®—è€—å°½é£é™©/å¥–å“æˆæœ¬ç‡é£é™© | ç¡®è®¤å®ç° |
| ç©ºå¥–è¿å‡»åˆ†å¸ƒ | ç›´æ–¹å›¾ | æ¨¡æ‹Ÿä¸­è¿ç»­ç©ºå¥–çš„é•¿åº¦åˆ†å¸ƒ | ç¡®è®¤å®ç° |
| ç´¯ç§¯æ¦‚ç‡æ›²çº¿ | æŠ˜çº¿å›¾ | N æ¬¡æŠ½å¥–åå„æ¡£ä½ç´¯è®¡è·å¾—æ¬¡æ•°è¶‹åŠ¿ | ç¡®è®¤å®ç° |

**é£é™©è¯„ä¼°é˜ˆå€¼ï¼š**

| é£é™©é¡¹ | ç»¿è‰²ï¼ˆå®‰å…¨ï¼‰ | é»„è‰²ï¼ˆå…³æ³¨ï¼‰ | çº¢è‰²ï¼ˆå±é™©ï¼‰ |
|---|---|---|---|
| high æ¡£ä½æ¯”ä¾‹ | <5% | 5%-8% | >8%ï¼ˆè¶…ç¡¬é¡¶ï¼‰ |
| ç©ºå¥–ç‡ | <30% | 30%-50% | >50% |
| é¢„ç®—è€—å°½é£é™© | >30 å¤© | 7-30 å¤© | <7 å¤© |
| å¥–å“æˆæœ¬ç‡ | <0.5 | 0.5-0.8 | >0.8ï¼ˆæ¥è¿‘äºæŸï¼‰ |

---

### 4.5 æ¨¡å— 4ï¼šç”¨æˆ·æ—…ç¨‹æ¨¡æ‹Ÿ

æ¨¡æ‹Ÿå•ä¸ªç”¨æˆ·çš„è¿ç»­æŠ½å¥–ä½“éªŒï¼Œé€æ­¥å±•ç¤ºç­–ç•¥æœºåˆ¶å¦‚ä½•è§¦å‘ã€‚

**å¯é…ç½®ç”¨æˆ·ç”»åƒï¼š**
- èµ·å§‹é¢„ç®—ï¼ˆå†³å®š budget_tierï¼‰
- ç”¨æˆ·åˆ†ç¾¤ï¼ˆdefault / new_user / vip_userï¼‰
- èµ·å§‹è¿ç©ºæ¬¡æ•°ï¼ˆ0 æˆ–è‡ªå®šä¹‰ï¼‰
- æ¨¡æ‹ŸæŠ½å¥–æ¬¡æ•°ï¼ˆ10 / 20 / 50ï¼‰

**æ—…ç¨‹æ·±åº¦ï¼ˆå†³ç­–ç‚¹ 8ï¼‰â€” å·²ç¡®è®¤ï¼šæ–¹æ¡ˆ B å®Œæ•´ç‰ˆ**

> **å†³å®š**ï¼šæ¯æ¬¡æŠ½å¥–å±•ç¤ºå®Œæ•´æƒé‡å˜åŒ–é“¾ï¼Œæ“ä½œè€…å¯ä»¥å®Œå…¨é€è§†ç­–ç•¥å¼•æ“çš„å†³ç­–è¿‡ç¨‹

æ¯ä¸€æŠ½å±•ç¤ºç¤ºä¾‹ï¼š
```
ç¬¬5æ¬¡æŠ½å¥–:
  åŸºç¡€æƒé‡: high=5% mid=15% low=80%
  â†’ BxPxè°ƒæ•´(B3P1): high=5% mid=15% low=80% fallback=0%
  â†’ 8%ç¡¬é¡¶: ä¸è§¦å‘
  â†’ Pityè°ƒæ•´(è¿ç©º3æ¬¡, Ã—1.5): high=7.3% mid=21.9% low=70.8%
  â†’ æœ€ç»ˆé€‰æ‹©: mid
  â†’ å¥–å“: 100ç§¯åˆ†
  â†’ è¿ç©ºæ¬¡æ•°é‡ç½®: 0
```

---

## äº”ã€åœºæ™¯é¢„è®¾èƒ½åŠ›ï¼ˆå†³ç­–ç‚¹ 7ï¼‰â€” å·²ç¡®è®¤ï¼šæ–¹æ¡ˆ C é¢„è®¾åœºæ™¯åº“

> **å†³å®š**ï¼šæä¾›é¢„è®¾åœºæ™¯ä¸‹æ‹‰èœå•ï¼Œæ“ä½œè€…é€‰æ‹©åå¯åœ¨æ­¤åŸºç¡€ä¸Šå¾®è°ƒ

**é¢„è®¾åœºæ™¯å®šä¹‰ï¼š**

| åœºæ™¯å | budget åˆ†å¸ƒ | pressure åˆ†å¸ƒ | segment åˆ†å¸ƒ | è¯´æ˜ |
|---|---|---|---|---|
| å½“å‰çœŸå® | B3=100% | P1=86.6%, P2=13.4% | ä»æ•°æ®åº“ç»Ÿè®¡ | åŸºäº lottery_draw_decisions å®æ—¶ç»Ÿè®¡ |
| å‡åŒ€åˆ†å¸ƒ | B0-B3 å„25% | P0-P2 å„33.3% | default=100% | æµ‹è¯•ç”¨ï¼Œè¦†ç›–æ‰€æœ‰çŸ©é˜µæ ¼å­ |
| ä½é¢„ç®—å¢å¤š | B1=20%, B2=30%, B3=50% | P1=70%, P2=30% | default=80%, new_user=20% | æ¨¡æ‹Ÿç”¨æˆ·é¢„ç®—ä¸‹é™åœºæ™¯ |
| é«˜å‹åŠ›åœºæ™¯ | B2=30%, B3=70% | P0=10%, P1=40%, P2=50% | default=70%, vip_user=30% | æ¨¡æ‹Ÿæ´»åŠ¨é«˜å³°/é¢„ç®—åƒç´§ |

æ“ä½œè€…é€‰æ‹©é¢„è®¾åï¼Œæ‰€æœ‰æ•°å€¼å‡å¯æ‰‹åŠ¨å¾®è°ƒã€‚

---

## å…­ã€åç«¯ API è®¾è®¡ï¼ˆå¯¹é½åç«¯å®é™…æŠ€æœ¯ä½“ç³»ï¼‰

### 6.1 è·¯ç”±ç»„ç»‡ï¼ˆå†³ç­–ç‚¹ 10ï¼‰â€” å·²ç¡®è®¤ï¼šæ–¹æ¡ˆ B ç‹¬ç«‹è·¯ç”±æ–‡ä»¶

> **å†³å®š**ï¼šæ–°å»º `routes/v4/console/lottery-simulation.js`ï¼Œåœ¨ `routes/v4/console/index.js` ä¸­æ³¨å†Œã€‚

**è·¯ç”±æ³¨å†Œæ–¹å¼**ï¼ˆå¯¹é½ç°æœ‰ `lottery-strategy-stats` æ¨¡å¼ï¼‰ï¼š
- ä¸­é—´ä»¶é“¾ï¼š`authenticateToken` â†’ `requireRoleLevel(100)`ï¼ˆå¤ç”¨ç°æœ‰ç®¡ç†å‘˜é‰´æƒï¼‰
- è·¯ç”±å‰ç¼€ï¼š`/api/v4/console/lottery-simulation/...`
- å“åº”æ ¼å¼ï¼šç»Ÿä¸€ä½¿ç”¨ `res.apiSuccess(data, message)` / `res.apiError(message, code, details, status)`
- æœåŠ¡è·å–ï¼š`req.app.locals.services.getService('strategy_simulation')`

### 6.2 æ¥å£åˆ—è¡¨ï¼ˆå­—æ®µå…¨éƒ¨å¯¹é½æ•°æ®åº“å®é™…åˆ—åï¼‰

#### GET /api/v4/console/lottery-simulation/baseline/:lottery_campaign_id

åŠ è½½æ¨¡æ‹ŸåŸºçº¿æ•°æ®ã€‚éœ€è¦ä»ä¸‰ä¸ªä½œç”¨åŸŸä¸åŒçš„è¡¨è¯»å–ï¼š

**æ•°æ®æ¥æºï¼ˆåŠ  `lottery_campaign_id` åˆ—åï¼Œå…¨éƒ¨æŒ‰æ´»åŠ¨è¿‡æ»¤ï¼‰ï¼š**
- `lottery_tier_rules`ï¼ˆWHERE `lottery_campaign_id` = :idï¼‰ â†’ åŸºç¡€æƒé‡
- `lottery_tier_matrix_config`ï¼ˆWHERE `lottery_campaign_id` = :idï¼‰ â†’ BxPx çŸ©é˜µï¼ˆå·²åŠ  campaign_id åˆ—ï¼‰
- `lottery_strategy_config`ï¼ˆWHERE `lottery_campaign_id` = :id AND `is_active` = 1ï¼‰ â†’ ç­–ç•¥é…ç½®ï¼ˆå·²åŠ  campaign_id åˆ—ï¼‰
- `lottery_draw_decisions` JOIN `lottery_draws`ï¼ˆWHERE campaign_id = :idï¼‰ â†’ å†å² BxPx åˆ†å¸ƒç»Ÿè®¡
- `lottery_prizes`ï¼ˆWHERE `lottery_campaign_id` = :idï¼‰ â†’ å¥–å“é…ç½®ï¼ˆç”¨äº cost_points/prize_value è®¡ç®—ï¼‰

**å“åº”ä½“**ï¼ˆ`res.apiSuccess(data)` çš„ `data` éƒ¨åˆ†ï¼‰ï¼š
```json
{
  "tier_rules": [
    { "segment_key": "default", "tier_name": "high", "tier_weight": 50000 },
    { "segment_key": "default", "tier_name": "mid", "tier_weight": 150000 },
    { "segment_key": "default", "tier_name": "low", "tier_weight": 800000 }
  ],
  "matrix_config": [
    {
      "budget_tier": "B3", "pressure_tier": "P1",
      "high_multiplier": 1.00, "mid_multiplier": 1.00,
      "low_multiplier": 1.00, "fallback_multiplier": 1.00,
      "cap_multiplier": 1.00, "empty_weight_multiplier": 0.70
    }
  ],
  "strategy_config": {
    "pity": { "enabled": true, "hard_guarantee_threshold": 10, "multiplier_table": {} },
    "anti_empty": { "enabled": true, "empty_streak_threshold": 3 },
    "anti_high": { "enabled": true, "high_streak_threshold": 2, "recent_draw_window": 5 },
    "luck_debt": { "enabled": true, "expected_empty_rate": 0.3, "min_draw_count": 10 },
    "budget_tier": { "threshold_high": 1000, "threshold_mid": 500, "threshold_low": 100 },
    "pressure_tier": { "threshold_high": 0.8, "threshold_low": 0.5 }
  },
  "actual_distribution": {
    "tier_distribution": { "high": 1393, "mid": 165, "low": 233, "fallback": 609 },
    "bxpx_distribution": { "B3_P1": 2078, "B3_P2": 322 },
    "total_draws": 2400
  }
}
```

#### POST /api/v4/console/lottery-simulation/run

æ‰§è¡Œ Monte Carlo æ¨¡æ‹Ÿã€‚

**è¯·æ±‚ä½“**ï¼ˆå­—æ®µåç›´æ¥ä½¿ç”¨ DB åˆ—åï¼Œå‰ç«¯ä¸åšæ˜ å°„ï¼‰ï¼š
```json
{
  "lottery_campaign_id": 1,
  "simulation_count": 10000,
  "proposed_config": {
    "tier_rules": [
      { "segment_key": "default", "tier_name": "high", "tier_weight": 50000 },
      { "segment_key": "default", "tier_name": "mid", "tier_weight": 150000 },
      { "segment_key": "default", "tier_name": "low", "tier_weight": 800000 }
    ],
    "matrix_config": [
      {
        "budget_tier": "B3", "pressure_tier": "P1",
        "high_multiplier": 0.5, "mid_multiplier": 1.0,
        "low_multiplier": 1.0, "fallback_multiplier": 1.0,
        "cap_multiplier": 1.0, "empty_weight_multiplier": 0.7
      }
    ],
    "strategy_config": {
      "pity": { "hard_guarantee_threshold": 8 },
      "anti_empty": { "empty_streak_threshold": 5 }
    }
  },
  "scenario": {
    "budget_distribution": { "B0": 0, "B1": 0, "B2": 0, "B3": 100 },
    "pressure_distribution": { "P0": 0, "P1": 86.6, "P2": 13.4 },
    "segment_distribution": { "default": 80, "new_user": 15, "vip_user": 5 }
  }
}
```

**å“åº”ä½“**ï¼ˆ`res.apiSuccess(data)` çš„ `data` éƒ¨åˆ†ï¼‰ï¼š
```json
{
  "simulation_result": {
    "tier_distribution": { "high": 32.5, "mid": 18.7, "low": 28.3, "fallback": 20.5 },
    "empty_rate": 20.5,
    "cost_metrics": {
      "avg_cost_points_by_tier": { "high": 11.76, "mid": 20.11, "low": 63.88, "fallback": 9.85 },
      "prize_value_per_1000_draws": 85200,
      "budget_deducted_per_1000_draws": 28500,
      "prize_cost_rate": 0.72
    },
    "experience_metrics": {
      "pity_trigger_rate": 2.3,
      "anti_empty_trigger_count": 45,
      "anti_high_trigger_count": 120,
      "avg_draws_to_first_non_empty": 1.8
    }
  },
  "comparison": {
    "tier_delta": { "high": -25.54, "mid": 11.82, "low": 18.59, "fallback": -4.88 },
    "empty_rate_delta": -4.88,
    "cost_delta": {
      "prize_value_per_1000_draws_delta": -12300,
      "budget_deducted_per_1000_draws_delta": -5200,
      "prize_cost_rate_delta": -0.08
    }
  },
  "risk_assessment": {
    "high_tier_risk": "green",
    "empty_rate_risk": "green",
    "budget_depletion_risk": "green",
    "prize_cost_rate_risk": "green"
  }
}
```

#### POST /api/v4/console/lottery-simulation/user-journey

æ¨¡æ‹Ÿå•ä¸ªç”¨æˆ·çš„è¿ç»­æŠ½å¥–æ—…ç¨‹ã€‚

**è¯·æ±‚ä½“ï¼š**
```json
{
  "lottery_campaign_id": 1,
  "proposed_config": { "...åŒ /run æ¥å£..." },
  "user_profile": {
    "budget": 2000,
    "segment_key": "default",
    "initial_empty_streak": 0
  },
  "draw_count": 20
}
```

**å“åº”ä½“**ï¼ˆ`res.apiSuccess(data)` çš„ `data` éƒ¨åˆ†ï¼‰ï¼š
```json
{
  "draws": [
    {
      "draw_number": 1,
      "budget_tier": "B3",
      "pressure_tier": "P1",
      "base_weights": { "high": 50000, "mid": 150000, "low": 800000 },
      "bxpx_adjusted": { "high": 50000, "mid": 150000, "low": 800000, "fallback": 0 },
      "after_high_cap": { "high": 50000, "mid": 150000, "low": 800000, "fallback": 0 },
      "after_pity": { "high": 50000, "mid": 150000, "low": 800000, "fallback": 0 },
      "final_weights": { "high": 50000, "mid": 150000, "low": 800000, "fallback": 0 },
      "final_tier": "low",
      "triggers": [],
      "user_state_after": { "empty_streak": 0, "recent_high_count": 0 }
    }
  ]
}
```

---

## ä¸ƒã€æ•°æ®æµæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 å‰ç«¯ (Alpine.js Composable)            â”‚
â”‚                                                       â”‚
â”‚  å‚æ•°æ²™ç›’ â”€â”€â†’ è¿è¡Œæ¨¡æ‹ŸæŒ‰é’® â”€â”€â†’ POST /simulation/run  â”‚
â”‚                                   â”‚                   â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚              â†“                                        â”‚
â”‚  å¯¹æ¯”åˆ†æé¢æ¿ â†â”€â”€ æ¨¡æ‹Ÿç»“æœ                             â”‚
â”‚  (ECharts åŒæŸ±çŠ¶å›¾ã€çƒ­åŠ›å›¾ã€æŒ‡æ ‡å¡ç‰‡ã€é£é™©ç¯)          â”‚
â”‚                                                       â”‚
â”‚  å‚æ•°æ²™ç›’ â”€â”€â†’ POST /simulation/user-journey           â”‚
â”‚                       â”‚                               â”‚
â”‚                       â†“                               â”‚
â”‚  ç”¨æˆ·æ—…ç¨‹æ—¶é—´çº¿ â†â”€â”€ é€æ¬¡æŠ½å¥–è¯¦æƒ…                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            åç«¯ (StrategySimulationService)            â”‚
â”‚                                                       â”‚
â”‚  åŠ è½½å½“å‰é…ç½® â”€â”€â†’ åˆå¹¶æè®®å‚æ•°ï¼ˆä»…å†…å­˜ä¸­ï¼‰              â”‚
â”‚       â”‚                                               â”‚
â”‚       â†“                                               â”‚
â”‚  Monte Carlo å¼•æ“                                     â”‚
â”‚  (å¤ç”¨ TierPickStage / PityCalculator ç­‰çº¯å‡½æ•°)        â”‚
â”‚       â”‚                                               â”‚
â”‚       â†“                                               â”‚
â”‚  èšåˆ N æ¬¡ç»“æœ â”€â”€â†’ å¯¹æ¯”åˆ†æ â”€â”€â†’ é£é™©è¯„ä¼°              â”‚
â”‚       â”‚                                               â”‚
â”‚       â†“                                               â”‚
â”‚  è¿”å›ç»“æœï¼ˆä¸å†™æ•°æ®åº“ï¼‰                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â†“ (åªè¯»)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®åº“ï¼ˆåªè¯»è®¿é—®ï¼‰                    â”‚
â”‚                                                       â”‚
â”‚  lottery_tier_rules          â†’ åŸºç¡€æƒé‡               â”‚
â”‚  lottery_tier_matrix_config  â†’ BxPx çŸ©é˜µ             â”‚
â”‚  lottery_strategy_config     â†’ ç­–ç•¥å‚æ•°               â”‚
â”‚  lottery_draws               â†’ å†å²çœŸå®åˆ†å¸ƒ            â”‚
â”‚  lottery_draw_decisions      â†’ BxPx å‘½ä¸­åˆ†å¸ƒ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…«ã€å…¶ä»–å†³ç­–ç‚¹

### 8.1 æ¨¡æ‹Ÿå†å²ä¿å­˜ï¼ˆå†³ç­–ç‚¹ 9ï¼‰â€” å·²ç¡®è®¤ï¼šæ–¹æ¡ˆ C æœåŠ¡ç«¯ä¿å­˜

> **å†³å®š**ï¼šæ–°å»º `lottery_simulation_records` è¡¨ï¼Œä¿å­˜æ¨¡æ‹Ÿå‚æ•° + ç»“æœå¿«ç…§ï¼Œæ”¯æŒå¤šäººåä½œå›æº¯ã€‚

**æ–°å¢æ•°æ®åº“è¡¨è®¾è®¡ï¼ˆå¯¹é½é¡¹ç›®ç°æœ‰ Sequelize Model è§„èŒƒï¼‰ï¼š**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|---|---|---|
| `lottery_simulation_record_id` | INT AUTO_INCREMENT | ä¸»é”®ï¼ˆå¯¹é½é¡¹ç›®å‘½åè§„èŒƒï¼šè¡¨åå•æ•° + `_id`ï¼‰ |
| `lottery_campaign_id` | INT, NOT NULL | å…³è”æ´»åŠ¨ IDï¼Œå¤–é”® â†’ `lottery_campaigns` |
| `simulation_name` | VARCHAR(100), NULL | æ“ä½œè€…ç»™æ¨¡æ‹Ÿå–çš„åç§°ï¼ˆå¯é€‰ï¼‰ |
| `simulation_count` | INT, NOT NULL | æ¨¡æ‹Ÿè¿­ä»£æ¬¡æ•° |
| `proposed_config` | JSON, NOT NULL | æ¨¡æ‹Ÿä½¿ç”¨çš„æè®®å‚æ•°å¿«ç…§ |
| `scenario` | JSON, NOT NULL | åœºæ™¯é…ç½®ï¼ˆé¢„ç®—/å‹åŠ›/åˆ†ç¾¤åˆ†å¸ƒï¼‰ |
| `simulation_result` | JSON | æ¨¡æ‹Ÿç»“æœï¼ˆæ¡£ä½åˆ†å¸ƒã€è§¦å‘ç‡ç­‰ï¼‰ |
| `comparison` | JSON | ä¸å½“å‰é…ç½®çš„å¯¹æ¯” delta |
| `risk_assessment` | JSON | é£é™©è¯„ä¼°ç»“æœ |
| `created_by` | INT | æ“ä½œè€…ç”¨æˆ· IDï¼Œå¤–é”® â†’ `users` |
| `created_at` | DATETIME | åˆ›å»ºæ—¶é—´ |
| `updated_at` | DATETIME | æ›´æ–°æ—¶é—´ |

> æ•°æ®åº“å·²ç¡®è®¤è¯¥è¡¨ **ä¸å­˜åœ¨**ï¼ˆ2026-02-20 æ ¡éªŒï¼‰ï¼Œéœ€æ–°å»º migrationã€‚
> Model æ–‡ä»¶æ”¾ `models/LotterySimulationRecord.js`ï¼Œåœ¨ `models/index.js` ä¸­æ³¨å†Œã€‚

### 8.2 æƒé™æ§åˆ¶ï¼ˆå†³ç­–ç‚¹ 12ï¼‰â€” å·²ç¡®è®¤ï¼šæ–¹æ¡ˆ A

> **å†³å®š**ï¼šå¤ç”¨ç­–ç•¥ç®¡ç†æƒé™ï¼Œèƒ½çœ‹åˆ°"ç­–ç•¥ç®¡ç†"Tab çš„äººå°±èƒ½ä½¿ç”¨æ¨¡æ‹Ÿã€‚æ¨¡æ‹Ÿæ˜¯åªè¯»æ“ä½œï¼Œä¸éœ€è¦é¢å¤–æƒé™é¡¹ã€‚

---

## ä¹ã€æ¶‰åŠæ–‡ä»¶æ¸…å•ï¼ˆå¯¹é½é¡¹ç›®å®é™…ç»“æ„ï¼‰

### æ–°å»ºæ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ | è´£ä»»ç«¯ |
|---|---|---|
| `services/lottery-analytics/StrategySimulationService.js` | Monte Carlo å¼•æ“ + ä¸‰ç»´æˆæœ¬åˆ†æ + å¯¹æ¯”åˆ†æï¼Œå¤ç”¨ `compute/calculators/` | åç«¯ |
| `routes/v4/console/lottery-simulation.js` | ç‹¬ç«‹è·¯ç”±æ–‡ä»¶ï¼ˆ3 ä¸ª simulation API + å†å²è®°å½• CRUDï¼‰ï¼Œä¸­é—´ä»¶é“¾: `authenticateToken` + `requireRoleLevel(100)` | åç«¯ |
| `models/LotterySimulationRecord.js` | æ¨¡æ‹Ÿè®°å½• Sequelize Modelï¼ˆ`lottery_simulation_records` è¡¨ï¼‰ | åç«¯ |
| `migrations/xxxxxxxx-add-lottery-simulation-records.js` | åˆ›å»º `lottery_simulation_records` è¡¨ | åç«¯ |
| `migrations/xxxxxxxx-add-campaign-id-to-matrix-and-strategy-config.js` | ç»™ `lottery_tier_matrix_config` å’Œ `lottery_strategy_config` åŠ  `lottery_campaign_id` åˆ— + å›å¡« + ç´¢å¼• | åç«¯ |
| `admin/src/modules/lottery/composables/strategy-simulation.js` | é¡µé¢çŠ¶æ€ï¼ˆ`useStrategySimulationState()` + `useStrategySimulationMethods()`ï¼‰ï¼Œå¯¹é½ç°æœ‰ `strategy.js` composable æ¨¡å¼ | Web å‰ç«¯ |

### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | æ”¹åŠ¨å†…å®¹ | è´£ä»»ç«¯ |
|---|---|---|
| `routes/v4/console/index.js` | `router.use('/lottery-simulation', require('./lottery-simulation'))` | åç«¯ |
| `models/index.js` | `models.LotterySimulationRecord = require('./LotterySimulationRecord')(sequelize, DataTypes)` | åç«¯ |
| `models/LotteryTierMatrixConfig.js` | åŠ  `lottery_campaign_id` å­—æ®µ + å¤–é”®å…³è” | åç«¯ |
| `models/LotteryStrategyConfig.js` | åŠ  `lottery_campaign_id` å­—æ®µ + å¤–é”®å…³è” | åç«¯ |
| `services/index.js` | åœ¨ ServiceManager æ³¨å†Œ `strategy_simulation` æœåŠ¡ | åç«¯ |
| `services/UnifiedLotteryEngine/compute/config/StrategyConfig.js` | é…ç½®åŠ è½½é€»è¾‘åŠ  `lottery_campaign_id` è¿‡æ»¤ | åç«¯ |
| `routes/v4/console/lottery-strategy-stats.js` | ç°æœ‰ config-summary æ¥å£åŠ  `lottery_campaign_id` è¿‡æ»¤ | åç«¯ |
| `admin/src/modules/lottery/composables/index.js` | å¯¼å‡ºæ–° composable | Web å‰ç«¯ |
| `admin/src/modules/lottery/composables/strategy.js` | ç­–ç•¥ç®¡ç† API è°ƒç”¨åŠ  `lottery_campaign_id` å‚æ•° | Web å‰ç«¯ |
| `admin/src/modules/lottery/pages/lottery-management.js` | åœ¨ `categoryTabs` ä¸­æ·»åŠ  `{ id: 'strategy-simulation', title: 'ç­–ç•¥æ¨¡æ‹Ÿ', icon: 'ğŸ§ª' }` | Web å‰ç«¯ |
| `admin/lottery-management.html` | æ·»åŠ  `x-show="current_page === 'strategy-simulation'"` çš„ HTML æ¨¡æ¿åŒºåŸŸ | Web å‰ç«¯ |
| `admin/src/utils/echarts-lazy.js` | æ·»åŠ  `HeatmapChart` å¯¼å…¥ | Web å‰ç«¯ |

> æ³¨æ„ï¼š**ä¸éœ€è¦ä¿®æ”¹ `sidebar-nav.js`**ï¼Œå› ä¸ºæ¨¡æ‹Ÿé¡µé¢æ˜¯ `lottery-management.html` å†…çš„ Tabï¼Œä¸æ˜¯ç‹¬ç«‹èœå•é¡¹ã€‚

---

## åã€åŸºäºçœŸå®æ•°æ®çš„æ¨¡æ‹Ÿæ•ˆæœé¢„æœŸ

å½“å‰æ ¸å¿ƒé—®é¢˜ï¼šbase weight è®¾å®š high=5%ï¼Œä½†å®é™…å‡ºé«˜æ¡£ä½ 58.04%ã€‚åŸå› æ˜¯ 100% ç”¨æˆ·éƒ½åœ¨ B3 å±‚ï¼ŒBxPx çŸ©é˜µå’Œ tier_first æ¨¡å¼ä¸‹æƒé‡å½’ä¸€åŒ–æ”¾å¤§äº† high æ¡£ä½ã€‚

æ¨¡æ‹Ÿé¡µé¢èƒ½å›ç­”çš„å…¸å‹é—®é¢˜ï¼š

| é—®é¢˜ | æ“ä½œ | é¢„æœŸ |
|---|---|---|
| B3P1 çš„ high_multiplier ä» 1.0 é™åˆ° 0.3ï¼Œhigh æ¯”ä¾‹ä¼šé™å¤šå°‘ï¼Ÿ | ä¿®æ”¹çŸ©é˜µå‚æ•° â†’ è·‘æ¨¡æ‹Ÿ | å¾—åˆ°ç²¾ç¡®é¢„æµ‹ |
| base weight ä¸­ high ä» 50,000 é™åˆ° 20,000ï¼Œæœ€ç»ˆåˆ†å¸ƒå¦‚ä½•ï¼Ÿ | ä¿®æ”¹åŸºç¡€æƒé‡ â†’ è·‘æ¨¡æ‹Ÿ | å¾—åˆ°ç²¾ç¡®é¢„æµ‹ |
| pity ç¡¬ä¿åº•é˜ˆå€¼ä» 10 é™åˆ° 5ï¼Œè§¦å‘ç‡å¢åŠ å¤šå°‘ï¼Ÿç©ºå¥–ç‡æ”¹å–„å¤šå¤§ï¼Ÿ | ä¿®æ”¹ pity å‚æ•° â†’ è·‘æ¨¡æ‹Ÿ | å¾—åˆ°è§¦å‘ç‡å’Œç©ºå¥–ç‡é¢„ä¼° |
| 30% ç”¨æˆ·é¢„ç®—ä¸‹é™åˆ° B2ï¼Œæ•´ä½“å‡ºå¥–åˆ†å¸ƒæ€ä¹ˆå˜ï¼Ÿ | è‡ªå®šä¹‰åœºæ™¯åˆ†å¸ƒ â†’ è·‘æ¨¡æ‹Ÿ | å¾—åˆ°æ–°åˆ†å¸ƒé¢„æµ‹ |

---

## åä¸€ã€é£é™©å’Œå±€é™æ€§

ä»¥ä¸‹å±€é™æ€§éœ€è¦åœ¨é¡µé¢ UI ä¸­æ˜ç¡®æç¤ºæ“ä½œè€…ï¼š

1. **æ¨¡æ‹Ÿå‡è®¾å‡åŒ€éšæœº**ï¼šçœŸå®ç”¨æˆ·è¡Œä¸ºæœ‰æ—¶æ®µè§„å¾‹ã€æµå¤±å€¾å‘ã€é¢„ç®—å˜åŒ–ï¼Œæ¨¡æ‹Ÿæ— æ³•å»ºæ¨¡
2. **ä½“éªŒçŠ¶æ€æ˜¯ç´¯ç§¯çš„**ï¼šPity/AntiEmpty/AntiHigh æ˜¯æŒ‰ç”¨æˆ·ç´¯ç§¯çš„ã€‚Monte Carlo æ¨¡æ‹Ÿçš„æ˜¯ç‹¬ç«‹ç”¨æˆ·ä¼šè¯ï¼Œä¸æ˜¯å…¨é‡ç”¨æˆ·ç¾¤çš„çŠ¶æ€æœº
3. **é¢„ç®—åˆ†å¸ƒæ˜¯å…³é”®è¾“å…¥**ï¼šå¦‚æœçœŸå®åˆ†å¸ƒå˜åŒ–ï¼ˆå¦‚å¤§é‡ç”¨æˆ·ä» B3 é™åˆ° B2ï¼‰ï¼Œå®é™…ç»“æœä¼šåç¦»æ¨¡æ‹Ÿ
4. **8% ç¡¬é¡¶å§‹ç»ˆç”Ÿæ•ˆ**ï¼šæ¨¡æ‹Ÿä¸­ä¸ç”Ÿäº§ä¸€è‡´ï¼Œhigh æ¡£ä½æ¦‚ç‡ä¸ä¼šè¶…è¿‡ 8%
5. ~~**åº“å­˜çº¦æŸæœªå»ºæ¨¡**~~ â†’ **å·²é€šè¿‡å¢å¼ºæ¨¡å— 8 è§£å†³**ï¼šæ¨¡æ‹Ÿå¾ªç¯å†…è·Ÿè¸ªæ¯ä¸ªå¥–å“çš„æ¨¡æ‹Ÿåº“å­˜ï¼Œåº“å­˜ä¸º 0 æ—¶è§¦å‘é™çº§ï¼Œä¸ç”Ÿäº§é€»è¾‘å¯¹é½ï¼ˆ`500ç§¯åˆ†åˆ¸` å’Œ `ä¹å…«æŠ˜åˆ¸` å·²è€—å°½çš„æƒ…å†µä¼šè¢«æ­£ç¡®æ¨¡æ‹Ÿï¼‰

---

## åäºŒã€å·¥ä½œé‡ä¼°ç®—ï¼ˆåŸºäºå…¨é‡æ–¹æ¡ˆ + æœåŠ¡ç«¯ä¿å­˜ï¼‰

| æ¨¡å— | åç«¯ | å‰ç«¯ | åˆè®¡ |
|---|---|---|---|
| baseline API + SimulationService åŸºç¡€æ¡†æ¶ | 1 å¤© | - | 1 å¤© |
| Monte Carlo å¼•æ“ï¼ˆçº¯å‡½æ•°æå– + å¾ªç¯ï¼‰ | 1.5 å¤© | - | 1.5 å¤© |
| å‚æ•°æ²™ç›’ UIï¼ˆå« BxPx åŒæ¨¡å¼åˆ‡æ¢ï¼‰ | - | 2 å¤© | 2 å¤© |
| å¯¹æ¯”åˆ†æé¢æ¿ï¼ˆ7 é¡¹å›¾è¡¨å…¨åšï¼‰ | - | 2 å¤© | 2 å¤© |
| ç”¨æˆ·æ—…ç¨‹æ¨¡æ‹Ÿï¼ˆå®Œæ•´ç‰ˆæƒé‡å˜åŒ–é“¾ï¼‰ | 0.5 å¤© | 1 å¤© | 1.5 å¤© |
| æ¨¡æ‹Ÿå†å²ä¿å­˜ï¼ˆModel + Migration + CRUD API + å‰ç«¯åˆ—è¡¨ï¼‰ | 0.5 å¤© | 0.5 å¤© | 1 å¤© |
| åœºæ™¯é¢„è®¾åº“ï¼ˆ4 ä¸ªé¢„è®¾ + å¾®è°ƒ UIï¼‰ | - | 0.5 å¤© | 0.5 å¤© |
| è”è°ƒ + æµ‹è¯• | 0.5 å¤© | 0.5 å¤© | 1 å¤© |
| **åˆè®¡** | **4 å¤©** | **6.5 å¤©** | **10.5 å¤©** |

---

## åä¸‰ã€å†³ç­–æ¸…å•æ±‡æ€»ï¼ˆå…¨éƒ¨å·²ç¡®è®¤ï¼‰

| # | å†³ç­–ç‚¹ | ç¡®è®¤æ–¹æ¡ˆ |
|---|---|---|
| 1 | é¡µé¢æ”¾ç½®ä½ç½® | **A** â€” lottery-management æ–° Tab (`?page=strategy-simulation`) |
| 2 | æ¨¡æ‹Ÿå¼•æ“æ‰§è¡Œä½ç½® | **A** â€” åç«¯ Node.js æœåŠ¡ç«¯è®¡ç®— |
| 3 | åŠŸèƒ½æ¨¡å—å–èˆ | **å…¨é‡æ–¹æ¡ˆ** â€” 4 ä¸ªæ¨¡å—å…¨éƒ¨å®ç° |
| 4 | å‚æ•°æ²™ç›’ UI å½¢å¼ | **A** â€” å·¦å³å¯¹æ¯”å¸ƒå±€ï¼ˆå½“å‰å€¼åªè¯» + æ¨¡æ‹Ÿå€¼å¯ç¼–è¾‘ï¼‰ |
| 5 | BxPx çŸ©é˜µç¼–è¾‘æ–¹å¼ | **A+B åŒæ¨¡å¼** â€” çƒ­åŠ›å›¾ + å…¨çŸ©é˜µè¡¨æ ¼ï¼Œæä¾›åˆ‡æ¢æŒ‰é’® |
| 6 | å¯¹æ¯”åˆ†æå›¾è¡¨é€‰æ‹© | **7 é¡¹å…¨åš** â€” åŒæŸ±çŠ¶å›¾ã€åŒçƒ­åŠ›å›¾ã€è§¦å‘ç‡å¡ç‰‡ã€é¢„ç®—å¡ã€é£é™©ç¯ã€è¿å‡»ç›´æ–¹å›¾ã€ç´¯ç§¯æ›²çº¿ |
| 7 | åœºæ™¯é¢„è®¾èƒ½åŠ› | **C** â€” é¢„è®¾åœºæ™¯åº“ï¼ˆå½“å‰çœŸå®/å‡åŒ€åˆ†å¸ƒ/ä½é¢„ç®—å¢å¤š/é«˜å‹åŠ›åœºæ™¯ï¼‰+ å¯å¾®è°ƒ |
| 8 | ç”¨æˆ·æ—…ç¨‹æ·±åº¦ | **B** â€” å®Œæ•´ç‰ˆï¼ˆæ¯æŠ½å±•ç¤ºå®Œæ•´æƒé‡å˜åŒ–é“¾ï¼‰ |
| 9 | æ¨¡æ‹Ÿå†å²ä¿å­˜ | **C** â€” æœåŠ¡ç«¯ä¿å­˜ï¼ˆæ–°å»º lottery_simulation_records è¡¨ï¼‰ |
| 10 | åç«¯è·¯ç”±ç»„ç»‡ | **B** â€” ç‹¬ç«‹è·¯ç”±æ–‡ä»¶ `routes/v4/console/lottery-simulation.js` |
| 11 | æ¨¡æ‹Ÿç²¾åº¦é€‰æ‹© | **B** â€” æ“ä½œè€…å¯é€‰ï¼šå¿«é€Ÿ(1K) / æ ‡å‡†(10K) / ç²¾ç¡®(50K) |
| 12 | æƒé™æ§åˆ¶ | **A** â€” å¤ç”¨ç­–ç•¥ç®¡ç†æƒé™ï¼ˆ`requireRoleLevel(100)`ï¼‰ |
| 13 | æˆæœ¬æŒ‡æ ‡ç»´åº¦ | **A+B æ··åˆ** â€” ä¸‰ç»´æˆæœ¬çŸ©é˜µï¼šç”¨æˆ·ä¾§(`cost_points`) + å¹³å°ä¾§(`budget_deducted`) + å¥–å“ä»·å€¼(`prize_value`) |
| 14 | çŸ©é˜µ/ç­–ç•¥é…ç½®ä½œç”¨åŸŸ | **B** â€” ç°åœ¨å°±åŠ  `lottery_campaign_id` åˆ—ï¼Œæå‰åšå¥½å¤šæ´»åŠ¨å‡†å¤‡ |

---

## åå››ã€åç«¯æŠ€æœ¯æ ˆå¯å¤ç”¨/å¯æ‰©å±•åˆ†æ

### 14.1 å¯ç›´æ¥å¤ç”¨ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰

| ç°æœ‰ç»„ä»¶ | å¤ç”¨æ–¹å¼ | èŠ‚çœå·¥ä½œé‡ |
|---|---|---|
| `compute/calculators/TierMatrixCalculator` | æ„é€ æ—¶æ³¨å…¥æ¨¡æ‹ŸçŸ©é˜µé…ç½®ï¼Œè°ƒç”¨ `calculate()` å¾—åˆ°è°ƒæ•´åæƒé‡ | çŸ©é˜µä¹˜æ•°è®¡ç®—ä¸ç”¨é‡å†™ |
| `compute/calculators/PityCalculator` | æ„é€ æ—¶æ³¨å…¥æ¨¡æ‹Ÿ pity é…ç½®ï¼Œè°ƒç”¨ `calculate()` å¾—åˆ° pity è°ƒæ•´åæƒé‡ | Pity ä¹˜æ•°é€»è¾‘ä¸ç”¨é‡å†™ |
| `compute/calculators/BudgetTierCalculator` | æ³¨å…¥é˜ˆå€¼é…ç½®ï¼Œåˆ¤æ–­ B0-B3 | é¢„ç®—åˆ†å±‚ä¸ç”¨é‡å†™ |
| `compute/calculators/PressureTierCalculator` | æ³¨å…¥é˜ˆå€¼é…ç½®ï¼Œåˆ¤æ–­ P0-P2 | å‹åŠ›åˆ†å±‚ä¸ç”¨é‡å†™ |
| `TierPickStage._enforceHighTierCap()` | ç›´æ¥è°ƒç”¨é™æ€æ–¹æ³• | 8% ç¡¬é¡¶ä¸ç”¨é‡å†™ |
| `TierPickStage._pickTier()` | ç›´æ¥è°ƒç”¨é™æ€æ–¹æ³• | éšæœºé€‰æ¡£ä½ä¸ç”¨é‡å†™ |
| `admin/src/utils/echarts-lazy.js` | å‰ç«¯å›¾è¡¨æ¸²æŸ“åŸºç¡€è®¾æ–½å·²å°±ç»ª | ä¸ç”¨é…ç½® ECharts |
| `admin/src/api/base.js` | API è¯·æ±‚åŸºç¡€è®¾æ–½ï¼ˆfetch + token + æ ‡å‡†å“åº”å¤„ç†ï¼‰ | ä¸ç”¨å†™ HTTP å±‚ |
| ç°æœ‰ composable æ¨¡å¼ (`useXxxState()` + `useXxxMethods()`) | å‰ç«¯çŠ¶æ€ç®¡ç†æ¨¡å¼ä¸€è‡´ | æ¶æ„ä¸€è‡´æ€§ |
| `authenticateToken` + `requireRoleLevel(100)` ä¸­é—´ä»¶é“¾ | è·¯ç”±é‰´æƒç›´æ¥å¤ç”¨ | ä¸ç”¨å†™æƒé™é€»è¾‘ |
| `res.apiSuccess()` / `res.apiError()` å“åº”å·¥å…· | æ ‡å‡†å“åº”æ ¼å¼ | ä¸ç”¨å®šä¹‰å“åº”ç»“æ„ |
| ServiceManager æ³¨å†Œæ¨¡å¼ | `req.app.locals.services.getService()` | æœåŠ¡å‘ç°ä¸€è‡´ |

### 14.2 éœ€è¦æ–°å»ºä½†å¯æ‰©å±•

| æ–°å»ºç»„ä»¶ | æ‰©å±•æ€§è®¾è®¡ |
|---|---|
| `StrategySimulationService` | æœªæ¥å¯æ”¯æŒå¤šæ´»åŠ¨å¯¹æ¯”ã€A/B æµ‹è¯•æ¨¡æ‹Ÿã€å®šæ—¶è‡ªåŠ¨æ¨¡æ‹Ÿ |
| `LotterySimulationRecord` Model | JSON å­—æ®µï¼ˆproposed_config/scenario/resultï¼‰å¤©ç„¶æ”¯æŒé…ç½®ç»“æ„å˜åŒ– |
| å‰ç«¯ composable `strategy-simulation.js` | å¯æ‰©å±•æ›´å¤šå›¾è¡¨ç±»å‹ã€åœºæ™¯é¢„è®¾ |

### 14.3 Web ç®¡ç†åå°å‰ç«¯æŠ€æœ¯æ ˆå…¼å®¹æ€§ç¡®è®¤

| æŠ€æœ¯é¡¹ | é¡¹ç›®ç°æœ‰ | æ¨¡æ‹Ÿé¡µé¢éœ€è¦ | å…¼å®¹æ€§ |
|---|---|---|---|
| æ¡†æ¶ | Alpine.js (ES Module) | Alpine.js composable | âœ… å®Œå…¨å…¼å®¹ |
| CSS | Tailwind + themed-* è‡ªå®šä¹‰ç±» | åŒä¸Š | âœ… å®Œå…¨å…¼å®¹ |
| å›¾è¡¨ | ECharts (tree-shaken lazy load) | åŒæŸ±çŠ¶å›¾ã€çƒ­åŠ›å›¾ã€æŠ˜çº¿å›¾ã€ç›´æ–¹å›¾ | âœ… å·²æ”¯æŒ BarChart/LineChartï¼Œéœ€æ–°å¢ HeatmapChart å¯¼å…¥ |
| API | native fetch + base.js wrapper | apiGet/apiCall | âœ… å®Œå…¨å…¼å®¹ |
| é¡µé¢æ³¨å†Œ | categoryTabs + x-show + loadPageData() | æ–°å¢ Tab å…¥å£ | âœ… å®Œå…¨å…¼å®¹ |
| çŠ¶æ€ç®¡ç† | useXxxState() + useXxxMethods() + spread | åŒä¸Š | âœ… å®Œå…¨å…¼å®¹ |

> ECharts éœ€é¢å¤–å¯¼å…¥ `HeatmapChart` ç»„ä»¶åˆ° `echarts-lazy.js`ï¼ˆå½“å‰æœªå¯¼å…¥ï¼‰ï¼Œè¿™æ˜¯å”¯ä¸€çš„å‰ç«¯ä¾èµ–å˜æ›´ã€‚

---

## åäº”ã€é—®é¢˜å½’å±åˆ†ç±»

### 15.1 åç«¯æ•°æ®åº“é¡¹ç›®çš„é—®é¢˜ï¼ˆéœ€åç«¯å®æ–½ï¼‰

| # | é—®é¢˜ | å…·ä½“å†…å®¹ |
|---|---|---|
| B1 | æ–°å»º migration | åˆ›å»º `lottery_simulation_records` è¡¨ï¼ˆDB å·²ç¡®è®¤ä¸å­˜åœ¨ï¼‰ |
| B2 | æ–°å»º Model | `models/LotterySimulationRecord.js` + æ³¨å†Œåˆ° `models/index.js` |
| B3 | æ–°å»º Service | `services/lottery-analytics/StrategySimulationService.js`ï¼Œå¤ç”¨ `compute/calculators/*` |
| B4 | æ–°å»ºè·¯ç”± | `routes/v4/console/lottery-simulation.js`ï¼Œ3 ä¸ª API + å†å²è®°å½• CRUD |
| B5 | æ³¨å†Œè·¯ç”± | `routes/v4/console/index.js` æ·»åŠ æŒ‚è½½ |
| B6 | æ³¨å†ŒæœåŠ¡ | `services/index.js` çš„ ServiceManager ä¸­æ³¨å†Œ |
| B7 | çŸ©é˜µ/ç­–ç•¥åŠ  campaign_id | âœ… å·²å†³ç­–ï¼šç»™ `lottery_tier_matrix_config` å’Œ `lottery_strategy_config` åŠ  `lottery_campaign_id` åˆ—ï¼Œå›å¡«ç°æœ‰æ•°æ®ä¸º campaign_id=1 |
| B8 | æ›´æ–°é…ç½®åŠ è½½é€»è¾‘ | `compute/config/StrategyConfig.js` æŒ‰ campaign_id è¿‡æ»¤ |
| B9 | æ›´æ–°ç°æœ‰ç­–ç•¥æ¥å£ | `lottery-strategy-stats.js` çš„ config-summary åŠ  campaign_id |

### 15.2 Web ç®¡ç†åå°å‰ç«¯é¡¹ç›®çš„é—®é¢˜ï¼ˆéœ€ Web å‰ç«¯å®æ–½ï¼‰

| # | é—®é¢˜ | å…·ä½“å†…å®¹ |
|---|---|---|
| W1 | æ–°å»º composable | `admin/src/modules/lottery/composables/strategy-simulation.js` |
| W2 | æ³¨å†Œ Tab | `lottery-management.js` çš„ `categoryTabs` æ·»åŠ å…¥å£ |
| W3 | HTML æ¨¡æ¿ | `lottery-management.html` æ·»åŠ  `x-show` åŒºåŸŸ |
| W4 | ECharts æ‰©å±• | `echarts-lazy.js` æ·»åŠ  `HeatmapChart` å¯¼å…¥ |
| W5 | å¯¼å‡º composable | `composables/index.js` å¯¼å‡ºæ–° composable |
| W6 | å­—æ®µåå¯¹é½ | å‰ç«¯ç›´æ¥ä½¿ç”¨åç«¯ DB å­—æ®µåï¼ˆ`tier_weight`/`config_group`/`reward_tier` ç­‰ï¼‰ï¼Œä¸åšæ˜ å°„ |
| W7 | ç°æœ‰ç­–ç•¥ç®¡ç†é€‚é… | `strategy.js` composable çš„ API è°ƒç”¨åŠ  `lottery_campaign_id` å‚æ•° |

### 15.3 å¾®ä¿¡å°ç¨‹åºå‰ç«¯é¡¹ç›®çš„é—®é¢˜

| # | ç»“è®º |
|---|---|
| æ—  | ç­–ç•¥æ¨¡æ‹Ÿåˆ†ææ˜¯çº¯åå°ç®¡ç†åŠŸèƒ½ï¼Œå¾®ä¿¡å°ç¨‹åºç«¯ **æ— ä»»ä½•æ”¹åŠ¨éœ€æ±‚** |

---

## åå…­ã€å†³ç­–ç¡®è®¤è®°å½•

### 16.1 âœ… å·²ç¡®è®¤ï¼šSection 1.2 "å¹³å‡æ¶ˆè€—ç§¯åˆ†" æ•°æ®æ¥æºä¸ä¸‰ç»´æˆæœ¬æ–¹æ¡ˆ

**æ•°æ®æº¯æºç»“è®º**ï¼šåŸç¨¿çš„"å¹³å‡æ¶ˆè€—ç§¯åˆ†"æ¥è‡ª `lottery_draws.cost_points`ï¼ˆç”¨æˆ·æ¯æ¬¡æŠ½å¥–èŠ±è´¹çš„ç§¯åˆ†ï¼‰ï¼Œä¸ `lottery_draw_decisions.budget_deducted`ï¼ˆå¹³å°ä¾§é¢„ç®—æ¶ˆè€—ï¼‰æ˜¯å®Œå…¨ä¸åŒçš„æˆæœ¬ç»´åº¦ã€‚

**ç¡®è®¤æ–¹æ¡ˆï¼šA+B æ··åˆï¼ˆä¸‰ç»´æˆæœ¬çŸ©é˜µï¼‰**

ä¿ç•™åŸç¨¿ `cost_points` æ•°æ®ï¼ˆç”¨æˆ·ä¾§æˆæœ¬ï¼‰ï¼Œæ¨¡æ‹Ÿè¾“å‡ºåŒæ—¶å±•ç¤ºä¸‰ä¸ªç»´åº¦ï¼š

| æŒ‡æ ‡ | DB æ¥æº | ç”¨é€” | è¡Œä¸šå¯¹æ ‡ |
|---|---|---|---|
| ç”¨æˆ·æ¯æ¬¡æŠ½å¥–æ¶ˆè€— | `AVG(lottery_draws.cost_points)` æŒ‰æ¡£ä½ | ç”¨æˆ·ä½“éªŒæ˜¯å¦åˆç† | æ¸¸æˆå…¬å¸è§†è§’ |
| æ¯åƒæ¬¡é¢„ä¼°å¥–å“å‘æ”¾ä»·å€¼ | `SUM(lottery_draws.prize_value) / draws Ã— 1000` | å¹³å°å®é™…æˆæœ¬ | ç¾å›¢æ ¸å¿ƒæŒ‡æ ‡ |
| æ¯åƒæ¬¡é¢„ä¼°é¢„ç®—æ¶ˆè€— | `SUM(lottery_draw_decisions.budget_deducted) / draws Ã— 1000` | é¢„ç®—è€—å°½é¢„è­¦ | ç¾å›¢é¢„ç®—æ§åˆ¶ |
| å¥–å“æˆæœ¬ç‡ | å¥–å“å‘æ”¾æ€»ä»·å€¼ / ç”¨æˆ·æ¶ˆè€—æ€»ç§¯åˆ† | ç›ˆäºå¹³è¡¡çº¢çº¿ | ç¾å›¢å…³é”®çº¢çº¿ |
| Pity/AntiEmpty/AntiHigh è§¦å‘ç‡ | æ¨¡æ‹Ÿç»Ÿè®¡ | ç”¨æˆ·ä½“éªŒä¿éšœ | æ¸¸æˆå…¬å¸æ ¸å¿ƒ |
| å¹³å‡é¦–æ¬¡éç©ºæ‰€éœ€æŠ½æ•° | æ¨¡æ‹Ÿç»Ÿè®¡ | æ–°ç”¨æˆ·ä½“éªŒ | æ¸¸æˆå…¬å¸è§†è§’ |

### 16.2 âœ… å·²ç¡®è®¤ï¼šçŸ©é˜µ/ç­–ç•¥é…ç½®åŠ  `lottery_campaign_id` åˆ—

**ç¡®è®¤æ–¹æ¡ˆï¼šB â€” ç°åœ¨å°±åŠ  `lottery_campaign_id` åˆ—**

å¯¹ `lottery_tier_matrix_config` å’Œ `lottery_strategy_config` ä¸¤å¼ è¡¨æ–°å¢ `lottery_campaign_id` åˆ—ï¼Œæå‰åšå¥½å¤šæ´»åŠ¨å‡†å¤‡ã€‚

**å®æ–½è¦ç‚¹ï¼š**
- æ–°å¢ migrationï¼šç»™ä¸¤å¼ è¡¨åŠ  `lottery_campaign_id` åˆ—ï¼ˆINT, NULLï¼Œå¤–é”® â†’ `lottery_campaigns`ï¼‰
- æ•°æ®å›å¡«ï¼šç°æœ‰æ•°æ®å…¨éƒ¨å›å¡« `lottery_campaign_id = 1`ï¼ˆå½“å‰å”¯ä¸€æ´»åŠ¨ï¼‰
- å›å¡«åæ”¹ä¸º NOT NULL + æ·»åŠ ç´¢å¼•
- ä¿®æ”¹ baseline æŸ¥è¯¢é€»è¾‘ï¼šæ”¹ä¸º `WHERE lottery_campaign_id = :id`
- ä¿®æ”¹ç°æœ‰ç­–ç•¥ç®¡ç†é¡µé¢çš„è¯»å†™é€»è¾‘ï¼šåŠ ä¸Š campaign_id è¿‡æ»¤
- ä¿®æ”¹ `compute/calculators/` ä¸­çš„é…ç½®åŠ è½½é€»è¾‘ï¼šæŒ‰ campaign_id æŸ¥è¯¢

**æ–°å¢ migration æ–‡ä»¶**ï¼ˆè¿½åŠ åˆ° Phase 1ï¼‰ï¼š
- `migrations/xxxxxxxx-add-campaign-id-to-matrix-and-strategy-config.js`

**å—å½±å“çš„ç°æœ‰æ–‡ä»¶**ï¼ˆè¿½åŠ åˆ°ä¿®æ”¹æ–‡ä»¶æ¸…å•ï¼‰ï¼š
- `models/LotteryTierMatrixConfig.js` â€” Model åŠ å­—æ®µ + å¤–é”®
- `models/LotteryStrategyConfig.js` â€” Model åŠ å­—æ®µ + å¤–é”®
- `services/UnifiedLotteryEngine/compute/config/StrategyConfig.js` â€” é…ç½®åŠ è½½åŠ  campaign_id è¿‡æ»¤
- `routes/v4/console/lottery-strategy-stats.js` â€” ç°æœ‰ config-summary æ¥å£åŠ  campaign_id
- `admin/src/modules/lottery/composables/strategy.js` â€” å‰ç«¯ç­–ç•¥ç®¡ç†åŠ  campaign_id å‚æ•°

---

## åä¸ƒã€å®æ–½æ­¥éª¤ï¼ˆæŒ‰ä¾èµ–é¡ºåºï¼‰

### Phase 1: åç«¯åŸºç¡€è®¾æ–½ï¼ˆé¢„è®¡ 2.5 å¤©ï¼‰

| æ­¥éª¤ | æ“ä½œ | æ–‡ä»¶ |
|---|---|---|
| 1 | åˆ›å»º migrationï¼š`lottery_simulation_records` è¡¨ | `migrations/xxxxxxxx-add-lottery-simulation-records.js` |
| 2 | åˆ›å»º migrationï¼šç»™ `lottery_tier_matrix_config` å’Œ `lottery_strategy_config` åŠ  `lottery_campaign_id` åˆ— + å›å¡« + NOT NULL + ç´¢å¼• | `migrations/xxxxxxxx-add-campaign-id-to-matrix-and-strategy-config.js` |
| 3 | åˆ›å»º Modelï¼š`LotterySimulationRecord` | `models/LotterySimulationRecord.js` |
| 4 | æ›´æ–° Modelï¼š`LotteryTierMatrixConfig` åŠ  `lottery_campaign_id` å­—æ®µ + å¤–é”® | `models/LotteryTierMatrixConfig.js` |
| 5 | æ›´æ–° Modelï¼š`LotteryStrategyConfig` åŠ  `lottery_campaign_id` å­—æ®µ + å¤–é”® | `models/LotteryStrategyConfig.js` |
| 6 | æ³¨å†Œ Model | `models/index.js` æ·»åŠ  `LotterySimulationRecord` |
| 7 | è¿è¡Œ migration | `npx sequelize-cli db:migrate` |
| 8 | æ›´æ–°é…ç½®åŠ è½½é€»è¾‘ï¼šæŒ‰ `lottery_campaign_id` è¿‡æ»¤ | `compute/config/StrategyConfig.js` |
| 9 | æ›´æ–°ç°æœ‰ç­–ç•¥ç®¡ç†æ¥å£ï¼šåŠ  `campaign_id` è¿‡æ»¤ | `routes/v4/console/lottery-strategy-stats.js` |

### Phase 2: åç«¯æ¨¡æ‹Ÿå¼•æ“ï¼ˆé¢„è®¡ 2 å¤©ï¼‰

| æ­¥éª¤ | æ“ä½œ | æ–‡ä»¶ |
|---|---|---|
| 10 | åˆ›å»º StrategySimulationServiceï¼Œrequire å¹¶å¤ç”¨ `TierMatrixCalculator`ã€`PityCalculator`ã€`AntiEmptyStreakHandler`ã€`AntiHighStreakHandler`ã€`TierPickStage._enforceHighTierCap` | `services/lottery-analytics/StrategySimulationService.js` |
| 11 | å®ç° `loadBaseline(lottery_campaign_id)` â€” 3 ä¸ªè¡¨æŸ¥è¯¢å…¨éƒ¨æŒ‰ `lottery_campaign_id` è¿‡æ»¤ + draws ç»Ÿè®¡ | åŒä¸Š |
| 12 | å®ç° `runSimulation(proposed_config, scenario, count)` â€” Monte Carlo å¾ªç¯ï¼Œæ¯è½®è°ƒç”¨ calculator çº¯å‡½æ•°ï¼Œè¾“å‡ºä¸‰ç»´æˆæœ¬çŸ©é˜µ | åŒä¸Š |
| 13 | å®ç° `simulateUserJourney(proposed_config, user_profile, draw_count)` â€” å•ç”¨æˆ·è¿ç»­æ¨¡æ‹Ÿ | åŒä¸Š |
| 14 | å®ç°å¯¹æ¯”åˆ†æï¼ˆå« cost_deltaï¼‰å’Œé£é™©è¯„ä¼°é€»è¾‘ï¼ˆå«å¥–å“æˆæœ¬ç‡é£é™©ï¼‰ | åŒä¸Š |

### Phase 3: åç«¯è·¯ç”±ï¼ˆé¢„è®¡ 0.5 å¤©ï¼‰

| æ­¥éª¤ | æ“ä½œ | æ–‡ä»¶ |
|---|---|---|
| 15 | åˆ›å»ºè·¯ç”±æ–‡ä»¶ï¼Œ3 ä¸ª simulation API + å†å²è®°å½• CRUDï¼ˆGET list + GET detail + DELETEï¼‰ | `routes/v4/console/lottery-simulation.js` |
| 16 | æ³¨å†Œè·¯ç”±åˆ° console/index.js | `routes/v4/console/index.js` |
| 17 | æ³¨å†ŒæœåŠ¡åˆ° ServiceManager | `services/index.js` |

### Phase 4: Web å‰ç«¯ï¼ˆé¢„è®¡ 5.5 å¤©ï¼‰

| æ­¥éª¤ | æ“ä½œ | æ–‡ä»¶ |
|---|---|---|
| 18 | `echarts-lazy.js` æ·»åŠ  HeatmapChart å¯¼å…¥ | `admin/src/utils/echarts-lazy.js` |
| 19 | åˆ›å»º composableï¼ˆ`useStrategySimulationState()` + `useStrategySimulationMethods()`ï¼‰ | `admin/src/modules/lottery/composables/strategy-simulation.js` |
| 20 | æ³¨å†Œ Tab å…¥å£åˆ° categoryTabs | `admin/src/modules/lottery/pages/lottery-management.js` |
| 21 | åˆ›å»º HTML æ¨¡æ¿åŒºåŸŸï¼ˆå‚æ•°æ²™ç›’ + ä¸‰ç»´æˆæœ¬å¡ç‰‡ + å¯¹æ¯”é¢æ¿ + ç”¨æˆ·æ—…ç¨‹ + å†å²è®°å½•ï¼‰ | `admin/lottery-management.html` |
| 22 | å¯¼å‡º composable | `admin/src/modules/lottery/composables/index.js` |
| 23 | æ›´æ–°ç°æœ‰ç­–ç•¥ç®¡ç† composableï¼šAPI è°ƒç”¨åŠ  `lottery_campaign_id` å‚æ•° | `admin/src/modules/lottery/composables/strategy.js` |

### Phase 5: è”è°ƒï¼ˆé¢„è®¡ 1.5 å¤©ï¼‰

| æ­¥éª¤ | æ“ä½œ |
|---|---|
| 24 | åç«¯ API å•å…ƒæµ‹è¯•ï¼ˆbaseline æ•°æ®åŠ è½½ã€campaign_id è¿‡æ»¤ã€æ¨¡æ‹Ÿç»“æœä¸€è‡´æ€§ï¼‰ |
| 25 | å‰åç«¯è”è°ƒï¼ˆå‚æ•°ä¼ é€’ã€ä¸‰ç»´æˆæœ¬å›¾è¡¨æ¸²æŸ“ã€åœºæ™¯é¢„è®¾ï¼‰ |
| 26 | å¯¹æ¯”çœŸå®æ•°æ®éªŒè¯æ¨¡æ‹Ÿç²¾åº¦ï¼ˆä¸‰ç»´æˆæœ¬ delta æ˜¯å¦åˆç†ï¼‰ |

**æ€»å·¥æ—¶ä¿®è®¢ï¼šPhase 1(2.5d) + Phase 2(2d) + Phase 3(0.5d) + Phase 4(5.5d) + Phase 5(1.5d) = 12 å¤©**ï¼ˆåŸä¼° 10.5 å¤©ï¼Œå› æ–°å¢ campaign_id è¿ç§» +1.5 å¤©ï¼‰
