### 生产级资产与物品交易统一方案（可叠加资产 + 不可叠加物品）

> 适用场景：游戏虚拟资产体系（材料/钻石/金币等可叠加资产 + 装备/卡牌等不可叠加物品）与交易市场/兑换市场/材料转换。
>
> 本文给出**最终生产方案**（single source of truth），用于长期稳定运行与对账；不讨论临时/过渡/测试/开发方案。

---

### 0. 前提与边界（不考虑现有代码/不考虑兼容性）

- **允许破坏性改动**：可以改表结构、改接口、删旧表、重建服务边界。
- **不做兼容**：不存在“旧接口继续可用/旧表继续读写”的约束。
- **单一真相强约束**：同一资产的余额与流水只能有一个最终来源（single source of truth）。
- **目标业务范围**：
  - 可叠加资产：钻石/材料/金币等数量型资产
  - 不可叠加物品：装备实例/卡牌实例/二手商品实例
  - 交易市场：挂牌/购买/撤回/手续费/退款与争议
  - 兑换市场：材料支付兑换实物
  - 材料转换：材料↔材料、材料→钻石等

---

### 0.1 需求拍板结论（强约束，后续所有设计以此为准）

- **水晶/材料资产形态**：水晶属于**余额型（可叠加）资产**，用账本余额表达（例如 `red_shard=100`），不做实例化道具。
- **交易是否必须冻结**：交易市场必须采用“下单冻结 → 成交结算 → 取消解冻”的模型（冻结为强制，不允许绕过）。
- **退款能力**：**最终决策：不支持退款/争议仲裁**（订单一旦 `completed` 即为终态，不可退款）。`SYSTEM_ESCROW` 托管账户保留但暂无实际业务流程。如未来需支持退款，必须单独立项并重审账本分录与状态机。
- **系统账户模型**：采用独立 `accounts` 表，区分 `account_type=user|system`；系统账户不复用真实用户。
- **结算币种（交易市场）**：交易市场结算币种**只允许 `DIAMOND`**（挂牌定价与成交结算统一为 DIAMOND）。
- **手续费模型（交易市场）**：手续费从成交总额中拆分（`gross_amount = fee_amount + net_amount`），平台手续费进入系统账户（见 `SYSTEM_PLATFORM_FEE`）；默认手续费率 5%（可按价值分档，最终确认采用统一 5% 或分档策略）。
- **强幂等（所有写操作）**：交易/兑换/转换必须由客户端提供 `business_id`（或 Header `Idempotency-Key`），缺失直接 400；同 key 重试返回同结果（必须返回 `is_duplicate=true`），同 key 参数不一致返回 409。**严格禁止后端兜底生成幂等键**。
- **幂等键参数一致性校验口径**：
  - **交易下单（购买挂牌）**：`listing_id` + `buyer_user_id` + `gross_amount`（或 `price_amount`）+ `asset_code`
  - **兑换市场**：`item_id` + `quantity` + `pay_asset_code` + `pay_amount`
  - **材料转换**：`user_id` + `from_asset_code` + `to_asset_code` + `from_amount`（`to_amount` 为推导字段不纳入指纹）

---

### 1. 背景与问题定义

在虚拟资产交易/兑换/转换并存的系统里，最常见的事故根因是“多套余额真相并行”。并行体系在“功能上”可以同时存在，但在生产环境会带来根本性风险：**同一种资产出现两套余额口径**，导致：

- **余额展示与扣款校验口径不一致**
- **对账/报表口径割裂（跨表聚合、易漏算/重复算）**
- **幂等键语义不一致，重试时可能出现“这一套认为重复、另一套不认为”**

---

### 2. 目标（生产级约束）

- **单一真相（Single Source of Truth）**：任何“余额”只能有一个最终来源
- **可审计可对账**：任意资产变动可回放、可追溯到业务单据（订单/兑换/转换）
- **强一致关键路径**：成交/扣款/转移所有权必须原子
- **支持多方结算**：买家扣、卖家入、平台手续费入等多分录
- **同时支持两类资产形态**：
  - **可叠加资产（Fungible）**：钻石、材料、金币等
  - **不可叠加物品（Non-fungible）**：装备实例、卡牌实例、二手商品实例等

---

### 3. 核心架构：两域分离 + 订单绑定

#### 3.1 统一账本域（Ledger Domain）——只管可叠加资产

职责：

- **余额**：可用/冻结（可选但强烈建议）
- **流水**：所有变动的审计记录
- **幂等**：防重复扣款/入账
- **对账口径**：同一业务单据产生的多分录可聚合核对

最终约束：

- 任何涉及钻石/材料数量的扣加都必须落到**同一个账本**（Ledger）

#### 3.2 物品所有权域（Item Ownership Domain）——只管不可叠加物品

职责：

- 物品实例的**所有者**、**状态机**、**上架/锁定/成交/取消**等
- 物品的“交易合约”信息（挂牌价、交易限制等）

最终约束：

- 任何“物品属于谁”的真相只能来自**物品实例表**（Item Instance）

#### 3.3 订单域（Order/Trade Domain）——把两域绑定为一个业务单据

职责：

- 产生 `business_id`（幂等键/对账键）
- 记录成交单据、状态、参与方
- 串起“物品所有权变更 + 账本多分录”

---

### 4. 数据模型（最终态建议）

#### 4.1 可叠加资产账本（Ledger）

**表：`accounts`（账户主体，独立于用户/系统）**

- `account_id`（主键）
- `account_type`：`user | system`
- `user_id`（当 `account_type=user` 时必填且唯一；当 `system` 时为 null）
- `system_code`（当 `account_type=system` 时必填且唯一，例如 `SYSTEM_PLATFORM_FEE`）
- `status`：`active | disabled`
- `created_at/updated_at`

**表：`account_asset_balances`（余额真相）**

- `account_id`
- `asset_code`：如 `DIAMOND`、`red_shard`……
- `available_amount`：可用余额（整数）
- `frozen_amount`：冻结余额（整数）
- 唯一索引：`(account_id, asset_code)`

**表：`asset_transactions`（审计真相，append-only）**

- `account_id`
- `asset_code`
- `delta_amount`：正/负表示增加/扣减（你们已有）
- `balance_before`
- `balance_after`
- `business_id`：业务单据 ID（幂等/对账关键）
- `business_type`：分录类型（buyer_debit/seller_credit/platform_fee/exchange_debit/convert_credit…）
- `meta`：订单号、物品 id、费率等扩展信息
- 幂等唯一索引：`(business_id, business_type)`

**冻结流水（本方案强制必须）**

冻结/解冻本质上也是账本分录的一种，可用 `business_type` 明确区分，例如：

- `order_freeze_buyer`：下单冻结
- `order_unfreeze_buyer`：取消/超时解冻
- `order_settle_buyer_debit`：成交从冻结转为扣款（或解冻后扣款）
- `order_settle_buyer_unfreeze`：成交时将冻结转为可用（可选，取决于实现是否“冻结余额直接扣减”还是“先解冻再扣减”）

#### 4.2 不可叠加物品（Item Ownership）

**最终决策：使用独立 `item_instances` 表作为物品实例真相（强约束）**

生产级必须将"物品实例"与"交易上架信息"显式建模，以支持并发与售后：

**表：`item_instances`（物品实例真相，必须实现）**

- `item_instance_id`（主键）
- `owner_user_id`（所有权真相，关联 `users.user_id`）
- `item_type` / `item_template_id`（可选：模板/品类，如 voucher/product/service）
- `status`：`available | locked | transferred | used | expired`（按业务裁剪）
- `meta`（JSON）：属性/词条/序列号、物品详情（name/description/icon/value 等）
- `created_at / updated_at`

**迁移策略（从现有 `user_inventory`）**：

- 将 `user_inventory` 数据迁移到 `item_instances`（`inventory_id → item_instance_id`，`user_id → owner_user_id`）
- 现有 `user_inventory` 表在迁移后可保留或删除（视历史兼容需求而定）

**表：`market_listings`（挂牌真相，订单撮合入口）**

- `listing_id`
- `listing_kind`：`item_instance | fungible_asset`（挂牌类型：不可叠加物品/可叠加资产）
- `seller_user_id`
- **挂牌标的（Offer）**
  - `offer_item_instance_id`（当 `listing_kind=item_instance` 时必填）
  - `offer_asset_code`（当 `listing_kind=fungible_asset` 时必填，例如 `red_shard`）
  - `offer_amount`（当 `listing_kind=fungible_asset` 时必填，例如 100）
- **成交对价（Price）**
  - `price_asset_code`（结算资产，默认 `DIAMOND`）
  - `price_amount`（本次挂牌的总价，单位为 `price_asset_code`）
- **冻结与锁定**
  - `seller_offer_frozen`（BOOLEAN）：挂牌标的是否已冻结（可叠加资产挂牌必须为 true）
  - `locked_by_order_id`、`locked_at`（并发与超时控制关键）
- `status`：`on_sale | locked | sold | withdrawn`

并发控制要求：

- 购买流程必须在事务中把 `market_listings` 从 `on_sale → locked`（或直接 `sold`），并同时锁定 `item_instances`。

#### 4.3 订单/成交记录（Trade Record / Order）

**表：`trade_orders`（订单真相，幂等入口）**

- `order_id`
- `business_id`（幂等键，唯一）
- `listing_id`
- `buyer_user_id`、`seller_user_id`
- `asset_code`（如 `DIAMOND`）
- `gross_amount` / `fee_amount` / `net_amount`（`gross = fee + net`）
- `status`：`created | frozen | paid | completed | cancelled | refunded | failed`
- `meta`

> 要求：任何一次扣款/冻结/解冻/退款，都必须能通过 `business_id` 聚合到账本分录集合。

---

### 5. 关键业务流程（最终态）

#### 5.1 不可叠加物品交易：成交（买家买到一件装备）

**输入**：`business_id`、`listing_id`、`buyer_id`

**同一数据库事务内完成：**

- **步骤 A：锁定挂牌与物品实例**
  - `market_listings` 行锁，校验 `status=on_sale`，并置为 `locked`
  - `item_instances` 行锁，校验 `owner_user_id=seller_user_id` 与 `status=available/可交易`
- **步骤 B：下单冻结（强烈推荐）**
  - 账本：冻结买家 `asset_code=DIAMOND` 的 `gross_amount`（分录类型：`order_freeze_buyer`）——**强制**
  - 订单：`trade_orders.status = frozen`
- **步骤 C：结算（多分录）**
  - 买家：从冻结转扣款（或解冻后扣款），`order_settle_buyer_debit`
  - 卖家：入账 `order_settle_seller_credit`
  - 平台：入账手续费 `order_settle_platform_fee_credit`（如启用）
- **步骤 D：转移所有权并完结挂牌**
  - `item_instances.owner_user_id: seller → buyer`
  - `market_listings.status: locked → sold`
  - `trade_orders.status: completed`

**幂等要求：**

- 同一 `business_id` 重试：不得重复冻结/扣款/入账/转移；返回同一订单结果（幂等返回）

#### 5.2 不可叠加物品交易：取消/下架

**撤回挂牌**

- `market_listings.status: on_sale → withdrawn`
- 不触碰账本

**订单取消（若已冻结）**

- `trade_orders.status: frozen/created → cancelled`
- 账本解冻：`order_unfreeze_buyer`

#### 5.4 退款/争议（本方案不支持）

**最终决策：本方案不支持退款/争议仲裁**：

- 订单 `completed` 后为终态，不可退款（业务强约束）
- 不提供 `refund_*` 分录类型
- 不提供 `SYSTEM_ESCROW` 托管账户的实际业务流程（账户保留但仅用于未来扩展）
- 如未来需支持退款，必须单独立项设计：退款订单/仲裁单 + 反向分录 + 物品回退/托管策略 + 状态机扩展

#### 5.5 兑换市场：材料支付兑换实物

最终态：

- 计算 `pay_asset_code/cost_amount*quantity`
- **账本扣减材料**：`asset_code=pay_asset_code`，`business_type=exchange_debit`
- 生成兑换订单并落库（`exchange_market_records.business_id` 用于幂等返回）
- 不自动进行材料→钻石转换（材料不足直接失败）

**兑换商品成本字段（实现与上线硬约束）**：

- 兑换商品必须配置成本：`exchange_items.cost_asset_code` + `exchange_items.cost_amount`
- **不做并行兼容**：支付逻辑只认 `cost_asset_code/cost_amount`（未配置或 `cost_amount<=0` 视为配置错误：禁止上架/禁止兑换）
- **不允许自动辅助**：兑换流程不允许隐式拆分/隐式转换；余额不足直接失败（用户需先显式转换）

#### 5.6 材料 → 钻石 显式分解

最终态：

- 材料规则与风控在材料域完成（是否允许、比例等；规则本身可以继续由 `MaterialConversionRule/MaterialAssetType` 提供）
- 账本执行两笔分录（同一 `business_id`）：
  - `red_shard` 扣减：`business_type=material_convert_debit`
  - `DIAMOND` 入账：`business_type=material_convert_credit`

**强约束（必须写入实现与验收）**：

- **唯一允许直转路径（本期）**：只允许 `red_shard → DIAMOND`；禁止 `red_crystal/orange_* → DIAMOND` 的越级直转（必须先按材料规则逐级到 `red_shard`）
- **固定比例（本期口径）**：`1 red_shard = 20 DIAMOND`（存储在 `material_conversion_rules` 表，`from_amount=1, to_amount=20`）
- **强一致**：同一数据库事务内完成"扣材料 + 加钻石 + 双流水"；任何一步失败全部回滚
- **双分录共享同一 `business_id`**：
  - `material_convert_debit`（扣减 `red_shard`）与 `material_convert_credit`（入账 `DIAMOND`）使用同一 `business_id`
  - 通过 `business_type` 区分两条分录，便于对账聚合（`WHERE business_id = ? AND business_type IN ('material_convert_debit', 'material_convert_credit')`）
- **幂等**：
  - 同一 `business_id` 重试必须返回同一结果（不得重复扣材料/重复入账）；返回 `is_duplicate=true`
  - 同一 `business_id` 但参数不同必须返回 409（冲突保护，校验字段：`user_id/from_asset_code/to_asset_code/from_amount`）

#### 5.7 可叠加资产挂单交易（以水晶 red_shard 为例：卖水晶、收 DIAMOND）

> 目标：允许把“余额型水晶”当作可挂牌出售的商品，而不把水晶实例化到 `item_instances`。
>
> 核心约束：你已拍板“交易必须冻结”，因此**卖家侧也必须占用库存**，采用“挂牌冻结卖家水晶”模型。

**挂牌（卖家创建 listing，强制冻结卖家水晶）**

- 输入：`business_id`（挂牌幂等键）、`offer_asset_code=red_shard`、`offer_amount`、`price_asset_code=DIAMOND`、`price_amount`
- 同一事务内完成：
  - 创建 `market_listings`（`listing_kind=fungible_asset`，`status=on_sale`）
  - 账本冻结卖家水晶（`offer_asset_code`）：
    - `business_type=listing_freeze_seller_offer`
    - 语义：`available_amount → frozen_amount`（冻结数量 = `offer_amount`）
  - `market_listings.seller_offer_frozen=true`

**购买（买家下单，锁定 listing 并冻结买家 DIAMOND）**

- 输入：`business_id`（订单幂等键）、`listing_id`
- 同一事务内完成：
  - 锁定 `market_listings`：`on_sale → locked`，写入 `locked_by_order_id/locked_at`
  - 校验 `seller_offer_frozen=true`（卖家水晶已冻结，否则禁止成交）
  - 创建 `trade_orders`（`status=frozen`）
  - 账本冻结买家 DIAMOND：
    - `business_type=order_freeze_buyer`
    - 冻结数量 = `gross_amount`（本方案：`gross_amount = price_amount`；手续费从 `gross_amount` 内拆分：`gross_amount = fee_amount + net_amount`，不额外加收）

**成交结算（多分录 + 交付水晶）**

同一事务内完成：

- 买家：从冻结完成扣款（DIAMOND）
  - `order_settle_buyer_debit`
- 卖家：入账 DIAMOND（净额）
  - `order_settle_seller_credit`
- 平台：入账手续费（如启用）
  - `order_settle_platform_fee_credit`
- 卖家：从冻结扣减水晶（交付给买家准备）
  - `listing_settle_seller_offer_debit`：`frozen_amount → 0`（扣减 `offer_amount`）
- 买家：收到水晶入账
  - `listing_transfer_buyer_offer_credit`：`available_amount += offer_amount`
- 更新状态：
  - `market_listings.status: locked → sold`
  - `trade_orders.status: completed`

**撤单（卖家下架，解冻卖家水晶）**

- 仅允许 `market_listings.status=on_sale`
- 同一事务内完成：
  - `market_listings.status: on_sale → withdrawn`
  - 账本解冻卖家水晶：
    - `business_type=listing_unfreeze_seller_offer`
    - 语义：`frozen_amount → available_amount`（解冻数量 = `offer_amount`）

---

### 6. 幂等与对账规范（生产级强约束）

- **业务单据 ID：`business_id`**
  - 订单/兑换/转换必须有全局唯一 `business_id`
  - 用于幂等返回、对账聚合、客服定位

- **账本分录类型：`business_type`**
  - 同一 `business_id` 可以有多条分录（例如交易市场三分录）
  - 账本幂等以 `(business_id, business_type)` 唯一约束为准

- **对账口径**
  - 交易市场：`gross_amount = fee_amount + net_amount`
  - `trade_orders.business_id` 必须能关联到 `asset_transactions` 的同 `business_id` 分录集合

---

### 7. “材料系统/钻石系统”在最终态的定位

为避免双账本冲突，最终态建议：

- **材料域（配置与展示）保留**：材料类型/展示/规则/风控仍然存在
- **余额与流水一律归账本**：不存在材料专用余额表/钻石专用余额表作为真相的情况

换句话说：

- **余额与流水**：统一账本
- **规则与配置**：材料域

#### 7.1 材料域"保留做配置与展示"的具体落地口径

**最终决策：材料配置表必须实现，禁止硬编码**

材料域配置表建议（生产级，强制实现）：

- 材料类型配置：`material_asset_types`（必须建表）
  - 用于：`display_name/group_code/form/tier/sort_order/visible_value_points` 等展示与分组
  - **禁止硬编码**：所有材料类型必须来自配置表，便于运营动态调整
- 材料转换规则配置：`material_conversion_rules`（必须建表并支持版本化）
  - 用于：材料合成/分解/逐级转换的规则与风控校验
  - **版本化强约束**：改比例/生效时间通过新增规则 + `effective_at` 实现（禁止 UPDATE 覆盖历史），确保流水可回放/可解释

硬约束：

- **材料配置真相**：`material_asset_types` / `material_conversion_rules`（必须建表，禁止硬编码）
- **材料余额真相**：Ledger（`account_asset_balances` + `asset_transactions`）

#### 7.2 余额接口如何在“账本真相”基础上拼材料展示（实现指引）

目标：用户侧资产列表既能看到“余额”，也能看到材料的展示信息与分组，但余额只来自账本。

建议最终输出字段（示例）：

- `asset_code`
- `balance`（来自 `account_asset_balances.available_amount`）
- `display_name/group_code/tier/form/sort_order`（若 `asset_code` 是材料，来自 `material_asset_types`；若 `asset_code='DIAMOND'`，由代码内固定映射）

实现方式（最终态建议）：

- 先从账本读取用户所有 `asset_code` 余额
- 再按 `asset_code` 查询材料配置表补齐展示字段
- `DIAMOND` 这类“非材料资产”的展示信息由 `asset_definitions`（可选）或代码内固定映射提供

#### 7.3 材料配置与规则的生产级约束（从旧方案全量纳入，强制实现）

**最终决策：材料规则必须配置表化 + 版本化，禁止硬编码**

- **材料资产类型（配置真相，必须建表）**：`material_asset_types`
  - 必含字段：`asset_code`（主键/唯一）、`display_name`、`group_code`、`form(shard|crystal)`、`tier`、`sort_order`、`is_enabled`、`created_at/updated_at`
  - 价值口径（保留两套）：`visible_value_points`（展示锚点）与 `budget_value_points`（预算/系统口径）
  - **禁止硬编码**：所有材料展示/转换规则必须来自配置表
- **材料转换规则（配置真相，必须建表）**：`material_conversion_rules`
  - 必含字段：`rule_id`（主键）、`from_asset_code`、`to_asset_code`、`from_amount`、`to_amount`、`effective_at`、`is_enabled`、`created_by`、`created_at`
  - **版本化强约束（强制执行）**：
    - 改比例/费率必须新增规则（禁止 UPDATE 覆盖历史规则的 `from_amount/to_amount/effective_at`）
    - 通过 `effective_at` 生效时间控制规则切换（取当前时间前的最新已启用规则）
    - 历史流水可通过 `effective_at` 回放计算依据，确保可审计/可解释
  - **风控校验（保存/启用时触发）**：
    - 循环拦截：不得出现 A→B→...→A 的闭环路径
    - 套利拦截：不得出现"沿环路换一圈资产数量不减反增"（负环检测）

#### 7.4 抽奖发放材料（生产级可配置 + 幂等）

- 奖品可配置材料发放：`lottery_prizes.material_asset_code/material_amount`
- 发放必须纳入抽奖事务（或同一 `business_id` 幂等链路）：
  - 建议 `business_id`：`lottery_draw_{draw_id}_{asset_code}`（可追溯、可重放）

#### 7.5 管理后台必须支持的能力（生产级验收项）

- **材料资产类型管理**：新增/禁用/排序/配置价值口径
- **材料转换规则管理**：新增/禁用/版本化生效时间；保存/启用时触发风控校验（不通过直接拦截）
- **材料余额查询（Admin）**：按用户查询其材料余额（含展示名）
- **材料流水查询（Admin）**：按 `user_id/business_id/时间范围` 查询
- **兑换商品成本配置（Admin Marketplace）**：维护 `cost_asset_code/cost_amount`
- **DIAMOND（Admin）**：查询用户余额与流水
- **管理员人工调整（必需，且必须幂等）**：
  - 材料：对任意 `asset_code` 做加/减，写账本分录 `business_type=admin_adjustment`
  - DIAMOND：同样支持加/减，写账本分录 `business_type=admin_adjustment`

#### 7.6 存量与初始化策略（本期默认）

- 上线时用户材料余额 **从 0 开始**（不做历史存量回填）

---

### 8. 资产定义、系统账户与规则（生产级必须写死）

#### 8.1 资产定义表（推荐：防止“asset_code 随意增长导致治理失控”）

**表：`asset_definitions`（资产定义/治理）**

- `asset_code`（唯一）：例如 `DIAMOND`、`red_shard`
- `asset_kind`：`currency | material | points | other`
- `display_name` / `icon` / `description`
- `unit`：统一为整数单位（例如 “1 DIAMOND”“1 red_shard”）
- `is_enabled`：是否启用（禁用后禁止新增交易/转换）
- `is_tradeable`：是否允许交易市场结算/挂牌定价使用
- `is_freezable`：是否允许冻结（本方案：`DIAMOND=true`；若某材料允许挂单出售，则该材料也必须为 `true`，例如 `red_shard=true`）
- `allow_negative`：是否允许负数（生产建议 `false`）
- `created_at/updated_at`

> 说明：材料依然保留 `material_asset_types` 做“材料特有展示与层级”，但 `asset_definitions` 是全资产层面的治理表（用于统一 API 输出与风控开关）。

#### 8.2 系统账户（避免“平台手续费账户=某个用户ID”的隐患）

本方案要求：系统账户必须独立于用户（通过 `accounts.account_type=system` 实现），不得复用真实用户。

- **平台手续费账户**：`SYSTEM_PLATFORM_FEE`
- **系统发放账户**：`SYSTEM_MINT`
- **系统销毁账户**：`SYSTEM_BURN`
- **平台托管账户（预留，暂无业务流程）**：`SYSTEM_ESCROW`（账户保留但本方案不支持退款/争议，暂无实际业务流程）

实现方式（两种选一）：

- **本方案采用**：`accounts` 表引入 `account_type = user | system`，账本余额表与流水表均以 `account_id` 做归属（生产推荐）

> 迁移提示：旧系统/旧落地方案里可能出现 `PLATFORM_USER_ID`（用真实用户充当“平台手续费账户”）的做法。
> 生产级最终态禁止该做法；平台手续费必须进入系统账户 `SYSTEM_PLATFORM_FEE`。如历史已用真实用户承接手续费，仅允许在迁移/对账阶段做映射与归集，新写入一律指向系统账户。

#### 8.3 手续费规则（Fee Rules）——分档、最小手续费、monetize 入平台

生产级要求手续费规则**可配置、可审计、可解释**，并能在对账时回放计算依据。

- **开关**：
  - 全局：`fee_rules.enabled`
  - 交易类型：`fee_rules.trade_type_fees.market_purchase.enabled`
- **策略（固定）**：`fee_rules.fee_strategy = monetize`
  - monetize 语义：手续费分录 `order_settle_platform_fee_credit` 入账至系统账户 `SYSTEM_PLATFORM_FEE`
- **计算口径（硬约束）**：
  - `gross_amount`：买家本次成交支付总额（单位 DIAMOND）
  - `fee_amount = ceil(gross_amount * rate)`，且当手续费启用时满足 `fee_amount >= min_fee`
  - `net_amount = gross_amount - fee_amount`
  - 对账强校验：`gross_amount = fee_amount + net_amount`
- **费率策略（最终确认）**：
  - **默认统一费率：5%**（`fee_amount = ceil(gross_amount * 0.05)`）
  - 最小手续费：`min_fee = 1`（手续费启用时，`fee_amount >= 1`）
  - 分档策略（可选，暂不实现）：若未来需按价值分档（3%/5%/10%），需单独立项并确认分档依据（`gross_amount` 还是物品 `value`）

> 分档依据（实现需一致）：可按 `gross_amount` 分档；若业务要求“按标的价值分档”，需把价值锚点写入 `trade_orders.meta` 与账本分录 `meta`（如 `estimated_value_points`），确保对账可解释。

---

### 9. 接口契约与错误码（生产级联调规范）

#### 9.1 幂等键规范（强制执行，必须一致）

**最终决策：严格客户端提供幂等键，后端不允许兜底生成**

- 客户端必须提供 `business_id`（Body）或 HTTP Header `Idempotency-Key`（二选一）
- **缺失幂等键：直接返回 400**（错误信息必须明确告知"缺少幂等键"，不允许后端兜底生成）
- **同一 `business_id` 的重复请求必须返回同一结果**（不重复扣款/入账/转移），**必须返回 `is_duplicate=true`**
- **同一 `business_id` 但参数不同必须返回 409 冲突错误**（避免幂等键被复用到不同业务）

#### 9.1.1 业务侧幂等交互口径（实现约束）

- **强制要求**：用户侧所有写操作（交易/兑换/转换/调整）必须提供幂等键（Body `business_id` 或 Header `Idempotency-Key` 二选一）
- **缺失拒绝**：两者都缺失返回 400，错误信息示例：`缺少幂等键：请在 Body 中提供 business_id 或在 Header 中提供 Idempotency-Key`
- **响应体强制字段**：
  - `is_duplicate`（boolean）：当命中幂等返回时为 `true`，首次执行为 `false`（便于客户端与排障）
  - `business_id`（string）：回传实际使用的幂等键（便于客户端确认）

#### 9.1.3 参数一致性校验口径（409 冲突判定标准）

**最终确认口径（实现标准）**：

- **交易下单（购买挂牌）**：
  - 指纹字段：`listing_id` + `buyer_user_id` + `gross_amount`（或 `price_amount`）+ `asset_code`
  - 存储位置：`trade_orders.meta.request_params_hash`（可选，用于快速冲突判定）
- **兑换市场**：
  - 指纹字段：`item_id` + `quantity` + `pay_asset_code` + `pay_amount`
  - 验证规则：`pay_asset_code` 必须等于 `cost_asset_code`，`pay_amount` 必须等于 `cost_amount * quantity`
- **材料转换**：
  - 指纹字段：`user_id` + `from_asset_code` + `to_asset_code` + `from_amount`
  - `to_amount` 为推导字段（不纳入指纹），避免规则版本变化导致误判

#### 9.1.2 时间与时区（实现约束）

- 生产统一使用北京时间：`Asia/Shanghai`（日志/审计时间、业务时间字段的格式化口径必须一致）
- 锁超时时间：**15 分钟**（`market_listings.locked_at` 超过 15 分钟自动解锁；可配置但默认 15 分钟）

#### 9.3 交易市场定价入参（硬约束：不兼容旧“积分定价”）

生产级交易市场挂牌/购买只允许 DIAMOND 定价：

- 挂牌：`price_asset_code` 必须为 `DIAMOND`
- 挂牌：只允许传 `price_amount`（DIAMOND 整数金额）
- 禁止任何“积分定价/展示积分”等旧入参参与撮合或成交（收到即 400）

> 说明：历史系统可能存在 `selling_points` 等字段；在生产级方案中，该类字段只能用于迁移期对照或展示，不允许作为成交口径。

#### 9.2 标准错误码建议

- **400 BAD_REQUEST**：参数缺失/非法、数量<=0、状态机不允许的操作
- **401 UNAUTHORIZED**：未登录
- **403 FORBIDDEN**：无权限、资产不可交易/不可冻结
- **404 NOT_FOUND**：listing/item/order 不存在
- **409 CONFLICT**：幂等键冲突、重复成交、状态冲突（如已 sold）
- **422 UNPROCESSABLE_ENTITY**：余额不足、库存不可交易、规则不支持
- **429 TOO_MANY_REQUESTS**：频率限制触发
- **500 INTERNAL_ERROR**：不可预期异常（必须可追踪到 trace_id）

响应体建议统一包含：

- `error_code`
- `message`
- `business_id`（若有）
- `trace_id`

---

### 10. 状态机与并发控制（生产级必须明确）

#### 10.1 `market_listings` 状态机

- `on_sale → locked → sold`
- `on_sale → withdrawn`
- `locked → on_sale`（锁超时/取消订单解锁）

规则：

- `locked` 必须记录 `locked_by_order_id/locked_at`
- **锁超时时间：15 分钟**（到期自动解锁，由定时任务或订单取消触发；可配置但默认 15 分钟）
- `listing_kind=fungible_asset` 时：卖家挂牌必须已冻结标的资产（`seller_offer_frozen=true`），否则禁止进入 `locked/sold`

#### 10.2 `trade_orders` 状态机

- `created → frozen → completed`
- `created/frozen → cancelled`
- `* → failed`（不可恢复错误）

**说明**：本方案不支持退款/争议，因此无 `refunded` 状态；`completed/cancelled/failed` 均为终态，不可逆转。

#### 10.3 锁顺序规范（避免死锁）

建议统一锁顺序：

- 先锁 `trade_orders`（若已存在）
- 再锁 `market_listings`
- 再锁 `item_instances`
- 最后锁账本账户（买家→卖家→平台/系统账户）

---

### 11. 账本分录类型枚举（生产级对账口径）

建议将 `business_type` 固化为枚举（至少覆盖以下类别）：

- **挂牌/订单阶段**
  - `order_freeze_buyer`
  - `order_unfreeze_buyer`
  - `listing_freeze_seller_offer`（可叠加资产挂牌：冻结卖家标的，例如冻结 `red_shard`）
  - `listing_unfreeze_seller_offer`（撤单/失败：解冻卖家标的）
- **成交结算（DIAMOND）**
  - `order_settle_buyer_debit`
  - `order_settle_seller_credit`
  - `order_settle_platform_fee_credit`
- **可叠加资产交付（卖家标的 → 买家）**
  - `listing_settle_seller_offer_debit`（从冻结扣减卖家标的资产）
  - `listing_transfer_buyer_offer_credit`（买家收到标的资产入账）
- **兑换市场（材料扣减）**
  - `exchange_debit`
- **材料转换**
  - `material_convert_debit`
  - `material_convert_credit`
- **退款/仲裁**
  - `refund_*` 分录（本方案不支持退款/争议，因此不提供此类分录；`SYSTEM_ESCROW` 账户保留但暂无业务流程）
- **管理员**
  - `admin_adjustment`

对账规则（必须可自动验证）：

- 对于交易订单：`gross_amount = fee_amount + net_amount`
- 对于同一 `business_id`：应能找到完整分录集合（冻结/解冻/结算各自可选，符合状态机；本方案不支持退款分录）

---

### 12. 风控、安全与审计（生产级必须可解释）

#### 12.1 风控点（最小集合）

- **频率限制**：同一用户单位时间内的购买/撤回/上架次数
- **价格异常**：与品类/历史均价偏离过大，触发人工审核或限制
- **重复锁定/刷单**：频繁触发 locked 超时、频繁取消
- **材料转换套利**：规则图检测（避免环路套利）与异常转换频率

**材料转换规则风控（强校验，建议最低实现）**：

- **循环拦截（必拦截）**：新增/启用规则后，存在从某个 `asset_code` 出发可回到自身的路径
- **套利闭环拦截（必拦截）**：存在任意闭环使得“沿环路换一圈资产数量不减反增”
  - 判定建议：将每条规则倍率 \(r=\frac{to_amount}{from_amount}\) 对数化为边权 \(w=-\log(r)\)，做有向图负环检测（Bellman-Ford）
  - 范围建议：限定在同一 `group_code` + 已生效（`effective_at`）+ `is_enabled=true` 的规则集合内

#### 12.2 审计日志（必须）

对以下动作必须写审计日志（含 `operator_id/trace_id/business_id`）：

- 管理员调整资产
- 强制取消订单/强制退款
- 禁用资产/禁用材料类型/禁用转换规则

---

### 13. 运维、对账作业与可观测性（生产级保障）

#### 13.1 对账作业（每天自动跑）

- **订单对账**：订单金额字段 vs 分录聚合一致性
- **冻结对账**：冻结余额 = 所有未完成订单冻结之和（按用户/资产维度）
- **异常扫描**：负余额、缺失分录、订单完成但 listing 未 sold、或反之

#### 13.2 指标与告警（建议最小集合）

- 成交成功率（`completed / attempted`）
- 幂等命中率（重复请求占比）
- 锁超时数量（`locked` 超时解锁次数）
- 退款率/仲裁率
- 账本写入失败率、事务回滚率

---

### 14. 最终结论

生产级的“可叠加资产 + 不可叠加物品交易”最佳实践是：

- **一个统一账本（Ledger）承载所有可叠加资产余额与流水（single source of truth）**
- **一个物品所有权域承载所有不可叠加物品的实例与状态机（single source of truth）**
- **订单域用同一个 `business_id` 把“物品所有权变化 + 账本多分录”绑定在一个原子事务里**

该架构能同时满足：

- 交易市场（多方结算/手续费/对账）
- 兑换市场（材料支付）
- 材料转换（规则/风控 + 统一记账）
- 不可叠加物品交易（所有权转移与资产结算强一致）

---

### 附录 A：从“旧架构落地方案（对齐当前代码）”提炼并纳入本生产方案的验收硬约束

- **DIAMOND 结算**：交易市场结算资产固定为 `DIAMOND`，不允许积分/其他资产作为成交口径。
- **手续费 monetize**：启用手续费时，平台手续费必须入账系统账户 `SYSTEM_PLATFORM_FEE`；且 `gross_amount = fee_amount + net_amount`。
- **强幂等**：兑换/转换/交易写操作必须带 `business_id`（或 `Idempotency-Key`）；重复请求幂等返回并建议返回 `is_duplicate=true`；参数冲突返回 409。
- **兑换材料支付**：兑换支付只认 `exchange_items.cost_asset_code/cost_amount`；材料不足直接失败；不允许隐式材料→钻石转换。
- **材料→DIAMOND 显式分解**：只允许 `red_shard → DIAMOND`，比例 `1:20`，同事务双分录，强幂等。
