# 客服工作台重设计方案

> 基于项目实际代码、真实数据库数据（96张表、66用户、6758物品实例、3030抽奖记录）全面分析后制定
>
> 包含行业方案横向对比（大厂/游戏公司/交易平台/小公司/活动策划）和最终选型论证
>
> **2026-02-22 后端验证**：已通过 Node.js + mysql2 直连 `restaurant_points_dev` 数据库核验全部数据，纠正API路径对齐后端 `/api/v4/console/customer-service/` 体系，新增可复用服务分析、三方归属、决策事项、执行步骤（见第十~十四节）
>
> **2026-02-22 二次深度验证**：深度遍历后端 `services/`（80+ Service）、`routes/v4/console/customer-service/`（6个路由文件）、`models/`（96个Model文件）、`services/index.js`（ServiceManager 完整注册表）。**重大发现**：已有 `UserDataQueryService`（8个方法）覆盖 user-context 70% 功能，Phase 1 代码量从 ~300 行降至 ~120 行。同时验证 Web 前端 `admin/src/modules/content/`（8个composable + 5个page）与后端 100% 技术兼容。新增决策8、小程序字段对齐清单（见 11.3/13 节）

---

## 一、系统本质定位

本项目不是普通的"餐厅系统"。从数据库结构和业务逻辑来看，它是一个 **游戏化积分运营平台**：

| 业务模块 | 类比行业 | 实际实现 |
|---------|---------|---------|
| 抽奖系统 | 手游抽卡 | tier_first 分层权重、保底机制、防连空/防连高、预算隔离 |
| 资产体系 | MMO游戏货币 | 7色碎片→水晶合成链、DIAMOND通货、POINTS/BUDGET_POINTS双轨 |
| 物品背包 | RPG背包系统 | item_template + item_instance、稀有度(common→legendary)、多级锁 |
| C2C市场 | 游戏交易所 | 挂单→冻结→锁定→成交/取消、DIAMOND计价、手续费体系 |
| 竞拍系统 | 拍卖行 | bid_products + bid_records |
| 门店体系 | 线下核销 | 消费→积分→抽奖→物品→市场交易 闭环 |

结论：客服工作台应对标 **游戏GM工作台 + 交易仲裁台** 的混合体，而非传统电商客服。

---

## 二、当前客服工作台缺陷诊断

基于真实数据库数据分析：

### 2.1 信息断裂 — 客服看不到业务上下文

当前右侧面板只有用户基本信息（头像/昵称/手机号）。但一个用户可能同时有：

- `account_asset_balances` 中的 DIAMOND 82万+、POINTS 151万+、red_shard 19万+
- `item_instances` 中的数千个物品（4196 available、624 locked）
- `lottery_draws` 中的抽奖记录（总计3030条）
- `market_listings` 中的挂单（21个在售、19个已售、255个已撤回）
- `trade_orders` 中的交易订单（20个已完成、112个已取消）
- `consumption_records` 中的消费核销记录

客服完全看不到这些，处理任何业务问题都要切到其他管理页面查询。

### 2.2 操作无能 — 客服只能聊天不能做事

当前客服只能：发消息、转接、关闭会话。

但实际业务场景需要：查看用户资产余额和交易流水、查看背包物品和锁定状态、查看抽奖记录和中奖情况、查看市场挂单和交易订单状态、查看消费核销记录、处理冻结资产/解锁物品。

### 2.3 工单缺失 — 150条反馈无人处理

`feedbacks` 表有 150 条 pending 状态。反馈处理（feedback-management.html）和客服聊天（customer-service.html）是两个完全独立的系统，聊天中发现的问题无法关联成工单跟踪。

### 2.4 会话堆积 — 18个等待只有1个坐席

`customer_service_agents` 仅1条 active 记录，`customer_service_sessions` 有18个 waiting 状态。需要更好的队列管理和优先级调度。

### 2.5 统计粗糙 — 只有响应时间

缺少按问题类型分布、按模块分布、解决率、重复咨询率等业务维度统计。

---

## 三、行业客服系统横向对比

不同行业的客服系统差异不在于"布局是三栏还是四栏"，而在于**解决问题的工作流模型**完全不同。

### 3.1 大厂模型（美团/阿里/腾讯）

**核心理念：漏斗式分层拦截**

```
用户问题进入
    │
    ▼
[第1层] 智能客服机器人 ──── 拦截 80%+ 的常见问题
    │ 无法解决
    ▼
[第2层] 意图识别 + 自动路由 ── 识别问题类型，分配到对应技能组
    │
    ▼
[第3层] 人工客服 ──── 配合「工单系统」跟踪到底
    │ 无法解决
    ▼
[第4层] 专家/主管介入 ──── 升级处理
    │
    ▼
[闭环] 用户满意度评价 → 质检 → 知识库沉淀
```

**核心能力清单**：

| 能力 | 说明 | 本项目适用性 |
|------|------|------------|
| 智能机器人 | 自动回答FAQ，拦截80%+简单咨询 | 后期可做，当前规模不需要 |
| 意图识别路由 | 根据问题类型自动分配给对应技能组 | 不需要，只有1-2个客服 |
| 工单系统 | 问题跟踪到底，跨班次不丢失 | **需要** |
| 质检系统 | 随机抽查会话质量，打分考核 | 后期可做 |
| 知识库 | 客服可搜索的解决方案库 | **需要** |
| 用户满意度 | 会话结束后评分 | **需要**（字段已存在但无功能） |
| SLA管理 | 响应超时自动告警/升级 | **需要** |

**结论**：大厂的AI分流和路由系统投入产出比太低（只有1个客服坐席），但工单系统、知识库、满意度闭环是任何规模都需要的。

### 3.2 游戏公司模型（米哈游/网易/腾讯游戏）

**核心理念：一键诊断 + 补偿工具**

游戏客服的核心不是"聊天"，而是：

```
玩家报告问题
    │
    ▼
[自动诊断] 一键检测该玩家的所有状态
    │ 结果: "交易订单#123卡在frozen状态已超时15分钟"
    ▼
[标准处理] 按问题类型执行标准操作(SOP)
    │ 例如: 解冻订单 + 退还钻石 + 补偿50钻石
    ▼
[补偿发放] 一键发放补偿物品/货币
    │
    ▼
[记录归档] 自动记录处理结果，关联到工单
```

**核心能力清单**：

| 能力 | 说明 | 本项目适用性 |
|------|------|------------|
| **一键诊断** | 选中用户后自动检查所有可能的问题 | **高度需要** |
| **补偿工具** | 直接在客服界面发放物品/货币 | **高度需要** |
| **标准操作流程(SOP)** | 每种问题类型有标准处理步骤 | **需要** |
| **操作审计** | 客服的每个操作都记录日志 | **需要**（admin_operation_logs表已存在） |
| **批量补偿** | 系统故障时一次性补偿所有受影响用户 | 中期需要 |
| **问题历史** | 用户下次来时看到所有历史会话和处理记录 | **需要** |
| 360度玩家视图 | 角色/背包/充值/行为日志一屏可见 | **需要**（即C区上下文面板） |

**结论**：本项目业务本质是游戏系统（虚拟资产、抽奖、交易），GM工作台模型高度适配。一键诊断和补偿工具是效率提升最大的功能。

### 3.3 虚拟物品交易平台模型（5173/交易猫/Steam）

**核心理念：证据链 + 仲裁裁决**

```
用户发起纠纷
    │
    ▼
[证据收集] 自动提取交易链路的所有数据
    │ 买家操作记录 + 卖家操作记录 + 系统日志 + 资金流向
    ▼
[双方视角] 同时展示买卖双方的完整信息
    │
    ▼
[仲裁裁决] 客服做出裁决: 退款/放行/部分退款
    │
    ▼
[执行裁决] 一键执行: 解冻 + 转账 + 退还 + 通知双方
```

**核心能力清单**：

| 能力 | 说明 | 本项目适用性 |
|------|------|------------|
| **双方视角** | 同时看到买卖双方的信息 | **需要**（有C2C市场） |
| **交易链路可视化** | 一笔交易的完整生命周期图 | **需要** |
| **仲裁裁决工具** | 退款/放行/冻结一键操作 | **需要** |
| 证据快照 | 纠纷时自动保存当时的状态快照 | 后期可做 |

**结论**：本项目有 market_listings + trade_orders 的C2C交易体系，交易纠纷处理能力不可缺少。

### 3.4 小公司/SaaS模型（Zendesk/Intercom/美洽/智齿）

**核心理念：轻量 + 开箱即用**

```
用户发消息 → 三栏聊天 → 关闭
```

**核心能力清单**：

| 能力 | 说明 | 本项目适用性 |
|------|------|------------|
| 多渠道统一 | 网页/APP/微信/邮件统一入口 | 后期需要（小程序） |
| Webhook集成 | 对接外部系统推送数据 | 不需要 |
| 自定义字段 | 用户信息面板显示业务数据 | 已通过C区实现 |
| SLA管理 | 自动计算响应时间，超时告警 | **需要** |

**结论**：通用SaaS无法展示本项目的业务上下文（抽奖/资产/多级锁），不适合直接使用。但SLA管理思路值得借鉴。

### 3.5 活动策划公司模型

**核心理念：活动维度 + 批量处理**

```
活动上线 → 同类问题涌入 → 批量识别 → 批量处理 → 群发公告
```

**核心能力清单**：

| 能力 | 说明 | 本项目适用性 |
|------|------|------------|
| **活动维度关联** | 会话自动关联到具体活动 | 需要（有lottery_campaigns） |
| **批量处理** | 同一问题影响多人时批量解决 | 中期需要 |
| 公告推送 | 处理后群发结果通知 | 后期可做 |

**结论**：活动维度关联在抽奖问题排查中有价值，批量处理在系统故障场景需要。

### 3.6 方案最终对比

| 维度 | 大厂方案 | 游戏GM方案 | 交易仲裁方案 | 小公司SaaS | 活动策划方案 |
|------|---------|-----------|------------|-----------|------------|
| 规模前提 | 千人客服 | 10-50人 | 5-20人 | 1-5人 | 按活动临时组 |
| 核心能力 | AI分流+路由 | 诊断+补偿 | 证据+裁决 | 聊天+工单 | 批量+模板 |
| 开发成本 | 3-6月 | 2-3月 | 2-3月 | 1-2周 | 1-2月 |
| 本项目需要 | 工单+知识库+SLA | **高度需要** | 市场纠纷时需要 | 规模匹配但能力不够 | 活动关联需要 |

### 3.7 本项目最终选型

**游戏GM工作台为主体(60%) + 轻量工单系统(25%) + 交易仲裁能力(15%)**

| 权重 | 来源模型 | 具体采纳的能力 |
|------|---------|--------------|
| 60% | 游戏GM工作台 | 一键诊断、补偿工具、用户全景视图(C区8Tab)、操作审计、SOP |
| 25% | 轻量工单系统 | 从会话创建工单、工单生命周期、内部备注、历史可追溯、满意度闭环 |
| 15% | 交易仲裁 | 交易纠纷双方视角、交易链路可视化、退款/放行一键操作 |

---

## 四、重设计方案 — GM工作台架构

### 4.1 整体布局：四区域自适应

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        顶部工作状态栏 (48px)                             │
│  [在线/忙碌/离开 ▼]  等待队列:18  处理中:2  今日已解决:4  ⚡首响:32s     │
├────────────┬───────────────────────────┬────────────────────────────────┤
│            │                           │                                │
│  A区：      │   B区：                    │   C区：                        │
│  会话队列    │   对话 + 操作主区域         │   上下文智能面板                 │
│  (280px)   │   (自适应)                 │   (360px)                     │
│            │                           │                                │
│            │                           │                                │
│            │                           │                                │
└────────────┴───────────────────────────┴────────────────────────────────┘
```

---

### 4.2 A区：智能会话队列（左侧 280px）

**与当前的区别**：当前只是按状态筛选的平铺列表。重设计后增加优先级排序、等待时长可视化、问题标签预判。

```
┌──────────────────────┐
│ 🔍 搜索用户/手机号     │
├──────────────────────┤
│ [我的] [排队] [全部]   │
│ [等待18] [处理2] [关4] │
├──────────────────────┤
│                      │
│ ── 紧急 ──────────    │
│ 🔴 用户A   等待47分   │
│ │ "钻石没到账"         │
│ │ 💎资产 🔄交易        │
│                      │
│ ── 排队中 ─────────   │
│ 🟡 用户B   等待12分   │
│ │ "抽奖扣了积分没出奖"  │
│ │ 🎰抽奖              │
│                      │
│ 🟡 用户C   等待8分    │
│ │ "物品被锁了"         │
│ │ 🎒背包 🔒锁定       │
│                      │
│ ── 处理中 ─────────   │
│ 🟢 用户D   处理中     │
│ │ 客服：小李           │
│                      │
│ ── 已关闭(今日) ────   │
│ ⚪ 用户E   已解决     │
│                      │
├──────────────────────┤
│ 共 24 个会话          │
└──────────────────────┘
```

#### 关键设计点

**1. 智能问题标签**

从用户最后一条消息自动识别问题类型（资产/交易/抽奖/背包/账号），用图标标记。基于关键词匹配实现，不需要AI：

- 包含"钻石/余额/积分/到账/扣款" → 💎资产
- 包含"交易/买/卖/挂单/订单" → 🔄交易
- 包含"抽奖/抽/中奖/概率/保底" → 🎰抽奖
- 包含"物品/背包/锁/锁定/道具" → 🎒背包
- 包含"兑换/核销/发货/物流" → 📦兑换
- 包含"登录/密码/账号/封号" → 👤账号

**2. 等待时长可视化**

基于 `customer_service_sessions.created_at` 实时计算：

- < 5分钟：绿色 🟢
- 5-15分钟：黄色 🟡
- 15-30分钟：橙色 🟠
- > 30分钟：红色闪烁 🔴

**3. 分组排序**

不再是简单的 status 筛选，而是按优先级分组：

1. 紧急（等待>15分钟）→ 按等待时间倒序
2. 排队中 → 按等待时间倒序
3. 处理中 → 按最近消息时间倒序
4. 今日已关闭 → 按关闭时间倒序

**4. "我的"会话 Tab**

基于 `customer_service_user_assignments` 过滤当前客服负责的用户，而非看到所有人的。解决多客服场景下的会话归属问题。

**5. 消息预览**

显示最后一条消息的前20字，来源是 `chat_messages` 按 session 的最新一条。比当前的"暂无消息"有用得多。

#### 数据来源

- 会话列表：`customer_service_sessions` JOIN `users`（现有API `GET /sessions` 已支持）
- 消息预览：`chat_messages` 按 session 最新一条（需新增字段或子查询）
- 问题标签：基于最后消息内容的关键词匹配（纯前端逻辑）

---

### 4.3 B区：对话 + 操作主区域（中间自适应）

**与当前的区别**：当前只有聊天消息流 + 输入框。重设计后增加 GM操作工具栏、一键诊断、补偿工具、工单创建。

```
┌────────────────────────────────────────┐
│ 💬 用户A (user_id:35)  等待47分        │
│ 手机: 136****2419  等级:normal         │
│ [📋接单] [🔍诊断] [🎁补偿] [📋工单]   │
│ [🔄转接] [❌关闭] [📌标记]             │
├────────────────────────────────────────┤
│                                        │
│ ──── 2026-02-22 09:15 ────             │
│                                        │
│  👤 用户A:                              │
│  ┌─────────────────────────┐           │
│  │ 我交易买了个东西，钻石扣了 │           │
│  │ 但是物品没收到             │           │
│  └─────────────────────────┘           │
│                                        │
│  🔍 系统识别: 交易纠纷                   │
│  ┌─────────────────────────┐           │
│  │ 📋 关联交易订单:                     │
│  │ #TO-20260222-001                    │
│  │ 状态: created (冻结中)               │
│  │ 金额: 500 DIAMOND                   │
│  │ [查看详情] [解冻退款]                 │
│  └─────────────────────────┘           │
│                                        │
│       客服回复: 👨‍💼                     │
│       ┌─────────────────────────┐      │
│       │ 已查到您的订单，正在处理   │      │
│       └─────────────────────────┘      │
│                                        │
├────────────────────────────────────────┤
│ ⚡快捷: [查资产] [查背包] [查抽奖]      │
│         [查交易] [查消费] [查反馈]      │
├────────────────────────────────────────┤
│ 📝 输入回复...                  [发送]  │
│ [📷图片] [📋模板] [📎附件]              │
└────────────────────────────────────────┘
```

#### 关键设计点

**1. 一键诊断（来自游戏GM模型，效率提升最大的功能）**

点击 [🔍诊断] 按钮，系统在2-3秒内并行检查该用户的所有模块，结果以系统卡片形式插入聊天流：

```
┌─ 🔍 一键诊断结果 ──────────────────┐
│ ✅ 资产状态: 正常，无异常冻结          │
│ ⚠️ 交易状态: 订单#TO-001 frozen      │
│    已超时 (应15分钟内完成，已过47分钟)  │
│ ✅ 背包状态: 正常，无异常锁定          │
│ ✅ 抽奖状态: 最近抽奖正常              │
│ ✅ 账号状态: 正常                     │
│                                     │
│ 🔴 发现1个问题:                      │
│ 交易订单 #TO-001 冻结超时             │
│ [一键解冻并退还500 DIAMOND]           │
└─────────────────────────────────────┘
```

技术实现：后端新增 `GET /api/v4/console/customer-service/user-context/:userId/diagnose` 接口，并行检查：
- `account_asset_balances` 是否有异常冻结（frozen_amount > 0 且关联订单已超时）
- `trade_orders` 是否有 created/frozen 状态且超过15分钟的订单
- `item_instances` 是否有 locked 状态且锁已超时的物品
- `lottery_draws` 最近一次抽奖是否有 has_debt=1 的记录
- `users` 账号状态是否正常

每项检查返回 `ok` / `warning` / `error`，前端按严重程度渲染。

**2. 补偿工具（来自游戏GM模型，解决问题的终极手段）**

点击 [🎁补偿] 按钮，弹出补偿表单：

```
┌─ 快捷补偿 ─────────────────────────┐
│ 补偿原因: [交易异常 ▼]               │
│                                     │
│ 补偿内容:                            │
│ [+ 添加项目]                         │
│ 💎 DIAMOND         [  500  ]        │
│ 🎒 50元优惠券 x     [  1   ]        │
│                                     │
│ 备注: 订单#TO-001冻结超时补偿         │
│                                     │
│ [发放补偿]  [取消]                    │
└─────────────────────────────────────┘
```

操作后自动：
- 调用 BalanceService 增加资产余额
- 调用 ItemService 创建物品实例（如果补偿物品）
- 记录到 `admin_operation_logs`（操作审计）
- 在聊天中插入系统消息："已发放补偿：500钻石 + 50元优惠券"
- 关联到当前会话/工单

技术实现：后端新增 `POST /api/v4/console/customer-service/compensate` 接口，在 `TransactionManager.execute()` 事务中完成所有操作。

**3. 工单创建（来自大厂模型，解决问题生命周期管理）**

点击 [📋工单] 按钮，从当前会话创建工单：

```
┌─ 创建工单 ──────────────────────────┐
│ 关联会话: #1920                      │
│ 关联用户: 用户A (ID:35)              │
│                                     │
│ 问题类型: [交易纠纷 ▼]               │
│ 优先级:   [高 ▼]                     │
│ 问题描述: 订单#TO-001冻结超时...      │
│           (自动从聊天内容提取)         │
│                                     │
│ 处理方案: [待处理 ▼]                 │
│ 指派给:   [当前客服 ▼]               │
│                                     │
│ [创建工单]  [取消]                    │
└─────────────────────────────────────┘
```

工单独立于会话存在，生命周期为：open → processing → resolved → closed。一个工单可关联多个会话（用户多次来问同一个问题）。

技术实现：需要新建 `customer_service_issues` 表（详见第六节新增表设计）。

**4. 智能上下文卡片**

当消息中提到关键业务实体时，自动在聊天流中插入关联数据卡片：

- 前端正则匹配消息内容中的关键词（"交易"/"订单"/"抽奖"/"钻石"/"物品"/"锁"等）
- 触发对应的后端查询（查该用户最近的交易/抽奖/资产变动）
- 渲染为可操作的数据卡片嵌入聊天流

**5. 快捷操作栏**

聊天输入框上方固定一排快捷按钮。点击后在C区打开对应查询面板：

| 按钮 | 后端API | 数据源 |
|------|---------|--------|
| 查资产 | `GET /api/v4/console/customer-service/user-context/:userId/assets` | account_asset_balances(通过accounts关联) |
| 查背包 | `GET /api/v4/console/customer-service/user-context/:userId/backpack` | item_instances(owner_user_id) + item_templates |
| 查抽奖 | `GET /api/v4/console/customer-service/user-context/:userId/lottery` | lottery_draws(user_id) + lottery_campaigns |
| 查交易 | `GET /api/v4/console/customer-service/user-context/:userId/trades` | trade_orders(buyer/seller_user_id) + market_listings |
| 查消费 | `GET /api/v4/console/customer-service/user-context/:userId/timeline` | consumption_records + exchange_records |
| 查反馈 | `GET /api/v4/console/customer-service/user-context/:userId/risk` | feedbacks(user_id) + risk_alerts |

**6. 接单流程**

waiting 状态的会话，客服需要明确"接单"操作，更新 `admin_id` 和状态为 assigned/active。比自动分配更适合少量客服场景。

**7. 消息模板库（知识库雏形）**

扩展当前的4条 quickReplies 为完整的分类模板库：

| 分类 | 模板示例 |
|------|---------|
| 通用 | 问候语 / 请稍等 / 感谢反馈 / 祝您愉快 |
| 资产 | 余额查询结果模板 / 冻结说明 / 退款进度 |
| 交易 | 订单状态说明 / 纠纷处理流程 / 取消订单指引 |
| 抽奖 | 概率机制说明 / 记录查询结果 / 保底规则说明 |
| 物品 | 锁定原因说明 / 解锁操作指引 / 物品使用说明 |
| SOP | 交易超时标准处理流程 / 抽奖异常标准处理流程 / 资产冻结标准处理流程 |

存储方案：`system_configs` 中以 JSON 格式存储，key 为 `cs_reply_templates`。后期可升级为独立的知识库系统。

---

### 4.4 C区：上下文智能面板（右侧 360px）

**整个重设计的最核心改进。** 当前右侧只有静态的用户基本信息。重设计后变成动态的8Tab业务面板。

```
┌─────────────────────────────┐
│ 用户画像                     │
│ ┌─────────────────────────┐ │
│ │ 👤 用户A (ID:35)        │ │
│ │ 📱 136****2419          │ │
│ │ 🏷️ normal | 注册180天   │ │
│ │ 📊 抽奖42次 交易5次      │ │
│ │       反馈2次 消费8次    │ │
│ └─────────────────────────┘ │
├─────────────────────────────┤
│ [💎资产] [🎒背包] [🎰抽奖]  │
│ [🔄交易] [📋记录] [⚠️风控]  │
│ [📜历史] [📝备注]           │
├─────────────────────────────┤
│                             │
│ (当前Tab内容区域)            │
│                             │
└─────────────────────────────┘
```

#### Tab 1 — 资产 (💎)

**数据源**：`account_asset_balances` JOIN `material_asset_types`，按用户 account_id 过滤

**展示内容**：

```
┌─ 资产余额 ─────────────────┐
│ 💎 DIAMOND      12,500      │
│    (冻结: 500)              │
│ 🔵 POINTS       8,200      │
│ 🔵 BUDGET_POINTS  200      │
│ 🔴 red_shard    3,500      │
│ 🔴 red_crystal     12      │
│ 🟢 green_shard    800      │
└─────────────────────────────┘

┌─ 最近资产变动(5条) ─────────┐
│ 02-22 09:12 交易冻结         │
│   DIAMOND -500 (冻结)        │
│ 02-22 08:45 抽奖消耗         │
│   BUDGET_POINTS -100         │
│ 02-21 22:10 市场卖出         │
│   DIAMOND +1,200             │
│ [查看完整流水 →]              │
└─────────────────────────────┘

┌─ 快捷操作 ─────────────────┐
│ [调整余额] [解冻资产]        │
│ [查看全部账户]               │
└─────────────────────────────┘
```

- 附加数据：`asset_transactions` 最近5条变动记录
- 操作入口：调整余额（跳转 asset-adjustment.html）、解冻（调用 BalanceService.unfreeze）

#### Tab 2 — 背包 (🎒)

**数据源**：`item_instances` JOIN `item_templates`，按 owner_user_id 过滤

**展示内容**：

```
┌─ 物品统计 ─────────────────┐
│ 可用: 42  锁定: 3  已用: 15 │
└─────────────────────────────┘

┌─ 物品列表 ─────────────────┐
│ 🟣 8折优惠券     rare       │
│   状态: available           │
│                             │
│ 🔵 50元优惠券    common     │
│   状态: locked 🔒           │
│   锁类型: trade (交易锁)    │
│   锁定时间: 02-22 09:00     │
│   [解锁]                    │
│                             │
│ 🟡 无线蓝牙耳机  rare       │
│   状态: available           │
│                             │
│ [查看全部 42 件 →]           │
└─────────────────────────────┘
```

- 关键字段：`status`（available/locked/transferred/used/expired）、`locks` JSON（trade/redemption/security 三级锁）
- 操作入口：解锁物品（调用 ItemService.unlockItem）、查看物品事件日志（item_instance_events）

#### Tab 3 — 抽奖 (🎰)

**数据源**：`lottery_draws` JOIN `lottery_campaigns` JOIN `lottery_prizes`，按 user_id 过滤

**展示内容**：

```
┌─ 抽奖概览 ─────────────────┐
│ 总抽奖: 42次                │
│ 高档位: 3次 (7.1%)         │
│ 中档位: 12次 (28.6%)       │
│ 低档位: 27次 (64.3%)       │
│ 保底触发: 2次               │
│ 总消耗: 4,200 BUDGET_POINTS │
└─────────────────────────────┘

┌─ 最近记录(5条) ────────────┐
│ 02-22 08:45 餐厅积分抽奖    │
│   🟢 low | 蓝水晶碎片 x5   │
│   消耗: 100 BUDGET_POINTS   │
│                             │
│ 02-21 20:30 餐厅积分抽奖    │
│   🟡 mid | 50元优惠券       │
│   消耗: 100 BUDGET_POINTS   │
│   ⚡ 保底触发               │
│                             │
│ [查看全部 42 条 →]           │
└─────────────────────────────┘
```

- 关键字段：`reward_tier`、`guarantee_triggered`、`points_deducted`、`has_debt`

#### Tab 4 — 交易 (🔄)

**数据源**：`trade_orders` + `market_listings`，按 buyer_user_id 或 seller_user_id 过滤

**展示内容**：

```
┌─ 交易统计 ─────────────────┐
│ 买入: 8单  卖出: 12单       │
│ 完成: 15  取消: 5           │
│ 当前冻结: 500 DIAMOND       │
└─────────────────────────────┘

┌─ 进行中的交易 ─────────────┐
│ 🟡 #TO-001 买入 (冻结中)    │
│   物品: 无线蓝牙耳机         │
│   金额: 500 DIAMOND         │
│   创建: 02-22 09:10         │
│   [查看详情] [取消订单]      │
└─────────────────────────────┘

┌─ 当前挂单 ─────────────────┐
│ 📦 red_shard x1000          │
│   价格: 200 DIAMOND         │
│   状态: on_sale             │
│                             │
│ [查看全部挂单 →]             │
└─────────────────────────────┘
```

- 操作入口：查看订单详情、取消冻结订单（调用 TradeOrderService.cancelOrder）

**交易纠纷双方视角**（来自交易平台模型）：当交易存在纠纷时，展示买卖双方对比视图：

```
┌─ 交易纠纷 #TO-001 ────────────────┐
│ ┌──── 买方 ────┐ ┌──── 卖方 ────┐ │
│ │ 用户A (ID:35)│ │ 用户B (ID:12)│ │
│ │ 已付 500💎   │ │ 挂单物品:    │ │
│ │ 状态: 冻结中  │ │ 无线蓝牙耳机  │ │
│ │              │ │ 状态: locked │ │
│ └──────────────┘ └──────────────┘ │
│                                    │
│ 时间线:                             │
│ 09:10 买方下单 → 09:10 冻结500💎    │
│ 09:10 锁定卖方物品                   │
│ 09:25 ⚠️ 超过15分钟未完成            │
│                                    │
│ [退款给买方] [放行给买方] [联系卖方]  │
└────────────────────────────────────┘
```

#### Tab 5 — 记录 (📋)

**数据源**：`consumption_records` + `feedbacks` + `exchange_records`，混合按时间倒序

**展示内容**：

```
┌─ 业务时间线 ───────────────┐
│ 02-22 09:10 🔄 交易买入     │
│   买入无线蓝牙耳机 500💎     │
│                             │
│ 02-22 08:45 🎰 抽奖         │
│   低档位 蓝水晶碎片 x5      │
│                             │
│ 02-21 22:10 📦 市场卖出     │
│   red_shard x500 +1200💎    │
│                             │
│ 02-21 18:00 💳 门店消费     │
│   消费 ¥88 获得 880 积分    │
│   门店: 旗舰店              │
│                             │
│ 02-20 15:30 📝 提交反馈     │
│   类别: 技术问题             │
│   状态: pending             │
│   "物品消失了..."            │
│                             │
│ [加载更多 →]                 │
└─────────────────────────────┘
```

- 作用：让客服快速了解"这个用户最近在做什么"，10秒内掌握全部上下文

#### Tab 6 — 风控 (⚠️)

**数据源**：`user_risk_profiles` + `risk_alerts` + `user_behavior_tracks`，按 user_id 过滤

**展示内容**：

```
┌─ 风险评估 ─────────────────┐
│ 风险等级: 低                 │
│ 异常评分: 12/100            │
│ 标记: 无                    │
└─────────────────────────────┘

┌─ 历史告警 ─────────────────┐
│ (无告警记录)                 │
└─────────────────────────────┘

┌─ 行为摘要 ─────────────────┐
│ 注册天数: 180天              │
│ 最近登录: 2小时前            │
│ 登录次数: 156次              │
│ 连续登录失败: 0次            │
└─────────────────────────────┘
```

- 作用：辅助客服判断是否为恶意用户（刷积分、恶意退款等）

#### Tab 7 — 历史会话 (📜)（新增）

**解决的问题**：用户第二次来时，新客服完全不知道之前发生了什么。

**数据源**：`customer_service_sessions` + `chat_messages` + `customer_service_issues`，按 user_id 查历史

**展示内容**：

```
┌─ 历史会话 ─────────────────┐
│ 📋 2026-02-20 (已解决)      │
│   问题: 抽奖没出奖          │
│   处理: 确认为正常概率       │
│   客服: 管理员              │
│   满意度: ⭐⭐⭐⭐           │
│   [展开聊天记录]             │
│                             │
│ 📋 2026-02-15 (已解决)      │
│   问题: 物品被锁            │
│   处理: 解除交易锁           │
│   客服: 管理员              │
│   补偿: 100 DIAMOND         │
│   关联工单: #ISS-003        │
│   [展开聊天记录]             │
│                             │
│ 📋 2026-01-28 (已解决)      │
│   问题: 钻石没到账          │
│   处理: 交易订单超时退款     │
│   客服: 管理员              │
│   补偿: 50 DIAMOND          │
│   [展开聊天记录]             │
│                             │
│ 共 3 次历史会话              │
│ [查看更多 →]                 │
└─────────────────────────────┘
```

- 每条历史会话展示：问题摘要、处理结果、客服、补偿记录、满意度评分、关联工单
- 点击"展开聊天记录"可查看历史消息
- 作用：10秒了解"这个用户以前来过几次，问了什么，怎么解决的"

#### Tab 8 — 内部备注 (📝)（新增）

**解决的问题**：客服之间无法传递关于用户的内部信息（如"该用户经常恶意投诉"或"上次答应24小时内解决"）。

**数据源**：新增 `customer_service_notes` 表（详见第六节），按 user_id 查询

**展示内容**：

```
┌─ 内部备注 ─────────────────┐
│ （仅客服可见，用户不可见）     │
│                             │
│ 📝 管理员 02-22 09:30       │
│ 订单#TO-001超时问题，已承诺  │
│ 24小时内处理完毕             │
│                             │
│ 📝 管理员 02-20 15:00       │
│ 该用户反馈过物品消失问题，    │
│ 经查为正常交易转移，非bug    │
│                             │
│ ──────────────────────────  │
│ 📝 添加备注...        [保存] │
└─────────────────────────────┘
```

- 备注仅客服可见，用户永远看不到
- 支持 @提及其他客服
- 作用：客服交接班/转接时不丢失上下文

---

### 4.5 顶部工作状态栏

**与当前的区别**：当前只有4个静态数字。重设计后变成实时工作仪表板，增加SLA告警。

```
┌────────────────────────────────────────────────────────────────────────────────┐
│ 🟢在线 ▼ │ 📬等待:18 ⏱️最久:47分 │ 💬处理:2/10 │ ⚡首响:32s │ ⚠️SLA:2超时 │ 🔔3 │
│          │ 📊今日:24 ✅已解决:4  │ 📋工单:3待处理│ ⭐满意:4.2 │             │     │
└────────────────────────────────────────────────────────────────────────────────┘
```

| 区块 | 数据来源 | 实时性 |
|------|---------|--------|
| 状态切换(在线/忙碌/离开) | AdminCustomerServiceService.updateAdminOnlineStatus() | Redis |
| 等待数 + 最久等待时长 | customer_service_sessions WHERE status='waiting' | WebSocket推送 |
| 处理中/最大并发 | customer_service_agents.current_session_count / max_concurrent_sessions | 实时 |
| 首响/均响 | CustomerServiceResponseStatsService.getResponseStats() | 5分钟缓存 |
| SLA超时数 | 等待>15分钟的会话数（新增统计） | WebSocket推送 |
| 待处理工单 | customer_service_issues WHERE status IN ('open','processing') | 30秒轮询 |
| 用户满意度 | 今日 satisfaction_score 均值 | 5分钟缓存 |
| 通知角标 | WebSocket事件: new_session / new_message | 实时 |

**SLA告警机制**：
- 等待超过5分钟 → 顶部黄色提示
- 等待超过15分钟 → 顶部红色闪烁 + 浏览器通知
- 工单处理超过24小时 → 自动升级标记
- 所有SLA数据纳入日报统计

---

## 五、需要新增的后端API

现有API已覆盖的不重复列出。以下全部是新增：

### 5.1 用户上下文查询（只读）

> **路径前缀**：`/api/v4/console/customer-service`（对齐后端现有路由挂载点 `routes/v4/console/customer-service/`）

| 接口 | 方法 | 用途 | 数据源 |
|------|------|------|--------|
| `/api/v4/console/customer-service/user-context/:userId/summary` | GET | 用户画像聚合 | users + 各表COUNT |
| `/api/v4/console/customer-service/user-context/:userId/assets` | GET | 资产余额+最近变动 | account_asset_balances(通过accounts.user_id关联) + asset_transactions |
| `/api/v4/console/customer-service/user-context/:userId/backpack` | GET | 背包物品列表 | item_instances(owner_user_id) + item_templates(item_template_id) |
| `/api/v4/console/customer-service/user-context/:userId/lottery` | GET | 抽奖记录+统计 | lottery_draws(user_id) + lottery_campaigns(lottery_campaign_id) |
| `/api/v4/console/customer-service/user-context/:userId/trades` | GET | 交易订单+挂单 | trade_orders(buyer_user_id/seller_user_id) + market_listings(seller_user_id) |
| `/api/v4/console/customer-service/user-context/:userId/timeline` | GET | 混合业务时间线 | consumption_records + feedbacks + exchange_records |
| `/api/v4/console/customer-service/user-context/:userId/risk` | GET | 风控信息 | user_risk_profiles(user_id) + risk_alerts |
| `/api/v4/console/customer-service/user-context/:userId/history` | GET | 历史会话列表 | customer_service_sessions(user_id) + chat_messages |
| `/api/v4/console/customer-service/user-context/:userId/diagnose` | GET | 一键诊断 | 并行检查各模块异常状态 |

### 5.2 会话操作

| 接口 | 方法 | 用途 | 数据源 |
|------|------|------|--------|
| `/api/v4/console/customer-service/sessions/:id/accept` | POST | 客服接单 | 更新 session status→assigned + admin_id，字段对齐 customer_service_sessions.admin_id |
| `/api/v4/console/customer-service/sessions/:id/tag` | POST | 会话打标签 | sessions 新字段 tags(JSON) |
| `/api/v4/console/customer-service/sessions/:id/satisfaction` | POST | 请求满意度评价 | WebSocket推送评价邀请→更新 satisfaction_score(已有字段) |

### 5.3 工单系统

| 接口 | 方法 | 用途 | 数据源 |
|------|------|------|--------|
| `/api/v4/console/customer-service/issues` | GET | 工单列表（筛选/分页） | customer_service_issues |
| `/api/v4/console/customer-service/issues` | POST | 创建工单（从会话创建） | customer_service_issues |
| `/api/v4/console/customer-service/issues/:id` | GET | 工单详情 | customer_service_issues + 关联会话 |
| `/api/v4/console/customer-service/issues/:id` | PUT | 更新工单状态/指派 | customer_service_issues |
| `/api/v4/console/customer-service/issues/:id/notes` | GET | 工单内部备注列表 | customer_service_notes |
| `/api/v4/console/customer-service/issues/:id/notes` | POST | 添加内部备注 | customer_service_notes |

### 5.4 GM操作工具

| 接口 | 方法 | 用途 | 数据源 |
|------|------|------|--------|
| `/api/v4/console/customer-service/compensate` | POST | 发放补偿（资产+物品） | 事务：BalanceService.changeBalance + ItemService.mintItem + admin_operation_logs |
| `/api/v4/console/customer-service/templates` | GET | 消息模板库 | system_configs(config_key='cs_reply_templates') |
| `/api/v4/console/customer-service/templates` | PUT | 更新消息模板 | system_configs |

### 5.5 用户端接口

| 接口 | 方法 | 用途 | 数据源 |
|------|------|------|--------|
| `/api/v4/system/chat/sessions/:id/rate` | POST | 用户提交满意度评分 | customer_service_sessions.satisfaction_score |
| `/api/v4/system/chat/issues` | GET | 用户查看自己的工单进度 | customer_service_issues |

### 5.6 设计原则

- user-context 接口全部为**只读查询**，不涉及数据变更
- diagnose 接口并行执行各模块检查，总耗时控制在 2-3 秒内
- compensate 接口在数据库事务中完成所有操作，保证原子性
- 复杂业务操作（调整余额、解冻、解锁）继续使用现有独立管理API
- 每个 user-context 接口支持分页，默认返回最近5-10条

---

## 六、需要新增的数据库表

现有96张表不做任何改动。仅新增2张表支持工单和内部备注：

### 6.1 customer_service_issues（工单表）

```sql
CREATE TABLE customer_service_issues (
  issue_id          BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id           INT NOT NULL,                          -- 关联用户
  created_by        INT NOT NULL,                          -- 创建人(客服)
  assigned_to       INT,                                   -- 指派给(客服)
  session_id        BIGINT,                                -- 关联的首次会话
  issue_type        ENUM('asset','trade','lottery','item','account','other') NOT NULL,
  priority          ENUM('low','medium','high','urgent') DEFAULT 'medium',
  status            ENUM('open','processing','resolved','closed') DEFAULT 'open',
  title             VARCHAR(200) NOT NULL,                 -- 问题标题
  description       TEXT,                                  -- 问题描述
  resolution        TEXT,                                  -- 处理结果
  compensation_log  JSON,                                  -- 补偿记录(自动填充)
  resolved_at       DATETIME,
  closed_at         DATETIME,
  created_at        DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at        DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_user_id (user_id),
  INDEX idx_assigned_to (assigned_to),
  INDEX idx_status (status),
  INDEX idx_created_at (created_at),
  FOREIGN KEY (user_id) REFERENCES users(user_id),
  FOREIGN KEY (session_id) REFERENCES customer_service_sessions(customer_service_session_id)
);
```

### 6.2 customer_service_notes（内部备注表）

```sql
CREATE TABLE customer_service_notes (
  note_id           BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id           INT NOT NULL,                          -- 关于哪个用户
  issue_id          BIGINT,                                -- 关联工单(可选)
  session_id        BIGINT,                                -- 关联会话(可选)
  author_id         INT NOT NULL,                          -- 备注作者(客服)
  content           TEXT NOT NULL,                         -- 备注内容
  created_at        DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_user_id (user_id),
  INDEX idx_issue_id (issue_id),
  FOREIGN KEY (user_id) REFERENCES users(user_id),
  FOREIGN KEY (author_id) REFERENCES users(user_id)
);
```

### 6.3 customer_service_sessions 表需新增的字段

```sql
ALTER TABLE customer_service_sessions
  ADD COLUMN issue_id BIGINT AFTER customer_service_session_id,
  ADD COLUMN tags JSON AFTER close_reason,
  ADD COLUMN resolution_summary VARCHAR(500) AFTER close_reason;
```

- `issue_id`：关联工单（一个工单可关联多个会话）
- `tags`：会话标签（如 `["交易纠纷","已补偿"]`）
- `resolution_summary`：处理摘要（关闭时填写，在历史Tab展示）

---

## 七、技术实现路线

完全基于现有技术栈，不引入新框架：

| 层级 | 技术选型 | 说明 |
|------|---------|------|
| 前端框架 | Alpine.js（不变） | composable 模式，拆分为更细的模块 |
| 样式 | Tailwind CSS（不变） | 新增自定义组件样式 |
| 构建 | Vite 多页应用（不变） | customer-service.html 独立入口 |
| 实时通信 | Socket.IO（不变） | 消息推送 + 状态同步 |
| 后端 | Express + Sequelize（不变） | 新增 user-context 路由模块 |
| 数据库 | MySQL（不变） | 新增2张表（工单+备注），现有96张表零改动 |

### 7.1 前端代码拆分（降低维护成本的关键）

当前所有客服逻辑集中在一个 composable 文件。重设计后按区域拆分：

```
admin/src/modules/customer-service/
├── pages/
│   └── customer-service.js              # 主页面（只负责布局和组合）
├── composables/
│   ├── use-session-queue.js             # A区：会话队列状态和逻辑
│   ├── use-chat-conversation.js         # B区：聊天对话状态和逻辑
│   ├── use-user-context.js              # C区：用户上下文面板
│   ├── use-work-status.js               # 顶部：工作状态栏
│   ├── use-ws-connection.js             # WebSocket连接管理（独立）
│   ├── use-templates.js                 # 消息模板库
│   ├── use-diagnosis.js                 # 一键诊断逻辑
│   ├── use-compensation.js              # 补偿工具逻辑
│   └── use-issues.js                    # 工单管理逻辑
├── components/
│   ├── session-card.js                  # 会话卡片（含标签渲染）
│   ├── context-panel-assets.js          # C区-资产Tab
│   ├── context-panel-backpack.js        # C区-背包Tab
│   ├── context-panel-lottery.js         # C区-抽奖Tab
│   ├── context-panel-trades.js          # C区-交易Tab（含双方视角）
│   ├── context-panel-timeline.js        # C区-记录Tab
│   ├── context-panel-risk.js            # C区-风控Tab
│   ├── context-panel-history.js         # C区-历史会话Tab（新增）
│   ├── context-panel-notes.js           # C区-内部备注Tab（新增）
│   ├── diagnosis-card.js               # 诊断结果卡片
│   ├── compensation-modal.js            # 补偿弹窗
│   └── issue-modal.js                   # 创建工单弹窗
└── utils/
    ├── keyword-tagger.js                # 消息关键词识别 → 问题标签
    └── time-helpers.js                  # 等待时长计算和格式化
```

每个文件控制在 200 行以内，职责单一，独立可测试。

### 7.2 后端代码组织（对齐实际项目结构）

```
routes/v4/console/customer-service/
├── index.js                             # 现有：路由聚合器（挂载所有子路由）
├── sessions.js                          # 现有：GET /sessions, GET /sessions/stats, GET /sessions/response-stats
├── messages.js                          # 现有：GET /:id/messages, POST /:id/send, POST /:id/mark-read
├── operations.js                        # 现有：POST /:id/transfer, POST /:id/close, POST /status
├── agents.js                            # 现有：坐席CRUD
├── assignments.js                       # 现有：用户-坐席分配
├── user-context.js                      # 新增：用户上下文聚合查询（9个GET接口）
├── issues.js                            # 新增：工单CRUD + 备注
└── gm-tools.js                          # 新增：诊断/补偿/模板

routes/v4/system/
└── chat.js                              # 现有：用户端聊天（新增满意度/工单路由）

services/
├── CustomerServiceSessionService.js     # 现有：1,385行 核心会话服务（静态类）
├── AdminCustomerServiceService.js       # 现有：654行 管理端Facade（静态类，依赖注入）
├── CustomerServiceAgentManagementService.js  # 现有：650行 坐席管理
├── ChatWebSocketService.js              # 现有：1,563行 WebSocket服务
├── ChatRateLimitService.js              # 现有：聊天限流
├── asset/BalanceService.js              # 现有：资产余额服务（可复用）
├── asset/ItemService.js                 # 现有：物品实例服务（可复用）
├── TradeOrderService.js                 # 现有：交易订单服务（可复用）
├── CustomerServiceUserContextService.js # 新增：用户上下文聚合（只读，调用上述Service）
├── CustomerServiceIssueService.js       # 新增：工单管理
├── CustomerServiceDiagnoseService.js    # 新增：一键诊断（只读，并行检查）
└── CustomerServiceCompensateService.js  # 新增：补偿发放（TransactionManager事务）

models/
├── CustomerServiceSession.js            # 现有（需加 issue_id/tags/resolution_summary 字段）
├── ChatMessage.js                       # 现有
├── CustomerServiceAgent.js              # 现有
├── CustomerServiceUserAssignment.js     # 现有
├── CustomerServiceIssue.js              # 新增
└── CustomerServiceNote.js               # 新增
```

**Service 注册与访问方式**（对齐现有 ServiceManager 实际代码模式）：
```javascript
// services/index.js 的 initializeAll() 中注册（与 cs_agent_management 同级，使用 this._services.set）
this._services.set('cs_user_context', CustomerServiceUserContextService)
this._services.set('cs_issue', CustomerServiceIssueService)
this._services.set('cs_diagnose', CustomerServiceDiagnoseService)
this._services.set('cs_compensate', CustomerServiceCompensateService)

// Route 中访问（与现有路由一致的调用模式）
const contextService = req.app.locals.services.getService('cs_user_context')
const balanceService = req.app.locals.services.getService('asset_balance')
const userDataQuery = req.app.locals.services.getService('user_data_query') // 已有，可直接使用
```

**服务层职责说明**：

`CustomerServiceUserContextService`（聚合查询，全部只读，**薄封装层**委托现有 Service）：
- `getSummary(userId)` → **委托** `UserDataQueryService.getUserOverview(models, userId)` （已有，含用户信息+资产汇总）
- `getAssets(userId)` → **委托** `UserDataQueryService.getAssetTransactions(models, userId, params)` + `BalanceService.getAllBalances()`
- `getBackpack(userId)` → **委托** `ItemService.getUserItemInstances({ owner_user_id: userId })` （已有）
- `getLottery(userId)` → **委托** `UserDataQueryService.getLotteryDraws(models, userId, params)` （已有）
- `getTrades(userId)` → **委托** `UserDataQueryService.getTradeRecords(models, userId)` + `UserDataQueryService.getMarketListings(models, userId)` （已有）
- `getTimeline(userId)` → **委托** `UserDataQueryService.getAssetTransactions()` + `getExchangeRecords()` + `getConversionRecords()` + 查 `consumption_records` + `feedbacks` 合并排序
- `getRisk(userId)` → 直接查 `UserRiskProfile` + `RiskAlert`（新增查询，~30行）
- `getHistory(userId)` → 直接查历史 `CustomerServiceSession`（新增查询，~40行）

`CustomerServiceDiagnoseService`（一键诊断，只读）：
- `diagnose(userId)` → 并行调用以下检查，汇总结果：
  - `checkAssets()` → 是否有异常冻结（frozen_amount > 0 且关联订单已超时）
  - `checkTrades()` → 是否有 created/frozen 状态且超过15分钟的订单
  - `checkItems()` → 是否有 locked 状态且锁已超时的物品
  - `checkLottery()` → 最近一次抽奖是否有 has_debt=1
  - `checkAccount()` → 账号状态是否正常

`CustomerServiceCompensateService`（补偿发放，写操作，事务内）：
- `compensate(userId, items, reason, operatorId)` → 在事务中：
  - 调用 BalanceService 增加资产余额
  - 调用 ItemService 创建物品实例
  - 写入 admin_operation_logs
  - 在会话中插入系统消息

`CustomerServiceIssueService`（工单管理）：
- `create()` / `update()` / `list()` / `getDetail()` → CRUD
- `addNote()` / `getNotes()` → 内部备注

---

## 八、实施路线图

### 第一阶段：基础重构（第1周）

| 阶段 | 内容 | 工期 | 优先级 | 前置依赖 |
|------|------|------|--------|---------|
| **Phase 1** | 后端：user-context API + diagnose API + 新建2张表 | 3天 | P0 | 无 |
| **Phase 2** | A区重构：智能会话队列（优先级排序、等待时长、消息预览、问题标签） | 2-3天 | P0 | 无（与Phase 1并行） |

Phase 1 + 2 并行开发，第1周结束时拥有：后端数据基础 + 改进的会话列表。

### 第二阶段：核心能力（第2周）

| 阶段 | 内容 | 工期 | 优先级 | 前置依赖 |
|------|------|------|--------|---------|
| **Phase 3** | C区核心：用户画像 + 资产Tab + 背包Tab + 历史会话Tab | 3-4天 | P0 | Phase 1 |
| **Phase 4** | B区增强：快捷操作栏 + 接单流程 + 一键诊断 + 上下文卡片 | 2-3天 | P0 | Phase 3 |

第2周结束时达到**可用状态**：客服能在一个页面内查看用户资产/背包/历史，能一键诊断问题。

### 第三阶段：GM工具（第3周）

| 阶段 | 内容 | 工期 | 优先级 | 前置依赖 |
|------|------|------|--------|---------|
| **Phase 5** | GM工具：补偿发放 + 工单系统 + 内部备注 | 3-4天 | P0 | Phase 1 |
| **Phase 6** | C区扩展：抽奖Tab + 交易Tab（含双方视角）+ 时间线Tab + 风控Tab | 3天 | P1 | Phase 1 |

第3周结束时达到**完整状态**：客服具备GM操作能力（诊断+补偿+工单），所有8个Tab可用。

### 第四阶段：体验完善（第4周）

| 阶段 | 内容 | 工期 | 优先级 | 前置依赖 |
|------|------|------|--------|---------|
| **Phase 7** | 顶部状态栏（含SLA告警）+ 消息模板库 + 会话标签 | 2-3天 | P1 | Phase 2 |
| **Phase 8** | 满意度闭环（用户评分 + 统计展示）+ 操作审计集成 | 2天 | P1 | Phase 5 |

第4周结束时达到**完善状态**：SLA管理、满意度追踪、操作审计全部就位。

### 里程碑总览

```
第1周末  → 后端API就绪 + 会话队列可用
第2周末  → 🎯 可投入使用（核心查看+诊断能力）
第3周末  → GM工具+工单系统+全部Tab完成
第4周末  → 体验完善（SLA/满意度/审计）
```

总工期：**3-4周**。第2周末即可投入日常使用，后续持续增强。

---

## 九、为什么这个方案长期维护成本最低

| 维度 | 设计决策 | 收益 |
|------|---------|------|
| 不引入新框架 | 继续 Alpine.js + Tailwind | 零学习成本，构建流程不变 |
| 现有表零改动 | 96张现有表不做任何结构变更 | 零回归风险 |
| 新增表极少 | 仅新增2张表（工单+备注）+ 3个字段 | 最小侵入 |
| 前端模块化拆分 | 1个大文件 → 20+个小文件(每个<200行) | 修改任何Tab不影响其他 |
| 渐进式实施 | Phase 1-4完成就能用 | 不存在"做一半不能用" |
| 数据层复用 | C区/诊断/补偿全部调用现有Service | 不重复造轮子 |
| 只读聚合模式 | user-context接口全部只读 | 无数据一致性风险 |
| 写操作事务化 | 补偿接口在事务中完成 | 原子性保证 |
| 行业模型验证 | 采纳游戏GM+工单+仲裁三种验证过的模型 | 方向不会错 |

---

## 附录A：现有技术栈清单

| 组件 | 版本 | 用途 |
|------|------|------|
| Node.js | >= 20.18.0 | 运行时 |
| Express | ^4.18.2 | Web框架 |
| Sequelize | ^6.35.2 | ORM |
| mysql2 | ^3.6.5 | 数据库驱动 |
| Socket.IO | ^4.8.1 | WebSocket |
| Alpine.js | - | 前端响应式 |
| Tailwind CSS | - | 样式 |
| Vite | - | 前端构建 |
| ioredis | ^5.7.0 | Redis客户端 |
| JWT | ^9.0.2 | 认证 |

## 附录B：相关数据库表清单

客服工作台直接或间接涉及的表（共24张，其中2张新增）：

### 现有表（22张，零改动）

| 表名 | 记录数 | 用途 |
|------|--------|------|
| users | 66 | 用户信息 |
| customer_service_sessions | 24 | 客服会话（新增3个字段：issue_id/tags/resolution_summary） |
| chat_messages | 847 | 聊天消息 |
| customer_service_agents | 1 | 客服坐席 |
| customer_service_user_assignments | - | 用户-坐席绑定 |
| admin_operation_logs | - | 操作审计日志（已存在，补偿操作写入此表） |
| account_asset_balances | - | 用户资产余额 |
| material_asset_types | 15 | 资产类型定义 |
| asset_transactions | - | 资产变动流水 |
| item_instances | 6,758 | 物品实例 |
| item_templates | 13 | 物品模板 |
| item_instance_events | - | 物品事件日志 |
| lottery_draws | 3,030 | 抽奖记录 |
| lottery_campaigns | 4 | 抽奖活动 |
| lottery_prizes | 15 | 奖品配置 |
| market_listings | 295 | 市场挂单 |
| trade_orders | 134 | 交易订单 |
| consumption_records | - | 消费核销记录 |
| feedbacks | 165 | 用户反馈 |
| risk_alerts | 9 | 风控告警 |
| user_risk_profiles | - | 用户风险画像 |
| roles | - | 角色定义 |

### 新增表（2张）

| 表名 | 用途 | 详见 |
|------|------|------|
| customer_service_issues | 工单（问题跟踪到底，跨会话跨班次） | 第六节 6.1 |
| customer_service_notes | 内部备注（客服间传递信息，用户不可见） | 第六节 6.2 |

---

## 十、真实数据库验证结果（2026-02-22 实际连接验证）

> 以下所有数据通过 Node.js + mysql2 直连生产数据库 `restaurant_points_dev` 获取，非备份文件。

### 10.1 文档数据 vs 真实数据对照

| 指标 | 文档描述 | 真实数据 | 结论 |
|------|---------|---------|------|
| 总表数 | 96张 | **96张** | ✅ 一致 |
| 用户数 | 66 | **66** | ✅ 一致 |
| 物品实例 | 6758 | **6776**（available:4202 locked:624 transferred:430 used:1517 expired:3）| ⚠️ 活跃增长+18（系统持续运行中） |
| 抽奖记录 | 3030 | **3030** | ✅ 一致 |
| 客服会话 | 24（18 waiting） | **24**（waiting:18 active:2 closed:4）| ✅ 一致 |
| 聊天消息 | 847 | **847** | ✅ 一致 |
| 客服坐席 | 1 active | **1**（user_id:31 "管理员用户" max_concurrent:10）| ✅ 一致 |
| 反馈 | 150 pending | **165总**(pending:150 processing:6 replied:5 closed:4）| ✅ pending数一致，总数165 |
| 市场挂单 | 21在售/19已售/255已撤回 | **21/19/255** | ✅ 一致 |
| 交易订单 | 20完成/112取消 | **20/112**（另有2个created状态）| ⚠️ 存在2个created状态订单 |
| 资产流水 | （文档未提及） | **28,799条** | 📌 数据量大，timeline接口需分页 |
| 操作日志 | （文档未提及） | **5,822条** | 📌 审计日志已有大量数据可复用 |
| 物品事件 | （文档未提及） | **5,375条** | 📌 item_instance_events 已有数据 |
| 消费记录 | （文档未提及） | **48条** | 📌 数据量少 |
| 风控告警 | （文档未提及） | **9条** | 📌 数据量少 |
| 用户风险画像 | （文档未提及） | **3条** | 📌 user_risk_profiles 已有数据 |
| 用户-坐席绑定 | （文档未提及） | **2条** | 📌 customer_service_user_assignments 已有数据 |

### 10.2 文档中的数据纠偏

**需要修正的描述**：

1. **第2.1节** 提到 "user_id:35 的 DIAMOND 82万+、POINTS 151万+"。实际查询 user_id=35 的资产为 DIAMOND:18,200、POINTS:400。原文描述的数据可能来自其他用户或早期快照，需要在前端展示时以实时查询为准，不硬编码示例数据。

2. **第2.3节** 提到 "150条反馈"。实际总数为165条（pending:150 + processing:6 + replied:5 + closed:4），pending数正确。

3. **第2.1节** 提到 trade_orders "20个已完成、112个已取消"，但遗漏了2个 **created** 状态的订单。这2个created订单恰好是一键诊断需要重点检查的对象（可能是冻结超时未完成的订单）。

### 10.3 新增表验证

| 表名 | 当前状态 | 需要动作 |
|------|---------|---------|
| `customer_service_issues` | **不存在** | 需要创建（Sequelize Migration） |
| `customer_service_notes` | **不存在** | 需要创建（Sequelize Migration） |
| `customer_service_sessions` 新增字段 | 缺少 issue_id/tags/resolution_summary | 需要 ALTER TABLE（Sequelize Migration） |

### 10.4 关键字段实际类型确认

| 表.字段 | 文档假设 | 实际类型 | 差异 |
|---------|---------|---------|------|
| customer_service_sessions.customer_service_session_id | BIGINT | **bigint** | ✅ 一致，主键名是全称非缩写 |
| customer_service_sessions.status | ENUM | **enum('waiting','assigned','active','closed')** | ✅ 一致 |
| customer_service_sessions.satisfaction_score | INT | **int, NULL** | ✅ 一致，字段已存在 |
| customer_service_sessions.first_response_at | （未提及） | **datetime, NULL** | 📌 已有首响时间字段 |
| customer_service_sessions.is_active_session | （未提及） | **tinyint(1)** | 📌 已有活跃标记字段 |
| chat_messages.chat_message_id | BIGINT | **bigint** | ✅ 一致，主键名是全称 |
| chat_messages.message_type | ENUM | **enum('text','image','system')** | ✅ 已支持system类型消息（补偿/诊断可用） |
| item_instances.locks | JSON | **json** | ✅ 多级锁字段存在 |
| account_asset_balances.lottery_campaign_id | （文档未提及） | **int, NULL** | 📌 余额按活动隔离，查询时注意 |
| account_asset_balances.lottery_campaign_key | （文档未提及） | **varchar, 'GLOBAL'** | 📌 默认 GLOBAL 为全局余额 |
| trade_orders.business_id | VARCHAR | **varchar(150), UNI** | 📌 幂等键，取消订单时可用 |
| lottery_draws.lottery_draw_id | （文档假设自增） | **varchar(50)** | ⚠️ 主键是字符串非自增，前端展示注意 |

### 10.5 资产体系实际结构

15种资产类型（`material_asset_types` 表）：

| 资产代码 | 显示名 | 性质 |
|---------|--------|------|
| DIAMOND | 钻石 | 通货（C2C交易计价） |
| POINTS | 普通积分 | 消费获取 |
| BUDGET_POINTS | 预算积分 | 抽奖消耗 |
| red_shard / red_crystal | 红水晶碎片 / 红水晶 | 合成材料 |
| orange_shard / orange_crystal | 橙水晶碎片 / 橙水晶 | 合成材料 |
| yellow_shard / yellow_crystal | 黄水晶碎片 / 黄水晶 | 合成材料 |
| green_shard / green_crystal | 绿水晶碎片 / 绿水晶 | 合成材料 |
| blue_shard / blue_crystal | 蓝水晶碎片 / 蓝水晶 | 合成材料 |
| purple_shard / purple_crystal | 紫水晶碎片 / 紫水晶 | 合成材料 |

补偿工具的资产下拉列表直接从此表查询，无需硬编码。

---

## 十一、问题三方归属（后端 / Web管理后台 / 微信小程序）

### 11.1 后端数据库项目需要做的事（owner: 后端）

| 序号 | 任务 | 类型 | 具体内容 |
|------|------|------|---------|
| B1 | 创建 customer_service_issues 表 | Migration | `npx sequelize-cli migration:create`，DDL 见第六节 6.1 |
| B2 | 创建 customer_service_notes 表 | Migration | DDL 见第六节 6.2 |
| B3 | customer_service_sessions 加字段 | Migration | ALTER TABLE 加 issue_id / tags(JSON) / resolution_summary |
| B4 | 新建 user-context.js 路由文件 | Route | 挂载到 `routes/v4/console/customer-service/user-context.js`，9个GET接口 |
| B5 | 新建 issues.js 路由文件 | Route | 挂载到 `routes/v4/console/customer-service/issues.js`，工单CRUD |
| B6 | 新建 gm-tools.js 路由文件 | Route | 挂载到 `routes/v4/console/customer-service/gm-tools.js`，诊断+补偿+模板 |
| B7 | 新建 CustomerServiceUserContextService | Service | **薄封装层**（~120行），委托已有 `UserDataQueryService`（8方法）+ `ItemService` + 少量新增查询 |
| B8 | 新建 CustomerServiceIssueService | Service | 工单 CRUD + 备注管理 |
| B9 | 新建 CustomerServiceDiagnoseService | Service | 一键诊断，并行检查各模块 |
| B10 | 新建 CustomerServiceCompensateService | Service | 补偿发放，TransactionManager.execute() 事务内 |
| B11 | 新建 CustomerServiceIssue Model | Model | Sequelize Model 定义 + 关联关系 |
| B12 | 新建 CustomerServiceNote Model | Model | Sequelize Model 定义 + 关联关系 |
| B13 | 注册新 Service 到 ServiceManager | Config | `services/index.js` 中注册 4 个新 Service |
| B14 | 更新 index.js 路由挂载 | Route | `routes/v4/console/customer-service/index.js` 中挂载 3 个新路由文件 |
| B15 | 用户端满意度评分接口 | Route | `/api/v4/system/chat/sessions/:id/rate` POST |
| B16 | 用户端工单查询接口 | Route | `/api/v4/system/chat/issues` GET |

### 11.2 Web管理后台前端项目需要做的事（owner: Web前端）

| 序号 | 任务 | 类型 | 具体内容 |
|------|------|------|---------|
| W1 | A区重构：智能会话队列 | 页面改造 | 分组排序、等待时长、消息预览、问题标签 |
| W2 | B区增强：GM操作工具栏 | 页面改造 | 接单/诊断/补偿/工单/转接/关闭按钮 |
| W3 | C区全新：8Tab用户上下文面板 | 新增组件 | 资产/背包/抽奖/交易/记录/风控/历史/备注 |
| W4 | 顶部状态栏升级 | 页面改造 | SLA告警、工单待处理数、满意度统计 |
| W5 | 一键诊断结果卡片渲染 | 新增组件 | diagnosis-card.js（系统消息卡片嵌入聊天流） |
| W6 | 补偿弹窗 | 新增组件 | compensation-modal.js（资产下拉+数量输入+备注） |
| W7 | 工单弹窗 | 新增组件 | issue-modal.js（创建/编辑工单表单） |
| W8 | 消息模板库 | 新增组件 | 分类模板选择器（替代当前4条 quickReplies） |
| W9 | API层新增 | 配置 | `admin/src/api/content.js` 中新增所有 user-context/issues/gm-tools 端点 |
| W10 | Composable 拆分 | 重构 | 当前 customer-service.js(482行) 拆分为多个 composable |

### 11.3 微信小程序项目需要做的事（owner: 小程序前端）

> 微信小程序代码不在本仓库中，是独立项目。本节作为**小程序前端求证文档**，明确后端权威字段名和接口规范。

| 序号 | 任务 | 类型 | 具体内容 |
|------|------|------|---------|
| M1 | 满意度评分UI | 新增页面/弹窗 | 会话关闭后弹出评分界面，调用 `POST /api/v4/system/chat/sessions/:id/rate` |
| M2 | 工单进度查看 | 新增页面 | 用户查看自己工单列表和进度，调用 `GET /api/v4/system/chat/issues` |
| M3 | 字段名对齐后端 | 代码修改 | 直接使用后端返回的字段名，不做任何映射（详见下方字段清单） |
| M4 | WebSocket 事件对齐 | 代码修改 | 使用后端 `ChatWebSocketService` 定义的事件名（`new_message`/`session_update`/`satisfaction_request`） |

#### M3 字段名对齐清单（后端权威，小程序直接使用）

**原则：后端数据库字段名即 API 返回字段名，小程序直接使用 snake_case，不做 camelCase 转换，不做字段重命名映射。**

| 业务域 | 后端权威字段名（snake_case） | 禁止的前端映射写法 | 说明 |
|--------|---------------------------|-------------------|------|
| 会话 | `customer_service_session_id` | ~~sessionId~~ | 主键，bigint |
| 会话 | `user_id` / `admin_id` | ~~userId~~ / ~~adminId~~ | 外键 |
| 会话 | `status` | — | enum: waiting/assigned/active/closed |
| 会话 | `satisfaction_score` | ~~rating~~ / ~~score~~ | int, NULL |
| 会话 | `first_response_at` | ~~firstResponseTime~~ | datetime |
| 会话 | `last_message_at` | ~~lastMessageTime~~ | datetime |
| 消息 | `chat_message_id` | ~~messageId~~ | 主键，bigint |
| 消息 | `sender_type` | ~~senderRole~~ | enum: user/admin/system |
| 消息 | `message_type` | ~~type~~ | enum: text/image/system |
| 消息 | `content` | — | 消息内容 |
| 消息 | `temp_message_id` | ~~tempId~~ | 客户端临时ID（发送时传入，服务端回传确认） |
| 工单 | `issue_id` | ~~ticketId~~ | 主键，bigint |
| 工单 | `issue_type` | ~~category~~ | enum: asset/trade/lottery/item/account/consumption/feedback/other |
| 工单 | `status` | — | enum: open/processing/resolved/closed |

#### M4 WebSocket 事件名对齐（后端权威）

| 事件名（后端定义） | 方向 | 数据结构 | 小程序处理 |
|-------------------|------|---------|-----------|
| `new_message` | Server→Client | `{ session_id, message }` | 追加到当前会话消息列表 |
| `session_update` | Server→Client | `{ session_id, status, ... }` | 更新会话状态 |
| `satisfaction_request` | Server→Client | `{ session_id }` | 显示内嵌评分卡片 |
| `new_session` | Server→Client | `{ session }` | 刷新会话列表（管理端） |
| `session_closed` | Server→Client | `{ session_id }` | 关闭当前聊天界面 |

### 11.4 三方依赖关系

```
后端 (B1-B16)
  ↓ 提供API
Web前端 (W1-W10) ← 依赖后端 B4-B10 的API
  ↑ 无直接依赖
小程序 (M1-M3) ← 依赖后端 B15-B16 的API
```

**关键路径**：后端 B1-B3（建表） → B4-B10（Service+Route） → Web前端 W3/W5/W6/W7 可并行开发

---

## 十二、后端可复用服务清单与技术兼容性分析

### 12.1 可直接复用的后端 Service（零改动）

| 现有 Service | Service Key | 可复用方法 | 用于客服工作台的场景 |
|-------------|-------------|-----------|-------------------|
| **BalanceService** | `asset_balance` | `getBalance()`、`getAllBalances()` | C区资产Tab查余额 |
| | | `changeBalance()` | 补偿发放资产 |
| | | `freeze()` / `unfreeze()` | 处理冻结资产问题 |
| **ItemService** | `asset_item` | `getUserItemInstances()` | C区背包Tab查物品列表 |
| | | `getItemInstanceDetail()` | 查看物品详情 |
| | | `unlockItem()` | 解锁被锁物品 |
| | | `mintItem()` | 补偿发放物品 |
| | | `getItemEvents()` | 查物品事件日志 |
| **TradeOrderService** | `trade_order` | `getUserOrders()` | C区交易Tab查订单列表 |
| | | `getOrderDetail()` | 查看订单详情 |
| | | `cancelOrder()` | 取消冻结订单 |
| | | `getUserTradeStats()` | 交易统计 |
| **CustomerServiceSessionService** | `customer_service_session` | `getSessionList()` | A区会话列表 |
| | | `getSessionMessages()` | B区聊天消息 |
| | | `sendMessage()` | 发送消息 |
| | | `closeSession()` | 关闭会话 |
| | | `getSessionStats()` | 顶部状态栏统计 |
| **AdminCustomerServiceService** | `admin_customer_service` | 全部方法（Facade） | 管理端所有客服操作 |
| | | `updateAdminOnlineStatus()` | 在线状态管理（Redis） |

| **UserDataQueryService** | `user_data_query` | `getUserOverview()` | C区用户画像聚合（用户基本信息+资产余额汇总） |
| | | `getAssetTransactions()` | C区资产Tab流水查询 |
| | | `getLotteryDraws()` | C区抽奖Tab记录查询 |
| | | `getTradeRecords()` | C区交易Tab订单查询 |
| | | `getMarketListings()` | C区交易Tab挂单查询 |
| | | `getExchangeRecords()` | C区记录Tab兑换记录 |
| | | `getConversionRecords()` | C区记录Tab合成记录 |
| | | `searchUser()` | A区搜索用户 |
| **SessionQueryService** | `console_session_query` | `getSessions()` | A区会话队列查询 |
| | | `getSessionById()` | 会话详情 |
| | | `getSessionStats()` | 顶部状态栏统计 |
| **BusinessRecordQueryService** | `console_business_record_query` | `getChatMessages()` | B区聊天历史查询 |
| | | `getChatMessageStats()` | 消息统计 |

**复用方式**：新 Service 通过 `ServiceManager.getService()` 获取已有 Service 实例，直接调用方法。

> **2026-02-22 二次验证重大发现**：`UserDataQueryService`（service key: `user_data_query`）已实现8个静态方法，覆盖了文档提出的 `CustomerServiceUserContextService` 约 **70%** 的功能。建议 `CustomerServiceUserContextService` 直接委托 `UserDataQueryService` 而非从零编写查询逻辑，仅需补充：背包物品查询（委托 `ItemService`）、风控信息查询、历史会话查询、一键诊断逻辑。这将原来 Phase 1 的 ~300 行新 Service 代码缩减为 ~120 行薄封装层。

### 12.2 可复用的后端基础设施

| 基础设施 | 已有实现 | 复用方式 |
|---------|---------|---------|
| TransactionManager | `utils/TransactionManager.js` | 补偿接口的事务控制 |
| admin_operation_logs | 5,822条已有数据 | 补偿操作自动写入审计日志 |
| ChatWebSocketService | 1,563行完整实现 | 新消息推送、诊断结果推送、满意度邀请推送 |
| BeijingTimeHelper | 全链路北京时间 | 所有时间字段统一 |
| system_configs 表 | 13条配置项 | 新增 `cs_reply_templates` 存储消息模板 |
| chat_messages.message_type='system' | 已支持系统消息 | 补偿/诊断结果作为系统消息插入聊天流 |
| customer_service_sessions.satisfaction_score | 字段已存在 | 满意度评分直接更新此字段 |
| customer_service_sessions.first_response_at | 字段已存在 | 首响时间计算无需新增 |

### 12.3 可扩展的后端模式

| 模式 | 已有范例 | 扩展方式 |
|------|---------|---------|
| 路由文件拆分 | `routes/v4/console/customer-service/` 下已有 6 个文件（index/sessions/messages/operations/agents/assignments） | 新增 user-context.js / issues.js / gm-tools.js |
| Service 静态类 | `BalanceService`、`ItemService` 等（static async + options.transaction） | 新增 Service 遵循同样的静态方法 + options.transaction 模式 |
| Service 委托模式 | `AdminCustomerServiceService` 委托 `CustomerServiceSessionService` | `CustomerServiceUserContextService` 委托 `UserDataQueryService` + `ItemService` |
| Model 关联 | `CustomerServiceSession.belongsTo(User)` | 新增 Model 按同样模式定义关联 |
| Sequelize Migration | `migrations/` 目录 + `npm run db:migrate` | 新增 Migration 文件创建表和字段 |
| ServiceManager 注册 | `this._services.set('key', Service)` 模式，已有 80+ 个 Service | 新增 4 个 Service 到 `services/index.js` |
| 路由挂载 | `router.use('/sub-path', subRoutes)` 嵌套路由模式 | 新增子路由挂载到 customer-service/index.js |

### 12.4 Web管理后台前端技术兼容性分析

| 维度 | 现有技术 | 文档方案 | 兼容性 |
|------|---------|---------|--------|
| 框架 | Alpine.js 3.15.4 | Alpine.js composable 模式 | ✅ 完全兼容 |
| 样式 | Tailwind CSS 3.4.19 | Tailwind 自定义组件 | ✅ 完全兼容 |
| 构建 | Vite 6.4.1 MPA | 继续使用 customer-service.html | ✅ 完全兼容 |
| HTTP | 自定义 fetch wrapper (`admin/src/api/base.js`) | `request()` 函数调用新API | ✅ 完全兼容 |
| WebSocket | Socket.IO Client 4.8.3 | 复用现有 WebSocket 连接 | ✅ 完全兼容 |
| 图表 | ECharts 6.0.0 | 统计面板可用 ECharts | ✅ 完全兼容 |
| 状态管理 | Alpine.js composable | 拆分为多个 composable 文件 | ✅ 完全兼容 |
| 模板 | EJS + Alpine x-data | 新增 x-data 组件 | ✅ 完全兼容 |
| API 配置 | `admin/src/api/content.js` 集中定义 | 新增端点到同一文件 | ✅ 完全兼容 |

**结论**：文档方案与 Web 管理后台现有技术栈 **100% 兼容**，不引入任何新依赖。

### 12.5 前端 Composable 拆分建议（对齐现有目录结构）

现有结构：
```
admin/src/modules/content/
├── composables/customer-service.js     # 482行（需拆分）
├── composables/cs-agent-management.js  # 532行
├── pages/customer-service.js
└── pages/cs-agent-management.js
```

建议拆分后（保持在 `content` 模块内，不新建模块目录）：
```
admin/src/modules/content/
├── composables/
│   ├── cs-session-queue.js          # A区：会话队列（从 customer-service.js 拆出）
│   ├── cs-chat-conversation.js      # B区：聊天对话（从 customer-service.js 拆出）
│   ├── cs-user-context.js           # C区：用户上下文面板（新增）
│   ├── cs-work-status.js            # 顶部：工作状态栏（新增）
│   ├── cs-ws-connection.js          # WebSocket连接（从 customer-service.js 拆出）
│   ├── cs-diagnosis.js              # 一键诊断（新增）
│   ├── cs-compensation.js           # 补偿工具（新增）
│   ├── cs-issues.js                 # 工单管理（新增）
│   ├── cs-templates.js              # 消息模板（新增）
│   └── cs-agent-management.js       # 保持不变
├── pages/
│   ├── customer-service.js          # 主页面（组合各 composable）
│   └── cs-agent-management.js       # 保持不变
└── components/                       # 新增目录
    ├── cs-context-panel-assets.js
    ├── cs-context-panel-backpack.js
    ├── cs-context-panel-lottery.js
    ├── cs-context-panel-trades.js
    ├── cs-context-panel-timeline.js
    ├── cs-context-panel-risk.js
    ├── cs-context-panel-history.js
    ├── cs-context-panel-notes.js
    ├── cs-diagnosis-card.js
    ├── cs-compensation-modal.js
    └── cs-issue-modal.js
```

> **与文档第七节 7.1 的差异**：文档建议新建 `admin/src/modules/customer-service/` 独立模块，但现有代码结构是 `admin/src/modules/content/` 下按功能分类。为避免破坏现有模块加载和引用关系，建议保持在 `content` 模块内，用 `cs-` 前缀区分客服文件。此为**需要拍板的决策**（见第十三节）。

---

## 十三、需要拍板的决策事项（含行业横向对比）

---

### 决策 1：前端模块目录结构

#### 各行业怎么做

| 公司/行业 | 做法 | 技术方案 | 适用规模 |
|-----------|------|---------|---------|
| **阿里巴巴（千牛客服）** | 微前端架构，每个业务模块是独立 micro-app | qiankun 微前端框架，每个模块独立仓库、独立部署 | 50+ 前端开发，上百个模块 |
| **腾讯（企业微信客服）** | 按业务线拆分独立 npm package | monorepo + lerna/pnpm workspace，package间通过接口引用 | 10-30 前端开发 |
| **美团（客服平台）** | 单仓库按 feature 目录分组 | 每个 feature 一个目录，内含 components/hooks/api/types | 5-15 前端开发 |
| **字节跳动（抖音客服）** | 低代码平台搭建 | 配置化生成客服界面，非纯代码开发 | 运营人员 |
| **米哈游（GM工作台）** | Vue 单仓库，按 views/模块名 分目录 | 不拆独立包，同一个 Vue 项目内 `views/gm-tools/` | 2-5 前端开发 |
| **中小游戏公司** | 一个项目一个文件夹，按页面分 | 简单目录结构，不过度拆分 | 1-3 前端开发 |
| **Zendesk/Intercom** | React SPA，按 feature 目录 | `features/tickets/`, `features/chat/`, 共享 `shared/` | 10-20 前端开发 |

#### 本项目实际情况

- 前端开发人数：**1-2 人**
- 框架：Alpine.js（轻量级，无 Vue/React 的模块系统）
- 构建：Vite MPA（多页应用，按 HTML 文件入口）
- 现有结构：`admin/src/modules/content/` 下已有 customer-service.js 和 cs-agent-management.js

#### 选项与推荐

| 选项 | 方案 | 匹配行业 | 改动量 |
|------|------|---------|--------|
| A | 新建 `admin/src/modules/customer-service/` 独立模块 | 腾讯/美团做法 | 中（需改 Vite 入口配置、调整引用路径） |
| **B（推荐）** | **保持 `content/` 内，`cs-` 前缀分组** | **米哈游/中小公司做法** | **零（构建配置零改动）** |

**推荐理由**：1-2人团队搞微前端或独立模块是杀鸡用牛刀。米哈游GM工作台同样是几个人维护，用前缀分组足够清晰。等团队到5人以上再拆模块不迟。

---

### 决策 2：数据库 schema 变更策略

#### 各行业怎么做

| 公司/行业 | 做法 | 原因 |
|-----------|------|------|
| **银行/投行（高盛、摩根）** | DBA 审批 + 版本化 migration + 回滚脚本 + 灰度发布 | 金融数据零容忍，任何 schema 变更必须经过 3 级审批 |
| **阿里/美团/字节** | 版本化 migration（Flyway/Liquibase）+ 灰度 + 影子表 | 线上数据量大，ALTER TABLE 可能锁表，需要 pt-online-schema-change |
| **游戏公司（米哈游/网易/腾讯游戏）** | 版本化 migration + 热更新能力 | 游戏服不停服更新，但后台工具可以停服迁移 |
| **中小公司/创业期** | ORM migration 工具（Sequelize/Prisma/Knex） | 数据量小，ALTER TABLE 瞬间完成，标准 migration 足够 |
| **股票/交易平台（5173/交易猫）** | 版本化 migration + 只加不改不删原则 | 交易数据不可变，只能追加字段 |

#### 本项目实际情况

- ORM：Sequelize 6.35.2（已有完整的 migration 体系，`npm run db:migrate`）
- 受影响表：`customer_service_sessions`（24条数据）
- 变更内容：ADD COLUMN x3（全部 DEFAULT NULL）

#### 选项与推荐

| 选项 | 方案 | 匹配行业 |
|------|------|---------|
| **A（推荐）** | **标准 Sequelize Migration，ALTER TABLE ADD COLUMN** | **全行业共识，无任何争议** |
| B | 跳过 migration 直接改 Model | 无行业采用（技术债务） |

**推荐理由**：这是全行业唯一正确做法。24条数据的 ALTER TABLE 执行时间 < 1秒，零风险。项目已有 migration 流程（`npm run migration:verify && npm run db:migrate`），不使用就是技术倒退。

---

### 决策 3：补偿操作权限控制

#### 各行业怎么做

| 公司/行业 | 做法 | 权限分层 | 审计 |
|-----------|------|---------|------|
| **米哈游（原神GM）** | 分级GM权限 | GM1: 查看权限。GM2: 补偿 ≤ 100原石。GM3: 补偿 ≤ 1000原石。GM总监: 无上限 | 每笔补偿写入操作日志，月度审计 |
| **网易游戏** | GM权限 + 金额阈值 | 小额自动审批，大额需上级确认 | 实时监控异常补偿 |
| **腾讯游戏** | GM工单系统 + 多级审批 | 不同等级GM有不同的补偿上限 | 完整审计链 |
| **美团/阿里** | 客服 + 主管两级 | 客服可退款 ≤ 50元。主管 ≤ 500元。经理: 无上限 | 全部记录工单 |
| **银行（工商/招商）** | 严格多级审批 | 柜员 → 主管 → 分行经理，每级有限额 | 双人复核 + 影像留存 |
| **5173/交易猫** | 客服 + 仲裁员两级 | 客服只能协调，仲裁员才能执行退款 | 纠纷记录完整保存 |
| **小公司/初创** | admin 统一权限 | 不分级，老板/技术负责人直接操作 | 操作日志 |
| **百度/抖音客服** | RBAC 角色控制 + 工单审批流 | 按角色分配不同操作权限 | 全链路日志 |

#### 本项目实际情况

- 当前坐席数：**1个**（user_id:31 管理员用户）
- admin 用户数：**4个**（user_id: 31, 135, 11114, 11132）
- 已有审计：`admin_operation_logs` 表（5,822条已有数据，含 `points_adjust` 528条、`asset_adjustment` 131条）
- 已有 RBAC：roles 表有10个角色，role_level 从 -1 到 100

#### 选项与推荐

| 选项 | 方案 | 匹配行业 | 适合时机 |
|------|------|---------|---------|
| **A（推荐）** | **admin 角色（role_level >= 100）可补偿，全部记 admin_operation_logs** | **小公司 + 游戏公司初期** | **现在**（1坐席，4admin） |
| B | 新增 "客服主管" 角色 + 补偿金额阈值 | 美团/阿里模型 | 坐席 ≥ 3人时 |
| C | 多级审批（补偿申请→审批→执行） | 银行/大厂模型 | 坐席 ≥ 10人时 |

**推荐理由**：米哈游最初也是小团队单GM操作，随团队扩大才分级。当前只有1个坐席4个admin，A方案完全够用。但**补偿接口设计时预留 `max_compensate_amount` 参数**，未来加阈值控制只需改配置不改代码。

**预留扩展点**：
```javascript
// 补偿接口设计时预留阈值检查位置
static async compensate(params, options = {}) {
  // 未来在此处加金额阈值校验：
  // if (totalAmount > agent.max_compensate_amount) throw new Error('超出权限')
  // 当前阶段：admin role_level >= 100 即可
}
```

---

### 决策 4：工单系统 issue_type 枚举值

#### 各行业怎么做

| 公司/行业 | 分类方式 | 具体类型 | 可扩展性 |
|-----------|---------|---------|---------|
| **Zendesk** | 完全自定义标签（无固定枚举） | 管理员自由创建标签和类别 | 高（运营自助） |
| **Intercom** | 预设 + 自定义 | 默认5类 + 自定义标签 | 高 |
| **美团** | 一级+二级分类 | 一级：订单/配送/支付/账号/其他。二级：每个一级下10-20个细分 | 高但复杂 |
| **阿里（淘宝）** | 三级分类树 | 交易→退款→仅退款/退货退款/换货 | 极高但运营成本高 |
| **米哈游/网易** | 按游戏模块分 | 账号/充值/游戏Bug/举报/建议/其他 | 中（跟随版本更新） |
| **5173/交易猫** | 按交易阶段分 | 交易纠纷/充值问题/提现问题/账号问题/商品问题/其他 | 中 |
| **银行** | 按业务线分 | 信用卡/储蓄/理财/贷款/转账/其他 | 低（需合规审批才能改） |
| **小公司** | 简单枚举 | 5-8 种固定类型 | 低（改代码才能加） |
| **百度/抖音** | 按产品模块分 | 和产品功能模块一一对应 | 中 |
| **活动策划公司** | 按活动分 + 通用类型 | 活动报名/奖品发放/系统异常/退款/其他 | 中 |

#### 本项目实际业务模块对照

| 业务模块 | 对应数据库表 | 实际数据量 | 可能产生的工单 |
|---------|------------|-----------|--------------|
| 资产体系 | account_asset_balances + asset_transactions | 28,685条流水 | 余额异常、冻结未解、充值不到账 |
| 交易市场 | trade_orders + market_listings | 134订单 + 295挂单 | 交易纠纷、冻结超时、物品未到 |
| 抽奖系统 | lottery_draws | 3,030条 | 扣分没出奖、保底未触发、奖品未到背包 |
| 物品背包 | item_instances + item_instance_events | 6,758实例 + 5,345事件 | 物品被锁、物品消失、无法使用 |
| 账号 | users + user_roles | 66用户 | 登录问题、封号申诉、等级异常 |
| 兑换商城 | exchange_records + exchange_items | 0条兑换记录 | 兑换失败、发货问题（**当前无数据，暂不开**） |
| 消费核销 | consumption_records | 48条 | 核销失败、积分未到账 |
| 反馈 | feedbacks | 165条 | 各类反馈升级为工单 |

#### 选项与推荐

| 选项 | 枚举值 | 匹配行业 |
|------|--------|---------|
| A | `asset, trade, lottery, item, account, other`（原方案6种） | 米哈游/小公司 |
| **B（推荐）** | **`asset, trade, lottery, item, account, consumption, feedback, other`（8种）** | **美团/5173 + 游戏公司混合** |
| C | 改用 VARCHAR + system_configs 动态配置 | Zendesk/Intercom |

**推荐理由**：

- **加 `consumption`**：消费核销已有48条数据，门店体系是核心闭环，核销问题是高频场景
- **加 `feedback`**：165条反馈（150条pending），反馈升级为工单是明确需求
- **不加 `redemption`**：exchange_records 为0条数据，兑换商城功能未启用，等启用时再加一行 ENUM 即可
- **不用 C 方案**：动态配置看似灵活但增加复杂度，8种固定枚举覆盖了当前所有活跃业务模块，加新类型只需一行 ALTER TABLE

---

### 决策 5：资产余额查询的活动隔离

#### 各行业怎么做

| 公司/行业 | 余额展示策略 | 分组逻辑 |
|-----------|------------|---------|
| **原神/崩铁（米哈游）** | 全部展示，但主货币突出显示 | 原石(通货) 置顶大字体，星琼/摩拉/体力等按类型分组 |
| **王者荣耀/LOL（腾讯）** | 全部展示，按用途分组 | 点券(付费) / 金币(免费) / 钻石(活动)，分区块展示 |
| **梦幻西游（网易）** | 全部展示 + 活动专属货币标注 | 主货币 + 绑定货币 + 活动限定货币，限定货币带"活动"标签和有效期 |
| **淘宝/美团** | 只展示主账户余额 | 优惠券/红包在独立入口查看，不混在余额里 |
| **银行（招商/工商）** | 全部展示，按账户类型分组 | 活期/定期/理财/基金，每个账户独立展示余额 |
| **股票券商** | 全部展示 + 汇总 | 总资产汇总 + 各股票/基金持仓明细 |
| **Steam** | 只展示钱包余额 | 单一货币，不做分组 |
| **5173/交易猫** | 只展示可用余额 | 可用 / 冻结中 / 提现中，三种状态 |
| **抖音** | 抖币总余额 | 单一虚拟货币 |

#### 本项目实际情况

- `account_asset_balances` 有 `lottery_campaign_key` 字段
- `GLOBAL` = 全局余额（通用）
- 活动 key = 活动专属余额（仅在特定活动中使用）
- 当前活动：1个 active（餐厅积分抽奖），3个已结束
- 客服场景：用户问的99%是"我的钻石/积分怎么少了"，关心的是 GLOBAL 余额

#### 选项与推荐

| 选项 | 展示策略 | 匹配行业 |
|------|---------|---------|
| **A（推荐）** | **默认展示 GLOBAL 全局余额，底部「查看活动专属余额」折叠展开** | **米哈游 + 银行混合** |
| B | 只展示 GLOBAL | Steam/抖音（但丢失信息） |
| C | 全部展示平铺 | 可能信息过载 |

**推荐理由**：参考米哈游做法——主货币突出显示，活动限定货币折叠。客服日常看 GLOBAL 就够了，遇到活动相关问题时展开查看。后端接口返回全量数据（含 `lottery_campaign_key`），**展示层由前端控制折叠/展开**，后端不做过滤。

---

### 决策 6：一键诊断的冻结超时阈值

#### 各行业怎么做

| 公司/行业 | 交易冻结超时 | 超时后处理 |
|-----------|------------|-----------|
| **淘宝** | 付款后 **24小时** 发货，确认收货 **10天** 自动打款 | 超时自动确认 + 退款通道 |
| **美团（外卖）** | 下单后 **30分钟** 骑手接单，超时自动取消 | 自动取消 + 全额退款 |
| **美团（到店）** | 支付后 **未消费7天** 可退 | 超时按规则退款 |
| **拼多多** | 付款后 **48小时** 发货 | 超时自动取消 |
| **原神/崩铁** | 交易系统无冻结（不开放C2C） | N/A |
| **梦幻西游（摆摊）** | 挂单 **7天** 自动下架 | 物品退回 |
| **5173** | 充值/提现 **15分钟** 处理。交易 **24小时** 发货 | 超时可申请退款 |
| **交易猫** | 交易 **2小时** 内完成验证 | 超时冻结升级为客服介入 |
| **Steam 市场** | 挂单无超时。交易完成后 **15天** 交易保留 | 无自动取消 |
| **银行转账** | 即时到账 / T+1 / T+3 看渠道 | 超时自动退款 |
| **支付宝** | 担保交易 **10天** 确认 | 超时自动确认收货 |
| **股票交易** | T+0（当日）撮合 | 未成交挂单当日收盘取消 |

#### 本项目实际情况

- 交易类型：**C2C 虚拟物品交易**（钻石买物品，类似游戏摆摊）
- 交易流程：买家下单 → 冻结买家钻石 + 锁定卖家物品 → 系统自动撮合完成
- 当前数据：trade_orders 有 2 个 created 状态（可能是冻结中未完成的）
- 交易金额范围：几百到几千 DIAMOND
- 技术细节：系统自动撮合（非人工确认），正常几秒内完成

#### 选项与推荐

| 选项 | 超时阈值 | 匹配行业 | 适用场景 |
|------|---------|---------|---------|
| A | 15分钟 | 5173 充值/提现级别 | 如果系统撮合应该秒级完成，15分钟已经很长 |
| **B（推荐）** | **30分钟（诊断告警）+ 2小时（自动取消）** | **交易猫 + 美团混合** | **给系统恢复时间，避免误取消** |
| C | 24小时 | 淘宝级别 | 太长，用户体验差 |

**推荐理由**：

本项目的 C2C 交易是系统自动撮合，正常情况下几秒就完成。如果一笔订单卡在 created/frozen 超过30分钟，几乎可以确定是系统异常。参考交易猫的做法：

- **30分钟**：诊断接口标记为 `warning`（黄色告警），提示客服关注
- **2小时**：诊断接口标记为 `error`（红色告警），建议立即处理
- **自动取消时间**：可配置在 `system_configs` 中（`trade_freeze_timeout_minutes`），不硬编码

```
0-30分钟: 正常（可能是网络延迟/系统队列）
30分钟-2小时: ⚠️ warning（客服关注，可能需要手动处理）
>2小时: 🔴 error（强烈建议取消订单退款）
```

---

### 决策 7：微信小程序满意度评分的触发时机

#### 各行业怎么做

| 公司/行业 | 触发时机 | 评分方式 | 未评分处理 |
|-----------|---------|---------|-----------|
| **美团** | 订单完成 **自动弹出** | 1-5星 + 标签（"服务好"/"态度差"） + 文字 | 3天后消失，默认好评 |
| **淘宝** | 交易完成 **自动弹出** + 客服可手动发起 | 1-5星 + 评语 | 15天未评默认好评 |
| **滴滴** | 行程结束 **自动弹出**，不评分无法叫下一单 | 1-5星 + 标签 | 强制评分（功能阻断） |
| **腾讯客服** | 工单关闭后 **推送消息** 邀请评分 | 满意/一般/不满意 三选一 | 48小时未评，不计入统计 |
| **原神客服** | 工单处理完成后 **站内信通知** | 满意/不满意 + 文字反馈 | 不强制 |
| **银行（招商/工商）** | 通话结束 **IVR自动转接评分** 或 **短信推送** | 1-5分按键 / 短信链接 | 不强制 |
| **Zendesk** | 工单状态变为 resolved 后 **邮件推送** | 满意/不满意（Good/Bad） | 默认不计入 |
| **企业微信客服** | 会话结束后 **自动在聊天窗口底部显示评分** | 满意/一般/不满意 | 60秒后消失 |
| **抖音客服** | 会话关闭 **聊天窗口内嵌评分卡** | 1-5星 | 不强制 |
| **百度客服** | 问题解决后 **弹窗邀请** | 已解决/未解决 + 星级 | 不强制 |
| **活动策划公司** | 活动结束后 **短信/公众号推送** | 问卷链接 | 不强制 |

#### 关键行业规律

1. **强制评分**（滴滴模式）：适合双边市场需要评分数据驱动匹配的场景。客服场景不适用
2. **自动弹出**（美团/淘宝模式）：适合高频交易场景，评分率最高（30-50%）
3. **消息推送**（腾讯/企微模式）：适合IM聊天场景，不打断用户操作，评分率中等（15-25%）
4. **邮件推送**（Zendesk模式）：评分率最低（5-10%），但样本质量高

#### 本项目实际情况

- 用户端：微信小程序
- 通信方式：WebSocket（Socket.IO）
- 已有字段：`customer_service_sessions.satisfaction_score`（int，NULL）
- 会话特点：用户发起 → 客服处理 → 关闭，非强制流程

#### 选项与推荐

| 选项 | 方案 | 匹配行业 | 评分率预估 |
|------|------|---------|-----------|
| A | 客服手动触发推送 | 原神/Zendesk | 5-10%（客服可能忘记） |
| B | 关闭时自动弹出 | 美团/淘宝/滴滴 | 30-50%（但可能打扰用户） |
| **C（推荐）** | **关闭时聊天窗口内嵌评分卡（自动）+ 客服可手动补发** | **企业微信/抖音 + 腾讯客服混合** | **20-35%** |

**推荐理由**：

参考企业微信和抖音的做法——会话关闭时在聊天窗口底部自动出现评分卡片（不是弹窗，不阻断操作），用户可以选择评或不评。同时客服有手动补发按钮，用于用户主动提到"你服务不错"但还没关闭会话的场景。

技术实现：
1. 后端 `closeSession()` 时自动通过 WebSocket 推送 `satisfaction_request` 事件到小程序
2. 小程序端在聊天页面底部渲染内嵌评分组件（非弹窗）
3. 客服端保留 `[请求评分]` 按钮，点击后手动推送
4. 评分提交调用 `POST /api/v4/system/chat/sessions/:id/rate`
5. 24小时未评分，该会话 satisfaction_score 保持 NULL，统计时排除

---

### 决策 8：UserContextService 实现策略（2026-02-22 二次验证新增）

#### 背景

二次代码验证发现 `UserDataQueryService`（service key: `user_data_query`，已注册在 ServiceManager）已实现 8 个静态方法：`getUserOverview`、`getAssetTransactions`、`getLotteryDraws`、`getTradeRecords`、`getMarketListings`、`getExchangeRecords`、`getConversionRecords`、`searchUser`。覆盖了文档原方案 `CustomerServiceUserContextService` 约 70% 的功能。

#### 各行业怎么做

| 公司/行业 | 新需求与已有服务重叠时的做法 | 技术方案 | 长期维护影响 |
|-----------|--------------------------|---------|------------|
| **阿里巴巴/蚂蚁** | 强制复用已有 HSF 服务，禁止重复实现 | 中台战略：所有查询走统一数据服务层，业务层只做编排 | 低（一处改，处处生效） |
| **腾讯（微信/企微）** | 写薄 Facade 封装已有能力 | BFF 层（Backend for Frontend），聚合调用内部微服务 | 低（Facade 维护成本极低） |
| **美团** | 数据查询服务统一收口，业务层委托调用 | 查询服务层 + 业务服务层分离，禁止业务层直写 SQL | 低 |
| **米哈游/网易游戏** | GM 工具直接调用游戏已有的玩家数据接口 | GM 后台不重写查询逻辑，调用游戏服的 RPC 接口 | 低（GM 工具只是 UI 壳） |
| **字节跳动** | 微服务编排层，组合已有服务 | GraphQL / BFF 聚合多个微服务数据 | 低 |
| **5173 / 交易猫** | 客服后台复用交易核心的查询 API | 客服系统不独立建查询，走交易服务的只读接口 | 低 |
| **Zendesk / Intercom** | 插件机制调用宿主系统 API | Webhook + REST API 集成，不复制数据 | 低 |
| **中小公司（常见错误）** | 为新功能从零写查询，忽略已有服务 | 复制粘贴 SQL，两处逻辑渐渐分裂 | **高**（改一处忘另一处，数据不一致） |

**行业共识**：当已有服务覆盖 > 50% 需求时，全行业一致选择**委托/封装**而非**重写**。唯一例外是已有服务性能不满足要求需要专门优化，但本项目数据量（66 用户、6776 物品）远未到此瓶颈。

#### 选项与推荐

| 选项 | 方案 | 代码量 | 维护成本 |
|------|------|--------|---------|
| **A（推荐）** | **`CustomerServiceUserContextService` 作为薄封装层，委托 `UserDataQueryService` 已有方法** | ~120行 | 低（查询逻辑集中在一处维护） |
| B | 独立实现，不依赖 `UserDataQueryService` | ~300行 | 中（两处重复的查询逻辑） |

**推荐理由**：`UserDataQueryService` 的 `getUserOverview()` 内部已处理 `accounts.user_id → account_id` 关联链、资产余额汇总等复杂逻辑，重复实现是技术债务。委托模式与项目已有的 `AdminCustomerServiceService` 委托 `CustomerServiceSessionService` 的模式一致。

---

### 决策总览表 — 最终定论

> **前提条件**：项目未上线、愿意一次性投入成本、不兼容旧接口、追求长期维护成本最低和技术债务最小化。在这些约束下，8 个决策全部有唯一最优解，不存在需要权衡取舍的情况。

| # | 决策 | 最终选项 | 核心理由 | 参考行业 | 各方案区别一句话 |
|---|------|---------|---------|---------|---------------|
| 1 | 前端目录结构 | **B: content/ 内 cs- 前缀** | 1-2人团队拆独立模块是过度工程化，增加构建配置复杂度 | 米哈游/中小公司 | A多一层目录+改Vite配置，B零改动。**区别仅在目录层级，非技术本质差异** |
| 2 | Schema 变更 | **A: 标准 Sequelize Migration** | 全行业唯一正确做法，24条数据ALTER<1秒 | 全行业共识 | B是跳过Migration直接改Model，**没有任何公司这么做**，纯技术债务 |
| 3 | 补偿权限 | **A: admin-only + 预留阈值** | 1坐席4admin不需要多级审批，但接口预留扩展点 | 游戏公司初期 | A是单层权限，B是两层，C是多级审批。**区别在于复杂度与坐席规模的匹配度** |
| 4 | 工单类型 | **B: 8种固定ENUM** | 覆盖全部活跃业务模块，ENUM性能>VARCHAR | 美团/5173混合 | A少2个类型不够用，C动态配置多出system_configs管理复杂度。**区别在于覆盖度和管理成本的平衡** |
| 5 | 资产隔离 | **A: GLOBAL默认+活动折叠** | 客服99%看GLOBAL够了，活动余额折叠不丢信息 | 米哈游 | B丢失信息，C信息过载。**区别在于信息密度：A是默认精简+按需展开** |
| 6 | 冻结阈值 | **B: 30min告警+2h严重** | 自动撮合秒级完成，30分钟已足够判定异常 | 交易猫/美团混合 | A太短可能误报，C太长用户等不起。**区别在于对"异常"的判定尺度** |
| 7 | 满意度触发 | **C: 自动内嵌卡片+手动补发** | IM场景内嵌最自然，评分率20-35%平衡了数据量和用户体验 | 企业微信/抖音 | A靠人记着会忘，B弹窗打断体验。**区别在于用户感知的侵入程度** |
| 8 | UserContext实现 | **A: 委托UserDataQueryService** | 70%逻辑已有，重写是技术债务 | 全行业共识 | A复用120行，B重写300行。**区别在于是否承认已有服务的价值** |

### 8个决策的核心分歧：大公司 vs 小公司 vs 游戏公司 vs 交易平台

每个决策背后的行业分歧本质上只有一个问题：**在你的规模下，复杂度的收益是否能覆盖它的成本？**

| 维度 | 大厂（美团/阿里/腾讯） | 游戏公司（米哈游/网易） | 交易平台（5173/交易猫） | 小公司/初创 | **本项目应对标** |
|------|---------------------|---------------------|---------------------|-----------|---------------|
| 团队规模 | 50-500人 | 5-50人 | 5-20人 | 1-5人 | **1-2人** |
| 前端架构 | 微前端/monorepo | 单仓库按模块分 | 单仓库按feature分 | 单文件/按页面分 | **单仓库前缀分组**（米哈游模式） |
| Schema变更 | 影子表+灰度 | Migration+热更新 | Migration+只加不删 | ORM Migration | **Sequelize Migration**（中小公司模式） |
| 权限体系 | RBAC+多级审批 | 分级GM | 客服+仲裁两级 | admin统一 | **admin统一+预留扩展**（游戏公司初期模式） |
| 工单分类 | 三级分类树 | 按模块分6-8种 | 按交易阶段分 | 5-8种固定 | **8种ENUM**（游戏+交易混合） |
| 资产展示 | 只看主账户 | 主货币+折叠 | 可用/冻结/提现 | 全部展示 | **GLOBAL+折叠**（米哈游模式） |
| 超时机制 | 小时/天级 | 无C2C交易 | 分钟/小时级 | 无 | **30min/2h两级**（交易猫模式） |
| 满意度 | 自动弹出 | 站内信 | 不做 | 不做 | **内嵌卡片**（企微模式） |
| 服务复用 | 中台强制复用 | 调已有RPC | 调交易核心API | 经常重写 | **委托已有Service**（大厂/游戏共识） |

**结论**：本项目8个决策全部对标**游戏公司初期阶段**（米哈游2-5人GM工具团队），叠加**交易平台的超时/仲裁能力**（因为有C2C市场）。不需要大厂的复杂度，也不该用小公司的"随便搞搞"。

### 为什么这8个选择是长期维护成本最低的

| 决策 | 如果选错了会怎样（反面案例） | 选对了的长期收益 |
|------|-------------------------|---------------|
| 1. 前缀分组 | 选A拆独立模块→Vite配置膨胀+跨模块引用路径维护成本+每次新增页面要改两处配置 | 零配置成本，新增composable放到content/就行 |
| 2. Migration | 选B跳过Migration→3个月后忘记哪些字段是手动加的，团队扩大后无法回溯变更历史 | 完整变更记录，`npm run migration:status`一键查看 |
| 3. admin统一 | 选C多级审批→1个坐席的系统写审批流，开发3天使用0次 | 简单直接，5822条审计日志已足够审计 |
| 4. 8种ENUM | 选A只6种→consumption/feedback问题无法分类，强行归"other"导致统计无意义 | 每种业务问题有独立统计维度 |
| 5. GLOBAL+折叠 | 选C全平铺→15种资产×4个活动=60行数据，客服找"钻石余额"要翻半天 | 3秒内看到核心信息，特殊情况再展开 |
| 6. 30min+2h | 选A 15分钟→网络抖动导致的正常延迟被标红，客服频繁误处理 | 精确匹配系统自动撮合的特点 |
| 7. 内嵌卡片 | 选B弹窗→微信小程序里弹窗体验差，用户直接划走不评分 | 自然融入聊天流，不打断不强制 |
| 8. 委托复用 | 选B重写→UserDataQueryService改了查询逻辑，客服面板的查询没跟着改，数据不一致 | 一处改处处生效，零维护成本 |

---

## 十四、基于后端技术栈的执行步骤

### Phase 0：数据库迁移（预计0.5天）

**后端执行**：

1. 创建 Migration 文件：
   ```bash
   npx sequelize-cli migration:create --name create-customer-service-issues
   npx sequelize-cli migration:create --name create-customer-service-notes
   npx sequelize-cli migration:create --name add-fields-to-customer-service-sessions
   ```

2. 编写 DDL（对齐第六节，外键引用 users.user_id / customer_service_sessions.customer_service_session_id）

3. 执行迁移：
   ```bash
   npm run migration:verify && npm run db:migrate
   ```

4. 创建 Sequelize Model 文件：
   - `models/CustomerServiceIssue.js`
   - `models/CustomerServiceNote.js`
   - 更新 `models/CustomerServiceSession.js` 加新字段

5. 注册 Model 关联：
   - `CustomerServiceIssue.belongsTo(User, { as: 'user', foreignKey: 'user_id' })`
   - `CustomerServiceIssue.belongsTo(User, { as: 'creator', foreignKey: 'created_by' })`
   - `CustomerServiceIssue.belongsTo(CustomerServiceSession, { foreignKey: 'session_id' })`
   - `CustomerServiceNote.belongsTo(User, { as: 'author', foreignKey: 'author_id' })`

### Phase 1：后端 user-context API（预计1.5天，因可委托 UserDataQueryService）

**文件清单**：

| 文件 | 动作 | 行数估算 | 说明 |
|------|------|---------|------|
| `services/CustomerServiceUserContextService.js` | 新建 | **~120行**（非原估300行） | 薄封装层，委托 `UserDataQueryService` + `ItemService` |
| `routes/v4/console/customer-service/user-context.js` | 新建 | ~150行 | 9个GET路由 |
| `routes/v4/console/customer-service/index.js` | 修改 | +2行 | 挂载 user-context 子路由 |
| `services/index.js` | 修改 | +1行 | `this._services.set('cs_user_context', ...)` |

**核心实现逻辑（委托模式，大幅减少新代码）**：

- `getSummary(userId)` → **直接委托** `UserDataQueryService.getUserOverview(models, userId)` 已有方法，返回用户基本信息+资产余额汇总。补充 `ItemInstance.count()` 和 `LotteryDraw.count()` 统计

- `getAssets(userId)` → **直接委托** `UserDataQueryService.getAssetTransactions(models, userId, params)` 已有方法
  - 注意：该方法内部已处理 `accounts.user_id → account_id` 关联链
  - 余额查询额外委托 `BalanceService.getAllBalances()` ，前端按 `lottery_campaign_key` 过滤（取决于决策5）

- `getBackpack(userId)` → **直接委托** `ItemService.getUserItemInstances({ owner_user_id: userId })` 已有方法

- `getLottery(userId)` → **直接委托** `UserDataQueryService.getLotteryDraws(models, userId, params)` 已有方法

- `getTrades(userId)` → **直接委托** `UserDataQueryService.getTradeRecords(models, userId)` + `UserDataQueryService.getMarketListings(models, userId)` 两个已有方法

- `getTimeline(userId)` → 组合 `UserDataQueryService` 已有方法结果 + 查 `consumption_records` + `feedbacks`，合并按时间排序

- `getRisk(userId)` → 新增查询（~30行）：`UserRiskProfile.findOne()` + `RiskAlert.findAll()`

- `getHistory(userId)` → 新增查询（~40行）：`CustomerServiceSession.findAll({ where: { user_id } })` + 每个session聚合消息摘要

### Phase 2：后端诊断+补偿+工单 API（预计2天）

**文件清单**：

| 文件 | 动作 | 行数估算 |
|------|------|---------|
| `services/CustomerServiceDiagnoseService.js` | 新建 | ~200行 |
| `services/CustomerServiceCompensateService.js` | 新建 | ~150行 |
| `services/CustomerServiceIssueService.js` | 新建 | ~250行 |
| `routes/v4/console/customer-service/gm-tools.js` | 新建 | ~100行 |
| `routes/v4/console/customer-service/issues.js` | 新建 | ~120行 |

**诊断服务核心逻辑**：
```javascript
static async diagnose(userId, options = {}) {
  const [assetCheck, tradeCheck, itemCheck, lotteryCheck, accountCheck] = await Promise.all([
    this.checkAssets(userId),    // frozen_amount > 0 且关联订单超时
    this.checkTrades(userId),    // created/frozen 状态超过阈值
    this.checkItems(userId),     // locked 状态且锁超时
    this.checkLottery(userId),   // has_debt = 1
    this.checkAccount(userId)    // users.status != 'active'
  ])
  return { assetCheck, tradeCheck, itemCheck, lotteryCheck, accountCheck }
}
```

**补偿服务核心逻辑**：
```javascript
static async compensate(params, options = {}) {
  return TransactionManager.execute(async (transaction) => {
    // 1. 资产补偿 → BalanceService.changeBalance()
    // 2. 物品补偿 → ItemService.mintItem()
    // 3. 操作日志 → AdminOperationLog.create()
    // 4. 系统消息 → ChatMessage.create({ message_type: 'system' })
  })
}
```

### Phase 3：Web前端 C区面板（预计3天，与Phase 1-2并行）

**依赖后端 Phase 1 完成**后可对接真实数据。前端可先用 mock 数据开发UI。

| 文件 | 动作 |
|------|------|
| `admin/src/modules/content/composables/cs-user-context.js` | 新建 |
| `admin/src/modules/content/components/cs-context-panel-*.js` | 新建 8 个Tab组件 |
| `admin/src/api/content.js` | 修改，新增 user-context 端点定义 |
| `admin/customer-service.html` | 修改，C区从静态信息改为 8Tab 面板 |

### Phase 4：Web前端 A区+B区重构（预计2天）

| 文件 | 动作 |
|------|------|
| `admin/src/modules/content/composables/cs-session-queue.js` | 从 customer-service.js 拆出 |
| `admin/src/modules/content/composables/cs-chat-conversation.js` | 从 customer-service.js 拆出 |
| `admin/src/modules/content/composables/cs-ws-connection.js` | 从 customer-service.js 拆出 |
| `admin/src/modules/content/composables/cs-diagnosis.js` | 新建 |
| `admin/src/modules/content/composables/cs-compensation.js` | 新建 |
| `admin/src/modules/content/composables/cs-issues.js` | 新建 |
| `admin/src/modules/content/components/cs-diagnosis-card.js` | 新建 |
| `admin/src/modules/content/components/cs-compensation-modal.js` | 新建 |
| `admin/src/modules/content/components/cs-issue-modal.js` | 新建 |

### Phase 5：顶部状态栏+满意度+模板（预计2天）

| 文件 | 动作 |
|------|------|
| `admin/src/modules/content/composables/cs-work-status.js` | 新建 |
| `admin/src/modules/content/composables/cs-templates.js` | 新建 |
| `routes/v4/system/chat.js` | 修改，新增满意度评分路由 |

### 总工期与并行关系（二次验证后修订）

```
            第1周                    第2周                    第3周
后端  ┤ Phase 0(0.5d) + Phase 1(1.5d)┤ Phase 2(2d)           ┤ Phase 5后端部分(0.5d)
Web   ┤ Phase 3 前半(mock开发)       ┤ Phase 3对接 + Phase 4  ┤ Phase 5前端部分(1.5d)
小程序 ┤                              ┤                        ┤ M1-M4(1d)
```

Phase 1 因委托 `UserDataQueryService` 从 2 天缩短为 1.5 天。**第2周末**即可达到核心可用状态。

---

## 十五、二次深度验证总结（2026-02-22）

### 15.1 验证方法

- Node.js + mysql2 直连 `restaurant_points_dev`（`dbconn.sealosbja.site:42569`），非备份文件
- ripgrep 遍历后端 `services/`、`routes/`、`models/` 全部源码文件
- 读取 `services/index.js` 完整 ServiceManager 注册表（80+ 个 Service Key）
- 读取 `admin/package.json`、`admin/vite.config.js`、`admin/src/api/content.js` 验证前端技术栈
- 读取 `admin/src/modules/content/composables/customer-service.js` 验证前端现有结构

### 15.2 文档准确性评估

| 维度 | 验证结果 | 说明 |
|------|---------|------|
| 数据库表数量 | ✅ 96张 | 一致 |
| 表结构（字段名/类型/枚举值） | ✅ 完全一致 | 所有 10.4 中声明的字段均已验证 |
| 新表是否已存在 | ✅ 均不存在 | `customer_service_issues`/`customer_service_notes` 需创建 |
| sessions 缺失字段 | ✅ 确认缺失 | `issue_id`/`tags`/`resolution_summary` 均不存在，需 ALTER TABLE |
| 后端 Service Key | ✅ 完全一致 | `asset_balance`/`asset_item`/`trade_order`/`customer_service_session`/`admin_customer_service` 均已注册 |
| Service 方法签名 | ✅ 完全一致 | 5 个 Service 的 18 个方法全部存在且签名匹配 |
| 路由文件结构 | ✅ 6 个文件 | sessions/messages/operations/agents/assignments/index |
| 路由挂载路径 | ✅ `/api/v4/console/customer-service/` | 通过 `app.js → routes/v4/console → customer-service/index.js` 三层挂载 |
| Web 前端技术栈 | ✅ 100% 兼容 | Alpine.js 3.15.4 / Tailwind 3.4.19 / Vite 6.4.1 / Socket.IO 4.8.3 |
| 前端 Composable 结构 | ✅ 一致 | `content/composables/customer-service.js` ~484行，需拆分 |
| 前端 API 定义文件 | ✅ 一致 | `admin/src/api/content.js` 集中定义，新增端点追加到此文件 |
| 业务数据量（活跃增长） | ⚠️ 微量偏差 | item_instances +18, asset_transactions +114, events +30（系统持续运行） |

### 15.3 重大新发现

1. **`UserDataQueryService`（service key: `user_data_query`）**：已有 8 个方法覆盖 user-context 70% 功能。文档原方案的 `CustomerServiceUserContextService` 可降级为薄封装层（~120行 vs 原估 ~300行），节省 60% 后端开发量
2. **`SessionQueryService`（service key: `console_session_query`）**：已有会话查询能力，A区可复用
3. **`BusinessRecordQueryService`（service key: `console_business_record_query`）**：已有聊天消息查询+统计能力
4. **ServiceManager 已注册 80+ Service**：后端服务生态成熟，新增 4 个 Service 完全遵循现有模式
5. **`admin/src/modules/content/` 无 `components/` 目录**：文档提出的组件目录需要新建，但对 Vite 构建配置零影响
6. **trade_orders.status 枚举包含 `frozen`**：验证了诊断 API 的 "检查 created/frozen 状态" 逻辑的可行性
7. **`user_roles` 表结构**：通过 `user_roles.role_id → roles.role_id` 关联（非直接存 role_name），补偿权限判断需 JOIN `roles` 表查 `role_level >= 100`

### 15.4 各项目问题归属最终确认

**后端项目问题（0个阻塞性问题，4个需新建的模块）**：
- 数据库层：缺 2 张表（issues/notes）+ sessions 缺 3 个字段 → Phase 0 Sequelize Migration 解决
- 路由层：缺 3 个路由文件（user-context/issues/gm-tools）→ Phase 1-2 新建
- 服务层：缺 4 个 Service，但 `UserDataQueryService` 可大幅复用 → Phase 1-2 新建（代码量减半）
- Model 层：缺 2 个 Model（Issue/Note）→ Phase 0 新建

**Web管理后台前端项目问题（0个阻塞性问题，需重构+新增组件）**：
- `customer-service.js` 484 行需拆分为 9 个 composable → Phase 4
- 缺少 `components/` 目录和 11 个组件文件 → Phase 3-4 新建
- `admin/src/api/content.js` 需追加 20+ 个新 API 端点定义 → Phase 3
- `customer-service.html` 需从三区域改为四区域（加顶部状态栏）→ Phase 4
- 技术栈（Alpine.js/Tailwind/Vite/Socket.IO）100% 兼容，零新依赖

**微信小程序项目问题（0个阻塞性问题，4个新增任务）**：
- M1：新增满意度评分 UI（内嵌卡片，非弹窗）
- M2：新增工单进度查看页面
- M3：所有字段名对齐后端 snake_case（详见 11.3 字段清单，禁止 camelCase 映射）
- M4：WebSocket 事件名对齐后端定义

### 15.5 需要拍板的 8 个决策

| # | 决策 | 推荐 | 影响范围 | 是否可延后 |
|---|------|------|---------|-----------|
| 1 | 前端目录结构 | B: content/ 内 cs- 前缀 | Web 前端 | 否（Phase 3 前确定） |
| 2 | Schema 变更方式 | A: 标准 Migration | 后端 | 否（Phase 0 前确定） |
| 3 | 补偿操作权限 | A: admin-only + 预留阈值 | 后端 | 是（Phase 2 前确定） |
| 4 | 工单 issue_type 枚举 | B: 8种 | 后端 | 否（Phase 0 前确定） |
| 5 | 资产余额活动隔离展示 | A: GLOBAL 默认 + 折叠 | Web 前端 | 是（Phase 3 前确定） |
| 6 | 冻结超时诊断阈值 | B: 30min告警 + 2h严重 | 后端 | 是（Phase 2 前确定） |
| 7 | 满意度触发时机 | C: 自动内嵌 + 手动补发 | 小程序 + 后端 | 是（Phase 5 前确定） |
| 8 | UserContext 实现策略 | A: 委托 UserDataQueryService | 后端 | 否（Phase 1 前确定） |

**建议决策顺序**：先确定 #2/#4/#8（影响 Phase 0-1），再确定 #1/#3（影响 Phase 2-3），#5/#6/#7 可在各自 Phase 开始前确定。
