# é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ - å›¾ç‰‡å­˜å‚¨æ¶æ„æ ¸æŸ¥æŠ¥å‘Š

**æ ¸æŸ¥æ—¶é—´**ï¼š2026å¹´01æœˆ07æ—¥ 21:45-21:50 åŒ—äº¬æ—¶é—´  
**æ•°æ®åº“**ï¼š`restaurant_points_dev`ï¼ˆMySQL 8.0.30ï¼‰  
**æ ¸æŸ¥æ–¹å¼**ï¼šNode.js + Sequelize ç›´è¿çœŸå®æ•°æ®åº“ + ä»£ç è·¯å¾„åˆ†æ  
**æ ¸æŸ¥èŒƒå›´**ï¼šå›¾ç‰‡å­˜å‚¨åç«¯ã€ä¸šåŠ¡é€»è¾‘é—­ç¯ã€å•†ä¸šæ¨¡å¼å˜ç°è·¯å¾„

---

## ğŸ¯ **æ¶æ„å†³ç­–ï¼ˆå·²æ‹æ¿ - æœ€ç»ˆç‰ˆï¼‰**

**å†³ç­–æ—¶é—´**ï¼š2026å¹´01æœˆ08æ—¥ 23:15 åŒ—äº¬æ—¶é—´ï¼ˆæœ€æ–°æ›´æ–°ï¼‰  
**å†³ç­–äºº**ï¼šé¡¹ç›®è´Ÿè´£äºº  
**å†³ç­–ä¾æ®**ï¼šéƒ¨ç½²ç¯å¢ƒï¼ˆSealos Devboxï¼‰+ æ‰©å®¹éœ€æ±‚ï¼ˆå¤šå®ä¾‹/å¼¹æ€§æ‰©å®¹ï¼‰+ è®¿é—®ç­–ç•¥ï¼ˆå›¾ç‰‡å…¨éƒ¨å…¬å¼€ï¼‰+ **ä¸ä½¿ç”¨CDNæœåŠ¡**ï¼ˆæˆæœ¬æ§åˆ¶ï¼‰

### **æœ€ç»ˆé€‰å‹ï¼šSealos å¯¹è±¡å­˜å‚¨ + é¢„ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆæ–¹æ¡ˆAï¼‰+ å¯¹è±¡ key å­˜å‚¨**

| å†³ç­–ç»´åº¦              | é€‰æ‹©ç»“æœ                                | ç†ç”±                                                                        |
| --------------------- | --------------------------------------- | --------------------------------------------------------------------------- |
| **å­˜å‚¨åç«¯**          | **Sealos å¯¹è±¡å­˜å‚¨**ï¼ˆS3 å…¼å®¹ï¼‰          | å·²æœ‰åŸºç¡€è®¾æ–½ã€ç¯å¢ƒå˜é‡å·²é…ç½®å®Œæ•´                                            |
| **è®¿é—®ç­–ç•¥**          | **å…¨éƒ¨å…¬å¼€**ï¼ˆpublic-read ACLï¼‰         | æ‰€æœ‰å›¾ç‰‡å‡ä¸ºå±•ç¤ºå‹ç´ æï¼ˆå¥–å“/Banner/å•†å“ï¼‰ï¼Œæ— æ•æ„Ÿå†…å®¹                      |
| **URL æ ¼å¼**          | **âœ… å­˜å‚¨å¯¹è±¡ key**ï¼ˆéå®Œæ•´ URLï¼‰       | **å·²æ‹æ¿ç¡®è®¤**ï¼šæ”¯æŒåŸŸååˆ‡æ¢ã€å…¬æœ‰/ç§æœ‰ç­–ç•¥æ¼”è¿›ã€åŸŸåå˜æ›´ä¸æ”¹åº“             |
| **CDN åŠ é€Ÿ**          | **âŒ ä¸ä½¿ç”¨ CDN**                       | **å·²æ‹æ¿ç¡®è®¤**ï¼šæˆæœ¬æ§åˆ¶ã€ç®€åŒ–æ¶æ„ã€ç›´è¿å¯¹è±¡å­˜å‚¨å…¬ç½‘åŸŸå                    |
| **ç¼©ç•¥å›¾ç­–ç•¥**        | **âœ… é¢„ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆæ–¹æ¡ˆAï¼‰**            | **å·²æ‹æ¿ç¡®è®¤**ï¼šä¸Šä¼ æ—¶ç”¨ sharp ç”Ÿæˆ 3 æ¡£ï¼ŒåŒæ ·å­˜ Sealosï¼Œæ— çŠ¶æ€æ¶æ„         |
| **éƒ¨ç½²æ¶æ„**          | **å¤šå®ä¾‹ + å¼¹æ€§æ‰©å®¹**                   | Sealos Devbox äº‘å¹³å°éƒ¨ç½²ï¼Œæ— çŠ¶æ€æœåŠ¡                                        |
| **ä¸Šä¼ é“¾è·¯**          | **å†…ç½‘ endpoint ä¸Šä¼ **                  | èŠ‚çœæµé‡è´¹ç”¨ä¸å»¶è¿Ÿï¼ˆSealos é›†ç¾¤å†…ä¸Šä¼ ï¼‰                                     |
| **æœ¬åœ°ç£ç›˜ /uploads** | **âœ… ç«‹å³å½»åº•æ”¾å¼ƒï¼Œä¸å…¼å®¹**             | **å·²æ‹æ¿ç¡®è®¤**ï¼šé¿å…å®¹å™¨é‡å¯/æ‰©å®¹æ—¶æ–‡ä»¶ä¸ä¸€è‡´ï¼Œæ— çŠ¶æ€æœåŠ¡æ¶æ„               |
| **ç¼©ç•¥å›¾å­˜å‚¨**        | **Sealos å¯¹è±¡å­˜å‚¨**ï¼ˆä¸åŸå›¾åŒåç«¯ï¼‰     | é¢„ç”Ÿæˆ small/medium/large ä¸‰æ¡£ï¼Œå†™å…¥ `thumbnail_paths` JSON å­—æ®µ            |
| **è®¿é—®åŸŸå**          | **SEALOS_ENDPOINT**ï¼ˆå¯¹è±¡å­˜å‚¨å…¬ç½‘åŸŸåï¼‰ | æ—  CDNï¼Œç›´æ¥ç”¨ Sealos å…¬ç½‘åŸŸåï¼ˆ`https://objectstorageapi.bja.sealos.run`ï¼‰ |

### **æ ¸å¿ƒåŸåˆ™ï¼ˆåŸºäºæ‹æ¿å†³ç­– - 2026-01-08 23:15 æœ€æ–°ç‰ˆï¼‰**

- âœ… **å•ä¸€çœŸç›¸æº**ï¼š`image_resources.file_path` å­˜å‚¨åŸå›¾å¯¹è±¡ keyï¼ˆå¦‚ `prizes/xxx.jpg`ï¼‰ï¼Œ`thumbnail_paths` å­˜å‚¨ç¼©ç•¥å›¾å¯¹è±¡ keyï¼ˆJSON æ ¼å¼ï¼‰
- âœ… **æ— çŠ¶æ€æœåŠ¡**ï¼šNode åº”ç”¨ä¸ä¾èµ–æœ¬åœ°ç£ç›˜ï¼Œå®¹å™¨å¯ä»»æ„é”€æ¯/é‡å»º
- âœ… **å…¬å¼€è®¿é—®**ï¼šæ‰€æœ‰å›¾ç‰‡ ACL=public-readï¼Œæ— éœ€é‰´æƒä¸ç­¾å URL
- âœ… **ç›´è¿å¯¹è±¡å­˜å‚¨**ï¼šä¸ä½¿ç”¨ CDNï¼Œå‰ç«¯ç›´æ¥è®¿é—® `SEALOS_ENDPOINT/{bucket}/{objectKey}`
- âœ… **é¢„ç”Ÿæˆç¼©ç•¥å›¾**ï¼šä¸Šä¼ æ—¶ç”¨ `sharp` åœ¨å†…å­˜ç”Ÿæˆ 3 æ¡£ï¼ˆ150/300/600pxï¼‰ï¼Œåˆ†åˆ«ä¸Šä¼ åˆ° Sealos
- âœ… **ç¼“å­˜ç­–ç•¥**ï¼šä¾èµ–å¯¹è±¡å­˜å‚¨ `Cache-Control: max-age=31536000` + æµè§ˆå™¨ç¼“å­˜
- âœ… **å†å²æ•°æ®æ¸…ç†**ï¼š**å·²æ‹æ¿ç¡®è®¤** - çœŸå®DBä¸­ `image_resources` ä»… 1 æ¡è®°å½•ï¼ˆ`status=deleted`ï¼‰ï¼Œæ— éœ€è¿ç§»ï¼Œç›´æ¥æ¸…ç†

### **ğŸ”´ å…³é”®æ‹æ¿å†³ç­–ï¼ˆ2026-01-08 23:15 æœ€ç»ˆç¡®è®¤ - å» CDN ç‰ˆï¼‰**

| å†³ç­–é¡¹                           | é€‰æ‹©                                      | æ‰§è¡Œç­–ç•¥                                                                                                                                         |
| -------------------------------- | ----------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------ |
| **1. å›¾ç‰‡å­—æ®µç»Ÿä¸€å­˜å¯¹è±¡ key**    | **âœ… æ˜¯**                                 | æ‰€æœ‰å›¾ç‰‡å­—æ®µï¼ˆ`image_resources.file_path`ã€`popup_banners.image_url`ã€`exchange_items` ç­‰ï¼‰ç»Ÿä¸€å­˜å‚¨å¯¹è±¡ keyï¼ˆå¦‚ `prizes/xxx.jpg`ï¼‰ï¼Œä¸å­˜å®Œæ•´ URL |
| **2. æ˜¯å¦å½»åº•æ”¾å¼ƒæœ¬åœ° /uploads** | **âœ… æ˜¯ï¼Œç«‹å³æ”¾å¼ƒï¼Œä¸å…¼å®¹**               | ä¸é…ç½® `/uploads` é™æ€æ‰˜ç®¡ã€ä¸ä¿ç•™æœ¬åœ°ç£ç›˜æ–‡ä»¶ã€è¿ç§»ååˆ é™¤ç‰©ç†æ–‡ä»¶ã€æ— é™çº§å…¼å®¹æ–¹æ¡ˆ                                                               |
| **3. æ˜¯å¦ä½¿ç”¨ CDN æœåŠ¡**         | **âŒ ä¸ä½¿ç”¨**                             | **å·²æ‹æ¿ç¡®è®¤**ï¼šæˆæœ¬æ§åˆ¶ã€ç®€åŒ–æ¶æ„ã€ç›´è¿ Sealos å¯¹è±¡å­˜å‚¨å…¬ç½‘åŸŸåï¼ˆ`SEALOS_ENDPOINT`ï¼‰                                                            |
| **4. ç¼©ç•¥å›¾ç”Ÿæˆæ–¹å¼**            | **âœ… é¢„ç”Ÿæˆï¼ˆæ–¹æ¡ˆAï¼‰**                    | **å·²æ‹æ¿ç¡®è®¤**ï¼šä¸Šä¼ æ—¶ç”¨ `sharp` ç”Ÿæˆ small/medium/large ä¸‰æ¡£ï¼Œåˆ†åˆ«ä¸Šä¼ åˆ° Sealosï¼Œå†™å…¥ `thumbnail_paths` JSON å­—æ®µ                               |
| **5. å•†å“å›¾ç‰‡ä½“ç³»**              | **âœ… ç»Ÿä¸€èµ° image_resources å…³è”**        | `exchange_items` ä½¿ç”¨ç°æœ‰ `primary_image_id` å­—æ®µï¼ŒåºŸå¼ƒ `image_url` å­—æ®µï¼ˆä¿ç•™ä½œå…¼å®¹æœŸï¼‰ï¼Œ`products` ä½¿ç”¨ç°æœ‰ `primary_image_id`                 |
| **6. å†å²æ•°æ®å¤„ç†**              | **âœ… æ— éœ€è¿ç§»ï¼ˆçœŸå®DBä»…1æ¡deletedè®°å½•ï¼‰** | çœŸå®DB `image_resources` ä»… 1 æ¡è®°å½•ä¸” `status=deleted`ï¼Œç›´æ¥ç‰©ç†åˆ é™¤å³å¯ï¼Œæ— éœ€è¿ç§»                                                              |

---

## ğŸ“Š æ ¸å¿ƒç»“è®ºï¼ˆåŸºäºçœŸå®æ•°æ®å¯¹é½ï¼‰

### 1ï¸âƒ£ **Sealos å¯¹è±¡å­˜å‚¨é›†æˆç°çŠ¶**

âœ… **å·²é›†æˆä¸”å¯ç”¨**ï¼ˆä»£ç å±‚é¢ï¼‰ï¼š

- å­˜åœ¨å®Œæ•´çš„ Sealos å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼š`services/sealosStorage.js`
- åŸºäº **AWS S3 SDK** å®ç°ï¼ˆ`aws-sdk` npmåŒ…ï¼‰
- å¿…éœ€çš„ç¯å¢ƒå˜é‡ **å·²é…ç½®**ï¼ˆåœ¨å®é™…è¿è¡Œç¯å¢ƒä¸­å­˜åœ¨ï¼‰ï¼š
  - `SEALOS_ENDPOINT`ï¼šSealos å¯¹è±¡å­˜å‚¨ç«¯ç‚¹åœ°å€
  - `SEALOS_BUCKET`ï¼šå­˜å‚¨æ¡¶åç§°
  - `SEALOS_ACCESS_KEY`ï¼šè®¿é—®å¯†é’¥ ID
  - `SEALOS_SECRET_KEY`ï¼šå¯†é’¥è®¿é—®å¯†é’¥
  - `SEALOS_REGION`ï¼šå­˜å‚¨åŒºåŸŸ
  - `SEALOS_INTERNAL_ENDPOINT`ï¼šå†…ç½‘ç«¯ç‚¹ï¼ˆSealos éƒ¨ç½²ä¸“ç”¨ï¼‰

âœ… **å·²è½åœ°çš„ä¸Šä¼ é“¾è·¯**ï¼ˆä»£ç å®ç°ï¼‰ï¼š

```
ç®¡ç†ç«¯å¼¹çª— Banner ä¸Šä¼ ï¼š
å‰ç«¯ /admin/popup-banners.htmlï¼ˆmulterä¸Šä¼ ï¼‰
  â†’ åç«¯ routes/v4/console/popup-banners.jsï¼ˆupload.single('image')ï¼‰
  â†’ PopupBannerService.uploadBannerImage(req.file.buffer, req.file.originalname)
  â†’ SealosStorageService.uploadImage(fileBuffer, 'popup-banners/')
  â†’ S3 SDK ä¸Šä¼ åˆ° Sealos å¯¹è±¡å­˜å‚¨
  â†’ è¿”å›å…¬ç½‘ URLï¼ˆresult.Locationï¼‰
  â†’ æ•°æ®åº“ popup_banners.image_url å­˜å‚¨è¯¥ URL
```

âš ï¸ **ä½†çœŸå®æ•°æ®åº“å½“å‰æ— å®é™…æ•°æ®**ï¼š

- `popup_banners` è¡¨è®°å½•æ•°ï¼š**0 æ¡**
- `popup_banners.image_url` æ ·ä¾‹ï¼š**ç©º**ï¼ˆå› ä¸ºæ— è®°å½•ï¼‰

---

### 2ï¸âƒ£ **å…¶ä»–å›¾ç‰‡å­˜å‚¨é“¾è·¯çš„å®é™…å½¢æ€**

#### **å¥–å“å›¾ç‰‡ï¼ˆlottery_prizesï¼‰**

âŒ **ä¸æ˜¯ç›´æ¥å­˜ URL**ï¼Œè€Œæ˜¯é‡‡ç”¨"å›¾ç‰‡èµ„æºå…³è”è¡¨"æ¨¡å¼ï¼š

- `lottery_prizes.image_id` â†’ å¤–é”®å…³è” `image_resources.image_id`
- `image_resources.file_path` å­˜å‚¨è·¯å¾„ï¼ˆå½“å‰ DB æ ·ä¾‹ï¼‰ï¼š
  - `"/prizes/prize_001.jpg"`
  - `"/uploads/test_receipt.jpg"`
- **æ•°æ®å½¢æ€**ï¼šæœ¬åœ°è·¯å¾„æ ¼å¼ï¼ˆ`/å¼€å¤´`ï¼‰ï¼Œä¸æ˜¯ Sealos å…¬ç½‘ URL

#### **å•†å“å›¾ç‰‡ï¼ˆproducts / exchange_itemsï¼‰**

- `products.image` / `products.premium_image`ï¼šå½“å‰ DB æ ·ä¾‹ä¸ºç©º
- `exchange_items.image_url`ï¼šå½“å‰ DB æ ·ä¾‹ä¸ºç©º
- ä»…æœ‰ 1 æ¡ `products.premium_image` æ ·ä¾‹ï¼š`"https://example.com/premium_0.jpg"`ï¼ˆç¤ºä¾‹æ•°æ®ï¼‰

#### **ç”¨æˆ·å¤´åƒï¼ˆusersï¼‰**

- `users.avatar_url`ï¼š**å­—æ®µä¸å­˜åœ¨**ï¼ˆå½“å‰ DB schema ä¸­ç”¨æˆ·è¡¨æ— æ­¤å­—æ®µï¼‰
- å‰ç«¯é¡µé¢ï¼ˆ`public/admin/users.html`ï¼‰ä½¿ç”¨ Base64 SVG é»˜è®¤å¤´åƒï¼ˆçº¯å‰ç«¯å¤„ç†ï¼‰

#### **å®é™…æœ¬åœ°å›¾ç‰‡æ–‡ä»¶ï¼ˆç‰©ç†éªŒè¯ï¼‰**

âœ… **æœ¬åœ° uploads ç›®å½•ç¡®å®æœ‰çœŸå®æ–‡ä»¶**ï¼š

- ç›®å½•ï¼š`/home/devbox/project/uploads/`
- æ–‡ä»¶æ•°ï¼šçº¦ 27 å¼ å›¾ç‰‡ï¼ˆ`mh3*.jpg/png` + `thumbnails/`ï¼‰
- è¯´æ˜ï¼šå­˜åœ¨æœ¬åœ°ç£ç›˜å­˜å‚¨çš„å®é™…ä½¿ç”¨é“¾è·¯

---

### 3ï¸âƒ£ **å›¾ç‰‡è®¿é—®é“¾è·¯çš„ä»£ç è¦†ç›–åº¦åˆ†æ**

#### **âœ… å·²æ˜ç¡®å®ç° Sealos ä¸Šä¼ çš„ä¸šåŠ¡**

| ä¸šåŠ¡æ¨¡å—    | ä»£ç è·¯å¾„                             | å­˜å‚¨åç«¯            | URL æ ¼å¼                      |
| ----------- | ------------------------------------ | ------------------- | ----------------------------- |
| å¼¹çª— Banner | `routes/v4/console/popup-banners.js` | **Sealos å¯¹è±¡å­˜å‚¨** | `result.Location`ï¼ˆå…¬ç½‘ URLï¼‰ |

#### **â“ å­˜å‚¨åç«¯ä¸æ˜ç¡®/æœªå®ç°çš„ä¸šåŠ¡**

| ä¸šåŠ¡æ¨¡å— | å­—æ®µä½ç½®                    | å½“å‰ DB æ•°æ®                 | ä»£ç è·¯å¾„                        | é—®é¢˜                       |
| -------- | --------------------------- | ---------------------------- | ------------------------------- | -------------------------- |
| å¥–å“å›¾ç‰‡ | `image_resources.file_path` | `"/prizes/xxx.jpg"` æœ¬åœ°è·¯å¾„ | ç®¡ç†ç«¯ `prizes.html` é€‰å›¾ä¸ä¸Šä¼  | `image_id: null`ï¼ˆä¸å†™å…¥ï¼‰ |
| å•†å“å›¾ç‰‡ | `exchange_items.image_url`  | ç©º                           | æœªæ‰¾åˆ°ä¸Šä¼ è·¯ç”±                  | æ— å®é™…æ•°æ®                 |
| ç”¨æˆ·å¤´åƒ | ä¸å­˜åœ¨                      | N/A                          | å‰ç«¯ Base64 é»˜è®¤å¤´åƒ            | æ— åç«¯å­˜å‚¨                 |

#### **âš ï¸ æœ¬åœ°é™æ€æ‰˜ç®¡ç¼ºå¤±é£é™©**

- **ä»£ç æ£€æŸ¥**ï¼š`app.js` åªæ‰˜ç®¡äº† `/admin` â†’ `public/admin/`ï¼Œ**æœªæ‰˜ç®¡ `/uploads`**
- **é£é™©**ï¼šDB ä¸­å­˜å‚¨ä¸º `"/uploads/xxx.jpg"` çš„è·¯å¾„ï¼Œå½“å‰æ— å¯¹åº”çš„ Express é™æ€ä¸­é—´ä»¶ï¼Œå¯èƒ½å¯¼è‡´ 404
- **å¯èƒ½çš„å¤–éƒ¨æ‰˜ç®¡**ï¼šå¦‚æœçº¿ä¸Šå›¾ç‰‡èƒ½è®¿é—®ï¼Œåˆ™æ˜¯åœ¨"Ingress/API ç½‘å…³/Nginx"å±‚åšçš„é™æ€ç›®å½•æ˜ å°„ï¼ˆæ­¤éƒ¨åˆ†ä¸åœ¨ Node ä»£ç ä¸­ï¼‰

---

## ğŸ—„ï¸ çœŸå®æ•°æ®åº“æ•°æ®å¿«ç…§ï¼ˆ2026-01-07 21:49:56 åŒ—äº¬æ—¶é—´ï¼‰

### **æ ¸å¿ƒä¸šåŠ¡è¡¨è®°å½•æ•°ç»Ÿè®¡**

```json
{
  "users": 23,
  "roles": 7,
  "user_roles": 15,
  "lottery_campaigns": 1,
  "lottery_prizes": 9,
  "lottery_draws": 1,
  "lottery_presets": 2,
  "system_settings": 18,
  "popup_banners": 0,
  "accounts": 15,
  "account_asset_balances": 11,
  "asset_transactions": 846,
  "exchange_items": 24,
  "exchange_records": 0,
  "redemption_orders": 188,
  "trade_orders": 0,
  "trade_records": 2,
  "market_listings": 0,
  "consumption_records": 0,
  "content_review_records": 0,
  "customer_service_sessions": 1,
  "chat_messages": 0,
  "image_resources": 3
}
```

### **å…³é”®ä¸šåŠ¡é…ç½®ï¼ˆsystem_settings çœŸå®æ•°æ®ï¼‰**

| é…ç½®é¡¹                    | å€¼       | è¯´æ˜                    |
| ------------------------- | -------- | ----------------------- |
| `lottery_cost_points`     | **100**  | å•æ¬¡æŠ½å¥–æ¶ˆè€—ç§¯åˆ†        |
| `daily_lottery_limit`     | **50**   | æ¯æ—¥æŠ½å¥–æ¬¡æ•°ä¸Šé™        |
| `budget_allocation_ratio` | **0.24** | é¢„ç®—åˆ†é…æ¯”ä¾‹ï¼ˆ24%ï¼‰     |
| `initial_points`          | **200**  | æ–°ç”¨æˆ·åˆå§‹ç§¯åˆ†          |
| `sign_in_points`          | **20**   | ç­¾åˆ°èµ é€ç§¯åˆ†            |
| `points_expire_days`      | **365**  | ç§¯åˆ†æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰        |
| `max_active_listings`     | **10**   | ç”¨æˆ·æœ€å¤šåŒæ—¶æŒ‚ç‰Œæ•°      |
| `api_rate_limit`          | **100**  | API é¢‘ç‡é™åˆ¶ï¼ˆæ¬¡/åˆ†é’Ÿï¼‰ |

### **èµ„äº§ä½“ç³»çœŸå®æ•°æ®åˆ†å¸ƒ**

| èµ„äº§ä»£ç        | è´¦æˆ·æ•° | å¯ç”¨ä½™é¢æ€»è®¡ | å†»ç»“ä½™é¢æ€»è®¡ |
| -------------- | ------ | ------------ | ------------ |
| `POINTS`       | 7      | 48,352       | 0            |
| `red_shard`    | 2      | 37,360       | 0            |
| `DIAMOND`      | 1      | 105,900      | 0            |
| `MATERIAL_001` | 1      | 100          | 0            |

### **å›¾ç‰‡èµ„æºè¡¨çœŸå®æ•°æ®ï¼ˆimage_resources - 2026-01-08 æœ€æ–°æ ¸æŸ¥ï¼‰**

**çœŸå®DBæ•°æ®ï¼ˆNode.js + Sequelize ç›´è¿ï¼‰**ï¼š

| image_id | file_path              | business_type | category    | status  | created_at          |
| -------- | ---------------------- | ------------- | ----------- | ------- | ------------------- |
| 1        | `prizes/prize_001.jpg` | lottery       | prize_image | deleted | 2025-09-23 01:15:43 |

**âœ… å…³é”®å‘ç°ï¼ˆä¸å†å²æŠ¥å‘Šå¯¹é½ï¼‰**ï¼š

- **çœŸå®DBä»…1æ¡è®°å½•**ï¼ˆéå†å²æŠ¥å‘Šä¸­çš„3æ¡ï¼‰
- `file_path` å·²æ˜¯ **å¯¹è±¡ key æ ¼å¼**ï¼ˆ`prizes/xxx.jpg`ï¼Œæ—  `/` å¼€å¤´ï¼‰
- è¯¥è®°å½• `status=deleted`ï¼ˆå·²è½¯åˆ é™¤ï¼‰
- **æ—  `user_upload_review` ç±»å‹æ•°æ®**ï¼ˆçœŸå®DBä¸­ä¸å­˜åœ¨ï¼Œå†å²æŠ¥å‘Šæœ‰è¯¯ï¼‰

**è¿ç§»å½±å“è¯„ä¼°**ï¼š

- âœ… æ— éœ€è¿ç§»å†å²æ•°æ®ï¼ˆä»…1æ¡å·²åˆ é™¤è®°å½•ï¼‰
- âœ… æ— éœ€æ¸…ç† `user_upload_review`ï¼ˆçœŸå®DBä¸­ä¸å­˜åœ¨ï¼‰
- âœ… å¯ç›´æ¥ä»"ç©ºç™½çŠ¶æ€"å¼€å§‹å®æ–½æ–°æ¶æ„

---

## ğŸ—ï¸ ä¸šåŠ¡é€»è¾‘ä¸å•†ä¸šæ¨¡å¼é—­ç¯ï¼ˆä¸çœŸå®æ•°æ®å¯¹é½ï¼‰

### **æ ¸å¿ƒä¸šåŠ¡æµç¨‹å›¾**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    1. ç”¨æˆ·è·å®¢ä¸ç§¯åˆ†è·å–                              â”‚
â”‚                                                                       â”‚
â”‚  æ–°ç”¨æˆ·æ³¨å†Œ â†’ èµ é€200ç§¯åˆ†ï¼ˆinitial_pointsï¼‰                           â”‚
â”‚  ç”¨æˆ·ç­¾åˆ°   â†’ èµ é€20ç§¯åˆ†/æ¬¡ï¼ˆsign_in_pointsï¼‰                         â”‚
â”‚  å•†å®¶æ¶ˆè´¹   â†’ æ¶ˆè´¹å‡­è¯å®¡æ ¸ï¼ˆconsumption_records + content_reviewï¼‰    â”‚
â”‚             â†’ å®¡æ ¸é€šè¿‡åé‡Šæ”¾å†»ç»“ç§¯åˆ†                                   â”‚
â”‚                                                                       â”‚
â”‚  æ•°æ®éªŒè¯ï¼šå½“å‰ DB æœ‰ 23 ä¸ªç”¨æˆ·ï¼Œ0 æ¡æ¶ˆè´¹è®°å½•ï¼ˆå¯èƒ½æœªå¼€å¯/æµ‹è¯•ç¯å¢ƒï¼‰   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                   â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    2. æ ¸å¿ƒæ¶ˆè€— - ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ                         â”‚
â”‚                                                                       â”‚
â”‚  ç”¨æˆ·æ¶ˆè€—ç§¯åˆ† â†’ æ¯æ¬¡æŠ½å¥–æ‰£é™¤ 100 ç§¯åˆ†ï¼ˆlottery_cost_pointsï¼‰          â”‚
â”‚              â†’ æ¯æ—¥é™é¢ 50 æ¬¡ï¼ˆdaily_lottery_limitï¼‰                  â”‚
â”‚              â†’ æŠ½ä¸­å¥–å“ï¼ˆlottery_prizes å…± 9 ä¸ªå¥–å“ï¼‰                 â”‚
â”‚              â†’ å¥–å“å…¥èƒŒåŒ…ï¼ˆitem_instances æˆ–ææ–™èµ„äº§ä½™é¢ï¼‰            â”‚
â”‚                                                                       â”‚
â”‚  ä¿åº•æœºåˆ¶ï¼šè¿ç»­æœªä¸­å¥– â†’ consecutive_fail_count ç´¯åŠ  â†’ è§¦å‘ä¿åº•        â”‚
â”‚                                                                       â”‚
â”‚  æ•°æ®éªŒè¯ï¼šå½“å‰ DB æœ‰ 1 æ¡æŠ½å¥–è®°å½•ï¼ˆlottery_drawsï¼‰ï¼Œæ¶ˆè€— 100 ç§¯åˆ†    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                   â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    3. èµ„äº§ä½“ç³» - å¯å åŠ èµ„äº§ + äº¤æ˜“å¸ç§                â”‚
â”‚                                                                       â”‚
â”‚  A. å¯å åŠ èµ„äº§ï¼ˆaccount_asset_balancesï¼‰                             â”‚
â”‚     - POINTSï¼ˆç§¯åˆ†ï¼‰ï¼šç”¨äºæŠ½å¥–æ¶ˆè€—ã€è‡»é€‰ç©ºé—´è§£é”                      â”‚
â”‚     - DIAMONDï¼ˆé’»çŸ³ï¼‰ï¼šC2C äº¤æ˜“å¸‚åœºç»“ç®—å¸ç§                           â”‚
â”‚     - MATERIAL_XXXï¼ˆææ–™ï¼‰ï¼šè™šæ‹Ÿå¥–å“ã€å…‘æ¢å•†å“æ¶ˆè€—                    â”‚
â”‚     - red_shardï¼ˆçº¢ç¢ç‰‡ï¼‰ç­‰ï¼šåˆæˆ/è½¬æ¢ææ–™                            â”‚
â”‚                                                                       â”‚
â”‚  B. ä¸å¯å åŠ ç‰©å“ï¼ˆitem_instancesï¼‰                                   â”‚
â”‚     - å®ç‰©åˆ¸ã€ä¼˜æƒ åˆ¸ç­‰å”¯ä¸€ç‰©å“                                        â”‚
â”‚     - å…³è”æ ¸é”€ç ï¼ˆredemption_ordersï¼Œå½“å‰ 188 æ¡è®°å½•ï¼‰                â”‚
â”‚                                                                       â”‚
â”‚  æ•°æ®éªŒè¯ï¼š11 ä¸ªè´¦æˆ·èµ„äº§ä½™é¢è®°å½•ï¼Œ846 æ¡èµ„äº§æµæ°´è®°å½•                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                   â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    4. å˜ç°è·¯å¾„ - C2C äº¤æ˜“å¸‚åœºæ‰‹ç»­è´¹                   â”‚
â”‚                                                                       â”‚
â”‚  å–å®¶æŒ‚ç‰Œç‰©å“ â†’ ä¹°å®¶ç”¨ DIAMOND è´­ä¹° â†’ æˆäº¤åæ‰‹ç»­è´¹æ‹†åˆ†ï¼š             â”‚
â”‚                                                                       â”‚
â”‚  ä¹°å®¶æ”¯ä»˜ï¼šgross_amountï¼ˆæ€»é¢ï¼‰                                       â”‚
â”‚          = fee_amountï¼ˆæ‰‹ç»­è´¹ï¼Œ5%ï¼‰+ net_amountï¼ˆå–å®¶å®æ”¶ï¼Œ95%ï¼‰      â”‚
â”‚                                                                       â”‚
â”‚  æ‰‹ç»­è´¹å»å‘ï¼šå…¥è´¦ SYSTEM_PLATFORM_FEE ç³»ç»Ÿè´¦æˆ·ï¼ˆå¹³å°æ”¶å…¥ï¼‰            â”‚
â”‚                                                                       â”‚
â”‚  é…ç½®æ¥æºï¼šconfig/fee_rules.js                                        â”‚
â”‚    - é»˜è®¤è´¹ç‡ï¼š5%ï¼ˆmarket_purchase.fixed_rate: 0.05ï¼‰                â”‚
â”‚    - è´¹ç”¨ç­–ç•¥ï¼šmonetizeï¼ˆå¹³å°æ”¶å…¥ï¼‰                                   â”‚
â”‚    - æ”¶è´¹å¯¹è±¡ï¼šsellerï¼ˆå–å®¶æ‰¿æ‹…ï¼‰                                     â”‚
â”‚    - æœ€å°æ‰‹ç»­è´¹ï¼š1 DIAMOND                                            â”‚
â”‚                                                                       â”‚
â”‚  æ•°æ®éªŒè¯ï¼šå½“å‰ DB æœ‰ 0 æ¡äº¤æ˜“è®¢å•ï¼ˆmarket_listings=0ï¼Œtrade_orders=0ï¼‰â”‚
â”‚           è¯´æ˜è¯¥é“¾è·¯å½“å‰æµ‹è¯•ç¯å¢ƒæœªå¯ç”¨æˆ–æ— å®é™…äº¤æ˜“æ•°æ®                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                   â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    5. å±¥çº¦ä¸å…‘ç° - B2C å•†åŸ + æ ¸é”€ç                   â”‚
â”‚                                                                       â”‚
â”‚  ç”¨æˆ·ç”¨ææ–™èµ„äº§å…‘æ¢å•†å“ï¼ˆexchange_itemsï¼Œ24 ä¸ªå•†å“ï¼‰                  â”‚
â”‚                      â†“                                                â”‚
â”‚  ç”Ÿæˆæ ¸é”€ç ï¼ˆredemption_ordersï¼Œå½“å‰ 188 æ¡è®°å½•ï¼‰                     â”‚
â”‚             â†“                                                         â”‚
â”‚  ç”¨æˆ·åˆ°åº—/çº¿ä¸‹æ ¸é”€ â†’ å•†å®¶ç¡®è®¤ â†’ è®¢å•å®Œæˆ                              â”‚
â”‚                                                                       â”‚
â”‚  æ•°æ®éªŒè¯ï¼šæ ¸é”€ç è®°å½•ï¼ˆ188ï¼‰>> å…‘æ¢è®¢å•è®°å½•ï¼ˆ0ï¼‰ï¼Œè¯´æ˜ï¼š              â”‚
â”‚    - æ ¸é”€ç ç³»ç»Ÿæ´»è·ƒåº¦é«˜ï¼ˆå¯èƒ½æ ¸é”€ç ç‹¬ç«‹å‘æ”¾ï¼Œä¸ä¸€å®šå…³è”å…‘æ¢è®¢å•ï¼‰     â”‚
â”‚    - æˆ–å…‘æ¢è®¢å•å°šæœªé€šè¿‡å½“å‰æµç¨‹èµ°åˆ° exchange_records è¡¨               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ–¼ï¸ å›¾ç‰‡å­˜å‚¨æ¶æ„è¯¦ç»†æ ¸æŸ¥

### **A. å¼¹çª— Banner å›¾ç‰‡ï¼ˆpopup_bannersï¼‰**

#### å­˜å‚¨åç«¯ï¼š**Sealos å¯¹è±¡å­˜å‚¨ï¼ˆå·²é›†æˆï¼‰**

**ä»£ç å®ç°è·¯å¾„**ï¼š

1. ç®¡ç†ç«¯é¡µé¢ï¼š`public/admin/popup-banners.html`
   - ä¸Šä¼ ç»„ä»¶ï¼š`<input type="file" accept="image/*">`
   - æ–‡ä»¶ç±»å‹ï¼šJPG/PNG/GIF/WebP
   - å¤§å°é™åˆ¶ï¼šæœ€å¤§ 5MB

2. åç«¯è·¯ç”±ï¼š`routes/v4/console/popup-banners.js`

   ```javascript
   router.post('/', adminAuthMiddleware, upload.single('image'), async (req, res) => {
     const PopupBannerService = req.app.locals.services.getService('popupBanner')

     // ä¸Šä¼ å›¾ç‰‡åˆ° Sealos
     const imageUrl = await PopupBannerService.uploadBannerImage(
       req.file.buffer,
       req.file.originalname
     )

     // æ•°æ®åº“å­˜å‚¨ URL
     const banner = await PopupBannerService.createBanner({
       title: title.trim(),
       image_url: imageUrl // âœ… Sealos å…¬ç½‘ URL
       // ...
     })
   })
   ```

3. Sealos ä¸Šä¼ å®ç°ï¼š`services/PopupBannerService.js` â†’ `services/sealosStorage.js`
   ```javascript
   async uploadBannerImage(fileBuffer, originalName) {
     const storageService = new SealosStorageService()
     const imageUrl = await storageService.uploadImage(
       fileBuffer,
       originalName,
       'popup-banners'  // å¯¹è±¡å­˜å‚¨æ–‡ä»¶å¤¹è·¯å¾„
     )
     return imageUrl  // è¿”å›ï¼šhttps://{endpoint}/{bucket}/popup-banners/{timestamp}_{hash}.jpg
   }
   ```

**çœŸå®æ•°æ®åº“æ•°æ®**ï¼š

- è¡¨è®°å½•æ•°ï¼š**0 æ¡**ï¼ˆpopup_bannersï¼‰
- è¯´æ˜ï¼šåŠŸèƒ½å·²å®ç°ï¼Œä½†å½“å‰æµ‹è¯•ç¯å¢ƒå°šæœªåˆ›å»ºä»»ä½• Banner

**éªŒè¯è·¯å¾„**ï¼š

```bash
# æ­¥éª¤ 1ï¼šé€šè¿‡ç®¡ç†åå°åˆ›å»ºä¸€æ¡ Bannerï¼ˆå¸¦å›¾ç‰‡ä¸Šä¼ ï¼‰
è®¿é—®ï¼šhttp://localhost:3000/admin/popup-banners.html
æ“ä½œï¼šç‚¹å‡»"æ·»åŠ å¼¹çª—" â†’ ä¸Šä¼ å›¾ç‰‡ â†’ å¡«å†™æ ‡é¢˜ â†’ ä¿å­˜

# æ­¥éª¤ 2ï¼šæŸ¥çœ‹æ•°æ®åº“å®é™…å­˜å‚¨çš„ URL æ ¼å¼
SELECT banner_id, image_url FROM popup_banners ORDER BY created_at DESC LIMIT 1;
# é¢„æœŸï¼šimage_url åº”ä¸º https://{sealos-endpoint}/...å½¢å¼çš„å…¬ç½‘ URL

# æ­¥éª¤ 3ï¼šéªŒè¯å›¾ç‰‡å¯è®¿é—®æ€§
curl -I <æ­¥éª¤2è¿”å›çš„image_url>
# é¢„æœŸï¼šHTTP 200ï¼ŒContent-Type: image/...
```

---

### **B. å¥–å“å›¾ç‰‡ï¼ˆlottery_prizesï¼‰**

#### å­˜å‚¨åç«¯ï¼š**å›¾ç‰‡èµ„æºå…³è”è¡¨æ¨¡å¼ï¼ˆæœ¬åœ°è·¯å¾„ï¼‰**

**è®¾è®¡æ¶æ„**ï¼š

- `lottery_prizes.image_id` â†’ å¤–é”®å…³è” `image_resources.image_id`
- `image_resources.file_path` å­˜å‚¨è·¯å¾„ï¼ˆç›¸å¯¹è·¯å¾„ï¼‰
- è®¿é—® URL æ‹¼æ¥ï¼š`/uploads/${file_path}`ï¼ˆä»£ç è§ `models/ImageResources.js`ï¼‰

**çœŸå®æ•°æ®åº“æ•°æ®**ï¼š

- `lottery_prizes` è¡¨ï¼š9 æ¡è®°å½•ï¼Œä½† **æ‰€æœ‰ `image_id` å‡ä¸º NULL**ï¼ˆå¥–å“æ— å…³è”å›¾ç‰‡ï¼‰
- `image_resources` è¡¨ï¼š3 æ¡è®°å½•
  ```json
  [
    { "file_path": "/prizes/prize_001.jpg" },
    { "file_path": "/uploads/test_receipt.jpg" },
    { "file_path": "/uploads/test_receipt.jpg" }
  ]
  ```

**ç®¡ç†ç«¯ä¸Šä¼ é“¾è·¯åˆ†æ**ï¼š

- é¡µé¢ä½ç½®ï¼š`public/admin/prizes.html`
- ä¸Šä¼ ç»„ä»¶ï¼šå­˜åœ¨ `<input type="file" id="prizeImageInput">`
- **å…³é”®é—®é¢˜**ï¼šåç«¯æäº¤ä»£ç å†™æ­» `image_id: null`
  ```javascript
  // prizes.html ç¬¬540è¡Œ
  const prizeData = {
    name: document.getElementById('prizeName').value,
    type: document.getElementById('prizeType').value,
    value: parseFloat(document.getElementById('prizeValue').value) || 0,
    // ...
    image_id: null // âŒ å†™æ­»ä¸º nullï¼Œå³ä½¿å‰ç«¯é€‰äº†å›¾ç‰‡ä¹Ÿä¸ä¸Šä¼ 
  }
  ```

**é—®é¢˜è¯Šæ–­**ï¼š

- âŒ **å‰ç«¯æœ‰é€‰å›¾ç•Œé¢ï¼Œä½†åç«¯é€»è¾‘æœªå®ç°å›¾ç‰‡ä¸Šä¼ **
- âŒ **æ‰¹é‡æ·»åŠ å¥–å“ API ä¸æ¥å—å›¾ç‰‡æ–‡ä»¶**ï¼ˆ`routes/v4/console/prize_pool.js` æ—  `upload.single('image')`ï¼‰
- âš ï¸ **å½“å‰å¥–å“å›¾ç‰‡éœ€è¦æ‰‹åŠ¨ç»´æŠ¤ `image_resources` è¡¨å¹¶å…³è” `image_id`**

---

### **C. å•†å“å›¾ç‰‡ï¼ˆexchange_items / productsï¼‰**

#### å­˜å‚¨åç«¯ï¼š**æœªå®ç°ä¸Šä¼ é“¾è·¯**

**æ•°æ®åº“å­—æ®µ**ï¼š

- `exchange_items.image_url`ï¼ˆVARCHAR 500ï¼‰
- `products.image`ï¼ˆTEXTï¼‰
- `products.premium_image`ï¼ˆTEXTï¼‰

**çœŸå®æ•°æ®åº“æ•°æ®**ï¼š

- `exchange_items`ï¼š24 æ¡è®°å½•ï¼Œ**æ‰€æœ‰ `image_url` å‡ä¸º NULL**
- `products`ï¼š52 æ¡è®°å½•ï¼Œä»… 1 æ¡æœ‰ `premium_image`ï¼ˆå€¼ï¼š`"https://example.com/premium_0.jpg"`ï¼Œç¤ºä¾‹æ•°æ®ï¼‰

**ä»£ç æ£€æŸ¥ç»“æœ**ï¼š

- âŒ **æœªæ‰¾åˆ°å•†å“å›¾ç‰‡ä¸Šä¼ è·¯ç”±**ï¼ˆ`routes/v4/shop/*` æ— å›¾ç‰‡ä¸Šä¼ ä¸­é—´ä»¶ï¼‰
- âŒ **æœªæ‰¾åˆ° `exchange_items` çš„å›¾ç‰‡ä¸Šä¼ æœåŠ¡è°ƒç”¨**

**é—®é¢˜è¯Šæ–­**ï¼š

- å½“å‰å•†å“å›¾ç‰‡ä¸ºç©ºæˆ–ç¤ºä¾‹æ•°æ®ï¼Œè¯´æ˜ï¼š
  - å¯èƒ½é€šè¿‡ SQL æ‰‹åŠ¨æ’å…¥å›¾ç‰‡ URLï¼ˆè¿è¥ç»´æŠ¤ï¼‰
  - æˆ–è¯¥åŠŸèƒ½å°šæœªå¼€å‘å®Œæ•´çš„ä¸Šä¼ ç•Œé¢

---

### **D. ç”¨æˆ·å¤´åƒï¼ˆusers.avatar_urlï¼‰**

#### å­˜å‚¨åç«¯ï¼š**å­—æ®µä¸å­˜åœ¨**

**æ•°æ®åº“ Schema æ£€æŸ¥**ï¼š

- `users` è¡¨å­—æ®µåˆ—è¡¨ï¼ˆæ¥è‡ª `SHOW COLUMNS`ï¼‰ï¼š
  - âœ… æœ‰ï¼š`user_id`, `mobile`, `nickname`, `status`, `consecutive_fail_count`, `history_total_points`
  - âŒ **æ— **ï¼š`avatar_url` æˆ–ç±»ä¼¼å­—æ®µ

**å‰ç«¯å¤„ç†æ–¹å¼**ï¼š

- ç®¡ç†ç«¯ç”¨æˆ·åˆ—è¡¨ï¼ˆ`public/admin/users.html`ï¼‰ä½¿ç”¨ **Base64 å†…è” SVG é»˜è®¤å¤´åƒ**
  ```javascript
  const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0i...'
  ```
- æ— åç«¯å­˜å‚¨å’Œä¸Šä¼ é“¾è·¯

**è®¾è®¡å†³ç­–**ï¼š

- å½“å‰æ¶æ„**ä¸æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰å¤´åƒ**
- å¦‚éœ€å¤´åƒåŠŸèƒ½ï¼Œéœ€åœ¨ `users` è¡¨æ·»åŠ  `avatar_url` å­—æ®µå¹¶å®ç°ä¸Šä¼ é“¾è·¯

---

## ğŸ” é™æ€æ–‡ä»¶è®¿é—®é“¾è·¯æ ¸æŸ¥

### **Express é™æ€ä¸­é—´ä»¶é…ç½®**

**ä»£ç ä½ç½®**ï¼š`app.js` ç¬¬ 510-527 è¡Œ

```javascript
app.use(
  '/admin',
  express.static(path.join(__dirname, 'public/admin'), {
    index: false,
    maxAge: process.env.NODE_ENV === 'production' ? '1h' : 0
    // ...
  })
)
```

**æ‰˜ç®¡èŒƒå›´**ï¼š

- âœ… **å·²æ‰˜ç®¡**ï¼š`/admin` â†’ `public/admin/`ï¼ˆç®¡ç†åå°é™æ€æ–‡ä»¶ï¼‰
- âŒ **æœªæ‰˜ç®¡**ï¼š`/uploads` ç›®å½•ï¼ˆç‰©ç†æ–‡ä»¶å­˜åœ¨ï¼Œä½†æ— é™æ€æœåŠ¡ï¼‰

### **å›¾ç‰‡è®¿é—®ç¼ºå£åˆ†æ**

| å­˜å‚¨ä½ç½®        | ç‰©ç†è·¯å¾„                             | Express æ‰˜ç®¡ | è®¿é—®è·¯å¾„              | çŠ¶æ€    |
| --------------- | ------------------------------------ | ------------ | --------------------- | ------- |
| `uploads/`      | `/home/devbox/project/uploads/`      | âŒ æœªé…ç½®    | æ— æ³•é€šè¿‡ Node è®¿é—®    | âš ï¸ ç¼ºå£ |
| `public/admin/` | `/home/devbox/project/public/admin/` | âœ… `/admin`  | `http://host/admin/*` | âœ… æ­£å¸¸ |

**é£é™©è¯†åˆ«**ï¼š

- å½“å‰ DB ä¸­ `image_resources.file_path` å­˜å‚¨ä¸º `"/uploads/xxx.jpg"`
- ä½† `app.js` æœªé…ç½® `/uploads` é™æ€æ‰˜ç®¡
- **å¯èƒ½çš„å¤–éƒ¨æ‰˜ç®¡æ–¹å¼**ï¼š
  1. Ingress/API ç½‘å…³å±‚é…ç½®äº†é™æ€ç›®å½•æ˜ å°„
  2. æˆ–ä½ åœ¨ Sealos/äº‘å¹³å°éƒ¨ç½²æ—¶å•ç‹¬é…ç½®äº†å¯¹è±¡å­˜å‚¨/CDNæ˜ å°„
  3. æˆ–è¯¥è·¯å¾„ç›®å‰ç¡®å®æ— æ³•è®¿é—®ï¼ˆæ­»é“¾ï¼‰

**ä¿®å¤æ–¹æ¡ˆï¼ˆå¦‚éœ€æœ¬åœ°é™æ€æ‰˜ç®¡ï¼‰**ï¼š

```javascript
// app.js ä¸­æ·»åŠ ï¼ˆåœ¨ /admin é™æ€æ‰˜ç®¡ä¹‹åï¼‰
app.use(
  '/uploads',
  express.static(path.join(__dirname, 'uploads'), {
    maxAge: process.env.NODE_ENV === 'production' ? '7d' : 0,
    etag: true,
    lastModified: true
  })
)
```

---

## ğŸ¦ å•†ä¸šæ¨¡å¼ä¸å˜ç°è·¯å¾„ï¼ˆåŸºäºçœŸå®æ•°æ®ï¼‰

### **å˜ç°æ¨¡å¼æ ¸å¿ƒè¦ç´ **

#### **1. æ”¶å…¥æ¥æºï¼šC2C äº¤æ˜“å¸‚åœºæ‰‹ç»­è´¹**

**ä¸šåŠ¡æµç¨‹**ï¼š

```
ç”¨æˆ· A ä¸Šæ¶ç‰©å“ï¼ˆæ ‡ä»· 1000 DIAMONDï¼‰
  â†’ ç”¨æˆ· B è´­ä¹°
  â†’ å¹³å°æ”¶å– 5% æ‰‹ç»­è´¹ï¼ˆ50 DIAMONDï¼‰
  â†’ å–å®¶å®æ”¶ 95%ï¼ˆ950 DIAMONDï¼‰
  â†’ æ‰‹ç»­è´¹å…¥è´¦ SYSTEM_PLATFORM_FEE ç³»ç»Ÿè´¦æˆ·
```

**é…ç½®è§„åˆ™**ï¼ˆ`config/fee_rules.js`ï¼‰ï¼š

- æ‰‹ç»­è´¹ç‡ï¼š**5%**ï¼ˆmarket_purchase.fixed_rateï¼‰
- æ”¶è´¹å¯¹è±¡ï¼š**å–å®¶**ï¼ˆbuyer æ”¯ä»˜å…¨é¢ï¼Œseller å®æ”¶æ‰£é™¤æ‰‹ç»­è´¹åé‡‘é¢ï¼‰
- ç­–ç•¥ï¼š**monetize**ï¼ˆå¹³å°æ”¶å…¥ï¼Œè®°å…¥ç³»ç»Ÿè´¦æˆ·ï¼‰
- æœ€å°æ‰‹ç»­è´¹ï¼š**1 DIAMOND**

**æ•°æ®åº“éªŒè¯**ï¼š

- `accounts` è¡¨ä¸­å­˜åœ¨ç³»ç»Ÿè´¦æˆ·ï¼š
  - `SYSTEM_PLATFORM_FEE`ï¼ˆå¹³å°æ‰‹ç»­è´¹è´¦æˆ·ï¼‰
  - `SYSTEM_ESCROW`ï¼ˆæ‰˜ç®¡è´¦æˆ·ï¼‰
  - `SYSTEM_MINT`ï¼ˆç³»ç»Ÿå‘æ”¾ï¼‰
  - `SYSTEM_BURN`ï¼ˆç³»ç»Ÿé”€æ¯ï¼‰
- `trade_orders` è¡¨è®¾è®¡å­—æ®µï¼š
  - `gross_amount`ï¼šä¹°å®¶æ”¯ä»˜æ€»é¢
  - `fee_amount`ï¼šå¹³å°æ‰‹ç»­è´¹
  - `net_amount`ï¼šå–å®¶å®æ”¶é‡‘é¢
- **å½“å‰æ— å®é™…äº¤æ˜“æ•°æ®**ï¼ˆtrade_orders=0ï¼‰

#### **2. é¢„ç®—æ§åˆ¶ï¼šæŠ½å¥–æˆæœ¬ç®¡ç†**

**é¢„ç®—åˆ†é…æœºåˆ¶**ï¼ˆ`budget_allocation_ratio = 0.24`ï¼‰ï¼š

- ç”¨æˆ·æ¶ˆè€— 100 ç§¯åˆ†æŠ½å¥– â†’ å¹³å°é¢„ç®—åˆ†é… 24 ç§¯åˆ†ç”¨äºå¥–å“ä»·å€¼
- é¢„ç®—æ¯”ä¾‹ï¼š24%ï¼ˆå¯åŠ¨æ€è°ƒæ•´ï¼‰
- å¥–å“ä»·å€¼æ€»å’Œä¸è¶…è¿‡é¢„ç®—æ± ï¼Œç¡®ä¿å¹³å°ç›ˆåˆ©

**æ•°æ®éªŒè¯**ï¼š

- å½“å‰ 1 æ¡æŠ½å¥–è®°å½•æ¶ˆè€— 100 ç§¯åˆ†
- ç³»ç»Ÿé…ç½® `budget_allocation_ratio=0.24` åœ¨çœŸå® DB ä¸­å­˜åœ¨

#### **3. ç”¨æˆ·ç•™å­˜ï¼šè‡»é€‰ç©ºé—´è§£é”ï¼ˆä»˜è´¹åŠŸèƒ½ï¼‰**

**ä¸šåŠ¡è§„åˆ™**ï¼ˆ`services/PremiumService.js`ï¼‰ï¼š

- è§£é”æ¡ä»¶ï¼š
  - å†å²ç´¯è®¡ç§¯åˆ† â‰¥ 100,000ï¼ˆ`history_total_points`ï¼‰
  - å½“å‰å¯ç”¨ç§¯åˆ† â‰¥ 100ï¼ˆæ”¯ä»˜èƒ½åŠ›ï¼‰
- è§£é”æˆæœ¬ï¼š**100 ç§¯åˆ†**
- æœ‰æ•ˆæœŸï¼š**24 å°æ—¶**ï¼ˆ`VALIDITY_HOURS=24`ï¼‰
- åŠŸèƒ½æƒç›Šï¼šæ‰©å±•èƒŒåŒ…/é«˜çº§åŠŸèƒ½ï¼ˆå…·ä½“æƒç›Šç”±ä¸šåŠ¡å®šä¹‰ï¼‰

**æ•°æ®éªŒè¯**ï¼š

- `user_premium_status` è¡¨å­˜åœ¨ï¼ˆç”¨æˆ·é«˜çº§ç©ºé—´çŠ¶æ€ï¼‰
- å½“å‰æ— å®é™…è§£é”è®°å½•

---

## ğŸ“¦ æœ¬åœ°ç£ç›˜å›¾ç‰‡æ–‡ä»¶å¿«ç…§

### **uploads/ ç›®å½•ç‰©ç†æ–‡ä»¶ç»Ÿè®¡**

**æ–‡ä»¶æ•°é‡**ï¼šçº¦ 27 å¼ å›¾ç‰‡
**æ–‡ä»¶å‘½åè§„åˆ™**ï¼š`mh3{éšæœºå­—ç¬¦}_{UUID}.{jpg|png}`

**æ ·ä¾‹æ–‡ä»¶**ï¼š

```
mh3jg0gk_297dbf6d-ae45-4052-8322-5e2c01f8aea9.jpg
mh3jkbis_34a12469-9874-434e-88bc-3e6601b92c48.jpg
mh3qcvft_d8b4f1eb-ecce-40e5-8dec-c24856ce56fa.jpg
mh3r1vpr_17102218-bc95-4e4d-ba24-60bab7bf9d3c.png
...
thumbnails/  ï¼ˆç¼©ç•¥å›¾ç›®å½•ï¼‰
```

**å‘½ååˆ†æ**ï¼š

- æ—¶é—´æˆ³å‰ç¼€ï¼š`mh3...`ï¼ˆç–‘ä¼¼ BeijingTimeHelper.timestamp() çš„æŸç§ç¼–ç ï¼‰
- UUID åç¼€ï¼šæ ‡å‡† UUIDv4 æ ¼å¼
- è¯´æ˜ï¼šå­˜åœ¨æœ¬åœ°ä¸Šä¼ é“¾è·¯çš„å®é™…ä½¿ç”¨ç—•è¿¹

**ç¼©ç•¥å›¾æœåŠ¡**ï¼š

- ä»£ç ï¼š`services/ThumbnailService.js`
- åŠŸèƒ½ï¼šåŸºäº `sharp` åº“ç”Ÿæˆ small/medium/large ä¸‰æ¡£ç¼©ç•¥å›¾
- å­˜å‚¨ï¼š`uploads/thumbnails/` ç›®å½•
- **å½“å‰æ•°æ®åº“ä¸­æ— ç¼©ç•¥å›¾è®°å½•**ï¼ˆ`image_resources.thumbnail_paths` æ ·ä¾‹ä¸ºç©ºï¼‰

---

## ğŸš¨ å…³é”®é£é™©ä¸é—®é¢˜è¯†åˆ«

### **P0 çº§é£é™©ï¼ˆå½±å“åŠŸèƒ½å¯ç”¨æ€§ï¼‰**

#### **1. æœ¬åœ°å›¾ç‰‡è®¿é—®è·¯å¾„ç¼ºå¤±**

**é—®é¢˜æè¿°**ï¼š

- DB ä¸­ `image_resources.file_path` å­˜å‚¨ä¸º `"/uploads/test_receipt.jpg"`
- ä½† `app.js` **æœªé…ç½® `/uploads` é™æ€æ‰˜ç®¡**
- å¦‚æœå‰ç«¯å°è¯•è®¿é—® `GET /uploads/test_receipt.jpg`ï¼Œä¼šå¾—åˆ° **404**

**å½±å“èŒƒå›´**ï¼š

- ç”¨æˆ·ä¸Šä¼ çš„æ¶ˆè´¹å‡­è¯å›¾ç‰‡ï¼ˆ`user_upload_review`ï¼‰æ— æ³•æŸ¥çœ‹
- å¥–å“å›¾ç‰‡ï¼ˆå¦‚æœä½¿ç”¨æœ¬åœ°è·¯å¾„ï¼‰æ— æ³•å±•ç¤º

**è§£å†³æ–¹æ¡ˆ**ï¼š

```javascript
// æ–¹æ¡ˆ1ï¼šæ·»åŠ é™æ€æ‰˜ç®¡ï¼ˆapp.jsï¼‰
app.use(
  '/uploads',
  express.static(path.join(__dirname, 'uploads'), {
    maxAge: process.env.NODE_ENV === 'production' ? '7d' : 0
  })
)

// æ–¹æ¡ˆ2ï¼šè¿ç§»åˆ° Sealos å¯¹è±¡å­˜å‚¨ï¼ˆæ¨èï¼‰
// å°†æ‰€æœ‰æœ¬åœ°å›¾ç‰‡è¿ç§»åˆ° Sealosï¼Œæ›´æ–° image_resources.file_path ä¸ºå…¬ç½‘ URL
```

#### **2. å¥–å“å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½æœªå®ç°**

**é—®é¢˜æè¿°**ï¼š

- ç®¡ç†ç«¯å¥–å“é¡µé¢æœ‰å›¾ç‰‡é€‰æ‹©å™¨ï¼ˆ`<input type="file" id="prizeImageInput">`ï¼‰
- ä½†æäº¤ä»£ç å†™æ­» `image_id: null`ï¼ˆç¬¬ 540 è¡Œï¼‰
- åç«¯æ‰¹é‡æ·»åŠ å¥–å“ API ä¸æ¥å—å›¾ç‰‡æ–‡ä»¶ï¼ˆæ—  `upload.single('image')`ï¼‰

**å½±å“èŒƒå›´**ï¼š

- ç®¡ç†å‘˜æ— æ³•é€šè¿‡ Web ç•Œé¢ä¸Šä¼ å¥–å“å›¾ç‰‡
- å¥–å“å›¾ç‰‡éœ€è¦æ‰‹åŠ¨ç»´æŠ¤æ•°æ®åº“ï¼ˆæ’å…¥ `image_resources` å¹¶æ›´æ–° `lottery_prizes.image_id`ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š

```javascript
// æ–¹æ¡ˆ1ï¼šå¥–å“å›¾ç‰‡ä¸Šä¼ åˆ° Sealosï¼ˆæ¨èï¼‰
// 1. åœ¨ routes/v4/console/prize_pool.js æ·»åŠ  upload.single('image')
// 2. è°ƒç”¨ SealosStorageService.uploadImage()
// 3. å°†è¿”å›çš„ URL å­˜å…¥ image_resources.file_path
// 4. å…³è” lottery_prizes.image_id

// æ–¹æ¡ˆ2ï¼šå¥–å“å›¾ç‰‡æœ¬åœ°å­˜å‚¨
// 1. åŒä¸Šï¼Œä½†æ–‡ä»¶ä¿å­˜åˆ° uploads/prizes/
// 2. file_path å­˜å‚¨ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚ "prizes/xxx.jpg"ï¼‰
// 3. ç¡®ä¿ /uploads å·²é™æ€æ‰˜ç®¡
```

### **P1 çº§é—®é¢˜ï¼ˆæ¶æ„ä¸€è‡´æ€§ï¼‰**

#### **3. å›¾ç‰‡å­˜å‚¨ç­–ç•¥æ··åˆä¸ä¸€è‡´**

**é—®é¢˜æè¿°**ï¼š

- å¼¹çª— Bannerï¼šèµ° **Sealos å¯¹è±¡å­˜å‚¨**ï¼ˆå…¬ç½‘ URLï¼‰
- å›¾ç‰‡èµ„æºè¡¨ï¼šèµ° **æœ¬åœ°è·¯å¾„**ï¼ˆ`/uploads/...`ï¼‰
- å¥–å“å›¾ç‰‡ï¼š**æœªå®ç°ä¸Šä¼ **ï¼ˆå­—æ®µå­˜åœ¨ä½†æ— æ•°æ®ï¼‰

**é£é™©åˆ†æ**ï¼š

- URL æ ¼å¼ä¸ç»Ÿä¸€ï¼šæœ‰äº›æ˜¯ `https://...`ï¼Œæœ‰äº›æ˜¯ `/uploads/...`
- å‰ç«¯æ‹¼æ¥é€»è¾‘å¤æ‚ï¼šéœ€åˆ¤æ–­å­—æ®µæ˜¯å®Œæ•´ URL è¿˜æ˜¯è·¯å¾„ç‰‡æ®µ
- éƒ¨ç½²çµæ´»æ€§å·®ï¼šå¯¹è±¡å­˜å‚¨ä¸æœ¬åœ°ç£ç›˜æ··ç”¨ï¼Œå¤šå®ä¾‹éƒ¨ç½²æ—¶å®¹æ˜“å‡ºç°æ–‡ä»¶ä¸ä¸€è‡´

**âœ… å·²æ‹æ¿ç­–ç•¥ï¼ˆ2026-01-08 23:15 æœ€ç»ˆç¡®è®¤ç‰ˆ - å» CDN + é¢„ç”Ÿæˆç¼©ç•¥å›¾ï¼‰**ï¼š

```
ğŸ¯ ç»Ÿä¸€æ–¹æ¡ˆï¼šSealos å¯¹è±¡å­˜å‚¨ + é¢„ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆæ–¹æ¡ˆAï¼‰+ å¯¹è±¡ key å­˜å‚¨
â”œâ”€â”€ å­˜å‚¨æ ¼å¼ï¼šfile_path å­˜å‚¨åŸå›¾å¯¹è±¡ keyï¼ˆå¦‚ prizes/xxx.jpgï¼‰ï¼Œéå®Œæ•´ URLã€âœ… å·²æ‹æ¿ç¡®è®¤ã€‘
â”œâ”€â”€ ç¼©ç•¥å›¾å­˜å‚¨ï¼šthumbnail_paths å­˜å‚¨ 3 æ¡£ç¼©ç•¥å›¾å¯¹è±¡ keyï¼ˆJSON æ ¼å¼ï¼‰ã€âœ… å·²æ‹æ¿ç¡®è®¤æ–¹æ¡ˆAã€‘
â”œâ”€â”€ URL ç”Ÿæˆï¼šAPI å±‚æ ¹æ® key ç”Ÿæˆå®Œæ•´ URLï¼ˆç›´è¿ SEALOS_ENDPOINTï¼Œæ—  CDNï¼‰
â”œâ”€â”€ è®¿é—®ç­–ç•¥ï¼šå…¨éƒ¨ public-readï¼ˆæ— æ•æ„Ÿå›¾ç‰‡ï¼‰
â”œâ”€â”€ CDN åŠ é€Ÿï¼šâŒ ä¸ä½¿ç”¨ CDN æœåŠ¡ã€âœ… å·²æ‹æ¿ç¡®è®¤ï¼šæˆæœ¬æ§åˆ¶ã€ç®€åŒ–æ¶æ„ã€‘
â”œâ”€â”€ ç¼©ç•¥å›¾ç”Ÿæˆï¼šä¸Šä¼ æ—¶ç”¨ sharp åœ¨å†…å­˜ç”Ÿæˆ small/medium/large ä¸‰æ¡£ï¼Œåˆ†åˆ«ä¸Šä¼ åˆ° Sealosã€âœ… å·²æ‹æ¿ç¡®è®¤æ–¹æ¡ˆAã€‘
â”œâ”€â”€ ä¸Šä¼ é“¾è·¯ï¼šå†…ç½‘ endpointï¼ˆSealos é›†ç¾¤å†…ï¼‰+ å…¬ç½‘è®¿é—®ï¼ˆSEALOS_ENDPOINTï¼‰
â””â”€â”€ å†å²æ•°æ®ï¼šçœŸå®DBä»…1æ¡deletedè®°å½•ï¼Œç›´æ¥ç‰©ç†åˆ é™¤å³å¯ã€âœ… å·²æ‹æ¿ç¡®è®¤ï¼šæ— éœ€è¿ç§»ã€‘

ä¸šåŠ¡æ¨¡å—å®æ–½ç­–ç•¥ï¼š
â”œâ”€â”€ popup_banners.image_urlï¼šå­˜å¯¹è±¡ keyï¼ˆâœ… ä»£ç å·²å®ç°ï¼‰
â”œâ”€â”€ image_resources.file_pathï¼šå­˜åŸå›¾å¯¹è±¡ key + thumbnail_paths å­˜ç¼©ç•¥å›¾ keyï¼ˆâœ… å­—æ®µå·²å­˜åœ¨ï¼‰
â”œâ”€â”€ lottery_prizes.image_idï¼šå…³è” image_resources + å¤ç”¨é€šç”¨ä¸Šä¼ æ¥å£ï¼ˆğŸ”„ å¾…å®ç°å‰ç«¯è°ƒç”¨ï¼‰
â”œâ”€â”€ exchange_items.primary_image_idï¼šç›´æ¥ä½¿ç”¨ï¼ˆâœ… å­—æ®µå·²å­˜åœ¨ï¼ŒçœŸå®DBå·²éªŒè¯ï¼‰
â”œâ”€â”€ products.primary_image_idï¼šä½œä¸ºä¸»å›¾å…³è”ï¼ˆâœ… å­—æ®µå·²å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨ï¼‰
â””â”€â”€ exchange_items.image_url / products.image/premium_imageï¼šåºŸå¼ƒå­—æ®µï¼ˆä¿ç•™ä½œå…¼å®¹æœŸï¼‰

ç«‹å³æ‰§è¡Œï¼ˆä¸å…¼å®¹æ—§æ–¹æ¡ˆï¼‰ï¼š
âœ… å½»åº•æ”¾å¼ƒæœ¬åœ°ç£ç›˜ /uploadsã€å·²æ‹æ¿ç¡®è®¤ï¼šç«‹å³æ”¾å¼ƒï¼Œä¸å…¼å®¹ã€‘
âœ… ä¸é…ç½® /uploads é™æ€æ‰˜ç®¡ï¼ˆapp.js ä¸æ·»åŠ  express.staticï¼‰
âœ… åˆ é™¤ uploads/ ç‰©ç†æ–‡ä»¶ï¼ˆå¤‡ä»½ååˆ é™¤ï¼ŒçœŸå®DBæ— ä¾èµ–ï¼‰
âœ… åˆ é™¤å”¯ä¸€çš„ deleted è®°å½•ï¼ˆimage_id=1ï¼Œstatus=deletedï¼‰ã€âœ… å·²æ‹æ¿ç¡®è®¤ï¼šç›´æ¥ç‰©ç†åˆ é™¤ã€‘

ä¸å†å®æ–½ï¼š
âŒ ç”¨æˆ·è‡ªä¸Šä¼ å‡­è¯å®¡æ ¸åŠŸèƒ½ï¼ˆçœŸå®DBä¸­ä¸å­˜åœ¨ï¼ŒåŠŸèƒ½æœªå¯ç”¨ï¼‰
âŒ URL å‚æ•°åŒ–ç¼©ç•¥å›¾ï¼ˆæ”¹ç”¨é¢„ç”Ÿæˆç¼©ç•¥å›¾æ–¹æ¡ˆAï¼‰ã€âœ… å·²æ‹æ¿ç¡®è®¤æ–¹æ¡ˆAã€‘
âŒ CDN é›†æˆï¼ˆä¸ä½¿ç”¨ CDN æœåŠ¡ï¼‰ã€âœ… å·²æ‹æ¿ç¡®è®¤ï¼šå» CDNã€‘
âŒ æœ¬åœ°ç£ç›˜é™æ€æ‰˜ç®¡ï¼ˆ/uploads ä¸å†é…ç½®ï¼‰
âŒ æœ¬åœ°è·¯å¾„å…¼å®¹æ–¹æ¡ˆï¼ˆä¸å…¼å®¹ï¼Œç›´æ¥åˆ‡æ¢ï¼‰
```

#### **4. ç¼©ç•¥å›¾æœåŠ¡ç­–ç•¥è°ƒæ•´**

**é—®é¢˜æè¿°**ï¼š

- `ThumbnailService` åŸºäºæœ¬åœ°ç£ç›˜ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆä½¿ç”¨ `sharp` åº“ï¼‰
- ä»£ç å‡è®¾åŸå§‹æ–‡ä»¶åœ¨ `uploads/` ç›®å½•
- å¦‚æœåŸå§‹æ–‡ä»¶åœ¨ Sealosï¼Œå½“å‰é€»è¾‘ä¼šå¤±è´¥

**âœ… å·²æ‹æ¿ç­–ç•¥ï¼ˆ2026-01-08 23:15 æœ€ç»ˆç¡®è®¤ - å» CDN ç‰ˆï¼‰**ï¼š

- **é‡‡ç”¨é¢„ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆæ–¹æ¡ˆ Aï¼‰**ã€âœ… å·²æ‹æ¿ç¡®è®¤ã€‘
- ä¸Šä¼ æ—¶ç”¨ `sharp` åœ¨å†…å­˜ç”Ÿæˆ small/medium/large ä¸‰æ¡£ç¼©ç•¥å›¾
- åŸå›¾ + 3 æ¡£ç¼©ç•¥å›¾åˆ†åˆ«ä¸Šä¼ åˆ° Sealos å¯¹è±¡å­˜å‚¨ï¼ˆå…± 4 ä¸ªå¯¹è±¡ï¼‰
- ç¼©ç•¥å›¾å¯¹è±¡ key å†™å…¥ `image_resources.thumbnail_paths` JSON å­—æ®µ
- **ä¸ä½¿ç”¨ CDN æœåŠ¡**ã€âœ… å·²æ‹æ¿ç¡®è®¤ã€‘ï¼šç›´è¿ Sealos å¯¹è±¡å­˜å‚¨å…¬ç½‘åŸŸå

**å®æ–½æ–¹æ¡ˆ**ï¼š

```javascript
// services/sealosStorage.js æ–°å¢æ–¹æ³•
async uploadImageWithThumbnails(fileBuffer, originalName, folder = 'photos') {
  // 1. ä¸Šä¼ åŸå›¾
  const originalKey = await this.uploadImage(fileBuffer, originalName, folder)

  // 2. ç”Ÿæˆå¹¶ä¸Šä¼  3 æ¡£ç¼©ç•¥å›¾
  const sharp = require('sharp')
  const sizes = {
    small: { width: 150, height: 150 },
    medium: { width: 300, height: 300 },
    large: { width: 600, height: 600 }
  }

  const thumbnailKeys = {}
  for (const [sizeName, dimensions] of Object.entries(sizes)) {
    const thumbnailBuffer = await sharp(fileBuffer)
      .resize(dimensions.width, dimensions.height, { fit: 'cover', position: 'center' })
      .jpeg({ quality: 80 })
      .toBuffer()

    const thumbnailKey = await this.uploadImage(
      thumbnailBuffer,
      `${sizeName}_${originalName}`,
      `${folder}/thumbnails`
    )
    thumbnailKeys[sizeName] = thumbnailKey
  }

  return { originalKey, thumbnailKeys }
}

// utils/ImageUrlHelper.js æ”¹é€ ï¼ˆå» CDNï¼‰
function getImageUrl(objectKey) {
  if (!objectKey) return null

  // å…¼å®¹å†å²å®Œæ•´ URL
  if (objectKey.startsWith('http://') || objectKey.startsWith('https://')) {
    return objectKey
  }

  // å…¼å®¹å†å²æœ¬åœ°è·¯å¾„ï¼ˆ/å¼€å¤´ï¼‰
  if (objectKey.startsWith('/')) {
    objectKey = objectKey.substring(1)
  }

  // ç›´è¿ Sealos å¯¹è±¡å­˜å‚¨å…¬ç½‘åŸŸåï¼ˆæ—  CDNï¼‰
  const sealosEndpoint = process.env.SEALOS_ENDPOINT
  const bucket = process.env.SEALOS_BUCKET

  if (!sealosEndpoint || !bucket) {
    console.warn('âŒ ImageUrlHelper: ç¼ºå°‘ SEALOS_ENDPOINT æˆ– SEALOS_BUCKET ç¯å¢ƒå˜é‡')
    return null
  }

  return `${sealosEndpoint}/${bucket}/${objectKey}`
}

// ä½¿ç”¨ç¤ºä¾‹
getImageUrl('prizes/abc123.jpg')
// è¾“å‡ºï¼šhttps://objectstorageapi.bja.sealos.run/tiangong/prizes/abc123.jpg

getThumbnailUrl('prizes/abc123.jpg', 'medium')
// è¾“å‡ºï¼šhttps://objectstorageapi.bja.sealos.run/tiangong/prizes/thumbnails/medium_abc123.jpg
```

**æŠ€æœ¯ä¼˜åŠ¿**ï¼š

- âœ… æ— éœ€ä¾èµ– CDN å›¾ç‰‡å¤„ç†èƒ½åŠ›ï¼ˆè‡ªä¸»å¯æ§ï¼‰
- âœ… çœŸæ­£å‡å°‘å¸¦å®½æ¶ˆè€—ï¼ˆå‰ç«¯åŠ è½½å°å›¾ï¼ŒéåŸå›¾ï¼‰
- âœ… ä¿æŒæ— çŠ¶æ€æ¶æ„ï¼ˆç¼©ç•¥å›¾å­˜ Sealosï¼Œä¸è½æœ¬åœ°ç›˜ï¼‰
- âœ… æˆæœ¬å¯æ§ï¼ˆä»…å¯¹è±¡å­˜å‚¨è´¹ç”¨ï¼Œæ—  CDN è´¹ç”¨ï¼‰

---

## ğŸ¯ è½åœ°éªŒè¯æ¸…å•ï¼ˆåˆ†é˜¶æ®µæ‰§è¡Œï¼‰

### **é˜¶æ®µ 1ï¼šéªŒè¯ Sealos åŠŸèƒ½å¯ç”¨æ€§ï¼ˆç«‹å³æ‰§è¡Œï¼‰**

- [ ] **æ­¥éª¤ 1.1**ï¼šè®¿é—®ç®¡ç†åå°å¼¹çª—é¡µé¢

  ```bash
  è®¿é—®ï¼šhttp://localhost:3000/admin/popup-banners.html
  éªŒè¯ï¼šé¡µé¢åŠ è½½æ­£å¸¸ï¼Œå¯çœ‹åˆ°å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ
  ```

- [ ] **æ­¥éª¤ 1.2**ï¼šåˆ›å»ºä¸€æ¡æµ‹è¯• Bannerï¼ˆä¸Šä¼ å›¾ç‰‡ï¼‰

  ```
  æ“ä½œï¼šç‚¹å‡»"æ·»åŠ å¼¹çª—" â†’ ä¸Šä¼ ä»»æ„å›¾ç‰‡ï¼ˆ<5MBï¼‰ â†’ å¡«å†™æ ‡é¢˜ â†’ ä¿å­˜
  é¢„æœŸï¼šä¿å­˜æˆåŠŸï¼Œè¿”å›æˆåŠŸæç¤º
  ```

- [ ] **æ­¥éª¤ 1.3**ï¼šæ£€æŸ¥æ•°æ®åº“å®é™…å­˜å‚¨çš„ URL

  ```sql
  SELECT banner_id, title, image_url, created_at
  FROM popup_banners
  ORDER BY created_at DESC
  LIMIT 1;
  ```

  **é¢„æœŸç»“æœ**ï¼š
  - `image_url` åº”ä¸º `https://{sealos-endpoint}/...` æ ¼å¼çš„å®Œæ•´ URL
  - é `"/uploads/..."` æˆ– `null`

- [ ] **æ­¥éª¤ 1.4**ï¼šéªŒè¯å›¾ç‰‡å¯å…¬ç½‘è®¿é—®
  ```bash
  curl -I <æ­¥éª¤1.3è¿”å›çš„image_url>
  ```
  **é¢„æœŸç»“æœ**ï¼š
  - HTTP çŠ¶æ€ç ï¼š200 OK
  - Content-Typeï¼šimage/jpeg æˆ– image/png
  - å¯é€šè¿‡æµè§ˆå™¨ç›´æ¥æ‰“å¼€

### **é˜¶æ®µ 2ï¼šæ ¸æŸ¥æœ¬åœ°å›¾ç‰‡è®¿é—®çŠ¶æ€ï¼ˆæ’æŸ¥æ–­é“¾ï¼‰**

- [ ] **æ­¥éª¤ 2.1**ï¼šå°è¯•è®¿é—®æ•°æ®åº“ä¸­çš„æœ¬åœ°è·¯å¾„

  ```bash
  # æ–¹å¼1ï¼šç›´æ¥è®¿é—® Node æœåŠ¡
  curl http://localhost:3000/uploads/test_receipt.jpg

  # æ–¹å¼2ï¼šè®¿é—®çº¿ä¸ŠåŸŸåï¼ˆå¦‚æœå·²éƒ¨ç½²ï¼‰
  curl https://omqktqrtntnn.sealosbja.site/uploads/test_receipt.jpg
  ```

  **é¢„æœŸç»“æœ**ï¼š
  - å¦‚æœè¿”å› **404**ï¼šè¯´æ˜ Node ä¾§æ— é™æ€æ‰˜ç®¡ï¼Œéœ€è¦é…ç½®æˆ–è¿ç§»åˆ° Sealos
  - å¦‚æœè¿”å› **200**ï¼šè¯´æ˜ç½‘å…³å±‚æœ‰é™æ€æ‰˜ç®¡ï¼Œå½“å‰é“¾è·¯å¯ç”¨

- [ ] **æ­¥éª¤ 2.2**ï¼šæ£€æŸ¥ç‰©ç†æ–‡ä»¶æ˜¯å¦å­˜åœ¨

  ```bash
  ls -lh /home/devbox/project/uploads/test_receipt.jpg
  ```

- [ ] **æ­¥éª¤ 2.3**ï¼šéªŒè¯å›¾ç‰‡æ•°æ®åº“è®°å½•ä¸æ–‡ä»¶å¯¹åº”å…³ç³»
  ```sql
  SELECT image_id, file_path, original_filename, file_size, business_type
  FROM image_resources
  WHERE file_path LIKE '%test_receipt%';
  ```

### **é˜¶æ®µ 3ï¼šå•†ä¸šæ¨¡å¼æ ¸å¿ƒé“¾è·¯éªŒè¯ï¼ˆä¸šåŠ¡å®Œæ•´æ€§ï¼‰**

- [ ] **æ­¥éª¤ 3.1**ï¼šéªŒè¯äº¤æ˜“å¸‚åœºæ‰‹ç»­è´¹è´¦æˆ·

  ```sql
  SELECT account_id, account_type, system_code, status, created_at
  FROM accounts
  WHERE system_code = 'SYSTEM_PLATFORM_FEE';
  ```

  **é¢„æœŸ**ï¼šè‡³å°‘ 1 æ¡è®°å½•ï¼ˆå¹³å°æ‰‹ç»­è´¹è´¦æˆ·ï¼‰

- [ ] **æ­¥éª¤ 3.2**ï¼šéªŒè¯æ‰‹ç»­è´¹å…¥è´¦æµæ°´

  ```sql
  SELECT COUNT(*) AS fee_transactions_count,
         COALESCE(SUM(delta_amount), 0) AS total_fee_collected
  FROM asset_transactions
  WHERE account_id IN (
    SELECT account_id FROM accounts WHERE system_code = 'SYSTEM_PLATFORM_FEE'
  ) AND delta_amount > 0;
  ```

  **é¢„æœŸ**ï¼šèƒ½çœ‹åˆ°æ‰‹ç»­è´¹ç´¯è®¡å…¥è´¦é‡‘é¢ï¼ˆå¦‚æœæœ‰å®é™…äº¤æ˜“ï¼‰

- [ ] **æ­¥éª¤ 3.3**ï¼šéªŒè¯æŠ½å¥–æˆæœ¬é…ç½®ä¸å®é™…æ¶ˆè€—

  ```sql
  -- é…ç½®
  SELECT setting_value
  FROM system_settings
  WHERE setting_key = 'lottery_cost_points';

  -- å®é™…æ¶ˆè€—ç»Ÿè®¡
  SELECT COUNT(*) AS total_draws,
         COALESCE(SUM(cost_points), 0) AS total_cost
  FROM lottery_draws;
  ```

  **å½“å‰æ•°æ®**ï¼š
  - é…ç½®ï¼š100 ç§¯åˆ†/æ¬¡
  - å®é™…ï¼š1 æ¬¡æŠ½å¥–ï¼Œæ¶ˆè€— 100 ç§¯åˆ†ï¼ˆä¸€è‡´ï¼‰

- [ ] **æ­¥éª¤ 3.4**ï¼šéªŒè¯æ ¸é”€ç ç³»ç»Ÿæ´»è·ƒåº¦
  ```sql
  SELECT COUNT(*) AS total_redemption_codes,
         COUNT(CASE WHEN status='pending' THEN 1 END) AS pending,
         COUNT(CASE WHEN status='redeemed' THEN 1 END) AS redeemed,
         COUNT(CASE WHEN status='expired' THEN 1 END) AS expired
  FROM redemption_orders;
  ```
  **å½“å‰æ•°æ®**ï¼š188 æ¡æ ¸é”€ç è®°å½•ï¼ˆè¯´æ˜è¯¥é“¾è·¯æ´»è·ƒï¼‰

### **é˜¶æ®µ 4ï¼šå›¾ç‰‡å­˜å‚¨ç­–ç•¥å†³ç­–éªŒè¯ï¼ˆé•¿æœŸè§„åˆ’ï¼‰**

- [ ] **æ­¥éª¤ 4.1**ï¼šç»Ÿè®¡å„ç±»å›¾ç‰‡çš„å®é™…ä½¿ç”¨é‡

  ```sql
  SELECT business_type,
         category,
         COUNT(*) AS count,
         COUNT(CASE WHEN file_path LIKE 'http%' THEN 1 END) AS sealos_count,
         COUNT(CASE WHEN file_path LIKE '/uploads/%' THEN 1 END) AS local_count
  FROM image_resources
  GROUP BY business_type, category;
  ```

- [ ] **æ­¥éª¤ 4.2**ï¼šè¯„ä¼° Sealos è´¹ç”¨ä¸æœ¬åœ°å­˜å‚¨æˆæœ¬

  ```
  è®¡ç®—å› ç´ ï¼š
  - Sealos å¯¹è±¡å­˜å‚¨è´¹ç”¨ï¼šå­˜å‚¨è´¹ç”¨ + æµé‡è´¹ç”¨
  - æœ¬åœ°å­˜å‚¨ï¼šç£ç›˜ç©ºé—´ + å¤‡ä»½æˆæœ¬ + å¤šå®ä¾‹åŒæ­¥æˆæœ¬
  - CDN åŠ é€Ÿéœ€æ±‚ï¼šå›¾ç‰‡è®¿é—®é¢‘ç‡ Ã— æµé‡å•ä»·
  ```

- [x] **æ­¥éª¤ 4.3**ï¼šç¡®å®šç»Ÿä¸€ç­–ç•¥ï¼ˆâœ… å·²æ‹æ¿ï¼‰
  - **âœ… é€‰å®šç­–ç•¥**ï¼š**å…¨é¢ Sealos å¯¹è±¡å­˜å‚¨ï¼ˆç­–ç•¥ Aï¼‰**
    - éƒ¨ç½²ç¯å¢ƒï¼šSealos äº‘å¹³å°ï¼ˆå®¹å™¨åŒ–éƒ¨ç½²ï¼‰
    - æ‰©å®¹éœ€æ±‚ï¼šå¤šå®ä¾‹ + å¼¹æ€§æ‰©å®¹
    - è®¿é—®ç­–ç•¥ï¼šå›¾ç‰‡å…¬å¼€å¯è®¿é—®ï¼ˆpublic-read ACLï¼‰
    - å­˜å‚¨åç«¯ï¼šç»Ÿä¸€ä½¿ç”¨ Sealos å¯¹è±¡å­˜å‚¨ï¼ˆS3 å…¼å®¹ï¼‰
    - URL æ ¼å¼ï¼šå®Œæ•´å…¬ç½‘ URLï¼ˆ`https://{endpoint}/{bucket}/...`ï¼‰
  - **âŒ ä¸é‡‡ç”¨ç­–ç•¥ B**ï¼ˆæœ¬åœ°ç£ç›˜ + é™æ€æ‰˜ç®¡ï¼‰
    - ç†ç”±ï¼šå¤šå®ä¾‹éƒ¨ç½²æ—¶æœ¬åœ°ç£ç›˜ä¸åŒæ­¥
    - ç†ç”±ï¼šå®¹å™¨é‡å¯/è¿ç§»å®¹æ˜“ä¸¢å¤±æ–‡ä»¶
    - ç†ç”±ï¼šå¤‡ä»½ä¸å®¹ç¾æˆæœ¬é«˜

---

## ğŸ’¡ æŠ€æœ¯å€ºåŠ¡ä¸æ”¹è¿›å»ºè®®ï¼ˆåŸºäºå·²æ‹æ¿å†³ç­–ï¼‰

### **çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2å‘¨å†…ï¼‰- P0 çº§åˆ«**

#### **1. å®ç°å¥–å“å›¾ç‰‡ä¸Šä¼ é“¾è·¯**ï¼ˆç®¡ç†ç«¯æ€¥éœ€åŠŸèƒ½ï¼‰

**âœ… å·²æ‹æ¿å®æ–½æ–¹æ¡ˆï¼ˆ2026-01-08 22:30 æœ€ç»ˆç¡®è®¤ï¼‰**ï¼š

- **é‡‡ç”¨å•ç‹¬ä¸Šä¼ æ¥å£**ï¼ˆå·¥ç¨‹ä¸Šæœ€åˆç†ï¼Œæ–‡ä»¶æµä¸ JSON åˆ†ç¦»ï¼‰
- **å­˜å‚¨å¯¹è±¡ key**ï¼ˆéå®Œæ•´ URLï¼Œæ”¯æŒ CDN åˆ‡æ¢ï¼‰ã€âœ… å·²æ‹æ¿ç¡®è®¤ã€‘
- **å…³è” `image_resources` è¡¨**ï¼ˆå›¾åº“æ¨¡å¼ï¼Œæ”¯æŒå¤šå›¾/å®¡æ ¸æ‰©å±•ï¼‰

**å®æ–½æ­¥éª¤**ï¼š

**æ­¥éª¤ 1ï¼šæ–°å¢å¥–å“å›¾ç‰‡ä¸Šä¼ æ¥å£**

- è·¯ç”±ï¼š`POST /api/v4/console/prize-pool/upload-image`
- ä¸­é—´ä»¶ï¼š`upload.single('image')`
- é€»è¾‘ï¼š
  1. ä¸Šä¼ åˆ° Sealosï¼ˆä½¿ç”¨å†…ç½‘ endpointï¼Œæ–‡ä»¶å¤¹ `prizes/`ï¼‰
  2. æå–å¯¹è±¡ keyï¼ˆå¦‚ `prizes/20260108_abc123.jpg`ï¼‰
  3. åˆ›å»º `image_resources` è®°å½•ï¼š
     - `file_path = objectKey`ï¼ˆä»…å­˜ keyï¼‰
     - `business_type = 'lottery'`
     - `category = 'prize_image'`
  4. è¿”å› `image_id` å’Œ CDN URLï¼ˆä¾›å‰ç«¯é¢„è§ˆï¼‰

**æ­¥éª¤ 2ï¼šæ”¹é€  `batch-add` æ¥å— `image_id`**

- `routes/v4/console/prize_pool.js`ï¼š`batch-add` æ¥å£æ¥å— `prizes[].image_id` å‚æ•°
- å‰ç«¯ï¼šå…ˆè°ƒç”¨ä¸Šä¼ æ¥å£è·å¾— `image_id`ï¼Œå†æäº¤å¥–å“æ•°æ®

**æ­¥éª¤ 3ï¼šå‰ç«¯æ”¹é€ **

- `public/admin/prizes.html`ï¼š
  1. ç§»é™¤ `image_id: null` ç¡¬ç¼–ç ï¼ˆç¬¬ 540 è¡Œï¼‰
  2. å›¾ç‰‡é€‰æ‹©åå…ˆè°ƒç”¨ä¸Šä¼ æ¥å£
  3. ä¸Šä¼ æˆåŠŸåå°† `image_id` å†™å…¥ `prizeData`

**é¢„æœŸæ”¶ç›Š**ï¼š

- âœ… ç®¡ç†å‘˜å¯é€šè¿‡ Web ç•Œé¢ä¸Šä¼ å¥–å“å›¾ç‰‡
- âœ… å›¾ç‰‡è‡ªåŠ¨ä¸Šä¼ åˆ° Sealos å¯¹è±¡å­˜å‚¨ï¼ˆå†…ç½‘ endpointï¼‰
- âœ… æ•°æ®åº“å…³è”å…³ç³»å®Œæ•´ï¼ˆ`lottery_prizes.image_id` â†’ `image_resources.image_id`ï¼‰
- âœ… æ”¯æŒ CDN åŸŸååˆ‡æ¢ï¼ˆä»…æ”¹ URL ç”Ÿæˆè§„åˆ™ï¼Œä¸æ”¹åº“ï¼‰

#### **2. å†å²æœ¬åœ°å›¾ç‰‡æ‰¹é‡è¿ç§»åˆ° Sealos**

**âœ… å·²æ‹æ¿è¿ç§»ç­–ç•¥ï¼ˆ2026-01-08 23:15 æœ€ç»ˆç¡®è®¤ - åŸºäºçœŸå®DBæ•°æ®ï¼‰**ï¼š

- **æ— éœ€è¿ç§»å†å²æ•°æ®**ï¼šçœŸå®DB `image_resources` ä»… 1 æ¡è®°å½•ä¸” `status=deleted`ã€âœ… å·²æ‹æ¿ç¡®è®¤ï¼šç›´æ¥ç‰©ç†åˆ é™¤ã€‘
- **å­˜å‚¨æ ¼å¼**ï¼šå¯¹è±¡ keyï¼ˆå¦‚ `prizes/20260108_abc123.jpg`ï¼‰ï¼Œéå®Œæ•´ URLã€âœ… å·²æ‹æ¿ç¡®è®¤ã€‘
- **ç¼©ç•¥å›¾å­˜å‚¨**ï¼šé¢„ç”Ÿæˆ 3 æ¡£ï¼ˆsmall/medium/largeï¼‰ï¼Œå†™å…¥ `thumbnail_paths` JSON å­—æ®µã€âœ… å·²æ‹æ¿ç¡®è®¤æ–¹æ¡ˆAã€‘
- **æœ¬åœ°æ–‡ä»¶å¤„ç†**ï¼šå¤‡ä»½åç«‹å³åˆ é™¤ï¼Œä¸ä¿ç•™ã€âœ… å·²æ‹æ¿ç¡®è®¤ï¼šå½»åº•æ”¾å¼ƒ /uploadsã€‘

**å®é™…æ¸…ç†èŒƒå›´ï¼ˆåŸºäºçœŸå® DB æ•°æ® - 2026-01-08 æ ¸æŸ¥ï¼‰**ï¼š

- `image_resources` è¡¨ï¼š1 æ¡ deleted è®°å½•ï¼ˆ`image_id=1`ï¼Œç›´æ¥ç‰©ç†åˆ é™¤ï¼‰
- `user_upload_review` ç±»å‹ï¼š**çœŸå®DBä¸­ä¸å­˜åœ¨**ï¼ˆå†å²æŠ¥å‘Šæœ‰è¯¯ï¼Œæ— éœ€æ¸…ç†ï¼‰
- `uploads/` ç‰©ç†æ–‡ä»¶ï¼šçº¦ 27 å¼ ï¼ˆå¤‡ä»½ååˆ é™¤ï¼ŒçœŸå®DBæ— ä¾èµ–ï¼‰

**è¿ç§»è„šæœ¬**ï¼ˆNode.js å®ç°ï¼‰ï¼š

```javascript
// scripts/migrate-local-images-to-sealos.js
// 1. æ¸…ç† user_upload_review æ•°æ®ï¼ˆä¸è¿ç§»ï¼‰
//    DELETE FROM image_resources WHERE business_type = 'user_upload_review';
// 2. è¯»å–å±•ç¤ºå‹ç´ æï¼ˆWHERE business_type IN ('lottery', 'exchange', 'trade')ï¼‰
// 3. éå†æ¯æ¡è®°å½•ï¼š
//    a. è¯»å–æœ¬åœ°æ–‡ä»¶ï¼ˆuploads/{file_path}ï¼‰
//    b. ä¸Šä¼ åˆ° Sealos å†…ç½‘ endpointï¼ˆè°ƒç”¨ SealosStorageService.uploadImage()ï¼‰
//    c. æ›´æ–° image_resources.file_path = objectKeyï¼ˆå¯¹è±¡ keyï¼Œéå®Œæ•´ URLï¼‰
// 4. äº‹åŠ¡ä¿æŠ¤ï¼Œå¤±è´¥å›æ»š
// 5. è®°å½•è¿ç§»æ—¥å¿—
```

**æ‰§è¡Œæ­¥éª¤**ï¼š

```bash
# 1. å¤‡ä»½æœ¬åœ°æ–‡ä»¶ï¼ˆå¿…éœ€ï¼‰
tar -czf uploads_backup_$(date +%Y%m%d_%H%M%S).tar.gz uploads/
mv uploads_backup_*.tar.gz backups/

# 2. å¤‡ä»½æ•°æ®åº“ï¼ˆå¿…éœ€ï¼‰
mysqldump -u$DB_USER -p$DB_PASSWORD $DB_NAME image_resources > backups/image_resources_$(date +%Y%m%d).sql

# 3. æ¸…ç† user_upload_review æ•°æ®ï¼ˆç«‹å³æ‰§è¡Œï¼‰
node scripts/migrate-local-images-to-sealos.js --cleanup-ugc
# é¢„æœŸï¼šåˆ é™¤ 2 æ¡è®°å½•

# 4. æ‰§è¡Œå±•ç¤ºå‹ç´ æè¿ç§»ï¼ˆå­˜å‚¨å¯¹è±¡ keyï¼‰
node scripts/migrate-local-images-to-sealos.js --dry-run
# é¢„è§ˆï¼š1 æ¡è®°å½•ï¼ˆ/prizes/prize_001.jpgï¼‰

node scripts/migrate-local-images-to-sealos.js --execute
# å®é™…æ‰§è¡Œï¼šä¸Šä¼ åˆ° Sealosï¼Œfile_path æ›´æ–°ä¸ºå¯¹è±¡ key

# 5. éªŒè¯è¿ç§»ç»“æœ
SELECT image_id, business_type, file_path FROM image_resources;
# é¢„æœŸï¼šfile_path = 'prizes/20260108_abc123.jpg'ï¼ˆå¯¹è±¡ key æ ¼å¼ï¼Œæ—  http å‰ç¼€ï¼‰

# 6. ç«‹å³åˆ é™¤æœ¬åœ°æ–‡ä»¶ï¼ˆä¸å…¼å®¹æ—§æ–¹æ¡ˆï¼‰
rm -rf uploads/*.jpg uploads/*.png uploads/thumbnails/
# é¢„æœŸï¼šuploads/ ç›®å½•ä¸ºç©º
```

#### **3. ç»Ÿä¸€ URL æ ¼å¼è§„èŒƒ**

**âœ… å·²æ‹æ¿æ•°æ®åº“å­—æ®µæ ‡å‡†ï¼ˆ2026-01-08 22:30 æœ€ç»ˆç¡®è®¤ï¼‰**ï¼š

- æ‰€æœ‰å›¾ç‰‡å­—æ®µç»Ÿä¸€å­˜å‚¨ **å¯¹è±¡ key**ï¼ˆéå®Œæ•´ URLï¼‰ã€âœ… å·²æ‹æ¿ç¡®è®¤ã€‘
- æ ¼å¼ï¼š`{folder}/{filename}`ï¼ˆå¦‚ `prizes/20260108_abc123.jpg`ï¼‰
- ç¤ºä¾‹ï¼š
  - `image_resources.file_path = 'prizes/20260108_abc123.jpg'`
  - `popup_banners.image_url = 'popup-banners/20260108_xyz789.jpg'`ï¼ˆéœ€æ”¹é€ ï¼‰
- **ä¸å…¼å®¹æ—§æ–¹æ¡ˆ**ï¼šä¸å­˜å‚¨ `/uploads/...` æœ¬åœ°è·¯å¾„ã€ä¸å­˜å‚¨ `https://...` å®Œæ•´ URL

**API å±‚ URL ç”Ÿæˆè§„èŒƒï¼ˆå» CDN ç‰ˆ - 2026-01-08 23:15 æœ€ç»ˆç¡®è®¤ï¼‰**ï¼š

```javascript
// utils/ImageUrlHelper.jsï¼ˆå·²å­˜åœ¨ï¼Œéœ€æ”¹é€ ï¼‰
const SEALOS_ENDPOINT = process.env.SEALOS_ENDPOINT
const SEALOS_BUCKET = process.env.SEALOS_BUCKET

function getImageUrl(objectKey) {
  if (!objectKey) return null

  // å…¼å®¹å†å²å®Œæ•´ URL
  if (objectKey.startsWith('http://') || objectKey.startsWith('https://')) {
    return objectKey
  }

  // å…¼å®¹å†å²æœ¬åœ°è·¯å¾„ï¼ˆ/å¼€å¤´ï¼‰
  if (objectKey.startsWith('/')) {
    objectKey = objectKey.substring(1)
  }

  // ç›´è¿ Sealos å¯¹è±¡å­˜å‚¨å…¬ç½‘åŸŸåï¼ˆæ—  CDNï¼‰
  return `${SEALOS_ENDPOINT}/${SEALOS_BUCKET}/${objectKey}`
}

function getThumbnailUrl(objectKey, size = 'medium') {
  // ä» thumbnail_paths JSON å­—æ®µè¯»å–å¯¹åº”å°ºå¯¸çš„å¯¹è±¡ key
  // ç”± API å±‚è°ƒç”¨æ—¶ä¼ å…¥å®Œæ•´çš„ thumbnailKeys[size]
  return getImageUrl(objectKey)
}

module.exports = { getImageUrl, getThumbnailUrl }
```

**å‰ç«¯ä½¿ç”¨è§„èŒƒ**ï¼š

- **ä¸å†ç›´æ¥ä½¿ç”¨æ•°æ®åº“å­—æ®µ**ï¼ˆå­—æ®µåªå­˜ keyï¼‰
- **ä½¿ç”¨ API è¿”å›çš„å®Œæ•´ URL**ï¼ˆAPI å±‚å·²ç”Ÿæˆï¼ŒåŒ…å«åŸå›¾ + 3 æ¡£ç¼©ç•¥å›¾ï¼‰
- é”™è¯¯å¤„ç†ï¼š`onerror="this.src='<é»˜è®¤å›¾ç‰‡ Sealos URL>'"`
- CORS å…¼å®¹ï¼šSealos å¯¹è±¡å­˜å‚¨ public-read è‡ªåŠ¨æ”¯æŒè·¨åŸŸè®¿é—®

### **ä¸­æœŸè§„åˆ’ï¼ˆ1-2ä¸ªæœˆå†…ï¼‰- P1 çº§åˆ«**

#### **4. å®ç°å•†å“å›¾ç‰‡ä¸Šä¼ ç®¡ç†**ï¼ˆè¡¥é½ä¸šåŠ¡å®Œæ•´æ€§ï¼‰

**âœ… å·²æ‹æ¿å®æ–½æ–¹æ¡ˆï¼ˆ2026-01-08 22:30 æœ€ç»ˆç¡®è®¤ï¼‰**ï¼š

- **é‡‡ç”¨ `image_resources` å…³è”æ¨¡å¼**ï¼ˆå›¾åº“/å¤šå›¾/å®¡æ ¸æ‰©å±•ï¼‰ã€âœ… å·²æ‹æ¿ç¡®è®¤ç»Ÿä¸€èµ°å…³è”ã€‘
- **å­˜å‚¨å¯¹è±¡ key**ï¼ˆéå®Œæ•´ URLï¼‰ã€âœ… å·²æ‹æ¿ç¡®è®¤ã€‘
- **ç»Ÿä¸€ä¸Šä¼ æ¥å£**ï¼ˆå¤ç”¨å¥–å“å›¾ä¸Šä¼ é€»è¾‘ï¼‰

**æ¶‰åŠè¡¨æ”¹é€ **ï¼š

- `exchange_items`ï¼šæ·»åŠ  `primary_image_id`ï¼ˆå…³è” `image_resources`ï¼‰ã€âœ… å·²æ‹æ¿ç¡®è®¤ã€‘
- `exchange_items.image_url`ï¼šåºŸå¼ƒå­—æ®µï¼ˆä¿ç•™ä½œå…¼å®¹æœŸï¼ŒåŒå†™éªŒè¯ååˆ é™¤ï¼‰
- `products.primary_image_id`ï¼šç›´æ¥ä½¿ç”¨ï¼ˆå­—æ®µå·²å­˜åœ¨ï¼‰
- `products.image` / `products.premium_image`ï¼šåºŸå¼ƒå­—æ®µï¼ˆä¿ç•™ä½œå…¼å®¹æœŸï¼‰
- è¿ç§»ç­–ç•¥ï¼šæ–°å¢å­—æ®µä¼˜å…ˆï¼Œæ—§å­—æ®µä¿ç•™åŒå†™æœŸï¼ŒéªŒè¯é€šè¿‡ååˆ é™¤æ—§å­—æ®µ

**å®æ–½æ–¹æ¡ˆ**ï¼š

**æ­¥éª¤ 1ï¼šæ•°æ®åº“æ”¹é€ **

```sql
-- exchange_items æ·»åŠ  primary_image_id
ALTER TABLE exchange_items
ADD COLUMN primary_image_id INT NULL COMMENT 'å•†å“ä¸»å›¾IDï¼ˆå…³è”image_resourcesï¼‰',
ADD CONSTRAINT fk_exchange_items_image
  FOREIGN KEY (primary_image_id) REFERENCES image_resources(image_id);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_exchange_items_image ON exchange_items(primary_image_id);
```

**æ­¥éª¤ 2ï¼šå¤ç”¨å›¾ç‰‡ä¸Šä¼ æ¥å£**

- è·¯ç”±ï¼š`POST /api/v4/console/images/upload`ï¼ˆé€šç”¨å›¾ç‰‡ä¸Šä¼ ï¼‰
- å‚æ•°ï¼š`business_type`ï¼ˆlottery/exchange/tradeï¼‰ã€`category`ï¼ˆprize_image/product_imageï¼‰
- è¿”å›ï¼š`image_id` + CDN URL

**æ­¥éª¤ 3ï¼šç®¡ç†ç«¯ç•Œé¢æ”¹é€ **

- `public/admin/exchange-market-items.html`ï¼š
  1. æ·»åŠ å›¾ç‰‡ä¸Šä¼ ç»„ä»¶
  2. è°ƒç”¨é€šç”¨ä¸Šä¼ æ¥å£
  3. è·å¾— `image_id` åå†™å…¥å•†å“æ•°æ®çš„ `primary_image_id` å­—æ®µ

#### **5. ç¼©ç•¥å›¾æœåŠ¡æ”¹é€  - é¢„ç”Ÿæˆæ–¹æ¡ˆï¼ˆæ–¹æ¡ˆAï¼‰**

**âœ… å·²æ‹æ¿ç­–ç•¥ï¼ˆ2026-01-08 23:15 æœ€ç»ˆç¡®è®¤ - å» CDN ç‰ˆï¼‰**ï¼š

- **æ”¹é€  `ThumbnailService` ä¸ºå†…å­˜ç”Ÿæˆæ¨¡å¼**ï¼ˆä¸è½æœ¬åœ°ç£ç›˜ï¼‰ã€âœ… å·²æ‹æ¿ç¡®è®¤æ–¹æ¡ˆAã€‘
- **é¢„ç”Ÿæˆ 3 æ¡£ç¼©ç•¥å›¾å¹¶ä¸Šä¼  Sealos**ï¼ˆsmall/medium/largeï¼‰
- **å†™å…¥ `thumbnail_paths` JSON å­—æ®µ**ï¼ˆçœŸå®DBå·²éªŒè¯å­—æ®µå­˜åœ¨ï¼‰
- **ä¸ä½¿ç”¨ URL å‚æ•°åŒ–**ï¼ˆæ—  CDN å›¾ç‰‡å¤„ç†èƒ½åŠ›ï¼‰ã€âœ… å·²æ‹æ¿ç¡®è®¤ï¼šå» CDNã€‘

**å®æ–½æ–¹æ¡ˆ**ï¼š

**æ­¥éª¤ 1ï¼šæ”¹é€  `SealosStorageService` æ–°å¢æ‰¹é‡ä¸Šä¼ æ–¹æ³•**

```javascript
// services/sealosStorage.js æ–°å¢æ–¹æ³•
async uploadImageWithThumbnails(fileBuffer, originalName, folder = 'photos') {
  const sharp = require('sharp')

  // 1. ä¸Šä¼ åŸå›¾
  const originalKey = await this.uploadImage(fileBuffer, originalName, folder)

  // 2. ç”Ÿæˆå¹¶ä¸Šä¼  3 æ¡£ç¼©ç•¥å›¾
  const sizes = {
    small: { width: 150, height: 150 },
    medium: { width: 300, height: 300 },
    large: { width: 600, height: 600 }
  }

  const thumbnailKeys = {}
  for (const [sizeName, dimensions] of Object.entries(sizes)) {
    // å†…å­˜ç”Ÿæˆç¼©ç•¥å›¾
    const thumbnailBuffer = await sharp(fileBuffer)
      .resize(dimensions.width, dimensions.height, {
        fit: 'cover',
        position: 'center'
      })
      .jpeg({ quality: 80 })
      .toBuffer()

    // ä¸Šä¼ åˆ° Sealosï¼ˆthumbnails å­æ–‡ä»¶å¤¹ï¼‰
    const thumbnailKey = await this.uploadImage(
      thumbnailBuffer,
      `${sizeName}_${originalName}`,
      `${folder}/thumbnails`
    )
    thumbnailKeys[sizeName] = thumbnailKey
  }

  return {
    originalKey,      // åŸå›¾å¯¹è±¡ key
    thumbnailKeys     // ç¼©ç•¥å›¾å¯¹è±¡ keyï¼ˆJSONï¼‰
  }
}
```

**æ­¥éª¤ 2ï¼šæ”¹é€  `ImageService.uploadImage()` è°ƒç”¨æ–°æ–¹æ³•**

```javascript
// services/ImageService.js æ”¹é€ 
static async uploadImage(options) {
  // ... å‰ç½®éªŒè¯ ...

  // ä¸Šä¼ åŸå›¾ + ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆæ–¹æ¡ˆAï¼‰
  const storageService = new SealosStorageService()
  const { originalKey, thumbnailKeys } = await storageService.uploadImageWithThumbnails(
    fileBuffer,
    originalName,
    folder
  )

  // åˆ›å»º image_resources è®°å½•
  const imageRecord = await ImageResources.create({
    file_path: originalKey,              // åŸå›¾å¯¹è±¡ key
    thumbnail_paths: thumbnailKeys,      // ç¼©ç•¥å›¾å¯¹è±¡ keyï¼ˆJSONï¼‰
    // ... å…¶ä»–å­—æ®µ ...
  }, { transaction })

  // ç”Ÿæˆå…¬ç½‘è®¿é—® URLï¼ˆç›´è¿ Sealosï¼Œæ—  CDNï¼‰
  const publicUrl = getImageUrl(originalKey)
  const thumbnails = {
    small: getImageUrl(thumbnailKeys.small),
    medium: getImageUrl(thumbnailKeys.medium),
    large: getImageUrl(thumbnailKeys.large)
  }

  return { image_id, object_key: originalKey, public_url: publicUrl, thumbnails }
}
```

**æ­¥éª¤ 3ï¼šAPI å“åº”ç¤ºä¾‹ï¼ˆåŒ…å«é¢„ç”Ÿæˆç¼©ç•¥å›¾ URLï¼‰**

```javascript
// API å“åº”æ ¼å¼
{
  "image_id": 123,
  "object_key": "prizes/20260108_abc123.jpg",
  "public_url": "https://objectstorageapi.bja.sealos.run/tiangong/prizes/20260108_abc123.jpg",
  "thumbnails": {
    "small": "https://objectstorageapi.bja.sealos.run/tiangong/prizes/thumbnails/small_20260108_abc123.jpg",
    "medium": "https://objectstorageapi.bja.sealos.run/tiangong/prizes/thumbnails/medium_20260108_abc123.jpg",
    "large": "https://objectstorageapi.bja.sealos.run/tiangong/prizes/thumbnails/large_20260108_abc123.jpg"
  }
}
```

**æŠ€æœ¯ä¼˜åŠ¿**ï¼š

- âœ… çœŸæ­£å‡å°‘å¸¦å®½æ¶ˆè€—ï¼ˆå‰ç«¯åŠ è½½ 150/300/600px å°å›¾ï¼ŒéåŸå›¾ï¼‰
- âœ… æ— éœ€ä¾èµ– CDN å›¾ç‰‡å¤„ç†èƒ½åŠ›ï¼ˆè‡ªä¸»å¯æ§ï¼‰
- âœ… ä¿æŒæ— çŠ¶æ€æ¶æ„ï¼ˆç¼©ç•¥å›¾å­˜ Sealosï¼Œä¸è½æœ¬åœ°ç›˜ï¼‰
- âœ… æˆæœ¬å¯æ§ï¼ˆä»…å¯¹è±¡å­˜å‚¨è´¹ç”¨ï¼Œæ—  CDN è´¹ç”¨ï¼‰

### **é•¿æœŸä¼˜åŒ–ï¼ˆ3-6ä¸ªæœˆå†…ï¼‰- P2 çº§åˆ«**

#### **6. å›¾ç‰‡è®¿é—®æ€§èƒ½ä¼˜åŒ–**ï¼ˆæ—  CDN åœºæ™¯ï¼‰

**âœ… å·²æ‹æ¿ç­–ç•¥ï¼ˆ2026-01-08 23:15 æœ€ç»ˆç¡®è®¤ - å» CDN ç‰ˆï¼‰**ï¼š

- **ä¸ä½¿ç”¨ CDN æœåŠ¡**ã€âœ… å·²æ‹æ¿ç¡®è®¤ã€‘
- **ç›´è¿ Sealos å¯¹è±¡å­˜å‚¨å…¬ç½‘åŸŸå**ï¼ˆ`SEALOS_ENDPOINT`ï¼‰
- **ä¾èµ–é¢„ç”Ÿæˆç¼©ç•¥å›¾å‡å°‘å¸¦å®½**ï¼ˆæ–¹æ¡ˆAå·²å®æ–½ï¼‰
- **ä¾èµ–æµè§ˆå™¨ç¼“å­˜**ï¼ˆå¯¹è±¡å­˜å‚¨ `Cache-Control: max-age=31536000`ï¼‰

**æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µ**ï¼š

**æ‰‹æ®µ 1ï¼šé¢„ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆå·²å®æ–½ï¼‰**

- ä¸Šä¼ æ—¶ç”Ÿæˆ small/medium/large ä¸‰æ¡£ï¼ˆ150/300/600pxï¼‰
- å‰ç«¯æ ¹æ®å±•ç¤ºåœºæ™¯é€‰æ‹©åˆé€‚å°ºå¯¸ï¼ˆåˆ—è¡¨ç”¨ smallï¼Œè¯¦æƒ…ç”¨ medium/largeï¼‰
- å‡å°‘ 70-90% å¸¦å®½æ¶ˆè€—ï¼ˆç›¸æ¯”ç›´æ¥åŠ è½½åŸå›¾ï¼‰

**æ‰‹æ®µ 2ï¼šæµè§ˆå™¨ç¼“å­˜ç­–ç•¥**

- å¯¹è±¡å­˜å‚¨å“åº”å¤´ï¼š`Cache-Control: max-age=31536000`ï¼ˆ1å¹´ï¼‰
- æµè§ˆå™¨è‡ªåŠ¨ç¼“å­˜å·²è®¿é—®å›¾ç‰‡
- äºŒæ¬¡è®¿é—®ç›´æ¥ä»æœ¬åœ°ç¼“å­˜è¯»å–ï¼ˆæ— ç½‘ç»œè¯·æ±‚ï¼‰

**æ‰‹æ®µ 3ï¼šå‰ç«¯æ‡’åŠ è½½**

```javascript
// å‰ç«¯å›¾ç‰‡ç»„ä»¶ç¤ºä¾‹
<img 
  src="${thumbnailUrl}" 
  loading="lazy"
  alt="${altText}"
  onerror="this.src='${defaultImageUrl}'"
/>
```

**æ‰‹æ®µ 4ï¼šå›¾ç‰‡æ ¼å¼ä¼˜åŒ–**

- ä¸Šä¼ æ—¶ç»Ÿä¸€è½¬ JPEGï¼ˆquality=80ï¼‰
- å‹ç¼©ç‡çº¦ 70-80%ï¼ˆç›¸æ¯”åŸå›¾ï¼‰
- å°ç¨‹åºç«¯å¯ä½¿ç”¨ WebP æ ¼å¼ï¼ˆéœ€å‰ç«¯åˆ¤æ–­æ”¯æŒåº¦ï¼‰

**ç¯å¢ƒå˜é‡é…ç½®ï¼ˆå» CDN ç‰ˆ - 2026-01-08 çœŸå®æ ¸æŸ¥ï¼‰**ï¼š

```bash
# .env é…ç½®ï¼ˆçœŸå®ç¯å¢ƒå·²éªŒè¯ï¼‰
SEALOS_INTERNAL_ENDPOINT=http://object-storage.objectstorage-system.svc.cluster.local  # å†…ç½‘ä¸Šä¼ ï¼ˆâœ… å·²é…ç½®ï¼‰
SEALOS_ENDPOINT=https://objectstorageapi.bja.sealos.run  # å…¬ç½‘è®¿é—®ï¼ˆâœ… å·²é…ç½®ï¼‰
SEALOS_BUCKET=tiangong  # å­˜å‚¨æ¡¶åç§°ï¼ˆâœ… å·²é…ç½®ï¼‰
SEALOS_REGION=bja  # å­˜å‚¨åŒºåŸŸï¼ˆâœ… å·²é…ç½®ï¼‰
# CDN_DOMAIN ä¸é…ç½®ï¼ˆä¸ä½¿ç”¨ CDNï¼‰
```

**éªŒè¯ç»“æœï¼ˆ2026-01-08 çœŸå®æ ¸æŸ¥ï¼‰**ï¼š

- âœ… `SEALOS_INTERNAL_ENDPOINT` å·²åœ¨ Devbox ç¯å¢ƒé…ç½®
- âœ… DNS è§£ææ­£å¸¸ï¼š`object-storage.objectstorage-system.svc.cluster.local` â†’ `10.96.108.241`
- âœ… å½¢å¼ï¼šK8s é›†ç¾¤å†…æœåŠ¡åŸŸåï¼ˆ`http://` + å†…ç½‘ DNSï¼‰
- âœ… `CDN_DOMAIN` æœªé…ç½®ï¼ˆç¬¦åˆå» CDN å†³ç­–ï¼‰

**ä»£ç æ”¹é€ ï¼ˆå» CDN ç‰ˆï¼‰**ï¼š

```javascript
// services/sealosStorage.js æ”¹é€ 
class SealosStorageService {
  constructor() {
    // ä¼˜å…ˆä½¿ç”¨å†…ç½‘ endpointï¼ˆSealos é›†ç¾¤å†…ï¼‰ï¼Œå›é€€åˆ°å…¬ç½‘ï¼ˆæœ¬åœ°å¼€å‘ï¼‰
    const uploadEndpoint = process.env.SEALOS_INTERNAL_ENDPOINT || process.env.SEALOS_ENDPOINT

    this.s3 = new AWS.S3({
      endpoint: uploadEndpoint, // å†…ç½‘ä¼˜å…ˆ
      accessKeyId: process.env.SEALOS_ACCESS_KEY,
      secretAccessKey: process.env.SEALOS_SECRET_KEY,
      region: process.env.SEALOS_REGION,
      s3ForcePathStyle: true,
      signatureVersion: 'v4'
    })

    this.bucket = process.env.SEALOS_BUCKET
    // å» CDNï¼šç›´æ¥ä½¿ç”¨ SEALOS_ENDPOINT
    this.publicEndpoint = process.env.SEALOS_ENDPOINT
  }

  // ä¸Šä¼ è¿”å›å¯¹è±¡ keyï¼ˆéå®Œæ•´ URLï¼‰
  async uploadImage(fileBuffer, originalName, folder = 'photos') {
    const objectKey = `${folder}/${timestamp}_${hash}${ext}`
    await this.s3
      .upload({
        Bucket: this.bucket,
        Key: objectKey,
        Body: fileBuffer,
        ContentType: contentType,
        ACL: 'public-read',
        CacheControl: 'max-age=31536000'
      })
      .promise()

    return objectKey // è¿”å› keyï¼Œè€Œé result.Location
  }

  // ç”Ÿæˆå…¬ç½‘è®¿é—® URLï¼ˆç›´è¿ Sealosï¼Œæ—  CDNï¼‰
  getPublicUrl(objectKey) {
    return `${this.publicEndpoint}/${this.bucket}/${objectKey}`
  }
}
```

**ç¼“å­˜ç­–ç•¥ï¼ˆå» CDN ç‰ˆ - 2026-01-08 23:15 æœ€ç»ˆç¡®è®¤ï¼‰**ï¼š

- ä¸Šä¼ æ—¶è®¾ç½®ï¼š`CacheControl: 'max-age=31536000'`ï¼ˆ1å¹´ï¼Œå·²å®ç°ï¼‰
- æµè§ˆå™¨ç¼“å­˜ï¼šä¾èµ–å¯¹è±¡å­˜å‚¨è¿”å›çš„ `Cache-Control` å“åº”å¤´
- å›¾ç‰‡æ ¼å¼ï¼šä¸Šä¼ æ—¶ç”¨ `sharp` ç»Ÿä¸€è½¬ JPEGï¼ˆquality=80ï¼‰
- ç¼©ç•¥å›¾ï¼šé¢„ç”Ÿæˆ 3 æ¡£ï¼ˆsmall/medium/largeï¼‰ï¼Œåˆ†åˆ«ä¸Šä¼ åˆ° Sealos

#### **7. ç”¨æˆ·å¤´åƒåŠŸèƒ½**ï¼ˆç”¨æˆ·ä½“éªŒæå‡ - é•¿æœŸè§„åˆ’ï¼‰

**âœ… å·²æ‹æ¿ç­–ç•¥ï¼ˆ2026-01-08ï¼‰**ï¼š

- å…³è” `image_resources`ï¼ˆå›¾åº“æ¨¡å¼ï¼Œå¤ç”¨é€šç”¨ä¸Šä¼ æ¥å£ï¼‰
- å­˜å‚¨å¯¹è±¡ keyï¼ˆ`avatars/{user_id}_{timestamp}.jpg`ï¼‰

**æ•°æ®åº“æ”¹é€ **ï¼š

```sql
-- è¿ç§»æ–‡ä»¶ï¼šmigrations/add-user-avatar.js
ALTER TABLE users
ADD COLUMN avatar_image_id INT NULL COMMENT 'ç”¨æˆ·å¤´åƒIDï¼ˆå…³è”image_resourcesï¼‰',
ADD CONSTRAINT fk_users_avatar
  FOREIGN KEY (avatar_image_id) REFERENCES image_resources(image_id);

CREATE INDEX idx_users_avatar_image_id ON users(avatar_image_id);
```

**ä¸Šä¼ é“¾è·¯**ï¼š

- è·¯ç”±ï¼š`POST /api/v4/user/avatar`ï¼ˆç”¨æˆ·ç«¯ï¼‰æˆ– `/api/v4/console/users/:id/avatar`ï¼ˆç®¡ç†ç«¯ï¼‰
- å¤ç”¨é€šç”¨ä¸Šä¼ æ¥å£ï¼š`/api/v4/console/images/upload?business_type=user&category=avatar`
- é™åˆ¶ï¼šæœ€å¤§ 2MBã€ä»…å›¾ç‰‡æ ¼å¼ã€è‡ªåŠ¨è£å‰ªä¸ºæ­£æ–¹å½¢ï¼ˆå‰ç«¯æˆ– Cloudflare å¤„ç†ï¼‰
- å­˜å‚¨ï¼šSealos `avatars/` æ–‡ä»¶å¤¹
- é»˜è®¤å¤´åƒï¼šæ‰˜ç®¡åœ¨ Sealosï¼ˆå¯¹è±¡ keyï¼š`defaults/avatar.svg`ï¼‰

#### **8. å›¾ç‰‡å®‰å…¨ä¸é˜²æŠ¤**ï¼ˆåˆè§„ä¸é£æ§ - æŒ‰éœ€å¯ç”¨ï¼‰

**âœ… å½“å‰ç­–ç•¥ï¼ˆ2026-01-08ï¼‰**ï¼š

- **æ— å†…å®¹å®¡æ ¸**ï¼ˆå…¨éƒ¨å±•ç¤ºå‹ç´ æï¼Œæ—  UGCï¼‰
- **å…¨å…¬å¼€è®¿é—®**ï¼ˆæ— é˜²ç›—é“¾ã€æ— ç­¾å URLï¼‰
- **åŸºç¡€é˜²æŠ¤**ï¼šæ–‡ä»¶ç±»å‹æ ¡éªŒã€å¤§å°é™åˆ¶ã€é¢‘ç‡é™åˆ¶ï¼ˆAPI å±‚ï¼‰

**æœªæ¥æ‰©å±•ï¼ˆå¦‚å¼•å…¥ UGCï¼‰**ï¼š

- å†…å®¹å®¡æ ¸ï¼šé›†æˆç¬¬ä¸‰æ–¹æœåŠ¡ï¼ˆç™¾åº¦ OCRã€è…¾è®¯äº‘å¤©å¾¡ç­‰ï¼‰
- è®¿é—®æ§åˆ¶ï¼šæ•æ„Ÿå›¾ç‰‡æ”¹ä¸º private + ä¸´æ—¶ç­¾å URL
- é˜²ç›—é“¾ï¼šCloudflare é…ç½® Referer ç™½åå•
- æ¶æ„ä¸Šä¼ é˜²æŠ¤ï¼šå›¾ç‰‡å“ˆå¸Œå»é‡ã€é¢‘ç‡é™åˆ¶

---

## ğŸ“‹ æ‰§è¡Œè·¯çº¿å›¾ï¼ˆåŸºäºå·²æ‹æ¿å†³ç­–ï¼‰

### **é˜¶æ®µ 1ï¼šç«‹å³éªŒè¯ Sealos + Cloudflare ç«¯åˆ°ç«¯å¯ç”¨æ€§ï¼ˆä»Šå¤©å®Œæˆï¼‰**

âœ… **å†³ç­–å·²æ‹æ¿**ï¼šSealos å¯¹è±¡å­˜å‚¨ï¼ˆå†…ç½‘ä¸Šä¼ ï¼‰+ Cloudflare CDN + å¯¹è±¡ key å­˜å‚¨

- [x] **æ­¥éª¤ 1.1**ï¼šéªŒè¯ Sealos ç¯å¢ƒå˜é‡å®Œæ•´æ€§ï¼ˆâœ… å·²éªŒè¯ï¼‰

  ```bash
  node -e "require('dotenv').config();
  const keys=['SEALOS_ENDPOINT','SEALOS_INTERNAL_ENDPOINT','SEALOS_BUCKET','SEALOS_ACCESS_KEY','SEALOS_SECRET_KEY','SEALOS_REGION'];
  const missing=keys.filter(k=>!process.env[k]);
  if(missing.length>0) { console.warn('ç¼ºå¤±é…ç½®:', missing); }
  console.log('âœ… Sealosé…ç½®:', keys.filter(k=>process.env[k]).length + '/' + keys.length);"
  ```

  **éªŒè¯ç»“æœï¼ˆ2026-01-08ï¼‰**ï¼š
  - âœ… `SEALOS_INTERNAL_ENDPOINT` = `http://object-storage.objectstorage-system.svc.cluster.local`
  - âœ… DNS è§£æï¼š`10.96.108.241`ï¼ˆK8s é›†ç¾¤å†… IPï¼‰
  - âš ï¸ `CDN_DOMAIN` æœªé…ç½®ï¼ˆå¾…åç»­ Cloudflare é…ç½®åè¡¥å……ï¼‰

- [ ] **æ­¥éª¤ 1.2**ï¼šæ”¹é€  `SealosStorageService` æ”¯æŒå†…ç½‘ä¸Šä¼  + è¿”å›å¯¹è±¡ key
  - ä¿®æ”¹ `uploadImage()` æ–¹æ³•ï¼š
    1. ä¼˜å…ˆä½¿ç”¨ `SEALOS_INTERNAL_ENDPOINT`ï¼ˆå·²éªŒè¯å¯ç”¨ï¼‰
    2. æœ¬åœ°å¼€å‘ç¯å¢ƒå›é€€åˆ° `SEALOS_ENDPOINT`ï¼ˆè‡ªåŠ¨é™çº§ï¼‰
    3. è¿”å›å¯¹è±¡ keyï¼ˆè€Œé `result.Location`ï¼‰
  - æ–°å¢ `getPublicUrl(objectKey)` æ–¹æ³•ï¼šæ ¹æ® key ç”Ÿæˆ CDN URL
  - ç¯å¢ƒå˜é‡å›é€€ç­–ç•¥ï¼š`SEALOS_INTERNAL_ENDPOINT || SEALOS_ENDPOINT`

- [ ] **æ­¥éª¤ 1.3**ï¼šåˆ›å»ºæµ‹è¯• Banner éªŒè¯ä¸Šä¼ ï¼ˆæ”¹é€ åï¼‰

  ```
  è®¿é—®ï¼šhttp://localhost:3000/admin/popup-banners.html
  æ“ä½œï¼šæ·»åŠ å¼¹çª— â†’ ä¸Šä¼ å›¾ç‰‡ â†’ ä¿å­˜
  éªŒè¯ï¼šæ•°æ®åº“ image_url åº”ä¸ºå¯¹è±¡ keyï¼ˆå¦‚ popup-banners/20260108_abc.jpgï¼‰
  ```

- [ ] **æ­¥éª¤ 1.4**ï¼šéªŒè¯ CDN URL å¯å…¬ç½‘è®¿é—®

  ```bash
  # ä»æ•°æ®åº“è·å–å¯¹è±¡ key
  # æ‰‹åŠ¨æ‹¼æ¥ CDN URL æµ‹è¯•
  curl -I "https://{CDN_DOMAIN}/{BUCKET}/{objectKey}"
  # é¢„æœŸï¼šHTTP 200ï¼ŒContent-Type: image/...
  ```

- [ ] **æ­¥éª¤ 1.5**ï¼šéªŒè¯ URL å‚æ•°åŒ–ç¼©ç•¥å›¾
  ```bash
  curl -I "https://{CDN_DOMAIN}/{BUCKET}/{objectKey}?width=300&height=300&fit=cover"
  # é¢„æœŸï¼šè¿”å›ç¼©æ”¾åçš„å›¾ç‰‡ï¼ˆå¦‚ Cloudflare Image Resizing å·²å¯ç”¨ï¼‰
  # å¦‚ä¸æ”¯æŒï¼šé™çº§ä¸ºå‰ç«¯ CSS æ§åˆ¶å°ºå¯¸
  ```

### **é˜¶æ®µ 2ï¼šè¿ç§»å†å²æœ¬åœ°å›¾ç‰‡ + æ¸…ç†é—ç•™æ•°æ®ï¼ˆæœ¬å‘¨å®Œæˆï¼‰**

**âœ… å·²æ‹æ¿æ‰§è¡Œç­–ç•¥ï¼ˆ2026-01-08 22:30 æœ€ç»ˆç¡®è®¤ï¼‰**ï¼š

- **æ¸…ç† user_upload_review**ï¼šç«‹å³åˆ é™¤ï¼Œä¸ä¿ç•™ã€âœ… å·²æ‹æ¿ç¡®è®¤ã€‘
- **è¿ç§»å±•ç¤ºå‹ç´ æ**ï¼šå­˜å‚¨å¯¹è±¡ keyï¼ˆéå®Œæ•´ URLï¼‰ã€âœ… å·²æ‹æ¿ç¡®è®¤ã€‘
- **åˆ é™¤æœ¬åœ°æ–‡ä»¶**ï¼šå¤‡ä»½åç«‹å³åˆ é™¤ï¼Œä¸å…¼å®¹ã€âœ… å·²æ‹æ¿ç¡®è®¤ï¼šå½»åº•æ”¾å¼ƒ /uploadsã€‘

- [ ] **æ­¥éª¤ 2.1**ï¼šå¤‡ä»½å½“å‰æ•°æ®ï¼ˆå¿…éœ€ï¼‰

  ```bash
  # å¤‡ä»½æœ¬åœ°æ–‡ä»¶
  tar -czf uploads_backup_$(date +%Y%m%d_%H%M%S).tar.gz uploads/
  mv uploads_backup_*.tar.gz backups/

  # å¤‡ä»½æ•°æ®åº“è¡¨
  mysqldump -u$DB_USER -p$DB_PASSWORD $DB_NAME image_resources > backups/image_resources_$(date +%Y%m%d).sql
  ```

- [ ] **æ­¥éª¤ 2.2**ï¼šæ¸…ç†å†å²é—ç•™æ•°æ®ï¼ˆuser_upload_reviewï¼‰ã€âœ… å·²æ‹æ¿ç¡®è®¤ï¼šä¸ä¿ç•™ã€‘

  ```sql
  -- æŸ¥çœ‹å¾…æ¸…ç†æ•°æ®
  SELECT image_id, business_type, file_path, review_status
  FROM image_resources
  WHERE business_type = 'user_upload_review';
  # å½“å‰ DBï¼š2 æ¡è®°å½•ï¼ˆ/uploads/test_receipt.jpgï¼‰

  -- æ‰§è¡Œæ¸…ç†ï¼ˆç«‹å³åˆ é™¤ï¼Œä¸è¿ç§»ï¼‰
  DELETE FROM image_resources WHERE business_type = 'user_upload_review';
  # é¢„æœŸï¼šåˆ é™¤ 2 æ¡è®°å½•
  ```

- [ ] **æ­¥éª¤ 2.3**ï¼šæ‰§è¡Œå±•ç¤ºå‹ç´ æè¿ç§»è„šæœ¬ã€âœ… å·²æ‹æ¿ç¡®è®¤ï¼šå­˜å‚¨å¯¹è±¡ keyã€‘

  ```bash
  # åˆ›å»ºè¿ç§»è„šæœ¬ï¼ˆä»…è¿ç§» business_type IN ('lottery', 'exchange', 'trade')ï¼‰
  node scripts/migrate-local-images-to-sealos.js --dry-run
  # é¢„è§ˆè¿ç§»è®¡åˆ’ï¼š1 æ¡è®°å½•ï¼ˆ/prizes/prize_001.jpgï¼‰

  node scripts/migrate-local-images-to-sealos.js --execute
  # å®é™…æ‰§è¡Œè¿ç§»ï¼ˆä¸Šä¼ åˆ° Sealos å†…ç½‘ endpointï¼Œfile_path æ›´æ–°ä¸ºå¯¹è±¡ keyï¼‰
  ```

- [ ] **æ­¥éª¤ 2.4**ï¼šéªŒè¯è¿ç§»å®Œæ•´æ€§ã€âœ… å·²æ‹æ¿ç¡®è®¤ï¼šå¯¹è±¡ key æ ¼å¼ã€‘

  ```sql
  -- æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æœ¬åœ°è·¯å¾„
  SELECT COUNT(*) AS local_path_count
  FROM image_resources
  WHERE file_path LIKE '/uploads/%' OR file_path LIKE '/prizes/%';
  # é¢„æœŸï¼š0

  -- æ£€æŸ¥å¯¹è±¡ key æ ¼å¼ï¼ˆéå®Œæ•´ URLï¼‰
  SELECT COUNT(*) AS object_key_count
  FROM image_resources
  WHERE file_path NOT LIKE 'http%' AND file_path NOT LIKE '/%';
  # é¢„æœŸï¼š1ï¼ˆè¿ç§»åçš„è®°å½•ï¼‰

  -- æŸ¥çœ‹è¿ç§»åçš„å®é™…æ ¼å¼
  SELECT image_id, business_type, file_path FROM image_resources;
  # é¢„æœŸï¼šfile_path = 'prizes/20260108_abc123.jpg'ï¼ˆå¯¹è±¡ key æ ¼å¼ï¼Œæ—  http å‰ç¼€ï¼‰
  ```

- [ ] **æ­¥éª¤ 2.5**ï¼šç«‹å³åˆ é™¤æœ¬åœ°å›¾ç‰‡æ–‡ä»¶ã€âœ… å·²æ‹æ¿ç¡®è®¤ï¼šå½»åº•æ”¾å¼ƒï¼Œä¸å…¼å®¹ã€‘
  ```bash
  # éªŒè¯æ‰€æœ‰å›¾ç‰‡å¯é€šè¿‡ CDN è®¿é—®åç«‹å³åˆ é™¤
  rm -rf uploads/*.jpg uploads/*.png uploads/thumbnails/
  # é¢„æœŸï¼šuploads/ ç›®å½•ä¸ºç©ºæˆ–ä»…ä¿ç•™ .gitkeep
  ```

### **é˜¶æ®µ 3ï¼šè¡¥é½å¥–å“/å•†å“å›¾ç‰‡ä¸Šä¼ é“¾è·¯ï¼ˆ2å‘¨å†…å®Œæˆï¼‰**

**âœ… å·²æ‹æ¿å®æ–½ç­–ç•¥ï¼ˆ2026-01-08 22:30 æœ€ç»ˆç¡®è®¤ï¼‰**ï¼š

- **å¥–å“å›¾**ï¼šå•ç‹¬ä¸Šä¼ æ¥å£ + å…³è” `image_resources`
- **å•†å“å›¾**ï¼šç»Ÿä¸€èµ° `image_resources` å…³è”ã€âœ… å·²æ‹æ¿ç¡®è®¤ã€‘
- **å­˜å‚¨æ ¼å¼**ï¼šå¯¹è±¡ keyï¼ˆAPI å±‚ç”Ÿæˆ CDN URLï¼‰ã€âœ… å·²æ‹æ¿ç¡®è®¤ã€‘

- [ ] **æ­¥éª¤ 3.1**ï¼šå®ç°é€šç”¨å›¾ç‰‡ä¸Šä¼ æ¥å£
  - è·¯ç”±ï¼š`POST /api/v4/console/images/upload`
  - å‚æ•°ï¼š`business_type`ï¼ˆlottery/exchange/tradeï¼‰ã€`category`ï¼ˆprize_image/product_imageï¼‰
  - é€»è¾‘ï¼š
    1. ä¸Šä¼ åˆ° Sealosï¼ˆå†…ç½‘ endpointï¼Œæ–‡ä»¶å¤¹æŒ‰ `business_type` åˆ†ç±»ï¼‰
    2. æå–å¯¹è±¡ keyï¼ˆå¦‚ `prizes/20260108_abc123.jpg`ï¼‰
    3. åˆ›å»º `image_resources` è®°å½•ï¼ˆ`file_path = objectKey`ï¼‰
    4. è¿”å› `image_id` + CDN URLï¼ˆä¾›å‰ç«¯é¢„è§ˆï¼‰

- [ ] **æ­¥éª¤ 3.2**ï¼šå®ç°å¥–å“å›¾ç‰‡ä¸Šä¼ 
  - å‰ç«¯ï¼šæ”¹é€  `public/admin/prizes.html`
    1. ç§»é™¤ `image_id: null` ç¡¬ç¼–ç ï¼ˆç¬¬ 540 è¡Œï¼‰
    2. å›¾ç‰‡é€‰æ‹©åè°ƒç”¨ `/api/v4/console/images/upload`
    3. è·å¾— `image_id` åå†™å…¥ `prizeData.image_id`
  - æµ‹è¯•ï¼šåˆ›å»º 1 ä¸ªå¥–å“å¹¶ä¸Šä¼ å›¾ç‰‡ï¼ŒéªŒè¯ `lottery_prizes.image_id` å…³è”æ­£ç¡®

- [ ] **æ­¥éª¤ 3.3**ï¼šå®ç°å•†å“å›¾ç‰‡ä¸Šä¼ 
  - æ•°æ®åº“ï¼š`exchange_items` æ·»åŠ  `primary_image_id` å­—æ®µ
  - å‰ç«¯ï¼šæ”¹é€  `public/admin/exchange-market-items.html`
  - åç«¯ï¼šæ”¹é€ å•†å“åˆ›å»º/æ›´æ–°æ¥å£æ¥å— `primary_image_id`
  - æµ‹è¯•ï¼šåˆ›å»º 1 ä¸ªå•†å“å¹¶ä¸Šä¼ å›¾ç‰‡ï¼ŒéªŒè¯ `exchange_items.primary_image_id` å…³è”æ­£ç¡®

- [ ] **æ­¥éª¤ 3.4**ï¼šç»Ÿä¸€å‰ç«¯å›¾ç‰‡å±•ç¤ºç»„ä»¶

  ```javascript
  // public/admin/js/image-helper.jsï¼ˆæ–°å¢ï¼‰
  const CDN_DOMAIN = 'https://cdn.yourdomain.com' // Cloudflare CDN
  const DEFAULT_IMAGE_KEY = 'defaults/placeholder.jpg'

  function getImageUrl(objectKey, options = {}) {
    if (!objectKey) return `${CDN_DOMAIN}/${DEFAULT_IMAGE_KEY}`

    let url = `${CDN_DOMAIN}/${objectKey}`

    // URL å‚æ•°åŒ–ç¼©ç•¥å›¾
    if (options.width || options.height) {
      const params = new URLSearchParams()
      if (options.width) params.append('width', options.width)
      if (options.height) params.append('height', options.height)
      if (options.fit) params.append('fit', options.fit || 'cover')
      url += `?${params.toString()}`
    }

    return url
  }

  function renderImage(objectKey, altText = 'å›¾ç‰‡', options = {}) {
    const imageUrl = getImageUrl(objectKey, options)
    const defaultUrl = getImageUrl(DEFAULT_IMAGE_KEY)
    return `<img src="${imageUrl}" 
                 alt="${altText}" 
                 onerror="this.src='${defaultUrl}'" />`
  }
  ```

### **é˜¶æ®µ 4ï¼šCloudflare CDN ç”Ÿäº§ä¼˜åŒ–ï¼ˆæŒ‰æµé‡éœ€æ±‚ï¼‰**

- [ ] **æ­¥éª¤ 4.1**ï¼šCloudflare CDN é…ç½®ä¸éªŒè¯

  ```
  1. æ·»åŠ è‡ªå®šä¹‰åŸŸåï¼ˆcdn.yourdomain.comï¼‰
  2. é…ç½® CNAME â†’ Sealos å¯¹è±¡å­˜å‚¨å…¬ç½‘åŸŸå
  3. å¼€å¯ Cloudflare Image Resizingï¼ˆå›¾ç‰‡å¤„ç†ï¼‰
  4. é…ç½®ç¼“å­˜è§„åˆ™ï¼ˆé™æ€å›¾ç‰‡ 30 å¤©ï¼‰
  5. å¼€å¯ Auto Minify + Brotli å‹ç¼©
  ```

- [ ] **æ­¥éª¤ 4.2**ï¼šéªŒè¯ URL å‚æ•°åŒ–ç¼©ç•¥å›¾

  ```bash
  # æµ‹è¯• Cloudflare Image Resizing
  curl -I "https://cdn.yourdomain.com/{bucket}/prizes/test.jpg?width=300&height=300&fit=cover"
  # é¢„æœŸï¼šè¿”å›ç¼©æ”¾åçš„å›¾ç‰‡

  # å¦‚ä¸æ”¯æŒï¼šé™çº§ä¸ºå‰ç«¯ CSS æ§åˆ¶
  # <img src="..." style="max-width: 300px; height: auto;" />
  ```

- [ ] **æ­¥éª¤ 4.3**ï¼šç›‘æ§ CDN æµé‡ä¸æˆæœ¬

  ```
  Cloudflare Analytics ç›‘æ§ï¼š
  - æ¯æ—¥è¯·æ±‚é‡
  - ç¼“å­˜å‘½ä¸­ç‡ï¼ˆç›®æ ‡ >90%ï¼‰
  - æµé‡å³°å€¼ä¸åœ°åŸŸåˆ†å¸ƒ
  - çƒ­ç‚¹å›¾ç‰‡ Top 10
  ```

- [ ] **æ­¥éª¤ 4.4**ï¼šå›¾ç‰‡æ ¼å¼è‡ªåŠ¨ä¼˜åŒ–
  - Cloudflare Polishï¼ˆè‡ªåŠ¨è½¬ WebP/AVIFï¼‰
  - å‹ç¼©è´¨é‡ï¼š80%ï¼ˆå·²åœ¨ä¸Šä¼ æ—¶è®¾ç½®ï¼‰
  - æ‡’åŠ è½½ï¼šå‰ç«¯ä½¿ç”¨ `loading="lazy"` å±æ€§

---

## ğŸ­ å¤§å…¬å¸ vs å°å…¬å¸ vs æ¸¸æˆå…¬å¸æ¶æ„å¯¹æ¯”ï¼ˆå†³ç­–å‚è€ƒï¼‰

### **æ¶æ„å¯¹æ¯”è¡¨**

| å…¬å¸ç±»å‹                     | å›¾ç‰‡å­˜å‚¨æ–¹æ¡ˆ                  | ä¸šåŠ¡æ•°æ®å­˜å‚¨              | ç‰¹ç‚¹                     | é€‚ç”¨åœºæ™¯         |
| ---------------------------- | ----------------------------- | ------------------------- | ------------------------ | ---------------- |
| **å¤§å…¬å¸**ï¼ˆç¾å›¢/è…¾è®¯/é˜¿é‡Œï¼‰ | å¯¹è±¡å­˜å‚¨ + CDN + å›¾ç‰‡å¤„ç†æœåŠ¡ | MySQL/åˆ†åº“åˆ†è¡¨ + æ•°æ®ä»“åº“ | å¼ºä¸€è‡´æ€§ã€é«˜å¯ç”¨ã€å¤šåœ°åŸŸ | æ—¥å‡åƒä¸‡çº§è®¿é—®   |
| **å°å…¬å¸**ï¼ˆæ—©æœŸï¼‰           | æœ¬åœ°ç£ç›˜ + Nginx é™æ€æ‰˜ç®¡     | MySQL å•åº“                | å®ç°å¿«ã€æˆæœ¬ä½           | æ—¥å‡ä¸‡çº§ä»¥ä¸‹è®¿é—® |
| **å°å…¬å¸**ï¼ˆå¢é•¿æœŸï¼‰         | å¯¹è±¡å­˜å‚¨ + CDN                | MySQL + Redis             | è¿ç§»åˆ°äº‘æœåŠ¡             | æ—¥å‡åä¸‡çº§è®¿é—®   |
| **æ¸¸æˆå…¬å¸**                 | å¯¹è±¡å­˜å‚¨ + CDN + é˜²ç›—é“¾       | å¼ºä¸€è‡´è´¦æœ¬ + ç¼“å­˜         | èµ„äº§å®‰å…¨ã€äº¤æ˜“å¹‚ç­‰       | è™šæ‹Ÿç‰©å“äº¤æ˜“     |
| **æ´»åŠ¨ç­–åˆ’å…¬å¸**             | å¯¹è±¡å­˜å‚¨ + CDN + å¼ºç¼“å­˜       | MySQL + å¿«é€Ÿå‘å¸ƒ          | é«˜é¢‘æµ·æŠ¥æ›´æ–°             | æ´»åŠ¨è¿è¥ç³»ç»Ÿ     |
| **äºŒæ‰‹å¹³å°**                 | å¯¹è±¡å­˜å‚¨ + é£æ§å®¡æ ¸           | è®¢å•/å•†å“è¡¨ + å®¡è®¡        | å›¾ç‰‡å“ˆå¸Œå»é‡ã€é‰´é»„       | UGC å†…å®¹å¹³å°     |

### **ä½ é¡¹ç›®çš„å®šä½ä¸é€‰å‹ç†ç”±ï¼ˆåŸºäºæ‹æ¿å†³ç­–ï¼‰**

**é¡¹ç›®ç‰¹å¾**ï¼š

- ä¸šåŠ¡æ¨¡å¼ï¼š**ç§¯åˆ†æŠ½å¥– + è™šæ‹Ÿèµ„äº§ + C2C äº¤æ˜“**ï¼ˆç±»ä¼¼æ¸¸æˆå…¬å¸ï¼‰
- éƒ¨ç½²ç¯å¢ƒï¼š**Sealos Devbox**ï¼ˆå®¹å™¨åŒ–ã€å¤šå®ä¾‹ã€å†…ç½‘äº’è”ï¼‰
- æ‰©å®¹éœ€æ±‚ï¼š**å¼¹æ€§æ‰©å®¹**ï¼ˆç”¨æˆ·é‡å¢é•¿æ—¶è‡ªåŠ¨æ‰©å®¹ï¼‰
- å›¾ç‰‡ç±»å‹ï¼š**å…¨éƒ¨å…¬å¼€å±•ç¤º**ï¼ˆå¥–å“/Banner/å•†å“å›¾ï¼Œæ— æ•æ„Ÿå†…å®¹ï¼‰

**âœ… æœ€ç»ˆé€‰å‹ï¼ˆ2026-01-08 æ‹æ¿ï¼‰**ï¼š

- **å­˜å‚¨åç«¯**ï¼šSealos å¯¹è±¡å­˜å‚¨ï¼ˆS3 å…¼å®¹ï¼‰
- **CDN åŠ é€Ÿ**ï¼šCloudflare CDNï¼ˆå…è´¹é¢åº¦ + å…¨çƒåŠ é€Ÿ + å›¾ç‰‡ä¼˜åŒ–ï¼‰
- **å­˜å‚¨æ ¼å¼**ï¼šå¯¹è±¡ keyï¼ˆæ”¯æŒ CDN åŸŸååˆ‡æ¢ã€å…¬æœ‰/ç§æœ‰ç­–ç•¥æ¼”è¿›ï¼‰
- **è®¿é—®ç­–ç•¥**ï¼šå…¨éƒ¨ public-readï¼ˆæ— æ•æ„Ÿå›¾ç‰‡ï¼‰
- **ç¼©ç•¥å›¾**ï¼šURL å‚æ•°åŒ–ï¼ˆCloudflare Image Resizingï¼‰
- **ä¸Šä¼ é“¾è·¯**ï¼šå†…ç½‘ endpointï¼ˆSealos é›†ç¾¤å†…ä¸Šä¼ ï¼ŒèŠ‚çœæµé‡ï¼‰
- **æ¶æ„å¯¹æ ‡**ï¼š**æ´»åŠ¨ç­–åˆ’å…¬å¸ï¼ˆé«˜é¢‘ç´ ææ›´æ–°ï¼‰+ æ¸¸æˆå…¬å¸ï¼ˆäº¤æ˜“è´¦æœ¬é‡ã€å›¾ç‰‡å±•ç¤ºè½»ï¼‰**

### **ä¸åŒç±»é¡¹ç›®çš„å¯¹æ ‡**

| åŒç±»é¡¹ç›®                        | å›¾ç‰‡å­˜å‚¨                | ä½ çš„é€‰æ‹©                          | åŒ¹é…åº¦ |
| ------------------------------- | ----------------------- | --------------------------------- | ------ |
| **ç‹è€…è£è€€/åŸç¥**ï¼ˆè™šæ‹Ÿé“å…·ï¼‰   | å¯¹è±¡å­˜å‚¨ + å…¨çƒ CDN     | Sealos å¯¹è±¡å­˜å‚¨ + Cloudflare CDN  | âœ… é«˜  |
| **é—²é±¼/è½¬è½¬**ï¼ˆäºŒæ‰‹äº¤æ˜“ï¼‰       | å¯¹è±¡å­˜å‚¨ + å®¡æ ¸         | Sealos å¯¹è±¡å­˜å‚¨ï¼ˆæ— å®¡æ ¸ï¼Œå…¨å…¬å¼€ï¼‰ | âœ… ä¸­  |
| **é¥¿äº†ä¹ˆ/ç¾å›¢**ï¼ˆæ´»åŠ¨åˆ¸ï¼‰       | å¯¹è±¡å­˜å‚¨ + å¼ºç¼“å­˜       | Sealos å¯¹è±¡å­˜å‚¨ + Cloudflare ç¼“å­˜ | âœ… é«˜  |
| **æ´»åŠ¨ç­–åˆ’å…¬å¸**ï¼ˆæµ·æŠ¥/è½åœ°é¡µï¼‰ | å¯¹è±¡å­˜å‚¨ + CDN + ç‰ˆæœ¬åŒ– | Sealos å¯¹è±¡å­˜å‚¨ + Cloudflare      | âœ… é«˜  |
| **ä¸ªäººåšå®¢/å°ç«™**               | æœ¬åœ°ç£ç›˜ + Nginx        | âŒ ä¸é€‚ç”¨ï¼ˆä½ éœ€å¤šå®ä¾‹ï¼‰           | âŒ ä½  |

### **ä¸ºä»€ä¹ˆé€‰è¿™å¥—ç»„åˆ**

1. **Sealos Devbox å¤©ç„¶ä¼˜åŠ¿**ï¼šå†…ç½‘ä¸Šä¼ å¿«ä¸”çœé’±ã€å¤šå®ä¾‹æ— çŠ¶æ€ã€å®¹å™¨åŒ–éƒ¨ç½²å‹å¥½
2. **Cloudflare CDN å…è´¹é¢åº¦**ï¼šæ¯æœˆ 10GB å…è´¹æµé‡ã€å…¨çƒåŠ é€Ÿã€è‡ªåŠ¨å›¾ç‰‡ä¼˜åŒ–ï¼ˆWebP/AVIFï¼‰
3. **å¯¹è±¡ key å­˜å‚¨**ï¼šæ¢ CDN åŸŸåä¸æ”¹åº“ã€æ”¯æŒæœªæ¥ç§æœ‰å›¾ç‰‡ç­–ç•¥æ¼”è¿›ã€URL ç”Ÿæˆçµæ´»
4. **URL å‚æ•°åŒ–ç¼©ç•¥å›¾**ï¼šæ— éœ€åç«¯ç”Ÿæˆä¸å­˜å‚¨ã€ä¾èµ– Cloudflare Image Resizingã€é™çº§æ–¹æ¡ˆç®€å•ï¼ˆå‰ç«¯ CSSï¼‰
5. **å…¨å…¬å¼€ç­–ç•¥**ï¼šä½ å½“å‰æ— æ•æ„Ÿå›¾ç‰‡ï¼ˆæ— ç”¨æˆ·å‡­è¯/UGCï¼‰ï¼Œç®€åŒ–é‰´æƒä¸å®¡æ ¸æµç¨‹

---

## ğŸ“ é™„å½•ï¼šå…³é”®ä»£ç è·¯å¾„ç´¢å¼•

### **Sealos å¯¹è±¡å­˜å‚¨ç›¸å…³**

- æœåŠ¡å®ç°ï¼š`services/sealosStorage.js`
- ä½¿ç”¨ç¤ºä¾‹ï¼š`services/PopupBannerService.js`
- ç¯å¢ƒå˜é‡ï¼š`.env`ï¼ˆSEALOS\_\*ï¼‰
- é…ç½®æ¨¡æ¿ï¼š`config.example`ï¼ˆç¬¬ 56-72 è¡Œï¼‰

### **å›¾ç‰‡èµ„æºæ¨¡å‹**

- æ¨¡å‹å®šä¹‰ï¼š`models/ImageResources.js`
- å…³è”å…³ç³»ï¼š
  - `User.hasMany(ImageResources, { as: 'uploadedImages' })`
  - `LotteryPrize.belongsTo(ImageResources, { as: 'image' })`

### **ç¼©ç•¥å›¾æœåŠ¡**

- æœåŠ¡å®ç°ï¼š`services/ThumbnailService.js`
- ä¾èµ–ï¼š`sharp` åº“ï¼ˆnpm åŒ…ï¼‰
- ç”Ÿæˆç›®å½•ï¼š`uploads/thumbnails/`

### **ç®¡ç†ç«¯å›¾ç‰‡ä¸Šä¼ ç•Œé¢**

- å¼¹çª— Bannerï¼š`public/admin/popup-banners.html`
- å¥–å“ç®¡ç†ï¼š`public/admin/prizes.html`ï¼ˆä¸Šä¼ æœªå®ç°ï¼‰
- å•†å“ç®¡ç†ï¼š`public/admin/exchange-market-items.html`ï¼ˆä¸Šä¼ æœªå®ç°ï¼‰

---

## âœ… æ ¸æŸ¥æ–¹æ³•è®ºè¯´æ˜

### **æ•°æ®æ¥æº**

- âœ… çœŸå®æ•°æ®åº“è¿æ¥ï¼šNode.js + Sequelize + é¡¹ç›®ç¯å¢ƒå˜é‡
- âœ… ä»£ç è·¯å¾„åˆ†æï¼šgrep + codebase_search + æ–‡ä»¶è¯»å–
- âœ… ç‰©ç†æ–‡ä»¶éªŒè¯ï¼šls æ£€æŸ¥æœ¬åœ° uploads/ ç›®å½•
- âŒ **æœªä½¿ç”¨**ï¼šå¤‡ä»½æ–‡ä»¶ã€å†å²æŠ¥å‘Šã€å‡è®¾æ•°æ®

### **éªŒè¯æ‰‹æ®µ**

```bash
# æ•°æ®åº“è¿æ¥æµ‹è¯•
node -e "require('dotenv').config(); const {sequelize} = require('./config/database');
(async()=>{ await sequelize.authenticate(); console.log('DB OK'); })();"

# è¡¨ç»“æ„ä¸æ•°æ®æŠ½æ ·
SHOW COLUMNS FROM popup_banners;
SELECT * FROM image_resources LIMIT 5;

# ç¯å¢ƒå˜é‡æ£€æŸ¥ï¼ˆä¸æ‰“å°æ•æ„Ÿå€¼ï¼‰
node -e "require('dotenv').config(); console.log(Boolean(process.env.SEALOS_ENDPOINT));"
```

---

---

## ğŸ¯ æ¶æ„å†³ç­–æ€»ç»“ï¼ˆå¿«é€Ÿå‚è€ƒï¼‰

### **å·²æ‹æ¿å†³ç­–ï¼ˆ2026-01-08 22:30 æœ€ç»ˆç¡®è®¤ç‰ˆï¼‰**

| å†³ç­–é¡¹                 | é€‰æ‹©ç»“æœ                            | æ‰§è¡ŒçŠ¶æ€          |
| ---------------------- | ----------------------------------- | ----------------- |
| **å›¾ç‰‡å­˜å‚¨åç«¯**       | Sealos å¯¹è±¡å­˜å‚¨ï¼ˆS3 å…¼å®¹ï¼‰          | âœ… å·²å†³ç­–         |
| **è®¿é—®ç­–ç•¥**           | å…¨éƒ¨å…¬å¼€ï¼ˆpublic-read ACLï¼‰         | âœ… å·²å†³ç­–         |
| **URL æ ¼å¼**           | **å­˜å‚¨å¯¹è±¡ keyï¼ˆéå®Œæ•´ URLï¼‰**      | **âœ… å·²æ‹æ¿ç¡®è®¤** |
| **CDN åŠ é€Ÿ**           | Cloudflare CDNï¼ˆå·²é€‰å®šï¼‰            | âœ… å·²å†³ç­–         |
| **ç¼©ç•¥å›¾ç­–ç•¥**         | URL å‚æ•°åŒ–ï¼ˆä¼˜å…ˆï¼‰                  | âœ… å·²å†³ç­–         |
| **ä¸Šä¼ é“¾è·¯**           | å†…ç½‘ endpointï¼ˆSealos é›†ç¾¤å†…ï¼‰      | âœ… å·²å†³ç­–         |
| **éƒ¨ç½²æ¶æ„**           | å¤šå®ä¾‹ + å¼¹æ€§æ‰©å®¹                   | âœ… å·²å†³ç­–         |
| **æœ¬åœ°ç£ç›˜ /uploads**  | **ç«‹å³å½»åº•æ”¾å¼ƒï¼Œä¸å…¼å®¹**            | **âœ… å·²æ‹æ¿ç¡®è®¤** |
| **å¥–å“å›¾ä¸Šä¼ **         | å•ç‹¬ä¸Šä¼ æ¥å£ + å…³è” image_resources | âœ… å·²å†³ç­–         |
| **å•†å“å›¾ä½“ç³»**         | **ç»Ÿä¸€èµ° image_resources å…³è”**     | **âœ… å·²æ‹æ¿ç¡®è®¤** |
| **user_upload_review** | **ä¸ä¿ç•™ï¼ˆç«‹å³æ¸…ç†ï¼‰**              | **âœ… å·²æ‹æ¿ç¡®è®¤** |

### **è¿ç§»ä¼˜å…ˆçº§ï¼ˆåŸºäºæ‹æ¿å†³ç­– - 2026-01-08 22:30 æœ€ç»ˆç¡®è®¤ï¼‰**

| ä¼˜å…ˆçº§ | ä»»åŠ¡                                                                | é¢„è®¡å·¥ä½œé‡ | é£é™©ç­‰çº§ | å¤‡æ³¨                       |
| ------ | ------------------------------------------------------------------- | ---------- | -------- | -------------------------- |
| **P0** | æ”¹é€  SealosStorageServiceï¼ˆå†…ç½‘ä¸Šä¼  + è¿”å› keyï¼‰ã€âœ… å·²æ‹æ¿ç¡®è®¤ã€‘   | 0.5 å¤©     | ä½       | æ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼Œè¿”å›å¯¹è±¡ key |
| **P0** | å®ç°é€šç”¨å›¾ç‰‡ä¸Šä¼ æ¥å£ï¼ˆå•ç‹¬æ¥å£ï¼‰                                    | 0.5 å¤©     | ä½       | å¥–å“/å•†å“å¤ç”¨              |
| **P0** | å®ç°å¥–å“å›¾ç‰‡ä¸Šä¼ ï¼ˆå…³è” image_resourcesï¼‰                            | 0.5-1 å¤©   | ä½       | ç®¡ç†ç«¯æ€¥éœ€                 |
| **P0** | æ¸…ç†å†å²é—ç•™æ•°æ®ï¼ˆuser_upload_reviewï¼‰ã€âœ… å·²æ‹æ¿ç¡®è®¤ï¼šä¸ä¿ç•™ã€‘     | 0.2 å¤©     | ä½       | ç«‹å³åˆ é™¤ 2 æ¡è®°å½•          |
| **P0** | è¿ç§»å†å²å±•ç¤ºå›¾åˆ° Sealosï¼ˆå­˜å¯¹è±¡ keyï¼‰ã€âœ… å·²æ‹æ¿ç¡®è®¤ã€‘              | 0.5 å¤©     | ä¸­       | 1 æ¡è®°å½•ï¼Œéœ€å¤‡ä»½           |
| **P0** | åˆ é™¤æœ¬åœ° uploads/ æ–‡ä»¶ã€âœ… å·²æ‹æ¿ç¡®è®¤ï¼šå½»åº•æ”¾å¼ƒã€‘                   | 0.1 å¤©     | ä½       | å¤‡ä»½åç«‹å³åˆ é™¤             |
| **P1** | é…ç½® Cloudflare CDNï¼ˆåŸŸå + ç¼“å­˜è§„åˆ™ï¼‰                              | 0.5 å¤©     | ä½       | æµé‡ä¼˜åŒ–                   |
| **P1** | å®ç°å•†å“å›¾ç‰‡ä¸Šä¼ ï¼ˆå…³è” image_resourcesï¼‰ã€âœ… å·²æ‹æ¿ç¡®è®¤ç»Ÿä¸€èµ°å…³è”ã€‘ | 1 å¤©       | ä½       | è¿è¥é…ç½®èƒ½åŠ›               |
| **P1** | éªŒè¯ URL å‚æ•°åŒ–ç¼©ç•¥å›¾ï¼ˆCloudflareï¼‰                                 | 0.5 å¤©     | ä½       | ä¾èµ–å¹³å°èƒ½åŠ›               |
| **P2** | ç»Ÿä¸€å‰ç«¯å›¾ç‰‡å±•ç¤ºç»„ä»¶ï¼ˆimageUrlHelperï¼‰                              | 0.5 å¤©     | ä½       | ä»£ç è§„èŒƒ                   |
| **P2** | ç›‘æ§ CDN æµé‡ä¸æˆæœ¬                                                 | æŒç»­       | ä½       | è¿è¥ç›‘æ§                   |

### **é£é™©æç¤ºï¼ˆåŸºäºæ‹æ¿å†³ç­–ï¼‰**

âš ï¸ **è¿ç§»å‰å¿…åš**ï¼š

- å¤‡ä»½å½“å‰ `uploads/` ç›®å½•ï¼ˆtar å‹ç¼©ä¿å­˜ï¼‰
- å¤‡ä»½ `image_resources` è¡¨æ•°æ®ï¼ˆmysqldumpï¼‰
- **ä¸éœ€è¦å›æ»šæ–¹æ¡ˆ**ã€âœ… å·²æ‹æ¿ç¡®è®¤ï¼šå½»åº•æ”¾å¼ƒæœ¬åœ° /uploadsï¼Œä¸å…¼å®¹ã€‘
- âœ… ~~éªŒè¯ Sealos å†…ç½‘ endpoint å¯ç”¨æ€§~~ï¼ˆå·²éªŒè¯ï¼šDNS è§£ææ­£å¸¸ï¼Œé›†ç¾¤å†…å¯è¾¾ï¼‰

âš ï¸ **Sealos + Cloudflare ä¾èµ–**ï¼š

- ç¡®ä¿ Sealos å¯¹è±¡å­˜å‚¨ç¨³å®šæ€§ï¼ˆSLAã€å¤‡ä»½ç­–ç•¥ï¼‰
- ç›‘æ§ Sealos è´¹ç”¨ï¼ˆå­˜å‚¨è´¹ç”¨ + å†…ç½‘æµé‡å…è´¹ + å…¬ç½‘æµé‡è´¹ç”¨ï¼‰
- é…ç½® Cloudflare ç¼“å­˜è§„åˆ™ï¼ˆé¿å…é¢‘ç¹å›æºï¼‰
- éªŒè¯ Cloudflare Image Resizing å¯ç”¨æ€§ï¼ˆå¦‚ä¸å¯ç”¨ï¼Œé™çº§ä¸ºå‰ç«¯ CSSï¼‰
- é…ç½®å‘Šè­¦ï¼ˆSealos é…é¢ä¸è¶³ã€Cloudflare æµé‡å¼‚å¸¸ï¼‰

âš ï¸ **å¯¹è±¡ key å­˜å‚¨æ ¼å¼é£é™©**ã€âœ… å·²æ‹æ¿ç¡®è®¤ã€‘ï¼š

- ç¡®ä¿æ‰€æœ‰ API å“åº”éƒ½é€šè¿‡ `imageUrlHelper` ç”Ÿæˆå®Œæ•´ URL
- å‰ç«¯ä¸èƒ½ç›´æ¥æ‹¼æ¥æ•°æ®åº“å­—æ®µï¼ˆä¼šæ‹¼æ¥é”™è¯¯ï¼‰
- éœ€è¦åœ¨ API å±‚ç»Ÿä¸€å¤„ç† URL ç”Ÿæˆé€»è¾‘ï¼ˆå¢åŠ ä¸€å±‚æŠ½è±¡ï¼‰
- **ä¸å…¼å®¹æ—§æ–¹æ¡ˆ**ï¼šä¸å­˜å‚¨ `/uploads/...` æœ¬åœ°è·¯å¾„ã€ä¸å­˜å‚¨ `https://...` å®Œæ•´ URL

âš ï¸ **å†å²æ•°æ®æ¸…ç†é£é™©**ã€âœ… å·²æ‹æ¿ç¡®è®¤ï¼šuser_upload_review ä¸ä¿ç•™ã€‘ï¼š

- `user_upload_review` ç±»å‹æ•°æ®ç«‹å³åˆ é™¤ï¼ˆ2 æ¡è®°å½•ï¼‰
- åŠŸèƒ½å·²åºŸå¼ƒï¼Œæ— ä¸šåŠ¡ä¾èµ–
- **ä¸éœ€è¦è½¯åˆ é™¤è§‚å¯ŸæœŸ**ï¼šç›´æ¥ç‰©ç†åˆ é™¤

---

---

## ğŸ“‹ æ‹æ¿å†³ç­–æ‰§è¡Œæ£€æŸ¥æ¸…å•ï¼ˆ2026-01-08 æœ€ç»ˆç‰ˆï¼‰

### **æ ¸å¿ƒå†³ç­–ç¡®è®¤ï¼ˆ2026-01-08 22:30 æœ€ç»ˆç¡®è®¤ï¼‰**

- [x] **å›¾ç‰‡è®¿é—®ç­–ç•¥**ï¼šå…¨éƒ¨å…¬å¼€ï¼ˆæ— æ•æ„Ÿå›¾ç‰‡ï¼‰
- [x] **URL æ ¼å¼**ï¼š**å­˜å‚¨å¯¹è±¡ keyï¼ˆéå®Œæ•´ URLï¼‰**ã€âœ… å·²æ‹æ¿ç¡®è®¤ã€‘
- [x] **CDN é€‰å‹**ï¼šCloudflare CDN
- [x] **ç¼©ç•¥å›¾ç­–ç•¥**ï¼šURL å‚æ•°åŒ–ï¼ˆä¾èµ– Cloudflare Image Resizingï¼‰
- [x] **å¥–å“å›¾ä¸Šä¼ **ï¼šå•ç‹¬ä¸Šä¼ æ¥å£ + å…³è” `image_resources`
- [x] **å•†å“å›¾ä½“ç³»**ï¼š**ç»Ÿä¸€èµ° image_resources å…³è”**ã€âœ… å·²æ‹æ¿ç¡®è®¤ã€‘
- [x] **ä¸Šä¼ é“¾è·¯**ï¼šå†…ç½‘ endpointï¼ˆSealos é›†ç¾¤å†…ï¼‰
- [x] **æœ¬åœ°ç£ç›˜ /uploads**ï¼š**ç«‹å³å½»åº•æ”¾å¼ƒï¼Œä¸å…¼å®¹**ã€âœ… å·²æ‹æ¿ç¡®è®¤ã€‘
- [x] **user_upload_review**ï¼š**ä¸ä¿ç•™ï¼ˆç«‹å³æ¸…ç†ï¼‰**ã€âœ… å·²æ‹æ¿ç¡®è®¤ã€‘

### **å…³é”®å®æ–½è¦ç‚¹**

1. **æ”¹é€  `SealosStorageService`**ï¼š
   - è¿”å›å¯¹è±¡ keyï¼ˆè€Œé `result.Location`ï¼‰
   - ä¼˜å…ˆä½¿ç”¨å†…ç½‘ endpointï¼ˆ`SEALOS_INTERNAL_ENDPOINT`ï¼Œå·²éªŒè¯ï¼š`http://object-storage.objectstorage-system.svc.cluster.local`ï¼‰
   - æœ¬åœ°å¼€å‘è‡ªåŠ¨å›é€€å…¬ç½‘ endpointï¼ˆ`SEALOS_ENDPOINT`ï¼‰
2. **æ–°å¢ `imageUrlHelper`**ï¼šç»Ÿä¸€ URL ç”Ÿæˆï¼ˆCDN åŸŸå + å¯¹è±¡ keyï¼‰
3. **æ¸…ç† `user_upload_review`**ï¼šåˆ é™¤ 2 æ¡å†å²é—ç•™è®°å½•
4. **è¿ç§»å±•ç¤ºå‹ç´ æ**ï¼š1 æ¡ `lottery` ç±»å‹è®°å½•ï¼ˆ`/prizes/prize_001.jpg` â†’ `prizes/xxx.jpg`ï¼‰
5. **åºŸå¼ƒ `ThumbnailService`**ï¼šä¸å†åç«¯ç”Ÿæˆç¼©ç•¥å›¾
6. **ä¸é…ç½® `/uploads` é™æ€æ‰˜ç®¡**ï¼šæœ¬åœ°ç£ç›˜ä¸å†ä½¿ç”¨

### **å†…ç½‘ endpoint éªŒè¯ç»“æœï¼ˆ2026-01-08ï¼‰**

- **å½¢å¼**ï¼šK8s é›†ç¾¤å†…æœåŠ¡åŸŸåï¼ˆ`http://object-storage.objectstorage-system.svc.cluster.local`ï¼‰
- **DNS è§£æ**ï¼šâœ… æ­£å¸¸ï¼ˆ`10.96.108.241`ï¼Œé›†ç¾¤å†… IPï¼‰
- **å›é€€ç­–ç•¥**ï¼šæœ¬åœ°å¼€å‘ç¯å¢ƒç¼ºå¤±å†…ç½‘ DNS æ—¶è‡ªåŠ¨ä½¿ç”¨å…¬ç½‘ endpoint
- **é…ç½®ä½ç½®**ï¼š`.env` æ–‡ä»¶ï¼ˆ`SEALOS_INTERNAL_ENDPOINT`ï¼Œå¯é€‰ï¼ŒSealos éƒ¨ç½²ä¸“ç”¨ï¼‰

### **éªŒæ”¶æ ‡å‡†ï¼ˆåŸºäºæ‹æ¿å†³ç­– - 2026-01-08 22:30ï¼‰**

- [ ] æ‰€æœ‰ `image_resources.file_path` ä¸ºå¯¹è±¡ key æ ¼å¼ï¼ˆæ—  `/` å¼€å¤´ã€æ—  `http` å¼€å¤´ï¼‰ã€âœ… å·²æ‹æ¿ç¡®è®¤ã€‘
- [ ] API å“åº”åŒ…å«å®Œæ•´ CDN URLï¼ˆå‰ç«¯å¯ç›´æ¥ä½¿ç”¨ï¼‰
- [ ] å¥–å“å›¾ç‰‡å¯é€šè¿‡ç®¡ç†åå°ä¸Šä¼ å¹¶å±•ç¤º
- [ ] Cloudflare CDN ç¼“å­˜å‘½ä¸­ç‡ >90%
- [ ] URL å‚æ•°åŒ–ç¼©ç•¥å›¾å¯ç”¨ï¼ˆæˆ–å·²é™çº§ä¸ºå‰ç«¯ CSSï¼‰
- [ ] å†å² `user_upload_review` æ•°æ®å·²æ¸…ç†ï¼ˆ0 æ¡è®°å½•ï¼‰ã€âœ… å·²æ‹æ¿ç¡®è®¤ï¼šä¸ä¿ç•™ã€‘
- [ ] æœ¬åœ° `uploads/` ç›®å½•å·²åˆ é™¤ï¼ˆä»…ä¿ç•™ .gitkeep æˆ–ä¸ºç©ºï¼‰ã€âœ… å·²æ‹æ¿ç¡®è®¤ï¼šå½»åº•æ”¾å¼ƒã€‘
- [ ] `exchange_items.primary_image_id` å­—æ®µå·²æ·»åŠ å¹¶å…³è” `image_resources`ã€âœ… å·²æ‹æ¿ç¡®è®¤ç»Ÿä¸€èµ°å…³è”ã€‘

---

**æŠ¥å‘Šç”Ÿæˆå·¥å…·**ï¼šClaude Sonnet 4.5 + Cursor Agent  
**æ ¸æŸ¥äººå‘˜**ï¼šAI è‡ªåŠ¨åŒ–æ ¸æŸ¥  
**å†³ç­–è®°å½•**ï¼šé¡¹ç›®è´Ÿè´£äººå·²æ‹æ¿æœ€ç»ˆæ–¹æ¡ˆï¼ˆ2026-01-08ï¼‰  
**ä¸‹æ¬¡æ›´æ–°**ï¼šå®Œæˆé˜¶æ®µ 1-2 å®æ–½åæ›´æ–°æœ¬æŠ¥å‘Šç¬¬ 3 ç‰ˆï¼ˆè®°å½•å®é™…å¯¹è±¡ key æ ¼å¼ã€CDN æ€§èƒ½æ•°æ®ã€è¿ç§»ç»“æœï¼‰
