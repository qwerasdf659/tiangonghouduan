# å¾…å¤„ç†é—®é¢˜æ¸…å•

**ç”Ÿæˆæ—¶é—´**ï¼š2026å¹´01æœˆ09æ—¥  
**é¡¹ç›®ç‰ˆæœ¬**ï¼šV4.0.0  
**æ–‡æ¡£ç›®çš„**ï¼šè®°å½•å½“å‰ä»£ç ç°çŠ¶ä¸­éœ€è¦å¤„ç†çš„æŠ€æœ¯å€ºåŠ¡å’Œä¼˜åŒ–é¡¹  
**ä¼˜å…ˆçº§å®šä¹‰**ï¼š

-

## P1çº§é—®é¢˜ï¼ˆæ¶æ„ä¸€è‡´æ€§/å¯ç»´æŠ¤æ€§ï¼‰

### 6. ESLint ä»æœ‰ 87 ä¸ª warnings

**é—®é¢˜ç°çŠ¶**ï¼š

```bash
âœ– 87 problems (0 errors, 87 warnings)
```

**è­¦å‘Šç±»å‹åˆ†å¸ƒ**ï¼š

- `no-unused-vars`ï¼šçº¦10ä¸ªï¼ˆæµ‹è¯•æ–‡ä»¶ä¸­çš„æœªä½¿ç”¨å˜é‡ï¼‰
- `no-await-in-loop`ï¼šçº¦60ä¸ªï¼ˆå¾ªç¯ä¸­çš„ awaitï¼Œéƒ¨åˆ†åˆç†éƒ¨åˆ†å¯ä¼˜åŒ–ï¼‰
- `no-restricted-syntax`ï¼šçº¦10ä¸ªï¼ˆäº‹åŠ¡è¾¹ç•Œå‘Šè­¦ï¼Œä¸šåŠ¡ä¸€è‡´æ€§é—®é¢˜ï¼‰
- å…¶ä»–ï¼šçº¦7ä¸ª

**ä¸šåŠ¡é£é™©**ï¼š

- å™ªå£°è¿‡å¤§ï¼ŒçœŸå®é—®é¢˜å®¹æ˜“è¢«æ·¹æ²¡
- éƒ¨åˆ†è§„åˆ™ï¼ˆäº‹åŠ¡è¾¹ç•Œæç¤ºï¼‰æœ¬è´¨æ˜¯è´¨é‡é—¨æ§›ï¼Œå¿½ç•¥ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**ï¼š
åˆ†æ‰¹æ¸…ç†ï¼Œä¼˜å…ˆé¡ºåºï¼šno-unused-vars â†’ äº‹åŠ¡è¾¹ç•Œå‘Šè­¦ â†’ no-await-in-loop

**å®æ–½æ­¥éª¤**ï¼š

#### ç¬¬ä¸€æ‰¹ï¼šæ¸…ç† no-unused-varsï¼ˆé¢„è®¡å‡å°‘10ä¸ªè­¦å‘Šï¼‰

```bash
# 1. æŸ¥æ‰¾æ‰€æœ‰æœªä½¿ç”¨å˜é‡
npm run lint 2>&1 | grep "no-unused-vars"

# 2. é€ä¸ªä¿®å¤ï¼ˆåˆ é™¤æˆ–æ”¹ä¸º _variableNameï¼‰
# ç¤ºä¾‹ï¼š
# - tests/business/asset/phase3_migration.test.js:13 'sequelize' æœªä½¿ç”¨ â†’ åˆ é™¤
# - tests/business/auth/api.test.js:25 'test_user_id' æœªä½¿ç”¨ â†’ åˆ é™¤æˆ–ä½¿ç”¨
```

#### ç¬¬äºŒæ‰¹ï¼šæ ¸æŸ¥äº‹åŠ¡è¾¹ç•Œå‘Šè­¦ï¼ˆé¢„è®¡ä¿®å¤5-10ä¸ªçœŸå®é—®é¢˜ï¼‰

```bash
# 1. æŸ¥æ‰¾æ‰€æœ‰äº‹åŠ¡è¾¹ç•Œå‘Šè­¦
npm run lint 2>&1 | grep "no-restricted-syntax" | grep "äº‹åŠ¡è¾¹ç•Œ"

# 2. é€ä¸ªæ ¸æŸ¥æ˜¯å¦çœŸçš„ç¼º transaction
# ç¤ºä¾‹ï¼šroutes/v4/console/asset-adjustment.js:2070
# - æ£€æŸ¥ AssetService.changeBalance() è°ƒç”¨æ˜¯å¦åœ¨äº‹åŠ¡å†…
# - å¦‚æœç¼ºå¤±ï¼Œè¡¥å…… { transaction } å‚æ•°
# - å¦‚æœç¡®è®¤ä¸éœ€è¦ï¼Œæ·»åŠ  eslint-disable-next-line å¹¶æ³¨é‡Šè¯´æ˜åŸå› 
```

#### ç¬¬ä¸‰æ‰¹ï¼šä¼˜åŒ– no-await-in-loopï¼ˆä»…ä¼˜åŒ–å¯å¹¶è¡Œçš„åœºæ™¯ï¼‰

```bash
# 1. æŸ¥æ‰¾æ‰€æœ‰ no-await-in-loop
npm run lint 2>&1 | grep "no-await-in-loop"

# 2. åˆ†ç±»å¤„ç†ï¼š
# - å¯å¹¶è¡Œï¼šæ”¹ä¸º Promise.all()
#   ä¾‹å¦‚ï¼šæ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
#   const users = await Promise.all(userIds.map(id => User.findByPk(id)))
#
# - å¿…é¡»ä¸²è¡Œï¼šä¿ç•™å¹¶æ·»åŠ æ³¨é‡Š + eslint-disable
#   ä¾‹å¦‚ï¼šé¡ºåºæ‰§è¡Œçš„ä¸šåŠ¡æµç¨‹ï¼ˆå‘å¥– â†’ æ‰£åº“å­˜ â†’ è®°å½•æ—¥å¿—ï¼‰
#   // eslint-disable-next-line no-await-in-loop -- ä¸šåŠ¡è¦æ±‚é¡ºåºæ‰§è¡Œ
```

**é¢„æœŸæ•ˆæœ**ï¼š

- ç¬¬ä¸€æ‰¹å®Œæˆåï¼š87 â†’ 77 warnings
- ç¬¬äºŒæ‰¹å®Œæˆåï¼š77 â†’ 67 warningsï¼ˆå¹¶ä¿®å¤æ½œåœ¨çš„äº‹åŠ¡ä¸€è‡´æ€§é—®é¢˜ï¼‰
- ç¬¬ä¸‰æ‰¹å®Œæˆåï¼š67 â†’ 30-40 warningsï¼ˆå‰©ä½™çš„éƒ½æ˜¯åˆç†çš„ä¸²è¡Œé€»è¾‘ï¼‰

---

### 7. listing_expiry_days/ç›‘æ§é˜ˆå€¼æ˜¯å¦å…¨éƒ¨ä»¥ DB ä¸ºçœŸç›¸æº

**é—®é¢˜ä½ç½®**ï¼š

- `jobs/hourly-expire-fungible-asset-listings.js` å®šæ—¶ä»»åŠ¡
- `jobs/hourly-market-listing-monitor.js` ç›‘æ§ä»»åŠ¡
- `scripts/maintenance/scheduled-tasks.js` è°ƒåº¦é…ç½®

**é—®é¢˜ç°çŠ¶**ï¼š

è™½ç„¶ `MarketListingService` å·²æ”¹ä¸ºä» DB è¯»å– `max_active_listings` å’Œ `listing_expiry_days`ï¼Œä½†å®šæ—¶ä»»åŠ¡å’Œç›‘æ§é€»è¾‘å¯èƒ½ä»å­˜åœ¨ç¡¬ç¼–ç ï¼š

```javascript
// âŒ å¯èƒ½å­˜åœ¨çš„ç¡¬ç¼–ç 
const EXPIRY_DAYS = 3 // ç¡¬ç¼–ç è¿‡æœŸå¤©æ•°
const MONITOR_THRESHOLD_DAYS = 2 // ç¡¬ç¼–ç ç›‘æ§é˜ˆå€¼
```

**ä¸šåŠ¡é£é™©**ï¼š

- è¿è¥è°ƒæ•´é…ç½®åï¼Œå®šæ—¶ä»»åŠ¡ä»æŒ‰æ—§å€¼æ‰§è¡Œ
- ç›‘æ§å‘Šè­¦é˜ˆå€¼ä¸å®é™…ä¸šåŠ¡è§„åˆ™ä¸ä¸€è‡´
- é…ç½®ä¸ä¸€è‡´å¯¼è‡´ç”¨æˆ·å›°æƒ‘ï¼ˆä¸ºä»€ä¹ˆ3å¤©è¿˜æ²¡è¿‡æœŸï¼Ÿï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š

æ¢³ç† `jobs/*market*`ã€`scripts/maintenance/*` æ˜¯å¦è¯»å– `system_settings(marketplace/*)`ï¼›ä¸è¯»çš„æ”¹æˆè¯» DB

**å®æ–½æ­¥éª¤**ï¼š

1. æ£€æŸ¥æ‰€æœ‰å®šæ—¶ä»»åŠ¡å’Œç›‘æ§è„šæœ¬ï¼š

   ```bash
   # æŸ¥æ‰¾ç¡¬ç¼–ç çš„å¤©æ•°/é˜ˆå€¼
   grep -r "EXPIRY.*DAY\|THRESHOLD.*DAY\|= 3\|= 2" jobs/ scripts/maintenance/

   # æŸ¥æ‰¾æ˜¯å¦ä½¿ç”¨ AdminSystemService.getSettingValue
   grep -r "getSettingValue\|system_settings" jobs/ scripts/maintenance/
   ```

2. ä¿®æ”¹ `jobs/hourly-expire-fungible-asset-listings.js`ï¼š

   ```javascript
   // âœ… ä» DB è¯»å–é…ç½®
   async function expireFungibleAssetListings() {
     // è¯»å–è¿‡æœŸå¤©æ•°é…ç½®
     const expiryDays = await AdminSystemService.getSettingValue(
       'marketplace',
       'listing_expiry_days'
     )
     const expiryDaysNum = parseInt(expiryDays, 10) || 3 // å…œåº•å€¼

     logger.info('å¼€å§‹è¿‡æœŸæŒ‚ç‰Œæ£€æŸ¥', { expiry_days: expiryDaysNum })

     const expiryDate = new Date()
     expiryDate.setDate(expiryDate.getDate() - expiryDaysNum)

     // æŸ¥æ‰¾è¿‡æœŸæŒ‚ç‰Œ
     const expiredListings = await MarketListing.findAll({
       where: {
         status: 'on_sale',
         created_at: { [Op.lt]: expiryDate }
       }
     })

     // ... å¤„ç†è¿‡æœŸé€»è¾‘
   }
   ```

3. ä¿®æ”¹ `jobs/hourly-market-listing-monitor.js`ï¼š

   ```javascript
   // âœ… ä» DB è¯»å–ç›‘æ§é˜ˆå€¼
   async function monitorMarketListings() {
     // è¯»å–ç›‘æ§é…ç½®
     const monitorThresholdDays = await AdminSystemService.getSettingValue(
       'marketplace',
       'monitor_threshold_days'
     )
     const thresholdDays = parseInt(monitorThresholdDays, 10) || 2 // å…œåº•å€¼

     logger.info('å¼€å§‹å¸‚åœºç›‘æ§', { threshold_days: thresholdDays })

     // æŸ¥æ‰¾é•¿æœŸåœ¨å”®æŒ‚ç‰Œ
     const thresholdDate = new Date()
     thresholdDate.setDate(thresholdDate.getDate() - thresholdDays)

     const longTermListings = await MarketListing.findAll({
       where: {
         status: 'on_sale',
         created_at: { [Op.lt]: thresholdDate }
       }
     })

     if (longTermListings.length > 0) {
       logger.warn('å‘ç°é•¿æœŸåœ¨å”®æŒ‚ç‰Œ', {
         count: longTermListings.length,
         threshold_days: thresholdDays
       })

       // å‘é€å‘Šè­¦
       await NotificationService.sendAdminAlert({
         type: 'long_term_listings',
         count: longTermListings.length,
         threshold_days: thresholdDays
       })
     }
   }
   ```

4. åœ¨ `system_settings` è¡¨ä¸­æ·»åŠ ç›‘æ§é…ç½®ï¼ˆå¦‚æœç¼ºå¤±ï¼‰ï¼š

   ```sql
   -- æ·»åŠ ç›‘æ§é˜ˆå€¼é…ç½®
   INSERT INTO system_settings (setting_key, setting_value, value_type, description, created_at)
   VALUES
     ('marketplace/monitor_threshold_days', '2', 'number', 'C2Cå¸‚åœºç›‘æ§é˜ˆå€¼ï¼ˆå¤©ï¼‰', NOW())
   ON DUPLICATE KEY UPDATE
     setting_value = VALUES(setting_value),
     description = VALUES(description);
   ```

5. æ·»åŠ é…ç½®ä¸€è‡´æ€§æ£€æŸ¥è„šæœ¬ï¼š

   ```javascript
   // scripts/validation/check-marketplace-config-consistency.js
   const { AdminSystemService } = require('../../services/AdminSystemService')
   const { MarketListingService } = require('../../services/MarketListingService')

   async function checkConfigConsistency() {
     console.log('ğŸ” æ£€æŸ¥å¸‚åœºé…ç½®ä¸€è‡´æ€§...')

     // 1. æ£€æŸ¥å¿…éœ€é…ç½®æ˜¯å¦å­˜åœ¨
     const requiredConfigs = [
       'marketplace/max_active_listings',
       'marketplace/listing_expiry_days',
       'marketplace/monitor_threshold_days'
     ]

     const missingConfigs = []
     for (const key of requiredConfigs) {
       const [category, configKey] = key.split('/')
       const value = await AdminSystemService.getSettingValue(category, configKey)

       if (!value) {
         missingConfigs.push(key)
       } else {
         console.log(`âœ… ${key}: ${value}`)
       }
     }

     if (missingConfigs.length > 0) {
       console.error('âŒ ç¼ºå¤±é…ç½®:', missingConfigs)
       process.exit(1)
     }

     // 2. æ£€æŸ¥é…ç½®å€¼æ˜¯å¦åˆç†
     const expiryDays = parseInt(
       await AdminSystemService.getSettingValue('marketplace', 'listing_expiry_days'),
       10
     )
     const monitorThresholdDays = parseInt(
       await AdminSystemService.getSettingValue('marketplace', 'monitor_threshold_days'),
       10
     )

     if (monitorThresholdDays >= expiryDays) {
       console.warn('âš ï¸ ç›‘æ§é˜ˆå€¼åº”å°äºè¿‡æœŸå¤©æ•°', {
         monitor_threshold_days: monitorThresholdDays,
         listing_expiry_days: expiryDays
       })
     }

     console.log('âœ… å¸‚åœºé…ç½®ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡')
   }

   checkConfigConsistency().catch(console.error)
   ```

**é¢„æœŸæ•ˆæœ**ï¼š

- æ‰€æœ‰å®šæ—¶ä»»åŠ¡å’Œç›‘æ§é€»è¾‘ç»Ÿä¸€ä» DB è¯»å–é…ç½®
- è¿è¥è°ƒæ•´é…ç½®åï¼Œå®šæ—¶ä»»åŠ¡ç«‹å³ç”Ÿæ•ˆ
- é…ç½®ä¸€è‡´æ€§æ£€æŸ¥è„šæœ¬å¯åœ¨éƒ¨ç½²å‰éªŒè¯
- ç›‘æ§å‘Šè­¦é˜ˆå€¼ä¸å®é™…ä¸šåŠ¡è§„åˆ™ä¸€è‡´

---

### 8. å†å²å¹‚ç­‰è®°å½•é‡Œ api_path æ—§å€¼æ®‹ç•™

**é—®é¢˜ä½ç½®**ï¼š

- `api_idempotency_requests` è¡¨å†å²æ•°æ®
- `routes/v4/shop/assets/convert.js` å·²ä¿®æ­£ `api_path`

**é—®é¢˜ç°çŠ¶**ï¼š

è™½ç„¶å·²ä¿®æ­£è·¯ç”±ä»£ç ä¸­çš„ `api_path` è®°å½•ï¼ˆä» `/api/v4/assets/convert` æ”¹ä¸º `/api/v4/shop/assets/convert`ï¼‰ï¼Œä½†æ•°æ®åº“ä¸­å¯èƒ½å·²æœ‰æ—§è·¯å¾„çš„å¹‚ç­‰è¯·æ±‚è®°å½•ï¼š

```sql
-- å¯èƒ½å­˜åœ¨çš„æ—§æ•°æ®
SELECT * FROM api_idempotency_requests
WHERE api_path = '/api/v4/assets/convert';  -- æ—§è·¯å¾„
```

**ä¸šåŠ¡é£é™©**ï¼š

- å®¡è®¡æ’éšœæ—¶è·¯å¾„æ··ä¹±ï¼ˆåŒä¸€åŠŸèƒ½æœ‰ä¸¤ä¸ªè·¯å¾„ï¼‰
- å¹‚ç­‰æ€§æ£€æŸ¥å¯èƒ½å¤±æ•ˆï¼ˆæ–°æ—§è·¯å¾„ä¸åŒ¹é…ï¼‰
- ç»Ÿè®¡åˆ†æä¸å‡†ç¡®ï¼ˆåŒä¸€æ¥å£è¢«æ‹†æˆä¸¤æ¡è®°å½•ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š

ç¡®è®¤ `api_idempotency_requests` è¡¨é‡Œæ—§è·¯å¾„æ•°æ®æ˜¯å¦éœ€è¦è¿ç§»/æ¸…ç†ï¼ˆé¿å…å®¡è®¡ä¸æ’éšœæ··ä¹±ï¼‰

**å®æ–½æ­¥éª¤**ï¼š

1. æ£€æŸ¥å†å²æ•°æ®ä¸­çš„æ—§è·¯å¾„ï¼š

   ```sql
   -- æŸ¥æ‰¾æ‰€æœ‰æ—§è·¯å¾„çš„å¹‚ç­‰è®°å½•
   SELECT
     api_path,
     COUNT(*) as count,
     MIN(created_at) as first_request,
     MAX(created_at) as last_request
   FROM api_idempotency_requests
   WHERE api_path LIKE '/api/v4/assets/%'
   GROUP BY api_path
   ORDER BY api_path;
   ```

2. åˆ›å»ºæ•°æ®è¿ç§»è„šæœ¬ `migrations/YYYYMMDDHHMMSS-migrate-api-path-history.js`ï¼š

   ```javascript
   'use strict'

   module.exports = {
     async up(queryInterface, Sequelize) {
       console.log('ğŸ”„ å¼€å§‹è¿ç§»å†å² api_path æ•°æ®...')

       // è·¯å¾„æ˜ å°„è¡¨
       const pathMappings = [
         {
           old: '/api/v4/assets/convert',
           new: '/api/v4/shop/assets/convert',
           reason: 'ææ–™è½¬æ¢æ¥å£è·¯å¾„ä¿®æ­£'
         }
         // æœªæ¥å‘ç°å…¶ä»–è·¯å¾„å˜æ›´åœ¨æ­¤æ·»åŠ 
       ]

       for (const mapping of pathMappings) {
         const [result] = await queryInterface.sequelize.query(
           `UPDATE api_idempotency_requests 
            SET api_path = ?,
                meta = JSON_SET(
                  COALESCE(meta, '{}'),
                  '$.path_migrated_from', ?,
                  '$.path_migration_reason', ?,
                  '$.path_migration_at', NOW()
                )
            WHERE api_path = ?`,
           {
             replacements: [mapping.new, mapping.old, mapping.reason, mapping.old]
           }
         )

         console.log(`  âœ… ${mapping.old} â†’ ${mapping.new} (affected: ${result.affectedRows})`)
       }

       // éªŒè¯è¿ç§»ç»“æœ
       const [verification] = await queryInterface.sequelize.query(
         `SELECT api_path, COUNT(*) as count
          FROM api_idempotency_requests
          WHERE api_path LIKE '/api/v4/%assets%'
          GROUP BY api_path
          ORDER BY api_path`
       )

       console.log('  ğŸ“Š è¿ç§»åè·¯å¾„åˆ†å¸ƒ:')
       verification.forEach(row => {
         console.log(`     ${row.api_path}: ${row.count} æ¡è®°å½•`)
       })

       console.log('âœ… api_path å†å²æ•°æ®è¿ç§»å®Œæˆ')
     },

     async down(queryInterface, Sequelize) {
       console.log('ğŸ”„ å¼€å§‹å›æ»š api_path è¿ç§»...')

       // å›æ»šé€»è¾‘ï¼šä» meta ä¸­è¯»å–åŸå§‹è·¯å¾„
       await queryInterface.sequelize.query(
         `UPDATE api_idempotency_requests
          SET api_path = JSON_UNQUOTE(JSON_EXTRACT(meta, '$.path_migrated_from'))
          WHERE JSON_EXTRACT(meta, '$.path_migrated_from') IS NOT NULL`
       )

       console.log('âœ… api_path è¿ç§»å·²å›æ»š')
     }
   }
   ```

3. æ·»åŠ è·¯å¾„ä¸€è‡´æ€§æ£€æŸ¥åˆ°å¯åŠ¨éªŒè¯ï¼š

   ```javascript
   // scripts/validation/check-api-path-consistency.js
   async function checkApiPathConsistency() {
     console.log('ğŸ” æ£€æŸ¥ API è·¯å¾„ä¸€è‡´æ€§...')

     // 1. æŸ¥æ‰¾æ‰€æœ‰å¹‚ç­‰è®°å½•çš„è·¯å¾„
     const [paths] = await sequelize.query(
       `SELECT DISTINCT api_path 
        FROM api_idempotency_requests 
        ORDER BY api_path`
     )

     // 2. æ£€æŸ¥æ˜¯å¦æœ‰å·²çŸ¥çš„æ—§è·¯å¾„
     const knownOldPaths = [
       '/api/v4/assets/convert' // å·²åºŸå¼ƒ
     ]

     const foundOldPaths = paths.filter(row => knownOldPaths.includes(row.api_path))

     if (foundOldPaths.length > 0) {
       console.warn(
         'âš ï¸ å‘ç°æ—§è·¯å¾„è®°å½•:',
         foundOldPaths.map(p => p.api_path)
       )
       console.warn('   å»ºè®®è¿è¡Œè¿ç§»: npm run migration:run')
     } else {
       console.log('âœ… æœªå‘ç°æ—§è·¯å¾„è®°å½•')
     }

     // 3. æ£€æŸ¥è·¯å¾„æ ¼å¼è§„èŒƒ
     const invalidPaths = paths.filter(row => {
       const path = row.api_path
       // è·¯å¾„åº”è¯¥ä»¥ /api/v4/ å¼€å¤´
       return path && !path.startsWith('/api/v4/')
     })

     if (invalidPaths.length > 0) {
       console.warn(
         'âš ï¸ å‘ç°ä¸è§„èŒƒè·¯å¾„:',
         invalidPaths.map(p => p.api_path)
       )
     }

     console.log(`ğŸ“Š æ€»è®¡ ${paths.length} ä¸ªä¸åŒçš„ API è·¯å¾„`)
   }
   ```

4. æ·»åŠ å®šæœŸæ¸…ç†ç­–ç•¥ï¼ˆå¯é€‰ï¼‰ï¼š

   ```javascript
   // jobs/monthly-cleanup-old-idempotency-records.js
   module.exports = {
     name: 'monthly-cleanup-old-idempotency-records',
     schedule: '0 3 1 * *', // æ¯æœˆ1å·å‡Œæ™¨3ç‚¹
     async handler() {
       logger.info('å¼€å§‹æ¸…ç†è¿‡æœŸå¹‚ç­‰è®°å½•')

       // æ¸…ç†90å¤©å‰çš„å¹‚ç­‰è®°å½•
       const cutoffDate = new Date()
       cutoffDate.setDate(cutoffDate.getDate() - 90)

       const [result] = await sequelize.query(
         `DELETE FROM api_idempotency_requests 
          WHERE created_at < ? 
          AND status IN ('completed', 'failed')`,
         {
           replacements: [cutoffDate]
         }
       )

       logger.info('è¿‡æœŸå¹‚ç­‰è®°å½•æ¸…ç†å®Œæˆ', {
         deleted_count: result.affectedRows,
         cutoff_date: cutoffDate
       })
     }
   }
   ```

**é¢„æœŸæ•ˆæœ**ï¼š

- å†å²æ•°æ®ä¸­çš„æ—§è·¯å¾„ç»Ÿä¸€è¿ç§»åˆ°æ–°è·¯å¾„
- è¿ç§»è®°å½•ä¿ç•™åœ¨ `meta` å­—æ®µä¸­ï¼Œå¯è¿½æº¯
- å¯åŠ¨éªŒè¯å¯æ£€æµ‹è·¯å¾„ä¸ä¸€è‡´é—®é¢˜
- å®šæœŸæ¸…ç†è¿‡æœŸå¹‚ç­‰è®°å½•ï¼Œä¿æŒè¡¨å¤§å°å¯æ§

---

### 9. æœåŠ¡è·å–æ–¹å¼æœªå®Œå…¨ç»Ÿä¸€ï¼ˆä»æœ‰è·¯ç”±/æœåŠ¡ç›´æ¥ require Service çš„æƒ…å†µï¼‰

**é—®é¢˜ä½ç½®**ï¼š

- `routes/v4/console/marketplace.js` ç¬¬455è¡Œ

**é—®é¢˜ç°çŠ¶**ï¼š

```javascript
// âŒ ç›´æ¥ require Service
const MarketListingService = require('../../../services/MarketListingService')

// âœ… å…¶ä»–åœ°æ–¹å·²ç»Ÿä¸€ä½¿ç”¨ ServiceManager
const ExchangeService = req.app.locals.services.getService('exchangeMarket')
```

**ä¸šåŠ¡é£é™©**ï¼š

- è¿èƒŒ"è·¯ç”±é€šè¿‡ ServiceManager è·å– Service"çš„æ¶æ„çº¦æŸ
- åç»­ä¾èµ–ä¼šè¶Šæ¥è¶Šä¹±ï¼Œéš¾ä»¥è¿½è¸ªæœåŠ¡è°ƒç”¨å…³ç³»
- æ— æ³•ç»Ÿä¸€ç®¡ç†æœåŠ¡ç”Ÿå‘½å‘¨æœŸï¼ˆå¦‚çƒ­é‡è½½ã€ä¾èµ–æ³¨å…¥ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š
æŠŠ `MarketListingService` çº³å…¥ `ServiceManager` æ³¨å†Œï¼Œå¹¶åœ¨è·¯ç”±æ”¹ä¸º `req.app.locals.services.getService(...)`

**å®æ–½æ­¥éª¤**ï¼š

1. æ£€æŸ¥ `MarketListingService` æ˜¯å¦å·²åœ¨ `ServiceManager` æ³¨å†Œï¼š

   ```bash
   grep -r "MarketListingService" utils/ServiceManager.js app.js
   ```

2. å¦‚æœæœªæ³¨å†Œï¼Œåœ¨ `app.js` æˆ– `utils/ServiceManager.js` ä¸­æ·»åŠ æ³¨å†Œï¼š

   ```javascript
   // app.js ä¸­çš„æœåŠ¡æ³¨å†Œéƒ¨åˆ†
   const MarketListingService = require('./services/MarketListingService')
   serviceManager.registerService('marketListing', MarketListingService)
   ```

3. ä¿®æ”¹ `routes/v4/console/marketplace.js`ï¼š

   ```javascript
   // åˆ é™¤ç›´æ¥ require
   - const MarketListingService = require('../../../services/MarketListingService')

   // æ”¹ä¸ºé€šè¿‡ ServiceManager è·å–
   + const MarketListingService = req.app.locals.services.getService('marketListing')
   ```

4. å…¨å±€æœç´¢å…¶ä»–ç›´æ¥ require Service çš„æƒ…å†µï¼š

   ```bash
   grep -r "require.*Service\.js" routes/ | grep -v "ServiceManager"
   ```

5. é€ä¸ªä¿®æ”¹ä¸ºç»Ÿä¸€çš„ ServiceManager è·å–æ–¹å¼

**é¢„æœŸæ•ˆæœ**ï¼š

- æ‰€æœ‰è·¯ç”±ç»Ÿä¸€é€šè¿‡ `ServiceManager` è·å–æœåŠ¡
- æœåŠ¡ä¾èµ–å…³ç³»æ¸…æ™°å¯è¿½è¸ª
- ä¸ºåç»­æœåŠ¡å±‚ä¼˜åŒ–ï¼ˆå¦‚ä¾èµ–æ³¨å…¥ã€AOPï¼‰æ‰“ä¸‹åŸºç¡€

---

## P2çº§é—®é¢˜ï¼ˆè§„èŒƒ/ä¸€è‡´æ€§/é•¿æœŸæŠ€æœ¯å€ºï¼‰

### 10. è‡ªåŠ¨å¯¹è´¦ä¸å‘Šè­¦é—­ç¯

**é—®é¢˜ä½ç½®**ï¼š

- `jobs/hourly-market-listing-monitor.js` ç›‘æ§ä»»åŠ¡
- å‘Šè­¦æ¸ é“å’Œå¤„ç†æµç¨‹

**é—®é¢˜ç°çŠ¶**ï¼š

å½“å‰ç›‘æ§ä»»åŠ¡å¯ä»¥æ£€æµ‹å¼‚å¸¸ï¼ˆå¦‚"å†»ç»“>æŒ‚ç‰Œ""æŒ‚ç‰Œ>å†»ç»“""é•¿æœŸåœ¨å”®""å¼‚å¸¸ä»·æ ¼"ï¼‰ï¼Œä½†ï¼š

- å‘Šè­¦æ¸ é“ä¸æ˜ç¡®ï¼ˆä»…æ—¥å¿—ï¼Ÿè¿˜æ˜¯é€šçŸ¥ï¼Ÿï¼‰
- å‘Šè­¦é˜ˆå€¼ç¡¬ç¼–ç æˆ–ç¼ºå¤±
- ç¼ºå°‘å¤„ç† SOPï¼ˆå‘ç°é—®é¢˜åè°å¤„ç†ï¼Ÿæ€ä¹ˆå¤„ç†ï¼Ÿï¼‰

**ä¸šåŠ¡é£é™©**ï¼š

- å¼‚å¸¸è¢«æ£€æµ‹åˆ°ä½†æ— äººå¤„ç†
- å‘Šè­¦ç–²åŠ³ï¼ˆé˜ˆå€¼ä¸åˆç†å¯¼è‡´é¢‘ç¹å‘Šè­¦ï¼‰
- å¤„ç†æµç¨‹ä¸ç»Ÿä¸€ï¼ˆä¸åŒäººå¤„ç†æ–¹å¼ä¸åŒï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š

æŠŠ"å†»ç»“>æŒ‚ç‰Œ""æŒ‚ç‰Œ>å†»ç»“""é•¿æœŸåœ¨å”®""å¼‚å¸¸ä»·æ ¼"ç­‰ç›‘æ§çš„å‘Šè­¦æ¸ é“ã€é˜ˆå€¼ã€å¤„ç† SOP å›ºåŒ–ï¼ˆä»èµ° DB é…ç½®ï¼‰

**å®æ–½æ­¥éª¤**ï¼š

1. åœ¨ `system_settings` è¡¨ä¸­æ·»åŠ ç›‘æ§é…ç½®ï¼š

   ```sql
   -- ç›‘æ§å‘Šè­¦é…ç½®
   INSERT INTO system_settings (setting_key, setting_value, value_type, description, created_at)
   VALUES
     ('marketplace/alert_channels', 'admin_message,webhook', 'string', 'å‘Šè­¦æ¸ é“ï¼ˆé€—å·åˆ†éš”ï¼‰', NOW()),
     ('marketplace/long_term_listing_days', '7', 'number', 'é•¿æœŸåœ¨å”®å‘Šè­¦é˜ˆå€¼ï¼ˆå¤©ï¼‰', NOW()),
     ('marketplace/abnormal_price_ratio', '10', 'number', 'å¼‚å¸¸ä»·æ ¼å‘Šè­¦æ¯”ä¾‹ï¼ˆå€æ•°ï¼‰', NOW()),
     ('marketplace/frozen_mismatch_auto_fix', 'true', 'boolean', 'å†»ç»“ä¸åŒ¹é…æ˜¯å¦è‡ªåŠ¨ä¿®å¤', NOW())
   ON DUPLICATE KEY UPDATE
     setting_value = VALUES(setting_value),
     description = VALUES(description);
   ```

2. åˆ›å»ºç»Ÿä¸€çš„å‘Šè­¦æœåŠ¡ `services/MarketAlertService.js`ï¼š

   ```javascript
   class MarketAlertService {
     /**
      * å‘é€å¸‚åœºå‘Šè­¦
      * @param {string} alertType - å‘Šè­¦ç±»å‹
      * @param {Object} alertData - å‘Šè­¦æ•°æ®
      */
     static async sendAlert(alertType, alertData) {
       // è¯»å–å‘Šè­¦æ¸ é“é…ç½®
       const channelsStr = await AdminSystemService.getSettingValue('marketplace', 'alert_channels')
       const channels = channelsStr ? channelsStr.split(',') : ['admin_message']

       logger.info('å‘é€å¸‚åœºå‘Šè­¦', { alert_type: alertType, channels })

       // æ„é€ å‘Šè­¦æ¶ˆæ¯
       const alertMessage = this._buildAlertMessage(alertType, alertData)

       // å¹¶è¡Œå‘é€åˆ°æ‰€æœ‰æ¸ é“
       await Promise.allSettled(channels.map(channel => this._sendToChannel(channel, alertMessage)))
     }

     static _buildAlertMessage(alertType, alertData) {
       const templates = {
         frozen_mismatch: `æ£€æµ‹åˆ°å†»ç»“ä½™é¢ä¸åŒ¹é…ï¼š${alertData.count}æ¡è®°å½•`,
         long_term_listing: `æ£€æµ‹åˆ°é•¿æœŸåœ¨å”®æŒ‚ç‰Œï¼š${alertData.count}æ¡ï¼Œè¶…è¿‡${alertData.threshold_days}å¤©`,
         abnormal_price: `æ£€æµ‹åˆ°å¼‚å¸¸ä»·æ ¼æŒ‚ç‰Œï¼š${alertData.count}æ¡ï¼Œä»·æ ¼æ¯”ä¾‹è¶…è¿‡${alertData.ratio}å€`,
         orphan_frozen: `æ£€æµ‹åˆ°å­¤å„¿å†»ç»“ä½™é¢ï¼š${alertData.count}æ¡`
       }

       return {
         type: alertType,
         title: templates[alertType] || 'å¸‚åœºå¼‚å¸¸å‘Šè­¦',
         data: alertData,
         timestamp: new Date().toISOString()
       }
     }

     static async _sendToChannel(channel, message) {
       switch (channel) {
         case 'admin_message':
           // å‘é€ç«™å†…æ¶ˆæ¯ç»™æ‰€æœ‰ç®¡ç†å‘˜
           await NotificationService.sendToAllAdmins({
             type: 'market_alert',
             title: message.title,
             content: JSON.stringify(message.data),
             priority: 'high'
           })
           break

         case 'webhook':
           // å‘é€åˆ° Webhookï¼ˆå¦‚é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ï¼‰
           await this._sendWebhook(message)
           break

         case 'email':
           // å‘é€é‚®ä»¶å‘Šè­¦
           await this._sendEmail(message)
           break

         default:
           logger.warn('æœªçŸ¥å‘Šè­¦æ¸ é“', { channel })
       }
     }

     static async _sendWebhook(message) {
       const webhookUrl = process.env.MARKET_ALERT_WEBHOOK_URL
       if (!webhookUrl) {
         logger.warn('Webhook URL æœªé…ç½®')
         return
       }

       try {
         await fetch(webhookUrl, {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({
             msgtype: 'text',
             text: { content: `ã€å¸‚åœºå‘Šè­¦ã€‘${message.title}` }
           })
         })
       } catch (error) {
         logger.error('Webhook å‘é€å¤±è´¥', { error: error.message })
       }
     }
   }
   ```

3. ä¿®æ”¹ç›‘æ§ä»»åŠ¡ä½¿ç”¨ç»Ÿä¸€å‘Šè­¦æœåŠ¡ï¼š

   ```javascript
   // jobs/hourly-market-listing-monitor.js
   async function monitorMarketListings() {
     logger.info('å¼€å§‹å¸‚åœºç›‘æ§')

     // 1. æ£€æŸ¥é•¿æœŸåœ¨å”®æŒ‚ç‰Œ
     const longTermDays =
       parseInt(
         await AdminSystemService.getSettingValue('marketplace', 'long_term_listing_days'),
         10
       ) || 7

     const longTermListings = await this._findLongTermListings(longTermDays)
     if (longTermListings.length > 0) {
       await MarketAlertService.sendAlert('long_term_listing', {
         count: longTermListings.length,
         threshold_days: longTermDays,
         listings: longTermListings.slice(0, 10) // ä»…å‘é€å‰10æ¡
       })
     }

     // 2. æ£€æŸ¥å†»ç»“ä½™é¢ä¸åŒ¹é…
     const frozenMismatches = await this._findFrozenMismatches()
     if (frozenMismatches.length > 0) {
       // æ£€æŸ¥æ˜¯å¦è‡ªåŠ¨ä¿®å¤
       const autoFix = await AdminSystemService.getSettingValue(
         'marketplace',
         'frozen_mismatch_auto_fix'
       )

       if (autoFix === 'true') {
         // è‡ªåŠ¨è°ƒç”¨æ¸…ç†æœåŠ¡
         const result = await OrphanFrozenCleanupService.detectAndCleanup({
           dryRun: false,
           reason: 'auto_monitor_cleanup'
         })

         await MarketAlertService.sendAlert('frozen_mismatch', {
           count: frozenMismatches.length,
           auto_fixed: true,
           cleaned: result.cleaned
         })
       } else {
         // ä»…å‘Šè­¦ï¼Œä¸è‡ªåŠ¨ä¿®å¤
         await MarketAlertService.sendAlert('frozen_mismatch', {
           count: frozenMismatches.length,
           auto_fixed: false
         })
       }
     }

     // 3. æ£€æŸ¥å¼‚å¸¸ä»·æ ¼
     const abnormalPriceRatio =
       parseInt(
         await AdminSystemService.getSettingValue('marketplace', 'abnormal_price_ratio'),
         10
       ) || 10

     const abnormalPriceListings = await this._findAbnormalPriceListings(abnormalPriceRatio)
     if (abnormalPriceListings.length > 0) {
       await MarketAlertService.sendAlert('abnormal_price', {
         count: abnormalPriceListings.length,
         ratio: abnormalPriceRatio,
         listings: abnormalPriceListings.slice(0, 10)
       })
     }

     logger.info('å¸‚åœºç›‘æ§å®Œæˆ')
   }
   ```

4. åˆ›å»ºå‘Šè­¦å¤„ç† SOP æ–‡æ¡£ï¼š

   ````markdown
   # å¸‚åœºå‘Šè­¦å¤„ç† SOP

   ## å†»ç»“ä½™é¢ä¸åŒ¹é…

   **è§¦å‘æ¡ä»¶**ï¼š`account_asset_balances.frozen_amount > å®é™…æŒ‚ç‰Œå†»ç»“æ€»é¢`

   **å¤„ç†æµç¨‹**ï¼š

   1. å¦‚æœé…ç½®äº†è‡ªåŠ¨ä¿®å¤ï¼ˆ`frozen_mismatch_auto_fix=true`ï¼‰ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è§£å†»å¤šä½™éƒ¨åˆ†
   2. å¦‚æœæœªé…ç½®è‡ªåŠ¨ä¿®å¤ï¼Œç®¡ç†å‘˜éœ€æ‰‹åŠ¨è°ƒç”¨æ¸…ç†æ¥å£ï¼š
      ```bash
      POST /api/v4/console/orphan-frozen/cleanup
      ```
   ````

   3. æ£€æŸ¥å‘Šè­¦åŸå› ï¼Œå¦‚æœæ˜¯æµ‹è¯•/è„šæœ¬å¯¼è‡´ï¼Œéœ€ä¿®å¤æµ‹è¯•ä»£ç 

   ## é•¿æœŸåœ¨å”®æŒ‚ç‰Œ

   **è§¦å‘æ¡ä»¶**ï¼šæŒ‚ç‰Œåœ¨å”®æ—¶é—´è¶…è¿‡é…ç½®é˜ˆå€¼ï¼ˆé»˜è®¤7å¤©ï¼‰

   **å¤„ç†æµç¨‹**ï¼š
   1. æ£€æŸ¥æŒ‚ç‰Œæ˜¯å¦åˆç†ï¼ˆä»·æ ¼æ˜¯å¦è¿‡é«˜ï¼‰
   2. è”ç³»å–å®¶ç¡®è®¤æ˜¯å¦éœ€è¦è°ƒæ•´ä»·æ ¼æˆ–æ’¤å›
   3. å¦‚æœæ˜¯å¼‚å¸¸æŒ‚ç‰Œï¼Œç®¡ç†å‘˜å¯å¼ºåˆ¶æ’¤å›ï¼š
      ```bash
      POST /api/v4/console/marketplace/force-withdraw
      ```

   ## å¼‚å¸¸ä»·æ ¼æŒ‚ç‰Œ

   **è§¦å‘æ¡ä»¶**ï¼šæŒ‚ç‰Œä»·æ ¼æ¯”ä¾‹è¶…è¿‡é…ç½®é˜ˆå€¼ï¼ˆé»˜è®¤10å€ï¼‰

   **å¤„ç†æµç¨‹**ï¼š
   1. æ£€æŸ¥æ˜¯å¦ä¸ºæ¶æ„æŒ‚ç‰Œæˆ–æ“ä½œå¤±è¯¯
   2. è”ç³»å–å®¶ç¡®è®¤ä»·æ ¼
   3. å¦‚æœç¡®è®¤ä¸ºå¼‚å¸¸ï¼Œç®¡ç†å‘˜å¯å¼ºåˆ¶æ’¤å›

   ```

   ```

**é¢„æœŸæ•ˆæœ**ï¼š

- å‘Šè­¦æ¸ é“ç»Ÿä¸€ï¼ˆç«™å†…æ¶ˆæ¯ + Webhook + é‚®ä»¶ï¼‰
- å‘Šè­¦é˜ˆå€¼å¯é…ç½®ï¼ˆèµ° DB `system_settings`ï¼‰
- éƒ¨åˆ†å¼‚å¸¸å¯è‡ªåŠ¨ä¿®å¤ï¼ˆå¦‚å­¤å„¿å†»ç»“ï¼‰
- å¤„ç†æµç¨‹æ ‡å‡†åŒ–ï¼ˆSOP æ–‡æ¡£ï¼‰

---

### 11. ä¸¥æ ¼è·¯ç”±å±‚è§„èŒƒæ²»ç†

**é—®é¢˜ä½ç½®**ï¼š

- `routes/v4/**` æ‰€æœ‰è·¯ç”±æ–‡ä»¶

**é—®é¢˜ç°çŠ¶**ï¼š

è™½ç„¶å·²è¦æ±‚"è·¯ç”±é€šè¿‡ ServiceManager è·å–æœåŠ¡"ã€"è·¯ç”±ç¦æ­¢ç›´è¿ models"ã€"è·¯ç”±ç¦æ­¢è·¨è¡¨äº‹åŠ¡"ï¼Œä½†å¯èƒ½ä»å­˜åœ¨è¿è§„æƒ…å†µï¼š

```javascript
// âŒ è·¯ç”±ç›´è¿ models
const user = await User.findByPk(userId)

// âŒ è·¯ç”±å†…è·¨è¡¨äº‹åŠ¡
const transaction = await sequelize.transaction()
await User.update({...}, { transaction })
await Account.update({...}, { transaction })
await transaction.commit()

// âŒ ç›´æ¥ require Service
const UserService = require('../../../services/UserService')
```

**ä¸šåŠ¡é£é™©**ï¼š

- è¿èƒŒæ¶æ„çº¦æŸï¼Œä»£ç éš¾ä»¥ç»´æŠ¤
- äº‹åŠ¡è¾¹ç•Œä¸æ¸…æ™°ï¼Œå®¹æ˜“å‡ºç°æ•°æ®ä¸ä¸€è‡´
- æœåŠ¡ä¾èµ–æ··ä¹±ï¼Œæ— æ³•è¿½è¸ªè°ƒç”¨å…³ç³»

**è§£å†³æ–¹æ¡ˆ**ï¼š

å…¨é‡æ£€æŸ¥ `routes/v4/**` æ˜¯å¦éƒ½é€šè¿‡ ServiceManager è·å–æœåŠ¡ã€æ˜¯å¦å­˜åœ¨è·¯ç”±ç›´è¿ models/è·¨è¡¨äº‹åŠ¡ç­‰ï¼Œå‘ç°å³æ”¶å£åˆ° Service

**å®æ–½æ­¥éª¤**ï¼š

1. åˆ›å»ºè·¯ç”±è§„èŒƒæ£€æŸ¥è„šæœ¬ `scripts/validation/check-route-compliance.js`ï¼š

   ```javascript
   const fs = require('fs')
   const path = require('path')
   const glob = require('glob')

   async function checkRouteCompliance() {
     console.log('ğŸ” æ£€æŸ¥è·¯ç”±å±‚è§„èŒƒåˆè§„æ€§...')

     const routeFiles = glob.sync('routes/v4/**/*.js')
     const violations = []

     for (const file of routeFiles) {
       const content = fs.readFileSync(file, 'utf8')
       const fileViolations = []

       // 1. æ£€æŸ¥æ˜¯å¦ç›´æ¥ require Serviceï¼ˆåº”è¯¥é€šè¿‡ ServiceManagerï¼‰
       const serviceRequirePattern = /require\(['"].*\/services\/\w+Service['"]\)/g
       if (serviceRequirePattern.test(content)) {
         fileViolations.push({
           type: 'DIRECT_SERVICE_REQUIRE',
           message: 'è·¯ç”±ç›´æ¥ require Serviceï¼Œåº”é€šè¿‡ ServiceManager è·å–'
         })
       }

       // 2. æ£€æŸ¥æ˜¯å¦ç›´æ¥ä½¿ç”¨ modelsï¼ˆåº”è¯¥é€šè¿‡ Serviceï¼‰
       const modelPatterns = [
         /await\s+User\.find/,
         /await\s+Account\.find/,
         /await\s+MarketListing\.find/,
         /await\s+\w+\.create\(/,
         /await\s+\w+\.update\(/,
         /await\s+\w+\.destroy\(/
       ]

       for (const pattern of modelPatterns) {
         if (pattern.test(content)) {
           fileViolations.push({
             type: 'DIRECT_MODEL_ACCESS',
             message: 'è·¯ç”±ç›´æ¥è®¿é—® modelsï¼Œåº”é€šè¿‡ Service å°è£…'
           })
           break
         }
       }

       // 3. æ£€æŸ¥æ˜¯å¦åœ¨è·¯ç”±å†…åˆ›å»ºäº‹åŠ¡ï¼ˆåº”è¯¥åœ¨ Service å†…ï¼‰
       if (content.includes('sequelize.transaction()')) {
         fileViolations.push({
           type: 'TRANSACTION_IN_ROUTE',
           message: 'è·¯ç”±å†…åˆ›å»ºäº‹åŠ¡ï¼Œåº”åœ¨ Service å†…å¤„ç†'
         })
       }

       if (fileViolations.length > 0) {
         violations.push({
           file: file,
           violations: fileViolations
         })
       }
     }

     // è¾“å‡ºæ£€æŸ¥ç»“æœ
     if (violations.length === 0) {
       console.log('âœ… æ‰€æœ‰è·¯ç”±æ–‡ä»¶ç¬¦åˆè§„èŒƒ')
       return
     }

     console.error(`âŒ å‘ç° ${violations.length} ä¸ªæ–‡ä»¶å­˜åœ¨è§„èŒƒè¿è§„:`)
     violations.forEach(({ file, violations: fileViolations }) => {
       console.error(`\nğŸ“ ${file}:`)
       fileViolations.forEach(v => {
         console.error(`   âŒ ${v.type}: ${v.message}`)
       })
     })

     process.exit(1)
   }

   checkRouteCompliance().catch(console.error)
   ```

2. å°†æ£€æŸ¥è„šæœ¬åŠ å…¥ CI/CD æµç¨‹ï¼š

   ```json
   // package.json
   {
     "scripts": {
       "validate:routes": "node scripts/validation/check-route-compliance.js",
       "pretest": "npm run validate:routes"
     }
   }
   ```

3. é€ä¸ªä¿®å¤è¿è§„è·¯ç”±ï¼ˆç¤ºä¾‹ï¼‰ï¼š

   ```javascript
   // âŒ ä¿®å¤å‰ï¼šroutes/v4/console/marketplace.js
   const MarketListingService = require('../../../services/MarketListingService')

   router.post('/force-withdraw', async (req, res) => {
     const { listing_id } = req.body

     // ç›´æ¥è®¿é—® models
     const listing = await MarketListing.findByPk(listing_id)

     // è·¯ç”±å†…äº‹åŠ¡
     const transaction = await sequelize.transaction()
     try {
       await listing.update({ status: 'withdrawn' }, { transaction })
       await AccountAssetBalance.update({...}, { transaction })
       await transaction.commit()
     } catch (error) {
       await transaction.rollback()
       throw error
     }

     return res.apiSuccess(listing)
   })

   // âœ… ä¿®å¤å
   router.post('/force-withdraw', async (req, res) => {
     const { listing_id } = req.body

     // é€šè¿‡ ServiceManager è·å–æœåŠ¡
     const MarketListingService = req.app.locals.services.getService('marketListing')

     // è°ƒç”¨ Service æ–¹æ³•ï¼ˆäº‹åŠ¡åœ¨ Service å†…å¤„ç†ï¼‰
     const result = await MarketListingService.adminForceWithdraw(
       listing_id,
       req.user.user_id,
       {
         reason: req.body.reason || 'admin_force_withdraw'
       }
     )

     return res.apiSuccess(result, 'å¼ºåˆ¶æ’¤å›æˆåŠŸ')
   })
   ```

4. æ·»åŠ  ESLint è§„åˆ™å¼ºåˆ¶æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰ï¼š

   ```javascript
   // .eslintrc.js
   module.exports = {
     rules: {
       'no-restricted-syntax': [
         'error',
         {
           selector: "CallExpression[callee.name='require'][arguments.0.value=/\\/services\\//]",
           message: 'è·¯ç”±ç¦æ­¢ç›´æ¥ require Serviceï¼Œè¯·é€šè¿‡ ServiceManager è·å–'
         },
         {
           selector:
             'MemberExpression[object.name=/^(User|Account|MarketListing)$/][property.name=/^(find|create|update|destroy)$/]',
           message: 'è·¯ç”±ç¦æ­¢ç›´æ¥è®¿é—® modelsï¼Œè¯·é€šè¿‡ Service å°è£…'
         }
       ]
     }
   }
   ```

**é¢„æœŸæ•ˆæœ**ï¼š

- æ‰€æœ‰è·¯ç”±ç»Ÿä¸€é€šè¿‡ ServiceManager è·å–æœåŠ¡
- è·¯ç”±ä¸å†ç›´æ¥è®¿é—® models
- äº‹åŠ¡é€»è¾‘å…¨éƒ¨æ”¶å£åˆ° Service å±‚
- CI/CD æµç¨‹è‡ªåŠ¨æ£€æŸ¥è§„èŒƒåˆè§„æ€§

---

### 12. å»é™¤é V4 çš„æ®‹ç•™ä¸æ— ç”¨æ¨¡å—ï¼ˆæŒ‰ä½ è¦æ±‚ï¼šä¸åšå‘åå…¼å®¹ï¼‰

**é—®é¢˜ä½ç½®**ï¼š

- å¯èƒ½å­˜åœ¨çš„æ—§ç‰ˆæœ¬è·¯ç”±ï¼ˆ`routes/v1/`ã€`routes/v2/`ã€`routes/v3/`ï¼‰
- æ—§ç­–ç•¥æ–‡ä»¶ï¼ˆå¦‚æ—§æŠ½å¥–ç­–ç•¥ï¼‰
- å…¼å®¹å±‚ä»£ç 

**é—®é¢˜ç°çŠ¶**ï¼š

è™½ç„¶å·²æ˜ç¡®"ä¸åšå‘åå…¼å®¹"ã€"åªä¿ç•™ V4"ï¼Œä½†å¯èƒ½ä»å­˜åœ¨ï¼š

```javascript
// âŒ æ—§ç‰ˆæœ¬è·¯ç”±
routes / v3 / lottery.js

// âŒ æ—§ç­–ç•¥æ–‡ä»¶
strategies / OldLotteryStrategy.js

// âŒ å…¼å®¹å±‚ä»£ç 
if (req.apiVersion === 'v3') {
  // å…¼å®¹æ—§ç‰ˆæœ¬é€»è¾‘
}
```

**ä¸šåŠ¡é£é™©**ï¼š

- ä»£ç å†—ä½™ï¼Œå¢åŠ ç»´æŠ¤æˆæœ¬
- å®¹æ˜“è¯¯ç”¨æ—§ä»£ç 
- æ–°äººä¸æ¸…æ¥šå“ªäº›ä»£ç æ˜¯æœ‰æ•ˆçš„

**è§£å†³æ–¹æ¡ˆ**ï¼š

å…¨åº“æ‰«ææ—§ç‰ˆæœ¬è·¯ç”±/æ—§ç­–ç•¥/å…¼å®¹å±‚ï¼Œæ˜ç¡®åˆ é™¤æˆ–è¿ç§»åˆå¹¶åˆ° V4 å”¯ä¸€å®ç°

**å®æ–½æ­¥éª¤**ï¼š

1. æ‰«ææ—§ç‰ˆæœ¬è·¯ç”±å’Œç­–ç•¥ï¼š

   ```bash
   # æŸ¥æ‰¾æ—§ç‰ˆæœ¬è·¯ç”±
   find routes/ -type d -name "v1" -o -name "v2" -o -name "v3"

   # æŸ¥æ‰¾æ—§ç­–ç•¥æ–‡ä»¶
   find strategies/ -name "*Old*" -o -name "*Legacy*" -o -name "*Deprecated*"

   # æŸ¥æ‰¾å…¼å®¹å±‚ä»£ç 
   grep -r "apiVersion.*v[123]" routes/ services/
   grep -r "backward.*compat" routes/ services/
   ```

2. åˆ›å»ºæ¸…ç†è„šæœ¬ `scripts/cleanup/remove-legacy-code.sh`ï¼š

   ```bash
   #!/bin/bash

   echo "ğŸ—‘ï¸ å¼€å§‹æ¸…ç†æ—§ç‰ˆæœ¬ä»£ç ..."

   # 1. åˆ é™¤æ—§ç‰ˆæœ¬è·¯ç”±ç›®å½•
   for version in v1 v2 v3; do
     if [ -d "routes/$version" ]; then
       echo "  åˆ é™¤ routes/$version/"
       rm -rf "routes/$version"
     fi
   done

   # 2. åˆ é™¤æ—§ç­–ç•¥æ–‡ä»¶
   find strategies/ -name "*Old*" -o -name "*Legacy*" -delete

   # 3. æŸ¥æ‰¾å¹¶æŠ¥å‘Šå…¼å®¹å±‚ä»£ç ï¼ˆéœ€æ‰‹åŠ¨å¤„ç†ï¼‰
   echo ""
   echo "ğŸ“‹ éœ€è¦æ‰‹åŠ¨æ¸…ç†çš„å…¼å®¹å±‚ä»£ç :"
   grep -rn "apiVersion.*v[123]" routes/ services/ || echo "  æœªå‘ç°"
   grep -rn "backward.*compat" routes/ services/ || echo "  æœªå‘ç°"

   echo ""
   echo "âœ… æ—§ç‰ˆæœ¬ä»£ç æ¸…ç†å®Œæˆ"
   ```

3. æ£€æŸ¥ `app.js` ä¸­çš„è·¯ç”±æ³¨å†Œï¼š

   ```javascript
   // âŒ åˆ é™¤æ—§ç‰ˆæœ¬è·¯ç”±æ³¨å†Œ
   // app.use('/api/v1', require('./routes/v1'))
   // app.use('/api/v2', require('./routes/v2'))
   // app.use('/api/v3', require('./routes/v3'))

   // âœ… ä»…ä¿ç•™ V4
   app.use('/api/v4', require('./routes/v4'))
   ```

4. æ›´æ–°æ–‡æ¡£å’Œæ³¨é‡Šï¼š

   ```javascript
   // âŒ åˆ é™¤æ—§ç‰ˆæœ¬ç›¸å…³æ³¨é‡Š
   /**
    * å…¼å®¹ V3 ç‰ˆæœ¬çš„æ—§æ¥å£
    * @deprecated ä½¿ç”¨ V4 æ¥å£æ›¿ä»£
    */

   // âœ… æ›´æ–°ä¸º V4 æ³¨é‡Š
   /**
    * V4 ç»Ÿä¸€æ¥å£
    * @since V4.0.0
    */
   ```

**é¢„æœŸæ•ˆæœ**ï¼š

- åˆ é™¤æ‰€æœ‰æ—§ç‰ˆæœ¬è·¯ç”±ï¼ˆv1/v2/v3ï¼‰
- åˆ é™¤æ‰€æœ‰æ—§ç­–ç•¥å’Œå…¼å®¹å±‚ä»£ç 
- ä»£ç åº“æ›´æ¸…æ™°ï¼Œä»…ä¿ç•™ V4 å®ç°
- æ–°äººå¿«é€Ÿç†è§£ä»£ç ç»“æ„

---

### 13. æµ‹è¯•ç¯å¢ƒé…ç½®åŠ è½½é“¾è·¯éœ€è¦è¿›ä¸€æ­¥ç»Ÿä¸€

**é—®é¢˜ä½ç½®**ï¼š

- `jest.setup.js` ç¬¬13è¡Œï¼š`require('dotenv').config()`
- `tests/helpers/test-setup.js` ç¬¬9-11è¡Œï¼šå¤‡ç”¨ dotenv åŠ è½½é€»è¾‘

**é—®é¢˜ç°çŠ¶**ï¼š

```javascript
// jest.setup.js
require('dotenv').config() // ä¸»å…¥å£

// tests/helpers/test-setup.js
if (!process.env.DB_HOST) {
  require('dotenv').config() // å¤‡ç”¨å…¥å£
}
```

**ä¸šåŠ¡é£é™©**ï¼š

- æœªæ¥å®¹æ˜“å‡ºç°"è°è¦†ç›–è°"çš„è¯¯è§£
- è°ƒè¯•æ—¶éš¾ä»¥ç¡®å®šé…ç½®æ¥æº
- å¯èƒ½å¯¼è‡´æµ‹è¯•ç¯å¢ƒä¸å¼€å‘ç¯å¢ƒé…ç½®ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**ï¼š
æ˜ç¡®å”¯ä¸€å…¥å£ï¼ˆåªåœ¨ `jest.setup.js` åŠ è½½ dotenvï¼‰ï¼Œ`tests/helpers/test-setup.js` åªåšæ–­è¨€å·¥å…·ä¸éæ•æ„Ÿå…œåº•

**å®æ–½æ­¥éª¤**ï¼š

1. ä¿®æ”¹ `tests/helpers/test-setup.js`ï¼Œç§»é™¤ dotenv åŠ è½½é€»è¾‘ï¼š

   ```javascript
   // åˆ é™¤å¤‡ç”¨åŠ è½½é€»è¾‘
   - if (!process.env.DB_HOST) {
   -   require('dotenv').config()
   - }

   // æ·»åŠ æ˜ç¡®çš„æ³¨é‡Šè¯´æ˜
   + /**
   +  * æ³¨æ„ï¼šç¯å¢ƒå˜é‡ç”± jest.setup.js ç»Ÿä¸€åŠ è½½
   +  * æ­¤æ–‡ä»¶ä»…æä¾›æµ‹è¯•å·¥å…·ç±»å’Œéæ•æ„Ÿé…ç½®å…œåº•
   +  */
   ```

2. åœ¨ `jest.setup.js` é¡¶éƒ¨æ·»åŠ æ³¨é‡Šè¯´æ˜ï¼š

   ```javascript
   /**
    * Jestæµ‹è¯•ç¯å¢ƒè®¾ç½® - å”¯ä¸€é…ç½®å…¥å£
    *
    * èŒè´£ï¼š
    * 1. ä» .env åŠ è½½æ‰€æœ‰ç¯å¢ƒå˜é‡ï¼ˆå•ä¸€çœŸç›¸æºï¼‰
    * 2. è®¾ç½®æµ‹è¯•ä¸“ç”¨é…ç½®ï¼ˆNODE_ENVã€è¶…æ—¶æ—¶é—´ç­‰ï¼‰
    * 3. æä¾›éæ•æ„Ÿé…ç½®çš„å…œåº•å€¼
    *
    * âš ï¸ å…¶ä»–æµ‹è¯•æ–‡ä»¶ä¸åº”å†åŠ è½½ dotenv
    */
   require('dotenv').config()
   ```

3. æ·»åŠ ç¯å¢ƒå˜é‡åŠ è½½éªŒè¯ï¼š
   ```javascript
   // jest.setup.js æœ«å°¾æ·»åŠ 
   if (!process.env.DB_HOST || !process.env.DB_NAME) {
     console.error('âŒ ç¯å¢ƒå˜é‡åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ .env æ–‡ä»¶æ˜¯å¦å­˜åœ¨')
     process.exit(1)
   }
   ```

**é¢„æœŸæ•ˆæœ**ï¼š

- é…ç½®åŠ è½½é“¾è·¯æ¸…æ™°ï¼š`.env` â†’ `jest.setup.js` â†’ æ‰€æœ‰æµ‹è¯•
- é¿å…å¤šå¤„åŠ è½½å¯¼è‡´çš„é…ç½®è¦†ç›–é—®é¢˜
- é…ç½®ç¼ºå¤±æ—¶èƒ½ç«‹å³å‘ç°å¹¶æŠ¥é”™

---

### 6. å¥åº·æ£€æŸ¥è¿”å›å­—æ®µä¸è§£æè„šæœ¬ä¸ä¸€è‡´

**é—®é¢˜ä½ç½®**ï¼š

- `/health` æ¥å£è¿”å›çš„æ•°æ®ç»“æ„
- å„å¤„å¥åº·æ£€æŸ¥è§£æè„šæœ¬

**é—®é¢˜ç°çŠ¶**ï¼š

```javascript
// å®é™…è¿”å›ç»“æ„
{
  "data": {
    "status": "healthy",
    "systems": {
      "database": "connected",
      "redis": "connected"
    }
  }
}

// è„šæœ¬å°è¯•è§£æçš„ç»“æ„ï¼ˆé”™è¯¯ï¼‰
checks.database.status  // å®é™…ä¸å­˜åœ¨
checks.redis.status     // å®é™…ä¸å­˜åœ¨
```

**ä¸šåŠ¡é£é™©**ï¼š

- è¿ç»´è„šæœ¬/ç›‘æ§è¯¯åˆ¤ï¼ˆæ˜¾ç¤º unknownï¼‰
- CI/CD æµç¨‹ä¸­çš„å¥åº·æ£€æŸ¥å¯èƒ½å¤±æ•ˆ
- å‘Šè­¦ç³»ç»Ÿæ— æ³•æ­£ç¡®è¯†åˆ«æœåŠ¡çŠ¶æ€

**è§£å†³æ–¹æ¡ˆ**ï¼š
ç»Ÿä¸€å¥åº·æ£€æŸ¥å“åº”å¥‘çº¦ï¼Œæˆ–åŒæ­¥æ›´æ–°æ‰€æœ‰è§£æè„šæœ¬ï¼ˆåªä¿ç•™ä¸€ç§ï¼Œä¸åšå…¼å®¹ä¸¤å¥—ï¼‰

**å®æ–½æ­¥éª¤**ï¼š

#### æ–¹æ¡ˆAï¼šä¿®æ”¹è§£æè„šæœ¬ï¼ˆæ¨èï¼Œä¸æ”¹æ¥å£ï¼‰

```bash
# 1. æŸ¥æ‰¾æ‰€æœ‰å¥åº·æ£€æŸ¥è§£æè„šæœ¬
grep -r "checks.database" scripts/ docs/ .github/

# 2. ç»Ÿä¸€ä¿®æ”¹ä¸ºæ­£ç¡®çš„è§£æè·¯å¾„
# æ—§ï¼šd.get('checks',{}).get('database',{}).get('status','unknown')
# æ–°ï¼šd.get('data',{}).get('systems',{}).get('database','unknown')
```

#### æ–¹æ¡ˆBï¼šä¿®æ”¹æ¥å£å“åº”ï¼ˆå¦‚æœå›¢é˜Ÿçº¦å®šéœ€è¦ checks å­—æ®µï¼‰

```javascript
// routes/v4/system.js ä¸­çš„ /health æ¥å£
return res.apiSuccess({
  status: 'healthy',
  systems: { database: 'connected', redis: 'connected' },
  // æ·»åŠ  checks å­—æ®µä»¥å…¼å®¹æ—§è„šæœ¬
  checks: {
    database: { status: 'connected' },
    redis: { status: 'connected' }
  }
})
```

**å®æ–½å»ºè®®**ï¼š

- ä¼˜å…ˆé‡‡ç”¨æ–¹æ¡ˆAï¼ˆä¿®æ”¹è„šæœ¬ï¼‰ï¼Œä¿æŒæ¥å£ç®€æ´
- å¦‚æœå¤–éƒ¨ç³»ç»Ÿä¾èµ–æ—§æ ¼å¼ï¼Œåˆ™é‡‡ç”¨æ–¹æ¡ˆBï¼ˆåŒæ—¶è¿”å›ä¸¤ç§æ ¼å¼ï¼‰
- æ— è®ºå“ªç§æ–¹æ¡ˆï¼Œéƒ½è¦åœ¨æ–‡æ¡£ä¸­æ˜ç¡®å¥åº·æ£€æŸ¥å“åº”å¥‘çº¦

**é¢„æœŸæ•ˆæœ**ï¼š

- å¥åº·æ£€æŸ¥è§£æè„šæœ¬èƒ½æ­£ç¡®è¯†åˆ«æœåŠ¡çŠ¶æ€
- è¿ç»´ç›‘æ§/å‘Šè­¦ç³»ç»Ÿæ­£å¸¸å·¥ä½œ
- å“åº”æ ¼å¼ç»Ÿä¸€ï¼Œä¾¿äºå¯¹æ¥å¤–éƒ¨ç³»ç»Ÿ

---

## å®æ–½è®¡åˆ’

### ä¼˜å…ˆçº§ä¸æ—¶é—´ä¼°ç®—

| ä¼˜å…ˆçº§ | é—®é¢˜ç¼–å· | é—®é¢˜æè¿°                                   | é¢„è®¡å·¥æ—¶ | ä¾èµ–å…³ç³»                |
| ------ | -------- | ------------------------------------------ | -------- | ----------------------- |
| P1     | 6        | ESLint warnings æ¸…ç†                       | 4å°æ—¶    | åˆ†ä¸‰æ‰¹è¿›è¡Œ              |
| P1     | 7        | listing_expiry_days ç­‰é…ç½®æœªç»Ÿä¸€ä» DB è¯»å– | 2å°æ—¶    | éœ€ä¿®æ”¹å®šæ—¶ä»»åŠ¡          |
| P1     | 8        | å†å²å¹‚ç­‰è®°å½• api_path æ—§å€¼æ®‹ç•™             | 1.5å°æ—¶  | éœ€è¦æ•°æ®åº“è¿ç§»          |
| P1     | 9        | æœåŠ¡è·å–æ–¹å¼æœªå®Œå…¨ç»Ÿä¸€                     | 1å°æ—¶    | æ—                       |
| P2     | 10       | è‡ªåŠ¨å¯¹è´¦ä¸å‘Šè­¦é—­ç¯                         | 3å°æ—¶    | éœ€åˆ›å»ºå‘Šè­¦æœåŠ¡+SOPæ–‡æ¡£  |
| P2     | 11       | ä¸¥æ ¼è·¯ç”±å±‚è§„èŒƒæ²»ç†                         | 4å°æ—¶    | éœ€åˆ›å»ºæ£€æŸ¥è„šæœ¬+é€ä¸ªä¿®å¤ |
| P2     | 12       | å»é™¤é V4 çš„æ®‹ç•™ä¸æ— ç”¨æ¨¡å—                 | 2å°æ—¶    | éœ€æ‰«æå¹¶åˆ é™¤æ—§ä»£ç       |
| P2     | 13       | æµ‹è¯•é…ç½®åŠ è½½ç»Ÿä¸€                           | 0.5å°æ—¶  | æ—                       |
| P2     | 14       | å¥åº·æ£€æŸ¥å“åº”ç»Ÿä¸€                           | 0.5å°æ—¶  | æ—                       |

**æ€»è®¡**ï¼šçº¦33-34å°æ—¶

### å®æ–½é¡ºåºå»ºè®®

6. **é—®é¢˜9ï¼šæœåŠ¡è·å–ç»Ÿä¸€** â†’ å¿«é€Ÿä¿®å¤ï¼Œæ¶æ„ä¸€è‡´æ€§
7. **é—®é¢˜7ï¼šé…ç½®ç»Ÿä¸€ä» DB è¯»å–** â†’ ä¿®æ”¹å®šæ—¶ä»»åŠ¡è¯»å– system_settings
8. **é—®é¢˜8ï¼šapi_path å†å²æ•°æ®è¿ç§»** â†’ æ•°æ®åº“è¿ç§»è„šæœ¬
9. **é—®é¢˜6ï¼šESLint warnings æ¸…ç†**ï¼ˆåˆ†æ‰¹è¿›è¡Œï¼‰
   - ç¬¬ä¸€æ‰¹ï¼šno-unused-vars
   - ç¬¬äºŒæ‰¹ï¼šäº‹åŠ¡è¾¹ç•Œå‘Šè­¦
   - ç¬¬ä¸‰æ‰¹ï¼šno-await-in-loop

**ç¬¬ä¸‰é˜¶æ®µï¼ˆP2é—®é¢˜ï¼Œ3å¤©å†…å®Œæˆï¼‰**ï¼š

10. **é—®é¢˜11ï¼šè·¯ç”±å±‚è§„èŒƒæ²»ç†** â†’ åˆ›å»ºæ£€æŸ¥è„šæœ¬ + é€ä¸ªä¿®å¤è¿è§„è·¯ç”±
11. **é—®é¢˜10ï¼šè‡ªåŠ¨å¯¹è´¦ä¸å‘Šè­¦é—­ç¯** â†’ åˆ›å»º MarketAlertService + SOP æ–‡æ¡£
12. **é—®é¢˜12ï¼šæ¸…ç†æ—§ç‰ˆæœ¬ä»£ç ** â†’ åˆ é™¤ v1/v2/v3 è·¯ç”±å’Œæ—§ç­–ç•¥
13. **é—®é¢˜13ï¼šæµ‹è¯•é…ç½®ç»Ÿä¸€** â†’ æ˜ç¡®å”¯ä¸€å…¥å£
14. **é—®é¢˜14ï¼šå¥åº·æ£€æŸ¥ç»Ÿä¸€** â†’ å“åº”æ ¼å¼ç»Ÿä¸€

---

## è´¨é‡æ£€æŸ¥æ ‡å‡†

æ¯å®Œæˆä¸€é¡¹é—®é¢˜ä¿®å¤åï¼Œå¿…é¡»é€šè¿‡ä»¥ä¸‹æ£€æŸ¥ï¼š

### ä»£ç è´¨é‡æ£€æŸ¥

```bash
npm run lint
# é¢„æœŸï¼š0 errorsï¼Œwarnings é€æ­¥å‡å°‘
```

### åŠŸèƒ½æµ‹è¯•

```bash
npm test
# é¢„æœŸï¼šæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œæ— æ–°å¢å¤±è´¥
```

### å¥åº·æ£€æŸ¥

```bash
curl -s http://localhost:3000/health | python3 -m json.tool
# é¢„æœŸï¼šstatus = healthyï¼Œdatabase/redis = connected
```

### æœåŠ¡è¿è¡Œæ£€æŸ¥

```bash
npm run pm:status
# é¢„æœŸï¼šPM2 æ˜¾ç¤º online çŠ¶æ€
```

##
