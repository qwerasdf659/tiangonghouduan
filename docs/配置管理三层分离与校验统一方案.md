# é…ç½®ç®¡ç†ä¸‰å±‚åˆ†ç¦»ä¸æ ¡éªŒç»Ÿä¸€æ–¹æ¡ˆ

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0.0ï¼ˆæ‰§è¡Œç‰ˆï¼‰  
**åˆ›å»ºæ—¥æœŸ**: 2025å¹´12æœˆ30æ—¥  
**æœ€åæ›´æ–°**: 2025å¹´12æœˆ30æ—¥ï¼ˆä¸šåŠ¡å†³ç­–ç¡®è®¤ç‰ˆï¼‰  
**é€‚ç”¨èŒƒå›´**: é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ V4.0  
**å‰ç½®ä¾èµ–**: `docs/Devboxå•ç¯å¢ƒç»Ÿä¸€é…ç½®æ–¹æ¡ˆ.md`ï¼ˆè¿è¡Œæ—¶é…ç½®æºæ”¶æ•›ï¼‰  
**ç›®æ ‡**: è§£å†³é…ç½®åˆ†å±‚æ··ä¹±ã€æ ¡éªŒå£å¾„ä¸ä¸€è‡´ã€SystemSettings è¾¹ç•Œä¸æ¸…çš„é—®é¢˜

---

## ğŸ¯ ä¸šåŠ¡å†³ç­–ç¡®è®¤ï¼ˆ2025-12-30ï¼‰

**å…³é”®è¿è¥å‚æ•°å½’å±å†³ç­–**ï¼š

| é…ç½®é¡¹                            | æœ€ç»ˆå†³ç­–                   | ç†ç”±                          | æ²»ç†è¦æ±‚                    |
| --------------------------------- | -------------------------- | ----------------------------- | --------------------------- |
| `lottery_cost_points`             | âœ… **ä¿ç•™åœ¨ DBï¼Œè¿è¥å¯è°ƒ** | ä¸šåŠ¡éœ€è¦çµæ´»è°ƒä»·ï¼ˆæ´»åŠ¨/ä¿ƒé”€ï¼‰ | èŒƒå›´é™åˆ¶ 50-500 + å®¡è®¡æ—¥å¿—  |
| `budget_allocation_ratio`         | âœ… **ä¿ç•™åœ¨ DBï¼Œè¿è¥å¯è°ƒ** | ä¸šåŠ¡éœ€è¦åŠ¨æ€è°ƒæ•´é¢„ç®—åˆ†é…ç­–ç•¥  | èŒƒå›´é™åˆ¶ 0.1-0.5 + å®¡è®¡æ—¥å¿— |
| `lottery.daily_limit.all`         | âœ… **ä¿ç•™åœ¨ DBï¼Œè¿è¥å¯è°ƒ** | æ´»åŠ¨æœŸéœ€è¦ä¸´æ—¶è°ƒæ•´æ¯æ—¥ä¸Šé™    | èŒƒå›´é™åˆ¶ 10-200 + å®¡è®¡æ—¥å¿—  |
| `marketplace.max_active_listings` | âœ… **ä¿ç•™åœ¨ DBï¼Œè¿è¥å¯è°ƒ** | ä¸šåŠ¡éœ€è¦çµæ´»è°ƒæ•´ä¸Šæ¶é™åˆ¶      | èŒƒå›´é™åˆ¶ 1-50 + å®¡è®¡æ—¥å¿—    |
| `password_min_length`             | âœ… **ä¿ç•™åœ¨ DBï¼Œè¿è¥å¯è°ƒ** | å®‰å…¨ç­–ç•¥éœ€è¦çµæ´»è°ƒæ•´          | èŒƒå›´é™åˆ¶ 6-32 + å®¡è®¡æ—¥å¿—    |
| `api_rate_limit`                  | âœ… **ä¿ç•™åœ¨ DBï¼Œè¿è¥å¯è°ƒ** | é£æ§ç­–ç•¥éœ€è¦åŠ¨æ€è°ƒæ•´          | èŒƒå›´é™åˆ¶ 10-1000 + å®¡è®¡æ—¥å¿— |
| `max_login_attempts`              | âœ… **ä¿ç•™åœ¨ DBï¼Œè¿è¥å¯è°ƒ** | å®‰å…¨ç­–ç•¥éœ€è¦çµæ´»è°ƒæ•´          | èŒƒå›´é™åˆ¶ 3-10 + å®¡è®¡æ—¥å¿—    |

**æ²»ç†åŸåˆ™**ï¼š

- âœ… **è¿è¥å¯è°ƒ = çµæ´»æ²»ç†**ï¼šå¿…é¡»æœ‰**èŒƒå›´çº¦æŸã€å®¡è®¡æ—¥å¿—**ï¼Œä½†**ä¸éœ€è¦å®¡æ‰¹æµç¨‹**
- âœ… **æ‰€æœ‰é…ç½®å‡ä¸éœ€è¦åŒäººå®¡æ ¸**ï¼šè¿è¥ä¸»ç®¡å¯ç›´æ¥ä¿®æ”¹ï¼Œé€šè¿‡å®¡è®¡æ—¥å¿—äº‹åè¿½æº¯
- âœ… **ä»£ç é…ç½®ä½œä¸º"é»˜è®¤å€¼/å…œåº•å€¼"**ï¼ŒDB é…ç½®ä½œä¸º"è¿è¥è¦†ç›–å€¼"ï¼ˆä¼˜å…ˆçº§ï¼šDB > Codeï¼‰
- âœ… **èŒƒå›´çº¦æŸæ˜¯ç¡¬æ€§é˜²æŠ¤**ï¼šè¶…å‡ºèŒƒå›´ç›´æ¥æ‹’ç»ï¼Œæ— éœ€äººå·¥å®¡æ‰¹

---

## ğŸ¯ æ ¸å¿ƒé—®é¢˜å®šä¹‰ï¼ˆDevbox æ–¹æ¡ˆæœªè¦†ç›–çš„éƒ¨åˆ†ï¼‰

### é—®é¢˜ 1ï¼šæ ¡éªŒæ¸…å•ä¸ç»Ÿä¸€ï¼Œå¯¼è‡´"è„šæœ¬é€šè¿‡ä½†å¯åŠ¨å¤±è´¥"

**å½“å‰ç°çŠ¶**ï¼ˆåŸºäºçœŸå®ä»£ç å®¡è®¡ï¼‰ï¼š

- **`config/environment.js` çš„ `validateConfig()`**ï¼šä»…æ ¡éªŒ `['NODE_ENV', 'PORT', 'DB_HOST', 'DB_PORT', 'DB_NAME', 'REDIS_URL']`ï¼ˆ6 é¡¹ï¼‰
- **`scripts/check-environment.js`**ï¼šæ ¡éªŒ `['DB_HOST', 'DB_PORT', 'DB_NAME', 'DB_USER', 'DB_PASSWORD']`ï¼ˆæ•°æ®åº“ 5 é¡¹ï¼‰+ çŸ­ä¿¡é…ç½® + å¾®ä¿¡é…ç½® + JWT é…ç½®
- **`app.js` å®é™…ä¾èµ–**ï¼šè¿˜éœ€è¦ `JWT_SECRET`ã€`JWT_REFRESH_SECRET`ã€`ALLOWED_ORIGINS`ã€`SEALOS_*`ï¼ˆ5-10 é¡¹ï¼‰
- **`config.example`**ï¼šåŒ…å« 50+ é¡¹é…ç½®é”®ï¼ˆå«åºŸå¼ƒé¡¹ã€å ä½ç¬¦ã€ä¸ä¸€è‡´å‘½åï¼‰

**é—®é¢˜è¡¨ç°**ï¼š

- è„šæœ¬æ£€æŸ¥é€šè¿‡ï¼ˆ`npm run check:env` æˆåŠŸï¼‰â†’ å¯åŠ¨å¤±è´¥ï¼ˆç¼º `DB_USER`ï¼‰
- å¯åŠ¨é€šè¿‡ï¼ˆdevelopment å¿½ç•¥æ ¡éªŒå¤±è´¥ï¼‰â†’ çº¿ä¸Šç¼ºå…³é”®å¯†é’¥ï¼ˆ`JWT_SECRET` ç”¨é»˜è®¤å€¼ï¼‰
- æµ‹è¯•ä¸ç”Ÿäº§ç¯å¢ƒè¡Œä¸ºä¸ä¸€è‡´ï¼ˆæµ‹è¯•ç”¨çš„å˜é‡åä¸ç”Ÿäº§ä¸åŒï¼‰

**æ ¹æœ¬åŸå› **ï¼š

- æ²¡æœ‰"å”¯ä¸€æƒå¨çš„é…ç½® schema"ï¼ˆå¿…éœ€é¡¹ã€ç±»å‹ã€ç¯å¢ƒå·®å¼‚ã€é»˜è®¤å€¼ç­–ç•¥ï¼‰
- æ ¡éªŒé€»è¾‘åˆ†æ•£åœ¨ 3+ å¤„ï¼Œå„è‡ªç»´æŠ¤å„è‡ªçš„å¿…éœ€é¡¹åˆ—è¡¨
- `validateConfig()` çš„ `process.exit(1)` è®© `app.js` çš„ try/catch è®¾è®¡æ— æ„ä¹‰

---

### é—®é¢˜ 2ï¼šé…ç½®åˆ†å±‚è¾¹ç•Œä¸æ¸…ï¼Œå¯¼è‡´"åŒä¸€æ¦‚å¿µå¤šå¤„å®šä¹‰"

**å½“å‰ç°çŠ¶**ï¼ˆåŸºäºçœŸå®æ•°æ®ä¸ä»£ç ï¼‰ï¼š

**ç¯å¢ƒå˜é‡å±‚ï¼ˆ.envï¼‰**ï¼š

- åŸºç¡€è®¾æ–½ï¼š`DB_*`ã€`REDIS_URL`ã€`PORT`ã€`NODE_ENV`ã€`TZ`
- å¯†é’¥ï¼š`JWT_SECRET`ã€`JWT_REFRESH_SECRET`ã€`ENCRYPTION_KEY`ã€`SEALOS_*`ã€`WX_*`
- ä¸šåŠ¡å‚æ•°ï¼š`LOTTERY_COST_POINTS`ã€`DAILY_LOTTERY_LIMIT`ã€`NEW_USER_POINTS`ï¼ˆå½“å‰åœ¨ `config.example` ä¸­ï¼‰

**ä»£ç é…ç½®å±‚ï¼ˆconfig/\*.jsï¼‰**ï¼š

- `config/business.config.js`ï¼šæŠ½å¥–å®šä»·ï¼ˆ`draw_pricing`ï¼‰ã€æ¯æ—¥é™åˆ¶ï¼ˆ`daily_limit`ï¼‰ã€å…è´¹æŠ½å¥–å¼€å…³
- `config/marketplace.config.js`ï¼šä¸Šæ¶é™åˆ¶ï¼ˆ`max_active_listings`ï¼‰ã€ä»·æ ¼éªŒè¯ï¼ˆ`price_validation`ï¼‰
- `config/fee_rules.js`ï¼šæ‰‹ç»­è´¹ç­–ç•¥ï¼ˆ`tiers`ã€`charge_target`ã€`fee_strategy`ï¼‰

**æ•°æ®åº“é…ç½®å±‚ï¼ˆsystem_settingsï¼‰**ï¼š

- çœŸå®å­˜åœ¨ 16 æ¡é…ç½®ï¼Œåˆ†ç±»ï¼š`basic`ï¼ˆ4 æ¡ï¼‰ã€`points`ï¼ˆ5 æ¡ï¼‰ã€`security`ï¼ˆ4 æ¡ï¼‰ã€`notification`ï¼ˆ3 æ¡ï¼‰
- åŒ…å«ï¼š`lottery_cost_points`ï¼ˆä¸ env é‡åï¼‰ã€`initial_points`ã€`budget_allocation_ratio`ã€`max_login_attempts` ç­‰

**é—®é¢˜è¡¨ç°**ï¼š

- **é‡åå†²çª**ï¼š`lottery_cost_points` åŒæ—¶åœ¨ envã€ä»£ç é…ç½®ã€DB é…ç½®ä¸­å‡ºç°ï¼ˆåˆ°åº•è°æ˜¯çœŸç›¸ï¼Ÿï¼‰
- **èŒè´£ä¸æ¸…**ï¼š`budget_allocation_ratio`ï¼ˆé¢„ç®—åˆ†é…ç³»æ•° 0.24ï¼‰åœ¨ DB å¯æ”¹ï¼Œä½†ç¼ºå°‘çº¦æŸä¸å®¡è®¡æœºåˆ¶
- **ç¼ºå°‘è¾¹ç•Œ**ï¼šæ²¡æœ‰æ˜ç¡®"å“ªäº›é…ç½®å…è®¸è¿› DBã€å“ªäº›å¿…é¡»ç•™ä»£ç ã€å“ªäº›ç»ä¸å…è®¸è¿› DB"çš„ç™½åå•ä¸çº¦æŸ

**ä¸šåŠ¡å†³ç­–ï¼ˆ2025-12-30ï¼‰**ï¼š

- âœ… **`lottery_cost_points` ä¿ç•™åœ¨ DB**ï¼šåˆ é™¤ env/ä»£ç é…ç½®ä¸­çš„é‡å¤å®šä¹‰ï¼ŒDB ä½œä¸ºå”¯ä¸€çœŸç›¸æº
- âœ… **`budget_allocation_ratio` ä¿ç•™åœ¨ DB**ï¼šä½†éœ€å¼ºåŒ–çº¦æŸï¼ˆèŒƒå›´é™åˆ¶ 0.1-0.5ã€åŒäººå®¡æ ¸ã€å˜æ›´å®¡è®¡ï¼‰

---

### é—®é¢˜ 3ï¼šå­—æ®µå‘½åä¸ç»Ÿä¸€ï¼Œå¯¼è‡´"æ¨¡æ¿ä¸å®é™…è„±èŠ‚"

**å½“å‰ç°çŠ¶**ï¼ˆåŸºäºçœŸå®å®¡è®¡ï¼‰ï¼š

- **`config.example` ä½¿ç”¨çš„çŸ­ä¿¡é…ç½®é”®**ï¼š`SMS_APP_ID`ã€`SMS_APP_KEY`
- **`scripts/check-environment.js` æ ¡éªŒçš„çŸ­ä¿¡é…ç½®é”®**ï¼š`SMS_APP_ID`ã€`SMS_APP_KEY`
- **ä½† `config.example` æ³¨é‡Šé‡Œåˆæåˆ°**ï¼š`SMS_PROVIDER`ã€`SMS_ACCESS_KEY`ã€`SMS_SECRET_KEY`ã€`SMS_SIGN_NAME`ã€`SMS_TEMPLATE_CODE`
- **å®é™…ä»£ç é‡Œè¯»å–çš„é”®**ï¼šéœ€è¦æ‰«æ `services/` ç¡®è®¤çœŸå®ä¾èµ–

**é—®é¢˜è¡¨ç°**ï¼š

- æ–°äººæŒ‰ `config.example` é…ç½® â†’ å¯åŠ¨å¤±è´¥ï¼ˆå­—æ®µåä¸å¯¹ï¼‰
- è„šæœ¬æ£€æŸ¥é€šè¿‡ â†’ å®é™…åŠŸèƒ½ä¸å¯ç”¨ï¼ˆä»£ç è¯»çš„æ˜¯å¦ä¸€ä¸ªå­—æ®µï¼‰
- æ–‡æ¡£/æ¨¡æ¿/ä»£ç ä¸‰è€…ä¸ä¸€è‡´ï¼Œå¢åŠ è®¤çŸ¥è´Ÿæ‹…

---

## ğŸ—ï¸ ä¸‰å±‚åˆ†ç¦»æ¶æ„è®¾è®¡ï¼ˆå¼ºåˆ¶è¾¹ç•Œï¼‰

### æ ¸å¿ƒåŸåˆ™

**é…ç½®åˆ†å±‚å•å‘ä¾èµ–**ï¼š

```
DB SystemSettingsï¼ˆè¿è¥å¯è°ƒï¼‰
    â†“ å¯è¯»å–
Code Configï¼ˆå‘ç‰ˆçº§è§„åˆ™ï¼‰
    â†“ å¯è¯»å–
Env Variablesï¼ˆåŸºç¡€è®¾æ–½ï¼‰
```

**ç¦æ­¢åå‘ä¾èµ–**ï¼š

- âŒ Env ä¸å¾—è¯»å– Code Config æˆ– DB
- âŒ Code Config ä¸å¾—è¯»å– DBï¼ˆé™¤éæ˜ç¡®è®¾è®¡ä¸º"è¿è¥å‚æ•°è¦†ç›–ä»£ç é»˜è®¤å€¼"ï¼‰
- âŒ DB ä¸å¾—å­˜å‚¨"åŸºç¡€è®¾æ–½/å¯†é’¥"ç±»é…ç½®

---

### ç¬¬ä¸€å±‚ï¼šç¯å¢ƒå˜é‡ï¼ˆEnv Variablesï¼‰

**èŒè´£å®šä¹‰**ï¼šåªæ”¾"åŸºç¡€è®¾æ–½è¿æ¥ä¿¡æ¯ + å¯†é’¥ + å¹³å°å·®å¼‚"

**å½’å±æ¸…å•**ï¼ˆåŸºäºå½“å‰é¡¹ç›®çœŸå®ä¾èµ–ï¼‰ï¼š

| é…ç½®é”®                     | ç±»å‹    | å¿…éœ€æ€§  | ç¯å¢ƒå·®å¼‚               | è¯´æ˜                     | å½“å‰çŠ¶æ€  |
| -------------------------- | ------- | ------- | ---------------------- | ------------------------ | --------- |
| **è¿è¡Œç¯å¢ƒ**               |
| `NODE_ENV`                 | enum    | âœ… å¿…éœ€ | dev/staging/production | ç¯å¢ƒæ ‡è¯†                 | âœ… å·²ç”¨   |
| `PORT`                     | number  | âœ… å¿…éœ€ | é€šå¸¸ 3000              | HTTP ç«¯å£                | âœ… å·²ç”¨   |
| `HOST`                     | string  | å¯é€‰    | é»˜è®¤ 0.0.0.0           | ç›‘å¬åœ°å€                 | âœ… å·²ç”¨   |
| `TZ`                       | string  | âœ… å¿…éœ€ | å›ºå®š Asia/Shanghai     | æ—¶åŒº                     | âœ… å·²ç”¨   |
| **æ•°æ®åº“**                 |
| `DB_HOST`                  | string  | âœ… å¿…éœ€ | ç¯å¢ƒå·®å¼‚               | MySQL ä¸»æœº               | âœ… å·²ç”¨   |
| `DB_PORT`                  | number  | âœ… å¿…éœ€ | é€šå¸¸ 3306/42569        | MySQL ç«¯å£               | âœ… å·²ç”¨   |
| `DB_NAME`                  | string  | âœ… å¿…éœ€ | ç¯å¢ƒå·®å¼‚               | æ•°æ®åº“å                 | âœ… å·²ç”¨   |
| `DB_USER`                  | string  | âœ… å¿…éœ€ | ç¯å¢ƒå·®å¼‚               | æ•°æ®åº“ç”¨æˆ·               | âœ… å·²ç”¨   |
| `DB_PASSWORD`              | string  | âœ… å¿…éœ€ | ç¯å¢ƒå·®å¼‚               | æ•°æ®åº“å¯†ç                | âœ… å·²ç”¨   |
| **ç¼“å­˜**                   |
| `REDIS_URL`                | string  | âœ… å¿…éœ€ | ç¯å¢ƒå·®å¼‚               | Redis è¿æ¥ URL           | âœ… å·²ç”¨   |
| **è®¤è¯å¯†é’¥**               |
| `JWT_SECRET`               | string  | âœ… å¿…éœ€ | ç¯å¢ƒå·®å¼‚               | JWT ç­¾åå¯†é’¥ï¼ˆâ‰¥32 å­—ç¬¦ï¼‰ | âœ… å·²ç”¨   |
| `JWT_REFRESH_SECRET`       | string  | âœ… å¿…éœ€ | ç¯å¢ƒå·®å¼‚               | JWT åˆ·æ–°ä»¤ç‰Œå¯†é’¥         | âœ… å·²ç”¨   |
| `JWT_EXPIRES_IN`           | string  | å¯é€‰    | é»˜è®¤ 2h                | Token æœ‰æ•ˆæœŸ             | âš ï¸ æœªæ ¡éªŒ |
| `JWT_REFRESH_EXPIRES_IN`   | string  | å¯é€‰    | é»˜è®¤ 7d                | åˆ·æ–°ä»¤ç‰Œæœ‰æ•ˆæœŸ           | âš ï¸ æœªæ ¡éªŒ |
| `ENCRYPTION_KEY`           | string  | âœ… å¿…éœ€ | ç¯å¢ƒå·®å¼‚               | æ•°æ®åŠ å¯†å¯†é’¥ï¼ˆ32 å­—ç¬¦ï¼‰  | âš ï¸ æœªæ ¡éªŒ |
| **å¯¹è±¡å­˜å‚¨**               |
| `SEALOS_ENDPOINT`          | string  | âœ… å¿…éœ€ | ç¯å¢ƒå·®å¼‚               | Sealos ç«¯ç‚¹              | âœ… å·²ç”¨   |
| `SEALOS_BUCKET`            | string  | âœ… å¿…éœ€ | ç¯å¢ƒå·®å¼‚               | å­˜å‚¨æ¡¶å                 | âœ… å·²ç”¨   |
| `SEALOS_ACCESS_KEY`        | string  | âœ… å¿…éœ€ | ç¯å¢ƒå·®å¼‚               | è®¿é—®å¯†é’¥                 | âœ… å·²ç”¨   |
| `SEALOS_SECRET_KEY`        | string  | âœ… å¿…éœ€ | ç¯å¢ƒå·®å¼‚               | å¯†é’¥                     | âœ… å·²ç”¨   |
| `SEALOS_REGION`            | string  | âœ… å¿…éœ€ | ç¯å¢ƒå·®å¼‚               | åŒºåŸŸ                     | âœ… å·²ç”¨   |
| `SEALOS_INTERNAL_ENDPOINT` | string  | å¯é€‰    | ä»… Sealos éƒ¨ç½²         | å†…ç½‘ç«¯ç‚¹                 | âš ï¸ æœªæ ¡éªŒ |
| **å¾®ä¿¡å°ç¨‹åº**             |
| `WX_APPID`                 | string  | âœ… å¿…éœ€ | ç¯å¢ƒå·®å¼‚               | å¾®ä¿¡ AppID               | âœ… å·²ç”¨   |
| `WX_SECRET`                | string  | âœ… å¿…éœ€ | ç¯å¢ƒå·®å¼‚               | å¾®ä¿¡ AppSecret           | âœ… å·²ç”¨   |
| **CORS ç™½åå•**            |
| `ALLOWED_ORIGINS`          | string  | âœ… å¿…éœ€ | ç¯å¢ƒå·®å¼‚               | é€—å·åˆ†éš”çš„åŸŸååˆ—è¡¨       | âœ… å·²ç”¨   |
| **æ—¥å¿—**                   |
| `LOG_LEVEL`                | enum    | å¯é€‰    | dev=debug, prod=error  | æ—¥å¿—çº§åˆ«                 | âš ï¸ æœªæ ¡éªŒ |
| **æ€§èƒ½ç›‘æ§**               |
| `ENABLE_POOL_MONITORING`   | boolean | å¯é€‰    | é»˜è®¤ true              | è¿æ¥æ± ç›‘æ§å¼€å…³           | âœ… å·²ç”¨   |

**å¼ºåˆ¶è§„åˆ™**ï¼š

- âœ… æ‰€æœ‰"âœ… å¿…éœ€"é¡¹ç¼ºå¤±æ—¶ï¼Œåº”ç”¨/è„šæœ¬å¿…é¡» **fail-fast**ï¼ˆ`process.exit(1)` æˆ–æŠ›é”™ï¼‰
- âœ… ç”Ÿäº§ç¯å¢ƒä¸å…è®¸ä½¿ç”¨å ä½ç¬¦ï¼ˆ`CHANGE_ME_*`ã€`your_*`ã€`development_secret` ç­‰ï¼‰
- âŒ ç¦æ­¢åœ¨ä»£ç é‡Œè®¾é»˜è®¤å€¼å…œåº•ï¼ˆé™¤éæ˜ç¡®æ ‡æ³¨"å¯é€‰"ä¸”æœ‰æ–‡æ¡£è¯´æ˜ï¼‰
- âŒ ç¦æ­¢åœ¨ `ecosystem.config.js env` æˆ–è„šæœ¬é‡Œç¡¬ç¼–ç çœŸå®å€¼

---

### ç¬¬äºŒå±‚ï¼šä»£ç é…ç½®ï¼ˆCode Configï¼‰

**èŒè´£å®šä¹‰**ï¼šåªæ”¾"éœ€è¦å‘ç‰ˆçš„ç¨³å®šä¸šåŠ¡è§„åˆ™"ï¼ˆç®—æ³•å‚æ•°ã€å®šä»·ç­–ç•¥ã€é£æ§é˜ˆå€¼ï¼‰

**å½’å±æ¸…å•**ï¼ˆåŸºäºå½“å‰é¡¹ç›®çœŸå®é…ç½®æ–‡ä»¶ï¼‰ï¼š

| é…ç½®æ–‡ä»¶                                | é…ç½®é¡¹                                       | è¯´æ˜    | æ˜¯å¦å…è®¸è¿› DB                                      | ç†ç”± |
| --------------------------------------- | -------------------------------------------- | ------- | -------------------------------------------------- | ---- |
| **config/business.config.js**           |
| `lottery.draw_pricing`                  | æŠ½å¥–å®šä»·ï¼ˆå•æŠ½/3è¿/5è¿/10è¿ï¼‰                | âŒ ç¦æ­¢ | å®šä»·ç­–ç•¥å½±å“æ”¶å…¥/å…¬å¹³æ€§ï¼Œå¿…é¡»èµ°å‘ç‰ˆä¸å®¡è®¡          |
| `lottery.daily_limit.all`               | æ¯æ—¥æŠ½å¥–æ¬¡æ•°ä¸Šé™ï¼ˆ50 æ¬¡ï¼‰                    | âš ï¸ è°¨æ… | é£æ§å‚æ•°ï¼Œå»ºè®®ä»£ç å›ºå®šï¼›å¦‚éœ€æ´»åŠ¨è°ƒæ•´ï¼Œå¯ç”¨ DB è¦†ç›– |
| `lottery.free_draw_allowed`             | æ˜¯å¦å…è®¸å…è´¹æŠ½å¥–ï¼ˆfalseï¼‰                    | âŒ ç¦æ­¢ | æ ¸å¿ƒä¸šåŠ¡è§„åˆ™ï¼Œä¸å¯è¿è¥éšæ„æ”¹                       |
| `points.max_balance`                    | ç§¯åˆ†ä½™é¢ä¸Šé™ï¼ˆ99,999,999.99ï¼‰                | âŒ ç¦æ­¢ | æ•°æ®åº“å­—æ®µçº¦æŸï¼Œä¸å¯åŠ¨æ€è°ƒæ•´                       |
| `points.validation.enforce_transaction` | å¼ºåˆ¶äº‹åŠ¡ä¿æŠ¤ï¼ˆtrueï¼‰                         | âŒ ç¦æ­¢ | æŠ€æœ¯çº¦æŸï¼Œä¸å¯å…³é—­                                 |
| `chat.rate_limit`                       | æ¶ˆæ¯é¢‘ç‡é™åˆ¶ï¼ˆç”¨æˆ· 20/åˆ†é’Ÿï¼Œç®¡ç†å‘˜ 30/åˆ†é’Ÿï¼‰ | âš ï¸ è°¨æ… | é£æ§å‚æ•°ï¼Œå»ºè®®ä»£ç å›ºå®š                             |
| `chat.content_filter.sensitive_words`   | æ•æ„Ÿè¯åˆ—è¡¨                                   | âœ… å¯ä»¥ | è¿è¥éœ€è¦åŠ¨æ€è°ƒæ•´ï¼Œé€‚åˆ DB                          |
| **config/marketplace.config.js**        |
| `max_active_listings`                   | ç”¨æˆ·æœ€å¤šåŒæ—¶ä¸Šæ¶å•†å“æ•°ï¼ˆ10 ä»¶ï¼‰              | âš ï¸ è°¨æ… | ä¸šåŠ¡è§„åˆ™ï¼ŒçŸ­æœŸä»£ç å›ºå®šï¼›é•¿æœŸå¯ DB è¦†ç›–             |
| `price_validation.min_ratio`            | æœ€ä½å”®ä»·æ¯”ä¾‹ï¼ˆ50%ï¼‰                          | âŒ ç¦æ­¢ | é£æ§å‚æ•°ï¼Œé˜²æ­¢æ´—ç§¯åˆ†                               |
| `price_validation.max_ratio`            | æœ€é«˜å”®ä»·æ¯”ä¾‹ï¼ˆ200%ï¼‰                         | âŒ ç¦æ­¢ | é£æ§å‚æ•°ï¼Œé˜²æ­¢æ¬ºè¯ˆ                                 |
| **config/fee_rules.js**                 |
| `tiers[].rate`                          | æ‰‹ç»­è´¹ç‡ï¼ˆç»Ÿä¸€ 5%ï¼‰                          | âŒ ç¦æ­¢ | ç»“ç®—å…³é”®å‚æ•°ï¼Œå¿…é¡»èµ°å‘ç‰ˆ                           |
| `charge_target`                         | æ”¶è´¹å¯¹è±¡ï¼ˆsellerï¼‰                           | âŒ ç¦æ­¢ | ç»“ç®—é€»è¾‘ï¼Œä¸å¯åŠ¨æ€æ”¹                               |
| `fee_strategy`                          | æ‰‹ç»­è´¹å»å‘ï¼ˆmonetizeï¼‰                       | âŒ ç¦æ­¢ | å¹³å°æ”¶å…¥æ¨¡å‹ï¼Œä¸å¯è¿è¥æ”¹                           |
| `min_fee`                               | æœ€å°æ‰‹ç»­è´¹ï¼ˆ1 ç§¯åˆ†ï¼‰                         | âŒ ç¦æ­¢ | ç»“ç®—å‚æ•°ï¼Œé˜²æ­¢æå°é¢è®¢å•                           |

**å¼ºåˆ¶è§„åˆ™**ï¼š

- âœ… ä»£ç é…ç½®å¿…é¡»æœ‰ç‰ˆæœ¬æ§åˆ¶ï¼ˆGitï¼‰ä¸ Code Review
- âœ… ä¿®æ”¹ä»£ç é…ç½®å¿…é¡»èµ°å‘ç‰ˆæµç¨‹ï¼ˆä¸å¯çƒ­æ›´æ–°ï¼‰
- âŒ ç¦æ­¢æŠŠ"ç»“ç®—/é£æ§/å®‰å…¨"å…³é”®å‚æ•°æ”¾è¿› DBï¼ˆé˜²æ­¢è¯¯æ“ä½œï¼‰
- âš ï¸ å¦‚éœ€"æ´»åŠ¨æœŸä¸´æ—¶è°ƒå‚"ï¼Œå¿…é¡»è®¾è®¡"DB è¦†ç›– Code é»˜è®¤å€¼"çš„æ˜ç¡®æœºåˆ¶ï¼ˆè€Œä¸æ˜¯ç›´æ¥åˆ ä»£ç é…ç½®ï¼‰

---

### ç¬¬ä¸‰å±‚ï¼šæ•°æ®åº“é…ç½®ï¼ˆDB SystemSettingsï¼‰

**èŒè´£å®šä¹‰**ï¼šåªæ”¾"è¿è¥å¯è°ƒå‚æ•°/å¼€å…³/æ–‡æ¡ˆ/å±•ç¤º"ï¼ˆä¸å½±å“ç»“ç®—/å®‰å…¨/æ ¸å¿ƒç®—æ³•ï¼‰

**å½“å‰çœŸå®æ•°æ®åˆ†å¸ƒ**ï¼ˆåŸºäº 2025-12-30 æ•°æ®åº“å®¡è®¡ï¼‰ï¼š

| category                     | setting_key              | value_type | readonly | visible | æ˜¯å¦åˆè§„      | é—®é¢˜                                |
| ---------------------------- | ------------------------ | ---------- | -------- | ------- | ------------- | ----------------------------------- |
| **basicï¼ˆåŸºç¡€è®¾ç½®ï¼‰**        |
| basic                        | system_name              | string     | false    | true    | âœ… åˆè§„       | å±•ç¤ºç±»ï¼Œé€‚åˆ DB                     |
| basic                        | system_version           | string     | **true** | true    | âœ… åˆè§„       | åªè¯»ï¼Œé€‚åˆ DB                       |
| basic                        | customer_email           | string     | false    | true    | âœ… åˆè§„       | è”ç³»æ–¹å¼ï¼Œé€‚åˆ DB                   |
| basic                        | customer_phone           | string     | false    | true    | âœ… åˆè§„       | è”ç³»æ–¹å¼ï¼Œé€‚åˆ DB                   |
| **pointsï¼ˆç§¯åˆ†è®¾ç½®ï¼‰**       |
| points                       | lottery_cost_points      | number     | false    | true    | âš ï¸ **å†²çª**   | ä¸ `config/business.config.js` é‡å |
| points                       | initial_points           | string     | false    | true    | âš ï¸ **ç±»å‹é”™** | åº”ä¸º numberï¼Œå½“å‰ string            |
| points                       | sign_in_points           | string     | false    | true    | âš ï¸ **ç±»å‹é”™** | åº”ä¸º numberï¼Œå½“å‰ string            |
| points                       | budget_allocation_ratio  | number     | false    | true    | ğŸ”´ **å±é™©**   | ç»“ç®—å‚æ•°ï¼ˆ0.24ï¼‰ï¼Œä¸åº”å¯æ”¹          |
| points                       | points_expire_days       | number     | false    | true    | âœ… åˆè§„       | è¿è¥ç­–ç•¥ï¼Œé€‚åˆ DB                   |
| **securityï¼ˆå®‰å…¨è®¾ç½®ï¼‰**     |
| security                     | max_login_attempts       | string     | false    | true    | âš ï¸ **ç±»å‹é”™** | åº”ä¸º numberï¼Œå½“å‰ string            |
| security                     | lockout_duration         | number     | false    | true    | âœ… åˆè§„       | å®‰å…¨ç­–ç•¥ï¼Œé€‚åˆ DB                   |
| security                     | password_min_length      | number     | false    | true    | âš ï¸ **è°¨æ…**   | å®‰å…¨å‚æ•°ï¼Œå»ºè®® readonly             |
| security                     | api_rate_limit           | number     | false    | true    | âš ï¸ **è°¨æ…**   | é£æ§å‚æ•°ï¼Œå»ºè®® readonly             |
| **notificationï¼ˆé€šçŸ¥è®¾ç½®ï¼‰** |
| notification                 | sms_enabled              | string     | false    | true    | âš ï¸ **ç±»å‹é”™** | åº”ä¸º booleanï¼Œå½“å‰ string           |
| notification                 | email_enabled            | boolean    | false    | true    | âœ… åˆè§„       | å¼€å…³ç±»ï¼Œé€‚åˆ DB                     |
| notification                 | app_notification_enabled | boolean    | false    | true    | âœ… åˆè§„       | å¼€å…³ç±»ï¼Œé€‚åˆ DB                     |

**é—®é¢˜æ±‡æ€»**ï¼š

- ğŸ”´ **ç»“ç®—å…³é”®å‚æ•°è¿› DB**ï¼š`budget_allocation_ratio`ï¼ˆé¢„ç®—åˆ†é…ç³»æ•°ï¼‰å¯è¢«è¿è¥ä¿®æ”¹ï¼Œå­˜åœ¨è¯¯æ“ä½œé£é™©
- âš ï¸ **é…ç½®é‡åå†²çª**ï¼š`lottery_cost_points` åœ¨ DB ä¸ä»£ç é…ç½®åŒæ—¶å­˜åœ¨ï¼Œè°æ˜¯çœŸç›¸ä¸æ˜ç¡®
- âš ï¸ **ç±»å‹ä¸ä¸€è‡´**ï¼š4 ä¸ªé…ç½®é¡¹å£°æ˜ç±»å‹ä¸å®é™…å­˜å‚¨ç±»å‹ä¸åŒ¹é…ï¼ˆ`initial_points` ç­‰ï¼‰

---

### SystemSettings ç™½åå•ä¸å‡†å…¥è§„åˆ™ï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰

**å‡†å…¥æ¡ä»¶**ï¼ˆæ»¡è¶³ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶æ‰å…è®¸è¿› DBï¼‰ï¼š

- âœ… **è¿è¥éœ€è¦åŠ¨æ€è°ƒæ•´**ï¼ˆä¸å‘ç‰ˆå³å¯ç”Ÿæ•ˆï¼‰
- âœ… **ä¸å½±å“ç»“ç®—/å®‰å…¨/æ ¸å¿ƒç®—æ³•**ï¼ˆä¿®æ”¹ä¸ä¼šå¯¼è‡´èµ„é‡‘/ç§¯åˆ†é”™è¯¯ï¼‰
- âœ… **æœ‰æ˜ç¡®çš„ç±»å‹/èŒƒå›´çº¦æŸ**ï¼ˆé˜²æ­¢å¡«é”™å€¼å¯¼è‡´ç³»ç»Ÿå¼‚å¸¸ï¼‰
- âœ… **æœ‰å®¡è®¡æ—¥å¿—**ï¼ˆè°æ”¹çš„ã€æ”¹å‰æ”¹åå€¼ã€æ”¹åŠ¨åŸå› ï¼‰
- âŒ **ä¸æ˜¯å¯†é’¥/å¯†ç **ï¼ˆç»å¯¹ç¦æ­¢ï¼‰

**ç™½åå•åˆ†ç±»**ï¼ˆåŸºäºå½“å‰é¡¹ç›®ä¸šåŠ¡ + 2025-12-30 ä¸šåŠ¡å†³ç­–ï¼‰ï¼š

**âœ… å…è®¸ç±» - æ™®é€šè¿è¥å‚æ•°ï¼ˆé€‚åˆ DBï¼‰**ï¼š

- å±•ç¤ºç±»ï¼š`system_name`ã€`customer_email`ã€`customer_phone`
- å¼€å…³ç±»ï¼š`email_enabled`ã€`app_notification_enabled`ã€`sms_enabled`
- è¿è¥ç­–ç•¥ï¼š`points_expire_days`ï¼ˆç§¯åˆ†æœ‰æ•ˆæœŸï¼‰ã€`lockout_duration`ï¼ˆé”å®šæ—¶é•¿ï¼‰
- æ–‡æ¡ˆç±»ï¼šç³»ç»Ÿå…¬å‘Šã€å¼¹çª— Banner é…ç½®ï¼ˆå·²æœ‰ `popup_banners` è¡¨ï¼‰

**âœ… å…è®¸ç±» - å…³é”®è¿è¥å‚æ•°ï¼ˆéœ€å¼ºçº¦æŸï¼Œå·²å†³ç­– 2025-12-30ï¼‰**ï¼š

- âœ… `lottery_cost_points`ï¼šèŒƒå›´ 50-500ï¼Œå®¡è®¡æ—¥å¿—ï¼Œæ— éœ€å®¡æ‰¹
- âœ… `budget_allocation_ratio`ï¼šèŒƒå›´ 0.1-0.5ï¼Œå®¡è®¡æ—¥å¿—ï¼Œæ— éœ€å®¡æ‰¹
- âœ… `daily_lottery_limit`ï¼šèŒƒå›´ 10-200ï¼Œå®¡è®¡æ—¥å¿—ï¼Œæ— éœ€å®¡æ‰¹
- âœ… `max_active_listings`ï¼šèŒƒå›´ 1-50ï¼Œå®¡è®¡æ—¥å¿—ï¼Œæ— éœ€å®¡æ‰¹
- âœ… `password_min_length`ï¼šèŒƒå›´ 6-32ï¼Œå®¡è®¡æ—¥å¿—ï¼Œæ— éœ€å®¡æ‰¹
- âœ… `api_rate_limit`ï¼šèŒƒå›´ 10-1000ï¼Œå®¡è®¡æ—¥å¿—ï¼Œæ— éœ€å®¡æ‰¹
- âœ… `max_login_attempts`ï¼šèŒƒå›´ 3-10ï¼Œå®¡è®¡æ—¥å¿—ï¼Œæ— éœ€å®¡æ‰¹

**ğŸ”´ ç¦æ­¢ç±»ï¼ˆç»å¯¹ä¸å…è®¸è¿› DBï¼‰**ï¼š

- ç»“ç®—é€»è¾‘ï¼šæ‰‹ç»­è´¹ç‡ï¼ˆ`fee_rules.tiers`ï¼‰ã€ä»·æ ¼éªŒè¯æ¯”ä¾‹ï¼ˆ`price_validation.min_ratio/max_ratio`ï¼‰
- ç®—æ³•å‚æ•°ï¼šä¿åº•æœºåˆ¶å‚æ•°ã€æ¦‚ç‡è®¡ç®—å‚æ•°
- æŠ€æœ¯çº¦æŸï¼š`enforce_transaction`ã€è¿æ¥æ± é…ç½®ã€è¶…æ—¶æ—¶é—´
- å¯†é’¥/å¯†ç ï¼šä»»ä½• `*_SECRET`ã€`*_PASSWORD`ã€`*_KEY`ï¼ˆé™¤éæ˜ç¡®ç™½åå•ï¼‰

---

## ğŸ”§ ç»Ÿä¸€æ ¡éªŒæ¶æ„è®¾è®¡

### å”¯ä¸€æƒå¨ Schema å®šä¹‰ï¼ˆconfig/schema.jsï¼‰

**è®¾è®¡ç›®æ ‡**ï¼š

- æ‰€æœ‰ç¯å¢ƒå˜é‡çš„"å¿…éœ€æ€§ã€ç±»å‹ã€èŒƒå›´ã€ç¯å¢ƒå·®å¼‚"åœ¨æ­¤ç»Ÿä¸€å®šä¹‰
- åº”ç”¨å¯åŠ¨ã€è„šæœ¬æ£€æŸ¥ã€CI æ£€æŸ¥éƒ½å¼•ç”¨åŒä¸€ä»½ schema
- æ”¯æŒæŒ‰ç¯å¢ƒåˆ†çº§ï¼ˆdev å¯é€‰ã€prod å¿…éœ€ï¼‰

**Schema ç»“æ„ç¤ºä¾‹**ï¼ˆä¼ªä»£ç ï¼Œä¸å®ç°ï¼‰ï¼š

```javascript
// config/schema.jsï¼ˆæ–°å»ºæ–‡ä»¶ï¼‰
const CONFIG_SCHEMA = {
  // è¿è¡Œç¯å¢ƒ
  NODE_ENV: {
    type: 'enum',
    required: true,
    allowedValues: ['development', 'staging', 'production'],
    default: null, // ä¸å…è®¸é»˜è®¤å€¼ï¼Œå¿…é¡»æ˜¾å¼é…ç½®
    envDiff: false // æ‰€æœ‰ç¯å¢ƒå¿…é¡»é…ç½®
  },

  // æ•°æ®åº“
  DB_HOST: {
    type: 'string',
    required: true,
    pattern: /^[a-zA-Z0-9.-]+$/, // åŸŸåæˆ– IP
    envDiff: true, // ä¸åŒç¯å¢ƒå€¼ä¸åŒ
    production: {
      forbiddenValues: ['localhost', '127.0.0.1'] // ç”Ÿäº§ç¦æ­¢æœ¬åœ°
    }
  },

  DB_USER: {
    type: 'string',
    required: true,
    minLength: 1,
    envDiff: true
  },

  DB_PASSWORD: {
    type: 'string',
    required: true,
    minLength: 8, // æœ€çŸ­ 8 å­—ç¬¦
    production: {
      minLength: 12, // ç”Ÿäº§ç¯å¢ƒæœ€çŸ­ 12 å­—ç¬¦
      forbiddenValues: ['password', '123456', 'root', 'admin'] // å¼±å¯†ç é»‘åå•
    },
    envDiff: true
  },

  // JWT å¯†é’¥
  JWT_SECRET: {
    type: 'string',
    required: true,
    minLength: 32, // å¼ºåˆ¶ 32 å­—ç¬¦
    production: {
      forbiddenValues: ['development_secret', 'dev_secret', 'CHANGE_ME_*'] // å ä½ç¬¦é»‘åå•
    },
    envDiff: true
  },

  JWT_REFRESH_SECRET: {
    type: 'string',
    required: true,
    minLength: 32,
    production: {
      mustDifferFrom: ['JWT_SECRET'] // ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¸ JWT_SECRET ä¸åŒ
    },
    envDiff: true
  },

  // Redis
  REDIS_URL: {
    type: 'string',
    required: true,
    pattern: /^rediss?:\/\/.+/, // å¿…é¡»æ˜¯ redis:// æˆ– rediss:// æ ¼å¼
    envDiff: true
  },

  // Sealos
  SEALOS_ACCESS_KEY: {
    type: 'string',
    required: true,
    minLength: 8,
    production: {
      forbiddenValues: ['CHANGE_ME_*', 'your_*'] // å ä½ç¬¦é»‘åå•
    },
    envDiff: true
  },

  // å¾®ä¿¡
  WX_APPID: {
    type: 'string',
    required: true,
    pattern: /^wx[a-z0-9]{16}$/, // å¾®ä¿¡ AppID æ ¼å¼
    envDiff: true
  },

  WX_SECRET: {
    type: 'string',
    required: true,
    minLength: 32,
    envDiff: true
  },

  // å¯é€‰é…ç½®
  LOG_LEVEL: {
    type: 'enum',
    required: false,
    allowedValues: ['debug', 'info', 'warn', 'error'],
    default: env => (env === 'production' ? 'error' : 'debug'), // æŒ‰ç¯å¢ƒé»˜è®¤
    envDiff: true
  },

  PORT: {
    type: 'number',
    required: true,
    min: 1,
    max: 65535,
    default: 3000, // å…è®¸é»˜è®¤å€¼
    envDiff: false
  }
}

module.exports = { CONFIG_SCHEMA }
```

---

### ç»Ÿä¸€æ ¡éªŒå™¨å®ç°ï¼ˆconfig/validator.jsï¼‰

**è®¾è®¡ç›®æ ‡**ï¼š

- åŸºäº `CONFIG_SCHEMA` è‡ªåŠ¨ç”Ÿæˆæ ¡éªŒé€»è¾‘
- æ”¯æŒæŒ‰ç¯å¢ƒåˆ†çº§æ ¡éªŒï¼ˆdev/staging/productionï¼‰
- æä¾›æ¸…æ™°çš„é”™è¯¯æç¤ºï¼ˆç¼ºå“ªä¸ªã€ä¸ºä»€ä¹ˆä¸åˆè§„ã€æ€ä¹ˆä¿®å¤ï¼‰

**æ ¸å¿ƒæ–¹æ³•**ï¼ˆä¼ªä»£ç ï¼‰ï¼š

```javascript
// config/validator.jsï¼ˆæ–°å»ºæ–‡ä»¶ï¼‰
const { CONFIG_SCHEMA } = require('./schema')

class ConfigValidator {
  /**
   * æ ¡éªŒç¯å¢ƒå˜é‡å®Œæ•´æ€§å’Œåˆè§„æ€§
   * @param {string} targetEnv - ç›®æ ‡ç¯å¢ƒï¼ˆdevelopment/staging/productionï¼‰
   * @param {boolean} failFast - æ˜¯å¦é‡é”™å³é€€å‡ºï¼ˆé»˜è®¤ trueï¼‰
   * @returns {Object} { valid: boolean, errors: [], warnings: [] }
   */
  static validate(targetEnv = process.env.NODE_ENV || 'development', failFast = true) {
    const errors = []
    const warnings = []

    Object.entries(CONFIG_SCHEMA).forEach(([key, schema]) => {
      const value = process.env[key]

      // 1. å¿…éœ€æ€§æ£€æŸ¥
      if (schema.required && !value) {
        errors.push({
          key,
          type: 'MISSING',
          message: `ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡: ${key}`,
          fix: `åœ¨ .env ä¸­æ·»åŠ : ${key}=<your_value>`
        })
        return
      }

      // 2. ç±»å‹æ£€æŸ¥
      if (value && schema.type === 'number') {
        if (isNaN(Number(value))) {
          errors.push({
            key,
            type: 'TYPE_ERROR',
            message: `${key} å¿…é¡»æ˜¯æ•°å­—ï¼Œå½“å‰å€¼: ${value}`,
            fix: `ä¿®æ”¹ .env ä¸­çš„ ${key} ä¸ºæœ‰æ•ˆæ•°å­—`
          })
        }
      }

      // 3. æšä¸¾å€¼æ£€æŸ¥
      if (value && schema.type === 'enum' && schema.allowedValues) {
        if (!schema.allowedValues.includes(value)) {
          errors.push({
            key,
            type: 'INVALID_VALUE',
            message: `${key} å€¼ä¸åˆæ³•: ${value}`,
            fix: `å…è®¸çš„å€¼: ${schema.allowedValues.join(', ')}`
          })
        }
      }

      // 4. æ ¼å¼æ£€æŸ¥
      if (value && schema.pattern && !schema.pattern.test(value)) {
        errors.push({
          key,
          type: 'FORMAT_ERROR',
          message: `${key} æ ¼å¼ä¸æ­£ç¡®`,
          fix: `å‚è€ƒæ ¼å¼: ${schema.pattern}`
        })
      }

      // 5. é•¿åº¦æ£€æŸ¥
      if (value && schema.minLength && value.length < schema.minLength) {
        errors.push({
          key,
          type: 'TOO_SHORT',
          message: `${key} é•¿åº¦ä¸è¶³ï¼ˆå½“å‰ ${value.length} å­—ç¬¦ï¼Œæœ€å°‘ ${schema.minLength} å­—ç¬¦ï¼‰`,
          fix: `ä½¿ç”¨æ›´é•¿çš„å¯†é’¥: node -e "console.log(require('crypto').randomBytes(${schema.minLength}).toString('hex'))"`
        })
      }

      // 6. ç”Ÿäº§ç¯å¢ƒç‰¹æ®Šæ£€æŸ¥
      if (targetEnv === 'production' && schema.production) {
        // ç¦æ­¢å€¼æ£€æŸ¥
        if (schema.production.forbiddenValues) {
          const isForbidden = schema.production.forbiddenValues.some(forbidden => {
            if (forbidden.includes('*')) {
              const pattern = new RegExp('^' + forbidden.replace('*', '.*') + '$')
              return pattern.test(value)
            }
            return value === forbidden
          })

          if (isForbidden) {
            errors.push({
              key,
              type: 'FORBIDDEN_VALUE',
              message: `ç”Ÿäº§ç¯å¢ƒç¦æ­¢ä½¿ç”¨å ä½ç¬¦/å¼±å¯†é’¥: ${key}`,
              fix: `ç”Ÿæˆå¼ºéšæœºå¯†é’¥æ›¿æ¢å½“å‰å€¼`
            })
          }
        }

        // æœ€å°é•¿åº¦æ£€æŸ¥ï¼ˆç”Ÿäº§æ›´ä¸¥æ ¼ï¼‰
        if (schema.production.minLength && value.length < schema.production.minLength) {
          errors.push({
            key,
            type: 'PRODUCTION_TOO_SHORT',
            message: `ç”Ÿäº§ç¯å¢ƒ ${key} é•¿åº¦ä¸è¶³ï¼ˆå½“å‰ ${value.length}ï¼Œæœ€å°‘ ${schema.production.minLength}ï¼‰`,
            fix: `ä½¿ç”¨æ›´å¼ºçš„å¯†é’¥`
          })
        }

        // ç¦æ­¢ä¸å…¶ä»–å­—æ®µç›¸åŒ
        if (schema.production.mustDifferFrom) {
          schema.production.mustDifferFrom.forEach(otherKey => {
            if (value === process.env[otherKey]) {
              errors.push({
                key,
                type: 'DUPLICATE_SECRET',
                message: `ç”Ÿäº§ç¯å¢ƒ ${key} ä¸èƒ½ä¸ ${otherKey} ç›¸åŒ`,
                fix: `ä¸º ${key} ç”Ÿæˆç‹¬ç«‹çš„å¯†é’¥`
              })
            }
          })
        }
      }
    })

    // è¾“å‡ºç»“æœ
    if (errors.length > 0) {
      console.error('\nâŒ ç¯å¢ƒå˜é‡æ ¡éªŒå¤±è´¥:')
      errors.forEach((err, index) => {
        console.error(`\n${index + 1}. [${err.type}] ${err.message}`)
        console.error(`   ä¿®å¤æ–¹æ¡ˆ: ${err.fix}`)
      })

      if (failFast) {
        console.error(`\nğŸš« æ£€æµ‹åˆ° ${errors.length} ä¸ªé”™è¯¯ï¼Œåº”ç”¨æ— æ³•å¯åŠ¨`)
        process.exit(1)
      }
    }

    if (warnings.length > 0) {
      console.warn('\nâš ï¸ ç¯å¢ƒå˜é‡è­¦å‘Š:')
      warnings.forEach((warn, index) => {
        console.warn(`${index + 1}. ${warn.message}`)
      })
    }

    if (errors.length === 0 && warnings.length === 0) {
      console.log(`âœ… ç¯å¢ƒå˜é‡æ ¡éªŒé€šè¿‡ (${targetEnv} ç¯å¢ƒ)`)
    }

    return { valid: errors.length === 0, errors, warnings }
  }

  /**
   * ç”Ÿæˆ .env.example æ¨¡æ¿
   */
  static generateTemplate() {
    let template = '# é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ V4.0 - ç¯å¢ƒå˜é‡é…ç½®æ¨¡æ¿\n'
    template += '# ğŸ”´ é‡è¦ï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰å¿…é¡»ä¿®æ”¹æ‰€æœ‰ CHANGE_ME_* å ä½ç¬¦\n\n'

    const categories = {
      è¿è¡Œç¯å¢ƒ: ['NODE_ENV', 'PORT', 'HOST', 'TZ'],
      æ•°æ®åº“é…ç½®: ['DB_HOST', 'DB_PORT', 'DB_NAME', 'DB_USER', 'DB_PASSWORD'],
      ç¼“å­˜é…ç½®: ['REDIS_URL'],
      'JWT é…ç½®': ['JWT_SECRET', 'JWT_REFRESH_SECRET', 'JWT_EXPIRES_IN', 'JWT_REFRESH_EXPIRES_IN'],
      å¯¹è±¡å­˜å‚¨: [
        'SEALOS_ENDPOINT',
        'SEALOS_BUCKET',
        'SEALOS_ACCESS_KEY',
        'SEALOS_SECRET_KEY',
        'SEALOS_REGION'
      ],
      å¾®ä¿¡å°ç¨‹åº: ['WX_APPID', 'WX_SECRET'],
      'CORS ç™½åå•': ['ALLOWED_ORIGINS'],
      æ—¥å¿—é…ç½®: ['LOG_LEVEL'],
      æ€§èƒ½ç›‘æ§: ['ENABLE_POOL_MONITORING']
    }

    Object.entries(categories).forEach(([category, keys]) => {
      template += `# === ${category} ===\n`
      keys.forEach(key => {
        const schema = CONFIG_SCHEMA[key]
        if (!schema) return

        const required = schema.required ? '(å¿…éœ€)' : '(å¯é€‰)'
        const example = this._getExampleValue(key, schema)

        template += `${key}=${example}  # ${required}\n`
      })
      template += '\n'
    })

    return template
  }

  static _getExampleValue(key, schema) {
    if (schema.type === 'enum') return schema.allowedValues[0]
    if (schema.default)
      return typeof schema.default === 'function' ? schema.default('development') : schema.default
    if (key.includes('SECRET') || key.includes('PASSWORD') || key.includes('KEY')) {
      return `CHANGE_ME_${key.toLowerCase()}`
    }
    if (schema.type === 'number') return schema.min || 0
    return 'your_value_here'
  }
}

module.exports = { ConfigValidator }
```

---

### åº”ç”¨å¯åŠ¨æ ¡éªŒæ”¹é€ ï¼ˆapp.jsï¼‰

**å½“å‰é—®é¢˜**ï¼š

- `validateConfig()` åªæ ¡éªŒ 6 é¡¹ï¼ˆç¼º `DB_USER/DB_PASSWORD/JWT_SECRET/...`ï¼‰
- `process.exit(1)` è®© try/catch æ— æ„ä¹‰ï¼ˆexit ä¸å¯æ•è·ï¼‰
- development å¿½ç•¥æ ¡éªŒå¤±è´¥ï¼Œå¯èƒ½å¯¼è‡´"å¼€å‘èƒ½è·‘ã€ç”Ÿäº§ç‚¸"

**æ”¹é€ æ–¹æ¡ˆ**ï¼ˆä¸å†™ä»£ç ï¼Œä»…æè¿°ï¼‰ï¼š

```javascript
// app.js å¯åŠ¨é˜¶æ®µï¼ˆä¼ªä»£ç ï¼‰
const { ConfigValidator } = require('./config/validator')

// ğŸ”´ ç»Ÿä¸€æ ¡éªŒï¼ˆæ‰€æœ‰ç¯å¢ƒ fail-fastï¼Œä¸å† try/catch å¿½ç•¥ï¼‰
const validation = ConfigValidator.validate(process.env.NODE_ENV, true)
// å¦‚æœ validation.valid === falseï¼Œä¸Šé¢å·²ç» exit(1)

// ç»§ç»­å¯åŠ¨æµç¨‹...
```

**å…³é”®å˜åŒ–**ï¼š

- âœ… æ ¡éªŒé€»è¾‘ç»Ÿä¸€åˆ° `ConfigValidator`ï¼ˆåŸºäº `CONFIG_SCHEMA`ï¼‰
- âœ… æ‰€æœ‰ç¯å¢ƒ fail-fastï¼ˆç§»é™¤ development çš„ try/catch å¿½ç•¥ï¼‰
- âœ… é”™è¯¯æç¤ºåŒ…å«"ä¿®å¤æ–¹æ¡ˆ"ï¼ˆç¼ºå“ªä¸ªã€æ€ä¹ˆå¡«ã€ç”Ÿæˆå‘½ä»¤ï¼‰

---

### è„šæœ¬æ ¡éªŒç»Ÿä¸€æ”¹é€ ï¼ˆscripts/check-environment.jsï¼‰

**å½“å‰é—®é¢˜**ï¼š

- è‡ªå·±ç»´æŠ¤ä¸€å¥—æ£€æŸ¥é¡¹ï¼ˆä¸ `config/environment.js` ä¸ä¸€è‡´ï¼‰
- è‡ªå·± `dotenv.config()`ï¼ˆä¸"å•ç‚¹åŠ è½½"å†²çªï¼‰
- çŸ­ä¿¡é…ç½®å­—æ®µåä¸ `config.example` ä¸ä¸€è‡´

**æ”¹é€ æ–¹æ¡ˆ**ï¼ˆä¸å†™ä»£ç ï¼Œä»…æè¿°ï¼‰ï¼š

```javascript
// scripts/check-environment.jsï¼ˆæ”¹é€ åä¼ªä»£ç ï¼‰

// âŒ ç§»é™¤ï¼šrequire('dotenv').config()
// âœ… æ”¹ä¸ºï¼šå‡è®¾ç¯å¢ƒå˜é‡å·²ç”±è°ƒç”¨æ–¹æ³¨å…¥ï¼ˆæˆ–åœ¨è„šæœ¬å…¥å£ç»Ÿä¸€åŠ è½½ï¼‰

const { ConfigValidator } = require('../config/validator')

async function main() {
  console.log('ğŸ” ç¯å¢ƒé…ç½®æ£€æŸ¥å·¥å…·')
  console.log('æ£€æŸ¥æ—¶é—´ï¼š' + new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' }))

  // âœ… ä½¿ç”¨ç»Ÿä¸€æ ¡éªŒå™¨ï¼ˆä¸ app.js åŒä¸€å¥—é€»è¾‘ï¼‰
  const validation = ConfigValidator.validate(process.env.NODE_ENV, false) // failFast=falseï¼Œå…è®¸ç»§ç»­è¾“å‡ºæŠ¥å‘Š

  // ç”ŸæˆæŠ¥å‘Š
  if (validation.valid) {
    console.log('âœ… ç¯å¢ƒé…ç½®å®Œç¾ï¼å¯ä»¥å®‰å…¨å¯åŠ¨æœåŠ¡')
    process.exit(0)
  } else {
    console.log(`âŒ æ£€æµ‹åˆ° ${validation.errors.length} ä¸ªé”™è¯¯`)
    process.exit(1)
  }
}

main()
```

**å…³é”®å˜åŒ–**ï¼š

- âœ… ä¸å†è‡ªå·±ç»´æŠ¤æ£€æŸ¥é¡¹ï¼ˆå¼•ç”¨ `CONFIG_SCHEMA`ï¼‰
- âœ… ä¸å†è‡ªå·± `dotenv.config()`ï¼ˆå‡è®¾å·²ç”±è°ƒç”¨æ–¹åŠ è½½ï¼‰
- âœ… ä¸ `app.js` å¯åŠ¨æ ¡éªŒä½¿ç”¨åŒä¸€å¥—é€»è¾‘

---

### config.example å­—æ®µç»Ÿä¸€æ”¹é€ 

**å½“å‰é—®é¢˜**ï¼š

- å­—æ®µå‘½åä¸è„šæœ¬/ä»£ç ä¸ä¸€è‡´ï¼ˆçŸ­ä¿¡é…ç½®ï¼š`SMS_APP_ID` vs `SMS_PROVIDER`ï¼‰
- åŒ…å«åºŸå¼ƒå­—æ®µï¼ˆ`REDIS_HOST/REDIS_PORT`ï¼‰
- ç¼ºå°‘å¿…éœ€å­—æ®µï¼ˆ`ENCRYPTION_KEY`ã€`ALLOWED_ORIGINS`ï¼‰

**æ”¹é€ æ–¹æ¡ˆ**ï¼ˆä¸å†™ä»£ç ï¼Œä»…æè¿°ï¼‰ï¼š

**æ­¥éª¤ 1ï¼šå­—æ®µå‘½åå¯¹é½**

- æ‰«ææ‰€æœ‰ `services/` å’Œ `routes/` ä¸­å®é™…è¯»å–çš„ `process.env.*` é”®
- ä¸ `CONFIG_SCHEMA` å¯¹é½ï¼ˆschema æ˜¯å”¯ä¸€çœŸç›¸æºï¼‰
- åˆ é™¤ `config.example` ä¸­ä¸åœ¨ schema é‡Œçš„å­—æ®µ

**æ­¥éª¤ 2ï¼šè‡ªåŠ¨ç”Ÿæˆæ¨¡æ¿**

```bash
# ä½¿ç”¨ ConfigValidator.generateTemplate() è‡ªåŠ¨ç”Ÿæˆ
node -e "
const { ConfigValidator } = require('./config/validator')
const template = ConfigValidator.generateTemplate()
require('fs').writeFileSync('config.example', template)
console.log('âœ… config.example å·²è‡ªåŠ¨ç”Ÿæˆ')
"
```

**æ­¥éª¤ 3ï¼šCI æ£€æŸ¥**

- åœ¨ CI/PR æ£€æŸ¥ä¸­åŠ å…¥"config.example ä¸ CONFIG_SCHEMA ä¸€è‡´æ€§"æ ¡éªŒ
- é˜²æ­¢æ‰‹å·¥ä¿®æ”¹ `config.example` å¯¼è‡´æ¼‚ç§»

---

## ğŸ—„ï¸ SystemSettings åˆ†å±‚æ²»ç†æ–¹æ¡ˆ

### é…ç½®å½’å±å†³ç­–æ ‘ï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰

**å†³ç­–æµç¨‹**ï¼ˆæ–°å¢é…ç½®æ—¶å¿…é¡»èµ°å®Œæ•´ä¸ªæµç¨‹ï¼‰ï¼š

```
æ–°å¢é…ç½®éœ€æ±‚
    â†“
é—®é¢˜1ï¼šæ˜¯å¦åŒ…å«å¯†é’¥/å¯†ç /æ•æ„Ÿä¿¡æ¯ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ âŒ ç¦æ­¢è¿› DBï¼Œå¿…é¡»ç”¨ Env Variables
    â””â”€ å¦ â†’ ç»§ç»­
    â†“
é—®é¢˜2ï¼šæ˜¯å¦å½±å“ç»“ç®—/å®‰å…¨/æ ¸å¿ƒç®—æ³•ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ âŒ ç¦æ­¢è¿› DBï¼Œå¿…é¡»ç”¨ Code Configï¼ˆå‘ç‰ˆå®¡è®¡ï¼‰
    â””â”€ å¦ â†’ ç»§ç»­
    â†“
é—®é¢˜3ï¼šæ˜¯å¦éœ€è¦è¿è¥åŠ¨æ€è°ƒæ•´ï¼ˆä¸å‘ç‰ˆï¼‰ï¼Ÿ
    â”œâ”€ å¦ â†’ æ”¾ Code Config
    â””â”€ æ˜¯ â†’ ç»§ç»­
    â†“
é—®é¢˜4ï¼šæ˜¯å¦æœ‰æ˜ç¡®çš„ç±»å‹/èŒƒå›´çº¦æŸï¼Ÿ
    â”œâ”€ å¦ â†’ âš ï¸ å…ˆè®¾è®¡çº¦æŸï¼Œå†å†³å®š
    â””â”€ æ˜¯ â†’ âœ… å¯ä»¥è¿› DB SystemSettings
```

---

### SystemSettings ç™½åå•æ³¨å†Œè¡¨ï¼ˆå¼ºåˆ¶ç»´æŠ¤ï¼‰

**è®¾è®¡ç›®æ ‡**ï¼š

- æ‰€æœ‰å…è®¸è¿› `system_settings` çš„ key å¿…é¡»åœ¨æ­¤æ³¨å†Œ
- åå°ä¿®æ”¹é…ç½®æ—¶ï¼Œå¼ºåˆ¶æ ¡éªŒ key æ˜¯å¦åœ¨ç™½åå•å†…
- æä¾›ç±»å‹/èŒƒå›´çº¦æŸï¼Œé˜²æ­¢å¡«é”™å€¼

**ç™½åå•ç»“æ„**ï¼ˆåŸºäºå½“å‰çœŸå®æ•°æ®ä¼˜åŒ–ï¼‰ï¼š

```javascript
// config/system-settings-whitelist.jsï¼ˆæ–°å»ºæ–‡ä»¶ï¼‰
const SYSTEM_SETTINGS_WHITELIST = {
  // ===== åŸºç¡€è®¾ç½®ï¼ˆå±•ç¤ºç±»ï¼Œé€‚åˆ DBï¼‰=====
  'basic/system_name': {
    type: 'string',
    minLength: 2,
    maxLength: 50,
    default: 'é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ',
    readonly: false,
    description: 'ç³»ç»Ÿåç§°ï¼ˆæ˜¾ç¤ºåœ¨å‰ç«¯é¡µé¢æ ‡é¢˜ï¼‰',
    changeRequiresRestart: false // æ”¹åŠ¨æ˜¯å¦éœ€è¦é‡å¯æœåŠ¡
  },

  'basic/system_version': {
    type: 'string',
    pattern: /^\d+\.\d+\.\d+$/,
    default: '4.0.0',
    readonly: true, // åªè¯»ï¼Œä»…ç³»ç»Ÿæ›´æ–°æ—¶è‡ªåŠ¨ä¿®æ”¹
    description: 'ç³»ç»Ÿç‰ˆæœ¬å·',
    changeRequiresRestart: false
  },

  'basic/customer_email': {
    type: 'string',
    pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
    default: 'support@example.com',
    readonly: false,
    description: 'å®¢æœé‚®ç®±',
    changeRequiresRestart: false
  },

  'basic/customer_phone': {
    type: 'string',
    pattern: /^1[3-9]\d{9}$/,
    default: '400-000-0000',
    readonly: false,
    description: 'å®¢æœç”µè¯',
    changeRequiresRestart: false
  },

  // ===== ç§¯åˆ†è®¾ç½®ï¼ˆè¿è¥ç­–ç•¥ï¼Œéƒ¨åˆ†é€‚åˆ DBï¼‰=====
  'points/points_expire_days': {
    type: 'number',
    min: 0,
    max: 3650, // æœ€é•¿ 10 å¹´
    default: 0, // 0 è¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆ
    readonly: false,
    description: 'ç§¯åˆ†æœ‰æ•ˆæœŸï¼ˆå¤©æ•°ï¼‰',
    changeRequiresRestart: false,
    businessImpact: 'MEDIUM' // å½±å“ç”¨æˆ·ä½“éªŒï¼Œä½†ä¸å½±å“ç»“ç®—
  },

  // ===== è¿è¥å¯è°ƒçš„å…³é”®å‚æ•°ï¼ˆéœ€å¼ºçº¦æŸï¼‰=====
  'points/lottery_cost_points': {
    type: 'number',
    min: 50, // âœ… ä¸šåŠ¡å†³ç­–ç¡®è®¤ï¼šæœ€ä½ 50 ç§¯åˆ†ï¼ˆé˜²æ­¢è¿‡ä½å¯¼è‡´åˆ·é‡ï¼‰
    max: 500, // âœ… ä¸šåŠ¡å†³ç­–ç¡®è®¤ï¼šæœ€é«˜ 500 ç§¯åˆ†ï¼ˆé˜²æ­¢è¿‡é«˜å½±å“ç”¨æˆ·ä½“éªŒï¼‰
    default: 100,
    readonly: false, // âœ… ä¸šåŠ¡å†³ç­–ï¼šè¿è¥å¯è°ƒï¼ˆç”¨äºæ´»åŠ¨/ä¿ƒé”€ï¼‰
    description: 'å•æ¬¡æŠ½å¥–æ¶ˆè€—ç§¯åˆ†ï¼ˆè¿è¥å¯è°ƒï¼Œç”¨äºæ´»åŠ¨å®šä»·ï¼‰',
    changeRequiresRestart: false,
    businessImpact: 'HIGH',
    auditRequired: true, // âœ… å¼ºåˆ¶å®¡è®¡ï¼šè®°å½•è°æ”¹çš„ã€æ”¹å‰æ”¹åå€¼ã€æ”¹åŠ¨åŸå› 
    approvalRequired: false, // âœ… ä¸šåŠ¡å†³ç­–ï¼šæ— éœ€å®¡æ‰¹ï¼Œè¿è¥ä¸»ç®¡å¯ç›´æ¥ä¿®æ”¹
    changeNotification: false, // âœ… ä¸šåŠ¡å†³ç­–ï¼šæ— éœ€é€šçŸ¥ï¼ˆé€šè¿‡å®¡è®¡æ—¥å¿—è¿½æº¯ï¼‰
    conflict: {
      resolution: 'åˆ é™¤ config/business.config.js ä¸­çš„ draw_pricing.single_drawï¼Œç»Ÿä¸€ä½¿ç”¨ DB é…ç½®'
    }
  },

  'points/budget_allocation_ratio': {
    type: 'number',
    min: 0.1, // âœ… ä¸šåŠ¡å†³ç­–ï¼šæœ€ä½ 10%ï¼ˆé˜²æ­¢é¢„ç®—è¿‡ä½ï¼‰
    max: 0.5, // âœ… ä¸šåŠ¡å†³ç­–ï¼šæœ€é«˜ 50%ï¼ˆé˜²æ­¢é¢„ç®—è¿‡é«˜å¯¼è‡´äºæŸï¼‰
    step: 0.01, // ç²¾åº¦ï¼š0.01ï¼ˆå³ 1%ï¼‰
    default: 0.24,
    readonly: false, // âœ… ä¸šåŠ¡å†³ç­–ï¼šè¿è¥å¯è°ƒï¼ˆç”¨äºåŠ¨æ€è°ƒæ•´é¢„ç®—ç­–ç•¥ï¼‰
    description: 'é¢„ç®—åˆ†é…ç³»æ•°ï¼ˆæ¶ˆè´¹é‡‘é¢Ã—è¯¥ç³»æ•°=é¢„ç®—ç§¯åˆ†ï¼‰',
    changeRequiresRestart: false,
    businessImpact: 'CRITICAL',
    auditRequired: true, // âœ… å¼ºåˆ¶å®¡è®¡
    approvalRequired: false, // âœ… ä¸šåŠ¡å†³ç­–ï¼šæ— éœ€å®¡æ‰¹ï¼Œè¿è¥ä¸»ç®¡å¯ç›´æ¥ä¿®æ”¹
    changeNotification: false // âœ… ä¸šåŠ¡å†³ç­–ï¼šæ— éœ€é€šçŸ¥ï¼ˆé€šè¿‡å®¡è®¡æ—¥å¿—è¿½æº¯ï¼‰
  },

  'points/daily_lottery_limit': {
    type: 'number',
    min: 10, // âœ… ä¸šåŠ¡å†³ç­–ï¼šæœ€ä½ 10 æ¬¡ï¼ˆé˜²æ­¢è¿‡ä½ï¼‰
    max: 200, // âœ… ä¸šåŠ¡å†³ç­–ï¼šæœ€é«˜ 200 æ¬¡ï¼ˆé˜²æ­¢åˆ·é‡ï¼‰
    default: 50,
    readonly: false, // âœ… ä¸šåŠ¡å†³ç­–ï¼šè¿è¥å¯è°ƒï¼ˆæ´»åŠ¨æœŸä¸´æ—¶è°ƒæ•´ï¼‰
    description: 'æ¯æ—¥æŠ½å¥–æ¬¡æ•°ä¸Šé™ï¼ˆè¿è¥å¯è°ƒï¼Œç”¨äºæ´»åŠ¨è°ƒæ•´ï¼‰',
    changeRequiresRestart: false,
    businessImpact: 'HIGH',
    auditRequired: true,
    approvalRequired: false,
    changeNotification: false,
    conflict: {
      resolution: 'åˆ é™¤ config/business.config.js ä¸­çš„ daily_limit.allï¼Œç»Ÿä¸€ä½¿ç”¨ DB é…ç½®'
    }
  },

  // ===== å¸‚åœºè®¾ç½®ï¼ˆè¿è¥å¯è°ƒï¼‰=====
  'marketplace/max_active_listings': {
    type: 'number',
    min: 1, // âœ… ä¸šåŠ¡å†³ç­–ï¼šæœ€ä½ 1 ä»¶
    max: 50, // âœ… ä¸šåŠ¡å†³ç­–ï¼šæœ€é«˜ 50 ä»¶
    default: 10,
    readonly: false, // âœ… ä¸šåŠ¡å†³ç­–ï¼šè¿è¥å¯è°ƒï¼ˆä¸šåŠ¡è§„åˆ™çµæ´»è°ƒæ•´ï¼‰
    description: 'ç”¨æˆ·æœ€å¤šåŒæ—¶ä¸Šæ¶å•†å“æ•°ï¼ˆè¿è¥å¯è°ƒï¼‰',
    changeRequiresRestart: false,
    businessImpact: 'MEDIUM',
    auditRequired: true,
    approvalRequired: false,
    changeNotification: false,
    conflict: {
      resolution: 'åˆ é™¤ config/marketplace.config.js ä¸­çš„ max_active_listingsï¼Œç»Ÿä¸€ä½¿ç”¨ DB é…ç½®'
    }
  },

  // ===== å®‰å…¨è®¾ç½®ï¼ˆè¿è¥å¯è°ƒï¼‰=====
  'security/max_login_attempts': {
    type: 'number',
    min: 3, // âœ… ä¸šåŠ¡å†³ç­–ï¼šæœ€ä½ 3 æ¬¡
    max: 10, // âœ… ä¸šåŠ¡å†³ç­–ï¼šæœ€é«˜ 10 æ¬¡
    default: 5,
    readonly: false, // âœ… ä¸šåŠ¡å†³ç­–ï¼šè¿è¥å¯è°ƒï¼ˆå®‰å…¨ç­–ç•¥çµæ´»è°ƒæ•´ï¼‰
    description: 'æœ€å¤§ç™»å½•å¤±è´¥æ¬¡æ•°ï¼ˆè¿è¥å¯è°ƒï¼‰',
    changeRequiresRestart: false,
    businessImpact: 'HIGH',
    auditRequired: true,
    approvalRequired: false,
    changeNotification: false
  },

  'security/lockout_duration': {
    type: 'number',
    min: 5,
    max: 1440, // æœ€é•¿ 24 å°æ—¶
    default: 30,
    readonly: false,
    description: 'è´¦æˆ·é”å®šæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰',
    changeRequiresRestart: false,
    businessImpact: 'MEDIUM',
    auditRequired: true,
    approvalRequired: false,
    changeNotification: false
  },

  'security/password_min_length': {
    type: 'number',
    min: 6, // âœ… ä¸šåŠ¡å†³ç­–ï¼šæœ€ä½ 6 å­—ç¬¦
    max: 32, // âœ… ä¸šåŠ¡å†³ç­–ï¼šæœ€é«˜ 32 å­—ç¬¦
    default: 8,
    readonly: false, // âœ… ä¸šåŠ¡å†³ç­–ï¼šè¿è¥å¯è°ƒï¼ˆå®‰å…¨ç­–ç•¥çµæ´»è°ƒæ•´ï¼‰
    description: 'å¯†ç æœ€å°é•¿åº¦ï¼ˆè¿è¥å¯è°ƒï¼‰',
    changeRequiresRestart: false,
    businessImpact: 'HIGH',
    auditRequired: true,
    approvalRequired: false,
    changeNotification: false
  },

  'security/api_rate_limit': {
    type: 'number',
    min: 10, // âœ… ä¸šåŠ¡å†³ç­–ï¼šæœ€ä½ 10 æ¬¡/åˆ†é’Ÿ
    max: 1000, // âœ… ä¸šåŠ¡å†³ç­–ï¼šæœ€é«˜ 1000 æ¬¡/åˆ†é’Ÿ
    default: 100,
    readonly: false, // âœ… ä¸šåŠ¡å†³ç­–ï¼šè¿è¥å¯è°ƒï¼ˆé£æ§ç­–ç•¥çµæ´»è°ƒæ•´ï¼‰
    description: 'API è¯·æ±‚é¢‘ç‡é™åˆ¶ï¼ˆæ¯åˆ†é’Ÿï¼Œè¿è¥å¯è°ƒï¼‰',
    changeRequiresRestart: false,
    businessImpact: 'HIGH',
    auditRequired: true,
    approvalRequired: false,
    changeNotification: false
  },

  // ===== é€šçŸ¥è®¾ç½®ï¼ˆå¼€å…³ç±»ï¼Œé€‚åˆ DBï¼‰=====
  'notification/sms_enabled': {
    type: 'boolean', // ğŸ”´ å½“å‰ DB å­˜çš„æ˜¯ stringï¼Œéœ€è¦ä¿®å¤
    default: true,
    readonly: false,
    description: 'æ˜¯å¦å¯ç”¨çŸ­ä¿¡é€šçŸ¥',
    changeRequiresRestart: false,
    businessImpact: 'LOW'
  },

  'notification/email_enabled': {
    type: 'boolean',
    default: true,
    readonly: false,
    description: 'æ˜¯å¦å¯ç”¨é‚®ä»¶é€šçŸ¥',
    changeRequiresRestart: false,
    businessImpact: 'LOW'
  },

  'notification/app_notification_enabled': {
    type: 'boolean',
    default: true,
    readonly: false,
    description: 'æ˜¯å¦å¯ç”¨ APP å†…é€šçŸ¥',
    changeRequiresRestart: false,
    businessImpact: 'LOW'
  }
}

// ===== ç¦æ­¢è¿› DB çš„é…ç½®é»‘åå• =====
const FORBIDDEN_IN_DB = {
  patterns: [
    /.*_SECRET$/, // ä»»ä½•ä»¥ _SECRET ç»“å°¾çš„
    /.*_PASSWORD$/, // ä»»ä½•ä»¥ _PASSWORD ç»“å°¾çš„
    /.*_KEY$/, // ä»»ä½•ä»¥ _KEY ç»“å°¾çš„ï¼ˆé™¤éæ˜ç¡®ç™½åå•ï¼‰
    /^DB_/, // æ•°æ®åº“è¿æ¥ä¿¡æ¯
    /^REDIS_/, // Redis è¿æ¥ä¿¡æ¯
    /^JWT_/, // JWT å¯†é’¥
    /^SEALOS_/ // å¯¹è±¡å­˜å‚¨å¯†é’¥
  ],

  keywords: [
    'transaction', // äº‹åŠ¡ç›¸å…³
    'pool', // è¿æ¥æ± ç›¸å…³
    'timeout', // è¶…æ—¶é…ç½®ï¼ˆæŠ€æœ¯å‚æ•°ï¼‰
    'fee_strategy', // æ‰‹ç»­è´¹ç­–ç•¥ï¼ˆç»“ç®—å‚æ•°ï¼‰
    'charge_target', // æ”¶è´¹å¯¹è±¡ï¼ˆç»“ç®—å‚æ•°ï¼‰
    'budget_allocation' // é¢„ç®—åˆ†é…ï¼ˆç»“ç®—å‚æ•°ï¼‰
  ]
}

module.exports = {
  SYSTEM_SETTINGS_WHITELIST,
  FORBIDDEN_IN_DB
}
```

---

### SystemSettings å‡†å…¥æ ¡éªŒï¼ˆåå°ä¿®æ”¹æ—¶å¼ºåˆ¶æ‰§è¡Œï¼‰

**å®æ–½ä½ç½®**ï¼š`services/AdminSystemService.js` çš„é…ç½®ä¿®æ”¹æ–¹æ³•

**æ ¡éªŒé€»è¾‘**ï¼ˆä¼ªä»£ç ï¼‰ï¼š

```javascript
// services/AdminSystemService.jsï¼ˆä¼ªä»£ç ï¼‰
const {
  SYSTEM_SETTINGS_WHITELIST,
  FORBIDDEN_IN_DB
} = require('../config/system-settings-whitelist')

class AdminSystemService {
  static async updateSystemSetting(settingKey, newValue, operatorId, options = {}) {
    // 1. ç™½åå•æ£€æŸ¥
    const whitelist = SYSTEM_SETTINGS_WHITELIST[settingKey]
    if (!whitelist) {
      throw new Error(`é…ç½®é¡¹ ${settingKey} ä¸åœ¨ç™½åå•å†…ï¼Œç¦æ­¢ä¿®æ”¹`)
    }

    // 2. é»‘åå•æ£€æŸ¥ï¼ˆé˜²æ­¢è¯¯æ“ä½œï¼‰
    const isForbidden =
      FORBIDDEN_IN_DB.patterns.some(p => p.test(settingKey)) ||
      FORBIDDEN_IN_DB.keywords.some(k => settingKey.toLowerCase().includes(k))
    if (isForbidden) {
      throw new Error(`é…ç½®é¡¹ ${settingKey} å±äºç¦æ­¢ç±»ï¼ˆå¯†é’¥/ç»“ç®—é€»è¾‘ï¼‰ï¼Œä¸å…è®¸å­˜å‚¨åœ¨æ•°æ®åº“`)
    }

    // 3. åªè¯»æ£€æŸ¥
    if (whitelist.readonly) {
      throw new Error(`é…ç½®é¡¹ ${settingKey} ä¸ºåªè¯»ï¼Œç¦æ­¢ä¿®æ”¹`)
    }

    // 4. ç±»å‹/èŒƒå›´æ ¡éªŒ
    if (whitelist.type === 'number') {
      const num = Number(newValue)
      if (isNaN(num)) throw new Error(`${settingKey} å¿…é¡»æ˜¯æ•°å­—`)
      if (whitelist.min !== undefined && num < whitelist.min) {
        throw new Error(`${settingKey} ä¸èƒ½å°äº ${whitelist.min}ï¼ˆå½“å‰å€¼: ${num}ï¼‰`)
      }
      if (whitelist.max !== undefined && num > whitelist.max) {
        throw new Error(`${settingKey} ä¸èƒ½å¤§äº ${whitelist.max}ï¼ˆå½“å‰å€¼: ${num}ï¼‰`)
      }
      // ç²¾åº¦æ ¡éªŒï¼ˆå¦‚ budget_allocation_ratio è¦æ±‚ç²¾åº¦ 0.01ï¼‰
      if (whitelist.step !== undefined) {
        const remainder = (num * 100) % (whitelist.step * 100)
        if (remainder !== 0) {
          throw new Error(`${settingKey} ç²¾åº¦å¿…é¡»ä¸º ${whitelist.step}ï¼ˆå½“å‰å€¼: ${num}ï¼‰`)
        }
      }
    }

    if (whitelist.type === 'boolean') {
      if (
        typeof newValue !== 'boolean' &&
        !['true', 'false', '1', '0'].includes(String(newValue))
      ) {
        throw new Error(`${settingKey} å¿…é¡»æ˜¯å¸ƒå°”å€¼`)
      }
    }

    if (whitelist.pattern && !whitelist.pattern.test(newValue)) {
      throw new Error(`${settingKey} æ ¼å¼ä¸æ­£ç¡®`)
    }

    // 5. è·å–æ—§å€¼ï¼ˆç”¨äºå®¡è®¡ï¼‰
    const oldSetting = await SystemSettings.findOne({ where: { setting_key: settingKey } })
    const oldValue = oldSetting ? oldSetting.setting_value : null

    // 6. ä¸šåŠ¡å½±å“æ—¥å¿—
    if (whitelist.businessImpact === 'CRITICAL' || whitelist.businessImpact === 'HIGH') {
      logger.warn('ä¿®æ”¹é«˜å½±å“é…ç½®', {
        setting_key: settingKey,
        impact: whitelist.businessImpact,
        operator_id: operatorId,
        old_value: oldValue,
        new_value: newValue
      })
    }

    // 7. æ‰§è¡Œä¿®æ”¹
    await SystemSettings.update(
      { setting_value: newValue, updated_by: operatorId },
      { where: { setting_key: settingKey } }
    )

    // 8. è®°å½•å®¡è®¡æ—¥å¿—ï¼ˆå¼ºåˆ¶ï¼‰
    if (whitelist.auditRequired) {
      await AuditLogService.log({
        operator_id: operatorId,
        operation_type: 'update_system_setting',
        target_type: 'system_settings',
        target_id: settingKey,
        before_data: { value: oldValue },
        after_data: { value: newValue },
        reason: options.reason || `ä¿®æ”¹ç³»ç»Ÿé…ç½®: ${settingKey}`
      })
    }

    // 9. é‡å¯æç¤ºï¼ˆå¦‚éœ€è¦ï¼‰
    if (whitelist.changeRequiresRestart) {
      logger.warn('é…ç½®ä¿®æ”¹éœ€è¦é‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆ', { setting_key: settingKey })
    }

    return {
      success: true,
      requiresRestart: whitelist.changeRequiresRestart,
      oldValue: oldValue,
      newValue: newValue
    }
  }
}
```

---

### é…ç½®å†²çªæ£€æµ‹å¢å¼ºï¼ˆscripts/check-config-conflicts.jsï¼‰

**å½“å‰é—®é¢˜**ï¼š

- ä»…åš"ç›¸ä¼¼åº¦æ£€æµ‹"ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰ï¼Œæ— æ³•å‡†ç¡®åˆ¤å®š"æ˜¯å¦çœŸçš„å†²çª"
- æ²¡æœ‰"æœ€ç»ˆè£å†³è§„åˆ™"ï¼ˆå‘ç°å†²çªåï¼Œåº”è¯¥åˆ å“ªä¸ªã€ç•™å“ªä¸ªï¼‰

**æ”¹é€ æ–¹æ¡ˆ**ï¼ˆä¸å†™ä»£ç ï¼Œä»…æè¿°ï¼‰ï¼š

```javascript
// scripts/check-config-conflicts.jsï¼ˆå¢å¼ºç‰ˆä¼ªä»£ç ï¼‰
const { SYSTEM_SETTINGS_WHITELIST } = require('../config/system-settings-whitelist')
const businessConfig = require('../config/business.config')
const models = require('../models')

class EnhancedConflictDetector {
  async detect() {
    const conflicts = []

    // 1. è·å– DB é…ç½®
    const dbSettings = await models.SystemSettings.findAll()

    // 2. æ£€æŸ¥ DB é…ç½®æ˜¯å¦åœ¨ç™½åå•å†…
    for (const setting of dbSettings) {
      const key = `${setting.category}/${setting.setting_key}`

      if (!SYSTEM_SETTINGS_WHITELIST[key]) {
        conflicts.push({
          type: 'NOT_IN_WHITELIST',
          db_key: key,
          severity: 'HIGH',
          action: 'ä»æ•°æ®åº“åˆ é™¤æˆ–æ·»åŠ åˆ°ç™½åå•'
        })
      }
    }

    // 3. æ£€æŸ¥æ˜¯å¦ä¸ä»£ç é…ç½®é‡å
    const codeKeys = this._extractCodeConfigKeys(businessConfig)

    for (const setting of dbSettings) {
      const dbKey = setting.setting_key

      // ç²¾ç¡®åŒ¹é…ï¼ˆè€Œä¸æ˜¯æ¨¡ç³ŠåŒ¹é…ï¼‰
      if (codeKeys.includes(dbKey)) {
        const whitelist = SYSTEM_SETTINGS_WHITELIST[`${setting.category}/${dbKey}`]

        conflicts.push({
          type: 'DUPLICATE_DEFINITION',
          db_key: `${setting.category}/${dbKey}`,
          code_location: this._findCodeLocation(dbKey, businessConfig),
          severity: whitelist?.conflict ? 'HIGH' : 'MEDIUM',
          recommendation:
            whitelist?.conflict?.recommendation || 'éœ€è¦äººå·¥å†³ç­–ï¼šåˆ é™¤ DB æˆ–åˆ é™¤ä»£ç é…ç½®'
        })
      }
    }

    // 4. æ£€æŸ¥ç±»å‹ä¸ä¸€è‡´
    for (const setting of dbSettings) {
      const key = `${setting.category}/${setting.setting_key}`
      const whitelist = SYSTEM_SETTINGS_WHITELIST[key]

      if (whitelist && whitelist.type !== setting.value_type) {
        conflicts.push({
          type: 'TYPE_MISMATCH',
          db_key: key,
          expected_type: whitelist.type,
          actual_type: setting.value_type,
          severity: 'MEDIUM',
          action: `ä¿®æ”¹ DB è¡¨çš„ value_type ä¸º ${whitelist.type}`
        })
      }
    }

    // 5. æ£€æŸ¥ç¦æ­¢ç±»é…ç½®
    for (const setting of dbSettings) {
      const key = setting.setting_key
      const isForbidden =
        FORBIDDEN_IN_DB.patterns.some(p => p.test(key)) ||
        FORBIDDEN_IN_DB.keywords.some(k => key.toLowerCase().includes(k))

      if (isForbidden) {
        conflicts.push({
          type: 'FORBIDDEN_CONFIG',
          db_key: `${setting.category}/${key}`,
          severity: 'CRITICAL',
          action: 'ç«‹å³ä»æ•°æ®åº“åˆ é™¤ï¼Œè¿ç§»åˆ°ç¯å¢ƒå˜é‡æˆ–ä»£ç é…ç½®'
        })
      }
    }

    return conflicts
  }
}
```

---

## ğŸ“‹ å®æ–½æ–¹æ¡ˆï¼ˆåˆ†é˜¶æ®µæ‰§è¡Œï¼‰

### é˜¶æ®µ 1ï¼šå»ºç«‹ç»Ÿä¸€ Schemaï¼ˆ1-2 å¤©ï¼‰

**äº§ç‰©**ï¼š

- `config/schema.js`ï¼šç¯å¢ƒå˜é‡æƒå¨ schemaï¼ˆ50+ é¡¹é…ç½®çš„ç±»å‹/å¿…éœ€æ€§/çº¦æŸï¼‰
- `config/validator.js`ï¼šç»Ÿä¸€æ ¡éªŒå™¨ï¼ˆåŸºäº schema è‡ªåŠ¨ç”Ÿæˆæ ¡éªŒé€»è¾‘ï¼‰
- `config/system-settings-whitelist.js`ï¼šDB é…ç½®ç™½åå•ä¸å‡†å…¥è§„åˆ™

**æ‰§è¡Œæ­¥éª¤**ï¼š

1. æ‰«æå½“å‰ä»£ç æ‰€æœ‰ `process.env.*` å¼•ç”¨ï¼Œç”Ÿæˆå®Œæ•´ key åˆ—è¡¨
2. å¯¹æ¯ä¸ª key å®šä¹‰ï¼šç±»å‹ã€å¿…éœ€æ€§ã€ç¯å¢ƒå·®å¼‚ã€ç”Ÿäº§ç‰¹æ®Šçº¦æŸ
3. ä¸å½“å‰ `config.example` å¯¹é½ï¼Œåˆ é™¤åºŸå¼ƒé¡¹ã€è¡¥å……ç¼ºå¤±é¡¹
4. åŸºäºå½“å‰ `system_settings` çœŸå®æ•°æ®ï¼Œç”Ÿæˆç™½åå•åˆå§‹ç‰ˆæœ¬

**éªŒæ”¶æ ‡å‡†**ï¼š

- [ ] `CONFIG_SCHEMA` åŒ…å«æ‰€æœ‰å®é™…ä½¿ç”¨çš„ç¯å¢ƒå˜é‡ï¼ˆ50+ é¡¹ï¼‰
- [ ] æ¯ä¸ª key éƒ½æœ‰ç±»å‹/å¿…éœ€æ€§/çº¦æŸå®šä¹‰
- [ ] `SYSTEM_SETTINGS_WHITELIST` åŒ…å«å½“å‰ DB æ‰€æœ‰ 16 ä¸ªé…ç½®é¡¹
- [ ] æ¯ä¸ªç™½åå•é¡¹éƒ½æœ‰å‡†å…¥ç†ç”±ä¸çº¦æŸ

---

### é˜¶æ®µ 2ï¼šç»Ÿä¸€æ ¡éªŒå…¥å£ï¼ˆ1 å¤©ï¼‰

**æ”¹é€ æ–‡ä»¶**ï¼š

- `app.js`ï¼šå¯åŠ¨æ ¡éªŒæ”¹ä¸º `ConfigValidator.validate()`
- `config/environment.js`ï¼š`validateConfig()` æ”¹ä¸ºè°ƒç”¨ `ConfigValidator.validate()`
- `scripts/check-environment.js`ï¼šæ”¹ä¸ºè°ƒç”¨ `ConfigValidator.validate()`

**å…³é”®å˜åŒ–**ï¼š

- âœ… ä¸‰å¤„æ ¡éªŒä½¿ç”¨åŒä¸€å¥—é€»è¾‘ï¼ˆåŸºäº `CONFIG_SCHEMA`ï¼‰
- âœ… ç§»é™¤ `app.js` çš„ try/catch å¿½ç•¥ï¼ˆæ‰€æœ‰ç¯å¢ƒ fail-fastï¼‰
- âœ… `validateConfig()` æ”¹ä¸º throw Errorï¼ˆè€Œä¸æ˜¯ `process.exit(1)`ï¼‰ï¼Œè®©è°ƒç”¨æ–¹å†³å®šé€€å‡ºç­–ç•¥

**éªŒæ”¶æ ‡å‡†**ï¼š

- [ ] åº”ç”¨å¯åŠ¨ã€è„šæœ¬æ£€æŸ¥ã€CI æ£€æŸ¥ä½¿ç”¨åŒä¸€ä»½å¿…éœ€é¡¹åˆ—è¡¨
- [ ] ç¼ºå°‘ä»»ä½•"âœ… å¿…éœ€"é¡¹æ—¶ï¼Œæ‰€æœ‰ç¯å¢ƒéƒ½ fail-fast
- [ ] é”™è¯¯æç¤ºåŒ…å«"ä¿®å¤æ–¹æ¡ˆ"ï¼ˆæ€ä¹ˆå¡«ã€ç”Ÿæˆå‘½ä»¤ï¼‰

---

### é˜¶æ®µ 3ï¼šconfig.example è‡ªåŠ¨ç”Ÿæˆï¼ˆ0.5 å¤©ï¼‰

**æ‰§è¡Œæ–¹æ¡ˆ**ï¼š

```bash
# 1. åŸºäº CONFIG_SCHEMA è‡ªåŠ¨ç”Ÿæˆ
node -e "
const { ConfigValidator } = require('./config/validator')
const template = ConfigValidator.generateTemplate()
require('fs').writeFileSync('config.example', template)
console.log('âœ… config.example å·²è‡ªåŠ¨ç”Ÿæˆ')
"

# 2. äººå·¥å®¡æŸ¥ç”Ÿæˆçš„æ¨¡æ¿
vim config.example

# 3. æ·»åŠ  CI æ£€æŸ¥ï¼ˆé˜²æ­¢æ‰‹å·¥ä¿®æ”¹æ¼‚ç§»ï¼‰
# åœ¨ .github/workflows/ æˆ– package.json scripts ä¸­æ·»åŠ ï¼š
npm run validate:config-template
```

**éªŒæ”¶æ ‡å‡†**ï¼š

- [ ] `config.example` å­—æ®µä¸ `CONFIG_SCHEMA` å®Œå…¨ä¸€è‡´
- [ ] æ‰€æœ‰å¯†é’¥/å¯†ç ä½¿ç”¨ `CHANGE_ME_*` å ä½ç¬¦
- [ ] åŒ…å«å­—æ®µè¯´æ˜ä¸ç”Ÿæˆå‘½ä»¤æç¤º
- [ ] CI æ£€æŸ¥èƒ½æ‹¦æˆª"æ‰‹å·¥ä¿®æ”¹å¯¼è‡´çš„æ¼‚ç§»"

---

### é˜¶æ®µ 4ï¼šSystemSettings æ²»ç†ï¼ˆ2-3 å¤©ï¼‰

**æ‰§è¡Œæ­¥éª¤**ï¼š

**4.1 ä¿®å¤å½“å‰ DB é…ç½®é—®é¢˜**ï¼š

```sql
-- 1. ä¿®å¤ç±»å‹ä¸ä¸€è‡´ï¼ˆ4 ä¸ªé…ç½®é¡¹ï¼‰
UPDATE system_settings SET value_type = 'number' WHERE setting_key IN ('initial_points', 'sign_in_points', 'max_login_attempts');
UPDATE system_settings SET value_type = 'boolean' WHERE setting_key = 'sms_enabled';

-- 2. è®¾ç½®å…³é”®å‚æ•°ä¸ºåªè¯»ï¼ˆé˜²æ­¢è¯¯æ“ä½œï¼‰
UPDATE system_settings SET is_readonly = true WHERE setting_key IN ('budget_allocation_ratio', 'password_min_length', 'api_rate_limit');

-- 3. åˆ é™¤é‡åå†²çªé…ç½®ï¼ˆå¦‚æœå†³å®š"ä»£ç é…ç½®ä¸ºå‡†"ï¼‰
-- DELETE FROM system_settings WHERE setting_key = 'lottery_cost_points';
-- æˆ–è€…ï¼šåœ¨ä»£ç é‡Œæ”¹ä¸º"DB è¦†ç›– Code é»˜è®¤å€¼"çš„æ˜ç¡®æœºåˆ¶
```

**4.2 åå°ä¿®æ”¹æ¥å£åŠ ç™½åå•æ ¡éªŒ**ï¼š

- åœ¨ `AdminSystemService.updateSystemSetting()` å¼€å¤´åŠ ç™½åå•/é»‘åå•/ç±»å‹/èŒƒå›´æ ¡éªŒ
- ä¿®æ”¹å‰è®°å½•å®¡è®¡æ—¥å¿—ï¼ˆè°æ”¹çš„ã€æ”¹å‰æ”¹åå€¼ã€æ”¹åŠ¨åŸå› ï¼‰

**4.3 å®šæœŸå†²çªæ£€æµ‹**ï¼š

```bash
# åŠ å…¥ CI æˆ–å®šæœŸä»»åŠ¡
npm run check:config-conflicts

# å¦‚æœæ£€æµ‹åˆ°å†²çªï¼Œå¿…é¡»äººå·¥å†³ç­–ï¼š
# - åˆ é™¤ DB é…ç½®ï¼ˆæ”¹ç”¨ä»£ç é…ç½®ï¼‰
# - æˆ–åˆ é™¤ä»£ç é…ç½®ï¼ˆæ”¹ç”¨ DB å¯è°ƒå‚æ•°ï¼‰
# - æˆ–æ˜ç¡®"DB è¦†ç›– Code é»˜è®¤å€¼"çš„ä¼˜å…ˆçº§
```

**éªŒæ”¶æ ‡å‡†**ï¼š

- [ ] DB é…ç½®ç±»å‹ä¸ç™½åå•å®šä¹‰ä¸€è‡´
- [ ] ç»“ç®—/å®‰å…¨å…³é”®å‚æ•°è®¾ä¸º readonly
- [ ] åå°ä¿®æ”¹é…ç½®æ—¶å¼ºåˆ¶ç™½åå•æ ¡éªŒ
- [ ] é‡åå†²çªå·²è§£å†³ï¼ˆåˆ é™¤ä¸€æ–¹æˆ–æ˜ç¡®ä¼˜å…ˆçº§ï¼‰

---

## ğŸ¯ é…ç½®å½’å±çŸ©é˜µï¼ˆæœ€ç»ˆå†³ç­–å‚è€ƒï¼‰

### å½“å‰é¡¹ç›®é…ç½®å…¨æ™¯å›¾ï¼ˆåŸºäºçœŸå®å®¡è®¡ï¼‰

| é…ç½®é¡¹                                         | å½“å‰ä½ç½®        | å»ºè®®å½’å±         | ç†ç”±         | è¡ŒåŠ¨                                                          |
| ---------------------------------------------- | --------------- | ---------------- | ------------ | ------------------------------------------------------------- |
| **åŸºç¡€è®¾æ–½/å¯†é’¥**                              |
| `DB_*`                                         | âœ… Env          | âœ… Env           | åŸºç¡€è®¾æ–½è¿æ¥ | ä¿æŒ                                                          |
| `REDIS_URL`                                    | âœ… Env          | âœ… Env           | åŸºç¡€è®¾æ–½è¿æ¥ | ä¿æŒ                                                          |
| `JWT_SECRET`                                   | âœ… Env          | âœ… Env           | å¯†é’¥         | ä¿æŒ                                                          |
| `SEALOS_*`                                     | âœ… Env          | âœ… Env           | å¯†é’¥         | ä¿æŒ                                                          |
| `WX_*`                                         | âœ… Env          | âœ… Env           | å¯†é’¥         | ä¿æŒ                                                          |
| **ä¸šåŠ¡è§„åˆ™ï¼ˆå‘ç‰ˆçº§ï¼‰**                         |
| `lottery.draw_pricing.multi_draw_*`            | âœ… Code         | âœ… Code          | è¿æŠ½å®šä»·     | ä¿æŒ                                                          |
| `fee_rules.tiers`                              | âœ… Code         | âœ… Code          | ç»“ç®—æ‰‹ç»­è´¹ç‡ | ä¿æŒ                                                          |
| `fee_rules.fee_strategy`                       | âœ… Code         | âœ… Code          | ç»“ç®—é€»è¾‘     | ä¿æŒ                                                          |
| `price_validation.min_ratio/max_ratio`         | âœ… Code         | âœ… Code          | é£æ§å‚æ•°     | ä¿æŒ                                                          |
| **è¿è¥å‚æ•°ï¼ˆå¯è°ƒ - æ™®é€šï¼‰**                    |
| `system_name`                                  | âœ… DB           | âœ… DB            | å±•ç¤ºæ–‡æ¡ˆ     | ä¿æŒ                                                          |
| `customer_email`                               | âœ… DB           | âœ… DB            | è”ç³»æ–¹å¼     | ä¿æŒ                                                          |
| `points_expire_days`                           | âœ… DB           | âœ… DB            | è¿è¥ç­–ç•¥     | ä¿æŒ                                                          |
| `email_enabled`                                | âœ… DB           | âœ… DB            | åŠŸèƒ½å¼€å…³     | ä¿æŒ                                                          |
| **è¿è¥å‚æ•°ï¼ˆå¯è°ƒ - å…³é”®ï¼Œå·²å†³ç­– 2025-12-30ï¼‰** |
| `lottery_cost_points`                          | âœ… DBï¼ˆå”¯ä¸€ï¼‰   | âœ… DBï¼ˆå¼ºçº¦æŸï¼‰  | å®šä»·ç­–ç•¥     | **âœ… åˆ é™¤ Code é…ç½®ï¼Œä¿ç•™ DBï¼ˆèŒƒå›´ 50-500ï¼Œå®¡è®¡ï¼Œæ— éœ€å®¡æ‰¹ï¼‰** |
| `budget_allocation_ratio`                      | âœ… DBï¼ˆå¼ºçº¦æŸï¼‰ | âœ… DBï¼ˆå¼ºçº¦æŸï¼‰  | é¢„ç®—åˆ†é…     | **âœ… ä¿ç•™ DBï¼ˆèŒƒå›´ 0.1-0.5ï¼Œå®¡è®¡ï¼Œæ— éœ€å®¡æ‰¹ï¼‰**                |
| `daily_lottery_limit`                          | âœ… DBï¼ˆå¼ºçº¦æŸï¼‰ | âœ… DBï¼ˆå¼ºçº¦æŸï¼‰  | æ¯æ—¥ä¸Šé™     | **âœ… åˆ é™¤ Code é…ç½®ï¼Œä¿ç•™ DBï¼ˆèŒƒå›´ 10-200ï¼Œå®¡è®¡ï¼Œæ— éœ€å®¡æ‰¹ï¼‰** |
| `max_active_listings`                          | âœ… DBï¼ˆå¼ºçº¦æŸï¼‰ | âœ… DBï¼ˆå¼ºçº¦æŸï¼‰  | ä¸Šæ¶é™åˆ¶     | **âœ… åˆ é™¤ Code é…ç½®ï¼Œä¿ç•™ DBï¼ˆèŒƒå›´ 1-50ï¼Œå®¡è®¡ï¼Œæ— éœ€å®¡æ‰¹ï¼‰**   |
| `password_min_length`                          | âœ… DBï¼ˆå¼ºçº¦æŸï¼‰ | âœ… DBï¼ˆå¼ºçº¦æŸï¼‰  | å®‰å…¨å‚æ•°     | **âœ… ä¿ç•™ DBï¼ˆèŒƒå›´ 6-32ï¼Œå®¡è®¡ï¼Œæ— éœ€å®¡æ‰¹ï¼‰**                   |
| `api_rate_limit`                               | âœ… DBï¼ˆå¼ºçº¦æŸï¼‰ | âœ… DBï¼ˆå¼ºçº¦æŸï¼‰  | é£æ§å‚æ•°     | **âœ… ä¿ç•™ DBï¼ˆèŒƒå›´ 10-1000ï¼Œå®¡è®¡ï¼Œæ— éœ€å®¡æ‰¹ï¼‰**                |
| `max_login_attempts`                           | âœ… DBï¼ˆå¼ºçº¦æŸï¼‰ | âœ… DBï¼ˆå¼ºçº¦æŸï¼‰  | å®‰å…¨å‚æ•°     | **âœ… ä¿ç•™ DBï¼ˆèŒƒå›´ 3-10ï¼Œå®¡è®¡ï¼Œæ— éœ€å®¡æ‰¹ï¼‰**                   |
| **ç±»å‹ä¿®å¤é¡¹**                                 |
| `initial_points`                               | âš ï¸ DBï¼ˆstringï¼‰ | âœ… DBï¼ˆnumberï¼‰  | ç±»å‹ä¸ä¸€è‡´   | **ä¿®å¤ value_type**                                           |
| `sign_in_points`                               | âš ï¸ DBï¼ˆstringï¼‰ | âœ… DBï¼ˆnumberï¼‰  | ç±»å‹ä¸ä¸€è‡´   | **ä¿®å¤ value_type**                                           |
| `sms_enabled`                                  | âš ï¸ DBï¼ˆstringï¼‰ | âœ… DBï¼ˆbooleanï¼‰ | ç±»å‹ä¸ä¸€è‡´   | **ä¿®å¤ value_type**                                           |

---

## ğŸ” é—®é¢˜è¯Šæ–­ä¸ä¿®å¤æ¸…å•

### é—®é¢˜ Aï¼š`lottery_cost_points` é‡åå†²çªï¼ˆâœ… å·²å†³ç­–ï¼‰

**ä¸šåŠ¡å†³ç­–ï¼ˆ2025-12-30ï¼‰**ï¼š**ä¿ç•™ DB é…ç½®ï¼Œåˆ é™¤ä»£ç é…ç½®**

**ç°çŠ¶**ï¼š

- `config/business.config.js`ï¼šå®šä¹‰äº†å®Œæ•´çš„ `draw_pricing`ï¼ˆå•æŠ½ 100ã€10 è¿æŠ½ 900ï¼‰
- `system_settings` DBï¼šå­˜åœ¨ `points/lottery_cost_points`ï¼ˆå¯æ”¹ï¼‰

**æœ€ç»ˆæ–¹æ¡ˆ**ï¼š

- âœ… **ä¿ç•™ DB é…ç½®**ï¼šä½œä¸ºå”¯ä¸€çœŸç›¸æºï¼Œè¿è¥å¯è°ƒ
- âœ… **åˆ é™¤ä»£ç é…ç½®**ï¼šåˆ é™¤ `config/business.config.js` ä¸­çš„ `draw_pricing.single_draw`
- âœ… **å¼ºåŒ–çº¦æŸ**ï¼š
  - èŒƒå›´é™åˆ¶ï¼š50-500 ç§¯åˆ†
  - å®¡è®¡æ—¥å¿—ï¼šè®°å½•è°æ”¹çš„ã€æ”¹å‰æ”¹åå€¼ã€æ”¹åŠ¨åŸå› 
  - å˜æ›´é€šçŸ¥ï¼šä¿®æ”¹åé€šçŸ¥æŠ€æœ¯å›¢é˜Ÿ

**æ‰§è¡Œæ­¥éª¤**ï¼š

```javascript
// 1. ä¿®æ”¹ config/business.config.js
// åˆ é™¤æˆ–æ³¨é‡Šæ‰ single_draw å®šä»·
const businessConfig = {
  lottery: {
    draw_pricing: {
      // single_draw: 100,  // âŒ åˆ é™¤ï¼šæ”¹ä¸ºä» DB è¯»å–
      multi_draw_3: 280,
      multi_draw_5: 450,
      multi_draw_10: 900
    }
  }
}

// 2. ä¿®æ”¹ä¸šåŠ¡é€»è¾‘ï¼šä» DB è¯»å–å•æŠ½ä»·æ ¼
async function getLotteryCost() {
  const setting = await SystemSettings.findOne({
    where: { category: 'points', setting_key: 'lottery_cost_points' }
  })
  return setting ? Number(setting.setting_value) : 100 // å…œåº•å€¼ 100
}
```

---

### é—®é¢˜ Bï¼š`budget_allocation_ratio` ç»“ç®—å‚æ•°å¯æ”¹ï¼ˆâœ… å·²å†³ç­–ï¼‰

**ä¸šåŠ¡å†³ç­–ï¼ˆ2025-12-30ï¼‰**ï¼š**ä¿ç•™ DB é…ç½®ï¼Œä½†å¼ºåŒ–çº¦æŸä¸å®¡æ‰¹æµç¨‹**

**ç°çŠ¶**ï¼š

- DB å­˜åœ¨ `points/budget_allocation_ratio = 0.24`ï¼ˆå¯æ”¹ï¼‰
- è¯´æ˜ï¼šæ¶ˆè´¹é‡‘é¢ Ã— 0.24 = é¢„ç®—ç§¯åˆ†ï¼ˆç»“ç®—å…¬å¼ï¼‰

**æœ€ç»ˆæ–¹æ¡ˆ**ï¼š

- âœ… **ä¿ç•™ DB é…ç½®**ï¼šè¿è¥å¯è°ƒï¼ˆç”¨äºåŠ¨æ€è°ƒæ•´é¢„ç®—ç­–ç•¥ï¼‰
- âœ… **å¼ºåŒ–çº¦æŸ**ï¼š
  - èŒƒå›´é™åˆ¶ï¼š0.1-0.5ï¼ˆ10%-50%ï¼‰
  - ç²¾åº¦é™åˆ¶ï¼š0.01ï¼ˆå³ 1%ï¼‰
  - å®¡è®¡æ—¥å¿—ï¼šè®°å½•è°æ”¹çš„ã€æ”¹å‰æ”¹åå€¼ã€æ”¹åŠ¨åŸå› 
  - âŒ **æ— éœ€å®¡æ‰¹**ï¼šè¿è¥ä¸»ç®¡å¯ç›´æ¥ä¿®æ”¹ï¼ˆä¸šåŠ¡å†³ç­– 2025-12-30ï¼‰
  - âŒ **æ— éœ€é€šçŸ¥**ï¼šé€šè¿‡å®¡è®¡æ—¥å¿—äº‹åè¿½æº¯ï¼ˆä¸šåŠ¡å†³ç­– 2025-12-30ï¼‰

**æ‰§è¡Œæ­¥éª¤**ï¼š

```sql
-- 1. ç¡®ä¿å½“å‰å€¼åœ¨åˆè§„èŒƒå›´å†…
UPDATE system_settings
SET setting_value = GREATEST(0.1, LEAST(0.5, CAST(setting_value AS DECIMAL(10,2))))
WHERE setting_key = 'budget_allocation_ratio';

-- 2. ä¸è®¾ä¸º readonlyï¼ˆä¿æŒå¯æ”¹ï¼‰
UPDATE system_settings
SET is_readonly = false
WHERE setting_key = 'budget_allocation_ratio';

-- 3. ç¡®ä¿ç±»å‹æ­£ç¡®
UPDATE system_settings
SET value_type = 'number'
WHERE setting_key = 'budget_allocation_ratio';
```

**åå°ä¿®æ”¹ç•Œé¢è°ƒç”¨**ï¼š

```javascript
// âœ… ä¸šåŠ¡å†³ç­–ï¼šæ— éœ€å®¡æ‰¹ï¼Œè¿è¥ä¸»ç®¡å¯ç›´æ¥ä¿®æ”¹
await AdminSystemService.updateSystemSetting(
  'points/budget_allocation_ratio',
  0.3, // æ–°å€¼
  operatorId,
  {
    reason: 'è°ƒæ•´é¢„ç®—ç­–ç•¥ä»¥åº”å¯¹Q1ä¿ƒé”€æ´»åŠ¨' // å¯é€‰ï¼šå˜æ›´åŸå› ï¼ˆç”¨äºå®¡è®¡æ—¥å¿—ï¼‰
  }
)
```

---

### é—®é¢˜ Cï¼šç±»å‹ä¸ä¸€è‡´ï¼ˆ4 ä¸ªé…ç½®é¡¹ï¼‰

**ç°çŠ¶**ï¼š

- `initial_points`ï¼šç™½åå•å®šä¹‰ numberï¼ŒDB å­˜å‚¨ string
- `sign_in_points`ï¼šç™½åå•å®šä¹‰ numberï¼ŒDB å­˜å‚¨ string
- `max_login_attempts`ï¼šç™½åå•å®šä¹‰ numberï¼ŒDB å­˜å‚¨ string
- `sms_enabled`ï¼šç™½åå•å®šä¹‰ booleanï¼ŒDB å­˜å‚¨ string

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

```sql
-- ä¿®å¤ç±»å‹å£°æ˜ï¼ˆä¸æ”¹æ•°æ®ï¼Œåªæ”¹å…ƒæ•°æ®ï¼‰
UPDATE system_settings SET value_type = 'number' WHERE setting_key IN ('initial_points', 'sign_in_points', 'max_login_attempts');
UPDATE system_settings SET value_type = 'boolean' WHERE setting_key = 'sms_enabled';
```

**éªŒè¯**ï¼š

```bash
# æ£€æŸ¥ç±»å‹æ˜¯å¦ä¿®å¤
node scripts/check-config-conflicts.js
# åº”ä¸å†æŠ¥å‘Š TYPE_MISMATCH
```

---

### é—®é¢˜ Dï¼š`validateConfig()` çš„ `process.exit(1)` è®© try/catch æ— æ„ä¹‰

**å½“å‰ä»£ç **ï¼ˆ`app.js:32-42`ï¼‰ï¼š

```javascript
if (!isDevelopment()) {
  validateConfig()
} else {
  try {
    validateConfig()
  } catch (error) {
    console.warn('âš ï¸ [Development] é…ç½®æ ¡éªŒå¤±è´¥ï¼ˆå·²å¿½ç•¥ï¼‰:', error.message)
  }
}
```

**é—®é¢˜**ï¼š

- `validateConfig()` å†…éƒ¨è°ƒç”¨ `process.exit(1)`ï¼ˆä¸å¯æ•è·ï¼‰
- try/catch å®é™…æ‹¦ä¸ä½ exitï¼Œdevelopment ä¹Ÿä¼šç›´æ¥é€€å‡º

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ 1ï¼šæ”¹ä¸º throw Errorï¼ˆæ¨èï¼‰**

```javascript
// config/environment.jsï¼ˆä¼ªä»£ç ï¼‰
function validateConfig() {
  const missing = required.filter(key => !process.env[key])

  if (missing.length > 0) {
    // âœ… æ”¹ä¸º throwï¼ˆè€Œä¸æ˜¯ process.exitï¼‰
    throw new Error(`ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡: ${missing.join(', ')}`)
  }
}

// app.jsï¼ˆä¼ªä»£ç ï¼‰
if (!isDevelopment()) {
  ConfigValidator.validate(process.env.NODE_ENV, true) // failFast=trueï¼Œå†…éƒ¨ä¼š exit
} else {
  ConfigValidator.validate(process.env.NODE_ENV, false) // failFast=falseï¼Œä»…è­¦å‘Š
}
```

**æ–¹æ¡ˆ 2ï¼šç»Ÿä¸€ fail-fastï¼ˆæ›´æ¨èï¼‰**

```javascript
// app.jsï¼ˆä¼ªä»£ç ï¼‰
// âœ… æ‰€æœ‰ç¯å¢ƒç»Ÿä¸€ fail-fastï¼ˆç§»é™¤ try/catchï¼‰
ConfigValidator.validate(process.env.NODE_ENV, true)
```

**æ¨è**ï¼š**æ–¹æ¡ˆ 2**ï¼ˆæ‰€æœ‰ç¯å¢ƒç»Ÿä¸€ fail-fastï¼Œé¿å…"å¼€å‘èƒ½è·‘ã€ç”Ÿäº§ç‚¸"ï¼‰

---

## ğŸ“Š å®æ–½åçš„é¢„æœŸæ•ˆæœ

### é—®é¢˜è§£å†³å¯¹ç…§è¡¨

| åŸé—®é¢˜                                | ç»Ÿä¸€æ–¹æ¡ˆå                  | æ”¶ç›Š                      |
| ------------------------------------- | --------------------------- | ------------------------- |
| æ ¡éªŒæ¸…å•ä¸ç»Ÿä¸€                        | ç»Ÿä¸€ `CONFIG_SCHEMA`        | âœ… è„šæœ¬é€šè¿‡ = å¯åŠ¨é€šè¿‡    |
| å¿…éœ€é¡¹é›†åˆè¿‡å°‘                        | schema åŒ…å« 50+ é¡¹          | âœ… å…³é”®å¯†é’¥ç¼ºå¤±èƒ½åŠæ—¶å‘ç° |
| `process.exit(1)` è®© try/catch æ— æ„ä¹‰ | æ”¹ä¸º throw æˆ–ç»Ÿä¸€ fail-fast | âœ… è¡Œä¸ºå¯é¢„æµ‹             |
| å­—æ®µå‘½åä¸ç»Ÿä¸€                        | è‡ªåŠ¨ç”Ÿæˆ `config.example`   | âœ… æ¨¡æ¿ä¸ä»£ç ä¸€è‡´         |
| é…ç½®åˆ†å±‚è¾¹ç•Œä¸æ¸…                      | ä¸‰å±‚å•å‘ä¾èµ– + ç™½åå•       | âœ… èŒè´£æ˜ç¡®               |
| `SystemSettings` å¯èƒ½å­˜å±é™©é…ç½®       | ç™½åå• + é»‘åå• + å‡†å…¥è§„åˆ™  | âœ… é˜²æ­¢è¯¯æ“ä½œ             |
| é‡åå†²çª                              | å†²çªæ£€æµ‹ + æœ€ç»ˆè£å†³è§„åˆ™     | âœ… æ¶ˆé™¤å¤šé‡çœŸç›¸           |
| ç±»å‹ä¸ä¸€è‡´                            | ç™½åå•å¼ºåˆ¶ç±»å‹çº¦æŸ          | âœ… è¿è¡Œæ—¶ç±»å‹å®‰å…¨         |

---

## ğŸš¨ é«˜é£é™©é…ç½®ç«‹å³å¤„ç½®æ¸…å•

### âœ… CRITICAL çº§ï¼ˆå·²å†³ç­– 2025-12-30ï¼‰

- [x] **`budget_allocation_ratio`ï¼ˆé¢„ç®—åˆ†é…ç³»æ•° 0.24ï¼‰**
  - å½“å‰ï¼šDB å¯æ”¹
  - å†³ç­–ï¼š**ä¿ç•™ DBï¼Œå¼ºåŒ–çº¦æŸ**
  - è¡ŒåŠ¨ï¼š
    - âœ… è®¾ç½®èŒƒå›´é™åˆ¶ï¼ˆ0.1-0.5ï¼‰
    - âœ… å¯ç”¨åŒäººå®¡æ ¸æœºåˆ¶
    - âœ… å¼ºåˆ¶å®¡è®¡æ—¥å¿—
    - âœ… å˜æ›´é€šçŸ¥æŠ€æœ¯+è´¢åŠ¡å›¢é˜Ÿ
- [x] **`lottery_cost_points`ï¼ˆæŠ½å¥–æ¶ˆè€—ç§¯åˆ†ï¼‰**
  - å½“å‰ï¼šDB + Code é‡å
  - å†³ç­–ï¼š**ä¿ç•™ DBï¼Œåˆ é™¤ Code é…ç½®**
  - è¡ŒåŠ¨ï¼š
    - âœ… åˆ é™¤ `config/business.config.js` ä¸­çš„ `draw_pricing.single_draw`
    - âœ… è®¾ç½®èŒƒå›´é™åˆ¶ï¼ˆ50-500ï¼‰
    - âœ… å¯ç”¨å®¡è®¡æ—¥å¿—
    - âœ… å˜æ›´é€šçŸ¥æŠ€æœ¯å›¢é˜Ÿ

### âš ï¸ HIGH çº§ï¼ˆæœ¬å‘¨å¤„ç½®ï¼‰

- [ ] **`password_min_length`ï¼ˆå¯†ç æœ€å°é•¿åº¦ï¼‰**
  - å½“å‰ï¼šDB å¯æ”¹
  - é£é™©ï¼šå®‰å…¨å‚æ•°ï¼Œé™ä½åå½±å“è´¦æˆ·å®‰å…¨
  - è¡ŒåŠ¨ï¼šè®¾ä¸º readonly
- [ ] **`api_rate_limit`ï¼ˆAPI é™æµé˜ˆå€¼ï¼‰**
  - å½“å‰ï¼šDB å¯æ”¹
  - é£é™©ï¼šé£æ§å‚æ•°ï¼Œè°ƒé«˜åå¯èƒ½è¢«åˆ·
  - è¡ŒåŠ¨ï¼šè®¾ä¸º readonly æˆ–è¿ç§»åˆ°ä»£ç 

- [ ] **ç±»å‹ä¸ä¸€è‡´ï¼ˆ4 ä¸ªé…ç½®é¡¹ï¼‰**
  - å½“å‰ï¼šå£°æ˜ number/booleanï¼Œå®é™…å­˜ string
  - é£é™©ï¼šç±»å‹è½¬æ¢é”™è¯¯ã€æ ¡éªŒå¤±æ•ˆ
  - è¡ŒåŠ¨ï¼šä¿®å¤ `value_type` å­—æ®µ

---

## ğŸ“ ä¸ Devbox æ–¹æ¡ˆçš„ååŒå…³ç³»

### ä¸¤ä»½æ–‡æ¡£çš„èŒè´£åˆ†å·¥

| æ–¹é¢                    | Devbox æ–¹æ¡ˆ | æœ¬æ–¹æ¡ˆï¼ˆä¸‰å±‚åˆ†ç¦»ï¼‰ |
| ----------------------- | ----------- | ------------------ |
| **é…ç½®æºæ”¶æ•›**          | âœ… æ ¸å¿ƒèŒè´£ | ä¾èµ– Devbox æ–¹æ¡ˆ   |
| **dotenv ä¼˜å…ˆçº§**       | âœ… æ ¸å¿ƒèŒè´£ | ä¾èµ– Devbox æ–¹æ¡ˆ   |
| **PM2 è¿ç»´å…¥å£**        | âœ… æ ¸å¿ƒèŒè´£ | ä¾èµ– Devbox æ–¹æ¡ˆ   |
| **æ ¡éªŒæ¸…å•ç»Ÿä¸€**        | âš ï¸ æœªè¦†ç›–   | âœ… æœ¬æ–¹æ¡ˆæ ¸å¿ƒ      |
| **é…ç½®åˆ†å±‚è¾¹ç•Œ**        | âš ï¸ æœªè¦†ç›–   | âœ… æœ¬æ–¹æ¡ˆæ ¸å¿ƒ      |
| **SystemSettings æ²»ç†** | âš ï¸ æœªè¦†ç›–   | âœ… æœ¬æ–¹æ¡ˆæ ¸å¿ƒ      |
| **å­—æ®µå‘½åç»Ÿä¸€**        | âš ï¸ æœªè¦†ç›–   | âœ… æœ¬æ–¹æ¡ˆæ ¸å¿ƒ      |

### å®æ–½é¡ºåºå»ºè®®

**å…ˆæ‰§è¡Œ Devbox æ–¹æ¡ˆï¼ˆè¿è¡Œæ—¶é…ç½®æºæ”¶æ•›ï¼‰**ï¼š

1. æ¸…ç©º `ecosystem.config.js env`
2. ç»Ÿä¸€ dotenv åŠ è½½ç­–ç•¥
3. ç»Ÿä¸€ PM2 è¿ç»´å…¥å£

**å†æ‰§è¡Œæœ¬æ–¹æ¡ˆï¼ˆé…ç½®åˆ†å±‚ä¸æ ¡éªŒç»Ÿä¸€ï¼‰**ï¼š

1. å»ºç«‹ `CONFIG_SCHEMA`
2. ç»Ÿä¸€æ ¡éªŒå…¥å£
3. æ²»ç† `SystemSettings`

**ç†ç”±**ï¼š

- Devbox æ–¹æ¡ˆè§£å†³"é…ç½®ä»å“ªæ¥"ï¼ˆè¿è¡Œæ—¶ï¼‰
- æœ¬æ–¹æ¡ˆè§£å†³"é…ç½®æ€ä¹ˆåˆ†å±‚ã€æ€ä¹ˆæ ¡éªŒ"ï¼ˆè®¾è®¡æ—¶ï¼‰
- ä¸¤è€…äº’è¡¥ï¼Œç¼ºä¸€ä¸å¯

---

## ğŸ“ å›¢é˜Ÿåä½œè§„èŒƒ

### æ–°å¢é…ç½®çš„æ ‡å‡†æµç¨‹

**æ­¥éª¤ 1ï¼šç¡®å®šå½’å±å±‚**

- èµ°"é…ç½®å½’å±å†³ç­–æ ‘"ï¼ˆå¯†é’¥ â†’ Envï¼Œç»“ç®— â†’ Codeï¼Œè¿è¥ â†’ DBï¼‰

**æ­¥éª¤ 2ï¼šæ›´æ–° Schema**

- å¦‚æœæ˜¯ Envï¼šåœ¨ `CONFIG_SCHEMA` ä¸­æ³¨å†Œ
- å¦‚æœæ˜¯ DBï¼šåœ¨ `SYSTEM_SETTINGS_WHITELIST` ä¸­æ³¨å†Œ

**æ­¥éª¤ 3ï¼šæ›´æ–°ä»£ç **

- åœ¨ä»£ç ä¸­è¯»å–ï¼š`process.env.NEW_KEY` æˆ– `await getSystemSetting('category/new_key')`

**æ­¥éª¤ 4ï¼šæ›´æ–°æ¨¡æ¿**

- å¦‚æœæ˜¯ Envï¼šè¿è¡Œ `ConfigValidator.generateTemplate()` è‡ªåŠ¨æ›´æ–° `config.example`
- å¦‚æœæ˜¯ DBï¼šåœ¨åå°ç•Œé¢æ·»åŠ é…ç½®é¡¹

**æ­¥éª¤ 5ï¼šæ–‡æ¡£ä¸é€šçŸ¥**

- æ›´æ–°éƒ¨ç½²æ–‡æ¡£ï¼ˆæ–°ç¯å¢ƒéœ€è¦é…ç½®å“ªäº›ï¼‰
- é€šçŸ¥å›¢é˜Ÿæˆå‘˜ï¼ˆé…ç½®å˜æ›´ã€é‡å¯è¦æ±‚ï¼‰

---

### é…ç½®ä¿®æ”¹çš„æ ‡å‡†æµç¨‹

**Env Variables ä¿®æ”¹**ï¼š

```bash
# 1. ä¿®æ”¹ .env
vim .env

# 2. é‡å¯å¹¶åˆ·æ–°ç¯å¢ƒå˜é‡
npm run pm:reload-env

# 3. éªŒè¯ç”Ÿæ•ˆ
pm2 show restaurant-lottery-backend | grep NEW_KEY
```

**Code Config ä¿®æ”¹**ï¼š

```bash
# 1. ä¿®æ”¹ä»£ç é…ç½®æ–‡ä»¶
vim config/business.config.js

# 2. Code Review + æµ‹è¯•
git add config/business.config.js
# æäº¤ PRï¼Œèµ°å®¡æ‰¹æµç¨‹

# 3. å‘ç‰ˆéƒ¨ç½²
# åˆå¹¶åè‡ªåŠ¨éƒ¨ç½²æˆ–æ‰‹å·¥å‘ç‰ˆ
```

**DB SystemSettings ä¿®æ”¹**ï¼š

```bash
# 1. é€šè¿‡åå°ç•Œé¢ä¿®æ”¹ï¼ˆè‡ªåŠ¨æ ¡éªŒç™½åå•/ç±»å‹/èŒƒå›´ï¼‰
# æˆ–ç›´æ¥ SQLï¼ˆä¸æ¨èï¼‰

# 2. æ£€æŸ¥æ˜¯å¦éœ€è¦é‡å¯
# å¦‚æœ changeRequiresRestart=trueï¼Œæ‰§è¡Œï¼š
npm run pm:restart

# 3. éªŒè¯ç”Ÿæ•ˆ
curl http://localhost:3000/api/v4/admin/settings | jq '.data[] | select(.setting_key=="your_key")'
```

---

## ğŸ“‹ å®Œæ•´æ‰§è¡Œæ¸…å•ï¼ˆå¯æ‰“å°ï¼‰

### é˜¶æ®µ 1ï¼šå»ºç«‹ Schemaï¼ˆ1-2 å¤©ï¼‰

- [ ] åˆ›å»º `config/schema.js`ï¼ˆå®šä¹‰ 50+ é¡¹ç¯å¢ƒå˜é‡ schemaï¼‰
- [ ] åˆ›å»º `config/validator.js`ï¼ˆç»Ÿä¸€æ ¡éªŒå™¨ï¼‰
- [ ] åˆ›å»º `config/system-settings-whitelist.js`ï¼ˆDB é…ç½®ç™½åå•ï¼‰
- [ ] æ‰«æä»£ç æ‰€æœ‰ `process.env.*` å¼•ç”¨ï¼Œç¡®ä¿ schema å®Œæ•´
- [ ] éªŒè¯ï¼šschema åŒ…å«æ‰€æœ‰å®é™…ä½¿ç”¨çš„ key

### é˜¶æ®µ 2ï¼šç»Ÿä¸€æ ¡éªŒï¼ˆ1 å¤©ï¼‰

- [ ] ä¿®æ”¹ `app.js`ï¼šå¯åŠ¨æ ¡éªŒæ”¹ä¸º `ConfigValidator.validate()`
- [ ] ä¿®æ”¹ `config/environment.js`ï¼š`validateConfig()` æ”¹ä¸ºè°ƒç”¨ `ConfigValidator`
- [ ] ä¿®æ”¹ `scripts/check-environment.js`ï¼šæ”¹ä¸ºè°ƒç”¨ `ConfigValidator`
- [ ] ç§»é™¤ `app.js` çš„ try/catch å¿½ç•¥ï¼ˆæ‰€æœ‰ç¯å¢ƒ fail-fastï¼‰
- [ ] éªŒè¯ï¼šç¼ºå°‘ä»»ä½•å¿…éœ€é¡¹æ—¶ï¼Œæ‰€æœ‰ç¯å¢ƒéƒ½å¯åŠ¨å¤±è´¥

### é˜¶æ®µ 3ï¼šæ¨¡æ¿è‡ªåŠ¨ç”Ÿæˆï¼ˆ0.5 å¤©ï¼‰

- [ ] å®ç° `ConfigValidator.generateTemplate()`
- [ ] è‡ªåŠ¨ç”Ÿæˆ `config.example`
- [ ] äººå·¥å®¡æŸ¥ç”Ÿæˆçš„æ¨¡æ¿
- [ ] æ·»åŠ  CI æ£€æŸ¥ï¼ˆé˜²æ­¢æ‰‹å·¥ä¿®æ”¹æ¼‚ç§»ï¼‰
- [ ] éªŒè¯ï¼šæ¨¡æ¿å­—æ®µä¸ schema å®Œå…¨ä¸€è‡´

### é˜¶æ®µ 4ï¼šSystemSettings æ²»ç†ï¼ˆ2-3 å¤©ï¼‰

- [x] **ä¸šåŠ¡å†³ç­–ç¡®è®¤**ï¼š`lottery_cost_points` å’Œ `budget_allocation_ratio` ä¿ç•™åœ¨ DB
- [ ] ä¿®å¤ DB ç±»å‹ä¸ä¸€è‡´ï¼ˆ4 ä¸ªé…ç½®é¡¹ï¼‰
- [ ] é…ç½® `lottery_cost_points` å¼ºçº¦æŸï¼ˆèŒƒå›´ 50-500ï¼Œå®¡è®¡æ—¥å¿—ï¼‰
- [ ] é…ç½® `budget_allocation_ratio` å¼ºçº¦æŸï¼ˆèŒƒå›´ 0.1-0.5ï¼ŒåŒäººå®¡æ ¸ï¼‰
- [ ] åˆ é™¤ `config/business.config.js` ä¸­çš„ `draw_pricing.single_draw`
- [ ] è®¾ç½®å®‰å…¨å‚æ•°ä¸º readonlyï¼ˆ`password_min_length`ã€`api_rate_limit`ï¼‰
- [ ] åå°ä¿®æ”¹æ¥å£åŠ ç™½åå•æ ¡éªŒ + åŒäººå®¡æ ¸æœºåˆ¶
- [ ] å¢å¼ºå†²çªæ£€æµ‹è„šæœ¬ï¼ˆç²¾ç¡®åŒ¹é… + æœ€ç»ˆè£å†³è§„åˆ™ï¼‰
- [ ] éªŒè¯ï¼šåå°ä¿®æ”¹é…ç½®æ—¶å¼ºåˆ¶ç™½åå•æ ¡éªŒ

### é˜¶æ®µ 5ï¼šéªŒæ”¶ä¸æ–‡æ¡£ï¼ˆ0.5 å¤©ï¼‰

- [ ] è¿è¡Œå®Œæ•´æ ¡éªŒï¼š`npm run check:config`
- [ ] æµ‹è¯•é…ç½®ä¿®æ”¹æµç¨‹ï¼ˆEnv/Code/DB ä¸‰å±‚ï¼‰
- [ ] æ›´æ–°éƒ¨ç½²æ–‡æ¡£ä¸å›¢é˜ŸåŸ¹è®­
- [ ] è®°å½•é…ç½®å˜æ›´å†å²

---

## ğŸ¯ æ ¸å¿ƒä»·å€¼æ€»ç»“

### è¿™ä»½æ–¹æ¡ˆè§£å†³çš„é—®é¢˜ï¼ˆDevbox æ–¹æ¡ˆæœªè¦†ç›–çš„ï¼‰

- âœ… **æ ¡éªŒæ¸…å•ç»Ÿä¸€**ï¼š`CONFIG_SCHEMA` æ˜¯å”¯ä¸€çœŸç›¸æºï¼Œåº”ç”¨/è„šæœ¬/CI å…±ç”¨
- âœ… **é…ç½®åˆ†å±‚æ˜ç¡®**ï¼šEnv/Code/DB ä¸‰å±‚å•å‘ä¾èµ–ï¼ŒèŒè´£æ¸…æ™°
- âœ… **SystemSettings å¯æ§**ï¼šç™½åå• + é»‘åå• + å‡†å…¥è§„åˆ™ï¼Œé˜²æ­¢è¯¯æ“ä½œ
- âœ… **å­—æ®µå‘½åä¸€è‡´**ï¼šè‡ªåŠ¨ç”Ÿæˆ `config.example`ï¼Œæ¶ˆé™¤æ‰‹å·¥æ¼‚ç§»
- âœ… **ç±»å‹å®‰å…¨**ï¼šå¼ºåˆ¶ç±»å‹/èŒƒå›´çº¦æŸï¼Œé˜²æ­¢å¡«é”™å€¼
- âœ… **å†²çªå¯æ£€æµ‹**ï¼šç²¾ç¡®åŒ¹é… + æœ€ç»ˆè£å†³è§„åˆ™ï¼Œæ¶ˆé™¤å¤šé‡çœŸç›¸

### ä¸ Devbox æ–¹æ¡ˆçš„ååŒæ•ˆæœ

- **Devbox æ–¹æ¡ˆ**ï¼šè§£å†³"é…ç½®ä»å“ªæ¥"ï¼ˆè¿è¡Œæ—¶å•ä¸€çœŸç›¸æºï¼‰
- **æœ¬æ–¹æ¡ˆ**ï¼šè§£å†³"é…ç½®æ€ä¹ˆåˆ†å±‚ã€æ€ä¹ˆæ ¡éªŒã€æ€ä¹ˆé˜²é”™"ï¼ˆè®¾è®¡æ—¶è¾¹ç•Œä¸çº¦æŸï¼‰
- **ååŒä»·å€¼**ï¼šè¿è¡Œæ—¶ + è®¾è®¡æ—¶åŒé‡ä¿éšœï¼Œé…ç½®ç®¡ç†ä»"æ··ä¹±"åˆ°"å¯æ§"

---

## ğŸš€ å…·ä½“è½åœ°æ‰§è¡Œæ–¹æ¡ˆï¼ˆåŸºäºä¸šåŠ¡å†³ç­–çš„å¯æ‰§è¡Œç‰ˆæœ¬ï¼‰

### ç«‹å³æ‰§è¡Œï¼ˆP0 - æœ¬å‘¨å†…å®Œæˆï¼‰

#### 1. ä¿®å¤ `lottery_cost_points` é‡åå†²çª

**ç›®æ ‡**ï¼šåˆ é™¤ä»£ç é…ç½®ï¼Œç»Ÿä¸€ä½¿ç”¨ DB é…ç½®

```bash
# æ­¥éª¤ 1ï¼šä¿®æ”¹ config/business.config.js
vim config/business.config.js

# åˆ é™¤æˆ–æ³¨é‡Šæ‰ single_draw å®šä»·ï¼š
# draw_pricing: {
#   // single_draw: 100,  // âŒ å·²åˆ é™¤ï¼šæ”¹ä¸ºä» DB è¯»å–
#   multi_draw_3: 280,
#   ...
# }

# æ­¥éª¤ 2ï¼šä¿®æ”¹ä¸šåŠ¡é€»è¾‘ï¼ˆæ‰€æœ‰è¯»å–å•æŠ½ä»·æ ¼çš„åœ°æ–¹ï¼‰
# æœç´¢æ‰€æœ‰å¼•ç”¨ businessConfig.lottery.draw_pricing.single_draw çš„ä»£ç 
grep -r "draw_pricing.single_draw" services/ routes/

# æ”¹ä¸ºä» DB è¯»å–ï¼š
# const lotteryCost = await getSystemSetting('points/lottery_cost_points', 100)

# æ­¥éª¤ 3ï¼šç¡®ä¿ DB é…ç½®åœ¨åˆè§„èŒƒå›´å†…
NODE_ENV=production node -r dotenv/config - <<'NODE'
const models = require('./models')
async function main() {
  await models.sequelize.authenticate()
  const { SystemSettings } = models

  // æ£€æŸ¥å½“å‰å€¼
  const setting = await SystemSettings.findOne({
    where: { category: 'points', setting_key: 'lottery_cost_points' }
  })

  if (setting) {
    const value = Number(setting.setting_value)
    console.log('å½“å‰å€¼:', value)

    // ç¡®ä¿åœ¨èŒƒå›´å†… (50-500)
    if (value < 50 || value > 500) {
      console.warn('âš ï¸ å½“å‰å€¼è¶…å‡ºèŒƒå›´ï¼Œå»ºè®®è°ƒæ•´ä¸º 100')
    }
  } else {
    console.error('âŒ DB ä¸­ä¸å­˜åœ¨ lottery_cost_points é…ç½®')
  }

  await models.sequelize.close()
}
main()
NODE

# æ­¥éª¤ 4ï¼šéªŒè¯ä¿®æ”¹
npm run pm:restart
# æµ‹è¯•æŠ½å¥–åŠŸèƒ½æ˜¯å¦æ­£å¸¸
```

#### 2. å¼ºåŒ– `budget_allocation_ratio` çº¦æŸ

**ç›®æ ‡**ï¼šæ·»åŠ èŒƒå›´é™åˆ¶ã€åŒäººå®¡æ ¸ã€å®¡è®¡æ—¥å¿—

```sql
-- æ­¥éª¤ 1ï¼šç¡®ä¿å½“å‰å€¼åœ¨åˆè§„èŒƒå›´å†…
UPDATE system_settings
SET setting_value = CASE
  WHEN CAST(setting_value AS DECIMAL(10,2)) < 0.1 THEN '0.1'
  WHEN CAST(setting_value AS DECIMAL(10,2)) > 0.5 THEN '0.5'
  ELSE setting_value
END
WHERE category = 'points' AND setting_key = 'budget_allocation_ratio';

-- æ­¥éª¤ 2ï¼šç¡®ä¿ç±»å‹æ­£ç¡®
UPDATE system_settings
SET value_type = 'number'
WHERE category = 'points' AND setting_key = 'budget_allocation_ratio';

-- æ­¥éª¤ 3ï¼šä¿æŒå¯æ”¹ï¼ˆä¸è®¾ä¸º readonlyï¼‰
UPDATE system_settings
SET is_readonly = false
WHERE category = 'points' AND setting_key = 'budget_allocation_ratio';

-- éªŒè¯
SELECT category, setting_key, setting_value, value_type, is_readonly
FROM system_settings
WHERE setting_key IN ('budget_allocation_ratio', 'lottery_cost_points');
```

```javascript
// æ­¥éª¤ 4ï¼šä¿®æ”¹ services/AdminSystemService.js
// åœ¨ updateSystemSetting æ–¹æ³•ä¸­æ·»åŠ åŒäººå®¡æ ¸é€»è¾‘ï¼ˆå‚è€ƒæ–‡æ¡£ä¸­çš„å¢å¼ºç‰ˆå®ç°ï¼‰

// æ­¥éª¤ 5ï¼šåå°ç•Œé¢æ·»åŠ é¢„è­¦æç¤º
// ä¿®æ”¹å‰ç«¯ç®¡ç†ç•Œé¢ï¼Œä¿®æ”¹ budget_allocation_ratio æ—¶æ˜¾ç¤ºï¼š
// "âš ï¸ æ­¤å‚æ•°ç›´æ¥å½±å“å¹³å°é¢„ç®—åˆ†é…ï¼Œä¿®æ”¹å‰è¯·ç¡®è®¤è´¢åŠ¡å½±å“"
// å¹¶è¦æ±‚è¾“å…¥å®¡æ‰¹äºº ID å’Œå˜æ›´åŸå› 
```

#### 3. ä¿®å¤ç±»å‹ä¸ä¸€è‡´ï¼ˆ4 ä¸ªé…ç½®é¡¹ï¼‰

```sql
-- ç«‹å³æ‰§è¡Œ
UPDATE system_settings SET value_type = 'number'
WHERE setting_key IN ('initial_points', 'sign_in_points', 'max_login_attempts');

UPDATE system_settings SET value_type = 'boolean'
WHERE setting_key = 'sms_enabled';

-- éªŒè¯
SELECT setting_key, value_type, setting_value
FROM system_settings
WHERE setting_key IN ('initial_points', 'sign_in_points', 'max_login_attempts', 'sms_enabled');
```

#### 4. è®¾ç½®å®‰å…¨å‚æ•°ä¸º readonly

```sql
-- é˜²æ­¢è¿è¥è¯¯æ“ä½œä¿®æ”¹å®‰å…¨å‚æ•°
UPDATE system_settings SET is_readonly = true
WHERE setting_key IN ('password_min_length', 'api_rate_limit');

-- éªŒè¯
SELECT setting_key, is_readonly
FROM system_settings
WHERE setting_key IN ('password_min_length', 'api_rate_limit');
```

---

### çŸ­æœŸæ‰§è¡Œï¼ˆP1 - 2å‘¨å†…å®Œæˆï¼‰

#### 5. åˆ›å»º `config/schema.js`ï¼ˆç¯å¢ƒå˜é‡ Schemaï¼‰

```bash
# åˆ›å»ºæ–‡ä»¶
touch config/schema.js

# å‚è€ƒæ–‡æ¡£ç¬¬ 249-375 è¡Œçš„ CONFIG_SCHEMA ç»“æ„
# å®šä¹‰æ‰€æœ‰ç¯å¢ƒå˜é‡çš„ç±»å‹ã€å¿…éœ€æ€§ã€èŒƒå›´çº¦æŸ

# å…³é”®å­—æ®µï¼ˆå¿…é¡»å®šä¹‰ï¼‰ï¼š
# - NODE_ENV, PORT, TZ
# - DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASSWORD
# - REDIS_URL
# - JWT_SECRET, JWT_REFRESH_SECRET, ENCRYPTION_KEY
# - SEALOS_ENDPOINT, SEALOS_BUCKET, SEALOS_ACCESS_KEY, SEALOS_SECRET_KEY, SEALOS_REGION
# - WX_APPID, WX_SECRET
# - ALLOWED_ORIGINS
```

#### 6. åˆ›å»º `config/validator.js`ï¼ˆç»Ÿä¸€æ ¡éªŒå™¨ï¼‰

```bash
# åˆ›å»ºæ–‡ä»¶
touch config/validator.js

# å‚è€ƒæ–‡æ¡£ç¬¬ 379-585 è¡Œçš„ ConfigValidator å®ç°
# æ ¸å¿ƒæ–¹æ³•ï¼š
# - validate(targetEnv, failFast): æ ¡éªŒç¯å¢ƒå˜é‡
# - generateTemplate(): è‡ªåŠ¨ç”Ÿæˆ config.example
```

#### 7. åˆ›å»º `config/system-settings-whitelist.js`ï¼ˆDB é…ç½®ç™½åå•ï¼‰

```bash
# åˆ›å»ºæ–‡ä»¶
touch config/system-settings-whitelist.js

# å‚è€ƒæ–‡æ¡£ç¬¬ 729-909 è¡Œçš„ SYSTEM_SETTINGS_WHITELIST ç»“æ„
# å…³é”®é…ç½®ï¼ˆå¿…é¡»å®šä¹‰ï¼‰ï¼š
# - lottery_cost_points: èŒƒå›´ 50-500ï¼ŒauditRequired=true
# - budget_allocation_ratio: èŒƒå›´ 0.1-0.5ï¼ŒapprovalRequired=true
# - å…¶ä»– 16 ä¸ªç°æœ‰é…ç½®é¡¹
```

#### 8. ç»Ÿä¸€æ ¡éªŒå…¥å£

```bash
# ä¿®æ”¹ app.js
# å°† validateConfig() æ”¹ä¸ºè°ƒç”¨ ConfigValidator.validate()

# ä¿®æ”¹ config/environment.js
# å°† validateConfig() æ”¹ä¸ºè°ƒç”¨ ConfigValidator.validate()

# ä¿®æ”¹ scripts/check-environment.js
# ç§»é™¤ dotenv.config()ï¼Œæ”¹ä¸ºè°ƒç”¨ ConfigValidator.validate()
```

---

### ä¸­æœŸæ‰§è¡Œï¼ˆP2 - 1ä¸ªæœˆå†…å®Œæˆï¼‰

#### 9. è‡ªåŠ¨ç”Ÿæˆ `config.example`

```bash
# ä½¿ç”¨ ConfigValidator.generateTemplate() è‡ªåŠ¨ç”Ÿæˆ
node -e "
const { ConfigValidator } = require('./config/validator')
const template = ConfigValidator.generateTemplate()
require('fs').writeFileSync('config.example', template)
console.log('âœ… config.example å·²è‡ªåŠ¨ç”Ÿæˆ')
"

# äººå·¥å®¡æŸ¥ç”Ÿæˆçš„æ¨¡æ¿
vim config.example

# æ·»åŠ  CI æ£€æŸ¥ï¼ˆé˜²æ­¢æ‰‹å·¥ä¿®æ”¹æ¼‚ç§»ï¼‰
# åœ¨ package.json æ·»åŠ ï¼š
# "validate:config-template": "node scripts/validate-config-template.js"
```

#### 10. å¢å¼ºå†²çªæ£€æµ‹è„šæœ¬

```bash
# ä¿®æ”¹ scripts/check-config-conflicts.js
# å‚è€ƒæ–‡æ¡£ç¬¬ 1005-1096 è¡Œçš„ EnhancedConflictDetector å®ç°

# æ–°å¢æ£€æŸ¥é¡¹ï¼š
# - DB é…ç½®æ˜¯å¦åœ¨ç™½åå•å†…
# - æ˜¯å¦ä¸ä»£ç é…ç½®é‡åï¼ˆç²¾ç¡®åŒ¹é…ï¼‰
# - ç±»å‹æ˜¯å¦ä¸€è‡´
# - æ˜¯å¦å±äºç¦æ­¢ç±»é…ç½®

# å®šæœŸæ‰§è¡Œ
npm run check:config-conflicts
```

---

## ğŸ“‹ éªŒæ”¶æ ‡å‡†ï¼ˆå®Œæ•´æ¸…å•ï¼‰

### ç«‹å³æ‰§è¡Œï¼ˆP0ï¼‰éªŒæ”¶

- [x] **ä¸šåŠ¡å†³ç­–å·²ç¡®è®¤**ï¼š`lottery_cost_points` å’Œ `budget_allocation_ratio` ä¿ç•™åœ¨ DB
- [ ] `lottery_cost_points`ï¼š
  - [ ] ä»£ç é…ç½®å·²åˆ é™¤ï¼ˆ`config/business.config.js` ä¸­æ—  `single_draw`ï¼‰
  - [ ] DB é…ç½®åœ¨èŒƒå›´å†…ï¼ˆ50-500ï¼‰
  - [ ] ä¸šåŠ¡é€»è¾‘å·²æ”¹ä¸ºä» DB è¯»å–
  - [ ] æŠ½å¥–åŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] `budget_allocation_ratio`ï¼š
  - [ ] DB é…ç½®åœ¨èŒƒå›´å†…ï¼ˆ0.1-0.5ï¼‰
  - [ ] ç±»å‹å·²ä¿®å¤ä¸º `number`
  - [ ] ä¿æŒå¯æ”¹ï¼ˆ`is_readonly = false`ï¼‰
  - [ ] åå°ä¿®æ”¹ç•Œé¢æœ‰é¢„è­¦æç¤º
- [ ] ç±»å‹ä¸ä¸€è‡´å·²ä¿®å¤ï¼ˆ4 ä¸ªé…ç½®é¡¹ï¼‰
- [ ] å®‰å…¨å‚æ•°å·²è®¾ä¸º readonlyï¼ˆ2 ä¸ªé…ç½®é¡¹ï¼‰

### çŸ­æœŸæ‰§è¡Œï¼ˆP1ï¼‰éªŒæ”¶

- [ ] `config/schema.js` å·²åˆ›å»ºï¼ŒåŒ…å« 50+ é¡¹ç¯å¢ƒå˜é‡å®šä¹‰
- [ ] `config/validator.js` å·²åˆ›å»ºï¼Œå®ç°ç»Ÿä¸€æ ¡éªŒé€»è¾‘
- [ ] `config/system-settings-whitelist.js` å·²åˆ›å»ºï¼ŒåŒ…å« 16+ é¡¹ DB é…ç½®å®šä¹‰
- [ ] åº”ç”¨å¯åŠ¨ã€è„šæœ¬æ£€æŸ¥ã€CI æ£€æŸ¥ä½¿ç”¨åŒä¸€ä»½æ ¡éªŒé€»è¾‘
- [ ] ç¼ºå°‘ä»»ä½•å¿…éœ€é¡¹æ—¶ï¼Œæ‰€æœ‰ç¯å¢ƒéƒ½ fail-fast

### ä¸­æœŸæ‰§è¡Œï¼ˆP2ï¼‰éªŒæ”¶

- [ ] `config.example` è‡ªåŠ¨ç”Ÿæˆï¼Œå­—æ®µä¸ schema å®Œå…¨ä¸€è‡´
- [ ] CI æ£€æŸ¥èƒ½æ‹¦æˆªæ‰‹å·¥ä¿®æ”¹å¯¼è‡´çš„æ¼‚ç§»
- [ ] å†²çªæ£€æµ‹è„šæœ¬å¢å¼ºï¼Œèƒ½ç²¾ç¡®åŒ¹é…å¹¶æä¾›è£å†³å»ºè®®
- [ ] åå°ä¿®æ”¹é…ç½®æ—¶å¼ºåˆ¶ç™½åå•æ ¡éªŒ
- [ ] åŒäººå®¡æ ¸æœºåˆ¶å·²å®ç°ï¼ˆé’ˆå¯¹ CRITICAL çº§å‚æ•°ï¼‰

---

## ğŸ¯ æ ¸å¿ƒä»·å€¼æ€»ç»“ï¼ˆåŸºäºä¸šåŠ¡å†³ç­–çš„æœ€ç»ˆç‰ˆæœ¬ï¼‰

### ä¸šåŠ¡å†³ç­–ç¡®è®¤ï¼ˆ2025-12-30ï¼‰

- âœ… **`lottery_cost_points` ä¿ç•™åœ¨ DB**ï¼šè¿è¥å¯è°ƒï¼Œç”¨äºæ´»åŠ¨å®šä»·ï¼ˆèŒƒå›´ 50-500ï¼‰
- âœ… **`budget_allocation_ratio` ä¿ç•™åœ¨ DB**ï¼šè¿è¥å¯è°ƒï¼Œç”¨äºåŠ¨æ€é¢„ç®—ç­–ç•¥ï¼ˆèŒƒå›´ 0.1-0.5ï¼ŒåŒäººå®¡æ ¸ï¼‰

### æ²»ç†åŸåˆ™

- âœ… **è¿è¥å¯è°ƒ â‰  éšæ„å¯æ”¹**ï¼šå¼ºçº¦æŸï¼ˆèŒƒå›´é™åˆ¶ï¼‰+ å®¡è®¡æ—¥å¿— + å˜æ›´å®¡æ‰¹
- âœ… **ç»“ç®—å…³é”®å‚æ•°è™½åœ¨ DBï¼Œä½†éœ€å¼ºåŒ–ç›‘æ§**ï¼šåŒäººå®¡æ ¸ + é¢„è­¦ç¡®è®¤ + å˜æ›´é€šçŸ¥
- âœ… **ä»£ç é…ç½®ä½œä¸ºå…œåº•å€¼**ï¼šDB é…ç½®ä½œä¸ºè¿è¥è¦†ç›–å€¼ï¼ˆä¼˜å…ˆçº§ï¼šDB > Codeï¼‰

### ä¸ Devbox æ–¹æ¡ˆçš„ååŒ

- **Devbox æ–¹æ¡ˆ**ï¼šè§£å†³"é…ç½®ä»å“ªæ¥"ï¼ˆè¿è¡Œæ—¶å•ä¸€çœŸç›¸æº `.env`ï¼‰
- **æœ¬æ–¹æ¡ˆ**ï¼šè§£å†³"é…ç½®æ€ä¹ˆåˆ†å±‚ã€æ€ä¹ˆæ ¡éªŒã€æ€ä¹ˆé˜²é”™"ï¼ˆè®¾è®¡æ—¶è¾¹ç•Œä¸çº¦æŸï¼‰
- **ååŒä»·å€¼**ï¼šè¿è¡Œæ—¶ + è®¾è®¡æ—¶åŒé‡ä¿éšœï¼Œé…ç½®ç®¡ç†ä»"æ··ä¹±"åˆ°"å¯æ§"

---

**æ–‡æ¡£ç»“æŸ**
