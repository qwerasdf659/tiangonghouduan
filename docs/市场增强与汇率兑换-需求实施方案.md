# 市场增强与汇率兑换 — 需求实施方案

> 编制日期：2026-02-23
> 基于代码版本：当前 main 分支工作区
> 数据来源：真实数据库 restaurant_points_dev（Node.js Sequelize 直连验证）
> 数据验证时间：2026-02-23（通过 .env 配置连接 Sealos MySQL 实例逐表逐字段核对）

---

## 一、行业方案对比分析

### 1.1 六类企业的虚拟物品交易设计对比

| 维度 | 大厂（腾讯/阿里/美团） | 游戏公司（Steam/网易/米哈游） | 活动策划公司（得物/有赞） | 小众二手平台（闲鱼/Depop） | 小公司/创业团队 | 本项目适用性 |
|---|---|---|---|---|---|---|
| **交易模型** | 中心化 B2C 积分商城 + 固定汇率 | C2C 挂牌 + 订单簿（buy order + sell listing） | 模板化兑换 + 抽奖合成 | 纯 C2C 自由定价 | 固定汇率 + 简单 C2C | C2C 挂牌 + 固定汇率兑换 |
| **定价机制** | 平台定价，用户无议价空间 | 双轨制：commodity 自动撮合 / non-commodity 指定挂牌 | 平台统一定价 | 卖家自由定价 | 固定汇率 | 卖家自由定价 + 固定汇率兑换 |
| **结算模型** | 单一积分扣减 | 平台币（Steam Wallet）统一结算 | 虚拟货币/积分 | 法币支付 | 内部货币 | DIAMOND 统一结算（已实现） |
| **记账体系** | 单式记账（余额增减） | 双录记账（wallet debit/credit） | 单式记账 | 支付网关托管 | 简单余额 | **双录记账（已实现，行业领先）** |
| **汇率管理** | 固定汇率表（运营配置） | 市场驱动汇率（供需决定） | 无汇率概念 | 无（法币直接交易） | 固定汇率 | 固定汇率为主，市场数据辅助 |
| **手续费** | 无（B2C 利润内含） | 分档费率（Steam 15% / CS2 Buff 2.5%） | 无或固定比例 | 平台抽佣 5-15% | 低费率吸引用户 | 5% 基础费率（已实现，可配置） |
| **技术复杂度** | 极高（微服务/分库分表/MQ） | 高（订单簿引擎/实时撮合） | 中（模板驱动/配置化） | 中（支付集成） | 低-中 | **中（已有成熟基础设施）** |
| **长期维护成本** | 极高（团队 50+） | 高（专职经济团队） | 中（规则配置为主） | 中 | 低 | **低（规则驱动 + 配置化）** |

### 1.2 五种核心架构模式（含本项目实际状态）

| 模式 | 说明 | 本项目状态 | 本次是否实施 |
|---|---|---|---|
| **A. 订单簿撮合** | 买卖双方挂单，系统自动撮合（Steam/交易所） | ❌ 没做 | **不做** — 67 用户、20 笔成交，流动性远不足 |
| **B. 固定价挂牌 C2C** | 卖家标价，买家按标价购买（Buff/闲鱼） | ✅ **在用** — 21 条 item 在售 + 2 条 fungible_asset 在售，20 笔已完成订单 | **增强** — 补充价格发现和市场数据 |
| **C. 固定汇率兑换** | 平台设定汇率，用户按比例兑换（腾讯积分/美团） | ✅ **代码已有** — AssetConversionService + 452 条 material_convert 流水，但仅 1 条规则且已禁用 | **增强** — 新建 exchange_rates 表，补齐限额/时间窗/多币对规则 |
| **D. P2P 点对点报价** | 用户之间"我拿 X 换你的 Y"（网游面对面交易） | ❌ 没做 | **不做** — 用户之间无聊天通道、无好友系统、无法互相发现，缺乏前置条件 |
| **E. 拍卖竞价** | 运营上架商品，用户竞价，价高者得（eBay/得物） | ✅ **代码完整** — BidService + bid_products/bid_records 表，但 0 条数据未启用 | **不做** — 代码就绪，等运营配商品即可启用，无需开发 |
| **F. B2C 固定价兑换** | 运营上架商品，用户按标价购买，先到先得（积分商城） | ✅ **代码完整** — exchange/CoreService + exchange_items/exchange_records 表，1983 条 exchange_debit 流水 | **不做** — 服务已完整运行 |

### 1.3 最适合本项目的方案：增强 B + 增强 C

**不做 A 和 D 的原因**：

| 排除项 | 原因 |
|---|---|
| A（订单簿） | 技术复杂度极高，67 用户流动性不足以支撑 |
| D（P2P 报价） | 本项目聊天系统是"用户↔客服"，不是"用户↔用户"。用户之间无法互相发现、无法沟通、不知道对方 ID。等未来有好友系统或用户间聊天再考虑 |

**本次方案组合**：
1. **增强交易市场挂牌交易**（模式 B，已实现）→ 补充价格发现 + 市场数据分析
2. **增强固定汇率兑换**（模式 C，代码已有）→ 新建 exchange_rates 表，补齐多币对规则和限额

---

## 二、项目现状摘要（基于真实代码和数据库 — 逐字段核对）

### 2.1 技术栈

| 层级 | 后端 | Web 管理后台 | 微信小程序 |
|---|---|---|---|
| 运行时 | Node.js 20+ / Express 4.18 | Vite + Alpine.js 3.x | 微信原生框架（独立仓库） |
| ORM/状态 | Sequelize 6.x（MySQL） | — | — |
| 数据库 | MySQL 8.x（Sealos 托管，dbconn.sealosbja.site:42569） | — | — |
| 缓存 | Redis（ioredis 5.x） | — | — |
| UI 框架 | — | Tailwind CSS 3.x | — |
| 图表 | — | ECharts 6.x | — |
| 实时通信 | Socket.IO 4.8 | Socket.IO Client 4.8 | — |
| 路由版本 | `/api/v4/*`（Express Router） | 调用后端 API（统一 `API_PREFIX = /api/v4`） | 调用后端 API |
| 认证 | JWT + RBAC（requireRoleLevel） | JWT Bearer Token | JWT Bearer Token |
| 响应格式 | `ApiResponse` 标准中间件（res.apiSuccess / res.apiError） | 统一解析 `{success, code, message, data, timestamp, request_id}` | 统一解析同上 |
| 事务管理 | `requireTransaction` / `assertAndGetTransaction` | — | — |
| 幂等控制 | `idempotency_key` UNIQUE 约束 | — | — |

### 2.2 核心资产体系（后端已实现，前端适配此结构）

**统一账本架构**：`accounts` → `account_asset_balances` → `asset_transactions`

| 层级 | 表 | 关键字段（数据库真实字段名） |
|---|---|---|
| 账户 | `accounts` | account_id (BIGINT PK), account_type (ENUM user/system), user_id (INT UNI), system_code (VARCHAR UNI) |
| 余额 | `account_asset_balances` | account_id + asset_code 联合，available_amount + frozen_amount |
| 流水 | `asset_transactions` | asset_transaction_id, account_id, counterpart_account_id, asset_code, **delta_amount** (BIGINT), balance_before, balance_after, frozen_amount_change, business_type, idempotency_key (UNI), meta (JSON) |

**系统账户（数据库实际数据 — 6 个）**：

| account_id | system_code | 用途 | 余额数据 |
|---|---|---|---|
| 1 | SYSTEM_PLATFORM_FEE | 平台手续费收入 | DIAMOND available: 1,922 |
| 2 | SYSTEM_MINT | 系统发放来源 | POINTS available: 73,722,994 |
| 3 | SYSTEM_BURN | 资产销毁目标 | — |
| 4 | SYSTEM_ESCROW | 托管/争议临时账户 | — |
| 12 | SYSTEM_RESERVE | 系统储备 | — |
| 15 | SYSTEM_CAMPAIGN_POOL | 活动奖池 | — |
| **需新增** | **SYSTEM_EXCHANGE** | **汇率兑换对手方账户** | **本次新增** |

**当前活跃资产（数据库真实数据 — `material_asset_types` 表，字段名已校正）**：

| asset_code | display_name | group_code | form | tier | is_tradable | budget_value_points | 用户持有账户数 | 用户总可用 | 用户总冻结 |
|---|---|---|---|---|---|---|---|---|---|
| DIAMOND | 钻石 | currency | currency | 10 | 1 | 100 | 22 | 633,805 | 45,100 |
| POINTS | 普通积分 | points | crystal | 0 | 0 | 1 | 7 | 213,260 | 28,420 |
| red_shard | 红水晶碎片 | red | shard | 1 | 1 | 10 | 7 | 215,859 | 7,995 |
| orange_shard | 橙水晶碎片 | orange | shard | 1 | 1 | 10 | 4 | 2,000 | 0 |
| red_crystal | 红水晶 | red | crystal | 2 | 1 | 50 | 4 | 800 | 0 |
| blue_shard | 蓝水晶碎片 | blue | shard | 1 | 1 | 80 | 0 | 0 | 0 |
| green_shard | 绿水晶碎片 | green | shard | 1 | 1 | 40 | 0 | 0 | 0 |
| yellow_shard | 黄水晶碎片 | yellow | shard | 1 | 1 | 20 | 0 | 0 | 0 |
| purple_shard | 紫水晶碎片 | purple | shard | 1 | 1 | 160 | 0 | 0 | 0 |
| 各色水晶 | 蓝/绿/橙/紫/黄水晶 | 各色 | crystal | 2 | 1 | 100-1600 | 0 | 0 | 0 |
| BUDGET_POINTS | 预算积分 | points | crystal | 0 | 0 | 1 | 1 | 5,217 | 0 |

> **数据库字段名校正**：文档旧版使用 `asset_group` / `is_tradeable`，数据库真实字段为 `group_code` / `is_tradable`（注意拼写差异）。前端和后端代码均需使用真实字段名。

### 2.3 现有交易市场（数据库真实数据）

**交易市场挂牌交易**（`market_listings` + `trade_orders`）：

| 维度 | 数值 |
|---|---|
| 完成订单 | 20 笔（总额 5,900 DIAMOND） |
| 已创建（未完成） | 2 笔（总额 2,100 DIAMOND） |
| 取消订单 | 114 笔（总额 25,650 DIAMOND） |
| 在售挂牌（item） | 21 条（全部 price_asset_code=DIAMOND, price_amount=100） |
| 在售挂牌（fungible_asset） | 2 条（offer_asset_code=DIAMOND） |
| 已售出（item） | 5 条 |
| 已售出（fungible_asset） | 14 条 |
| 已撤回 | 257 条（item 7 + fungible_asset 250） |
| 结算币种白名单 | DIAMOND, red_shard（system_settings 配置） |
| 手续费率 | 5%（DIAMOND 和 red_shard 统一，system_settings 配置） |

**B2C 兑换市场**：`exchange_items` 0 条商品，但 `exchange_debit` 流水 1,983 条（服务已运行）

**材料转换**：1 条规则 red_shard → DIAMOND = 1:20（**已禁用**），`material_convert_*` 流水 452 条

**已注册的 business_type**（asset_transactions 中实际存在的 60+ 种，关键类别）：
- 市场交易类：`order_freeze_buyer`、`order_settle_*`、`listing_*`、`market_listing_*`
- 材料转换类：`material_convert_debit/credit` + `*_counterpart`
- 兑换类：`exchange_debit` + `exchange_debit_counterpart`
- 管理类：`admin_adjustment`、`admin_data_fix`
- 抽奖类：`lottery_*`
- 消费类：`consumption_*`

### 2.4 现有服务层架构（后端权威，前端适配）

```
services/
├── asset/
│   ├── BalanceService.js      ← 余额核心（changeBalance / freeze / unfreeze / settleFromFrozen）
│   │                            参数: {user_id, system_code, asset_code, delta_amount, business_type, counterpart_*, idempotency_key, meta}
│   ├── ItemService.js         ← 三表模型物品管理
│   ├── ItemLifecycleService.js
│   ├── PortfolioQueryService.js
│   └── QueryService.js
├── market/
│   └── QueryService.js        ← 市场挂牌只读查询（有 Redis 缓存，BusinessCacheHelper.getMarketListings）
├── market-listing/
│   ├── CoreService.js         ← 挂牌/购买/撤回核心逻辑
│   ├── QueryService.js        ← 挂牌查询
│   └── AdminService.js
├── exchange/
│   ├── CoreService.js         ← B2C兑换核心（exchangeItem方法，需idempotency_key）
│   ├── QueryService.js        ← 兑换查询
│   ├── BidService.js          ← 竞价服务
│   └── AdminService.js
├── FeeCalculator.js           ← 手续费计算（DIAMOND分档/其他单一费率，calculateFeeByAsset(asset_code, itemValue, sellingPrice)）
├── AssetConversionService.js  ← 材料转换服务（convertMaterial: 规则驱动 + 三方记账 + 幂等 + assertAndGetTransaction）
├── TradeOrderService.js       ← 交易订单服务（创建/取消/完成/多币种）
├── ChatWebSocketService.js    ← WebSocket 实时推送（sendToUser方法可复用）
└── IdempotencyService.js      ← 幂等性控制
```

### 2.5 现有路由架构（后端权威）

```
app.js 挂载路径：
├── /api/v4/auth          → routes/v4/auth/
├── /api/v4/console       → routes/v4/console/          ← 管理后台所有路由
│   ├── /marketplace      → routes/v4/console/marketplace.js（listing-stats, listings CRUD, trade_orders, tradable-assets等）
│   ├── /material         → routes/v4/console/material.js（conversion-rules CRUD, asset-types CRUD）
│   └── ...
├── /api/v4/market        → routes/v4/market/            ← 用户端交易市场
│   ├── /listings         → listings.js（GET /listings, /facets, /settlement-currencies, /my-listings, /listing-status）
│   ├── /list             → sell.js（POST /list, /fungible-assets/list）
│   ├── /buy              → buy.js（POST /listings/:id/purchase）
│   ├── /manage           → manage.js（POST /listings/:id/withdraw）
│   └── /escrow           → escrow.js（担保码）
├── /api/v4/shop          → routes/v4/shop/
│   ├── /exchange         → exchange.js（POST /）, items.js（GET /items）, orders.js（GET /orders）
│   └── /assets/convert   → convert.js（材料转换用户端）
├── /api/v4/assets        → routes/v4/assets/
│   ├── /balance          → balance.js
│   ├── /conversion-rules → conversion-rules.js（GET /conversion-rules 用户端查询）
│   └── /transactions     → transactions.js
├── /api/v4/backpack      → routes/v4/backpack/（含 bid.js, exchange.js）
├── /api/v4/lottery       → routes/v4/lottery/
├── /api/v4/system        → routes/v4/system/
└── /api/v4/user          → routes/v4/user/
```

### 2.6 Web 管理后台前端架构

```
admin/src/
├── api/
│   ├── base.js              ← 统一请求封装（API_PREFIX=/api/v4, request(), buildURL()）
│   ├── market/
│   │   ├── index.js         ← 聚合导出 MarketAPI/MARKET_ENDPOINTS
│   │   ├── trade.js         ← TRADE_ENDPOINTS（交易市场/挂牌/孤儿冻结/业务记录）
│   │   ├── exchange.js      ← EXCHANGE_ENDPOINTS（B2C兑换商品）
│   │   └── bid.js           ← BID_ENDPOINTS（竞价管理）
│   ├── asset.js             ← ASSET_ENDPOINTS
│   └── system/admin.js      ← SYSTEM_ADMIN_ENDPOINTS
├── modules/
│   ├── market/
│   │   ├── pages/trade-management.js    ← 交易市场管理（Alpine.js Mixin v3.0）
│   │   ├── pages/exchange-market.js     ← B2C兑换市场管理
│   │   ├── pages/bid-management.js      ← 竞价管理
│   │   └── composables/exchange-*.js    ← 兑换商品/订单/统计 composable
│   ├── asset/
│   │   ├── pages/material-conversion.js ← 材料转换管理
│   │   └── pages/asset-management.js    ← 资产管理
│   └── system/
│       └── composables/exchange-page-config.js
└── alpine/index.js          ← Alpine.js + createPageMixin 基础框架
```

**Web 前端技术模式**：Alpine.js 3.x composable 模式 + `document.addEventListener('alpine:init', ...)` + `createPageMixin` 页面混入 + 统一 `request()`/`buildURL()` API 调用。

### 2.7 system_settings 市场配置（数据库真实数据，20 条）

| setting_key | setting_value | 说明 |
|---|---|---|
| allowed_listing_assets | ["DIAMOND","red_shard"] | 挂牌允许的定价币种 |
| allowed_settlement_assets | ["DIAMOND","red_shard"] | 结算币种白名单 |
| fee_rate_DIAMOND | 0.05 | DIAMOND 5% 手续费 |
| fee_rate_red_shard | 0.05 | red_shard 5% 手续费 |
| fee_min_DIAMOND | 1 | DIAMOND 最低手续费 |
| fee_min_red_shard | 1 | red_shard 最低手续费 |
| max_active_listings | 10 | 最多同时上架数 |
| listing_expiry_days | 3 | 挂牌过期天数 |
| daily_max_listings_DIAMOND | 20 | 日挂单次数上限 |
| daily_max_trades_DIAMOND | 10 | 日成交次数上限 |
| daily_max_amount_DIAMOND | 100000 | 日成交额上限 |
| monitor_price_low_threshold | 0.1 | 价格下限阈值 |
| monitor_price_high_threshold | 3.0 | 价格上限阈值 |
| monitor_long_listing_days | 7 | 超长挂牌监控天数 |
| monitor_alert_enabled | true | 监控告警开关 |

---

## 三、可复用基础设施分析（后端已有能力）

### 3.1 可直接复用（零改动）

| 基础设施 | 位置 | 三个需求中的复用场景 |
|---|---|---|
| BalanceService.changeBalance | services/asset/BalanceService.js | 汇率兑换扣减/入账（参数: user_id, asset_code, delta_amount, business_type, counterpart_*, idempotency_key） |
| AssetConversionService 架构模式 | services/AssetConversionService.js | 汇率兑换参考其"规则驱动 + 三方记账 + assertAndGetTransaction + 幂等"模式 |
| BusinessCacheHelper | utils/BusinessCacheHelper.js | 价格缓存（get/set/del + TTL jitter + delByPattern），已有 getMarketListings/setMarketListings 可参考 |
| IdempotencyService | services/IdempotencyService.js | 兑换幂等 |
| requireTransaction / assertAndGetTransaction | utils/transactionHelpers.js | 所有写操作事务保证 |
| 双录记账流水 | AssetTransaction 模型 | 所有资产变动走 BalanceService 自动产生双录流水 |
| ApiResponse 中间件 | utils/ApiResponse.js | res.apiSuccess / res.apiError 标准响应 |
| FeeCalculator | services/FeeCalculator.js | calculateFeeByAsset(asset_code, itemValue, sellingPrice) 手续费计算 |
| ChatWebSocketService.sendToUser | services/ChatWebSocketService.js | 实时通知（可选） |

### 3.2 可扩展复用（少量改动）

| 基础设施 | 扩展点 | 改动量 |
|---|---|---|
| BusinessCacheHelper | 新增 getExchangeRate/setExchangeRate/invalidateExchangeRate 方法对 + 新增 getPriceTrend/setPriceTrend 方法对 | 新增 ~60 行 |
| system_settings marketplace 类 | 新增汇率/兑换相关配置项（category='exchange_rate'） | 新增配置行 |
| MarketListing + TradeOrder 模型 | 价格发现直接聚合这两张表 JOIN 查询 | 零改动，纯查询 |
| FeeCalculator | 汇率兑换手续费可直接复用 calculateFeeByAsset | 零改动 |

### 3.3 需新增（不可复用）

| 新增项 | 类型 | 说明 | 归属端 |
|---|---|---|---|
| exchange_rates 表 | 数据库表 | 固定汇率配置（DB 中不存在） | **后端** |
| ExchangeRate 模型 | Sequelize Model | 对应 exchange_rates 表 | **后端** |
| SYSTEM_EXCHANGE 系统账户 | 数据行 | accounts 表新增一行（account_type='system', system_code='SYSTEM_EXCHANGE'） | **后端** |
| PriceDiscoveryService | 服务 | 价格聚合计算（trade_orders JOIN market_listings） | **后端** |
| ExchangeRateService | 服务 | 汇率兑换核心逻辑（参考 AssetConversionService 模式） | **后端** |
| MarketAnalyticsService | 服务 | 市场数据分析（卖家定价建议） | **后端** |
| 汇率管理页面 | HTML + Alpine.js composable | 管理后台汇率 CRUD | **Web 管理后台** |
| 兑换页面 | 微信小程序页面 | 用户端汇率兑换入口 | **微信小程序** |
| 走势图组件 | 微信小程序组件 | 价格走势展示（需图表库） | **微信小程序** |

---

## 四、需求总览

| # | 需求 | 复杂度 | 新增表 | 新增服务 | 可复用 |
|---|---|---|---|---|---|
| 1 | 价格发现系统 | 中 | 0（利用现有 trade_orders + market_listings） | 1 | BusinessCacheHelper + SQL 聚合 |
| 2 | 市场数据分析 | 中 | 0（第一期就做 snapshots） | 1 | BusinessCacheHelper + 需求 1 共享 |
| 3 | 固定汇率兑换 | 低 | 1（exchange_rates） | 1 | BalanceService + AssetConversionService 模式 |

**已排除的需求**：

| 需求 | 排除原因 |
|---|---|
| ~~订单簿撮合（A）~~ | 67 用户流动性不足，技术复杂度极高 |
| ~~P2P 点对点报价（D）~~ | 用户之间无聊天通道（仅用户↔客服）、无好友系统、无法互相发现 |

**实施顺序**：3 → 1 → 2

理由：
- **3（汇率兑换）** 复杂度最低，直接复用 BalanceService + AssetConversionService 模式，1-2 天可完成
- **1（价格发现）** 纯查询聚合，不涉及写操作，风险最低
- **2（市场分析）** 依赖需求 1 的数据，作为卖家视角增强

---

## 五、需求一：价格发现系统

### 5.1 业务目标

每个可交易资产/物品在市场页面展示价格走势、成交量、中位数、历史极值。

### 5.2 数据来源（无需新建表）

所有数据从现有 `trade_orders` JOIN `market_listings` 聚合（数据库真实字段名）：

| 指标 | SQL 字段 |
|---|---|
| 成交价格 | `trade_orders.gross_amount` WHERE `status = 'completed'` |
| 成交时间 | `trade_orders.completed_at` |
| 物品类型 | `market_listings.listing_kind` + `offer_asset_code` / `offer_item_template_id` |
| 结算币种 | `trade_orders.asset_code`（实际全部为 DIAMOND） |
| 成交量 | COUNT / SUM(`market_listings.offer_amount`) |
| 历史极值 | MIN / MAX 聚合 |
| 手续费 | `trade_orders.fee_amount` |
| 卖家净收 | `trade_orders.net_amount` |

### 5.3 新增服务：`services/market/PriceDiscoveryService.js`

| 方法 | 入参 | 出参 | 说明 |
|---|---|---|---|
| `getPriceTrend` | asset_code/template_id, period, granularity | 时间序列 | 按小时/天/周聚合 |
| `getVolumeTrend` | asset_code/template_id, period, granularity | 时间序列 | 成交量聚合 |
| `getPriceSummary` | asset_code/template_id | {median, min, max, avg, count} | 综合摘要 |
| `getLatestTrades` | asset_code/template_id, limit | 最近 N 笔 | 实时成交流 |

**缓存策略**（复用 BusinessCacheHelper，新增方法对）：

| 数据 | TTL | 缓存键 |
|---|---|---|
| 价格走势 | 10 分钟 | `biz:price:trend:{asset}:{period}:{granularity}` |
| 成交量 | 10 分钟 | `biz:price:volume:{asset}:{period}:{granularity}` |
| 价格摘要 | 5 分钟 | `biz:price:summary:{asset}` |
| 最近成交 | 30 秒 | `biz:price:latest:{asset}:{limit}` |

### 5.4 新增 API 路由

基于后端已有路由架构，挂载到 `/api/v4/market` 下（新增子模块 `price.js`）：

| 方法 | 路径 | 说明 |
|---|---|---|
| GET | `/api/v4/market/price/trend` | 价格走势 |
| GET | `/api/v4/market/price/volume` | 成交量走势 |
| GET | `/api/v4/market/price/summary` | 价格摘要 |
| GET | `/api/v4/market/price/recent-trades` | 最近成交列表 |

**参数**：`?asset_code=red_shard&period=7d&granularity=1d` 或 `?template_id=123`

**响应格式**（遵循后端 ApiResponse 标准，使用 `res.apiSuccess`）：

```json
{
  "success": true,
  "code": "SUCCESS",
  "data": {
    "asset_code": "red_shard",
    "period": "7d",
    "granularity": "1d",
    "data_points": [
      { "time": "2026-02-16", "avg_price": 150, "min_price": 150, "max_price": 150, "trade_count": 1, "total_volume": 30 }
    ],
    "summary": {
      "median_price": 150,
      "lowest_ever": 50,
      "highest_ever": 1000,
      "avg_price_7d": 370,
      "total_trades": 20
    }
  },
  "timestamp": "2026-02-23 20:00:00",
  "version": "v4.0",
  "request_id": "req_xxx"
}
```

### 5.5 SQL 聚合示例（基于真实字段名）

```sql
SELECT
  DATE(t.completed_at) AS trade_date,
  COUNT(*) AS trade_count,
  MIN(t.gross_amount) AS min_price,
  MAX(t.gross_amount) AS max_price,
  ROUND(AVG(t.gross_amount)) AS avg_price,
  SUM(t.fee_amount) AS total_fees,
  SUM(ml.offer_amount) AS total_volume
FROM trade_orders t
JOIN market_listings ml ON t.market_listing_id = ml.market_listing_id
WHERE t.status = 'completed'
  AND ml.offer_asset_code = :asset_code
  AND t.completed_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY DATE(t.completed_at)
ORDER BY trade_date ASC;
```

### 5.6 后端实施步骤

| 步骤 | 文件 | 操作 | 工作量 |
|---|---|---|---|
| 1 | `services/market/PriceDiscoveryService.js` | 新建服务，4 个静态方法，Sequelize raw query | 0.5 天 |
| 2 | `utils/BusinessCacheHelper.js` | 新增 `getPriceTrend`/`setPriceTrend` 等缓存方法对 | 30 分钟 |
| 3 | `routes/v4/market/price.js` | 新建路由文件，4 个 GET 端点 | 2 小时 |
| 4 | `routes/v4/market/index.js` | 挂载 `router.use('/', priceRoutes)` | 2 行 |

### 5.7 各端职责

| 端 | 职责 | 是否有问题 |
|---|---|---|
| **后端** | 实现 PriceDiscoveryService + 路由 + 缓存 | ❌ 无问题，纯新增 |
| **Web 管理后台** | 无需改动（管理后台不展示用户端价格走势） | ❌ 无需动 |
| **微信小程序** | 调用 `/api/v4/market/price/*` 接口，渲染走势图 | ⚠️ 需确认图表库（见第十三节） |

---

## 六、需求二：市场数据分析

### 6.1 业务目标

卖家在挂牌定价时看到"这类物品最近一周成交均价多少"辅助定价。与价格发现高度重合，核心区别：价格发现是买家视角，市场数据分析是卖家视角。

### 6.2 新增（可选）：`market_price_snapshots` 预聚合表

当成交量增长后引入，当前 20 笔成交完全可以实时聚合。

| 字段 | 类型 | 说明 |
|---|---|---|
| snapshot_id | BIGINT PK AUTO_INCREMENT | 主键 |
| snapshot_date | DATE NOT NULL | 快照日期 |
| asset_code | VARCHAR(50) NULL | 资产代码 |
| item_template_id | BIGINT NULL | 物品模板 ID |
| listing_kind | ENUM('item','fungible_asset') | 挂牌类型 |
| trade_count | INT | 成交笔数 |
| total_volume | BIGINT | 总成交量 |
| total_diamond_volume | BIGINT | 总 DIAMOND 成交额 |
| min_price | BIGINT | 最低价 |
| max_price | BIGINT | 最高价 |
| avg_price | BIGINT | 均价 |
| median_price | BIGINT | 中位数价 |
| on_sale_count | INT | 当日在售数 |
| created_at | DATETIME | 创建时间 |

**索引**：
- `uk_snapshot_date_asset` UNIQUE (snapshot_date, asset_code, item_template_id)

### 6.3 新增服务：`services/market/MarketAnalyticsService.js`

| 方法 | 说明 |
|---|---|
| `getPricingAdvice(asset_code/template_id)` | 定价建议（近 7 天均价、当前在售均价、建议区间） |
| `getMarketOverview()` | 市场总览（各资产成交量排行） |
| `generateDailySnapshot()` | 定时任务：生成每日快照（第一期不做） |
| `getAssetPriceHistory(asset_code, days)` | 价格历史（优先读快照表，无快照则实时聚合） |

**定价建议算法**：

```
建议最低价 = 近7天成交均价 × 0.8
建议参考价 = 近7天成交均价
建议最高价 = 近7天成交均价 × 1.5
当前竞争力 = 当前在售同类挂牌的最低价
```

### 6.4 新增 API 路由

挂载到 `/api/v4/market` 下（新增子模块 `analytics.js`）：

| 方法 | 路径 | 说明 |
|---|---|---|
| GET | `/api/v4/market/analytics/pricing-advice` | 定价建议 |
| GET | `/api/v4/market/analytics/overview` | 市场总览 |
| GET | `/api/v4/market/analytics/history` | 价格历史 |

### 6.5 后端实施步骤

| 步骤 | 文件 | 操作 | 工作量 |
|---|---|---|---|
| 1 | `services/market/MarketAnalyticsService.js` | 新建服务，4 个静态方法 | 0.5 天 |
| 2 | `routes/v4/market/analytics.js` | 新建路由文件，3 个 GET 端点 | 2 小时 |
| 3 | `routes/v4/market/index.js` | 挂载 `router.use('/', analyticsRoutes)` | 2 行 |

**管理后台（可选）**：

| 步骤 | 文件 | 操作 | 工作量 |
|---|---|---|---|
| 1 | `routes/v4/console/marketplace.js` | 新增 `/stats/overview` 端点（复用 MarketAnalyticsService） | 1 小时 |
| 2 | `admin/src/modules/market/pages/trade-management.js` | 在已有页面中新增"市场概览"子页 Tab | 0.5 天 |

### 6.6 各端职责

| 端 | 职责 | 是否有问题 |
|---|---|---|
| **后端** | 实现 MarketAnalyticsService、路由 | ❌ 无问题 |
| **Web 管理后台** | 可在 trade-management.js 增加数据概览面板（ECharts 已有） | ❌ 无问题，ECharts 6.x 已集成 |
| **微信小程序** | 在挂牌定价页面调用定价建议 API 展示参考价 | ⚠️ 需确认挂牌页面是否存在 |

---

## 七、需求三：固定汇率兑换

### 7.1 业务目标

支持不同资产按固定汇率兑换。例如：10 red_shard → 1 DIAMOND。

### 7.2 ✅ 已决定：新建 exchange_rates（方案 B）

| 维度 | 方案 A：复用 material_conversion_rules | 方案 B：新建 exchange_rates |
|---|---|---|
| **现有字段覆盖** | ✅ from/to_asset_code、from/to_amount、fee_rate、min/max_from_amount、rounding_mode 全覆盖 | 需新建全部字段 |
| **现有服务** | ✅ AssetConversionService.convertMaterial 已完整实现（规则查询 + 三方记账 + assertAndGetTransaction + 幂等） | 需新建 ExchangeRateService（但可参考同一模式） |
| **现有管理后台** | ✅ routes/v4/console/material.js 已有 conversion-rules CRUD + admin/src/modules/asset/pages/material-conversion.js 页面 | 需新建管理路由 + 管理页面 |
| **改动量** | 低（ALTER ADD 4 字段 + 少量 UI 调整） | 中（新表 + 新模型 + 新服务 + 新路由 + 新管理页面） |
| **语义清晰度** | ⚠️ "material_conversion" 名字不够精准 | ✅ "exchange_rate" 语义精准 |
| **双向汇率** | ⚠️ 需要配两条规则（A→B 和 B→A） | ✅ 天然支持 |
| **生效时间/优先级** | ⚠️ 仅有 effective_at，无 effective_until 和 priority | ✅ 完整时间窗和优先级 |
| **每日限额** | ⚠️ 无 daily_user_limit / daily_global_limit 字段 | ✅ 内置限额字段 |
| **长期维护成本** | ✅ 低（复用现有代码） | ⚠️ 中（新增一套并行系统） |
| **技术债务** | ✅ 低（不新增表） | ⚠️ 中（新增表 + 服务） |

**建议**：**方案 B（新建 exchange_rates）**。

理由：
1. 项目未上线，一次性投入成本可接受
2. 汇率兑换是**高频运营场景**，需要 daily_user_limit / daily_global_limit / effective_until / priority 这些字段，material_conversion_rules 缺少这些
3. 语义分离更清晰：material_conversion 是"材料合成"，exchange_rate 是"货币兑换"，运营人员不会混淆
4. 但 AssetConversionService 的**架构模式**（规则查询 + 三方记账 + 幂等）可完全参考复用

**已拍板选 B**。详细行业对比分析见第十五节 P1。

### 7.3 新增数据表：`exchange_rates`（方案 B）

| 字段 | 类型 | 说明 |
|---|---|---|
| exchange_rate_id | BIGINT PK AUTO_INCREMENT | 主键 |
| from_asset_code | VARCHAR(50) NOT NULL | 源资产代码（FK material_asset_types.asset_code） |
| to_asset_code | VARCHAR(50) NOT NULL | 目标资产代码（FK material_asset_types.asset_code） |
| rate_numerator | BIGINT NOT NULL | 汇率分子 |
| rate_denominator | BIGINT NOT NULL | 汇率分母 |
| min_from_amount | BIGINT DEFAULT 1 | 最小兑换数量 |
| max_from_amount | BIGINT NULL | 最大兑换数量 |
| daily_user_limit | BIGINT NULL | 每用户每日限额 |
| daily_global_limit | BIGINT NULL | 全局每日限额 |
| fee_rate | DECIMAL(5,4) DEFAULT 0 | 手续费率 |
| status | ENUM('active','paused','disabled') DEFAULT 'active' | 状态 |
| priority | INT DEFAULT 0 | 优先级 |
| effective_from | DATETIME NULL | 生效时间 |
| effective_until | DATETIME NULL | 失效时间 |
| created_by | INT NULL FK(users.user_id) | 创建人 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**索引**：
- `uk_exchange_rate_pair` UNIQUE (from_asset_code, to_asset_code, priority, status)
- `idx_from_asset` (from_asset_code, status)

**汇率表达**：整数分子/分母避免浮点精度。计算：`to_amount = FLOOR(from_amount × rate_numerator ÷ rate_denominator)`

### 7.4 初始汇率确认（基于 material_asset_types.budget_value_points 内部锚定法）

**定价方法**：内部锚定法（阿里/美团积分体系常用），以 `budget_value_points` 为价值锚，保守取整后上线观察调整。

| from → to | rate_numerator | rate_denominator | 含义 | budget 比 | 保守调整说明 |
|---|---|---|---|---|---|
| red_shard → DIAMOND | 1 | 10 | 10 碎片 = 1 钻 | 10:100 = 1:10 | 精确匹配 |
| orange_shard → DIAMOND | 1 | 10 | 10 碎片 = 1 钻 | 10:100 = 1:10 | 精确匹配 |
| yellow_shard → DIAMOND | 1 | 5 | 5 碎片 = 1 钻 | 20:100 = 1:5 | 精确匹配 |
| green_shard → DIAMOND | 1 | 3 | 3 碎片 = 1 钻 | 40:100 = 1:2.5 → 向上取 3 | 保守（让用户多付 0.5 个碎片等价） |
| blue_shard → DIAMOND | 1 | 2 | 2 碎片 = 1 钻 | 80:100 = 1:1.25 → 向上取 2 | 保守（让用户多付 0.75 个碎片等价） |
| purple_shard → DIAMOND | 1 | 1 | 1 碎片 = 1 钻 | 160:100 > 1:1 → 取 1:1 | 保守（理论应给 > 1 钻，先压低） |
| red_crystal → DIAMOND | 2 | 1 | 1 水晶 = 2 钻 | 50:100 = 1:2 | 保守匹配 |

> **保守首发策略**（行业标准做法）：初始偏低 → 用户不急着换 → 观察 1-2 周市场反应 → 运营在管理后台调高。如果初始过高 → 用户大量抛售碎片换钻石 → 钻石通胀 → 无法回收。system_settings 支持运营随时调价无需改代码。

### 7.5 新增服务：`services/exchange/ExchangeRateService.js`

| 方法 | 说明 | 复用 |
|---|---|---|
| `getRate(from, to)` | 查询当前有效汇率（WHERE status='active' AND effective_from <= NOW() AND (effective_until IS NULL OR effective_until > NOW()) ORDER BY priority DESC LIMIT 1） | — |
| `getAllRates()` | 所有活跃汇率 | BusinessCacheHelper Redis 缓存 60s |
| `previewConvert(userId, from, to, amount)` | 预览兑换结果（计算 to_amount + fee + 检查限额） | — |
| `executeConvert(userId, from, to, amount, idempotencyKey, options)` | 执行兑换（assertAndGetTransaction 内） | BalanceService.changeBalance |
| `getUserDailyUsage(userId, rateId)` | 今日已用额度（查 asset_transactions WHERE business_type='exchange_rate_debit' AND DATE(created_at)=CURDATE()） | — |

**executeConvert 核心流程**（参考 AssetConversionService.convertMaterial 模式）：

```
输入：userId=32, from=red_shard, to=DIAMOND, amount=100

1. 查 exchange_rates：red_shard → DIAMOND, numerator=1, denominator=10
2. 计算：to_amount = FLOOR(100 × 1 ÷ 10) = 10
3. 检查限额（daily_user_limit / daily_global_limit）
4. assertAndGetTransaction 内：
   a. BalanceService.changeBalance：user扣减 red_shard -100（business_type='exchange_rate_debit', counterpart: SYSTEM_EXCHANGE）
   b. BalanceService.changeBalance：user增加 DIAMOND +10（business_type='exchange_rate_credit', counterpart: SYSTEM_EXCHANGE）
   c. 如有手续费：BalanceService.changeBalance 入 SYSTEM_PLATFORM_FEE（business_type='exchange_rate_fee'）
5. 双录记账自动覆盖（asset_transactions 自动产生 delta_amount + counterpart_account_id）
```

**新增 business_type 常量**：

| 常量 | 值 |
|---|---|
| EXCHANGE_RATE_DEBIT | `exchange_rate_debit` |
| EXCHANGE_RATE_CREDIT | `exchange_rate_credit` |
| EXCHANGE_RATE_FEE | `exchange_rate_fee` |

**新增系统账户**：`SYSTEM_EXCHANGE`（accounts 表新增 INSERT，account_type='system', system_code='SYSTEM_EXCHANGE'）

### 7.6 新增 API 路由

**用户端**（挂载到 `/api/v4/market` 下，新增子模块 `exchange-rate.js`）：

| 方法 | 路径 | 说明 |
|---|---|---|
| GET | `/api/v4/market/exchange-rates` | 所有可用汇率 |
| GET | `/api/v4/market/exchange-rates/:from/:to` | 特定币对汇率 |
| POST | `/api/v4/market/exchange-rates/preview` | 预览兑换结果 |
| POST | `/api/v4/market/exchange-rates/convert` | 执行兑换 |

> **已决定**：挂 `/api/v4/market/exchange-rates`。详细行业对比分析见第十五节 P3。

**管理后台**（挂载到 `/api/v4/console/exchange-rates`，新建路由文件）：

| 方法 | 路径 | 说明 |
|---|---|---|
| GET | `/api/v4/console/exchange-rates` | 列表查询 |
| POST | `/api/v4/console/exchange-rates` | 新增汇率 |
| PUT | `/api/v4/console/exchange-rates/:id` | 更新汇率 |
| PATCH | `/api/v4/console/exchange-rates/:id/status` | 启停汇率 |

### 7.7 后端实施步骤

| 步骤 | 文件 | 操作 | 工作量 |
|---|---|---|---|
| 1 | `migrations/YYYYMMDD-create-exchange-rates.js` | 创建 exchange_rates 表迁移 | 1 小时 |
| 2 | `migrations/YYYYMMDD-seed-exchange-rates.js` | 写入初始汇率 + SYSTEM_EXCHANGE 账户 | 30 分钟 |
| 3 | `models/ExchangeRate.js` | 新建 Sequelize Model（参考 MaterialConversionRule.js 模式） | 1 小时 |
| 4 | `services/exchange/ExchangeRateService.js` | 新建服务（5 个方法，参考 AssetConversionService 模式） | 0.5 天 |
| 5 | `routes/v4/market/exchange-rate.js` | 用户端路由（4 个端点） | 2 小时 |
| 6 | `routes/v4/console/exchange-rates.js` | 管理端路由（4 个端点） | 2 小时 |
| 7 | `routes/v4/market/index.js` | 挂载 exchange-rate 子路由 | 2 行 |
| 8 | `routes/v4/console/index.js` | 挂载 exchange-rates 子路由 | 2 行 |
| 9 | `utils/BusinessCacheHelper.js` | 新增 getExchangeRate/setExchangeRate/invalidateExchangeRate | 30 分钟 |

### 7.8 Web 管理后台实施步骤

| 步骤 | 文件 | 操作 | 工作量 |
|---|---|---|---|
| 1 | `admin/src/api/market/exchange-rate.js` | 新建 API 模块（EXCHANGE_RATE_ENDPOINTS + ExchangeRateAPI） | 1 小时 |
| 2 | `admin/src/api/market/index.js` | 导出新模块 | 5 分钟 |
| 3 | `admin/src/modules/market/composables/exchange-rates.js` | 新建 composable（useExchangeRateState + useExchangeRateActions） | 2 小时 |
| 4 | `admin/src/modules/market/pages/exchange-rate-management.js` | 新建管理页面（Alpine.js + createPageMixin 模式） | 0.5 天 |
| 5 | `admin/exchange-rate-management.html` | 新建 HTML 页面（参考已有 HTML 模板） | 1 小时 |

### 7.9 各端职责

| 端 | 职责 | 是否有问题 |
|---|---|---|
| **后端** | 新建 exchange_rates 表、ExchangeRate 模型、ExchangeRateService、用户路由 + 管理路由、SYSTEM_EXCHANGE 账户 | ❌ 无问题，纯新增 |
| **Web 管理后台** | 新增汇率管理页面（CRUD + 启停），调用 `/api/v4/console/exchange-rates` | ❌ 无问题，Alpine.js composable + HTML 模式完全兼容 |
| **微信小程序** | 新增兑换页面，调用 `/api/v4/market/exchange-rates/*`，展示汇率列表和兑换入口 | ⚠️ 需确认小程序端技术实现（见第十三节） |

---

## 八、迁移计划

### 8.1 数据库迁移文件

| 序号 | 文件名 | 内容 | 归属 |
|---|---|---|---|
| 1 | `YYYYMMDD-create-exchange-rates.js` | 创建 exchange_rates 表 | 后端 |
| 2 | `YYYYMMDD-seed-exchange-rates.js` | 写入 7 条初始汇率 + SYSTEM_EXCHANGE 系统账户 | 后端 |
| 3 | `YYYYMMDD-create-market-price-snapshots.js` | 创建 market_price_snapshots 表（** ，第一期就做**） | 后端 |

### 8.2 执行步骤

```bash
# 1. 生成迁移文件
npm run migration:create -- --name create-exchange-rates

# 2. 验证迁移（内置 migration_toolkit.js 检查）
npm run migration:verify

# 3. 执行迁移
npm run migration:up

# 4. 验证结果
npm run db:check
```

---

## 九、风险与并发安全

| 场景 | 风险 | 防护措施 | 后端已有能力 |
|---|---|---|---|
| 汇率兑换并发 | 超出限额 | BalanceService 行级锁 + 幂等键 + assertAndGetTransaction | ✅ 已有 |
| 汇率配置变更 | 兑换中汇率变了 | 事务内读取汇率，不受外部变更影响 | ✅ 事务隔离 |
| 余额不足 | 扣款失败 | BalanceService.changeBalance 内部检查 available_amount >= delta_amount | ✅ 已有 |
| 对账 | 所有资产变动自动审计 | 走 BalanceService.changeBalance → asset_transactions 双录流水，现有 scripts/reconcile-items.js 无需修改 | ✅ 已有 |

---

## 十、6 项决定 — 行业深度对比与最终决策

### 决定 1：汇率表方案 → ✅ 选 B（新建 exchange_rates）

**行业对比**：

| 企业 | 做法 | 是否复用合成表做汇率？ |
|---|---|---|
| 腾讯 | Q 币兑换、游戏币兑换、积分兑换各自独立表和服务 | **否** |
| 阿里 | 天猫积分、淘金币、蚂蚁森林能量各自独立 | **否** |
| Steam | Steam Wallet 独立货币系统，与物品合成完全分离 | **否** |
| 网易/米哈游 | "材料合成"和"货币兑换"两套独立系统 | **否** |

**项目实际情况**：`material_conversion_rules` 缺少 4 个汇率核心字段（daily_user_limit、daily_global_limit、effective_until、priority）。但现有 AssetConversionService 的**架构模式**（规则查询 + 三方记账 + 幂等）可完全参考。

### 决定 2：初始汇率数值 → ✅ 按 budget_value_points 保守设置（7 条已确认）

基于数据库真实 budget_value_points 计算（见 7.4 节表格）。**请确认 7 条初始汇率数值是否可以**。

### 决定 3：price_snapshots 第一期 →  做（实时聚合）

20 笔成交的 SQL 聚合 < 1ms，加上 BusinessCacheHelper Redis 缓存 TTL 5-10 分钟，完全够用。等成交量上千再加。

### 决定 4：B2C 兑换市场（exchange_items）→ 保留，后续独立迭代

数据库真实数据：`exchange_items` = 0 条商品，但 exchange_debit 流水 1,983 条（服务已运行）。保留不动。

### 决定 5：用户端汇率路由路径 → ✅ 挂 `/api/v4/market/exchange-rates`

| 方案 | 路径 | 优劣 |
|---|---|---|
| A（推荐） | `/api/v4/market/exchange-rates/*` | 与市场交易统一入口，复用 market index.js 子模块机制 |
| B | `/api/v4/exchange-rate/*` | 语义独立，需 app.js 新增一行挂载 |

### 决定 6：管理后台汇率页面放在哪个导航菜单 → ✅ "资产交易"分组内，紧跟"兑换市场"

| 方案 | 位置 | 说明 |
|---|---|---|
| A（推荐） | 放在"市场管理"模块下（与 trade-management、exchange-market 并列） | admin/src/modules/market/ 目录下 |
| B | 放在"资产管理"模块下（与 material-conversion 并列） | admin/src/modules/asset/ 目录下 |

### 决定汇总表

| # | 决定项 | 最终选择 | 状态 |
|---|---|---|---|
| 1 | 汇率表方案 | **B：新建 exchange_rates** | ✅ 已定 |
| 2 | 初始汇率数值 | **按 budget_value_points 保守设置（7 条）** | ✅ 已定 |
| 3 | snapshots 表 | **第一期不做** | 已定 |
| 4 | B2C 兑换市场 | **保留代码不动** | 已定 |
| 5 | 用户端汇率路由 | **挂 /api/v4/market/exchange-rates** | ✅ 已定 |
| 6 | 管理后台菜单位置 | **"资产交易"分组内，紧跟"兑换市场"** | ✅ 已定 |

---

## 十一、各端问题清单

### 11.1 后端数据库项目问题（需修改/新增）

| # | 问题/任务 | 类型 | 说明 |
|---|---|---|---|
| B1 | 新建 exchange_rates 表 | 迁移 | 通过 Sequelize CLI 迁移，参考已有 material_conversion_rules 表结构 |
| B2 | 新建 ExchangeRate 模型 | 模型 | 参考 models/MaterialConversionRule.js 的 define 模式 |
| B3 | 新增 SYSTEM_EXCHANGE 系统账户 | 数据 | accounts 表 INSERT 一行 |
| B4 | 新建 ExchangeRateService | 服务 | 参考 AssetConversionService 的架构模式 |
| B5 | 新建 PriceDiscoveryService | 服务 | 纯 SQL 聚合 + BusinessCacheHelper 缓存 |
| B6 | 新建 MarketAnalyticsService | 服务 | 纯 SQL 聚合 + 定价建议算法 |
| B7 | 新建用户端路由 | 路由 | routes/v4/market/ 下新增 price.js + analytics.js + exchange-rate.js |
| B8 | 新建管理端路由 | 路由 | routes/v4/console/ 下新增 exchange-rates.js |
| B9 | BusinessCacheHelper 扩展 | 缓存 | 新增汇率缓存 + 价格缓存方法对 |
| B10 | 新增 business_type 常量 | 常量 | exchange_rate_debit / exchange_rate_credit / exchange_rate_fee |

**无需修改的后端文件**：
- BalanceService.js（零改动，直接调用）
- FeeCalculator.js（零改动，calculateFeeByAsset 直接复用）
- transactionHelpers.js（零改动）
- IdempotencyService.js（零改动）
- 现有 market/exchange 相关服务和路由（零改动）

### 11.2 Web 管理后台前端项目问题（需修改/新增）

| # | 问题/任务 | 类型 | 说明 |
|---|---|---|---|
| W1 | 新建 exchange-rate API 模块 | API | admin/src/api/market/exchange-rate.js |
| W2 | 更新 market API 导出 | API | admin/src/api/market/index.js 导出新模块 |
| W3 | 新建汇率管理 composable | 逻辑 | admin/src/modules/market/composables/exchange-rates.js |
| W4 | 新建汇率管理页面 | 页面 | admin/src/modules/market/pages/exchange-rate-management.js |
| W5 | 新建汇率管理 HTML | 页面 | admin/exchange-rate-management.html |
| W6 | 可选：trade-management 添加市场概览 Tab | 增强 | 在已有页面增加 ECharts 图表面板 |

**完全兼容，无需修改已有文件**：
- Alpine.js 3.x composable 模式 → 新文件直接使用
- createPageMixin 页面混入 → 新页面直接使用
- request() / buildURL() API 调用 → 新 API 模块直接使用
- ECharts 6.x → 市场概览图表直接使用
- Tailwind CSS 3.x → 新页面直接使用

### 11.3 微信小程序前端项目问题（需确认）

| # | 问题/任务 | 类型 | 状态 |
|---|---|---|---|
| M1 | 是否已集成图表库（wx-charts / ECharts 微信版） | 技术确认 | ⚠️ 需确认 — 影响价格走势图展示 |
| M2 | 是否有统一的 request 封装 | 技术确认 | ⚠️ 需确认 — 调用新 API |
| M3 | 是否已有"市场"页面框架 | 功能确认 | ⚠️ 需确认 — 兑换页面放在哪里 |
| M4 | 新增兑换页面 | 新页面 | 调用 `/api/v4/market/exchange-rates/*` |
| M5 | 新增价格走势组件 | 新组件 | 调用 `/api/v4/market/price/*` |
| M6 | 挂牌定价页面增加建议价 | 增强 | 调用 `/api/v4/market/analytics/pricing-advice` |

> 微信小程序项目不在本仓库内，以上需与小程序开发者确认。**后端 API 设计不受小程序技术栈影响**。

---

## 十二、工作量评估

| 需求 | 后端模型 | 后端服务 | 后端路由 | 迁移 | 后端工作量 | Web 管理后台 | 微信小程序 |
|---|---|---|---|---|---|---|---|
| 固定汇率兑换 | 1 | 1 | 2（用户+管理） | 2 | 1-2 天 | 0.5 天（汇率管理页） | 1 天（兑换页面） |
| 价格发现系统 | 0 | 1 | 1 | 0 | 1 天 | 0 | 0.5 天（走势图） |
| 市场数据分析 | 0 | 1 | 1 | 0 | 1 天 | 0.5 天（概览面板） | 0.5 天（定价建议） |
| **合计** | **1** | **3** | **4** | **2** | **3-4 天** | **1 天** | **2 天** |

---

## 十三、技术栈兼容性确认

### 13.1 后端兼容性（完全兼容）

| 技术项 | 现有版本/模式 | 新需求要求 | 兼容性 |
|---|---|---|---|
| Sequelize 模型定义 | 6.x `class extends Model` + `Model.init()` | 新建 ExchangeRate 模型 | ✅ 完全一致（参考 MaterialConversionRule.js） |
| 事务管理 | `assertAndGetTransaction(options, 'methodName')` | 兑换写操作事务保证 | ✅ 直接复用 |
| 幂等性 | `idempotency_key` VARCHAR(100) UNIQUE 约束 | 兑换幂等 | ✅ 完全一致 |
| 双录记账 | `BalanceService.changeBalance({delta_amount, business_type, counterpart_*})` | 新 business_type 常量 | ✅ 仅新增常量值 |
| Redis 缓存 | `BusinessCacheHelper.get/set/del/delByPattern` + TTL jitter | 汇率/价格缓存 | ✅ 新增方法对 |
| 路由注册 | Express Router `/api/v4/*` + `router.use('/', subRoutes)` | 新增路由文件 | ✅ 完全一致 |
| 响应格式 | `res.apiSuccess(data, message)` / `res.apiError(message, code, data, status)` | 新端点响应 | ✅ 直接复用 |
| 手续费 | `FeeCalculator.calculateFeeByAsset(asset_code, itemValue, sellingPrice)` | 兑换手续费 | ✅ 直接复用 |
| 定时任务 | `node-cron` in `scripts/maintenance/scheduled_tasks.js` | 快照生成（可选） | ✅ 新增任务 |
| 日志 | `winston` 结构化日志 | 新服务日志 | ✅ 直接复用 |

### 13.2 Web 管理后台兼容性（完全兼容）

| 技术项 | 现有模式 | 新需求 | 兼容性 |
|---|---|---|---|
| 前端框架 | Alpine.js 3.x + `document.addEventListener('alpine:init', ...)` | 新增汇率管理页面 | ✅ 新增 HTML + composable + page |
| 页面模式 | `createPageMixin` 混入 + Alpine.store | 新页面 | ✅ 完全一致 |
| API 调用 | `request(url, options)` + `buildURL(template, params)` + `buildQueryString(params)` | 调用新管理 API | ✅ 完全一致 |
| API 模块化 | `export const ENDPOINTS = {}` + `export const XxxAPI = {}` | 新增 exchange-rate 模块 | ✅ 完全一致（参考 trade.js） |
| 图表 | ECharts 6.x | 市场数据概览图表 | ✅ 直接复用 |
| 样式 | Tailwind CSS 3.x | 新页面样式 | ✅ 直接复用 |

### 13.3 微信小程序兼容性（需确认）

| 技术项 | 需确认 | 影响 | 如果不具备的解决方案 |
|---|---|---|---|
| 图表库 | 是否已集成 wx-charts 或 ECharts 微信版 | 价格走势图展示 | 需额外安装图表库，或用 Canvas 简单绘制 |
| API 调用封装 | 是否有统一的 request 封装 | 调用新 API | 如果有，直接调用；如果没有，用 `wx.request` 直接调 |
| 市场页面 | 是否已有"市场"Tab 页 | 兑换入口放在哪里 | 需新建页面或 Tab |

> 微信小程序项目不在本仓库内，以上需与小程序开发者确认。后端 API 设计不受小程序技术栈影响。

---

## 十四、数据库字段名校正清单

> **重要**：以下字段名以数据库真实 DDL 为准，前端必须直接使用后端字段名，不做映射。

| 表 | 文档旧名 / 常见误写 | 数据库真实字段名 | 需要修改的端 |
|---|---|---|---|
| material_asset_types | `asset_group` | **`group_code`** | 前端如有使用需改 |
| material_asset_types | `is_tradeable` | **`is_tradable`** | 前端如有使用需改 |
| asset_transactions | `amount` | **`delta_amount`** | 前端如有使用需改 |
| accounts | `account_name` | **无此字段**（表中无 account_name 列） | 前端如有使用需删除 |
| material_asset_types | `asset_group_code` | **`group_code`** | 前端如有使用需改 |

---

## 十五、4 项决定 — 行业深度对比与最终决策

> 对比维度：大厂（腾讯/阿里/美团）、游戏公司（Steam/网易/米哈游/暴雪）、活动策划公司（得物/有赞）、小众二手平台（闲鱼/Buff/Depop）、小公司/创业团队。
> 决策原则：项目未上线、愿意一次性投入、不兼容旧接口、从长期维护成本最低和技术债务最少的角度出发、基于后端实际技术栈。

---

### P1 最终决策：汇率表方案 → **B（新建 exchange_rates）**

#### 行业怎么做的

| 类型 | 代表企业 | "材料合成"和"货币兑换"是否同一张表？ | 具体做法 |
|---|---|---|---|
| **大厂** | 腾讯 | **否** | Q 币兑换、游戏币兑换、积分兑换各自独立表和微服务。Q 币→游戏点券是"兑换服务"，装备合成是"合成服务"，从 API 到数据库到团队完全隔离 |
| **大厂** | 阿里 | **否** | 天猫积分、淘金币、蚂蚁森林能量、饿了么超级吃货卡各自独立系统。"积分兑换商品"和"积分互转"用不同的表和服务 |
| **大厂** | 美团 | **否** | 美团币兑换、商家积分、外卖红包分属不同子系统。货币兑换走"finance"域，材料合成走"game"域 |
| **游戏公司** | Steam | **否** | Steam Wallet（货币系统）和物品合成（Trading Card Badge 升级）完全独立。Wallet 有自己的 `wallet_transactions` 表，Badge 合成有自己的 `badge_crafting` 表 |
| **游戏公司** | 米哈游（原神） | **否** | "原石→创世结晶"兑换是 `exchange_rates` 级别的配置表；"角色突破材料合成"是 `recipe_table` 级别的配置表。两套 UI、两套服务 |
| **游戏公司** | 暴雪（WoW） | **否** | "金币→时光徽章"是独立经济系统（类似汇率兑换）；"材料合成装备"是专业技能系统（crafting）。两个完全不同的子系统 |
| **游戏公司** | 网易（梦幻西游） | **否** | "仙玉→金币"兑换和"材料炼化装备"是两套独立系统，各自有配置表、服务、管理后台 |
| **活动策划** | 得物 | **否** | 积分兑换和合成是两个模块 |
| **小众平台** | Buff/IGXE | **不适用** | 只有市场交易，没有材料合成，但货币兑换（卖出余额→提现）是独立的 `withdrawal` 系统 |
| **小公司** | 常见错误做法 | **是** | 起初复用一张"万能规则表"，字段越加越多（加 `rule_type` 区分合成/兑换/转化），一年后变成"上帝表"（God Table），字段 40+，查询条件复杂，最终被迫重构拆表 |

#### 两种方案差异详解

| 维度 | 方案 A：复用 material_conversion_rules（ALTER ADD 4 字段） | 方案 B：新建 exchange_rates |
|---|---|---|
| **前期成本** | 低（ALTER ADD + 改 AssetConversionService 内部逻辑增加条件分支） | 中（新表 + 新模型 + 新服务） |
| **长期维护成本** | ⚠️ **高** — convertMaterial 方法需增加 `if (isExchangeRate)` 分支判断限额/时间窗/优先级，方法会从 200 行膨胀到 400+。material_conversion_rules 表字段从 21 个增加到 25 个，运营看到"材料转换规则"里混着"货币兑换规则"会困惑 | ✅ **低** — ExchangeRateService 独立清晰，方法只做汇率兑换一件事。表字段 16 个，语义精准 |
| **技术债务** | ⚠️ 增加。单一职责被打破，一张表承担两种业务语义。未来如果要加"反向汇率""多级汇率""动态汇率"，改动波及 AssetConversionService + material_conversion_rules + 管理后台 material-conversion 页面，牵一发动全身 | ✅ 不增加。ExchangeRateService + exchange_rates 表是独立闭环，未来扩展不影响材料转换系统 |
| **运营理解成本** | ⚠️ 运营在"材料转换管理"页面看到兑换规则会困惑 | ✅ 独立的"汇率管理"页面，语义清晰 |
| **代码复用** | 复用 AssetConversionService 代码（但需大量 if 分支） | 参考 AssetConversionService **架构模式**（规则查询 + 三方记账 + 幂等），代码独立但模式一致 |
| **行业选择** | **0 家**大厂/游戏公司采用此方案 | **100%** 大厂和游戏公司采用分离方案 |

#### 最适合本项目的方案

**方案 B（新建 exchange_rates）**。理由：

1. **行业共识**：腾讯/阿里/Steam/米哈游/暴雪/网易无一例外分离"材料合成"和"货币兑换"。这不是巧合，是踩坑后的行业最佳实践
2. **本项目实际情况**：`material_conversion_rules` 已有 21 个字段，加 4 个变 25 个。而 AssetConversionService.convertMaterial 已经 200+ 行，加限额/时间窗/优先级逻辑会膨胀到 400+，可读性骤降
3. **前期成本差异不大**：方案 A 需要 ALTER ADD 4 字段 + 改 AssetConversionService 逻辑 + 改 material-conversion 管理页面。方案 B 需要新表 + 新模型 + 新服务 + 新管理页面。工作量差距约 0.5-1 天
4. **长期成本差异巨大**：方案 A 每次改汇率逻辑都要担心是否影响材料转换；方案 B 完全隔离，改汇率不碰转换
5. **项目未上线**：没有兼容负担，一次建对

---

### P2 最终决策：初始汇率数值 → **确认 7 条保守汇率**

#### 行业定价方法论

| 方法 | 谁用 | 做法 | 本项目适用性 |
|---|---|---|---|
| **成本定价**（基于获取概率反推） | 腾讯/网易游戏 | 根据抽奖概率计算物品期望获取成本，汇率 = 期望成本比 | 可参考，但需精确的概率数据和大量样本 |
| **市场定价**（基于成交均价） | Steam/Buff | 取近 7 天交易市场成交均价作为汇率基准 | ⚠️ 仅 20 笔成交，数据不足，统计不可靠 |
| **内部锚定**（基于 budget_value_points） | 阿里/美团积分体系 | 平台内部设定价值锚，按锚定比例换算 | ✅ **最适合** — 已有完整的 budget_value_points 锚定体系 |
| **保守首发 + 动态调整** | 几乎所有平台 | 初始偏低 → 观察 → 调高。绝不初始过高 | ✅ 行业标准做法 |

#### 确认的 7 条初始汇率

| from → to | numerator | denominator | 含义 | 风险评估 |
|---|---|---|---|---|
| red_shard → DIAMOND | 1 | 10 | 10 碎片 = 1 钻 | 低（精确匹配 budget 比） |
| orange_shard → DIAMOND | 1 | 10 | 10 碎片 = 1 钻 | 低（精确匹配） |
| yellow_shard → DIAMOND | 1 | 5 | 5 碎片 = 1 钻 | 低（精确匹配） |
| green_shard → DIAMOND | 1 | 3 | 3 碎片 = 1 钻 | 低（略保守于 budget 1:2.5） |
| blue_shard → DIAMOND | 1 | 2 | 2 碎片 = 1 钻 | 低（略保守于 budget 1:1.25） |
| purple_shard → DIAMOND | 1 | 1 | 1 碎片 = 1 钻 | 中（budget 比 160:100 理论应给 1.6 钻，初始压到 1:1） |
| red_crystal → DIAMOND | 2 | 1 | 1 水晶 = 2 钻 | 低（budget 比 50:100 = 1:2 保守匹配） |

**风控逻辑**：初始偏低 → 用户不着急兑换 → 运营观察 1-2 周 → 在管理后台调高。如果初始过高 → 用户大量抛碎片换钻石 → 钻石通胀 → 无法回收。purple_shard 风险最高，因为压低最多（理论 1.6 钻，给 1 钻），但也因此通胀风险最小。

---

### P3 最终决策：用户端汇率路由 → **挂 `/api/v4/market/exchange-rates`**

#### 行业路由设计对比

| 类型 | 代表企业 | API 路由风格 | 汇率/兑换路径 | 逻辑 |
|---|---|---|---|---|
| **大厂** | 腾讯 | 按业务域划分，每个域独立 | `/api/v1/exchange/*`（独立域） | 大厂有上百个域，每个域一级路由 |
| **大厂** | 阿里 | 按业务域划分 | `/api/trade/exchange/*`（交易域下子路由） | 归到"交易"大域下 |
| **大厂** | 美团 | 按业务域划分 | `/api/finance/exchange/*`（金融域） | 归到"金融"域 |
| **游戏公司** | Steam | 按 API 版本 + 功能 | `/IEconService/GetTradeOffers`（独立服务） | 每个服务独立，扁平 |
| **游戏公司** | 米哈游 | 按功能分 | 内部 API，兑换和市场在同一"经济系统"下 | 经济系统是一个整体 |
| **小公司** | 常见做法 A | 什么都放 `/api/v1/*` 下 | `/api/v1/exchange-rate` | 简单但扁平 |
| **小公司** | 常见做法 B | 按模块分层 | `/api/v1/market/exchange-rate` | 模块化，可维护性好 |

#### 本项目已有的路由结构

```
/api/v4/market          ← 用户交易市场（listings / sell / buy / manage / escrow）
/api/v4/shop/exchange   ← B2C 官方兑换商城（items / orders）
/api/v4/shop/assets/convert ← 材料转换用户端
/api/v4/assets/conversion-rules ← 转换规则用户端查询
```

#### 两种方案对比

| 维度 | 方案 1：`/api/v4/market/exchange-rates` | 方案 2：独立 `/api/v4/exchange-rate` |
|---|---|---|
| **与现有路由一致性** | ✅ 高 — market 下已有 listings/sell/buy/manage/escrow 五个子模块，加一个 exchange-rate 自然 | ⚠️ 需要 app.js 新增一行挂载 `app.use('/api/v4/exchange-rate', ...)` |
| **语义** | "市场"是用户做交易的地方，汇率兑换也是一种交易行为 | 独立更精准，但 13 个一级路由已经不少 |
| **前端调用** | 小程序/Web 调用 `/api/v4/market/exchange-rates/*`，和市场其他 API 在同一个 baseURL 下 | 多一个 baseURL 前缀 |
| **长期扩展** | 如果未来 market 下子模块太多（>10），可再拆 | 独立后不好再合回去 |

**最适合本项目**：方案 1。理由：
1. 后端 `routes/v4/market/index.js` 已有成熟的子模块加载模式（`router.use('/', subRoutes)`），加一个 exchange-rate.js 子模块是零成本
2. app.js 目前已有 13 个一级路由挂载，再加一个独立的 exchange-rate 会让一级路由膨胀到 14 个
3. 汇率兑换本质是"用虚拟资产做交易"，归属"市场"域合理
4. 小程序调用路径统一在 `/api/v4/market/*` 下，不用记额外前缀

---

### P4 最终决策：管理后台菜单位置 → **放在现有"资产交易"侧边栏组下**

#### 关键发现：管理后台实际没有"市场管理"和"资产管理"两个分组

查看 `admin/src/alpine/components/sidebar-nav.js` 发现：**侧边栏只有一个统一的"资产交易"分组**（`id: 'asset-trade'`），包含：

```
💎 资产交易
├── 资产管理       → asset-management.html
├── 资产调整       → asset-adjustment.html
├── 物品追踪       → item-lifecycle.html
├── 对账报告       → reconciliation.html
├── 兑换市场       → exchange-market.html（B2C 兑换商城）
├── 交易市场       → trade-management.html
├── 竞价管理       → bid-management.html
└── 孤儿冻结清理   → orphan-frozen.html
```

**没有单独的"市场管理"分组**。所以 P4 的问题实际变成：在"资产交易"分组里加在哪个位置。

#### 行业管理后台菜单设计

| 类型 | 代表企业 | 汇率/兑换管理放在哪里 |
|---|---|---|
| **大厂** | 腾讯 | "经济系统管理"大类下，与"积分商城管理""虚拟货币管理"并列 |
| **大厂** | 阿里 | "营销工具"大类下的"积分体系"子菜单 |
| **大厂** | 美团 | "财务中心"大类下的"兑换配置" |
| **游戏公司** | 米哈游 | "经济系统"大类下，与"商店管理""抽卡配置"并列 |
| **游戏公司** | 网易 | "经济系统"下的"兑换比例配置" |
| **小公司** | 常见做法 | 和"商品管理"或"积分管理"放一起 |

#### 最适合本项目的位置

在"资产交易"分组的 **"兑换市场"后面** 新增一项 **"汇率兑换"**：

```
💎 资产交易
├── 资产管理
├── 资产调整
├── 物品追踪
├── 对账报告
├── 兑换市场        ← B2C 官方兑换商城（已有）
├── 汇率兑换        ← ✅ 新增，紧跟在"兑换市场"后
├── 交易市场       ← 用户间挂牌交易（已有）
├── 竞价管理
└── 孤儿冻结清理
```

理由：
1. "兑换市场"是 B2C 商品兑换，"汇率兑换"是固定汇率货币兑换，放在一起运营容易找
2. 不需要新建侧边栏分组（避免分组过多），只在已有的"资产交易"分组里加一项
3. sidebar-nav.js 只需在 `items` 数组的 `exchange` 项后面加一行：`{ id: 'exchange-rate', name: '汇率兑换', url: '/admin/exchange-rate-management.html' }`

---

### 决定汇总表（最终版）

| # | 决定项 | 最终选择 | 行业依据 | 对本项目的具体影响 |
|---|---|---|---|---|
| **P1** | 汇率表方案 | **B：新建 exchange_rates** | 腾讯/阿里/Steam/米哈游/暴雪/网易 100% 分离合成与兑换 | 后端新增 1 表 + 1 模型 + 1 服务 + 2 路由文件，不改动任何已有文件 |
| **P2** | 初始汇率 | **确认 7 条保守汇率** | 行业标准"保守首发 + 动态调整"策略 | seed 迁移写入 7 行数据，运营在管理后台随时可调 |
| **P3** | 用户端路由 | **`/api/v4/market/exchange-rates`** | 小公司模块化分层 + 本项目已有 market 子模块机制 | 后端 routes/v4/market/ 下新增 exchange-rate.js，market/index.js 加一行挂载 |
| **P4** | 管理后台位置 | **"资产交易"侧边栏分组，紧跟"兑换市场"之后** | 游戏公司"经济系统"统一管理 + 本项目已有的单一分组结构 | sidebar-nav.js 加一行，新建 exchange-rate-management.html + 对应 JS |

---

## 十六、实施完成记录（2026-02-23）

### 16.1 后端 + Web管理后台 — 全部完成

**后端（16项）**：exchange_rates表+模型+ExchangeRateService+PriceDiscoveryService+MarketAnalyticsService+BusinessCacheHelper扩展+4个路由文件+路由挂载+服务注册+模型注册+幂等映射+测试（12/12通过）+ESLint 0 error

**Web管理后台（7项）**：API模块+market导出更新+页面JS+HTML+侧边栏+Vite配置+构建完成

**质量检查**：健康检查✅ | ESLint 0 error✅ | Jest 12/12✅ | API 11/11✅ | 双录记账验证✅ | 前端页面5/5 HTTP 200✅

---

## 十七、微信小程序前端对接指南

> 以下11个API端点全部已实现并通过测试，微信小程序前端可直接对接。

### 17.1 汇率兑换 API（需求三）

**API 1：获取所有可用汇率**
```
GET /api/v4/market/exchange-rates
Authorization: Bearer {token}
```
返回 `data` 为数组，每条包含：`exchange_rate_id`, `from_asset_code`, `to_asset_code`, `rate_numerator`, `rate_denominator`, `rate_display`, `min_from_amount`, `max_from_amount`, `daily_user_limit`, `fee_rate`, `status`, `description`

**API 2：获取特定币对汇率**
```
GET /api/v4/market/exchange-rates/:from/:to
示例: GET /api/v4/market/exchange-rates/red_shard/DIAMOND
Authorization: Bearer {token}
```

**API 3：预览兑换结果**
```
POST /api/v4/market/exchange-rates/preview
Authorization: Bearer {token}
Body: { "from_asset_code": "red_shard", "to_asset_code": "DIAMOND", "from_amount": 100 }
```
返回 `data` 包含：`from_amount`, `gross_to_amount`, `fee_amount`, `net_to_amount`, `rate_display`, `user_balance`, `sufficient_balance`, `daily_user_limit`, `daily_used`, `daily_remaining`

**API 4：执行兑换**
```
POST /api/v4/market/exchange-rates/convert
Authorization: Bearer {token}
Idempotency-Key: {唯一值}
Body: { "from_asset_code": "red_shard", "to_asset_code": "DIAMOND", "from_amount": 100 }
```
返回 `data` 包含：`success`, `from_amount`, `net_to_amount`, `from_balance`（兑换后源资产余额）, `to_balance`（兑换后目标资产余额）, `is_duplicate`

### 17.2 价格发现 API（需求一）

**API 5：价格走势**
```
GET /api/v4/market/price/trend?asset_code=red_shard&period=7d&granularity=1d
Authorization: Bearer {token}
```
参数：`asset_code` 或 `template_id`（二选一），`period`（1d/7d/30d/90d），`granularity`（1h/1d/1w）

**API 6：成交量走势**
```
GET /api/v4/market/price/volume?asset_code=red_shard&period=7d&granularity=1d
Authorization: Bearer {token}
```

**API 7：价格摘要**
```
GET /api/v4/market/price/summary?asset_code=red_shard
Authorization: Bearer {token}
```
返回：`total_trades`, `lowest_ever`, `highest_ever`, `median_price`, `avg_price_7d`, `trades_7d`

**API 8：最近成交**
```
GET /api/v4/market/price/recent-trades?asset_code=red_shard&limit=10
Authorization: Bearer {token}
```

### 17.3 市场分析 API（需求二）

**API 9：定价建议**
```
GET /api/v4/market/analytics/pricing-advice?asset_code=red_shard
Authorization: Bearer {token}
```
返回：`has_trade_data`, `suggested_min_price`, `suggested_price`, `suggested_max_price`, `lowest_on_sale`, `advice_text`

**API 10：市场总览**
```
GET /api/v4/market/analytics/overview
Authorization: Bearer {token}
```

**API 11：价格历史**
```
GET /api/v4/market/analytics/history?asset_code=red_shard&days=30
Authorization: Bearer {token}
```

### 17.4 错误码

| 错误码 | HTTP | 含义 | 前端建议 |
|---|---|---|---|
| RATE_NOT_FOUND | 404 | 汇率规则不存在 | 提示"该兑换暂未开放" |
| INVALID_AMOUNT | 400 | 数量无效 | 表单校验 |
| AMOUNT_BELOW_MINIMUM | 400 | 低于最小兑换量 | 提示最小量 |
| AMOUNT_ABOVE_MAXIMUM | 400 | 超过最大兑换量 | 提示最大量 |
| DAILY_LIMIT_EXCEEDED | 400 | 超出每日限额 | 显示今日已用/剩余 |
| MISSING_IDEMPOTENCY_KEY | 400 | 缺少幂等键 | 客户端生成 |
| IDEMPOTENCY_KEY_CONFLICT | 409 | 幂等键冲突 | 生成新键重试 |

### 17.5 微信小程序待确认事项

| # | 确认项 | 影响 |
|---|---|---|
| M1 | 是否已集成图表库 | 影响价格走势图（API 5/6） |
| M2 | 是否有统一 request 封装 | 影响调用方式 |
| M3 | 是否已有"市场"页面 | 影响兑换入口位置 |
| M4 | 幂等键生成策略 | 建议：`exchange_rate_${Date.now()}_${随机6位}` |
