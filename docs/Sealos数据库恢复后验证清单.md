# Sealos 数据库恢复后验证清单

**创建时间**：2025年10月13日  
**文档版本**：v1.0  
**适用场景**：数据库备份恢复后的完整验证流程

---

## 🎉 恭喜！数据库恢复成功

根据 Sealos 监控面板数据，您的数据库已经：
- ✅ 成功启动并运行 1.2+ 小时
- ✅ 资源使用正常（CPU、内存、磁盘）
- ✅ 数据库连接正常（10+ 个活跃连接）
- ✅ 性能指标健康（事务、表锁等）

---

## 📋 完整验证清单

### 第一阶段：数据完整性验证 ⭐⭐⭐

#### 1. 运行自动验证脚本

```bash
# 在项目根目录执行
bash scripts/verify-restored-data.sh
```

**验证内容：**
- ✅ 数据库连接测试
- ✅ 核心表完整性检查
- ✅ 数据记录数量统计
- ✅ 关键用户数据验证
- ✅ 数据一致性检查
- ✅ 性能指标评估

**预期结果：**
```
🏥 数据健康度: 90+/100
✅ 优秀 - 数据完整且一致
```

#### 2. 手动验证关键数据

登录数据库手动检查：

```bash
# 连接到 Sealos 数据库（从 Sealos 控制台获取连接信息）
mysql -h <sealos-host> -P <port> -u <username> -p<password> <database_name>
```

执行以下查询：

```sql
-- 1. 检查用户数据
SELECT COUNT(*) AS user_count, 
       COUNT(DISTINCT role) AS role_types,
       SUM(balance) AS total_balance
FROM users;

-- 2. 检查商品数据
SELECT COUNT(*) AS product_count,
       COUNT(CASE WHEN status = 'active' THEN 1 END) AS active_products
FROM products;

-- 3. 检查订单数据
SELECT COUNT(*) AS order_count,
       SUM(total_amount) AS total_revenue,
       COUNT(CASE WHEN status = 'completed' THEN 1 END) AS completed_orders
FROM orders;

-- 4. 检查抽奖记录
SELECT COUNT(*) AS lottery_count,
       COUNT(DISTINCT user_id) AS participated_users,
       COUNT(CASE WHEN prize_id IS NOT NULL THEN 1 END) AS won_count
FROM lottery_records;
```

---

### 第二阶段：性能优化 ⭐⭐

#### 3. 运行性能优化脚本

```bash
# 优化数据库表和索引
bash scripts/optimize-database.sh
```

**优化内容：**
- 🔧 分析慢查询日志
- 🔧 检查表碎片情况
- 🔧 优化核心数据表
- 🔧 更新表统计信息
- 🔧 检查关键索引
- 🔧 清理过期数据

#### 4. 监控性能指标

在 Sealos 控制台持续监控：

**资源指标：**
- CPU 使用率应该 < 70%
- 内存使用率应该 < 80%
- 磁盘使用率应该 < 90%

**性能指标：**
- 当前连接数应该稳定
- 慢查询应该 = 0 或接近 0
- 表锁应该 < 0.5
- 异常连接应该 = 0

---

### 第三阶段：应用功能测试 ⭐⭐⭐

#### 5. 后端服务健康检查

```bash
# 检查后端服务状态
curl http://localhost:3000/health

# 预期返回
{
  "status": "healthy",
  "timestamp": "2025-10-13T...",
  "database": "connected",
  "uptime": "..."
}
```

#### 6. 功能测试清单

**用户功能：**
- [ ] 用户注册功能
- [ ] 用户登录功能（手机号 + 万能验证码 123456）
- [ ] 用户信息查询
- [ ] 用户余额查询

**商品功能：**
- [ ] 商品列表查询
- [ ] 商品详情查询
- [ ] 商品搜索功能
- [ ] 商品分类筛选

**抽奖功能：**
- [ ] 抽奖规则查询
- [ ] 执行抽奖
- [ ] 中奖记录查询
- [ ] 用户库存管理

**订单功能：**
- [ ] 创建订单
- [ ] 订单列表查询
- [ ] 订单详情查询
- [ ] 订单状态更新

**管理功能：**
- [ ] 管理员登录
- [ ] 用户管理
- [ ] 商品管理
- [ ] 订单管理
- [ ] 数据统计

#### 7. 前端测试清单

访问前端应用并测试：

**基础功能：**
- [ ] 页面能正常加载
- [ ] 登录功能正常
- [ ] API 请求成功
- [ ] 数据显示正确

**关键流程：**
- [ ] 用户注册/登录流程
- [ ] 商品浏览流程
- [ ] 抽奖流程
- [ ] 订单创建流程

---

### 第四阶段：数据备份策略 ⭐⭐

#### 8. 设置定期备份

在 Sealos 控制台设置自动备份：

**建议配置：**
- 📅 **每日备份**：凌晨 2:00
- 📅 **保留天数**：7 天
- 📅 **备份类型**：全量备份

**本地备份：**
```bash
# 创建本地备份
bash scripts/backup-from-sealos.sh

# 备份文件位置
backups/sealos_backup_YYYYMMDD_HHMMSS.sql
```

#### 9. 验证备份可用性

定期测试备份恢复：

```bash
# 每月测试一次备份恢复到测试环境
bash scripts/test-backup-restore.sh
```

---

## 🔍 问题排查指南

### 常见问题 1：数据不完整

**症状：**
- 某些表缺失
- 记录数不对
- 用户余额不对

**解决方案：**
1. 检查备份文件是否完整
2. 重新执行恢复流程
3. 联系 Sealos 技术支持

### 常见问题 2：性能问题

**症状：**
- 查询很慢
- 连接数过高
- CPU/内存使用率高

**解决方案：**
```bash
# 1. 运行性能优化脚本
bash scripts/optimize-database.sh

# 2. 检查慢查询
mysql -e "SHOW FULL PROCESSLIST;"

# 3. 分析表索引
mysql -e "SHOW INDEX FROM <table_name>;"
```

### 常见问题 3：连接异常

**症状：**
- 连接数突然暴增
- 出现大量异常连接
- 连接超时

**解决方案：**
1. 检查应用连接池配置
2. 查看应用日志找出问题代码
3. 优化数据库连接参数
4. 增加数据库资源配额

---

## 📊 监控建议

### 关键指标监控

**每日检查：**
- ✅ CPU/内存/磁盘使用率
- ✅ 活跃连接数
- ✅ 慢查询数量
- ✅ 表锁情况

**每周检查：**
- ✅ 数据增长趋势
- ✅ 备份完整性
- ✅ 表碎片情况
- ✅ 索引使用情况

**每月检查：**
- ✅ 数据一致性
- ✅ 安全审计
- ✅ 性能优化效果
- ✅ 容量规划

### 告警阈值设置

**资源告警：**
- 🔴 CPU > 80%（持续 5 分钟）
- 🔴 内存 > 90%（持续 5 分钟）
- 🔴 磁盘 > 85%（立即告警）

**性能告警：**
- 🔴 慢查询 > 10 次/小时
- 🔴 连接数 > 100
- 🔴 表锁 > 1.0

---

## 🎯 优化建议

### 短期优化（本周完成）

1. **数据库配置优化**
   - 调整 InnoDB 缓冲池大小（建议 512MB+）
   - 优化查询缓存设置
   - 调整连接池参数

2. **应用代码优化**
   - 检查并修复慢查询
   - 优化数据库连接使用
   - 添加必要的索引

3. **监控完善**
   - 设置性能监控告警
   - 建立日志收集系统
   - 配置自动备份

### 中期优化（本月完成）

1. **数据归档**
   - 归档历史订单数据
   - 清理过期抽奖记录
   - 压缩日志表

2. **性能测试**
   - 进行压力测试
   - 优化高并发场景
   - 测试备份恢复速度

3. **文档完善**
   - 更新运维文档
   - 编写故障处理手册
   - 建立知识库

### 长期优化（季度完成）

1. **架构升级**
   - 考虑读写分离
   - 考虑数据分片
   - 评估缓存方案

2. **自动化运维**
   - 自动化备份和恢复
   - 自动化性能优化
   - 自动化告警处理

---

## ✅ 验证完成标志

当以下所有项目都完成时，可以认为数据库恢复验证完成：

- [x] 数据库成功启动并稳定运行
- [ ] 数据完整性验证脚本通过（健康度 > 90）
- [ ] 性能优化脚本执行完成
- [ ] 后端服务健康检查通过
- [ ] 所有核心功能测试通过
- [ ] 前端应用功能正常
- [ ] 自动备份已配置
- [ ] 监控告警已设置

---

## 📞 技术支持

如遇到问题，请按以下顺序处理：

1. **查阅本文档**的问题排查指南
2. **检查 Sealos 控制台**的日志和监控
3. **查看应用日志**：`pm2 logs` 或检查日志文件
4. **联系 Sealos 技术支持**：support@sealos.io
5. **查看 Sealos 文档**：https://sealos.io/docs

---

**文档维护**：请在每次重要操作后更新本文档  
**最后验证时间**：2025年10月13日  
**验证人员**：运维团队

🎉 **祝贺您成功完成数据库恢复！**

