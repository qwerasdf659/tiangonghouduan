# å¹¿å‘Šç³»ç»Ÿå‡çº§æ–¹æ¡ˆ - åç«¯å®æ–½æ–¹æ¡ˆ

> **æ–‡æ¡£æ—¥æœŸ**: 2026-02-18  
> **åç«¯å®æ–½çŠ¶æ€**: æœªå¼€å§‹ï¼ˆç»æ•°æ®åº“å®æŸ¥ç¡®è®¤ï¼Œ5 ä¸ªæ–°å­—æ®µå‡ä¸å­˜åœ¨ï¼‰  
> **æ•°æ®åº“å®æŸ¥æ—¶é—´**: 2026-02-18ï¼Œè¿æ¥ `restaurant_points_dev` åº“çœŸå®éªŒè¯

---

## ä¸€ã€å½“å‰åç«¯çœŸå®çŠ¶æ€ï¼ˆæ•°æ®åº“å®æŸ¥ï¼‰

### 1.1 `popup_banners` è¡¨ç°æœ‰å­—æ®µï¼ˆ16 åˆ—ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|---|---|---|
| `popup_banner_id` | INT PK AUTO_INCREMENT | ä¸»é”® |
| `title` | VARCHAR(100) NOT NULL | åå°ç®¡ç†è¯†åˆ«ç”¨æ ‡é¢˜ |
| `image_url` | VARCHAR(500) NOT NULL | å›¾ç‰‡å¯¹è±¡ keyï¼ˆéå®Œæ•´ URLï¼‰ |
| `display_mode` | ENUM(6 å€¼) NOT NULL | æ˜¾ç¤ºæ¨¡å¼ï¼ˆwide/horizontal/square/tall/slim/full_imageï¼‰ |
| `image_width` | INT UNSIGNED NULL | åŸå›¾å®½åº¦ px |
| `image_height` | INT UNSIGNED NULL | åŸå›¾é«˜åº¦ px |
| `link_url` | VARCHAR(500) NULL | è·³è½¬é“¾æ¥ |
| `link_type` | ENUM(4 å€¼) DEFAULT 'none' | è·³è½¬ç±»å‹ï¼ˆnone/page/miniprogram/webviewï¼‰ |
| `position` | VARCHAR(50) DEFAULT 'home' | æ˜¾ç¤ºä½ç½® |
| `is_active` | TINYINT(1) DEFAULT 0 | æ˜¯å¦å¯ç”¨ |
| `display_order` | INT DEFAULT 0 | æ˜¾ç¤ºé¡ºåºï¼ˆå°çš„ä¼˜å…ˆï¼‰ |
| `start_time` | DATETIME NULL | å¼€å§‹å±•ç¤ºæ—¶é—´ |
| `end_time` | DATETIME NULL | ç»“æŸå±•ç¤ºæ—¶é—´ |
| `created_by` | INT NULL FKâ†’users.user_id | åˆ›å»ºäºº |
| `created_at` | DATETIME DEFAULT CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| `updated_at` | DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

### 1.2 ç°æœ‰æ•°æ®ï¼ˆ2 æ¡è®°å½•ï¼‰

| popup_banner_id | title | display_mode | is_active | position | æ—¶é—´èŒƒå›´ |
|---|---|---|---|---|---|
| 15 | 2.3 | tall | 1 | home | 2026-02-08 ~ 2026-02-20 |
| 16 | 555 | tall | 1 | home | 2026-02-10 ~ 2026-02-28 |

> è¿ç§»åè¿™ 2 æ¡è®°å½•ä¼šè‡ªåŠ¨å¡«å…¥é»˜è®¤å€¼ `banner_type='promo'`, `frequency_rule='once_per_day'`, `priority=0`, `force_show=0`, `frequency_value=1`ã€‚

### 1.3 ç°æœ‰ç´¢å¼•

| ç´¢å¼•å | å­—æ®µ |
|---|---|
| PRIMARY | popup_banner_id |
| created_by | created_by |
| idx_popup_banners_position_active | (position, is_active) |
| idx_popup_banners_display_order | display_order |
| idx_popup_banners_time_range | (start_time, end_time) |

### 1.4 ç°æœ‰å­—å…¸ï¼ˆsystem_dictionaries è¡¨ï¼‰

å·²æœ‰ 3 ç»„ banner ç›¸å…³å­—å…¸ï¼š

| dict_type | æ¡ç›® |
|---|---|
| `banner_position` | home, lottery, activity, profileï¼ˆ4 æ¡ï¼‰ |
| `banner_link_type` | none, page, miniprogram, webviewï¼ˆ4 æ¡ï¼‰ |
| `banner_display_mode` | wide, horizontal, square, tall, slim, full_imageï¼ˆ6 æ¡ï¼‰ |

`displayNameHelper.js` å·²æ³¨å†Œï¼š`BANNER_POSITION`ã€`BANNER_LINK_TYPE`ã€`BANNER_DISPLAY_MODE`ã€‚

### 1.5 ç°æœ‰ä»£ç å±‚

| å±‚ | æ–‡ä»¶ | çŠ¶æ€ |
|---|---|---|
| Model | `models/PopupBanner.js` | ä»… 16 ä¸ªç°æœ‰å­—æ®µï¼Œæ— é¢‘ç‡æ§åˆ¶å­—æ®µ |
| Service | `services/PopupBannerService.js` | 7 ä¸ªæ–¹æ³•ï¼ˆgetActiveBanners/getAdminBannerList/createBanner/updateBanner/deleteBanner/toggleBannerActive/getStatisticsï¼‰ï¼Œæ— é¢‘ç‡é€»è¾‘ |
| å°ç¨‹åºè·¯ç”± | `routes/v4/system/popup-banners.js` | GET è¿”å› 7 ä¸ªå­—æ®µï¼ˆä¸å« titleï¼‰ï¼ŒæŒ‰ display_order ASC æ’åº |
| ç®¡ç†åå°è·¯ç”± | `routes/v4/console/popup-banners.js` | å®Œæ•´ CRUD + toggle + orderï¼Œæ—  banner_type ç­›é€‰ |
| ServiceManager | `services/index.js` | å·²æ³¨å†Œ `popup_banner` æœåŠ¡ |

### 1.6 Web ç®¡ç†åå°å‰ç«¯ç°çŠ¶ä¸å‘½åæ­§ä¹‰

#### å†…å®¹ç®¡ç†ä¸­å¿ƒä¸‰ä¸ª tab å¯¹åº”çš„åç«¯ç³»ç»Ÿ

Web ç®¡ç†åå°çš„ã€Œå†…å®¹ç®¡ç†ä¸­å¿ƒã€é¡µé¢æœ‰ 3 ä¸ª tabï¼Œåˆ†åˆ«å¯¹æ¥ 3 å¼ ç‹¬ç«‹çš„åç«¯è¡¨ï¼š

| Web å‰ç«¯ tab | å½“å‰æ ‡ç­¾å | å®é™…å¯¹æ¥çš„åç«¯è¡¨ | åç«¯å…¨é“¾è·¯å‘½å |
|---|---|---|---|
| å…¬å‘Šç®¡ç† | å…¬å‘Šç®¡ç† | `system_announcements` | SystemAnnouncementï¼ˆæ— æ­§ä¹‰ï¼‰ |
| **è½®æ’­å›¾ç®¡ç†** | **è½®æ’­å›¾ç®¡ç†ï¼ˆæœ‰æ­§ä¹‰ï¼‰** | **`popup_banners`** | **PopupBanner / å¼¹çª—æ¨ªå¹…ï¼ˆåç«¯æ— æ­§ä¹‰ï¼‰** |
| å›¾ç‰‡èµ„æº | å›¾ç‰‡èµ„æº | `image_resources` | ImageResourceï¼ˆæ— æ­§ä¹‰ï¼‰ |

#### å‘½åæ­§ä¹‰è¯´æ˜

Web å‰ç«¯å°† `popup_banners`ï¼ˆå¼¹çª—æ¨ªå¹…ï¼‰æ ‡è®°ä¸º"è½®æ’­å›¾ç®¡ç†"ï¼Œä¸åç«¯å‘½åä¸ä¸€è‡´ï¼š

| å¯¹æ¯”é¡¹ | åç«¯å‘½åï¼ˆæƒå¨ï¼‰ | Web å‰ç«¯å‘½åï¼ˆæœ‰æ­§ä¹‰ï¼‰ |
|---|---|---|
| æ•°æ®åº“è¡¨ | `popup_banners` | â€” |
| ä¸»é”® | `popup_banner_id` | å‰ç«¯ JS ä¸­ä¹Ÿç”¨ `popup_banner_id` |
| Model | `PopupBanner` | â€” |
| Service | `PopupBannerService` | â€” |
| API è·¯å¾„ | `/api/v4/console/popup-banners` | è°ƒç”¨æ­£ç¡®ï¼Œä½† UI æ ‡ç­¾å†™"è½®æ’­å›¾" |
| ä»£ç æ³¨é‡Š | å…¨éƒ¨å†™"å¼¹çª— Banner" | JS æ—¥å¿—å†™"åŠ è½½è½®æ’­å›¾åˆ—è¡¨" |
| **tab æ ‡ç­¾** | â€” | **"è½®æ’­å›¾ç®¡ç†"ï¼ˆåº”æ”¹ä¸º"å¼¹çª—ç®¡ç†"ï¼‰** |

"è½®æ’­å›¾"é€šå¸¸æŒ‡é¡µé¢å†…è‡ªåŠ¨æ»‘åŠ¨åˆ‡æ¢çš„æ¨ªå¹…ç»„ä»¶ï¼ˆswiper/carouselï¼‰ï¼Œè€Œ `popup_banners` æ˜¯å¼¹çª—æµ®å±‚ï¼ˆmodalï¼‰ï¼Œä¸¤è€…äº¤äº’å½¢æ€å®Œå…¨ä¸åŒã€‚

#### éœ€è¦ä¿®æ­£çš„å‰ç«¯æ–‡ä»¶

| æ–‡ä»¶ | å½“å‰çŠ¶æ€ | ä¿®æ­£å†…å®¹ |
|---|---|---|
| `admin/src/modules/content/pages/content-management.js` | `{ id: 'popup-banners', name: 'è½®æ’­å›¾ç®¡ç†', icon: 'ğŸ¨' }` | name æ”¹ä¸º"å¼¹çª—ç®¡ç†" |
| `admin/src/modules/content/composables/banners.js` | æ—¥å¿—å’Œæç¤ºè¯­å…¨éƒ¨å†™"è½®æ’­å›¾" | ç»Ÿä¸€æ”¹ä¸º"å¼¹çª—" |
| `admin/content-management.html` | HTML æ¨¡æ¿ä¸­çš„"è½®æ’­å›¾"æ–‡æ¡ˆ | ç»Ÿä¸€æ”¹ä¸º"å¼¹çª—" |

#### `popup_banners` ä¸ `system_announcements` æ˜¯ä¸¤ä¸ªç‹¬ç«‹ç³»ç»Ÿ

| å¯¹æ¯”ç»´åº¦ | popup_bannersï¼ˆå¼¹çª—æ¨ªå¹…ï¼‰ | system_announcementsï¼ˆç³»ç»Ÿå…¬å‘Šï¼‰ |
|---|---|---|
| æ ¸å¿ƒå†…å®¹ | å›¾ç‰‡ï¼ˆimage_url å¿…å¡«ï¼‰ | çº¯æ–‡å­—ï¼ˆtitle + content TEXTï¼‰ |
| UI å½¢å¼ | å¼¹çª—æµ®å±‚ modalï¼Œè¦†ç›–é¡µé¢ | æ–‡å­—æ¡/é€šçŸ¥åˆ—è¡¨ |
| æ•°æ®é‡ | 2 æ¡è®°å½• | 50+ æ¡è®°å½•ï¼ˆå«æµ‹è¯•æ•°æ®ï¼‰ |
| ç±»å‹å­—æ®µ | æ— ï¼ˆæœ¬æ¬¡æ–°å¢ `banner_type`ï¼‰ | `type` ENUM: system/activity/maintenance/notice |
| ä¼˜å…ˆçº§ | æ— ï¼ˆæœ¬æ¬¡æ–°å¢ `priority` INTï¼‰ | `priority` ENUM: high/medium/low |
| ç›®æ ‡æ§åˆ¶ | `position`ï¼ˆhome/profileï¼‰ | `target_groups` JSON |
| é˜…è¯»è¿½è¸ª | æ— ï¼ˆå®¢æˆ·ç«¯æœ¬åœ°å­˜å‚¨ï¼‰ | `view_count`ï¼ˆæœåŠ¡ç«¯è®¡æ•°ï¼‰ |
| é¢‘ç‡æ§åˆ¶ | **æœ¬æ¬¡æ–°å¢**ï¼ˆå®¢æˆ·ç«¯æ‰§è¡Œï¼‰ | æ— ï¼ˆä¾èµ– is_active + expires_atï¼‰ |
| å›¾ç‰‡æ”¯æŒ | æœ‰ï¼ˆå®Œæ•´çš„ä¸Šä¼ /å­˜å‚¨/CDN è½¬æ¢ï¼‰ | æ—  |

> æœ¬æ–‡æ¡£çš„é¢‘ç‡æ§åˆ¶æ–¹æ¡ˆä»…é’ˆå¯¹ `popup_banners`ï¼Œä¸æ¶‰åŠ `system_announcements`ã€‚ä¸¤è€…æ˜¯å®Œå…¨ç‹¬ç«‹çš„ç³»ç»Ÿï¼Œä¸å­˜åœ¨åŠŸèƒ½äº¤å‰ã€‚

---

## äºŒã€éœ€è¦æ–°å¢çš„ 5 ä¸ªå­—æ®µï¼ˆä»¥åç«¯æ•°æ®åº“ä¸ºå‡†ï¼‰

### 2.1 æ•°æ®åº“è¿ç§»

åœ¨ `popup_banners` è¡¨æ–°å¢ 5 åˆ—ï¼š

| å­—æ®µå | ç±»å‹ | NOT NULL | é»˜è®¤å€¼ | è¯´æ˜ |
|---|---|---|---|---|
| `banner_type` | VARCHAR(20) | YES | `'promo'` | ç±»å‹åˆ†çº§ï¼š`notice`(ç³»ç»Ÿå…¬å‘Š) / `event`(æ´»åŠ¨æ¨å¹¿) / `promo`(æ—¥å¸¸ä¿ƒé”€)ã€‚è½®æ’­å›¾ç‹¬ç«‹ä¸º `carousel_items` è¡¨ï¼ˆæ‹æ¿å†³ç­–1ï¼‰ã€‚è¿œæœŸ `user_ad` é€šè¿‡ `ad_campaigns` è¡¨ç®¡ç† |
| `frequency_rule` | VARCHAR(30) | YES | `'once_per_day'` | é¢‘ç‡è§„åˆ™æšä¸¾ï¼ˆè§ 2.2ï¼‰ |
| `frequency_value` | INT | NO | `1` | é¢‘ç‡å‚æ•°ï¼ˆé…åˆ `once_per_n_days` / `n_times_total` ä½¿ç”¨ï¼‰ |
| `force_show` | TINYINT(1) | NO | `0` | æ˜¯å¦å¼ºåˆ¶å¼¹å‡ºï¼ˆ1=ä¸å¯ç‚¹é®ç½©å…³é—­ï¼‰ |
| `priority` | INT | NO | `0` | å¼¹å‡ºä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå¤§è¶Šä¼˜å…ˆï¼ŒåŒºåˆ«äº display_order çš„ç®¡ç†æ’åºï¼‰ |

æ–°å¢ 2 ä¸ªç´¢å¼•ï¼š

| ç´¢å¼•å | å­—æ®µ | ç”¨é€” |
|---|---|---|
| `idx_popup_banners_type_active` | (banner_type, is_active) | æŒ‰ç±»å‹ç­›é€‰æ´»è·ƒå¼¹çª— |
| `idx_popup_banners_priority` | (priority) | ä¼˜å…ˆçº§æ’åº |

> **å‘½åè¯´æ˜**: ç”¨ `banner_type` è€Œé `type`ï¼Œé¿å… Sequelize STI ä¿ç•™å­—å†²çªã€‚

### 2.2 `frequency_rule` æšä¸¾å€¼å®šä¹‰

| frequency_rule | frequency_value ç”¨æ³• | å«ä¹‰ |
|---|---|---|
| `always` | å¿½ç•¥ | æ¯æ¬¡è¿›å…¥é¡µé¢éƒ½å¼¹ |
| `once` | å¿½ç•¥ | æ•´ä¸ªæ´»åŠ¨å‘¨æœŸåªå¼¹ä¸€æ¬¡ |
| `once_per_session` | å¿½ç•¥ | æ¯æ¬¡å°ç¨‹åºå†·å¯åŠ¨å¼¹ä¸€æ¬¡ |
| `once_per_day` | å¿½ç•¥ | æ¯å¤©æœ€å¤šå¼¹ä¸€æ¬¡ |
| `once_per_n_days` | Nï¼ˆå¤©æ•°ï¼‰ | æ¯ N å¤©å¼¹ä¸€æ¬¡ |
| `n_times_total` | Nï¼ˆæ€»æ¬¡æ•°ï¼‰ | ç´¯è®¡æœ€å¤šå¼¹ N æ¬¡ |

### 2.3 `priority` ä¸ `display_order` çš„èŒè´£åŒºåˆ†

| å­—æ®µ | èŒè´£ | æ’åºæ–¹å‘ | ä½¿ç”¨åœºæ™¯ |
|---|---|---|---|
| `priority` | å¼¹å‡ºç«äº‰ä¼˜å…ˆçº§ | DESCï¼ˆå¤§çš„å…ˆå¼¹ï¼‰ | å¤šä¸ªæ´»è·ƒå¼¹çª—ç«äº‰æ—¶å†³å®šè°å…ˆå¼¹ |
| `display_order` | ç®¡ç†åå°åˆ—è¡¨æ’åº | ASCï¼ˆå°çš„æ’å‰ï¼‰ | ç®¡ç†å‘˜åœ¨åå°çœ‹åˆ°çš„æ’åˆ—é¡ºåº |

---

## ä¸‰ã€å¯å¤ç”¨çš„ç°æœ‰åŸºç¡€è®¾æ–½

ä»¥ä¸‹æ˜¯é¡¹ç›®ä¸­å·²æˆç†Ÿè¿è¡Œçš„ç»„ä»¶ï¼Œæœ¬æ¬¡ç›´æ¥å¤ç”¨ï¼Œæ— éœ€é‡å»ºï¼š

### 3.1 è¿ç§»æœºåˆ¶

- **å·¥å…·**: `sequelize-cli`ï¼Œè¿ç§»æ–‡ä»¶æ”¾ `migrations/` ç›®å½•
- **å‘½åè§„èŒƒ**: `YYYYMMDDHHMMSS-æè¿°.js`ï¼ˆå¦‚ `20260218170000-add-frequency-fields-to-popup-banners.js`ï¼‰
- **å¤ç”¨æ–¹å¼**: `queryInterface.addColumn()` + `queryInterface.addIndex()` + `queryInterface.bulkInsert()` å­—å…¸æ•°æ®

### 3.2 å­—å…¸ä½“ç³»

- **å­˜å‚¨**: `system_dictionaries` è¡¨ï¼Œå­—æ®µ dict_type / dict_code / dict_name / dict_color / sort_order
- **æ³¨å†Œ**: `utils/displayNameHelper.js` çš„ `DICT_TYPES` å¸¸é‡
- **è°ƒç”¨**: `attachDisplayNames(data, [{ field, dictType }])` è‡ªåŠ¨é™„åŠ  `_display` å’Œ `_color` åç¼€
- **å¤ç”¨æ–¹å¼**: æ–°å¢ `banner_type` å’Œ `banner_frequency` ä¸¤ç»„å­—å…¸ï¼Œæ³¨å†Œ `BANNER_TYPE` å’Œ `BANNER_FREQUENCY` åˆ° `DICT_TYPES`

### 3.3 Service å±‚æ¨¡å¼

- **åŸºç±»**: é™æ€æ–¹æ³• classï¼Œæ— éœ€å®ä¾‹åŒ–
- **æ—¥å¿—**: `logger.info/error()` ç»“æ„åŒ–æ—¥å¿—
- **å›¾ç‰‡ URL**: `_transformBannerImageUrl()` ç»Ÿä¸€å°†å¯¹è±¡ key è½¬å®Œæ•´ CDN URL
- **ä¸­æ–‡åé™„åŠ **: `attachDisplayNames()` è‡ªåŠ¨ä¸ºæšä¸¾å­—æ®µé™„åŠ ä¸­æ–‡æ˜¾ç¤ºå
- **å¤ç”¨æ–¹å¼**: åœ¨ç°æœ‰ `PopupBannerService` çš„æ–¹æ³•ä¸­è¿½åŠ å­—æ®µå³å¯

### 3.4 è·¯ç”±å±‚æ¨¡å¼

- **è®¤è¯**: `adminAuthMiddleware` ç®¡ç†å‘˜é‰´æƒä¸­é—´ä»¶
- **å¼‚æ­¥**: `asyncHandler(fn)` åŒ…è£…å™¨
- **æœåŠ¡è·å–**: `req.app.locals.services.getService('popup_banner')`
- **å“åº”æ ¼å¼**: `res.apiSuccess(data, message)` / `res.apiError(message, code, detail, status)`
- **å¤ç”¨æ–¹å¼**: åœ¨ç°æœ‰è·¯ç”±æ–‡ä»¶ä¸­è¿½åŠ å‚æ•°æ ¡éªŒå’Œç­›é€‰é€»è¾‘

### 3.5 å‰ç«¯é€‚é…çº¦å®š

- å‰ç«¯**ç›´æ¥ä½¿ç”¨åç«¯å­—æ®µå**ï¼ˆsnake_caseï¼‰ï¼Œä¸åšæ˜ å°„
- å‰ç«¯é€šè¿‡ `_display` åç¼€å­—æ®µè·å–ä¸­æ–‡åï¼ˆå¦‚ `banner_type_display`ï¼‰
- å‰ç«¯é€šè¿‡ `_color` åç¼€å­—æ®µè·å–æ ·å¼ classï¼ˆå¦‚ `banner_type_color`ï¼‰

---

## å››ã€å¯æ‰©å±•çš„æ”¹é€ ç‚¹

### 4.1 Model å±‚æ‰©å±•ï¼ˆ`models/PopupBanner.js`ï¼‰

**æ–°å¢ 5 ä¸ªå­—æ®µå®šä¹‰**ï¼š

| å­—æ®µ | Sequelize ç±»å‹ | éªŒè¯è§„åˆ™ | æ‰©å±•ç‚¹ |
|---|---|---|---|
| `banner_type` | DataTypes.STRING(20) | isIn: ['notice', 'event', 'promo'] | è½®æ’­å›¾ç‹¬ç«‹è¡¨ï¼Œè¿œæœŸ `user_ad` é€šè¿‡ `ad_campaigns` |
| `frequency_rule` | DataTypes.STRING(30) | isIn: 6 ç§æšä¸¾å€¼ | åç»­å¯æ‰©å±•æ–°è§„åˆ™ï¼Œå¦‚ `once_per_week` |
| `frequency_value` | DataTypes.INTEGER | min: 1 | é€šç”¨å‚æ•°ï¼Œé…åˆä¸åŒ rule ä½¿ç”¨ |
| `force_show` | DataTypes.BOOLEAN | æ—  | å¸ƒå°”å‹ï¼Œä¸ is_active æ¨¡å¼ä¸€è‡´ |
| `priority` | DataTypes.INTEGER | min: 0 | æ•´æ•°æ’åºï¼Œä¸ display_order æ¨¡å¼ä¸€è‡´ |

**æ–°å¢ Scope**ï¼š

```
byType(banner_type) â†’ where: { banner_type }
```

### 4.2 Service å±‚æ‰©å±•ï¼ˆ`services/PopupBannerService.js`ï¼‰

| ç°æœ‰æ–¹æ³• | æ”¹é€ å†…å®¹ |
|---|---|
| `getActiveBanners()` | attributes è¿½åŠ  5 ä¸ªæ–°å­—æ®µï¼›æ’åºæ”¹ä¸º `priority DESC, display_order ASC`ï¼›éœ€è¦åŒæ—¶è¿”å› `title`ï¼ˆå‰ç«¯ notice ç±»å‹éœ€å±•ç¤ºæ ‡é¢˜ï¼‰ |
| `getAdminBannerList()` | æ”¯æŒ `banner_type` query å‚æ•°ç­›é€‰ï¼›`attachDisplayNames` è¿½åŠ  `banner_type` å’Œ `frequency_rule` |
| `createBanner()` | è§£æ„èµ‹å€¼è¿½åŠ  5 ä¸ªæ–°å­—æ®µï¼›create è°ƒç”¨è¿½åŠ  5 ä¸ªå­—æ®µ |
| `updateBanner()` | `allowedFields` æ•°ç»„è¿½åŠ  5 ä¸ªå­—æ®µï¼›force_show ç”¨ `=== 'true' \|\| === true` å¤„ç† |
| `getStatistics()` | è¿½åŠ æŒ‰ `banner_type` åˆ†ç»„ç»Ÿè®¡ï¼ˆ`by_type: { notice, event, promo }`ï¼‰ |

### 4.3 è·¯ç”±å±‚æ‰©å±•

**å°ç¨‹åºç«¯** `routes/v4/system/popup-banners.js`ï¼š
- è¿”å›å­—æ®µä» 7 ä¸ªå¢åŠ åˆ° 13 ä¸ªï¼ˆè¿½åŠ  title + 5 ä¸ªé¢‘ç‡æ§åˆ¶å­—æ®µï¼‰
- æ’åºä» `display_order ASC` æ”¹ä¸º `priority DESC, display_order ASC`

**ç®¡ç†åå°** `routes/v4/console/popup-banners.js`ï¼š
- GET åˆ—è¡¨ï¼šè¿½åŠ  `banner_type` query å‚æ•°
- POST åˆ›å»ºï¼šå‚æ•°æ ¡éªŒè¿½åŠ  5 ä¸ªæ–°å­—æ®µï¼ˆbanner_type / frequency_rule / frequency_value / force_show / priorityï¼‰
- PUT æ›´æ–°ï¼šåŒä¸Š

### 4.4 å­—å…¸æ•°æ®æ‰©å±•

æ–°å¢ 2 ç»„å­—å…¸ï¼ˆå†™å…¥ `system_dictionaries` è¡¨ï¼‰ï¼š

**`banner_type`**ï¼ˆ3 æ¡ï¼Œä¸å« carouselï¼Œè½®æ’­å›¾ç‹¬ç«‹è¡¨ï¼‰ï¼š

| dict_code | dict_name | dict_color | sort_order |
|---|---|---|---|
| `notice` | ç³»ç»Ÿå…¬å‘Š | bg-red-500 | 1 |
| `event` | æ´»åŠ¨æ¨å¹¿ | bg-orange-500 | 2 |
| `promo` | æ—¥å¸¸ä¿ƒé”€ | bg-blue-500 | 3 |

**`banner_frequency`**ï¼ˆ6 æ¡ï¼‰ï¼š

| dict_code | dict_name | dict_color | sort_order |
|---|---|---|---|
| `always` | æ¯æ¬¡å¼¹å‡º | bg-gray-500 | 1 |
| `once` | ä»…å¼¹ä¸€æ¬¡ | bg-green-500 | 2 |
| `once_per_session` | æ¯æ¬¡å¯åŠ¨å¼¹ä¸€æ¬¡ | bg-cyan-500 | 3 |
| `once_per_day` | æ¯å¤©ä¸€æ¬¡ | bg-blue-500 | 4 |
| `once_per_n_days` | æ¯Nå¤©ä¸€æ¬¡ | bg-purple-500 | 5 |
| `n_times_total` | ç´¯è®¡Næ¬¡ | bg-pink-500 | 6 |

**`displayNameHelper.js` æ³¨å†Œ**ï¼š

```
BANNER_TYPE: 'banner_type'
BANNER_FREQUENCY: 'banner_frequency'
```

---

## äº”ã€å°ç¨‹åºç«¯ API å“åº”æ ¼å¼ï¼ˆä»¥åç«¯ä¸ºå‡†ï¼‰

### `GET /api/v4/system/popup-banners?status=active&position=home`

**åç«¯æ ‡å‡†å“åº”æ ¼å¼**ï¼ˆå«è‡ªåŠ¨æ³¨å…¥çš„ä¿¡å°å­—æ®µï¼‰ï¼š

```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "banners": [
      {
        "popup_banner_id": 15,
        "title": "æ˜¥èŠ‚ç§¯åˆ†ç¿»å€æ´»åŠ¨",
        "image_url": "https://objectstorageapi.bja.sealos.run/br0za7uc-tiangong/popup-banners/xxx.jpg",
        "display_mode": "square",
        "image_width": 750,
        "image_height": 750,
        "link_url": "/pages/lottery/lottery",
        "link_type": "page",
        "banner_type": "promo",
        "frequency_rule": "once_per_n_days",
        "frequency_value": 3,
        "force_show": false,
        "priority": 100
      }
    ]
  },
  "timestamp": "2026-02-18T12:00:00.000+08:00",
  "version": "v4",
  "request_id": "req_xxx"
}
```

**è¿”å›å­—æ®µæ¸…å•**ï¼ˆ12 ä¸ªï¼Œä¸å«ç®¡ç†ä¸“ç”¨å­—æ®µï¼‰ï¼š

| å­—æ®µ | è¯´æ˜ | å‰ç«¯ç”¨é€” |
|---|---|---|
| `popup_banner_id` | ä¸»é”® | æœ¬åœ°å­˜å‚¨ keyã€å¹‚ç­‰æ ‡è¯† |
| `title` | å¼¹çª—æ ‡é¢˜ | notice ç±»å‹å±•ç¤ºæ ‡é¢˜ |
| `image_url` | å®Œæ•´ CDN URLï¼ˆåç«¯è‡ªåŠ¨è½¬æ¢ï¼‰ | å›¾ç‰‡å±•ç¤º |
| `display_mode` | æ˜¾ç¤ºæ¨¡å¼ | å¼¹çª—å°ºå¯¸é€‚é… |
| `image_width` | åŸå›¾å®½åº¦ | é¢„åŠ è½½åˆ¤æ–­ |
| `image_height` | åŸå›¾é«˜åº¦ | é¢„åŠ è½½åˆ¤æ–­ |
| `link_url` | è·³è½¬ç›®æ ‡ | ç‚¹å‡»è·³è½¬ |
| `link_type` | è·³è½¬ç±»å‹ | è·³è½¬æ–¹å¼åˆ¤æ–­ |
| `banner_type` | **[æ–°]** ç±»å‹åˆ†çº§ | å…³é—­è¡Œä¸ºå’Œ UI å±•ç¤º |
| `frequency_rule` | **[æ–°]** é¢‘ç‡è§„åˆ™ | å®¢æˆ·ç«¯é¢‘ç‡åˆ¤æ–­ |
| `frequency_value` | **[æ–°]** é¢‘ç‡å‚æ•° | é…åˆ frequency_rule |
| `force_show` | **[æ–°]** å¼ºåˆ¶å¼¹å‡º | é®ç½©ç‚¹å‡»è¡Œä¸º |
| `priority` | **[æ–°]** å¼¹å‡ºä¼˜å…ˆçº§ | å·²ç”±åç«¯æ’åºï¼Œå‰ç«¯æŒ‰æ•°ç»„é¡ºåºå±•ç¤º |

**ä¸è¿”å›çš„å­—æ®µ**ï¼ˆç®¡ç†ä¸“ç”¨ï¼Œå‰ç«¯ä¸éœ€è¦ï¼‰ï¼š`position`, `is_active`, `display_order`, `start_time`, `end_time`, `created_by`, `created_at`, `updated_at`

**æ’åºè§„åˆ™**ï¼ˆåç«¯æ‰§è¡Œï¼‰ï¼š`priority DESC, display_order ASC, created_at DESC`

---

## å…­ã€Web ç®¡ç†åå°å‰ç«¯é€‚é…è¯´æ˜

ç®¡ç†åå°å‰ç«¯éœ€è¦é€‚é…ä»¥ä¸‹åç«¯å˜æ›´ï¼ˆç›´æ¥ä½¿ç”¨åç«¯å­—æ®µåï¼Œä¸åšæ˜ å°„ï¼‰ï¼š

### 6.0 å‘½åä¿®æ­£ï¼ˆå‰ç«¯é€‚é…åç«¯ï¼‰

ä»¥åç«¯ `popup_banners` å‘½åä¸ºå‡†ï¼Œå‰ç«¯ç»Ÿä¸€æ”¹ä¸º"å¼¹çª—"ï¼š

| ä¿®æ”¹ä½ç½® | æ”¹å‰ | æ”¹å |
|---|---|---|
| tab æ ‡ç­¾ | `è½®æ’­å›¾ç®¡ç†` | `å¼¹çª—ç®¡ç†` |
| JS æ—¥å¿—/æç¤ºè¯­ | `åŠ è½½è½®æ’­å›¾åˆ—è¡¨` / `è½®æ’­å›¾å·²åˆ›å»º` / `ä¿å­˜è½®æ’­å›¾å¤±è´¥` ç­‰ | `åŠ è½½å¼¹çª—åˆ—è¡¨` / `å¼¹çª—å·²åˆ›å»º` / `ä¿å­˜å¼¹çª—å¤±è´¥` ç­‰ |
| HTML æ¨¡æ¿æ–‡æ¡ˆ | æ‰€æœ‰"è½®æ’­å›¾"æ–‡æ¡ˆ | ç»Ÿä¸€æ”¹ä¸º"å¼¹çª—" |
| è¡¨å•éªŒè¯æç¤º | `è¯·é€‰æ‹©è½®æ’­å›¾å›¾ç‰‡` / `è½®æ’­å›¾ ID ç¼ºå¤±` | `è¯·é€‰æ‹©å¼¹çª—å›¾ç‰‡` / `å¼¹çª— ID ç¼ºå¤±` |

æ¶‰åŠæ–‡ä»¶ï¼š
- `admin/src/modules/content/pages/content-management.js`
- `admin/src/modules/content/composables/banners.js`
- `admin/content-management.html`

### 6.1 åˆ—è¡¨ç­›é€‰

`GET /api/v4/console/popup-banners` æ–°å¢ query å‚æ•°ï¼š

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|---|---|---|
| `banner_type` | STRING | æŒ‰ç±»å‹ç­›é€‰ï¼ˆnotice/event/promo/carouselï¼‰ï¼Œä¸ä¼ åˆ™ä¸ç­›é€‰ |

### 6.2 åˆ›å»º/æ›´æ–°

`POST /api/v4/console/popup-banners` å’Œ `PUT /api/v4/console/popup-banners/:id` body æ–°å¢å­—æ®µï¼š

| å­—æ®µ | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | æ ¡éªŒè§„åˆ™ |
|---|---|---|---|---|
| `banner_type` | STRING | å¦ | `'promo'` | æšä¸¾ï¼šnotice / event / promo |
| `frequency_rule` | STRING | å¦ | `'once_per_day'` | æšä¸¾ï¼šalways / once / once_per_session / once_per_day / once_per_n_days / n_times_total |
| `frequency_value` | INT | å¦ | `1` | æ­£æ•´æ•°ï¼Œä»…å½“ frequency_rule ä¸º once_per_n_days æˆ– n_times_total æ—¶æœ‰æ„ä¹‰ |
| `force_show` | BOOLEAN | å¦ | `false` | true/false |
| `priority` | INT | å¦ | `0` | éè´Ÿæ•´æ•° |

### 6.3 åˆ—è¡¨/è¯¦æƒ…å“åº”

åç«¯è‡ªåŠ¨é™„åŠ ä¸­æ–‡æ˜¾ç¤ºåï¼Œå‰ç«¯ç›´æ¥ä½¿ç”¨ï¼š

| åç«¯è¿”å›å­—æ®µ | å€¼ç¤ºä¾‹ | è¯´æ˜ |
|---|---|---|
| `banner_type` | `"notice"` | åŸå§‹å€¼ |
| `banner_type_display` | `"ç³»ç»Ÿå…¬å‘Š"` | ä¸­æ–‡åï¼ˆè‡ªåŠ¨é™„åŠ ï¼‰ |
| `banner_type_color` | `"bg-red-500"` | æ ·å¼ classï¼ˆè‡ªåŠ¨é™„åŠ ï¼‰ |
| `frequency_rule` | `"once_per_day"` | åŸå§‹å€¼ |
| `frequency_rule_display` | `"æ¯å¤©ä¸€æ¬¡"` | ä¸­æ–‡åï¼ˆè‡ªåŠ¨é™„åŠ ï¼‰ |
| `frequency_rule_color` | `"bg-blue-500"` | æ ·å¼ classï¼ˆè‡ªåŠ¨é™„åŠ ï¼‰ |

### 6.4 ç»Ÿè®¡æ¥å£

`GET /api/v4/console/popup-banners/statistics` å“åº”æ–°å¢ `by_type` ç»´åº¦ï¼š

```json
{
  "statistics": {
    "total": 2,
    "active": 2,
    "inactive": 0,
    "by_position": { "home": 2, "profile": 0 },
    "by_type": { "notice": 0, "event": 0, "promo": 2, "carousel": 0 }
  }
}
```

---

## ä¸ƒã€å®æ–½æ­¥éª¤ï¼ˆæŒ‰ä¾èµ–é¡ºåºï¼‰

### åç«¯æ”¹é€ ï¼ˆæ­¥éª¤ 1-6ï¼‰

| æ­¥éª¤ | å±‚ | æ”¹åŠ¨æ–‡ä»¶ | è¯´æ˜ |
|---|---|---|---|
| 1 | è¿ç§» | `migrations/YYYYMMDDHHMMSS-add-frequency-fields-to-popup-banners.js` | æ–°å¢ 5 åˆ— + 2 ç´¢å¼• + 10 æ¡å­—å…¸æ•°æ®ï¼ˆbanner_type 4 æ¡ + banner_frequency 6 æ¡ï¼‰ |
| 2 | å­—å…¸æ³¨å†Œ | `utils/displayNameHelper.js` | DICT_TYPES è¿½åŠ  BANNER_TYPEã€BANNER_FREQUENCY |
| 3 | Model | `models/PopupBanner.js` | è¿½åŠ  5 ä¸ªå­—æ®µå®šä¹‰ + byType scope |
| 4 | Service | `services/PopupBannerService.js` | æ”¹é€  5 ä¸ªæ–¹æ³•ï¼ˆè§ç¬¬å››èŠ‚ 4.2ï¼‰ |
| 5 | å°ç¨‹åºè·¯ç”± | `routes/v4/system/popup-banners.js` | æ— éœ€æ”¹åŠ¨è·¯ç”±æ–‡ä»¶æœ¬èº«ï¼ŒService å±‚å˜æ›´è‡ªåŠ¨ç”Ÿæ•ˆ |
| 6 | ç®¡ç†è·¯ç”± | `routes/v4/console/popup-banners.js` | POST/PUT è¿½åŠ å‚æ•°æ ¡éªŒï¼ŒGET è¿½åŠ  banner_type ç­›é€‰ |

> **æ­¥éª¤ 5 è¯´æ˜**: å°ç¨‹åºè·¯ç”±è°ƒç”¨ `PopupBannerService.getActiveBanners()`ï¼Œè¯¥æ–¹æ³•è¿”å›çš„å­—æ®µåˆ—è¡¨åœ¨ Service å±‚æ§åˆ¶ï¼Œè·¯ç”±æ–‡ä»¶æœ¬èº«ä¸éœ€è¦æ”¹åŠ¨ã€‚

### Web ç®¡ç†åå°å‰ç«¯é€‚é…ï¼ˆæ­¥éª¤ 7-9ï¼‰

| æ­¥éª¤ | æ”¹åŠ¨æ–‡ä»¶ | è¯´æ˜ |
|---|---|---|
| 7 | `admin/src/modules/content/pages/content-management.js` | tab æ ‡ç­¾ä»"è½®æ’­å›¾ç®¡ç†"æ”¹ä¸º"å¼¹çª—ç®¡ç†" |
| 8 | `admin/src/modules/content/composables/banners.js` | æ‰€æœ‰"è½®æ’­å›¾"æ–‡æ¡ˆæ”¹ä¸º"å¼¹çª—"ï¼›`bannerForm` è¿½åŠ  5 ä¸ªæ–°å­—æ®µï¼ˆbanner_type / frequency_rule / frequency_value / force_show / priorityï¼‰ |
| 9 | `admin/content-management.html` | HTML æ¨¡æ¿"è½®æ’­å›¾"æ–‡æ¡ˆæ”¹ä¸º"å¼¹çª—"ï¼›åˆ›å»º/ç¼–è¾‘è¡¨å•è¿½åŠ  5 ä¸ªæ–°å­—æ®µçš„è¾“å…¥æ§ä»¶ |

---

## å…«ã€è”è°ƒéªŒè¯ç”¨ä¾‹

### ç”¨ä¾‹ 1: noticeï¼ˆç³»ç»Ÿå…¬å‘Šï¼‰

åˆ›å»ºæ•°æ®ï¼š`banner_type='notice', frequency_rule='once', force_show=1, priority=999`

é¢„æœŸï¼šå¼ºåˆ¶å¼¹å‡ºï¼Œä¸å¯ç‚¹é®ç½©å…³é—­ï¼Œæ˜¾ç¤º"æˆ‘çŸ¥é“äº†"æŒ‰é’®ï¼Œå…³é—­åæ°¸ä¸å†å¼¹

### ç”¨ä¾‹ 2: eventï¼ˆæ´»åŠ¨æ¨å¹¿ï¼‰

åˆ›å»ºæ•°æ®ï¼š`banner_type='event', frequency_rule='once', force_show=0, priority=100`

é¢„æœŸï¼šæ´»åŠ¨æœŸé—´å¼¹ä¸€æ¬¡ï¼Œå¯ç‚¹é®ç½©å…³é—­

### ç”¨ä¾‹ 3: promo - æ¯å¤©ä¸€æ¬¡

åˆ›å»ºæ•°æ®ï¼š`banner_type='promo', frequency_rule='once_per_day', force_show=0, priority=50`

é¢„æœŸï¼šæ¯å¤©é¦–æ¬¡è¿›å…¥å¼¹å‡ºï¼Œå…³é—­åå½“å¤©ä¸å†å¼¹

### ç”¨ä¾‹ 4: promo - æ¯ 3 å¤©ä¸€æ¬¡

åˆ›å»ºæ•°æ®ï¼š`banner_type='promo', frequency_rule='once_per_n_days', frequency_value=3, force_show=0, priority=30`

é¢„æœŸï¼šé¦–æ¬¡å¼¹å‡ºå 3 å¤©å†…ä¸å†å¼¹ï¼Œç¬¬ 4 å¤©å†å¼¹

### ç”¨ä¾‹ 5: ä¼˜å…ˆçº§ç«äº‰

åŒæ—¶å­˜åœ¨å¤šä¸ªæ´»è·ƒå¼¹çª—ï¼Œ`priority` æ•°å­—æœ€å¤§çš„æ’åœ¨æ•°ç»„ç¬¬ä¸€ä½

---

## ä¹ã€æ•°æ®æµæ¦‚è§ˆ

```
è¿è¥äººå‘˜ï¼ˆWebç®¡ç†åå° â†’ å†…å®¹ç®¡ç†ä¸­å¿ƒ â†’ "å¼¹çª—ç®¡ç†" tabï¼‰
  â”‚  æ³¨æ„ï¼šæ­¤ tab åŸå"è½®æ’­å›¾ç®¡ç†"ï¼Œéœ€æ”¹ä¸º"å¼¹çª—ç®¡ç†"ä»¥åŒ¹é…åç«¯å‘½å
  â”‚
  â”‚ POST/PUT /api/v4/console/popup-banners
  â”‚ body: { banner_type, frequency_rule, frequency_value, force_show, priority, ... }
  â–¼
åç«¯ (Express + Sequelize + MySQL)
  â”‚ popup_banners è¡¨å­˜å‚¨é…ç½®ï¼ˆä¸ system_announcements æ˜¯ç‹¬ç«‹ç³»ç»Ÿï¼‰
  â”‚ Service å±‚æ§åˆ¶å­—æ®µè¿‡æ»¤å’Œæ’åº
  â”‚ æ’åº: priority DESC, display_order ASC, created_at DESC
  â”‚ è¿‡æ»¤: is_active=true + æ—¶é—´èŒƒå›´
  â”‚ å›¾ç‰‡ URL: å¯¹è±¡ key â†’ CDN å®Œæ•´ URL
  â–¼
  â”‚ GET /api/v4/system/popup-banners â†’ 12 ä¸ªå­—æ®µ
  â–¼
å‰ç«¯ï¼ˆå¾®ä¿¡å°ç¨‹åºï¼‰
  â”‚ æ¥æ”¶åç«¯è¿”å›çš„ banner æ•°ç»„ï¼ˆå·²æŒ‰ priority æ’åºï¼‰
  â”‚ ç”¨ frequency_rule + frequency_value + æœ¬åœ°å­˜å‚¨ åšé¢‘ç‡åˆ¤æ–­
  â”‚ ç”¨ banner_type å†³å®š UI æ ·å¼ï¼ˆnotice æ˜¾ç¤º"æˆ‘çŸ¥é“äº†"ï¼‰
  â”‚ ç”¨ force_show å†³å®šé®ç½©æ˜¯å¦å¯ç‚¹å‡»å…³é—­
  â”‚ æŒ‰æ•°ç»„é¡ºåºå±•ç¤ºï¼ˆåç«¯å·²æ’å¥½åºï¼‰
  â–¼
æœ¬åœ°å­˜å‚¨: { "15": { lastSeen: 1740000000, seenCount: 3, dismissed: true } }
```

---

## åã€æ³¨æ„äº‹é¡¹

1. **é¡¹ç›®æœªä¸Šçº¿**: æ— å­˜é‡æ•°æ®å…¼å®¹å‹åŠ›ï¼Œä¸€æ¬¡æ€§åšåˆ°ä½
2. **ç°æœ‰ 2 æ¡è®°å½•**: è¿ç§»è‡ªåŠ¨å¡«å…¥é»˜è®¤å€¼ï¼ˆ`banner_type='promo'`, `frequency_rule='once_per_day'`ï¼‰ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½
3. **é¢‘ç‡åˆ¤æ–­åœ¨å®¢æˆ·ç«¯æ‰§è¡Œ**: åç«¯åªè´Ÿè´£å­˜å‚¨å’Œä¸‹å‘è§„åˆ™é…ç½®ï¼Œä¸åšé¢‘ç‡è®¡ç®—ï¼ˆå‡å°‘åç«¯çŠ¶æ€ç®¡ç†å¤æ‚åº¦ï¼‰
4. **å‰ç«¯ç›´æ¥ä½¿ç”¨åç«¯å­—æ®µå**: snake_caseï¼Œä¸åš camelCase æ˜ å°„ï¼Œä¸åšå­—æ®µé‡å‘½å
5. **å­—å…¸ä¸­æ–‡åè‡ªåŠ¨é™„åŠ **: å‰ç«¯é€šè¿‡ `_display` / `_color` åç¼€è·å–ï¼Œæ— éœ€é¢å¤–æ¥å£è°ƒç”¨
6. **å‘½åç»Ÿä¸€åŸåˆ™**: ä»¥åç«¯ `popup_banners` / "å¼¹çª—æ¨ªå¹…" å‘½åä¸ºæƒå¨ï¼ŒWeb ç®¡ç†åå°å‰ç«¯åŸæœ‰çš„"è½®æ’­å›¾"å‘½åæœ‰æ­§ä¹‰ï¼ˆè½®æ’­å›¾æŒ‡ swiper/carouselï¼Œå¼¹çª—æŒ‡ modal popupï¼Œäº¤äº’å½¢æ€å®Œå…¨ä¸åŒï¼‰ï¼Œå¿…é¡»æ”¹ä¸º"å¼¹çª—"
7. **æœ¬æ–¹æ¡ˆä¸æ¶‰åŠ `system_announcements`**: ç³»ç»Ÿå…¬å‘Šæ˜¯ç‹¬ç«‹ç³»ç»Ÿï¼ˆçº¯æ–‡å­—ã€æœåŠ¡ç«¯ view_countã€ENUM ä¼˜å…ˆçº§ï¼‰ï¼Œä¸å¼¹çª—æ¨ªå¹…ï¼ˆå›¾ç‰‡ã€å®¢æˆ·ç«¯é¢‘ç‡æ§åˆ¶ã€INT ä¼˜å…ˆçº§ï¼‰æ— åŠŸèƒ½äº¤å‰

---

## åä¸€ã€è¡Œä¸šè®¾è®¡æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰å‹

### 11.1 å¼¹çª—/è½®æ’­å›¾/å…¬å‘Šçš„æœ¬è´¨åŒºåˆ«

| | å¼¹çª— Popup | è½®æ’­å›¾ Carousel | å…¬å‘Š Announcement |
|---|---|---|---|
| äº¤äº’å½¢æ€ | æµ®å±‚è¦†ç›–é¡µé¢ï¼Œå¿…é¡»å…³é—­æ‰èƒ½ç»§ç»­ | åµŒåœ¨é¡µé¢å†…ï¼Œè‡ªåŠ¨æ»‘åŠ¨ï¼Œä¸é˜»æ–­æ“ä½œ | æ–‡å­—æ¡/åˆ—è¡¨ï¼Œç”¨æˆ·ä¸»åŠ¨æŸ¥çœ‹ |
| ç”¨æˆ·æ„Ÿå— | æ‰“æ–­å¼ï¼Œæœ‰ä¾µå…¥æ„Ÿ | æµè§ˆå¼ï¼Œè‡ªç„¶èå…¥é¡µé¢ | ä¿¡æ¯å¼ï¼Œè¢«åŠ¨æ¥æ”¶ |
| å…¸å‹ä½ç½® | å±å¹•æ­£ä¸­å¤® | é¡µé¢é¡¶éƒ¨/ä¸­éƒ¨å›ºå®šåŒºåŸŸ | é¡µé¢é¡¶éƒ¨æ»šåŠ¨æ¡æˆ–é€šçŸ¥ä¸­å¿ƒ |
| å…³é—­æ–¹å¼ | ç‚¹å…³é—­æŒ‰é’®/é®ç½© | ä¸éœ€è¦å…³é—­ï¼Œä¸€ç›´åœ¨ | ç‚¹å·²è¯»/å¿½ç•¥ |
| é¢‘ç‡æ•æ„Ÿåº¦ | æé«˜ï¼ˆå¼¹å¤ªå¤šç”¨æˆ·ä¼šå¸è½½ï¼‰ | ä½ï¼ˆä¸€ç›´å±•ç¤ºä¸æ‰“æ‰°ï¼‰ | ä¸­ç­‰ |

è¿™ä¸‰è€…åœ¨å¤§å¤šæ•°å…¬å¸æ˜¯ä¸åŒçš„ä¸œè¥¿ï¼Œä½†å¾ˆå¤šå…¬å¸ä¼šæŠŠå®ƒä»¬æ”¾åœ¨åŒä¸€ä¸ªåå°ç³»ç»Ÿé‡Œç»Ÿä¸€ç®¡ç†ã€‚

### 11.2 å››ç§è¡Œä¸šè®¾è®¡æ–¹æ¡ˆ

| æ–¹æ¡ˆ | è®¾è®¡æ€è·¯ | é€‚åˆåœºæ™¯ |
|---|---|---|
| **A. å¤§å‚ç»Ÿä¸€è¿è¥ä½** | 1 å¼ è¡¨ + `slot_type` åŒºåˆ†æ‰€æœ‰å†…å®¹ç±»å‹ï¼ˆå¼¹çª—/è½®æ’­/æ¨ªå¹…/æ‚¬æµ®æŒ‰é’®ï¼‰ï¼Œåç«¯ä¸å…³å¿ƒæ¸²æŸ“æ–¹å¼ï¼Œå‰ç«¯æ ¹æ® slot_type é€‰ç»„ä»¶ | æ—¥æ´»ç™¾ä¸‡+ï¼Œè¿è¥å›¢é˜Ÿ 10 äºº+ï¼ŒæŠ•æ”¾ä½ 20+ |
| **B. æ¸¸æˆé˜Ÿåˆ—ç³»ç»Ÿ** | å¼¹çª—æœ‰ç‹¬ç«‹çš„é˜Ÿåˆ—è°ƒåº¦å™¨ï¼ˆä¸€æ¬¡å¼¹ä¸€ä¸ªï¼Œå…³äº†å†å¼¹ä¸‹ä¸€ä¸ªï¼‰ï¼Œè½®æ’­å›¾/é€šçŸ¥å„è‡ªç‹¬ç«‹ç³»ç»Ÿ | åŒå±å¼¹çª— 5+ï¼Œéœ€è¦ä¸¥æ ¼æ’é˜Ÿï¼Œéœ€è¦æœåŠ¡ç«¯å±•ç¤ºæ—¥å¿—åšè½¬åŒ–åˆ†æ |
| **C. ç®€å•åˆ†ç¦»** | popup_banners + swiper_banners + announcements å„ä¸€å¼ è¡¨å„ç®¡å„çš„ | å°å›¢é˜Ÿï¼ŒåŠŸèƒ½æ˜ç¡® |
| **D. å¼¹çª—è½®æ’­åˆå¹¶** | ä¸€å¼  popup_banners è¡¨é€šè¿‡ `banner_type` åŒºåˆ†å¼¹çª—å’Œè½®æ’­å›¾ï¼Œå‰ç«¯æ ¹æ®ç±»å‹é€‰æ‹©æ¸²æŸ“ç»„ä»¶ | å†…å®¹é‡ < 20 æ¡ï¼Œè¿è¥ 1-3 äºº |

### 11.3 æ–¹æ¡ˆ A / B / D æ ¸å¿ƒåŒºåˆ«

| å¯¹æ¯”ç»´åº¦ | A. ç»Ÿä¸€è¿è¥ä½ | B. æ¸¸æˆé˜Ÿåˆ— | D. å¼¹çª—è½®æ’­åˆå¹¶ |
|---|---|---|---|
| è¡¨æ•°é‡ | 1 å¼ ï¼ˆæ‰€æœ‰ç±»å‹ï¼‰ | 3+ å¼ ï¼ˆå¼¹çª—/è½®æ’­/é€šçŸ¥å„ä¸€å¥—ï¼‰ | 1 å¼  popup_banners |
| å¼¹çª—æ’é˜Ÿ | æ— ä¸“é—¨é˜Ÿåˆ—ï¼Œå…±ç”¨ä¼˜å…ˆçº§æ±  | æœ‰ç‹¬ç«‹é˜Ÿåˆ—è°ƒåº¦å™¨ï¼Œä¸€æ¬¡å¼¹ä¸€ä¸ª | æœ‰ priority æ’åºï¼Œæ— é˜Ÿåˆ— |
| å±•ç¤ºæ—¥å¿— | ä¸è®°å½•æˆ–ä»…è®°"æ˜¯å¦å±•ç¤ºè¿‡" | æœåŠ¡ç«¯æ—¥å¿—è¡¨è®°å½•å±•ç¤ºæ—¶é•¿ã€å…³é—­æ–¹å¼ | å®¢æˆ·ç«¯æœ¬åœ°å­˜å‚¨ |
| æ¸²æŸ“æ§åˆ¶ | åç«¯ `render_config` JSON å­˜æ¸²æŸ“å‚æ•° | å„ç³»ç»Ÿå„è‡ªç¡¬ç¼–ç  | å‰ç«¯æ ¹æ® banner_type ç¡¬ç¼–ç  |
| æ‰©å±•æ–°ç±»å‹ | åŠ æšä¸¾å€¼ + render_config æ¨¡æ¿ | æ–°å»ºè¡¨ + æ¥å£ + ç®¡ç†é¡µ | åŠ  banner_type æšä¸¾å€¼ |
| å¼€å‘é‡ | ä¸­ï¼ˆéœ€è¦ render_config æŠ½è±¡å±‚ï¼‰ | é«˜ï¼ˆæ¯ç§ç±»å‹å…¨å¥—ï¼‰ | ä½ï¼ˆåŠ å­—æ®µå³å¯ï¼‰ |

### 11.4 æœ¬é¡¹ç›®é€‰å‹ï¼šæ–¹æ¡ˆ B + è™šæ‹Ÿè´§å¸å¹¿å‘Šå¹³å°

**æ‰€æœ‰å¹¿å‘Šä½å‡é‡‡ç”¨æ–¹æ¡ˆ B**ï¼ˆé˜Ÿåˆ—ç³»ç»Ÿ + æœåŠ¡ç«¯å±•ç¤ºæ—¥å¿— + é€ä¸ªè¿½è¸ªï¼‰ï¼ŒåŒæ—¶å»ºè®¾**å®Œæ•´çš„è™šæ‹Ÿè´§å¸å¹¿å‘Šå¹³å°**ï¼ˆç«ä»·+å®šå‘+åä½œå¼Š+DMPï¼‰ï¼Œç”¨é’»çŸ³ï¼ˆDIAMONDï¼‰ä»£æ›¿çœŸå®è´§å¸ã€‚

**æ ¸å¿ƒå†³ç­–**ï¼š

| å†³ç­–é¡¹ | ç»“è®º |
|---|---|
| å¼¹çª—å±•ç¤ºæ–¹å¼ | æ–¹æ¡ˆ B é˜Ÿåˆ—ç³»ç»Ÿï¼šä¸€ä¸ªæ¥ä¸€ä¸ªå¼¹ï¼Œå…³äº†å†å¼¹ä¸‹ä¸€ä¸ªï¼Œæœ€å¤š 5 ä¸ªæ’é˜Ÿ |
| è½®æ’­å›¾å±•ç¤ºæ–¹å¼ | æ–¹æ¡ˆ Bï¼šæŒ‰ priority æ’åºå†³å®šæ»‘åŠ¨é¡ºåºï¼Œæ¯å¼ æ»‘è¿‡éƒ½è®°å½•æœåŠ¡ç«¯å±•ç¤ºæ—¥å¿—ï¼ˆå±•ç¤ºæ—¶é•¿ã€æ˜¯å¦ç‚¹å‡»ï¼‰ï¼Œé€ä¸ªè¿½è¸ª |
| å¼¹çª—ä¸è½®æ’­å›¾ | åŒºåˆ†å¼€ï¼šå¼¹çª—æ˜¯æµ®å±‚ modalï¼ˆå¿…é¡»å…³é—­ï¼‰ï¼Œè½®æ’­å›¾æ˜¯é¡µé¢å†…åµŒ swiperï¼ˆè‡ªåŠ¨æ»‘åŠ¨ï¼‰ã€‚æ¸²æŸ“æ–¹å¼ä¸åŒï¼Œä½†éƒ½èµ°æ–¹æ¡ˆ B çš„æœåŠ¡ç«¯è¿½è¸ªå’Œä¼˜å…ˆçº§æ’åº |
| æ‰€æœ‰å›¾ç‰‡ç±»å†…å®¹ | å…¨éƒ¨æ¥å…¥å¹¿å‘Šç®¡ç†ç³»ç»Ÿç»Ÿä¸€ç®¡ç†ï¼ˆå¼¹çª—/è½®æ’­å›¾/å¹¿å‘Šä½å›¾ç‰‡ï¼‰ |
| è‡ªè¥å†…å®¹ | ä¸å†æœ‰"è‡ªè¥"æ¦‚å¿µï¼Œè¿è¥é…ç½®çš„ notice/event/promo ä¹Ÿçº³å…¥å¹¿å‘Šç³»ç»Ÿï¼Œè¿è¥åªè°ƒä¼˜å…ˆçº§æ’åº |
| è®¡è´¹æ–¹å¼ | ä¸¤ç§å¹¶å­˜ï¼šå¹¿å‘Šä¸»å¯é€‰"å›ºå®šä»·æ ¼åŒ…å¤©"ï¼ˆN é’»çŸ³=M å¤©ï¼‰æˆ–"ç«ä»·æ’å"ï¼ˆå‡ºä»·é«˜çš„ä¼˜å…ˆå±•ç¤ºï¼‰ |
| ç«ä»·å¼•æ“ | éœ€è¦ï¼šç«ä»·æ¨¡å¼ä¸‹ï¼Œå¤šä¸ªå¹¿å‘Šä¸»å‡ºä¸åŒä»·æ ¼ç«äº‰åŒä¸€å¹¿å‘Šä½ |
| äººç¾¤å®šå‘ï¼ˆDMPï¼‰ | éœ€è¦ï¼šåŸºäºç”¨æˆ·è¡Œä¸ºæ ‡ç­¾åšç²¾å‡†å®šå‘æŠ•æ”¾ |
| CPC/CPM è®¡è´¹ | ä¸éœ€è¦ï¼šä¸æŒ‰ç‚¹å‡»/æ›å…‰æ‰£è´¹ï¼ŒæŒ‰å¤©æ‰£è´¹ |
| åä½œå¼Š | éœ€è¦ï¼šé˜²æ­¢åˆ·æ›å…‰é‡è™šå‡æŠ¬é«˜å±•ç¤ºæ•°æ® |
| å½’å› è¿½è¸ª | éœ€è¦ï¼šè¿½è¸ªå¹¿å‘Šç‚¹å‡»åæ˜¯å¦äº§ç”Ÿäº†è½¬åŒ–è¡Œä¸º |
| å¹¿å‘Šä¸»åå° | éœ€è¦ï¼šç”¨æˆ·åœ¨å°ç¨‹åºå†…è‡ªåŠ©åˆ›å»ºå¹¿å‘Šã€æŸ¥çœ‹æŠ¥è¡¨ |
| ç´ æå®¡æ ¸ | éœ€è¦ï¼šç®¡ç†å‘˜äººå·¥å®¡æ ¸ |
| æ¶æ„ | å•ä½“ Node.jsï¼Œä¸æ‹†å¾®æœåŠ¡ |

**å¹¿å‘Šä½ç±»å‹**ï¼ˆç»Ÿä¸€ç®¡ç†ï¼Œå…¨éƒ¨æ–¹æ¡ˆ Bï¼‰ï¼š

| å¹¿å‘Šä½ç±»å‹ | æ¸²æŸ“æ–¹å¼ | æ–¹æ¡ˆ B ä½“ç° | æœåŠ¡ç«¯æ—¥å¿— |
|---|---|---|---|
| å¼¹çª—å¹¿å‘Šä½ | å¼¹çª— modalï¼ˆæµ®å±‚è¦†ç›–ï¼‰ | é˜Ÿåˆ—æ’åºï¼šä¸€ä¸ªæ¥ä¸€ä¸ªå¼¹ï¼Œå…³äº†å†å¼¹ä¸‹ä¸€ä¸ªï¼Œæœ€å¤š 5 ä¸ª | æ¯ä¸ªå¼¹çª—è®°å½•ï¼šå±•ç¤ºæ—¶é•¿ã€å…³é—­æ–¹å¼ã€æ˜¯å¦ç‚¹å‡»è·³è½¬ |
| è½®æ’­å›¾å¹¿å‘Šä½ | é¡µé¢å†…åµŒ swiperï¼ˆè‡ªåŠ¨æ»‘åŠ¨ï¼‰ | ä¼˜å…ˆçº§æ’åºï¼špriority é«˜çš„æ’åœ¨å‰å‡ å¼ ï¼Œå…ˆè¢«ç”¨æˆ·çœ‹åˆ° | æ¯å¼ è½®æ’­è®°å½•ï¼šæ›å…‰æ—¶é•¿ï¼ˆåœç•™åœ¨è¯¥å¼ çš„æ—¶é—´ï¼‰ã€æ˜¯å¦ç‚¹å‡»è·³è½¬ |

**è¿è¥è°ƒé…çš„å†…å®¹ç±»å‹**ï¼ˆçº³å…¥å¹¿å‘Šç³»ç»Ÿç»Ÿä¸€ç®¡ç†ï¼Œè¿è¥åªè®¾ä¼˜å…ˆçº§ï¼‰ï¼š

| å†…å®¹ç±»å‹ | å¹¿å‘Šä½ | ä¼˜å…ˆçº§èŒƒå›´ | è¯´æ˜ |
|---|---|---|---|
| `notice`ï¼ˆç³»ç»Ÿå…¬å‘Šï¼‰ | å¼¹çª— | 900-999ï¼ˆæœ€é«˜ï¼‰ | force_show=trueï¼Œç”¨æˆ·å¿…é¡»ç‚¹"æˆ‘çŸ¥é“äº†" |
| `event`ï¼ˆæ´»åŠ¨æ¨å¹¿ï¼‰ | å¼¹çª—/è½®æ’­ | 500-899 | æ´»åŠ¨æœŸé—´å±•ç¤º |
| `promo`ï¼ˆæ—¥å¸¸ä¿ƒé”€ï¼‰ | å¼¹çª—/è½®æ’­ | 100-499 | æ—¥å¸¸ä¿ƒé”€ä¿¡æ¯ |
| `user_ad`ï¼ˆå¹¿å‘Šä¸»æŠ•æ”¾ï¼‰ | å¼¹çª—/è½®æ’­ | 1-99ï¼ˆæœ€ä½ï¼‰ | å¹¿å‘Šä¸»èŠ±é’»çŸ³æŠ•æ”¾ |

**å¼¹çª—é˜Ÿåˆ—è¡Œä¸º**ï¼ˆæ–¹æ¡ˆ Bï¼‰ï¼š

```
ç”¨æˆ·æ‰“å¼€é¦–é¡µ â†’ åç«¯è¿”å›å¼¹çª—é˜Ÿåˆ—ï¼ˆæœ€å¤š 5 ä¸ªï¼ŒæŒ‰ priority DESC æ’åºï¼‰
  â†’ å¼¹å‡ºç¬¬ 1 ä¸ªï¼ˆnotice: ç³»ç»Ÿç»´æŠ¤å…¬å‘Š, priority=999ï¼‰
  â†’ ç”¨æˆ·å…³é—­ â†’ æœåŠ¡ç«¯è®°å½•ï¼šå±•ç¤º 3.2 ç§’ï¼Œç‚¹äº†"æˆ‘çŸ¥é“äº†"
  â†’ å¼¹å‡ºç¬¬ 2 ä¸ªï¼ˆevent: æ˜¥èŠ‚æ´»åŠ¨, priority=500ï¼‰
  â†’ ç”¨æˆ·å…³é—­ â†’ æœåŠ¡ç«¯è®°å½•ï¼šå±•ç¤º 1.1 ç§’ï¼Œç‚¹äº†é®ç½©å…³é—­
  â†’ å¼¹å‡ºç¬¬ 3 ä¸ªï¼ˆuser_ad: ç«ä»·èƒœå‡ºçš„å¹¿å‘Š, priority=50ï¼‰
  â†’ ç”¨æˆ·å…³é—­ â†’ æœåŠ¡ç«¯è®°å½• + è§¦å‘è®¡è´¹
  â†’ ç»ˆäºçœ‹åˆ°é¦–é¡µ
```

**è½®æ’­å›¾è¡Œä¸º**ï¼ˆæ–¹æ¡ˆ Bï¼‰ï¼š

```
é¦–é¡µåŠ è½½ â†’ åç«¯è¿”å›è½®æ’­å›¾åˆ—è¡¨ï¼ˆæŒ‰ priority DESC æ’åºï¼‰
  â†’ swiper ç»„ä»¶æŒ‰é¡ºåºè‡ªåŠ¨æ»‘åŠ¨
  â†’ ç¬¬ 1 å¼ ï¼ˆevent: æ˜¥èŠ‚æ´»åŠ¨æµ·æŠ¥, priority=600ï¼‰å±•ç¤º 3 ç§’
     â†’ æœåŠ¡ç«¯è®°å½•ï¼šæ›å…‰ 3 ç§’ï¼Œæœªç‚¹å‡»
  â†’ è‡ªåŠ¨æ»‘åˆ°ç¬¬ 2 å¼ ï¼ˆpromo: æ–°å“æ¨è, priority=300ï¼‰å±•ç¤º 3 ç§’
     â†’ æœåŠ¡ç«¯è®°å½•ï¼šæ›å…‰ 3 ç§’ï¼Œæœªç‚¹å‡»
  â†’ è‡ªåŠ¨æ»‘åˆ°ç¬¬ 3 å¼ ï¼ˆuser_ad: ç«ä»·å¹¿å‘Š, priority=50ï¼‰å±•ç¤º 3 ç§’
     â†’ æœåŠ¡ç«¯è®°å½•ï¼šæ›å…‰ 3 ç§’ + è§¦å‘è®¡è´¹
  â†’ ç”¨æˆ·æ‰‹åŠ¨æ»‘å›ç¬¬ 1 å¼  â†’ æœåŠ¡ç«¯è®°å½•ï¼šäºŒæ¬¡æ›å…‰
  â†’ ç”¨æˆ·ç‚¹å‡»ç¬¬ 1 å¼  â†’ æœåŠ¡ç«¯è®°å½•ï¼šç‚¹å‡»äº‹ä»¶ + è·³è½¬
```

---

## åäºŒã€è™šæ‹Ÿè´§å¸å¹¿å‘Šå¹³å°ï¼ˆå®Œæ•´æ–¹æ¡ˆï¼‰

### 12.1 ä¸šåŠ¡ç›®æ ‡ä¸å®šä½

å»ºè®¾å®Œæ•´çš„å¹¿å‘ŠæŠ•æ”¾å¹³å°ï¼Œæ‰€æœ‰è®¡ä»·/é¢„ç®—å‡ä½¿ç”¨è™šæ‹Ÿé’»çŸ³ï¼ˆDIAMONDï¼‰ä»£æ›¿çœŸå®è´§å¸ï¼Œä¸ºè™šæ‹Ÿé“å…·å¢åŠ æ ¸å¿ƒæ¶ˆè€—åœºæ™¯ã€‚ä¿æŒå•ä½“æ¶æ„ï¼Œä¸æ‹†å¾®æœåŠ¡ã€‚

| ç»´åº¦ | è§„æ ¼ |
|---|---|
| è´§å¸ | è™šæ‹Ÿé’»çŸ³ï¼ˆDIAMONDï¼‰ï¼Œä¸æ¶‰åŠçœŸå®è´§å¸ |
| å¹¿å‘Šä¸»è§„æ¨¡ | æ•°ä¸‡çº§ï¼ˆç”¨æˆ·è‡ªåŠ©æ³¨å†ŒæŠ•æ”¾ï¼‰ |
| ç”¨æˆ·è§„æ¨¡ | ç™¾ä¸‡çº§ |
| åœ¨æŠ•å¹¿å‘Šé‡ | æ•°åƒæ¡ |
| å†³ç­–å»¶è¿Ÿ | 3 ç§’å†… |
| QPS | æ•°ä¸‡çº§ |
| æ¶æ„ | å•ä½“ Node.jsï¼ˆç°æœ‰æ¶æ„ä¸å˜ï¼‰ |
| è®¡è´¹æ¨¡å¼ | å›ºå®šä»·æ ¼åŒ…å¤© + ç«ä»·æ’åï¼ˆå¹¿å‘Šä¸»äºŒé€‰ä¸€ï¼‰ |

### 12.2 ç°æœ‰è™šæ‹Ÿç»æµä½“ç³»ï¼ˆæ•°æ®åº“å®æŸ¥ï¼‰

| è™šæ‹Ÿèµ„äº§ | asset_code | æŒæœ‰ç”¨æˆ· | æ€»æµé€šé‡ | å¯äº¤æ˜“ | å½“å‰æ¶ˆè€—é€”å¾„ |
|---|---|---|---|---|---|
| é’»çŸ³ | `DIAMOND` | 18 äºº | 727,132 | å¯äº¤æ˜“ | æŠ½å¥–ã€C2C å¸‚åœºä¹°å…¥ã€é«˜çº§è§£é” |
| çº¢æ°´æ™¶ç¢ç‰‡ | `red_shard` | 3 äºº | 183,039 | å¯äº¤æ˜“ | å…‘æ¢å•†å“ã€C2C æŒ‚å–ã€ææ–™è½¬æ¢ |
| æ™®é€šç§¯åˆ† | `POINTS` | 7 äºº | 803,723 | ä¸å¯äº¤æ˜“ | å·²ç¦ç”¨ |
| é¢„ç®—ç§¯åˆ† | `BUDGET_POINTS` | 1 äºº | 5,187 | ä¸å¯äº¤æ˜“ | æŠ½å¥–é¢„ç®— |

ç°æœ‰ 6 ç§æ¶ˆè€—é€”å¾„ï¼Œå¹¿å‘Šå¹³å° = **ç¬¬ 7 ç§æ ¸å¿ƒæ¶ˆè€—åœºæ™¯**ã€‚

### 12.3 ä¸¤ç§è®¡è´¹æ¨¡å¼

å¹¿å‘Šä¸»åˆ›å»ºå¹¿å‘Šæ—¶äºŒé€‰ä¸€ï¼š

| æ¨¡å¼ | å¹¿å‘Šä¸»æ“ä½œ | æ‰£è´¹æ–¹å¼ | å±•ç¤ºæ’åº | é€‚åˆ |
|---|---|---|---|---|
| **å›ºå®šä»·æ ¼åŒ…å¤©** | é€‰å±•ç¤ºå¤©æ•°ï¼Œæ”¯ä»˜ N é’»çŸ³ä¹° M å¤© | åˆ›å»ºæ—¶ä¸€æ¬¡æ€§å†»ç»“é’»çŸ³ï¼Œå®¡æ ¸é€šè¿‡åæ‰£é™¤ | æŒ‰è¿è¥è®¾å®šçš„ priority æ’åº | ç¡®å®šæƒ³å±•ç¤ºã€ä¸æƒ³ç«äº‰çš„å¹¿å‘Šä¸» |
| **ç«ä»·æ’å** | è®¾æ—¥å‡ºä»·ï¼ˆå¦‚ 10 é’»çŸ³/å¤©ï¼‰ï¼Œè®¾æ€»é¢„ç®— | æ¯å¤©ä»è´¦æˆ·æ‰£æ—¥å‡ºä»·é’»çŸ³ï¼Œé¢„ç®—è€—å°½åœæŠ• | å‡ºä»·é«˜çš„ä¼˜å…ˆå±•ç¤ºï¼ˆåŒä¸€å¹¿å‘Šä½å¤šä¸ªç«ä»·å¹¿å‘Šç«äº‰ï¼‰ | æƒ³èŠ±æœ€å°‘é’±è·å¾—æœ€å¤šå±•ç¤ºçš„å¹¿å‘Šä¸» |

**ç«ä»·æ’åæµç¨‹**ï¼ˆåŒä¸€ä¸ªå¼¹çª—/è½®æ’­å¹¿å‘Šä½æœ‰å¤šä¸ªç«ä»·å¹¿å‘Šç«äº‰æ—¶ï¼‰ï¼š

```
å¼¹çª—å¹¿å‘Šä½ï¼š3 ä¸ªç«ä»·å¹¿å‘Šç«äº‰
  å¹¿å‘Šä¸»ç”² å‡ºä»· 10 é’»çŸ³/å¤©ï¼Œå®šå‘"æŠ½å¥–æ´»è·ƒç”¨æˆ·" â†’ å¯¹ç”¨æˆ· A æœ‰æ•ˆ
  å¹¿å‘Šä¸»ä¹™ å‡ºä»· 15 é’»çŸ³/å¤©ï¼Œå®šå‘"å…¨éƒ¨ç”¨æˆ·"      â†’ å¯¹ç”¨æˆ· A æœ‰æ•ˆ
  å¹¿å‘Šä¸»ä¸™ å‡ºä»· 20 é’»çŸ³/å¤©ï¼Œå®šå‘"æ–°ç”¨æˆ·"         â†’ å¯¹ç”¨æˆ· A æ— æ•ˆï¼ˆä¸æ˜¯æ–°ç”¨æˆ·ï¼‰
  â†’ ç”¨æˆ· A çœ‹åˆ°å¹¿å‘Šä¸»ä¹™çš„å¹¿å‘Šï¼ˆæœ‰æ•ˆå‡ºä»·æœ€é«˜ï¼‰

è½®æ’­å›¾å¹¿å‘Šä½ï¼šæŒ‰å‡ºä»·æ’åºå†³å®š swiper ä¸­çš„å±•ç¤ºé¡ºåº
  å‡ºä»·é«˜çš„æ’åœ¨å‰å‡ å¼ ï¼Œå‡ºä»·ä½çš„æ’åœ¨åé¢
```

### 12.4 å¹³å°å®Œæ•´åŠŸèƒ½æ¸…å•

#### å¹¿å‘Šä¸»ç«¯ï¼ˆç”¨æˆ·åœ¨å°ç¨‹åºå†…è‡ªåŠ©æ“ä½œï¼‰

| åŠŸèƒ½ | è¯´æ˜ |
|---|---|
| é’»çŸ³è´¦æˆ· | å¤ç”¨ç°æœ‰ `account_asset_balances`ï¼Œå¹¿å‘Šé¢„ç®—ä»é’»çŸ³ä½™é¢æ‰£é™¤ |
| å¹¿å‘Šåˆ›å»º | é€‰å¹¿å‘Šä½ç±»å‹ï¼ˆå¼¹çª—/è½®æ’­å›¾ï¼‰â†’ ä¸Šä¼ ç´ æï¼ˆå›¾ç‰‡ï¼‰â†’ è®¾è·³è½¬é“¾æ¥ â†’ é€‰è®¡è´¹æ¨¡å¼ï¼ˆå›ºå®šåŒ…å¤©/ç«ä»·ï¼‰â†’ è®¾å‡ºä»·æˆ–å±•ç¤ºå¤©æ•° â†’ é€‰å®šå‘äººç¾¤ â†’ æäº¤å®¡æ ¸ |
| å®šå‘è®¾ç½® | é€‰æ‹©ç›®æ ‡äººç¾¤æ ‡ç­¾ï¼ˆå…¨éƒ¨ç”¨æˆ· / æŠ½å¥–æ´»è·ƒ / æŒæœ‰ç‰¹å®šèµ„äº§ / æ–°ç”¨æˆ· ç­‰ï¼‰ |
| é¢„ç®—æ§åˆ¶ | å›ºå®šåŒ…å¤©ï¼šä¸€æ¬¡æ€§æ”¯ä»˜ï¼›ç«ä»·ï¼šè®¾æ€»é¢„ç®—ä¸Šé™ï¼ŒèŠ±å®Œè‡ªåŠ¨åœæŠ• |
| æ•°æ®æŠ¥è¡¨ | æ›å…‰æ•°ã€èŠ±è´¹é’»çŸ³æ•°ã€å¹¿å‘ŠçŠ¶æ€ |

#### å¹³å°ç«¯ï¼ˆå¹¿å‘Šå¼•æ“ï¼Œåç«¯å®ç°ï¼‰

| æ¨¡å— | è¯´æ˜ |
|---|---|
| **ç«ä»·å¼•æ“** | åŒä¸€å¹¿å‘Šä½æœ‰å¤šä¸ªç«ä»·å¹¿å‘Šæ—¶ï¼Œ3 ç§’å†…æŒ‰å‡ºä»·é«˜ä½ + å®šå‘åŒ¹é…é€‰å‡ºèƒœå‡ºè€… |
| **äººç¾¤å®šå‘ï¼ˆDMPï¼‰** | åŸºäºç”¨æˆ·è¡Œä¸ºæ ‡ç­¾åšå®šå‘ï¼šæŠ½å¥–æ´»è·ƒåº¦ã€æ¶ˆè´¹ç­‰çº§ã€æŒæœ‰èµ„äº§ç±»å‹ã€æ³¨å†Œå¤©æ•°ã€æœ€è¿‘æ´»è·ƒæ—¶é—´ã€‚åä¸‡çº§ç”¨æˆ·æ ‡ç­¾ï¼Œå®šæ—¶æ›´æ–° |
| **è®¡è´¹ç³»ç»Ÿ** | å›ºå®šåŒ…å¤©ï¼šåˆ›å»ºæ—¶å†»ç»“ â†’ å®¡æ ¸é€šè¿‡æ‰£é™¤ â†’ å®¡æ ¸æ‹’ç»é€€å›ã€‚ç«ä»·ï¼šæ¯å¤©å‡Œæ™¨æ‰£æ—¥å‡ºä»· â†’ é¢„ç®—è€—å°½åœæŠ• |
| **åä½œå¼Šç³»ç»Ÿ** | é˜²æ­¢åˆ·æ›å…‰é‡ï¼šè¯†åˆ«å¼‚å¸¸å±•ç¤ºæ¨¡å¼ã€åŒä¸€ç”¨æˆ·çŸ­æ—¶é—´å†…å¤§é‡è§¦å‘å±•ç¤ºä¸ŠæŠ¥ |
| **ç´ æå®¡æ ¸** | ç®¡ç†å‘˜åœ¨ Web åå°å®¡æ ¸å¹¿å‘Šç´ æï¼Œé€šè¿‡/æ‹’ç» |
| **å½’å› è¿½è¸ª** | è¿½è¸ªå¹¿å‘Šå±•ç¤º/ç‚¹å‡»åæ˜¯å¦äº§ç”Ÿäº†è½¬åŒ–è¡Œä¸ºï¼ˆè·³è½¬ç›®æ ‡é¡µã€å®ŒæˆæŠ½å¥–/å…‘æ¢ï¼‰ |
| **æŠ¥è¡¨ç³»ç»Ÿ** | æŒ‰å°æ—¶/å¹¿å‘Š/ç´ æ/äººç¾¤ç»´åº¦çš„å¤šç»´åˆ†æ |

#### å±•ç¤ºç«¯ï¼ˆå°ç¨‹åºï¼‰

| åŠŸèƒ½ | è¯´æ˜ |
|---|---|
| å¹¿å‘Šè¯·æ±‚ | æ‰“å¼€é¡µé¢æ—¶å‘åç«¯è¯·æ±‚å¹¿å‘Šï¼Œ3 ç§’å†…è¿”å› |
| æ›å…‰ä¸ŠæŠ¥ | å¹¿å‘Šå±•ç¤ºåä¸ŠæŠ¥æ›å…‰äº‹ä»¶ï¼ˆç”¨äºæŠ¥è¡¨å’Œåä½œå¼Šï¼‰ |
| ç‚¹å‡»ä¸ŠæŠ¥ | ç”¨æˆ·ç‚¹å‡»å¹¿å‘Šåä¸ŠæŠ¥ç‚¹å‡»äº‹ä»¶ï¼ˆç”¨äºå½’å› è¿½è¸ªï¼‰ |
| å¼¹çª—é˜Ÿåˆ— | è¿è¥å¼¹çª— + å¹¿å‘Šå¼¹çª—ç»Ÿä¸€æ’é˜Ÿï¼ŒæŒ‰ priority é¡ºåºå¼¹å‡º |
| è½®æ’­å›¾æ··æ’ | è¿è¥è½®æ’­ + å¹¿å‘Šè½®æ’­æ··æ’åœ¨ swiper ä¸­ï¼ŒæŒ‰ priority / å‡ºä»·æ’åº |

#### è¿è¥ç®¡ç†ç«¯ï¼ˆWeb åå°ï¼‰

| åŠŸèƒ½ | è¯´æ˜ |
|---|---|
| å†…å®¹ç®¡ç† | åˆ›å»º/ç¼–è¾‘ notice/event/promo ç±»å‹å†…å®¹ï¼ˆçº³å…¥å¹¿å‘Šç³»ç»Ÿç»Ÿä¸€ç®¡ç†ï¼‰ |
| ä¼˜å…ˆçº§è°ƒé… | è°ƒæ•´æ‰€æœ‰å†…å®¹ï¼ˆè¿è¥+å¹¿å‘Šï¼‰çš„ priority æ’åº |
| å¹¿å‘Šå®¡æ ¸ | å®¡æ ¸å¹¿å‘Šä¸»æäº¤çš„ç´ æï¼Œé€šè¿‡/æ‹’ç»ï¼ˆæ‹’ç»è‡ªåŠ¨é€€æ¬¾ï¼‰ |
| æ•°æ®çœ‹æ¿ | å…¨å±€å¹¿å‘Šæ•°æ®ï¼šåœ¨æŠ•æ•°é‡ã€æ€»æ›å…‰ã€æ€»æ”¶å…¥é’»çŸ³ã€å¹¿å‘Šä¸»æ•°é‡ |

### 12.5 äººç¾¤å®šå‘æ ‡ç­¾ï¼ˆåŸºäºç°æœ‰æ•°æ®å¯æå–ï¼‰

| æ ‡ç­¾ç»´åº¦ | æ•°æ®æ¥æº | æ ‡ç­¾ç¤ºä¾‹ |
|---|---|---|
| æŠ½å¥–è¡Œä¸º | `lottery_draws` è¡¨ | è¿‘ 7 å¤©æŠ½å¥– > 10 æ¬¡ã€ç´¯è®¡æŠ½å¥– > 100 æ¬¡ |
| èµ„äº§æŒæœ‰ | `account_asset_balances` è¡¨ | æŒæœ‰é’»çŸ³ > 1000ã€æŒæœ‰çº¢æ°´æ™¶ç¢ç‰‡ > 500 |
| æ¶ˆè´¹ç­‰çº§ | `asset_transactions` è¡¨ | ç´¯è®¡æ¶ˆè´¹é’»çŸ³ > 5000 |
| å…‘æ¢è¡Œä¸º | `exchange_records` è¡¨ | è¿‘ 30 å¤©å…‘æ¢ > 3 æ¬¡ |
| äº¤æ˜“è¡Œä¸º | `market_listings` / `trade_orders` è¡¨ | æœ‰è¿‡ C2C äº¤æ˜“ç»éªŒ |
| ç”¨æˆ·å±æ€§ | `users` è¡¨ | æ³¨å†Œå¤©æ•°ã€æœ€è¿‘æ´»è·ƒæ—¶é—´ã€æ˜¯å¦æ–°ç”¨æˆ· |

### 12.6 åä½œå¼Šè§„åˆ™

| è§„åˆ™ | æ£€æµ‹æ–¹å¼ | å¤„ç† |
|---|---|---|
| å¼‚å¸¸æ›å…‰é¢‘ç‡ | åŒä¸€ user_id çŸ­æ—¶é—´å†…å¯¹åŒä¸€å¹¿å‘Šè§¦å‘å¤§é‡å±•ç¤ºä¸ŠæŠ¥ | å¤šä½™çš„ä¸è®¡å…¥æ›å…‰æ•° |
| è‡ªçœ‹è‡ªå¹¿å‘Š | å¹¿å‘Šä¸»è‡ªå·±è§¦å‘è‡ªå·±å¹¿å‘Šçš„æ›å…‰ | ä¸è®¡å…¥æœ‰æ•ˆæ›å…‰ |
| æ‰¹é‡åˆ·é‡ | å¤šä¸ªè´¦å·çŸ­æ—¶é—´å†…é›†ä¸­è§¦å‘åŒä¸€å¹¿å‘Šæ›å…‰ | æ ‡è®°å¯ç–‘ï¼Œæš‚åœå¹¿å‘Š |
| è™šå‡ç‚¹å‡» | ç‚¹å‡»åæœªäº§ç”Ÿä»»ä½•é¡µé¢åœç•™æˆ–è·³è½¬è¡Œä¸º | ä¸è®¡å…¥æœ‰æ•ˆç‚¹å‡» |

### 12.7 å¯å¤ç”¨çš„ç°æœ‰åŸºç¡€è®¾æ–½

| éœ€è¦çš„èƒ½åŠ› | å¤ç”¨ä»€ä¹ˆ | è¯´æ˜ |
|---|---|---|
| é’»çŸ³æ‰£è´¹/å†»ç»“/é€€æ¬¾ | `asset_transactions` + å†»ç»“â†’æ‰£æ¬¾æµç¨‹ | å·²æœ‰å®Œæ•´çš„å†»ç»“/æ‰£æ¬¾/è§£å†»æœºåˆ¶ |
| å›¾ç‰‡ä¸Šä¼  | `PopupBannerService.uploadBannerImage()` | 400KB/JPG+PNG æ ¡éªŒã€Sealos å­˜å‚¨ã€CDN è½¬æ¢ |
| ç´ æå®¡æ ¸æµç¨‹ | ç®¡ç†åå°ç°æœ‰ CRUD + is_active å¼€å…³ | ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡/æ‹’ç» |
| å±•ç¤ºæ—¶é—´æ§åˆ¶ | `popup_banners` çš„ start_time / end_time | ç›´æ¥å¤ç”¨ |
| å¼¹çª—é¢‘ç‡æ§åˆ¶ | æœ¬æ¬¡æ–°å¢çš„ frequency_rule ä½“ç³» | è¿è¥å¼¹çª—å¤ç”¨ |
| é˜²é‡å¤æ“ä½œ | `IdempotencyService` | é˜²æ­¢é‡å¤æ‰£è´¹ |
| é€šçŸ¥ | `admin_notifications` | å®¡æ ¸é€šçŸ¥ |
| ç”¨æˆ·è¡Œä¸ºæ•°æ® | `lottery_draws` / `exchange_records` / `market_listings` / `trade_orders` | æ„å»º DMP æ ‡ç­¾çš„æ•°æ®æº |

### 12.8 éœ€è¦æ–°å»ºçš„æ¨¡å—

| æ¨¡å— | è¯´æ˜ |
|---|---|
| å¹¿å‘Šè®¡åˆ’è¡¨ `ad_campaigns` | å¹¿å‘Šä¸»åˆ›å»ºçš„æŠ•æ”¾è®¡åˆ’ï¼šå¹¿å‘Šä½ç±»å‹ï¼ˆå¼¹çª—/è½®æ’­ï¼‰ã€è®¡è´¹æ¨¡å¼ï¼ˆå›ºå®šåŒ…å¤©/ç«ä»·ï¼‰ã€å‡ºä»·ã€é¢„ç®—ã€å®šå‘è§„åˆ™ã€çŠ¶æ€ |
| å¹¿å‘Šç´ æè¡¨ `ad_creatives` | å¹¿å‘Šç´ æï¼šå›¾ç‰‡ object keyã€æ ‡é¢˜ã€è·³è½¬é“¾æ¥ã€å®¡æ ¸çŠ¶æ€ã€å®¡æ ¸å¤‡æ³¨ |
| æ›å…‰æ—¥å¿—è¡¨ `ad_impression_logs` | æœåŠ¡ç«¯è®°å½•æ¯æ¬¡æ›å…‰ï¼ˆå¹¿å‘Š IDã€ç”¨æˆ· IDã€æ—¶é—´ã€å¹¿å‘Šä½ç±»å‹ã€æ˜¯å¦æœ‰æ•ˆï¼‰ |
| ç‚¹å‡»æ—¥å¿—è¡¨ `ad_click_logs` | æœåŠ¡ç«¯è®°å½•æ¯æ¬¡ç‚¹å‡»ï¼ˆå¹¿å‘Š IDã€ç”¨æˆ· IDã€æ—¶é—´ã€è·³è½¬ç›®æ ‡ã€æ˜¯å¦æœ‰æ•ˆï¼‰ |
| å¼¹çª—å±•ç¤ºæ—¥å¿—è¡¨ `popup_show_logs` | å¼¹çª—é˜Ÿåˆ—å±•ç¤ºè®°å½•ï¼ˆå¼¹çª— IDã€å±•ç¤ºæ—¶é•¿ã€å…³é—­æ–¹å¼ï¼‰ |
| ç”¨æˆ·æ ‡ç­¾è¡¨ `user_ad_tags` | DMP ç”¨æˆ·è¡Œä¸ºæ ‡ç­¾ï¼Œå®šæ—¶ä»å„ä¸šåŠ¡è¡¨èšåˆæ›´æ–° |
| ç«ä»·å¼•æ“ `AdBiddingService` | åŒä¸€å¹¿å‘Šä½å¤šä¸ªç«ä»·å¹¿å‘Šæ—¶ï¼Œ3 ç§’å†…é€‰å‡ºèƒœå‡ºè€… |
| è®¡è´¹æœåŠ¡ `AdBillingService` | å›ºå®šåŒ…å¤©å†»ç»“/æ‰£é™¤ï¼Œç«ä»·æ—¥æ‰£è´¹ï¼Œé¢„ç®—è€—å°½åœæŠ• |
| åä½œå¼ŠæœåŠ¡ `AdAntifraudService` | è¯†åˆ«æ— æ•ˆæ›å…‰/ç‚¹å‡» |
| æ ‡ç­¾èšåˆä»»åŠ¡ `AdTagAggregationJob` | å®šæ—¶ä»»åŠ¡ï¼Œä»ä¸šåŠ¡è¡¨èšåˆç”¨æˆ·æ ‡ç­¾åˆ° `user_ad_tags` |
| å¹¿å‘ŠæŠ¥è¡¨æœåŠ¡ `AdReportService` | æŒ‰å°æ—¶/å¹¿å‘Š/ç´ æ/äººç¾¤ç»´åº¦çš„å¤šç»´åˆ†æ |
| å½’å› è¿½è¸ªæœåŠ¡ `AdAttributionService` | è¿½è¸ªå¹¿å‘Šç‚¹å‡»åçš„è½¬åŒ–è¡Œä¸º |

### 12.9 å…¨å¹¿å‘Šä½æ–¹æ¡ˆ B å±•ç¤ºæµç¨‹

```
ç”¨æˆ·æ‰“å¼€å°ç¨‹åºé¦–é¡µ
  â”‚
  â–¼
åç«¯ï¼ˆ3 ç§’å†…å®Œæˆï¼‰
  â”‚
  â”‚ === å¼¹çª—å¹¿å‘Šä½ ===
  â”‚
  â”‚ ç¬¬ 1 æ­¥ï¼šè·å–è¿è¥å¼¹çª—
  â”‚   æŸ¥è¯¢å¹¿å‘Šç³»ç»Ÿä¸­ banner_type IN (notice/event/promo)ï¼Œå¹¿å‘Šä½=å¼¹çª—ï¼Œis_active=trueï¼Œæ—¶é—´èŒƒå›´å†…
  â”‚   è¿è¥å¼¹çª—æŒ‰ priority DESC æ’åº
  â”‚
  â”‚ ç¬¬ 2 æ­¥ï¼šç«ä»·è·å–å¹¿å‘Šå¼¹çª—
  â”‚   æŸ¥è¯¢ç”¨æˆ·æ ‡ç­¾ï¼ˆuser_ad_tagsï¼‰
  â”‚   ä» ad_campaigns ä¸­å¬å›å®šå‘åŒ¹é… + å¹¿å‘Šä½=å¼¹çª— + é¢„ç®—æœªè€—å°½çš„å€™é€‰
  â”‚   å›ºå®šåŒ…å¤©å¹¿å‘Šï¼šç›´æ¥å…¥é€‰
  â”‚   ç«ä»·å¹¿å‘Šï¼šæŒ‰å‡ºä»·é«˜ä½æ’åºï¼Œé€‰å‡ºèƒœå‡ºè€…
  â”‚
  â”‚ ç¬¬ 3 æ­¥ï¼šåˆå¹¶å¼¹çª—é˜Ÿåˆ—
  â”‚   è¿è¥å¼¹çª—ï¼ˆpriority 900-999ï¼‰æ’åœ¨é˜Ÿåˆ—å‰é¢
  â”‚   å¹¿å‘Šå¼¹çª—ï¼ˆpriority 1-99ï¼‰æ’åœ¨é˜Ÿåˆ—åé¢
  â”‚   æ€»é˜Ÿåˆ—æœ€å¤š 5 ä¸ª
  â”‚
  â”‚ === è½®æ’­å›¾å¹¿å‘Šä½ ===
  â”‚
  â”‚ ç¬¬ 4 æ­¥ï¼šè·å–è¿è¥è½®æ’­
  â”‚   æŸ¥è¯¢å¹¿å‘Šç³»ç»Ÿä¸­ banner_type IN (event/promo)ï¼Œå¹¿å‘Šä½=è½®æ’­ï¼Œis_active=trueï¼Œæ—¶é—´èŒƒå›´å†…
  â”‚   æŒ‰ priority DESC æ’åº
  â”‚
  â”‚ ç¬¬ 5 æ­¥ï¼šç«ä»·è·å–å¹¿å‘Šè½®æ’­
  â”‚   ä» ad_campaigns ä¸­å¬å›å®šå‘åŒ¹é… + å¹¿å‘Šä½=è½®æ’­ + é¢„ç®—æœªè€—å°½çš„å€™é€‰
  â”‚   å›ºå®šåŒ…å¤©å¹¿å‘Šï¼šç›´æ¥å…¥é€‰
  â”‚   ç«ä»·å¹¿å‘Šï¼šæŒ‰å‡ºä»·é«˜ä½æ’åº
  â”‚
  â”‚ ç¬¬ 6 æ­¥ï¼šåˆå¹¶è½®æ’­å›¾åˆ—è¡¨
  â”‚   è¿è¥è½®æ’­æŒ‰ priority æ’åœ¨å‰é¢
  â”‚   å¹¿å‘Šè½®æ’­æŒ‰å‡ºä»·/priority æ’åœ¨åé¢
  â”‚   priority é«˜çš„æ’ç¬¬ 1 å¼ ï¼ˆç”¨æˆ·æœ€å…ˆçœ‹åˆ°ï¼‰
  â–¼
å°ç¨‹åºå‰ç«¯
  â”‚
  â”‚ å¼¹çª—é˜Ÿåˆ—ï¼ˆæ–¹æ¡ˆ Bï¼‰ï¼š
  â”‚   å¼¹ç¬¬ 1 ä¸ª â†’ ç”¨æˆ·å…³é—­ â†’ ä¸ŠæŠ¥å±•ç¤ºæ—¥å¿—ï¼ˆpopup_show_logsï¼šå±•ç¤ºæ—¶é•¿ã€å…³é—­æ–¹å¼ï¼‰
  â”‚   å¼¹ç¬¬ 2 ä¸ª â†’ ç”¨æˆ·å…³é—­ â†’ ä¸ŠæŠ¥å±•ç¤ºæ—¥å¿—
  â”‚   ...æœ€å¤šå¼¹ 5 ä¸ª
  â”‚   å¹¿å‘Šå¼¹çª—å…³é—­ â†’ é¢å¤–ä¸ŠæŠ¥ï¼ˆad_impression_logsï¼‰
  â”‚
  â”‚ è½®æ’­å›¾ï¼ˆæ–¹æ¡ˆ Bï¼‰ï¼š
  â”‚   swiper æŒ‰åç«¯è¿”å›çš„ä¼˜å…ˆçº§é¡ºåºè‡ªåŠ¨æ»‘åŠ¨
  â”‚   æ¯å¼ æ»‘è¿‡ â†’ ä¸ŠæŠ¥å±•ç¤ºæ—¥å¿—ï¼ˆcarousel_show_logsï¼šæ›å…‰æ—¶é•¿ã€æ˜¯å¦æ‰‹åŠ¨æ»‘å…¥ï¼‰
  â”‚   å¹¿å‘Šè½®æ’­æ›å…‰ â†’ é¢å¤–ä¸ŠæŠ¥ï¼ˆad_impression_logsï¼‰
  â”‚   ç”¨æˆ·æ‰‹åŠ¨æ»‘å›æŸå¼  â†’ è®°å½•äºŒæ¬¡æ›å…‰
  â”‚
  â”‚ ç‚¹å‡»è¡Œä¸ºï¼ˆå¼¹çª—å’Œè½®æ’­å›¾ç»Ÿä¸€ï¼‰ï¼š
  â”‚   ç”¨æˆ·ç‚¹å‡»ä»»æ„å†…å®¹ â†’ ä¸ŠæŠ¥ç‚¹å‡»äº‹ä»¶ï¼ˆad_click_logsï¼‰
  â”‚   åç«¯æ£€æŸ¥åä½œå¼Šè§„åˆ™ â†’ æœ‰æ•ˆç‚¹å‡»è®°å…¥å½’å› è¿½è¸ª
```

### 12.10 æ–°å»ºæ—¥å¿—è¡¨æ±‡æ€»

| æ—¥å¿—è¡¨ | è®°å½•ä»€ä¹ˆ | å¯¹åº”å¹¿å‘Šä½ |
|---|---|---|
| `popup_show_logs` | æ¯ä¸ªå¼¹çª—çš„å±•ç¤ºæ—¶é•¿ã€å…³é—­æ–¹å¼ï¼ˆå…³é—­æŒ‰é’®/é®ç½©ç‚¹å‡»/"æˆ‘çŸ¥é“äº†"ï¼‰ | å¼¹çª— |
| `carousel_show_logs` | æ¯å¼ è½®æ’­å›¾çš„æ›å…‰æ—¶é•¿ã€æ˜¯å¦æ‰‹åŠ¨æ»‘å…¥ã€åœç•™æ—¶é—´ | è½®æ’­å›¾ |
| `ad_impression_logs` | å¹¿å‘Šçš„æœ‰æ•ˆæ›å…‰ï¼ˆå»é‡åï¼‰ï¼Œç”¨äºè®¡è´¹å’ŒæŠ¥è¡¨ | å¼¹çª—+è½®æ’­å›¾ |
| `ad_click_logs` | å¹¿å‘Šçš„ç‚¹å‡»äº‹ä»¶ï¼Œç”¨äºå½’å› è¿½è¸ªå’Œåä½œå¼Š | å¼¹çª—+è½®æ’­å›¾ |

> å¼¹çª—å’Œè½®æ’­å›¾å„æœ‰ç‹¬ç«‹çš„å±•ç¤ºæ—¥å¿—è¡¨ï¼ˆè®°å½•ç”¨æˆ·äº¤äº’ç»†èŠ‚ï¼‰ï¼Œå¹¿å‘Šæ›å…‰/ç‚¹å‡»æ—¥å¿—è¡¨æ˜¯ç»Ÿä¸€çš„ï¼ˆç”¨äºè®¡è´¹å’Œåˆ†æï¼‰ã€‚

### 12.11 åˆ†é˜¶æ®µæ¼”è¿›è·¯çº¿

| é˜¶æ®µ | æ—¶æœº | åšä»€ä¹ˆ | å¯¹åº”æœ¬æ–‡æ¡£ |
|---|---|---|---|
| **é˜¶æ®µ 1ï¼ˆå½“å‰ï¼‰** | ç°åœ¨ | å¼¹çª—é¢‘ç‡æ§åˆ¶ + è½®æ’­å›¾æ”¯æŒ + å‘½åä¿®æ­£ | ç¬¬äºŒ~ä¹èŠ‚ |
| **é˜¶æ®µ 2** | é˜¶æ®µ 1 å®Œæˆå | å…¨å¹¿å‘Šä½æ–¹æ¡ˆ Bï¼šå¼¹çª—é˜Ÿåˆ—ï¼ˆæœ€å¤š 5 ä¸ªæ’é˜Ÿï¼‰+ è½®æ’­å›¾ä¼˜å…ˆçº§æ’åº + æœåŠ¡ç«¯å±•ç¤ºæ—¥å¿—ï¼ˆpopup_show_logs + carousel_show_logsï¼‰ | 11.4 |
| **é˜¶æ®µ 3** | é˜¶æ®µ 2 å®Œæˆå | å¹¿å‘ŠåŸºç¡€ç‰ˆï¼šå¹¿å‘Šä¸»è‡ªåŠ©åˆ›å»ºå¹¿å‘Šã€å›ºå®šä»·æ ¼åŒ…å¤©æŠ•æ”¾ã€ç´ æå®¡æ ¸ã€åŸºç¡€æŠ¥è¡¨ | 12.3 ~ 12.4 |
| **é˜¶æ®µ 4** | é˜¶æ®µ 3 éªŒè¯å | ç«ä»·æ’åï¼šåŒä¸€å¹¿å‘Šä½å¤šä¸ªå¹¿å‘Šç«äº‰ã€å‡ºä»·é«˜ä¼˜å…ˆå±•ç¤ºã€æ—¥æ‰£è´¹ã€é¢„ç®—æ§åˆ¶ | 12.3 ç«ä»·æ¨¡å¼ |
| **é˜¶æ®µ 5** | ç”¨æˆ·æ ‡ç­¾æ•°æ®ç§¯ç´¯å | DMP äººç¾¤å®šå‘ + åä½œå¼Šï¼šç”¨æˆ·æ ‡ç­¾ç³»ç»Ÿã€ç²¾å‡†å®šå‘æŠ•æ”¾ã€æ— æ•ˆæ›å…‰/ç‚¹å‡»æ£€æµ‹ | 12.5 ~ 12.6 |
| **é˜¶æ®µ 6** | å¹¿å‘Šæ•°æ®ç§¯ç´¯å | å½’å› è¿½è¸ª + å¤šç»´æŠ¥è¡¨ï¼šè½¬åŒ–è¿½è¸ªã€æŒ‰å°æ—¶/äººç¾¤/ç´ æäº¤å‰åˆ†æ | 12.8 |

> é˜¶æ®µ 1 çš„ `banner_type` å’Œ `priority` è®¾è®¡å·²ä¸ºåç»­é˜¶æ®µé¢„ç•™æ‰©å±•ç©ºé—´ã€‚æ¯ä¸ªé˜¶æ®µç‹¬ç«‹å¯äº¤ä»˜ï¼Œä¸ä¾èµ–åç»­é˜¶æ®µã€‚

---

## åä¸‰ã€æ‹æ¿å†³ç­–è®°å½•ï¼ˆ2026-02-18 ç¡®è®¤ï¼‰

| # | å†³ç­–é¡¹ | é€‰æ‹© | è¯´æ˜ |
|---|---|---|---|
| 1 | è½®æ’­å›¾å­˜å‚¨æ–¹å¼ | **B-åˆ†è¡¨** | æ–°å»º `carousel_items` ç‹¬ç«‹è¡¨ï¼Œå¼¹çª—/è½®æ’­å„ç®¡å„çš„ï¼Œé•¿æœŸç»´æŠ¤å¹²å‡€ |
| 2 | å¹¿å‘Šä½ç®¡ç†æ–¹å¼ | **B-åŠ¨æ€è¡¨** | æ–°å»º `ad_slots` è¡¨ï¼Œadmin å¯å¢åˆ å¹¿å‘Šä½ï¼Œæ¯ä¸ªä½å¯å•ç‹¬è®¾åº•ä»·å’Œæœ€å¤§å±•ç¤ºæ•° |
| 3 | å›ºå®šåŒ…å¤©å®šä»· | **B-æŒ‰ä½å®šä»·** | `ad_slots` è¡¨ä¸­é…ç½®æ¯ä¸ªå¹¿å‘Šä½çš„ `daily_price_diamond` |
| 4 | ç«ä»·æœ€ä½å‡ºä»· | **C-é«˜é—¨æ§›** | æœ€ä½æ—¥å‡ºä»· **50 é’»çŸ³**ï¼Œæœ€ä½æ€»é¢„ç®— **500 é’»çŸ³** |
| 5 | å¼¹çª—é˜Ÿåˆ—æ•°é‡ | **B-å¯é…ç½®** | `system_configs` è¡¨å­˜ `popup_queue_max_count`ï¼Œé»˜è®¤ **5** |
| 6 | Priority èŒƒå›´ | **C-è‡ªåŠ¨åˆ†é…+èŒƒå›´çº¦æŸ** | åç«¯æŒ‰ `banner_type` è‡ªåŠ¨åˆ†é…é»˜è®¤å€¼ï¼Œè¿è¥å¯åœ¨èŒƒå›´å†…å¾®è°ƒ |
| 7 | å½’å› çª—å£æœŸ | **A-24 å°æ—¶** | ç‚¹å‡»å¹¿å‘Šå 24 å°æ—¶å†…äº§ç”Ÿçš„è½¬åŒ–ç®—å½’å›  |
| 8 | DMP æ ‡ç­¾åˆ·æ–° | **A-æ¯å¤©å‡Œæ™¨** | `node-cron` å‡Œæ™¨ 3 ç‚¹æ‰¹é‡èšåˆç”¨æˆ·è¡Œä¸ºæ ‡ç­¾ |

### Priority è‡ªåŠ¨åˆ†é…è§„åˆ™ï¼ˆå†³ç­– 6 ç»†åŒ–ï¼‰

| banner_type / æ¥æº | é»˜è®¤ priority | å…è®¸èŒƒå›´ | è¯´æ˜ |
|---|---|---|---|
| `notice`ï¼ˆç³»ç»Ÿå…¬å‘Šï¼‰ | 950 | 900 ~ 999 | æœ€é«˜ä¼˜å…ˆçº§ï¼Œå¼ºåˆ¶å±•ç¤º |
| `event`ï¼ˆæ´»åŠ¨æ¨å¹¿ï¼‰ | 700 | 500 ~ 899 | æ´»åŠ¨æ¨å¹¿ |
| `promo`ï¼ˆæ—¥å¸¸ä¿ƒé”€ï¼‰ | 300 | 100 ~ 499 | æ—¥å¸¸å†…å®¹ |
| `user_ad`ï¼ˆå¹¿å‘Šä¸»æŠ•æ”¾ï¼‰ | 50 | 1 ~ 99 | å¹¿å‘Šä¼˜å…ˆçº§æœ€ä½ï¼Œä¸å½±å“è¿è¥å†…å®¹ |

---

## åå››ã€å…¨ 6 é˜¶æ®µåç«¯è¯¦ç»†å®æ–½æ–¹æ¡ˆ

> ä»¥ä¸‹æ–¹æ¡ˆä¸¥æ ¼å¯¹é½é¡¹ç›®ç°æœ‰æŠ€æœ¯æ ˆï¼šNode.js 20+ / Express / Sequelize 6 / MySQL / Redis / Socket.io / Sealos å¯¹è±¡å­˜å‚¨ã€‚
> API è·¯å¾„éµå¾ª `/api/v4/{domain}/` æ‰å¹³åŒ– RESTful è®¾è®¡ã€‚å“åº”æ ¼å¼ç»Ÿä¸€ä½¿ç”¨ `res.apiSuccess()` / `res.apiError()`ã€‚

### 14.0 å…¨é˜¶æ®µæ–°å»ºè¡¨æ€»è§ˆï¼ˆ13 å¼ æ–°è¡¨ï¼‰

| é˜¶æ®µ | æ–°å»ºè¡¨ | ç”¨é€” |
|---|---|---|
| 1 | `carousel_items` | è½®æ’­å›¾ç‹¬ç«‹ç®¡ç† |
| 2 | `popup_show_logs` | å¼¹çª—å±•ç¤ºæ—¥å¿— |
| 2 | `carousel_show_logs` | è½®æ’­å›¾æ›å…‰æ—¥å¿— |
| 3 | `ad_slots` | å¹¿å‘Šä½é…ç½® |
| 3 | `ad_campaigns` | å¹¿å‘ŠæŠ•æ”¾è®¡åˆ’ |
| 3 | `ad_creatives` | å¹¿å‘Šç´ æ |
| 3 | `ad_billing_records` | å¹¿å‘Šè®¡è´¹æµæ°´ |
| 5 | `user_ad_tags` | ç”¨æˆ·è¡Œä¸ºæ ‡ç­¾ï¼ˆDMPï¼‰ |
| 5 | `ad_impression_logs` | å¹¿å‘Šæ›å…‰æ—¥å¿— |
| 5 | `ad_click_logs` | å¹¿å‘Šç‚¹å‡»æ—¥å¿— |
| 5 | `ad_antifraud_logs` | åä½œå¼Šåˆ¤å®šæ—¥å¿— |
| 6 | `ad_attribution_logs` | å½’å› è¿½è¸ªæ—¥å¿— |
| 6 | `ad_report_daily_snapshots` | æ¯æ—¥æŠ¥è¡¨å¿«ç…§ |

### 14.0.1 å…¨é˜¶æ®µæ–°å»º Service æ€»è§ˆï¼ˆ12 ä¸ªæ–° Serviceï¼‰

| é˜¶æ®µ | Service | è¯´æ˜ |
|---|---|---|
| 1 | `CarouselItemService` | è½®æ’­å›¾ CRUD + å°ç¨‹åºæ¥å£ |
| 2 | `PopupShowLogService` | å¼¹çª—å±•ç¤ºæ—¥å¿—è®°å½•ä¸ç»Ÿè®¡ |
| 2 | `CarouselShowLogService` | è½®æ’­å›¾æ›å…‰æ—¥å¿—è®°å½•ä¸ç»Ÿè®¡ |
| 3 | `AdSlotService` | å¹¿å‘Šä½ç®¡ç† |
| 3 | `AdCampaignService` | å¹¿å‘Šè®¡åˆ’ç®¡ç†ï¼ˆåˆ›å»º/æäº¤/å®¡æ ¸/å–æ¶ˆï¼‰ |
| 3 | `AdCreativeService` | å¹¿å‘Šç´ æä¸Šä¼ ä¸å®¡æ ¸ |
| 3 | `AdBillingService` | é’»çŸ³å†»ç»“/æ‰£æ¬¾/é€€æ¬¾ |
| 4 | `AdBiddingService` | ç«ä»·å¼•æ“ï¼ˆé€‰å‡ºèƒœå‡ºå¹¿å‘Šï¼‰ |
| 5 | `AdTagAggregationService` | DMP æ ‡ç­¾èšåˆï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰ |
| 5 | `AdAntifraudService` | åä½œå¼Šåˆ¤å®š |
| 6 | `AdAttributionService` | å½’å› è¿½è¸ª |
| 6 | `AdReportService` | å¤šç»´æŠ¥è¡¨ç”Ÿæˆ |

### 14.0.2 å…¨é˜¶æ®µæ–°å»º Route æ–‡ä»¶æ€»è§ˆï¼ˆ6 ä¸ªæ–°è·¯ç”±ï¼‰

| é˜¶æ®µ | è·¯ç”±æ–‡ä»¶ | æŒ‚è½½è·¯å¾„ |
|---|---|---|
| 1 | `routes/v4/system/carousel-items.js` | `/api/v4/system/carousel-items` |
| 1 | `routes/v4/console/carousel-items.js` | `/api/v4/console/carousel-items` |
| 3 | `routes/v4/user/ad-campaigns.js` | `/api/v4/user/ad-campaigns` |
| 3 | `routes/v4/console/ad-campaigns.js` | `/api/v4/console/ad-campaigns` |
| 3 | `routes/v4/console/ad-slots.js` | `/api/v4/console/ad-slots` |
| 5 | `routes/v4/system/ad-events.js` | `/api/v4/system/ad-events` |

---

### 14.1 Phase 1ï¼šå¼¹çª—é¢‘ç‡æ§åˆ¶ + è½®æ’­å›¾ç‹¬ç«‹è¡¨

#### 14.1.1 è¿ç§»æ–‡ä»¶

`migrations/20260219000001-popup-frequency-and-carousel-items.js`

**ALTER `popup_banners`**ï¼šæ–°å¢ 5 åˆ— + 2 ç´¢å¼•ï¼ˆè¯¦è§ç¬¬äºŒèŠ‚ï¼Œä¸é‡å¤ï¼‰

**CREATE `carousel_items`**ï¼š

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|---|---|---|---|
| `carousel_item_id` | INT | PK AUTO_INCREMENT | ä¸»é”® |
| `title` | VARCHAR(100) | NOT NULL | æ ‡é¢˜ |
| `image_url` | VARCHAR(500) | NOT NULL | å›¾ç‰‡å¯¹è±¡ keyï¼ˆéå®Œæ•´ URLï¼‰ |
| `display_mode` | ENUM('wide','horizontal','square') | NOT NULL DEFAULT 'wide' | æ˜¾ç¤ºæ¨¡å¼ï¼ˆè½®æ’­å›¾å¸¸ç”¨å®½å±ï¼‰ |
| `image_width` | INT UNSIGNED | NULL | åŸå›¾å®½åº¦ px |
| `image_height` | INT UNSIGNED | NULL | åŸå›¾é«˜åº¦ px |
| `link_url` | VARCHAR(500) | NULL | è·³è½¬é“¾æ¥ |
| `link_type` | ENUM('none','page','miniprogram','webview') | DEFAULT 'none' | è·³è½¬ç±»å‹ |
| `position` | VARCHAR(50) | NOT NULL DEFAULT 'home' | æ˜¾ç¤ºä½ç½® |
| `is_active` | TINYINT(1) | DEFAULT 0 | æ˜¯å¦å¯ç”¨ |
| `display_order` | INT | DEFAULT 0 | æ˜¾ç¤ºé¡ºåº ASC |
| `slide_interval_ms` | INT | DEFAULT 3000 | è½®æ’­é—´éš”æ¯«ç§’ |
| `start_time` | DATETIME | NULL | å¼€å§‹å±•ç¤ºæ—¶é—´ |
| `end_time` | DATETIME | NULL | ç»“æŸå±•ç¤ºæ—¶é—´ |
| `created_by` | INT | NULL FKâ†’users.user_id | åˆ›å»ºäºº |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | |
| `updated_at` | DATETIME | ON UPDATE CURRENT_TIMESTAMP | |

ç´¢å¼•ï¼š`idx_carousel_position_active(position, is_active)`, `idx_carousel_display_order(display_order)`, `idx_carousel_time_range(start_time, end_time)`, `created_by`

**INSERT `system_configs`**ï¼š

| config_key | config_value | description |
|---|---|---|
| `popup_queue_max_count` | `5` | å¼¹çª—é˜Ÿåˆ—æœ€å¤§æ•°é‡ï¼ˆæ‹æ¿å†³ç­– 5ï¼‰ |

**INSERT `system_dictionaries`**ï¼ˆ9 æ¡æ–°å¢ï¼‰ï¼š
- `banner_type`ï¼š3 æ¡ï¼ˆnotice / event / promoï¼‰
- `banner_frequency`ï¼š6 æ¡ï¼ˆalways / once / once_per_session / once_per_day / once_per_n_days / n_times_totalï¼‰

**`displayNameHelper.js` æ³¨å†Œ**ï¼š`BANNER_TYPE: 'banner_type'`, `BANNER_FREQUENCY: 'banner_frequency'`

#### 14.1.2 Model å˜æ›´

| æ–‡ä»¶ | åŠ¨ä½œ | å†…å®¹ |
|---|---|---|
| `models/PopupBanner.js` | ä¿®æ”¹ | è¿½åŠ  5 å­—æ®µå®šä¹‰ + `byType` scope + priority é»˜è®¤å€¼é€»è¾‘ï¼ˆæŒ‰ banner_type è‡ªåŠ¨åˆ†é…ï¼Œè§å†³ç­– 6ï¼‰ |
| `models/CarouselItem.js` | **æ–°å»º** | å®Œæ•´æ¨¡å‹å®šä¹‰ï¼Œå­—æ®µ/scope/å…³è”/éªŒè¯å™¨æ¨¡å¼å¤åˆ» PopupBannerï¼Œé¢å¤–å¢åŠ  `slide_interval_ms` |

#### 14.1.3 Service å˜æ›´

| æ–‡ä»¶ | åŠ¨ä½œ | å†…å®¹ |
|---|---|---|
| `services/PopupBannerService.js` | ä¿®æ”¹ | `getActiveBanners` è¿½åŠ  5 å­—æ®µ+æ’åºæ”¹ priority DESCï¼›`getAdminBannerList` è¿½åŠ  banner_type ç­›é€‰+attachDisplayNamesï¼›`createBanner` è¿½åŠ  5 å­—æ®µ+priority è‡ªåŠ¨åˆ†é…ï¼›`updateBanner` allowedFields+5ï¼›`getStatistics` è¿½åŠ  by_type ç»´åº¦ |
| `services/CarouselItemService.js` | **æ–°å»º** | é™æ€ç±»ï¼Œå¤åˆ» PopupBannerService çš„ CRUD æ¨¡å¼ï¼ˆgetActiveCarousels / getAdminList / create / update / delete / toggle / uploadImage / getStatisticsï¼‰ï¼Œå›¾ç‰‡ä¸Šä¼ å¤ç”¨ Sealos é€»è¾‘ |
| `services/index.js` | ä¿®æ”¹ | æ³¨å†Œ `carousel_item` æœåŠ¡ |

#### 14.1.4 Route å˜æ›´

| æ–‡ä»¶ | åŠ¨ä½œ | å†…å®¹ |
|---|---|---|
| `routes/v4/console/popup-banners.js` | ä¿®æ”¹ | POST/PUT è¿½åŠ  5 å­—æ®µå‚æ•°æ ¡éªŒï¼ˆbanner_type æšä¸¾ã€frequency_rule æšä¸¾ã€frequency_value æ­£æ•´æ•°ã€force_show å¸ƒå°”ã€priority èŒƒå›´æ ¡éªŒï¼‰ï¼›GET è¿½åŠ  `?banner_type=` ç­›é€‰ |
| `routes/v4/system/popup-banners.js` | ä¸æ”¹ | Service å±‚å˜æ›´è‡ªåŠ¨ç”Ÿæ•ˆ |
| `routes/v4/system/carousel-items.js` | **æ–°å»º** | `GET /api/v4/system/carousel-items?position=home`ï¼Œè¿”å›æ´»è·ƒè½®æ’­å›¾åˆ—è¡¨ |
| `routes/v4/console/carousel-items.js` | **æ–°å»º** | å®Œæ•´ CRUD + toggle + order + statistics + å›¾ç‰‡ä¸Šä¼ ï¼Œå¤åˆ» console/popup-banners.js çš„è·¯ç”±ç»“æ„ |
| `app.js` | ä¿®æ”¹ | æ³¨å†Œ 2 ä¸ªæ–°è·¯ç”± |

#### 14.1.5 å°ç¨‹åºç«¯è½®æ’­å›¾ API å“åº”æ ¼å¼

`GET /api/v4/system/carousel-items?position=home`

```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "carousel_items": [
      {
        "carousel_item_id": 1,
        "title": "æ˜¥èŠ‚æ´»åŠ¨æµ·æŠ¥",
        "image_url": "https://objectstorageapi.bja.sealos.run/br0za7uc-tiangong/carousel/xxx.jpg",
        "display_mode": "wide",
        "image_width": 750,
        "image_height": 420,
        "link_url": "/pages/lottery/lottery",
        "link_type": "page",
        "slide_interval_ms": 3000
      }
    ]
  },
  "timestamp": "2026-02-18T12:00:00.000+08:00",
  "version": "v4",
  "request_id": "req_xxx"
}
```

è¿”å›å­—æ®µï¼ˆ8 ä¸ªï¼‰ï¼š`carousel_item_id`, `title`, `image_url`(CDN), `display_mode`, `image_width`, `image_height`, `link_url`, `link_type`, `slide_interval_ms`

ä¸è¿”å›çš„ç®¡ç†å­—æ®µï¼š`position`, `is_active`, `display_order`, `start_time`, `end_time`, `created_by`, `created_at`, `updated_at`

æ’åºè§„åˆ™ï¼š`display_order ASC, created_at DESC`

#### 14.1.6 å¯å¤ç”¨æ¸…å•

| éœ€è¦çš„èƒ½åŠ› | å¤ç”¨æ¥æº | æ”¹åŠ¨é‡ |
|---|---|---|
| å›¾ç‰‡ä¸Šä¼  + Sealos å­˜å‚¨ | `PopupBannerService.uploadBannerImage()` | æå–ä¸ºå…¬å…±æ–¹æ³• |
| CDN URL è½¬æ¢ | `_transformBannerImageUrl()` | é€šç”¨åŒ– |
| å­—å…¸ä¸­æ–‡åè‡ªåŠ¨é™„åŠ  | `displayNameHelper` + `system_dictionaries` | è¿½åŠ  2 ä¸ª dict_type æ³¨å†Œ |
| ç®¡ç†å‘˜é‰´æƒ | `adminAuthMiddleware` | ç›´æ¥å¤ç”¨ |
| å¼‚æ­¥åŒ…è£… | `asyncHandler` | ç›´æ¥å¤ç”¨ |
| å“åº”æ ¼å¼ | `res.apiSuccess()` / `res.apiError()` | ç›´æ¥å¤ç”¨ |
| æ—¶é—´å¤„ç† | `BeijingTimeHelper` | ç›´æ¥å¤ç”¨ |
| ServiceManager æ³¨å†Œ | `services/index.js` | è¿½åŠ æ³¨å†Œ |
| Multer å›¾ç‰‡ä¸Šä¼  | console/popup-banners.js çš„ multer é…ç½® | å¤åˆ» |

---

### 14.2 Phase 2ï¼šæœåŠ¡ç«¯å±•ç¤ºæ—¥å¿—ï¼ˆæ–¹æ¡ˆ B å¼¹çª—é˜Ÿåˆ— + è½®æ’­è¿½è¸ªï¼‰

#### 14.2.1 è¿ç§»æ–‡ä»¶

`migrations/20260219000002-create-show-logs.js`

**CREATE `popup_show_logs`**ï¼š

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|---|---|---|---|
| `popup_show_log_id` | BIGINT | PK AUTO_INCREMENT | ä¸»é”®ï¼ˆæ—¥å¿—é‡å¤§ç”¨ BIGINTï¼‰ |
| `popup_banner_id` | INT | NOT NULL FKâ†’popup_banners | å¼¹çª— ID |
| `user_id` | INT | NOT NULL FKâ†’users | ç”¨æˆ· ID |
| `show_duration_ms` | INT UNSIGNED | NULL | å±•ç¤ºæ—¶é•¿æ¯«ç§’ |
| `close_method` | VARCHAR(20) | NOT NULL | `close_btn` / `overlay` / `confirm_btn` / `auto_timeout` |
| `queue_position` | TINYINT UNSIGNED | NOT NULL | åœ¨é˜Ÿåˆ—ä¸­çš„ä½ç½®ï¼ˆ1~5ï¼‰ |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | ä¸ŠæŠ¥æ—¶é—´ |

ç´¢å¼•ï¼š`idx_psl_banner(popup_banner_id)`, `idx_psl_user(user_id)`, `idx_psl_created(created_at)`

**CREATE `carousel_show_logs`**ï¼š

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|---|---|---|---|
| `carousel_show_log_id` | BIGINT | PK AUTO_INCREMENT | |
| `carousel_item_id` | INT | NOT NULL FKâ†’carousel_items | è½®æ’­å›¾ ID |
| `user_id` | INT | NOT NULL FKâ†’users | |
| `exposure_duration_ms` | INT UNSIGNED | NULL | æ›å…‰æ—¶é•¿æ¯«ç§’ |
| `is_manual_swipe` | TINYINT(1) | DEFAULT 0 | ç”¨æˆ·æ˜¯å¦æ‰‹åŠ¨æ»‘å…¥ |
| `is_clicked` | TINYINT(1) | DEFAULT 0 | æ˜¯å¦ç‚¹å‡» |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | |

ç´¢å¼•ï¼š`idx_csl_item(carousel_item_id)`, `idx_csl_user(user_id)`, `idx_csl_created(created_at)`

#### 14.2.2 API è®¾è®¡

**å°ç¨‹åºç«¯ä¸ŠæŠ¥**ï¼ˆéœ€ç”¨æˆ·é‰´æƒï¼‰ï¼š

| æ–¹æ³• | è·¯å¾„ | Body | è¯´æ˜ |
|---|---|---|---|
| POST | `/api/v4/system/popup-banners/show-log` | `{ popup_banner_id, show_duration_ms, close_method, queue_position }` | å¼¹çª—å…³é—­æ—¶ä¸ŠæŠ¥ |
| POST | `/api/v4/system/carousel-items/show-log` | `{ carousel_item_id, exposure_duration_ms, is_manual_swipe, is_clicked }` | è½®æ’­å›¾ç¦»å¼€è§†å£æ—¶ä¸ŠæŠ¥ |

**ç®¡ç†åå°ç»Ÿè®¡**ï¼š

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|---|---|---|
| GET | `/api/v4/console/popup-banners/:id/show-stats` | å•å¼¹çª—å±•ç¤ºç»Ÿè®¡ï¼ˆæ€»å±•ç¤ºæ¬¡æ•°ã€å¹³å‡æ—¶é•¿ã€å…³é—­æ–¹å¼åˆ†å¸ƒï¼‰ |
| GET | `/api/v4/console/carousel-items/:id/show-stats` | å•è½®æ’­å›¾æ›å…‰ç»Ÿè®¡ï¼ˆæ€»æ›å…‰ã€ç‚¹å‡»ç‡ã€å¹³å‡æ›å…‰æ—¶é•¿ï¼‰ |

#### 14.2.3 Service å˜æ›´

| æ–‡ä»¶ | åŠ¨ä½œ | å†…å®¹ |
|---|---|---|
| `services/PopupShowLogService.js` | **æ–°å»º** | `createLog(data)` / `getShowStats(bannerId, dateRange)` / `getDailyStats(dateRange)` |
| `services/CarouselShowLogService.js` | **æ–°å»º** | `createLog(data)` / `getShowStats(itemId, dateRange)` / `getDailyStats(dateRange)` |
| `services/PopupBannerService.js` | ä¿®æ”¹ | `getActiveBanners()` è¿½åŠ é˜Ÿåˆ—æˆªæ–­é€»è¾‘ï¼šè¯»å– `system_configs.popup_queue_max_count`ï¼Œè¿”å›ä¸è¶…è¿‡ N æ¡ |
| `services/PopupBannerService.js` | ä¿®æ”¹ | `getStatistics()` è¿½åŠ å±•ç¤ºæ—¥å¿—ç»Ÿè®¡ç»´åº¦ |

#### 14.2.4 å¯å¤ç”¨æ¸…å•

| å¤ç”¨é¡¹ | æ¥æº |
|---|---|
| `system_configs` è¯»å– | é¡¹ç›®å·²æœ‰ `SystemConfigService` æˆ–ç›´æ¥æŸ¥ `system_configs` è¡¨ |
| å°ç¨‹åºç”¨æˆ·é‰´æƒ | JWT ä¸­é—´ä»¶ |
| æ—¥å¿—é‡å¤§æ—¶åˆ†é¡µæŸ¥è¯¢ | é¡¹ç›®å·²æœ‰åˆ†é¡µæ¨¡å¼ `res.apiPaginated()` |
| ServiceManager æ³¨å†Œ | `services/index.js` |

---

### 14.3 Phase 3ï¼šå¹¿å‘ŠåŸºç¡€ç‰ˆï¼ˆå¹¿å‘Šä¸»è‡ªåŠ© + å›ºå®šåŒ…å¤© + å®¡æ ¸ï¼‰

#### 14.3.1 è¿ç§»æ–‡ä»¶

`migrations/20260219000003-create-ad-system-tables.js`

**CREATE `ad_slots`**ï¼ˆå¹¿å‘Šä½é…ç½®è¡¨ï¼‰ï¼š

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|---|---|---|---|
| `ad_slot_id` | INT | PK AUTO_INCREMENT | |
| `slot_key` | VARCHAR(50) | NOT NULL UNIQUE | å¹¿å‘Šä½æ ‡è¯†ï¼Œå¦‚ `home_popup` |
| `slot_name` | VARCHAR(100) | NOT NULL | å¹¿å‘Šä½åç§°ï¼Œå¦‚ã€Œé¦–é¡µå¼¹çª—ä½ã€ |
| `slot_type` | VARCHAR(20) | NOT NULL | `popup` / `carousel` |
| `position` | VARCHAR(50) | NOT NULL | é¡µé¢ä½ç½® |
| `max_display_count` | INT | DEFAULT 3 | è¯¥ä½æ¯æ¬¡æœ€å¤šå±•ç¤ºå¹¿å‘Šæ•° |
| `daily_price_diamond` | INT | NOT NULL | å›ºå®šåŒ…å¤©æ—¥ä»·ï¼ˆé’»çŸ³ï¼‰ |
| `min_bid_diamond` | INT | NOT NULL DEFAULT 50 | ç«ä»·æœ€ä½æ—¥å‡ºä»·ï¼ˆå†³ç­– 4ï¼‰ |
| `min_budget_diamond` | INT | NOT NULL DEFAULT 500 | ç«ä»·æœ€ä½æ€»é¢„ç®—ï¼ˆå†³ç­– 4ï¼‰ |
| `is_active` | TINYINT(1) | DEFAULT 1 | æ˜¯å¦å¼€æ”¾æŠ•æ”¾ |
| `description` | VARCHAR(500) | NULL | å¹¿å‘Šä½æè¿° |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | |
| `updated_at` | DATETIME | ON UPDATE CURRENT_TIMESTAMP | |

åˆå§‹æ•°æ®ï¼ˆ4 æ¡ï¼‰ï¼š

| slot_key | slot_name | slot_type | position | daily_price_diamond |
|---|---|---|---|---|
| `home_popup` | é¦–é¡µå¼¹çª—ä½ | popup | home | 100 |
| `home_carousel` | é¦–é¡µè½®æ’­ä½ | carousel | home | 60 |
| `lottery_popup` | æŠ½å¥–é¡µå¼¹çª—ä½ | popup | lottery | 80 |
| `profile_popup` | ä¸ªäººä¸­å¿ƒå¼¹çª—ä½ | popup | profile | 50 |

**CREATE `ad_campaigns`**ï¼ˆå¹¿å‘ŠæŠ•æ”¾è®¡åˆ’è¡¨ï¼‰ï¼š

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|---|---|---|---|
| `ad_campaign_id` | INT | PK AUTO_INCREMENT | |
| `business_id` | VARCHAR(100) | NOT NULL UNIQUE | å¹‚ç­‰é”®ï¼ˆå¤ç”¨ IdempotencyServiceï¼‰ |
| `advertiser_user_id` | INT | NOT NULL FKâ†’users | å¹¿å‘Šä¸» |
| `ad_slot_id` | INT | NOT NULL FKâ†’ad_slots | æŠ•æ”¾å¹¿å‘Šä½ |
| `campaign_name` | VARCHAR(100) | NOT NULL | è®¡åˆ’åç§° |
| `billing_mode` | VARCHAR(20) | NOT NULL | `fixed_daily` / `bidding` |
| `status` | VARCHAR(20) | NOT NULL DEFAULT 'draft' | `draft` / `pending_review` / `approved` / `active` / `paused` / `completed` / `rejected` / `cancelled` |
| `daily_bid_diamond` | INT | NULL | ç«ä»·æ—¥å‡ºä»·ï¼ˆ`bidding` æ¨¡å¼ï¼‰ |
| `budget_total_diamond` | INT | NULL | æ€»é¢„ç®—ï¼ˆ`bidding` æ¨¡å¼ï¼‰ |
| `budget_spent_diamond` | INT | DEFAULT 0 | å·²æ¶ˆè€—é’»çŸ³ |
| `fixed_days` | INT | NULL | å›ºå®šåŒ…å¤©å¤©æ•° |
| `fixed_total_diamond` | INT | NULL | å›ºå®šåŒ…å¤©æ€»ä»· = daily_price Ã— days |
| `targeting_rules` | JSON | NULL | å®šå‘è§„åˆ™ï¼ˆPhase 5 å¯ç”¨ï¼‰ |
| `priority` | INT | DEFAULT 50 | å±•ç¤ºä¼˜å…ˆçº§ï¼ˆå¹¿å‘ŠèŒƒå›´ 1~99ï¼‰ |
| `start_date` | DATE | NULL | æŠ•æ”¾å¼€å§‹æ—¥æœŸ |
| `end_date` | DATE | NULL | æŠ•æ”¾ç»“æŸæ—¥æœŸ |
| `review_note` | VARCHAR(500) | NULL | å®¡æ ¸å¤‡æ³¨ |
| `reviewed_by` | INT | NULL FKâ†’users | å®¡æ ¸äºº |
| `reviewed_at` | DATETIME | NULL | å®¡æ ¸æ—¶é—´ |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | |
| `updated_at` | DATETIME | ON UPDATE CURRENT_TIMESTAMP | |

ç´¢å¼•ï¼š`idx_ac_advertiser(advertiser_user_id)`, `idx_ac_slot(ad_slot_id)`, `idx_ac_status(status)`, `idx_ac_billing_status(billing_mode, status)`, `uk_ac_business(business_id)` UNIQUE

**CREATE `ad_creatives`**ï¼ˆå¹¿å‘Šç´ æè¡¨ï¼‰ï¼š

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|---|---|---|---|
| `ad_creative_id` | INT | PK AUTO_INCREMENT | |
| `ad_campaign_id` | INT | NOT NULL FKâ†’ad_campaigns | æ‰€å±è®¡åˆ’ |
| `title` | VARCHAR(100) | NOT NULL | ç´ ææ ‡é¢˜ |
| `image_url` | VARCHAR(500) | NOT NULL | å›¾ç‰‡å¯¹è±¡ key |
| `image_width` | INT UNSIGNED | NULL | |
| `image_height` | INT UNSIGNED | NULL | |
| `link_url` | VARCHAR(500) | NULL | è·³è½¬é“¾æ¥ |
| `link_type` | VARCHAR(20) | DEFAULT 'none' | è·³è½¬ç±»å‹ |
| `review_status` | VARCHAR(20) | DEFAULT 'pending' | `pending` / `approved` / `rejected` |
| `review_note` | VARCHAR(500) | NULL | |
| `reviewed_by` | INT | NULL FKâ†’users | |
| `reviewed_at` | DATETIME | NULL | |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | |
| `updated_at` | DATETIME | ON UPDATE CURRENT_TIMESTAMP | |

ç´¢å¼•ï¼š`idx_acr_campaign(ad_campaign_id)`, `idx_acr_review(review_status)`

**CREATE `ad_billing_records`**ï¼ˆå¹¿å‘Šè®¡è´¹æµæ°´è¡¨ï¼‰ï¼š

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|---|---|---|---|
| `ad_billing_record_id` | BIGINT | PK AUTO_INCREMENT | |
| `business_id` | VARCHAR(100) | NOT NULL UNIQUE | å¹‚ç­‰é”® |
| `ad_campaign_id` | INT | NOT NULL FKâ†’ad_campaigns | |
| `advertiser_user_id` | INT | NOT NULL FKâ†’users | |
| `billing_date` | DATE | NOT NULL | è®¡è´¹æ—¥æœŸ |
| `amount_diamond` | INT | NOT NULL | é’»çŸ³é‡‘é¢ |
| `billing_type` | VARCHAR(20) | NOT NULL | `freeze` / `deduct` / `refund` / `daily_deduct` |
| `asset_transaction_id` | BIGINT | NULL | å…³è” `asset_transactions` æµæ°´ ID |
| `remark` | VARCHAR(200) | NULL | |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | |

ç´¢å¼•ï¼š`idx_abr_campaign(ad_campaign_id)`, `idx_abr_date(billing_date)`, `idx_abr_type(billing_type)`, `uk_abr_business(business_id)` UNIQUE

**INSERT `system_dictionaries`**ï¼ˆ15 æ¡æ–°å¢ï¼‰ï¼š

| dict_type | æ¡ç›® |
|---|---|
| `ad_campaign_status` | draft / pending_review / approved / active / paused / completed / rejected / cancelledï¼ˆ8 æ¡ï¼‰ |
| `ad_billing_mode` | fixed_daily / biddingï¼ˆ2 æ¡ï¼‰ |
| `ad_review_status` | pending / approved / rejectedï¼ˆ3 æ¡ï¼‰ |
| `ad_slot_type` | popup / carouselï¼ˆ2 æ¡ï¼‰ |

**`displayNameHelper.js` æ³¨å†Œ**ï¼š`AD_CAMPAIGN_STATUS`, `AD_BILLING_MODE`, `AD_REVIEW_STATUS`, `AD_SLOT_TYPE`

#### 14.3.2 API è®¾è®¡

**å¹¿å‘Šä¸»ç«¯ï¼ˆå°ç¨‹åºç”¨æˆ·æ“ä½œï¼‰** â€” æŒ‚è½½ `/api/v4/user/ad-campaigns`ï¼š

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | é‰´æƒ |
|---|---|---|---|
| GET | `/api/v4/user/ad-campaigns` | æˆ‘çš„å¹¿å‘Šè®¡åˆ’åˆ—è¡¨ï¼ˆåˆ†é¡µ+çŠ¶æ€ç­›é€‰ï¼‰ | JWT ç”¨æˆ· |
| POST | `/api/v4/user/ad-campaigns` | åˆ›å»ºå¹¿å‘Šè®¡åˆ’ï¼ˆå«ç´ æä¸Šä¼ ï¼‰ | JWT ç”¨æˆ· |
| GET | `/api/v4/user/ad-campaigns/:id` | è®¡åˆ’è¯¦æƒ… | JWT ç”¨æˆ·ï¼ˆåªèƒ½çœ‹è‡ªå·±çš„ï¼‰ |
| PUT | `/api/v4/user/ad-campaigns/:id` | æ›´æ–°è‰ç¨¿çŠ¶æ€çš„è®¡åˆ’ | JWT ç”¨æˆ· |
| POST | `/api/v4/user/ad-campaigns/:id/submit` | æäº¤å®¡æ ¸ï¼ˆå›ºå®šåŒ…å¤©ï¼šå†»ç»“é’»çŸ³ï¼‰ | JWT ç”¨æˆ· |
| POST | `/api/v4/user/ad-campaigns/:id/cancel` | å–æ¶ˆè®¡åˆ’ï¼ˆé€€å›å†»ç»“çš„é’»çŸ³ï¼‰ | JWT ç”¨æˆ· |
| GET | `/api/v4/user/ad-campaigns/:id/report` | è®¡åˆ’æ•°æ®æŠ¥è¡¨ | JWT ç”¨æˆ· |

**ç®¡ç†åå°** â€” æŒ‚è½½ `/api/v4/console/ad-campaigns` å’Œ `/api/v4/console/ad-slots`ï¼š

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | é‰´æƒ |
|---|---|---|---|
| GET | `/api/v4/console/ad-campaigns` | å…¨éƒ¨å¹¿å‘Šè®¡åˆ’ï¼ˆåˆ†é¡µ+çŠ¶æ€+å¹¿å‘Šä½ç­›é€‰ï¼‰ | adminAuth |
| GET | `/api/v4/console/ad-campaigns/:id` | è®¡åˆ’è¯¦æƒ…ï¼ˆå«ç´ æ+è®¡è´¹è®°å½•ï¼‰ | adminAuth |
| PATCH | `/api/v4/console/ad-campaigns/:id/review` | å®¡æ ¸é€šè¿‡/æ‹’ç»ï¼ˆé€šè¿‡â†’æ‰£æ¬¾ï¼Œæ‹’ç»â†’é€€æ¬¾ï¼‰ | adminAuth |
| GET | `/api/v4/console/ad-slots` | å¹¿å‘Šä½åˆ—è¡¨ | adminAuth |
| POST | `/api/v4/console/ad-slots` | æ–°å»ºå¹¿å‘Šä½ | adminAuth |
| PUT | `/api/v4/console/ad-slots/:id` | ç¼–è¾‘å¹¿å‘Šä½ï¼ˆæ—¥ä»·/æœ€ä½å‡ºä»·ç­‰ï¼‰ | adminAuth |
| PATCH | `/api/v4/console/ad-slots/:id/toggle` | å¼€å…³å¹¿å‘Šä½ | adminAuth |
| GET | `/api/v4/console/ad-dashboard` | å¹¿å‘Šæ€»è§ˆé¢æ¿ | adminAuth |

**å›ºå®šåŒ…å¤©è®¡è´¹æµç¨‹**ï¼š
```
å¹¿å‘Šä¸»åˆ›å»ºè®¡åˆ’(draft) â†’ æäº¤å®¡æ ¸(pending_review, å†»ç»“ fixed_total_diamond é’»çŸ³)
  â†’ ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡(approved â†’ active, å†»ç»“é’»çŸ³æ­£å¼æ‰£é™¤)
  â†’ åˆ°æœŸè‡ªåŠ¨å®Œæˆ(completed)
  â†’ ç®¡ç†å‘˜å®¡æ ¸æ‹’ç»(rejected, å†»ç»“é’»çŸ³é€€å›)
  â†’ å¹¿å‘Šä¸»å–æ¶ˆ(cancelled, å†»ç»“é’»çŸ³é€€å›)
```

#### 14.3.3 å¯å¤ç”¨æ¸…å•

| éœ€è¦çš„èƒ½åŠ› | å¤ç”¨æ¥æº | è¯´æ˜ |
|---|---|---|
| **é’»çŸ³å†»ç»“/æ‰£æ¬¾/é€€å›** | `asset_transactions` + `account_asset_balances` çš„ `available_amount` / `frozen_amount` æœºåˆ¶ | ç°æœ‰å†»ç»“â†’æ‰£æ¬¾â†’è§£å†»æµç¨‹ï¼Œæ ¸å¿ƒå¤ç”¨ |
| **å›¾ç‰‡ä¸Šä¼ ** | `PopupBannerService.uploadBannerImage()` çš„ Sealos é€»è¾‘ | ç´ æä¸Šä¼ å¤ç”¨ |
| **å¹‚ç­‰æ€§** | `IdempotencyService` + `api_idempotency_requests` | é˜²é‡å¤æ‰£è´¹ |
| **ç®¡ç†å‘˜é€šçŸ¥** | `admin_notifications` è¡¨ | æ–°å¹¿å‘Šå®¡æ ¸é€šçŸ¥ |
| **å­—å…¸ä½“ç³»** | `system_dictionaries` + `displayNameHelper` | çŠ¶æ€ä¸­æ–‡å |
| **åˆ†é¡µå“åº”** | `res.apiPaginated()` | åˆ—è¡¨æ¥å£ |

---

### 14.4 Phase 4ï¼šç«ä»·æ’å

#### 14.4.1 è¿ç§»æ–‡ä»¶

`migrations/20260219000004-create-bid-logs.js`

**CREATE `ad_bid_logs`**ï¼ˆç«ä»·è®°å½•è¡¨ï¼‰ï¼š

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|---|---|---|---|
| `ad_bid_log_id` | BIGINT | PK AUTO_INCREMENT | |
| `ad_slot_id` | INT | NOT NULL FKâ†’ad_slots | ç«äº‰çš„å¹¿å‘Šä½ |
| `ad_campaign_id` | INT | NOT NULL FKâ†’ad_campaigns | å‚ä¸ç«ä»·çš„è®¡åˆ’ |
| `bid_amount_diamond` | INT | NOT NULL | å‡ºä»·ï¼ˆé’»çŸ³ï¼‰ |
| `is_winner` | TINYINT(1) | NOT NULL | æ˜¯å¦èƒœå‡º |
| `target_user_id` | INT | NOT NULL FKâ†’users | ç›®æ ‡ç”¨æˆ· |
| `lose_reason` | VARCHAR(50) | NULL | è½é€‰åŸå› ï¼š`outbid` / `targeting_mismatch` / `budget_exhausted` |
| `bid_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | |

ç´¢å¼•ï¼š`idx_abl_slot_time(ad_slot_id, bid_at)`, `idx_abl_campaign(ad_campaign_id)`, `idx_abl_user(target_user_id)`

#### 14.4.2 æ ¸å¿ƒ Service

**`services/AdBiddingService.js`**ï¼ˆæ–°å»ºï¼‰ï¼š

æ ¸å¿ƒæ–¹æ³• `selectWinners(slotKey, userId)`ï¼Œ3 ç§’å†…å®Œæˆï¼š
1. æŸ¥ `ad_slots` è·å–å¹¿å‘Šä½é…ç½®ï¼ˆ`max_display_count`, `min_bid_diamond`ï¼‰
2. æŸ¥ `ad_campaigns` å¬å›å€™é€‰ï¼š`ad_slot_id` åŒ¹é… + `status='active'` + æ—¥æœŸèŒƒå›´å†… + `budget_spent < budget_total`
3. åˆ†ç±»å¤„ç†ï¼š
   - `fixed_daily`ï¼šç›´æ¥å…¥é€‰ï¼ˆå·²ä»˜è´¹ï¼‰
   - `bidding`ï¼šæŒ‰ `daily_bid_diamond DESC` æ’åº
4. Phase 5 å¯ç”¨åï¼šå¢åŠ  `targeting_rules` ä¸ `user_ad_tags` åŒ¹é…è¿‡æ»¤
5. æˆªæ–­åˆ° `max_display_count` æ¡
6. å†™å…¥ `ad_bid_logs`ï¼ˆèƒœå‡º+è½é€‰å‡è®°å½•ï¼‰
7. è¿”å›èƒœå‡ºçš„å¹¿å‘Šåˆ—è¡¨

#### 14.4.3 å®šæ—¶ä»»åŠ¡ï¼šç«ä»·æ—¥æ‰£è´¹

**`AdBillingService` æ–°å¢æ–¹æ³•**ï¼š`processDailyBidding()`

- æ‰§è¡Œæ—¶æœºï¼š`node-cron` å‡Œæ™¨ 1 ç‚¹
- é€»è¾‘ï¼š
  1. æŸ¥æ‰€æœ‰ `billing_mode='bidding'` + `status='active'` çš„ campaign
  2. å¯¹æ¯ä¸ª campaign æ‰£ `daily_bid_diamond` é’»çŸ³
  3. `budget_spent += daily_bid_diamond`
  4. è‹¥ `budget_spent >= budget_total`ï¼Œè‡ªåŠ¨ `status='completed'`ï¼ˆé¢„ç®—è€—å°½ï¼‰
  5. æ‰£è´¹å¤±è´¥ï¼ˆä½™é¢ä¸è¶³ï¼‰åˆ™ `status='paused'`
  6. æ¯ç¬”æ‰£è´¹å†™å…¥ `ad_billing_records`ï¼ˆ`billing_type='daily_deduct'`ï¼‰

#### 14.4.4 ä¿®æ”¹å†…å®¹åˆ†å‘é€»è¾‘

**`PopupBannerService.getActiveBanners(position, userId)`**ï¼š
1. æŸ¥è¿è¥å¼¹çª—ï¼ˆç°æœ‰é€»è¾‘ï¼Œpriority 900~999 èŒƒå›´ï¼‰
2. è°ƒ `AdBiddingService.selectWinners('home_popup', userId)` è·å–å¹¿å‘Šå¼¹çª—
3. å°†å¹¿å‘Š creative æ•°æ®æ˜ å°„ä¸ºä¸å¼¹çª—ç›¸åŒçš„å“åº”ç»“æ„
4. åˆå¹¶é˜Ÿåˆ—ï¼šè¿è¥å¼¹çª—åœ¨å‰ + å¹¿å‘Šå¼¹çª—åœ¨åï¼ˆæŒ‰ priority ç»Ÿä¸€æ’åºï¼‰
5. æˆªæ–­åˆ° `popup_queue_max_count`

**`CarouselItemService.getActiveCarousels(position, userId)`**ï¼š
åŒç†ï¼Œåˆå¹¶è¿è¥è½®æ’­ + å¹¿å‘Šè½®æ’­

#### 14.4.5 å¯å¤ç”¨æ¸…å•

| å¤ç”¨é¡¹ | æ¥æº |
|---|---|
| é’»çŸ³æ‰£æ¬¾ | `asset_transactions` å†»ç»“â†’æ‰£æ¬¾æœºåˆ¶ |
| å®šæ—¶ä»»åŠ¡æ¡†æ¶ | `node-cron`ï¼ˆpackage.json å·²æœ‰ä¾èµ–ï¼‰ |
| å¹‚ç­‰æ€§ | `IdempotencyService` é˜²é‡å¤æ‰£è´¹ |

---

### 14.5 Phase 5ï¼šDMP äººç¾¤å®šå‘ + åä½œå¼Š

#### 14.5.1 è¿ç§»æ–‡ä»¶

`migrations/20260219000005-create-dmp-and-antifraud.js`

**CREATE `user_ad_tags`**ï¼ˆç”¨æˆ·è¡Œä¸ºæ ‡ç­¾è¡¨ï¼‰ï¼š

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|---|---|---|---|
| `user_ad_tag_id` | BIGINT | PK AUTO_INCREMENT | |
| `user_id` | INT | NOT NULL FKâ†’users | |
| `tag_key` | VARCHAR(50) | NOT NULL | æ ‡ç­¾é”® |
| `tag_value` | VARCHAR(100) | NOT NULL | æ ‡ç­¾å€¼ |
| `calculated_at` | DATETIME | NOT NULL | è®¡ç®—æ—¶é—´ |

å”¯ä¸€çº¦æŸï¼š`uk_uat_user_tag(user_id, tag_key)`
ç´¢å¼•ï¼š`idx_uat_tag(tag_key, tag_value)`

**æ ‡ç­¾å®šä¹‰ï¼ˆåŸºäºç°æœ‰ 79 å¼ è¡¨å¯æå–ï¼‰**ï¼š

| tag_key | æ•°æ®æ¥æºè¡¨ | è®¡ç®—é€»è¾‘ | tag_value ç¤ºä¾‹ |
|---|---|---|---|
| `lottery_active_7d` | `lottery_draws` | è¿‘ 7 å¤©æŠ½å¥–æ¬¡æ•° > 10 | `true` / `false` |
| `lottery_active_30d` | `lottery_draws` | è¿‘ 30 å¤©æŠ½å¥–æ¬¡æ•° > 50 | `true` / `false` |
| `lottery_total_count` | `lottery_draws` | ç´¯è®¡æŠ½å¥–æ¬¡æ•° | æ•°å­—å­—ç¬¦ä¸² |
| `diamond_balance` | `account_asset_balances` | é’»çŸ³æŒæœ‰é‡ | æ•°å­—å­—ç¬¦ä¸² |
| `diamond_rich` | `account_asset_balances` | æŒæœ‰é’»çŸ³ > 1000 | `true` / `false` |
| `has_red_shard` | `account_asset_balances` | æŒæœ‰çº¢æ°´æ™¶ç¢ç‰‡ > 0 | `true` / `false` |
| `market_trader` | `market_listings` + `trade_orders` | æœ‰è¿‡ C2C äº¤æ˜“ | `true` / `false` |
| `new_user` | `users` | æ³¨å†Œ < 7 å¤© | `true` / `false` |
| `active_7d` | `users` / `user_behavior_tracks` | æœ€è¿‘ 7 å¤©æœ‰æ´»è·ƒ | `true` / `false` |
| `register_days` | `users` | æ³¨å†Œå¤©æ•° | æ•°å­—å­—ç¬¦ä¸² |

**CREATE `ad_impression_logs`**ï¼ˆå¹¿å‘Šæ›å…‰æ—¥å¿—ï¼‰ï¼š

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|---|---|---|---|
| `ad_impression_log_id` | BIGINT | PK AUTO_INCREMENT | |
| `ad_campaign_id` | INT | NOT NULL FK | |
| `user_id` | INT | NOT NULL FK | |
| `ad_slot_id` | INT | NOT NULL FK | |
| `is_valid` | TINYINT(1) | DEFAULT 1 | åä½œå¼Šåˆ¤å®šç»“æœ |
| `invalid_reason` | VARCHAR(50) | NULL | `self_view` / `frequency_limit` / `batch_suspect` |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | |

ç´¢å¼•ï¼š`idx_ail_campaign(ad_campaign_id)`, `idx_ail_user(user_id)`, `idx_ail_created(created_at)`

**CREATE `ad_click_logs`**ï¼ˆå¹¿å‘Šç‚¹å‡»æ—¥å¿—ï¼‰ï¼š

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|---|---|---|---|
| `ad_click_log_id` | BIGINT | PK AUTO_INCREMENT | |
| `ad_campaign_id` | INT | NOT NULL FK | |
| `user_id` | INT | NOT NULL FK | |
| `ad_slot_id` | INT | NOT NULL FK | |
| `click_target` | VARCHAR(500) | NULL | è·³è½¬ç›®æ ‡ |
| `is_valid` | TINYINT(1) | DEFAULT 1 | åä½œå¼Šåˆ¤å®šç»“æœ |
| `invalid_reason` | VARCHAR(50) | NULL | `fake_click` / `self_click` |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | |

ç´¢å¼•ï¼š`idx_acl_campaign(ad_campaign_id)`, `idx_acl_user_created(user_id, created_at)`

**CREATE `ad_antifraud_logs`**ï¼ˆåä½œå¼Šåˆ¤å®šæ—¥å¿—ï¼‰ï¼š

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|---|---|---|---|
| `ad_antifraud_log_id` | BIGINT | PK AUTO_INCREMENT | |
| `user_id` | INT | NOT NULL | |
| `ad_campaign_id` | INT | NOT NULL | |
| `event_type` | VARCHAR(20) | NOT NULL | `impression` / `click` |
| `rule_triggered` | VARCHAR(50) | NOT NULL | è§¦å‘çš„è§„åˆ™ |
| `verdict` | VARCHAR(20) | NOT NULL | `valid` / `invalid` / `suspicious` |
| `raw_data` | JSON | NULL | åŸå§‹äº‹ä»¶æ•°æ® |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | |

ç´¢å¼•ï¼š`idx_aaf_user(user_id)`, `idx_aaf_campaign(ad_campaign_id)`

#### 14.5.2 API è®¾è®¡

**å°ç¨‹åºç«¯äº‹ä»¶ä¸ŠæŠ¥** â€” æŒ‚è½½ `/api/v4/system/ad-events`ï¼š

| æ–¹æ³• | è·¯å¾„ | Body | è¯´æ˜ |
|---|---|---|---|
| POST | `/api/v4/system/ad-events/impression` | `{ ad_campaign_id, ad_slot_id }` | å¹¿å‘Šæ›å…‰ä¸ŠæŠ¥ |
| POST | `/api/v4/system/ad-events/click` | `{ ad_campaign_id, ad_slot_id, click_target }` | å¹¿å‘Šç‚¹å‡»ä¸ŠæŠ¥ |

#### 14.5.3 æ ¸å¿ƒ Service

**`services/AdTagAggregationService.js`**ï¼ˆæ–°å»ºï¼‰ï¼š
- `aggregateAllUserTags()`ï¼š`node-cron` å‡Œæ™¨ 3 ç‚¹æ‰§è¡Œï¼Œéå†æ‰€æœ‰æ´»è·ƒç”¨æˆ·ï¼Œä» `lottery_draws` / `account_asset_balances` / `market_listings` / `trade_orders` / `users` èšåˆæ ‡ç­¾å†™å…¥ `user_ad_tags`
- `getUserTags(userId)`ï¼šè·å–å•ä¸ªç”¨æˆ·çš„å…¨éƒ¨æ ‡ç­¾ï¼ˆä¾›ç«ä»·å¼•æ“è°ƒç”¨ï¼‰

**`services/AdAntifraudService.js`**ï¼ˆæ–°å»ºï¼‰ï¼š
- `checkImpression(userId, campaignId)`ï¼š
  - è§„åˆ™ 1ï¼šå¹¿å‘Šä¸»çœ‹è‡ªå·±å¹¿å‘Š â†’ `self_view` â†’ invalid
  - è§„åˆ™ 2ï¼šåŒä¸€ç”¨æˆ· 10 åˆ†é’Ÿå†…å¯¹åŒä¸€å¹¿å‘Šè§¦å‘ > 3 æ¬¡ â†’ `frequency_limit` â†’ invalid
  - è§„åˆ™ 3ï¼šåŒä¸€å¹¿å‘Š 1 åˆ†é’Ÿå†…è¢« > 20 ä¸ªä¸åŒç”¨æˆ·æ›å…‰ â†’ `batch_suspect` â†’ suspicious
- `checkClick(userId, campaignId)`ï¼š
  - è§„åˆ™ 1ï¼šå¹¿å‘Šä¸»ç‚¹å‡»è‡ªå·±å¹¿å‘Š â†’ `self_click` â†’ invalid
  - è§„åˆ™ 2ï¼šç‚¹å‡»å 0 ç§’å†…æ— é¡µé¢åœç•™ â†’ `fake_click` â†’ invalid

**ä¿®æ”¹ `AdBiddingService.selectWinners()`**ï¼š
- ç¬¬ 4 æ­¥å¢åŠ ï¼šè°ƒ `AdTagAggregationService.getUserTags(userId)`ï¼Œç”¨ `targeting_rules` JSON åŒ¹é…ç”¨æˆ·æ ‡ç­¾ï¼Œä¸åŒ¹é…çš„å€™é€‰å‰”é™¤

#### 14.5.4 targeting_rules JSON æ ¼å¼

å­˜å‚¨åœ¨ `ad_campaigns.targeting_rules` å­—æ®µä¸­ï¼š

```json
{
  "match_all": [
    { "tag_key": "lottery_active_7d", "operator": "eq", "value": "true" },
    { "tag_key": "diamond_balance", "operator": "gte", "value": "500" }
  ],
  "match_any": [
    { "tag_key": "new_user", "operator": "eq", "value": "true" },
    { "tag_key": "market_trader", "operator": "eq", "value": "true" }
  ]
}
```

- `match_all`ï¼šæ‰€æœ‰æ¡ä»¶éƒ½æ»¡è¶³æ‰æŠ•æ”¾ï¼ˆANDï¼‰
- `match_any`ï¼šä»»ä¸€æ¡ä»¶æ»¡è¶³å³æŠ•æ”¾ï¼ˆORï¼‰
- ä¸¤è€…åŒæ—¶å­˜åœ¨æ—¶ï¼š`match_all AND match_any`
- ä¸ºç©º/null æ—¶ï¼šæŠ•æ”¾ç»™æ‰€æœ‰ç”¨æˆ·

#### 14.5.5 å¯å¤ç”¨æ¸…å•

| å¤ç”¨é¡¹ | æ¥æº |
|---|---|
| `lottery_draws` æ•°æ® | ç°æœ‰ 2,280 æ¡ï¼Œç›´æ¥èšåˆ |
| `account_asset_balances` | ç°æœ‰èµ„äº§æ•°æ® |
| `market_listings` / `trade_orders` | ç°æœ‰ 281 æ¡ + äº¤æ˜“æ•°æ® |
| `users` æ³¨å†Œæ—¶é—´ | 60 ä¸ªç”¨æˆ· |
| `node-cron` å®šæ—¶ä»»åŠ¡ | package.json å·²æœ‰ä¾èµ– |
| `admin_notifications` | åä½œå¼Šè§¦å‘æ—¶é€šçŸ¥ç®¡ç†å‘˜ |

---

### 14.6 Phase 6ï¼šå½’å› è¿½è¸ª + å¤šç»´æŠ¥è¡¨

#### 14.6.1 è¿ç§»æ–‡ä»¶

`migrations/20260219000006-create-attribution-and-reports.js`

**CREATE `ad_attribution_logs`**ï¼ˆå½’å› è¿½è¸ªæ—¥å¿—ï¼‰ï¼š

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|---|---|---|---|
| `ad_attribution_log_id` | BIGINT | PK AUTO_INCREMENT | |
| `ad_click_log_id` | BIGINT | NOT NULL FKâ†’ad_click_logs | å…³è”çš„ç‚¹å‡» |
| `ad_campaign_id` | INT | NOT NULL FK | |
| `user_id` | INT | NOT NULL FK | |
| `conversion_type` | VARCHAR(30) | NOT NULL | `lottery_draw` / `exchange` / `market_buy` / `page_view` |
| `conversion_entity_id` | VARCHAR(100) | NULL | è½¬åŒ–å®ä½“ IDï¼ˆå¦‚ draw_id / exchange_record_idï¼‰ |
| `click_at` | DATETIME | NOT NULL | ç‚¹å‡»æ—¶é—´ |
| `conversion_at` | DATETIME | NOT NULL | è½¬åŒ–æ—¶é—´ |
| `attribution_window_hours` | INT | DEFAULT 24 | å½’å› çª—å£ï¼ˆå†³ç­– 7ï¼‰ |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | |

ç´¢å¼•ï¼š`idx_aal_campaign(ad_campaign_id)`, `idx_aal_user(user_id)`, `idx_aal_type(conversion_type)`, `idx_aal_click_at(click_at)`

**CREATE `ad_report_daily_snapshots`**ï¼ˆæ¯æ—¥æŠ¥è¡¨å¿«ç…§ï¼‰ï¼š

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|---|---|---|---|
| `snapshot_id` | BIGINT | PK AUTO_INCREMENT | |
| `snapshot_date` | DATE | NOT NULL | å¿«ç…§æ—¥æœŸ |
| `ad_campaign_id` | INT | NOT NULL FK | |
| `ad_slot_id` | INT | NOT NULL FK | |
| `impressions_total` | INT | DEFAULT 0 | æ€»æ›å…‰ |
| `impressions_valid` | INT | DEFAULT 0 | æœ‰æ•ˆæ›å…‰ |
| `clicks_total` | INT | DEFAULT 0 | æ€»ç‚¹å‡» |
| `clicks_valid` | INT | DEFAULT 0 | æœ‰æ•ˆç‚¹å‡» |
| `conversions` | INT | DEFAULT 0 | è½¬åŒ–æ•° |
| `spend_diamond` | INT | DEFAULT 0 | æ¶ˆè€—é’»çŸ³ |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | |

å”¯ä¸€çº¦æŸï¼š`uk_ards_date_campaign_slot(snapshot_date, ad_campaign_id, ad_slot_id)`

#### 14.6.2 æ ¸å¿ƒ Service

**`services/AdAttributionService.js`**ï¼ˆæ–°å»ºï¼‰ï¼š
- `checkConversion(userId, conversionType, entityId)`ï¼š
  1. æŸ¥ `ad_click_logs` æœ€è¿‘ 24 å°æ—¶å†…è¯¥ç”¨æˆ·æ˜¯å¦æœ‰æœ‰æ•ˆçš„å¹¿å‘Šç‚¹å‡»
  2. è‹¥æœ‰ â†’ å†™å…¥ `ad_attribution_logs`
  3. åµŒå…¥ç‚¹ï¼šæŠ½å¥–å®Œæˆ(`lottery_draw`)ã€å…‘æ¢å®Œæˆ(`exchange`)ã€å¸‚åœºäº¤æ˜“å®Œæˆ(`market_buy`) çš„ä¸šåŠ¡å›è°ƒä¸­è°ƒç”¨

**`services/AdReportService.js`**ï¼ˆæ–°å»ºï¼‰ï¼š
- `generateDailySnapshot(date)`ï¼š`node-cron` å‡Œæ™¨ 4 ç‚¹æ‰§è¡Œï¼ˆåœ¨æ ‡ç­¾èšåˆä¹‹åï¼‰ï¼Œèšåˆå‰ä¸€å¤©çš„æ›å…‰/ç‚¹å‡»/è½¬åŒ–/æ¶ˆè€—æ•°æ®å†™å…¥ `ad_report_daily_snapshots`
- `getCampaignReport(campaignId, startDate, endDate)`ï¼šå•è®¡åˆ’å¤šæ—¥æŠ¥è¡¨
- `getSlotReport(slotId, startDate, endDate)`ï¼šå•å¹¿å‘Šä½å¤šæ—¥æŠ¥è¡¨
- `getDashboardOverview(startDate, endDate)`ï¼šå…¨å±€æ±‡æ€»

#### 14.6.3 API è®¾è®¡

**ç®¡ç†åå°æŠ¥è¡¨**ï¼š

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|---|---|---|
| GET | `/api/v4/console/ad-reports/overview?start_date=&end_date=` | å…¨å±€å¹¿å‘Šæ•°æ®æ€»è§ˆ |
| GET | `/api/v4/console/ad-reports/campaigns/:id?start_date=&end_date=` | å•è®¡åˆ’è¯¦ç»†æŠ¥è¡¨ |
| GET | `/api/v4/console/ad-reports/slots/:id?start_date=&end_date=` | å•å¹¿å‘Šä½è¯¦ç»†æŠ¥è¡¨ |

**å¹¿å‘Šä¸»ç«¯æŠ¥è¡¨**ï¼š

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|---|---|---|
| GET | `/api/v4/user/ad-campaigns/:id/report?start_date=&end_date=` | Phase 3 å·²å®šä¹‰ï¼Œæ­¤é˜¶æ®µä¸°å¯Œå½’å› æ•°æ® |

#### 14.6.4 å®šæ—¶ä»»åŠ¡æ±‡æ€»

| æ—¶é—´ | ä»»åŠ¡ | Service | é˜¶æ®µ |
|---|---|---|---|
| å‡Œæ™¨ 1:00 | ç«ä»·æ—¥æ‰£è´¹ | `AdBillingService.processDailyBidding()` | Phase 4 |
| å‡Œæ™¨ 3:00 | DMP æ ‡ç­¾èšåˆ | `AdTagAggregationService.aggregateAllUserTags()` | Phase 5 |
| å‡Œæ™¨ 4:00 | æŠ¥è¡¨å¿«ç…§ç”Ÿæˆ | `AdReportService.generateDailySnapshot()` | Phase 6 |

#### 14.6.5 å¯å¤ç”¨æ¸…å•

| å¤ç”¨é¡¹ | æ¥æº |
|---|---|
| æŠ½å¥–å®Œæˆå›è°ƒ | `lottery_draws` å†™å…¥åçš„ hook æˆ– Service å±‚å›è°ƒ |
| å…‘æ¢å®Œæˆå›è°ƒ | `exchange_records` å†™å…¥åçš„å›è°ƒ |
| å¸‚åœºäº¤æ˜“å›è°ƒ | `trade_orders` å®Œæˆåçš„å›è°ƒ |
| `node-cron` | å·²æœ‰ä¾èµ– |
| `BeijingTimeHelper` | æ—¥æœŸèŒƒå›´è®¡ç®— |

---

## åäº”ã€å…¨é˜¶æ®µæ‰§è¡Œä¾èµ–å…³ç³»ä¸é‡Œç¨‹ç¢‘

```
Phase 1 â”€â”€â”€â”€â”€â”€â”€ Phase 2 â”€â”€â”€â”€â”€â”€â”€ Phase 3 â”€â”€â”€â”€â”€â”€â”€ Phase 4 â”€â”€â”€â”€â”€â”€â”€ Phase 5 â”€â”€â”€â”€â”€â”€â”€ Phase 6
å¼¹çª—é¢‘ç‡æ§åˆ¶     å±•ç¤ºæ—¥å¿—         å¹¿å‘ŠåŸºç¡€ç‰ˆ       ç«ä»·æ’å         DMP+åä½œå¼Š       å½’å› +æŠ¥è¡¨
+è½®æ’­ç‹¬ç«‹è¡¨      +å¼¹çª—é˜Ÿåˆ—        +å›ºå®šåŒ…å¤©+å®¡æ ¸   +æ—¥æ‰£è´¹+æ’åº     +æ ‡ç­¾+è¿‡æ»¤       +å¿«ç…§+åˆ†æ

æ”¹åŠ¨é‡(é¢„ä¼°):
 5åˆ—+1è¡¨         2è¡¨              4è¡¨+15å­—å…¸       1è¡¨              4è¡¨+10æ ‡ç­¾       2è¡¨
 2Model+2Svc     2Svc             4Model+4Svc      1Svc+å®šæ—¶ä»»åŠ¡    2Svc+å®šæ—¶ä»»åŠ¡    2Svc+å®šæ—¶ä»»åŠ¡
 2Route          è¿½åŠ åˆ°ç°æœ‰Route   3Route           ä¿®æ”¹ç°æœ‰Svc      1Route           è¿½åŠ åˆ°ç°æœ‰Route
```

æ¯ä¸ªé˜¶æ®µçš„è¿ç§»æ–‡ä»¶ç‹¬ç«‹ï¼Œå¯å•ç‹¬æ‰§è¡Œ `npx sequelize-cli db:migrate` æ¨è¿›ã€‚

---

## åå…­ã€æ³¨æ„äº‹é¡¹è¡¥å……

1. **æ‰€æœ‰æ—¥å¿—è¡¨ç”¨ BIGINT ä¸»é”®**ï¼š`popup_show_logs` / `carousel_show_logs` / `ad_impression_logs` / `ad_click_logs` / `ad_billing_records` / `ad_antifraud_logs` / `ad_attribution_logs` / `ad_report_daily_snapshots` å‡ç”¨ BIGINTï¼Œé¢„ç•™æ—¥å¿—é‡å¢é•¿ç©ºé—´
2. **å¹‚ç­‰é”®è¦†ç›–æ‰€æœ‰æ‰£è´¹æ“ä½œ**ï¼š`ad_campaigns.business_id` å’Œ `ad_billing_records.business_id` å‡è®¾ UNIQUE çº¦æŸï¼Œå¤ç”¨ `IdempotencyService`
3. **å¹¿å‘Šç´ æå¤ç”¨ç°æœ‰å›¾ç‰‡ä¸Šä¼ èƒ½åŠ›**ï¼š`ad_creatives.image_url` å­˜å¯¹è±¡ keyï¼ŒCDN è½¬æ¢å¤ç”¨ `_transformBannerImageUrl()` é€»è¾‘
4. **carousel_items ä¸éœ€è¦é¢‘ç‡æ§åˆ¶**ï¼šè½®æ’­å›¾æ˜¯é¡µé¢å†…åµŒç»„ä»¶ï¼ˆä¸€ç›´å±•ç¤ºï¼‰ï¼Œä¸åƒå¼¹çª—æœ‰æ‰“æ–­æ€§ï¼Œå› æ­¤ä¸éœ€è¦ `frequency_rule` ç­‰å­—æ®µ
5. **å¼¹çª—é˜Ÿåˆ—æœ€å¤§æ•°é‡å¯çƒ­æ›´æ–°**ï¼šå­˜ `system_configs` è¡¨ï¼ŒService æ¯æ¬¡è¯»å–ï¼Œæ— éœ€é‡å¯æœåŠ¡
6. **æ‰€æœ‰ ad_ ç³»åˆ—è¡¨çš„ FK éƒ½è®¾ `RESTRICT`**ï¼šé˜²æ­¢è¯¯åˆ å…³è”æ•°æ®
7. **targeting_rules ä½¿ç”¨ JSON å­—æ®µè€Œéå…³è”è¡¨**ï¼š60 ä¸ªç”¨æˆ·ã€æ•°åƒå¹¿å‘Šé‡çº§ä¸‹ï¼ŒJSON å­˜å‚¨+åº”ç”¨å±‚åŒ¹é…è¶³å¤Ÿï¼Œæ— éœ€å»ºç‹¬ç«‹çš„å®šå‘è§„åˆ™å…³è”è¡¨
