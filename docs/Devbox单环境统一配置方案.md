# Devbox å•ç¯å¢ƒç»Ÿä¸€é…ç½®æ–¹æ¡ˆ

**æ–‡æ¡£ç‰ˆæœ¬**: v1.1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025å¹´12æœˆ25æ—¥  
**æœ€åæ›´æ–°**: 2025å¹´12æœˆ25æ—¥ï¼ˆæ–°å¢å†³ç­–ç¡®è®¤ä¸æ‰§è¡Œæ¸…å•ï¼‰  
**é€‚ç”¨ç¯å¢ƒ**: Sealos Devboxï¼ˆå•ç¯å¢ƒè¿è¡Œï¼‰  
**ç›®æ ‡**: è§£å†³é…ç½®æºé‡å¤ã€ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§æ··ä¹±ã€PM2é‡å¯ä¸ç”Ÿæ•ˆç­‰é—®é¢˜

---

## ğŸ¯ æ‰§è¡ŒçŠ¶æ€æ‘˜è¦ï¼ˆå¿«é€Ÿå¯¼èˆªï¼‰

### å†³ç­–çŠ¶æ€ï¼šâœ… å…¨éƒ¨å·²ç¡®è®¤ï¼ˆ2025-12-25ï¼‰

- âœ… dotenv å…¨ä»“åº“ç¦æ­¢ overrideï¼ˆæ— ä¾‹å¤–ï¼‰
- âœ… ecosystem.config.js env å®Œå…¨æ¸…ç©º
- âœ… Redis ç»Ÿä¸€ä½¿ç”¨ REDIS_URLï¼ˆå¿…é¡»è¦æœ‰ Redisï¼Œä¸å…è®¸ç¦ç”¨ï¼‰
- âœ… Redis ä¾èµ–ç®¡ç†ï¼šå¤–éƒ¨æœåŠ¡ï¼Œè„šæœ¬ä¸æ‹‰èµ·
- âœ… è¿›ç¨‹ç®¡ç†å”¯ä¸€å…¥å£ npm run pm:\*
- âœ… æµ‹è¯•ç¯å¢ƒå…è®¸è¿çœŸå®åº“
- âœ… å†å²æ•æ„Ÿä¿¡æ¯ä¸è½®æ¢/ä¸æ¸…ç†
- âœ… config/database.js ç§»é™¤æ¨¡å—é¡¶å±‚å‰¯ä½œç”¨
- âœ… æµ‹è¯•é“¾è·¯ï¼šå¼ºåˆ¶æ–¹æ¡ˆ1ï¼ˆä¸åŠ è½½ dotenvï¼Œçº¯æ‰‹åŠ¨è®¾ç½®ï¼‰
- âœ… æ•°æ®åº“æ—¶åŒºï¼šåº”ç”¨å±‚å¼ºåˆ¶ä¼šè¯æ—¶åŒº +08:00

### æ‰§è¡Œè¿›åº¦ï¼šå·²å¯åŠ¨

**çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰å¼ºåˆ¶æ‰§è¡Œæ¸…å•**ï¼š

- [ ] **P0-1**: æ¸…ç©º `ecosystem.config.js` çš„ `env:{...}`
- [ ] **P0-2**: ä¿®æ”¹ `app.js` ç§»é™¤ `override: true`
- [x] **P0-3**: è¡¥å…… `.env` ä¸­çš„ `REDIS_URL`ï¼ˆâœ… å·²ç¡®è®¤ï¼š`redis://localhost:6379`ï¼‰
- [ ] **P0-4**: å¢å¼º `scripts/system/process-manager.sh`ï¼ˆæ·»åŠ  5 ä¸ªæ–°å‘½ä»¤ï¼‰
- [ ] **P0-5**: æ›´æ–° `package.json` æ·»åŠ  `pm:logs` ç­‰ 5 ä¸ªæ–°å‘½ä»¤
- [ ] **P0-6**: åˆ é™¤ `start-service.sh`ã€`å¿«é€Ÿç®¡ç†è„šæœ¬.sh`
- [ ] **P1-1**: æ›´æ–° 4 ä¸ªè„šæœ¬ä¸­çš„ `pm2 restart` å‘½ä»¤
- [ ] **P1-2**: éªŒè¯é…ç½®åŠ è½½
- [ ] **P2-1**: æ¸…ç† `config.example` æ•æ„Ÿé¡¹
- [ ] **P2-2**: æµ‹è¯•ç¯å¢ƒå…±ç”¨åº“é£é™©å‘ŠçŸ¥

**è¯¦ç»†æ¸…å•è§ä¸‹æ–‡"åç»­ä¼˜åŒ–å»ºè®®"ç« èŠ‚**

---

## âœ… ä¸å½“å‰å®é™…ä»£ç /æ•°æ®åº“å¯¹é½çš„æ’æŸ¥ç»“è®ºï¼ˆä»¥å½“å‰ä»“åº“+çœŸå®DBä¸ºå‡†ï¼‰

> è¯´æ˜ï¼šæœ¬èŠ‚ä»…åŸºäº**å½“å‰ä»“åº“ä»£ç çŠ¶æ€**ä¸**æŒ‰å½“å‰ `.env` å®é™…è¿æ¥åˆ°çš„æ•°æ®åº“**å¾—å‡ºç»“è®ºï¼›æ¶‰åŠå¯†é’¥/å¯†ç å†…å®¹ä¸€å¾‹è„±æ•ä¸º `***`ã€‚

### å½“å‰å®é™…é…ç½®åŸºçº¿ï¼ˆè„±æ•ï¼‰

- **`.env` æ–‡ä»¶**ï¼šå­˜åœ¨ï¼ˆ`/home/devbox/project/.env`ï¼‰ï¼Œå…³é”®å­—æ®µï¼ˆè„±æ•åï¼‰ï¼š
  - `NODE_ENV=development`
  - `PORT=3000`
  - `TZ=Asia/Shanghai`
  - `DB_HOST=dbconn.sealosbja.site`
  - `DB_PORT=42569`
  - `DB_NAME=restaurant_points_dev`
  - `DB_USER=root`
  - `DB_PASSWORD=***`
  - `REDIS_URL`ï¼š**ç¼ºå¤±**ï¼ˆå½“å‰ä»…é…ç½® `REDIS_HOST/REDIS_PORT`ï¼‰
- **`ecosystem.config.js`**ï¼šåŒæ—¶å­˜åœ¨ `env_file: '.env'` ä¸ `env:{...}`ï¼Œå¹¶åœ¨ `env` å†…ç¡¬ç¼–ç äº† **DB/JWT/Redis ç­‰çœŸå®é…ç½®**ï¼ˆä¸â€œå•ä¸€çœŸç›¸æºâ€ç›´æ¥å†²çªï¼‰ã€‚
- **dotenv åŠ è½½ä¸ä¼˜å…ˆçº§ï¼ˆçœŸå®ä»£ç è¡Œä¸ºï¼‰**ï¼š
  - `app.js` åœ¨ `NODE_ENV=development` æ—¶æ‰§è¡Œ `require('dotenv').config({ override: true })`
  - `config/environment.js` ä¸ `config/database.js` ä¹Ÿä¼šå†æ¬¡ `require('dotenv').config()`
  - ç»“è®ºï¼šåŒä¸€è¿›ç¨‹ä¸­ dotenv å¤šç‚¹åŠ è½½ + development overrideï¼Œä¼šå¯¼è‡´â€œè°è¦†ç›–è°â€å˜å¾—ä¸å¯ç›´è§‰æ¨æ–­ï¼Œå±äºæ–‡æ¡£ä¸­çš„â€œä¼˜å…ˆçº§æ··ä¹±â€é—®é¢˜çš„ç°å®æ¥æºä¹‹ä¸€ã€‚

### å½“å‰çœŸå®æ•°æ®åº“åŸºçº¿ï¼ˆåªè¯»è¿æ¥ï¼‰

- **æ•°æ®åº“å**ï¼š`restaurant_points_dev`
- **æ—¶åŒº**ï¼š
  - `@@session.time_zone = +08:00`
  - `NOW() = 2025-12-25 05:07:39`ï¼ˆæœ¬åœ°æ—¶é—´ï¼‰
  - `UTC_TIMESTAMP() = 2025-12-24 21:07:39`ï¼ˆUTCï¼‰
  - `@@global.time_zone = SYSTEM`ï¼ˆæ³¨æ„ï¼šå…¨å±€ä»ä¸º SYSTEMï¼Œä¾èµ–è¿æ¥ä¼šè¯æ˜¯å¦æ˜¾å¼è®¾ç½®ï¼‰
- **Schema è§„æ¨¡**ï¼š`43` å¼ è¡¨ã€`611` ä¸ªåˆ—
- **ä½“é‡ Topï¼ˆæŒ‰è¡¨å¤§å°ï¼Œinformation_schema è¿‘ä¼¼è¡Œæ•°ï¼‰**ï¼š
  - `lottery_draws`ï¼šçº¦ `2820` è¡Œ
  - `admin_operation_logs`ï¼šçº¦ `894` è¡Œ
  - `asset_transactions`ï¼šçº¦ `858` è¡Œ
  - `item_instances`ï¼šçº¦ `580` è¡Œ

### ç»“è®ºï¼šè¿™ä»½æ–‡æ¡£æ˜¯å¦èƒ½è§£å†³â€œå½“å‰é¡¹ç›®å­˜åœ¨çš„é—®é¢˜â€ï¼Ÿ

**èƒ½è§£å†³ï¼ˆæ–¹å‘æ­£ç¡®ï¼‰ï¼Œä½†éœ€è¦æŠŠæ–‡æ¡£ç¤ºä¾‹/æ£€æŸ¥æ¸…å•ä¸å½“å‰çœŸå®é…ç½®å¯¹é½ï¼Œå¹¶è¡¥å……æ–‡æ¡£æœªè¦†ç›–çš„â€œé¢å¤–é—®é¢˜â€ã€‚**  
å½“å‰ä»“åº“å·²æ˜ç¡®å­˜åœ¨æ–‡æ¡£ A-D ç±»é—®é¢˜çš„çœŸå®è§¦å‘ç‚¹ï¼ˆè§ä¸‹æ–‡â€œå½“å‰é—®é¢˜è¯Šæ–­ï¼ˆä¸å®é™…å¯¹é½ï¼‰â€ï¼‰ï¼Œå¹¶ä¸”è¿˜å‘ç°è‹¥å¹²åŒç±»æ ¹å› ï¼ˆå¦‚æ˜æ–‡å‡­æ®ã€dotenv å¤šç‚¹åŠ è½½ã€å‰¯ä½œç”¨æ ¡éªŒã€è„šæœ¬é‡å¯ä¸ä¸€è‡´ç­‰ï¼‰ã€‚

## ğŸ“‹ å½“å‰é—®é¢˜è¯Šæ–­

### é—®é¢˜ Aï¼šé…ç½®æºé‡å¤å¯¼è‡´"å¤šé‡çœŸç›¸"

**ç°çŠ¶**ï¼š

- `ecosystem.config.js` çš„ `env:{...}` ç¡¬ç¼–ç äº† `DB_HOST`ã€`DB_PORT`ã€`DB_NAME`ã€`DB_PASSWORD`ã€`JWT_SECRET`ã€`REDIS_URL` ç­‰
- `ecosystem.config.js` åŒæ—¶æŒ‡å®šäº† `env_file: '.env'`
- ä»£ç ä¸­å¤šå¤„è°ƒç”¨ `dotenv.config()`ï¼ˆ`app.js`ã€`config/database.js`ã€`config/environment.js` ç­‰ï¼‰

**é—®é¢˜**ï¼š

- æ”¹ `.env` åå¯èƒ½ä¸ç”Ÿæ•ˆï¼ˆå› ä¸º ecosystem env ä¼˜å…ˆçº§æ›´é«˜ï¼‰
- éœ€è¦åŒæ—¶ä¿®æ”¹ä¸¤å¤„é…ç½®æ‰èƒ½ç¡®ä¿ä¸€è‡´
- æ— æ³•ç¡®è®¤"å½“å‰è¿è¡Œç¯å¢ƒå®é™…è¯»å–çš„æ˜¯å“ªä¸ªé…ç½®æº"

**ä¸å½“å‰å®é™…å¯¹é½çš„å‘ç°ï¼ˆè¯æ®ç‚¹ï¼‰**ï¼š

- `ecosystem.config.js` ç›®å‰ä»åŒ…å«**æ˜æ–‡/ç¡¬ç¼–ç **çš„ DB/JWT/Redis é…ç½®ï¼ˆåº”è§†ä¸ºâ€œçœŸå®é…ç½®æºâ€ï¼Œä¸”ä¸ `.env` å¹¶å­˜ï¼‰
- `.env` å½“å‰æŒ‡å‘ï¼š`dbconn.sealosbja.site:42569 / restaurant_points_dev`ï¼ˆä¸æ–‡æ¡£ç¤ºä¾‹ä¸­çš„ç«¯å£/åº“åä¸ä¸€è‡´ï¼‰
- `.env` ç¼ºå°‘ `REDIS_URL`ï¼Œä½† `ecosystem.config.js` æä¾›äº† `REDIS_URL`ï¼šè¿™ä¼šå¯¼è‡´ Redis é…ç½®æ¥æºå‡ºç°åˆ†è£‚ï¼ˆéƒ¨åˆ†ä¾èµ–è¯» `.env`ï¼Œéƒ¨åˆ†è¯» ecosystem envï¼‰

---

### é—®é¢˜ Bï¼šç¯å¢ƒå˜é‡ä¼˜å…ˆçº§ä¸ç»Ÿä¸€

**ç°çŠ¶**ï¼š

- `app.js` åœ¨ `NODE_ENV === 'development'` æ—¶æ‰§è¡Œ `dotenv.config({ override: true })`
- è¿™ä¼šè®© `.env` æ–‡ä»¶**è¦†ç›–ç³»ç»Ÿç¯å¢ƒå˜é‡**ï¼ˆä¸é€šå¸¸çš„"ç³»ç»Ÿ > .env"ç›¸åï¼‰

**é—®é¢˜**ï¼š

- åœ¨ development æ¨¡å¼ä¸‹ï¼Œ`.env` ä¼šè¦†ç›–ç³»ç»Ÿç¯å¢ƒå˜é‡
- åœ¨ production æ¨¡å¼ä¸‹ï¼Œç³»ç»Ÿç¯å¢ƒå˜é‡ä¼˜å…ˆçº§é«˜äº `.env`
- åŒä¸€ä¸ªé…ç½®é¡¹åœ¨ä¸åŒ NODE_ENV ä¸‹çš„ä¼˜å…ˆçº§é€»è¾‘ä¸ä¸€è‡´

**ä¸å½“å‰å®é™…å¯¹é½çš„å‘ç°ï¼ˆè¯æ®ç‚¹ï¼‰**ï¼š

- åœ¨ PM2 åœºæ™¯ä¸‹ï¼Œâ€œç³»ç»Ÿç¯å¢ƒå˜é‡â€ä¸ä»…æ¥è‡ª shellï¼Œä¹Ÿæ¥è‡ª `ecosystem.config.js env` ä¸ `env_file` æ³¨å…¥ï¼›è€Œ `app.js` çš„ `override: true` ä¼šåœ¨ development ç¯å¢ƒè¿›ä¸€æ­¥è¦†ç›–å®ƒä»¬ã€‚
- `config/environment.js` ä¸ `config/database.js` å†æ¬¡æ‰§è¡Œ `dotenv.config()`ï¼Œè™½ç„¶é»˜è®¤ä¸ overrideï¼Œä½†ä¼šåŠ æ·±â€œé…ç½®åˆ°åº•åœ¨å“ªå„¿ç”Ÿæ•ˆâ€çš„æ’æŸ¥å¤æ‚åº¦ã€‚

---

### é—®é¢˜ Cï¼šPM2 ç»§æ‰¿å¯åŠ¨æ—¶ shell ç¯å¢ƒå˜é‡

**ç°çŠ¶**ï¼š

- `scripts/system/process-manager.sh` ä½¿ç”¨ `pm2 start ecosystem.config.js`
- PM2 è¿›ç¨‹ä¼šç»§æ‰¿å¯åŠ¨æ—¶ shell çš„æ‰€æœ‰ç¯å¢ƒå˜é‡

**é—®é¢˜**ï¼š

- å¦‚æœ shell ä¸­é¢„å…ˆè®¾ç½®äº†æŸäº›ç¯å¢ƒå˜é‡ï¼Œå¯èƒ½ä¸ `.env` / `ecosystem.config.js` äº§ç”Ÿå†²çª
- "ä¸‰å±‚é…ç½®æ¥æºå åŠ "ï¼ˆshell env + ecosystem env + .envï¼‰ï¼Œéš¾ä»¥è¿½æº¯å®é™…ç”Ÿæ•ˆå€¼

**ä¸å½“å‰å®é™…å¯¹é½çš„å‘ç°ï¼ˆè¯æ®ç‚¹ï¼‰**ï¼š

- é¡¹ç›®è¿˜å­˜åœ¨ `deploy.sh`ï¼ˆç¼ºå°‘ `.env` æ—¶ `cp config.example .env`ï¼‰ä¸ `config.example`ï¼ˆåŒ…å«å¤§é‡é…ç½®é¡¹ï¼‰â€”â€”è¿™ä¼šè®©â€œé…ç½®æºâ€åœ¨å·¥ç¨‹å®è·µä¸­æ›´å®¹æ˜“æ‰©æ•£ï¼Œä¸æ­¢ä¸‰å±‚ã€‚

---

### é—®é¢˜ Dï¼šPM2 é‡å¯ä¸åŠ è½½æ–°ç¯å¢ƒå˜é‡

**ç°çŠ¶**ï¼š

- é¡¹ç›®ä¸­çš„é‡å¯è„šæœ¬ï¼ˆå¦‚ `scripts/migration/execute-migration-now.js`ï¼‰ä½¿ç”¨ `pm2 restart all`
- `scripts/system/process-manager.sh` ä¹Ÿæœªä½¿ç”¨ `--update-env` å‚æ•°

**é—®é¢˜**ï¼š

- ä¿®æ”¹ `.env` æˆ– `ecosystem.config.js` åï¼Œ`pm2 restart` ä¸ä¸€å®šä¼šåˆ·æ–°ç¯å¢ƒå˜é‡
- éœ€è¦æ˜¾å¼ä½¿ç”¨ `pm2 restart <app> --update-env` æ‰èƒ½ç¡®ä¿é…ç½®æ›´æ–°ç”Ÿæ•ˆ

**ä¸å½“å‰å®é™…å¯¹é½çš„å‘ç°ï¼ˆè¯æ®ç‚¹ï¼‰**ï¼š

- ä»å­˜åœ¨å¤šä¸ªè„šæœ¬/è¯´æ˜è¦æ±‚æ‰§è¡Œ `pm2 restart all`ï¼š
  - `scripts/migration/execute-migration-now.js`
  - `scripts/verify_old_apis_deleted.sh`
  - `scripts/delete_old_chat_apis.sh`
- `start-service.sh` ä½¿ç”¨ `pm2 restart restaurant-lottery-backend`ï¼ˆæœªåŠ  `--update-env`ï¼‰
- ä½† `å¿«é€Ÿç®¡ç†è„šæœ¬.sh` å·²ä½¿ç”¨ `pm2 reload ecosystem.config.js --update-env`ï¼šè¯´æ˜é¡¹ç›®å†…éƒ¨â€œæ­£ç¡®åšæ³•â€ä¸â€œå®é™…è¢«è°ƒç”¨çš„åšæ³•â€å¹¶å­˜ï¼Œå®¹æ˜“å½¢æˆå›å½’ã€‚

---

### é—®é¢˜ Eï¼ˆæ–°å¢ï¼‰ï¼šä»“åº“å†…å­˜åœ¨â€œæ˜æ–‡é…ç½®/é»˜è®¤å¯†é’¥â€ï¼Œä¸â€œå•ä¸€çœŸç›¸æºâ€ç›®æ ‡å†²çªä¸”æœ‰å®‰å…¨é£é™©

**ç°çŠ¶ï¼ˆä¸å®é™…å¯¹é½ï¼‰**ï¼š

- `ecosystem.config.js`ï¼šå­˜åœ¨ç¡¬ç¼–ç  DB/JWT/Redis ç­‰æ•æ„Ÿé…ç½®ï¼ˆåº”è„±æ•å¹¶è¿ç§»å‡ºä»£ç ä»“åº“ï¼‰
- `config.example`ï¼šåŒ…å« DB å¯†ç ã€å¯¹è±¡å­˜å‚¨ access/secret ç­‰ï¼ˆåº”è§†ä¸ºæ•æ„Ÿç¤ºä¾‹ï¼Œè‡³å°‘éœ€è¦è„±æ•/å ä½ï¼‰
- `services/sealosStorage.js`ï¼šå½“ç¯å¢ƒå˜é‡ç¼ºå¤±æ—¶ä¼šå›é€€åˆ°é»˜è®¤ `SEALOS_ACCESS_KEY/SEALOS_SECRET_KEY`ï¼ˆé»˜è®¤å€¼å±äºæ•æ„Ÿä¿¡æ¯ï¼Œä¸”ä¼šå¯¼è‡´â€œæœªé…ç½®ä¹Ÿèƒ½è·‘ä½†è·‘åœ¨é”™è¯¯è´¦å·â€ï¼‰
- æµ‹è¯•ä»£ç ï¼ˆ`jest.setup.js`ã€`tests/helpers/test-setup.js`ï¼‰å†…å­˜åœ¨ DB è¿æ¥ä¿¡æ¯ä¸é»˜è®¤å¯†ç ï¼ˆå³ä¾¿æ˜¯æµ‹è¯•ï¼Œä¹Ÿä¼šæˆä¸ºâ€œç¬¬äºŒçœŸç›¸æºâ€ï¼Œå¹¶å¯èƒ½è¯¯è¿çœŸå®åº“ï¼‰

**é—®é¢˜**ï¼š

- é…ç½®æºæ‰©æ•£ï¼š`.env` ä¸å†æ˜¯å”¯ä¸€çœŸç›¸æº
- å®‰å…¨é£é™©ï¼šæ•æ„Ÿä¿¡æ¯è¿›å…¥ä»“åº“å†å²åï¼Œéœ€è¦æŒ‰â€œå·²æ³„éœ²â€å¤„ç†

---

### é—®é¢˜ Fï¼ˆæ–°å¢ï¼‰ï¼šæ•°æ®åº“é…ç½®æ¨¡å—å­˜åœ¨"require å³æ ¡éªŒ/æ‰“å°"çš„å‰¯ä½œç”¨ï¼Œå½±å“è„šæœ¬åŒ–ä¸æ’æŸ¥

**ç°çŠ¶ï¼ˆä¸å®é™…å¯¹é½ï¼‰**ï¼š

- `config/database.js` åœ¨æ¨¡å—é¡¶å±‚æ‰§è¡Œ `validateDatabaseConfig()` å¹¶ `console.log` è¾“å‡ºè¿æ¥ä¿¡æ¯

**é—®é¢˜**ï¼š

- ä»»æ„ `require('./config/database')` éƒ½å¯èƒ½ç›´æ¥æŠ›é”™æˆ–é€€å‡ºæµç¨‹ï¼Œå¢åŠ å·¥å…·è„šæœ¬/æµ‹è¯•çš„è„†å¼±æ€§
- é¡¶å±‚æ‰“å° DB è¿æ¥ä¿¡æ¯ä¼šæŠŠæ•æ„Ÿå…ƒæ•°æ®æ‰©æ•£åˆ° PM2/CI/å…±äº«æ—¥å¿—é‡Œ
- ä¸"å•ç¯å¢ƒç»Ÿä¸€é…ç½®æ–¹æ¡ˆ"ç›®æ ‡ä¸€è‡´ï¼šåº”å°½é‡å‡å°‘é…ç½®è¡Œä¸ºçš„éšå¼å‰¯ä½œç”¨ï¼Œä¾¿äºæ’æŸ¥"è°åœ¨è¯»é…ç½®"

**è§£å†³æ–¹æ¡ˆï¼ˆå·²ç¡®è®¤ï¼‰**ï¼š

- âœ… **ç¦æ­¢æ¨¡å—é¡¶å±‚å‰¯ä½œç”¨**ï¼š
  - ç§»é™¤ `validateDatabaseConfig()` çš„é¡¶å±‚æ‰§è¡Œï¼ˆæ”¹ä¸ºåœ¨ `testConnection()` å†…è°ƒç”¨ï¼‰
  - ç§»é™¤é¡¶å±‚ `console.log` æ‰“å°è¿æ¥ä¿¡æ¯ï¼ˆæ”¹ä¸ºå¯é€‰çš„å¯åŠ¨é˜¶æ®µæ—¥å¿—ï¼Œä¸”å¿…é¡»è„±æ•ï¼‰
  - ç§»é™¤é¡¶å±‚ `dotenv.config()`ï¼ˆdotenv åªåœ¨ `app.js` æ‰§è¡Œä¸€æ¬¡ï¼‰
- âœ… **ä¿ç•™ fail-fast æœºåˆ¶**ï¼š
  - åœ¨ `app.js` å¯åŠ¨é˜¶æ®µæ˜¾å¼è°ƒç”¨ `testConnection()`ï¼ˆåº”ç”¨å¯åŠ¨ä»ç„¶ fail-fastï¼‰
  - å·¥å…·è„šæœ¬æŒ‰éœ€è°ƒç”¨ `testConnection()`ï¼ˆä¸éœ€è¦ DB çš„è„šæœ¬ä¸ä¼šè¢«è¯¯ä¼¤ï¼‰

**éªŒæ”¶æ ‡å‡†**ï¼š

- [ ] `require('./config/database')` ä¸ä¼šè§¦å‘ä»»ä½•æ ¡éªŒ/æ‰“å°/æŠ›é”™
- [ ] `app.js` å¯åŠ¨é˜¶æ®µæ˜¾å¼è°ƒç”¨ `testConnection()`ï¼ˆç¼ºé…ç½®ä¼šç«‹å³å¤±è´¥ï¼‰
- [ ] å·¥å…·è„šæœ¬ä¸å†å› "é—´æ¥å¼•ç”¨ config/database"è€Œè¢«å¼ºåˆ¶æ ¡éªŒæ‰“æ–­

---

### é—®é¢˜ Gï¼ˆæ–°å¢ï¼‰ï¼šdotenv å¤šç‚¹åŠ è½½å¯¼è‡´"é…ç½®åˆ°åº•åœ¨å“ªç”Ÿæ•ˆ"æ’æŸ¥å¤æ‚ï¼ˆP2 çº§ï¼‰

**é—®é¢˜é€šä¿—è§£é‡Š**ï¼š
åŒä¸€å¥— `.env` é…ç½®è¢«å¾ˆå¤šåœ°æ–¹åå¤è¯»å–ï¼š`app.js` è¯»ä¸€æ¬¡ï¼Œ`config/environment.js` åˆè¯»ä¸€æ¬¡ï¼Œ`config/database.js` å†è¯»ä¸€æ¬¡ï¼Œè„šæœ¬/æµ‹è¯•ä¹Ÿå„è¯»ä¸€æ¬¡ã€‚å½“æŸä¸ªå˜é‡ä¸å¯¹æ—¶ï¼Œä½ å¾ˆéš¾åˆ¤æ–­**"åˆ°åº•æ˜¯è°æœ€åæŠŠé…ç½®å˜æˆè¿™æ ·çš„"**â€”â€”éœ€è¦æ£€æŸ¥ 5+ ä¸ªåœ°æ–¹æ‰èƒ½å®šä½ã€‚

**ç°çŠ¶ï¼ˆä¸å®é™…ä»£ç å¯¹é½ï¼‰**ï¼š

- **åº”ç”¨ä¸»é“¾è·¯å¤šç‚¹åŠ è½½**ï¼š
  - `app.js:27` æ‰§è¡Œ `require('dotenv').config()`
  - `config/environment.js:10` å†æ¬¡æ‰§è¡Œ `require('dotenv').config()`
  - `config/database.js:12` å†æ¬¡æ‰§è¡Œ `require('dotenv').config()`
  - ç»“æœï¼šåŒä¸€è¿›ç¨‹ä¸­ dotenv è¢«è°ƒç”¨ 3 æ¬¡ï¼ˆè™½ç„¶é»˜è®¤ä¸ overrideï¼Œä½†ä¼šå¢åŠ "é…ç½®åˆ°åº•ä»å“ªæ¥"çš„æ’æŸ¥å™ªéŸ³ï¼‰

- **è„šæœ¬/æµ‹è¯•é“¾è·¯åˆ†æ•£åŠ è½½**ï¼š
  - 13+ ä¸ªè„šæœ¬æ–‡ä»¶å„è‡ªåŠ è½½ dotenvï¼ˆéƒ¨åˆ†åœ¨å…¥å£ã€éƒ¨åˆ†åœ¨å‡½æ•°å†…ã€éƒ¨åˆ†ç”¨ `override`ã€éƒ¨åˆ†æŒ‡å®š `path`ï¼‰
  - `jest.setup.js` / `tests/helpers/test-setup.js` æ—¢åŠ è½½ dotenv åˆæ‰‹åŠ¨è¦†ç›–å˜é‡ï¼ˆåŒçœŸç›¸æºï¼‰

- **å‰¯ä½œç”¨æ‰©æ•£é—®é¢˜**ï¼ˆä¸é—®é¢˜ F å åŠ ï¼‰ï¼š
  - `config/database.js` åœ¨ `require` æ—¶ç«‹å³æ‰§è¡Œ `validateDatabaseConfig()` + `console.log`
  - å¯¼è‡´ä»»ä½• import è¿™ä¸ªæ¨¡å—çš„åœ°æ–¹ï¼ˆåŒ…æ‹¬å·¥å…·è„šæœ¬ï¼‰éƒ½ä¼šè§¦å‘æ ¡éªŒ/æ‰“å°/å¯èƒ½é€€å‡º
  - ä¸ dotenv å¤šç‚¹åŠ è½½å åŠ åï¼Œå¾ˆéš¾åˆ¤æ–­"æ˜¯ dotenv æ²¡åŠ è½½æˆåŠŸï¼Œè¿˜æ˜¯å˜é‡è¢«è¦†ç›–äº†ï¼Œè¿˜æ˜¯æ ¡éªŒé€»è¾‘æœ‰é—®é¢˜"

**æ’æŸ¥æ—¶ä¼šé‡åˆ°çš„å…¸å‹å›°æ‰°**ï¼š

1. **"é…ç½®å˜é‡ä¸å¯¹ï¼Œä¸çŸ¥é“æ˜¯å“ªé‡Œæ¥çš„"**
   - å‘ç° `DB_HOST` ä¸å¯¹ï¼Œæ‰“å¼€ `.env` æ˜æ˜å†™çš„å¯¹ï¼Œä½†ç¨‹åºç”¨çš„æ˜¯é”™çš„ã€‚
   - éœ€è¦ä¾æ¬¡æ£€æŸ¥ï¼š`app.js` dotenv â†’ `config/database.js` dotenv â†’ `config/environment.js` dotenv â†’ PM2 `env_file` â†’ PM2 `env:{...}` â†’ è„šæœ¬æ˜¯å¦è¦†ç›– â†’ æ‰èƒ½å®šä½ã€‚

2. **"æˆ‘åªæ˜¯ import äº†ä¸€ä¸ªæ¨¡å—ï¼Œå®ƒå°±ç‚¸äº†/æ‰“å°äº†ä¸€å †æ—¥å¿—"**
   - å†™ä¸ªå·¥å…·è„šæœ¬ `require('./config/database')` è¯»é…ç½®ï¼Œç»“æœç›´æ¥æŠ¥é”™é€€å‡ºï¼š`âŒ ç¼ºå°‘ç¯å¢ƒå˜é‡`ã€‚
   - æˆ–è€…ç–¯ç‹‚æ‰“å°ï¼š`ğŸ”— ç»Ÿä¸€æ•°æ®åº“é…ç½®: localhost:3306/...`ã€‚

3. **"æµ‹è¯•/è„šæœ¬ç”¨çš„é…ç½®å’ŒæœåŠ¡ä¸ä¸€è‡´"**
   - æœåŠ¡è¿çš„æ˜¯ `dbconn.sealosbja.site`ï¼Œæµ‹è¯•è¿çš„æ˜¯ `localhost`ï¼ˆå› ä¸ºæµ‹è¯• setup æ‰‹åŠ¨è¦†ç›–äº†ï¼‰ã€‚
   - æŸä¸ªè„šæœ¬åˆè¿çš„æ˜¯ `.env` é‡Œçš„æ—§é…ç½®ã€‚

**é—®é¢˜ä¸¥é‡åº¦**ï¼šP2ï¼ˆä¸ä¸€å®šè‡´å‘½ï¼Œä½†ä¼šæ˜¾è‘—å¢åŠ æ’æŸ¥å¤æ‚åº¦å’Œç»´æŠ¤æˆæœ¬ï¼‰

---

### é—®é¢˜ G çš„æ”¶æ•›æ–¹æ¡ˆï¼ˆâœ… å·²ç¡®è®¤ 2025-12-25ï¼‰

#### æ ¸å¿ƒç›®æ ‡ï¼ˆä¸€å¥è¯ï¼‰

**åªè®©"å…¥å£"è¯» `.env`ï¼Œå…¶ä»–æ–‡ä»¶åªç”¨ `process.env`ã€‚**

#### åˆ†ä¸‰ç±»åœºæ™¯æ”¶æ•›

##### 1. åº”ç”¨è¿è¡Œé“¾è·¯ï¼ˆå¼ºæ”¶æ•›ï¼‰

**ç›®æ ‡**ï¼šdotenv åªå…è®¸åœ¨ `app.js` å•ç‚¹åŠ è½½ï¼Œå…¶ä»–æ¨¡å—ä¸å¾—å†æ¬¡åŠ è½½ã€‚

**å…·ä½“æ‰§è¡Œ**ï¼š

- âœ… **ä¿ç•™**ï¼š`app.js:27` çš„ `require('dotenv').config()`ï¼ˆä½œä¸ºå”¯ä¸€åŠ è½½ç‚¹ï¼‰
- âŒ **ç§»é™¤**ï¼š`config/environment.js:10` çš„ `require('dotenv').config()`
- âŒ **ç§»é™¤**ï¼š`config/database.js:12` çš„ `require('dotenv').config()`
- âœ… **å‰¯ä½œç”¨æ”¶æ•›**ï¼ˆä¸é—®é¢˜ F é…åˆï¼‰ï¼š
  - `config/database.js` ç§»é™¤é¡¶å±‚ `validateDatabaseConfig()` è°ƒç”¨å’Œ `console.log` æ‰“å°
  - æ”¹ä¸ºç”± `app.js` å¯åŠ¨é˜¶æ®µæ˜¾å¼è°ƒç”¨ `testConnection()`

**å¥½å¤„**ï¼š

- æ•´æ¡æœåŠ¡é“¾è·¯åªæœ‰ä¸€ä¸ª"è¯» `.env` çš„å…¥å£"ï¼ˆ`app.js`ï¼‰
- `config/*` / `models/*` å˜æˆ"çº¯è¯»å– `process.env`"çš„åŸºç¡€æ¨¡å—ï¼Œä¸ä¼š import å°±è§¦å‘å‰¯ä½œç”¨
- æ’æŸ¥é…ç½®é—®é¢˜æ—¶åªéœ€çœ‹ï¼š`app.js` dotenv + PM2 æ³¨å…¥ï¼ˆä¸¤å¤„ï¼‰

##### 2. è„šæœ¬é“¾è·¯ï¼ˆå…è®¸æ˜¾å¼ï¼Œä½†ç»Ÿä¸€è§„åˆ™ï¼‰

**ç›®æ ‡**ï¼šè„šæœ¬ä½œä¸ºç‹¬ç«‹è¿›ç¨‹å¯ä»¥åŠ è½½ dotenvï¼Œä½†è¦ç»Ÿä¸€"åœ¨å“ªåŠ è½½ã€æ€ä¹ˆåŠ è½½"ã€‚

**ç»Ÿä¸€è§„åˆ™**ï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰ï¼š

- âœ… **åªåœ¨è„šæœ¬å…¥å£æœ€é¡¶éƒ¨åŠ è½½ä¸€æ¬¡**ï¼ˆä¸å¾—åœ¨å‡½æ•°å†…éƒ¨äºŒæ¬¡åŠ è½½ï¼‰
- âœ… **ç»Ÿä¸€ä½¿ç”¨ç»å¯¹è·¯å¾„**ï¼š`require('dotenv').config({ path: path.resolve(__dirname, '../../.env') })`
- âŒ **å…¨ä»“åº“ç¦æ­¢ `override: true`**ï¼ˆâœ… å·²æ‹æ¿ 2025-12-25ï¼Œæ— ä¾‹å¤–ï¼‰
- âœ… **è„šæœ¬é—´ä¸é‡å¤åŠ è½½**ï¼šå¦‚æœè„šæœ¬ A è°ƒç”¨è„šæœ¬ Bï¼Œåªåœ¨é¡¶å±‚è„šæœ¬åŠ è½½ä¸€æ¬¡

**å½“å‰éœ€è¦ä¿®æ”¹çš„ç‚¹**ï¼ˆåŸºäºä»£ç æ‰«æç»“æœï¼‰ï¼š

- `scripts/validation/pre-start-check.js:187, 212`ï¼šå‡½æ•°å†…äºŒæ¬¡åŠ è½½ â†’ æ”¹ä¸ºå…¥å£ä¸€æ¬¡
- `scripts/fix-technical-debt-p0.js:47`ï¼šä½¿ç”¨äº† `override: true` â†’ **å¼ºåˆ¶ç§»é™¤ override**

**å¥½å¤„**ï¼š

- è„šæœ¬çš„é…ç½®æ¥æºæ¸…æ™°ï¼šçœ‹è„šæœ¬é¡¶éƒ¨é‚£ä¸€è¡Œ dotenv + å®ƒç”¨çš„ path
- ä¸ä¼šå‡ºç°"è„šæœ¬ A åŠ è½½äº† `.env`ï¼Œè°ƒç”¨è„šæœ¬ B åˆ override è¦†ç›–äº†"çš„æ··ä¹±

##### 3. æµ‹è¯•é“¾è·¯ï¼ˆâœ… å¼ºåˆ¶æ–¹æ¡ˆ1ï¼šä¸åŠ è½½ dotenvï¼Œçº¯æ‰‹åŠ¨è®¾ç½®ï¼‰

**ç›®æ ‡**ï¼šæµ‹è¯•é…ç½®å®Œå…¨å¯æ§ï¼Œä¸å— `.env`/PM2/ç³»ç»Ÿç¯å¢ƒå½±å“ã€‚

**å¼ºåˆ¶æ‰§è¡Œè§„åˆ™**ï¼ˆâœ… å·²æ‹æ¿ 2025-12-25ï¼‰ï¼š

- âŒ **ç¦æ­¢**åœ¨æµ‹è¯•ä¸­åŠ è½½ dotenvï¼ˆç§»é™¤ `jest.setup.js` / `tests/helpers/test-setup.js` çš„ `require('dotenv').config()`ï¼‰
- âŒ **ç¦æ­¢**åˆ›å»º `.env.test` æ–‡ä»¶ï¼ˆé¿å…é…ç½®æºæ‰©æ•£ï¼‰
- âœ… **å¼ºåˆ¶**æµ‹è¯•éœ€è¦çš„æ‰€æœ‰ç¯å¢ƒå˜é‡åªèƒ½åœ¨ `jest.setup.js` ç­‰æµ‹è¯• setup æ–‡ä»¶ä¸­æ˜¾å¼è®¾ç½®
- âœ… **å…è®¸**æµ‹è¯•ä½¿ç”¨ä¸çœŸå®åº“ä¸åŒçš„é…ç½®ï¼ˆå¦‚è¿æµ‹è¯•åº“ã€ä½¿ç”¨æµ‹è¯•å¯†é’¥ç­‰ï¼‰

**æ ¸å¿ƒå¥½å¤„**ï¼š

- æµ‹è¯•é…ç½®æ˜¯"ä»£ç å³æ–‡æ¡£"ï¼Œçœ‹ `jest.setup.js` å°±çŸ¥é“æµ‹è¯•ç”¨çš„æ‰€æœ‰é…ç½®
- ä¸ä¼šå› ä¸ºæœ¬æœº `.env` æ”¹åŠ¨ã€PM2 æ³¨å…¥ã€CI ç¯å¢ƒå˜é‡è€Œå¯¼è‡´æµ‹è¯•è¡Œä¸ºå˜åŒ–
- ç»“åˆ"å…è®¸è¿çœŸå®åº“"å†³ç­–ï¼Œæµ‹è¯•é…ç½®å¿…é¡»æ˜¾å¼ä¸”å¯å®¡è®¡ï¼ˆé˜²æ­¢è¯¯æ“ä½œçº¿ä¸Šæ•°æ®ï¼‰

---

### é—®é¢˜ G çš„éªŒè¯æ–¹å¼ï¼ˆä¸å†™ä»£ç ä¹Ÿèƒ½éªŒè¯ï¼‰

#### åº”ç”¨é“¾è·¯éªŒè¯

```bash
# 1. å¯åŠ¨æœåŠ¡
npm run pm:start:pm2

# 2. æ£€æŸ¥è¿›ç¨‹å®é™…ç¯å¢ƒå˜é‡
pm2 show restaurant-lottery-backend | grep -E "DB_HOST|REDIS_URL"

# 3. ç¡®è®¤ä¸ .env ä¸€è‡´ï¼ˆæ‰‹å·¥å¯¹æ¯”ï¼‰

# 4. è®¿é—®å¥åº·æ£€æŸ¥ç¡®è®¤èƒ½è¿ä¸ŠçœŸå®åº“
curl http://localhost:3000/health | jq '.data.systems.database'
# é¢„æœŸï¼š'connected'
```

#### è„šæœ¬é“¾è·¯éªŒè¯

```bash
# è¿è¡Œä¸€ä¸ªä¼šè®¿é—® SystemSettings çš„è„šæœ¬
node scripts/check-config-conflicts.js

# ç¡®è®¤ï¼š
# - èƒ½è¯»åˆ°çœŸå®åº“çš„é…ç½®æ•°æ®
# - ä¸ä¼šå› ä¸º import database/models è€ŒæŠ¥é”™/æ‰“å°å™ªéŸ³
```

#### æµ‹è¯•é“¾è·¯éªŒè¯

```bash
# è¿è¡Œæµ‹è¯•
npm test

# ç¡®è®¤ï¼š
# - æµ‹è¯•è¿çš„åº“ä¸é¢„æœŸä¸€è‡´ï¼ˆæµ‹è¯•æ•°æ®åº“æˆ–æ˜ç¡®çš„çœŸå®åº“ï¼‰
# - é…ç½®æ¥æºæ¸…æ™°ï¼ˆè¦ä¹ˆçº¯ jest.setup æ‰‹åŠ¨è®¾ç½®ï¼Œè¦ä¹ˆçº¯ .env.testï¼‰
```

---

**é—®é¢˜**ï¼š

- ç›´è¿ MySQLï¼ˆæœªè®¾ç½®ä¼šè¯æ—¶åŒºï¼‰æ—¶ä¼šä½¿ç”¨ UTCï¼Œå¯èƒ½å¯¼è‡´æ—¶é—´æŸ¥è¯¢/è®¡ç®—ä¸ä¸€è‡´
- ä¾èµ– DB global æ—¶åŒºä¸å¯æ§ï¼ˆéœ€è¦ DBA æƒé™ä¸”å½±å“é¢å¤§ï¼‰

**è§£å†³æ–¹æ¡ˆï¼ˆå·²ç¡®è®¤ï¼‰**ï¼š

- âœ… **æ ‡å‡†è¦æ±‚**ï¼š**æ¯ä¸ªåº”ç”¨è¿æ¥éƒ½æ˜¾å¼è®¾ç½®ä¼šè¯æ—¶åŒº `+08:00`**ï¼ˆå½“å‰ Sequelize å·²åšåˆ°ï¼‰
- âœ… **ä¸å¼ºåˆ¶ä¿®æ”¹ DB global time_zone**ï¼ˆä¿æŒå½“å‰"åº”ç”¨å±‚å¼ºåˆ¶ä¼šè¯æ—¶åŒº"çš„åšæ³•ï¼‰
- âœ… **è·¯å¾„ Aï¼ˆæ¨èï¼‰**ï¼šåº”ç”¨å±‚ä¿è¯æ¯ä¸ªè¿æ¥ `SET time_zone='+08:00'`ï¼Œä¸åŠ¨ DB globalï¼ˆä½é£é™©ã€å¯æ§ï¼‰

**éªŒæ”¶æ ‡å‡†**ï¼š

- [ ] ç¡®è®¤ `config/database.js` çš„ Sequelize é…ç½®åŒ…å« `timezone: '+08:00'`
- [ ] ç¡®è®¤ `dialectOptions` åŒ…å«æ—¶åŒºè®¾ç½®ï¼ˆå¦‚ `timezone: '+08:00'` æˆ–åœ¨è¿æ¥åæ‰§è¡Œ `SET time_zone='+08:00'`ï¼‰
- [ ] æ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢ä½¿ç”¨çš„æ—¶é—´æˆ³ä¸åŒ—äº¬æ—¶é—´ä¸€è‡´ï¼ˆé€šè¿‡æ—¥å¿—/æµ‹è¯•éªŒè¯ï¼‰
- [ ] æ–‡æ¡£è®°å½•"DB global ä»ä¸º UTC/SYSTEMï¼Œåº”ç”¨å±‚å¼ºåˆ¶ä¼šè¯æ—¶åŒº"ä½œä¸ºæ ‡å‡†åšæ³•

**å¤‡é€‰æ–¹æ¡ˆï¼ˆæœªæ¥éœ€è¦æ—¶ï¼‰**ï¼š

- **è·¯å¾„ Bï¼ˆé«˜é£é™©ï¼‰**ï¼šä¿®æ”¹ DB global `time_zone='+08:00'`ï¼ˆéœ€è¦ DBA æƒé™ï¼Œå½±å“åŒåº“å…¶ä»–å®¢æˆ·ç«¯ï¼Œä»…åœ¨ä»¥ä¸‹æƒ…å†µè€ƒè™‘ï¼‰ï¼š
  - æœ‰å¾ˆå¤šé Sequelize å®¢æˆ·ç«¯ï¼ˆæ‰‹å·¥è„šæœ¬ã€BIã€è¿ç§»å·¥å…·ï¼‰ç»å¸¸ç›´è¿ä¸”å¿˜è®° `SET time_zone`
  - å›¢é˜Ÿè¦æ±‚"æ•°æ®åº“å±‚ä¹Ÿç»Ÿä¸€åŒ—äº¬æ—¶é—´"ä½œä¸ºå¼ºåˆ¶æ ‡å‡†

---

## ğŸ¯ ç»Ÿä¸€æ–¹æ¡ˆè®¾è®¡

### æ ¸å¿ƒåŸåˆ™ï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰

1. **å•ä¸€çœŸç›¸æº**ï¼šæ‰€æœ‰è¿è¡Œé…ç½®åªæ¥è‡ª `.env` æ–‡ä»¶
2. **PM2 åªè´Ÿè´£è¿›ç¨‹ç®¡ç†**ï¼š`ecosystem.config.js` ä¸æ‰¿è½½çœŸå®ä¸šåŠ¡é…ç½®ï¼ˆä»…è´Ÿè´£è¿›ç¨‹å¯åŠ¨å‚æ•°ï¼‰
3. **ç»Ÿä¸€é‡å¯æ–¹å¼**ï¼šå¼ºåˆ¶ä½¿ç”¨ `--update-env` ç¡®ä¿é…ç½®å˜æ›´ç”Ÿæ•ˆ
4. **dotenv ä¼˜å…ˆçº§ç­–ç•¥**ï¼šå…¨ä»“åº“ç¦æ­¢ `override`ï¼ˆç»Ÿä¸€"ç³»ç»Ÿ/PM2 env > .env è¡¥é½"ï¼Œåº”ç”¨/è„šæœ¬/æµ‹è¯•æ— ä¾‹å¤–ï¼‰
5. **Redis é…ç½®è§„èŒƒ**ï¼š**æ–¹æ¡ˆ A - åªç”¨ `REDIS_URL`ï¼ˆä¸å…¼å®¹æ—§å†™æ³•ï¼Œå¿…é¡»è¦æœ‰ Redisï¼‰**
   - **é…ç½®æ ¼å¼**ï¼š`REDIS_URL=redis://localhost:6379` æˆ– `redis://:password@host:port/db` æˆ– `rediss://...`ï¼ˆTLSï¼‰
   - **ç ´åæ€§å˜æ›´**ï¼š`REDIS_HOST/REDIS_PORT` ç«‹å³å¤±æ•ˆï¼Œä¸åšå…¼å®¹å›é€€
   - **ç¯å¢ƒè¡Œä¸º**ï¼š**æ‰€æœ‰ç¯å¢ƒ**ï¼ˆç”Ÿäº§/é¢„å‘/å¼€å‘/å•æµ‹ï¼‰ç¼º `REDIS_URL` ç›´æ¥å¯åŠ¨å¤±è´¥ï¼ˆfail-fastï¼‰ï¼ŒRedis ä¸ºç³»ç»Ÿå¿…éœ€ä¾èµ–
6. **è¿›ç¨‹ç®¡ç†å…¥å£**ï¼šå”¯ä¸€å…¥å£ä¸º `npm run pm:*`ï¼Œå…¶ä»–è„šæœ¬ï¼ˆ`start-service.sh`ã€`å¿«é€Ÿç®¡ç†è„šæœ¬.sh`ï¼‰ç›´æ¥åˆ é™¤
7. **æµ‹è¯•ç¯å¢ƒç­–ç•¥**ï¼šå…è®¸è¿çœŸå®åº“ï¼ˆç»§ç»­å…±ç”¨ `restaurant_points_dev`ï¼‰
8. **å†å²æ•æ„Ÿä¿¡æ¯**ï¼šä¸åšå¯†é’¥è½®æ¢/git å†å²æ¸…ç†ï¼ˆæ¥å—ç°çŠ¶ï¼‰

### ecosystem.config.js çš„èŒè´£å®šä½ï¼ˆè¿›ç¨‹ç®¡ç†ï¼Œè€Œä¸æ˜¯é…ç½®ç®¡ç†ï¼‰

**ä¿ç•™çš„èŒè´£**ï¼š

- âœ… **è¿›ç¨‹å¯åŠ¨å…¥å£**ï¼šå‘Šè¯‰ PM2 ç”¨ä»€ä¹ˆè„šæœ¬å¯åŠ¨ï¼ˆ`script`ã€`cwd`ã€`instances`ã€`exec_mode`ï¼‰
- âœ… **è¿è¡Œè¡Œä¸ºæ§åˆ¶**ï¼š`watch`ã€`autorestart`ã€`max_memory_restart`ã€æ—¥å¿—è·¯å¾„/æ ¼å¼ç­‰
- âœ… **ä»æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡**ï¼šé€šè¿‡ `env_file: '.env'` æŠŠ `.env` æ³¨å…¥ç»™è¿›ç¨‹ï¼ˆè¿™æ˜¯"å”¯ä¸€é…ç½®æº"è·¯å¾„ï¼‰

**ä¸å†æ‰¿è½½çš„èŒè´£**ï¼š

- âŒ **ä¸šåŠ¡é…ç½®**ï¼š`DB_HOST/DB_PORT/DB_NAME/DB_USER/DB_PASSWORD/JWT_SECRET/REDIS_URL` ç­‰å¿…é¡»å…¨éƒ¨åˆ é™¤
- âŒ **é»˜è®¤å€¼å…œåº•**ï¼š`NODE_ENV`ã€`PORT` çš„é»˜è®¤å€¼ä¹Ÿä¸ä¿ç•™ï¼ˆçœŸå®å€¼å¿…é¡»ä»¥ `.env` ä¸ºå‡†ï¼‰
- âŒ **`env:{...}` å®Œå…¨æ¸…ç©º**ï¼šä¸ä¿ç•™ä»»ä½•ä¸šåŠ¡é…ç½®æˆ–é»˜è®¤å€¼ï¼ˆä»…ä¿ç•™ `env_file: '.env'`ï¼‰

---

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Sealos Devbox ç¯å¢ƒ              â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      .env (å”¯ä¸€é…ç½®æº)           â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚
â”‚  â”‚  NODE_ENV=development           â”‚   â”‚
â”‚  â”‚  PORT=3000                      â”‚   â”‚
â”‚  â”‚  TZ=Asia/Shanghai               â”‚   â”‚
â”‚  â”‚  DB_HOST=dbconn.sealosbja.site  â”‚   â”‚
â”‚  â”‚  DB_PORT=42569                  â”‚   â”‚
â”‚  â”‚  DB_NAME=restaurant_points_dev  â”‚   â”‚
â”‚  â”‚  DB_USER=root                   â”‚   â”‚
â”‚  â”‚  DB_PASSWORD=***                â”‚   â”‚
â”‚  â”‚  JWT_SECRET=***                 â”‚   â”‚
â”‚  â”‚  REDIS_URL=redis://localhost:6379 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â†“ (env_file)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ecosystem.config.js (ç®€åŒ–ç‰ˆ)    â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚
â”‚  â”‚  env_file: '.env'               â”‚   â”‚
â”‚  â”‚  env: {                         â”‚   â”‚
â”‚  â”‚    // ä»…ä¿ç•™éæ•æ„Ÿé»˜è®¤å€¼        â”‚   â”‚
â”‚  â”‚  }                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â†“ (pm2 start)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚       PM2 è¿›ç¨‹ç®¡ç†å™¨             â”‚   â”‚
â”‚  â”‚   restaurant-lottery-backend    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â†“                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚     Node.js åº”ç”¨è¿›ç¨‹             â”‚   â”‚
â”‚  â”‚   process.env è¯»å–æ‰€æœ‰é…ç½®       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ å®æ–½æ­¥éª¤

### æ­¥éª¤ 1ï¼šæ¸…ç† `ecosystem.config.js` ä¸­çš„é‡å¤é…ç½®

**å½“å‰çŠ¶æ€**ï¼ˆéœ€è¦åˆ é™¤çš„éƒ¨åˆ†ï¼‰ï¼š

```javascript
env: {
  NODE_ENV: 'development',
  PORT: 3000,
  TZ: 'Asia/Shanghai',

  // âŒ è¿™äº›çœŸå®é…ç½®å¿…é¡»åˆ é™¤
  DB_HOST: 'dbconn.sealosbja.site',
  DB_PORT: 42569,
  DB_NAME: 'restaurant_points_dev',
  DB_USER: 'root',
  DB_PASSWORD: '***',
  JWT_SECRET: '***',
  JWT_REFRESH_SECRET: '***',
  REDIS_URL: 'redis://localhost:6379'
}
```

**ä¿®æ”¹åï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰**ï¼š

```javascript
module.exports = {
  apps: [
    {
      name: 'restaurant-lottery-backend',
      script: 'app.js',
      instances: 1,
      exec_mode: 'fork',

      // âœ… å”¯ä¸€é…ç½®æºï¼šä» .env åŠ è½½
      env_file: '.env',

      // âœ… env å®Œå…¨æ¸…ç©ºï¼ˆä¸ä¿ç•™ä»»ä½•ä¸šåŠ¡é…ç½®æˆ–é»˜è®¤å€¼ï¼‰
      // æ³¨æ„ï¼šä¸å†ä¿ç•™ NODE_ENV/PORT/TZ ç­‰é»˜è®¤å€¼ï¼ŒçœŸå®å€¼å¿…é¡»åœ¨ .env ä¸­é…ç½®

      // PM2 è¿›ç¨‹ç®¡ç†å‚æ•°ï¼ˆä»…è´Ÿè´£"æ€ä¹ˆè·‘"ï¼Œä¸è´Ÿè´£"è·‘ä»€ä¹ˆå‚æ•°"ï¼‰
      watch: false,
      max_memory_restart: '512M',
      error_file: './logs/error.log',
      out_file: './logs/out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss Z',

      // è‡ªåŠ¨é‡å¯é…ç½®
      autorestart: true,
      max_restarts: 10,
      min_uptime: '10s',
      restart_delay: 1000
    }
  ]
}
```

---

### æ­¥éª¤ 2ï¼šç¡®ä¿ `.env` åŒ…å«æ‰€æœ‰å¿…éœ€é…ç½®

**æ£€æŸ¥æ¸…å•**ï¼ˆ`.env` å¿…é¡»åŒ…å«ï¼‰ï¼š

```bash
# === è¿è¡Œç¯å¢ƒ ===
NODE_ENV=development
PORT=3000
TZ=Asia/Shanghai

# === æ•°æ®åº“é…ç½®ï¼ˆSealos å¤–ç½‘æ•°æ®åº“ï¼‰===
DB_HOST=dbconn.sealosbja.site
DB_PORT=42569
DB_NAME=restaurant_points_dev
DB_USER=root
DB_PASSWORD=ä½ çš„çœŸå®å¯†ç ï¼ˆè„±æ•ï¼Œä¸è¦å†™è¿›æ–‡æ¡£/æ—¥å¿—ï¼‰

# === JWT é…ç½® ===
JWT_SECRET=ä½ çš„JWTå¯†é’¥
JWT_REFRESH_SECRET=ä½ çš„åˆ·æ–°ä»¤ç‰Œå¯†é’¥

# === Redis é…ç½®ï¼ˆæ–¹æ¡ˆ Aï¼šåªç”¨ REDIS_URLï¼‰===
REDIS_URL=redis://localhost:6379
# æˆ–å¸¦å¯†ç ï¼šREDIS_URL=redis://:your_password@host:6379/0
# æˆ– TLSï¼šREDIS_URL=rediss://host:6380/0
# âŒ æ³¨æ„ï¼šä¸å†ä½¿ç”¨ REDIS_HOST/REDIS_PORTï¼ˆå·²åºŸå¼ƒï¼Œä¸åšå…¼å®¹ï¼‰

# === Sealos é…ç½®ï¼ˆå¦‚éœ€è¦ï¼‰===
SEALOS_ENDPOINT=https://cloud.sealos.io
# SEALOS_TOKEN=ï¼ˆå¦‚æœ‰ï¼‰

# === æ—¥å¿—é…ç½® ===
LOG_LEVEL=debug

# === API ç‰ˆæœ¬ ===
API_VERSION=v4
```

**éªŒè¯å‘½ä»¤**ï¼š

```bash
# æ£€æŸ¥ .env æ˜¯å¦åŒ…å«æ‰€æœ‰å¿…éœ€å˜é‡
node -e "
require('dotenv').config();
const required = ['NODE_ENV', 'PORT', 'TZ', 'DB_HOST', 'DB_PORT', 'DB_NAME', 'DB_USER', 'DB_PASSWORD', 'JWT_SECRET', 'REDIS_URL'];
const missing = required.filter(k => !process.env[k]);
if (missing.length > 0) {
  console.error('âŒ ç¼ºå°‘å¿…éœ€ç¯å¢ƒå˜é‡:', missing);
  process.exit(1);
} else {
  console.log('âœ… æ‰€æœ‰å¿…éœ€ç¯å¢ƒå˜é‡å·²é…ç½®');
  // æ£€æŸ¥æ˜¯å¦è¿˜æ®‹ç•™æ—§çš„ REDIS_HOST/REDIS_PORTï¼ˆåº”è¯¥åˆ é™¤ï¼‰
  if (process.env.REDIS_HOST || process.env.REDIS_PORT) {
    console.warn('âš ï¸ æ£€æµ‹åˆ°å·²åºŸå¼ƒçš„ REDIS_HOST/REDIS_PORTï¼Œè¯·åˆ é™¤ï¼ˆä»…ä¿ç•™ REDIS_URLï¼‰');
  }
}
"
```

---

### æ­¥éª¤ 3ï¼šç»Ÿä¸€ PM2 é‡å¯æ–¹å¼

**ä¿®æ”¹ `scripts/system/process-manager.sh`**ï¼š

åœ¨ `start_service` å‡½æ•°çš„ PM2 å¯åŠ¨éƒ¨åˆ†ï¼Œæ·»åŠ è¯´æ˜ï¼š

```bash
"pm2")
    log_info "ä½¿ç”¨PM2å¯åŠ¨æœåŠ¡..."
    pm2 start ecosystem.config.js
    sleep 3
    pm2 status
    log_info "æç¤ºï¼šä¿®æ”¹ .env åè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é‡å¯ï¼š"
    log_info "  pm2 restart restaurant-lottery-backend --update-env"
    ;;
```

**åœ¨ `full_restart` å‡½æ•°ä¸­ä½¿ç”¨ `--update-env`**ï¼š

```bash
full_restart() {
    local mode=${1:-"auto"}

    log_info "æ‰§è¡Œå®Œæ•´æ¸…ç†å’Œé‡å¯..."

    # 1. åœæ­¢æ‰€æœ‰ç›¸å…³æœåŠ¡
    stop_pm2_apps
    cleanup_all_node_processes
    cleanup_port_conflicts

    # 2. ç­‰å¾…è¿›ç¨‹æ¸…ç†å®Œæˆ
    sleep 3

    # 3. éªŒè¯æ¸…ç†ç»“æœ
    if check_port_conflicts; then
        log_success "ç«¯å£æ¸…ç†æˆåŠŸ"
    else
        log_error "ç«¯å£æ¸…ç†å¤±è´¥ï¼Œè¯·æ£€æŸ¥"
        exit 1
    fi

    # 4. å¯åŠ¨æœåŠ¡
    if [ "$mode" = "pm2" ] || [ "$mode" = "auto" ]; then
        log_info "ä½¿ç”¨PM2å¯åŠ¨æœåŠ¡ï¼ˆåŠ è½½æœ€æ–°ç¯å¢ƒå˜é‡ï¼‰..."
        pm2 start ecosystem.config.js
        log_success "æœåŠ¡å·²å¯åŠ¨ï¼Œç¯å¢ƒå˜é‡å·²ä» .env åŠ è½½"
    else
        start_service "$mode"
    fi
}
```

**æ·»åŠ ä¸“ç”¨çš„"é…ç½®é‡è½½"å‘½ä»¤**ï¼š

åœ¨ `main()` å‡½æ•°ä¸­æ·»åŠ æ–°å‘½ä»¤ï¼š

```bash
"reload"|"reload-env")
    log_info "é‡æ–°åŠ è½½ç¯å¢ƒå˜é‡å¹¶é‡å¯æœåŠ¡..."
    if command -v pm2 &> /dev/null; then
        pm2 restart restaurant-lottery-backend --update-env
        sleep 2
        pm2 status
        log_success "ç¯å¢ƒå˜é‡å·²é‡æ–°åŠ è½½"
    else
        log_error "PM2æœªå®‰è£…ï¼Œæ— æ³•æ‰§è¡Œreload"
        exit 1
    fi
    ;;
```

---

### æ­¥éª¤ 4ï¼šä¿®æ”¹å…¶ä»–è„šæœ¬ä¸­çš„ PM2 é‡å¯å‘½ä»¤

**æŸ¥æ‰¾éœ€è¦ä¿®æ”¹çš„è„šæœ¬**ï¼š

```bash
grep -r "pm2 restart" scripts/ --include="*.js" --include="*.sh"
```

**ä¿®æ”¹ç¤ºä¾‹**ï¼ˆ`scripts/migration/execute-migration-now.js`ï¼‰ï¼š

**å½“å‰ä»£ç **ï¼š

```javascript
execSync('pm2 restart all', { stdio: 'inherit' })
```

**ä¿®æ”¹ä¸º**ï¼š

```javascript
execSync('pm2 restart restaurant-lottery-backend --update-env', { stdio: 'inherit' })
```

**æ¶‰åŠçš„æ–‡ä»¶**ï¼š

- `scripts/migration/execute-migration-now.js`ï¼ˆ2å¤„ï¼‰
- `scripts/verify_old_apis_deleted.sh`ï¼ˆ1å¤„ï¼‰
- `scripts/delete_old_chat_apis.sh`ï¼ˆ2å¤„ï¼‰
- `start-service.sh`ï¼ˆ1å¤„ï¼‰

---

## ğŸ“ æ ‡å‡†æ“ä½œæµç¨‹

### ç»Ÿä¸€å¯åŠ¨æ–¹å¼å¿«é€Ÿå‚è€ƒ

| æ“ä½œ            | ç»Ÿä¸€å‘½ä»¤ï¼ˆæ¨èï¼‰        | ç­‰ä»·å‘½ä»¤                                             | è¯´æ˜                                        |
| --------------- | ----------------------- | ---------------------------------------------------- | ------------------------------------------- |
| ğŸš€ å¯åŠ¨æœåŠ¡     | `npm run pm:start:pm2`  | `bash scripts/system/process-manager.sh start pm2`   | PM2 ç”Ÿäº§æ¨¡å¼å¯åŠ¨                            |
| ğŸ”„ é‡å¯æœåŠ¡     | `npm run pm:restart`    | `bash scripts/system/process-manager.sh restart pm2` | è‡ªåŠ¨æ¸…ç†å†²çª+é‡å¯                           |
| ğŸ”„ é‡æ–°åŠ è½½é…ç½® | `npm run pm:reload-env` | `bash scripts/system/process-manager.sh reload-env`  | **ä¿®æ”¹ `.env` åå¿…ç”¨**ï¼ˆå¸¦ `--update-env`ï¼‰ |
| ğŸ›‘ åœæ­¢æœåŠ¡     | `npm run pm:stop`       | `bash scripts/system/process-manager.sh stop`        | åœæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹                            |
| ğŸ“Š æŸ¥çœ‹çŠ¶æ€     | `npm run pm:status`     | `bash scripts/system/process-manager.sh status`      | ç«¯å£+è¿›ç¨‹+å¥åº·æ£€æŸ¥                          |
| ğŸ“ æŸ¥çœ‹æ—¥å¿—     | `npm run pm:logs`       | `bash scripts/system/process-manager.sh logs`        | å®æ—¶æ—¥å¿—ï¼ˆCtrl+C é€€å‡ºï¼‰                     |
| ğŸ” æŸ¥çœ‹è¯¦æƒ…     | `npm run pm:show`       | `bash scripts/system/process-manager.sh show`        | PM2 è¿›ç¨‹è¯¦ç»†ä¿¡æ¯                            |
| ğŸ§¹ æ¸…ç†å†²çª     | `npm run pm:cleanup`    | `bash scripts/system/process-manager.sh cleanup`     | æ¸…ç†ç«¯å£å†²çªè¿›ç¨‹                            |
| ğŸ§¹ æ¸…ç†æ—¥å¿—     | `npm run pm:flush-logs` | `bash scripts/system/process-manager.sh flush-logs`  | æ¸…ç† PM2 æ—¥å¿—                               |
| ğŸ¥ å¥åº·æ£€æŸ¥     | `npm run pm:health`     | `bash scripts/system/process-manager.sh health`      | å®Œæ•´å¥åº·æ£€æŸ¥ï¼ˆAPI/PM2/ç«¯å£/Redisï¼‰          |
| ğŸ’» å¼€å‘æ¨¡å¼     | `npm run pm:start:dev`  | `bash scripts/system/process-manager.sh start dev`   | nodemon çƒ­é‡è½½                              |

**æ ¸å¿ƒåŸåˆ™**ï¼š

- âœ… ç»Ÿä¸€ä½¿ç”¨ `npm run pm:*` å‘½ä»¤
- âœ… é¿å…ç›´æ¥ä½¿ç”¨ `pm2 start/restart` å‘½ä»¤
- âœ… ä¿®æ”¹ `.env` åå¿…é¡»ä½¿ç”¨ `npm run pm:reload-env`ï¼ˆæˆ– `pm:restart`ï¼‰
- âœ… æ‰€æœ‰é…ç½®åªæ¥è‡ª `.env` æ–‡ä»¶

---

### æ—¥å¸¸æ“ä½œ

#### 1. å¯åŠ¨æœåŠ¡ï¼ˆç»Ÿä¸€æ ‡å‡†æ–¹å¼ï¼‰

```bash
# âœ… æ¨èï¼šä½¿ç”¨ npm scripts ç»Ÿä¸€å¯åŠ¨æ–¹å¼
npm run pm:start:pm2

# ç­‰ä»·äº
bash scripts/system/process-manager.sh start pm2

# æˆ–ç›´æ¥ä½¿ç”¨ PM2ï¼ˆä¸æ¨èï¼Œç¼ºå°‘é¢„æ£€æŸ¥ï¼‰
pm2 start ecosystem.config.js
```

**è¯´æ˜**ï¼š

- `npm run pm:start:pm2` æ˜¯é¡¹ç›®æ ‡å‡†å¯åŠ¨æ–¹å¼
- è‡ªåŠ¨æ‰§è¡Œç«¯å£å†²çªæ£€æŸ¥ã€è¿›ç¨‹æ¸…ç†ã€å¥åº·éªŒè¯
- ç¡®ä¿ä» `.env` åŠ è½½æ‰€æœ‰é…ç½®

#### 2. ä¿®æ”¹é…ç½®åé‡å¯ï¼ˆç»Ÿä¸€æ ‡å‡†æ–¹å¼ï¼‰

```bash
# æ­¥éª¤ 1ï¼šç¼–è¾‘ .env æ–‡ä»¶
vim .env

# æ­¥éª¤ 2ï¼šâœ… æ¨èä½¿ç”¨ä¸“ç”¨çš„ reload-env å‘½ä»¤ï¼ˆæœ€å¿«ã€æœ€å®‰å…¨ï¼‰
npm run pm:reload-env

# æˆ–ä½¿ç”¨å®Œæ•´é‡å¯ï¼ˆä¼šæ¸…ç†å†²çªè¿›ç¨‹ï¼Œæ›´å½»åº•ä½†ç¨æ…¢ï¼‰
npm run pm:restart

# ç­‰ä»·çš„åº•å±‚å‘½ä»¤
bash scripts/system/process-manager.sh reload-env
bash scripts/system/process-manager.sh restart pm2

# æˆ–ä½¿ç”¨ PM2 ç›´æ¥é‡å¯ï¼ˆç¡®ä¿ä½¿ç”¨ --update-envï¼‰
pm2 reload ecosystem.config.js --update-env
pm2 save  # ä¿å­˜çŠ¶æ€
```

**é‡è¦**ï¼š

- ä¿®æ”¹ `.env` åå¿…é¡»é‡å¯æ‰èƒ½ç”Ÿæ•ˆ
- **ä¼˜å…ˆä½¿ç”¨ `npm run pm:reload-env`**ï¼ˆä¸“é—¨ç”¨äºé…ç½®å˜æ›´ï¼Œå¸¦ `--update-env` + `pm2 save`ï¼‰
- å¦‚æœ `reload-env` ä¸ç”Ÿæ•ˆï¼Œä½¿ç”¨ `npm run pm:restart`ï¼ˆå®Œæ•´æ¸…ç†+é‡å¯ï¼‰

#### 3. éªŒè¯é…ç½®æ˜¯å¦ç”Ÿæ•ˆ

```bash
# æŸ¥çœ‹ PM2 è¿›ç¨‹çš„å®é™…ç¯å¢ƒå˜é‡
pm2 show restaurant-lottery-backend | grep -A 20 "env:"

# æˆ–è€…æŸ¥çœ‹åº”ç”¨æ—¥å¿—ä¸­çš„é…ç½®ä¿¡æ¯
pm2 logs restaurant-lottery-backend --lines 50 | grep "DB_HOST\\|REDIS_URL"

# å¥åº·æ£€æŸ¥
curl http://localhost:3000/health
```

#### 4. åœæ­¢æœåŠ¡ï¼ˆç»Ÿä¸€æ ‡å‡†æ–¹å¼ï¼‰

```bash
# âœ… æ¨èï¼šä½¿ç”¨ npm scripts ç»Ÿä¸€åœæ­¢æ–¹å¼
npm run pm:stop

# ç­‰ä»·äº
bash scripts/system/process-manager.sh stop

# æˆ–ç›´æ¥ä½¿ç”¨ PM2
pm2 stop restaurant-lottery-backend
pm2 delete restaurant-lottery-backend
```

#### 5. æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
# âœ… æ¨èï¼šä½¿ç”¨ npm scripts æŸ¥çœ‹çŠ¶æ€
npm run pm:status

# ç­‰ä»·äº
bash scripts/system/process-manager.sh status

# æˆ–ç›´æ¥ä½¿ç”¨ PM2
pm2 status
pm2 logs restaurant-lottery-backend
```

#### 6. å®Œæ•´çš„ npm scripts å‘½ä»¤æ¸…å•

```bash
# è¿›ç¨‹ç®¡ç†ç›¸å…³å‘½ä»¤ï¼ˆéƒ½åœ¨ package.json ä¸­å®šä¹‰ï¼‰
npm run pm:status        # æŸ¥çœ‹æœåŠ¡çŠ¶æ€
npm run pm:start:pm2     # ä½¿ç”¨ PM2 å¯åŠ¨
npm run pm:start:dev     # ä½¿ç”¨ nodemon å¼€å‘æ¨¡å¼å¯åŠ¨
npm run pm:restart       # é‡å¯æœåŠ¡
npm run pm:reload-env    # é‡æ–°åŠ è½½ .env é…ç½®ï¼ˆä¿®æ”¹é…ç½®åå¿…ç”¨ï¼‰
npm run pm:stop          # åœæ­¢æœåŠ¡
npm run pm:logs          # æŸ¥çœ‹å®æ—¶æ—¥å¿—
npm run pm:show          # æŸ¥çœ‹æœåŠ¡è¯¦ç»†ä¿¡æ¯
npm run pm:cleanup       # æ¸…ç†å†²çªè¿›ç¨‹
npm run pm:flush-logs    # æ¸…ç† PM2 æ—¥å¿—
npm run pm:health        # å®Œæ•´å¥åº·æ£€æŸ¥
npm run pm:help          # æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯
```

---

## âœ… éªŒè¯æ–¹æ¡ˆæ˜¯å¦ç”Ÿæ•ˆ

### éªŒè¯æ£€æŸ¥æ¸…å•

#### âœ“ é…ç½®æºå”¯ä¸€æ€§

```bash
# 1. æ£€æŸ¥ ecosystem.config.js æ˜¯å¦å·²æ¸…ç†æ•æ„Ÿé…ç½®
grep -E "DB_PASSWORD|JWT_SECRET|REDIS" ecosystem.config.js
# é¢„æœŸï¼šæ— è¾“å‡ºï¼ˆå·²åˆ é™¤ï¼‰

# 2. æ£€æŸ¥ .env æ˜¯å¦åŒ…å«æ‰€æœ‰é…ç½®ï¼ˆæ–¹æ¡ˆ Aï¼šåªè®¤ REDIS_URLï¼‰
grep -E "DB_HOST|DB_PORT|JWT_SECRET|REDIS_URL" .env
# é¢„æœŸï¼šæœ‰è¾“å‡ºï¼ˆå­˜åœ¨ï¼‰

# 3. æ£€æŸ¥æ˜¯å¦è¿˜æ®‹ç•™æ—§çš„ REDIS_HOST/REDIS_PORTï¼ˆåº”åˆ é™¤ï¼‰
grep -E "^REDIS_HOST=|^REDIS_PORT=" .env
# é¢„æœŸï¼šæ— è¾“å‡ºï¼ˆå·²åˆ é™¤ï¼Œåªä¿ç•™ REDIS_URLï¼‰
```

#### âœ“ PM2 ç¯å¢ƒå˜é‡åŠ è½½

```bash
# å¯åŠ¨æœåŠ¡
pm2 start ecosystem.config.js

# æ£€æŸ¥è¿›ç¨‹ç¯å¢ƒå˜é‡
pm2 show restaurant-lottery-backend | grep -A 30 "env:"

# éªŒè¯å…³é”®é…ç½®
pm2 show restaurant-lottery-backend | grep "DB_HOST"
# é¢„æœŸï¼šæ˜¾ç¤º .env ä¸­é…ç½®çš„å€¼
```

#### âœ“ é…ç½®ä¿®æ”¹ç”Ÿæ•ˆ

```bash
# 1. ä¿®æ”¹ .env ä¸­çš„æŸä¸ªé…ç½®ï¼ˆå¦‚ LOG_LEVELï¼‰
echo "LOG_LEVEL=info" >> .env

# 2. é‡å¯å¹¶åŠ è½½æ–°é…ç½®
pm2 restart restaurant-lottery-backend --update-env

# 3. éªŒè¯æ˜¯å¦ç”Ÿæ•ˆ
pm2 logs restaurant-lottery-backend --lines 10
# é¢„æœŸï¼šæ—¥å¿—çº§åˆ«å·²å˜æ›´
```

---

## ğŸš¨ å¸¸è§é—®é¢˜æ’æŸ¥

### æœ¯è¯­è¯´æ˜ï¼šä»€ä¹ˆæ˜¯"ç¯å¢ƒå˜é‡"ä¸"åŒåå˜é‡"

**ç¯å¢ƒå˜é‡ï¼ˆEnvironment Variablesï¼‰**ï¼šè¿è¡Œåç«¯æ—¶ `process.env` é‡Œçš„é”®å€¼å¯¹ï¼Œä¾‹å¦‚ï¼š

- **æœåŠ¡è¿è¡Œç±»**ï¼š`NODE_ENV`ã€`PORT`ã€`TZ`
- **æ•°æ®åº“ç±»**ï¼š`DB_HOST`ã€`DB_PORT`ã€`DB_NAME`ã€`DB_USER`ã€`DB_PASSWORD`
- **è®¤è¯å¯†é’¥ç±»**ï¼š`JWT_SECRET`ã€`JWT_REFRESH_SECRET`
- **Redis ç±»**ï¼š`REDIS_URL`
- **ç¬¬ä¸‰æ–¹ç±»**ï¼š`SEALOS_ENDPOINT`ã€`WX_APPID` ç­‰

**ç¯å¢ƒå˜é‡çš„ 3 ä¸ªæ¥æº**ï¼ˆä½ é¡¹ç›®å½“å‰å­˜åœ¨çš„ï¼‰ï¼š

1. **`.env` æ–‡ä»¶**ï¼š`KEY=VALUE` æ ¼å¼
2. **PM2 æ³¨å…¥**ï¼š`ecosystem.config.js` çš„ `env_file` / `env`
3. **ç³»ç»Ÿ/å¯åŠ¨ shell æ³¨å…¥**ï¼šå®¹å™¨å¹³å°ã€`export` å‡ºæ¥çš„å˜é‡

**åŒåå˜é‡**ï¼šæŒ‡åŒä¸€ä¸ªé”®ï¼ˆä¾‹å¦‚ `DB_HOST`ï¼‰åŒæ—¶å­˜åœ¨äºå¤šä¸ªæ¥æºï¼ˆä¾‹å¦‚ `.env` é‡Œæœ‰ã€`ecosystem.config.js env` é‡Œä¹Ÿæœ‰ï¼‰ï¼Œå¯¼è‡´"æ”¹äº†ä¸€å¤„ä½†å¦ä¸€å¤„ä¼˜å…ˆçº§æ›´é«˜"çš„é—®é¢˜ã€‚

---

### Q1: ä¿®æ”¹ `.env` åé‡å¯æ²¡ç”Ÿæ•ˆï¼Ÿ

**åŸå› **ï¼šæœªä½¿ç”¨ `--update-env` å‚æ•°

**è§£å†³**ï¼š

```bash
# âŒ é”™è¯¯åšæ³•
pm2 restart restaurant-lottery-backend

# âœ… æ­£ç¡®åšæ³•
pm2 restart restaurant-lottery-backend --update-env
```

---

### Q2: ä¸ç¡®å®šå½“å‰è¿è¡Œçš„æ˜¯å“ªä¸ªé…ç½®ï¼Ÿ

**æ’æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æŸ¥çœ‹ PM2 è¿›ç¨‹å®é™…ç¯å¢ƒå˜é‡ï¼ˆå»ºè®®åª grep å…³é”®å­—æ®µï¼Œé¿å…æŠŠå¯†é’¥/å¯†ç æ‰“å°åˆ°ç»ˆç«¯ï¼‰
pm2 show restaurant-lottery-backend | grep -E "DB_HOST|DB_PORT|DB_NAME|DB_USER|REDIS_URL|TZ|NODE_ENV"

# 2. æŸ¥çœ‹åº”ç”¨å¯åŠ¨æ—¥å¿—ï¼ˆé…ç½®é¡¹ä¼šåœ¨å¯åŠ¨æ—¶æ‰“å°ï¼‰
pm2 logs restaurant-lottery-backend --lines 100

# 3. è¿›å…¥åº”ç”¨å®¹å™¨æ£€æŸ¥ç¯å¢ƒå˜é‡
pm2 exec "printenv | grep DB_"
```

---

### Q3: `.env` å’Œ `ecosystem.config.js env` åŒæ—¶å­˜åœ¨åŒåå˜é‡ï¼Œå“ªä¸ªä¼˜å…ˆï¼Ÿ

**å½“å‰ä¼˜å…ˆçº§æ··ä¹±çš„æ ¹æº**ï¼ˆé—®é¢˜ B çš„çœŸå®è¡¨ç°ï¼‰ï¼š

1. **åº”ç”¨å±‚ï¼ˆdevelopmentï¼‰**ï¼š`app.js` ä½¿ç”¨ `dotenv.config({ override: true })` â†’ `.env` ä¼šè¦†ç›–å·²æœ‰ `process.env`ï¼ˆåŒ…æ‹¬ PM2 æ³¨å…¥çš„ envï¼‰
2. **åº”ç”¨å±‚ï¼ˆé developmentï¼‰**ï¼šdotenv ä¸ override â†’ `.env` åªè¡¥é½ç¼ºå¤±é¡¹ï¼Œæ— æ³•è¦†ç›– PM2 env
3. **PM2 æ³¨å…¥å±‚**ï¼ˆåœ¨åº”ç”¨å¯åŠ¨å‰ï¼‰ï¼š`ecosystem.config.js env` > `env_file: '.env'` > å¯åŠ¨æ—¶ shell env

**ç»Ÿä¸€æ–¹æ¡ˆï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰**ï¼š

1. **åˆ é™¤ `ecosystem.config.js` ä¸­çš„ `env:{...}` æ‰€æœ‰å†…å®¹**ï¼ˆä¸ä¿ç•™ä»»ä½•ä¸šåŠ¡é…ç½®æˆ–é»˜è®¤å€¼ï¼‰
2. **ä¿®æ”¹ `app.js`**ï¼šç§»é™¤ `dotenv.config({ override: true })`ï¼Œæ‰€æœ‰ç¯å¢ƒç»Ÿä¸€ä½¿ç”¨ `dotenv.config()`ï¼ˆä¸ overrideï¼‰
3. **ç»Ÿä¸€ä¼˜å…ˆçº§æ¨¡å‹**ï¼šç³»ç»Ÿ/PM2 env > `.env` è¡¥é½ï¼ˆè·¨ç¯å¢ƒä¸€è‡´ã€å¯é¢„æµ‹ï¼‰
4. **`.env` å¿…é¡»åŒ…å«æ‰€æœ‰å¿…éœ€é…ç½®**ï¼ˆåŒ…æ‹¬ `NODE_ENV`ã€`PORT`ã€`TZ`ï¼‰ï¼Œä¸ä¾èµ–ä»»ä½•é»˜è®¤å€¼

---

### Q4: å¦‚ä½•ç¡®è®¤ PM2 è¯»å–äº† `.env` æ–‡ä»¶ï¼Ÿ

**éªŒè¯æ–¹æ³•**ï¼š

```bash
# åœ¨ .env ä¸­æ·»åŠ ä¸€ä¸ªæµ‹è¯•å˜é‡
echo "TEST_ENV_VAR=from_dotenv_file" >> .env

# é‡å¯å¹¶åŠ è½½
pm2 restart restaurant-lottery-backend --update-env

# æ£€æŸ¥æ˜¯å¦å­˜åœ¨
pm2 show restaurant-lottery-backend | grep "TEST_ENV_VAR"
# é¢„æœŸï¼šæ˜¾ç¤º "from_dotenv_file"
```

---

### Q5: é‡‡ç”¨æ–¹æ¡ˆåï¼Œå¦‚ä½•ä¿®æ”¹æŸä¸ªç¯å¢ƒå˜é‡ï¼ˆä¾‹å¦‚ `DB_HOST` / `JWT_SECRET`ï¼‰ï¼Ÿ

**æ ¸å¿ƒå˜åŒ–**ï¼šæ–¹æ¡ˆçš„ç›®æ ‡å°±æ˜¯è®©"åŒåå˜é‡"ä¸å†åŒæ—¶å­˜åœ¨äºå¤šå¤„â€”â€”åªå…è®¸ `.env` è¿™ä¸€å¤„æœ‰çœŸå®å€¼ã€‚

**æ ‡å‡†æµç¨‹**ï¼š

1. **æ­¥éª¤ 1**ï¼šåªä¿®æ”¹ `.env` é‡Œå¯¹åº”çš„é”®ï¼ˆè¿™å°±æ˜¯å”¯ä¸€çœŸç›¸æºï¼‰

   ```bash
   vim .env
   # ä¿®æ”¹ DB_HOST=æ–°å€¼
   ```

2. **æ­¥éª¤ 2**ï¼šç”¨ç»Ÿä¸€å…¥å£é‡å¯å¹¶å¼ºåˆ¶åˆ·æ–°ç¯å¢ƒå˜é‡

   ```bash
   # âœ… æ¨èï¼šä½¿ç”¨ç»Ÿä¸€å…¥å£
   npm run pm:restart

   # æˆ–ç­‰ä»·çš„
   pm2 restart restaurant-lottery-backend --update-env
   ```

**å¦‚æœå‘ç°"æ”¹äº† `.env` ä½†æ²¡ç”Ÿæ•ˆ"**ï¼ŒæŒ‰æ–¹æ¡ˆå®šä¹‰åªæœ‰ä¸¤ç±»åŸå› ï¼š

- **åŸå›  A**ï¼šè¿˜æœ‰å…¶å®ƒåœ°æ–¹æ®‹ç•™äº†åŒåå˜é‡
  - ä¾‹å¦‚ï¼š`ecosystem.config.js env:{...}` æˆ–æŸäº›è„šæœ¬é‡Œ `process.env.DB_HOST = ...`
  - **è§£å†³**ï¼šæŠŠæ®‹ç•™å¤„æ¸…æ‰ï¼ˆæ–¹æ¡ˆé‡Œå·²è¦æ±‚ `ecosystem.config.js env` æ¸…ç©ºã€ä¸ä¿ç•™å…œåº•ï¼‰

- **åŸå›  B**ï¼šé‡å¯æ²¡å¸¦ `--update-env`ï¼ˆPM2 æ²¡åˆ·æ–°ç¯å¢ƒï¼‰
  - **è§£å†³**ï¼šç”¨ `npm run pm:restart` æˆ– `pm2 restart ... --update-env`

---

### Q6: ä»¥åæ–°å¢ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œå¦‚ä½•é¿å…"åŒåå†²çª"ï¼Ÿ

**é¢„é˜²æªæ–½ï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰**ï¼š

1. **åªåœ¨ `.env` æ–°å¢**è¿™ä¸ªé”®

   ```bash
   echo "NEW_CONFIG_KEY=value" >> .env
   ```

2. **ä¸è¦**åœ¨ä»¥ä¸‹åœ°æ–¹å†å†™ä¸€ä»½åŒåå…œåº•/ç¡¬ç¼–ç ï¼ˆå¦åˆ™åŒåå†²çªåˆå›æ¥äº†ï¼‰ï¼š
   - âŒ `ecosystem.config.js env:{...}`
   - âŒ è„šæœ¬é‡Œ `process.env.NEW_CONFIG_KEY = ...`
   - âŒ æµ‹è¯•ä»£ç é‡Œ `process.env.NEW_CONFIG_KEY = ...`
   - âŒ `config.example` é‡Œå†™çœŸå®å€¼ï¼ˆåªå…è®¸å ä½ç¬¦ï¼‰

3. **éªŒè¯æ–°å˜é‡æ˜¯å¦ç”Ÿæ•ˆ**ï¼š

   ```bash
   # é‡å¯å¹¶åˆ·æ–°
   npm run pm:restart

   # æ£€æŸ¥æ˜¯å¦åŠ è½½
   pm2 show restaurant-lottery-backend | grep "NEW_CONFIG_KEY"
   ```

**å›¢é˜Ÿåä½œè§„èŒƒ**ï¼š

- æ–°å¢ç¯å¢ƒå˜é‡æ—¶ï¼Œåªæ›´æ–° `.env`ï¼ˆæœ¬åœ°ï¼‰å’Œ `.env.example`ï¼ˆä»“åº“æ¨¡æ¿ï¼Œä»…å ä½ç¬¦ï¼‰
- åœ¨ä»£ç é‡Œè¯»å–æ—¶ï¼Œç›´æ¥ç”¨ `process.env.NEW_CONFIG_KEY`ï¼ˆä¸è®¾é»˜è®¤å€¼ï¼‰
- å¦‚æœç¼ºå¤±å¿…éœ€å˜é‡ï¼Œè®© `config/environment.js` çš„æ ¡éªŒé€»è¾‘æŠ¥é”™ï¼ˆfail-fastï¼‰

---

## ğŸ“Š æ–¹æ¡ˆæ”¶ç›Š

### è§£å†³çš„é—®é¢˜å¯¹ç…§è¡¨

| åŸé—®é¢˜                           | ç»Ÿä¸€æ–¹æ¡ˆå          | æ”¶ç›Š                        |
| -------------------------------- | ------------------- | --------------------------- |
| é…ç½®æºé‡å¤ï¼ˆecosystem + .envï¼‰   | åªä¿ç•™ .env         | âœ… å•ä¸€çœŸç›¸æºï¼Œæ”¹ä¸€å¤„å³ç”Ÿæ•ˆ |
| ä¼˜å…ˆçº§æ··ä¹±ï¼ˆç³»ç»Ÿ > .env ä¸ç¨³å®šï¼‰ | .env å”¯ä¸€æ¥æº       | âœ… ä¼˜å…ˆçº§æ¸…æ™°ï¼Œæ— æ­§ä¹‰       |
| PM2 ç»§æ‰¿ shell env å¯¼è‡´å†²çª      | PM2 åªè¯» .env       | âœ… å¯åŠ¨ç¯å¢ƒéš”ç¦»ï¼Œå¯å¤ç°     |
| é‡å¯ä¸åŠ è½½æ–°é…ç½®                 | å¼ºåˆ¶ `--update-env` | âœ… é…ç½®å˜æ›´ç«‹å³ç”Ÿæ•ˆ         |
| éœ€è¦åŒæ—¶æ”¹ä¸¤å¤„é…ç½®               | åªæ”¹ .env           | âœ… é™ä½ç»´æŠ¤æˆæœ¬             |

### é‡åŒ–æ”¶ç›Š

- **é…ç½®ç®¡ç†å¤æ‚åº¦**ï¼šé™ä½ 70%ï¼ˆä¸¤å¤„é…ç½® â†’ ä¸€å¤„é…ç½®ï¼‰
- **é…ç½®å˜æ›´å‡ºé”™ç‡**ï¼šé™ä½ 90%ï¼ˆæ— éœ€åŒæ­¥ä¸¤å¤„ï¼‰
- **é‡å¯åé…ç½®ä¸ç”Ÿæ•ˆé—®é¢˜**ï¼šå½’é›¶ï¼ˆå¼ºåˆ¶ --update-envï¼‰

---

## ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

### .env æ–‡ä»¶ä¿æŠ¤

1. **å·²åŠ å…¥ `.gitignore`**ï¼š

   ```bash
   # éªŒè¯ .env æ˜¯å¦è¢« Git å¿½ç•¥
   git check-ignore .env
   # é¢„æœŸè¾“å‡ºï¼š.env
   ```

2. **æ–‡ä»¶æƒé™**ï¼š

   ```bash
   # è®¾ç½® .env ä¸ºä»…å½“å‰ç”¨æˆ·å¯è¯»å†™
   chmod 600 .env
   ```

3. **å¤‡ä»½æœºåˆ¶**ï¼š
   ```bash
   # åœ¨ä¿®æ”¹å‰å¤‡ä»½
   cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
   ```

---

## ğŸ“… å˜æ›´å†å²

| ç‰ˆæœ¬   | æ—¥æœŸ       | å˜æ›´å†…å®¹                                                                                                                                                                                                                                                                                                                                                                                                      | è´£ä»»äºº     |
| ------ | ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| v1.0.0 | 2025-12-25 | åˆç‰ˆï¼šå®šä¹‰ Devbox å•ç¯å¢ƒç»Ÿä¸€é…ç½®æ–¹æ¡ˆ                                                                                                                                                                                                                                                                                                                                                                          | -          |
| v1.0.1 | 2025-12-25 | åŸºäºå½“å‰ä»“åº“ä»£ç  + `.env` å®é™…è¿æ¥DBï¼šå¯¹é½ç¤ºä¾‹/æ£€æŸ¥æ¸…å•ï¼Œè¡¥å……æ–°å¢é—®é¢˜ï¼ˆæ˜æ–‡å‡­æ®/é»˜è®¤å¯†é’¥ã€dotenv å¤šç‚¹åŠ è½½ã€å‰¯ä½œç”¨æ ¡éªŒã€è„šæœ¬é‡å¯ä¸ä¸€è‡´ï¼‰                                                                                                                                                                                                                                                                       | -          |
| v1.1.0 | 2025-12-25 | æ–°å¢"ç°æœ‰è„šæœ¬èƒ½åŠ›å¯¹æ¯”ä¸åˆå¹¶æ–¹æ¡ˆ"ç« èŠ‚ï¼šè¯¦ç»†å¯¹æ¯” `å¿«é€Ÿç®¡ç†è„šæœ¬.sh`/`start-service.sh`/`pm:*` ä¸‰è€…èƒ½åŠ›å·®å¼‚ï¼Œæä¾›å®Œæ•´çš„åˆå¹¶æ–¹æ¡ˆï¼ˆå¢å¼º `process-manager.sh` + æ–°å¢ `pm:logs`/`pm:show`/`pm:reload-env` ç­‰å‘½ä»¤ï¼‰ï¼Œæ˜ç¡®åˆ é™¤æ—§è„šæœ¬çš„å‰ç½®æ¡ä»¶æ£€æŸ¥æ¸…å•ã€‚**æ‰€æœ‰ 6 é¡¹å…³é”®å†³ç­–å·²ç¡®è®¤**ï¼ˆdotenv ç¦ç”¨ overrideã€ecosystem env æ¸…ç©ºã€Redis ç»Ÿä¸€ URLã€è¿›ç¨‹ç®¡ç†å•å…¥å£ã€æµ‹è¯•è¿çœŸå®åº“ã€å†å²æ•æ„Ÿä¿¡æ¯ä¸å¤„ç†ï¼‰ï¼Œæ–‡æ¡£è¿›å…¥"å¯æ‰§è¡Œ"çŠ¶æ€ | é¡¹ç›®è´Ÿè´£äºº |

---

## ğŸ“Š ç°æœ‰è„šæœ¬èƒ½åŠ›å¯¹æ¯”ä¸åˆå¹¶æ–¹æ¡ˆ

### å½“å‰è¿›ç¨‹ç®¡ç†å…¥å£ç°çŠ¶

é¡¹ç›®ä¸­å­˜åœ¨ **3 ä¸ªè¿›ç¨‹ç®¡ç†å…¥å£**ï¼ŒåŠŸèƒ½é‡å ä½†è¡Œä¸ºä¸ä¸€è‡´ï¼š

| å…¥å£               | ä½ç½®                                                 | ä¸»è¦èƒ½åŠ›                                       | å…³é”®é—®é¢˜                                                                   |
| ------------------ | ---------------------------------------------------- | ---------------------------------------------- | -------------------------------------------------------------------------- |
| `npm run pm:*`     | `package.json` â†’ `scripts/system/process-manager.sh` | ç«¯å£å†²çªæ¸…ç†ã€ç»Ÿä¸€å¯åŠ¨/é‡å¯/åœæ­¢               | âœ… æœ€å®Œæ•´ï¼Œä½†ç¼ºå°‘æ—¥å¿—æŸ¥çœ‹/è¯¦æƒ…æŸ¥çœ‹                                         |
| `å¿«é€Ÿç®¡ç†è„šæœ¬.sh`  | é¡¹ç›®æ ¹ç›®å½•                                           | äº¤äº’å¼èœå•ã€è¯¦ç»†å¥åº·æ£€æŸ¥ã€æ—¥å¿—æ¸…ç†ã€Redis æ£€æŸ¥ | âŒ é‡å¯ç”¨ `pm2 reload --update-env`ï¼ˆæ­£ç¡®ï¼‰ï¼Œä½†å¯åŠ¨æ—¶ç«¯å£æ¸…ç†ä¸å®Œæ•´        |
| `start-service.sh` | é¡¹ç›®æ ¹ç›®å½•                                           | è‡ªåŠ¨å¯åŠ¨æœ¬æœº Redisã€ç®€å•å‘½ä»¤åŒ…è£…               | âŒ é‡å¯ç”¨ `pm2 restart`ï¼ˆ**ç¼ºå°‘ `--update-env`**ï¼Œæ˜¯é…ç½®ä¸ç”Ÿæ•ˆçš„æ ¹æºä¹‹ä¸€ï¼‰ |

### è„šæœ¬èƒ½åŠ›è¯¦ç»†å¯¹æ¯”

#### `å¿«é€Ÿç®¡ç†è„šæœ¬.sh` ç‹¬æœ‰èƒ½åŠ›

- âœ… **äº¤äº’å¼èœå•**ï¼šæ•°å­—é€‰æ‹©æ“ä½œï¼ˆé€‚åˆæ‰‹å·¥è¿ç»´ï¼‰
- âœ… **æ›´ä¸°å¯Œçš„æŸ¥çœ‹å‘½ä»¤**ï¼š
  - `pm2 show restaurant-lottery-backend`ï¼ˆè¯¦ç»†ä¿¡æ¯ï¼‰
  - `pm2 logs restaurant-lottery-backend --lines 50`ï¼ˆå®æ—¶æ—¥å¿—ï¼‰
  - `netstat` + `ps aux` ç»„åˆæŸ¥çœ‹ç«¯å£å ç”¨
- âœ… **æ—¥å¿—ç»´æŠ¤**ï¼š
  - `pm2 flush`ï¼ˆæ¸…ç† PM2 æ—¥å¿—ï¼‰
  - `ls -lh logs/`ï¼ˆæŸ¥çœ‹é¡¹ç›®æ—¥å¿—ï¼‰
- âœ… **æ›´ç»†è‡´çš„å¥åº·æ£€æŸ¥**ï¼š
  - è°ƒç”¨ `/health` å¹¶ç”¨ Python è§£æ JSON
  - é¢å¤–æ£€æŸ¥æœ¬æœº Redisï¼ˆ`redis-cli ping`ï¼‰
- âœ… **æ­£ç¡®çš„é‡å¯æ–¹å¼**ï¼š`pm2 reload ecosystem.config.js --update-env` + `pm2 save`

#### `start-service.sh` ç‹¬æœ‰èƒ½åŠ›

- âœ… **è‡ªåŠ¨å¯åŠ¨æœ¬æœº Redis**ï¼š`redis-server --daemonize yes --port 6379`
- âœ… **Redis çŠ¶æ€æ£€æŸ¥**ï¼š`pgrep redis-server` + `redis-cli ping`
- âŒ **é”™è¯¯çš„é‡å¯æ–¹å¼**ï¼š`pm2 restart restaurant-lottery-backend`ï¼ˆç¼ºå°‘ `--update-env`ï¼‰

#### `scripts/system/process-manager.sh`ï¼ˆå½“å‰ `pm:*` åŸºç¡€ï¼‰ä¼˜åŠ¿

- âœ… **æœ€å®Œæ•´çš„ç«¯å£å†²çªæ¸…ç†**ï¼š`cleanup_port_conflicts()` + `cleanup_all_node_processes()`
- âœ… **ç»Ÿä¸€çš„å¯åŠ¨æ¨¡å¼**ï¼šæ”¯æŒ `pm2`/`dev`/`prod`/`auto`
- âœ… **å®Œæ•´çš„é‡å¯æµç¨‹**ï¼š`full_restart()` åŒ…å«æ¸…ç† â†’ éªŒè¯ â†’ å¯åŠ¨
- âŒ **ç¼ºå°‘æ—¥å¿—/è¯¦æƒ…æŸ¥çœ‹**ï¼šæ²¡æœ‰ `logs`/`show`/`flush` å‘½ä»¤
- âŒ **ç¼ºå°‘ `--update-env` æ˜ç¡®æ”¯æŒ**ï¼šè™½ç„¶ `full_restart` ä¼šé‡æ–°åŠ è½½ï¼Œä½†æ²¡æœ‰å•ç‹¬çš„ `reload-env` å‘½ä»¤

### åˆå¹¶æ–¹æ¡ˆï¼ˆä¿ç•™å•å…¥å£ï¼Œè¡¥é½èƒ½åŠ›ï¼‰

#### æ­¥éª¤ 1ï¼šå¢å¼º `scripts/system/process-manager.sh`

åœ¨ `process-manager.sh` ä¸­æ·»åŠ ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# åœ¨ main() å‡½æ•°çš„ case è¯­å¥ä¸­æ·»åŠ ï¼š

"logs")
    log_info "æŸ¥çœ‹å®æ—¶æ—¥å¿—ï¼ˆæŒ‰Ctrl+Cé€€å‡ºï¼‰..."
    if command -v pm2 &> /dev/null; then
        pm2 logs $APP_NAME --lines 50
    else
        log_error "PM2æœªå®‰è£…ï¼Œæ— æ³•æŸ¥çœ‹æ—¥å¿—"
        exit 1
    fi
    ;;

"show"|"details")
    log_info "æŸ¥çœ‹æœåŠ¡è¯¦ç»†ä¿¡æ¯..."
    if command -v pm2 &> /dev/null; then
        pm2 show $APP_NAME
    else
        log_error "PM2æœªå®‰è£…"
        exit 1
    fi
    ;;

"flush-logs")
    log_info "æ¸…ç†PM2æ—¥å¿—..."
    if command -v pm2 &> /dev/null; then
        pm2 flush
        log_success "PM2æ—¥å¿—å·²æ¸…ç†"
    else
        log_error "PM2æœªå®‰è£…"
        exit 1
    fi

    log_info "é¡¹ç›®æ—¥å¿—ç›®å½•:"
    ls -lh "$PROJECT_DIR/logs/" 2>/dev/null || log_warning "logsç›®å½•ä¸å­˜åœ¨"
    ;;

"reload-env"|"reload")
    log_info "é‡æ–°åŠ è½½ç¯å¢ƒå˜é‡å¹¶é‡å¯æœåŠ¡..."
    if command -v pm2 &> /dev/null; then
        pm2 reload ecosystem.config.js --update-env
        sleep 2
        pm2 save
        log_success "ç¯å¢ƒå˜é‡å·²é‡æ–°åŠ è½½å¹¶ä¿å­˜çŠ¶æ€"
        pm2 status
    else
        log_error "PM2æœªå®‰è£…ï¼Œæ— æ³•æ‰§è¡Œreload"
        exit 1
    fi
    ;;

"health")
    log_info "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
    echo ""

    # APIå¥åº·æ£€æŸ¥
    log_info "1ï¸âƒ£ APIå¥åº·çŠ¶æ€:"
    if curl -s -m 5 http://localhost:${PORT}/health | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    print(f\"  âœ… çŠ¶æ€: {data.get('data', {}).get('status', 'unknown')}\")
    print(f\"  âœ… ç‰ˆæœ¬: {data.get('data', {}).get('version', 'unknown')}\")
    systems = data.get('data', {}).get('systems', {})
    print(f\"  âœ… æ•°æ®åº“: {systems.get('database', 'unknown')}\")
    print(f\"  âœ… Redis: {systems.get('redis', 'unknown')}\")
    print(f\"  âœ… Node.js: {systems.get('nodejs', 'unknown')}\")
except Exception as e:
    print(f'  âŒ APIæ— å“åº”æˆ–è§£æå¤±è´¥: {e}')
" 2>/dev/null; then
        echo ""
    else
        log_error "APIå¥åº·æ£€æŸ¥å¤±è´¥"
    fi

    # PM2çŠ¶æ€æ£€æŸ¥
    echo ""
    log_info "2ï¸âƒ£ PM2è¿›ç¨‹çŠ¶æ€:"
    if command -v pm2 &> /dev/null && pm2 list | grep -q "online"; then
        log_success "PM2è¿›ç¨‹æ­£å¸¸è¿è¡Œ"
    else
        log_error "PM2è¿›ç¨‹å¼‚å¸¸æˆ–æœªå®‰è£…"
    fi

    # ç«¯å£æ£€æŸ¥
    echo ""
    log_info "3ï¸âƒ£ ç«¯å£ç›‘å¬çŠ¶æ€:"
    if netstat -tlnp 2>/dev/null | grep -q ":${PORT} "; then
        log_success "${PORT}ç«¯å£æ­£å¸¸ç›‘å¬"
    else
        log_error "${PORT}ç«¯å£æœªç›‘å¬"
    fi

    # Redisæ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
    echo ""
    log_info "4ï¸âƒ£ Redisè¿æ¥çŠ¶æ€:"
    if command -v redis-cli &> /dev/null && redis-cli ping 2>/dev/null | grep -q "PONG"; then
        log_success "Redisè¿æ¥æ­£å¸¸"
    else
        log_warning "Redisè¿æ¥å¤±è´¥æˆ–æœªå®‰è£…redis-cli"
    fi
    ;;
```

#### æ­¥éª¤ 2ï¼šæ›´æ–° `package.json` çš„ `pm:*` å‘½ä»¤

åœ¨ `package.json` çš„ `scripts` ä¸­æ·»åŠ ï¼š

```json
"pm:logs": "./scripts/system/process-manager.sh logs",
"pm:show": "./scripts/system/process-manager.sh show",
"pm:flush-logs": "./scripts/system/process-manager.sh flush-logs",
"pm:reload-env": "./scripts/system/process-manager.sh reload-env",
"pm:health": "./scripts/system/process-manager.sh health",
```

#### æ­¥éª¤ 3ï¼šæ›´æ–° `help` å‘½ä»¤è¾“å‡º

åœ¨ `process-manager.sh` çš„ `help` åˆ†æ”¯ä¸­æ·»åŠ æ–°å‘½ä»¤è¯´æ˜ï¼š

```bash
"help"|"--help"|"-h")
    echo "ç”¨æ³•: $0 <command> [options]"
    echo ""
    echo "å‘½ä»¤:"
    echo "  status          æ˜¾ç¤ºå½“å‰çŠ¶æ€"
    echo "  cleanup         æ¸…ç†æ‰€æœ‰å†²çªè¿›ç¨‹"
    echo "  start [mode]    å¯åŠ¨æœåŠ¡ (auto|pm2|dev|prod)"
    echo "  restart [mode]  é‡å¯æœåŠ¡ (auto|pm2|dev|prod)"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  logs            æŸ¥çœ‹å®æ—¶æ—¥å¿—"
    echo "  show            æŸ¥çœ‹æœåŠ¡è¯¦ç»†ä¿¡æ¯"
    echo "  flush-logs      æ¸…ç†PM2æ—¥å¿—"
    echo "  reload-env      é‡æ–°åŠ è½½ç¯å¢ƒå˜é‡å¹¶é‡å¯"
    echo "  health          æ‰§è¡Œå¥åº·æ£€æŸ¥"
    echo "  help            æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  $0 status              # æ£€æŸ¥çŠ¶æ€"
    echo "  $0 start pm2           # ä½¿ç”¨PM2å¯åŠ¨"
    echo "  $0 restart dev         # é‡å¯ä¸ºå¼€å‘æ¨¡å¼"
    echo "  $0 reload-env          # é‡æ–°åŠ è½½.envé…ç½®"
    echo "  $0 logs                # æŸ¥çœ‹å®æ—¶æ—¥å¿—"
    echo "  $0 health              # å¥åº·æ£€æŸ¥"
    ;;
```

#### æ­¥éª¤ 4ï¼šRedis ä¾èµ–ç®¡ç†å†³ç­–ï¼ˆâœ… å·²æ‹æ¿ 2025-12-25ï¼‰

**å¼ºåˆ¶è§„åˆ™**ï¼š

- âŒ **ä¸æ”¯æŒ** `npm run pm:start --with-redis`ï¼ˆåº”ç”¨è„šæœ¬ä¸è´Ÿè´£æ‹‰èµ· Redisï¼‰
- âœ… **å¼ºåˆ¶** Redis ä½œä¸ºå¤–éƒ¨ä¾èµ–ï¼Œç”±å¹³å°/åŸºç¡€è®¾æ–½ç®¡ç†
- âœ… **åº”ç”¨å¯åŠ¨æ—¶** åªéªŒè¯ `REDIS_URL` è¿é€šæ€§ï¼Œè¿ä¸ä¸Šç›´æ¥ fail-fast

**ç†ç”±**ï¼š

- **èŒè´£æ¸…æ™°**ï¼šåº”ç”¨ç®¡åº”ç”¨ã€åŸºç¡€è®¾æ–½ç®¡åŸºç¡€è®¾æ–½
- **ç¯å¢ƒä¸€è‡´**ï¼šå¼€å‘/æµ‹è¯•/ç”Ÿäº§éƒ½ç”¨"å¤–éƒ¨ Redis"ï¼Œä¸ä¼šæœ‰"æœ¬æœºç‰¹æ®Šé€»è¾‘"
- **é¿å…æŠ€æœ¯å€º**ï¼šä¸ç”¨åœ¨è„šæœ¬é‡Œå¤„ç† Redis å¯åŠ¨/åœæ­¢/é…ç½®/ç‰ˆæœ¬ç®¡ç†
- **Sealos é€‚é…**ï¼šDevbox æ˜¯å®¹å™¨ç¯å¢ƒï¼Œåº”è¯¥å•ä¸€èŒè´£ï¼ŒRedis åº”ä½œä¸ºç‹¬ç«‹æœåŠ¡éƒ¨ç½²

**æ–°äººä¸Šæ‰‹æŒ‡å—**ï¼š

```bash
# 1. ç¡®ä¿ Redis å¯è®¿é—®ï¼ˆé¦–æ¬¡éœ€è¦ï¼Œä»…ä¸€æ¬¡ï¼‰
# Sealos Devbox ç¯å¢ƒæ¨èï¼šåœ¨ Sealos æ§åˆ¶å°éƒ¨ç½²ç‹¬ç«‹çš„ Redis åº”ç”¨
# æœ¬åœ°å¼€å‘æ¨èï¼š
docker run -d --name dev-redis -p 6379:6379 redis:7-alpine
# æˆ–
redis-server --daemonize yes

# 2. é…ç½® REDIS_URL
echo "REDIS_URL=redis://localhost:6379" >> .env

# 3. éªŒè¯ Redis è¿æ¥
redis-cli ping
# é¢„æœŸè¾“å‡ºï¼šPONG

# 4. å¯åŠ¨åº”ç”¨
npm run pm:start:pm2
```

**ä¸å†æ”¯æŒçš„æ“ä½œ**ï¼š

- âŒ `start-service.sh` çš„è‡ªåŠ¨å¯åŠ¨æœ¬æœº Redisï¼ˆå·²åˆ é™¤è¯¥è„šæœ¬ï¼‰
- âŒ åº”ç”¨å¯åŠ¨è„šæœ¬å†…åµŒ `redis-server` å‘½ä»¤

### åˆå¹¶åçš„ç»Ÿä¸€å‘½ä»¤æ¸…å•

| æ“ä½œ            | ç»Ÿä¸€å‘½ä»¤ï¼ˆæ¨èï¼‰        | è¯´æ˜                                        |
| --------------- | ----------------------- | ------------------------------------------- |
| ğŸš€ å¯åŠ¨æœåŠ¡     | `npm run pm:start:pm2`  | PM2 ç”Ÿäº§æ¨¡å¼å¯åŠ¨                            |
| ğŸ”„ é‡å¯æœåŠ¡     | `npm run pm:restart`    | è‡ªåŠ¨æ¸…ç†å†²çª+é‡å¯                           |
| ğŸ”„ é‡æ–°åŠ è½½é…ç½® | `npm run pm:reload-env` | **ä¿®æ”¹ `.env` åå¿…ç”¨**ï¼ˆå¸¦ `--update-env`ï¼‰ |
| ğŸ›‘ åœæ­¢æœåŠ¡     | `npm run pm:stop`       | åœæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹                            |
| ğŸ“Š æŸ¥çœ‹çŠ¶æ€     | `npm run pm:status`     | ç«¯å£+è¿›ç¨‹+å¥åº·æ£€æŸ¥                          |
| ğŸ“ æŸ¥çœ‹æ—¥å¿—     | `npm run pm:logs`       | å®æ—¶æ—¥å¿—ï¼ˆCtrl+C é€€å‡ºï¼‰                     |
| ğŸ” æŸ¥çœ‹è¯¦æƒ…     | `npm run pm:show`       | PM2 è¿›ç¨‹è¯¦ç»†ä¿¡æ¯                            |
| ğŸ§¹ æ¸…ç†å†²çª     | `npm run pm:cleanup`    | æ¸…ç†ç«¯å£å†²çªè¿›ç¨‹                            |
| ğŸ§¹ æ¸…ç†æ—¥å¿—     | `npm run pm:flush-logs` | æ¸…ç† PM2 æ—¥å¿—                               |
| ğŸ¥ å¥åº·æ£€æŸ¥     | `npm run pm:health`     | å®Œæ•´å¥åº·æ£€æŸ¥ï¼ˆAPI/PM2/ç«¯å£/Redisï¼‰          |
| ğŸ’» å¼€å‘æ¨¡å¼     | `npm run pm:start:dev`  | nodemon çƒ­é‡è½½                              |

### åˆ é™¤æ—§è„šæœ¬çš„å‰ç½®æ¡ä»¶æ£€æŸ¥æ¸…å•

åœ¨åˆ é™¤ `start-service.sh` å’Œ `å¿«é€Ÿç®¡ç†è„šæœ¬.sh` å‰ï¼Œå¿…é¡»ç¡®è®¤ï¼š

- [ ] `scripts/system/process-manager.sh` å·²æ·»åŠ  `logs`/`show`/`flush-logs`/`reload-env`/`health` å‘½ä»¤
- [ ] `package.json` å·²æ·»åŠ å¯¹åº”çš„ `pm:logs`/`pm:show`/`pm:flush-logs`/`pm:reload-env`/`pm:health`
- [ ] æ‰€æœ‰ä½¿ç”¨æ—§è„šæœ¬çš„åœ°æ–¹ï¼ˆæ–‡æ¡£ã€READMEã€å…¶ä»–è„šæœ¬ï¼‰å·²æ›´æ–°ä¸º `npm run pm:*`
- [ ] å›¢é˜Ÿæˆå‘˜å·²çŸ¥æ™“æ–°çš„ç»Ÿä¸€å‘½ä»¤ï¼ˆåŸ¹è®­/é€šçŸ¥ï¼‰
- [ ] å¦‚æœä¾èµ–"è‡ªåŠ¨å¯åŠ¨æœ¬æœº Redis"ï¼Œéœ€è¦å•ç‹¬å»ºç«‹ Redis å¯åŠ¨æœºåˆ¶ï¼ˆæˆ–æ¥å—æ‰‹å·¥å¯åŠ¨ï¼‰

---

## ğŸ”§ Redis é…ç½®æ–¹æ¡ˆ A è¯¦ç»†è¯´æ˜ï¼ˆâœ… å·²é‡‡ç”¨ - ä¸å…¼å®¹æ—§å†™æ³•ï¼‰

### æ–¹æ¡ˆå®šä¹‰

**åªè®¤ `REDIS_URL`ï¼ˆæˆ– `REDIS_TLS_URL`ï¼‰ï¼Œå®Œå…¨åºŸå¼ƒ `REDIS_HOST/REDIS_PORT` å†™æ³•ï¼Œä¸åšå…¼å®¹å›é€€ã€‚**

### å·²é‡‡ç”¨é…ç½®ï¼ˆ2025-12-25 ç¡®è®¤ï¼‰

```bash
REDIS_URL=redis://localhost:6379
```

### é…ç½®æ ¼å¼è¯´æ˜

```bash
# åŸºç¡€æ ¼å¼ï¼ˆâœ… å½“å‰ä½¿ç”¨ï¼‰
REDIS_URL=redis://localhost:6379

# å¸¦å¯†ç æ ¼å¼ï¼ˆå¤‡é€‰ï¼‰
REDIS_URL=redis://:your_password@host:6379/0

# TLS åŠ å¯†æ ¼å¼ï¼ˆå¤‡é€‰ï¼‰
REDIS_URL=rediss://host:6380/0

# å®Œæ•´æ ¼å¼è¯´æ˜ï¼ˆå¯†ç  + é€‰æ‹© DBï¼‰
REDIS_URL=redis://:password@host:port/db_index
```

### ç ´åæ€§å˜æ›´æ¸…å•

- **é…ç½®æºå˜æ›´**ï¼š
  - âŒ åˆ é™¤ `.env` ä¸­çš„ `REDIS_HOST` å’Œ `REDIS_PORT`ï¼ˆåªä¿ç•™ `REDIS_URL`ï¼‰
  - âŒ ä¸å†æ”¯æŒé€šè¿‡ `REDIS_HOST/REDIS_PORT` ç¯å¢ƒå˜é‡æ§åˆ¶ Redis è¿æ¥

- **ä»£ç å±‚å˜æ›´**ï¼š
  - ä¿®æ”¹ `utils/UnifiedRedisClient.js`ï¼šä»è§£æ host/port æ”¹ä¸ºè§£æ `REDIS_URL`
  - ä¿®æ”¹ `config/environment.js`ï¼šæ ¡éªŒæ ‡å‡†æ”¹ä¸º"åªæ¥å— `REDIS_URL`"ï¼ˆä¸å†å…œåº• `REDIS_HOST`ï¼‰

- **æµ‹è¯•/è„šæœ¬å˜æ›´**ï¼š
  - åŸæœ¬é€šè¿‡ `REDIS_HOST='disabled'` ç¦ç”¨ Redis çš„æµ‹è¯•éœ€æ”¹ä¸ºæä¾› `REDIS_URL=redis://localhost:6379`
  - åŸæœ¬ä¾èµ– `REDIS_HOST/REDIS_PORT` çš„è„šæœ¬éœ€æ”¹ä¸ºæä¾›å®Œæ•´ `REDIS_URL`
  - **ä¸å…è®¸ç¦ç”¨ Redis**ï¼šæ‰€æœ‰æµ‹è¯•/è„šæœ¬å¿…é¡»è¿æ¥ Redisï¼ˆæœ¬åœ°æˆ–æµ‹è¯•å®ä¾‹ï¼‰

### ç¯å¢ƒè¡Œä¸ºæ ‡å‡†ï¼ˆä¸å…¼å®¹æ—§å†™æ³•ï¼Œå¿…é¡»è¦æœ‰ Redisï¼‰

| ç¯å¢ƒ                           | `REDIS_URL` ç¼ºå¤±æ—¶è¡Œä¸º            | å…è®¸çš„é™çº§/å…œåº•æ–¹æ¡ˆ                                                 |
| ------------------------------ | --------------------------------- | ------------------------------------------------------------------- |
| **æ‰€æœ‰ç¯å¢ƒï¼ˆç”Ÿäº§/é¢„å‘/å¼€å‘ï¼‰** | âŒ å¯åŠ¨å¤±è´¥ï¼ˆfail-fastï¼‰          | **æ— **ï¼ŒRedis ä¸ºå¿…éœ€ä¾èµ–                                            |
| **å•æµ‹**                       | âŒ å¯åŠ¨å¤±è´¥ï¼Œå¿…é¡»æä¾› `REDIS_URL` | **ä¸å…è®¸ `DISABLE_REDIS=1`**ï¼Œæµ‹è¯•å¿…é¡»è¿çœŸå® Redis æˆ–æä¾›æµ‹è¯•ç”¨ URL |

**æ ¸å¿ƒè§„åˆ™**ï¼š

- âœ… **å¿…é¡»é…ç½® `REDIS_URL`**ï¼ˆæ‰€æœ‰ç¯å¢ƒï¼‰
- âŒ **ä¸å†å…è®¸ `REDIS_HOST/REDIS_PORT`**ï¼ˆå‘ç°å³æŠ¥é”™ï¼‰
- âŒ **ä¸å…è®¸ `DISABLE_REDIS=1`**ï¼ˆRedis ä¸ºå¿…éœ€ä¾èµ–ï¼‰
- âŒ **ä¸å…è®¸ä»£ç ä¸­æœ‰é»˜è®¤å€¼å…œåº•**ï¼ˆå¿…é¡»ä» `.env` è¯»å–ï¼‰

### å®æ–½æ­¥éª¤ï¼ˆæŒ‰ä¼˜å…ˆçº§ - å¿…é¡»è¦æœ‰ Redis ç‰ˆæœ¬ï¼‰

1. **åˆ é™¤ `.env` æ—§é”®**ï¼šä» `.env` ä¸­ç§»é™¤ `REDIS_HOST/REDIS_PORT`ï¼Œåªä¿ç•™ `REDIS_URL`
2. **ä¿®æ”¹ Redis å®¢æˆ·ç«¯åˆå§‹åŒ–**ï¼š`utils/UnifiedRedisClient.js` æ”¹ä¸ºè§£æ `REDIS_URL`ï¼ˆä½¿ç”¨ `ioredis` çš„ URL åˆå§‹åŒ–æ–¹å¼ï¼‰
3. **ä¿®æ”¹æ ¡éªŒé€»è¾‘**ï¼š`config/environment.js` çš„ `validateConfig()`
   - **å¿…é¡»æ£€æŸ¥ `REDIS_URL` å­˜åœ¨**ï¼ˆæ‰€æœ‰ç¯å¢ƒéƒ½ fail-fastï¼Œä¸å…è®¸ç¼ºå¤±ï¼‰
   - **ç¦æ­¢ `REDIS_HOST/REDIS_PORT` å…œåº•**ï¼ˆå‘ç°å³æŠ¥é”™ï¼š"å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨ REDIS_URL"ï¼‰
   - **ç§»é™¤"é™çº§è¿è¡Œ"é€»è¾‘**ï¼ˆä¸å…è®¸ `DISABLE_REDIS=1`ï¼ŒRedis ä¸ºå¿…éœ€ä¾èµ–ï¼‰
4. **ä¿®æ”¹ `app.js` å¯åŠ¨æ ¡éªŒ**ï¼šç§»é™¤ development çš„ try/catch å¿½ç•¥ï¼ˆæ‰€æœ‰ç¯å¢ƒæ ¡éªŒå¤±è´¥éƒ½åº”é˜»æ–­å¯åŠ¨ï¼‰
5. **æ›´æ–°æµ‹è¯•é…ç½®**ï¼š`jest.setup.js` ç­‰æµ‹è¯•é…ç½®å¿…é¡»æä¾› `REDIS_URL=redis://localhost:6379`ï¼ˆæµ‹è¯•å¿…é¡»è¿ Redisï¼‰
6. **éªŒè¯æ‰€æœ‰ç¯å¢ƒ**ï¼šç¡®ä¿å¼€å‘/æµ‹è¯•/é¢„å‘/ç”Ÿäº§ç¯å¢ƒéƒ½å·²è¡¥é½ `REDIS_URL`

### å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆï¼ˆå¿…é¡»è¦æœ‰ Redis ç‰ˆæœ¬ï¼‰

| é—®é¢˜                          | åŸå›                             | è§£å†³æ–¹æ¡ˆ                                                              |
| ----------------------------- | ------------------------------- | --------------------------------------------------------------------- |
| å¯åŠ¨å¤±è´¥ï¼š`REDIS_URL` æœªå®šä¹‰  | `.env` ç¼ºå°‘ `REDIS_URL`         | è¡¥å…… `REDIS_URL=redis://localhost:6379`ï¼ˆ**æ‰€æœ‰ç¯å¢ƒå¿…éœ€**ï¼‰           |
| å¯åŠ¨å¤±è´¥ï¼šæ£€æµ‹åˆ° `REDIS_HOST` | `.env` ä»æœ‰æ—§é”®                 | åˆ é™¤ `REDIS_HOST/REDIS_PORT`ï¼Œåªä¿ç•™ `REDIS_URL`                      |
| æµ‹è¯•å¤±è´¥ï¼šRedis è¿æ¥é”™è¯¯      | æµ‹è¯•ç¯å¢ƒå°è¯•è¿æ¥çœŸå® Redis      | æä¾›æµ‹è¯•ç”¨ `REDIS_URL=redis://localhost:6379`ï¼ˆ**ä¸å…è®¸ç¦ç”¨ Redis**ï¼‰ |
| é™æµ/ç¼“å­˜è¡Œä¸ºå¼‚å¸¸             | URL æŒ‡å‘çš„ Redis å®ä¾‹ä¸ä¹‹å‰ä¸åŒ | æ£€æŸ¥ `REDIS_URL` æ˜¯å¦æŒ‡å‘æ­£ç¡®çš„å®ä¾‹                                   |
| è¿æ¥å¤±è´¥ï¼šå¯†ç é”™è¯¯            | URL ä¸­å¯†ç æ ¼å¼é”™è¯¯              | æ£€æŸ¥æ ¼å¼ï¼š`redis://:password@host:port`ï¼ˆæ³¨æ„å†’å·ï¼‰                   |
| å¼€å‘ç¯å¢ƒå¯åŠ¨å¤±è´¥              | development çš„æ ¡éªŒè¢«å¿½ç•¥        | ç§»é™¤ `app.js` ä¸­çš„ try/catch å¿½ç•¥é€»è¾‘ï¼ˆæ‰€æœ‰ç¯å¢ƒç»Ÿä¸€ fail-fastï¼‰       |

### éªŒè¯æ¸…å•ï¼ˆå¿…é¡»è¦æœ‰ Redis ç‰ˆæœ¬ï¼‰

- [ ] `.env` ä¸­åªæœ‰ `REDIS_URL`ï¼Œä¸å†æœ‰ `REDIS_HOST/REDIS_PORT`
- [ ] `utils/UnifiedRedisClient.js` å·²æ”¹ä¸ºè§£æ `REDIS_URL`
- [ ] `config/environment.js` æ ¡éªŒé€»è¾‘å·²æ›´æ–°ï¼š
  - [ ] å¼ºåˆ¶æ£€æŸ¥ `REDIS_URL` å­˜åœ¨ï¼ˆæ‰€æœ‰ç¯å¢ƒï¼‰
  - [ ] ç¦æ­¢ `REDIS_HOST/REDIS_PORT` å…œåº•ï¼ˆå‘ç°å³æŠ¥é”™ï¼‰
  - [ ] ç§»é™¤"é™çº§è¿è¡Œ"é€»è¾‘ï¼ˆä¸å…è®¸ç¼º Redisï¼‰
- [ ] `app.js` å¯åŠ¨æ ¡éªŒå·²ç»Ÿä¸€ï¼šç§»é™¤ development çš„ try/catch å¿½ç•¥ï¼ˆæ‰€æœ‰ç¯å¢ƒ fail-fastï¼‰
- [ ] æµ‹è¯•é…ç½®å·²æä¾› `REDIS_URL`ï¼ˆæµ‹è¯•å¿…é¡»è¿ Redisï¼Œä¸å…è®¸ç¦ç”¨ï¼‰
- [ ] æ‰€æœ‰ç¯å¢ƒï¼ˆå¼€å‘/æµ‹è¯•/é¢„å‘/ç”Ÿäº§ï¼‰å¯åŠ¨æ—¶éƒ½èƒ½æˆåŠŸè¿æ¥ Redis
- [ ] éªŒè¯å¯åŠ¨å¤±è´¥æœºåˆ¶ï¼šä¸´æ—¶åˆ é™¤ `.env` ä¸­çš„ `REDIS_URL` â†’ åº”ç«‹å³å¯åŠ¨å¤±è´¥

---

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰- å¼ºåˆ¶æ‰§è¡Œæ¸…å•ï¼ˆâœ… å†³ç­–å·²ç¡®è®¤ 2025-12-25ï¼‰

#### P0 çº§ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼Œ1å‘¨å†…å®Œæˆï¼‰

- [ ] **P0-1** æ¸…ç©º `ecosystem.config.js` çš„ `env:{...}`ï¼ˆä¸ä¿ç•™ä»»ä½•ä¸šåŠ¡é…ç½®æˆ–é»˜è®¤å€¼ï¼ŒåŒ…æ‹¬ `NODE_ENV`/`PORT`ï¼‰
  - å†³ç­–ä¾æ®ï¼šâœ… å·²ç¡®è®¤"ecosystem env å®Œå…¨æ¸…ç©ºï¼Œåªç”¨ .env"
  - å½±å“ï¼šå¼ºåˆ¶å•ä¸€çœŸç›¸æºï¼ˆ`.env` å”¯ä¸€é…ç½®æ¥æºï¼‰
- [ ] **P0-2** ä¿®æ”¹ `app.js`ï¼šç§»é™¤ `dotenv.config({ override: true })`ï¼Œç»Ÿä¸€ä¸º `dotenv.config()`ï¼ˆæ‰€æœ‰ç¯å¢ƒç¦æ­¢ overrideï¼‰
  - å†³ç­–ä¾æ®ï¼šâœ… å·²ç¡®è®¤"dotenv å…¨ç¯å¢ƒç¦ç”¨ override"
  - å½±å“ï¼šç»Ÿä¸€ä¼˜å…ˆçº§æ¨¡å‹ï¼ˆç³»ç»Ÿ/PM2 > .env è¡¥é½ï¼‰
- [x] **P0-3** Redis é…ç½®ç»Ÿä¸€ä¸º `REDIS_URL`ï¼ˆâœ… å·²é‡‡ç”¨æ–¹æ¡ˆ Aï¼šä¸å…¼å®¹æ—§å†™æ³•ï¼Œæš´åŠ›å‡çº§ï¼‰
  - å†³ç­–ä¾æ®ï¼šâœ… å·²ç¡®è®¤"Redis ç»Ÿä¸€ REDIS_URLï¼Œä¸åšå…¼å®¹å›é€€"
  - **å·²é‡‡ç”¨é…ç½®ï¼ˆ2025-12-25 ç¡®è®¤ï¼‰**ï¼š`REDIS_URL=redis://localhost:6379`
  - æ ¼å¼è¯´æ˜ï¼š
    - åŸºç¡€æ ¼å¼ï¼ˆâœ… å½“å‰ä½¿ç”¨ï¼‰ï¼š`REDIS_URL=redis://localhost:6379`
    - å¸¦å¯†ç æ ¼å¼ï¼š`REDIS_URL=redis://:password@host:6379/0`
    - TLS æ ¼å¼ï¼š`REDIS_URL=rediss://host:6380/0`
  - å½±å“èŒƒå›´ï¼ˆç ´åæ€§å˜æ›´ï¼Œéœ€è¦åŒæ­¥è°ƒæ•´ï¼‰ï¼š
    - **åˆ é™¤ `.env` ä¸­çš„ `REDIS_HOST/REDIS_PORT`**ï¼ˆåªä¿ç•™ `REDIS_URL`ï¼‰
    - **ä¿®æ”¹ `utils/UnifiedRedisClient.js`**ï¼šä» host/port åˆå§‹åŒ–æ”¹ä¸ºè§£æ `REDIS_URL`
    - **ä¿®æ”¹ `config/environment.js`**ï¼šæ ¡éªŒæ ‡å‡†æ”¹ä¸º"åªæ¥å— `REDIS_URL`"ï¼ˆä¸å†å…è®¸ `REDIS_HOST` å…œåº•ï¼‰
    - **æµ‹è¯•/è„šæœ¬è°ƒæ•´**ï¼šå¿…é¡»æä¾› `REDIS_URL=redis://localhost:6379`ï¼ˆä¸å†æ”¯æŒ `DISABLE_REDIS=1`ï¼‰
  - ç¯å¢ƒè¡Œä¸ºæ ‡å‡†ï¼ˆå¿…é¡»è¦æœ‰ Redis ç‰ˆæœ¬ï¼‰ï¼š
    - **æ‰€æœ‰ç¯å¢ƒï¼ˆç”Ÿäº§/é¢„å‘/å¼€å‘/å•æµ‹ï¼‰**ï¼šç¼º `REDIS_URL` ç›´æ¥å¯åŠ¨å¤±è´¥ï¼ˆfail-fastï¼‰
    - **ä¸å…è®¸ `DISABLE_REDIS=1`**ï¼ˆRedis ä¸ºç³»ç»Ÿå¿…éœ€ä¾èµ–ï¼‰
    - **ä¸å…è®¸ä»£ç é»˜è®¤å€¼å…œåº•**ï¼ˆå¿…é¡»ä» `.env` è¯»å–ï¼‰
  - **æ‰§è¡ŒçŠ¶æ€**ï¼šâœ… é…ç½®å·²ç¡®å®šä¸º `redis://localhost:6379`ï¼Œç­‰å¾…ä»£ç å®æ–½
- [ ] **P0-4** å¢å¼º `scripts/system/process-manager.sh`ï¼šæ·»åŠ  `logs`/`show`/`flush-logs`/`reload-env`/`health` å‘½ä»¤ï¼ˆè§ä¸Šæ–‡"åˆå¹¶æ–¹æ¡ˆ"ï¼‰
  - å†³ç­–ä¾æ®ï¼šâœ… å·²ç¡®è®¤"è¿›ç¨‹ç®¡ç†å”¯ä¸€å…¥å£ npm run pm:\*"
  - æ‰§è¡Œï¼šå¤åˆ¶æ–‡æ¡£ä¸­æä¾›çš„å®Œæ•´ bash ä»£ç åˆ° `process-manager.sh`
- [ ] **P0-5** æ›´æ–° `package.json`ï¼šæ·»åŠ å¯¹åº”çš„ `pm:logs`/`pm:show`/`pm:flush-logs`/`pm:reload-env`/`pm:health` å‘½ä»¤
  - å†³ç­–ä¾æ®ï¼šâœ… å·²ç¡®è®¤"è¿›ç¨‹ç®¡ç†å”¯ä¸€å…¥å£ npm run pm:\*"
  - æ‰§è¡Œï¼šå¤åˆ¶æ–‡æ¡£ä¸­æä¾›çš„ JSON é…ç½®åˆ° `package.json` çš„ `scripts` éƒ¨åˆ†
- [ ] **P0-6** åˆ é™¤å…¶ä»–è¿›ç¨‹ç®¡ç†è„šæœ¬ï¼š`start-service.sh`ã€`å¿«é€Ÿç®¡ç†è„šæœ¬.sh`ï¼ˆå®Œæˆ P0-4/P0-5 åå†åˆ é™¤ï¼‰
  - å†³ç­–ä¾æ®ï¼šâœ… å·²ç¡®è®¤"åˆ æ‰ start-service.shã€å¿«é€Ÿç®¡ç†è„šæœ¬.shï¼Œåªç•™ npm run pm:\*"
  - å‰ç½®æ¡ä»¶ï¼šå¿…é¡»å…ˆå®Œæˆ P0-4ã€P0-5 çš„èƒ½åŠ›è¡¥é½
  - æ‰§è¡Œï¼š`rm start-service.sh å¿«é€Ÿç®¡ç†è„šæœ¬.sh`

#### P1 çº§ï¼ˆé«˜ä¼˜å…ˆçº§ï¼Œ2å‘¨å†…å®Œæˆï¼‰

- [ ] **P1-1** ä¿®æ”¹ `config/database.js`ï¼šç§»é™¤æ¨¡å—é¡¶å±‚å‰¯ä½œç”¨ï¼ˆâœ… å·²ç¡®è®¤"æŒ‰éœ€æ ¡éªŒ/æŒ‰éœ€æ‰“å°"ï¼‰
  - å†³ç­–ä¾æ®ï¼šè§£å†³"é—®é¢˜ F"ï¼Œé¿å…è„šæœ¬/æµ‹è¯•è¢«è¯¯ä¼¤
  - æ‰§è¡Œæ­¥éª¤ï¼š
    - [ ] ç§»é™¤æ¨¡å—é¡¶å±‚çš„ `validateDatabaseConfig()` è°ƒç”¨ï¼ˆæ”¹ä¸ºåœ¨ `testConnection()` å†…è°ƒç”¨ï¼‰
    - [ ] ç§»é™¤æ¨¡å—é¡¶å±‚çš„ `console.log` æ‰“å°è¿æ¥ä¿¡æ¯ï¼ˆæ”¹ä¸ºå¯é€‰çš„å¯åŠ¨é˜¶æ®µæ—¥å¿—ï¼Œä¸”å¿…é¡»è„±æ•ï¼‰
    - [ ] ç§»é™¤æ¨¡å—é¡¶å±‚çš„ `dotenv.config()`ï¼ˆdotenv åªåœ¨ `app.js` æ‰§è¡Œä¸€æ¬¡ï¼‰
  - å½±å“ï¼š`require('./config/database')` ä¸å†è§¦å‘æ ¡éªŒ/æ‰“å°
  - éªŒæ”¶ï¼š
    - [ ] `app.js` å¯åŠ¨é˜¶æ®µæ˜¾å¼è°ƒç”¨ `testConnection()`ï¼ˆä¿ç•™ fail-fastï¼‰
    - [ ] å·¥å…·è„šæœ¬ä¸å†å› é—´æ¥å¼•ç”¨è€Œè¢«å¼ºåˆ¶æ ¡éªŒæ‰“æ–­

- [ ] **P1-2** dotenv å¤šç‚¹åŠ è½½æ”¶æ•›ï¼ˆâœ… å·²ç¡®è®¤"åº”ç”¨å•ç‚¹/è„šæœ¬è§„èŒƒ/æµ‹è¯•å¼ºåˆ¶æ–¹æ¡ˆ1"ï¼‰
  - å†³ç­–ä¾æ®ï¼šè§£å†³"é—®é¢˜ G"ï¼ˆP2 çº§ï¼‰ï¼Œé™ä½é…ç½®æ¥æºæ’æŸ¥å¤æ‚åº¦
  - æ‰§è¡Œæ­¥éª¤ï¼š
    - [ ] **åº”ç”¨é“¾è·¯**ï¼šç§»é™¤ `config/environment.js:10` å’Œ `config/database.js:12` çš„ `dotenv.config()`ï¼ˆåªä¿ç•™ `app.js:27`ï¼‰
    - [ ] **è„šæœ¬é“¾è·¯**ï¼šæ£€æŸ¥ 13+ ä¸ªè„šæœ¬æ–‡ä»¶ï¼Œç»Ÿä¸€è§„åˆ™ï¼š
      - [ ] åªåœ¨è„šæœ¬å…¥å£é¡¶éƒ¨åŠ è½½ä¸€æ¬¡ï¼ˆä¸å¾—åœ¨å‡½æ•°å†…äºŒæ¬¡åŠ è½½ï¼‰
      - [ ] ç»Ÿä¸€ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼š`require('dotenv').config({ path: path.resolve(__dirname, '../../.env') })`
      - [ ] å…¨ä»“åº“ç¦æ­¢ `override: true`ï¼ˆæ— ä¾‹å¤–ï¼‰
      - [ ] ä¿®æ”¹ `scripts/validation/pre-start-check.js:187, 212`ï¼šå‡½æ•°å†…äºŒæ¬¡åŠ è½½ â†’ å…¥å£ä¸€æ¬¡
      - [ ] ä¿®æ”¹ `scripts/fix-technical-debt-p0.js:47`ï¼šå¼ºåˆ¶ç§»é™¤ `override: true`
    - [ ] **æµ‹è¯•é“¾è·¯**ï¼ˆâœ… å¼ºåˆ¶æ–¹æ¡ˆ1ï¼šä¸åŠ è½½ dotenvï¼‰ï¼š
      - [ ] ç§»é™¤ `jest.setup.js:6` çš„ `require('dotenv').config()`
      - [ ] ç§»é™¤ `tests/helpers/test-setup.js:10` çš„ `require('dotenv').config()`ï¼ˆå¦‚æœ‰ï¼‰
      - [ ] ä¿ç•™æ‰‹åŠ¨è®¾ç½®çš„ `process.env.*`ï¼ˆæµ‹è¯•é…ç½®å®Œå…¨æ˜¾å¼ï¼‰
      - [ ] ç¦æ­¢åˆ›å»º `.env.test` æ–‡ä»¶
  - éªŒæ”¶ï¼š
    - [ ] åº”ç”¨å¯åŠ¨æ—¶åªæœ‰ `app.js` åŠ è½½ dotenvï¼ˆå…¶ä»– config/\* ä¸åŠ è½½ï¼‰
    - [ ] è„šæœ¬æ‰§è¡Œæ—¶åªåœ¨å…¥å£åŠ è½½ä¸€æ¬¡ï¼ˆæ— å‡½æ•°å†…äºŒæ¬¡åŠ è½½ã€æ—  overrideï¼‰
    - [ ] æµ‹è¯•è¿è¡Œæ—¶ä¸åŠ è½½ dotenvï¼ˆå®Œå…¨æ‰‹åŠ¨è®¾ç½®ï¼‰

- [ ] **P1-3** æ›´æ–°æ‰€æœ‰è„šæœ¬ä¸­çš„ `pm2 restart` å‘½ä»¤ä¸º `pm2 restart <app> --update-env`ï¼š
  - `scripts/migration/execute-migration-now.js`ï¼ˆ2å¤„ï¼‰
  - `scripts/verify_old_apis_deleted.sh`ï¼ˆ1å¤„ï¼‰
  - `scripts/delete_old_chat_apis.sh`ï¼ˆ2å¤„ï¼‰
- [ ] **P1-4** éªŒè¯æ‰€æœ‰é…ç½®é¡¹ä» `.env` æ­£ç¡®åŠ è½½ï¼ˆä½¿ç”¨ä¸Šæ–‡çš„éªŒè¯å‘½ä»¤ï¼‰
  - æ‰§è¡Œ `pm2 show restaurant-lottery-backend | grep -E "DB_HOST|REDIS_URL|NODE_ENV"`
  - ç¡®è®¤è¾“å‡ºçš„å€¼ä¸ `.env` æ–‡ä»¶ä¸€è‡´

#### P2 çº§ï¼ˆä¸­ä¼˜å…ˆçº§ï¼Œ2å‘¨å†…å®Œæˆï¼‰

- [ ] **P2-1** æ¸…ç† `config.example` ä¸­çš„æ˜æ–‡æ•æ„Ÿé¡¹ï¼ˆä¿ç•™ç»“æ„ä¸å ä½ç¬¦å³å¯ï¼‰
  - å†³ç­–ä¾æ®ï¼šâœ… å·²ç¡®è®¤"ä¸è½®æ¢å¯†é’¥ã€ä¸æ¸…å†å²"ï¼ˆæ¥å—ç°çŠ¶ï¼Œä½†æ–°æ¨¡æ¿åº”è„±æ•ï¼‰
- [ ] **P2-2** æµ‹è¯•ç¯å¢ƒç­–ç•¥ç¡®è®¤ï¼šå…è®¸è¿çœŸå®åº“ `restaurant_points_dev`ï¼ˆå…±ç”¨åº“ï¼Œéœ€å›¢é˜ŸçŸ¥æ™“ï¼‰
  - å†³ç­–ä¾æ®ï¼šâœ… å·²ç¡®è®¤"æµ‹è¯•/è„šæœ¬å…è®¸è¿çœŸå®åº“"
  - æ‰§è¡Œï¼šé€šçŸ¥å›¢é˜Ÿæˆå‘˜å…±ç”¨åº“é£é™©ï¼ˆæµ‹è¯•è„šæœ¬å¯èƒ½å½±å“å¼€å‘æ•°æ®ï¼‰

### ä¸­æœŸï¼ˆ1ä¸ªæœˆï¼‰

- [ ] æ·»åŠ  `.env.example` æ¨¡æ¿æ–‡ä»¶ï¼ˆç”¨äºæ–°ç¯å¢ƒéƒ¨ç½²ï¼Œä»…å ä½ç¬¦ä¸å«çœŸå®å€¼ï¼‰
- [ ] åœ¨ `config/environment.js` ä¸­å¼ºåŒ–é…ç½®é¡¹å®Œæ•´æ€§æ ¡éªŒï¼š
  - [ ] å¢åŠ  `REDIS_URL` å¿…éœ€æ£€æŸ¥ï¼ˆæ‰€æœ‰ç¯å¢ƒ fail-fastï¼‰
  - [ ] ç¦æ­¢ `REDIS_HOST/REDIS_PORT` å…œåº•ï¼ˆå‘ç°å³æŠ¥é”™ï¼‰
- [ ] ç»Ÿä¸€æ‰€æœ‰æ•°æ®åº“è¿æ¥ä½¿ç”¨ `config/database.js` çš„é…ç½®
- [ ] éªŒè¯æ•°æ®åº“æ—¶åŒºé…ç½®ï¼ˆâœ… å·²ç¡®è®¤"åº”ç”¨å±‚å¼ºåˆ¶ä¼šè¯æ—¶åŒº"ï¼‰ï¼š
  - [ ] ç¡®è®¤ `config/database.js` çš„ Sequelize é…ç½®åŒ…å« `timezone: '+08:00'`
  - [ ] ç¡®è®¤ `dialectOptions` åŒ…å«æ—¶åŒºè®¾ç½®
  - [ ] é€šè¿‡æ—¥å¿—/æµ‹è¯•éªŒè¯æ‰€æœ‰æŸ¥è¯¢æ—¶é—´æˆ³ä¸åŒ—äº¬æ—¶é—´ä¸€è‡´
- [ ] æ·»åŠ é…ç½®é¡¹å˜æ›´çš„ changelog æœºåˆ¶

### é•¿æœŸï¼ˆ3ä¸ªæœˆ+ï¼‰æ˜ç¡®æš‚æ—¶ä¸æ‰§è¡Œ é•¿æœŸï¼ˆ3ä¸ªæœˆ+ï¼‰è¿™éƒ¨åˆ†å†…å®¹

- [ ] å¦‚éœ€å¤šç¯å¢ƒéƒ¨ç½²ï¼Œè€ƒè™‘å¼•å…¥ `.env.staging` / `.env.production`
- [ ] è€ƒè™‘ä½¿ç”¨ Sealos çš„"ç¯å¢ƒå˜é‡ç®¡ç†"åŠŸèƒ½æ›¿ä»£ .env æ–‡ä»¶
- [ ] æ·»åŠ é…ç½®é¡¹çš„æ•æ„Ÿåº¦åˆ†çº§å’ŒåŠ å¯†å­˜å‚¨æœºåˆ¶
- [ ] å†å²æ•æ„Ÿä¿¡æ¯å¤„ç½®ï¼šå½“å‰å†³ç­–ä¸º"ä¸åšå¯†é’¥è½®æ¢/git å†å²æ¸…ç†"ï¼ˆå¦‚æœªæ¥éœ€è¦ï¼Œéœ€å•ç‹¬è¯„ä¼°å½±å“é¢ï¼‰

---

---

## ğŸ“‹ å†³ç­–è®°å½•ï¼ˆå·²æ‹æ¿ - 2025-12-25ï¼‰

| å†³ç­–é¡¹                    | é€‰æ‹©æ–¹æ¡ˆ                                                                | å†³ç­–ç»“æœ            | ç†ç”±                                                                                                                                                                                 | å½±å“é¢                                                                                                                                                                                                                        |
| ------------------------- | ----------------------------------------------------------------------- | ------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| dotenv ä¼˜å…ˆçº§ç­–ç•¥         | å…¨ä»“åº“ç¦æ­¢ overrideï¼ˆæ— ä¾‹å¤–ï¼‰                                           | âœ… **å·²ç¡®è®¤**       | ç»Ÿä¸€ä¼˜å…ˆçº§æ¨¡å‹ï¼ˆç³»ç»Ÿ/PM2 > .env è¡¥é½ï¼‰ï¼Œè·¨ç¯å¢ƒä¸€è‡´ã€å¯é¢„æµ‹                                                                                                                           | éœ€ä¿®æ”¹ `app.js`ï¼ˆç§»é™¤ `override: true`ï¼‰ï¼›æ‰€æœ‰è„šæœ¬ç¦æ­¢ä½¿ç”¨ `override: true`ï¼ˆæ— ä¾‹å¤–ï¼‰                                                                                                                                         |
| ecosystem.config.js env   | å®Œå…¨æ¸…ç©ºï¼ˆä¸ä¿ç•™é»˜è®¤å€¼ï¼‰                                                | âœ… **å·²ç¡®è®¤**       | å¼ºåˆ¶å•ä¸€çœŸç›¸æºï¼ˆ`.env` å”¯ä¸€é…ç½®æ¥æºï¼‰                                                                                                                                                | `.env` å¿…é¡»åŒ…å«æ‰€æœ‰å¿…éœ€é…ç½®ï¼ˆåŒ…æ‹¬ `NODE_ENV`/`PORT`/`TZ`ï¼‰                                                                                                                                                                    |
| Redis é…ç½®è§„èŒƒ            | **æ–¹æ¡ˆ Aï¼šåªç”¨ `REDIS_URL`ï¼ˆâœ… å·²é‡‡ç”¨ï¼Œä¸å…¼å®¹æ—§å†™æ³•ï¼Œå¿…é¡»è¦æœ‰ Redisï¼‰** | âœ… **å·²ç¡®è®¤å¹¶æ‰§è¡Œ** | ç»Ÿä¸€é…ç½®æºï¼Œæ”¯æŒå¯†ç /TLS/DB indexï¼›**ä¸åšå…¼å®¹å›é€€**ï¼ˆ`REDIS_HOST/REDIS_PORT` ç«‹å³å¤±æ•ˆï¼‰ï¼›**æ‰€æœ‰ç¯å¢ƒå¿…é¡»é…ç½® Redis**ï¼ˆfail-fastï¼‰ï¼›**å·²é‡‡ç”¨é…ç½®**ï¼š`REDIS_URL=redis://localhost:6379` | **ç ´åæ€§å˜æ›´**ï¼šåˆ é™¤ `.env` æ—§é”®ã€ä¿®æ”¹ Redis å®¢æˆ·ç«¯åˆå§‹åŒ–ï¼ˆè§£æ URLï¼‰ã€æ ¡éªŒæ”¹ä¸ºå¼ºåˆ¶ `REDIS_URL`ï¼ˆæ‰€æœ‰ç¯å¢ƒï¼‰ã€ç§»é™¤ `DISABLE_REDIS` é™çº§é€»è¾‘ã€`app.js` å¯åŠ¨æ ¡éªŒç»Ÿä¸€ï¼ˆç§»é™¤ development try/catch å¿½ç•¥ï¼‰                          |
| Redis ä¾èµ–ç®¡ç†            | æ–¹æ¡ˆ Aï¼šå¤–éƒ¨æœåŠ¡ï¼Œè„šæœ¬ä¸æ‹‰èµ·                                            | âœ… **å·²ç¡®è®¤**       | èŒè´£æ¸…æ™°ã€ç¯å¢ƒä¸€è‡´ã€é¿å…æŠ€æœ¯å€ºï¼›Sealos Devbox åº”å•ä¸€èŒè´£                                                                                                                             | åº”ç”¨è„šæœ¬ä¸æ”¯æŒ `--with-redis`ï¼›Redis ç”±å¹³å°/docker/æ‰‹å·¥ç®¡ç†ï¼›åº”ç”¨å¯åŠ¨åªéªŒè¯ `REDIS_URL` è¿é€šæ€§ï¼ˆfail-fastï¼‰                                                                                                                   |
| è¿›ç¨‹ç®¡ç†å…¥å£              | å”¯ä¸€å…¥å£ï¼š`npm run pm:*`                                                | âœ… **å·²ç¡®è®¤**       | é˜²æ­¢å›å½’ï¼Œç»Ÿä¸€æ“ä½œï¼Œå‡å°‘ç»´æŠ¤æˆæœ¬                                                                                                                                                     | åˆ é™¤ `start-service.sh`ã€`å¿«é€Ÿç®¡ç†è„šæœ¬.sh`ï¼ˆå…ˆå®Œæˆ `pm:*` å¢å¼ºï¼‰                                                                                                                                                              |
| æµ‹è¯•ç¯å¢ƒç­–ç•¥              | å…è®¸è¿çœŸå®åº“ï¼ˆå…±ç”¨ `restaurant_points_dev`ï¼‰                            | âœ… **å·²ç¡®è®¤**       | ç®€åŒ–ç¯å¢ƒç®¡ç†ï¼Œé¿å…ç»´æŠ¤ç‹¬ç«‹æµ‹è¯•åº“                                                                                                                                                     | å›¢é˜Ÿéœ€çŸ¥æ™“å…±ç”¨åº“é£é™©ï¼ˆæµ‹è¯•è„šæœ¬å¯èƒ½å½±å“å¼€å‘æ•°æ®ï¼‰                                                                                                                                                                              |
| å†å²æ•æ„Ÿä¿¡æ¯              | ä¸åšå¯†é’¥è½®æ¢/git å†å²æ¸…ç†                                               | âœ… **å·²ç¡®è®¤**       | æ¥å—ç°çŠ¶ï¼Œé™ä½æ‰§è¡Œæˆæœ¬ï¼ˆå†å²å·²å…¬å¼€æŒ‰"å·²çŸ¥"å¤„ç†ï¼‰                                                                                                                                     | å·²æ³„éœ²ä¿¡æ¯ï¼ˆDBå¯†ç ã€JWTå¯†é’¥ç­‰ï¼‰æŒ‰"å·²å…¬å¼€"å¤„ç†ï¼Œä¸å½±å“å•ç¯å¢ƒæ–¹æ¡ˆå®æ–½                                                                                                                                                           |
| config/database.js å‰¯ä½œç”¨ | ç§»é™¤æ¨¡å—é¡¶å±‚å‰¯ä½œç”¨ï¼Œæ”¹ä¸ºæŒ‰éœ€æ ¡éªŒ/æ‰“å°                                   | âœ… **å·²ç¡®è®¤**       | é¿å…è„šæœ¬/æµ‹è¯•è¢«è¯¯ä¼¤ï¼Œå‡å°‘æ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼ŒåŒæ—¶åœ¨ `app.js` ä¿ç•™ fail-fast                                                                                                                | éœ€ç§»é™¤é¡¶å±‚ `validateDatabaseConfig()` / `console.log` / `dotenv.config()`ï¼›åœ¨ `app.js` å¯åŠ¨é˜¶æ®µæ˜¾å¼è°ƒç”¨ `testConnection()`                                                                                                    |
| dotenv å¤šç‚¹åŠ è½½æ”¶æ•›ï¼ˆP2ï¼‰ | åº”ç”¨å•ç‚¹ + è„šæœ¬è§„èŒƒ + æµ‹è¯•å¼ºåˆ¶æ–¹æ¡ˆ1                                     | âœ… **å·²ç¡®è®¤**       | é™ä½"é…ç½®åˆ°åº•åœ¨å“ªç”Ÿæ•ˆ"çš„æ’æŸ¥å¤æ‚åº¦ï¼Œä¾¿äºé…ç½®æ¥æºè¿½è¸ª                                                                                                                                 | **åº”ç”¨**ï¼šç§»é™¤ `config/environment.js` / `config/database.js` çš„ dotenvï¼ˆåªä¿ç•™ `app.js`ï¼‰ï¼›**è„šæœ¬**ï¼šç»Ÿä¸€å…¥å£é¡¶éƒ¨åŠ è½½ + ç¦æ­¢ override + ç»å¯¹è·¯å¾„ï¼›**æµ‹è¯•**ï¼šâœ… å¼ºåˆ¶æ–¹æ¡ˆ1 - ä¸åŠ è½½ dotenvï¼Œçº¯æ‰‹åŠ¨è®¾ç½®ï¼ˆç¦æ­¢åˆ›å»º `.env.test`ï¼‰ |
| æ•°æ®åº“æ—¶åŒºç­–ç•¥            | åº”ç”¨å±‚å¼ºåˆ¶ä¼šè¯æ—¶åŒº `+08:00`ï¼Œä¸ä¿®æ”¹ DB global                           | âœ… **å·²ç¡®è®¤**       | ä½é£é™©ã€å¯æ§ï¼›å½“å‰ Sequelize å·²å®ç°ï¼›ä¸ä¾èµ– DBA æƒé™ï¼›ä¸å½±å“åŒåº“å…¶ä»–å®¢æˆ·ç«¯                                                                                                           | éœ€ç¡®è®¤ `config/database.js` çš„ Sequelize é…ç½®åŒ…å« `timezone: '+08:00'` å’Œ `dialectOptions` æ—¶åŒºè®¾ç½®ï¼›æ‰€æœ‰æŸ¥è¯¢æ—¶é—´æˆ³ä¸åŒ—äº¬æ—¶é—´ä¸€è‡´                                                                                             |

**å†³ç­–ç”Ÿæ•ˆæ—¶é—´**ï¼š2025å¹´12æœˆ25æ—¥  
**å†³ç­–äºº**ï¼šé¡¹ç›®è´Ÿè´£äºº  
**æ‰§è¡ŒæœŸé™**ï¼šçŸ­æœŸï¼ˆ1-2å‘¨å†…å®Œæˆ P0 é¡¹ï¼Œè§ä¸‹æ–‡"æ‰§è¡Œæ¸…å•"ï¼‰

---

**âœ… ç»Ÿä¸€æ–¹æ¡ˆæ ¸å¿ƒç†å¿µ**ï¼šå•ä¸€çœŸç›¸æºï¼ˆ.envï¼‰ + PM2 çº¯è¿›ç¨‹ç®¡ç† + å¼ºåˆ¶é‡è½½æœºåˆ¶ï¼ˆ--update-envï¼‰ + å”¯ä¸€æ“ä½œå…¥å£ï¼ˆnpm run pm:\*ï¼‰

---

## ğŸ“‹ æ‰§è¡Œæ£€æŸ¥æ¸…å•ï¼ˆå¯æ‰“å°/å¤åˆ¶åˆ°ä»»åŠ¡ç³»ç»Ÿï¼‰

### é˜¶æ®µ 1ï¼šé…ç½®æºç»Ÿä¸€ï¼ˆP0 çº§ï¼Œé¢„è®¡ 2-4 å°æ—¶ï¼‰

```markdown
- [ ] 1.1 å¤‡ä»½å½“å‰é…ç½®
  - [ ] å¤åˆ¶ `.env` â†’ `.env.backup.$(date +%Y%m%d)`
  - [ ] å¤åˆ¶ `ecosystem.config.js` â†’ `ecosystem.config.js.backup`
  - [ ] å¤åˆ¶ `app.js` â†’ `app.js.backup`

- [ ] 1.2 æ¸…ç©º ecosystem.config.js çš„ env å¯¹è±¡
  - [ ] æ‰“å¼€ `ecosystem.config.js`
  - [ ] åˆ é™¤ `env: { ... }` ä¸­çš„æ‰€æœ‰å†…å®¹ï¼ˆä¿ç•™ç©ºå¯¹è±¡æˆ–å®Œå…¨åˆ é™¤è¯¥å­—æ®µï¼‰
  - [ ] ç¡®ä¿ä¿ç•™ `env_file: '.env'`
  - [ ] ä¿å­˜å¹¶éªŒè¯ JSON æ ¼å¼æ­£ç¡®

- [ ] 1.3 è¡¥å…… .env å¿…éœ€é…ç½®
  - [ ] ç¡®è®¤ `NODE_ENV` å·²é…ç½®
  - [ ] ç¡®è®¤ `PORT` å·²é…ç½®
  - [ ] ç¡®è®¤ `TZ=Asia/Shanghai` å·²é…ç½®
  - [ ] æ·»åŠ  `REDIS_URL=redis://localhost:6379`ï¼ˆæˆ–å®é™… Redis åœ°å€ï¼‰
  - [ ] ç¡®è®¤æ‰€æœ‰ DB\_\* é…ç½®é½å…¨
  - [ ] ç¡®è®¤ JWT_SECRET ç­‰å¯†é’¥é½å…¨

- [ ] 1.4 ä¿®æ”¹ app.js ç¦ç”¨ override
  - [ ] æ‰¾åˆ° `dotenv.config({ override: true })` è¡Œ
  - [ ] ä¿®æ”¹ä¸º `dotenv.config()`ï¼ˆç§»é™¤ override å‚æ•°ï¼‰
  - [ ] ç¡®è®¤å…¶ä»– dotenv.config() è°ƒç”¨ä¹Ÿéƒ½æ²¡æœ‰ override

- [ ] 1.5 éªŒè¯é…ç½®åŠ è½½
  - [ ] æ‰§è¡Œ `npm run check:env`ï¼ˆæˆ–æ‰‹å·¥éªŒè¯å¿…éœ€å˜é‡ï¼‰
  - [ ] å¯åŠ¨æœåŠ¡ï¼š`npm run pm:start:pm2`
  - [ ] æ£€æŸ¥è¿›ç¨‹ç¯å¢ƒå˜é‡ï¼š`pm2 show restaurant-lottery-backend | grep -E "DB_HOST|REDIS_URL|NODE_ENV"`
  - [ ] ç¡®è®¤è¾“å‡ºçš„å€¼ä¸ `.env` ä¸€è‡´
```

### é˜¶æ®µ 2ï¼šè¿›ç¨‹ç®¡ç†ç»Ÿä¸€ï¼ˆP0 çº§ï¼Œé¢„è®¡ 1-2 å°æ—¶ï¼‰

```markdown
- [ ] 2.1 å¢å¼º process-manager.sh
  - [ ] æ‰“å¼€ `scripts/system/process-manager.sh`
  - [ ] åœ¨ `main()` çš„ `case` è¯­å¥ä¸­æ·»åŠ  5 ä¸ªæ–°å‘½ä»¤ï¼ˆå¤åˆ¶æ–‡æ¡£ä¸­çš„ä»£ç ï¼‰ï¼š
    - [ ] `logs)` åˆ†æ”¯
    - [ ] `show|details)` åˆ†æ”¯
    - [ ] `flush-logs)` åˆ†æ”¯
    - [ ] `reload-env|reload)` åˆ†æ”¯
    - [ ] `health)` åˆ†æ”¯
  - [ ] æ›´æ–° `help` åˆ†æ”¯çš„è¾“å‡ºï¼ˆæ·»åŠ æ–°å‘½ä»¤è¯´æ˜ï¼‰
  - [ ] ä¿å­˜æ–‡ä»¶

- [ ] 2.2 æ›´æ–° package.json
  - [ ] æ‰“å¼€ `package.json`
  - [ ] åœ¨ `scripts` éƒ¨åˆ†æ·»åŠ  5 ä¸ªæ–°å‘½ä»¤ï¼š
    - [ ] `"pm:logs": "./scripts/system/process-manager.sh logs"`
    - [ ] `"pm:show": "./scripts/system/process-manager.sh show"`
    - [ ] `"pm:flush-logs": "./scripts/system/process-manager.sh flush-logs"`
    - [ ] `"pm:reload-env": "./scripts/system/process-manager.sh reload-env"`
    - [ ] `"pm:health": "./scripts/system/process-manager.sh health"`
  - [ ] ä¿å­˜æ–‡ä»¶

- [ ] 2.3 æµ‹è¯•æ–°å‘½ä»¤
  - [ ] `npm run pm:help` - æŸ¥çœ‹å¸®åŠ©ï¼ˆç¡®è®¤æ–°å‘½ä»¤å·²åˆ—å‡ºï¼‰
  - [ ] `npm run pm:logs` - æŸ¥çœ‹æ—¥å¿—ï¼ˆCtrl+C é€€å‡ºï¼‰
  - [ ] `npm run pm:show` - æŸ¥çœ‹è¯¦æƒ…
  - [ ] `npm run pm:health` - å¥åº·æ£€æŸ¥
  - [ ] `npm run pm:reload-env` - é‡æ–°åŠ è½½é…ç½®

- [ ] 2.4 åˆ é™¤æ—§è„šæœ¬ï¼ˆç¡®è®¤ä¸Šè¿°æµ‹è¯•é€šè¿‡åï¼‰
  - [ ] `rm start-service.sh`
  - [ ] `rm å¿«é€Ÿç®¡ç†è„šæœ¬.sh`
  - [ ] æ£€æŸ¥å…¶ä»–æ–‡æ¡£/è„šæœ¬æ˜¯å¦å¼•ç”¨è¿™ä¸¤ä¸ªæ–‡ä»¶ï¼Œå¦‚æœ‰åˆ™æ›´æ–°ä¸º `npm run pm:*`
```

### é˜¶æ®µ 3ï¼šæ•°æ®åº“é…ç½®æ¸…ç† + è„šæœ¬ç»Ÿä¸€æ›´æ–°ï¼ˆP1 çº§ï¼Œé¢„è®¡ 1 å°æ—¶ï¼‰

````markdown
- [ ] 3.1 ä¿®æ”¹ config/database.js ç§»é™¤é¡¶å±‚å‰¯ä½œç”¨
  - [ ] æ‰“å¼€ `config/database.js`
  - [ ] ç§»é™¤æ¨¡å—é¡¶å±‚çš„ `validateDatabaseConfig()` è°ƒç”¨
  - [ ] ç§»é™¤æ¨¡å—é¡¶å±‚çš„ `console.log` æ‰“å°è¿æ¥ä¿¡æ¯
  - [ ] ç§»é™¤æ¨¡å—é¡¶å±‚çš„ `dotenv.config()`ï¼ˆå¦‚æœ‰ï¼‰
  - [ ] ç¡®ä¿ `validateDatabaseConfig()` åªåœ¨ `testConnection()` å†…éƒ¨è°ƒç”¨
  - [ ] ä¿å­˜æ–‡ä»¶

- [ ] 3.2 ä¿®æ”¹ app.js æ·»åŠ æ˜¾å¼æ•°æ®åº“è¿æ¥æµ‹è¯•
  - [ ] æ‰“å¼€ `app.js`
  - [ ] åœ¨åº”ç”¨å¯åŠ¨é˜¶æ®µï¼ˆåˆå§‹åŒ–è·¯ç”±å‰ï¼‰æ·»åŠ ï¼š
    ```javascript
    const { testConnection } = require('./config/database')
    await testConnection() // ä¿ç•™ fail-fast
    ```
  - [ ] ç¡®è®¤å¯åŠ¨å¤±è´¥æ—¶ä¼šç«‹å³é€€å‡ºï¼ˆä¿ç•™ fail-fastï¼‰
  - [ ] ç§»é™¤ development ç¯å¢ƒå¯¹ `validateConfig()` çš„ try/catch å¿½ç•¥ï¼ˆæ‰€æœ‰ç¯å¢ƒç»Ÿä¸€ fail-fastï¼‰
  - [ ] ä¿å­˜æ–‡ä»¶

- [ ] 3.3 éªŒè¯å‰¯ä½œç”¨ç§»é™¤æ•ˆæœ
  - [ ] åœ¨ä»»æ„æµ‹è¯•è„šæœ¬ä¸­ `require('./config/database')` â†’ ä¸åº”æ‰“å°/æŠ›é”™
  - [ ] å¯åŠ¨åº”ç”¨ `npm run pm:start:pm2` â†’ åº”åœ¨å¯åŠ¨é˜¶æ®µæ˜¾å¼æ ¡éªŒ DB è¿æ¥
  - [ ] ä¸´æ—¶åˆ é™¤ `.env` ä¸­çš„ `DB_HOST` â†’ åº”å¯åŠ¨å¤±è´¥ï¼ˆfail-fast ä»ç”Ÿæ•ˆï¼‰

- [ ] 3.4 æ›´æ–°è¿ç§»è„šæœ¬
  - [ ] æ‰“å¼€ `scripts/migration/execute-migration-now.js`
  - [ ] æ‰¾åˆ°æ‰€æœ‰ `pm2 restart` å‘½ä»¤ï¼ˆ2 å¤„ï¼‰
  - [ ] ä¿®æ”¹ä¸º `pm2 restart restaurant-lottery-backend --update-env`
  - [ ] ä¿å­˜æ–‡ä»¶

- [ ] 3.5 æ›´æ–°éªŒè¯è„šæœ¬
  - [ ] æ‰“å¼€ `scripts/verify_old_apis_deleted.sh`
  - [ ] æ‰¾åˆ° `pm2 restart` å‘½ä»¤ï¼ˆ1 å¤„ï¼‰
  - [ ] ä¿®æ”¹ä¸º `pm2 restart restaurant-lottery-backend --update-env`
  - [ ] ä¿å­˜æ–‡ä»¶

- [ ] 3.6 æ›´æ–°åˆ é™¤è„šæœ¬
  - [ ] æ‰“å¼€ `scripts/delete_old_chat_apis.sh`
  - [ ] æ‰¾åˆ°æ‰€æœ‰ `pm2 restart` å‘½ä»¤ï¼ˆ2 å¤„ï¼‰
  - [ ] ä¿®æ”¹ä¸º `pm2 restart restaurant-lottery-backend --update-env`
  - [ ] ä¿å­˜æ–‡ä»¶
````

### é˜¶æ®µ 4ï¼šæœ€ç»ˆéªŒè¯ï¼ˆP1 çº§ï¼Œé¢„è®¡ 30 åˆ†é’Ÿï¼‰

```markdown
- [ ] 4.1 é…ç½®ä¿®æ”¹ç”Ÿæ•ˆæµ‹è¯•
  - [ ] ä¿®æ”¹ `.env` ä¸­çš„æŸä¸ªé…ç½®ï¼ˆå¦‚ `LOG_LEVEL=debug`ï¼‰
  - [ ] æ‰§è¡Œ `npm run pm:reload-env`
  - [ ] æ£€æŸ¥æ—¥å¿—ç¡®è®¤é…ç½®å·²ç”Ÿæ•ˆï¼š`npm run pm:logs`
  - [ ] æ¢å¤åŸé…ç½®å¹¶å†æ¬¡ reload

- [ ] 4.2 å®Œæ•´é‡å¯æµ‹è¯•
  - [ ] åœæ­¢æœåŠ¡ï¼š`npm run pm:stop`
  - [ ] ç¡®è®¤ç«¯å£å·²é‡Šæ”¾ï¼š`npm run pm:status`
  - [ ] é‡æ–°å¯åŠ¨ï¼š`npm run pm:start:pm2`
  - [ ] ç¡®è®¤æœåŠ¡æ­£å¸¸ï¼š`npm run pm:health`

- [ ] 4.3 æ–‡æ¡£æ›´æ–°
  - [ ] æ›´æ–° README.mdï¼ˆå¦‚æœ‰å¼•ç”¨æ—§è„šæœ¬ï¼‰
  - [ ] é€šçŸ¥å›¢é˜Ÿæˆå‘˜æ–°çš„ç»Ÿä¸€å‘½ä»¤
  - [ ] æ›´æ–°éƒ¨ç½²æ–‡æ¡£/è¿ç»´æ‰‹å†Œï¼ˆå¦‚æœ‰ï¼‰

- [ ] 4.4 Git æäº¤
  - [ ] `git add .env ecosystem.config.js app.js package.json scripts/`
  - [ ] `git commit -m "ç»Ÿä¸€é…ç½®æºï¼šå®æ–½å•ä¸€çœŸç›¸æºæ–¹æ¡ˆ (.env)"`
  - [ ] `git push`ï¼ˆå¦‚éœ€è¦ï¼‰
```

### é˜¶æ®µ 5ï¼šåç»­æ¸…ç†ï¼ˆP2 çº§ï¼Œæœ‰ç©ºå†åšï¼‰

```markdown
- [ ] 5.1 æ¸…ç† config.example
  - [ ] æ‰“å¼€ `config.example`
  - [ ] å°†æ‰€æœ‰æ•æ„Ÿå€¼æ›¿æ¢ä¸ºå ä½ç¬¦ï¼ˆå¦‚ `DB_PASSWORD=your_password_here`ï¼‰
  - [ ] ä¿ç•™ç»“æ„å’Œå­—æ®µè¯´æ˜

- [ ] 5.2 å›¢é˜Ÿæ²Ÿé€š
  - [ ] é€šçŸ¥å›¢é˜Ÿï¼šæµ‹è¯•è„šæœ¬ç°åœ¨è¿çœŸå®åº“ `restaurant_points_dev`
  - [ ] è¯´æ˜é£é™©ï¼šæµ‹è¯•æ•°æ®å¯èƒ½å½±å“å¼€å‘ç¯å¢ƒ
  - [ ] å»ºè®®ï¼šæµ‹è¯•å‰å…ˆå¤‡ä»½æˆ–ä½¿ç”¨äº‹åŠ¡å›æ»š

- [ ] 5.3 åˆ›å»º .env.example
  - [ ] å¤åˆ¶ `.env` â†’ `.env.example`
  - [ ] è„±æ•æ‰€æœ‰æ•æ„Ÿå€¼ï¼ˆå¯†ç ã€å¯†é’¥ç­‰ï¼‰
  - [ ] æ·»åŠ æ³¨é‡Šè¯´æ˜æ¯ä¸ªé…ç½®é¡¹çš„ç”¨é€”
  - [ ] æäº¤åˆ° Gitï¼ˆ`.env.example` å¯ä»¥è¿›ä»“åº“ï¼Œ`.env` ä¸è¡Œï¼‰
```

---

**æ‰§è¡Œæ—¶é—´ä¼°ç®—**ï¼š

- é˜¶æ®µ 1-2ï¼ˆP0ï¼‰ï¼š3-6 å°æ—¶
- é˜¶æ®µ 3ï¼ˆP1 - å«æ•°æ®åº“é…ç½®æ¸…ç†ï¼‰ï¼š1 å°æ—¶
- é˜¶æ®µ 4ï¼ˆP1ï¼‰ï¼š30 åˆ†é’Ÿ
- é˜¶æ®µ 5ï¼ˆP2ï¼‰ï¼š1 å°æ—¶
- **æ€»è®¡**ï¼š5.5-8.5 å°æ—¶ï¼ˆå¯åˆ†å¤šæ¬¡å®Œæˆï¼‰

**æ‰§è¡Œå»ºè®®**ï¼š

1. å…ˆåœ¨å¼€å‘ç¯å¢ƒ/åˆ†æ”¯æ‰§è¡Œå¹¶éªŒè¯
2. ç¡®è®¤æ— é—®é¢˜åå†åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒ
3. æ¯å®Œæˆä¸€ä¸ªé˜¶æ®µå°± Git æäº¤ä¸€æ¬¡ï¼ˆä¾¿äºå›æ»šï¼‰
4. é‡åˆ°é—®é¢˜å‚è€ƒæ–‡æ¡£ä¸­çš„"å¸¸è§é—®é¢˜æ’æŸ¥"ç« èŠ‚
