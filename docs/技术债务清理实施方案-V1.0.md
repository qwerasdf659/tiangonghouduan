# ğŸ”§ æŠ€æœ¯å€ºåŠ¡æ¸…ç†å®æ–½æ–¹æ¡ˆ V1.0

> **æ–‡æ¡£ç‰ˆæœ¬**: V1.1  
> **åˆ›å»ºæ—¶é—´**: 2026-01-24  
> **æœ€åæ›´æ–°**: 2026-01-24 20:30ï¼ˆæ–°å¢å®é™…éªŒè¯ç»“æœç« èŠ‚ï¼‰  
> **ç›®æ ‡**: å½»åº•æ¸…ç†è¿ç§»/å…¼å®¹æ®‹ç•™ï¼Œç»Ÿä¸€æŠ€æœ¯æ ˆï¼Œé™ä½ç»´æŠ¤å¤æ‚åº¦  
> **é€‚ç”¨èŒƒå›´**: åç«¯ä»£ç ã€æ•°æ®åº“ï¼ˆä¸å«å‰ç«¯é¡¹ç›®ï¼‰

---

## ğŸ“‹ ç›®å½•

0. [é¡¹ç›®ç°çŠ¶æ€»ç»“ï¼ˆåŸºäºå®é™…æ•°æ®ï¼‰](#é›¶é¡¹ç›®ç°çŠ¶æ€»ç»“åŸºäºå®é™…æ•°æ®)
0.5. [**å®é™…éªŒè¯ç»“æœï¼ˆ2026-01-24ï¼‰**](#é›¶äº”å®é™…éªŒè¯ç»“æœ2026-01-24)
1. [æ¸…ç†èŒƒå›´æ¦‚è¿°](#ä¸€æ¸…ç†èŒƒå›´æ¦‚è¿°)
2. [å¿…é¡»ä¿ç•™çš„ä¸šåŠ¡åŒè½¨è®¾è®¡](#äºŒå¿…é¡»ä¿ç•™çš„ä¸šåŠ¡åŒè½¨è®¾è®¡)
3. [è¿ç§»/å…¼å®¹æ®‹ç•™æ¸…ç†æ¸…å•](#ä¸‰è¿ç§»å…¼å®¹æ®‹ç•™æ¸…ç†æ¸…å•)
4. [æ•°æ®åº“å±‚é¢æ¸…ç†å»ºè®®](#å››æ•°æ®åº“å±‚é¢æ¸…ç†å»ºè®®)
5. [åŠŸèƒ½åˆå¹¶æ”¶ç¼©å»ºè®®](#äº”åŠŸèƒ½åˆå¹¶æ”¶ç¼©å»ºè®®)
6. [å®æ–½æ£€æŸ¥æ¸…å•](#å…­å®æ–½æ£€æŸ¥æ¸…å•)
7. [é£é™©è¯„ä¼°ä¸å›æ»šæ–¹æ¡ˆ](#ä¸ƒé£é™©è¯„ä¼°ä¸å›æ»šæ–¹æ¡ˆ)
8. [é¢„æœŸæ”¶ç›Š](#å…«é¢„æœŸæ”¶ç›Š)
9. [åç«¯é‡æ„æ–¹æ¡ˆï¼ˆçº¯åç«¯ç²¾ç®€ç‰ˆï¼‰](#ä¹åç«¯é‡æ„æ–¹æ¡ˆçº¯åç«¯ç²¾ç®€ç‰ˆ)

---

## é›¶ã€é¡¹ç›®ç°çŠ¶æ€»ç»“ï¼ˆåŸºäºå®é™…æ•°æ®ï¼‰

> **é‡è¦**: æœ¬ç« èŠ‚æ•°æ®æ¥è‡ª 2026-01-24 å¯¹çœŸå®æ•°æ®åº“çš„æŸ¥è¯¢ï¼Œéå†å²æ–‡æ¡£ã€‚

### 0.1 æŠ€æœ¯æ¶æ„æ¦‚å†µ

| ç»´åº¦ | ç°çŠ¶ |
|------|------|
| **åç«¯æ¡†æ¶** | Node.js 20+ + Express 4.18 |
| **æ•°æ®åº“** | MySQL + Sequelize ORM 6.x |
| **ç¼“å­˜** | Redis (ioredis) ç”¨äºç¼“å­˜å’Œåˆ†å¸ƒå¼é” |
| **è®¤è¯** | JWT + RBACï¼ˆUUIDè§’è‰²ç³»ç»Ÿï¼Œrole_level >= 100 ä¸ºç®¡ç†å‘˜ï¼‰ |
| **æŠ½å¥–å¼•æ“** | ç»Ÿä¸€æŠ½å¥–å¼•æ“ V4.6 Pipeline æ¶æ„ |
| **APIç‰ˆæœ¬** | V4 RESTful æ‰å¹³åŒ–è®¾è®¡ (`/api/v4/*`) |
| **æ•°æ®åº“è¡¨** | 68 å¼ è¡¨ï¼ˆå·²å®Œæˆ V4 è¿ç§»ï¼‰ |
| **æ—¶åŒº** | å…¨é“¾è·¯åŒ—äº¬æ—¶é—´ (Asia/Shanghai) |

### 0.2 æ•°æ®åº“å®é™…æ•°æ®ç»Ÿè®¡

#### æ ¸å¿ƒä¸šåŠ¡æ•°æ®

| æ•°æ®ç±»å‹ | æ•°é‡ | è¯´æ˜ |
|----------|------|------|
| **ç”¨æˆ·æ€»æ•°** | 1,572 | æŒ‰ role_level åˆ†å±‚ç®¡ç† |
| **æ´»è·ƒæŠ½å¥–æ´»åŠ¨** | 1 ä¸ª | campaign_code: BASIC_LOTTERY |
| **å¥–å“é…ç½®** | 5 ä¸ª | ç§¯åˆ†å¥–å“4ç§ + è°¢è°¢æƒ é¡¾1ç§ |
| **ç‰©å“å®ä¾‹** | 2,172 ä¸ª | voucher: 2,170, product: 2 |
| **æ ¸é”€è®¢å•** | 1,012 ä¸ª | pending: 504, fulfilled: 2, expired: 506 |
| **èµ„äº§äº¤æ˜“æµæ°´** | 5,600+ æ¡ | æŒ‰ business_type åˆ†ç±» |

#### è§’è‰²ç³»ç»Ÿï¼ˆ9ä¸ªè§’è‰²ï¼‰

| è§’è‰² | role_level | è¯´æ˜ |
|------|------------|------|
| super_admin | 1000 | è¶…çº§ç®¡ç†å‘˜ |
| admin | 500 | ç®¡ç†å‘˜ |
| merchant | 300 | å•†æˆ· |
| staff | 200 | å‘˜å·¥ |
| moderator | 120 | ç‰ˆä¸» |
| vip_user | 50 | VIPç”¨æˆ· |
| regular_user | 10 | æ™®é€šç”¨æˆ· |
| guest | 1 | è®¿å®¢ |
| banned | 0 | ç¦ç”¨ç”¨æˆ· |

#### ç”¨æˆ·è§’è‰²åˆ†å¸ƒ

| è§’è‰² | ç”¨æˆ·æ•° |
|------|--------|
| regular_user | 1,559 |
| merchant | 7 |
| staff | 3 |
| super_admin | 1 |
| admin | 1 |
| vip_user | 1 |

#### èµ„äº§ç±»å‹å®šä¹‰ï¼ˆmaterial_asset_typesï¼‰

| asset_code | display_name | å¯äº¤æ˜“ |
|------------|--------------|--------|
| POINTS | ç§¯åˆ† | æ˜¯ |
| DIAMOND | é’»çŸ³ | æ˜¯ |
| GOLD_COIN | é‡‘å¸ | å¦ |
| SILVER_COIN | é“¶å¸ | å¦ |
| COPPER_COIN | é“œå¸ | å¦ |
| ENERGY | èƒ½é‡ | å¦ |
| EXPERIENCE | ç»éªŒ | å¦ |

#### è´¦æˆ·ç±»å‹åˆ†å¸ƒ

| account_type | system_code | æ•°é‡ |
|--------------|-------------|------|
| user | MAIN | 1,572 |
| system | SYSTEM_FEE | 1 |
| system | SYSTEM_CUSTODY | 1 |
| system | SYSTEM_DESTROY | 1 |
| system | SYSTEM_EMISSION | 1 |

#### èµ„äº§äº¤æ˜“ç±»å‹(Top10)

| business_type | asset_code | æ•°é‡ |
|---------------|------------|------|
| lottery_draw | POINTS | 3,040 |
| lottery_win | POINTS | 1,628 |
| consumption_refund | POINTS | 433 |
| admin_adjust | POINTS | 170 |
| admin_adjustment | POINTS | 146 |
| signin | POINTS | 80 |
| exchange_market_fee | POINTS | 36 |
| exchange_market_order_create | POINTS | 34 |
| trade_complete | POINTS | 18 |
| exchange_market_order_cancel | POINTS | 12 |

#### ç‰©å“å®ä¾‹çŠ¶æ€åˆ†å¸ƒ

| status | item_type | æ•°é‡ |
|--------|-----------|------|
| in_backpack | voucher | 1,677 |
| pending_redemption | voucher | 457 |
| redeemed | voucher | 34 |
| listed | product | 2 |
| used | voucher | 2 |

#### æ ¸é”€è®¢å•çŠ¶æ€åˆ†å¸ƒ

| status | æ•°é‡ |
|--------|------|
| expired | 506 |
| pending | 504 |
| fulfilled | 2 |

### 0.3 åŠŸèƒ½å¼€å…³çŠ¶æ€ï¼ˆfeature_flagsï¼‰

| flag_key | çŠ¶æ€ | è¯´æ˜ |
|----------|------|------|
| ENABLE_LOTTERY | âœ… å¯ç”¨ | æŠ½å¥–ç³»ç»Ÿæ€»å¼€å…³ |
| ENABLE_POINTS_EXCHANGE | âœ… å¯ç”¨ | ç§¯åˆ†å…‘æ¢ |
| ENABLE_MARKET_TRADE | âŒ ç¦ç”¨ | å¸‚åœºäº¤æ˜“ï¼ˆè®¡åˆ’ä¸­ï¼‰ |
| ENABLE_CHAT | âœ… å¯ç”¨ | èŠå¤©åŠŸèƒ½ |
| ENABLE_SIGNIN | âœ… å¯ç”¨ | ç­¾åˆ°åŠŸèƒ½ |
| ENABLE_CONSUMPTION | âœ… å¯ç”¨ | æ¶ˆè´¹ç§¯åˆ† |

### 0.4 æ•°æ®åº“è¡¨æ¸…å•ï¼ˆ68å¼ è¡¨ï¼‰

å·²ç¡®è®¤å­˜åœ¨çš„è¡¨ï¼š
```
account_asset_balances, accounts, admin_operation_logs, announcement_read_status,
announcements, asset_freeze_records, asset_transactions, authentication_sessions,
chat_messages, consumption_records, consumption_store_configs, content_review_records,
customer_sessions, exchange_market_items, exchange_market_orders, exchange_rate_configs,
feature_flags, hourly_metrics, image_usage_log, images, item_instances, item_templates,
lottery_campaigns, lottery_daily_metrics, lottery_draws, lottery_hourly_metrics,
lottery_pool_configs, lottery_pool_items, lottery_prizes, lottery_probability_tiers,
lottery_user_daily_draw_quota, market_listings, material_asset_types, menu_structure,
permissions, point_deduction_rules, preset_budget_debts, preset_debt_limits,
preset_draw_results, preset_inventory_debts, prize_cost_configs, prize_tier_configs,
qrcode_batches, qrcode_templates, rate_limit_configs, redemption_orders, risk_events,
roles, sequelizemeta, signin_configs, signin_records, store_consumption_quota,
system_configs, system_dictionaries, system_settings, trade_records, user_daily_limits,
user_devices, user_premium_status, user_risk_profiles, user_roles, user_segments, users,
verification_codes, wechat_bindigns, wechat_bindingsw
```

### 0.5 å•†ä¸šæ¨¡å¼ç†è§£

åŸºäºæ•°æ®åˆ†æï¼Œé¡¹ç›®æ˜¯ä¸€ä¸ª**é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ**ï¼š

1. **ç§¯åˆ†è·å–**ï¼šç”¨æˆ·é€šè¿‡æ¶ˆè´¹ã€ç­¾åˆ°ç­‰æ–¹å¼è·å–ç§¯åˆ†
2. **ç§¯åˆ†æ¶ˆè€—**ï¼šç”¨æˆ·ä½¿ç”¨ç§¯åˆ†è¿›è¡ŒæŠ½å¥–ï¼ˆæ¯æ¬¡æ¶ˆè€—ä¸€å®šç§¯åˆ†ï¼‰
3. **å¥–å“ç±»å‹**ï¼š
   - ç§¯åˆ†å¥–å“ï¼ˆä¸­å¥–è¿”è¿˜æ›´å¤šç§¯åˆ†ï¼‰
   - ä¼˜æƒ åˆ¸ï¼ˆå­˜å…¥èƒŒåŒ…ï¼Œå¯æ ¸é”€ï¼‰
   - è°¢è°¢æƒ é¡¾ï¼ˆæœªä¸­å¥–ï¼‰
4. **èƒŒåŒ…ç³»ç»Ÿ**ï¼š
   - `assets[]`ï¼šå¯å åŠ èµ„äº§ï¼ˆç§¯åˆ†ã€é’»çŸ³ç­‰ï¼‰
   - `items[]`ï¼šä¸å¯å åŠ ç‰©å“ï¼ˆä¼˜æƒ åˆ¸å®ä¾‹ï¼‰
5. **æ ¸é”€æµç¨‹**ï¼šç”¨æˆ·å±•ç¤ºäºŒç»´ç  â†’ å•†æˆ·æ‰«ç æ ¸é”€ â†’ è®¢å•å®Œæˆ
6. **ç®¡ç†åŠŸèƒ½**ï¼š
   - æŠ½å¥–æ¦‚ç‡é…ç½®
   - é¢„è®¾ä¸­å¥–ï¼ˆç®¡ç†å‘˜å¹²é¢„ï¼‰
   - èµ„äº§è°ƒæ•´
   - å®¡è®¡æ—¥å¿—

---

## é›¶äº”ã€å®é™…éªŒè¯ç»“æœï¼ˆ2026-01-24ï¼‰

> **é‡è¦**: æœ¬ç« èŠ‚è®°å½•é€šè¿‡ Node.js è„šæœ¬è¿æ¥çœŸå®æ•°æ®åº“çš„éªŒè¯ç»“æœï¼Œç¡®è®¤æ¸…ç†é¡¹å½“å‰çŠ¶æ€ã€‚

### 0.5.1 æ•°æ®åº“å±‚é¢éªŒè¯ç»“æœ

#### æ—§è¡¨æ¸…ç†çŠ¶æ€ï¼ˆâœ… å…¨éƒ¨å·²æ¸…ç†ï¼‰

| æ—§è¡¨å | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| `user_prize_budget` | âœ… ä¸å­˜åœ¨ | å·²æ¸…ç† |
| `user_wallet` | âœ… ä¸å­˜åœ¨ | å·²æ¸…ç† |
| `lottery_records` | âœ… ä¸å­˜åœ¨ | å·²æ¸…ç† |
| `prize_records` | âœ… ä¸å­˜åœ¨ | å·²æ¸…ç† |
| `user_inventory` | âœ… ä¸å­˜åœ¨ | å·²è¢« `item_instances` æ›¿ä»£ |
| `points_transactions` | âœ… ä¸å­˜åœ¨ | å·²è¢« `asset_transactions` æ›¿ä»£ |
| `user_points_accounts` | âœ… ä¸å­˜åœ¨ | å·²è¢« `accounts` + `account_asset_balances` æ›¿ä»£ |
| `trade_records` | âœ… ä¸å­˜åœ¨ | å·²æ¸…ç† |

#### V1é—ç•™å­—æ®µæ¸…ç†çŠ¶æ€ï¼ˆâœ… å…¨éƒ¨å·²æ¸…ç†ï¼‰

| è¡¨å | å­—æ®µ | çŠ¶æ€ |
|------|------|------|
| `consumption_records` | `qr_code_version` | âœ… å·²æ¸…ç† |
| `consumption_records` | `is_legacy_v1` | âœ… å·²æ¸…ç† |

#### ç©ºè¡¨åˆ†æï¼ˆå…±13å¼ ï¼Œå‡ä¸ºä¸šåŠ¡é¢„ç•™ï¼‰

| è¡¨å | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| `lottery_campaign_quota_grants` | ğŸŸ¡ ç©ºè¡¨ | æ´»åŠ¨é…é¢æˆæƒ - é¢„ç•™åŠŸèƒ½ |
| `lottery_campaign_user_quota` | ğŸŸ¡ ç©ºè¡¨ | ç”¨æˆ·æ´»åŠ¨é…é¢ - é¢„ç•™åŠŸèƒ½ |
| `lottery_daily_metrics` | ğŸŸ¡ ç©ºè¡¨ | æ¯æ—¥ç»Ÿè®¡ - æ•°æ®å°šæœªç”Ÿæˆ |
| `lottery_draw_decisions` | ğŸŸ¡ ç©ºè¡¨ | æŠ½å¥–å†³ç­– - æ­£å¸¸ä¸šåŠ¡é¢„ç•™ |
| `lottery_hourly_metrics` | ğŸŸ¡ ç©ºè¡¨ | å°æ—¶ç»Ÿè®¡ - æ•°æ®å°šæœªç”Ÿæˆ |
| `lottery_user_experience_state` | ğŸŸ¡ ç©ºè¡¨ | ç”¨æˆ·ä½“éªŒçŠ¶æ€ - é¢„ç•™åŠŸèƒ½ |
| `lottery_user_global_state` | ğŸŸ¡ ç©ºè¡¨ | ç”¨æˆ·å…¨å±€çŠ¶æ€ - é¢„ç•™åŠŸèƒ½ |
| `preset_budget_debt` | ğŸŸ¡ ç©ºè¡¨ | é¢„è®¾é¢„ç®—æ¬ è´¦ - ä¸šåŠ¡éœ€è¦ |
| `preset_debt_limits` | ğŸŸ¡ ç©ºè¡¨ | é¢„è®¾æ¬ è´¦é™åˆ¶ - ä¸šåŠ¡éœ€è¦ |
| `preset_inventory_debt` | ğŸŸ¡ ç©ºè¡¨ | é¢„è®¾åº“å­˜æ¬ è´¦ - ä¸šåŠ¡éœ€è¦ |
| `trade_orders` | ğŸŸ¡ ç©ºè¡¨ | äº¤æ˜“è®¢å• - ä¸šåŠ¡åŠŸèƒ½é¢„ç•™ |
| `user_premium_status` | ğŸŸ¡ ç©ºè¡¨ | ç”¨æˆ·é«˜çº§çŠ¶æ€ - ä¸šåŠ¡åŠŸèƒ½ |
| `system_dictionary_history` | ğŸŸ¡ ç©ºè¡¨ | å­—å…¸å†å² - å¾…è¯„ä¼° |

**ç»“è®º**: ç©ºè¡¨å‡ä¸ºä¸šåŠ¡é¢„ç•™åŠŸèƒ½ï¼Œ**æ— éœ€åˆ é™¤**ã€‚

#### è´¦æˆ·åŒè½¨éªŒè¯ï¼ˆâœ… æ­£å¸¸è¿è¡Œï¼‰

| account_type | æ•°é‡ | è¯´æ˜ |
|--------------|------|------|
| `user` | 21 ä¸ª | ç”¨æˆ·è´¦æˆ· |
| `system` | 6 ä¸ª | ç³»ç»Ÿè´¦æˆ·ï¼ˆFEE/CUSTODY/DESTROY/EMISSIONç­‰ï¼‰ |

#### ç‰©å“å®ä¾‹çŠ¶æ€åˆ†å¸ƒ

| status | item_type | æ•°é‡ |
|--------|-----------|------|
| `used` | voucher | 1,126 |
| `locked` | voucher | 533 |
| `available` | voucher | 511 |
| `available` | product | 2 |

#### å…‘æ¢è®¢å•çŠ¶æ€åˆ†å¸ƒ

| status | æ•°é‡ |
|--------|------|
| `expired` | 506 |
| `pending` | 504 |
| `fulfilled` | 2 |

### 0.5.2 ä»£ç å±‚é¢éªŒè¯ç»“æœ

#### å·²ç¡®è®¤å­˜åœ¨çš„å…¼å®¹ä»£ç ï¼ˆå¾…æ¸…ç†ï¼‰

| æ–‡ä»¶ | è¡Œå· | é—®é¢˜ | çŠ¶æ€ |
|------|------|------|------|
| `middleware/sensitiveOperation.js` | L64-72 | æ—§Tokenå…¼å®¹ï¼ˆç¼ºå°‘session_tokenæ—¶å…è®¸é€šè¿‡ï¼‰ | â³ å¾…æ¸…ç† |
| `app.js` | L524-600 | `PAGE_REDIRECT_MAP` é¡µé¢é‡å®šå‘ | â³ å¾…æ¸…ç† |
| `services/PrizePoolService.js` | L144-153 | `value_points`/`budget_cost_points`/`probability` å­—æ®µå…¼å®¹ | â³ å¾…æ¸…ç† |
| `routes/v4/console/marketplace.js` | L40-62 | è·¯å¾„æ˜ å°„ä¸­é—´ä»¶ï¼ˆ`/exchange-items` â†’ `/exchange_market/items`ï¼‰ | â³ å¾…æ¸…ç† |
| `routes/v4/shop/audit/index.js` | L123-128 | å“åº”å­—æ®µåˆ«åï¼ˆ`operator`, `store`, `target_user`ï¼‰ | â³ å¾…æ¸…ç† |
| `routes/v4/lottery/campaigns.js` | L158 | å®šä»·é…ç½®æ ¼å¼å…¼å®¹ï¼ˆæ•°ç»„â†’å¯¹è±¡è½¬æ¢ï¼‰ | â³ å¾…æ¸…ç† |
| `routes/v4/console/shared/middleware.js` | L74 | `sharedComponents` åˆ«åæ³¨é‡Š | â³ å¾…æ¸…ç† |

### 0.5.3 æ ¹ç›®å½•æ®‹ç•™æ–‡ä»¶éªŒè¯

| æ–‡ä»¶ | çŠ¶æ€ | å¤„ç†æ–¹å¼ |
|------|------|----------|
| `app.js.backup.20260108_125922` | â³ å­˜åœ¨ | âŒ åˆ é™¤ |
| `æ•°æ®åº“è¿ç§»è„šæœ¬.sql` | â³ å­˜åœ¨ | âŒ åˆ é™¤ |
| `test_material_api.sh` | â³ å­˜åœ¨ | âŒ åˆ é™¤ |
| `test-config-api-auth.sh` | â³ å­˜åœ¨ | âŒ åˆ é™¤ |
| `db_analyze.js` | â³ å­˜åœ¨ | âŒ åˆ é™¤ |
| `generate_api_business_content.py` | â³ å­˜åœ¨ | âŒ åˆ é™¤ |
| `analyze_project.js` | â³ å­˜åœ¨ | âŒ åˆ é™¤ |
| `analyze_project2.js` | â³ å­˜åœ¨ | âŒ åˆ é™¤ |
| `analyze_project3.js` | â³ å­˜åœ¨ | âŒ åˆ é™¤ |

### 0.5.4 scripts/migration æ®‹ç•™è„šæœ¬

| æ–‡ä»¶ | çŠ¶æ€ | å¤„ç†æ–¹å¼ |
|------|------|----------|
| `scripts/migration/analyze-old-codes.sql` | â³ å­˜åœ¨ | âŒ åˆ é™¤ |
| `scripts/migration/EXECUTE_TONIGHT.sh` | â³ å­˜åœ¨ | âŒ åˆ é™¤ |
| `scripts/migration/add_opening_balance.js` | â³ å­˜åœ¨ | â³ è¯„ä¼°åå†³å®š |

### 0.5.5 éªŒè¯ç»“è®º

| ç»´åº¦ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| **æ•°æ®åº“æ—§è¡¨** | âœ… å·²æ¸…ç† | æ‰€æœ‰æ–‡æ¡£æåŠçš„æ—§è¡¨å‡ä¸å­˜åœ¨ |
| **V1é—ç•™å­—æ®µ** | âœ… å·²æ¸…ç† | `qr_code_version`, `is_legacy_v1` å·²æ¸…ç† |
| **ç©ºè¡¨** | âœ… ä¸šåŠ¡éœ€è¦ | 13å¼ ç©ºè¡¨å‡ä¸ºé¢„ç•™åŠŸèƒ½ï¼Œä¸åˆ é™¤ |
| **è´¦æˆ·åŒè½¨** | âœ… æ­£å¸¸è¿è¡Œ | user(21) + system(6) è®¾è®¡æ­£ç¡® |
| **ä»£ç å…¼å®¹å±‚** | â³ å¾…æ¸…ç† | 7å¤„å…¼å®¹ä»£ç ç¡®è®¤å­˜åœ¨ |
| **æ®‹ç•™æ–‡ä»¶** | â³ å¾…æ¸…ç† | 9ä¸ªæ ¹ç›®å½•æ–‡ä»¶ + 3ä¸ªè¿ç§»è„šæœ¬ |

---

## ä¸€ã€æ¸…ç†èŒƒå›´æ¦‚è¿°

### 1.1 æ¸…ç†åŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **æš´åŠ›é‡æ„** | ä¸å…¼å®¹æ—§æ¥å£ï¼Œç›´æ¥åˆ é™¤æ—§æ–¹æ¡ˆ |
| **ä¸šåŠ¡ä¼˜å…ˆ** | ä¿è¯ä¸šåŠ¡åŠŸèƒ½ä¸å˜ |
| **ä»£ç å¯¹é½** | æ–‡æ¡£å’Œä»£ç å®Œå…¨å¯¹é½ï¼Œæ— æ®‹ç•™ |
| **ä¸€æ¬¡æŠ•å…¥** | é¡¹ç›®æœªä¸Šçº¿ï¼Œå¯ä¸€æ¬¡æ€§å½»åº•æ¸…ç† |

### 1.2 æ¸…ç†èŒƒå›´

- âœ… åç«¯ä»£ç ï¼ˆservicesã€routesã€modelsï¼‰
- âœ… æ•°æ®åº“ï¼ˆåºŸå¼ƒè¡¨ã€åºŸå¼ƒå­—æ®µï¼‰
- âœ… è„šæœ¬æ–‡ä»¶ï¼ˆä¸´æ—¶è„šæœ¬ã€æ—§è¿ç§»è„šæœ¬ï¼‰
- âœ… è§„èŒƒæ–‡æ¡£ï¼ˆ`.cursor/rules/`ï¼‰
- âŒ å‰ç«¯é¡¹ç›®ï¼ˆä¸åœ¨æœ¬æ¬¡æ¸…ç†èŒƒå›´å†…ï¼‰

---

## äºŒã€å¿…é¡»ä¿ç•™çš„ä¸šåŠ¡åŒè½¨è®¾è®¡

ä»¥ä¸‹æ˜¯**ä¸šåŠ¡è®¾è®¡å¿…é¡»ä¿ç•™**çš„åŒè½¨æ¶æ„ï¼Œ**ä¸æ¸…ç†**ï¼š

| åŒè½¨è®¾è®¡ | ä½ç½® | ä¿ç•™åŸå›  |
|----------|------|----------|
| **èƒŒåŒ…åŒè½¨æ¶æ„** | `BackpackService.js` | `assets[]`ï¼ˆå¯å åŠ èµ„äº§ï¼‰+ `items[]`ï¼ˆä¸å¯å åŠ ç‰©å“ï¼‰æ˜¯ä¸šåŠ¡æ¨¡å‹è®¾è®¡ |
| **è´¦æˆ·åŒè½¨æ¶æ„** | `Account` æ¨¡å‹ | userè´¦æˆ· + systemè´¦æˆ· åŒºåˆ†ç”¨æˆ·å’Œç³»ç»Ÿèµ„äº§ |
| **åˆ†æåŒè½¨æŸ¥è¯¢** | `LotteryAnalyticsService.js` | è¿‘æœŸæŸ¥æ˜ç»†è¡¨(`lottery_draws`) + å†å²æŸ¥èšåˆè¡¨(`hourly_metrics`) æ˜¯æ€§èƒ½ä¼˜åŒ–è®¾è®¡ |
| **å†³ç­–æ¥æºä¸‰è½¨** | `UnifiedLotteryEngine` | `preset/override/normal` æ˜¯æŠ½å¥–å†³ç­–ä¼˜å…ˆçº§æœºåˆ¶ï¼Œç®¡ç†å‘˜å¹²é¢„åŠŸèƒ½ |
| **æŠ½å¥–fallbackä¿åº•** | æŠ½å¥–å¼•æ“å¤šå¤„ | æ¡£ä½é™çº§è·¯å¾„ `high â†’ mid â†’ low â†’ fallback` æ˜¯ä¸šåŠ¡åŠŸèƒ½ |
| **ä¸´æ—¶è¡¥å¿æ¬¡æ•°** | `LotteryUserDailyDrawQuota` | `bonus_draw_count` æ˜¯å®¢æœåŠ æ¬¡æ•°åŠŸèƒ½ï¼Œä¸šåŠ¡è®¾è®¡ |
| **V2åŠ¨æ€äºŒç»´ç ** | `routes/v4/shop/consumption/qrcode.js` | å½“å‰ç‰ˆæœ¬ï¼ŒV1å·²ç§»é™¤ï¼ŒéåŒè½¨ |

### ä¸šåŠ¡åŒè½¨è¯¦ç»†è¯´æ˜

#### 2.1 èƒŒåŒ…åŒè½¨æ¶æ„

```javascript
// BackpackService.js è¿”å›ç»“æ„
{
  assets: [           // å¯å åŠ èµ„äº§ï¼ˆç§¯åˆ†ã€é’»çŸ³ã€ææ–™ï¼‰
    { asset_code: 'POINTS', balance: 1000 },
    { asset_code: 'DIAMOND', balance: 50 }
  ],
  items: [            // ä¸å¯å åŠ ç‰©å“ï¼ˆä¼˜æƒ åˆ¸ã€å¥–å“å®ä¾‹ï¼‰
    { item_instance_id: 'xxx', item_type: 'COUPON' }
  ]
}
```

#### 2.2 è´¦æˆ·ç±»å‹åŒè½¨

```javascript
// Account æ¨¡å‹ account_type å­—æ®µ
- 'user': ç”¨æˆ·è´¦æˆ·ï¼ˆç”¨æˆ·èµ„äº§ï¼‰
- 'system': ç³»ç»Ÿè´¦æˆ·ï¼ˆæ‰‹ç»­è´¹/å‘æ”¾/é”€æ¯/æ‰˜ç®¡ï¼‰
```

#### 2.3 åˆ†ææ—¶é—´åŒè½¨

```javascript
// LotteryAnalyticsService.js æŸ¥è¯¢ç­–ç•¥
- 24å°æ—¶å†…æ•°æ®: æŸ¥è¯¢ lottery_draws è¡¨ï¼ˆå®æ—¶æ€§ä¼˜å…ˆï¼‰
- 7-90å¤©å†å²æ•°æ®: æŸ¥è¯¢ lottery_hourly_metrics è¡¨ï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰
- 90å¤©ä»¥ä¸Šæ•°æ®: æŸ¥è¯¢ lottery_daily_metrics è¡¨ï¼ˆå­˜å‚¨æ•ˆç‡ä¼˜å…ˆï¼‰
```

---

## ä¸‰ã€è¿ç§»/å…¼å®¹æ®‹ç•™æ¸…ç†æ¸…å•

### ã€ä¸­é—´ä»¶å±‚é¢ã€‘

#### 3.0 æ•æ„Ÿæ“ä½œæ—§Tokenå…¼å®¹ï¼ˆP0 å®‰å…¨ç›¸å…³ï¼‰

| æ–‡ä»¶ | è¡Œå· | é—®é¢˜ | å¤„ç†æ–¹å¼ |
|------|------|------|----------|
| `middleware/sensitiveOperation.js` | ç¬¬60-73è¡Œ | æ—§Tokenå…¼å®¹é€»è¾‘ï¼ˆç¼ºå°‘session_tokenæ—¶å…è®¸é€šè¿‡ï¼‰ | âŒ **åˆ é™¤å…¼å®¹åˆ†æ”¯ï¼Œç»Ÿä¸€ä¸¥æ ¼æ¨¡å¼** |

**è¯¦ç»†è¯´æ˜**:
```javascript
// å¾…åˆ é™¤ä»£ç ä½ç½®ï¼šmiddleware/sensitiveOperation.js ç¬¬60-73è¡Œ
// å½“å‰é€»è¾‘ï¼šç¼ºå°‘ session_token æ—¶ä»…è­¦å‘Šä½†å…è®¸é€šè¿‡
// ç›®æ ‡ï¼šç»Ÿä¸€ä½¿ç”¨ä¸¥æ ¼æ¨¡å¼ï¼Œç¼ºå°‘ session_token ç›´æ¥æ‹’ç»

// ğŸ”´ å½“å‰å…¼å®¹ä»£ç ï¼ˆéœ€åˆ é™¤ï¼‰
if (!sessionToken) {
  logger.warn(`âš ï¸ [SensitiveOp] æ•æ„Ÿæ“ä½œç¼ºå°‘session_token...`)
  // æš‚æ—¶å…è®¸é€šè¿‡ï¼Œåç»­å¯æ”¹ä¸ºæ‹’ç»ï¼š
  return next()  // â† è¿™æ˜¯å…¼å®¹æ—§Tokençš„é€»è¾‘ï¼Œéœ€åˆ é™¤
}

// âœ… æ”¹ä¸ºä¸¥æ ¼æ¨¡å¼
if (!sessionToken) {
  return res.apiError('ä¼šè¯ä¿¡æ¯ç¼ºå¤±ï¼Œè¯·é‡æ–°ç™»å½•', 'SESSION_REQUIRED', null, 401)
}
```

**æ–¹æ¡ˆé€‰æ‹©**:
- æ–¹æ¡ˆAï¼šä¿®æ”¹ `requireValidSession` ä¸ºä¸¥æ ¼æ¨¡å¼ï¼ˆæ¨èï¼‰
- æ–¹æ¡ˆBï¼šæ‰€æœ‰æ•æ„Ÿæ“ä½œæ”¹ç”¨ `requireValidSessionStrict`

---

### ã€æœåŠ¡å±‚é¢ã€‘

#### 3.0.1 å¥–å“åˆ›å»ºå­—æ®µå…¼å®¹

| æ–‡ä»¶ | è¡Œå· | é—®é¢˜ | å¤„ç†æ–¹å¼ |
|------|------|------|----------|
| `services/PrizePoolService.js` | ç¬¬141-153è¡Œ | å¤šå­—æ®µå…¼å®¹é€»è¾‘ | âŒ **åˆ é™¤æ—§å­—æ®µå…¼å®¹** |

**è¯¦ç»†è¯´æ˜**:
```javascript
// å¾…æ¸…ç†ä»£ç ä½ç½®ï¼šservices/PrizePoolService.js ç¬¬141-153è¡Œ

// ğŸ”´ å½“å‰å…¼å®¹ä»£ç ï¼ˆéœ€åˆ é™¤æ—§å­—æ®µæ”¯æŒï¼‰
prize_value_points:
  parseInt(
    prizeData.prize_value_points ??
      prizeData.value_points ??      // â† æ—§å­—æ®µå…¼å®¹ï¼Œéœ€åˆ é™¤
      prizeData.budget_cost_points ?? // â† æ—§å­—æ®µå…¼å®¹ï¼Œéœ€åˆ é™¤
      0
  ) || 0,
win_probability: prizeData.win_probability || prizeData.probability || 0, // probability æ˜¯æ—§å­—æ®µ

// âœ… æ¸…ç†åï¼ˆåªæ¥å—è§„èŒƒå­—æ®µï¼‰
prize_value_points: parseInt(prizeData.prize_value_points ?? 0) || 0,
win_probability: prizeData.win_probability || 0,
```

**å‰ç½®æ¡ä»¶**ï¼šç¡®è®¤å‰ç«¯å·²ç»Ÿä¸€ä½¿ç”¨ `prize_value_points` å’Œ `win_probability`

---

#### 3.0.2 APIå“åº”æ ¼å¼å­—æ®µåˆ«å

| æ–‡ä»¶ | è¡Œå· | é—®é¢˜ | å¤„ç†æ–¹å¼ |
|------|------|------|----------|
| `routes/v4/shop/audit/index.js` | ç¬¬122-128è¡Œ, 180-186è¡Œ | å“åº”å­—æ®µåˆ«åå…¼å®¹ | âŒ **åˆ é™¤åˆ«åå­—æ®µ** |

**è¯¦ç»†è¯´æ˜**:
```javascript
// å¾…æ¸…ç†ä»£ç ä½ç½®ï¼šroutes/v4/shop/audit/index.js

// ğŸ”´ å½“å‰å…¼å®¹ä»£ç ï¼ˆæ·»åŠ äº†åˆ«åå­—æ®µï¼‰
const logs = result_data.items.map(log => ({
  ...log,
  operator: log.operator_info,     // â† åˆ«åå­—æ®µï¼Œéœ€åˆ é™¤
  store: log.store_info,           // â† åˆ«åå­—æ®µï¼Œéœ€åˆ é™¤
  target_user: log.target_user_info // â† åˆ«åå­—æ®µï¼Œéœ€åˆ é™¤
}))

// âœ… æ¸…ç†åï¼ˆç›´æ¥è¿”å›ï¼Œå‰ç«¯ä½¿ç”¨ operator_info ç­‰å­—æ®µåï¼‰
const logs = result_data.items
```

**å‰ç½®æ¡ä»¶**ï¼šç¡®è®¤å‰ç«¯å·²ä½¿ç”¨ `operator_info`ã€`store_info`ã€`target_user_info`

---

#### 3.0.3 è·¯ç”±å±‚è·¯å¾„æ˜ å°„å…¼å®¹

| æ–‡ä»¶ | è¡Œå· | é—®é¢˜ | å¤„ç†æ–¹å¼ |
|------|------|------|----------|
| `routes/v4/console/marketplace.js` | ç¬¬40-62è¡Œ | å‰ç«¯è·¯å¾„ç®€åŒ–å…¼å®¹ä¸­é—´ä»¶ | âŒ **åˆ é™¤è·¯å¾„æ˜ å°„** |

**è¯¦ç»†è¯´æ˜**:
```javascript
// å¾…æ¸…ç†ä»£ç ä½ç½®ï¼šroutes/v4/console/marketplace.js ç¬¬40-62è¡Œ

// ğŸ”´ å½“å‰å…¼å®¹ä¸­é—´ä»¶ï¼ˆè·¯å¾„é‡å†™ï¼‰
const pathMappings = {
  '/exchange-items': '/exchange_market/items',
  '/exchange-orders': '/exchange_market/orders',
  '/exchange-stats': '/exchange_market/statistics',
  '/trade-orders': '/trade_orders'
}
// ... è·¯å¾„é‡å†™é€»è¾‘
```

**å‰ç½®æ¡ä»¶**ï¼šç¡®è®¤å‰ç«¯å·²ä½¿ç”¨è§„èŒƒè·¯å¾„

---

### ã€ä»£ç å±‚é¢ã€‘

#### 3.1 éœ€è¦æ¸…ç†çš„å†å²æ³¨é‡Š

| æ–‡ä»¶ | è¡Œå·/ä½ç½® | æ¸…ç†å†…å®¹ |
|------|-----------|----------|
| `services/index.js` | ç¬¬17è¡Œ | `ğŸ†• ç§¯åˆ†æ“ä½œç»Ÿä¸€ä½¿ç”¨ AssetServiceï¼ˆå·²ç§»é™¤ PointsServiceï¼‰` |
| `services/IdempotencyService.js` | ç¬¬78-79è¡Œ | `ã€å·²æ‹æ¿å†³ç­– 2026-01-19ã€‘ï¼šè·¯å¾„åŒè½¨æ¸…ç†` |
| `services/IdempotencyService.js` | ç¬¬614-615, 796-797è¡Œ | å¼ºåˆ¶ä¸å…¼å®¹ç­–ç•¥æ³¨é‡Š |
| `routes/v4/shop/exchange/exchange.js` | ç¬¬23, 29, 57, 114è¡Œ | è·¯å¾„åŒè½¨æ¸…ç†å†å²æ³¨é‡Š |
| `services/ConsumptionService.js` | ç¬¬280, 376è¡Œ | æ¶æ„å†³ç­–å’Œå†å²å…¼å®¹æ³¨é‡Š |
| `services/UserRoleService.js` | å¤šå¤„ | `ä» UserPermissionModule è¿ç§»` æ³¨é‡Š |
| `services/ChatWebSocketService.js` | ç¬¬174è¡Œ | `åˆ é™¤ is_admin å…¼å®¹` æ³¨é‡Š |
| `services/ImageService.js` | ç¬¬476, 480è¡Œ | æ¶æ„å†³ç­–/å…¼å®¹ä»£ç æ¸…ç†æ³¨é‡Š |
| `services/DataSanitizer.js` | ç¬¬64è¡Œ | `å…¼å®¹å­—æ®µæ¸…ç†` æ³¨é‡Š |
| `models/index.js` | ç¬¬17è¡Œ | `å·²ç§»é™¤ PointsService` æ³¨é‡Š |

#### 3.2 æ— éœ€æ¸…ç†çš„ä»£ç 

- **å®é™…åŒè½¨ä»£ç **: èƒŒåŒ…åŒè½¨ã€è´¦æˆ·åŒè½¨ã€åˆ†æåŒè½¨ â€” è¿™äº›æ˜¯ä¸šåŠ¡è®¾è®¡ï¼Œä¿ç•™
- **è·¯ç”±ä»£ç **: é¡¹ç›®å·²å®Œæˆè·¯å¾„åŒè½¨æ¸…ç†ï¼Œåªä¿ç•™äº† canonical è·¯å¾„ï¼Œæ— éœ€å†åˆ é™¤è·¯ç”±

#### 3.3 app.js ä¸­çš„é¡µé¢é‡å®šå‘æ®‹ç•™

| è¡Œå· | å†…å®¹ | å¤„ç†æ–¹å¼ |
|------|------|----------|
| 524-581 | `PAGE_REDIRECT_MAP` æ—§é¡µé¢æ˜ å°„ | âŒ **åˆ é™¤æ•´æ®µ** |
| 583-600 | é‡å®šå‘ä¸­é—´ä»¶ `/admin` | âŒ **åˆ é™¤æ•´æ®µ** |

**è¯¦ç»†è¯´æ˜**:
```javascript
// å¾…åˆ é™¤ä»£ç ä½ç½®ï¼šapp.js ç¬¬524-600è¡Œ
// PAGE_REDIRECT_MAP å¯¹è±¡åŠç›¸å…³é‡å®šå‘ä¸­é—´ä»¶
// è¿™äº›æ˜¯æ—§çš„åˆ†æ•£é¡µé¢URLåˆ°æ–°æ•´åˆé¡µé¢çš„é‡å®šå‘é€»è¾‘
// é¡¹ç›®æœªä¸Šçº¿ï¼Œæ— éœ€ä¿ç•™URLå…¼å®¹æ€§
```

#### 3.4 è·¯ç”±å±‚å…¼å®¹ä»£ç 

| æ–‡ä»¶ | è¡Œå· | é—®é¢˜ | å¤„ç†æ–¹å¼ |
|------|------|------|----------|
| `routes/v4/lottery/campaigns.js` | ç¬¬158è¡Œ | "å…¼å®¹æ—§çš„ API è¿”å›ç»“æ„" æ³¨é‡Šå’Œé€»è¾‘ | âŒ **åˆ é™¤å…¼å®¹é€»è¾‘** |
| `routes/v4/console/shared/middleware.js` | ç¬¬74è¡Œ | "å…¼å®¹æ—§ä»£ç ï¼šæä¾› sharedComponents åˆ«å" | âŒ **åˆ é™¤åˆ«å** |

#### 3.5 é—ç•™æŠ½å¥–Strategy

| æ–‡ä»¶ | çŠ¶æ€ | å¤„ç†æ–¹å¼ |
|------|------|----------|
| `services/UnifiedLotteryEngine/strategies/ManagementStrategy.js` | ä»è¢«ç®¡ç†APIä½¿ç”¨ | âœ… **ä¿ç•™** |
| `services/UnifiedLotteryEngine/strategies/` ç›®å½•ä¸‹å…¶ä»–æ–‡ä»¶ | å¾…ç¡®è®¤ | â³ **æ£€æŸ¥å¼•ç”¨åå†³å®š** |

**ç¡®è®¤å‘½ä»¤**:
```bash
# æ£€æŸ¥ strategies ç›®å½•ä¸‹å„æ–‡ä»¶çš„å¼•ç”¨æƒ…å†µ
grep -rln "BasicGuaranteeStrategy" --include="*.js" .
grep -rln "from.*strategies" --include="*.js" .
```

---

### ã€è„šæœ¬å’Œä¸´æ—¶æ–‡ä»¶ã€‘

| æ–‡ä»¶ | é—®é¢˜ | å¤„ç†æ–¹å¼ |
|------|------|----------|
| `æ•°æ®åº“è¿ç§»è„šæœ¬.sql` | å¼•ç”¨å·²ä¸å­˜åœ¨çš„æ—§è¡¨ï¼ˆuser_prize_budgetã€lottery_recordsç­‰ï¼‰ | âŒ **åˆ é™¤æ–‡ä»¶** |
| `migrations/20251206_dual_account_system.sql` | SQLæ ¼å¼è¿ç§»ï¼Œå·²è¢«æ­£å¼Sequelizeè¿ç§»æ›¿ä»£ | âŒ **åˆ é™¤æ–‡ä»¶** |
| `scripts/migration/EXECUTE_TONIGHT.sh` | æ—§è¿ç§»æ‰§è¡Œè„šæœ¬ | âŒ **åˆ é™¤** |
| `scripts/migration/analyze-old-codes.sql` | æ—§åˆ†æè„šæœ¬ | âŒ **åˆ é™¤** |
| `test_material_api.sh` | ä¸´æ—¶æµ‹è¯•è„šæœ¬ | âŒ **åˆ é™¤** |
| `test-config-api-auth.sh` | ä¸´æ—¶æµ‹è¯•è„šæœ¬ | âŒ **åˆ é™¤** |
| `app.js.backup.20260108_125922` | å¤‡ä»½æ–‡ä»¶ | âŒ **åˆ é™¤** |
| `db_analyze.js` | ä¸´æ—¶åˆ†æè„šæœ¬ | â³ **ç¡®è®¤ååˆ é™¤** |
| `generate_api_business_content.py` | ä¸´æ—¶ç”Ÿæˆè„šæœ¬ | â³ **ç¡®è®¤ååˆ é™¤** |

---

### ã€è§„èŒƒå±‚é¢ã€‘

| æ–‡ä»¶ | è¡Œå· | é—®é¢˜ | å¤„ç†æ–¹å¼ |
|------|------|------|----------|
| `.cursor/rules/08-ç”Ÿäº§è´¨é‡ä¿è¯æ ‡å‡†.mdc` | ç¬¬453è¡Œ | å¼•ç”¨ `UserInventory` æ—§è¡¨ç¤ºä¾‹ | âŒ **æ›´æ–°ç¤ºä¾‹ä»£ç ** |
| `.cursor/rules/08-ç”Ÿäº§è´¨é‡ä¿è¯æ ‡å‡†.mdc` | ç¬¬442è¡Œ | `MIGRATION_CUTOFF_DATE` è¿ç§»åŒè½¨ç¤ºä¾‹ | âŒ **åˆ é™¤è¯¥ç¤ºä¾‹** |

**æ›´æ–°è¯´æ˜**:
- ç§»é™¤æ‰€æœ‰å¼•ç”¨å·²åˆ é™¤æ—§è¡¨çš„ç¤ºä¾‹ä»£ç 
- ç§»é™¤è¿ç§»åŒè½¨çš„ç¤ºä¾‹ï¼ˆå› ä¸ºé¡¹ç›®é‡‡ç”¨æš´åŠ›é‡æ„ç­–ç•¥ï¼Œä¸ä¿ç•™è¿ç§»åŒè½¨ï¼‰

---

## å››ã€æ•°æ®åº“å±‚é¢æ¸…ç†å»ºè®®

### 4.1 æ•°æ®åº“è¡¨çŠ¶æ€

| è¡¨å | å½“å‰çŠ¶æ€ | å»ºè®®åŠ¨ä½œ |
|------|----------|----------|
| `trade_records` | `is_legacy=1`ï¼Œåªè¯» | âœ… ä¿ç•™ä¸ºå†å²å½’æ¡£ï¼Œä¸åˆ é™¤ |
| `user_points_accounts` | å·²æ ‡è®°åºŸå¼ƒ | â³ ç¡®è®¤ä¸å­˜åœ¨åæ— éœ€æ“ä½œ |
| `points_transactions` | å·²è¢« `asset_transactions` æ›¿ä»£ | â³ ç¡®è®¤ä¸å­˜åœ¨åæ— éœ€æ“ä½œ |
| `user_inventory` | å·²è¢« `item_instances` + `redemption_orders` æ›¿ä»£ | â³ ç¡®è®¤ä¸å­˜åœ¨åæ— éœ€æ“ä½œ |

### 4.2 éœ€ç¡®è®¤çš„æ½œåœ¨æ—§è¡¨

æ‰§è¡Œä»¥ä¸‹SQLæ£€æŸ¥æ—§è¡¨æ˜¯å¦å­˜åœ¨ï¼š

```sql
-- æ£€æŸ¥è¿™äº›æ—§è¡¨æ˜¯å¦å­˜åœ¨ï¼ˆå¦‚å­˜åœ¨ä¸”æ— å¼•ç”¨åˆ™åˆ é™¤ï¼‰
SHOW TABLES LIKE 'user_prize_budget';
SHOW TABLES LIKE 'user_wallet';
SHOW TABLES LIKE 'lottery_records';
SHOW TABLES LIKE 'prize_records';
SHOW TABLES LIKE 'user_inventory';
SHOW TABLES LIKE 'points_transactions';
SHOW TABLES LIKE 'user_points_accounts';
```

**å¤„ç†åŸåˆ™**:
- å¦‚æœè¡¨å­˜åœ¨ä½†ä»£ç ä¸­æ— å¼•ç”¨ â†’ åˆ›å»ºè¿ç§»åˆ é™¤è¡¨
- å¦‚æœè¡¨å­˜åœ¨ä¸”ä»æœ‰å¼•ç”¨ â†’ åˆ†æå¼•ç”¨æ¥æºï¼Œå†³å®šæ˜¯å¦éœ€è¦æ¸…ç†å¼•ç”¨ä»£ç 

### 4.3 V1äºŒç»´ç é—ç•™å­—æ®µ

| ä½ç½® | é—®é¢˜ | å¤„ç†æ–¹å¼ |
|------|------|----------|
| `consumption_records` è¡¨ | `qr_code_version`ã€`is_legacy_v1` å­—æ®µ | âŒ **åˆ›å»ºè¿ç§»åˆ é™¤å­—æ®µ** |
| `migrations/20260112190000-mark-v1-qrcode-as-legacy.js` | V1æ ‡è®°è¿ç§»ï¼ˆå·²æ‰§è¡Œå®Œæ¯•ï¼‰ | â³ **å½’æ¡£åˆ° archive/ æˆ–åˆ é™¤** |

**å¾…åˆ›å»ºçš„æ¸…ç†è¿ç§»**:
```javascript
// migrations/YYYYMMDDHHMMSS-remove-v1-qrcode-legacy-fields.js
module.exports = {
  async up(queryInterface, Sequelize) {
    await queryInterface.removeColumn('consumption_records', 'qr_code_version');
    await queryInterface.removeColumn('consumption_records', 'is_legacy_v1');
  },
  async down(queryInterface, Sequelize) {
    // å›æ»šé€»è¾‘ï¼ˆå¦‚éœ€è¦ï¼‰
  }
};
```

---

## äº”ã€åŠŸèƒ½åˆå¹¶æ”¶ç¼©å»ºè®®

### 5.1 å¯åˆå¹¶çš„APIè·¯ç”±

| åˆå¹¶å»ºè®® | å½“å‰è·¯ç”± | åˆå¹¶å |
|----------|----------|--------|
| **èµ„äº§è°ƒæ•´ç»Ÿä¸€** | `/console/asset-adjustment/`, `/console/material/*/adjust`, `/console/diamond-accounts/adjust` | ç»Ÿä¸€åˆ° `/console/asset-adjustment/adjust` |
| **æŠ½å¥–ç›‘æ§ç»Ÿä¸€** | `/console/lottery-monitoring/`, `/console/lottery-strategy-stats/` | ç»Ÿä¸€åˆ° `/console/lottery-analytics/` |

### 5.2 è¿ç§»æ–‡ä»¶å½’æ¡£

**ç°çŠ¶**: `migrations/` ç›®å½•æœ‰ 130+ ä¸ªè¿ç§»æ–‡ä»¶

**å»ºè®®æ–¹æ¡ˆ**:
1. ä»å½“å‰ç”Ÿäº§æ•°æ®åº“å¯¼å‡ºå®Œæ•´ schema ä½œä¸ºæ–° baseline
2. åˆ›å»º `migrations/archive/` ç›®å½•
3. å°†å†å²è¿ç§»æ–‡ä»¶ç§»åŠ¨åˆ° archive ç›®å½•
4. ä¿ç•™æœ€è¿‘çš„è¿ç§»æ–‡ä»¶ç”¨äºå¼€å‘å‚è€ƒ

**æ“ä½œå‘½ä»¤**:
```bash
# åˆ›å»ºå½’æ¡£ç›®å½•
mkdir -p migrations/archive

# ç§»åŠ¨2026å¹´1æœˆä¹‹å‰çš„è¿ç§»åˆ°å½’æ¡£ï¼ˆç¤ºä¾‹ï¼‰
mv migrations/2025*.js migrations/archive/
```

**é¢„æœŸæ”¶ç›Š**:
- é™ä½å¼€å‘æ—¶çš„å¿ƒæ™ºè´Ÿæ‹…
- åŠ å¿« `npx sequelize-cli db:migrate:status` æ‰§è¡Œé€Ÿåº¦
- ä¿æŒè¿ç§»ç›®å½•æ•´æ´

### 5.3 å¤‡ä»½ç›®å½•æ¸…ç†

| ç›®å½• | å¤„ç†æ–¹å¼ |
|------|----------|
| `backups/` | æ£€æŸ¥å¹¶æ¸…ç†è¿‡æœŸå¤‡ä»½ï¼Œä¿ç•™æœ€è¿‘3ä¸ªç‰ˆæœ¬ |

---

## å…­ã€å®æ–½æ£€æŸ¥æ¸…å•

### Phase 0ï¼šå®‰å…¨ç›¸å…³æ¸…ç†ï¼ˆP0 ä¼˜å…ˆçº§ï¼‰

å®‰å…¨ç›¸å…³çš„å…¼å®¹ä»£ç ï¼Œå¿…é¡»ä¼˜å…ˆå¤„ç†ï¼š

- [ ] **ã€P0ã€‘** `middleware/sensitiveOperation.js` ç¬¬60-73è¡Œ - åˆ é™¤æ—§Tokenå…¼å®¹ï¼Œç»Ÿä¸€ä¸¥æ ¼æ¨¡å¼

### Phase 1ï¼šæ¸…ç†å†å²æ³¨é‡Šï¼ˆä½é£é™©ï¼‰

çº¯æ–‡æœ¬ä¿®æ”¹ï¼Œæ— åŠŸèƒ½å½±å“ï¼š

- [ ] æ¸…ç† `services/index.js` ç¬¬17è¡Œæ³¨é‡Š
- [ ] æ¸…ç† `services/IdempotencyService.js` ç¬¬78-79, 614-615, 796-797è¡Œæ³¨é‡Š
- [ ] æ¸…ç† `routes/v4/shop/exchange/exchange.js` ç¬¬23, 29, 57, 114è¡Œæ³¨é‡Š
- [ ] æ¸…ç† `services/ConsumptionService.js` ç¬¬280, 376è¡Œæ³¨é‡Š
- [ ] æ¸…ç† `services/UserRoleService.js` è¿ç§»ç›¸å…³æ³¨é‡Š
- [ ] æ¸…ç† `services/ChatWebSocketService.js` ç¬¬174è¡Œæ³¨é‡Š
- [ ] æ¸…ç† `services/ImageService.js` ç¬¬476, 480è¡Œæ³¨é‡Š
- [ ] æ¸…ç† `services/DataSanitizer.js` ç¬¬64è¡Œæ³¨é‡Š
- [ ] æ¸…ç† `models/index.js` ç¬¬17è¡Œæ³¨é‡Š

### Phase 2ï¼šéªŒè¯åºŸå¼ƒè¡¨ï¼ˆéœ€éªŒè¯ï¼‰

ä»…ç¡®è®¤ï¼Œä¸åˆ é™¤ï¼š

- [ ] æ‰§è¡Œ SQL æ£€æŸ¥æ—§è¡¨æ˜¯å¦å­˜åœ¨
- [ ] ç¡®è®¤ `trade_records` ä¿æŒåªè¯»å½’æ¡£çŠ¶æ€
- [ ] è®°å½•æ£€æŸ¥ç»“æœ

### Phase 3ï¼šä»£ç æ¸…ç†ï¼ˆä¸­é£é™©ï¼‰

**æœåŠ¡å±‚æ¸…ç†**:
- [ ] `services/PrizePoolService.js` ç¬¬141-153è¡Œ - åˆ é™¤å­—æ®µå…¼å®¹é€»è¾‘ï¼ˆ`value_points`, `budget_cost_points`, `probability`ï¼‰

**è·¯ç”±å±‚æ¸…ç†**:
- [ ] åˆ é™¤ `app.js` ç¬¬524-600è¡Œï¼ˆ`PAGE_REDIRECT_MAP` + é‡å®šå‘ä¸­é—´ä»¶ï¼‰
- [ ] åˆ é™¤ `routes/v4/lottery/campaigns.js` å…¼å®¹é€»è¾‘ï¼ˆç¬¬158è¡Œé™„è¿‘ï¼‰
- [ ] åˆ é™¤ `routes/v4/console/shared/middleware.js` å…¼å®¹åˆ«åï¼ˆç¬¬74è¡Œé™„è¿‘ï¼‰
- [ ] åˆ é™¤ `routes/v4/console/marketplace.js` ç¬¬40-62è¡Œè·¯å¾„æ˜ å°„ä¸­é—´ä»¶
- [ ] åˆ é™¤ `routes/v4/shop/audit/index.js` ç¬¬122-128è¡Œ, 180-186è¡Œå“åº”å­—æ®µåˆ«å

**å¼•æ“å±‚æ¸…ç†**:
- [ ] ç¡®è®¤å¹¶æ¸…ç† `services/UnifiedLotteryEngine/strategies/` é—ç•™æ–‡ä»¶

### Phase 4ï¼šè„šæœ¬å’Œæ–‡ä»¶æ¸…ç†

- [ ] åˆ é™¤ `æ•°æ®åº“è¿ç§»è„šæœ¬.sql`
- [ ] åˆ é™¤ `migrations/20251206_dual_account_system.sql`
- [ ] åˆ é™¤ `scripts/migration/EXECUTE_TONIGHT.sh`
- [ ] åˆ é™¤ `scripts/migration/analyze-old-codes.sql`
- [ ] åˆ é™¤ `test_material_api.sh`
- [ ] åˆ é™¤ `test-config-api-auth.sh`
- [ ] åˆ é™¤ `app.js.backup.*`
- [ ] è¯„ä¼°åˆ é™¤ `db_analyze.js`
- [ ] è¯„ä¼°åˆ é™¤ `generate_api_business_content.py`

### Phase 5ï¼šæ•°æ®åº“æ¸…ç†

- [ ] åˆ›å»ºè¿ç§»åˆ é™¤ `consumption_records` è¡¨çš„ V1 ç›¸å…³å­—æ®µ
- [ ] æ£€æŸ¥å¹¶åˆ é™¤æ•°æ®åº“ä¸­çš„æ—§è¡¨ï¼ˆæ‰§è¡Œ 4.2 èŠ‚SQLï¼‰

### Phase 6ï¼šè§„èŒƒæ›´æ–°

- [ ] æ›´æ–° `.cursor/rules/08-ç”Ÿäº§è´¨é‡ä¿è¯æ ‡å‡†.mdc` ç§»é™¤æ—§è¡¨å¼•ç”¨
- [ ] æ›´æ–° `.cursor/rules/08-ç”Ÿäº§è´¨é‡ä¿è¯æ ‡å‡†.mdc` ç§»é™¤è¿ç§»åŒè½¨ç¤ºä¾‹
- [ ] å…¨å±€æœç´¢ç¡®è®¤æ— å…¶ä»–æ–‡æ¡£å¼•ç”¨å·²åˆ é™¤çš„è¡¨/æ¥å£

### Phase 7ï¼šéªŒè¯ä¸æµ‹è¯•

- [ ] è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶ `npm test`
- [ ] éªŒè¯æ‰€æœ‰ API ç«¯ç‚¹æ­£å¸¸å·¥ä½œ
- [ ] æ£€æŸ¥æ•°æ®åº“è¿ç§»çŠ¶æ€ `npx sequelize-cli db:migrate:status`

### Phase 8ï¼ˆå¯é€‰ï¼‰ï¼šAPIè·¯ç”±åˆå¹¶

éœ€è¦å‰åç«¯é…åˆæ—¶å†æ‰§è¡Œï¼š

- [ ] èµ„äº§è°ƒæ•´è·¯ç”±ç»Ÿä¸€
- [ ] æŠ½å¥–ç›‘æ§è·¯ç”±ç»Ÿä¸€

---

## ä¸ƒã€é£é™©è¯„ä¼°ä¸å›æ»šæ–¹æ¡ˆ

### 7.1 é£é™©è¯„ä¼°

| é£é™©é¡¹ | é£é™©ç­‰çº§ | ç¼“è§£æªæ–½ |
|--------|----------|----------|
| åˆ é™¤ä»£ç å¯¼è‡´åŠŸèƒ½å¼‚å¸¸ | ä¸­ | æ¯æ¬¡åˆ é™¤åç«‹å³è¿è¡Œæµ‹è¯• |
| æ•°æ®åº“è¿ç§»å¤±è´¥ | ä½ | å¤‡ä»½æ•°æ®åº“åå†æ‰§è¡Œè¿ç§» |
| é—æ¼å¼•ç”¨å¯¼è‡´è¿è¡Œæ—¶é”™è¯¯ | ä¸­ | ä½¿ç”¨ grep å…¨å±€æœç´¢ç¡®è®¤æ— å¼•ç”¨ |

### 7.2 å›æ»šæ–¹æ¡ˆ

1. **ä»£ç å›æ»š**: ä½¿ç”¨ Git å›æ»šåˆ°æ¸…ç†å‰çš„ commit
   ```bash
   git revert <cleanup-commit-hash>
   ```

2. **æ•°æ®åº“å›æ»š**: ä½¿ç”¨ Sequelize å›æ»šè¿ç§»
   ```bash
   npx sequelize-cli db:migrate:undo
   ```

3. **å®Œæ•´å›æ»š**: ä»å¤‡ä»½æ¢å¤
   ```bash
   # æ¢å¤æ•°æ®åº“å¤‡ä»½
   mysql -u root -p database_name < backups/pre-cleanup-backup.sql
   ```

---

## å…«ã€é¢„æœŸæ”¶ç›Š

### 8.1 é‡åŒ–æ”¶ç›Š

| æŒ‡æ ‡ | æ¸…ç†å‰ | æ¸…ç†å | æ”¹å–„å¹…åº¦ |
|------|--------|--------|----------|
| ä»£ç è¡Œæ•°ï¼ˆé¢„ä¼°ï¼‰ | - | -500è¡Œ | å‡å°‘å†—ä½™ä»£ç  |
| è¿ç§»æ–‡ä»¶æ•°é‡ | 130+ | 20-30 | å‡å°‘ 80% |
| ä¸´æ—¶è„šæœ¬æ–‡ä»¶ | 10+ | 0 | 100% æ¸…ç† |
| æ—§è¡¨/å­—æ®µ | è‹¥å¹² | 0 | 100% æ¸…ç† |

### 8.2 è´¨åŒ–æ”¶ç›Š

- âœ… **é™ä½ç»´æŠ¤å¤æ‚åº¦**: æ— éœ€ç»´æŠ¤å…¼å®¹å±‚ä»£ç 
- âœ… **å‡å°‘è®¤çŸ¥è´Ÿæ‹…**: å¼€å‘è€…æ— éœ€ç†è§£æ–°æ—§ä¸¤å¥—æ–¹æ¡ˆ
- âœ… **æé«˜ä»£ç è´¨é‡**: ç»Ÿä¸€æŠ€æœ¯æ ˆï¼Œä»£ç æ›´åŠ ä¸€è‡´
- âœ… **é™ä½Bugé£é™©**: å‡å°‘å› å…¼å®¹é€»è¾‘å¯¼è‡´çš„è¾¹ç•Œé—®é¢˜
- âœ… **æ–‡æ¡£å¯¹é½**: æ–‡æ¡£ä¸ä»£ç å®Œå…¨ä¸€è‡´ï¼Œæ— è¿‡æ—¶å†…å®¹

---

## ä¹ã€åç«¯é‡æ„æ–¹æ¡ˆï¼ˆçº¯åç«¯ç²¾ç®€ç‰ˆï¼‰

> æœ¬èŠ‚ä¸ºé‡æ„æ–¹æ¡ˆçš„ç²¾ç®€æ‰§è¡Œæ‘˜è¦ï¼Œé€‚åˆå¿«é€Ÿæ‰§è¡Œå‚è€ƒã€‚

### ä¸€ã€ä¸šåŠ¡åŒè½¨ï¼ˆä¿ç•™ï¼‰

| åŒè½¨ | æ–‡ä»¶ | ä¿ç•™ç†ç”± |
|------|------|----------|
| **èƒŒåŒ…ï¼šassets + items** | `services/BackpackService.js` | å¯å åŠ  vs å®ä¾‹åŒ–èµ„äº§ |
| **è´¦æˆ·ï¼šuser + system** | `services/AssetService.js` | æ ‡å‡†è´¦åŠ¡æ¶æ„ |
| **å®¡æ ¸ + å®¡è®¡** | `ContentReviewRecord` + `AdminOperationLog` | ä¸åŒä¸šåŠ¡è¯­ä¹‰ |
| **å†³ç­–æ¥æºä¸‰è½¨** | `UnifiedLotteryEngine` | preset/override/normal ä¼˜å…ˆçº§æœºåˆ¶ |
| **æŠ½å¥–ä¿åº•æœºåˆ¶** | `TierPickStage.js` | high â†’ mid â†’ low â†’ fallback é™çº§è·¯å¾„ |
| **ä¸´æ—¶è¡¥å¿æ¬¡æ•°** | `LotteryUserDailyDrawQuota` | bonus_draw_count å®¢æœåŠŸèƒ½ |

---

### äºŒã€æ¸…ç†é¡¹

#### ğŸ”´ 2.0 P0 å®‰å…¨ç›¸å…³ï¼ˆä¼˜å…ˆæ‰§è¡Œï¼‰

| æ–‡ä»¶ | æ¸…ç†å†…å®¹ |
|------|----------|
| `middleware/sensitiveOperation.js` | L60-73 åˆ é™¤æ—§Tokenå…¼å®¹ï¼Œç»Ÿä¸€ä¸¥æ ¼æ¨¡å¼ |

#### ğŸ—‘ï¸ 2.1 æ ¹ç›®å½•æ®‹ç•™

```bash
rm -f app.js.backup.20260108_125922
rm -f æ•°æ®åº“è¿ç§»è„šæœ¬.sql
rm -f test_material_api.sh test-config-api-auth.sh
rm -rf backups/
```

#### ğŸ—‘ï¸ 2.2 æœåŠ¡å±‚å­—æ®µå…¼å®¹

| æ–‡ä»¶ | æ¸…ç†å†…å®¹ |
|------|----------|
| `services/PrizePoolService.js` | L141-153 åˆ é™¤ `value_points`ã€`budget_cost_points`ã€`probability` å…¼å®¹ |

#### ğŸ—‘ï¸ 2.3 è·¯ç”±å±‚å…¼å®¹ä»£ç 

| æ–‡ä»¶ | æ¸…ç†å†…å®¹ |
|------|----------|
| `routes/v4/console/marketplace.js` | L40-62 åˆ é™¤è·¯å¾„æ˜ å°„ä¸­é—´ä»¶ |
| `routes/v4/shop/audit/index.js` | L122-128, L180-186 åˆ é™¤å“åº”å­—æ®µåˆ«å |
| `routes/v4/lottery/campaigns.js` | L158 åˆ é™¤å®šä»·é…ç½®æ ¼å¼å…¼å®¹ |
| `routes/v4/console/shared/middleware.js` | L74 åˆ é™¤ `sharedComponents` åˆ«å |

#### ğŸ—‘ï¸ 2.4 è¿‡æ—¶æ³¨é‡Šæ¸…ç†

| æ–‡ä»¶ | æ¸…ç†å†…å®¹ |
|------|----------|
| `services/index.js` | L18/L128 è¿‡æ—¶æ³¨é‡Š |
| `services/IdempotencyService.js` | L78-79, L614-615, L796-797 å†³ç­–æ³¨é‡Š |
| `services/ConsumptionService.js` | L280, L376 æ¶æ„å†³ç­–æ³¨é‡Š |
| `services/ChatWebSocketService.js` | L174 `is_admin å…¼å®¹` æ³¨é‡Š |
| `scripts/maintenance/scheduled_tasks.js` | L34/L50 ç§»é™¤è¯´æ˜ |
| `scripts/verify-doc-decisions.js` | æ—§è¡¨æ£€æŸ¥é€»è¾‘ï¼ˆæ•´ä¸ªè„šæœ¬å¯åˆ ï¼‰ |

#### ğŸ—‘ï¸ 2.5 æ•°æ®åº“éªŒè¯

```sql
-- ç¡®è®¤æ—  PascalCase æ®‹ç•™
SELECT target_type FROM admin_operation_logs WHERE target_type REGEXP '^[A-Z]' LIMIT 5;

-- ç¡®è®¤æ—§è¡¨ä¸å­˜åœ¨
SHOW TABLES LIKE 'user_inventory';
SHOW TABLES LIKE 'points_transactions';
SHOW TABLES LIKE 'user_points_accounts';
```

---

### ä¸‰ã€åˆå¹¶æ”¶ç¼©

#### 3.1 è·¯ç”±åˆå¹¶

| ä» | åˆ° |
|----|----|
| `/api/v4/merchant-points` | `/api/v4/shop/consumption` |
| `/api/v4/activities` | `/api/v4/lottery/campaigns` |
| `/api/v4/debug-control` | `/api/v4/system/debug` |

#### 3.2 é…ç½®åˆå¹¶

- `config/marketplace.config.js` â†’ åˆå¹¶å…¥ `config/business.config.js`
- `config/segment_rules.js` â†’ åˆå¹¶å…¥ `config/business.config.js`

---

### å››ã€è§„èŒƒå¯¹é½

æ›´æ–° `.cursor/rules/01-æ ¸å¿ƒå¼€å‘è´¨é‡æ ‡å‡†.mdc`ï¼š
- `/api/v2/*` ç¤ºä¾‹ â†’ `/api/v4/*`

---

### æ‰§è¡Œæ€»ç»“

| ç±»åˆ« | æ•°é‡ |
|------|------|
| P0 å®‰å…¨ä¿®å¤ | 1 å¤„ï¼ˆæ•æ„Ÿæ“ä½œä¸­é—´ä»¶ï¼‰ |
| åˆ é™¤æ®‹ç•™æ–‡ä»¶ | 5-10 ä¸ª |
| æœåŠ¡å±‚å­—æ®µå…¼å®¹ | 1 å¤„ï¼ˆPrizePoolServiceï¼‰ |
| è·¯ç”±å±‚å…¼å®¹ä»£ç  | 4 å¤„ |
| æ¸…ç†è¿‡æ—¶æ³¨é‡Š | ~50 è¡Œ |
| åˆå¹¶è·¯ç”±åŸŸ | 3 ä¸ª |
| åˆå¹¶é…ç½®æ–‡ä»¶ | 2 ä¸ª |

---

## é™„å½•

### A. å…¨å±€æœç´¢å‘½ä»¤å‚è€ƒ

```bash
# æœç´¢æ—§è¡¨å¼•ç”¨
grep -rln "user_prize_budget\|user_wallet\|lottery_records\|user_inventory" --include="*.js" .

# æœç´¢å…¼å®¹ç›¸å…³æ³¨é‡Š
grep -rln "å…¼å®¹\|deprecated\|legacy\|æ—§" --include="*.js" .

# æœç´¢ PointsService å¼•ç”¨
grep -rln "PointsService" --include="*.js" .

# æœç´¢ UserPermissionModule å¼•ç”¨
grep -rln "UserPermissionModule" --include="*.js" .

# æœç´¢æ—§å­—æ®µå…¼å®¹ï¼ˆæœåŠ¡å±‚ï¼‰
grep -rln "value_points\|budget_cost_points\|probability" --include="*.js" services/

# æœç´¢ sharedComponents ä½¿ç”¨æƒ…å†µ
grep -rln "sharedComponents" --include="*.js" routes/

# æœç´¢æ•æ„Ÿæ“ä½œä¸­é—´ä»¶ä½¿ç”¨
grep -rln "requireValidSession\|requireValidSessionStrict" --include="*.js" routes/

# æœç´¢è·¯å¾„æ˜ å°„é€»è¾‘
grep -rln "pathMappings\|pathMapping" --include="*.js" routes/
```

### B. ç›¸å…³æ–‡æ¡£

- `.cursor/rules/08-ç”Ÿäº§è´¨é‡ä¿è¯æ ‡å‡†.mdc` - ç”Ÿäº§è´¨é‡ä¿è¯æ ‡å‡†

---

## é™„å½• Cï¼šé¡¹ç›®ç»“æ„æ¦‚è§ˆ

### è·¯ç”±ç»“æ„ (`/routes/v4/`)

```
routes/v4/
â”œâ”€â”€ auth/           # è®¤è¯ç›¸å…³ (ç™»å½•ã€æ³¨å†Œã€Token)
â”œâ”€â”€ console/        # ç®¡ç†åå°
â”‚   â”œâ”€â”€ asset-adjustment/   # èµ„äº§è°ƒæ•´
â”‚   â”œâ”€â”€ lottery-monitoring/ # æŠ½å¥–ç›‘æ§
â”‚   â”œâ”€â”€ marketplace/        # å¸‚åœºç®¡ç†
â”‚   â”œâ”€â”€ shared/             # å…±äº«ç»„ä»¶
â”‚   â””â”€â”€ ...
â”œâ”€â”€ lottery/        # æŠ½å¥–ç³»ç»Ÿ
â”œâ”€â”€ market/         # å¸‚åœºäº¤æ˜“
â”œâ”€â”€ shop/           # å•†æˆ·åŠŸèƒ½
â”‚   â”œâ”€â”€ audit/      # å®¡è®¡æ—¥å¿—
â”‚   â”œâ”€â”€ consumption/# æ¶ˆè´¹ç§¯åˆ†
â”‚   â””â”€â”€ exchange/   # å…‘æ¢åŠŸèƒ½
â”œâ”€â”€ system/         # ç³»ç»Ÿç®¡ç†
â”œâ”€â”€ user/           # ç”¨æˆ·ç›¸å…³
â”œâ”€â”€ assets/         # èµ„äº§ç®¡ç†
â”œâ”€â”€ backpack/       # èƒŒåŒ…ç³»ç»Ÿ
â”œâ”€â”€ merchant-points/# å•†æˆ·ç§¯åˆ†
â”œâ”€â”€ activities/     # æ´»åŠ¨ç®¡ç†
â””â”€â”€ debug-control/  # è°ƒè¯•æ§åˆ¶
```

### æœåŠ¡å±‚ç»“æ„ (`/services/`)

```
services/
â”œâ”€â”€ AssetService.js           # èµ„äº§ç®¡ç†æ ¸å¿ƒæœåŠ¡
â”œâ”€â”€ BackpackService.js        # èƒŒåŒ…åŒè½¨æ¶æ„
â”œâ”€â”€ ConsumptionService.js     # æ¶ˆè´¹ç§¯åˆ†æœåŠ¡
â”œâ”€â”€ IdempotencyService.js     # å¹‚ç­‰æ€§æ§åˆ¶
â”œâ”€â”€ ImageService.js           # å›¾ç‰‡ç®¡ç†
â”œâ”€â”€ LotteryAnalyticsService.js# æŠ½å¥–ç»Ÿè®¡åˆ†æ
â”œâ”€â”€ PrizePoolService.js       # å¥–æ± ç®¡ç†
â”œâ”€â”€ UserRoleService.js        # ç”¨æˆ·è§’è‰²ç®¡ç†
â”œâ”€â”€ ChatWebSocketService.js   # WebSocketèŠå¤©
â”œâ”€â”€ UnifiedLotteryEngine/     # ç»Ÿä¸€æŠ½å¥–å¼•æ“ V4.6
â”‚   â”œâ”€â”€ stages/               # Pipeline é˜¶æ®µ
â”‚   â”‚   â”œâ”€â”€ ValidationStage.js
â”‚   â”‚   â”œâ”€â”€ TierPickStage.js
â”‚   â”‚   â”œâ”€â”€ SettlementStage.js
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ strategies/           # æŠ½å¥–ç­–ç•¥
â””â”€â”€ index.js                  # æœåŠ¡èšåˆå¯¼å‡º
```

### æ¨¡å‹å±‚ç»“æ„ (`/models/`)

```
models/
â”œâ”€â”€ User.js                   # ç”¨æˆ·æ¨¡å‹
â”œâ”€â”€ Role.js                   # è§’è‰²æ¨¡å‹
â”œâ”€â”€ UserRole.js               # ç”¨æˆ·è§’è‰²å…³è”
â”œâ”€â”€ Account.js                # è´¦æˆ·æ¨¡å‹ï¼ˆåŒè½¨ï¼šuser/systemï¼‰
â”œâ”€â”€ AccountAssetBalance.js    # è´¦æˆ·èµ„äº§ä½™é¢
â”œâ”€â”€ AssetTransaction.js       # èµ„äº§äº¤æ˜“æµæ°´
â”œâ”€â”€ ItemInstance.js           # ç‰©å“å®ä¾‹
â”œâ”€â”€ ItemTemplate.js           # ç‰©å“æ¨¡æ¿
â”œâ”€â”€ RedemptionOrder.js        # æ ¸é”€è®¢å•
â”œâ”€â”€ LotteryCampaign.js        # æŠ½å¥–æ´»åŠ¨
â”œâ”€â”€ LotteryPrize.js           # å¥–å“é…ç½®
â”œâ”€â”€ LotteryDraw.js            # æŠ½å¥–è®°å½•
â”œâ”€â”€ FeatureFlag.js            # åŠŸèƒ½å¼€å…³
â””â”€â”€ index.js                  # æ¨¡å‹èšåˆ + å…³è”å®šä¹‰
```

---

**æ–‡æ¡£ç»´æŠ¤è€…**: AI Assistant  
**æœ€åæ›´æ–°**: 2026-01-24 20:30  
**çŠ¶æ€**: å¾…æ‰§è¡Œ  
**ç‰ˆæœ¬è¯´æ˜**: 
- V1.0 - åˆå§‹ç‰ˆæœ¬ï¼Œæ–°å¢ç¬¬é›¶ç« "é¡¹ç›®ç°çŠ¶æ€»ç»“"ï¼ˆåŸºäºå®é™…æ•°æ®åº“æ•°æ®ï¼‰ï¼Œæ–°å¢é™„å½•Cé¡¹ç›®ç»“æ„æ¦‚è§ˆ
- V1.1 - æ–°å¢ç¬¬0.5ç« "å®é™…éªŒè¯ç»“æœ"ï¼Œè®°å½•é€šè¿‡Node.jsè„šæœ¬è¿æ¥çœŸå®æ•°æ®åº“çš„éªŒè¯ç»“è®º
