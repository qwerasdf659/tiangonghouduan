# 10 ç­–ç•¥æ´»åŠ¨çº§å¼€å…³â€”â€”éœ€æ±‚æ–¹æ¡ˆ

> éœ€æ±‚ç›®æ ‡ï¼šé™¤å®šä»·å’ŒåŠ¨æ€é…ç½®å¤–çš„ 10 ä¸ªå¯å…³é—­ç­–ç•¥ï¼Œå…¨éƒ¨æ”¯æŒæ´»åŠ¨çº§åˆ«ç‹¬ç«‹é…ç½®ï¼Œä¸åŒæ´»åŠ¨å¯é€‰æ‹©ä¸åŒçš„ç­–ç•¥ç»„åˆã€‚
> åŸºå‡†æ—¥æœŸï¼š2026-02-23
> æ•°æ®æ¥æºï¼šNode.js ç›´è¿ restaurant_points_dev æ•°æ®åº“ + ä»£ç é€æ–‡ä»¶è¿½è¸ª
> **å®æ–½çŠ¶æ€ï¼šâœ… å·²å…¨éƒ¨å®Œæˆï¼ˆ2026-02-23 åç«¯+è¿ç§»+å‰ç«¯ï¼Œ2026-02-23 F2ç®¡ç†å¹²é¢„æ´»åŠ¨çº§ä¿®å¤ï¼Œ2026-02-23 è·¯ç”±æ¶æ„åˆè§„ä¿®å¤ï¼‰**
>
> å†³ç­–è£å®šç»“æœï¼š
> - å†³ç­– 4ï¼ˆ4 æ¡ active force_winï¼‰ï¼šæ–¹æ¡ˆ Cï¼ˆå…¨éƒ¨ cancelï¼‰ âœ… å·²æ‰§è¡Œ
> - å†³ç­– 5ï¼ˆ6 ä¸ª dead code æ–¹æ³•ï¼‰ï¼šæ–¹æ¡ˆ Bï¼ˆç›´æ¥åˆ é™¤ï¼Œçº¦ 350 è¡Œï¼‰ âœ… å·²æ‰§è¡Œ
>
> **ä»£ç å®¡æŸ¥éªŒè¯ç»“æœï¼ˆ2026-02-23 é€é¡¹å®æŸ¥ + æ¶æ„åˆè§„ä¿®å¤ï¼‰**ï¼š
> - B1-B9 å…¨éƒ¨å®Œæˆï¼ˆä»£ç çº§éªŒè¯é€šè¿‡ï¼‰
> - P1-P7 åç«¯é˜¶æ®µå…¨éƒ¨å®Œæˆï¼ˆAPI ç«¯ç‚¹å®æµ‹ GET/PUT æ­£ç¡®è¿”å›ï¼‰
> - P7 è·¯ç”±æ¶æ„åˆè§„ä¿®å¤ï¼šGET/PUT strategy-config è·¯ç”±å·²ä»ç›´æ¥ require models é‡æ„ä¸ºé€šè¿‡ ServiceManager è°ƒç”¨ QueryService/CRUDServiceï¼ˆè¯»æ“ä½œæ”¶å£åˆ° QueryServiceï¼Œå†™æ“ä½œæ”¶å£åˆ° CRUDService + äº‹åŠ¡ï¼‰
> - P8 å‰ç«¯é¡µé¢å·²åŒ…å«ç­–ç•¥å¼€å…³ Tabï¼ˆlottery-management.html çš„ activity-strategy-switch é¡µï¼Œå«7ä¸ªç­–ç•¥å¼€å…³ + ç°åº¦ç™¾åˆ†æ¯”é…ç½®ï¼‰
> - F2 ç®¡ç†å¹²é¢„æ´»åŠ¨çº§ä¿®å¤å®Œæˆï¼ˆforce-win/force-lose æ”¯æŒ lottery_campaign_idï¼Œå‰ç«¯è¡¨å•å«æ´»åŠ¨é€‰æ‹©å™¨ï¼‰
> - æ•°æ®è¿ç§»å·²æ‰§è¡Œï¼ˆlottery_management_settings.lottery_campaign_id åˆ—å­˜åœ¨ï¼Œmanagement/grayscale é…ç½®4ä¸ªæ´»åŠ¨å„5æ¡ï¼‰
> - éªŒæ”¶æ ‡å‡† 1-8 å…¨éƒ¨é€šè¿‡ï¼ˆæ´»åŠ¨éš”ç¦»ã€ç‹¬ç«‹æ§åˆ¶ã€è·¨æ´»åŠ¨ä¸è¦†ç›–ã€ç¼“å­˜éš”ç¦»å‡éªŒè¯é€šè¿‡ï¼‰
> - ESLint 0 é”™è¯¯ + Jest 483 æµ‹è¯•å…¨é€šè¿‡ + Health Check SYSTEM_HEALTHY
>
> **æ•°æ®åº“å®é™…çŠ¶æ€ï¼ˆ2026-02-23 éªŒè¯ï¼‰**ï¼š
> - lottery_management_settings: lottery_campaign_id åˆ—å·²å­˜åœ¨ï¼Œ3 æ¡ active è®°å½•
> - lottery_strategy_config: æ´»åŠ¨1=24æ¡, æ´»åŠ¨25=24æ¡, æ´»åŠ¨26=26æ¡, æ´»åŠ¨27=24æ¡
> - management.enabled: 4ä¸ªæ´»åŠ¨å‡æœ‰ï¼ˆå…¨éƒ¨trueï¼‰
> - grayscale: 4ä¸ªæ´»åŠ¨å„4æ¡ç™¾åˆ†æ¯”é…ç½®ï¼ˆå…¨éƒ¨100%ï¼‰
> - pressure config_group: å…¨éƒ¨ç»Ÿä¸€ä¸º pressure_tierï¼ˆå·²æ—  pressure ä¸ä¸€è‡´é—®é¢˜ï¼‰
>
> **å¾®ä¿¡å°ç¨‹åºå¯¹æ¥è¯´æ˜**ï¼šæœ¬éœ€æ±‚ä¸æ¶‰åŠå°ç¨‹åºæ”¹åŠ¨ã€‚æŠ½å¥–æ¥å£ `POST /api/v4/lottery/draw` çš„è¯·æ±‚å’Œå“åº”ç»“æ„ä¸å˜ï¼Œç­–ç•¥å¼€å…³æ˜¯åç«¯å¼•æ“å†…éƒ¨å†³ç­–ï¼Œå¯¹å°ç¨‹åºç«¯å®Œå…¨é€æ˜ã€‚

## ã€‡ã€é¡¹ç›®æŠ€æœ¯æ ˆç¡®è®¤ï¼ˆä»¥åç«¯ä¸ºæƒå¨ï¼‰

### åç«¯æ•°æ®åº“é¡¹ç›®ï¼ˆæƒå¨åŸºå‡†ï¼‰

| å±‚ | æŠ€æœ¯ |
|----|------|
| è¿è¡Œæ—¶ | Node.js 20+ |
| Web æ¡†æ¶ | Express 4.18 |
| ORM | Sequelize 6.35 + mysql2 3.6 |
| æ•°æ®åº“ | MySQLï¼ˆSealos æ‰˜ç®¡ test-db-12-mysqlï¼‰ |
| ç¼“å­˜ | Redisï¼ˆioredis 5.7ï¼‰ |
| API ç‰ˆæœ¬ | `/api/v4/{resource}` RESTful |
| äº‹åŠ¡æ¨¡å¼ | æ¨¡å¼ Aï¼šå¤–éƒ¨ä¼ å…¥äº‹åŠ¡ï¼ˆTransactionManager.executeï¼‰ |
| ç­–ç•¥é…ç½®å­˜å‚¨ | `lottery_strategy_config` è¡¨ï¼ˆæŒ‰ `lottery_campaign_id` éš”ç¦»ï¼‰ |
| ç­–ç•¥é…ç½®åŠ è½½ | `DynamicConfigLoader`ï¼ˆStrategyConfig.jsï¼‰ä¸‰å±‚ä¼˜å…ˆçº§ï¼šDB > env > ä»£ç é»˜è®¤å€¼ |

### Web ç®¡ç†åå°å‰ç«¯ï¼ˆéœ€é€‚é…åç«¯ï¼‰

| å±‚ | æŠ€æœ¯ |
|----|------|
| æ„å»ºå·¥å…· | Vite 6.4 |
| JS æ¡†æ¶ | Alpine.js 3.15ï¼ˆè½»é‡å“åº”å¼ï¼‰ |
| CSS æ¡†æ¶ | Tailwind CSS 3.4 |
| å›¾è¡¨ | ECharts 6.0 |
| å®æ—¶é€šä¿¡ | Socket.io-client 4.8 |
| é¡µé¢æ¨¡å¼ | å¤šé¡µé¢ HTML + Alpine.js composable æ¨¡å— |

### å¾®ä¿¡å°ç¨‹åºå‰ç«¯

æœ¬éœ€æ±‚ä¸æ¶‰åŠå¾®ä¿¡å°ç¨‹åºæ”¹åŠ¨ã€‚10 ç­–ç•¥æ´»åŠ¨çº§å¼€å…³æ˜¯çº¯åç«¯å¼•æ“ + ç®¡ç†åå°é…ç½®åŠŸèƒ½ï¼Œå°ç¨‹åºç«¯æŠ½å¥–æ¥å£å’Œæµç¨‹æ— å˜åŒ–ã€‚

---

## ä¸€ã€æ•°æ®åº“çœŸå®çŠ¶æ€æ ¸éªŒï¼ˆ2026-02-23 å®æ—¶æŸ¥è¯¢ï¼‰

### 1.1 lottery_campaigns å®é™…æ•°æ®

| ID | åç§° | çŠ¶æ€ | budget_mode | segment_resolver_version |
|----|------|------|-------------|--------------------------|
| 1 | é¤å…ç§¯åˆ†æŠ½å¥– | active | user | v1 |
| 25 | èµ°èµ°èµ° | ended | user | v1 |
| 26 | å†æ‰¾æ‰¾ | paused | user | v1 |
| 27 | 12312 | ended | user | v1 |

### 1.2 lottery_strategy_config å®é™…æ•°æ®

| æ´»åŠ¨ ID | è®°å½•æ•° | config_group åˆ—è¡¨ |
|---------|--------|------------------|
| 1 | 19 æ¡ | anti_empty, anti_high, budget_tier, luck_debt, matrix, pity, pressure_tier |
| 26 | 2 æ¡ | matrix, **pressure**ï¼ˆæ³¨æ„ï¼šä¸æ˜¯ pressure_tierï¼‰ |
| 25 | 0 æ¡ | æ— ä»»ä½•é…ç½® |
| 27 | 0 æ¡ | æ— ä»»ä½•é…ç½® |

**æ•°æ®é—®é¢˜ç¡®è®¤**ï¼š
- æ´»åŠ¨ 26 çš„ `config_group='pressure'` ä¸æ´»åŠ¨ 1 çš„ `config_group='pressure_tier'` ä¸ä¸€è‡´
- æ´»åŠ¨ 25/27 å®Œå…¨æ²¡æœ‰ç­–ç•¥é…ç½®è®°å½•
- æ–°å»ºæ´»åŠ¨æ—¶ `CRUDService.createCampaign()` ä¸ä¼šè‡ªåŠ¨æ’å…¥ç­–ç•¥é…ç½®

### 1.3 lottery_management_settings å®é™…æ•°æ®

| å­—æ®µ | å®é™…æƒ…å†µ |
|------|---------|
| æ€»è®°å½• | 2956 æ¡ |
| æŒ‰çŠ¶æ€åˆ†å¸ƒ | active 4 æ¡ã€expired 43 æ¡ã€used 16 æ¡ã€cancelled 2893 æ¡ |
| æŒ‰ç±»å‹åˆ†å¸ƒ | force_winï¼ˆactive 4 + expired 40 + used 16 + cancelled 517ï¼‰ã€force_loseï¼ˆexpired 1ï¼‰ã€probability_adjustï¼ˆexpired 2 + cancelled 2376ï¼‰ |
| æ´»è·ƒè®°å½• | **4 æ¡**ï¼ˆå…¨éƒ¨ä¸º user_id=31 çš„ force_winï¼Œç›®æ ‡ lottery_prize_id=9 "ä¹å…«æŠ˜åˆ¸"ï¼Œæ— è¿‡æœŸæ—¶é—´ï¼Œåˆ›å»ºäº 2026-02-23ï¼‰ |
| setting_type æšä¸¾ | `force_win`, `force_lose`, `probability_adjust`, `user_queue`ï¼ˆæ–‡æ¡£æ–°å¢ï¼šä»£ç ä¸­è¿˜æ”¯æŒ `user_queue` é¢„è®¾é˜Ÿåˆ—ç±»å‹ï¼‰ |
| `lottery_campaign_id` åˆ— | **ä¸å­˜åœ¨**â€”â€”è¡¨ä»… 9 åˆ—ï¼š`lottery_management_setting_id`, `user_id`, `setting_type`, `setting_data`(JSON), `expires_at`, `status`, `created_by`, `created_at`, `updated_at` |

**æ•°æ®ä¿®æ­£**ï¼ˆåŸæ–‡æ¡£æœ‰è¯¯ï¼‰ï¼š
- åŸæ–‡æ¡£ç§°"0 æ¡æ´»è·ƒè®°å½•"ï¼Œå®é™… **4 æ¡ active force_win**ï¼ˆuser_id=31ï¼‰
- è¿™æ„å‘³ç€ç­–ç•¥ 9 æ”¹è¡¨åï¼Œè¿™ 4 æ¡è®°å½•çš„ `lottery_campaign_id` éœ€å†³å®šèµ‹å€¼ï¼ˆè§ç¬¬å››èŠ‚ç­–ç•¥ 9ï¼‰

### 1.4 lottery_tier_matrix_config å®é™…æ•°æ®

æ´»åŠ¨ 1 æœ‰å®Œæ•´ 12 è¡Œï¼ˆB0-B3 Ã— P0-P2ï¼‰ï¼Œå…¶ä»–æ´»åŠ¨ 0 è¡Œã€‚

### 1.5 feature_flags å®é™…æ•°æ®

| flag_key | is_enabled | rollout_percentage | rollout_strategy |
|----------|------------|-------------------|-----------------|
| lottery_pity_system | 1 | 100% | all |
| lottery_luck_debt | 1 | 100% | all |
| lottery_anti_empty_streak | 1 | 100% | all |
| lottery_anti_high_streak | 1 | 100% | all |
| lottery_bxpx_matrix | 1 | 100% | all |
| lottery_budget_tier | 1 | 100% | all |
| lottery_pressure_tier | 1 | 100% | all |

è¡¨å…± 18 åˆ—ï¼Œå« `flag_key`(unique), `is_enabled`, `rollout_strategy`, `rollout_percentage`, `whitelist_user_ids`, `blacklist_user_ids`, `target_segments`, `effective_start/end`, `fallback_behavior` ç­‰ã€‚7 ä¸ª flag å…¨éƒ¨ enabled + 100% å…¨é‡ã€‚æ—  `lottery_campaign_id` åˆ—ã€‚

### 1.6 lottery_campaigns è¡¥å……å­—æ®µ

DB å®æŸ¥å‘ç°æ–‡æ¡£é—æ¼çš„å­—æ®µï¼š
- `pick_method`ï¼šå€¼ä¸º `tier_first`ï¼ˆ4 ä¸ªæ´»åŠ¨å‡ç›¸åŒï¼‰ã€‚TierPickStage ä¸­ `pick_method === 'normalize'` æ—¶è·³è¿‡æ¡£ä½é€‰æ‹©ï¼Œç›´æ¥ç”± PrizePickStage æŒ‰ win_probability æŠ½å–ã€‚å½“å‰æ— æ´»åŠ¨ä½¿ç”¨ normalize æ¨¡å¼ã€‚
- æœ¬éœ€æ±‚çš„ 10 ç­–ç•¥æ”¹é€ ä»…å½±å“ `tier_first` æ¨¡å¼ï¼Œ`normalize` æ¨¡å¼ä¸èµ° TierPickStage çš„æƒé‡è°ƒæ•´é“¾è·¯ã€‚

---

## äºŒã€10 ç­–ç•¥å½“å‰çŠ¶æ€ vs ç›®æ ‡çŠ¶æ€ï¼ˆä»£ç å®æŸ¥ï¼‰

| # | ç­–ç•¥ | å½“å‰å¼€å…³é“¾è·¯ï¼ˆä»£ç å®æŸ¥ï¼‰ | å½“å‰é—®é¢˜ | ç›®æ ‡çŠ¶æ€ |
|---|------|----------------------|---------|---------|
| 1 | ç”¨æˆ·åˆ†ç¾¤ | `lottery_campaigns.segment_resolver_version` | âœ… å·²æ˜¯æ´»åŠ¨çº§ | ä¿æŒç°çŠ¶ |
| 2 | é¢„ç®—åˆ†å±‚ | `lottery_campaigns.budget_mode` + `lottery_strategy_config.budget_tier.*` | âœ… å·²æ˜¯æ´»åŠ¨çº§ | ä¿æŒç°çŠ¶ |
| 3 | æ´»åŠ¨å‹åŠ› | TierPickStage L252: `DynamicConfigLoader.getValue('pressure_tier', 'enabled', true)` â€” StrategyConfig.js L848 ç­¾å `getValue(group, key, default_value)` **æ—  options å‚æ•°** | âš ï¸ `getValue()` ä¸æ¥å— `lottery_campaign_id`ï¼Œ`loadConfig()` ç”¨å…¨å±€å•ä»½ç¼“å­˜ | ä¿® `getValue` ç­¾å + ç¼“å­˜æŒ‰æ´»åŠ¨éš”ç¦» |
| 4 | BxPx çŸ©é˜µ | TierPickStage L272: `DynamicConfigLoader.getValue('matrix', 'enabled', true)` â€” åŒä¸Š | âš ï¸ åŒç­–ç•¥ 3 | åŒç­–ç•¥ 3 å…±äº«ä¿®å¤ |
| 5 | Pity ä¿åº• | `LotteryComputeEngine` æ„é€ å‡½æ•° L150: `enable_pity: isFeatureEnabled('pity')` â†’ åªè¯» env `PITY_ENABLED` | ğŸ”´ `isFeatureEnabled()` åªçœ‹ StrategyConfig.js L448 ä¸­ `PITY_CONFIG.enabled = process.env.PITY_ENABLED !== 'false'`ï¼Œå¯åŠ¨åå†™æ­» | æ”¹ä¸ºè¿è¡Œæ—¶ä» DB æŒ‰æ´»åŠ¨è¯»å– |
| 6 | è¿æ°”å€ºåŠ¡ | æ„é€ å‡½æ•° L151: `enable_luck_debt: isFeatureEnabled('luck_debt')` â†’ åªè¯» env | ğŸ”´ åŒç­–ç•¥ 5 | åŒç­–ç•¥ 5 |
| 7 | é˜²è¿ç©º | æ„é€ å‡½æ•° L152: `enable_anti_streak: isFeatureEnabled('anti_empty') \|\| isFeatureEnabled('anti_high')` | ğŸ”´ anti_empty å’Œ anti_high åˆå¹¶ä¸ºä¸€ä¸ªå¼€å…³ `enable_anti_streak` | æ‹†æˆä¸¤ä¸ªç‹¬ç«‹å¼€å…³ + ä» DB è¯»å– |
| 8 | é˜²è¿é«˜ | åŒç­–ç•¥ 7 å…±ç”¨ `enable_anti_streak` | ğŸ”´ åŒç­–ç•¥ 7 | åŒç­–ç•¥ 7 |
| 9 | ç®¡ç†å¹²é¢„ | `LoadDecisionSourceStage._checkOverride()` L215: å‚æ•° `_lottery_campaign_id` å¸¦ä¸‹åˆ’çº¿å‰ç¼€ï¼ˆæ•…æ„æœªä½¿ç”¨ï¼‰ï¼ŒæŸ¥è¯¢åªæŒ‰ `user_id` | ğŸ”´ è¡¨æ—  `lottery_campaign_id` åˆ—ï¼Œç®¡ç†å¹²é¢„å¯¹æ‰€æœ‰æ´»åŠ¨ç”Ÿæ•ˆï¼›**DB æœ‰ 4 æ¡ active è®°å½•éœ€å¤„ç†** | æ–°å¢æ´»åŠ¨çº§æ€»å¼€å…³ + æ”¹è¡¨ |
| 10 | ç°åº¦å‘å¸ƒ | `StrategyConfig.js` L341-380: `GRAYSCALE_CONFIG` ä» env è§£æï¼Œå¯åŠ¨åå†™æ­»ï¼›`isFeatureEnabledForContext()` L493 åšç™¾åˆ†æ¯”åˆ¤æ–­ä½†ä¸è¯» DB | ğŸ”´ å®Œå…¨ä¾èµ– envï¼Œä¸æ”¯æŒæŒ‰æ´»åŠ¨é…ä¸åŒç°åº¦ | æ–°å¢æ´»åŠ¨çº§ DB é…ç½® |

**è¡¥å……å‘ç°ï¼šä¸‰ç‰ˆä½“éªŒå¹³æ»‘æ–¹æ³•å¹¶å­˜**

TierPickStage L365 å®é™…è°ƒç”¨çš„æ˜¯ `computeEngine.applyExperienceSmoothing()`ï¼ˆåŸºç¡€ç‰ˆï¼‰ï¼ŒLotteryComputeEngine ä¸­è¿˜æœ‰ä¸¤ä¸ªæœªè¢« pipeline ä½¿ç”¨çš„å˜ä½“ï¼š
- `applyExperienceSmoothingWithGrayscale()` â€” ä½¿ç”¨ env ç°åº¦é…ç½®
- `applyExperienceSmoothingWithFeatureFlag()` â€” ä½¿ç”¨ `feature_flags` è¡¨

ç­–ç•¥ 5-8 æ”¹é€ åº”ä¿®æ”¹ **åŸºç¡€ç‰ˆ `applyExperienceSmoothing()`**ï¼ˆL378-500ï¼‰ï¼Œè¿™æ˜¯ pipeline å®é™…è°ƒç”¨çš„ç‰ˆæœ¬ã€‚å¦å¤–ä¸¤ä¸ªå˜ä½“åœ¨æ”¹é€ å®Œæˆååº”æ ‡è®°ä¸º `@deprecated` æˆ–åˆ é™¤ï¼Œé¿å…å¤šç‰ˆæœ¬å¹¶å­˜çš„ç»´æŠ¤è´Ÿæ‹…ã€‚

### æ”¹é€ é‡æ±‡æ€»

| åˆ†ç±» | ç­–ç•¥/é—®é¢˜ | æ•°é‡ | å·¥ä½œé‡ |
|------|----------|------|--------|
| æ— éœ€æ”¹é€  | ç”¨æˆ·åˆ†ç¾¤ã€é¢„ç®—åˆ†å±‚ | 2 | 0 |
| ä¿® DynamicConfigLoader + ç¼“å­˜ Map åŒ– | æ´»åŠ¨å‹åŠ›ã€BxPx çŸ©é˜µï¼ˆå« B1/B2ï¼‰ | 2 | 0.5 å¤© |
| æ”¹å¼€å…³è¯»å–é“¾è·¯ + åºŸå¼ƒå†—ä½™ç‰ˆæœ¬ | Pityã€è¿æ°”å€ºåŠ¡ã€é˜²è¿ç©ºã€é˜²è¿é«˜ï¼ˆå« B3/B4/B9ï¼‰ | 4 | 1 å¤© |
| æ–°å¢æ´»åŠ¨çº§å¼€å…³ | ç®¡ç†å¹²é¢„ã€ç°åº¦å‘å¸ƒï¼ˆå« B5ï¼‰ | 2 | 1 å¤© |
| ä¿® upsertConfig + æ•°æ®è¿ç§» | B8 + B6 + B7 | â€” | 0.5 å¤© |
| **åç«¯åˆè®¡** | | **10 ç­–ç•¥ + 3 åŸºç¡€ä¿®å¤** | **çº¦ 3 å¤©** |

---

## ä¸‰ã€é—®é¢˜å½’å±åˆ†ç±»ï¼ˆåç«¯ / Web å‰ç«¯ / å°ç¨‹åºï¼‰

### 3.1 åç«¯æ•°æ®åº“é¡¹ç›®çš„é—®é¢˜ï¼ˆ9 é¡¹ï¼‰

| # | é—®é¢˜ | æ¶‰åŠæ–‡ä»¶ | æ€§è´¨ |
|---|------|---------|------|
| B1 | `DynamicConfigLoader.getValue()` ç­¾åç¼ºå°‘ `options` å‚æ•° | `StrategyConfig.js` L848 | æ–¹æ³•ç­¾åä¸å®Œæ•´ |
| B2 | `_dynamicConfigCache` æ˜¯å…¨å±€å•ä»½ï¼Œä¸æ”¯æŒæŒ‰æ´»åŠ¨éš”ç¦» | `StrategyConfig.js` L635-644 | ç¼“å­˜æ¶æ„ç¼ºé™· |
| B3 | `LotteryComputeEngine` æ„é€ å‡½æ•°å†™æ­» env å¼€å…³ï¼Œè¿è¡Œæ—¶ä¸é‡è¯» | `LotteryComputeEngine.js` L147-154 | å¼€å…³é“¾è·¯æ–­è£‚ |
| B4 | `enable_anti_streak` åˆå¹¶ anti_empty å’Œ anti_high | `LotteryComputeEngine.js` L152 | å¼€å…³ç²’åº¦ä¸å¤Ÿ |
| B5 | `LoadDecisionSourceStage._checkOverride()` ä¸æŒ‰æ´»åŠ¨è¿‡æ»¤ + `lottery_management_settings` è¡¨ç¼º `lottery_campaign_id` åˆ— | `LoadDecisionSourceStage.js` L215 + `LotteryManagementSetting.js` | ç®¡ç†å¹²é¢„æ— æ´»åŠ¨éš”ç¦»ï¼ˆæ•°æ®æ¨¡å‹ç¼ºé™·ï¼‰ |
| B6 | `CRUDService.createCampaign()` ä¸è‡ªåŠ¨æ’å…¥ç­–ç•¥é…ç½® | `CRUDService.js` L77-210 | æ–°æ´»åŠ¨é…ç½®ç¼ºå¤± |
| B7 | æ´»åŠ¨ 26 `config_group='pressure'` ä¸ä¸€è‡´ | æ•°æ®åº“ `lottery_strategy_config` | å†å²æ•°æ®ä¸è§„èŒƒ |
| **B8** | **`LotteryStrategyConfig.upsertConfig()` çš„ `where` æ¡ä»¶ç¼ºå°‘ `lottery_campaign_id`** | `LotteryStrategyConfig.js` L183-218 | **å†™å…¥æ¥å£ç¼ºé™·ï¼š`findOrCreate` çš„ where ä»…å« `config_group + config_key + priority`ï¼Œä¸åŒºåˆ†æ´»åŠ¨ã€‚PUT API æ‰¹é‡æ›´æ–°æ—¶ä¼šè·¨æ´»åŠ¨è¦†ç›–** |
| **B9** | **ä¸‰ç‰ˆ `applyExperienceSmoothing` å¹¶å­˜ï¼ˆbase / Grayscale / FeatureFlagï¼‰ï¼Œpipeline åªç”¨ base ç‰ˆ** | `LotteryComputeEngine.js` L378/L1012/L1159 | å†—ä½™ä»£ç ï¼Œæ”¹é€ åå¦ä¸¤ç‰ˆæœ¬åº”åºŸå¼ƒ |

### 3.2 Web ç®¡ç†åå°å‰ç«¯é¡¹ç›®çš„é—®é¢˜ï¼ˆ2 é¡¹ï¼‰

| # | é—®é¢˜ | è¯´æ˜ |
|---|------|------|
| F1 | æ— ç­–ç•¥é…ç½®ç®¡ç† UI | å½“å‰ç®¡ç†åå°æ— é¡µé¢è®©è¿è¥æŸ¥çœ‹/ä¿®æ”¹æ¯ä¸ªæ´»åŠ¨çš„ç­–ç•¥å¼€å…³å’Œå‚æ•° |
| F2 | ç®¡ç†å¹²é¢„ç¼ºå°‘æ´»åŠ¨çº§å¼€å…³å…¥å£ | `lottery-management.js` ä¸­åˆ›å»ºå¹²é¢„æ—¶ä¸å…³è”æ´»åŠ¨ï¼Œæ— æ´»åŠ¨ç»´åº¦è¿‡æ»¤ |

### 3.3 å¾®ä¿¡å°ç¨‹åºå‰ç«¯çš„é—®é¢˜ï¼ˆ0 é¡¹ï¼‰

æœ¬éœ€æ±‚ä¸æ¶‰åŠå°ç¨‹åºæ”¹åŠ¨ã€‚æŠ½å¥–æ¥å£ `POST /api/v4/lottery/draw` çš„è¯·æ±‚å’Œå“åº”ç»“æ„ä¸å˜ï¼Œç­–ç•¥å¼€å…³æ˜¯åç«¯å¼•æ“å†…éƒ¨å†³ç­–ã€‚

---

## å››ã€é€ç­–ç•¥æ”¹é€ æ–¹æ¡ˆ

### ç­–ç•¥ 1ï¼šç”¨æˆ·åˆ†ç¾¤ âœ… æ— éœ€æ”¹é€ 

**ç°çŠ¶**ï¼š`lottery_campaigns.segment_resolver_version` å­—æ®µï¼Œæ¯æ´»åŠ¨ç‹¬ç«‹ã€‚

**ä»£ç é“¾è·¯**ï¼ˆå·²éªŒè¯ TierPickStage.js L439-483ï¼‰ï¼š
```
TierPickStage._resolveUserSegment()
  â†’ campaign.segment_resolver_version   // ä» LoadCampaignStage åŠ è½½
  â†’ SegmentResolver.resolveSegmentAsync(version, user)
```

**DB å®é™…å€¼**ï¼š4 ä¸ªæ´»åŠ¨å…¨éƒ¨ `v1`ã€‚è¿è¥å¯é€‰ default/v1/v2/v3/v4ã€‚

**ç»“è®º**ï¼šå¤©ç„¶æ´»åŠ¨çº§éš”ç¦»ï¼Œæ— éœ€æ”¹é€ ã€‚

---

### ç­–ç•¥ 2ï¼šé¢„ç®—åˆ†å±‚ âœ… æ— éœ€æ”¹é€ 

**ç°çŠ¶**ï¼š
- ä¸»å¼€å…³ï¼š`lottery_campaigns.budget_mode`ï¼ˆuser/pool/noneï¼‰
- å‚æ•°ï¼š`lottery_strategy_config` è¡¨ `budget_tier.*`

**DB å®é™…å€¼**ï¼š4 ä¸ªæ´»åŠ¨å…¨éƒ¨ `user` æ¨¡å¼ã€‚é˜ˆå€¼ä»…æ´»åŠ¨ 1 æœ‰é…ç½®ï¼ˆthreshold_high=1000, threshold_mid=500, threshold_low=100ï¼‰ã€‚

**ç»“è®º**ï¼šå¤©ç„¶æ´»åŠ¨çº§éš”ç¦»ã€‚

---

### ç­–ç•¥ 3ï¼šæ´»åŠ¨å‹åŠ› âš ï¸ ä¿® DynamicConfigLoader

**å½“å‰ä»£ç **ï¼ˆTierPickStage.js L252ï¼‰ï¼š
```
const pressure_enabled = await DynamicConfigLoader.getValue('pressure_tier', 'enabled', true)
```

**StrategyConfig.js L848 çš„å®é™…ç­¾å**ï¼š
```
static async getValue(group, key, default_value) {
  const config = await this.loadConfig()  // â† ä¸ä¼  lottery_campaign_id
  ...
}
```

**é—®é¢˜æœ¬è´¨**ï¼š`getValue()` ç¼ºå°‘ `options` å‚æ•°ï¼Œ`loadConfig()` è™½ç„¶æ”¯æŒ `options.lottery_campaign_id` ä½†ä¸Šæ¸¸æ²¡ä¼ ã€‚ä¸” `_dynamicConfigCache` æ˜¯å…¨å±€å•ä»½ã€‚

**æ”¹é€ æ–¹æ¡ˆ**ï¼š
1. `getValue()` å¢åŠ ç¬¬ 4 ä¸ªå‚æ•° `options = {}`ï¼Œé€ä¼ ç»™ `loadConfig(options)`
2. `_dynamicConfigCache` æ”¹ä¸º `Map<lottery_campaign_id | 'global', { data, loaded_at }>`
3. TierPickStage è°ƒç”¨æ—¶ä¼ å…¥ `{ lottery_campaign_id }`

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `services/UnifiedLotteryEngine/compute/config/StrategyConfig.js`ï¼ˆ`getValue` + `loadConfig` + ç¼“å­˜ç»“æ„ï¼‰
- `services/UnifiedLotteryEngine/pipeline/stages/TierPickStage.js`ï¼ˆL252 è°ƒç”¨å¤„ï¼‰

**æ•°æ®ä¿®å¤**ï¼šæ´»åŠ¨ 26 `config_group='pressure'` â†’ `'pressure_tier'`

---

### ç­–ç•¥ 4ï¼šBxPx çŸ©é˜µ âš ï¸ åŒç­–ç•¥ 3

**å½“å‰ä»£ç **ï¼ˆTierPickStage.js L272ï¼‰ï¼š
```
const matrix_enabled = await DynamicConfigLoader.getValue('matrix', 'enabled', true)
```

**æ”¹é€ æ–¹æ¡ˆ**ï¼šä¸ç­–ç•¥ 3 å…±äº« `DynamicConfigLoader` ä¿®å¤ï¼ŒTierPickStage L272 åŠ  `{ lottery_campaign_id }`ã€‚

**æ¶‰åŠæ–‡ä»¶**ï¼šåŒç­–ç•¥ 3ã€‚

---

### ç­–ç•¥ 5-8ï¼šPity / è¿æ°”å€ºåŠ¡ / é˜²è¿ç©º / é˜²è¿é«˜ ğŸ”´ æ”¹å¼€å…³è¯»å–é“¾è·¯

**å½“å‰ä»£ç **ï¼ˆLotteryComputeEngine.js L147-154ï¼‰ï¼š
```
constructor(options = {}) {
  this.options = {
    enable_pity: isFeatureEnabled('pity'),          // L150
    enable_luck_debt: isFeatureEnabled('luck_debt'), // L151
    enable_anti_streak: isFeatureEnabled('anti_empty') || isFeatureEnabled('anti_high'), // L152
    ...options
  }
}
```

**`isFeatureEnabled()` å®é™…å®ç°**ï¼ˆStrategyConfig.js L448-461ï¼‰ï¼š
```
function isFeatureEnabled(feature) {
  switch (feature) {
    case 'pity': return PITY_CONFIG.enabled      // â† process.env.PITY_ENABLED !== 'false'
    case 'luck_debt': return LUCK_DEBT_CONFIG.enabled  // â† process.env.LUCK_DEBT_ENABLED !== 'false'
    case 'anti_empty': return ANTI_EMPTY_CONFIG.enabled
    case 'anti_high': return ANTI_HIGH_CONFIG.enabled
  }
}
```

**`applyExperienceSmoothing()` å®é™…è°ƒç”¨é“¾**ï¼ˆpipeline å®é™…ä½¿ç”¨çš„ç‰ˆæœ¬ï¼ŒL378-500ï¼‰ï¼š
```
TierPickStage.execute() L365
  â†’ computeEngine.applyExperienceSmoothing(params)  // â† åŸºç¡€ç‰ˆï¼Œéç°åº¦ç‰ˆ
    â†’ L401: if (this.options.enable_pity)      // env å†™æ­»
    â†’ L418: if (this.options.enable_anti_streak) // env å†™æ­»ï¼ŒAntiEmpty
    â†’ L441: if (this.options.enable_anti_streak) // env å†™æ­»ï¼ŒAntiHighï¼ˆä¸ AntiEmpty å…±ç”¨åŒä¸€å¼€å…³ï¼‰
```

**é—®é¢˜**ï¼š
1. å…¨éƒ¨åªçœ‹ envï¼Œå®Œå…¨ä¸è¯» DB æ´»åŠ¨çº§é…ç½®
2. æ„é€ å‡½æ•°æ‰§è¡Œä¸€æ¬¡åå†™æ­»ï¼Œè¿è¡Œæ—¶ä¸é‡è¯»
3. `anti_empty` å’Œ `anti_high` è¢«åˆå¹¶ä¸º `enable_anti_streak` ä¸€ä¸ªå¼€å…³
4. å­˜åœ¨ä¸‰ç‰ˆ `applyExperienceSmoothing`ï¼ˆbase / Grayscale / FeatureFlagï¼‰ï¼Œä½† pipeline åªè°ƒç”¨ base ç‰ˆï¼ˆL365ï¼‰ï¼Œå…¶ä»–ä¸¤ç‰ˆæ˜¯æ­»ä»£ç 

**æ”¹é€ æ–¹æ¡ˆ**ï¼š

ä¿®æ”¹ **åŸºç¡€ç‰ˆ `applyExperienceSmoothing()`**ï¼ˆL378-500ï¼Œè¿™æ˜¯ pipeline å®é™…è°ƒç”¨çš„ç‰ˆæœ¬ï¼‰ï¼Œæ¯æ¬¡è°ƒç”¨æ—¶ä» DB æŒ‰æ´»åŠ¨è¯»å–å¼€å…³ï¼Œæ›¿ä»£ `this.options.enable_*`ï¼š

```
applyExperienceSmoothing(params) {
  const { lottery_campaign_id } = params

  // æ›¿ä»£ this.options.enable_pity â†’ DB æ´»åŠ¨çº§ > env > ä»£ç é»˜è®¤
  const pity_enabled = await DynamicConfigLoader.getValue(
    'pity', 'enabled', this.options.enable_pity, { lottery_campaign_id }
  )

  // æ›¿ä»£ this.options.enable_anti_streak â†’ æ‹†æˆä¸¤ä¸ªç‹¬ç«‹åˆ¤æ–­
  const anti_empty_enabled = await DynamicConfigLoader.getValue(
    'anti_empty', 'enabled', isFeatureEnabled('anti_empty'), { lottery_campaign_id }
  )
  const anti_high_enabled = await DynamicConfigLoader.getValue(
    'anti_high', 'enabled', isFeatureEnabled('anti_high'), { lottery_campaign_id }
  )

  // åŒç†å¤„ç† luck_debt
  const luck_debt_enabled = await DynamicConfigLoader.getValue(
    'luck_debt', 'enabled', this.options.enable_luck_debt, { lottery_campaign_id }
  )
}
```

ä¼˜å…ˆçº§ï¼šDB æ´»åŠ¨çº§ > env ç¯å¢ƒå˜é‡ > ä»£ç é»˜è®¤ trueï¼ˆä¸ç°æœ‰ DynamicConfigLoader ä¸‰å±‚ä¼˜å…ˆçº§ä¸€è‡´ï¼‰

**é™„å¸¦æ¸…ç†**ï¼šæ”¹é€ å®Œæˆåå°† `applyExperienceSmoothingWithGrayscale()`ï¼ˆL1012ï¼‰å’Œ `applyExperienceSmoothingWithFeatureFlag()`ï¼ˆL1159ï¼‰æ ‡è®° `@deprecated` å¹¶åœ¨ä¸‹ä¸€ç‰ˆæœ¬åˆ é™¤ã€‚`checkFeatureWithGrayscale()` å’Œ `checkFeatureWithFeatureFlag()` åŒç†ã€‚pipeline ç»Ÿä¸€èµ° base ç‰ˆ + DynamicConfigLoader è·¯å¾„ã€‚

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `services/UnifiedLotteryEngine/compute/LotteryComputeEngine.js`ï¼ˆ`applyExperienceSmoothing` L378-500ï¼Œä¸‰å¤„ `this.options.enable_*` æ›¿æ¢ + åºŸå¼ƒå¦ä¸¤ç‰ˆæœ¬ï¼‰
- `services/UnifiedLotteryEngine/compute/config/StrategyConfig.js`ï¼ˆ`getValue` æ”¹é€ ï¼Œä¸ç­–ç•¥ 3/4 å…±äº«ï¼‰

---

### ç­–ç•¥ 9ï¼šç®¡ç†å¹²é¢„ ğŸ”´ æ”¹è¡¨ + æ´»åŠ¨çº§æ€»å¼€å…³ï¼ˆå·²è£å®š B+A åˆä½“ï¼‰

**ç°çŠ¶**ï¼ˆLoadDecisionSourceStage.js L215ï¼‰ï¼š
```
async _checkOverride(user_id, _lottery_campaign_id) {  // â† ä¸‹åˆ’çº¿å‰ç¼€ï¼Œæ•…æ„æœªä½¿ç”¨
  const override = await LotteryManagementSetting.findOne({
    where: { user_id, setting_type: { [Op.in]: ['force_win', 'force_lose'] }, status: 'active', ... }
  })
}
```

DB ç¡®è®¤ï¼š`lottery_management_settings` è¡¨æ—  `lottery_campaign_id` åˆ—ã€‚**4 æ¡æ´»è·ƒ force_win è®°å½•**ï¼ˆuser_id=31ï¼Œç›®æ ‡ lottery_prize_id=9ï¼‰+ 43 expired + 16 used + 2893 cancelledã€‚é¡¹ç›®æœªä¸Šçº¿ï¼Œè¿ç§»æˆæœ¬æä½ã€‚

**å·²è£å®šæ–¹æ¡ˆï¼šBï¼ˆæ”¹è¡¨ç»“æ„ï¼‰+ Aï¼ˆæ€»å¼€å…³ä½œä¾¿æ·å…¥å£ï¼‰**

è¯¦ç»†è®ºè¯è§ç¬¬åä¸€èŠ‚è¡Œä¸šå¯¹æ ‡åˆ†æã€‚

**æ”¹é€ å†…å®¹**ï¼š
1. `lottery_management_settings` è¡¨åŠ  `lottery_campaign_id INT NULL`ï¼ŒåŠ ç´¢å¼•
2. `LoadDecisionSourceStage._checkOverride()` å»æ‰ `_` å‰ç¼€ï¼ŒæŸ¥è¯¢åŠ  `lottery_campaign_id` è¿‡æ»¤æ¡ä»¶
3. ç®¡ç†åå°åˆ›å»ºå¹²é¢„æ—¶å¸¦æ´»åŠ¨ IDï¼ˆNULL è¡¨ç¤ºå…¨å±€å¹²é¢„ï¼Œå…¼å®¹æ—§é€»è¾‘ï¼‰
4. `lottery_strategy_config` åŠ  `management.enabled` æ€»å¼€å…³â€”â€”å…³é—­åè·³è¿‡ `_checkOverride()`
5. å†å²ç»ˆæ€è®°å½•ï¼ˆexpired/used/cancelledï¼‰`lottery_campaign_id` ä¿æŒ NULLï¼ˆå…¨å±€ç”Ÿæ•ˆï¼‰
6. **4 æ¡ active è®°å½•å¤„ç†**ï¼šè¿ç§»è„šæœ¬ä¸­å°† user_id=31 çš„ 4 æ¡ active force_win çš„ `lottery_campaign_id` è®¾ä¸º 1ï¼ˆå½“å‰å”¯ä¸€ active æ´»åŠ¨ï¼‰ï¼Œæˆ–ç”±è¿è¥ç¡®è®¤åèµ‹å€¼

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `models/LotteryManagementSetting.js`ï¼ˆåŠ å­—æ®µå®šä¹‰ï¼‰
- `services/UnifiedLotteryEngine/pipeline/stages/LoadDecisionSourceStage.js`ï¼ˆ`_checkOverride` åŠ æ´»åŠ¨è¿‡æ»¤ + æ€»å¼€å…³å‰ç½®æ£€æŸ¥ï¼‰
- æ•°æ®è¿ç§»ï¼šåŠ åˆ— + 4 æ¡ active è®°å½•èµ‹å€¼ + æ¯æ´»åŠ¨æ’å…¥ `management.enabled=true`
- ç®¡ç†åå°ï¼šåˆ›å»ºå¹²é¢„ UI å¢åŠ æ´»åŠ¨é€‰æ‹©

---

### ç­–ç•¥ 10ï¼šç°åº¦å‘å¸ƒ ğŸ”´ lottery_strategy_config å­˜æ´»åŠ¨çº§ç™¾åˆ†æ¯”ï¼ˆå·²è£å®šæ–¹æ¡ˆ Aï¼‰

**ç°çŠ¶**ï¼ˆStrategyConfig.js L341-380ï¼‰ï¼š
```
const GRAYSCALE_CONFIG = {
  pity: {
    percentage: parseInt(process.env.PITY_GRAYSCALE_PERCENTAGE) || 100,
    user_whitelist: parseEnvArray(process.env.PITY_USER_WHITELIST),
    campaign_whitelist: parseEnvArray(process.env.PITY_CAMPAIGN_WHITELIST)
  },
  // ... åŒç† luck_debt, anti_empty, anti_high
}
```

`isFeatureEnabledForContext()` L493 ä½¿ç”¨ env å€¼åšç°åº¦åˆ¤æ–­ã€‚DB å·²æœ‰ `feature_flags` è¡¨ï¼ˆå« `rollout_percentage`ã€`whitelist_user_ids`ï¼‰ï¼Œä½†æ—  `lottery_campaign_id` åˆ—ã€‚

**å·²è£å®šæ–¹æ¡ˆ Aï¼šlottery_strategy_config å­˜æ´»åŠ¨çº§ç°åº¦ç™¾åˆ†æ¯”**

è¯¦ç»†è®ºè¯è§ç¬¬åä¸€èŠ‚è¡Œä¸šå¯¹æ ‡åˆ†æã€‚`feature_flags` è¡¨ä¿ç•™ç»™ç³»ç»Ÿçº§åŠŸèƒ½å¼€å…³ã€‚

**æ”¹é€ å†…å®¹**ï¼š
1. `lottery_strategy_config` æ¯æ´»åŠ¨æ’å…¥ `grayscale.pity_percentage`ã€`grayscale.luck_debt_percentage`ã€`grayscale.anti_empty_percentage`ã€`grayscale.anti_high_percentage`
2. `isFeatureEnabledForContext()` æ”¹ä¸ºå…ˆä» `DynamicConfigLoader.getValue('grayscale', 'xxx_percentage', env_value, { lottery_campaign_id })` è¯»å–ï¼Œæ— å€¼å›é€€ env
3. ç™½åå•ä¿æŒ envï¼ˆä½é¢‘å˜æ›´ï¼‰

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `services/UnifiedLotteryEngine/compute/config/StrategyConfig.js`ï¼ˆ`isFeatureEnabledForContext` è¯» DBï¼‰
- `services/UnifiedLotteryEngine/compute/LotteryComputeEngine.js`ï¼ˆ`checkFeatureWithGrayscale` é€ä¼ æ´»åŠ¨ IDï¼‰
- æ•°æ®è¿ç§»ï¼šæ¯æ´»åŠ¨æ’å…¥ç°åº¦é»˜è®¤é…ç½®ï¼ˆ100%ï¼‰

---

## äº”ã€å…±äº«æ”¹é€ é¡¹ï¼šDynamicConfigLoader æ´»åŠ¨çº§æŸ¥è¯¢æ”¯æŒ

ç­–ç•¥ 3/4/5/6/7/8/10 éƒ½ä¾èµ–åŒä¸€ä¸ªæ”¹åŠ¨ã€‚

### 5.1 å½“å‰ä»£ç å®æŸ¥

```
// StrategyConfig.js L848 - å®é™…ç­¾å
static async getValue(group, key, default_value) {
  const config = await this.loadConfig()  // â† ä¸ä¼  lottery_campaign_id
  if (config && config[group] && config[group][key] !== undefined) {
    return config[group][key]
  }
  return default_value
}

// StrategyConfig.js L690 - loadConfig æ”¯æŒ options ä½†ä¸Šæ¸¸æ²¡ä¼ 
static async loadConfig(options = {}) {
  // ...
  const db_config = await LotteryStrategyConfig.getAllConfig(options.lottery_campaign_id)
  // ...
}

// StrategyConfig.js L635 - å…¨å±€å•ä»½ç¼“å­˜
const _dynamicConfigCache = {
  data: null,
  matrix: null,
  loaded_at: null,
  loading: false
}
```

### 5.2 æ”¹é€ å

**`getValue` ç­¾åå˜æ›´**ï¼š
```
static async getValue(group, key, default_value, options = {}) {
  const config = await this.loadConfig(options)  // â† é€ä¼  options
  ...
}
```

**ç¼“å­˜æ”¹ä¸ºæŒ‰æ´»åŠ¨ ID éš”ç¦»**ï¼š
```
// Map ç»“æ„: campaign_id â†’ { data, matrix, loaded_at }
const _dynamicConfigCache = new Map()

// cache key: lottery_campaign_id || 'global'
```

TTL ä¿æŒ 5 åˆ†é’Ÿä¸å˜ã€‚

### 5.3 å¯å¤ç”¨åŸºç¡€è®¾æ–½

| ç°æœ‰è®¾æ–½ | çŠ¶æ€ | å¤ç”¨æ–¹å¼ |
|---------|------|---------|
| `LotteryStrategyConfig.getAllConfig(lottery_campaign_id)` | âœ… å·²æ”¯æŒæŒ‰æ´»åŠ¨æŸ¥è¯¢ | ç›´æ¥å¤ç”¨ |
| `LotteryStrategyConfig.upsertConfig()` | âš ï¸ **where æ¡ä»¶ç¼º `lottery_campaign_id`**ï¼ˆB8ï¼‰| éœ€ä¿®å¤ï¼š`findOrCreate` çš„ where åŠ å…¥ `lottery_campaign_id`ï¼Œå¦åˆ™è·¨æ´»åŠ¨æ›´æ–°ä¼šè¦†ç›– |
| `LotteryStrategyConfig.getParsedValue()` | âœ… è‡ªåŠ¨ç±»å‹è½¬æ¢ | ç›´æ¥å¤ç”¨ |
| `DynamicConfigLoader.clearCache()` | âš ï¸ å½“å‰æ¸…é™¤å…¨å±€ç¼“å­˜ï¼ˆL884-889ï¼‰ | ç¼“å­˜æ”¹ Map åéœ€æ”¯æŒ `clearCache(lottery_campaign_id)` æŒ‰æ´»åŠ¨æ¸…é™¤ |
| å”¯ä¸€ç´¢å¼• `uk_strategy_campaign_group_key_priority` | âœ… å·²å»ºç«‹ `(lottery_campaign_id, config_group, config_key, priority)` | ä¿è¯å¹‚ç­‰ |
| ç´¢å¼• `idx_strategy_config_campaign` | âœ… å·²å»ºç«‹ `(lottery_campaign_id)` | æ”¯æŒæŒ‰æ´»åŠ¨æŸ¥è¯¢ |
| ç´¢å¼• `idx_strategy_config_group_active` | âœ… å·²å»ºç«‹ `(config_group, is_active)` | æ”¯æŒæŒ‰åˆ†ç»„æŸ¥è¯¢ |

### 5.4 å¯æ‰©å±•ç‚¹

| æ‰©å±•æ–¹å‘ | ç°æœ‰æ”¯æ’‘ |
|---------|---------|
| æ–°å¢ç­–ç•¥ç»´åº¦ | å‘ `lottery_strategy_config` æ’å…¥æ–° `config_group` å³å¯ï¼Œä¸æ”¹è¡¨ç»“æ„ |
| é…ç½®å®šæ—¶ç”Ÿæ•ˆ | è¡¨å·²æœ‰ `effective_start`/`effective_end` å­—æ®µï¼Œ`isEffective()` å®ä¾‹æ–¹æ³•å·²å®ç° |
| é…ç½®ä¼˜å…ˆçº§ | è¡¨å·²æœ‰ `priority` å­—æ®µï¼ŒæŸ¥è¯¢å·²æŒ‰ `priority DESC` æ’åº |
| é…ç½®å®¡è®¡ | è¡¨å·²æœ‰ `created_by`/`updated_by` å­—æ®µ |

---

## å…­ã€æ•°æ®è¿ç§»æ–¹æ¡ˆ

### 6.1 ä¿®å¤æ•°æ®ä¸ä¸€è‡´

æ´»åŠ¨ 26 çš„ pressure `config_group` ä» `'pressure'` ç»Ÿä¸€ä¸º `'pressure_tier'`ã€‚

### 6.2 ä¸ºç¼ºå¤±é…ç½®çš„æ´»åŠ¨è¡¥å……é»˜è®¤è®°å½•

æ´»åŠ¨ 25/27 å½“å‰ 0 æ¡ç­–ç•¥é…ç½®ã€‚ä»¥æ´»åŠ¨ 1 çš„ 19 æ¡è®°å½•ä¸ºæ¨¡æ¿ï¼Œä¸ºæ¯ä¸ªç¼ºå¤±æ´»åŠ¨æ’å…¥å®Œæ•´é»˜è®¤é…ç½®é›†ï¼ˆenabled å…¨éƒ¨ trueï¼Œå‚æ•°ç”¨ä»£ç é»˜è®¤å€¼ï¼‰ã€‚

é»˜è®¤é…ç½®é›†ï¼ˆæ¯æ´»åŠ¨ 19 + 5 = 24 æ¡ï¼‰ï¼š

| config_group | config_key | default_value | value_type |
|-------------|------------|---------------|------------|
| anti_empty | enabled | true | boolean |
| anti_empty | empty_streak_threshold | 3 | number |
| anti_high | enabled | true | boolean |
| anti_high | high_streak_threshold | 2 | number |
| anti_high | recent_draw_window | 5 | number |
| budget_tier | threshold_high | 1000 | number |
| budget_tier | threshold_low | 100 | number |
| budget_tier | threshold_mid | 500 | number |
| luck_debt | enabled | true | boolean |
| luck_debt | expected_empty_rate | 0.3 | number |
| luck_debt | min_draw_count | 10 | number |
| matrix | enabled | true | boolean |
| pity | enabled | true | boolean |
| pity | hard_guarantee_threshold | 10 | number |
| pity | min_non_empty_cost | 10 | number |
| pity | multiplier_table | {0:1,...,9:10} | object |
| pressure_tier | enabled | true | boolean |
| pressure_tier | threshold_high | 0.8 | number |
| pressure_tier | threshold_low | 0.5 | number |
| **management** | **enabled** | **true** | **boolean** |
| **grayscale** | **pity_percentage** | **100** | **number** |
| **grayscale** | **luck_debt_percentage** | **100** | **number** |
| **grayscale** | **anti_empty_percentage** | **100** | **number** |
| **grayscale** | **anti_high_percentage** | **100** | **number** |

### 6.3 ä¿®å¤ upsertConfig() æ–¹æ³•ï¼ˆB8 å‰ç½®ä¿®å¤ï¼‰

`LotteryStrategyConfig.upsertConfig()` çš„ `findOrCreate` where æ¡ä»¶å½“å‰ä»…å« `config_group + config_key + priority`ï¼Œç¼ºå°‘ `lottery_campaign_id`ã€‚PUT API æŒ‰æ´»åŠ¨æ›´æ–°é…ç½®å‰å¿…é¡»å…ˆä¿®å¤æ­¤æ–¹æ³•ï¼Œå¦åˆ™ä¼šè·¨æ´»åŠ¨è¦†ç›–ã€‚

ä¿®å¤æ–¹æ¡ˆï¼š`upsertConfig()` ç­¾åå¢åŠ  `lottery_campaign_id` å‚æ•°ï¼Œ`findOrCreate` where åŠ å…¥è¯¥å­—æ®µã€‚

### 6.4 CRUDService.createCampaign è‡ªåŠ¨æ’å…¥

åœ¨ `CRUDService.createCampaign()` ä¸­ï¼ˆç±»æ¯”å·²æœ‰çš„è‡ªåŠ¨åˆ›å»ºå®šä»·é…ç½® L157-208ï¼‰ï¼Œæ–°å»ºæ´»åŠ¨æ—¶è‡ªåŠ¨æ’å…¥ä¸Šè¿° 24 æ¡é»˜è®¤ç­–ç•¥é…ç½®è®°å½•ã€‚

**å¯å¤ç”¨æ¨¡å¼**ï¼š`CRUDService.js` å·²æœ‰è‡ªåŠ¨åˆ›å»º `LotteryCampaignPricingConfig` çš„é€»è¾‘ï¼ˆL157-208ï¼‰ï¼Œæ–°å¢ç­–ç•¥é…ç½®ç”¨åŒæ ·çš„ try-catch æ¨¡å¼ï¼Œåœ¨åŒä¸€äº‹åŠ¡å†…æ‰§è¡Œã€‚

---

## ä¸ƒã€æ”¹é€ åçš„æ´»åŠ¨é…ç½®èƒ½åŠ›çŸ©é˜µ

| # | ç­–ç•¥ | å¼€å…³ | å¯è°ƒå‚æ•° | é…ç½®ä½ç½® |
|---|------|------|---------|---------|
| 1 | ç”¨æˆ·åˆ†ç¾¤ | é€‰æ‹©ç‰ˆæœ¬ | default/v1/v2/v3/v4 | `lottery_campaigns.segment_resolver_version` |
| 2 | é¢„ç®—åˆ†å±‚ | é€‰æ‹©æ¨¡å¼ | user/pool/none | `lottery_campaigns.budget_mode` |
| 2 | é¢„ç®—åˆ†å±‚ | è°ƒé˜ˆå€¼ | B1/B2/B3 é˜ˆå€¼ | `lottery_strategy_config.budget_tier.*` |
| 3 | æ´»åŠ¨å‹åŠ› | enabled | P1/P2 é˜ˆå€¼ | `lottery_strategy_config.pressure_tier.*` |
| 4 | BxPx çŸ©é˜µ | enabled | 12 æ ¼ä¹˜æ•°çŸ©é˜µ | `lottery_strategy_config.matrix.*` + `lottery_tier_matrix_config` |
| 5 | Pity ä¿åº• | enabled | è½¯ç¡¬ä¿åº•é˜ˆå€¼ã€å€æ•°è¡¨ | `lottery_strategy_config.pity.*` |
| 6 | è¿æ°”å€ºåŠ¡ | enabled | æœŸæœ›ç©ºå¥–ç‡ã€æœ€å°æ ·æœ¬é‡ | `lottery_strategy_config.luck_debt.*` |
| 7 | é˜²è¿ç©º | enabled | è¿ç»­ç©ºå¥–é˜ˆå€¼ | `lottery_strategy_config.anti_empty.*` |
| 8 | é˜²è¿é«˜ | enabled | ç»Ÿè®¡çª—å£ã€è§¦å‘é˜ˆå€¼ | `lottery_strategy_config.anti_high.*` |
| 9 | ç®¡ç†å¹²é¢„ | enabled | â€” | `lottery_strategy_config.management.enabled` |
| 10 | ç°åº¦å‘å¸ƒ | å„ç­–ç•¥ç™¾åˆ†æ¯” | 0~100 | `lottery_strategy_config.grayscale.*` |

---

## å…«ã€åç«¯ API è®¾è®¡ï¼ˆä»¥åç«¯æŠ€æœ¯ä½“ç³»ä¸ºå‡†ï¼‰

### 8.1 ç°æœ‰ API è·¯ç”±è§„èŒƒ

é¡¹ç›® API ç‰ˆæœ¬ `/api/v4/`ï¼Œç®¡ç†åå°èµ° `/api/v4/console/`ã€‚ç°æœ‰ç›¸å…³è·¯ç”±æ–‡ä»¶ï¼š
- `routes/v4/console/lottery-campaigns.js` â€” æ´»åŠ¨ CRUD
- `routes/v4/console/lottery-management/interventions.js` â€” å¹²é¢„è§„åˆ™ç®¡ç†
- `routes/v4/console/lottery-management/pricing-config.js` â€” å®šä»·é…ç½®
- `routes/v4/console/lottery-configs.js` â€” å·²æœ‰é…ç½®ç›¸å…³è·¯ç”±
- `routes/v4/console/feature-flags.js` â€” Feature Flag ç®¡ç†

è·¯ç”±å±‚æ¶æ„è§„èŒƒï¼ˆä» `interventions.js` å®æŸ¥ï¼‰ï¼š
- é€šè¿‡ `req.app.locals.services.getService('xxx')` è·å– Service
- æŸ¥è¯¢æ“ä½œç”¨ QueryServiceï¼Œå†™æ“ä½œç”¨ CoreService
- å†™æ“ä½œé€šè¿‡ `TransactionManager` ç»Ÿä¸€ç®¡ç†äº‹åŠ¡
- ä½¿ç”¨ `adminAuthMiddleware` / `adminOpsAuthMiddleware` é‰´æƒ
- è·¯ç”±å±‚ç¦æ­¢ç›´æ¥ `require models`

`lottery_strategy_config` è¡¨å·²æœ‰ Sequelize æ¨¡å‹ï¼ˆå« `getAllConfig`ã€`upsertConfig`ã€`getParsedValue` ç­‰æ–¹æ³•ï¼‰ä½†æ— ç‹¬ç«‹è·¯ç”±ã€‚

### 8.2 æ–°å¢ API ç«¯ç‚¹

åŸºäºåç«¯ RESTful èµ„æºè®¾è®¡å’Œç°æœ‰è·¯ç”±æ¶æ„è§„èŒƒï¼Œæ–°å¢ä»¥ä¸‹ç«¯ç‚¹ã€‚å®ç°æ–¹å¼äºŒé€‰ä¸€ï¼ˆå‡ç¬¦åˆé¡¹ç›®ç°æœ‰æ¨¡å¼ï¼‰ï¼š

- **æ–¹æ¡ˆ A**ï¼šåœ¨ `routes/v4/console/lottery-campaigns.js` å†…æ–°å¢å­è·¯ç”±ï¼ˆä¸ pricing-config æ¨¡å¼ä¸€è‡´ï¼‰
- **æ–¹æ¡ˆ B**ï¼šæ–°å»º `routes/v4/console/lottery-strategy-config.js`ï¼ˆä¸ lottery-configs.js æ¨¡å¼ä¸€è‡´ï¼‰

å»ºè®®æ–¹æ¡ˆ Aï¼ˆç­–ç•¥é…ç½®æ˜¯æ´»åŠ¨çš„å­èµ„æºï¼ŒRESTful è¯­ä¹‰æ›´æ¸…æ™°ï¼‰ã€‚

**GET `/api/v4/console/lottery-campaigns/:lottery_campaign_id/strategy-config`**

æŸ¥è¯¢æŸæ´»åŠ¨çš„å…¨éƒ¨ç­–ç•¥é…ç½®ã€‚Service å±‚è°ƒç”¨ `LotteryStrategyConfig.getAllConfig(lottery_campaign_id)`ã€‚

è·¯ç”±å±‚å®ç°éµå¾ªæ¶æ„è§„èŒƒï¼ˆè¯»æ“ä½œæ”¶å£åˆ° QueryServiceï¼Œé€šè¿‡ ServiceManager è·å–ï¼‰ï¼š
```
router.get('/:lottery_campaign_id/strategy-config',
  authenticateToken, requireRoleLevel(100),
  async (req, res) => {
    const queryService = req.app.locals.services.getService('admin_lottery_query')
    const result = await queryService.getStrategyConfig(req.params.lottery_campaign_id)
    return res.apiSuccess(result)
  }
)
```

å“åº”æ ¼å¼ï¼ˆä½¿ç”¨åç«¯å­—æ®µåï¼Œå‰ç«¯ç›´æ¥é€‚é…ï¼‰ï¼š
```json
{
  "success": true,
  "code": "SUCCESS",
  "data": {
    "lottery_campaign_id": 1,
    "config": {
      "pity": { "enabled": true, "hard_guarantee_threshold": 10 },
      "anti_empty": { "enabled": true, "empty_streak_threshold": 3 },
      "pressure_tier": { "enabled": true, "threshold_high": 0.8 },
      "matrix": { "enabled": true },
      "management": { "enabled": true },
      "grayscale": { "pity_percentage": 100, "anti_empty_percentage": 100 }
    }
  }
}
```

**PUT `/api/v4/console/lottery-campaigns/:lottery_campaign_id/strategy-config`**

æ‰¹é‡æ›´æ–°æŸæ´»åŠ¨çš„ç­–ç•¥é…ç½®ã€‚Service å±‚ä½¿ç”¨ä¿®å¤åçš„ `LotteryStrategyConfig.upsertConfig()`ï¼ˆå« `lottery_campaign_id`ï¼‰+ `TransactionManager.execute()` äº‹åŠ¡ã€‚æ›´æ–°åè°ƒç”¨ `DynamicConfigLoader.clearCache(lottery_campaign_id)` æ¸…é™¤è¯¥æ´»åŠ¨ç¼“å­˜ã€‚

è¯·æ±‚ä½“ï¼š
```json
{
  "config": {
    "pity": { "enabled": false },
    "anti_empty": { "enabled": true, "empty_streak_threshold": 5 },
    "grayscale": { "pity_percentage": 50 }
  }
}
```

### 8.3 å‰ç«¯é€‚é…è¦æ±‚

Web ç®¡ç†åå°å‰ç«¯ç›´æ¥ä½¿ç”¨åç«¯å­—æ®µåï¼ˆ`lottery_campaign_id`, `config_group`, `config_key`, `enabled`, `empty_streak_threshold` ç­‰ï¼‰ï¼Œä¸åšæ˜ å°„ã€‚å‰ç«¯ API è°ƒç”¨å‚è€ƒç°æœ‰ `admin/src/modules/lottery/composables/campaigns.js` ä¸­çš„ fetch å°è£…æ¨¡å¼å’Œ `LOTTERY_ENDPOINTS` å¸¸é‡ã€‚

---

## ä¹ã€Web ç®¡ç†åå°å‰ç«¯æ‰§è¡Œæ­¥éª¤

### 9.1 æŠ€æœ¯æ ˆåŒ¹é…åº¦

| éœ€æ±‚ | ç°æœ‰æŠ€æœ¯æ ˆæ”¯æ’‘ | å¯å‚è€ƒçš„ç°æœ‰æ–‡ä»¶ |
|------|--------------|---------------|
| ç­–ç•¥é…ç½®é¡µé¢ | Alpine.js composable + Tailwind CSS | `lottery-management.js` é¡µé¢æ¨¡å¼ |
| API è°ƒç”¨ | `LOTTERY_ENDPOINTS` + fetch å°è£… | `campaigns.js` composable çš„ API è°ƒç”¨æ¨¡å¼ |
| æ´»åŠ¨é€‰æ‹©å™¨ | `useCampaignsState()` å·²æœ‰æ´»åŠ¨åˆ—è¡¨åŠ è½½ | `campaigns.js` L18-76 |
| è¡¨å•ç»„ä»¶ | Tailwind CSS è¡¨å• + Alpine.js `x-model` | ç°æœ‰ç¼–è¾‘è¡¨å•ï¼ˆcampaignForm æ¨¡å¼ï¼‰ |
| å¼€å…³åˆ‡æ¢ | Alpine.js å“åº”å¼ `x-model` + toggle | å·²æœ‰ `guarantee_enabled` å¼€å…³å¯å‚è€ƒ |
| åˆ†ç»„å±•ç¤º | Tailwind CSS grid/flex + Alpine.js `x-show` | ç°æœ‰å¤š tab é¡µé¢æ¨¡å¼ |

å®Œå…¨ç¬¦åˆ Web å‰ç«¯ç°æœ‰æŠ€æœ¯æ ˆï¼ˆVite 6.4 + Alpine.js 3.15 + Tailwind CSS 3.4ï¼‰ï¼Œæ— éœ€å¼•å…¥æ–°ä¾èµ–ã€‚

### 9.2 å‰ç«¯æ‰§è¡Œæ­¥éª¤

1. **æ–°å»º composable** `admin/src/modules/lottery/composables/strategy-config.js`
   - å‚è€ƒ `campaigns.js` çš„ composable æ¨¡å¼
   - å¯¼å‡º `useStrategyConfigState()` å’Œæ“ä½œæ–¹æ³•
   - è°ƒç”¨ GET/PUT `/api/v4/console/lottery-campaigns/:id/strategy-config`
   - ç›´æ¥ä½¿ç”¨åç«¯å­—æ®µåï¼ˆ`config_group`, `config_key`, `enabled` ç­‰ï¼‰

2. **æ–°å»ºé¡µé¢** `admin/src/modules/lottery/pages/lottery-strategy-config.js`
   - Alpine.js `Alpine.data()` æ³¨å†Œï¼Œå‚è€ƒ `lottery-management.js`
   - å¤ç”¨ `useCampaignsState()` çš„æ´»åŠ¨åˆ—è¡¨åšæ´»åŠ¨é€‰æ‹©
   - 10 ç­–ç•¥åˆ†ç»„å±•ç¤ºï¼Œæ¯ç»„ä¸€ä¸ª enabled å¼€å…³ + å‚æ•°é…ç½®åŒº

3. **æ–°å»º HTML å…¥å£** `admin/lottery-strategy-config.html`
   - å‚è€ƒç°æœ‰ `admin/lottery-management.html` çš„ HTML ç»“æ„
   - ä½¿ç”¨ Tailwind CSS è¡¨å•å¸ƒå±€

4. **åœ¨æ´»åŠ¨ç®¡ç†é¡µå¢åŠ å…¥å£** â€” æ´»åŠ¨åˆ—è¡¨æ“ä½œåˆ—åŠ "ç­–ç•¥é…ç½®"æŒ‰é’®é“¾æ¥åˆ°æ–°é¡µé¢

---

## åã€å®æ–½é¡ºåº

| é˜¶æ®µ | å†…å®¹ | æ¶‰åŠæ–‡ä»¶ | å½’å± | é¢„ä¼° |
|------|------|---------|------|------|
| P1 | DynamicConfigLoader `getValue` ç­¾å + ç¼“å­˜ Map åŒ– + `clearCache(campaign_id)` | `StrategyConfig.js` L848, L635-644, L884-889 | åç«¯ | 0.5 å¤© |
| P1b | **ä¿®å¤ `upsertConfig()` where æ¡ä»¶åŠ  `lottery_campaign_id`ï¼ˆB8ï¼‰** | `LotteryStrategyConfig.js` L183-218 | åç«¯ | 0.5 å°æ—¶ |
| P2 | TierPickStage ä¼ å…¥æ´»åŠ¨ IDï¼ˆç­–ç•¥ 3/4ï¼‰ | `TierPickStage.js` L252, L272 | åç«¯ | 0.5 å°æ—¶ |
| P3 | LotteryComputeEngine å¼€å…³é“¾è·¯æ”¹é€ ï¼ˆç­–ç•¥ 5/6/7/8ï¼‰â€” æ‹† `enable_anti_streak` + DB è¯»å– + åºŸå¼ƒå¦ä¸¤ç‰ˆæœ¬ï¼ˆB9ï¼‰ | `LotteryComputeEngine.js` L378-500, L1012, L1159 | åç«¯ | 0.5 å¤© |
| P4 | ç®¡ç†å¹²é¢„ï¼š`lottery_management_settings` åŠ åˆ— + `_checkOverride` æ”¹é€  + æ€»å¼€å…³ + **4 æ¡ active è®°å½•è¿ç§»** | `LotteryManagementSetting.js` + `LoadDecisionSourceStage.js` L215 | åç«¯ | 1 å¤© |
| P5 | ç°åº¦å‘å¸ƒæ´»åŠ¨çº§é…ç½®ï¼ˆç­–ç•¥ 10ï¼‰ | `StrategyConfig.js` L341-380, L493 + `LotteryComputeEngine.js` | åç«¯ | 0.5 å¤© |
| P6 | æ•°æ®è¿ç§» + CRUDService è‡ªåŠ¨æ’å…¥é»˜è®¤é…ç½®ï¼ˆ24 æ¡/æ´»åŠ¨ï¼‰ | è¿ç§»æ–‡ä»¶ + `CRUDService.js` L157-208 | åç«¯ | 0.5 å¤© |
| P7 | åç«¯ APIï¼ˆGET/PUT strategy-configï¼‰åµŒå¥—åœ¨ç°æœ‰ `lottery-campaigns` è·¯ç”±ä¸‹ | `routes/v4/console/lottery-campaigns.js` æˆ–æ–°æ–‡ä»¶ | åç«¯ | 0.5 å¤© |
| P8 | Web å‰ç«¯ç­–ç•¥é…ç½®é¡µé¢ + ç®¡ç†å¹²é¢„æ´»åŠ¨é€‰æ‹© | `admin/src/modules/lottery/` | å‰ç«¯ | 1.5 å¤© |

**æ€»è®¡çº¦ 5.5 å¤©**ï¼ˆåç«¯ 4 å¤© + å‰ç«¯ 1.5 å¤©ï¼‰ã€‚P1+P1b æ˜¯æ‰€æœ‰é˜¶æ®µçš„å‰ç½®ä¾èµ–ã€‚P2-P5 äº’ç›¸ç‹¬ç«‹å¯å¹¶è¡Œã€‚P6 åœ¨åç«¯æ”¹é€ å®Œæˆåæ‰§è¡Œã€‚P7-P8 åœ¨ P6 å®Œæˆåå¹¶è¡Œå¼€å‘ã€‚

---

## åä¸€ã€3 é¡¹å†³ç­–çš„è¡Œä¸šå¯¹æ ‡åˆ†æä¸æœ€ç»ˆè£å®š

### å†³ç­– 1ï¼šç­–ç•¥ 9 ç®¡ç†å¹²é¢„â€”â€”æ–¹æ¡ˆ A vs B vs A+B

#### è¡Œä¸šå¦‚ä½•åš

**å¤§å‚ï¼ˆç¾å›¢/é˜¿é‡Œ/è…¾è®¯ï¼‰**ï¼š
- ç¾å›¢åˆ¸ç³»ç»Ÿã€é˜¿é‡ŒåŒ11çº¢åŒ…ã€è…¾è®¯æ¸¸æˆé“å…·â€”â€”å¹²é¢„è®°å½•**å¿…å®šç»‘å®šæ´»åŠ¨ç»´åº¦**ã€‚è¿è¥å¯ä»¥"åœ¨æ´»åŠ¨ A å¯¹ç”¨æˆ· X å¼ºåˆ¶å‘å¥–ï¼Œæ´»åŠ¨ B ä¸å—å½±å“"ã€‚è¿™æ˜¯åŸºæœ¬èƒ½åŠ›ã€‚
- åŒæ—¶æœ‰æ´»åŠ¨çº§æ€»å¼€å…³ï¼š"æµ‹è¯•æ´»åŠ¨å…³é—­å…¨éƒ¨å¹²é¢„"ã€‚
- æ•°æ®æ¨¡å‹ï¼š`intervention(user_id, campaign_id, type, expires_at)`ï¼Œä¸æœ¬é¡¹ç›®çš„ `lottery_management_settings` ç»“æ„å¯¹åº”ã€‚
- **ç»“è®ºï¼šå¤§å‚åšçš„æ˜¯ A+B åˆä½“**â€”â€”è¡¨ä¸Šæœ‰ `campaign_id`ï¼ˆæ–¹æ¡ˆ Bï¼‰ï¼Œé…ç½®ä¸Šæœ‰æ€»å¼€å…³ï¼ˆæ–¹æ¡ˆ Aï¼‰ã€‚

**æ¸¸æˆå…¬å¸ï¼ˆç±³å“ˆæ¸¸/ç½‘æ˜“/è‰è‰ä¸ï¼‰**ï¼š
- æŠ½å¡ gacha ç³»ç»Ÿçš„"GM æŒ‡ä»¤"ï¼ˆç®¡ç†å‘˜å¼ºåˆ¶å‘å¡ï¼‰**å¿…å®šæŒ‰å¡æ± éš”ç¦»**ã€‚åŸç¥æ¯ä¸ªå¡æ± æœ‰ç‹¬ç«‹çš„ä¿åº•è®¡æ•°å™¨å’Œå¹²é¢„è®°å½•ï¼Œä¸ä¼š"è§’è‰²æ± å¹²é¢„å½±å“æ­¦å™¨æ± "ã€‚
- æ¸¸æˆè¡Œä¸šæœ¯è¯­å« "banner-scoped intervention"ã€‚
- **ç»“è®ºï¼šä¸æ–¹æ¡ˆ B ä¸€è‡´**â€”â€”å¹²é¢„è®°å½•ç»‘å®šåˆ°å¡æ± ï¼ˆæ´»åŠ¨ï¼‰ã€‚

**å°å…¬å¸/åˆåˆ›**ï¼š
- å¾ˆå¤šä¸€å¼€å§‹åšæ–¹æ¡ˆ Aï¼ˆæ€»å¼€å…³ï¼‰å›¾å¿«ï¼Œä¸Šçº¿åå‘ç°"å…³äº†æŸä¸ªæ´»åŠ¨çš„å¹²é¢„ä¼šæŠŠå…¶ä»–æ´»åŠ¨çš„å¹²é¢„ä¹Ÿæä¹±"ï¼Œç„¶åå›å¤´æ”¹æ–¹æ¡ˆ Bï¼Œäº§ç”Ÿè¿ç§»æˆæœ¬ã€‚
- **ç»“è®ºï¼šå…ˆ A å B æ˜¯å…¸å‹çš„æŠ€æœ¯å€ºåŠ¡ç´¯ç§¯è·¯å¾„**ã€‚

**è™šæ‹Ÿç‰©å“äº¤æ˜“/äºŒæ‰‹å¹³å°**ï¼š
- è¿è¥å¹²é¢„ç²’åº¦æ›´ç»†â€”â€”æŒ‰äº¤æ˜“/è®¢å•çº§åˆ«ã€‚ä½†æœ€ä½ç»´åº¦ä¹Ÿæ˜¯"æ´»åŠ¨+ç”¨æˆ·"ã€‚

#### æœ¬é¡¹ç›®å®é™…æƒ…å†µ

| å› ç´  | å®é™…å€¼ |
|------|--------|
| `lottery_management_settings` æ´»è·ƒè®°å½• | **4 æ¡**ï¼ˆuser_id=31 force_winï¼Œç›®æ ‡ prize_id=9ï¼‰+ 43 expired + 16 used + 2893 cancelled |
| é¡¹ç›®æ˜¯å¦ä¸Šçº¿ | æœªä¸Šçº¿ |
| æ—§æ•°æ®è¿ç§»æˆæœ¬ | æä½ï¼ˆä»… 4 æ¡ active è®°å½•éœ€èµ‹å€¼ `lottery_campaign_id`ï¼Œç»ˆæ€è®°å½•ä¿æŒ NULLï¼‰ |
| `_checkOverride()` å‚æ•° `_lottery_campaign_id` | å·²é¢„ç•™ä½†æ•…æ„æœªä½¿ç”¨ï¼ˆä»£ç å·²ä¸ºæ–¹æ¡ˆ B ç•™å¥½äº†å£å­ï¼‰ |

#### æœ€ç»ˆè£å®šï¼šæ–¹æ¡ˆ Bï¼ˆæ”¹è¡¨ç»“æ„ï¼‰ï¼Œç†ç”±å¦‚ä¸‹

| ç»´åº¦ | æ–¹æ¡ˆ A æ€»å¼€å…³ | æ–¹æ¡ˆ B æ”¹è¡¨ç»“æ„ | **æ–¹æ¡ˆ B ä¸ºä»€ä¹ˆæ›´å¥½** |
|------|-------------|---------------|---------------------|
| æ•°æ®æ¨¡å‹å®Œæ•´æ€§ | âŒ å¹²é¢„è®°å½•ä»æ— æ´»åŠ¨ç»´åº¦ï¼Œæ•°æ®æ¨¡å‹æœ‰æ´ | âœ… å¹²é¢„è®°å½•å®Œæ•´ç»‘å®šæ´»åŠ¨ | ä¸ç•™åŠæˆå“ |
| è¿è¥èƒ½åŠ› | åªèƒ½"æ•´ä¸ªæ´»åŠ¨å…³å¹²é¢„" | "æ´»åŠ¨ A å¯¹ç”¨æˆ· X å¹²é¢„ï¼Œæ´»åŠ¨ B ä¸å¹²é¢„" | ç²¾ç¡®åº¦è´¨çš„åŒºåˆ« |
| è¿ç§»æˆæœ¬ | 0 | æä½ï¼ˆ4 æ¡ active è®°å½•èµ‹å€¼ï¼Œé¡¹ç›®æœªä¸Šçº¿ï¼‰ | **æˆæœ¬è¿‘ä¼¼** |
| é•¿æœŸç»´æŠ¤ | æœªæ¥éœ€æ±‚ä¸€æ¥è¿˜æ˜¯è¦æ”¹è¡¨ | ä¸€æ­¥åˆ°ä½ | é¿å…äºŒæ¬¡é‡æ„ |
| ä»£ç é¢„ç•™ | â€” | `_checkOverride` å·²æœ‰ `_lottery_campaign_id` å‚æ•° | **ä»£ç å·²é¢„ç•™æ¥å£** |
| è¡Œä¸šå¯¹é½ | åˆåˆ›å…¬å¸ä¸´æ—¶æ–¹æ¡ˆ | å¤§å‚+æ¸¸æˆè¡Œä¸šæ ‡å‡† | å¯¹æ ‡è¡Œä¸šæ ‡å‡† |

**è¿½åŠ ä¸€ä¸ªæ€»å¼€å…³**ï¼šæ–¹æ¡ˆ B å®æ–½åï¼Œåœ¨ `lottery_strategy_config` åŠ  `management.enabled` æ€»å¼€å…³ä½œä¸º"ä¾¿æ·å…¥å£"ï¼ˆç±»ä¼¼ Nginx çš„ `server_name` å’Œ `if` åŒæ—¶å­˜åœ¨ï¼‰ï¼Œè¿è¥å¯ä»¥ä¸€é”®å…³é—­æŸæ´»åŠ¨çš„å…¨éƒ¨å¹²é¢„ï¼Œä¸å¿…é€æ¡åˆ é™¤ã€‚è¿™æ˜¯ A+B åˆä½“ï¼Œä½†ä»¥ B ä¸ºæ ¹åŸºã€‚

**æ¶‰åŠæ”¹åŠ¨**ï¼š
- `lottery_management_settings` åŠ  `lottery_campaign_id` åˆ—ï¼ˆINT, NULL, ç´¢å¼•ï¼‰
- `LoadDecisionSourceStage._checkOverride()` å»æ‰ä¸‹åˆ’çº¿ï¼Œä¼ å…¥å¹¶ä½¿ç”¨ `lottery_campaign_id`
- ç®¡ç†åå°åˆ›å»ºå¹²é¢„æ—¶å¸¦ä¸Šæ´»åŠ¨ ID
- 4 æ¡ active è®°å½•è¿ç§»èµ‹å€¼ `lottery_campaign_id`ï¼ˆéœ€è¿è¥ç¡®è®¤æˆ–é»˜è®¤èµ‹å€¼æ´»åŠ¨ 1ï¼‰
- ç»ˆæ€å†å²è®°å½•ï¼ˆexpired/used/cancelledï¼‰`lottery_campaign_id` ä¿æŒ NULL
- `lottery_strategy_config` åŠ  `management.enabled` æ€»å¼€å…³ï¼ˆä¾¿æ·å…¥å£ï¼‰

---

### å†³ç­– 2ï¼šç­–ç•¥ 10 ç°åº¦å‘å¸ƒâ€”â€”æ–¹æ¡ˆ A vs B

#### è¡Œä¸šå¦‚ä½•åš

**å¤§å‚ç°åº¦å‘å¸ƒç³»ç»Ÿ**ï¼š
- é˜¿é‡Œçš„ ABTest å¹³å°ã€è…¾è®¯çš„è“ç›¾ã€Google çš„ Experimentsâ€”â€”è¿™äº›æ˜¯**ç³»ç»Ÿçº§**åŠŸèƒ½å¼€å…³ï¼Œç®¡çš„æ˜¯"æ–°åŠŸèƒ½ä¸Šçº¿æ—¶ç°åº¦æ”¾é‡"ã€‚
- ç‰¹ç‚¹ï¼šå…¨å±€ç»´åº¦ï¼ˆä¸æŒ‰ä¸šåŠ¡æ´»åŠ¨éš”ç¦»ï¼‰ï¼Œç”¨æˆ·å“ˆå¸Œåˆ†æ¡¶ï¼Œé•¿æœŸå­˜åœ¨ã€‚
- é€‚ç”¨åœºæ™¯ï¼šæ–°ç‰ˆ UI ç°åº¦ã€æ–°ç®—æ³• A/B æµ‹è¯•ã€‚

**æ¸¸æˆ gacha ç°åº¦**ï¼š
- æ¸¸æˆçš„"ä¿åº•ç°åº¦"æ˜¯**ä¸šåŠ¡é…ç½®**ï¼šæ¯ä¸ªå¡æ± æœ‰ç‹¬ç«‹çš„ä¿åº•æ¦‚ç‡ã€ç°åº¦æ¯”ä¾‹ã€‚
- å­˜åœ¨å¡æ± é…ç½®è¡¨é‡Œï¼ˆç­‰åŒäºæœ¬é¡¹ç›®çš„ `lottery_strategy_config`ï¼‰ï¼Œä¸åœ¨å…¨å±€åŠŸèƒ½å¼€å…³è¡¨é‡Œã€‚
- åŸå› ï¼šä¸åŒå¡æ± çš„ç°åº¦ç™¾åˆ†æ¯”ä¸åŒï¼Œæ˜¯è¿è¥æŒ‰æ´»åŠ¨è°ƒæ•´çš„ä¸šåŠ¡å‚æ•°ã€‚

**æœ¬é¡¹ç›®å®é™…æƒ…å†µ**ï¼š

| å› ç´  | å®é™…å€¼ |
|------|--------|
| `feature_flags` è¡¨ | âœ… å·²å­˜åœ¨ï¼Œæœ‰ `rollout_percentage`, `whitelist_user_ids` ç­‰å­—æ®µ |
| `feature_flags` è¡¨æ˜¯å¦æœ‰ `lottery_campaign_id` | âŒ æ²¡æœ‰â€”â€”åªæœ‰å…¨å±€ç»´åº¦ |
| ç°åº¦çš„æœ¬è´¨ | "æ´»åŠ¨ A çš„ Pity ç°åº¦ 50%ï¼Œæ´»åŠ¨ B çš„ Pity ç°åº¦ 100%"â€”â€”è¿™æ˜¯ä¸šåŠ¡é…ç½®ï¼Œä¸æ˜¯åŠŸèƒ½å¼€å…³ |
| `LotteryComputeEngine` å·²æœ‰ `checkFeatureWithFeatureFlag()` | âœ… å·²æ¥å…¥ï¼Œä½†ä½œä¸ºé™çº§å…œåº• |

#### æ ¸å¿ƒåŒºåˆ†ï¼šåŠŸèƒ½ç°åº¦ vs ä¸šåŠ¡ç°åº¦

| | åŠŸèƒ½ç°åº¦ï¼ˆfeature_flags é€‚åˆï¼‰ | ä¸šåŠ¡ç°åº¦ï¼ˆlottery_strategy_config é€‚åˆï¼‰ |
|---|---|---|
| ç»´åº¦ | å…¨å±€/ç”¨æˆ·çº§ | æ´»åŠ¨+ç”¨æˆ·çº§ |
| å˜æ›´é¢‘ç‡ | ä½ï¼ˆä¸Šçº¿æ—¶è®¾ä¸€æ¬¡ï¼‰ | é«˜ï¼ˆè¿è¥æŒ‰æ´»åŠ¨è°ƒæ•´ï¼‰ |
| ç”Ÿå‘½å‘¨æœŸ | ä¸´æ—¶ï¼ˆç°åº¦ç»“æŸååˆ é™¤ flagï¼‰ | æ°¸ä¹…ï¼ˆé…ç½®è·Ÿéšæ´»åŠ¨å­˜åœ¨ï¼‰ |
| ç®¡ç†ç•Œé¢ | å¼€å‘è€…/æŠ€æœ¯è¿è¥ | ä¸šåŠ¡è¿è¥ |
| **æœ¬é¡¹ç›®çš„ç°åº¦å±äº** | | âœ… è¿™æ˜¯ä¸šåŠ¡ç°åº¦ |

#### æœ€ç»ˆè£å®šï¼šæ–¹æ¡ˆ Aï¼ˆlottery_strategy_configï¼‰ï¼Œç†ç”±å¦‚ä¸‹

| ç»´åº¦ | æ–¹æ¡ˆ A strategy_config | æ–¹æ¡ˆ B FeatureFlagService | **æ–¹æ¡ˆ A ä¸ºä»€ä¹ˆæ›´å¥½** |
|------|----------------------|--------------------------|---------------------|
| æ´»åŠ¨éš”ç¦» | âœ… å¤©ç„¶æ”¯æŒï¼ˆ`lottery_campaign_id` åˆ—ï¼‰ | âŒ éœ€åŠ åˆ—æˆ–æ‰©å±• | é›¶æ”¹é€ æˆæœ¬ |
| åŠ è½½é“¾è·¯ | ä¸ç­–ç•¥ 3-8 å…±äº« `DynamicConfigLoader` | ç‹¬ç«‹çš„ Service è°ƒç”¨é“¾ | ä¸€å¥—ç¼“å­˜ã€ä¸€å¥— TTL |
| è¿è¥ç®¡ç† | ä¸å…¶ä»–ç­–ç•¥å‚æ•°åŒä¸€é¡µé¢é…ç½® | éœ€è¦ç‹¬ç«‹çš„ Feature Flag ç®¡ç†é¡µé¢ | è¿è¥ä½“éªŒä¸€è‡´ |
| `feature_flags` çš„æ­£ç¡®ç”¨é€” | â€” | ä¿ç•™ç»™"æ–°åŠŸèƒ½ä¸Šçº¿ç°åº¦"ï¼ˆå¦‚æ–°ç‰ˆæŠ½å¥–åŠ¨ç”»ã€æ–°ç‰ˆ UIï¼‰ | èŒè´£æ¸…æ™°ä¸æ··æ·† |
| ä»£ç å¤æ‚åº¦ | æ”¹ `isFeatureEnabledForContext()` åŠ  DB è¯»å– | `checkFeatureWithFeatureFlag()` å·²æœ‰ä½†éœ€æ‰©å±•æ´»åŠ¨ç»´åº¦ | æ–¹æ¡ˆ A æ”¹åŠ¨æ›´å°‘ |

**`feature_flags` è¡¨ä¿ç•™ç»™ç³»ç»Ÿçº§åŠŸèƒ½å¼€å…³**ï¼ˆå¦‚"æ˜¯å¦å¯ç”¨æ–°ç‰ˆæŠ½å¥–åŠ¨ç”»"ï¼‰ï¼Œä¸ç”¨æ¥å­˜ä¸šåŠ¡ç°åº¦å‚æ•°ã€‚ä¸¤ä¸ªç³»ç»Ÿå„å¸å…¶èŒã€‚

---

### å†³ç­– 3ï¼šanti_empty å’Œ anti_high æ˜¯å¦æ‹†åˆ†

#### è¡Œä¸šå¦‚ä½•åšâ€”â€”100% æ‹†åˆ†

**è¿™æ˜¯æ‰€æœ‰è¡Œä¸šçš„å…±è¯†ï¼Œæ²¡æœ‰äº‰è®®**ï¼š

| æœºåˆ¶ | ç›®çš„ | å—ç›Šæ–¹ | è¡Œä¸šæœ¯è¯­ |
|------|------|--------|---------|
| anti_emptyï¼ˆé˜²è¿ç©ºï¼‰ | ä¿æŠ¤ç”¨æˆ·ä½“éªŒï¼Œé˜²æ­¢"å¤ªå€’éœ‰" | ç”¨æˆ· | Pity / Bad Luck Protection |
| anti_highï¼ˆé˜²è¿é«˜ï¼‰ | ä¿æŠ¤å•†ä¸šæ¨¡å‹ï¼Œé˜²æ­¢"å¤ªå¹¸è¿"è€—å…‰é¢„ç®— | å¹³å° | Rate Limiter / Lucky Cap |

**ç”¨æˆ·ä¿æŠ¤ vs å¹³å°ä¿æŠ¤æ˜¯ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„ä¸šåŠ¡è¯‰æ±‚**ï¼š
- ç¾å›¢/é˜¿é‡Œï¼šé£æ§ï¼ˆé˜²è–…ç¾Šæ¯›ï¼‰å’Œä½“éªŒä¼˜åŒ–ï¼ˆå‘å®‰æ…°åˆ¸ï¼‰æ˜¯ä¸¤ä¸ªç‹¬ç«‹ç³»ç»Ÿ
- åŸç¥/FGOï¼šè½¯ä¿åº•ï¼ˆSoft Pityï¼‰å’Œå•æ—¥é«˜ä»·å€¼ä¸Šé™ï¼ˆDaily Capï¼‰ç‹¬ç«‹å¼€å…³
- æ‰€æœ‰æ¸¸æˆçš„è¿è¥åœºæ™¯ï¼š"VIP æ´»åŠ¨å…³é—­é˜²è¿é«˜ï¼ˆè®© VIP å°½æƒ…æŠ½ï¼‰ï¼Œä½†ä¿ç•™é˜²è¿ç©ºï¼ˆç¡®ä¿ä¸ä¼šå¤ªè¡°ï¼‰"

**æœ¬é¡¹ç›®æ•°æ®åº“å·²ç»æ‹†äº†**ï¼š
- `lottery_strategy_config` è¡¨ä¸­ `anti_empty.enabled` å’Œ `anti_high.enabled` æ˜¯ä¸¤æ¡ç‹¬ç«‹è®°å½•
- åªæ˜¯ä»£ç åˆå¹¶æˆäº† `enable_anti_streak` ä¸€ä¸ªå¼€å…³

#### æœ€ç»ˆè£å®šï¼šæ‹†åˆ†ï¼Œä»£ç å¯¹é½ DB

ä»£ç ä» `enable_anti_streak` æ‹†ä¸º `enable_anti_empty` + `enable_anti_high`ï¼Œä¸ DB çš„ `anti_empty.enabled` / `anti_high.enabled` ä¸€ä¸€å¯¹åº”ã€‚

---

### ä¸‰é¡¹å†³ç­–æ±‡æ€»

| å†³ç­– | è£å®š | æ ¸å¿ƒç†ç”± |
|------|------|---------|
| ç­–ç•¥ 9 ç®¡ç†å¹²é¢„ | **æ–¹æ¡ˆ Bï¼ˆæ”¹è¡¨ï¼‰+ A æ€»å¼€å…³ä½œä¾¿æ·å…¥å£** | é¡¹ç›®æœªä¸Šçº¿é›¶è¿ç§»æˆæœ¬ï¼Œä¸€æ­¥åˆ°ä½å¯¹é½è¡Œä¸šæ ‡å‡† |
| ç­–ç•¥ 10 ç°åº¦ | **æ–¹æ¡ˆ Aï¼ˆlottery_strategy_configï¼‰** | ä¸šåŠ¡ç°åº¦ä¸æ˜¯åŠŸèƒ½ç°åº¦ï¼Œfeature_flags è¡¨ç•™ç»™ç³»ç»Ÿçº§å¼€å…³ |
| anti_empty / anti_high | **æ‹†åˆ†** | DB å·²æ‹†ã€è¡Œä¸šå…±è¯†ã€ä¸šåŠ¡è¯‰æ±‚æœ¬è´¨ä¸åŒ |

---

## åäºŒã€éœ€è¦æ‹æ¿çš„å†³ç­–ï¼ˆ2 é¡¹ï¼‰

### å†³ç­– 4ï¼š4 æ¡ active force_win è®°å½•â€”â€”è¿ç§»æ—¶å¦‚ä½•å¤„ç†å†å²è¿è¥å¹²é¢„æ•°æ®

#### é—®é¢˜èƒŒæ™¯

æ”¹è¡¨åŠ  `lottery_campaign_id` åˆ—åï¼Œå·²æœ‰çš„ 4 æ¡ active force_win è®°å½•ï¼ˆuser_id=31ï¼Œç›®æ ‡ lottery_prize_id=9 "ä¹å…«æŠ˜åˆ¸"ï¼Œ2026-02-23 åˆ›å»ºï¼Œæ— è¿‡æœŸæ—¶é—´ï¼‰å¿…é¡»å†³å®šå¦‚ä½•èµ‹å€¼ã€‚è¿™æ˜¯æ•°æ®åº“ schema è¿ç§»çš„ç»å…¸é—®é¢˜ï¼š**æ–°å¢ NOT NULL è¯­ä¹‰çš„åˆ—ï¼Œæ—§è®°å½•æ€ä¹ˆåŠï¼Ÿ**

#### è¡Œä¸šå¦‚ä½•åš

**å¤§å‚ï¼ˆç¾å›¢/é˜¿é‡Œ/è…¾è®¯ï¼‰æ•°æ®è¿ç§»ç­–ç•¥**ï¼š
- å¤§è§„æ¨¡çº¿ä¸Šç³»ç»Ÿï¼ˆåƒä¸‡çº§è®°å½•ï¼‰ï¼šåˆ†ä¸‰é˜¶æ®µâ€”â€”å…ˆåŠ åˆ— NULL â†’ åå°è„šæœ¬é€æ‰¹å›å¡« â†’ ç¡®è®¤æ— è¯¯åæ”¹ NOT NULLã€‚éœ€è¦"å›å¡«çª—å£æœŸ"ï¼ŒæœŸé—´æ–°æ—§ä»£ç å¹¶å­˜ã€‚
- **ä½†è¿™å¥—æµç¨‹æ˜¯ç»™äº¿çº§åœ¨çº¿ç³»ç»Ÿè®¾è®¡çš„**ã€‚æ ¸å¿ƒè¯‰æ±‚æ˜¯"ä¸åœæœè¿ç§»"å’Œ"ç°åº¦å›æ»š"ã€‚
- ç¾å›¢æ´»åŠ¨ç³»ç»Ÿå¦‚æœè¦åšç±»ä¼¼è¿ç§»ï¼Œä¼šæœ‰ä¸“é—¨çš„æ•°æ®æ²»ç†å›¢é˜Ÿè·‘å›å¡«è„šæœ¬ï¼Œè€—æ—¶ä»¥å‘¨è®¡ã€‚

**æ¸¸æˆå…¬å¸ï¼ˆç±³å“ˆæ¸¸/ç½‘æ˜“/è‰è‰ä¸ï¼‰è¿ç§»ç­–ç•¥**ï¼š
- å¡æ± é‡æ„æ—¶çš„æ ‡å‡†åšæ³•ï¼š**åœæœç»´æŠ¤ + ä¸€æ¬¡æ€§è¿ç§»**ã€‚ç‰ˆæœ¬å¤§æ›´æ–°æ—¶ç›´æ¥æ¸…ç†æ—§æ•°æ®ã€‚
- åŸç¥æ¯æ¬¡å¤§ç‰ˆæœ¬æ›´æ–°æœ‰ 5-6 å°æ—¶ç»´æŠ¤çª—å£ï¼ŒæœŸé—´è·‘æ•°æ®è¿ç§»ã€‚
- å¯¹äºå°‘é‡"æ´»è·ƒ GM æŒ‡ä»¤"ï¼šç»´æŠ¤å…¬å‘Šæå‰é€šçŸ¥ï¼Œè¿ç§»åç”±è¿è¥é‡æ–°è®¾ç½®ã€‚
- **å°ä½“é‡æ•°æ®ä¸åšç²¾ç»†å›å¡«ï¼Œç›´æ¥æ¸…ç†é‡å»º**ã€‚

**å°å…¬å¸/åˆåˆ›äº§å“**ï¼š
- é¡¹ç›®æœªä¸Šçº¿é˜¶æ®µï¼š**ç›´æ¥ truncate æˆ– cancel æ—§æ•°æ®**ï¼Œé›¶æˆæœ¬ã€‚
- æ—©æœŸæµ‹è¯•æ•°æ®ä¸å…·å¤‡ç”Ÿäº§ä»·å€¼ï¼Œä¿ç•™åè€Œå¢åŠ è¿ç§»å¤æ‚åº¦ã€‚
- "ä¸è¦ä¸ºæµ‹è¯•æ•°æ®å†™ç”Ÿäº§çº§å›å¡«é€»è¾‘"æ˜¯åˆ›ä¸šå…¬å¸çš„å¸¸è§å‡†åˆ™ã€‚

**è™šæ‹Ÿç‰©å“äº¤æ˜“/äºŒæ‰‹å¹³å°**ï¼š
- Buff/C5/é—²é±¼ç­‰ï¼šäº¤æ˜“è®¢å•è¿ç§»æ—¶å¯¹"è¿›è¡Œä¸­çš„è®¢å•"ç‰¹æ®Šå¤„ç†â€”â€”è¦ä¹ˆç­‰è®¢å•å®Œç»“å†è¿ç§»ï¼Œè¦ä¹ˆå¼ºåˆ¶å…³é—­å¹¶é€€æ¬¾ã€‚
- æ ¸å¿ƒåŸåˆ™ï¼š**æ´»è·ƒçŠ¶æ€çš„è®°å½•è¦ä¹ˆæ˜ç¡®å½’å±ï¼Œè¦ä¹ˆç»ˆæ­¢**ï¼Œä¸ç•™"æ— ä¸»"çŠ¶æ€ã€‚

#### æœ¬é¡¹ç›®å®é™…æƒ…å†µ

| å› ç´  | å€¼ |
|------|-----|
| è®°å½•æ•°é‡ | ä»… 4 æ¡ activeï¼ˆä¸æ˜¯ 4 ä¸‡æ¡ï¼‰ |
| è®°å½•æ€§è´¨ | æµ‹è¯•æ•°æ®ï¼ˆuser_id=31ï¼ŒåŒä¸€ç”¨æˆ·è¿åˆ› 4 æ¡ï¼Œé—´éš”å‡ åˆ†é’Ÿï¼Œ2026-02-23 å½“å¤©åˆ›å»ºï¼‰ |
| é¡¹ç›®é˜¶æ®µ | æœªä¸Šçº¿ï¼Œæ— çœŸå®ç”¨æˆ· |
| å½“å‰å”¯ä¸€ active æ´»åŠ¨ | lottery_campaign_id=1 "é¤å…ç§¯åˆ†æŠ½å¥–" |
| å¯¹ä¸šåŠ¡çš„å½±å“ | è¿™ 4 æ¡è®°å½•è¢« cancel åï¼Œuser_id=31 ä¸‹æ¬¡æŠ½å¥–ä¸å†å¼ºåˆ¶ä¸­"ä¹å…«æŠ˜åˆ¸" |

#### ä¸‰ä¸ªæ–¹æ¡ˆå¯¹æ¯”

| ç»´åº¦ | A. èµ‹å€¼æ´»åŠ¨ 1 | B. è¿è¥ç¡®è®¤ | **C. å…¨éƒ¨ cancel** |
|------|-------------|-----------|-------------------|
| å¤æ‚åº¦ | ä½ï¼ˆä¸€è¡Œ SQLï¼‰ | é«˜ï¼ˆéœ€å»º"è¡¥å…¨"UIï¼‰ | æœ€ä½ï¼ˆä¸€è¡Œ SQLï¼‰ |
| æ•°æ®å‡†ç¡®æ€§ | æ¨æµ‹æ€§èµ‹å€¼ | 100% å‡†ç¡® | ä¸ä¿ç•™æ—§æ•°æ® |
| é€‚åˆé˜¶æ®µ | çº¿ä¸Šæœ‰çœŸå®å¹²é¢„æ—¶ | çº¿ä¸Šæœ‰é‡è¦å¹²é¢„æ—¶ | **æœªä¸Šçº¿/æµ‹è¯•æ•°æ®** |
| è¡Œä¸šå¯¹æ ‡ | å¤§å‚çº¿ä¸Šå›å¡« | å¤§å‚ç²¾ç»†åŒ–è¿ç§» | **æ¸¸æˆå…¬å¸/åˆ›ä¸šå…¬å¸æ ‡å‡†åšæ³•** |
| åç»­è´Ÿæ‹… | èµ‹å€¼å¯èƒ½é”™è¯¯ï¼Œéœ€éªŒè¯ | éœ€è¿è¥ä»‹å…¥ | é›¶è´Ÿæ‹… |

#### æœ€ç»ˆå»ºè®®ï¼šæ–¹æ¡ˆ Cï¼ˆcancel åé‡å»ºï¼‰

ç†ç”±ï¼š
1. 4 æ¡è®°å½•æ˜¯ 2026-02-23 å½“å¤©å¯†é›†åˆ›å»ºçš„æµ‹è¯•æ•°æ®ï¼Œä¸æ˜¯è¿è¥ç²¾å¿ƒè®¾ç½®çš„ä¸šåŠ¡é…ç½®
2. é¡¹ç›®æœªä¸Šçº¿ï¼Œæ²¡æœ‰çœŸå®ç”¨æˆ·ä¼šå—å½±å“
3. è¿ç§»è„šæœ¬ä¸­ `UPDATE lottery_management_settings SET status = 'cancelled' WHERE status = 'active'`ï¼Œä¸€è¡Œæå®š
4. æ–°ç®¡ç†åå°ä¸Šçº¿åï¼Œè¿è¥åœ¨å¸¦æ´»åŠ¨ ID çš„æ–° UI ä¸­é‡æ–°åˆ›å»ºâ€”â€”æ•°æ®ä»ä¸€å¼€å§‹å°±å¹²å‡€
5. **å¯¹æ ‡æ¸¸æˆè¡Œä¸šï¼šå¤§ç‰ˆæœ¬é‡æ„æ—¶æ¸…ç†æµ‹è¯•å¹²é¢„æ•°æ®æ˜¯æ ‡å‡†æ“ä½œ**

å¦‚æœ user_id=31 çš„å¹²é¢„ç¡®å®æœ‰æ„ä¹‰ï¼ˆä¸æ˜¯æµ‹è¯•ï¼‰ï¼Œé€‰æ–¹æ¡ˆ A ä¹Ÿå¯ä»¥â€”â€”é£é™©æä½ã€‚

---

### å†³ç­– 5ï¼šå†—ä½™ä»£ç â€”â€”ä¸‰ç‰ˆä½“éªŒå¹³æ»‘æ–¹æ³•æ˜¯å¦æœ¬æœŸç›´æ¥åˆ é™¤

#### é—®é¢˜èƒŒæ™¯

`LotteryComputeEngine.js` ä¸­å­˜åœ¨ä¸‰ç‰ˆä½“éªŒå¹³æ»‘æ–¹æ³•å’Œä¸‰ç‰ˆç°åº¦åˆ¤æ–­æ–¹æ³•ï¼š

| æ–¹æ³• | è¡Œå· | è°ƒç”¨è€… | çŠ¶æ€ |
|------|------|--------|------|
| `applyExperienceSmoothing()` | L378 | TierPickStage L365 | âœ… **pipeline å”¯ä¸€è°ƒç”¨** |
| `applyExperienceSmoothingWithGrayscale()` | L1012 | **æ— ** | ğŸ”´ æ­»ä»£ç  |
| `applyExperienceSmoothingWithFeatureFlag()` | L1159 | **æ— ** | ğŸ”´ æ­»ä»£ç  |
| `checkFeatureWithGrayscale()` | L995 | ä»…è¢« WithGrayscale ç‰ˆè°ƒç”¨ | ğŸ”´ é—´æ¥æ­»ä»£ç  |
| `checkFeatureWithFeatureFlag()` | L1128 | ä»…è¢« WithFeatureFlag ç‰ˆè°ƒç”¨ | ğŸ”´ é—´æ¥æ­»ä»£ç  |
| `getLuckDebtMultiplierWithFeatureFlag()` | L1263 | **æ— ** | ğŸ”´ æ­»ä»£ç  |

ä»£ç æœç´¢ç¡®è®¤ï¼šè¿™ 6 ä¸ªæ–¹æ³•é™¤äº†æ–‡ä»¶å†…éƒ¨äº’ç›¸å¼•ç”¨å’Œæµ‹è¯•æ–‡ä»¶å¤–ï¼Œ**é¡¹ç›®ä¸­æ— ä»»ä½•å¤–éƒ¨è°ƒç”¨**ã€‚

#### è¡Œä¸šå¦‚ä½•åš

**å¤§å‚ï¼ˆç¾å›¢/é˜¿é‡Œ/è…¾è®¯ï¼‰ä»£ç æ²»ç†ç­–ç•¥**ï¼š
- é˜¿é‡Œçš„ P3C è§„èŒƒï¼š**æœªè¢«ä½¿ç”¨çš„ä»£ç å¿…é¡»åˆ é™¤ï¼Œä¸å…è®¸ä»¥æ³¨é‡Šå½¢å¼ä¿ç•™**ã€‚ç†ç”±ï¼š"æ³¨é‡Šæ‰çš„ä»£ç æ¯”æ²¡æœ‰ä»£ç æ›´æœ‰å®³â€”â€”åæ¥è€…ä¸çŸ¥é“è¯¥æ¢å¤è¿˜æ˜¯è¯¥åˆ é™¤"ã€‚
- ç¾å›¢çš„ä»£ç å®¡æŸ¥ï¼š**dead code æ˜¯ P0 çº§ block é¡¹**ï¼Œåˆå¹¶å‰å¿…é¡»æ¸…ç†ã€‚
- è…¾è®¯çš„åšæ³•æ›´æ¿€è¿›ï¼šæœ‰ä¸“é—¨çš„ dead code æ£€æµ‹å·¥å…·ï¼ˆCodeDogï¼‰ï¼ŒCI/CD ç®¡çº¿ä¸­è‡ªåŠ¨æ‹¦æˆªã€‚
- **å¤§å‚å…±è¯†ï¼šdead code é›¶å®¹å¿**ã€‚

**æ¸¸æˆå…¬å¸ä»£ç ç®¡ç†**ï¼š
- ç±³å“ˆæ¸¸/è‰è‰ä¸ï¼š**ä¸»å¹²åˆ†æ”¯ç¦æ­¢ dead code**ã€‚å†å²å®ç°æ”¾ git å†å²é‡Œï¼Œä¸ç•™åœ¨ä»£ç ä¸­ã€‚
- ç½‘æ˜“ï¼šæœ‰"ä»£ç ç˜¦èº«"å­£åº¦ä»»åŠ¡ï¼Œä¸“é—¨æ¸…ç†åºŸå¼ƒä»£ç ï¼ŒæŒ‰åˆ é™¤è¡Œæ•°ç»Ÿè®¡æˆæœã€‚
- æ¸¸æˆè¡Œä¸šå°¤å…¶é‡è§†ä»£ç ä½“ç§¯â€”â€”å®¢æˆ·ç«¯åŒ…ä½“å¤§å°ç›´æ¥å½±å“ç”¨æˆ·ä¸‹è½½ç‡ã€‚æœåŠ¡ç«¯è™½ç„¶æ²¡è¿™ä¸ªé—®é¢˜ï¼Œä½†"è®¤çŸ¥è´Ÿæ‹…"æ˜¯å…±è¯†ç—›ç‚¹ã€‚

**å°å…¬å¸/åˆ›ä¸šå…¬å¸**ï¼š
- ä¸¤ç§æç«¯ï¼š
  - **å¥½çš„åšæ³•**ï¼šåˆ›ä¸šå…¬å¸ codebase å°ã€æ”¹åŠ¨å¿«ï¼Œdead code å‘ç°å³åˆ â€”â€”"æ˜å¤©è¿™æ®µä»£ç å°±æ²¡äººè®°å¾—äº†"ã€‚
  - **åçš„åšæ³•**ï¼šä¿ç•™"ä»¥å¤‡åç”¨"ï¼Œ6 ä¸ªæœˆåæ²¡äººçŸ¥é“è¿™æ®µä»£ç å¹²ä»€ä¹ˆï¼Œæ–°äººä»¥ä¸ºæ˜¯å…³é”®é€»è¾‘ä¸æ•¢åŠ¨ã€‚
- Dead code åœ¨å°å›¢é˜Ÿçš„å±å®³æ¯”å¤§å›¢é˜Ÿæ›´å¤§â€”â€”å› ä¸ºæ²¡æœ‰æ–‡æ¡£ã€æ²¡æœ‰ ownerã€æ²¡æœ‰ä¸Šä¸‹æ–‡ã€‚

**è™šæ‹Ÿç‰©å“äº¤æ˜“/äºŒæ‰‹å¹³å°**ï¼š
- æŠ€æœ¯æ ˆé€šå¸¸ä¹Ÿæ˜¯ Node.js + MySQLã€‚
- Buffï¼ˆå®Œç¾ä¸–ç•Œï¼‰ï¼šä»£ç å®¡æŸ¥ä¸­"æœªä½¿ç”¨çš„å‡½æ•°"æ˜¯å¿…é¡»ä¿®å¤çš„ lint è­¦å‘Šã€‚
- æ ‡å‡†åšæ³•ï¼š`eslint no-unused-vars` è§„åˆ™å¼ºåˆ¶æ‰§è¡Œï¼Œé…åˆ `no-unreachable` é˜²æ­¢æ­»è·¯å¾„ã€‚

#### æœ¬é¡¹ç›®å®é™…æƒ…å†µ

| å› ç´  | å€¼ |
|------|-----|
| æ–¹æ³•æ•°é‡ | 6 ä¸ªæ–¹æ³•ï¼Œçº¦ 350 è¡Œä»£ç  |
| å¤–éƒ¨è°ƒç”¨ | 0ï¼ˆä»…æ–‡ä»¶å†…äº’å¼• + æµ‹è¯•æ–‡ä»¶ï¼‰ |
| æµ‹è¯•æ–‡ä»¶ | `tests/unit/compute/LotteryComputeEngine.test.js` ä¸­æœ‰ `checkFeatureWithGrayscale/FeatureFlag` çš„æµ‹è¯•ç”¨ä¾‹ |
| é¡¹ç›®é˜¶æ®µ | æœªä¸Šçº¿ |
| Git å†å² | ä»£ç æœ‰ git è®°å½•ï¼Œåˆ é™¤åå¯ä»å†å²æ¢å¤ |
| æœ¬æœŸæ”¹é€ å½±å“ | æ”¹é€ å base ç‰ˆ `applyExperienceSmoothing` ç›´æ¥èµ° `DynamicConfigLoader` è·¯å¾„ï¼Œå¦å¤–ä¸¤ç‰ˆçš„ç°åº¦é€»è¾‘è¢« base ç‰ˆå®Œå…¨è¦†ç›– |

#### ä¸¤ä¸ªæ–¹æ¡ˆå¯¹æ¯”

| ç»´åº¦ | A. æ ‡è®° @deprecated | **B. ç›´æ¥åˆ é™¤** |
|------|-------------------|----------------|
| å³æ—¶æ•ˆæœ | ä»£ç ä»åœ¨ï¼Œå¢åŠ è®¤çŸ¥è´Ÿæ‹… | å‡å°‘ ~350 è¡Œï¼Œæ–‡ä»¶æ›´æ¸…æ™° |
| å®‰å…¨æ€§ | "å®‰å…¨"ä½†ä»·å€¼ä¸ºé›¶â€”â€”é¡¹ç›®æœªä¸Šçº¿ | åŒæ ·å®‰å…¨â€”â€”git å¯æ¢å¤ |
| è¡Œä¸šå¯¹æ ‡ | çº¿ä¸Šå¤§ç³»ç»Ÿçš„ä¿å®ˆåšæ³• | **å¤§å‚ P3C è§„èŒƒ + æ¸¸æˆè¡Œä¸šæ ‡å‡†** |
| å¯¹åç»­å¼€å‘çš„å½±å“ | åæ¥çš„å¼€å‘è€…ä¼šå›°æƒ‘"è¿™äº›æ–¹æ³•è¦ä¸è¦ç”¨" | ä»£ç å³æ–‡æ¡£â€”â€”ä¸å­˜åœ¨çš„æ–¹æ³•ä¸ä¼šé€ æˆå›°æƒ‘ |
| æµ‹è¯•æ–‡ä»¶ | éœ€ä¿ç•™å¯¹åº”æµ‹è¯•ï¼ˆå³ä½¿æ–¹æ³•ä¸ç”¨äº†ï¼‰ | åŒæ­¥åˆ é™¤æµ‹è¯•ï¼Œå‡å°‘ç»´æŠ¤è´Ÿæ‹… |
| é•¿æœŸç»´æŠ¤æˆæœ¬ | æ¯æ¬¡ review å¤š 350 è¡Œæ— ç”¨ä»£ç  | **é›¶è´Ÿæ‹…** |

#### æœ€ç»ˆå»ºè®®ï¼šæ–¹æ¡ˆ Bï¼ˆç›´æ¥åˆ é™¤ï¼‰

ç†ç”±ï¼š
1. **è¡Œä¸šå…±è¯†**ï¼šé˜¿é‡Œ P3Cã€ç¾å›¢ CodeDogã€è…¾è®¯ CIâ€”â€”å¤§å‚å¯¹ dead code é›¶å®¹å¿
2. **å®‰å…¨ä¿è¯**ï¼š`rg` æœç´¢å·²ç¡®è®¤æ— å¤–éƒ¨è°ƒç”¨ï¼Œgit å†å²å¯æ¢å¤
3. **é¡¹ç›®æœªä¸Šçº¿**ï¼šä¸å­˜åœ¨"çº¿ä¸Šå›æ»šé£é™©"
4. **æœ¬æœŸæ”¹é€ åå®Œå…¨å†—ä½™**ï¼šbase ç‰ˆ `applyExperienceSmoothing` èµ° `DynamicConfigLoader` è·¯å¾„åï¼Œå¦å¤–ä¸¤ç‰ˆçš„ç°åº¦/FeatureFlag é€»è¾‘å·²è¢«å®Œå…¨è¦†ç›–
5. **å‡å°‘è®¤çŸ¥è´Ÿæ‹…**ï¼š`LotteryComputeEngine.js` å½“å‰ 1297 è¡Œï¼Œåˆ é™¤åçº¦ 950 è¡Œï¼Œæ–‡ä»¶ç»“æ„æ›´æ¸…æ™°

åˆ é™¤æ¸…å•ï¼š
- `applyExperienceSmoothingWithGrayscale()` L1012-1141
- `applyExperienceSmoothingWithFeatureFlag()` L1159-1250
- `checkFeatureWithGrayscale()` L995-997
- `checkFeatureWithFeatureFlag()` L1128-1142
- `getLuckDebtMultiplierWithFeatureFlag()` L1263-1295
- å¯¹åº”æµ‹è¯•ç”¨ä¾‹ in `tests/unit/compute/LotteryComputeEngine.test.js`

---

### ä¸¤é¡¹å†³ç­–æ±‡æ€»

| å†³ç­– | å»ºè®®è£å®š | æ ¸å¿ƒç†ç”± | è¡Œä¸šå¯¹æ ‡ |
|------|---------|---------|---------|
| å†³ç­– 4ï¼š4 æ¡ active è®°å½• | **æ–¹æ¡ˆ Cï¼ˆcancel åé‡å»ºï¼‰** | æµ‹è¯•æ•°æ®æ— ç”Ÿäº§ä»·å€¼ï¼Œæœªä¸Šçº¿é›¶é£é™© | æ¸¸æˆå…¬å¸å¤§ç‰ˆæœ¬é‡æ„æ ‡å‡†æ“ä½œ |
| å†³ç­– 5ï¼š6 ä¸ªæ­»ä»£ç æ–¹æ³• | **æ–¹æ¡ˆ Bï¼ˆç›´æ¥åˆ é™¤ï¼‰** | è¡Œä¸šå…±è¯† dead code é›¶å®¹å¿ï¼Œgit å¯æ¢å¤ | é˜¿é‡Œ P3C + ç¾å›¢ CodeDog + æ¸¸æˆè¡Œä¸šç˜¦èº« |

**ä¸¤é¡¹å†³ç­–çš„å…±åŒé€»è¾‘**ï¼šé¡¹ç›®æœªä¸Šçº¿ â†’ æ²¡æœ‰çœŸå®ç”¨æˆ·/çœŸå®æ•°æ® â†’ ä¸éœ€è¦å¤§å‚"çº¿ä¸Šç³»ç»Ÿ"çš„ä¿å®ˆç­–ç•¥ â†’ ç”¨æœ€å¹²å‡€çš„æ–¹å¼ä¸€æ­¥åˆ°ä½ã€‚

---

## åä¸‰ã€éªŒæ”¶æ ‡å‡†

1. æ´»åŠ¨ 1 å…³é—­ Pityï¼Œæ´»åŠ¨ 26 å¼€å¯ Pity â†’ ä¸¤ä¸ªæ´»åŠ¨åŒæ—¶æŠ½å¥–ï¼ŒPity åªåœ¨æ´»åŠ¨ 26 ç”Ÿæ•ˆ
2. æ–°å»ºä¸€ä¸ªæ´»åŠ¨ï¼Œä¸åšä»»ä½•é…ç½® â†’ è‡ªåŠ¨æ‹¥æœ‰ 24 æ¡é»˜è®¤ç­–ç•¥é…ç½®è®°å½•ï¼ˆå…¨éƒ¨ enabled=trueï¼‰
3. ä¿®æ”¹æ´»åŠ¨ 1 `anti_empty.enabled=false` â†’ è¯¥æ´»åŠ¨ä¸å†è§¦å‘é˜²è¿ç©ºï¼Œå…¶ä»–æ´»åŠ¨ä¸å—å½±å“
4. å…³é—­æ´»åŠ¨ 1 ç®¡ç†å¹²é¢„ â†’ å³ä½¿ `lottery_management_settings` æœ‰è¯¥æ´»åŠ¨ + ç”¨æˆ·çš„ force_win è®°å½•ä¹Ÿä¸ç”Ÿæ•ˆ
5. è®¾ç½®æ´»åŠ¨ A ç°åº¦ `pity_percentage=50` â†’ çº¦ 50% ç”¨æˆ·åœ¨æ´»åŠ¨ A äº«å— Pityï¼Œæ´»åŠ¨ B ä¸å—å½±å“
6. Web ç®¡ç†åå°ç­–ç•¥é…ç½®é¡µé¢å¯æŸ¥çœ‹/ä¿®æ”¹æ¯ä¸ªæ´»åŠ¨çš„ 10 ç­–ç•¥å¼€å…³å’Œå‚æ•°
7. **B8 éªŒè¯**ï¼šæ´»åŠ¨ 1 å’Œæ´»åŠ¨ 26 åˆ†åˆ«è®¾ç½®ä¸åŒçš„ `pity.enabled` å€¼ â†’ `upsertConfig()` ä¸ä¼šç›¸äº’è¦†ç›–
8. **ç¼“å­˜éš”ç¦»éªŒè¯**ï¼šä¿®æ”¹æ´»åŠ¨ 1 é…ç½®å `clearCache(1)` â†’ æ´»åŠ¨ 26 çš„ç¼“å­˜ä¸å—å½±å“
