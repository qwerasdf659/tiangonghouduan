# 前端适配后端接口 - 修改清单

## 📋 文档信息

| 项目 | 内容 |
|------|------|
| **文档名称** | 前端适配后端接口修改清单（以后端为准） |
| **核心原则** | 后端数据库/API 为唯一标准，前端全面适配后端字段名和响应格式 |
| **创建日期** | 2026-02-15 |
| **后端地址** | `https://omqktqrtntnn.sealosbja.site` |
| **后端API版本** | `/api/v4/` |

---

## 一、结论：后端有1个bug，其余全部是前端问题

| 归属 | 数量 | 说明 |
|------|------|------|
| 🔴 后端bug | **1个** | `CustomerServiceSessionService.getSessionList()` 引用了不存在的字段 `message_id`，应为 `chat_message_id`，导致 DATABASE_ERROR |
| 🟡 前端适配 | **7项** | 前端设计的字段名/概念与后端实际不一致，需前端修改代码对齐后端 |

---

## 二、🔴 后端唯一需要修复的bug

### 文件：`services/CustomerServiceSessionService.js` 第191行

**现状**：

```javascript
// 第184-193行
if (include_last_message) {
  includeOptions.push({
    model: ChatMessage,
    as: 'messages',
    limit: 1,
    order: [['created_at', 'DESC']],
    required: false,
    attributes: ['message_id', 'content', 'sender_type', 'created_at']  // ← BUG: message_id 不存在
  })
}
```

**原因**：`chat_messages` 表的主键是 `chat_message_id`，不存在 `message_id` 字段。Sequelize 执行 SQL 时报 `Unknown column 'message_id'`，被 catch 后返回 DATABASE_ERROR。

**修复**：将 `message_id` 改为 `chat_message_id`。

**验证**：修复后 `GET /api/v4/system/chat/sessions` 将不再返回 500。

---

## 三、前端适配清单（共7项）

---

### 适配项 1：聊天会话列表 - 移除 `session_type` 概念

**接口**：`GET /api/v4/system/chat/sessions`

**问题**：前端设计了6种 `session_type`（customer-service、system-notify、ai-assistant 等），但后端 `customer_service_sessions` 表**没有 `session_type` 字段**。后端只有一个 `source` 字段（varchar 32）。

**后端 `customer_service_sessions` 表的真实字段**：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `customer_service_session_id` | bigint | 主键 |
| `user_id` | int | 用户ID |
| `admin_id` | int | 客服ID（可为null） |
| `status` | enum('waiting','assigned','active','closed') | 会话状态 |
| `source` | varchar(32) | 来源（实际值：mobile、system_notification） |
| `priority` | int | 优先级 |
| `last_message_at` | datetime | 最后消息时间 |
| `is_active_session` | tinyint(1) | 是否活跃 |
| `first_response_at` | datetime | 首次响应时间 |
| `created_at` | datetime | 创建时间 |
| `updated_at` | datetime | 更新时间 |

**后端实际返回的响应格式**：

```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "获取会话列表成功",
  "data": {
    "sessions": [
      {
        "customer_service_session_id": 1871,
        "user": { "user_id": 11493, "nickname": "张三", "mobile": "138****1234" },
        "admin": null,
        "status": "waiting",
        "priority": 1,
        "last_message_at": "2026-02-15T10:18:16+08:00",
        "created_at": "2026-02-15T02:06:52+08:00",
        "updated_at": "2026-02-15T02:18:16+08:00",
        "last_message": { "chat_message_id": 5756, "content": "你好", "sender_type": "user", "created_at": "..." },
        "unread_count": 3
      }
    ],
    "pagination": {
      "current_page": 1,
      "per_page": 10,
      "total_count": 15,
      "total_pages": 2
    }
  }
}
```

**前端需要修改**：

| 前端原有字段 | 后端实际字段 | 修改方式 |
|-------------|-------------|---------|
| `session_id` | `customer_service_session_id` | 直接使用后端字段名 |
| `session_type` | **不存在** | 删除前端 `session_type` 分发逻辑，改为直接渲染会话列表 |
| `last_message`（string） | `last_message`（object，含 `content` 字段） | 取 `last_message.content` 作为展示文本 |
| `unread_count` | `unread_count` | ✅ 一致，无需改 |
| `is_online` | **不存在** | 删除该字段的使用，后端不提供在线状态 |
| `last_update_time` | `updated_at` | 直接使用 `updated_at` |

**前端核心改动**：`pages/chat/chat.ts` 中的 `distributeSessionData()` 按 `session_type` 分发的逻辑应删除，改为直接使用 `sessions` 数组渲染列表。

---

### 适配项 2：扫码核销 - 参数名 `code` → `redeem_code`

**接口**：`POST /api/v4/shop/redemption/fulfill`

**后端实际要求的请求参数**：

```json
{
  "redeem_code": "XXXX-YYYY-ZZZZ"
}
```

前端原来传 `"code"`，后端接收的是 `"redeem_code"`。

**后端实际返回的响应格式**：

```json
{
  "success": true,
  "message": "核销成功",
  "data": {
    "order": {
      "order_id": "uuid-string",
      "item_instance_id": 123,
      "status": "fulfilled",
      "fulfilled_at": "2026-02-15T14:30:00+08:00",
      "redeemer_user_id": 31
    },
    "item_instance": {
      "item_instance_id": 123,
      "item_type": "prize",
      "name": "物品名称",
      "status": "used"
    },
    "redeemer": {
      "user_id": 31,
      "nickname": "商户昵称"
    }
  }
}
```

**前端需要修改**：

| 前端原有 | 后端实际 | 修改方式 |
|---------|---------|---------|
| 请求参数 `code` | 请求参数 `redeem_code` | 改参数名 |
| 响应 `data.item_name` | `data.item_instance.name` | 改取值路径 |
| 响应 `data.user_nickname` | `data.redeemer.nickname` | 改取值路径 |
| 响应 `data.redemption_order_id` | `data.order.order_id` | 改取值路径 |
| 响应 `data.fulfilled_at` | `data.order.fulfilled_at` | 改取值路径 |
| 错误码 `INVALID_CODE` | `BAD_REQUEST` | 对齐后端错误码 |
| 错误码 `CODE_EXPIRED` | `EXPIRED` | 对齐后端错误码 |
| 错误码 `CODE_ALREADY_USED` | `CONFLICT` | 对齐后端错误码 |

---

### 适配项 3：消费录入 - 获取用户信息接口字段

**接口**：`GET /api/v4/shop/consumption/user-info?qr_code=xxx&store_id=xxx`

此接口后端**已完整实现**，响应格式与前端期望基本一致：

```json
{
  "success": true,
  "message": "用户信息获取成功",
  "data": {
    "user_id": 123,
    "user_uuid": "uuid-string",
    "nickname": "张三",
    "mobile": "13800138000",
    "qr_code": "QRV2_..."
  }
}
```

**注意**：后端返回的 `mobile` 是**完整手机号**（未脱敏）。前端如需脱敏展示，应在前端侧做格式化处理。

**前端需要修改**：无（接口基本一致）。前端如需脱敏展示手机号，自行处理。

---

### 适配项 4：消费提交 - 响应字段名差异

**接口**：`POST /api/v4/shop/consumption/submit`

**后端实际返回的响应格式**：

```json
{
  "success": true,
  "message": "消费记录提交成功，等待审核",
  "data": {
    "record_id": 2039,
    "user_id": 31,
    "store_id": 7,
    "consumption_amount": 88.50,
    "points_to_award": 89,
    "status": "pending",
    "status_name": "待审核",
    "created_at": { "iso": "2026-02-02T03:17:19+08:00", "display": "2026-02-02 03:17:19" },
    "is_duplicate": false
  }
}
```

**前端需要修改**：

| 前端原有 | 后端实际 | 修改方式 |
|---------|---------|---------|
| `created_at`（string） | `created_at`（object，含 `iso` 和 `display`） | 取 `created_at.display` 或 `created_at.iso` |

其余字段（`record_id`、`points_to_award`、`status`、`status_name`）✅ 一致。

---

### 适配项 5：审批管理 - 路由参数 `:record_id` → `:id`

**涉及接口**：
- `POST /api/v4/console/consumption/approve/:id`（非 `:record_id`）
- `POST /api/v4/console/consumption/reject/:id`（非 `:record_id`）

**后端使用 `:id` 作为路由参数**，不是前端文档写的 `:record_id`。

**前端需要修改**：API 调用路径改为 `/approve/${record_id}` 和 `/reject/${record_id}`（URL 拼接的值不变，只是后端路由定义用的是 `:id`，对前端拼接无影响，确认前端不要用命名参数即可）。

---

### 适配项 6：审批管理 - 权限等级差异

**前端期望**：`role_level >= 40`（商家店长可审批）

**后端实际**：`role_level >= 100`（仅 admin 可审批）

这是后端的业务设计决策：

> console 域仅限 admin（role_level >= 100）访问，商家员工使用 /api/v4/shop/* 提交和查询消费，审核权限只开放给 admin。

**前端需要修改**：审批管理页面只对 admin 角色可见，非 admin 不展示该功能入口。

---

### 适配项 7：审批列表 - 响应字段名差异

**接口**：`GET /api/v4/console/consumption/pending?page=1&page_size=20`

后端通过 `ConsumptionQueryService.getPendingConsumptionRecords()` 返回数据，使用 `ConsumptionRecord.toAPIResponse()` 格式化。

**后端实际返回每条记录的字段**：

```json
{
  "id": 2039,
  "record_id": 2039,
  "user_id": 31,
  "merchant_id": 31,
  "store_id": 7,
  "consumption_amount": 88.50,
  "points_to_award": 89,
  "status": "pending",
  "status_name": "待审核",
  "status_color": "warning",
  "qr_code": "QRV2_...",
  "merchant_notes": "备注",
  "admin_notes": null,
  "reviewed_by": null,
  "reviewed_at": null,
  "created_at": { "iso": "...", "display": "..." },
  "updated_at": { "iso": "...", "display": "..." },
  "user_mobile": "13800138000",
  "user_nickname": "张三",
  "anomaly_flags": [],
  "anomaly_score": 0,
  "is_anomaly": false
}
```

**前端需要修改**：

| 前端原有 | 后端实际 | 修改方式 |
|---------|---------|---------|
| `created_at`（string） | `created_at`（object，含 `iso`/`display`） | 取 `.display` 或 `.iso` |
| `user_mobile`（期望脱敏） | `user_mobile`（完整手机号） | 前端自行脱敏格式化 |

其余字段（`record_id`、`user_nickname`、`consumption_amount`、`points_to_award`、`merchant_notes`）✅ 一致。

---

## 四、后端真实数据库现状（2026-02-15 实时查询）

| 表名 | 记录数 | 说明 |
|------|--------|------|
| `users` | 60 | 用户表 |
| `customer_service_sessions` | 15 | 客服会话（source 值均为 system_notification） |
| `chat_messages` | 1,075 | 聊天消息 |
| `consumption_records` | 48 | 消费记录（pending:38, approved:10） |
| `redemption_orders` | 1,183 | 核销订单（pending:615, fulfilled:3, expired:564） |
| `stores` | 5 | 门店 |
| `store_staff` | 3 | 门店员工 |
| `roles` | 10 | 角色定义 |

### 后端角色体系（roles 表）

| role_id | role_name | role_level | 说明 |
|---------|-----------|------------|------|
| 1 | user | 0 | 普通用户 |
| 10 | merchant_staff | 20 | 商家员工 |
| 11 | merchant_manager | 40 | 商家店长 |
| 8 | sales_staff | 40 | 业务员 |
| 7 | business_manager | 60 | 业务经理 |
| 6 | regional_manager | 80 | 区域负责人 |
| 2 | admin | 100 | 管理员（全权限） |
| 9 | ops | 30 | 运营只读 |

---

## 五、后端接口已实现清单（确认全部存在）

| 接口 | 路由文件 | 状态 |
|------|---------|------|
| `GET /api/v4/system/chat/sessions` | `routes/v4/system/chat.js` | ✅ 已实现（修复bug后可用） |
| `POST /api/v4/system/chat/sessions` | `routes/v4/system/chat.js` | ✅ 已实现 |
| `GET /api/v4/system/chat/sessions/:id/messages` | `routes/v4/system/chat.js` | ✅ 已实现 |
| `POST /api/v4/system/chat/sessions/:id/messages` | `routes/v4/system/chat.js` | ✅ 已实现 |
| `POST /api/v4/shop/redemption/fulfill` | `routes/v4/shop/redemption/fulfill.js` | ✅ 已实现 |
| `GET /api/v4/shop/consumption/user-info` | `routes/v4/shop/consumption/qrcode.js` | ✅ 已实现 |
| `POST /api/v4/shop/consumption/submit` | `routes/v4/shop/consumption/submit.js` | ✅ 已实现 |
| `GET /api/v4/console/consumption/pending` | `routes/v4/console/consumption.js` | ✅ 已实现 |
| `POST /api/v4/console/consumption/approve/:id` | `routes/v4/console/consumption.js` | ✅ 已实现 |
| `POST /api/v4/console/consumption/reject/:id` | `routes/v4/console/consumption.js` | ✅ 已实现 |

---

## 六、前端修改优先级

| 优先级 | 修改项 | 工作量 |
|--------|--------|--------|
| **P0** | 聊天页面：删除 `session_type` 分发逻辑，直接使用 `sessions` 数组渲染；字段名改为 `customer_service_session_id`、`updated_at`；`last_message` 从 object 取 `.content` | 较大 |
| **P1** | 扫码核销：参数名 `code` → `redeem_code`；响应取值路径调整 | 小 |
| **P1** | 消费提交/审批列表：`created_at` 从 object 取 `.display` 或 `.iso` | 小 |
| **P2** | 审批管理：入口权限判断改为 `role_level >= 100` | 小 |
| **P2** | 手机号脱敏：前端自行格式化 `mobile.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2')` | 极小 |
