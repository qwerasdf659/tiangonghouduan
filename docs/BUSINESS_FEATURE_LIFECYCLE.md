# 业务功能生命周期管理规范

**创建时间**: 2025年01月21日  
**目的**: 防止出现VIP等过时功能的测试代码残留  

## 🎯 当前支持的业务功能清单

### ✅ 正式支持的功能模块

#### 1. 核心抽奖系统
- **抽奖策略**: 基础保底策略、管理策略  
- **抽奖引擎**: V4统一抽奖引擎
- **奖品管理**: 奖品池、中奖概率配置

#### 2. 积分系统
- **积分获得**: 任务完成、活动奖励
- **积分消费**: 抽奖消耗、商品兑换
- **积分查询**: 余额查询、交易历史

#### 3. 用户管理
- **角色系统**: admin(超级管理员)、user(普通用户)
- **认证系统**: 手机号验证码登录
- **权限管理**: 基于UUID角色的权限控制

#### 4. 库存系统
- **用户库存**: 奖品存储、使用、转让
- **核销码**: 生成、验证、使用

#### 5. 照片上传
- **Sealos对象存储**: 照片上传、缩略图生成
- **图片管理**: 存储、访问、删除

### ❌ 已废弃的功能模块

#### 1. VIP系统 (已完全废弃)
- **废弃日期**: 2025年01月15日
- **废弃原因**: 业务简化，统一使用基础权限系统
- **清理状态**: ✅ 测试代码已清理，模型关联待清理

#### 2. 多级权限系统 (已简化)
- **废弃日期**: 2025年01月10日  
- **废弃原因**: 复杂度过高，简化为admin/user两级
- **清理状态**: ✅ 大部分代码已清理

## 🔄 功能废弃标准流程

### 第1步：业务决策确认
1. **业务方确认**: 功能确实不再需要
2. **影响评估**: 评估废弃对现有用户的影响
3. **迁移方案**: 制定数据迁移和用户通知方案

### 第2步：代码系统性清理
1. **后端代码清理**:
   ```bash
   # 删除路由
   rm routes/v4/**/vip*.js
   
   # 删除服务
   rm services/**/vip*.js
   
   # 删除中间件
   rm middleware/**/vip*.js
   ```

2. **数据库结构清理**:
   ```sql
   -- 删除VIP相关表
   DROP TABLE IF EXISTS vip_levels;
   DROP TABLE IF EXISTS vip_benefits;
   
   -- 删除VIP相关字段
   ALTER TABLE users DROP COLUMN vip_level_id;
   ```

3. **测试代码清理**:
   ```bash
   # 搜索并删除VIP相关测试
   grep -r "VIP\|vip\|Vip" tests/ --include="*.js"
   
   # 删除相关测试文件
   rm tests/**/*vip*.test.js
   ```

### 第3步：模型和关联清理
1. **模型关联删除**:
   ```javascript
   // User.js 中删除VIP关联
   // VIP等级关联 - 已废弃
   // if (models.VipLevel) {
   //   User.belongsTo(models.VipLevel, {
   //     foreignKey: 'vip_level_id',
   //     as: 'vipLevel'
   //   })
   // }
   ```

2. **前端代码清理**:
   ```javascript
   // 删除VIP相关API调用
   // API.getVipStatus = async (userId) => { ... } // 已废弃
   ```

### 第4步：文档和配置更新
1. **API文档更新**: 移除废弃接口的文档
2. **业务文档更新**: 更新功能说明文档  
3. **配置文件清理**: 移除相关配置项

## 🚫 预防机制

### 1. 定期功能审查
- **频率**: 每季度一次
- **内容**: 审查所有业务功能的使用情况
- **决策**: 确定保留、简化或废弃功能

### 2. 测试代码同步检查
- **规则**: 任何业务功能变更都必须同步更新测试代码
- **检查**: 代码审查时强制检查测试代码的一致性
- **工具**: 建立自动化脚本检查测试代码与业务代码的匹配度

### 3. 代码清理自动化
```bash
#!/bin/bash
# 功能废弃清理脚本模板

FEATURE_NAME=$1
echo "开始清理功能: $FEATURE_NAME"

# 1. 搜索相关代码
echo "搜索相关代码文件..."
find . -name "*.js" -exec grep -l "$FEATURE_NAME" {} \;

# 2. 搜索相关测试
echo "搜索相关测试文件..."
find tests/ -name "*.js" -exec grep -l "$FEATURE_NAME" {} \;

# 3. 搜索数据库引用
echo "搜索数据库相关引用..."
grep -r "$FEATURE_NAME" models/ || true
grep -r "$FEATURE_NAME" migrations/ || true

echo "清理检查完成，请手动确认并删除相关代码"
```

## 📋 当前清理任务清单

### 🔴 紧急清理任务
- [ ] User模型中的vip_level_id字段关联
- [ ] 数据库中的VIP相关表结构  
- [ ] 可能残留的VIP相关配置

### 🟡 计划清理任务
- [ ] 审查其他可能废弃的功能模块
- [ ] 建立功能使用情况监控
- [ ] 制定功能废弃的标准流程

## 💡 最佳实践建议

### 1. 业务功能设计原则
- **最小可行功能**: 避免过度设计复杂功能
- **模块化设计**: 功能模块独立，便于废弃
- **向后兼容**: 考虑功能演进的兼容性

### 2. 测试代码管理原则  
- **业务驱动**: 测试代码必须反映实际业务需求
- **定期审查**: 定期检查测试代码的有效性
- **同步更新**: 业务变更时强制同步更新测试

### 3. 代码清理原则
- **彻底清理**: 废弃功能必须彻底清理，不留残留
- **分步实施**: 大功能废弃分步骤实施，降低风险
- **文档记录**: 详细记录废弃原因和清理过程

---

**核心原则**: 业务驱动、定期审查、彻底清理、预防为主 