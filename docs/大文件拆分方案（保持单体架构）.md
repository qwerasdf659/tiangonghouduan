# å¤§æ–‡ä»¶æ‹†åˆ†æ–¹æ¡ˆï¼ˆä¿æŒå•ä½“æ¶æ„ï¼‰

**åˆ›å»ºæ—¥æœŸ**ï¼š2026å¹´1æœˆ30æ—¥  
**æœ€åæ›´æ–°**ï¼š2026å¹´1æœˆ31æ—¥  
**èƒŒæ™¯**ï¼šé¡¹ç›®ä»£ç è§„æ¨¡åˆ†æå‘ç°å¤šä¸ªæœåŠ¡æ–‡ä»¶è¶…è¿‡1500è¡Œï¼Œå½±å“å¯ç»´æŠ¤æ€§  
**åŸåˆ™**ï¼šä¿æŒå•ä½“æ¶æ„ï¼Œé€šè¿‡æ–‡ä»¶æ‹†åˆ†é™ä½å•æ–‡ä»¶å¤æ‚åº¦
**å†³ç­–çŠ¶æ€**ï¼šâœ… å·²æ‹æ¿ç¡®è®¤ï¼ˆ2026-01-31ï¼‰

---

## 1. é¡¹ç›®è§„æ¨¡ç°çŠ¶

### 1.1 æ•´ä½“æ•°æ®

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| æœåŠ¡å±‚ä»£ç è¡Œæ•° | 7.5ä¸‡è¡Œ |
| æœåŠ¡æ–‡ä»¶æ•° | 103ä¸ª |
| è·¯ç”±æ–‡ä»¶æ•° | 119ä¸ª |
| æ•°æ®åº“è¿ç§»æ–‡ä»¶ | 166ä¸ª |

### 1.2 æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬/é…ç½® |
|------|----------|
| è¿è¡Œæ—¶ | Node.js 20+ |
| Webæ¡†æ¶ | Express 4.18 |
| ORM | Sequelize 6.35 |
| æ•°æ®åº“ | MySQL (mysql2) |
| ç¼“å­˜ | Redis (ioredis) |
| å®æ—¶é€šä¿¡ | Socket.io 4.8 |
| æ—¶åŒº | å…¨ç³»ç»ŸåŒ—äº¬æ—¶é—´ (+08:00) |

### 1.3 å¤§æ–‡ä»¶æ¸…å•ï¼ˆ2026-01-31 å®é™…ç»Ÿè®¡ï¼‰

| æ–‡ä»¶ | è¡Œæ•° | è¯„ä¼° | æ‹†åˆ†å†³ç­– |
|------|------|------|----------|
| LotteryAnalyticsService.js | 4,745 | âŒ ä¸¥é‡è¶…æ ‡ | âœ… **ç¡®è®¤æ‹†åˆ†** |
| AssetService.js | 2,371 | âŒ è¶…æ ‡ | âœ… **ç¡®è®¤æ‹†åˆ†** |
| MarketListingService.js | 2,295 | âŒ è¶…æ ‡ | âœ… **ç¡®è®¤æ‹†åˆ†** |
| ExchangeService.js | 1,874 | âš ï¸ åå¤§ | âœ… **ç¡®è®¤æ‹†åˆ†** |
| ConsumptionService.js | 1,826 | âš ï¸ åå¤§ | âœ… **ç¡®è®¤æ‹†åˆ†** |
| ReportingService.js | 1,820 | âš ï¸ åå¤§ | âœ… **ç¡®è®¤æ‹†åˆ†** |
| AdminLotteryService.js | 1,782 | âš ï¸ åå¤§ | âœ… **ç¡®è®¤æ‹†åˆ†** |

> **å†³ç­–ï¼ˆ2026-01-31ï¼‰**ï¼šä¸€æ¬¡æ€§å¤„ç†å…¨éƒ¨7ä¸ªå¤§æ–‡ä»¶ï¼Œå¹¶è¡Œæ‹†åˆ†ã€‚

### 1.4 æ˜¯å¦éœ€è¦å¾®æœåŠ¡æ‹†åˆ†ï¼Ÿ

**ç»“è®ºï¼šä¸éœ€è¦**

| ç»´åº¦ | åˆ†æ |
|------|------|
| å›¢é˜Ÿè§„æ¨¡ | å°å›¢é˜Ÿï¼Œå¾®æœåŠ¡å¢åŠ åä½œæˆæœ¬ |
| éƒ¨ç½²å¤æ‚åº¦ | å•ä½“éƒ¨ç½²æ›´ç®€å• |
| ä»£ç è€¦åˆåº¦ | ä¾èµ–å…³ç³»å¯æ§ï¼ˆæœ€å¤§10ä¸ªä¾èµ–ï¼‰ |
| å½“å‰é—®é¢˜æœ¬è´¨ | æ˜¯ä»£ç è´¨é‡é—®é¢˜ï¼Œä¸æ˜¯æ¶æ„é—®é¢˜ |

---

## 2. ç°æœ‰æœåŠ¡æ¶æ„åˆ†æ

### 2.1 æŠ½å¥–ç³»ç»ŸæœåŠ¡åˆ†å¸ƒ

é¡¹ç›®å·²å­˜åœ¨ä¸¤å¥—æŠ½å¥–ç›¸å…³æœåŠ¡ï¼ŒèŒè´£æ˜ç¡®åˆ†ç¦»ï¼š

```
services/
â”œâ”€â”€ lottery/                         # ğŸŸ¢ ç°æœ‰ï¼šæŠ½å¥–æ‰§è¡Œç›¸å…³ï¼ˆ2,086è¡Œï¼‰
â”‚   â”œâ”€â”€ index.js                     # æœåŠ¡å®¹å™¨ï¼ˆLotteryServiceContainerï¼‰
â”‚   â”œâ”€â”€ LotteryUserService.js        # ç”¨æˆ·æŠ½å¥–èµ„æ ¼éªŒè¯
â”‚   â”œâ”€â”€ LotteryHistoryService.js     # æŠ½å¥–å†å²æŸ¥è¯¢
â”‚   â”œâ”€â”€ LotteryQuotaService.js       # é…é¢ç®¡ç†
â”‚   â””â”€â”€ LotteryPricingService.js     # å®šä»·æœåŠ¡
â”‚
â”œâ”€â”€ UnifiedLotteryEngine/            # ğŸŸ¢ ç°æœ‰ï¼šæŠ½å¥–å¼•æ“ï¼ˆPipelineæ¶æ„ï¼‰
â”‚   â”œâ”€â”€ UnifiedLotteryEngine.js      # ç»Ÿä¸€å…¥å£
â”‚   â”œâ”€â”€ pipeline/                    # ç®¡çº¿ç¼–æ’
â”‚   â””â”€â”€ compute/                     # è®¡ç®—å¼•æ“
â”‚
â””â”€â”€ LotteryAnalyticsService.js       # ğŸ”´ å¾…æ‹†åˆ†ï¼šæŠ½å¥–åˆ†æç›‘æ§ï¼ˆ4,744è¡Œï¼‰
```

### 2.2 èŒè´£åŸŸåˆ’åˆ†

| æ¨¡å— | èŒè´£ | æ˜¯å¦æ‹†åˆ† |
|------|------|----------|
| `services/lottery/` | æŠ½å¥–æ‰§è¡Œï¼ˆèµ„æ ¼éªŒè¯ã€å†å²ã€é…é¢ã€å®šä»·ï¼‰ | å¦ |
| `UnifiedLotteryEngine/` | æŠ½å¥–å¼•æ“ï¼ˆPipelineã€å†³ç­–ã€ç»“ç®—ï¼‰ | å¦ |
| `LotteryAnalyticsService.js` | æŠ½å¥–åˆ†æï¼ˆç›‘æ§ã€ç»Ÿè®¡ã€æŠ¥è¡¨ï¼‰| **æ˜¯** |

**é‡è¦**ï¼š`LotteryAnalyticsService` ä¸ç°æœ‰ `services/lottery/` ç›®å½•ç›¸äº’ç‹¬ç«‹ï¼Œæ— ä¾èµ–å…³ç³»ã€‚

### 2.3 æœåŠ¡è°ƒç”¨æ¨¡å¼

æœ¬é¡¹ç›®ä½¿ç”¨**æœåŠ¡å®¹å™¨æ¨¡å¼**è¿›è¡ŒæœåŠ¡ç®¡ç†ï¼š

```javascript
// services/index.js - æœåŠ¡æ³¨å†Œ
this._services.set('lottery_analytics', new LotteryAnalyticsService(this.models))

// è·¯ç”±å±‚è°ƒç”¨æ–¹å¼
const service = req.app.locals.services.getService('lottery_analytics')
await service.getRealtimeOverview(campaignId)
```

---

## 3. æŠ€æœ¯æ¡†æ¶å¯¹é½åˆ†æ

> **æœ¬èŠ‚è¯´æ˜**ï¼šåŸºäºé¡¹ç›®å®é™…ä»£ç åˆ†æçš„æŠ€æœ¯æ¡†æ¶å’Œè®¾è®¡æ¨¡å¼ï¼Œç¡®ä¿æ‹†åˆ†æ–¹æ¡ˆä¸ç°æœ‰æ¶æ„ä¿æŒä¸€è‡´ã€‚

### 3.1 æœåŠ¡ç®¡ç†æ¶æ„

æœ¬é¡¹ç›®ä½¿ç”¨ **ServiceManager å•ä¾‹æ¨¡å¼** ç®¡ç†æ‰€æœ‰æœåŠ¡ï¼š

```javascript
// services/index.js - V4æœåŠ¡ç®¡ç†å™¨æ ¸å¿ƒæ¶æ„
class ServiceManager {
  constructor() {
    this.models = models
    this._services = new Map()  // ä½¿ç”¨Mapå­˜å‚¨æœåŠ¡å®ä¾‹
    this._initialized = false
  }

  async initialize() {
    // é™æ€ç±»æœåŠ¡ï¼šç›´æ¥æ³¨å†Œç±»
    this._services.set('asset', AssetService)
    this._services.set('exchange_market', ExchangeService)
    
    // å®ä¾‹åŒ–æœåŠ¡ï¼šéœ€è¦ä¼ å…¥ models
    this._services.set('lottery_analytics', new LotteryAnalyticsService(this.models))
    this._services.set('dictionary', new DictionaryService(this.models))
  }

  getService(name) {
    return this._services.get(name)
  }
}
```

**å…³é”®è®¾è®¡è§„èŒƒ**ï¼š
| è§„èŒƒé¡¹ | è¦æ±‚ |
|--------|------|
| æœåŠ¡é”®å‘½å | **snake_case**ï¼ˆå¦‚ `lottery_analytics`ã€`asset_balance`ï¼‰ |
| é™æ€ç±»æœåŠ¡ | ç›´æ¥æ³¨å†Œç±»å¼•ç”¨ï¼ˆå¦‚ `AssetService`ï¼‰ |
| å®ä¾‹åŒ–æœåŠ¡ | ä½¿ç”¨ `new Service(this.models)` |
| è·¯ç”±å±‚è®¿é—® | `req.app.locals.services.getService('service_key')` |

### 3.2 æœåŠ¡ç±»å‹åˆ†ç±»

é¡¹ç›®ä¸­å­˜åœ¨ä¸¤ç§æœåŠ¡å®ç°æ¨¡å¼ï¼š

#### é™æ€ç±»æœåŠ¡ï¼ˆAssetService æ¨¡å¼ï¼‰

```javascript
// services/AssetService.js - é™æ€æ–¹æ³•æ¨¡å¼
class AssetService {
  static async changeBalance(user_id, asset_code, delta_amount, options) { ... }
  static async freeze(user_id, asset_code, amount, options) { ... }
  static async mintItem(user_id, item_type, options) { ... }
}

// è°ƒç”¨æ–¹å¼
await AssetService.changeBalance(userId, 'PLATFORM_POINTS', 100, { transaction })
```

#### å®ä¾‹åŒ–æœåŠ¡ï¼ˆLotteryAnalyticsService æ¨¡å¼ï¼‰

```javascript
// services/LotteryAnalyticsService.js - å®ä¾‹æ–¹æ³•æ¨¡å¼
class LotteryAnalyticsService {
  constructor(models) {
    this.models = models
    this.logger = logger
  }
  async getRealtimeOverview(campaignId) { ... }
  async getUserProfile(userId) { ... }
}

// è°ƒç”¨æ–¹å¼
const service = new LotteryAnalyticsService(models)
await service.getRealtimeOverview(campaignId)
```

### 3.3 äº‹åŠ¡è¾¹ç•Œå¼ºåˆ¶æ£€æŸ¥ï¼ˆAssetService æ ¸å¿ƒæœºåˆ¶ï¼‰

AssetService ä½¿ç”¨ **äº‹åŠ¡è¾¹ç•Œå¼ºåˆ¶æ£€æŸ¥** ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼š

```javascript
// services/AssetService.js - äº‹åŠ¡è¾¹ç•Œæ£€æŸ¥å™¨
function checkTransactionBoundary(transaction, methodName) {
  if (!transaction) {
    const error = new Error(
      `[äº‹åŠ¡è¾¹ç•Œé”™è¯¯] ${methodName} å¿…é¡»åœ¨äº‹åŠ¡ä¸­è°ƒç”¨ã€‚\n` +
      'è¯·ä½¿ç”¨ TransactionManager.execute() åŒ…è£¹è°ƒç”¨ã€‚'
    )
    error.code = 'TRANSACTION_REQUIRED'
    throw error
  }
}

// åœ¨æ‰€æœ‰å†™æ“ä½œæ–¹æ³•ä¸­è°ƒç”¨
static async changeBalance(user_id, asset_code, delta_amount, options) {
  const { transaction } = options
  checkTransactionBoundary(transaction, 'AssetService.changeBalance')  // å¼ºåˆ¶æ£€æŸ¥
  // ... ä¸šåŠ¡é€»è¾‘
}
```

**æ²»ç†å†³ç­–ï¼ˆ2026-01-05ï¼‰**ï¼šè·¨è¡¨å†™å…¥æ–¹æ³•å¼ºåˆ¶è¦æ±‚äº‹åŠ¡è¾¹ç•Œï¼Œé˜²æ­¢éƒ¨åˆ†æˆåŠŸé£é™©ã€‚

### 3.4 æ‹†åˆ†åçš„æŠ€æœ¯å¯¹é½è¦æ±‚

#### LotteryAnalyticsService æ‹†åˆ†å¯¹é½

| åŸæœåŠ¡ | æœåŠ¡ç±»å‹ | æ‹†åˆ†åè¦æ±‚ |
|--------|----------|-----------|
| LotteryAnalyticsService | å®ä¾‹åŒ–æœåŠ¡ | å­æœåŠ¡ä¹Ÿä½¿ç”¨å®ä¾‹åŒ–æ¨¡å¼ï¼ˆéœ€è¦ models ä¾èµ–ï¼‰ |
| æœåŠ¡æ³¨å†Œé”® | `lottery_analytics` | æ‹†åˆ†ä¸º `lottery_analytics_realtime`ã€`lottery_analytics_statistics` ç­‰ï¼ˆä¸šåŠ¡åŸŸä¼˜å…ˆå‘½åï¼‰ |

```javascript
// æ‹†åˆ†å services/index.js æ³¨å†Œæ–¹å¼ï¼ˆä¸šåŠ¡åŸŸä¼˜å…ˆå‘½åï¼‰
const { RealtimeService, StatisticsService, ... } = require('./lottery-analytics')

this._services.set('lottery_analytics_realtime', new RealtimeService(this.models))
this._services.set('lottery_analytics_statistics', new StatisticsService(this.models))
this._services.set('lottery_analytics_report', new ReportService(this.models))
this._services.set('lottery_analytics_user', new UserAnalysisService(this.models))
this._services.set('lottery_analytics_campaign', new CampaignAnalysisService(this.models))
```

#### AssetService æ‹†åˆ†å¯¹é½

| åŸæœåŠ¡ | æœåŠ¡ç±»å‹ | æ‹†åˆ†åè¦æ±‚ |
|--------|----------|-----------|
| AssetService | é™æ€ç±»æœåŠ¡ | å­æœåŠ¡ä¹Ÿä½¿ç”¨é™æ€ç±»æ¨¡å¼ï¼ˆæ— çŠ¶æ€ä¾èµ–ï¼‰ |
| äº‹åŠ¡è¾¹ç•Œæ£€æŸ¥ | `checkTransactionBoundary()` | æå–ä¸ºå…±äº«æ¨¡å—ï¼Œæ‰€æœ‰å­æœåŠ¡å¼•ç”¨ |
| æœåŠ¡æ³¨å†Œé”® | `asset` | æ‹†åˆ†ä¸º `asset_balance`ã€`asset_item`ã€`asset_query`ï¼ˆä¸šåŠ¡åŸŸä¼˜å…ˆå‘½åï¼‰ |

```javascript
// æ‹†åˆ†å services/index.js æ³¨å†Œæ–¹å¼ï¼ˆä¸šåŠ¡åŸŸä¼˜å…ˆå‘½åï¼‰
const { BalanceService, ItemService, QueryService } = require('./asset')

this._services.set('asset_balance', BalanceService)  // é™æ€ç±»
this._services.set('asset_item', ItemService)        // é™æ€ç±»
this._services.set('asset_query', QueryService)      // é™æ€ç±»

// ä¸ä¿ç•™å…¼å®¹åˆ«åï¼ˆå†³ç­–4=Aï¼‰
```

### 3.5 UnifiedLotteryEngine ä¾èµ–åˆ†æ

AssetService è¢« UnifiedLotteryEngine çš„ Pipeline æ¶æ„æ·±åº¦ä¾èµ–ï¼š

```
UnifiedLotteryEngine/
â”œâ”€â”€ UnifiedLotteryEngine.js     â†’ AssetService.changeBalance()  (é¢„ç®—æ‰£å‡)
â”œâ”€â”€ pipeline/
â”‚   â””â”€â”€ stages/
â”‚       â””â”€â”€ SettleStage.js      â†’ AssetService.mintItem()       (å‘å¥–)
â”‚                               â†’ AssetService.changeBalance()  (ç§¯åˆ†ç»“ç®—)
â””â”€â”€ compute/
    â”œâ”€â”€ LotteryComputeEngine.js â†’ AssetService.getBalance()     (é¢„ç®—æŸ¥è¯¢)
    â”œâ”€â”€ UserBudgetProvider.js   â†’ AssetService.getAllBalances() (ä½™é¢æŸ¥è¯¢)
    â””â”€â”€ BudgetTierCalculator.js â†’ AssetService.getBalance()     (æ¡£ä½è®¡ç®—)
```

**æ‹†åˆ†å½±å“**ï¼š
- `SettleStage.js` éœ€è¦åŒæ—¶å¼•ç”¨ `BalanceService` å’Œ `ItemService`
- `LotteryComputeEngine.js` åªéœ€å¼•ç”¨ `QueryService`
- ä¿®æ”¹å·¥ä½œé‡å¯æ§ï¼ˆ5ä¸ªæ–‡ä»¶ï¼‰

---

## 4. é—¨é¢æ¨¡å¼å¿…è¦æ€§åˆ†æ

### 3.1 ä»€ä¹ˆæ˜¯é—¨é¢æ¨¡å¼ï¼Ÿ

é—¨é¢æ¨¡å¼ï¼ˆFacade Patternï¼‰æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œæä¾›ä¸€ä¸ªç»Ÿä¸€çš„é«˜å±‚æ¥å£ï¼Œä½¿å­ç³»ç»Ÿæ›´æ˜“ä½¿ç”¨ã€‚

**åœ¨æœ¬é¡¹ç›®çš„åº”ç”¨åœºæ™¯**ï¼š
- æ‹†åˆ†åçš„å­æœåŠ¡ï¼ˆå¦‚ `LotteryRealtimeService`ã€`AssetBalanceService`ï¼‰æ˜¯"å­ç³»ç»Ÿ"
- åŸæœåŠ¡ï¼ˆå¦‚ `LotteryAnalyticsService`ã€`AssetService`ï¼‰ä½œä¸º"é—¨é¢"
- é—¨é¢æŠŠè°ƒç”¨è½¬å‘åˆ°å¯¹åº”çš„å­æœåŠ¡

### 3.2 è°ƒç”¨æ–¹åˆ†æ

#### LotteryAnalyticsService è°ƒç”¨æ–¹ï¼ˆ5å¤„ï¼‰

| æ–‡ä»¶ | è°ƒç”¨æ–¹å¼ | è¯´æ˜ |
|------|----------|------|
| routes/v4/console/lottery-campaigns.js | ç›´æ¥å¼•ç”¨ | requireæ–¹å¼ |
| routes/v4/console/lottery-analytics.js | æœåŠ¡å®¹å™¨ | getServiceæ–¹å¼ |
| routes/v4/console/lottery-monitoring.js | æœåŠ¡å®¹å™¨ | getServiceæ–¹å¼ |
| routes/v4/console/lottery-strategy-stats.js | æœåŠ¡å®¹å™¨ | getServiceæ–¹å¼ |
| services/index.js | æœåŠ¡æ³¨å†Œ | å…¨éƒ¨å¯¼å‡º |

**åˆ†æç»“è®º**ï¼š4ä¸ªè·¯ç”±æ–‡ä»¶è°ƒç”¨ï¼Œå…¶ä¸­3ä¸ªé€šè¿‡æœåŠ¡å®¹å™¨ï¼Œè°ƒç”¨ç‚¹é›†ä¸­å¯æ§ã€‚

#### AssetService è°ƒç”¨æ–¹ï¼ˆ34å¤„ï¼‰

| ç±»åˆ« | æ–‡ä»¶æ•° | ä¸»è¦è°ƒç”¨æ–¹ |
|------|--------|------------|
| æœåŠ¡å±‚ | 17 | MarketListingService, TradeOrderService, ExchangeService ç­‰ |
| UnifiedLotteryEngine | 5 | UnifiedLotteryEngine.js, SettleStage.js, LotteryComputeEngine.js ç­‰ |
| è·¯ç”±å±‚ | 8 | console/accounts.js, assets/*.js, shop/*.js ç­‰ |
| ä»»åŠ¡å±‚ | 2 | jobs/hourly-*.js |
| æµ‹è¯•æ–‡ä»¶ | 4 | *.test.js |

**åˆ†æç»“è®º**ï¼š34å¤„è°ƒç”¨åˆ†å¸ƒå¹¿æ³›ï¼Œä½†éƒ½åœ¨å†…éƒ¨ä»£ç ä¸­ï¼Œå¯æ‰¹é‡æ›¿æ¢ã€‚

### 3.3 é—¨é¢ vs ç›´æ¥æ‹†åˆ†å¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **é—¨é¢æ¨¡å¼** | è°ƒç”¨æ–¹é›¶æ”¹åŠ¨ã€é£é™©ä½ã€æ¸è¿›å¼è¿ç§» | å¤šä¸€å±‚é—´æ¥è°ƒç”¨ã€ä»£ç å†—ä½™ã€é•¿æœŸç»´æŠ¤è´Ÿæ‹… | å¤–éƒ¨ APIã€éœ€è¦é•¿æœŸå…¼å®¹ |
| **ç›´æ¥æ‹†åˆ†** | ä»£ç ç®€æ´ã€æ— å†—ä½™è½¬å‘ã€ä¸€æ¬¡åˆ°ä½ | éœ€è¦æ‰¹é‡ä¿®æ”¹è°ƒç”¨æ–¹ | å†…éƒ¨æœåŠ¡ã€å°å›¢é˜Ÿã€è°ƒç”¨ç‚¹å¯æ§ |

### 3.4 æœ€ç»ˆå†³ç­–

#### LotteryAnalyticsService â†’ **ä¸éœ€è¦é—¨é¢ï¼Œç›´æ¥æ‹†åˆ†**

ç†ç”±ï¼š
- ä»… 4 ä¸ªè·¯ç”±æ–‡ä»¶è°ƒç”¨
- 3ä¸ªé€šè¿‡æœåŠ¡å®¹å™¨è°ƒç”¨ï¼Œåªéœ€æ›´æ–°æœåŠ¡æ³¨å†Œ
- ä¿®æ”¹å·¥ä½œé‡å°ï¼ˆçº¦ 1 å°æ—¶ï¼‰
- æ— å¤–éƒ¨ä¾èµ–æ–¹

#### AssetService â†’ **ä¸éœ€è¦é—¨é¢ï¼Œæ‰¹é‡æ›¿æ¢**

ç†ç”±ï¼š
- 34 å¤„è°ƒç”¨å…¨éƒ¨æ˜¯å†…éƒ¨ä»£ç 
- ä½¿ç”¨ IDE å…¨å±€æ›¿æ¢åŠŸèƒ½ï¼Œ2 å°æ—¶å†…å¯å®Œæˆ
- ä»£ç ç»“æ„æ›´æ¸…æ™°ï¼Œæ— è½¬å‘å±‚å¼€é”€

---

## 5. ä¸šç•Œè®¾è®¡æ¨¡å¼å¯¹æ¯”

### 5.1 å¤§å…¬å¸æ¨¡å¼ï¼ˆç¾å›¢ã€è…¾è®¯ã€é˜¿é‡Œï¼‰

**æ¶æ„ç‰¹ç‚¹**ï¼š
- **å¾®æœåŠ¡æ¶æ„**ï¼šæ¯ä¸ªæœåŠ¡ç‹¬ç«‹éƒ¨ç½²ã€ç‹¬ç«‹æ‰©å±•
- **API Gateway**ï¼šç»Ÿä¸€å…¥å£ï¼Œè·¯ç”±åˆ°åç«¯æœåŠ¡
- **æœåŠ¡æ³¨å†Œå‘ç°**ï¼šNacosã€Consulã€Eureka
- **åˆ†å¸ƒå¼äº‹åŠ¡**ï¼šSeataã€TCCã€SAGA

**æŠ€æœ¯æ ˆç¤ºä¾‹**ï¼š
```
ç”¨æˆ·è¯·æ±‚ â†’ API Gateway â†’ èµ„äº§æœåŠ¡ï¼ˆç‹¬ç«‹é›†ç¾¤ï¼‰
                        â†’ è®¢å•æœåŠ¡ï¼ˆç‹¬ç«‹é›†ç¾¤ï¼‰
                        â†’ åº“å­˜æœåŠ¡ï¼ˆç‹¬ç«‹é›†ç¾¤ï¼‰
```

**ä¼˜åŠ¿**ï¼š
- å¯ç‹¬ç«‹æ‰©å±•
- æ•…éšœéš”ç¦»
- å›¢é˜Ÿç‹¬ç«‹å¼€å‘

**ä»£ä»·**ï¼š
- è¿ç»´å¤æ‚åº¦é«˜
- éœ€è¦å¤§é‡åŸºç¡€è®¾æ–½
- åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†å›°éš¾
- éœ€è¦ä¸“èŒ DevOps å›¢é˜Ÿ

**é€‚ç”¨åœºæ™¯**ï¼šæ—¥æ´»ç™¾ä¸‡ä»¥ä¸Šã€50+ å¼€å‘äººå‘˜

### 5.2 ä¸­å‹å…¬å¸æ¨¡å¼

**æ¶æ„ç‰¹ç‚¹**ï¼š
- **æ¨¡å—åŒ–å•ä½“** æˆ– **è½»é‡çº§æœåŠ¡æ‹†åˆ†**
- å…³é”®æ¨¡å—ç‹¬ç«‹ï¼ˆå¦‚æ”¯ä»˜ã€è´¦æˆ·ï¼‰
- å…±äº«æ•°æ®åº“æˆ–è¯»å†™åˆ†ç¦»

**æŠ€æœ¯æ ˆç¤ºä¾‹**ï¼š
```
ç”¨æˆ·è¯·æ±‚ â†’ Nginx â†’ ä¸»åº”ç”¨ï¼ˆå¤§éƒ¨åˆ†é€»è¾‘ï¼‰
                  â†’ æ”¯ä»˜æœåŠ¡ï¼ˆæ ¸å¿ƒç‹¬ç«‹ï¼‰
                  â†’ å…±äº« MySQL + Redis
```

**ä¼˜åŠ¿**ï¼š
- éƒ¨ç½²ç›¸å¯¹ç®€å•
- å…³é”®æ¨¡å—å¯ç‹¬ç«‹æ‰©å±•
- å›¢é˜Ÿåä½œæˆæœ¬é€‚ä¸­

**é€‚ç”¨åœºæ™¯**ï¼šæ—¥æ´» 10-100 ä¸‡ã€10-50 å¼€å‘äººå‘˜

### 5.3 å°å…¬å¸ / åˆåˆ›æ¨¡å¼

**æ¶æ„ç‰¹ç‚¹**ï¼š
- **å•ä½“åº”ç”¨**ï¼Œå†…éƒ¨æŒ‰æ¨¡å—ç»„ç»‡
- æœåŠ¡å±‚æ‹†åˆ†æ–‡ä»¶ï¼Œä½†å…±ç”¨è¿›ç¨‹
- å¿«é€Ÿè¿­ä»£ï¼Œçµæ´»è°ƒæ•´

**æŠ€æœ¯æ ˆç¤ºä¾‹**ï¼š
```
ç”¨æˆ·è¯·æ±‚ â†’ Express/Koa â†’ å•è¿›ç¨‹åº”ç”¨
                        â”œâ”€â”€ services/asset/
                        â”œâ”€â”€ services/lottery/
                        â””â”€â”€ services/market/
                        â†’ å•æ•°æ®åº“ + Redis
```

**ä¼˜åŠ¿**ï¼š
- éƒ¨ç½²ç®€å•ï¼ˆå•è¿›ç¨‹ï¼‰
- å¼€å‘è°ƒè¯•æ–¹ä¾¿
- æ— åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜
- å¿«é€Ÿå“åº”ä¸šåŠ¡å˜åŒ–

**é€‚ç”¨åœºæ™¯**ï¼šæ—¥æ´» 1 ä¸‡ä»¥ä¸‹ã€1-10 å¼€å‘äººå‘˜

### 5.4 æ¸¸æˆå…¬å¸æ¨¡å¼

**è™šæ‹Ÿç‰©å“äº¤æ˜“ç³»ç»Ÿç‰¹ç‚¹**ï¼š

| æ¨¡å— | è®¾è®¡è¦ç‚¹ |
|------|----------|
| **èƒŒåŒ…ç³»ç»Ÿ** | ç‰©å“å®ä¾‹åŒ–ã€å †å /éå †å ã€é”å®š/è§£é”çŠ¶æ€ |
| **è´§å¸ç³»ç»Ÿ** | å¤šå¸ç§ï¼ˆé‡‘å¸/é’»çŸ³/ç§¯åˆ†ï¼‰ã€å†»ç»“/è§£å†»æœºåˆ¶ |
| **äº¤æ˜“ç³»ç»Ÿ** | å¹‚ç­‰æ€§ã€äº‹åŠ¡è¾¹ç•Œã€é˜²åˆ·æ§åˆ¶ |
| **æ¦‚ç‡ç³»ç»Ÿ** | ä¿åº•æœºåˆ¶ã€ä½“éªŒè°ƒæ§ã€æ¦‚ç‡å®¡è®¡ |

**æŠ€æœ¯å®ç°**ï¼š
- å¼ºäº‹åŠ¡ä¿è¯ï¼ˆå®å¯å¤±è´¥ä¸å¯è„æ•°æ®ï¼‰
- è¯¦ç»†çš„æ“ä½œæ—¥å¿—ï¼ˆå®¡è®¡è¿½è¸ªï¼‰
- ç‰©å“çŠ¶æ€æœºï¼ˆavailable â†’ locked â†’ consumed/transferredï¼‰

**ä»£ç ç»„ç»‡**ï¼š
```
services/
â”œâ”€â”€ inventory/           # èƒŒåŒ…/åº“å­˜
â”‚   â”œâ”€â”€ InventoryCore.js     # æ ¸å¿ƒå¢åˆ æ”¹
â”‚   â””â”€â”€ InventoryQuery.js    # æŸ¥è¯¢ç»Ÿè®¡
â”œâ”€â”€ currency/            # è´§å¸/ç§¯åˆ†
â”‚   â”œâ”€â”€ CurrencyBalance.js   # ä½™é¢æ“ä½œ
â”‚   â””â”€â”€ CurrencyFrozen.js    # å†»ç»“æ“ä½œ
â””â”€â”€ trading/             # äº¤æ˜“
    â”œâ”€â”€ TradingOrder.js      # è®¢å•ç®¡ç†
    â””â”€â”€ TradingMatch.js      # æ’®åˆé€»è¾‘
```

### 5.5 å¯¹æ¯”æ€»ç»“

| ç±»å‹ | æ¶æ„ | æœåŠ¡æ‹†åˆ†ç²’åº¦ | äº‹åŠ¡å¤„ç† | åŸºç¡€è®¾æ–½ | å›¢é˜Ÿè§„æ¨¡ |
|------|------|-------------|----------|----------|----------|
| å¤§å…¬å¸ | å¾®æœåŠ¡ | ç»†ç²’åº¦ | åˆ†å¸ƒå¼äº‹åŠ¡ | å¤æ‚ | 50+ |
| ä¸­å‹å…¬å¸ | æ¨¡å—åŒ– | ä¸­ç­‰ | æœ¬åœ°äº‹åŠ¡ä¸ºä¸» | é€‚ä¸­ | 10-50 |
| å°å…¬å¸ | å•ä½“ | æ–‡ä»¶çº§ | æœ¬åœ°äº‹åŠ¡ | ç®€å• | 1-10 |
| æ¸¸æˆå…¬å¸ | å•ä½“/æ¨¡å— | é¢†åŸŸé©±åŠ¨ | å¼ºä¸€è‡´æ€§ | æŒ‰éœ€ | 5-30 |

---

## 6. æœ¬é¡¹ç›®æœ€ä½³å®è·µæ–¹æ¡ˆ

### 6.1 é¡¹ç›®å®šä½åˆ†æ

| ç»´åº¦ | ç°çŠ¶ | ç»“è®º |
|------|------|------|
| å›¢é˜Ÿè§„æ¨¡ | å°å›¢é˜Ÿï¼ˆ1-3 äººï¼‰ | ä¸é€‚åˆå¾®æœåŠ¡ |
| ä¸šåŠ¡è§„æ¨¡ | æ—©æœŸé˜¶æ®µ | å¿«é€Ÿè¿­ä»£ä¼˜å…ˆ |
| ä»£ç è§„æ¨¡ | 7.5ä¸‡è¡ŒæœåŠ¡å±‚ã€103ä¸ªæœåŠ¡æ–‡ä»¶ | å·²æœ‰ä¸€å®šå¤æ‚åº¦ |
| æŠ€æœ¯å€ºåŠ¡ | å¤§æ–‡ä»¶éœ€è¦æ‹†åˆ† | éœ€è¦ä¼˜åŒ– |

### 6.2 æ¨èæ–¹æ¡ˆï¼šæ¨¡å—åŒ–å•ä½“ï¼ˆæ–‡ä»¶çº§æ‹†åˆ†ï¼‰

**æ ¸å¿ƒåŸåˆ™**ï¼š
1. **ä¿æŒå•ä½“æ¶æ„**ï¼šå•è¿›ç¨‹éƒ¨ç½²ï¼Œç®€å•å¯é 
2. **æŒ‰èŒè´£æ‹†åˆ†æ–‡ä»¶**ï¼šé™ä½å•æ–‡ä»¶å¤æ‚åº¦
3. **ä¸ä½¿ç”¨é—¨é¢æ¨¡å¼**ï¼šè°ƒç”¨æ–¹ç›´æ¥å¼•ç”¨å­æœåŠ¡
4. **åˆ©ç”¨ IDE é‡æ„å·¥å…·**ï¼šæ‰¹é‡æ›¿æ¢è°ƒç”¨æ–¹
5. **é¿å…å‘½åå†²çª**ï¼šæ–°ç›®å½•ä½¿ç”¨æ˜ç¡®çš„åç§°

**æ¶æ„å›¾**ï¼š
```
services/
â”œâ”€â”€ lottery/                          # ğŸŸ¢ ä¿ç•™ï¼šæŠ½å¥–æ‰§è¡Œç›¸å…³
â”‚   â”œâ”€â”€ index.js                      # LotteryServiceContainer
â”‚   â”œâ”€â”€ LotteryUserService.js
â”‚   â”œâ”€â”€ LotteryHistoryService.js
â”‚   â”œâ”€â”€ LotteryQuotaService.js
â”‚   â””â”€â”€ LotteryPricingService.js
â”‚
â”œâ”€â”€ lottery-analytics/                # ğŸ†• æ–°å»ºï¼šæŠ½å¥–åˆ†æç›¸å…³
â”‚   â”œâ”€â”€ index.js                      # æ¨¡å—å…¥å£
â”‚   â”œâ”€â”€ RealtimeService.js            # å®æ—¶ç›‘æ§
â”‚   â”œâ”€â”€ StatisticsService.js          # ç»Ÿè®¡è¶‹åŠ¿
â”‚   â”œâ”€â”€ ReportService.js              # æŠ¥è¡¨ç”Ÿæˆ
â”‚   â”œâ”€â”€ UserAnalysisService.js        # ç”¨æˆ·åˆ†æ
â”‚   â””â”€â”€ CampaignAnalysisService.js    # æ´»åŠ¨åˆ†æ
â”‚
â”œâ”€â”€ asset/                            # ğŸ†• æ–°å»ºï¼šèµ„äº§æ¨¡å—
â”‚   â”œâ”€â”€ index.js                      # æ¨¡å—å…¥å£
â”‚   â”œâ”€â”€ BalanceService.js             # ä½™é¢æ“ä½œ
â”‚   â”œâ”€â”€ ItemService.js                # ç‰©å“æ“ä½œ
â”‚   â”œâ”€â”€ QueryService.js               # æŸ¥è¯¢ç»Ÿè®¡
â”‚   â””â”€â”€ TransactionHelper.js          # å…±äº«äº‹åŠ¡å·¥å…·
â”‚
â”œâ”€â”€ LotteryAnalyticsService.js        # ğŸ—‘ï¸ æ‹†åˆ†ååˆ é™¤
â””â”€â”€ AssetService.js                   # ğŸ—‘ï¸ æ‹†åˆ†ååˆ é™¤
```

### 6.3 ä¸ºä»€ä¹ˆä¸ç”¨é—¨é¢ï¼Ÿ

| å› ç´  | åˆ†æ | ç»“è®º |
|------|------|------|
| å¤–éƒ¨ä¾èµ– | æ— å¤–éƒ¨ç³»ç»Ÿè°ƒç”¨è¿™äº›æœåŠ¡ | æ— éœ€å…¼å®¹ |
| è°ƒç”¨ç‚¹æ•°é‡ | å¯æ§ï¼ˆ5 + 34 å¤„ï¼‰ | å¯æ‰¹é‡æ›¿æ¢ |
| å›¢é˜Ÿåä½œ | å°å›¢é˜Ÿï¼Œæ²Ÿé€šæˆæœ¬ä½ | å¯ä¸€æ¬¡æ€§æ”¹å®Œ |
| ä»£ç è´¨é‡ | é—¨é¢å¢åŠ é—´æ¥å±‚ | ç›´æ¥å¼•ç”¨æ›´æ¸…æ™° |
| ç»´æŠ¤æˆæœ¬ | é—¨é¢éœ€è¦æŒç»­ç»´æŠ¤ | ä¸€æ¬¡æ”¹å®Œæ— è´Ÿæ‹… |

---

## 7. æ‹†åˆ†åŸåˆ™

### 7.1 æ ¸å¿ƒåŸåˆ™

1. **æŒ‰èŒè´£æ‹†åˆ†**ï¼šä¸€ä¸ªæ–‡ä»¶åªåšä¸€ç±»äº‹æƒ…
2. **ç›´æ¥æ›¿æ¢è°ƒç”¨æ–¹**ï¼šä¸ä½¿ç”¨é—¨é¢è½¬å‘
3. **å…±äº«æ¨¡å—æå–**ï¼šå…¬å…±å·¥å…·å‡½æ•°ç‹¬ç«‹
4. **å•æ–‡ä»¶ä¸Šé™**ï¼šæ‹†åˆ†åæ¯ä¸ªæ–‡ä»¶æ§åˆ¶åœ¨ 1000 è¡Œä»¥å†…
5. **é¿å…å‘½åå†²çª**ï¼šä½¿ç”¨ `lottery-analytics/` è€Œé `lottery/`

### 7.2 ç›®å½•ç»“æ„è§„èŒƒ

```
services/
â”œâ”€â”€ lottery/                    # ç°æœ‰ç›®å½•ï¼ˆä¿ç•™ï¼‰
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ lottery-analytics/          # æŠ½å¥–åˆ†æå­æœåŠ¡ï¼ˆæ–°å»ºï¼‰
â”‚   â”œâ”€â”€ index.js               # ç»Ÿä¸€å¯¼å‡ºå…¥å£
â”‚   â”œâ”€â”€ RealtimeService.js
â”‚   â”œâ”€â”€ StatisticsService.js
â”‚   â”œâ”€â”€ ReportService.js
â”‚   â”œâ”€â”€ UserAnalysisService.js
â”‚   â””â”€â”€ CampaignAnalysisService.js
â”‚
â”œâ”€â”€ asset/                      # èµ„äº§ç›¸å…³å­æœåŠ¡ï¼ˆæ–°å»ºï¼‰
â”‚   â”œâ”€â”€ index.js               # ç»Ÿä¸€å¯¼å‡ºå…¥å£
â”‚   â”œâ”€â”€ BalanceService.js
â”‚   â”œâ”€â”€ ItemService.js
â”‚   â”œâ”€â”€ QueryService.js
â”‚   â””â”€â”€ TransactionHelper.js
â”‚
â””â”€â”€ shared/                     # å…±äº«æ¨¡å—
    â””â”€â”€ RedisHelper.js         # Redis å·¥å…·å‡½æ•°
```

---

## 8. åç«¯ API URL é‡å‘½åæ–¹æ¡ˆ

> **è®¾è®¡å†³ç­–**ï¼šé‡å‘½ååç«¯ API URL è·¯å¾„ï¼Œä½¿è·¯ç”±æ–‡ä»¶åä¸æœåŠ¡åä¿æŒä¸€è‡´ï¼Œæå‡ä»£ç å¯ç»´æŠ¤æ€§ã€‚

### 8.1 URL é‡å‘½åæ˜ å°„è¡¨

#### LotteryAnalyticsService ç›¸å…³ URL

| åŸ URL è·¯å¾„ | æ–° URL è·¯å¾„ | å¯¹åº”æœåŠ¡ |
|-------------|-------------|----------|
| `/console/lottery-monitoring/stats` | `/console/lottery-realtime/stats` | RealtimeService |
| `/console/lottery-monitoring/realtime-alerts` | `/console/lottery-realtime/alerts` | RealtimeService |
| `/console/lottery-monitoring/hourly-metrics` | `/console/lottery-statistics/hourly` | StatisticsService |
| `/console/lottery-monitoring/hourly-metrics/:id` | `/console/lottery-statistics/hourly/:id` | StatisticsService |
| `/console/lottery-monitoring/hourly-metrics/summary/:campaign_id` | `/console/lottery-statistics/hourly/summary/:campaign_id` | StatisticsService |
| `/console/lottery-analytics/daily-report` | `/console/lottery-report/daily` | ReportService |
| `/console/lottery-monitoring/campaign-report/:campaign_id` | `/console/lottery-report/campaign/:campaign_id` | ReportService |
| `/console/lottery-monitoring/user-profile/:user_id` | `/console/lottery-user-analysis/profile/:user_id` | UserAnalysisService |
| `/console/lottery-monitoring/user-experience-states` | `/console/lottery-user-analysis/experience-states` | UserAnalysisService |
| `/console/lottery-monitoring/user-global-states` | `/console/lottery-user-analysis/global-states` | UserAnalysisService |
| `/console/lottery-monitoring/user-quotas` | `/console/lottery-user-analysis/quotas` | UserAnalysisService |
| `/console/lottery-monitoring/abnormal-users` | `/console/lottery-user-analysis/abnormal` | UserAnalysisService |
| `/console/lottery-monitoring/campaign-roi/:campaign_id` | `/console/lottery-campaign-analysis/roi/:campaign_id` | CampaignAnalysisService |
| `/console/lottery-monitoring/strategy-effectiveness` | `/console/lottery-campaign-analysis/strategy-effectiveness` | CampaignAnalysisService |

#### AssetService ç›¸å…³ URLï¼ˆä¿æŒä¸å˜ï¼‰

AssetService çš„ç°æœ‰ URL å‘½åå·²ç»æ¸…æ™°ï¼ˆ`/asset-adjustment/`ã€`/assets/`ï¼‰ï¼Œ**æ— éœ€é‡å‘½å**ã€‚

### 8.2 åç«¯è·¯ç”±æ–‡ä»¶é‡ç»„

```
routes/v4/console/
â”œâ”€â”€ lottery-monitoring.js          # ğŸ—‘ï¸ åˆ é™¤ï¼ˆæ‹†åˆ†åˆ°ä¸‹æ–¹æ–‡ä»¶ï¼‰
â”œâ”€â”€ lottery-analytics.js           # ğŸ—‘ï¸ åˆ é™¤ï¼ˆæ‹†åˆ†åˆ°ä¸‹æ–¹æ–‡ä»¶ï¼‰
â”‚
â”œâ”€â”€ lottery-realtime.js            # ğŸ†• å®æ—¶ç›‘æ§å’Œå‘Šè­¦
â”œâ”€â”€ lottery-statistics.js          # ğŸ†• ç»Ÿè®¡è¶‹åŠ¿
â”œâ”€â”€ lottery-report.js              # ğŸ†• æŠ¥è¡¨ç”Ÿæˆ
â”œâ”€â”€ lottery-user-analysis.js       # ğŸ†• ç”¨æˆ·åˆ†æ
â””â”€â”€ lottery-campaign-analysis.js   # ğŸ†• æ´»åŠ¨åˆ†æ
```

### 8.3 è·¯ç”±ä¸æœåŠ¡å‘½åä¸€è‡´æ€§

æ‹†åˆ†å®Œæˆåï¼Œå‘½ååº”æ»¡è¶³ä»¥ä¸‹ä¸€è‡´æ€§ï¼ˆåç«¯å†…éƒ¨ï¼Œä¸šåŠ¡åŸŸä¼˜å…ˆå‘½åï¼‰ï¼š

```
åç«¯è·¯ç”±æ–‡ä»¶              â†’  æœåŠ¡æ–‡ä»¶                 â†’  ServiceManager é”®
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
lottery-realtime.js      â†’  RealtimeService.js      â†’  lottery_analytics_realtime
lottery-statistics.js    â†’  StatisticsService.js    â†’  lottery_analytics_statistics
lottery-report.js        â†’  ReportService.js        â†’  lottery_analytics_report
lottery-user-analysis.js â†’  UserAnalysisService.js  â†’  lottery_analytics_user
lottery-campaign-analysis.js â†’ CampaignAnalysisService.js â†’ lottery_analytics_campaign
```

---

## 9. LotteryAnalyticsService æ‹†åˆ†æ–¹æ¡ˆ

### 9.1 å½“å‰çŠ¶æ€

- **æ–‡ä»¶**ï¼š`services/LotteryAnalyticsService.js`
- **è¡Œæ•°**ï¼š4,744 è¡Œ
- **æ–¹æ³•æ•°**ï¼š70 ä¸ª async æ–¹æ³•
- **ä¾èµ–**ï¼šsequelize, logger, UnifiedRedisClient, 10+ æ•°æ®æ¨¡å‹
- **é—®é¢˜**ï¼šèŒè´£è¿‡å¤šï¼Œæ¶µç›–å®æ—¶ç›‘æ§ã€ç»Ÿè®¡ã€æŠ¥è¡¨ã€ç”¨æˆ·åˆ†æã€æ´»åŠ¨åˆ†æ
- **æœåŠ¡åˆå¹¶å†å²**ï¼šç”± LotteryMonitoringService + LotteryStrategyStatsService åˆå¹¶è€Œæ¥

### 8.2 æ–¹æ³•åŠŸèƒ½åˆ†ç±»

ç»è¿‡åˆ†æï¼Œ70ä¸ªæ–¹æ³•å¯åˆ†ä¸º5ä¸ªåŠŸèƒ½åŸŸï¼š

#### å®æ—¶ç›‘æ§ï¼ˆRealtimeï¼‰- 12ä¸ªæ–¹æ³•

```
getRealtimeOverview()
getRealtimeAlerts()
getMonitoringStats()
_checkBudgetAlerts()
_checkEmptyStreakAlerts()
_checkHighFrequencyAlerts()
_checkLowStockPrizes()
_checkStockAlerts()
_checkWinRateAlerts()
_getRedisClient()
```

#### ç»Ÿè®¡è¶‹åŠ¿ï¼ˆStatisticsï¼‰- 15ä¸ªæ–¹æ³•

```
getHourlyTrend()
getDailyTrend()
getHourlyMetrics()
getHourlyMetricById()
getHourlyMetricsSummary()
_getHourlyFromDraws()
_getHourlyFromMetrics()
_getHourStatsFromDraws()
_getTodayStatsFromDraws()
_getDrawStats()
_getHourlyTrend()
_getPrizeDistribution()
_getRecentDraws()
_getPrizeStats()
```

#### æŠ¥è¡¨ç”Ÿæˆï¼ˆReportï¼‰- 10ä¸ªæ–¹æ³•

```
generateDailyReport()
generateCampaignReport()
_getDailyReportStats()
_getDailyReportCampaignsBreakdown()
_getDailyReportHourlyBreakdown()
_getDailyReportTierBreakdown()
_getDailyReportTopPrizes()
_generateDailyReportAlerts()
```

#### ç”¨æˆ·åˆ†æï¼ˆUserAnalysisï¼‰- 12ä¸ªæ–¹æ³•

```
getUserDrawRecords()
getUserProfile()
getUserExperienceStates()
getUserExperienceState()
getUserGlobalStates()
getUserGlobalState()
getUserQuotas()
getUserQuota()
getQuotaGrants()
getQuotaGrantById()
getAbnormalUsers()
getDrawDetails()
```

#### æ´»åŠ¨åˆ†æï¼ˆCampaignï¼‰- 21ä¸ªæ–¹æ³•

```
getCampaignQuotaStats()
getCampaignROI()
getTierDistribution()
getBudgetConsumption()
getExperienceTriggers()
getStrategyEffectiveness()
_getTierDistributionFromDecisions()
_getTierDistributionFromHourly()
_getTierDistributionFromDaily()
_getExperienceTriggersFromDecisions()
_getExperienceTriggersFromHourly()
_getExperienceTriggersFromDaily()
_getBudgetConsumptionFromDraws()
_getBudgetConsumptionFromHourly()
_getBudgetConsumptionFromDaily()
_getBudgetProgress()
_getCampaignDailyDistribution()
_getCampaignExperienceMetrics()
_getCampaignHistoryComparison()
_getCampaignHourlyDistribution()
_getCampaignTierDistribution()
_getCampaignTopPrizes()
_getCampaignUserAnalysis()
_analyzeBxPxMatrix()
_analyzeExperienceMechanisms()
_analyzeTierDowngrade()
```

### 8.3 ç›®æ ‡æ–‡ä»¶ç»“æ„

```
services/
â”œâ”€â”€ lottery-analytics/                           # æ–°ç›®å½•ï¼ˆé¿å…ä¸lottery/å†²çªï¼‰
â”‚   â”œâ”€â”€ index.js                                 # ç»Ÿä¸€å¯¼å‡ºå…¥å£
â”‚   â”œâ”€â”€ RealtimeService.js                       # ~800è¡Œ - å®æ—¶ç›‘æ§å’Œå‘Šè­¦
â”‚   â”œâ”€â”€ StatisticsService.js                     # ~900è¡Œ - è¶‹åŠ¿å’Œç»Ÿè®¡
â”‚   â”œâ”€â”€ ReportService.js                         # ~700è¡Œ - æŠ¥è¡¨ç”Ÿæˆ
â”‚   â”œâ”€â”€ UserAnalysisService.js                   # ~800è¡Œ - ç”¨æˆ·ç»´åº¦åˆ†æ
â”‚   â””â”€â”€ CampaignAnalysisService.js               # ~1000è¡Œ - æ´»åŠ¨ç»´åº¦åˆ†æ
```

### 8.4 è°ƒç”¨æ–¹ä¿®æ”¹ç¤ºä¾‹

#### æ–¹å¼1ï¼šç›´æ¥å¼•ç”¨æ–¹å¼ï¼ˆlottery-campaigns.jsï¼‰

**ä¿®æ”¹å‰**ï¼š
```javascript
const LotteryAnalyticsService = require('../../../services/LotteryAnalyticsService')
const analyticsService = new LotteryAnalyticsService(req.app.locals.models)
await analyticsService.getRealtimeOverview(campaignId)
```

**ä¿®æ”¹å**ï¼š
```javascript
const { RealtimeService } = require('../../../services/lottery-analytics')
const realtimeService = new RealtimeService(req.app.locals.models)
await realtimeService.getRealtimeOverview(campaignId)
```

#### æ–¹å¼2ï¼šæœåŠ¡å®¹å™¨æ–¹å¼ï¼ˆlottery-monitoring.jsç­‰ï¼‰

**ä¿®æ”¹å‰**ï¼š
```javascript
// services/index.js
this._services.set('lottery_analytics', new LotteryAnalyticsService(this.models))

// è·¯ç”±è°ƒç”¨
const service = req.app.locals.services.getService('lottery_analytics')
await service.getRealtimeOverview(campaignId)
```

**ä¿®æ”¹å**ï¼š
```javascript
// services/index.js - æ³¨å†Œå¤šä¸ªå­æœåŠ¡ï¼ˆä¸šåŠ¡åŸŸä¼˜å…ˆå‘½åï¼‰
const { RealtimeService, StatisticsService, ReportService, UserAnalysisService, CampaignAnalysisService } = require('./lottery-analytics')

this._services.set('lottery_analytics_realtime', new RealtimeService(this.models))
this._services.set('lottery_analytics_statistics', new StatisticsService(this.models))
this._services.set('lottery_analytics_report', new ReportService(this.models))
this._services.set('lottery_analytics_user', new UserAnalysisService(this.models))
this._services.set('lottery_analytics_campaign', new CampaignAnalysisService(this.models))

// è·¯ç”±è°ƒç”¨
const realtimeService = req.app.locals.services.getService('lottery_analytics_realtime')
await realtimeService.getRealtimeOverview(campaignId)
```

### 8.5 éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| routes/v4/console/lottery-campaigns.js | æ›¿æ¢ç›´æ¥å¼•ç”¨ï¼ŒæŒ‰æ–¹æ³•å¯¹åº”å­æœåŠ¡ |
| routes/v4/console/lottery-analytics.js | æ›´æ–°æœåŠ¡å®¹å™¨è°ƒç”¨ |
| routes/v4/console/lottery-monitoring.js | æ›´æ–°æœåŠ¡å®¹å™¨è°ƒç”¨ |
| routes/v4/console/lottery-strategy-stats.js | æ›´æ–°æœåŠ¡å®¹å™¨è°ƒç”¨ |
| services/index.js | æ›´æ–°æœåŠ¡æ³¨å†Œï¼ˆæ³¨å†Œ5ä¸ªå­æœåŠ¡ï¼‰ |

---

## 10. AssetService æ‹†åˆ†æ–¹æ¡ˆ

### 10.1 å½“å‰çŠ¶æ€

- **æ–‡ä»¶**ï¼š`services/AssetService.js`
- **è¡Œæ•°**ï¼š2,370 è¡Œ
- **æ–¹æ³•æ•°**ï¼š24 ä¸ªé™æ€æ–¹æ³•
- **ä¾èµ–**ï¼šAccount, AccountAssetBalance, AssetTransaction, User, sequelize, logger
- **é—®é¢˜**ï¼šä½™é¢æ“ä½œå’Œç‰©å“æ“ä½œæ··åœ¨ä¸€èµ·
- **æ ¸å¿ƒç‰¹æ€§**ï¼š`checkTransactionBoundary()` å¼ºåˆ¶äº‹åŠ¡è¾¹ç•Œæ£€æŸ¥

### 10.2 æ–¹æ³•åŠŸèƒ½åˆ†ç±»

#### ä½™é¢æ“ä½œï¼ˆBalanceï¼‰- 8ä¸ªæ–¹æ³•

```
getOrCreateAccount()
getOrCreateBalance()
changeBalance()
freeze()
unfreeze()
settleFromFrozen()
getBalance()
getAllBalances()
```

#### ç‰©å“æ“ä½œï¼ˆItemï¼‰- 9ä¸ªæ–¹æ³•

```
mintItem()
lockItem()
unlockItem()
transferItem()
consumeItem()
recordItemEvent()
getItemEvents()
getUserItemInstances()
getItemInstanceDetail()
```

#### æŸ¥è¯¢ç»Ÿè®¡ï¼ˆQueryï¼‰- 7ä¸ªæ–¹æ³•

```
getTotalBudgetPoints()
getBudgetPointsByCampaigns()
getTransactions()
getTransactionByIdempotencyKey()
getAssetPortfolio()
getSystemStats()
```

### 10.3 ç›®æ ‡æ–‡ä»¶ç»“æ„

```
services/
â”œâ”€â”€ asset/
â”‚   â”œâ”€â”€ index.js                  # ç»Ÿä¸€å¯¼å‡ºå…¥å£
â”‚   â”œâ”€â”€ BalanceService.js         # ~800è¡Œ - ä½™é¢æ“ä½œ
â”‚   â”œâ”€â”€ ItemService.js            # ~700è¡Œ - ç‰©å“æ“ä½œ
â”‚   â”œâ”€â”€ QueryService.js           # ~500è¡Œ - æŸ¥è¯¢ç»Ÿè®¡
â”‚   â””â”€â”€ TransactionHelper.js      # ~100è¡Œ - å…±äº«äº‹åŠ¡å·¥å…·
```

### 10.4 å…±äº«æ¨¡å—ï¼šTransactionHelper

```javascript
// services/asset/TransactionHelper.js
const { sequelize } = require('../../config/database')
const logger = require('../../utils/logger')

/**
 * äº‹åŠ¡è¾¹ç•Œæ£€æŸ¥å·¥å…·
 * ä»åŸ AssetService.checkTransactionBoundary æå–
 * 
 * æ²»ç†å†³ç­–ï¼šè·¨è¡¨å†™å…¥æ–¹æ³•å¼ºåˆ¶è¦æ±‚äº‹åŠ¡è¾¹ç•Œ
 */
function checkTransactionBoundary(transaction, methodName) {
  if (!transaction) {
    const error = new Error(
      `[äº‹åŠ¡è¾¹ç•Œé”™è¯¯] ${methodName} å¿…é¡»åœ¨äº‹åŠ¡ä¸­è°ƒç”¨ã€‚\n` +
      'è¯·ä½¿ç”¨ TransactionManager.execute() åŒ…è£¹è°ƒç”¨ï¼Œæˆ–æ˜¾å¼ä¼ å…¥ { transaction } å‚æ•°ã€‚'
    )
    error.code = 'TRANSACTION_REQUIRED'
    logger.error(`âŒ [äº‹åŠ¡è¾¹ç•Œé”™è¯¯] ${methodName} æœªæ¥æ”¶åˆ°äº‹åŠ¡å¯¹è±¡`)
    throw error
  }
}

module.exports = { checkTransactionBoundary, sequelize }
```

### 10.5 éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆ34å¤„ï¼‰

| ç±»åˆ« | æ–‡ä»¶ | ä¿®æ”¹ç­–ç•¥ |
|------|------|----------|
| **æœåŠ¡å±‚** | | |
| | MarketListingService.js | Balance â†’ BalanceService, Item â†’ ItemService |
| | TradeOrderService.js | åŒä¸Š |
| | OrphanFrozenCleanupService.js | Balance â†’ BalanceService |
| | PremiumService.js | Balance â†’ BalanceService |
| | ExchangeService.js | Balance â†’ BalanceService |
| | BackpackService.js | Item â†’ ItemService |
| | ConsumptionService.js | Item â†’ ItemService |
| | RedemptionService.js | Item â†’ ItemService |
| | MerchantPointsService.js | Balance â†’ BalanceService |
| | UserService.js | æŒ‰è°ƒç”¨æ–¹æ³•åˆ†é… |
| | AssetConversionService.js | æŒ‰è°ƒç”¨æ–¹æ³•åˆ†é… |
| | ReportingService.js | Query â†’ QueryService |
| | DataSanitizer.js | æŒ‰è°ƒç”¨æ–¹æ³•åˆ†é… |
| | ActivityConditionValidator.js | æŒ‰è°ƒç”¨æ–¹æ³•åˆ†é… |
| **UnifiedLotteryEngine** | | |
| | UnifiedLotteryEngine.js | Balance â†’ BalanceService |
| | SettleStage.js | Balance â†’ BalanceService, Item â†’ ItemService |
| | LotteryComputeEngine.js | Balance â†’ BalanceService |
| | UserBudgetProvider.js | Balance â†’ BalanceService |
| | BudgetTierCalculator.js | Balance â†’ BalanceService |
| **è·¯ç”±å±‚** | | |
| | console/asset-adjustment.js | æŒ‰è°ƒç”¨æ–¹æ³•åˆ†é… |
| | console/assets/*.js | æŒ‰è°ƒç”¨æ–¹æ³•åˆ†é… |
| | console/campaign-budget.js | Query â†’ QueryService |
| | assets/balance.js | Balance â†’ BalanceService |
| | assets/transactions.js | Query â†’ QueryService |
| | shop/premium.js | Balance â†’ BalanceService |
| | shop/exchange/*.js | Balance â†’ BalanceService |
| **ä»»åŠ¡å±‚** | | |
| | jobs/hourly-expire-fungible-asset-listings.js | Balance â†’ BalanceService |
| | jobs/hourly-unlock-timeout-trade-orders.js | Balance â†’ BalanceService |
| **æµ‹è¯•** | | |
| | *.test.js | æŒ‰æµ‹è¯•ç›®æ ‡åˆ†é… |

### 10.6 æ‰¹é‡æ›¿æ¢å‘½ä»¤ï¼ˆIDE æ“ä½œï¼‰

ä½¿ç”¨ VSCode æˆ– WebStorm çš„å…¨å±€æœç´¢æ›¿æ¢ï¼š

```
æœç´¢: require('.*AssetService')
æ›¿æ¢: require('../asset') æˆ–å…·ä½“å­æœåŠ¡

æœç´¢: AssetService.freeze(
æ›¿æ¢: BalanceService.freeze(

æœç´¢: AssetService.mintItem(
æ›¿æ¢: ItemService.mintItem(

æœç´¢: AssetService.getTransactions(
æ›¿æ¢: QueryService.getTransactions(
```

---

## 11. å®æ–½æ­¥éª¤

### 11.1 Phase 1ï¼šLotteryAnalyticsServiceï¼ˆ2-3å¤©ï¼‰

| æ­¥éª¤ | ä»»åŠ¡ | äº§å‡º | é¢„è®¡æ—¶é—´ |
|------|------|------|----------|
| 1 | åˆ›å»º `services/lottery-analytics/` ç›®å½•ç»“æ„ | ç›®å½• + index.js | 15åˆ†é’Ÿ |
| 2 | æå– RealtimeService | å­æœåŠ¡æ–‡ä»¶ | 2å°æ—¶ |
| 3 | æå– StatisticsService | å­æœåŠ¡æ–‡ä»¶ | 2å°æ—¶ |
| 4 | æå– ReportService | å­æœåŠ¡æ–‡ä»¶ | 1.5å°æ—¶ |
| 5 | æå– UserAnalysisService | å­æœåŠ¡æ–‡ä»¶ | 2å°æ—¶ |
| 6 | æå– CampaignAnalysisService | å­æœåŠ¡æ–‡ä»¶ | 2.5å°æ—¶ |
| 7 | æ›´æ–° services/index.js æœåŠ¡æ³¨å†Œ | æ³¨å†Œ5ä¸ªå­æœåŠ¡ | 30åˆ†é’Ÿ |
| 8 | ä¿®æ”¹è°ƒç”¨æ–¹ï¼ˆ4ä¸ªè·¯ç”±æ–‡ä»¶ï¼‰ | å¼•ç”¨æ›´æ–° | 1å°æ—¶ |
| 9 | åˆ é™¤åŸ LotteryAnalyticsService.js | æ¸…ç† | 5åˆ†é’Ÿ |
| 10 | è¿è¡Œæµ‹è¯•éªŒè¯ | æµ‹è¯•é€šè¿‡ | 1å°æ—¶ |

### 11.2 Phase 2ï¼šAssetServiceï¼ˆ1-2å¤©ï¼‰

| æ­¥éª¤ | ä»»åŠ¡ | äº§å‡º | é¢„è®¡æ—¶é—´ |
|------|------|------|----------|
| 1 | åˆ›å»º `services/asset/` ç›®å½•ç»“æ„ | ç›®å½• + index.js | 15åˆ†é’Ÿ |
| 2 | æå– TransactionHelper | å…±äº«æ¨¡å— | 30åˆ†é’Ÿ |
| 3 | æå– BalanceService | å­æœåŠ¡æ–‡ä»¶ | 2å°æ—¶ |
| 4 | æå– ItemService | å­æœåŠ¡æ–‡ä»¶ | 2å°æ—¶ |
| 5 | æå– QueryService | å­æœåŠ¡æ–‡ä»¶ | 1.5å°æ—¶ |
| 6 | æ‰¹é‡ä¿®æ”¹è°ƒç”¨æ–¹ï¼ˆ34å¤„ï¼‰ | å¼•ç”¨æ›´æ–° | 2.5å°æ—¶ |
| 7 | åˆ é™¤åŸ AssetService.js | æ¸…ç† | 5åˆ†é’Ÿ |
| 8 | è¿è¡Œæµ‹è¯•éªŒè¯ | æµ‹è¯•é€šè¿‡ | 1å°æ—¶ |

### 11.3 æ€»ä½“æ—¶é—´ä¼°ç®—

| é˜¶æ®µ | å·¥ä½œé‡ |
|------|--------|
| LotteryAnalyticsService æ‹†åˆ† | 2-3å¤© |
| AssetService æ‹†åˆ† | 1-2å¤© |
| æµ‹è¯•éªŒè¯ + æ–‡æ¡£æ›´æ–° | 1å¤© |
| **æ€»è®¡** | **4-6å¤©** |

---

## 12. éªŒæ”¶æ ‡å‡†

### 12.1 ä»£ç æ ‡å‡†

- [ ] æ‹†åˆ†åå•æ–‡ä»¶ä¸è¶…è¿‡ 1000 è¡Œ
- [ ] æ‰€æœ‰å­æœåŠ¡æœ‰å®Œæ•´çš„ JSDoc æ³¨é‡Š
- [ ] è°ƒç”¨æ–¹æ­£ç¡®å¼•ç”¨å¯¹åº”å­æœåŠ¡
- [ ] æ— å¾ªç¯ä¾èµ–
- [ ] åŸæœåŠ¡æ–‡ä»¶å·²åˆ é™¤
- [ ] services/index.js æœåŠ¡æ³¨å†Œå·²æ›´æ–°

### 12.2 æµ‹è¯•æ ‡å‡†

- [ ] ç°æœ‰æµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] å­æœåŠ¡æœ‰ç‹¬ç«‹çš„å•å…ƒæµ‹è¯•
- [ ] API æ¥å£è¡Œä¸ºæ— å˜åŒ–

### 12.3 æ–‡æ¡£æ ‡å‡†

- [ ] æ›´æ–°æœåŠ¡ä¾èµ–å›¾
- [ ] æ›´æ–°æœ¬æ–‡æ¡£çŠ¶æ€
- [ ] å­æœåŠ¡å…¥å£æ–‡ä»¶ï¼ˆindex.jsï¼‰æœ‰ä½¿ç”¨è¯´æ˜

### 12.4 å‘½åä¸€è‡´æ€§éªŒæ”¶

- [ ] åç«¯è·¯ç”±æ–‡ä»¶åä¸æœåŠ¡åä¸€è‡´ï¼ˆå¦‚ `lottery-realtime.js` â†’ `RealtimeService.js`ï¼‰
- [ ] ServiceManager æœåŠ¡é”®ä¸æœåŠ¡ç±»åä¸€è‡´ï¼ˆå¦‚ `lottery_realtime` â†’ `RealtimeService`ï¼‰
- [ ] å…¨å±€æœç´¢ç¡®è®¤æ— é—æ¼çš„æ—§ URL å¼•ç”¨
- [ ] åç«¯ API åŠŸèƒ½æ­£å¸¸ï¼ˆå®æ—¶ç›‘æ§ã€ç»Ÿè®¡ã€æŠ¥è¡¨ã€ç”¨æˆ·åˆ†æã€æ´»åŠ¨åˆ†æï¼‰

---

## 13. æ‹†åˆ†æ”¶ç›Š

| æ–¹é¢ | æ‹†åˆ†å‰ | æ‹†åˆ†å |
|------|--------|--------|
| **æœ€å¤§æ–‡ä»¶è¡Œæ•°** | 4,744 | <1,000 |
| **å•æ–‡ä»¶èŒè´£** | 5ç§æ··åˆ | å•ä¸€èŒè´£ |
| **å¯æµ‹è¯•æ€§** | éœ€è¦ mock æ•´ä¸ªæœåŠ¡ | å­æœåŠ¡å¯ç‹¬ç«‹æµ‹è¯• |
| **ä»£ç å®¡æŸ¥** | éš¾ä»¥å¿«é€Ÿç†è§£ | èŒè´£æ¸…æ™°æ˜“å®¡æŸ¥ |
| **å¹¶è¡Œå¼€å‘** | å®¹æ˜“å†²çª | ä¸åŒäººæ”¹ä¸åŒæ–‡ä»¶ |
| **è°ƒç”¨æ¸…æ™°åº¦** | ç»Ÿä¸€å…¥å£ | æŒ‰èŒè´£ç›´æ¥å¼•ç”¨ |
| **ä»£ç å†—ä½™** | - | æ— é—¨é¢è½¬å‘å±‚ |

---

## 14. é£é™©å’Œæ³¨æ„äº‹é¡¹

### 14.1 é£é™©

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| æ‹†åˆ†è¿‡ç¨‹å¼•å…¥Bug | åŠŸèƒ½å¼‚å¸¸ | å……åˆ†æµ‹è¯•ï¼Œé€æ­¥æäº¤ |
| å¾ªç¯ä¾èµ– | å¯åŠ¨å¤±è´¥ | ä¾èµ–å…³ç³»æå‰è§„åˆ’ï¼Œå…±äº«æ¨¡å—æå– |
| é—æ¼è°ƒç”¨æ–¹ | è¿è¡Œé”™è¯¯ | grep å…¨é¢æœç´¢ï¼Œæµ‹è¯•è¦†ç›– |
| æœåŠ¡å®¹å™¨æ³¨å†Œé—æ¼ | è·¯ç”±æŠ¥é”™ | æ£€æŸ¥æ‰€æœ‰ getService è°ƒç”¨ |

### 14.2 æ³¨æ„äº‹é¡¹

1. **ç›®å½•å‘½å**ï¼šä½¿ç”¨ `lottery-analytics/` è€Œé `lottery/`ï¼Œé¿å…ä¸ç°æœ‰ç›®å½•å†²çª
2. **ç§æœ‰æ–¹æ³•å¤„ç†**ï¼šä»¥ `_` å¼€å¤´çš„æ–¹æ³•è·Ÿéšå…¶ä¸»æ–¹æ³•ç§»åŠ¨
3. **å…±äº«ä¾èµ–**ï¼š`_getRedisClient()`ã€`checkTransactionBoundary()` æå–åˆ°å…¬å…±æ¨¡å—
4. **äº‹åŠ¡è¾¹ç•Œ**ï¼šç¡®ä¿ `TransactionHelper` åœ¨æ‰€æœ‰å­æœåŠ¡ä¸­æ­£ç¡®å¼•ç”¨
5. **æ—¥å¿—æ ‡è¯†**ï¼šå­æœåŠ¡ä½¿ç”¨ç‹¬ç«‹çš„æ—¥å¿—æ ‡ç­¾ä¾¿äºè¿½è¸ª
6. **æœåŠ¡å®¹å™¨**ï¼šæ›´æ–° services/index.js ä¸­çš„æœåŠ¡æ³¨å†Œ

---

## 15. æœåŠ¡è°ƒç”¨é“¾è·¯è¿½è¸ªæ–¹æ¡ˆ

> **æœ¬èŠ‚è¯´æ˜**ï¼šæ‹†åˆ†åéœ€è¦æ·»åŠ æœåŠ¡è°ƒç”¨é“¾è·¯è¿½è¸ªï¼Œä¾¿äºé—®é¢˜å®šä½å’Œæ€§èƒ½ç›‘æ§ã€‚

### 15.1 è¿½è¸ªç›®æ ‡

| è¿½è¸ªç»´åº¦ | è¯´æ˜ | å®ç°æ–¹å¼ |
|----------|------|----------|
| è¯·æ±‚çº§è¿½è¸ª | å•æ¬¡ API è¯·æ±‚çš„å®Œæ•´è°ƒç”¨é“¾ | `request_id` è´¯ç©¿æ‰€æœ‰æ—¥å¿— |
| æœåŠ¡çº§è¿½è¸ª | æœåŠ¡é—´è°ƒç”¨å…³ç³» | æ—¥å¿—ä¸­è®°å½• `caller_service` å’Œ `callee_service` |
| æ–¹æ³•çº§è¿½è¸ª | å•ä¸ªæ–¹æ³•çš„æ‰§è¡Œæ—¶é—´å’Œå‚æ•° | æ–¹æ³•å…¥å£/å‡ºå£æ—¥å¿— |

### 15.2 æ—¥å¿—æ ¼å¼æ ‡å‡†

æ‹†åˆ†åçš„å­æœåŠ¡ç»Ÿä¸€ä½¿ç”¨ä»¥ä¸‹æ—¥å¿—æ ¼å¼ï¼š

```javascript
// services/lottery-analytics/RealtimeService.js
class RealtimeService {
  constructor(models) {
    this.models = models
    this.logger = require('../../utils/logger').logger
    this.serviceName = 'lottery_realtime'  // æœåŠ¡æ ‡è¯†
  }

  async getRealtimeOverview(campaignId, options = {}) {
    const { request_id } = options
    const methodName = 'getRealtimeOverview'
    const startTime = Date.now()

    // æ–¹æ³•å…¥å£æ—¥å¿—
    this.logger.info(`[${this.serviceName}] ${methodName} å¼€å§‹`, {
      request_id,
      service: this.serviceName,
      method: methodName,
      params: { campaignId }
    })

    try {
      // ... ä¸šåŠ¡é€»è¾‘ ...
      const result = { /* ... */ }

      // æ–¹æ³•å‡ºå£æ—¥å¿—ï¼ˆæˆåŠŸï¼‰
      this.logger.info(`[${this.serviceName}] ${methodName} å®Œæˆ`, {
        request_id,
        service: this.serviceName,
        method: methodName,
        duration_ms: Date.now() - startTime,
        result_summary: { count: result.length || 1 }
      })

      return result
    } catch (error) {
      // æ–¹æ³•å‡ºå£æ—¥å¿—ï¼ˆå¤±è´¥ï¼‰
      this.logger.error(`[${this.serviceName}] ${methodName} å¤±è´¥`, {
        request_id,
        service: this.serviceName,
        method: methodName,
        duration_ms: Date.now() - startTime,
        error: error.message,
        stack: error.stack
      })
      throw error
    }
  }
}
```

### 15.3 æœåŠ¡é—´è°ƒç”¨è¿½è¸ª

å½“å­æœåŠ¡è°ƒç”¨å…¶ä»–æœåŠ¡æ—¶ï¼Œè®°å½•è°ƒç”¨å…³ç³»ï¼š

```javascript
// services/lottery-analytics/StatisticsService.js
class StatisticsService {
  async getHourlyTrend(campaignId, options = {}) {
    const { request_id, transaction } = options

    // è°ƒç”¨å…¶ä»–æœåŠ¡å‰è®°å½•
    this.logger.info(`[${this.serviceName}] è°ƒç”¨ asset_query æœåŠ¡`, {
      request_id,
      caller_service: this.serviceName,
      callee_service: 'asset_query',
      callee_method: 'getTransactionStats'
    })

    const QueryService = require('../asset/QueryService')
    const stats = await QueryService.getTransactionStats(campaignId, { request_id, transaction })

    return stats
  }
}
```

### 15.4 è·¯ç”±å±‚ request_id æ³¨å…¥

ç¡®ä¿æ‰€æœ‰è¯·æ±‚éƒ½æœ‰ `request_id`ï¼š

```javascript
// routes/v4/console/lottery-realtime.js
const { v4: uuidv4 } = require('uuid')

router.get('/stats', authenticateToken, async (req, res) => {
  const request_id = req.headers['x-request-id'] || uuidv4()
  
  try {
    const RealtimeService = req.app.locals.services.getService('lottery_realtime')
    const result = await RealtimeService.getRealtimeOverview(
      req.query.campaign_id,
      { request_id }  // ä¼ é€’ request_id
    )
    res.apiSuccess(result)
  } catch (error) {
    res.apiError(error.message, error.code || 'INTERNAL_ERROR')
  }
})
```

---

## 16. æœåŠ¡é—´ä¾èµ–ä¼˜åŒ–æ–¹æ¡ˆ

> **æœ¬èŠ‚è¯´æ˜**ï¼šæ‹†åˆ†åéœ€è¦æ£€æŸ¥å¹¶ä¼˜åŒ–æœåŠ¡é—´ä¾èµ–ï¼Œé¿å…å¾ªç¯ä¾èµ–å’Œè¿‡åº¦è€¦åˆã€‚

### 16.1 å½“å‰ä¾èµ–å…³ç³»åˆ†æ

æ‹†åˆ†åéœ€è¦æ£€æŸ¥çš„ä¾èµ–å…³ç³»ï¼š

```
UnifiedLotteryEngine
â”œâ”€â”€ lottery_realtime      (RealtimeService)      â† æ— ä¾èµ–
â”œâ”€â”€ lottery_statistics    (StatisticsService)    â† ä¾èµ– asset_query
â”œâ”€â”€ lottery_report        (ReportService)        â† ä¾èµ– lottery_statistics
â”œâ”€â”€ lottery_user_analysis (UserAnalysisService)  â† ä¾èµ– asset_query
â””â”€â”€ lottery_campaign_analysis (CampaignAnalysisService) â† ä¾èµ– asset_query

asset_balance   (BalanceService)    â† ä¾èµ– TransactionHelper
asset_item      (ItemService)       â† ä¾èµ– TransactionHelper, asset_balance
asset_query     (QueryService)      â† æ— ä¾èµ–
```

### 16.2 ä¾èµ–æ£€æŸ¥å‘½ä»¤

æ‹†åˆ†å®Œæˆåæ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š

```bash
# æ£€æŸ¥å¾ªç¯ä¾èµ–
grep -r "require.*lottery-analytics" services/asset/ --include="*.js"
grep -r "require.*asset" services/lottery-analytics/ --include="*.js"

# æ£€æŸ¥æ˜¯å¦æœ‰ç›´æ¥å¼•ç”¨æ—§æœåŠ¡
grep -r "LotteryAnalyticsService" services/ routes/ --include="*.js"
grep -r "AssetService" services/ routes/ --include="*.js" | grep -v "asset/"

# æ£€æŸ¥æœåŠ¡æ³¨å†Œå®Œæ•´æ€§
grep "_services.set" services/index.js | wc -l
```

### 16.3 ä¾èµ–ä¼˜åŒ–è§„åˆ™

| è§„åˆ™ | è¯´æ˜ | æ£€æŸ¥æ–¹å¼ |
|------|------|----------|
| **ç¦æ­¢å¾ªç¯ä¾èµ–** | Aâ†’B å’Œ Bâ†’A ä¸èƒ½åŒæ—¶å­˜åœ¨ | grep äº¤å‰æ£€æŸ¥ |
| **å•å‘ä¾èµ–** | é«˜å±‚æœåŠ¡å¯ä¾èµ–ä½å±‚ï¼Œåä¹‹ç¦æ­¢ | ä»£ç  Review |
| **å…±äº«æ¨¡å—æå–** | è¢«å¤šä¸ªæœåŠ¡ä¾èµ–çš„é€»è¾‘æå–åˆ° shared/ | ä¾èµ–è®¡æ•° |
| **æ¥å£éš”ç¦»** | åªä¾èµ–éœ€è¦çš„æ–¹æ³•ï¼Œä¸ä¾èµ–æ•´ä¸ªæœåŠ¡ | æŒ‰éœ€ require |

### 16.4 ä¾èµ–å±‚çº§å®šä¹‰

```
å±‚çº§ 3ï¼ˆåº”ç”¨å±‚ï¼‰ï¼šè·¯ç”±æ–‡ä»¶
    â†“ è°ƒç”¨
å±‚çº§ 2ï¼ˆä¸šåŠ¡å±‚ï¼‰ï¼šLotteryAnalyticsService å­æœåŠ¡
    â†“ è°ƒç”¨
å±‚çº§ 1ï¼ˆåŸºç¡€å±‚ï¼‰ï¼šAssetService å­æœåŠ¡ã€å…±äº«æ¨¡å—
    â†“ è°ƒç”¨
å±‚çº§ 0ï¼ˆæ•°æ®å±‚ï¼‰ï¼šmodelsã€æ•°æ®åº“
```

**è§„åˆ™**ï¼šåªèƒ½å‘ä¸‹ä¾èµ–ï¼Œç¦æ­¢å‘ä¸Šä¾èµ–æˆ–å¹³çº§å¾ªç¯ä¾èµ–ã€‚

### 16.5 ä¾èµ–ä¼˜åŒ–æ£€æŸ¥è¡¨

æ‹†åˆ†å®Œæˆåéœ€éªŒè¯ï¼š

- [ ] æ— å¾ªç¯ä¾èµ–ï¼ˆgrep æ£€æŸ¥é€šè¿‡ï¼‰
- [ ] æ— å‘ä¸Šä¾èµ–ï¼ˆå±‚çº§ 1 ä¸ä¾èµ–å±‚çº§ 2ï¼‰
- [ ] å…±äº«æ¨¡å—å·²æå–ï¼ˆ`_getRedisClient`ã€`checkTransactionBoundary`ï¼‰
- [ ] æœåŠ¡æ³¨å†Œå®Œæ•´ï¼ˆæ‰€æœ‰å­æœåŠ¡åœ¨ services/index.js ä¸­æ³¨å†Œï¼‰
- [ ] æ—§æœåŠ¡å¼•ç”¨å·²æ¸…é™¤ï¼ˆæ— ç›´æ¥å¼•ç”¨ `LotteryAnalyticsService` æˆ– `AssetService`ï¼‰

---

## 17. åç»­é•¿æœŸä¼˜åŒ–

### 17.1 è‡ªåŠ¨åŒ–æ£€æŸ¥

- å»ºç«‹æœåŠ¡æ‹†åˆ†çš„è‡ªåŠ¨åŒ–æ£€æŸ¥ï¼ˆè¶…è¿‡ 1500 è¡Œå‘Šè­¦ï¼‰
- æ·»åŠ  CI æµç¨‹æ£€æŸ¥å¾ªç¯ä¾èµ–

### 17.2 æ¶æ„æ¼”è¿›

- å®šæœŸ Review æœåŠ¡èŒè´£è¾¹ç•Œ
- è€ƒè™‘æŒ‰é¢†åŸŸè¿›ä¸€æ­¥ç»„ç»‡ä»£ç ï¼ˆDDD é£æ ¼ï¼‰

---

## 18. å®æ–½åŸåˆ™ä¸æ£€æŸ¥æ¸…å•

> **é‡è¦**ï¼šæœ¬èŠ‚è§„å®šäº†æ‰§è¡Œæ‹†åˆ†æ—¶å¿…é¡»éµå®ˆçš„åŸåˆ™ï¼Œé˜²æ­¢å¢åŠ æŠ€æœ¯å€ºåŠ¡å’Œç³»ç»Ÿå¤æ‚åº¦ã€‚

### 18.1 åˆ›å»ºæ–°æ–‡ä»¶å‰çš„å¼ºåˆ¶æ£€æŸ¥æµç¨‹

åœ¨åˆ›å»ºä»»ä½•æ–°çš„æœåŠ¡ã€å·¥å…·ç±»ã€æ¨¡æ¿ç±»æˆ–åŠ©æ‰‹æ–‡ä»¶å‰ï¼Œ**å¿…é¡»**æ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š

```bash
# æ­¥éª¤1ï¼šæ£€æŸ¥ç°æœ‰ç›®å½•ç»“æ„
list_dir services/
list_dir services/lottery/
list_dir services/asset/  # å¦‚æœå·²å­˜åœ¨
list_dir utils/

# æ­¥éª¤2ï¼šæœç´¢ç›¸ä¼¼åŠŸèƒ½æ˜¯å¦å·²å­˜åœ¨
grep "RealtimeService\|StatisticsService\|ReportService" services/ -r
grep "BalanceService\|ItemService\|QueryService" services/ -r
grep "checkTransactionBoundary" services/ -r

# æ­¥éª¤3ï¼šæ£€æŸ¥æ˜¯å¦æœ‰å¯å¤ç”¨çš„å·¥å…·å‡½æ•°
grep "redis\|cache" utils/ -r
grep "transaction\|sequelize" utils/ -r
```

### 18.2 åˆ›å»ºæ–°æ–‡ä»¶çš„ä¸‰ä¸ªå¿…è¦æ¡ä»¶

| æ¡ä»¶ | æ£€æŸ¥æ–¹å¼ | é€šè¿‡æ ‡å‡† |
|------|----------|----------|
| **æ¡ä»¶1**ï¼šç°æœ‰æ–‡ä»¶ç¡®å®ä¸åŒ…å«ç›¸å…³åŠŸèƒ½ | `grep` æœç´¢å…³é”®è¯ | æœç´¢ç»“æœä¸ºç©ºæˆ–æ— åŒ¹é… |
| **æ¡ä»¶2**ï¼šæ–°åŠŸèƒ½ä¸ç°æœ‰åŠŸèƒ½èŒè´£æ˜ç¡®åˆ†ç¦» | é˜…è¯»ç°æœ‰ä»£ç ç¡®è®¤ | æ— èŒè´£é‡å  |
| **æ¡ä»¶3**ï¼šæ–°æ–‡ä»¶æœ‰ç‹¬ç‰¹ä¸”ä¸å¯åˆå¹¶çš„ä¸šåŠ¡ä»·å€¼ | ä¸šåŠ¡é€»è¾‘åˆ†æ | ä¸èƒ½åˆå¹¶åˆ°ç°æœ‰æ–‡ä»¶ |

**åªæœ‰ä¸‰ä¸ªæ¡ä»¶å…¨éƒ¨æ»¡è¶³ï¼Œæ‰èƒ½åˆ›å»ºæ–°æ–‡ä»¶ã€‚**

### 18.3 åŒæ­¥ä¿®æ”¹æ¸…å•

æ‰§è¡Œæ‹†åˆ†æ—¶ï¼Œä»¥ä¸‹æ–‡ä»¶ç±»å‹å¿…é¡»åŒæ­¥ä¿®æ”¹ï¼Œç¡®ä¿ä¸€è‡´æ€§ï¼š

| æ–‡ä»¶ç±»å‹ | è·¯å¾„æ¨¡å¼ | ä¿®æ”¹å†…å®¹ |
|----------|----------|----------|
| æœåŠ¡æ–‡ä»¶ | `services/*.js` | æ‹†åˆ†åçš„å­æœåŠ¡ |
| æœåŠ¡æ³¨å†Œ | `services/index.js` | æ›´æ–°æœåŠ¡æ³¨å†Œä»£ç  |
| è·¯ç”±æ–‡ä»¶ | `routes/v4/**/*.js` | æ›´æ–°æœåŠ¡å¼•ç”¨ |
| æµ‹è¯•æ–‡ä»¶ | `tests/**/*.test.js` | æ›´æ–°æµ‹è¯•ç”¨ä¾‹ |
| é…ç½®æ–‡ä»¶ | `config/*.js` | å¦‚æœ‰æœåŠ¡é…ç½®åˆ™æ›´æ–° |
| æ•°æ®åº“æ¨¡å‹ | `models/*.js` | å¦‚æœ‰å…³è”åˆ™æ£€æŸ¥ |
| ä¸­é—´ä»¶ | `middleware/*.js` | å¦‚æœ‰æœåŠ¡ä¾èµ–åˆ™æ£€æŸ¥ |

### 18.4 ç¦æ­¢äº‹é¡¹

- âŒ ç¦æ­¢åœ¨æœªæœç´¢ç°æœ‰ä»£ç çš„æƒ…å†µä¸‹åˆ›å»ºæ–°æ–‡ä»¶
- âŒ ç¦æ­¢åˆ›å»ºä¸ç°æœ‰æ–‡ä»¶åŠŸèƒ½é‡å çš„æ–°æ–‡ä»¶
- âŒ ç¦æ­¢åªä¿®æ”¹éƒ¨åˆ†æ–‡ä»¶è€Œä¸åŒæ­¥ä¿®æ”¹ä¾èµ–æ–‡ä»¶
- âŒ ç¦æ­¢è·³è¿‡æµ‹è¯•éªŒè¯ç›´æ¥åˆå¹¶ä»£ç 
- âŒ ç¦æ­¢åˆ›å»ºç©ºçš„å ä½æ–‡ä»¶

### 18.5 é¡¹ç›®ç»“æ„è®¤çŸ¥

æœ¬é¡¹ç›®éƒ¨ç½²åœ¨ **Sealos DevBox** ä¸­ï¼ŒåŒ…å«ï¼š

```
/home/devbox/project/
â”œâ”€â”€ services/           # åç«¯æœåŠ¡å±‚ï¼ˆæœ¬æ¬¡æ‹†åˆ†ç›®æ ‡ï¼‰
â”‚   â”œâ”€â”€ index.js        # ServiceManager æœåŠ¡æ³¨å†Œ
â”‚   â”œâ”€â”€ lottery/        # ç°æœ‰æŠ½å¥–å­æœåŠ¡ï¼ˆä¿ç•™ï¼‰
â”‚   â”œâ”€â”€ lottery-analytics/  # æ–°å»ºï¼šæŠ½å¥–åˆ†æå­æœåŠ¡
â”‚   â””â”€â”€ asset/          # æ–°å»ºï¼šèµ„äº§å­æœåŠ¡
â”œâ”€â”€ routes/             # è·¯ç”±å±‚
â”‚   â””â”€â”€ v4/console/     # ç®¡ç†åå°è·¯ç”±ï¼ˆéœ€åŒæ­¥ä¿®æ”¹ï¼‰
â”œâ”€â”€ models/             # Sequelize æ•°æ®æ¨¡å‹
â”œâ”€â”€ utils/              # å·¥å…·å‡½æ•°
â”œâ”€â”€ middleware/         # ä¸­é—´ä»¶
â”œâ”€â”€ config/             # é…ç½®æ–‡ä»¶
â”œâ”€â”€ tests/              # æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ migrations/         # æ•°æ®åº“è¿ç§»
â””â”€â”€ jobs/               # å®šæ—¶ä»»åŠ¡
```

### 18.6 æ‹†åˆ†æ‰§è¡Œæ£€æŸ¥è¡¨

åœ¨å¼€å§‹æ¯ä¸ªæ‹†åˆ†ä»»åŠ¡å‰ï¼Œå¿…é¡»å®Œæˆä»¥ä¸‹æ£€æŸ¥ï¼š

- [ ] å·²æ‰§è¡Œ `list_dir` æ£€æŸ¥ç›®æ ‡ç›®å½•ç»“æ„
- [ ] å·²æ‰§è¡Œ `grep` æœç´¢ç›¸ä¼¼åŠŸèƒ½
- [ ] å·²ç¡®è®¤ä¸‰ä¸ªå¿…è¦æ¡ä»¶å…¨éƒ¨æ»¡è¶³
- [ ] å·²åˆ—å‡ºæ‰€æœ‰éœ€è¦åŒæ­¥ä¿®æ”¹çš„æ–‡ä»¶
- [ ] å·²åˆ¶å®šå›æ»šæ–¹æ¡ˆ

åœ¨å®Œæˆæ¯ä¸ªæ‹†åˆ†ä»»åŠ¡åï¼Œå¿…é¡»éªŒè¯ï¼š

- [ ] æ‰€æœ‰å­æœåŠ¡æ–‡ä»¶å·²åˆ›å»º
- [ ] `services/index.js` æœåŠ¡æ³¨å†Œå·²æ›´æ–°
- [ ] æ‰€æœ‰è°ƒç”¨æ–¹æ–‡ä»¶å·²ä¿®æ”¹
- [ ] æµ‹è¯•æ–‡ä»¶å·²æ›´æ–°å¹¶é€šè¿‡
- [ ] åº”ç”¨å¯æ­£å¸¸å¯åŠ¨
- [ ] æ ¸å¿ƒåŠŸèƒ½å¯æ­£å¸¸è¿è¡Œ

---

## 19. æ‹æ¿å†³ç­–è®°å½•ï¼ˆ2026-01-31ï¼‰

> **é‡è¦**ï¼šæœ¬ç« èŠ‚è®°å½•ç»è¿‡è®¨è®ºåç¡®è®¤çš„å…³é”®å†³ç­–ï¼Œä½œä¸ºåç»­å®æ–½çš„ä¾æ®ã€‚

### 19.1 ä¸šåŠ¡æ•°æ®åŸºå‡†ï¼ˆæ¥è‡ªçœŸå®æ•°æ®åº“ï¼‰

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| ç”¨æˆ·æ•° | 51 | å…¨éƒ¨æ´»è·ƒ |
| æŠ½å¥–æ´»åŠ¨ | 4ï¼ˆ1ä¸ªæ´»è·ƒï¼‰ | - |
| æŠ½å¥–è®°å½• | 633 | - |
| ç‰©å“å®ä¾‹ | 5,128 | - |
| äº¤æ˜“æŒ‚ç‰Œ | 197ï¼ˆ6ä¸ªåœ¨å”®ï¼‰ | - |
| äº¤æ˜“è®¢å• | 99 | - |
| èµ„äº§æµæ°´ | 16,138 | - |
| æ•°æ®åº“è¡¨ | 73å¼  | - |
| æœåŠ¡æ–‡ä»¶ | 57ä¸ª | 54,846è¡Œ |

### 19.2 ç¡®è®¤çš„ä¹é¡¹å†³ç­–

| å†³ç­–ç‚¹ | é€‰é¡¹ | ç¡®è®¤é€‰æ‹© | ç†ç”± |
|--------|------|----------|------|
| **1. æ‹†åˆ†èŒƒå›´** | A.ä»…2ä¸ª / B.åŠ MarketListing / C.å…¨éƒ¨7ä¸ª | **C** | ä¸€æ¬¡æ€§å¤„ç†å…¨éƒ¨7ä¸ªå¤§æ–‡ä»¶ |
| **2. API URLé‡å‘½å** | A.ä¿æŒåŸURL / B.åŒæ—¶é‡å‘½å | **B** | æœåŠ¡å±‚+è·¯ç”±å±‚+URLï¼Œå‰ç«¯åŒæ­¥ä¿®æ”¹ |
| **3. æœåŠ¡ç±»å‹** | A.é™æ€æ–¹æ³• / B.å®ä¾‹æ–¹æ³• | **A** | ä¿æŒé™æ€ç±»æ¨¡å¼ï¼Œå‡å°‘æ”¹åŠ¨é‡ |
| **4. å…¼å®¹åˆ«å** | A.ä¸ä¿ç•™ / B.ä¿ç•™ | **A** | è°ƒç”¨æ–¹æ•°é‡å¯æ§ï¼Œä¸€æ¬¡æ€§æ”¹å®Œæ›´å¹²å‡€ |
| **5. æ‰§è¡Œé¡ºåº** | A.å…ˆAnalytics / B.å…ˆAsset / C.å¹¶è¡Œ | **B** | åˆ†ä¸¤æ‰¹ï¼šå…ˆåŸºç¡€å±‚ï¼ˆAssetServiceï¼‰ï¼Œåä¸šåŠ¡å±‚ï¼ˆå…¶ä½™6ä¸ªï¼‰ |
| **6. æœåŠ¡ç±»å‹ç»†åŒ–** | A.ä¿æŒåŸæœ‰ç±»å‹ / B.å…¨éƒ¨æ”¹é™æ€ | **A** | å®ä¾‹åŒ–çš„ä¿æŒå®ä¾‹åŒ–ï¼Œé™æ€çš„ä¿æŒé™æ€ï¼Œéœ€è¦çŠ¶æ€/ä¾èµ–çš„æ‰å®ä¾‹åŒ–ï¼ˆæ¸¸æˆå…¬å¸æ¨¡å¼ï¼‰ |
| **7. æœåŠ¡é”®å‘½å** | A.æ¨¡å—å‰ç¼€ / B.ä¸šåŠ¡åŸŸä¼˜å…ˆ | **B** | ä½¿ç”¨ä¸šåŠ¡åŸŸå‰ç¼€ï¼ˆå¦‚ `market_listing_*`ï¼‰ï¼Œä¾¿äºåˆ†ç»„ã€ç›‘æ§ã€æ‰©å±• |
| **8. ç›®å½•å‘½å** | A.å…¨ç§°å‘½å / B.ç®€ç§°å‘½å | **A** | ä½¿ç”¨å…¨ç§°ï¼ˆå¦‚ `market-listing/`ï¼‰ï¼Œç²¾ç¡®å¯¹åº”åŸæœåŠ¡åï¼Œé¿å…ä¸è·¯ç”±å±‚ `market/` æ··æ·† |
| **9. å¹¶è¡Œå®‰æ’** | A.å…¨å¹¶è¡Œ / B.åˆ†ä¸¤æ‰¹ / C.æŒ‰ä¾èµ– | **B** | åˆ†ä¸¤æ‰¹æ‰§è¡Œï¼šå…ˆç¨³å®šåŸºç¡€å±‚ï¼Œå†æ”¹ä¸šåŠ¡å±‚ï¼Œé£é™©å¯æ§ |

### 19.3 æ‹†åˆ†æ–‡ä»¶æ¸…å•ï¼ˆ7ä¸ªï¼‰

| åºå· | åŸæ–‡ä»¶ | è¡Œæ•° | æ‹†åˆ†åç›®å½• | å­æœåŠ¡æ•° |
|------|--------|------|------------|----------|
| 1 | LotteryAnalyticsService.js | 4,745 | `lottery-analytics/` | 5ä¸ª |
| 2 | AssetService.js | 2,371 | `asset/` | 3ä¸ª |
| 3 | MarketListingService.js | 2,294 | `market-listing/` | 3ä¸ª |
| 4 | ExchangeService.js | 1,873 | `exchange/` | 3ä¸ª |
| 5 | ConsumptionService.js | 1,825 | `consumption/` | 3ä¸ª |
| 6 | ReportingService.js | 1,819 | `reporting/` | 3ä¸ª |
| 7 | AdminLotteryService.js | 1,781 | `admin-lottery/` | 3ä¸ª |

### 19.4 å‰åç«¯åŒæ­¥æ”¹åŠ¨èŒƒå›´

ç”±äºé€‰æ‹©äº† **URLé‡å‘½å**ï¼ˆå†³ç­–2=Bï¼‰ï¼Œéœ€è¦åŒæ­¥ä¿®æ”¹ï¼š

| æ”¹åŠ¨èŒƒå›´ | æ–‡ä»¶ç±»å‹ | é¢„ä¼°æ•°é‡ |
|----------|----------|----------|
| åç«¯æœåŠ¡å±‚ | `services/*.js` | 7ä¸ªå¤§æ–‡ä»¶æ‹†åˆ† |
| åç«¯è·¯ç”±å±‚ | `routes/v4/**/*.js` | ç›¸å…³è·¯ç”±æ–‡ä»¶ |
| åç«¯æœåŠ¡æ³¨å†Œ | `services/index.js` | 1ä¸ªæ–‡ä»¶ |
| **å‰ç«¯APIè°ƒç”¨** | `admin/src/api/**/*.js` | æ¶‰åŠçš„APIæ¨¡å— |

### 19.5 æŠ€æœ¯çº¦æŸç¡®è®¤

- âœ… ä¿æŒå•ä½“æ¶æ„ï¼ˆä¸æ‹†å¾®æœåŠ¡ï¼‰
- âœ… ä½¿ç”¨ ServiceManager å•ä¾‹æ¨¡å¼
- âœ… æœåŠ¡é”®ä½¿ç”¨ snake_case + ä¸šåŠ¡åŸŸä¼˜å…ˆå‘½åï¼ˆå†³ç­–7=Bï¼‰
- âœ… ä¿æŒåŸæœ‰æœåŠ¡ç±»å‹ï¼šå®ä¾‹åŒ–çš„ä¿æŒå®ä¾‹åŒ–ï¼Œé™æ€çš„ä¿æŒé™æ€ï¼ˆå†³ç­–6=Aï¼‰
- âœ… å®ä¾‹åŒ–æœåŠ¡ä½¿ç”¨ `new Service(this.models)`ï¼ˆéœ€è¦çŠ¶æ€/ä¾èµ–çš„æ‰å®ä¾‹åŒ–ï¼‰
- âœ… äº‹åŠ¡è¾¹ç•Œæ£€æŸ¥ï¼ˆ`checkTransactionBoundary`ï¼‰æå–ä¸ºå…±äº«æ¨¡å—
- âœ… ä¸ä¿ç•™å‘åå…¼å®¹åˆ«å
- âœ… index.js ä½¿ç”¨ç›´æ¥å¯¼å‡ºæ¨¡å¼ï¼ˆåŒ `pipeline/`ï¼Œä¸ä½¿ç”¨æœåŠ¡å®¹å™¨ç±»ï¼‰
- âœ… ç›®å½•ä½¿ç”¨å…¨ç§°å‘½åï¼ˆå¦‚ `market-listing/`ï¼Œå†³ç­–8=Aï¼‰
- âœ… åˆ†ä¸¤æ‰¹æ‰§è¡Œï¼ˆå†³ç­–9=Bï¼‰

### 19.6 åˆ†æ‰¹æ‰§è¡Œè®¡åˆ’ï¼ˆå†³ç­–9=Bï¼‰

åŸºäºä¾èµ–å…³ç³»åˆ†æï¼Œé‡‡ç”¨**åˆ†ä¸¤æ‰¹**æ‰§è¡Œç­–ç•¥ï¼š

```
ä¾èµ–å…³ç³»ï¼š
AssetService â† MarketListingService
AssetService â† ExchangeService
AssetService â† ConsumptionService
AssetService â† ReportingService
AssetService â† UnifiedLotteryEngineï¼ˆ5ä¸ªæ–‡ä»¶ï¼‰

LotteryAnalyticsService â† æ— æœåŠ¡ä¾èµ–ï¼ˆä»…è·¯ç”±å±‚ï¼‰
AdminLotteryService â† æ— æœåŠ¡ä¾èµ–ï¼ˆä»…è·¯ç”±å±‚ï¼‰
```

#### ç¬¬1æ‰¹ï¼šåŸºç¡€å±‚ï¼ˆAssetServiceï¼‰

| æ–‡ä»¶ | è¡Œæ•° | æ‹†åˆ†ä¸º | è°ƒç”¨æ–¹æ•° |
|------|------|--------|----------|
| AssetService.js | 2,371 | `asset/` ç›®å½•ï¼ˆ3ä¸ªå­æœåŠ¡ï¼‰ | **34å¤„** |

**éªŒè¯é‡ç‚¹**ï¼š
- äº‹åŠ¡è¾¹ç•Œæ£€æŸ¥æ­£å¸¸
- ä½™é¢æ“ä½œï¼ˆchangeBalance, freeze, unfreezeï¼‰
- ç‰©å“æ“ä½œï¼ˆmintItem, lockItem, transferItemï¼‰
- UnifiedLotteryEngine æ­£å¸¸è°ƒç”¨

**é¢„è®¡æ—¶é—´**ï¼š1-2å¤©

#### ç¬¬2æ‰¹ï¼šä¸šåŠ¡å±‚ï¼ˆ6ä¸ªæœåŠ¡ï¼‰

| æ–‡ä»¶ | è¡Œæ•° | æ‹†åˆ†ä¸º | è°ƒç”¨æ–¹æ•° |
|------|------|--------|----------|
| LotteryAnalyticsService.js | 4,745 | `lottery-analytics/` ç›®å½•ï¼ˆ5ä¸ªå­æœåŠ¡ï¼‰ | 5å¤„ |
| MarketListingService.js | 2,294 | `market-listing/` ç›®å½•ï¼ˆ3ä¸ªå­æœåŠ¡ï¼‰ | 5å¤„ |
| ExchangeService.js | 1,873 | `exchange/` ç›®å½•ï¼ˆ3ä¸ªå­æœåŠ¡ï¼‰ | 1å¤„ |
| ConsumptionService.js | 1,825 | `consumption/` ç›®å½•ï¼ˆ3ä¸ªå­æœåŠ¡ï¼‰ | 1å¤„ |
| ReportingService.js | 1,819 | `reporting/` ç›®å½•ï¼ˆ3ä¸ªå­æœåŠ¡ï¼‰ | 4å¤„ |
| AdminLotteryService.js | 1,781 | `admin-lottery/` ç›®å½•ï¼ˆ3ä¸ªå­æœåŠ¡ï¼‰ | 1å¤„ |

**éªŒè¯é‡ç‚¹**ï¼š
- å„ä¸šåŠ¡åŠŸèƒ½æ­£å¸¸
- æœåŠ¡æ³¨å†Œæ­£ç¡®
- å‰ç«¯APIè°ƒç”¨æ­£å¸¸ï¼ˆURLé‡å‘½åï¼‰

**é¢„è®¡æ—¶é—´**ï¼š3-4å¤©

#### æ€»ä½“æ—¶é—´ä¼°ç®—

| é˜¶æ®µ | å·¥ä½œé‡ |
|------|--------|
| ç¬¬1æ‰¹ï¼ˆAssetServiceï¼‰ | 1-2å¤© |
| ç¬¬1æ‰¹éªŒè¯ | 0.5å¤© |
| ç¬¬2æ‰¹ï¼ˆ6ä¸ªä¸šåŠ¡æœåŠ¡ï¼‰ | 3-4å¤© |
| ç¬¬2æ‰¹éªŒè¯ | 1å¤© |
| **æ€»è®¡** | **5.5-7.5å¤©** |

---

## 20. 3-7å·æ–‡ä»¶è¯¦ç»†æ‹†åˆ†æ–¹æ¡ˆ

### 20.1 MarketListingService.js æ‹†åˆ†æ–¹æ¡ˆï¼ˆ2,294è¡Œ â†’ 3ä¸ªå­æœåŠ¡ï¼‰

**å½“å‰æœåŠ¡é”®**ï¼š`market_listing`  
**å½“å‰ç±»å‹**ï¼šé™æ€ç±»  
**è°ƒç”¨æ–¹**ï¼š5ä¸ªè·¯ç”±æ–‡ä»¶

#### æ–¹æ³•åˆ†ç±»

| å­æœåŠ¡ | èŒè´£ | æ–¹æ³• | é¢„ä¼°è¡Œæ•° |
|--------|------|------|----------|
| **ListingValidationService** | æŒ‚ç‰Œæ ¡éªŒï¼ˆç™½åå•ã€ä»·æ ¼ã€é£æ§ï¼‰ | `validateListingAssetWhitelist`, `validatePriceRange`, `validateSameItemSingleCurrency`, `validateRiskLimitsForListing`, `getListingConfig`, `clearConfigCache` | ~500è¡Œ |
| **ListingOperationService** | æŒ‚ç‰Œæ“ä½œï¼ˆåˆ›å»ºã€æ’¤å›ã€æš‚åœï¼‰ | `createListing`, `withdrawListing`, `createFungibleAssetListing`, `withdrawFungibleAssetListing`, `adminForceWithdrawListing`, `pauseListingForAsset`, `resumeListingForAsset`, `isAssetListingPaused`, `getPausedAssets`, `_cancelBuyerOrdersForListing` | ~1000è¡Œ |
| **ListingQueryService** | æŒ‚ç‰ŒæŸ¥è¯¢ | `getListingById`, `getUserListings`, `getMarketListings`, `getUserActiveListingCount`, `getFilterFacets` | ~700è¡Œ |

#### ç›®æ ‡æ–‡ä»¶ç»“æ„

```
services/market-listing/
â”œâ”€â”€ index.js                        # ç›´æ¥å¯¼å‡º
â”œâ”€â”€ ListingValidationService.js     # ~500è¡Œ - æ ¡éªŒé€»è¾‘
â”œâ”€â”€ ListingOperationService.js      # ~1000è¡Œ - æ“ä½œé€»è¾‘
â””â”€â”€ ListingQueryService.js          # ~700è¡Œ - æŸ¥è¯¢é€»è¾‘
```

#### æœåŠ¡æ³¨å†Œï¼ˆservices/index.jsï¼‰

```javascript
const { ListingValidationService, ListingOperationService, ListingQueryService } = require('./market-listing')

// ä¸šåŠ¡åŸŸä¼˜å…ˆå‘½åï¼šmarket_listing_*
this._services.set('market_listing_validation', ListingValidationService)
this._services.set('market_listing_operation', ListingOperationService)
this._services.set('market_listing_query', ListingQueryService)
```

#### è°ƒç”¨æ–¹ä¿®æ”¹æ¸…å•

| æ–‡ä»¶ | è°ƒç”¨æ–¹æ³• | ä¿®æ”¹åæœåŠ¡ |
|------|----------|------------|
| routes/v4/market/sell.js | `createListing`, `withdrawListing` | `market_listing_operation` |
| routes/v4/market/listings.js | `getMarketListings`, `getFilterFacets` | `market_listing_query` |
| routes/v4/market/manage.js | `getUserListings`, `withdrawListing` | `market_listing_query`, `market_listing_operation` |
| routes/v4/market/buy.js | `getListingById` | `market_listing_query` |
| routes/v4/console/marketplace.js | `adminForceWithdrawListing`, `getMarketListings` | `market_listing_operation`, `market_listing_query` |

---

### 20.2 ExchangeService.js æ‹†åˆ†æ–¹æ¡ˆï¼ˆ1,873è¡Œ â†’ 3ä¸ªå­æœåŠ¡ï¼‰

**å½“å‰æœåŠ¡é”®**ï¼š`exchange_market`  
**å½“å‰ç±»å‹**ï¼šé™æ€ç±»  
**è°ƒç”¨æ–¹**ï¼š1ä¸ªè·¯ç”±æ–‡ä»¶

#### æ–¹æ³•åˆ†ç±»

| å­æœåŠ¡ | èŒè´£ | æ–¹æ³• | é¢„ä¼°è¡Œæ•° |
|--------|------|------|----------|
| **ExchangeItemService** | å•†å“ç®¡ç†ï¼ˆCRUDï¼‰ | `createExchangeItem`, `updateExchangeItem`, `deleteExchangeItem`, `getItemDetail`, `getMarketItems`, `getAdminMarketItems`, `getMarketItemStatistics` | ~700è¡Œ |
| **ExchangeOrderService** | è®¢å•å¤„ç†ï¼ˆå…‘æ¢ã€çŠ¶æ€ï¼‰ | `exchangeItem`, `getUserOrders`, `getOrderDetail`, `updateOrderStatus`, `getAdminOrders`, `getAdminOrderDetail`, `_generateOrderNo` | ~800è¡Œ |
| **ExchangeStatsService** | ç»Ÿè®¡ä¸ç›‘æ§ | `getMarketStatistics`, `getUserListingStats`, `checkTimeoutAndAlert` | ~300è¡Œ |

#### ç›®æ ‡æ–‡ä»¶ç»“æ„

```
services/exchange/
â”œâ”€â”€ index.js                    # ç›´æ¥å¯¼å‡º
â”œâ”€â”€ ExchangeItemService.js      # ~700è¡Œ - å•†å“ç®¡ç†
â”œâ”€â”€ ExchangeOrderService.js     # ~800è¡Œ - è®¢å•å¤„ç†
â””â”€â”€ ExchangeStatsService.js     # ~300è¡Œ - ç»Ÿè®¡ç›‘æ§
```

#### æœåŠ¡æ³¨å†Œï¼ˆservices/index.jsï¼‰

```javascript
const { ExchangeItemService, ExchangeOrderService, ExchangeStatsService } = require('./exchange')

// ä¸šåŠ¡åŸŸä¼˜å…ˆå‘½åï¼šmarket_exchange_*ï¼ˆäº¤æ˜“åŸŸä¸‹çš„å…‘æ¢å­åŸŸï¼‰
this._services.set('market_exchange_item', ExchangeItemService)
this._services.set('market_exchange_order', ExchangeOrderService)
this._services.set('market_exchange_stats', ExchangeStatsService)
```

#### è°ƒç”¨æ–¹ä¿®æ”¹æ¸…å•

| æ–‡ä»¶ | è°ƒç”¨æ–¹æ³• | ä¿®æ”¹åæœåŠ¡ |
|------|----------|------------|
| routes/v4/console/marketplace.js | `createExchangeItem`, `updateExchangeItem`, `deleteExchangeItem`, `getAdminMarketItems`, `getAdminOrders` | `market_exchange_item`, `market_exchange_order` |

---

### 20.3 ConsumptionService.js æ‹†åˆ†æ–¹æ¡ˆï¼ˆ1,825è¡Œ â†’ 3ä¸ªå­æœåŠ¡ï¼‰

**å½“å‰æœåŠ¡é”®**ï¼š`consumption`  
**å½“å‰ç±»å‹**ï¼šé™æ€ç±»  
**è°ƒç”¨æ–¹**ï¼š1ä¸ªè·¯ç”±æ–‡ä»¶

#### æ–¹æ³•åˆ†ç±»

| å­æœåŠ¡ | èŒè´£ | æ–¹æ³• | é¢„ä¼°è¡Œæ•° |
|--------|------|------|----------|
| **ConsumptionSubmitService** | æäº¤ä¸å®¡æ ¸ | `merchantSubmitConsumption`, `approveConsumption`, `rejectConsumption`, `getUserInfoByQRCode`, `getBudgetRatio` | ~700è¡Œ |
| **ConsumptionRecordService** | è®°å½•ç®¡ç† | `getUserConsumptionRecords`, `getPendingConsumptionRecords`, `getAdminRecords`, `getConsumptionDetailWithAuth`, `getConsumptionRecordDetail`, `getRecordById`, `softDeleteRecord`, `restoreRecord` | ~700è¡Œ |
| **ConsumptionMerchantService** | å•†æˆ·ç«¯åŠŸèƒ½ | `getMerchantRecords`, `getMerchantRecordDetail`, `getMerchantStats`, `getUserConsumptionStats` | ~400è¡Œ |

#### ç›®æ ‡æ–‡ä»¶ç»“æ„

```
services/consumption/
â”œâ”€â”€ index.js                        # ç›´æ¥å¯¼å‡º
â”œâ”€â”€ ConsumptionSubmitService.js     # ~700è¡Œ - æäº¤å®¡æ ¸
â”œâ”€â”€ ConsumptionRecordService.js     # ~700è¡Œ - è®°å½•ç®¡ç†
â””â”€â”€ ConsumptionMerchantService.js   # ~400è¡Œ - å•†æˆ·ç«¯
```

#### æœåŠ¡æ³¨å†Œï¼ˆservices/index.jsï¼‰

```javascript
const { ConsumptionSubmitService, ConsumptionRecordService, ConsumptionMerchantService } = require('./consumption')

// ä¸šåŠ¡åŸŸä¼˜å…ˆå‘½åï¼šconsumption_*ï¼ˆæ¶ˆè´¹åŸŸï¼‰
this._services.set('consumption_submit', ConsumptionSubmitService)
this._services.set('consumption_record', ConsumptionRecordService)
this._services.set('consumption_merchant', ConsumptionMerchantService)
```

#### è°ƒç”¨æ–¹ä¿®æ”¹æ¸…å•

| æ–‡ä»¶ | è°ƒç”¨æ–¹æ³• | ä¿®æ”¹åæœåŠ¡ |
|------|----------|------------|
| routes/v4/console/consumption.js | `approveConsumption`, `rejectConsumption`, `getAdminRecords`, `getConsumptionRecordDetail` | `consumption_submit`, `consumption_record` |

---

### 20.4 ReportingService.js æ‹†åˆ†æ–¹æ¡ˆï¼ˆ1,819è¡Œ â†’ 3ä¸ªå­æœåŠ¡ï¼‰

**å½“å‰æœåŠ¡é”®**ï¼š`reporting`  
**å½“å‰ç±»å‹**ï¼šé™æ€ç±»  
**è°ƒç”¨æ–¹**ï¼š4ä¸ªè·¯ç”±æ–‡ä»¶

#### æ–¹æ³•åˆ†ç±»

| å­æœåŠ¡ | èŒè´£ | æ–¹æ³• | é¢„ä¼°è¡Œæ•° |
|--------|------|------|----------|
| **SystemStatsService** | ç³»ç»Ÿçº§ç»Ÿè®¡ | `getSimpleSystemStats`, `getTodayStats`, `getSystemOverview`, `getPerformanceReport`, `getInventoryAdminStatistics`, `_formatUptime` | ~500è¡Œ |
| **ChartDataService** | å›¾è¡¨æ•°æ® | `getChartsData`, `getUserGrowthData`, `getUserTypesData`, `getLotteryTrendData`, `getConsumptionTrendData`, `getPointsFlowData`, `getTopPrizesData`, `getActiveHoursData` | ~700è¡Œ |
| **AnalyticsQueryService** | åˆ†ææŸ¥è¯¢ | `getDecisionAnalytics`, `getLotteryTrends`, `getUserStatistics` | ~600è¡Œ |

#### ç›®æ ‡æ–‡ä»¶ç»“æ„

```
services/reporting/
â”œâ”€â”€ index.js                    # ç›´æ¥å¯¼å‡º
â”œâ”€â”€ SystemStatsService.js       # ~500è¡Œ - ç³»ç»Ÿç»Ÿè®¡
â”œâ”€â”€ ChartDataService.js         # ~700è¡Œ - å›¾è¡¨æ•°æ®
â””â”€â”€ AnalyticsQueryService.js    # ~600è¡Œ - åˆ†ææŸ¥è¯¢
```

#### æœåŠ¡æ³¨å†Œï¼ˆservices/index.jsï¼‰

```javascript
const { SystemStatsService, ChartDataService, AnalyticsQueryService } = require('./reporting')

// ä¸šåŠ¡åŸŸä¼˜å…ˆå‘½åï¼šreport_*ï¼ˆæŠ¥è¡¨åŸŸï¼‰
this._services.set('report_system_stats', SystemStatsService)
this._services.set('report_chart_data', ChartDataService)
this._services.set('report_analytics', AnalyticsQueryService)
```

#### è°ƒç”¨æ–¹ä¿®æ”¹æ¸…å•

| æ–‡ä»¶ | è°ƒç”¨æ–¹æ³• | ä¿®æ”¹åæœåŠ¡ |
|------|----------|------------|
| routes/v4/console/analytics.js | `getDecisionAnalytics`, `getLotteryTrends` | `report_analytics` |
| routes/v4/system/statistics.js | `getSimpleSystemStats`, `getChartsData` | `report_system_stats`, `report_chart_data` |
| routes/v4/system/status.js | `getSystemOverview`, `getPerformanceReport` | `report_system_stats` |
| routes/v4/system/user-stats.js | `getUserStatistics` | `report_analytics` |

---

### 20.5 AdminLotteryService.js æ‹†åˆ†æ–¹æ¡ˆï¼ˆ1,781è¡Œ â†’ 3ä¸ªå­æœåŠ¡ï¼‰

**å½“å‰æœåŠ¡é”®**ï¼š`admin_lottery`  
**å½“å‰ç±»å‹**ï¼šé™æ€ç±»  
**è°ƒç”¨æ–¹**ï¼š1ä¸ªè·¯ç”±æ–‡ä»¶

#### æ–¹æ³•åˆ†ç±»

| å­æœåŠ¡ | èŒè´£ | æ–¹æ³• | é¢„ä¼°è¡Œæ•° |
|--------|------|------|----------|
| **InterventionService** | å¹²é¢„ç®¡ç†ï¼ˆå¼ºåˆ¶ä¸­å¥–/ä¸ä¸­å¥–ï¼‰ | `forceWinForUser`, `forceLoseForUser`, `adjustUserProbability`, `setUserQueue`, `getUserManagementStatus`, `clearUserSettings`, `getInterventionList`, `getInterventionById`, `cancelIntervention`, `_formatInterventionItem`, `_formatInterventionDetail` | ~800è¡Œ |
| **CampaignAdminService** | æ´»åŠ¨ç®¡ç†ï¼ˆé¢„ç®—ã€çŠ¶æ€ï¼‰ | `getActiveCampaigns`, `updateCampaignBudget`, `supplementCampaignBudget`, `syncCampaignStatus` | ~600è¡Œ |
| **LotterySchedulerService** | å®šæ—¶ä»»åŠ¡ | `initialize`, `resetDailyWinCounts` | ~300è¡Œ |

#### ç›®æ ‡æ–‡ä»¶ç»“æ„

```
services/admin-lottery/
â”œâ”€â”€ index.js                    # ç›´æ¥å¯¼å‡º
â”œâ”€â”€ InterventionService.js      # ~800è¡Œ - å¹²é¢„ç®¡ç†
â”œâ”€â”€ CampaignAdminService.js     # ~600è¡Œ - æ´»åŠ¨ç®¡ç†
â””â”€â”€ LotterySchedulerService.js  # ~300è¡Œ - å®šæ—¶ä»»åŠ¡
```

#### æœåŠ¡æ³¨å†Œï¼ˆservices/index.jsï¼‰

```javascript
const { InterventionService, CampaignAdminService, LotterySchedulerService } = require('./admin-lottery')

// ä¸šåŠ¡åŸŸä¼˜å…ˆå‘½åï¼šlottery_admin_*ï¼ˆæŠ½å¥–åŸŸä¸‹çš„ç®¡ç†å­åŸŸï¼‰
this._services.set('lottery_admin_intervention', InterventionService)
this._services.set('lottery_admin_campaign', CampaignAdminService)
this._services.set('lottery_admin_scheduler', LotterySchedulerService)
```

#### è°ƒç”¨æ–¹ä¿®æ”¹æ¸…å•

| æ–‡ä»¶ | è°ƒç”¨æ–¹æ³• | ä¿®æ”¹åæœåŠ¡ |
|------|----------|------------|
| routes/v4/console/campaign-budget.js | `updateCampaignBudget`, `supplementCampaignBudget`, `getActiveCampaigns` | `lottery_admin_campaign` |

---

### 20.6 index.js ç›´æ¥å¯¼å‡ºæ¨¡å¼ç¤ºä¾‹

ä»¥ä¸‹æ˜¯å„ç›®å½• `index.js` çš„æ ‡å‡†å®ç°æ¨¡æ¿ï¼š

```javascript
// services/market-listing/index.js
'use strict'

/**
 * å¸‚åœºæŒ‚ç‰Œæ¨¡å—ç´¢å¼•
 * æä¾›ç»Ÿä¸€çš„æŒ‚ç‰ŒæœåŠ¡è®¿é—®æ¥å£
 * 
 * @module services/market-listing
 * @version 1.0.0
 * @date 2026-01-31
 */

const ListingValidationService = require('./ListingValidationService')
const ListingOperationService = require('./ListingOperationService')
const ListingQueryService = require('./ListingQueryService')

module.exports = {
  ListingValidationService,
  ListingOperationService,
  ListingQueryService
}
```

```javascript
// services/exchange/index.js
'use strict'

const ExchangeItemService = require('./ExchangeItemService')
const ExchangeOrderService = require('./ExchangeOrderService')
const ExchangeStatsService = require('./ExchangeStatsService')

module.exports = {
  ExchangeItemService,
  ExchangeOrderService,
  ExchangeStatsService
}
```

```javascript
// services/consumption/index.js
'use strict'

const ConsumptionSubmitService = require('./ConsumptionSubmitService')
const ConsumptionRecordService = require('./ConsumptionRecordService')
const ConsumptionMerchantService = require('./ConsumptionMerchantService')

module.exports = {
  ConsumptionSubmitService,
  ConsumptionRecordService,
  ConsumptionMerchantService
}
```

```javascript
// services/reporting/index.js
'use strict'

const SystemStatsService = require('./SystemStatsService')
const ChartDataService = require('./ChartDataService')
const AnalyticsQueryService = require('./AnalyticsQueryService')

module.exports = {
  SystemStatsService,
  ChartDataService,
  AnalyticsQueryService
}
```

```javascript
// services/admin-lottery/index.js
'use strict'

const InterventionService = require('./InterventionService')
const CampaignAdminService = require('./CampaignAdminService')
const LotterySchedulerService = require('./LotterySchedulerService')

module.exports = {
  InterventionService,
  CampaignAdminService,
  LotterySchedulerService
}
```

---

### 20.7 æ‹†åˆ†æ±‡æ€»è¡¨ï¼ˆä¸šåŠ¡åŸŸä¼˜å…ˆå‘½åï¼‰

| åºå· | åŸæ–‡ä»¶ | åŸæœåŠ¡é”® | æ‹†åˆ†åæœåŠ¡é”®ï¼ˆä¸šåŠ¡åŸŸä¼˜å…ˆï¼‰ | è°ƒç”¨æ–¹æ•° |
|------|--------|----------|----------------------------|----------|
| 1 | LotteryAnalyticsService | `lottery_analytics` | `lottery_analytics_realtime`, `lottery_analytics_statistics`, `lottery_analytics_report`, `lottery_analytics_user`, `lottery_analytics_campaign` | 5 |
| 2 | AssetService | `asset` | `asset_balance`, `asset_item`, `asset_query` | 34 |
| 3 | MarketListingService | `market_listing` | `market_listing_validation`, `market_listing_operation`, `market_listing_query` | 5 |
| 4 | ExchangeService | `exchange_market` | `market_exchange_item`, `market_exchange_order`, `market_exchange_stats` | 1 |
| 5 | ConsumptionService | `consumption` | `consumption_submit`, `consumption_record`, `consumption_merchant` | 1 |
| 6 | ReportingService | `reporting` | `report_system_stats`, `report_chart_data`, `report_analytics` | 4 |
| 7 | AdminLotteryService | `admin_lottery` | `lottery_admin_intervention`, `lottery_admin_campaign`, `lottery_admin_scheduler` | 1 |

**æ‹†åˆ†å‰**ï¼š7ä¸ªå¤§æœåŠ¡ï¼Œ17,588è¡Œ  
**æ‹†åˆ†å**ï¼š23ä¸ªå­æœåŠ¡ï¼Œå¹³å‡~760è¡Œ/æœåŠ¡

### 20.8 æœåŠ¡é”®å‘½åè§„èŒƒè¯´æ˜

é‡‡ç”¨**ä¸šåŠ¡åŸŸä¼˜å…ˆ**å‘½åè§„èŒƒï¼ˆå†³ç­–7=Bï¼‰ï¼Œå…·ä½“è§„åˆ™ï¼š

| ä¸šåŠ¡åŸŸ | æœåŠ¡é”®å‰ç¼€ | ç¤ºä¾‹ | è¯´æ˜ |
|--------|-----------|------|------|
| æŠ½å¥–åˆ†æ | `lottery_analytics_*` | `lottery_analytics_realtime` | æŠ½å¥–åŸŸ â†’ åˆ†æå­åŸŸ |
| æŠ½å¥–ç®¡ç† | `lottery_admin_*` | `lottery_admin_intervention` | æŠ½å¥–åŸŸ â†’ ç®¡ç†å­åŸŸ |
| èµ„äº§ | `asset_*` | `asset_balance` | èµ„äº§åŸŸï¼ˆé¡¶å±‚ï¼‰ |
| å¸‚åœºæŒ‚ç‰Œ | `market_listing_*` | `market_listing_validation` | å¸‚åœºåŸŸ â†’ æŒ‚ç‰Œå­åŸŸ |
| å¸‚åœºå…‘æ¢ | `market_exchange_*` | `market_exchange_item` | å¸‚åœºåŸŸ â†’ å…‘æ¢å­åŸŸ |
| æ¶ˆè´¹ | `consumption_*` | `consumption_submit` | æ¶ˆè´¹åŸŸï¼ˆé¡¶å±‚ï¼‰ |
| æŠ¥è¡¨ | `report_*` | `report_system_stats` | æŠ¥è¡¨åŸŸï¼ˆé¡¶å±‚ï¼‰ |

**å‘½åä¼˜åŠ¿**ï¼š
- âœ… æŒ‰ä¸šåŠ¡åŸŸè‡ªç„¶åˆ†ç»„ï¼Œä¾¿äºç›‘æ§å’Œæ—¥å¿—è¿‡æ»¤
- âœ… æœªæ¥æ‰©å±•æ—¶å‘½åç©ºé—´æ¸…æ™°ï¼ˆå¦‚ `market_auction_*`ï¼‰
- âœ… æœåŠ¡é”®å³ä¸šåŠ¡è¯­ä¹‰ï¼Œä»£ç è‡ªæ–‡æ¡£åŒ–

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv11.0  
**åˆ›å»ºæ—¶é—´**ï¼š2026-01-30  
**æ›´æ–°æ—¶é—´**ï¼š2026-01-31  
**é€‚ç”¨èŒƒå›´**ï¼šåç«¯æ•°æ®åº“é¡¹ç›®æœåŠ¡ä»£ç é‡æ„  
**æ ¸å¿ƒå†³ç­–**ï¼šä¸ä½¿ç”¨é—¨é¢æ¨¡å¼ï¼Œç›´æ¥æ‹†åˆ†å¹¶æ‰¹é‡æ›¿æ¢è°ƒç”¨æ–¹  
**æŠ€æœ¯å¯¹é½**ï¼šServiceManager å•ä¾‹æ¨¡å¼ + snake_case æœåŠ¡é”®ï¼ˆä¸šåŠ¡åŸŸä¼˜å…ˆï¼‰ + äº‹åŠ¡è¾¹ç•Œå¼ºåˆ¶æ£€æŸ¥  
**å‘½åè§„èŒƒ**ï¼šç›®å½•ä½¿ç”¨ `lottery-analytics/` é¿å…ä¸ç°æœ‰ `lottery/` å†²çªï¼›æœåŠ¡é”®ä½¿ç”¨ä¸šåŠ¡åŸŸä¼˜å…ˆï¼ˆå¦‚ `lottery_analytics_realtime`ï¼‰  
**å®æ–½åŸåˆ™**ï¼šåˆ›å»ºæ–°æ–‡ä»¶å‰å¿…é¡»æœç´¢ç°æœ‰ä»£ç ï¼ŒåŒæ­¥ä¿®æ”¹æ‰€æœ‰ä¾èµ–æ–‡ä»¶  
**é…å¥—å·¥ä½œ**ï¼šæœåŠ¡è°ƒç”¨é“¾è·¯è¿½è¸ª + æœåŠ¡é—´ä¾èµ–ä¼˜åŒ–  
**æ‹æ¿å†³ç­–ï¼ˆ7é¡¹ï¼‰**ï¼š
1. ä¸€æ¬¡æ€§æ‹†åˆ†7ä¸ªå¤§æ–‡ä»¶
2. URLé‡å‘½åï¼ˆå‰åç«¯åŒæ­¥ï¼‰
3. ä¿æŒåŸæœ‰æœåŠ¡ç±»å‹ï¼ˆå®ä¾‹åŒ–/é™æ€å„è‡ªä¿æŒï¼‰
4. ä¸ä¿ç•™å‘åå…¼å®¹åˆ«å
5. å¹¶è¡Œæ‹†åˆ†
6. æœåŠ¡ç±»å‹ï¼šä¿æŒåŸæœ‰ï¼Œéœ€è¦çŠ¶æ€çš„æ‰å®ä¾‹åŒ–ï¼ˆæ¸¸æˆå…¬å¸æ¨¡å¼ï¼‰
7. æœåŠ¡é”®å‘½åï¼šä¸šåŠ¡åŸŸä¼˜å…ˆï¼ˆå¦‚ `market_listing_*`ã€`lottery_analytics_*`ï¼‰

**å¯¼å‡ºæ¨¡å¼**ï¼šindex.js ä½¿ç”¨ç›´æ¥å¯¼å‡ºæ¨¡å¼ï¼ˆåŒ pipeline/ï¼‰ï¼Œä¸ä½¿ç”¨æœåŠ¡å®¹å™¨ç±»
