# æš´åŠ›ç»Ÿä¸€é‡æ„æ‰§è¡Œæ–¹æ¡ˆï¼ˆå®Œæ•´ç‰ˆï¼‰

**ç”Ÿæˆæ—¶é—´**ï¼š2025-12-18  
**ç›®æ ‡**ï¼šå½»åº•æ¶ˆç­æ–°æ—§å¹¶å­˜çš„è¿ç§»åŒè½¨/å…¼å®¹åŒè½¨ï¼Œé™ä½æŠ€æœ¯ç»´æŠ¤å¤æ‚åº¦ä¸æŠ€æœ¯å€ºåŠ¡  
**åŸåˆ™**ï¼šä¸šåŠ¡åŠŸèƒ½è¡Œä¸ºä¸å˜ï¼Œä½†ä¸å†å…¼å®¹æ—§ä»£ç /æ—§è·¯ç”±/æ—§æ–¹æ¡ˆï¼Œç›´æ¥æš´åŠ›é‡æ„ç§»é™¤æ‰€æœ‰æ—§æ–¹æ¡ˆ  
**ä¾æ®**ï¼šä»…åŸºäºå½“å‰ä»“åº“ä»£ç /è¿ç§»/è¡¨ç»“æ„ç°çŠ¶ï¼ˆä¸å¼•ç”¨ä»»ä½•å†å²æŠ¥å‘Š/å¤–éƒ¨æ–‡æ¡£ï¼‰

---

## ğŸ“Š Part 1ï¼šæˆ˜ç•¥æ€»è§ˆ

### 1.1 å½“å‰ä»£ç æ€è¯Šæ–­ç»“æœï¼ˆå·²æ ¸æŸ¥ï¼‰

#### âœ… å·²å®Œæˆç»Ÿä¸€ï¼ˆæ— éœ€æ”¹é€ ï¼‰

1. **WebSocket**ï¼šåªç”¨ `socket.io`ï¼ˆä¾èµ–å·²åˆ é™¤ `ws`ï¼‰
2. **Rediså®¢æˆ·ç«¯**ï¼šåªç”¨ `ioredis + utils/UnifiedRedisClient.js`ï¼ˆä¾èµ–å·²åˆ é™¤ `redis`ã€`rate-limit-redis`ï¼‰
3. **æ—¶é—´å·¥å…·**ï¼šåªç”¨ `utils/timeHelper.js`ï¼ˆä¾èµ–å·²åˆ é™¤ `moment`ã€`moment-timezone`ï¼Œä»£ç æ— å¼•ç”¨ï¼‰
4. **æ—¥å¿—ç³»ç»Ÿ**ï¼šå·²ç»Ÿä¸€åˆ° `utils/logger.js`ï¼ˆ64å¤„å¼•ç”¨ï¼Œæ—§ `UnifiedLotteryEngine/utils/Logger.js` å·²æ— å®é™…å¼•ç”¨ï¼Œä»…åœ¨é‡æ„è„šæœ¬å’Œå¤‡ä»½é‡Œæ®‹ç•™ï¼‰
5. **å¤‡ä»½å®ç°æ–‡ä»¶**ï¼šä»…å‰© 1 ä¸ª `services/AssetService.js.backup-phase1`ï¼ˆéœ€åˆ é™¤ï¼‰

#### ğŸ”´ ä»å­˜åœ¨åŒè½¨/å…¼å®¹ï¼ˆå¿…é¡»æ”¹é€ ï¼‰

1. **é™æµåŒå®ç°**ï¼šRedisæ»‘çª—ä¸»å®ç° + `express-rate-limit` åå¤‡åŒæ—¶æŒ‚è½½ï¼ˆéœ€é€‰å®šå”¯ä¸€ç­–ç•¥ï¼‰
2. **è·¯ç”±å…¼å®¹æŒ‚è½½**ï¼š`routes/v4/unified-engine/admin/index.js` åŒä¸€ router æŒ‚ä¸¤æ¬¡ï¼ˆ`/system/*` + æ ¹è·¯å¾„ï¼‰
3. **ç§¯åˆ†/èµ„äº§åŒè´¦æœ¬**ï¼š`user_points_accounts/points_transactions` ä¸ `account_asset_balances/asset_transactions` å¹¶å­˜ï¼ˆæœ€å¤§å€ºåŠ¡æºï¼‰
4. **åº“å­˜/ç‰©å“åŒçœŸç›¸**ï¼š`user_inventory` ä¸ `item_instances` å¹¶å­˜ï¼ˆInventoryService ç”¨æ—§è¡¨ï¼ŒBackpackService ç”¨æ–°è¡¨ï¼‰
5. **è¿ç§»è„šæœ¬å¤šå…¥å£**ï¼š`scripts/execute_migration.js` + `scripts/execute_migration_robust.js` å¹¶å­˜

### 1.2 æœ€ç»ˆå”¯ä¸€çœŸç›¸ï¼ˆç»Ÿä¸€åçš„æ ‡å‡†ï¼‰

#### æ•°æ®åº“å±‚å”¯ä¸€çœŸç›¸

| é¢†åŸŸ             | å”¯ä¸€çœŸç›¸è¡¨               | åˆ é™¤çš„æ—§è¡¨             | å¤‡æ³¨                                     |
| ---------------- | ------------------------ | ---------------------- | ---------------------------------------- |
| **è´¦æˆ·**         | `accounts`               | æ—                      | æ”¯æŒç”¨æˆ·è´¦æˆ· + ç³»ç»Ÿè´¦æˆ·                  |
| **èµ„äº§ä½™é¢**     | `account_asset_balances` | `user_points_accounts` | ç»Ÿä¸€ä½™é¢çœŸç›¸ï¼ˆç§¯åˆ†/è™šæ‹Ÿå¸/ææ–™å…¨éƒ¨å¹¶å…¥ï¼‰ |
| **èµ„äº§æµæ°´**     | `asset_transactions`     | `points_transactions`  | ç»Ÿä¸€æµæ°´çœŸç›¸ï¼ˆå¹‚ç­‰æ€§ + å®¡è®¡ï¼‰            |
| **ä¸å¯å åŠ ç‰©å“** | `item_instances`         | `user_inventory`       | ç‰©å“æ‰€æœ‰æƒçœŸç›¸                           |
| **æ ¸é”€è®¢å•**     | `redemption_orders`      | æ—                      | æ ¸é”€ç ä¸è®¢å•ç®¡ç†                         |
| **äº¤æ˜“è®¢å•**     | `trade_orders`           | æ—                      | å¸‚åœºäº¤æ˜“è®¢å•                             |

#### èµ„äº§ç æ ‡å‡†ï¼ˆå›ºå®šä¸”å…¨é“¾è·¯ä¸€è‡´ï¼‰

| èµ„äº§ç            | ç”¨é€”                                     | å¯¹åº”æ—§å­—æ®µ                                     | å¤‡æ³¨             |
| ---------------- | ---------------------------------------- | ---------------------------------------------- | ---------------- |
| `POINTS_DISPLAY` | æ˜¾ç¤ºç§¯åˆ†ï¼ˆç”¨æˆ·å¯è§ï¼Œæ§åˆ¶"èƒ½å¦æŠ½å¥–"ï¼‰     | `user_points_accounts.available_points`        | å‰ç«¯å±•ç¤ºä½™é¢     |
| `POINTS_BUDGET`  | é¢„ç®—ç§¯åˆ†ï¼ˆå†…éƒ¨é£æ§ï¼Œæ§åˆ¶"èƒ½æŠ½ä¸­ä»€ä¹ˆå¥–"ï¼‰ | `user_points_accounts.remaining_budget_points` | å¥–å“æˆæœ¬ä¸Šé™çº¦æŸ |
| `CRYSTAL_RED`    | çº¢æ°´æ™¶ï¼ˆè™šæ‹Ÿè´§å¸ï¼Œç”¨äºå…‘æ¢å®ç‰©ï¼‰         | `user_inventory` é‡Œçš„è™šæ‹Ÿå¥–å“                  | å¯å åŠ è™šæ‹Ÿèµ„äº§   |
| `DIAMOND`        | é’»çŸ³ï¼ˆå¸‚åœºäº¤æ˜“è´§å¸ï¼‰                     | å·²å­˜åœ¨                                         | ä¿æŒä¸å˜         |
| `MATERIAL_*`     | ææ–™èµ„äº§ï¼ˆå¦‚ç¢ç‰‡ï¼‰                       | å·²å­˜åœ¨                                         | ä¿æŒä¸å˜         |

#### æœåŠ¡å±‚å”¯ä¸€å…¥å£

| é¢†åŸŸ         | å”¯ä¸€æœåŠ¡                 | åˆ é™¤çš„æ—§æœåŠ¡                    | å¤‡æ³¨                                                |
| ------------ | ------------------------ | ------------------------------- | --------------------------------------------------- |
| **èµ„äº§ç®¡ç†** | `AssetService`           | `PointsService`ï¼ˆ**å®Œå…¨åˆ é™¤**ï¼‰ | ç»Ÿä¸€èµ„äº§æ“ä½œå…¥å£ï¼Œæ‰€æœ‰ç§¯åˆ†æ“ä½œç›´æ¥è°ƒç”¨ AssetService |
| **èƒŒåŒ…æŸ¥è¯¢** | `BackpackService`        | `InventoryService`ï¼ˆåˆ é™¤ï¼‰      | åŒè½¨ç»Ÿä¸€æŸ¥è¯¢ï¼ˆassets + itemsï¼‰                      |
| **æ ¸é”€ç®¡ç†** | `RedemptionOrderService` | æ—                               | æ ¸é”€ç ç”Ÿæˆä¸éªŒè¯                                    |
| **äº¤æ˜“å¸‚åœº** | `TradeOrderService`      | æ—                               | å¸‚åœºäº¤æ˜“è®¢å•ç®¡ç†                                    |

### 1.3 æŠ€æœ¯å†³ç­–å·²ç¡®è®¤ï¼ˆ2025-12-18ï¼‰

#### å†³ç­– 1ï¼šé™æµç­–ç•¥

**âœ… é€‰å®šæ–¹æ¡ˆ A**ï¼šåªä¿ç•™ Redis æ»‘çª—ï¼ŒRedis ä¸å¯ç”¨æ—¶ fail-openï¼ˆä¸é™æµï¼Œä»…å‘Šè­¦ï¼‰

**åˆ é™¤**ï¼š

- `app.js` çš„ `fallbackLimiter` å®šä¹‰ä¸æŒ‚è½½
- æ‰€æœ‰å…³äº"åå¤‡é™æµå™¨"çš„æ³¨é‡Šä¸æ—¥å¿—

**ä¿®æ”¹**ï¼š

- `middleware/RateLimiterMiddleware.js` çš„ catch å—æ”¹ä¸ºæ˜ç¡®çš„ fail-open + P1 å‘Šè­¦

**ç†ç”±**ï¼š

- Redis æ»‘çª—é™æµæ›´ç²¾å‡†ï¼ˆç§’çº§æ»‘åŠ¨çª—å£ vs åˆ†é’Ÿçº§å›ºå®šçª—å£ï¼‰
- fail-open ç­–ç•¥ä¿è¯ Redis æ•…éšœæ—¶ä¸šåŠ¡ä¸å—å½±å“ï¼ˆå¯ç”¨æ€§ä¼˜å…ˆï¼‰
- ç›‘æ§å‘Šè­¦ç¡®ä¿ Redis æ•…éšœèƒ½è¢«åŠæ—¶å‘ç°å’Œä¿®å¤
- æ¶ˆç­åŒå®ç°ï¼Œé™ä½ç»´æŠ¤å¤æ‚åº¦

#### å†³ç­– 2ï¼šPointsService ä¿ç•™æ–¹å¼

**âœ… é€‰å®šæ–¹æ¡ˆ A**ï¼šå®Œå…¨åˆ é™¤ `services/PointsService.js`ï¼Œæ‰€æœ‰ç§¯åˆ†æ“ä½œç›´æ¥è°ƒç”¨ `AssetService`

**åˆ é™¤**ï¼š

- `services/PointsService.js` æ•´ä¸ªæ–‡ä»¶
- `models/index.js` é‡Œå¯¹ PointsService çš„ä»»ä½•å¼•ç”¨

**æ”¹é€ **ï¼š

- æ‰€æœ‰ä¸šåŠ¡ä»£ç é‡Œçš„ `PointsService.addPoints(...)` æ”¹ä¸º `AssetService.changeBalance({ asset_code: 'POINTS_DISPLAY', ... })`
- æ‰€æœ‰ä¸šåŠ¡ä»£ç é‡Œçš„ `PointsService.consumeBudget(...)` æ”¹ä¸º `AssetService.changeBalance({ asset_code: 'POINTS_BUDGET', ... })`
- è·¯ç”±å±‚ `/api/v4/points/*` ä¿ç•™ï¼Œä½†å†…éƒ¨å®ç°æ”¹ä¸ºç›´æ¥è°ƒç”¨ `AssetService`

**ç†ç”±**ï¼š

- ä¸ä¿ç•™ä»»ä½•è¯­ä¹‰å°è£…å±‚ï¼Œé¿å…"ä¼ªç»Ÿä¸€"
- å¼ºåˆ¶å…¨ä»“åº“æ”¹ä¸ºç»Ÿä¸€çš„ `AssetService` + `asset_code` æ¨¡å¼
- æ¶ˆç­"ç§¯åˆ†"è¿™ä¸ªç‹¬ç«‹æ¦‚å¿µï¼Œç»Ÿä¸€ä¸ºèµ„äº§è´¦æœ¬é‡Œçš„èµ„äº§ç 
- é™ä½è®¤çŸ¥è´Ÿæ‹…ï¼šåªéœ€è¦è®°ä½ä¸€ä¸ªå…¥å£

### 1.4 æ”¹é€ å½±å“é¢ç»Ÿè®¡ï¼ˆåŸºäºå½“å‰ä»£ç  grep ç»“æœï¼‰

#### éœ€è¦æ”¹é€ çš„æ–‡ä»¶æ•°é‡

- **æ ¸å¿ƒä¸šåŠ¡**ï¼šçº¦ 15 ä¸ªæ–‡ä»¶ï¼ˆæŠ½å¥–/ç§¯åˆ†/æ¶ˆè´¹/å…‘æ¢/ç®¡ç†åå°ï¼‰
- **æµ‹è¯•æ–‡ä»¶**ï¼šçº¦ 20 ä¸ªæ–‡ä»¶
- **å·¥å…·è„šæœ¬**ï¼šçº¦ 10 ä¸ªæ–‡ä»¶
- **è·¯ç”±æ–‡ä»¶**ï¼šçº¦ 8 ä¸ªæ–‡ä»¶

**æ€»è®¡**ï¼šçº¦ 53 ä¸ªæ–‡ä»¶éœ€è¦æ”¹é€ ï¼ˆå»é™¤ backups/ å’Œé‡æ„è„šæœ¬ï¼‰

#### éœ€è¦åˆ é™¤çš„æ–‡ä»¶æ•°é‡

- **æ¨¡å‹**ï¼š3 ä¸ªæ–‡ä»¶
- **æœåŠ¡**ï¼š2 ä¸ªæ–‡ä»¶
- **å¤‡ä»½æ®‹ç•™**ï¼š1 ä¸ªæ–‡ä»¶
- **è„šæœ¬å¤šå…¥å£**ï¼š2 ä¸ªæ–‡ä»¶

**æ€»è®¡**ï¼š8 ä¸ªæ–‡ä»¶éœ€è¦åˆ é™¤

#### éœ€è¦åˆ é™¤çš„æ•°æ®åº“è¡¨

- `user_points_accounts`
- `points_transactions`
- `user_inventory`

**æ€»è®¡**ï¼š3 å¼ è¡¨éœ€è¦åˆ é™¤

---

## ğŸ“‹ Part 2ï¼šæ‰§è¡Œè¯¦ç»†æ¸…å•

### Phase 0ï¼šå‡†å¤‡é˜¶æ®µï¼ˆåœå†™å‰ 1-2 å°æ—¶ï¼‰

#### 0.1 å…¨é‡æ•°æ®å¤‡ä»½

```bash
# æ‰§è¡Œå®Œæ•´å¤‡ä»½ï¼ˆåŒ…å«æ‰€æœ‰è¡¨æ•°æ®ï¼‰
npm run backup:create

# éªŒè¯å¤‡ä»½å®Œæ•´æ€§
ls -lh backups/backup_$(date +%Y-%m-%d)/
```

#### 0.2 åˆ›å»ºå¹¶æµ‹è¯•è¿ç§»è„šæœ¬

**æ–‡ä»¶**ï¼š`migrations/20251218230000-brutal-unify-points-to-assets.js`

**è¿ç§»å†…å®¹**ï¼ˆSQLï¼‰ï¼š

```sql
-- 1. ä¸ºæ‰€æœ‰ç”¨æˆ·åˆ›å»ºè´¦æˆ·ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
INSERT INTO accounts (account_type, user_id, status, created_at, updated_at)
SELECT 'user', user_id, 'active', NOW(), NOW()
FROM users u
WHERE NOT EXISTS (
  SELECT 1 FROM accounts a
  WHERE a.account_type = 'user' AND a.user_id = u.user_id
);

-- 2. è¿ç§»æ˜¾ç¤ºç§¯åˆ†ï¼ˆavailable_points â†’ POINTS_DISPLAYï¼‰
INSERT INTO account_asset_balances (account_id, asset_code, available_amount, frozen_amount, created_at, updated_at)
SELECT
  a.account_id,
  'POINTS_DISPLAY' AS asset_code,
  COALESCE(p.available_points, 0) AS available_amount,
  COALESCE(p.frozen_points, 0) AS frozen_amount,
  NOW(),
  NOW()
FROM accounts a
INNER JOIN users u ON a.user_id = u.user_id AND a.account_type = 'user'
LEFT JOIN user_points_accounts p ON p.user_id = u.user_id AND p.is_active = 1
ON DUPLICATE KEY UPDATE
  available_amount = VALUES(available_amount),
  frozen_amount = VALUES(frozen_amount);

-- 3. è¿ç§»é¢„ç®—ç§¯åˆ†ï¼ˆremaining_budget_points â†’ POINTS_BUDGETï¼‰
INSERT INTO account_asset_balances (account_id, asset_code, available_amount, frozen_amount, created_at, updated_at)
SELECT
  a.account_id,
  'POINTS_BUDGET' AS asset_code,
  COALESCE(p.remaining_budget_points, 0) AS available_amount,
  0 AS frozen_amount,
  NOW(),
  NOW()
FROM accounts a
INNER JOIN users u ON a.user_id = u.user_id AND a.account_type = 'user'
LEFT JOIN user_points_accounts p ON p.user_id = u.user_id AND p.is_active = 1
ON DUPLICATE KEY UPDATE
  available_amount = VALUES(available_amount);

-- 4. è¿ç§»ç§¯åˆ†æµæ°´ï¼ˆpoints_transactions â†’ asset_transactionsï¼‰
INSERT INTO asset_transactions (
  account_id, user_id, asset_code, delta_amount,
  balance_before, balance_after, business_id, business_type, meta, created_at
)
SELECT
  a.account_id,
  pt.user_id,
  'POINTS_DISPLAY' AS asset_code,
  pt.points_amount AS delta_amount,
  pt.points_balance_before AS balance_before,
  pt.points_balance_after AS balance_after,
  CONCAT('migrated_points_', pt.transaction_id) AS business_id,
  CASE pt.business_type
    WHEN 'consumption_reward' THEN 'consumption_reward_display'
    WHEN 'lottery_consume' THEN 'lottery_consume_display'
    WHEN 'admin_adjust' THEN 'admin_adjust_display'
    ELSE CONCAT('migrated_', pt.business_type)
  END AS business_type,
  JSON_OBJECT(
    'migrated_from', 'points_transactions',
    'original_transaction_id', pt.transaction_id,
    'original_business_type', pt.business_type,
    'transaction_title', pt.transaction_title
  ) AS meta,
  pt.created_at
FROM points_transactions pt
INNER JOIN accounts a ON a.user_id = pt.user_id AND a.account_type = 'user'
ON DUPLICATE KEY UPDATE transaction_id = transaction_id;

-- 5. è¿ç§»åº“å­˜ç‰©å“ï¼ˆuser_inventory â†’ item_instancesï¼‰
INSERT INTO item_instances (
  owner_user_id, item_type, item_name, status, meta, created_at, updated_at
)
SELECT
  ui.user_id AS owner_user_id,
  ui.type AS item_type,
  ui.name AS item_name,
  CASE ui.status
    WHEN 'available' THEN 'available'
    WHEN 'used' THEN 'used'
    WHEN 'expired' THEN 'expired'
    WHEN 'transferred' THEN 'transferred'
    ELSE 'available'
  END AS status,
  JSON_OBJECT(
    'migrated_from', 'user_inventory',
    'original_inventory_id', ui.inventory_id,
    'description', ui.description,
    'icon', ui.icon,
    'value', ui.value,
    'source_type', ui.source_type,
    'source_id', ui.source_id,
    'acquired_at', ui.acquired_at,
    'expires_at', ui.expires_at,
    'used_at', ui.used_at
  ) AS meta,
  ui.created_at,
  ui.updated_at
FROM user_inventory ui
WHERE ui.status IN ('available', 'used', 'expired', 'transferred');

-- 6. è¿ç§»æ ¸é”€ç ï¼ˆuser_inventory.verification_code â†’ redemption_ordersï¼‰
INSERT INTO redemption_orders (
  user_id, item_instance_id, redemption_code, status, expires_at, created_at, updated_at
)
SELECT
  ui.user_id,
  ii.item_instance_id,
  ui.verification_code AS redemption_code,
  CASE ui.status
    WHEN 'available' THEN 'pending'
    WHEN 'used' THEN 'fulfilled'
    WHEN 'expired' THEN 'expired'
    ELSE 'cancelled'
  END AS status,
  ui.verification_expires_at AS expires_at,
  ui.created_at,
  ui.updated_at
FROM user_inventory ui
INNER JOIN item_instances ii ON ii.meta->>'$.original_inventory_id' = ui.inventory_id
WHERE ui.verification_code IS NOT NULL;
```

**éªŒè¯è„šæœ¬**ï¼ˆSQLï¼‰ï¼š

```sql
-- éªŒè¯ç‚¹ 1ï¼šç”¨æˆ·æ•°é‡ä¸€è‡´
SELECT
  (SELECT COUNT(DISTINCT user_id) FROM users) AS total_users,
  (SELECT COUNT(DISTINCT account_id) FROM accounts WHERE account_type='user') AS total_accounts;

-- éªŒè¯ç‚¹ 2ï¼šæ˜¾ç¤ºç§¯åˆ†æ€»é‡å®ˆæ’
SELECT
  (SELECT COALESCE(SUM(available_points + frozen_points), 0) FROM user_points_accounts) AS old_total,
  (SELECT COALESCE(SUM(available_amount + frozen_amount), 0) FROM account_asset_balances WHERE asset_code='POINTS_DISPLAY') AS new_total;

-- éªŒè¯ç‚¹ 3ï¼šé¢„ç®—ç§¯åˆ†æ€»é‡å®ˆæ’
SELECT
  (SELECT COALESCE(SUM(remaining_budget_points), 0) FROM user_points_accounts) AS old_budget,
  (SELECT COALESCE(SUM(available_amount), 0) FROM account_asset_balances WHERE asset_code='POINTS_BUDGET') AS new_budget;

-- éªŒè¯ç‚¹ 4ï¼šç‰©å“æ•°é‡ä¸€è‡´
SELECT
  (SELECT COUNT(*) FROM user_inventory WHERE status='available') AS old_items,
  (SELECT COUNT(*) FROM item_instances WHERE status='available') AS new_items;

-- éªŒè¯ç‚¹ 5ï¼šæ ¸é”€ç æ•°é‡ä¸€è‡´
SELECT
  (SELECT COUNT(*) FROM user_inventory WHERE verification_code IS NOT NULL) AS old_codes,
  (SELECT COUNT(*) FROM redemption_orders) AS new_codes;
```

#### 0.3 å‡†å¤‡å›æ»šæ–¹æ¡ˆ

- **æ•°æ®å›æ»š**ï¼šä»å¤‡ä»½æ¢å¤ï¼ˆå…¨é‡ï¼‰
- **ä»£ç å›æ»š**ï¼šGit åˆ†æ”¯å›é€€åˆ°å½“å‰ç‰ˆæœ¬
- **å›æ»šçª—å£**ï¼š30 åˆ†é’Ÿå†…å‘ç°é—®é¢˜ç«‹å³å›æ»š

---

### Phase 1ï¼šåœå†™çª—å£ï¼ˆç»´æŠ¤ 30-60 åˆ†é’Ÿï¼‰

#### 1.1 åœæ­¢æ‰€æœ‰å†™å…¥æœåŠ¡

```bash
# åœæ­¢åç«¯æœåŠ¡
./scripts/system/process-manager.sh stop

# éªŒè¯æœåŠ¡å·²åœæ­¢
./scripts/system/process-manager.sh status
```

#### 1.2 æ‰§è¡Œæ•°æ®åº“è¿ç§»

```bash
# æ‰§è¡Œè¿ç§»ï¼ˆç§¯åˆ†å¹¶å…¥èµ„äº§è´¦æœ¬ + åº“å­˜ç»Ÿä¸€åˆ° ItemInstanceï¼‰
npx sequelize-cli db:migrate

# ç«‹å³éªŒè¯ï¼ˆæ‰§è¡ŒéªŒè¯ SQLï¼‰
mysql -u$DB_USER -p$DB_PASSWORD $DB_NAME < scripts/verification/verify-migration-20251218.sql
```

**è¿ç§»éªŒè¯å£å¾„**ï¼š

- ç”¨æˆ·ç»´åº¦æ˜¾ç¤ºç§¯åˆ†ä¸€è‡´ï¼š`POINTS_DISPLAY.balance = æ—§ available_points`
- ç”¨æˆ·ç»´åº¦é¢„ç®—ç§¯åˆ†ä¸€è‡´ï¼š`POINTS_BUDGET.balance = æ—§ remaining_budget_points`
- ç”¨æˆ·ç»´åº¦ç‰©å“æ•°é‡ä¸€è‡´ï¼š`item_instances(status=available) count = æ—§ user_inventory(status=available) count`
- æµæ°´æ€»ç¬”æ•°ä¸€è‡´ï¼š`asset_transactions count >= points_transactions count`ï¼ˆå¯èƒ½æ–°å¢ç³»ç»Ÿè´¦æˆ·æµæ°´ï¼‰

#### 1.3 åˆ é™¤æ—§è¡¨ï¼ˆä¸å¯é€†ï¼‰

```sql
-- âš ï¸ ç¡®è®¤è¿ç§»éªŒè¯é€šè¿‡åå†æ‰§è¡Œ
DROP TABLE IF EXISTS user_points_accounts;
DROP TABLE IF EXISTS points_transactions;
DROP TABLE IF EXISTS user_inventory;

-- éªŒè¯åˆ é™¤æˆåŠŸ
SHOW TABLES LIKE '%points_accounts%';
SHOW TABLES LIKE '%user_inventory%';
```

---

### Phase 2ï¼šä»£ç æ”¹é€ ï¼ˆåœå†™çª—å£å†…å®Œæˆï¼‰

#### 2.1 åˆ é™¤æ¨¡å‹æ–‡ä»¶ï¼ˆ3 ä¸ªæ–‡ä»¶ï¼‰

```bash
rm -f models/UserPointsAccount.js
rm -f models/PointsTransaction.js
rm -f models/UserInventory.js
```

#### 2.2 æ›´æ–° models/index.js

**æ–‡ä»¶**ï¼š`models/index.js`

æ‰¾åˆ°å¹¶åˆ é™¤ä»¥ä¸‹è¡Œï¼ˆçº¦åœ¨ 15-25 è¡Œä¹‹é—´ï¼‰ï¼š

```javascript
// âŒ åˆ é™¤è¿™äº›è¡Œ
db.UserPointsAccount = require('./UserPointsAccount')(sequelize)
db.PointsTransaction = require('./PointsTransaction')(sequelize)
db.UserInventory = require('./UserInventory')(sequelize)
```

#### 2.3 åˆ é™¤æœåŠ¡æ–‡ä»¶ï¼ˆ3 ä¸ªæ–‡ä»¶ï¼‰

```bash
# åˆ é™¤ç§¯åˆ†æœåŠ¡
rm -f services/PointsService.js

# åˆ é™¤åº“å­˜æœåŠ¡
rm -f services/InventoryService.js

# åˆ é™¤å¤‡ä»½æ®‹ç•™
rm -f services/AssetService.js.backup-phase1
```

#### 2.4 æ”¹é€ ä¸šåŠ¡æœåŠ¡ï¼ˆéœ€è¦é€ä¸ªæ–‡ä»¶æ”¹é€ çš„æ¸…å•ï¼‰

**ä¼˜å…ˆçº§ P0ï¼ˆæ ¸å¿ƒä¸šåŠ¡æµç¨‹ï¼Œå¿…é¡»æ”¹é€ ï¼‰**ï¼š

1. **`services/UnifiedLotteryEngine/UnifiedLotteryEngine.js`**
   - æ”¹é€ ç‚¹ï¼šæŠ½å¥–å¼•æ“è¯»å–é¢„ç®—ä½™é¢çš„é€»è¾‘
   - æ—§ä»£ç ä½ç½®ï¼šçº¦ç¬¬ 1600-1700 è¡Œ
   - æ”¹é€ æ–¹å¼ï¼š`UserPointsAccount.findOne()` â†’ `AssetService.getBalance({ asset_code: 'POINTS_BUDGET' })`

```javascript
// âŒ æ—§ä»£ç 
const account = await UserPointsAccount.findOne({
  where: { user_id, is_active: true },
  transaction
})
const remaining_budget = account.remaining_budget_points

// âœ… æ–°ä»£ç 
const budgetBalance = await AssetService.getBalance(
  {
    user_id,
    asset_code: 'POINTS_BUDGET'
  },
  { transaction }
)
const remaining_budget = budgetBalance.available_amount
```

2. **`routes/v4/unified-engine/points.js`**
   - æ”¹é€ ç‚¹ï¼šç§¯åˆ†è·¯ç”±çš„æ‰€æœ‰æ¥å£å®ç°
   - æ”¹é€ æ–¹å¼ï¼š`PointsService.*` â†’ `AssetService.changeBalance()` / `AssetService.getBalance()`
   - è·¯ç”±è·¯å¾„ä¿æŒä¸å˜ï¼š`/api/v4/points/*`

**ç¤ºä¾‹ï¼šæŸ¥è¯¢ä½™é¢**

```javascript
// âŒ æ—§ä»£ç 
router.get('/balance', async (req, res) => {
  const account = await PointsService.getUserPointsAccount(req.user.user_id)
  return res.apiSuccess({
    available_points: account.available_points,
    total_earned: account.total_earned
  })
})

// âœ… æ–°ä»£ç 
router.get('/balance', async (req, res) => {
  const displayBalance = await AssetService.getBalance({
    user_id: req.user.user_id,
    asset_code: 'POINTS_DISPLAY'
  })

  // ç»Ÿè®¡ total_earnedï¼ˆä»æµæ°´æ±‡æ€»ï¼‰
  const transactions = await AssetService.getTransactions({
    user_id: req.user.user_id,
    asset_code: 'POINTS_DISPLAY'
  })
  const total_earned = transactions
    .filter(t => t.delta_amount > 0)
    .reduce((sum, t) => sum + Number(t.delta_amount), 0)

  return res.apiSuccess({
    available_points: displayBalance.available_amount,
    total_earned
  })
})
```

3. **`routes/v4/unified-engine/consumption.js`**
   - æ”¹é€ ç‚¹ï¼šå®¡æ ¸é€šè¿‡å‘æ”¾ç§¯åˆ†çš„é€»è¾‘

```javascript
// âŒ æ—§ä»£ç 
await PointsService.addPoints(user_id, points_amount, {
  business_id: `consumption_${consumption_id}`,
  business_type: 'consumption_reward',
  transaction
})

// âœ… æ–°ä»£ç 
const transaction = await sequelize.transaction()

try {
  // 1. å‘æ”¾æ˜¾ç¤ºç§¯åˆ†ï¼ˆç”¨æˆ·æ¶ˆè´¹é‡‘é¢å¯¹åº”çš„ç§¯åˆ†ï¼‰
  await AssetService.changeBalance(
    {
      user_id,
      asset_code: 'POINTS_DISPLAY',
      delta_amount: consumption_amount, // 1000
      business_id: `consumption_${consumption_id}_display`,
      business_type: 'consumption_reward_display',
      meta: {
        consumption_id,
        consumption_amount,
        audit_operator_id: req.user.user_id
      }
    },
    { transaction }
  )

  // 2. å‘æ”¾é¢„ç®—ç§¯åˆ†ï¼ˆæŒ‰æ¯”ä¾‹è®¡ç®—ï¼Œå¦‚ consumption_amount * 0.24ï¼‰
  const budget_amount = Math.floor(consumption_amount * 0.24)
  await AssetService.changeBalance(
    {
      user_id,
      asset_code: 'POINTS_BUDGET',
      delta_amount: budget_amount, // 240
      business_id: `consumption_${consumption_id}_budget`,
      business_type: 'consumption_reward_budget',
      meta: {
        consumption_id,
        consumption_amount,
        budget_ratio: 0.24,
        audit_operator_id: req.user.user_id
      }
    },
    { transaction }
  )

  await transaction.commit()
} catch (error) {
  await transaction.rollback()
  throw error
}
```

4. **æŠ½å¥–æµç¨‹æ”¹é€ **ï¼ˆçº¦ç¬¬ 2000+ è¡Œï¼‰ï¼š

```javascript
// âŒ æ—§ä»£ç 
await UserPointsAccount.update(
  {
    remaining_budget_points: sequelize.literal(`remaining_budget_points - ${prize_cost}`)
  },
  {
    where: { user_id },
    transaction
  }
)

// åˆ›å»ºè™šæ‹Ÿå¥–å“åˆ° user_inventory
await UserInventory.create(
  {
    user_id,
    name: 'çº¢æ°´æ™¶',
    type: 'virtual',
    value: prize_cost,
    virtual_amount: crystal_count
  },
  { transaction }
)

// âœ… æ–°ä»£ç 
// 1. æ‰£å‡é¢„ç®—ç§¯åˆ†
await AssetService.changeBalance(
  {
    user_id,
    asset_code: 'POINTS_BUDGET',
    delta_amount: -prize_cost,
    business_id: `lottery_${draw_id}_budget`,
    business_type: 'lottery_budget_consume',
    meta: { draw_id, prize_id, prize_cost }
  },
  { transaction }
)

// 2. å‘æ”¾è™šæ‹Ÿè´§å¸ï¼ˆçº¢æ°´æ™¶ï¼‰
await AssetService.changeBalance(
  {
    user_id,
    asset_code: 'CRYSTAL_RED',
    delta_amount: prize_cost, // æˆ– crystal_countï¼ˆå–å†³äºä½ çš„å•ä½ï¼‰
    business_id: `lottery_${draw_id}_prize`,
    business_type: 'lottery_prize_crystal',
    meta: { draw_id, prize_id, crystal_amount: prize_cost }
  },
  { transaction }
)
```

5. **å…‘æ¢æµç¨‹æ”¹é€ **ï¼š

```javascript
// âŒ æ—§ä»£ç 
// æ‰£å‡è™šæ‹Ÿå¥–å“
await UserInventory.update(
  {
    virtual_amount: sequelize.literal(`virtual_amount - ${required_amount}`)
  },
  {
    where: { user_id, type: 'virtual' },
    transaction
  }
)

// åˆ›å»ºå®ç‰©å•†å“
await UserInventory.create(
  {
    user_id,
    name: item.name,
    type: 'product',
    source_type: 'exchange'
  },
  { transaction }
)

// âœ… æ–°ä»£ç 
const transaction = await sequelize.transaction()

try {
  // 1. æ‰£å‡çº¢æ°´æ™¶
  await AssetService.changeBalance(
    {
      user_id,
      asset_code: 'CRYSTAL_RED',
      delta_amount: -required_amount,
      business_id: `exchange_${exchange_id}`,
      business_type: 'exchange_consume_crystal',
      meta: { exchange_id, item_id, required_amount }
    },
    { transaction }
  )

  // 2. åˆ›å»ºç‰©å“å®ä¾‹
  const itemInstance = await ItemInstance.create(
    {
      owner_user_id: user_id,
      item_type: 'product',
      item_name: item.name,
      status: 'available',
      meta: {
        exchange_id,
        cost_crystal: required_amount,
        description: item.description,
        source_type: 'exchange'
      }
    },
    { transaction }
  )

  // 3. åˆ›å»ºæ ¸é”€è®¢å•ï¼ˆå¦‚æœéœ€è¦æ ¸é”€ç ï¼‰
  if (item.needs_redemption) {
    const redemptionOrder = await RedemptionOrder.create(
      {
        user_id,
        item_instance_id: itemInstance.item_instance_id,
        redemption_code: generateRedemptionCode(),
        status: 'pending',
        expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000)
      },
      { transaction }
    )
  }

  await transaction.commit()
} catch (error) {
  await transaction.rollback()
  throw error
}
```

6. **èƒŒåŒ…æŸ¥è¯¢æ”¹é€ **ï¼ˆ`services/BackpackService.js`ï¼‰ï¼š

```javascript
static async _getAssets(user_id, options = {}) {
  const { transaction = null } = options

  // æŸ¥è¯¢æ‰€æœ‰èµ„äº§ä½™é¢ï¼ˆåŒ…æ‹¬ POINTS_DISPLAYã€POINTS_BUDGETã€CRYSTAL_REDã€DIAMONDã€ææ–™ç­‰ï¼‰
  const assetAccounts = await AssetService.getAllBalances(
    { user_id },
    { transaction }
  )

  // è¿‡æ»¤ä½™é¢ > 0 çš„èµ„äº§ï¼ˆåŒ…å«å†»ç»“ä½™é¢ï¼‰
  const validAssets = assetAccounts.filter(account =>
    (account.available_amount + account.frozen_amount) > 0
  )

  // æ ¼å¼åŒ–è¿”å›ï¼ˆå‰ç«¯éœ€è¦çš„å­—æ®µï¼‰
  return validAssets.map(account => ({
    asset_code: account.asset_code,
    display_name: getAssetDisplayName(account.asset_code), // éœ€è¦å®šä¹‰æ˜ å°„
    balance: account.available_amount + account.frozen_amount,
    available_balance: account.available_amount,
    frozen_balance: account.frozen_amount
  }))
}

// èµ„äº§ç æ˜¾ç¤ºåç§°æ˜ å°„
function getAssetDisplayName(asset_code) {
  const names = {
    'POINTS_DISPLAY': 'å¯ç”¨ç§¯åˆ†',
    'POINTS_BUDGET': 'é¢„ç®—ç§¯åˆ†',
    'CRYSTAL_RED': 'çº¢æ°´æ™¶',
    'DIAMOND': 'é’»çŸ³'
  }
  return names[asset_code] || asset_code
}
```

**ä¼˜å…ˆçº§ P1ï¼ˆç®¡ç†åå°ï¼Œéœ€è¦æ”¹é€ ï¼‰**ï¼š7. `routes/v4/unified-engine/admin/user_management.js` 8. `routes/v4/unified-engine/admin/analytics.js` 9. `services/ReportingService.js`

**ä¼˜å…ˆçº§ P2ï¼ˆå·¥å…·è„šæœ¬ï¼Œå¯å»¶åï¼‰**ï¼š10. `scripts/admin-tools/recalculate-balance.js` 11. `scripts/reconcile-inventory-migration.js` 12. `scripts/migration/invalidate-old-codes.js`

**ä¼˜å…ˆçº§ P3ï¼ˆæµ‹è¯•æ–‡ä»¶ï¼Œéœ€è¦åŒæ­¥æ”¹é€ ï¼‰**ï¼š13. `tests/business/points/*.test.js`ï¼ˆ5 ä¸ªæµ‹è¯•æ–‡ä»¶ï¼‰14. `tests/business/lottery/*.test.js`ï¼ˆæ¶‰åŠç§¯åˆ†çš„æµ‹è¯•ï¼‰15. `tests/services/BackpackService.test.js` 16. `tests/integration/*.test.js`ï¼ˆæ¶‰åŠç§¯åˆ†/åº“å­˜çš„é›†æˆæµ‹è¯•ï¼‰

#### 2.5 åˆ é™¤è·¯ç”±å…¼å®¹æŒ‚è½½

**æ–‡ä»¶**ï¼š`routes/v4/unified-engine/admin/index.js`

**åˆ é™¤å†…å®¹**ï¼š

- åˆ é™¤ç¬¬ 30-34 è¡Œçš„å…¼å®¹è¯´æ˜æ³¨é‡Šå—
- åˆ é™¤ç¬¬ 35 è¡Œï¼š`router.use(systemRoutes)`

**åªä¿ç•™**ï¼š

```javascript
router.use('/system', systemRoutes)
```

#### 2.6 åˆ é™¤é™æµåå¤‡å®ç°

**æ–‡ä»¶**ï¼š`app.js`

**åˆ é™¤å†…å®¹**ï¼š

- åˆ é™¤ç¬¬ 20 è¡Œï¼š`const rateLimit = require('express-rate-limit')`
- åˆ é™¤ç¬¬ 180-223 è¡Œï¼šæ•´ä¸ª `fallbackLimiter` å®šä¹‰ä¸æŒ‚è½½

**æ–‡ä»¶**ï¼š`middleware/RateLimiterMiddleware.js`

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬ 232-236 è¡Œ

**æ—§ä»£ç **ï¼š

```javascript
} catch (error) {
  logger.error('[RateLimiter] é™æµä¸­é—´ä»¶é”™è¯¯:', error)
  // å‘ç”Ÿé”™è¯¯æ—¶ä¸é˜»å¡è¯·æ±‚ï¼Œç»§ç»­å¤„ç†
  next()
}
```

**æ–°ä»£ç **ï¼š

```javascript
} catch (error) {
  logger.error('[RateLimiter] Redisé™æµå¤±è´¥ï¼Œfail-openæ”¾è¡Œè¯·æ±‚ï¼ˆå‘Šè­¦ï¼‰', {
    error: error.message,
    error_stack: error.stack,
    ip: req.ip,
    path: req.path,
    method: req.method,
    user_id: req.user?.user_id,
    timestamp: BeijingTimeHelper.now(),
    alert_level: 'P1',
    alert_reason: 'redis_rate_limiter_failure'
  })

  // fail-open ç­–ç•¥ï¼šRedisä¸å¯ç”¨æ—¶ä¸é™æµï¼ˆä¿è¯ä¸šåŠ¡å¯ç”¨æ€§ä¼˜å…ˆï¼‰
  next()
}
```

#### 2.7 åˆ é™¤è¿ç§»è„šæœ¬å¤šå…¥å£

```bash
rm -f scripts/execute_migration.js
rm -f scripts/execute_migration_robust.js
```

---

### Phase 3ï¼šéªŒè¯ä¸å¯åŠ¨ï¼ˆåœå†™çª—å£å†…å®Œæˆï¼‰

#### 3.1 å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨æœåŠ¡
./scripts/system/process-manager.sh start pm2

# ç­‰å¾… 5 ç§’
sleep 5
```

#### 3.2 å¥åº·æ£€æŸ¥

```bash
# å¥åº·æ£€æŸ¥
curl -s http://localhost:3000/health | jq

# éªŒè¯å…³é”®æ¥å£ï¼ˆç§¯åˆ†åŸŸï¼‰
curl -s -H "Authorization: Bearer $TOKEN" \
  http://localhost:3000/api/v4/points/balance | jq

# éªŒè¯å…³é”®æ¥å£ï¼ˆèƒŒåŒ…åŸŸï¼‰
curl -s -H "Authorization: Bearer $TOKEN" \
  http://localhost:3000/api/v4/backpack | jq
```

#### 3.3 ä¸šåŠ¡åŠŸèƒ½éªŒæ”¶ï¼ˆå†’çƒŸæµ‹è¯•ï¼‰

**æµ‹è¯•åœºæ™¯**ï¼š

1. **æ¶ˆè´¹å¥–åŠ±æµç¨‹**ï¼š
   - æäº¤æ¶ˆè´¹è®°å½• â†’ å®¡æ ¸é€šè¿‡ â†’ éªŒè¯ `POINTS_DISPLAY` å’Œ `POINTS_BUDGET` åŒæ—¶å¢åŠ 
2. **æŠ½å¥–æµç¨‹**ï¼š
   - å‘èµ·æŠ½å¥– â†’ éªŒè¯ `POINTS_DISPLAY` æ‰£å‡
   - ä¸­å¥– â†’ éªŒè¯ `POINTS_BUDGET` æ‰£å‡ + `CRYSTAL_RED` å¢åŠ 
   - é¢„ç®—ä¸è¶³æ—¶ â†’ éªŒè¯é«˜ä»·å€¼å¥–å“ä¸åœ¨å€™é€‰æ± 
3. **å…‘æ¢æµç¨‹**ï¼š
   - å…‘æ¢å•†å“ â†’ éªŒè¯ `CRYSTAL_RED` æ‰£å‡ + `item_instances` åˆ›å»º
   - ç”Ÿæˆæ ¸é”€ç  â†’ éªŒè¯ `redemption_orders` åˆ›å»º
4. **èƒŒåŒ…æŸ¥è¯¢**ï¼š
   - æŸ¥è¯¢èƒŒåŒ… â†’ éªŒè¯è¿”å› `assets[]`ï¼ˆåŒ…å« POINTS_DISPLAY/CRYSTAL_REDï¼‰å’Œ `items[]`

#### 3.4 æ•°æ®ä¸€è‡´æ€§éªŒè¯

```bash
# è¿è¡Œä¸€è‡´æ€§éªŒè¯è„šæœ¬
node scripts/verification/verify-brutal-unify-migration.js

# éªŒè¯ç‚¹ï¼š
# 1. æ‰€æœ‰ç”¨æˆ·çš„ POINTS_DISPLAY ä½™é¢ = æ—§ available_points
# 2. æ‰€æœ‰ç”¨æˆ·çš„ POINTS_BUDGET ä½™é¢ = æ—§ remaining_budget_points
# 3. æ‰€æœ‰ç”¨æˆ·çš„ç‰©å“æ•°é‡ä¸€è‡´
# 4. æµæ°´æ€»ç¬”æ•°ä¸€è‡´
```

---

### Phase 4ï¼šæ¸…ç†æ®‹ç•™ï¼ˆå¯åŠ¨å 1-2 å°æ—¶å†…å®Œæˆï¼‰

#### 4.1 åˆ é™¤åºŸå¼ƒæ³¨é‡Šï¼ˆå…¨ä»“åº“ï¼‰

**æŸ¥æ‰¾å‘½ä»¤**ï¼š

```bash
grep -rn "@deprecated\|âŒ å·²åºŸå¼ƒ\|âš ï¸ å…¼å®¹\|æ—§å®ç°\|è¿ç§»è·¯å¾„\|P0-1æ¶æ„é‡æ„\|å·²åœ¨.*åºŸå¼ƒ" \
  --include="*.js" \
  --exclude-dir=node_modules \
  --exclude-dir=backups \
  . > deprecated_comments.txt
```

**æ¸…ç†åŸåˆ™**ï¼š

- åˆ é™¤æ‰€æœ‰ `@deprecated` JSDoc æ ‡è®°
- åˆ é™¤æ‰€æœ‰ `âŒ å·²åºŸå¼ƒ` / `âš ï¸ å…¼å®¹` / `âœ… P*-* ä¼˜åŒ–å®Œæˆ` ç­‰è¿ç§»è¯´æ˜æ³¨é‡Š
- åˆ é™¤æ‰€æœ‰è¢«æ³¨é‡Šæ‰çš„ `require()` / `router.use()` è¡Œ
- åˆ é™¤æ‰€æœ‰"è¿ç§»è·¯å¾„"/"åŸå› ï¼šæ—§è·¯ç”±è°ƒç”¨ä¸å­˜åœ¨"çš„è¯´æ˜æ€§æ³¨é‡Š

**å…·ä½“æ–‡ä»¶**ï¼ˆåŸºäº grep ç»“æœï¼‰ï¼š

1. `services/InventoryService.js`ï¼šç¬¬ 3-7 è¡Œçš„ `@deprecated` å£°æ˜
2. `routes/v4/unified-engine/inventory.js`ï¼šç¬¬ 27-34 è¡Œã€ç¬¬ 51-54 è¡Œã€ç¬¬ 77-93 è¡Œçš„åºŸå¼ƒè¯´æ˜
3. `routes/v4/unified-engine/admin/index.js`ï¼šç¬¬ 30-34 è¡Œçš„å…¼å®¹è¯´æ˜

#### 4.2 æ¸…ç† backups/ ç›®å½•

```bash
# åˆ é™¤å†å²å¤‡ä»½ï¼ˆè¿ç§»åˆ°å¤–éƒ¨å­˜å‚¨ï¼‰
rm -rf backups/backup_2025-10-*
rm -rf backups/backup_2025-11-*
rm -rf backups/time_format_fix_*
rm -rf backups/migration-*
rm -rf backups/full_backup_2025-10-*
rm -rf backups/BACKUP_REPORT_*.md

# åªä¿ç•™
# - backups/backup_2025-12-18/ï¼ˆæœ€æ–°å¤‡ä»½ï¼Œç”¨äºå›æ»šï¼‰
# - scripts/database/backup-toolkit.jsï¼ˆå¤‡ä»½å·¥å…·ï¼‰
```

#### 4.3 æ›´æ–°æ–‡æ¡£ï¼ˆåªä¿ç•™ 4 ä»½å”¯ä¸€è§„èŒƒï¼‰

**åˆ é™¤æ–‡æ¡£**ï¼š

```bash
# åˆ é™¤å†å²/è¿ç§»/å®¡è®¡æŠ¥å‘Š
rm -f docs/duplicate-implementation-audit-2025-12-18.md
rm -f docs/è·¯ç”±å±‚ã€æ¨¡å‹å±‚ã€æœåŠ¡å±‚ã€æ•°æ®ä¸€è‡´æ€§æ–‡æ¡£.md
# å…¶å®ƒå†å²æŠ¥å‘Š...
```

**ä¿ç•™å¹¶æ›´æ–° 4 ä»½å”¯ä¸€è§„èŒƒ**ï¼š

1. `docs/ARCHITECTURE.md`ï¼šæ¨¡å—è¾¹ç•Œ + å•ä¸€çœŸç›¸è¡¨
2. `docs/API_CONTRACT.md`ï¼šä»…åˆ—å‡ºå½“å‰å®é™…å¼€æ”¾çš„ endpoint
3. `docs/DB_SCHEMA.md`ï¼šåªæè¿°å½“å‰æœ€ç»ˆä¿ç•™çš„è¡¨
4. `docs/ASSET_CODE_STANDARD.md`ï¼šèµ„äº§ç æ ‡å‡†ï¼ˆæ–°å»ºï¼‰

---

## ğŸ“‹ Part 3ï¼šå•†ä¸šé—­ç¯æ ‡å‡†è®°è´¦

### åœºæ™¯ 1ï¼šç”¨æˆ·æ¶ˆè´¹ 1000 å…ƒ â†’ åˆ†é…

**ä¸€æ¬¡äº‹åŠ¡ï¼Œä¸¤ç¬”å…¥è´¦**ï¼š

```javascript
const transaction = await sequelize.transaction()

// 1. å¢åŠ æ˜¾ç¤ºç§¯åˆ† +1000
await AssetService.changeBalance(
  {
    user_id,
    asset_code: 'POINTS_DISPLAY',
    delta_amount: 1000,
    business_id: `consumption_${consumption_id}_display`,
    business_type: 'consumption_reward_display',
    meta: { consumption_id, amount: 1000 }
  },
  { transaction }
)

// 2. å¢åŠ é¢„ç®—ç§¯åˆ† +240
await AssetService.changeBalance(
  {
    user_id,
    asset_code: 'POINTS_BUDGET',
    delta_amount: 240,
    business_id: `consumption_${consumption_id}_budget`,
    business_type: 'consumption_reward_budget',
    meta: { consumption_id, budget: 240 }
  },
  { transaction }
)

await transaction.commit()
```

### åœºæ™¯ 2ï¼šæŠ½å¥–æ¶ˆè€—ï¼ˆé¢„ç®—çº¦æŸç”Ÿæ•ˆï¼‰

**ä¸€æ¬¡äº‹åŠ¡ï¼Œ2-3 ç¬”è®°è´¦**ï¼š

```javascript
const transaction = await sequelize.transaction()

// 1. æ‰£å‡æ˜¾ç¤ºç§¯åˆ† -1000ï¼ˆæ”¯ä»˜æŠ½å¥–ï¼‰
await AssetService.changeBalance(
  {
    user_id,
    asset_code: 'POINTS_DISPLAY',
    delta_amount: -1000,
    business_id: `lottery_${draw_id}_display`,
    business_type: 'lottery_consume_display',
    meta: { draw_id, campaign_id }
  },
  { transaction }
)

// 2. æŠ½å¥–å‰ï¼šè¯»å–é¢„ç®—ä½™é¢ï¼ˆå†³å®šå¥–æ± èŒƒå›´ï¼‰
const budgetBalance = await AssetService.getBalance(
  {
    user_id,
    asset_code: 'POINTS_BUDGET'
  },
  { transaction }
)

// è¿‡æ»¤å¥–æ± ï¼šåªä¿ç•™ prize_cost <= budgetBalance.available_amount çš„å¥–å“
const affordablePrizes = allPrizes.filter(p => p.prize_cost <= budgetBalance.available_amount)

// 3. è‹¥ä¸­å¥–ï¼ˆå‡è®¾ä¸­å¥–æˆæœ¬ 150ï¼‰
if (isWin) {
  // 3a. æ‰£å‡é¢„ç®—ç§¯åˆ† -150
  await AssetService.changeBalance(
    {
      user_id,
      asset_code: 'POINTS_BUDGET',
      delta_amount: -150,
      business_id: `lottery_${draw_id}_budget`,
      business_type: 'lottery_budget_consume',
      meta: { draw_id, prize_id, prize_cost: 150 }
    },
    { transaction }
  )

  // 3b. å‘æ”¾è™šæ‹Ÿè´§å¸ +150ï¼ˆçº¢æ°´æ™¶ï¼‰
  await AssetService.changeBalance(
    {
      user_id,
      asset_code: 'CRYSTAL_RED',
      delta_amount: 150,
      business_id: `lottery_${draw_id}_prize`,
      business_type: 'lottery_prize_crystal',
      meta: { draw_id, prize_id, crystal_amount: 150 }
    },
    { transaction }
  )
}

await transaction.commit()
```

### åœºæ™¯ 3ï¼šå…‘æ¢æ¶ˆè€— â†’ å‘æ”¾å®ç‰©

**ä¸€æ¬¡äº‹åŠ¡ï¼Œ2 ç¬”æ“ä½œ**ï¼š

```javascript
const transaction = await sequelize.transaction()

// 1. æ‰£å‡çº¢æ°´æ™¶ -150
await AssetService.changeBalance(
  {
    user_id,
    asset_code: 'CRYSTAL_RED',
    delta_amount: -150,
    business_id: `exchange_${exchange_id}`,
    business_type: 'exchange_consume_crystal',
    meta: { exchange_id, item_id }
  },
  { transaction }
)

// 2. åˆ›å»ºç‰©å“å®ä¾‹ï¼ˆå®ç‰©å•†å“å‡­è¯ï¼‰
const itemInstance = await ItemInstance.create(
  {
    owner_user_id: user_id,
    item_type: 'product',
    item_name: 'ç²¾ç¾æ°´æ¯',
    status: 'available',
    meta: {
      exchange_id,
      cost_crystal: 150,
      description: 'ç²¾ç¾æ°´æ¯'
    }
  },
  { transaction }
)

// 3. åˆ›å»ºæ ¸é”€è®¢å•
const redemptionOrder = await RedemptionOrder.create(
  {
    user_id,
    item_instance_id: itemInstance.item_instance_id,
    redemption_code: generateCode(),
    status: 'pending',
    expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000) // 30å¤©
  },
  { transaction }
)

await transaction.commit()
```

---

## ğŸ“ Part 4ï¼šä¸šåŠ¡è¯­ä¹‰æ˜ å°„è¡¨

### ç§¯åˆ†åŸŸæ˜ å°„

| æ—§å­—æ®µ/æ¦‚å¿µ               | æ–°èµ„äº§ç                           | å¤‡æ³¨                                                                        |
| ------------------------- | --------------------------------- | --------------------------------------------------------------------------- |
| `available_points`        | `POINTS_DISPLAY.available_amount` | æ˜¾ç¤ºç§¯åˆ†ï¼ˆç”¨æˆ·å¯è§ï¼‰                                                        |
| `frozen_points`           | `POINTS_DISPLAY.frozen_amount`    | å†»ç»“ç§¯åˆ†ï¼ˆå®¡æ ¸ä¸­ï¼‰                                                          |
| `remaining_budget_points` | `POINTS_BUDGET.available_amount`  | é¢„ç®—ç§¯åˆ†ï¼ˆé£æ§ï¼‰                                                            |
| `used_budget_points`      | é€šè¿‡æµæ°´ç»Ÿè®¡                      | SUM(delta_amount WHERE asset_code='POINTS_BUDGET' AND delta_amount<0)       |
| `total_earned`            | é€šè¿‡æµæ°´ç»Ÿè®¡                      | SUM(delta_amount WHERE asset_code='POINTS_DISPLAY' AND delta_amount>0)      |
| `total_consumed`          | é€šè¿‡æµæ°´ç»Ÿè®¡                      | SUM(ABS(delta_amount) WHERE asset_code='POINTS_DISPLAY' AND delta_amount<0) |

### åº“å­˜åŸŸæ˜ å°„

| æ—§å­—æ®µ/æ¦‚å¿µ                        | æ–°è¡¨/å­—æ®µ                           | å¤‡æ³¨                                         |
| ---------------------------------- | ----------------------------------- | -------------------------------------------- |
| `user_inventory.inventory_id`      | `item_instances.item_instance_id`   | ä¸»é”®                                         |
| `user_inventory.name`              | `item_instances.meta.name`          | ç‰©å“åç§°                                     |
| `user_inventory.type`              | `item_instances.item_type`          | ç‰©å“ç±»å‹                                     |
| `user_inventory.status`            | `item_instances.status`             | çŠ¶æ€æœºï¼ˆavailable/used/expired/transferredï¼‰ |
| `user_inventory.verification_code` | `redemption_orders.redemption_code` | æ ¸é”€ç ï¼ˆå…³è”æŸ¥è¯¢ï¼‰                           |
| `user_inventory.acquired_at`       | `item_instances.created_at`         | è·å¾—æ—¶é—´                                     |

### ä¸šåŠ¡ç±»å‹æ˜ å°„ï¼ˆbusiness_typeï¼‰

| æ—§ä¸šåŠ¡ç±»å‹           | æ–°ä¸šåŠ¡ç±»å‹                   | èµ„äº§ç            | å¤‡æ³¨                 |
| -------------------- | ---------------------------- | ---------------- | -------------------- |
| `consumption_reward` | `consumption_reward_display` | `POINTS_DISPLAY` | æ¶ˆè´¹å¥–åŠ±ï¼ˆæ˜¾ç¤ºç§¯åˆ†ï¼‰ |
| æ—                    | `consumption_reward_budget`  | `POINTS_BUDGET`  | æ¶ˆè´¹å¥–åŠ±ï¼ˆé¢„ç®—ç§¯åˆ†ï¼‰ |
| `lottery_consume`    | `lottery_consume_display`    | `POINTS_DISPLAY` | æŠ½å¥–æ¶ˆè´¹ï¼ˆæ˜¾ç¤ºç§¯åˆ†ï¼‰ |
| æ—                    | `lottery_budget_consume`     | `POINTS_BUDGET`  | æŠ½å¥–ä¸­å¥–æˆæœ¬         |
| æ—                    | `lottery_prize_crystal`      | `CRYSTAL_RED`    | æŠ½å¥–å‘æ”¾è™šæ‹Ÿè´§å¸     |
| æ—                    | `exchange_consume_crystal`   | `CRYSTAL_RED`    | å…‘æ¢æ¶ˆè€—è™šæ‹Ÿè´§å¸     |
| `admin_adjust`       | `admin_adjust_display`       | `POINTS_DISPLAY` | ç®¡ç†å‘˜è°ƒæ•´æ˜¾ç¤ºç§¯åˆ†   |
| æ—                    | `admin_adjust_budget`        | `POINTS_BUDGET`  | ç®¡ç†å‘˜è°ƒæ•´é¢„ç®—ç§¯åˆ†   |

---

## âš ï¸ Part 5ï¼šé£é™©ä¸ç¼“è§£

### é£é™© 1ï¼šè¿ç§»è„šæœ¬æ•°æ®ä¸¢å¤±

**ç¼“è§£**ï¼š

- è¿ç§»å‰å…¨é‡å¤‡ä»½
- è¿ç§»è„šæœ¬å…ˆåœ¨æµ‹è¯•ç¯å¢ƒæ‰§è¡Œ 3 æ¬¡ä»¥ä¸Š
- è¿ç§»åç«‹å³éªŒè¯æ•°æ®ä¸€è‡´æ€§ï¼ˆç”¨æˆ·ç»´åº¦å¯¹è´¦ï¼‰

### é£é™© 2ï¼šä¸šåŠ¡é€»è¾‘é—æ¼æ”¹é€ ç‚¹

**ç¼“è§£**ï¼š

- å…¨ä»“åº“æœç´¢æ—§æ¨¡å‹åï¼ˆ`UserPointsAccount`/`PointsTransaction`/`UserInventory`ï¼‰
- é€ä¸ªæ–‡ä»¶ç¡®è®¤æ”¹é€ å®Œæˆ
- è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶ï¼ˆ`npm run test`ï¼‰

### é£é™© 3ï¼šå‰ç«¯ä»è°ƒç”¨æ—§è·¯ç”±

**ç¼“è§£**ï¼š

- å¦‚æœåˆ é™¤ `/api/v4/inventory` è·¯ç”±ï¼Œéœ€åŒæ­¥æ›´æ–°å‰ç«¯ä»£ç 
- å»ºè®®ä¿ç•™è·¯ç”±è·¯å¾„ä½†æ”¹ä¸ºæ–°å®ç°ï¼ˆé¿å…å‰ç«¯æ”¹é€ ï¼‰
- æˆ–åœ¨ 404 handler é‡Œé’ˆå¯¹æ—§è·¯ç”±è¿”å›æ˜ç¡®çš„è¿ç§»å¼•å¯¼

### é£é™© 4ï¼šå›æ»šå›°éš¾ï¼ˆæ—§è¡¨å·²åˆ é™¤ï¼‰

**ç¼“è§£**ï¼š

- å›æ»šç­–ç•¥åªèƒ½æ˜¯"ä»å¤‡ä»½æ¢å¤å…¨é‡æ•°æ® + ä»£ç å›é€€"
- ä¸æ”¯æŒ"ä»…å›æ»šä»£ç ä½†ä¿ç•™æ–°è¡¨"ï¼ˆå› ä¸ºæ—§ä»£ç ä¾èµ–æ—§è¡¨ï¼‰
- å›æ»šçª—å£ï¼š30 åˆ†é’Ÿå†…å‘ç°é—®é¢˜ç«‹å³å…¨é‡å›æ»š

---

## ğŸš¨ Part 6ï¼šå›æ»šæ–¹æ¡ˆ

### è§¦å‘å›æ»šçš„æ¡ä»¶

- è¿ç§»åæ•°æ®ä¸€è‡´æ€§éªŒè¯å¤±è´¥ï¼ˆç”¨æˆ·ç»´åº¦å¯¹è´¦ä¸ç¬¦ï¼‰
- å…³é”®ä¸šåŠ¡åŠŸèƒ½éªŒæ”¶å¤±è´¥ï¼ˆæŠ½å¥–/å…‘æ¢/èƒŒåŒ…æŸ¥è¯¢å¼‚å¸¸ï¼‰
- æœåŠ¡å¯åŠ¨å¤±è´¥æˆ–å¥åº·æ£€æŸ¥æŒç»­å¤±è´¥

### å›æ»šæ­¥éª¤ï¼ˆå…¨é‡å›æ»šï¼‰

```bash
# 1. åœæ­¢æœåŠ¡
./scripts/system/process-manager.sh stop

# 2. æ¢å¤æ•°æ®åº“å¤‡ä»½
mysql -u$DB_USER -p$DB_PASSWORD $DB_NAME < backups/backup_2025-12-18/full_backup.sql

# 3. å›é€€ä»£ç 
git reset --hard <commit_before_refactor>

# 4. é‡å¯æœåŠ¡
./scripts/system/process-manager.sh start pm2

# 5. éªŒè¯å›æ»šæˆåŠŸ
curl -s http://localhost:3000/health | jq
```

---

## ğŸ¯ Part 7ï¼šéªŒæ”¶æ ‡å‡†

### æ•°æ®å±‚éªŒæ”¶

- [ ] æ‰€æœ‰æ—§è¡¨å·²åˆ é™¤ï¼ˆ`SHOW TABLES` ä¸åŒ…å«æ—§è¡¨ï¼‰
- [ ] ç”¨æˆ·ç»´åº¦æ•°æ®ä¸€è‡´æ€§ 100%ï¼ˆæ˜¾ç¤ºç§¯åˆ†/é¢„ç®—ç§¯åˆ†/ç‰©å“æ•°é‡ï¼‰
- [ ] æµæ°´å¹‚ç­‰æ€§éªŒè¯é€šè¿‡ï¼ˆæ— é‡å¤ business_idï¼‰
- [ ] å¤–é”®å®Œæ•´æ€§éªŒè¯é€šè¿‡ï¼ˆæ— å­¤å„¿è®°å½•ï¼‰

### ä»£ç å±‚éªŒæ”¶

- [ ] å…¨ä»“åº“æ— æ—§æ¨¡å‹å¼•ç”¨ï¼ˆgrep ç»“æœä¸ºç©ºï¼‰
- [ ] å…¨ä»“åº“æ— æ—§æœåŠ¡å¼•ç”¨ï¼ˆgrep ç»“æœä¸ºç©ºï¼‰
- [ ] æ—§æ¨¡å‹æ–‡ä»¶å·²åˆ é™¤ï¼ˆls éªŒè¯ï¼‰
- [ ] æ—§æœåŠ¡æ–‡ä»¶å·²åˆ é™¤ï¼ˆls éªŒè¯ï¼‰

### åŠŸèƒ½å±‚éªŒæ”¶

- [ ] æ¶ˆè´¹å¥–åŠ±æµç¨‹æ­£å¸¸ï¼ˆæ˜¾ç¤ºç§¯åˆ† + é¢„ç®—ç§¯åˆ†åŒæ—¶åˆ°è´¦ï¼‰
- [ ] æŠ½å¥–æµç¨‹æ­£å¸¸ï¼ˆæ˜¾ç¤ºç§¯åˆ†æ‰£å‡ã€é¢„ç®—çº¦æŸç”Ÿæ•ˆã€è™šæ‹Ÿè´§å¸å‘æ”¾ï¼‰
- [ ] å…‘æ¢æµç¨‹æ­£å¸¸ï¼ˆè™šæ‹Ÿè´§å¸æ‰£å‡ã€ç‰©å“å®ä¾‹åˆ›å»ºã€æ ¸é”€ç ç”Ÿæˆï¼‰
- [ ] èƒŒåŒ…æŸ¥è¯¢æ­£å¸¸ï¼ˆè¿”å› assets[] + items[]ï¼‰
- [ ] å¹‚ç­‰æ€§éªŒè¯é€šè¿‡ï¼ˆé‡å¤è¯·æ±‚ä¸é‡å¤æ‰£è´¹ï¼‰

### ä¸šåŠ¡å±‚éªŒæ”¶

- [ ] ç®¡ç†åå°æ‰€æœ‰åŠŸèƒ½æ­£å¸¸ï¼ˆç”¨æˆ·ç®¡ç†/ç§¯åˆ†è°ƒæ•´/æ•°æ®ç»Ÿè®¡ï¼‰
- [ ] æµ‹è¯•å¥—ä»¶å…¨éƒ¨é€šè¿‡ï¼ˆ`npm run test`ï¼‰
- [ ] API æ€§èƒ½æ— æ˜æ˜¾é€€åŒ–ï¼ˆå“åº”æ—¶é—´ < 100msï¼‰

### è§„èŒƒå±‚éªŒæ”¶

- [ ] æ–‡æ¡£ä¸ä»£ç å®Œå…¨å¯¹é½ï¼ˆAPI_CONTRACT/DB_SCHEMA/ARCHITECTUREï¼‰
- [ ] æ— åºŸå¼ƒæ³¨é‡Šæ®‹ç•™ï¼ˆgrep éªŒè¯ï¼‰
- [ ] æ— æ—§è·¯ç”±æ®‹ç•™ï¼ˆåªæœ‰ canonical è·¯å¾„ï¼‰
- [ ] èµ„äº§ç æ ‡å‡†å·²å›ºåŒ–ï¼ˆASSET_CODE_STANDARD.mdï¼‰

---

## ğŸ“… Part 8ï¼šæ‰§è¡Œæ—¶é—´çª—å£

### æ¨èçª—å£ï¼šå‡Œæ™¨ 2:00-4:00ï¼ˆä¸šåŠ¡ä½å³°æœŸï¼‰

- **Phase 0ï¼ˆå‡†å¤‡ï¼‰**ï¼š1:00-2:00ï¼ˆ1 å°æ—¶ï¼‰
- **Phase 1ï¼ˆåœå†™+è¿ç§»ï¼‰**ï¼š2:00-2:30ï¼ˆ30 åˆ†é’Ÿï¼‰
- **Phase 2ï¼ˆä»£ç æ”¹é€ ï¼‰**ï¼š2:30-3:00ï¼ˆ30 åˆ†é’Ÿï¼‰
- **Phase 3ï¼ˆéªŒè¯+å¯åŠ¨ï¼‰**ï¼š3:00-3:30ï¼ˆ30 åˆ†é’Ÿï¼‰
- **Phase 4ï¼ˆæ¸…ç†æ®‹ç•™ï¼‰**ï¼š3:30-4:00ï¼ˆ30 åˆ†é’Ÿï¼‰
- **ç›‘æ§è§‚å¯Ÿ**ï¼š4:00-8:00ï¼ˆ4 å°æ—¶ï¼‰

### å›æ»šå†³ç­–ç‚¹

- **3:15 å‰å‘ç°é—®é¢˜**ï¼šç«‹å³å…¨é‡å›æ»šï¼ˆå¤‡ä»½æ¢å¤ + ä»£ç å›é€€ï¼‰
- **3:15 åå‘ç°é—®é¢˜**ï¼šè¯„ä¼°å½±å“é¢ï¼Œå°é—®é¢˜çƒ­ä¿®å¤ï¼Œå¤§é—®é¢˜æ¬¡æ—¥çª—å£å›æ»š

---

## ğŸ“ Part 9ï¼šæ‰§è¡Œçª—å£æ²Ÿé€šæ¸…å•

### T-24hï¼šæå‰é€šçŸ¥

- [ ] ç”¨æˆ·å…¬å‘Šï¼šç³»ç»Ÿç»´æŠ¤æ—¶é—´ï¼ˆå‡Œæ™¨ 2:00-4:00ï¼‰
- [ ] å®¢æœåŸ¹è®­ï¼šç»´æŠ¤æœŸé—´çš„åº”æ€¥è¯æœ¯
- [ ] å›¢é˜Ÿå¾…å‘½ï¼šå¼€å‘/è¿ç»´/æµ‹è¯•å›¢é˜Ÿç¡®è®¤åœ¨çº¿

### T-2hï¼šæœ€åå‡†å¤‡

- [ ] å…¨é‡æ•°æ®å¤‡ä»½å®Œæˆå¹¶éªŒè¯
- [ ] è¿ç§»è„šæœ¬åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯é€šè¿‡
- [ ] å›æ»šæ–¹æ¡ˆå·²å‡†å¤‡å¹¶æ¼”ç»ƒ
- [ ] ç›‘æ§å‘Šè­¦å·²é…ç½®

### T-0ï¼šå¼€å§‹æ‰§è¡Œ

- [ ] åœæ­¢æœåŠ¡
- [ ] æ‰§è¡Œè¿ç§»
- [ ] åˆ é™¤æ—§è¡¨
- [ ] æ”¹é€ ä»£ç 
- [ ] å¯åŠ¨æœåŠ¡
- [ ] åŠŸèƒ½éªŒæ”¶

### T+30minï¼šå›æ»šå†³ç­–ç‚¹

- [ ] æ•°æ®ä¸€è‡´æ€§éªŒè¯é€šè¿‡
- [ ] åŠŸèƒ½éªŒæ”¶é€šè¿‡
- [ ] å†³å®šï¼šç»§ç»­ or å›æ»š

### T+2hï¼šæ¸…ç†æ®‹ç•™

- [ ] åˆ é™¤æ—§ä»£ç æ–‡ä»¶
- [ ] åˆ é™¤åºŸå¼ƒæ³¨é‡Š
- [ ] æ¸…ç† backups/ ç›®å½•
- [ ] æ›´æ–°æ–‡æ¡£

### T+4hï¼šç›‘æ§è§‚å¯Ÿ

- [ ] ç›‘æ§ä¸šåŠ¡æŒ‡æ ‡ï¼ˆäº¤æ˜“æˆåŠŸç‡/å“åº”æ—¶é—´ï¼‰
- [ ] æ£€æŸ¥é”™è¯¯æ—¥å¿—ï¼ˆæ— å¼‚å¸¸æŠ¥é”™ï¼‰
- [ ] ç”¨æˆ·åé¦ˆï¼ˆæ— åŠŸèƒ½å¼‚å¸¸ï¼‰

---

## ğŸ¯ Part 10ï¼šæ ¸å¿ƒåŸåˆ™

1. **å•ä¸€çœŸç›¸**ï¼šæ¯ä¸ªé¢†åŸŸåªæœ‰ä¸€ä¸ªä½™é¢/çŠ¶æ€çœŸç›¸è¡¨
2. **åŸå­åˆ‡æ¢**ï¼šåœå†™ â†’ è¿ç§» â†’ åˆ æ—§ â†’ å¯åŠ¨ï¼Œä¸ç•™åŒè½¨çª—å£
3. **å¹‚ç­‰ä¿è¯**ï¼šæ‰€æœ‰èµ„äº§å˜åŠ¨å¿…é¡»æœ‰ business_id
4. **äº‹åŠ¡ä¸€è‡´æ€§**ï¼šå¤šè¡¨å†™æ“ä½œå¿…é¡»åœ¨åŒä¸€äº‹åŠ¡å†…
5. **ææ–™èµ„äº§æ”¯ä»˜**ï¼šå…‘æ¢å¸‚åœºåªæ”¯æŒææ–™èµ„äº§æ”¯ä»˜
6. **é¢„é˜²ä¼˜äºä¿®å¤**ï¼šé€šè¿‡çº¦æŸå’Œè§„èŒƒä»æºå¤´é˜²æ­¢é—®é¢˜

---

## ğŸ”¥ Part 12ï¼šé›¶å…¼å®¹æš´åŠ›é‡æ„éªŒæ”¶æ ‡å‡†ï¼ˆZero-Compatibility Brutal Refactorï¼‰

> **ç›®æ ‡**: å½»åº•åˆ é™¤æ‰€æœ‰åŒè½¨/æ—§æ–¹æ¡ˆæ®‹ç•™ï¼Œå®ç°"æ–‡æ¡£ = ä»£ç  = DB"çš„å”¯ä¸€çœŸç›¸æº  
> **é€‚ç”¨åœºæ™¯**: å·²å®Œæˆè¯•ç”Ÿäº§ï¼Œå‡†å¤‡å½»åº•é™ä½æŠ€æœ¯å€ºåŠ¡ï¼Œä¸å†å…¼å®¹ä»»ä½•æ—§ä»£ç /æ—§è¡¨/æ—§è·¯ç”±  
> **æ‰§è¡Œç­–ç•¥**: 410 Goneï¼ˆæ—§è·¯ç”±ï¼‰+ ç›´æ¥ä¸¢å¼ƒæ—§è¡¨æ•°æ® + æš´åŠ›åˆ é™¤æ—§ä»£ç   
> **ç¼–åˆ¶æ—¶é—´**: 2025-12-19  
> **éªŒæ”¶æ ‡å‡†**: grep é»‘åå•å…³é”®å­—å‘½ä¸­æ•° = 0

### 12.1 å½“å‰å‘ç°çš„åŒè½¨/æ—§æ–¹æ¡ˆæ®‹ç•™ï¼ˆå¿…é¡»åˆ‡æ–­ï¼‰

#### ğŸ”´ åˆ‡æ–­ç‚¹ 1ï¼šåº“å­˜/ç‰©å“çœŸç›¸åŒè½¨å¹¶å­˜ï¼ˆP0 ä¸¥é‡ï¼‰

**ç—‡çŠ¶**:

- âœ… æ–°æ–¹æ¡ˆï¼š`ItemInstance`ï¼ˆä¸å¯å åŠ ç‰©å“çœŸç›¸ï¼‰+ `RedemptionOrder`ï¼ˆæ ¸é”€ç çœŸç›¸ï¼‰+ `MarketListing`ï¼ˆäº¤æ˜“æŒ‚ç‰ŒçœŸç›¸ï¼‰
- âŒ æ—§æ–¹æ¡ˆä»åœ¨ï¼š`UserInventory` æ¨¡å‹/è¡¨ä»ç„¶å­˜åœ¨ï¼Œä¸”è¢« `InventoryService`ï¼ˆæ—§ç‰ˆï¼‰å¤§é‡å¼•ç”¨

**è¯æ®**:

```javascript
// models/index.js ç¬¬ 105-113 è¡Œ
models.UserInventory = require('./UserInventory')(sequelize, DataTypes)
/*
 * âœ… UserInventoryï¼šç”¨æˆ·åº“å­˜ç®¡ç†ï¼ˆå·²è¿ç§»è‡³ ItemInstanceï¼‰
 *    - âš ï¸ æ•°æ®å·²è¿ç§»è‡³ item_instances è¡¨ï¼Œuser_inventory ä½œä¸ºå†å²å…¼å®¹ä¿ç•™
 */
```

**å½±å“èŒƒå›´**:

- ä»£ç æ–‡ä»¶ï¼ˆ42ä¸ªï¼‰ï¼š`models/UserInventory.js`ã€`services/InventoryService.js`ã€ç›¸å…³æµ‹è¯•ã€è„šæœ¬ã€è¿ç§»æ–‡ä»¶
- è·¯ç”±æ–‡ä»¶ï¼ˆ2ä¸ªï¼‰ï¼š`routes/v4/unified-engine/inventory-core.js`ã€`inventory-market.js`
- æ•°æ®åº“è¡¨ï¼š`user_inventory`ï¼ˆæ•´è¡¨ï¼‰

---

#### ğŸ”´ åˆ‡æ–­ç‚¹ 2ï¼šå…‘æ¢å¸‚åœºæ—§è¯­ä¹‰æ®‹ç•™ï¼ˆP0/P1ï¼‰

**ç—‡çŠ¶**:

- âœ… æ¨¡å‹å­—æ®µå·²ç»Ÿä¸€ï¼š`ExchangeItem.cost_asset_code/cost_amount` + `ExchangeMarketRecord.pay_asset_code/pay_amount`
- âŒ æ—§è¯­ä¹‰æ®‹ç•™ï¼šJSDoc å‚æ•°æ³¨é‡Šã€æ—¥å¿—æè¿°ä»å‡ºç° `price_type (virtual/points/mixed)`

**è¯æ®**:

```javascript
// services/ExchangeMarketService.js ç¬¬ 213 è¡Œ
   * @param {string} [options.price_type] - æ”¯ä»˜æ–¹å¼ï¼ˆvirtual/points/mixedï¼‰

// app.js ç¬¬ 605-610 è¡Œ
  appLogger.info('V4å…‘æ¢å¸‚åœºç³»ç»ŸåŠ è½½æˆåŠŸï¼ˆåŒè´¦æˆ·æ¨¡å‹ï¼‰', {
    note: 'è™šæ‹Ÿå¥–å“ä»·å€¼/ç§¯åˆ†/æ··åˆæ”¯ä»˜å…‘æ¢ç³»ç»Ÿ'
  })
```

---

#### ğŸ”´ åˆ‡æ–­ç‚¹ 3ï¼šè·¯ç”±å±‚ models ç›´è¿ï¼ˆP1 ä¼˜åŒ–ï¼‰

**ç—‡çŠ¶**: æ–‡æ¡£å…è®¸"åªè¯»å®‰å…¨æ ¡éªŒç‰¹ä¾‹"ï¼Œä½†åœ¨"å½»åº•ç»Ÿä¸€"ç›®æ ‡ä¸‹å»ºè®®å½’é›¶

**è¯æ®**:

```javascript
// routes/v4/unified-engine/redemption.js ç¬¬ 68-69 è¡Œ
const { ItemInstance } = req.app.locals.models
const item = await ItemInstance.findByPk(item_instance_id)
```

---

### 12.2 æš´åŠ›åˆ‡æ¢æ‰§è¡Œæ–¹æ¡ˆï¼ˆ4 é˜¶æ®µï¼‰

#### é˜¶æ®µ Aï¼šæ•°æ®åº“å±‚æš´åŠ›åˆ‡æ¢ï¼ˆä¸€æ¬¡æ€§ destructive å˜æ›´ï¼‰

**A1. DROP æ—§è¡¨ï¼ˆç›´æ¥ä¸¢å¼ƒæ•°æ®ï¼‰**

```sql
-- ========================================
-- åˆ é™¤æ—§åº“å­˜çœŸç›¸è¡¨ï¼ˆuser_inventoryï¼‰
-- æ‰§è¡Œç­–ç•¥ï¼šç›´æ¥ä¸¢å¼ƒï¼ˆå·²ç¡®è®¤çº¿ä¸Šæ•°æ®ä¸éœ€è¦ä¿ç•™ï¼‰
-- ========================================

SET FOREIGN_KEY_CHECKS = 0;

-- åˆ é™¤ä¾èµ–æ—§è¡¨çš„å¤–é”®çº¦æŸï¼ˆå¦‚æœå­˜åœ¨ï¼‰
ALTER TABLE trade_records
DROP FOREIGN KEY IF EXISTS fk_trade_records_inventory_id;

-- åˆ é™¤ user_inventory è¡¨ï¼ˆå«æ‰€æœ‰æ•°æ®ï¼‰
DROP TABLE IF EXISTS user_inventory;

SET FOREIGN_KEY_CHECKS = 1;

-- éªŒè¯åˆ é™¤ç»“æœ
SHOW TABLES LIKE 'user_inventory';
-- é¢„æœŸç»“æœï¼šEmpty set (0.00 sec)
```

**A2. åŠ å¼ºæ–°è¡¨çº¦æŸï¼ˆå¼ºåˆ¶è§„èŒƒï¼‰**

```sql
-- ========================================
-- åŠ å¼º ExchangeMarketRecord çº¦æŸ
-- ç¡®ä¿ææ–™èµ„äº§æ”¯ä»˜å­—æ®µä¸ºå¿…å¡«ï¼ˆNOT NULLï¼‰
-- ========================================

-- 1. æ£€æŸ¥ç°æœ‰æ•°æ®å®Œæ•´æ€§
SELECT
  COUNT(*) AS total,
  COUNT(pay_asset_code) AS has_pay_asset_code,
  COUNT(pay_amount) AS has_pay_amount
FROM exchange_market_records;

-- 2. å¦‚æœç°æœ‰æ•°æ®æœ‰ NULLï¼Œå…ˆä¿®å¤
UPDATE exchange_market_records
SET
  pay_asset_code = cost_asset_code,
  pay_amount = cost_amount * quantity
WHERE pay_asset_code IS NULL OR pay_amount IS NULL;

-- 3. æ·»åŠ  NOT NULL çº¦æŸ
ALTER TABLE exchange_market_records
MODIFY COLUMN pay_asset_code VARCHAR(50) NOT NULL
COMMENT 'æ”¯ä»˜èµ„äº§ä»£ç ï¼ˆå¿…å¡«ï¼‰';

ALTER TABLE exchange_market_records
MODIFY COLUMN pay_amount BIGINT NOT NULL
COMMENT 'æ”¯ä»˜æ•°é‡ï¼ˆå¿…å¡«ï¼‰';

-- 4. ç¡®ä¿å¹‚ç­‰é”®å”¯ä¸€çº¦æŸå­˜åœ¨
ALTER TABLE exchange_market_records
ADD UNIQUE INDEX IF NOT EXISTS idx_business_id_unique (business_id);
```

---

#### é˜¶æ®µ Bï¼šä»£ç å±‚æš´åŠ›åˆ é™¤ï¼ˆä¸€æ¬¡æ€§æ¸…ç†ï¼‰

**B1. åˆ é™¤æ—§æ¨¡å‹ä¸æœåŠ¡ï¼ˆæ–‡ä»¶çº§ï¼‰**

```bash
#!/bin/bash
cd /home/devbox/project

# 1. åˆ é™¤æ—§æ¨¡å‹æ–‡ä»¶
rm -f models/UserInventory.js

# 2. åˆ é™¤æ—§æœåŠ¡æ–‡ä»¶
rm -f services/InventoryService.js

# 3. ä» models/index.js ç§»é™¤ UserInventory æ³¨å†Œï¼ˆéœ€æ‰‹å·¥ç¼–è¾‘ï¼‰
# åˆ é™¤ï¼šmodels.UserInventory = require('./UserInventory')...

# 4. ä» services/index.js ç§»é™¤ inventory æœåŠ¡æ³¨å†Œï¼ˆå¦‚æœå­˜åœ¨ï¼‰
# éªŒè¯ï¼šgrep "getService('inventory')" services/index.js
# é¢„æœŸï¼šæ— åŒ¹é…
```

**B2. åˆ é™¤æ—§æµ‹è¯•ä¸è„šæœ¬**

```bash
#!/bin/bash
cd /home/devbox/project

# åˆ é™¤åº“å­˜ç›¸å…³æµ‹è¯•æ–‡ä»¶
rm -f tests/business/inventory/*.test.js
rm -f tests/integration/*inventory*.test.js

# åˆ é™¤åº“å­˜ç›¸å…³è„šæœ¬
rm -f scripts/reconcile-inventory-migration.js
rm -f scripts/test_inventory_*.js
rm -f scripts/verify_inventory_routes.js

# åˆ é™¤è¿ç§»ç›¸å…³è„šæœ¬ï¼ˆä¸€æ¬¡æ€§è¿ç§»å·¥å…·ï¼‰
rm -rf scripts/migration/

# åˆ é™¤æ—§è¿ç§»æ–‡æ¡£
rm -f MIGRATION-COMPLETION-REPORT.md
```

**B3. åˆ é™¤æ—§ migrations æ–‡ä»¶ï¼ˆåªä¿ç•™æ–°åŸºçº¿ï¼‰**

```bash
#!/bin/bash
cd /home/devbox/project/migrations

# åˆ é™¤ user_inventory ç›¸å…³è¿ç§»ï¼ˆ6ä¸ªæ–‡ä»¶ï¼‰
rm -f 20251215220102-migrate-user-inventory-to-item-instances.js
rm -f 20251108234905-add-column-withdraw-fields-to-user-inventory.js
rm -f 20251215170000-add-selling-asset-fields-to-user-inventory.js
rm -f 20251109234600-cleanup-user-inventory-duplicate-verification-code-indexes.js
rm -f 20251109152918-add-operator-id-to-user-inventory.js
rm -f 20251109234220-add-transfer-tracking-fields-to-user-inventory.js

# åˆ é™¤æ—§æ”¯ä»˜æ–¹å¼è¿ç§»
rm -f 20251208234550-remove-price-type-points-mixed.js
rm -f 20251209002100-remove-payment-type-points-mixed-from-records.js
rm -f 20251206_dual_account_system.sql

# ä¿ç•™çš„åŸºçº¿è¿ç§»ï¼š
# - 20251215220101-create-item-instances-table.js
# - 20251217010000-create-redemption-orders-table.js
# - 20251215180000-create-market-listings-table.js
# - 20251215180100-add-pay-asset-fields-to-exchange-market-records.js
# - 20251219010000-add-not-null-constraints-material-asset-fields.js
```

---

#### é˜¶æ®µ Cï¼šè·¯ç”±å±‚å½»åº•ç»Ÿä¸€ï¼ˆ410 + Service ä¸‹æ²‰ï¼‰

**C1. æ—§è·¯ç”±æ˜¾å¼ 410 å¤„ç†**

æ–°å¢æ–‡ä»¶ï¼š`routes/v4/unified-engine/deprecated-routes.js`

```javascript
/**
 * å·²åºŸå¼ƒè·¯ç”±ç»Ÿä¸€å¤„ç†ï¼ˆ410 Goneï¼‰
 * åˆ›å»ºæ—¶é—´ï¼š2025-12-19
 */

const express = require('express')
const router = express.Router()

/**
 * 410 å“åº”å·¥å‚å‡½æ•°
 */
function gone410(oldPath, newPath, deprecatedSince) {
  return (req, res) => {
    return res.status(410).json({
      success: false,
      code: 'ENDPOINT_GONE',
      message: `æ­¤æ¥å£å·²æ°¸ä¹…åºŸå¼ƒï¼ˆè‡ª ${deprecatedSince}ï¼‰`,
      data: {
        deprecated_endpoint: oldPath,
        new_endpoint: newPath,
        deprecated_since: deprecatedSince,
        migration_guide: 'https://docs.yourproject.com/api-migration'
      },
      timestamp: new Date().toISOString(),
      version: 'v4.0'
    })
  }
}

// æ—§åº“å­˜è·¯ç”±
router.all(
  '/inventory/products',
  gone410('/api/v4/inventory/products', '/api/v4/exchange_market/items', '2025-12-12')
)

router.all(
  '/inventory/exchange',
  gone410('/api/v4/inventory/exchange', '/api/v4/exchange_market/exchange', '2025-12-12')
)

// æ—§æ ¸é”€ç è·¯ç”±
router.all(
  '/inventory/generate-code/:item_id',
  gone410('/api/v4/inventory/generate-code/:item_id', '/api/v4/redemption/orders', '2025-12-17')
)

router.all(
  '/inventory/verification/verify',
  gone410('/api/v4/inventory/verification/verify', '/api/v4/redemption/fulfill', '2025-12-17')
)

module.exports = router
```

åœ¨ `app.js` ä¸­æŒ‚è½½ï¼ˆåœ¨æ‰€æœ‰ä¸šåŠ¡è·¯ç”±ä¹‹åï¼Œ404 ä¹‹å‰ï¼‰ï¼š

```javascript
// å·²åºŸå¼ƒè·¯ç”±å¤„ç†ï¼ˆ410 Goneï¼‰
app.use('/api/v4', require('./routes/v4/unified-engine/deprecated-routes'))
```

**C2. è·¯ç”±å±‚ models ç›´è¿å½’é›¶ï¼ˆä¸‹æ²‰åˆ° Serviceï¼‰**

ä¿®æ”¹ `routes/v4/unified-engine/redemption.js`ï¼š

```javascript
// âŒ åˆ é™¤ï¼šè·¯ç”±å±‚ç›´è¿ models çš„æ‰€æœ‰æƒæ ¡éªŒ
// const { ItemInstance } = req.app.locals.models
// const item = await ItemInstance.findByPk(item_instance_id)
// if (item.owner_user_id !== userId) { ... }

// âœ… æ”¹ä¸ºï¼šæ‰€æœ‰æƒæ ¡éªŒä¸‹æ²‰åˆ° Service
const RedemptionOrderService = req.app.locals.services.getService('redemptionOrder')
const result = await RedemptionOrderService.createOrder(item_instance_id, {
  creator_user_id: userId // Service å†…éƒ¨ä¼šæ ¡éªŒæ‰€æœ‰æƒæˆ–ç®¡ç†å‘˜æƒé™
})
```

ä¿®æ”¹ `routes/v4/unified-engine/consumption.js`ï¼š

```javascript
// âŒ åˆ é™¤ï¼šè·¯ç”±å±‚ç›´è¿ models æŸ¥è¯¢ User
// const { User } = require('../../../models')
// const user = await User.findByPk(userId)

// âœ… æ”¹ä¸ºï¼šUUID æŸ¥è¯¢ä¸‹æ²‰åˆ° Service
const ConsumptionService = req.app.locals.services.getService('consumption')
const qrCodeData = await ConsumptionService.generateMerchantQRCode(userId)
```

---

#### é˜¶æ®µ Dï¼šéªŒæ”¶ä¸ç›‘æ§ï¼ˆè®©æ—§æ–¹æ¡ˆ"å¤ç‡ƒ"å˜å¾—ä¸å¯èƒ½ï¼‰

**D1. ä»£ç é»‘åå•å…³é”®å­—æ£€æŸ¥ï¼ˆgrep å‘½ä¸­æ•°å¿…é¡» = 0ï¼‰**

```bash
#!/bin/bash
# æš´åŠ›é‡æ„éªŒæ”¶è„šæœ¬ï¼ˆé»‘åå•å…³é”®å­—æ£€æŸ¥ï¼‰

KEYWORDS=(
  "UserInventory"           # æ—§åº“å­˜æ¨¡å‹
  "user_inventory"          # æ—§åº“å­˜è¡¨
  "InventoryService"        # æ—§åº“å­˜æœåŠ¡ï¼ˆæ’é™¤ BackpackServiceï¼‰
  "selling_points"          # æ—§å”®ä»·å­—æ®µï¼ˆç§¯åˆ†ï¼‰
  "verification_code"       # æ—§æ ¸é”€ç å­—æ®µï¼ˆå·²è¿ç§»åˆ° redemption_ordersï¼‰
  "price_type"              # æ—§æ”¯ä»˜æ–¹å¼å‚æ•°
  "payment_type"            # æ—§æ”¯ä»˜ç±»å‹å­—æ®µ
  "virtual_value"           # æ—§è™šæ‹Ÿä»·å€¼å­—æ®µ
  "points_paid"             # æ—§ç§¯åˆ†æ”¯ä»˜å­—æ®µ
  "åŒè´¦æˆ·"                   # æ—§æ–¹æ¡ˆæè¿°
  "åŒè½¨"                     # æ—§æ¶æ„æè¿°
  "å·²åºŸå¼ƒ"                   # deprecated æ ‡è®°
  "å†å²å…¼å®¹"                 # å…¼å®¹æ€§æ ‡è®°
  "å›æ»šè§‚æµ‹"                 # è¿ç§»æœŸæ ‡è®°
)

FAILED=0

for keyword in "${KEYWORDS[@]}"; do
  # æ’é™¤ï¼šdocs/ã€backups/ã€migrations/ã€node_modules/
  COUNT=$(rg "$keyword" \
    --glob '!docs/ZERO-COMPATIBILITY-BRUTAL-REFACTOR-PLAN.md' \
    --glob '!docs/è·¯ç”±å±‚ã€æ¨¡å‹å±‚ã€æœåŠ¡å±‚ã€æ•°æ®ä¸€è‡´æ€§æ–‡æ¡£.md' \
    --glob '!backups/' \
    --glob '!migrations/' \
    --glob '!node_modules/' \
    --count 2>/dev/null | wc -l)

  if [ "$COUNT" -gt 0 ]; then
    echo "âŒ é»‘åå•å…³é”®å­— '$keyword' ä»æœ‰ $COUNT å¤„å‘½ä¸­"
    FAILED=1
  else
    echo "âœ… é»‘åå•å…³é”®å­— '$keyword' å·²æ¸…é›¶"
  fi
done

if [ "$FAILED" -eq 0 ]; then
  echo "ğŸ‰ æš´åŠ›é‡æ„éªŒæ”¶é€šè¿‡ï¼šæ‰€æœ‰æ—§æ–¹æ¡ˆæ®‹ç•™å·²æ¸…é›¶"
  exit 0
else
  echo "ğŸš« æš´åŠ›é‡æ„éªŒæ”¶å¤±è´¥ï¼šä»æœ‰æ—§æ–¹æ¡ˆæ®‹ç•™"
  exit 1
fi
```

**D2. æ•°æ®åº“è¡¨æ¸…å•éªŒæ”¶ï¼ˆåªå…è®¸æ–°è¡¨å­˜åœ¨ï¼‰**

```sql
-- 1. ç¦æ­¢è¡¨æ¸…å•ï¼ˆå¿…é¡»ä¸å­˜åœ¨ï¼‰
SELECT TABLE_NAME FROM information_schema.TABLES
WHERE TABLE_SCHEMA = 'restaurant_lottery'
  AND TABLE_NAME IN ('user_inventory');
-- é¢„æœŸç»“æœï¼šEmpty set

-- 2. å¿…éœ€è¡¨æ¸…å•ï¼ˆå¿…é¡»å­˜åœ¨ï¼‰
SELECT TABLE_NAME FROM information_schema.TABLES
WHERE TABLE_SCHEMA = 'restaurant_lottery'
  AND TABLE_NAME IN (
    'item_instances',              -- ç‰©å“å®ä¾‹çœŸç›¸
    'redemption_orders',           -- æ ¸é”€ç çœŸç›¸
    'market_listings',             -- äº¤æ˜“æŒ‚ç‰ŒçœŸç›¸
    'trade_orders',                -- äº¤æ˜“è®¢å•çœŸç›¸
    'exchange_market_records',     -- å…‘æ¢å¸‚åœºè®¢å•
    'account_asset_balances'       -- å¯å åŠ èµ„äº§çœŸç›¸
  );
-- é¢„æœŸç»“æœï¼š6 rows

-- 3. å…³é”®çº¦æŸéªŒæ”¶
SELECT
  COLUMN_NAME,
  IS_NULLABLE,
  COLUMN_KEY
FROM information_schema.COLUMNS
WHERE TABLE_SCHEMA = 'restaurant_lottery'
  AND TABLE_NAME = 'exchange_market_records'
  AND COLUMN_NAME IN ('pay_asset_code', 'pay_amount', 'business_id');
-- é¢„æœŸï¼špay_asset_code/pay_amount IS_NULLABLE=NO, business_id COLUMN_KEY=UNI
```

**D3. è·¯ç”±åˆ†å±‚éªŒæ”¶ï¼ˆè·¯ç”±å±‚é›¶ models ç›´è¿ï¼‰**

```bash
#!/bin/bash
# è·¯ç”±åˆ†å±‚éªŒæ”¶ï¼šç¦æ­¢è·¯ç”±å±‚ç›´è¿ models

cd /home/devbox/project

# 1. æ£€æŸ¥è·¯ç”±å±‚æ˜¯å¦æœ‰ models å¼•ç”¨
ROUTES_WITH_MODELS=$(rg "require\(['\"].*models|app\.locals\.models" routes/ --files-with-matches)

if [ -z "$ROUTES_WITH_MODELS" ]; then
  echo "âœ… è·¯ç”±å±‚é›¶ models ç›´è¿"
else
  echo "âŒ ä»¥ä¸‹è·¯ç”±ä»åœ¨ç›´è¿ modelsï¼ˆå¿…é¡»ä¸‹æ²‰åˆ° Serviceï¼‰ï¼š"
  echo "$ROUTES_WITH_MODELS"
  exit 1
fi

# 2. æ£€æŸ¥è·¯ç”±å±‚æ˜¯å¦æœ‰ sequelize.transaction()
ROUTES_WITH_TX=$(rg "sequelize\.transaction\(" routes/ --files-with-matches)

if [ -z "$ROUTES_WITH_TX" ]; then
  echo "âœ… è·¯ç”±å±‚é›¶äº‹åŠ¡å¼€å¯"
else
  echo "âŒ ä»¥ä¸‹è·¯ç”±ä»åœ¨å¼€å¯äº‹åŠ¡ï¼ˆå¿…é¡»ä¸‹æ²‰åˆ° Serviceï¼‰ï¼š"
  echo "$ROUTES_WITH_TX"
  exit 1
fi

echo "ğŸ‰ è·¯ç”±åˆ†å±‚éªŒæ”¶å®Œæˆ"
```

---

### 12.3 P0 çº§ç¦æ­¢æ¸…å•ï¼ˆPR åˆå¹¶å‰å¼ºåˆ¶æ£€æŸ¥ï¼‰

#### ğŸš« ä»£ç å±‚ç¦ç”¨å…³é”®å­—ï¼ˆgrep å‘½ä¸­å³æ‹’ç» PRï¼‰

**æ¨¡å‹/è¡¨å**:

- `UserInventory`ï¼ˆæ—§åº“å­˜æ¨¡å‹ï¼‰
- `user_inventory`ï¼ˆæ—§åº“å­˜è¡¨ï¼‰
- `InventoryService`ï¼ˆæ—§åº“å­˜æœåŠ¡ï¼Œ`BackpackService`/`RedemptionOrderService` é™¤å¤–ï¼‰

**å­—æ®µå**:

- `selling_points`ï¼ˆæ—§å”®ä»·å­—æ®µï¼Œå·²æ”¹ä¸º `selling_amount + selling_asset_code`ï¼‰
- `verification_code`ï¼ˆæ—§æ ¸é”€ç å­—æ®µï¼Œå·²è¿ç§»åˆ° `redemption_orders.code_hash`ï¼‰
- `payment_type`ã€`price_type`ï¼ˆæ—§æ”¯ä»˜æ–¹å¼å­—æ®µï¼‰
- `points_paid`ã€`virtual_value_paid`ï¼ˆæ—§æ”¯ä»˜é‡‘é¢å­—æ®µï¼‰

**ä¸šåŠ¡è¯­ä¹‰**:

- `dual_account`ã€`åŒè´¦æˆ·`ï¼ˆæ—§æ–¹æ¡ˆæè¿°ï¼‰
- `mixed`ï¼ˆæ··åˆæ”¯ä»˜ï¼‰
- `virtual/points/mixed`ï¼ˆæ—§æ”¯ä»˜è¯­ä¹‰ï¼‰

**æ³¨é‡Šæ ‡è®°**:

- `å·²åºŸå¼ƒ`ã€`deprecated`ã€`@deprecated`
- `å†å²å…¼å®¹`ã€`backward compatibility`
- `å›æ»šè§‚æµ‹`ã€`è¿ç§»æœŸ`ã€`åŒè½¨`
- `æ—§ç‰ˆ`ã€`legacy`

---

#### ğŸš« ç¦æ­¢çš„ä»£ç æ¨¡å¼

**æ¨¡å¼ 1ï¼šè·¯ç”±å±‚ç›´è¿ models**

```javascript
// âŒ ç¦æ­¢
const { User, ItemInstance } = req.app.locals.models
const item = await ItemInstance.findByPk(id)

// âœ… æ­£ç¡®
const RedemptionOrderService = req.app.locals.services.getService('redemptionOrder')
const result = await RedemptionOrderService.createOrder(item_id, { creator_user_id })
```

**æ¨¡å¼ 2ï¼šè·¯ç”±å±‚å¼€å¯äº‹åŠ¡**

```javascript
// âŒ ç¦æ­¢
const transaction = await sequelize.transaction()
try {
  // ...ä¸šåŠ¡é€»è¾‘
  await transaction.commit()
}

// âœ… æ­£ç¡®
const AssetService = req.app.locals.services.getService('asset')
await AssetService.changeBalance({ ... }, { transaction })
```

**æ¨¡å¼ 3ï¼šService æ–¹æ³•æ¥å—æ—§æ”¯ä»˜è¯­ä¹‰å‚æ•°**

```javascript
// âŒ ç¦æ­¢
static async exchangeItem(userId, itemId, { price_type, points_amount }) { ... }

// âœ… æ­£ç¡®
static async exchangeItem(userId, itemId, quantity, options = {}) {
  // å†…éƒ¨ä» ExchangeItem è¯»å– cost_asset_code/cost_amount
}
```

---

### 12.4 å¼ºåˆ¶ 410 å¤„ç†æ ‡å‡†

**æ‰€æœ‰å·²åºŸå¼ƒæ¥å£å¿…é¡»**:

1. è¿”å› **410 Gone** çŠ¶æ€ç ï¼ˆè€Œé 404ï¼‰
2. å“åº”ä½“åŒ…å« `deprecated_endpoint` + `new_endpoint` + `deprecated_since`
3. æä¾›è¿ç§»æ–‡æ¡£é“¾æ¥ï¼ˆ`migration_guide`ï¼‰

**æ ‡å‡†å“åº”æ ¼å¼**:

```json
{
  "success": false,
  "code": "ENDPOINT_GONE",
  "message": "æ­¤æ¥å£å·²æ°¸ä¹…åºŸå¼ƒï¼ˆè‡ª 2025-12-12ï¼‰",
  "data": {
    "deprecated_endpoint": "/api/v4/inventory/exchange",
    "new_endpoint": "/api/v4/exchange_market/exchange",
    "deprecated_since": "2025-12-12",
    "migration_guide": "https://docs.yourproject.com/api-migration"
  },
  "timestamp": "2025-12-19T10:00:00+08:00",
  "version": "v4.0"
}
```

---

### 12.5 PR åˆå¹¶å‰å¼ºåˆ¶æ£€æŸ¥æ¸…å•

#### PR æäº¤å‰ï¼ˆæœ¬åœ°è‡ªæ£€ï¼‰

- [ ] æ‰§è¡Œé»‘åå•å…³é”®å­—æ£€æŸ¥è„šæœ¬ï¼ˆæ— å‘½ä¸­ï¼‰
- [ ] æ‰§è¡Œè·¯ç”±åˆ†å±‚æ£€æŸ¥è„šæœ¬ï¼ˆé€šè¿‡ï¼‰
- [ ] ç¡®è®¤æ‰€æœ‰ Service æ–¹æ³•ç­¾åä¸å«æ—§å‚æ•°
- [ ] ç¡®è®¤æ‰€æœ‰æ³¨é‡Š/æ—¥å¿—ä¸å«æ—§è¯­ä¹‰æè¿°

#### Code Review æ—¶ï¼ˆå®¡æŸ¥å¿…æŸ¥é¡¹ï¼‰

- [ ] æ˜¯å¦å¼•å…¥ä»»ä½•é»‘åå•å…³é”®å­—ï¼Ÿ
- [ ] æ˜¯å¦åœ¨è·¯ç”±å±‚ç›´è¿ models æˆ–å¼€å¯äº‹åŠ¡ï¼Ÿ
- [ ] æ˜¯å¦ä½¿ç”¨ç»Ÿä¸€å“åº”ä¸­é—´ä»¶ï¼ˆ`res.apiSuccess/apiError`ï¼‰ï¼Ÿ
- [ ] æ˜¯å¦æ‰€æœ‰èµ„äº§å˜åŠ¨æ“ä½œæœ‰äº‹åŠ¡ + å¹‚ç­‰ + å®¡è®¡æ—¥å¿—ï¼Ÿ

#### åˆå¹¶åï¼ˆCI è‡ªåŠ¨æ£€æŸ¥ï¼‰

- [ ] GitHub Actions é»‘åå•æ£€æŸ¥é€šè¿‡
- [ ] è·¯ç”±åˆ†å±‚æ£€æŸ¥é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡ï¼ˆæ ¸å¿ƒé“¾è·¯ï¼‰

---

### 12.6 æ‰§è¡Œæ—¶é—´è¡¨ï¼ˆå»ºè®®å•æ¬¡åœæœºå®Œæˆï¼‰

| æ—¶é—´æ®µ     | æ“ä½œå†…å®¹                    | è´Ÿè´£äºº      | éªŒæ”¶æ ‡å‡†                 |
| ---------- | --------------------------- | ----------- | ------------------------ |
| T-1 å¤©     | æ‰§è¡Œæœ€ç»ˆå¤‡ä»½ + æµ‹è¯•ç¯å¢ƒé¢„æ¼” | DBA + åç«¯  | å¤‡ä»½å¯æ¢å¤ï¼Œæµ‹è¯•ç¯å¢ƒé€šè¿‡ |
| T0 00:00   | åœæ­¢æœåŠ¡ï¼ˆåœæœºçª—å£å¼€å§‹ï¼‰    | è¿ç»´        | ç”¨æˆ·æ— æ³•è®¿é—®             |
| T0 00:05   | é˜¶æ®µ Aï¼šæ•°æ®åº“å±‚æš´åŠ›åˆ‡æ¢    | DBA         | SQL éªŒæ”¶é€šè¿‡             |
| T0 00:15   | é˜¶æ®µ Bï¼šä»£ç å±‚æš´åŠ›åˆ é™¤      | åç«¯        | æ–‡ä»¶åˆ é™¤æ¸…å•å®Œæˆ         |
| T0 00:25   | é˜¶æ®µ Cï¼šè·¯ç”±å±‚ç»Ÿä¸€          | åç«¯        | 410 è·¯ç”±éƒ¨ç½²å®Œæˆ         |
| T0 00:35   | é˜¶æ®µ Dï¼šéªŒæ”¶è„šæœ¬            | åç«¯ + DBA  | æ‰€æœ‰éªŒæ”¶é€šè¿‡             |
| T0 00:45   | å¯åŠ¨æœåŠ¡ + å¥åº·æ£€æŸ¥         | è¿ç»´        | /health è¿”å› healthy     |
| T0 01:00   | å¼€æ”¾æœåŠ¡ï¼ˆåœæœºçª—å£ç»“æŸï¼‰    | è¿ç»´        | ç”¨æˆ·å¯æ­£å¸¸è®¿é—®           |
| T0 ~ T+24h | æŒç»­ç›‘æ§                    | è¿ç»´ + åç«¯ | æ— å¼‚å¸¸å‘Šè­¦               |

**æ€»åœæœºæ—¶é•¿**: 60 åˆ†é’Ÿ

---

### 12.7 ç²¾ç¡®åˆ é™¤æ¸…å•ï¼ˆæ–‡ä»¶çº§ + è¡¨çº§ï¼‰

#### æ¨¡å‹å±‚ï¼ˆ1ä¸ªï¼‰

- [ ] `models/UserInventory.js`ï¼ˆæ•´ä¸ªæ–‡ä»¶ï¼‰
- [ ] `models/index.js`ï¼ˆåˆ é™¤ UserInventory æ³¨å†Œè¡Œï¼‰

#### æœåŠ¡å±‚ï¼ˆ1ä¸ªï¼‰

- [ ] `services/InventoryService.js`ï¼ˆæ•´ä¸ªæ–‡ä»¶ï¼Œ3000+ è¡Œï¼‰
- [ ] `services/index.js`ï¼ˆå¦‚æœæ³¨å†Œäº† inventory æœåŠ¡ï¼Œåˆ é™¤æ³¨å†Œè¡Œï¼‰

#### æµ‹è¯•æ–‡ä»¶ï¼ˆçº¦ 10 ä¸ªï¼‰

- [ ] `tests/business/inventory/` æ•´ä¸ªç›®å½•
- [ ] `tests/integration/*inventory*.test.js`
- [ ] `tests/integration/transfer_history_complete.test.js`
- [ ] `tests/integration/market_withdraw_optimization.test.js`

#### è„šæœ¬æ–‡ä»¶ï¼ˆçº¦ 8 ä¸ªï¼‰

- [ ] `scripts/reconcile-inventory-migration.js`
- [ ] `scripts/test_inventory_routes.js`
- [ ] `scripts/verify_inventory_routes.js`
- [ ] `scripts/test_inventory_transfer_audit.js`
- [ ] `scripts/migration/` æ•´ä¸ªç›®å½•
- [ ] `scripts/archived/one-time-migrations/migrate_inventory_fields.js`

#### è¿ç§»æ–‡ä»¶ï¼ˆ12 ä¸ªï¼‰

- [ ] `migrations/20251215220102-migrate-user-inventory-to-item-instances.js`
- [ ] `migrations/20251108234905-add-column-withdraw-fields-to-user-inventory.js`
- [ ] `migrations/20251215170000-add-selling-asset-fields-to-user-inventory.js`
- [ ] `migrations/20251109234600-cleanup-user-inventory-duplicate-verification-code-indexes.js`
- [ ] `migrations/20251109152918-add-operator-id-to-user-inventory.js`
- [ ] `migrations/20251109234220-add-transfer-tracking-fields-to-user-inventory.js`
- [ ] `migrations/20251208234550-remove-price-type-points-mixed.js`
- [ ] `migrations/20251209002100-remove-payment-type-points-mixed-from-records.js`
- [ ] `migrations/20251206_dual_account_system.sql`
- [ ] `migrations/DEPRECATED_EXCHANGE_RECORDS.md`
- [ ] `migrations/20251107000000-extend-trade-records-inventory-transfer.js`
- [ ] `migrations/20251211170000-add-inventory-transfer-operation-type.js`

#### æ–‡æ¡£ä¸æŠ¥å‘Šï¼ˆ6 ä¸ªï¼‰

- [ ] `MIGRATION-COMPLETION-REPORT.md`
- [ ] `scripts/migration/post-migration-verification.md`
- [ ] `scripts/migration/PRE-MIGRATION-CHECKLIST.md`
- [ ] `scripts/SCRIPT_ANALYSIS_REPORT.md`
- [ ] å…¶ä»–åŒ…å«"è¿ç§»""åŒè½¨""å…¼å®¹"å­—æ ·çš„ markdown æ–‡æ¡£ï¼ˆæ’é™¤æœ¬æ–‡æ¡£å’Œ `ZERO-COMPATIBILITY-BRUTAL-REFACTOR-PLAN.md`ï¼‰

#### æ•°æ®åº“è¡¨åˆ é™¤

```sql
-- æ‰§è¡Œå‰å¿…é¡»å¤‡ä»½ï¼
DROP TABLE IF EXISTS user_inventory;

-- å¦‚æœ exchange è¡¨ä»æ®‹ç•™æ—§å­—æ®µï¼Œæ‰§è¡Œï¼š
ALTER TABLE exchange_market_records DROP COLUMN IF EXISTS payment_type;
ALTER TABLE exchange_market_records DROP COLUMN IF EXISTS points_paid;
ALTER TABLE exchange_market_records DROP COLUMN IF EXISTS virtual_value_paid;
ALTER TABLE exchange_items DROP COLUMN IF EXISTS price_type;
```

---

### 12.8 æ³¨é‡Šæ¸…ç†æ¸…å•ï¼ˆæ—§è¯­ä¹‰æ“¦é™¤ï¼‰

#### app.js

```diff
- // V4å…‘æ¢å¸‚åœºè·¯ç”±ï¼ˆåŒè´¦æˆ·+å•†åŸåŒç©æ³•æ–¹æ¡ˆï¼‰
+ // V4å…‘æ¢å¸‚åœºè·¯ç”±
  app.use('/api/v4/exchange_market', require('./routes/v4/unified-engine/exchange_market'))
- appLogger.info('V4å…‘æ¢å¸‚åœºç³»ç»ŸåŠ è½½æˆåŠŸï¼ˆåŒè´¦æˆ·æ¨¡å‹ï¼‰', {
+ appLogger.info('V4å…‘æ¢å¸‚åœºç³»ç»ŸåŠ è½½æˆåŠŸ', {
    route: '/api/v4/exchange_market',
-   note: 'è™šæ‹Ÿå¥–å“ä»·å€¼/ç§¯åˆ†/æ··åˆæ”¯ä»˜å…‘æ¢ç³»ç»Ÿ'
+   note: 'ææ–™èµ„äº§å…‘æ¢ç³»ç»Ÿï¼ˆV4.5.0ç»Ÿä¸€ç‰ˆï¼‰'
  })
```

#### services/ExchangeMarketService.js

```diff
  /**
   * è·å–å…‘æ¢å¸‚åœºå•†å“åˆ—è¡¨
   * @param {Object} options - æŸ¥è¯¢é€‰é¡¹
   * @param {string} [options.status='active'] - å•†å“çŠ¶æ€ï¼ˆactive/inactiveï¼‰
-  * @param {string} [options.price_type] - æ”¯ä»˜æ–¹å¼ï¼ˆvirtual/points/mixedï¼‰
+  * @param {string} [options.asset_code] - ææ–™èµ„äº§ä»£ç ç­›é€‰ï¼ˆå¯é€‰ï¼‰
   * @param {number} [options.page=1] - é¡µç 
   */
```

#### models/index.js

```diff
- models.UserInventory = require('./UserInventory')(sequelize, DataTypes)
- /*
-  * âœ… UserInventoryï¼šç”¨æˆ·åº“å­˜ç®¡ç†ï¼ˆå·²è¿ç§»è‡³ ItemInstanceï¼‰
-  *    - âš ï¸ æ•°æ®å·²è¿ç§»è‡³ item_instances è¡¨ï¼Œuser_inventory ä½œä¸ºå†å²å…¼å®¹ä¿ç•™
-  */
```

---

### 12.9 CI å¼ºåˆ¶æ£€æŸ¥ï¼ˆé˜²æ­¢æ—§æ–¹æ¡ˆå¤ç‡ƒï¼‰

æ–°å¢æ–‡ä»¶ï¼š`.github/workflows/brutal-refactor-check.yml`ï¼ˆæˆ–é›†æˆåˆ°ç°æœ‰ CIï¼‰

```yaml
name: æš´åŠ›é‡æ„éªŒæ”¶æ£€æŸ¥

on: [push, pull_request]

jobs:
  refactor-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: é»‘åå•å…³é”®å­—æ£€æŸ¥
        run: |
          FAILED=0

          if rg "UserInventory" --glob '!docs/' --glob '!backups/' --quiet; then
            echo "âŒ å‘ç° UserInventory æ®‹ç•™"
            FAILED=1
          fi

          if rg "InventoryService" --glob '!BackpackService.js' --quiet; then
            echo "âŒ å‘ç° InventoryService æ®‹ç•™"
            FAILED=1
          fi

          if rg "price_type|payment_type|virtual_value|points_paid" services/ routes/ --quiet; then
            echo "âŒ å‘ç°æ—§æ”¯ä»˜è¯­ä¹‰æ®‹ç•™"
            FAILED=1
          fi

          exit $FAILED

      - name: è·¯ç”±åˆ†å±‚æ£€æŸ¥
        run: |
          if rg "require\(['\"].*models" routes/ --quiet; then
            echo "âŒ è·¯ç”±å±‚ä»åœ¨ç›´è¿ models"
            exit 1
          fi

          if rg "sequelize\.transaction\(" routes/ --quiet; then
            echo "âŒ è·¯ç”±å±‚ä»åœ¨å¼€å¯äº‹åŠ¡"
            exit 1
          fi

          echo "âœ… è·¯ç”±åˆ†å±‚æ£€æŸ¥é€šè¿‡"
```

---

### 12.10 FAQï¼ˆå¸¸è§é—®é¢˜ï¼‰

#### Q1: ä¸ºä»€ä¹ˆä¸ä¿ç•™ user_inventory ä½œä¸º"åªè¯»å†å²è¡¨"ï¼Ÿ

**A**: ç›®æ ‡æ˜¯"é™ä½ç»´æŠ¤å¤æ‚åº¦"ï¼Œä¿ç•™æ—§è¡¨ä¼šå¯¼è‡´ï¼š

- å¼€å‘äººå‘˜å¯èƒ½è¯¯ç”¨ï¼ˆå†™ JOIN æŸ¥è¯¢ï¼‰
- å ç”¨æ•°æ®åº“èµ„æºï¼ˆç´¢å¼•/å­˜å‚¨ï¼‰
- åˆ¶é€ "åŒçœŸç›¸"å¹»è§‰ï¼ˆåˆ°åº•è°æ˜¯æƒå¨ï¼Ÿï¼‰

â†’ **ç›´æ¥åˆ é™¤æ›´æ¸…æ™°**ï¼Œå†å²æ•°æ®å·²åœ¨å¤‡ä»½ä¸­ã€‚

#### Q2: å¦‚æœçº¿ä¸Šçªç„¶å‘ç°éœ€è¦æ—§æ•°æ®æ€ä¹ˆåŠï¼Ÿ

**A**: ä»å¤‡ä»½ SQL ä¸­æå–ï¼š

```bash
# ä»å¤‡ä»½æ¢å¤åˆ°ä¸´æ—¶åº“
mysql -h localhost -u root -p temp_db < backups/final-before-brutal-refactor-*/full_database.sql

# æå–ç‰¹å®šç”¨æˆ·çš„æ—§æ•°æ®
mysql -h localhost -u root -p temp_db -e \
  "SELECT * FROM user_inventory WHERE user_id = 123;" \
  --json > user_123_old_inventory.json
```

#### Q3: å‰ç«¯å›¢é˜Ÿè¯´"æ¥ä¸åŠåŒæ­¥è¿ç§»"æ€ä¹ˆåŠï¼Ÿ

**A**: 410 å“åº”æœ¬èº«å°±æ˜¯"ä¼˜é›…çš„ä¸å…¼å®¹"ï¼š

- å‰ç«¯å¯ä¸´æ—¶æ•è· 410ï¼Œæç¤ºç”¨æˆ·"åŠŸèƒ½å·²å‡çº§ï¼Œè¯·æ›´æ–° App"
- æˆ–å‰ç«¯åš"è‡ªåŠ¨é‡è¯•åˆ°æ–°è·¯ç”±"ï¼ˆè§£æ `data.new_endpoint`ï¼‰
- **ä¸å»ºè®®**åç«¯åšé‡å®šå‘/å…¼å®¹ï¼ˆè¿èƒŒ"é›¶å…¼å®¹"ç›®æ ‡ï¼‰

#### Q4: CI é»‘åå•æ£€æŸ¥ä¼šä¸ä¼šè¯¯ä¼¤åˆæ³•ä½¿ç”¨åœºæ™¯ï¼Ÿ

**A**: å¯èƒ½è¯¯ä¼¤çš„åœºæ™¯ï¼š

- æ–‡æ¡£ä¸­å¼•ç”¨æ—§å…³é”®å­—ï¼ˆå¦‚"UserInventory å·²åˆ é™¤"ï¼‰â†’ åœ¨ `rg` æ—¶ç”¨ `--glob '!docs/'` æ’é™¤
- æµ‹è¯•æ–‡ä»¶ä¸­æµ‹è¯•æ—§æ¥å£ï¼ˆå¦‚"ç¡®è®¤æ—§æ¥å£è¿”å› 410"ï¼‰â†’ æŒ‰éœ€è°ƒæ•´é»‘åå•æˆ–æ’é™¤æµ‹è¯•ç›®å½•

â†’ å»ºè®®ï¼šé»‘åå•è„šæœ¬åªæ‰«æ `services/`ã€`routes/`ã€`models/`ï¼ˆæ ¸å¿ƒä¸šåŠ¡ä»£ç ï¼‰

---

> **å®Œæ•´æ‰§è¡Œæ–¹æ¡ˆè¯¦è§**: `docs/ZERO-COMPATIBILITY-BRUTAL-REFACTOR-PLAN.md`ï¼ˆåŒ…å«å¤‡ä»½ç­–ç•¥ã€å›æ»šå†³ç­–æ ‘ã€ç›‘æ§æŒ‡æ ‡ã€ä¸€é”®æ‰§è¡Œè„šæœ¬ç­‰ï¼‰
