# é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿåç«¯æ¶æ„é‡æ„æ–¹æ¡ˆ

## ğŸ“Œ æ–‡æ¡£è¯´æ˜

**ç‰ˆæœ¬**: v2.0ï¼ˆç²¾ç®€å®ç”¨ç‰ˆï¼‰  
**åˆ›å»ºæ—¶é—´**: 2025å¹´12æœˆ09æ—¥  
**é€‚ç”¨èŒƒå›´**: V4.0 ç»Ÿä¸€å¼•æ“æ¶æ„  
**é‡æ„èŒƒå›´**: åç«¯æ•°æ®åº“è®¿é—®å±‚æ¶æ„  
**æ–‡æ¡£ç‰¹ç‚¹**: åŸºäºçœŸå®ä»£ç ç°çŠ¶ï¼Œä¸å¼•ç”¨å…¶å®ƒæŠ¥å‘Šï¼Œé‡‡ç”¨å®ç”¨ä¸»ä¹‰åŸåˆ™

---

## æ ¸å¿ƒé—®é¢˜

å½“å‰åç«¯å­˜åœ¨**æ¶æ„åˆ†å±‚é—®é¢˜**ï¼Œä¸»è¦ä½“ç°åœ¨ï¼š

1. **è·¯ç”±å±‚è¿‡é‡**ï¼š`inventory.js` 2933 è¡Œï¼ˆ20 ä¸ªç«¯ç‚¹ï¼‰ï¼Œç›´æ¥æ“ä½œ models 28 æ¬¡
2. **Service å±‚ä¸å®Œæ•´**ï¼šç¼ºå°‘ `InventoryService`ï¼Œå¯¼è‡´åº“å­˜é€»è¾‘æ•£è½åœ¨è·¯ç”±ä¸­
3. **èŒè´£ä¸æ¸…**ï¼šä¸€ä¸ªæ–‡ä»¶æ··åˆäº†åº“å­˜ç®¡ç†ã€å…‘æ¢ç³»ç»Ÿã€å¸‚åœºåŠŸèƒ½ã€æ ¸é”€ç³»ç»Ÿ
4. **æµ‹è¯•å›°éš¾**ï¼šä¸šåŠ¡é€»è¾‘ä¸ HTTP å±‚è€¦åˆï¼Œæ— æ³•ç‹¬ç«‹æµ‹è¯•

**é¢„æœŸæ•ˆæœï¼ˆå®ç”¨ä¸»ä¹‰ç‰ˆï¼‰**ï¼š

| æŒ‡æ ‡ | å½“å‰çŠ¶æ€ | ç¬¬ä¸€é˜¶æ®µç›®æ ‡ | æœ€ç»ˆç›®æ ‡ | æ”¹è¿›å¹…åº¦ |
|------|---------|------------|---------|---------|
| inventory.js è¡Œæ•° | 2933 è¡Œ | 2333 è¡Œ | 1900 è¡Œ | **å‡å°‘ 35%** |
| ç›´æ¥æ“ä½œ models | 28 å¤„ | 22 å¤„ | 10 å¤„ | **å‡å°‘ 64%** |
| Service è¦†ç›–ç‡ | ~40% | ~55% | ~70% | **æå‡ 75%** |
| æ ¸å¿ƒç«¯ç‚¹é‡æ„ | 0/20 | 4/20 | 10/20 | **50% è¦†ç›–** |

**è°ƒæ•´è¯´æ˜**ï¼š
- âœ… ç¬¬ä¸€é˜¶æ®µï¼ˆ2 å‘¨ï¼‰ï¼šé‡æ„ 4 ä¸ªæ ¸å¿ƒç«¯ç‚¹ï¼ˆP0+P1ï¼‰ï¼Œå‡å°‘ 600 è¡Œ
- âœ… æœ€ç»ˆç›®æ ‡ï¼šé‡æ„ 10 ä¸ªç«¯ç‚¹ï¼Œå‡å°‘ 1000 è¡Œï¼ˆä¿ç•™å¸‚åœºåŠŸèƒ½ç­‰å¤æ‚æ¨¡å—ï¼‰
- âŒ ä¸å¼ºæ±‚ 70% å‡å°‘ï¼ˆè¿‡åº¦è®¾è®¡ï¼‰
- âœ… æ¸è¿›å¼ä¼˜åŒ–ï¼Œæ¯æ¬¡éªŒè¯æ•ˆæœ

---

## ğŸ“‹ ç›®å½•

- [ä¸€ã€å½“å‰ä»£ç ç°çŠ¶åˆ†æ](#ä¸€å½“å‰ä»£ç ç°çŠ¶åˆ†æ)
- [äºŒã€ç›®æ ‡æ¶æ„è®¾è®¡](#äºŒç›®æ ‡æ¶æ„è®¾è®¡)
- [ä¸‰ã€åˆ†é˜¶æ®µå®æ–½è®¡åˆ’](#ä¸‰åˆ†é˜¶æ®µå®æ–½è®¡åˆ’)
- [å››ã€å®æ–½æ£€æŸ¥æ¸…å•](#å››å®æ–½æ£€æŸ¥æ¸…å•)

---

## ä¸€ã€å½“å‰ä»£ç ç°çŠ¶åˆ†æ

### 1.1 æ•°æ®æ¨¡å‹ç°çŠ¶ï¼ˆ31 ä¸ªæ¨¡å‹ï¼‰

**åŸºäº `models/index.js` çš„çœŸå®ç»Ÿè®¡**ï¼š

```
ç”¨æˆ·ä½“ç³»ï¼ˆ5 ä¸ªï¼‰
â”œâ”€â”€ User - ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
â”œâ”€â”€ Role - UUID è§’è‰²ç³»ç»Ÿ
â”œâ”€â”€ UserRole - ç”¨æˆ·è§’è‰²å…³è”
â”œâ”€â”€ UserHierarchy - ç”¨æˆ·å±‚çº§å…³ç³»
â””â”€â”€ RoleChangeLog - è§’è‰²å˜æ›´æ—¥å¿—

ç§¯åˆ†ä½“ç³»ï¼ˆ2 ä¸ªï¼‰
â”œâ”€â”€ UserPointsAccount - ç§¯åˆ†è´¦æˆ·
â””â”€â”€ PointsTransaction - ç§¯åˆ†äº¤æ˜“è®°å½•

åº“å­˜ä½“ç³»ï¼ˆ2 ä¸ªï¼‰
â”œâ”€â”€ UserInventory - ç”¨æˆ·åº“å­˜/èƒŒåŒ…
â””â”€â”€ TradeRecord - äº¤æ˜“è®°å½•

å…‘æ¢ä½“ç³»ï¼ˆ4 ä¸ªï¼‰
â”œâ”€â”€ Product - å•†å“ä¿¡æ¯
â”œâ”€â”€ ExchangeRecords - ç§¯åˆ†å…‘æ¢å®ç‰©è®°å½•
â”œâ”€â”€ ExchangeItem - å…‘æ¢å¸‚åœºå•†å“é…ç½®
â””â”€â”€ ExchangeMarketRecord - å…‘æ¢å¸‚åœºè®¢å•

æŠ½å¥–ä½“ç³»ï¼ˆ5 ä¸ªï¼‰
â”œâ”€â”€ LotteryCampaign - æŠ½å¥–æ´»åŠ¨
â”œâ”€â”€ LotteryPrize - å¥–å“é…ç½®
â”œâ”€â”€ LotteryDraw - æŠ½å¥–è®°å½•
â”œâ”€â”€ LotteryPreset - æŠ½å¥–é¢„è®¾
â””â”€â”€ LotteryManagementSetting - æŠ½å¥–ç®¡ç†è®¾ç½®

å®¡æ ¸ä½“ç³»ï¼ˆ3 ä¸ªï¼‰
â”œâ”€â”€ ContentReviewRecord - å†…å®¹å®¡æ ¸è®°å½•
â”œâ”€â”€ AdminOperationLog - ç®¡ç†å‘˜æ“ä½œæ—¥å¿—
â””â”€â”€ ConsumptionRecord - æ¶ˆè´¹è®°å½•

ç³»ç»ŸåŠŸèƒ½ï¼ˆ10 ä¸ªï¼‰
â”œâ”€â”€ SystemAnnouncement - ç³»ç»Ÿå…¬å‘Š
â”œâ”€â”€ SystemSettings - ç³»ç»Ÿè®¾ç½®
â”œâ”€â”€ Feedback - ç”¨æˆ·åé¦ˆ
â”œâ”€â”€ CustomerServiceSession - å®¢æœä¼šè¯
â”œâ”€â”€ ChatMessage - èŠå¤©æ¶ˆæ¯
â”œâ”€â”€ AuthenticationSession - è®¤è¯ä¼šè¯
â”œâ”€â”€ ImageResources - å›¾ç‰‡èµ„æº
â”œâ”€â”€ Store - é—¨åº—ä¿¡æ¯
â”œâ”€â”€ UserPremiumStatus - é«˜çº§ç©ºé—´çŠ¶æ€
â””â”€â”€ WebSocketStartupLog - WebSocket æ—¥å¿—
```

### 1.2 Service å±‚ç°çŠ¶

**âœ… å·²å­˜åœ¨ä¸”åŠŸèƒ½å®Œæ•´çš„ Serviceï¼ˆ12 ä¸ªï¼‰**

| Service | æ–‡ä»¶ | å½“å‰ä½¿ç”¨æƒ…å†µ | è´Ÿè´£è¡¨ |
|---------|------|------------|--------|
| PointsService | services/PointsService.js | âœ… routes/points.js å·²ä½¿ç”¨ | user_points_accounts, points_transactions |
| ExchangeMarketService | services/ExchangeMarketService.js | âœ… routes/exchange_market.js å·²ä½¿ç”¨ | exchange_items, exchange_market_records |
| ExchangeOperationService | services/ExchangeOperationService.js | âœ… æ‰¹é‡å®¡æ ¸ä½¿ç”¨ | exchange_records |
| ContentAuditEngine | services/ContentAuditEngine.js | âœ… å®¡æ ¸ç³»ç»Ÿä½¿ç”¨ | content_review_records |
| AnnouncementService | services/AnnouncementService.js | âœ… å…¬å‘Šç³»ç»Ÿä½¿ç”¨ | system_announcements |
| NotificationService | services/NotificationService.js | âœ… é€šçŸ¥ç³»ç»Ÿä½¿ç”¨ | - |
| ConsumptionService | services/ConsumptionService.js | âœ… æ¶ˆè´¹è®°å½•ä½¿ç”¨ | consumption_records |
| CustomerServiceSessionService | services/CustomerServiceSessionService.js | âœ… å®¢æœç³»ç»Ÿä½¿ç”¨ | customer_service_sessions, chat_messages |
| HierarchyManagementService | services/HierarchyManagementService.js | âœ… å±‚çº§ç®¡ç†ä½¿ç”¨ | user_hierarchy |
| UserRoleService | services/UserRoleService.js | âœ… è§’è‰²ç®¡ç†ä½¿ç”¨ | roles, user_roles, role_change_logs |
| UnifiedLotteryEngine | services/UnifiedLotteryEngine/ | âœ… æŠ½å¥–ç³»ç»Ÿä½¿ç”¨ | lottery_* ç³»åˆ—è¡¨ |
| ThumbnailService | services/ThumbnailService.js | âœ… ç¼©ç•¥å›¾æœåŠ¡ | image_resources |

**âŒ ç¡®å®ç¼ºå¤±çš„ Serviceï¼ˆ1 ä¸ªï¼‰**

- **InventoryService** - åº“å­˜ç®¡ç†æœåŠ¡
  - è¯æ®ï¼š`services/index.js` ç¬¬ 14 è¡Œæ ‡è®°ä¸º `// TODO: å¾…å®ç°`
  - å½±å“ï¼š`routes/v4/unified-engine/inventory.js`ï¼ˆ2933 è¡Œï¼‰ç›´æ¥æ“ä½œ models 28 æ¬¡
  - ä¼˜å…ˆçº§ï¼š**P0ï¼ˆæœ€é«˜ï¼‰**

### 1.3 è·¯ç”±å±‚é—®é¢˜åˆ†æ

**åŸºäºå®é™…è¡Œæ•°å’Œä»£ç æ‰«æçš„ç»Ÿè®¡**ï¼š

| è·¯ç”±æ–‡ä»¶ | è¡Œæ•° | API ç«¯ç‚¹æ•° | ç›´æ¥æ“ä½œ models | é—®é¢˜ä¸¥é‡ç¨‹åº¦ | ä¼˜å…ˆçº§ |
|---------|------|-----------|----------------|------------|--------|
| inventory.js | 2933 | 20 ä¸ª | 28 æ¬¡ | ğŸ”´ ä¸¥é‡ | P0 |
| points.js | 2364 | çº¦ 10 ä¸ª | 3 æ¬¡ | ğŸŸ¡ ä¸­ç­‰ | P1 |
| exchange_market.js | 488 | 6 ä¸ª | 0 æ¬¡ | âœ… è‰¯å¥½ | - |

**inventory.js çš„ 20 ä¸ª API ç«¯ç‚¹ï¼ˆçœŸå®ç»Ÿè®¡ï¼‰**ï¼š

```
ç”¨æˆ·ç«¯æ¥å£ï¼ˆ9 ä¸ªï¼‰ï¼š
â”œâ”€â”€ GET  /user/:user_id - è·å–ç”¨æˆ·åº“å­˜åˆ—è¡¨
â”œâ”€â”€ GET  /item/:item_id - è·å–ç‰©å“è¯¦æƒ…
â”œâ”€â”€ POST /use/:item_id - ä½¿ç”¨ç‰©å“
â”œâ”€â”€ POST /transfer - è½¬è®©ç‰©å“
â”œâ”€â”€ GET  /transfer-history - è½¬è®©å†å²
â”œâ”€â”€ POST /generate-code/:item_id - ç”Ÿæˆæ ¸é”€ç 
â”œâ”€â”€ POST /verification/verify - æ ¸é”€éªŒè¯
â”œâ”€â”€ GET  /products - è·å–å¯å…‘æ¢å•†å“
â””â”€â”€ POST /exchange - å…‘æ¢å•†å“

å…‘æ¢è®°å½•ç®¡ç†ï¼ˆ2 ä¸ªï¼‰ï¼š
â”œâ”€â”€ GET  /exchange-records - å…‘æ¢è®°å½•åˆ—è¡¨
â””â”€â”€ POST /exchange-records/:id/cancel - å–æ¶ˆå…‘æ¢

å¸‚åœºåŠŸèƒ½ï¼ˆ5 ä¸ªï¼‰ï¼š
â”œâ”€â”€ GET  /market/products - å¸‚åœºå•†å“åˆ—è¡¨
â”œâ”€â”€ GET  /market/products/:id - å•†å“è¯¦æƒ…
â”œâ”€â”€ POST /market/products/:id/purchase - è´­ä¹°å•†å“
â”œâ”€â”€ POST /market/products/:id/withdraw - æç°å•†å“
â””â”€â”€ POST /market/list - ä¸Šæ¶å•†å“

ç®¡ç†å‘˜æ¥å£ï¼ˆ4 ä¸ªï¼‰ï¼š
â”œâ”€â”€ GET  /admin/statistics - ç®¡ç†å‘˜ç»Ÿè®¡
â”œâ”€â”€ GET  /market/listing-status - ä¸Šæ¶çŠ¶æ€
â””â”€â”€ POST /market/products/:id/... - å…¶ä»–ç®¡ç†æ“ä½œ
```

**æ ¸å¿ƒé—®é¢˜**ï¼š
- 20 ä¸ªæ¥å£æ··åœ¨ä¸€ä¸ª 2933 è¡Œçš„æ–‡ä»¶ä¸­
- ä¸šåŠ¡é€»è¾‘åˆ†æ•£ï¼šåº“å­˜ç®¡ç† + å…‘æ¢ç³»ç»Ÿ + å¸‚åœºåŠŸèƒ½ + æ ¸é”€ç³»ç»Ÿ
- æ¯ä¸ªæ¥å£å¹³å‡ 146 è¡Œï¼ˆ2933 / 20ï¼‰ï¼Œè¿œè¶…åˆç†èŒƒå›´ï¼ˆåº” < 50 è¡Œï¼‰

#### å…¸å‹é—®é¢˜ä»£ç ç¤ºä¾‹

**âŒ é—®é¢˜ä»£ç ï¼šinventory.jsï¼ˆç¬¬ 105-150 è¡Œï¼‰**

```javascript
// é—®é¢˜ 1ï¼šç›´æ¥æ“ä½œ Model
const { count, rows: inventory } = await models.UserInventory.findAndCountAll({
  where: whereConditions,
  attributes: [...],
  order: [['acquired_at', 'DESC']],
  limit: finalLimit,
  offset
})

// é—®é¢˜ 2ï¼šä¸šåŠ¡é€»è¾‘åœ¨ Controller
const processedInventory = inventory.map(item => {
  const itemData = item.toJSON()
  itemData.status_description = getStatusDescription(itemData.status)
  if (itemData.expires_at) {
    itemData.is_expired = BeijingTimeHelper.createBeijingTime() > new Date(itemData.expires_at)
  }
  return itemData
})

// é—®é¢˜ 3ï¼šæƒé™æ£€æŸ¥åœ¨ Controllerï¼ˆç¬¬ 60-71 è¡Œï¼‰
const userRoles = await getUserRoles(req.user.user_id)
if (requestedUserId !== req.user.user_id && !userRoles.isAdmin) {
  return res.apiError('æ— æƒé™æŸ¥çœ‹å…¶ä»–ç”¨æˆ·åº“å­˜', 'FORBIDDEN', null, 403)
}
```

**âœ… è‰¯å¥½ä»£ç ï¼šexchange_market.jsï¼ˆç¬¬ 101-110 è¡Œï¼‰**

```javascript
// âœ… è–„è·¯ç”±ï¼šåªåšå‚æ•°éªŒè¯å’Œè°ƒç”¨ Service
router.get('/items', authenticateToken, async (req, res) => {
  try {
    const { status = 'active', price_type, page = 1, page_size = 20 } = req.query
    
    // å‚æ•°éªŒè¯
    const finalPage = Math.max(parseInt(page) || 1, 1)
    const finalPageSize = Math.min(Math.max(parseInt(page_size) || 20, 1), 50)
    
    // è°ƒç”¨ Service
    const result = await ExchangeMarketService.getMarketItems({
      status, price_type, page: finalPage, page_size: finalPageSize
    })
    
    return res.apiSuccess(result, 'è·å–å•†å“åˆ—è¡¨æˆåŠŸ')
  } catch (error) {
    return res.apiError(error.message, 'INTERNAL_ERROR', null, 500)
  }
})
```

### 1.4 æœªæŒ‚è½½æ–‡ä»¶æ¸…ç†éœ€æ±‚

**éœ€è¦å½’æ¡£çš„æ–‡ä»¶ï¼ˆ5 ä¸ªï¼‰**ï¼š

```
routes/v4/
â”œâ”€â”€ notifications_refactored.js          # é€šçŸ¥ä¸­å¿ƒé‡æ„ç‰ˆï¼ˆæœªæŒ‚è½½ï¼‰
â”œâ”€â”€ admin_announcements_refactored.js    # åå°å…¬å‘Šç®¡ç†é‡æ„ç‰ˆï¼ˆæœªæŒ‚è½½ï¼‰
â”œâ”€â”€ system_announcements_refactored.js   # ç”¨æˆ·ç«¯å…¬å‘Šé‡æ„ç‰ˆï¼ˆæœªæŒ‚è½½ï¼‰
â”œâ”€â”€ system.js.backup.2025-12-07T15-52-52-157Z  # å¤‡ä»½æ–‡ä»¶
â””â”€â”€ system.js.backup.20251207_155110     # å¤‡ä»½æ–‡ä»¶
```

**é—®é¢˜**ï¼š
- è¿™äº›æ–‡ä»¶å­˜åœ¨ä½†æœªè¢« `app.js` å¼•ç”¨
- å®¹æ˜“é€ æˆæ··æ·†ï¼šä¸çŸ¥é“å“ªä¸ªæ˜¯æ­£åœ¨ç”¨çš„ç‰ˆæœ¬
- å­˜åœ¨è¢«è¯¯æŒ‚è½½çš„é£é™©

---

## äºŒã€ç›®æ ‡æ¶æ„è®¾è®¡

### 2.1 åˆ†å±‚æ¶æ„åŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     HTTP Layer (è·¯ç”±å±‚)                      â”‚
â”‚  - å‚æ•°è§£æä¸éªŒè¯                                             â”‚
â”‚  - JWT è®¤è¯ä¸æƒé™æ£€æŸ¥                                         â”‚
â”‚  - è°ƒç”¨ Service æ–¹æ³•                                         â”‚
â”‚  - ç»Ÿä¸€å“åº”æ ¼å¼ (res.apiSuccess/apiError)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Service Layer (æœåŠ¡å±‚)                     â”‚
â”‚  - ä¸šåŠ¡è§„åˆ™ä¸æµç¨‹æ§åˆ¶                                         â”‚
â”‚  - è·¨è¡¨äº‹åŠ¡å¤„ç†                                              â”‚
â”‚  - æƒé™ä¸çŠ¶æ€éªŒè¯                                            â”‚
â”‚  - è°ƒç”¨å¤šä¸ª Model                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Data Access Layer (æ•°æ®è®¿é—®å±‚)              â”‚
â”‚  - Sequelize æ¨¡å‹å®šä¹‰                                        â”‚
â”‚  - åŸºç¡€ CRUD æ“ä½œ                                            â”‚
â”‚  - æ¨¡å‹å…³è”å…³ç³»                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 èŒè´£åˆ’åˆ†

**è·¯ç”±å±‚ï¼ˆControllerï¼‰åªåš 4 ä»¶äº‹**ï¼š

1. **é‰´æƒä¸æƒé™æ£€æŸ¥**ï¼š`authenticateToken`ã€`requireAdmin` ç­‰ä¸­é—´ä»¶
2. **å‚æ•°è§£æä¸éªŒè¯**ï¼šä» `req.query`/`req.body`/`req.params` æå–å‚æ•°
3. **è°ƒç”¨ Service**ï¼šè°ƒç”¨ 1-2 ä¸ª Service æ–¹æ³•
4. **ç»Ÿä¸€å“åº”**ï¼šç”¨ `res.apiSuccess` / `res.apiError` è¿”å›ç»“æœ

**ç¦æ­¢åœ¨è·¯ç”±å±‚åšçš„äº‹**ï¼š

- âŒ ç›´æ¥æ“ä½œ `models.XXX.findAll()` / `update()` / `create()`
- âŒ ç¼–å†™å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼ˆif/else è¶…è¿‡ 3 å±‚ï¼‰
- âŒ è·¨è¡¨äº‹åŠ¡å¤„ç†ï¼ˆ`sequelize.transaction()`ï¼‰
- âŒ ç›´æ¥ä¿®æ”¹æ•æ„Ÿæ•°æ®ï¼ˆç§¯åˆ†ã€åº“å­˜ã€è®¢å•çŠ¶æ€ç­‰ï¼‰

**Service å±‚è´Ÿè´£**ï¼š

1. **ä¸šåŠ¡è§„åˆ™éªŒè¯**ï¼šæ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³ã€ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿã€æƒé™æ˜¯å¦æ»¡è¶³
2. **çŠ¶æ€æµè½¬æ§åˆ¶**ï¼šè®¢å•çŠ¶æ€æœºã€åº“å­˜çŠ¶æ€å˜æ›´ã€å®¡æ ¸æµç¨‹
3. **è·¨è¡¨äº‹åŠ¡å¤„ç†**ï¼šåŒæ—¶ä¿®æ”¹å¤šå¼ è¡¨ï¼Œä¿è¯åŸå­æ€§
4. **ä¸šåŠ¡æ—¥å¿—è®°å½•**ï¼šæ“ä½œæ—¥å¿—ã€å®¡è®¡æ—¥å¿—ã€é€šçŸ¥æ¶ˆæ¯

**Model å±‚è´Ÿè´£**ï¼š

1. **æ•°æ®ç»“æ„å®šä¹‰**ï¼šå­—æ®µç±»å‹ã€é»˜è®¤å€¼ã€ç´¢å¼•
2. **æ¨¡å‹å…³è”å…³ç³»**ï¼š`hasMany`ã€`belongsTo` ç­‰
3. **æ•°æ®éªŒè¯è§„åˆ™**ï¼šå­—æ®µé•¿åº¦ã€æ ¼å¼æ ¡éªŒ

### 2.3 é¢†åŸŸæœåŠ¡è¾¹ç•Œï¼ˆåŸºäºçœŸå®ä¸šåŠ¡ï¼‰

**åŸºäºå®é™…è¡¨å’Œ Service çš„æ˜ å°„**ï¼š

| é¢†åŸŸ | è´Ÿè´£è¡¨ | Service | ç°çŠ¶ | æ ¸å¿ƒæ–¹æ³•ï¼ˆä»å®é™…ä»£ç æå–ï¼‰ | ä¸šåŠ¡ç‰¹ç‚¹ |
|------|--------|---------|------|------------------------|---------|
| ç§¯åˆ† | user_points_accounts<br>points_transactions | PointsService | âœ… å·²å®ç° | addPoints() - å¢åŠ ç§¯åˆ†<br>consumePoints() - æ¶ˆè´¹ç§¯åˆ†<br>refundPoints() - é€€å›ç§¯åˆ†<br>createPendingPointsForConsumption() - åˆ›å»ºå¾…å®¡æ ¸ç§¯åˆ†<br>approveConsumption() - å®¡æ ¸é€šè¿‡<br>getUserTransactions() - äº¤æ˜“å†å² | â€¢ æ”¯æŒäº‹åŠ¡ä¼ å…¥<br>â€¢ å¹‚ç­‰æ€§æ§åˆ¶ï¼ˆbusiness_idï¼‰<br>â€¢ pending çŠ¶æ€å®¡æ ¸æœºåˆ¶<br>â€¢ æ‚²è§‚é”é˜²å¹¶å‘ |
| åº“å­˜ | user_inventory<br>trade_records | InventoryService | âŒ å¾…åˆ›å»º | getUserInventory() - è·å–åº“å­˜<br>getItemDetail() - ç‰©å“è¯¦æƒ…<br>useItem() - ä½¿ç”¨ç‰©å“<br>transferItem() - è½¬è®©ç‰©å“<br>generateVerificationCode() - ç”Ÿæˆæ ¸é”€ç <br>verifyCode() - æ ¸é”€éªŒè¯ | â€¢ éœ€æ”¯æŒ 20 ä¸ªç«¯ç‚¹çš„ä¸šåŠ¡<br>â€¢ åŒ…å«æ ¸é”€ç³»ç»Ÿ<br>â€¢ åŒ…å«è½¬è®©è®°å½•<br>â€¢ æƒé™åˆ†çº§ï¼ˆç”¨æˆ·/ç®¡ç†å‘˜ï¼‰ |
| å…‘æ¢å¸‚åœº | exchange_items<br>exchange_market_records | ExchangeMarketService | âœ… å·²å®ç° | getMarketItems() - å•†å“åˆ—è¡¨<br>getItemDetail() - å•†å“è¯¦æƒ…<br>exchangeItem() - å…‘æ¢å•†å“<br>getUserOrders() - ç”¨æˆ·è®¢å• | â€¢ åªæ”¯æŒè™šæ‹Ÿå¥–å“æ”¯ä»˜<br>â€¢ ç¦æ­¢æ‰£é™¤ available_points<br>â€¢ payment_type å¼ºåˆ¶ä¸º 'virtual'<br>â€¢ äº‹åŠ¡ä¿æŠ¤ |
| å®¡æ ¸ | content_review_records<br>admin_operation_logs | ContentAuditEngine | âœ… å·²å®ç° | createAudit() - åˆ›å»ºå®¡æ ¸<br>approve() - å®¡æ ¸é€šè¿‡<br>reject() - å®¡æ ¸æ‹’ç» | â€¢ é€šç”¨å®¡æ ¸å¼•æ“<br>â€¢ æ”¯æŒå¤šç§ä¸šåŠ¡ç±»å‹ |
| é€šçŸ¥å…¬å‘Š | system_announcements | AnnouncementService | âœ… å·²å®ç° | getAnnouncements() - å…¬å‘Šåˆ—è¡¨<br>createAnnouncement() - åˆ›å»ºå…¬å‘Š | â€¢ ç®€å• CRUD |

**è¾¹ç•Œè§„åˆ™**ï¼š

- âœ… Service å¯ä»¥è°ƒç”¨å…¶ä»– Serviceï¼ˆå¦‚ `ExchangeMarketService` è°ƒç”¨ `InventoryService`ï¼‰
- âœ… Service å¯ä»¥ç›´æ¥æ“ä½œè‡ªå·±è´Ÿè´£çš„è¡¨
- âŒ Service **ç¦æ­¢**ç›´æ¥æ“ä½œå…¶ä»–é¢†åŸŸçš„è¡¨ï¼ˆå¿…é¡»é€šè¿‡å¯¹åº” Serviceï¼‰
- âŒ Controller **ç¦æ­¢**ç›´æ¥æ“ä½œä»»ä½•è¡¨ï¼ˆå¿…é¡»é€šè¿‡ Serviceï¼‰

---

## ä¸‰ã€åˆ†é˜¶æ®µå®æ–½è®¡åˆ’

### æ€»ä½“æ—¶é—´å®‰æ’ï¼š2 å‘¨ï¼ˆå®ç”¨ä¸»ä¹‰ç‰ˆï¼‰

**åŸºäºçœŸå®ä¸šåŠ¡ä»·å€¼çš„è°ƒæ•´**ï¼š

```
Week 1: é˜¶æ®µ 1ï¼ˆä¿æŠ¤ç°çŠ¶ + æ ¸å¿ƒé‡æ„ï¼‰
â”œâ”€ Day 1: è¡¥å……å›å½’æµ‹è¯•ï¼ˆä»…æ ¸å¿ƒ 2 ä¸ªç«¯ç‚¹ï¼‰
â”œâ”€ Day 2: æ¸…ç†æœªæŒ‚è½½æ–‡ä»¶ + åˆ›å»º InventoryService éª¨æ¶
â”œâ”€ Day 3: è¿ç§» getUserInventory æ¥å£ï¼ˆP0 - é«˜é¢‘æŸ¥è¯¢ï¼‰
â”œâ”€ Day 4-5: è¿ç§» useItem æ¥å£ï¼ˆP0 - æ ¸å¿ƒä¸šåŠ¡ï¼‰

Week 2: é˜¶æ®µ 2ï¼ˆæ‰©å±•é‡æ„ + éªŒæ”¶ï¼‰
â”œâ”€ Day 1-2: è¿ç§» transferItem æ¥å£ï¼ˆP1 - ä¸­ç­‰ä¼˜å…ˆçº§ï¼‰
â”œâ”€ Day 3: è¿ç§» getItemDetail æ¥å£ï¼ˆP1 - ç®€å•å¿«é€Ÿï¼‰
â”œâ”€ Day 4: æ‰©å±• ServiceManager + æ¸…ç† points.js
â”œâ”€ Day 5: å…¨é¢å›å½’æµ‹è¯• + æ–‡æ¡£æ›´æ–°
```

**è°ƒæ•´ç†ç”±**ï¼š
- âœ… å‹ç¼©åˆ° 2 å‘¨ï¼ˆåŸè®¡åˆ’ 3 å‘¨ï¼‰
- âœ… ç¬¬ä¸€å‘¨å®Œæˆ P0 ç«¯ç‚¹ï¼ˆæœ€é«˜ä»·å€¼ï¼‰
- âœ… ç¬¬äºŒå‘¨å®Œæˆ P1 ç«¯ç‚¹ï¼ˆä¸­ç­‰ä»·å€¼ï¼‰
- âŒ æš‚ä¸å¤„ç† P2 ç«¯ç‚¹ï¼ˆæ ¸é”€ç³»ç»Ÿï¼Œä½é¢‘ä½¿ç”¨ï¼‰
- âŒ å–æ¶ˆ"ç»Ÿä¸€é”™è¯¯å¤„ç†"ï¼ˆä¸ç¬¦åˆç°æœ‰æŠ€æœ¯è·¯çº¿ï¼‰

---

### é˜¶æ®µ 1ï¼šä¿æŠ¤ç°çŠ¶ï¼ˆé¢„è®¡ 1-2 å¤©ï¼‰

**ç›®æ ‡ï¼šå»ºç«‹å®‰å…¨ç½‘ï¼Œç¡®ä¿åç»­å˜æ›´å¯å›æ»š**

#### 1.1 è¡¥å……è‡ªåŠ¨åŒ–å›å½’æµ‹è¯•

**ä»»åŠ¡æ¸…å•**ï¼š

- [ ] åˆ›å»º `tests/integration/inventory-api.test.js`
- [ ] è¦†ç›– 3 ä¸ªå…³é”®æ¥å£ï¼š
  - `GET /api/v4/inventory/user/:user_id` - è·å–åº“å­˜åˆ—è¡¨
  - `POST /api/v4/inventory/item/:item_id/use` - ä½¿ç”¨ç‰©å“
  - `POST /api/v4/inventory/item/:item_id/transfer` - è½¬è®©ç‰©å“
- [ ] æ¯ä¸ªæ¥å£éªŒè¯ï¼š
  - çŠ¶æ€ç ï¼ˆ200/400/403/500ï¼‰
  - å“åº”æ ¼å¼ï¼ˆdata/message/codeï¼‰
  - å…³é”®å­—æ®µå­˜åœ¨æ€§ï¼ˆinventory_id/status/nameï¼‰

**æµ‹è¯•ç¤ºä¾‹**ï¼š

```javascript
// tests/integration/inventory-api.test.js
describe('åº“å­˜ API å›å½’æµ‹è¯•', () => {
  test('GET /api/v4/inventory/user/:user_id - è·å–åº“å­˜åˆ—è¡¨', async () => {
    const response = await request(app)
      .get('/api/v4/inventory/user/1')
      .set('Authorization', `Bearer ${testToken}`)
      .expect(200)
    
    expect(response.body).toHaveProperty('data')
    expect(response.body.data).toHaveProperty('inventory')
    expect(response.body.data).toHaveProperty('pagination')
  })
  
  test('POST /api/v4/inventory/item/:item_id/use - ä½¿ç”¨ç‰©å“', async () => {
    const response = await request(app)
      .post('/api/v4/inventory/item/1/use')
      .set('Authorization', `Bearer ${testToken}`)
      .expect(200)
    
    expect(response.body.data).toHaveProperty('status', 'used')
  })
})
```

**éªŒæ”¶æ ‡å‡†**ï¼š

- æ‰€æœ‰å…³é”®æ¥å£æµ‹è¯•é€šè¿‡
- æµ‹è¯•å¯åœ¨ 5 åˆ†é’Ÿå†…å®Œæˆ
- å¤±è´¥æ—¶æœ‰æ¸…æ™°çš„é”™è¯¯æç¤º

#### 1.2 æ¸…ç†æœªæŒ‚è½½å’Œå¤‡ä»½æ–‡ä»¶

**ä»»åŠ¡æ¸…å•**ï¼š

- [ ] åˆ›å»ºå½’æ¡£ç›®å½•ï¼š
  ```bash
  mkdir -p routes/v4/_archived/refactored-drafts
  mkdir -p routes/v4/_archived/backups
  ```
- [ ] ç§»åŠ¨æ–‡ä»¶ï¼š
  ```bash
  mv routes/v4/notifications_refactored.js routes/v4/_archived/refactored-drafts/
  mv routes/v4/admin_announcements_refactored.js routes/v4/_archived/refactored-drafts/
  mv routes/v4/system_announcements_refactored.js routes/v4/_archived/refactored-drafts/
  mv routes/v4/system.js.backup.* routes/v4/_archived/backups/
  ```
- [ ] åœ¨æ¯ä¸ªå½’æ¡£æ–‡ä»¶é¡¶éƒ¨æ·»åŠ è¯´æ˜æ³¨é‡Šï¼š
  ```javascript
  /**
   * âš ï¸ æ­¤æ–‡ä»¶å·²å½’æ¡£ - æœªå¯ç”¨çš„é‡æ„è‰æ¡ˆ
   * 
   * å½’æ¡£åŸå› ï¼šè®¾è®¡æ€è·¯è‰¯å¥½ä½†æœªå¯¹é½å½“å‰æ¶æ„
   * å½’æ¡£æ—¶é—´ï¼š2025-12-09
   * å½“å‰ç”Ÿæ•ˆå®ç°ï¼šroutes/v4/notifications.js
   */
  ```
- [ ] åˆ›å»º `routes/v4/_archived/README.md`ï¼š
  ```markdown
  # å½’æ¡£æ–‡ä»¶è¯´æ˜
  
  ## refactored-drafts/
  æœªå¯ç”¨çš„é‡æ„è‰æ¡ˆï¼Œä¿ç•™ä¾›å‚è€ƒ
  
  ## backups/
  å¤‡ä»½æ–‡ä»¶ï¼Œå·²è¢« .gitignore å¿½ç•¥
  ```
- [ ] æ›´æ–° `.gitignore`ï¼š
  ```
  # è·¯ç”±å¤‡ä»½æ–‡ä»¶
  routes/**/*.backup*
  routes/_archived/backups/
  ```

**éªŒæ”¶æ ‡å‡†**ï¼š

- `routes/v4/` ç›®å½•ä¸‹ä¸å†æœ‰ `*_refactored.js` å’Œ `.backup.*` æ–‡ä»¶
- å½’æ¡£ç›®å½•æœ‰æ¸…æ™°çš„ README
- è¿è¡Œç°æœ‰æµ‹è¯•å…¨éƒ¨é€šè¿‡

---

### é˜¶æ®µ 2ï¼šåº“å­˜æ¨¡å—é‡æ„ï¼ˆé¢„è®¡ 5-7 å¤©ï¼‰

**ç›®æ ‡ï¼šå°† inventory.js çš„ä¸šåŠ¡é€»è¾‘è¿ç§»åˆ° InventoryService**

#### 2.1 åˆ›å»º InventoryService éª¨æ¶ï¼ˆ1 å¤©ï¼‰

**è®¾è®¡å†³ç­–ï¼ˆåŸºäºçœŸå®ä¸šåŠ¡éœ€æ±‚ï¼‰**ï¼š

æ ¹æ® inventory.js çš„ 20 ä¸ªç«¯ç‚¹åˆ†æï¼ŒInventoryService éœ€è¦æ”¯æŒ 4 å¤§ä¸šåŠ¡æ¨¡å—ï¼š
1. **åº“å­˜æŸ¥è¯¢**ï¼šç”¨æˆ·åº“å­˜åˆ—è¡¨ã€ç‰©å“è¯¦æƒ…ã€ç»Ÿè®¡æ•°æ®
2. **ç‰©å“æ“ä½œ**ï¼šä½¿ç”¨ç‰©å“ã€è½¬è®©ç‰©å“ã€ç”Ÿæˆæ ¸é”€ç ã€æ ¸é”€éªŒè¯
3. **å…‘æ¢ç³»ç»Ÿ**ï¼šå•†å“å…‘æ¢ã€å…‘æ¢è®°å½•ã€å–æ¶ˆå…‘æ¢
4. **å¸‚åœºåŠŸèƒ½**ï¼šå¸‚åœºå•†å“ã€è´­ä¹°ã€æç°ã€ä¸Šæ¶

**å®ç”¨ä¸»ä¹‰åŸåˆ™**ï¼š
- âœ… **ç¬¬ä¸€é˜¶æ®µåªå®ç°æ ¸å¿ƒ 6 ä¸ªæ–¹æ³•**ï¼ˆè¦†ç›– 80% ä¸šåŠ¡ï¼‰
- âŒ ä¸å®ç°å¸‚åœºåŠŸèƒ½ï¼ˆå¯èƒ½éœ€è¦ç‹¬ç«‹ MarketServiceï¼‰
- âŒ ä¸å®ç°å…‘æ¢ç³»ç»Ÿï¼ˆå·²æœ‰ ExchangeMarketServiceï¼‰
- âœ… å‚è€ƒ PointsService çš„è®¾è®¡æ¨¡å¼ï¼ˆäº‹åŠ¡æ”¯æŒã€å¹‚ç­‰æ€§ã€é™æ€æ–¹æ³•ï¼‰

**ä»»åŠ¡æ¸…å•**ï¼š

- [ ] åˆ›å»º `services/InventoryService.js`
- [ ] å®ç°åŸºç¡€ç»“æ„ï¼ˆå‚è€ƒ PointsService å’Œ ExchangeMarketService çš„è®¾è®¡ï¼‰ï¼š

  ```javascript
/**
 * åº“å­˜ç®¡ç†æœåŠ¡
 * è´Ÿè´£ user_inventory å’Œ trade_records è¡¨çš„æ ¸å¿ƒä¸šåŠ¡æ“ä½œ
 * 
 * è®¾è®¡æ¨¡å¼ï¼šé™æ€æ–¹æ³•æœåŠ¡ç±»ï¼ˆä¸ PointsService ä¿æŒä¸€è‡´ï¼‰
 * äº‹åŠ¡æ”¯æŒï¼šæ‰€æœ‰å†™æ“ä½œæ”¯æŒå¤–éƒ¨äº‹åŠ¡ä¼ å…¥ï¼ˆoptions.transactionï¼‰
 * å¹‚ç­‰æ€§ï¼šå…³é”®æ“ä½œæ”¯æŒ business_id é˜²é‡å¤
 */
  class InventoryService {
  /**
   * è·å–ç”¨æˆ·åº“å­˜åˆ—è¡¨
   * @param {number} userId - ç”¨æˆ· ID
   * @param {Object} filters - è¿‡æ»¤æ¡ä»¶ {status, type, page, limit}
   * @param {Object} options - é€‰é¡¹ {viewerId, transaction}
   * @returns {Promise<Object>} {inventory, pagination}
   */
  static async getUserInventory(userId, filters = {}, options = {}) {
    // TODO: å®ç°
    // 1. æƒé™æ£€æŸ¥ï¼ˆæ™®é€šç”¨æˆ·åªèƒ½æŸ¥è‡ªå·±ï¼Œç®¡ç†å‘˜å¯æŸ¥æ‰€æœ‰ï¼‰
    // 2. æ„å»ºæŸ¥è¯¢æ¡ä»¶ï¼ˆstatus, typeï¼‰
    // 3. åˆ†é¡µæŸ¥è¯¢ï¼ˆlimit: 1-50ï¼Œé»˜è®¤ 20ï¼‰
    // 4. æ•°æ®å¤„ç†ï¼ˆstatus_description, is_expiredï¼‰
    // 5. æ•°æ®è„±æ•ï¼ˆæ ¹æ® viewerId æƒé™ï¼‰
    }
    
  /**
   * è·å–ç‰©å“è¯¦æƒ…
   * @param {number} viewerId - æŸ¥çœ‹è€… ID
   * @param {number} itemId - ç‰©å“ ID
   * @returns {Promise<Object>} ç‰©å“è¯¦æƒ…
   */
  static async getItemDetail(viewerId, itemId) {
      // TODO: å®ç°
    // 1. æƒé™æ£€æŸ¥ï¼ˆç®¡ç†å‘˜å¯æŸ¥æ‰€æœ‰ï¼Œæ™®é€šç”¨æˆ·åªèƒ½æŸ¥è‡ªå·±çš„ï¼‰
    // 2. æŸ¥è¯¢ç‰©å“ï¼ˆåŒ…å« user å…³è”ï¼‰
    // 3. å®¡è®¡æ—¥å¿—ï¼ˆç®¡ç†å‘˜æŸ¥çœ‹ä»–äººç‰©å“æ—¶è®°å½•ï¼‰
    // 4. æ•°æ®å¤„ç†ï¼ˆicon å­—æ®µã€çŠ¶æ€æè¿°ï¼‰
  }
  
  /**
   * ä½¿ç”¨ç‰©å“ï¼ˆæ ¸é”€ï¼‰
   * @param {number} actorId - æ“ä½œè€… ID
   * @param {number} itemId - ç‰©å“ ID
   * @param {Object} context - ä¸Šä¸‹æ–‡ä¿¡æ¯ {transaction, business_id}
   * @returns {Promise<Object>} ä½¿ç”¨ç»“æœ
   */
  static async useItem(actorId, itemId, context = {}) {
      // TODO: å®ç°
    // 1. æŸ¥è¯¢ç‰©å“ï¼ˆåŠ è¡Œçº§é” FOR UPDATEï¼‰
    // 2. æƒé™æ£€æŸ¥ï¼ˆç‰©å“æ‰€æœ‰è€…æˆ–ç®¡ç†å‘˜ï¼‰
    // 3. çŠ¶æ€æ£€æŸ¥ï¼ˆåªæœ‰ available çŠ¶æ€å¯ä½¿ç”¨ï¼‰
    // 4. æ›´æ–°çŠ¶æ€ï¼ˆstatus='used', used_at=NOW()ï¼‰
    // 5. è®°å½•æ“ä½œæ—¥å¿—
    // 6. å‘é€é€šçŸ¥ï¼ˆå¼‚æ­¥ï¼‰
  }
  
  /**
   * è½¬è®©ç‰©å“
   * @param {number} fromUserId - è½¬è®©æ–¹ ID
   * @param {number} toUserId - æ¥æ”¶æ–¹ ID
   * @param {number} itemId - ç‰©å“ ID
   * @param {Object} context - ä¸Šä¸‹æ–‡ä¿¡æ¯ {transaction, business_id}
   * @returns {Promise<Object>} è½¬è®©ç»“æœ
   */
  static async transferItem(fromUserId, toUserId, itemId, context = {}) {
      // TODO: å®ç°
    // 1. æŸ¥è¯¢ç‰©å“ï¼ˆåŠ è¡Œçº§é”ï¼‰
    // 2. çŠ¶æ€æ£€æŸ¥ï¼ˆåªæœ‰ available çŠ¶æ€å¯è½¬è®©ï¼‰
    // 3. æ£€æŸ¥æ¥æ”¶æ–¹æ˜¯å¦å­˜åœ¨
    // 4. æ›´æ–°ç‰©å“çŠ¶æ€ï¼ˆstatus='transferred', transfer_to_user_id, transfer_atï¼‰
    // 5. åˆ›å»ºäº¤æ˜“è®°å½•ï¼ˆTradeRecordï¼‰
    // 6. å‘é€é€šçŸ¥ï¼ˆå¼‚æ­¥ï¼‰
  }
  
  /**
   * ç”Ÿæˆæ ¸é”€ç 
   * @param {number} userId - ç”¨æˆ· ID
   * @param {number} itemId - ç‰©å“ ID
   * @param {Object} options - é€‰é¡¹ {transaction}
   * @returns {Promise<Object>} {verification_code, expires_at}
   */
  static async generateVerificationCode(userId, itemId, options = {}) {
      // TODO: å®ç°
    // 1. æŸ¥è¯¢ç‰©å“ï¼ˆéªŒè¯æ‰€æœ‰æƒï¼‰
    // 2. ç”Ÿæˆ 6 ä½æ•°å­—ç 
    // 3. è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆ5 åˆ†é’Ÿï¼‰
    // 4. æ›´æ–°ç‰©å“è®°å½•
    }
    
  /**
   * æ ¸é”€éªŒè¯
   * @param {number} merchantId - å•†å®¶ ID
   * @param {string} verificationCode - æ ¸é”€ç 
   * @param {Object} options - é€‰é¡¹ {transaction}
   * @returns {Promise<Object>} æ ¸é”€ç»“æœ
   */
  static async verifyCode(merchantId, verificationCode, options = {}) {
    // TODO: å®ç°
    // 1. æ ¹æ®æ ¸é”€ç æŸ¥è¯¢ç‰©å“
    // 2. éªŒè¯ç æœ‰æ•ˆæ€§æ£€æŸ¥ï¼ˆæœªè¿‡æœŸã€æœªä½¿ç”¨ï¼‰
    // 3. æ›´æ–°ç‰©å“çŠ¶æ€ï¼ˆstatus='used'ï¼‰
    // 4. è®°å½•æ ¸é”€æ—¥å¿—
  }
  
  // ==================== ç§æœ‰è¾…åŠ©æ–¹æ³• ====================
  
  /**
   * æƒé™æ£€æŸ¥
   * @private
   */
  static async _checkViewPermission(viewerId, targetUserId) {
    // å‚è€ƒ inventory.js ç¬¬ 60-71 è¡Œçš„å®ç°
  }
  
  /**
   * æ•°æ®å¤„ç†
   * @private
   */
  static _processInventoryData(inventory) {
    // å‚è€ƒ inventory.js ç¬¬ 139-150 è¡Œçš„å®ç°
  }
  
  /**
   * è·å–çŠ¶æ€æè¿°
   * @private
   */
  static _getStatusDescription(status) {
    const statusMap = {
      available: 'å¯ç”¨',
      used: 'å·²ä½¿ç”¨',
      expired: 'å·²è¿‡æœŸ',
      transferred: 'å·²è½¬è®©'
    }
    return statusMap[status] || 'æœªçŸ¥'
  }
  }
  
  module.exports = InventoryService
  ```

- [ ] åœ¨ `services/index.js` ä¸­æ³¨å†Œï¼š

  ```javascript
// services/index.js ç¬¬ 14 è¡Œæ›¿æ¢ä¸ºï¼š
const InventoryService = require('./InventoryService')

// ç¬¬ 148 è¡Œæ·»åŠ ï¼š
  this._services.set('inventory', new InventoryService(this.models))
  ```

**éªŒæ”¶æ ‡å‡†**ï¼š

- Service æ–‡ä»¶åˆ›å»ºæˆåŠŸ
- æ‰€æœ‰æ–¹æ³•æœ‰ JSDoc æ³¨é‡Š
- å¯é€šè¿‡ `serviceManager.getService('inventory')` è·å–

#### 2.2 è¿ç§» getUserInventory æ¥å£ï¼ˆ2-3 å¤©ï¼‰

**ä»»åŠ¡æ¸…å•**ï¼š

- [ ] **Step 1**ï¼šåœ¨ `InventoryService` ä¸­å®ç° `getUserInventory()` æ–¹æ³•
  - ä» `inventory.js` ç¬¬ 60-180 è¡Œæå–é€»è¾‘
  - åŒ…å«ï¼šæƒé™æ£€æŸ¥ã€æŸ¥è¯¢æ¡ä»¶æ„å»ºã€åˆ†é¡µã€æ•°æ®å¤„ç†ã€æ•°æ®è„±æ•

```javascript
// services/InventoryService.js
async getUserInventory(userId, filters = {}, options = {}) {
  const { status, type, page = 1, limit = 20 } = filters
  const { viewerId } = options
  
  // 1. æƒé™æ£€æŸ¥
  await this._checkViewPermission(viewerId, userId)
  
  // 2. æ„å»ºæŸ¥è¯¢æ¡ä»¶
  const whereConditions = { user_id: userId }
  if (status) whereConditions.status = status
  if (type) whereConditions.type = type
  
  // 3. åˆ†é¡µå‚æ•°
  const finalLimit = Math.min(Math.max(parseInt(limit) || 20, 1), 50)
  const offset = (page - 1) * finalLimit
  
  // 4. æŸ¥è¯¢æ•°æ®
  const { count, rows: inventory } = await this.UserInventory.findAndCountAll({
    where: whereConditions,
    attributes: [
      'inventory_id', 'name', 'description', 'icon', 'type', 'value',
      'status', 'source_type', 'source_id', 'acquired_at', 'expires_at',
      'used_at', 'verification_code', 'transfer_to_user_id', 'transfer_at',
      'created_at', 'updated_at'
    ],
    order: [['acquired_at', 'DESC']],
    limit: finalLimit,
    offset
  })
  
  // 5. æ•°æ®å¤„ç†
  const processedInventory = this._processInventoryData(inventory)
  
  // 6. æ•°æ®è„±æ•
  const dataLevel = await this._getDataLevel(viewerId)
  const sanitizedInventory = DataSanitizer.sanitizeInventory(processedInventory, dataLevel)
  
  return {
    inventory: sanitizedInventory,
    pagination: {
      total: count,
      page: parseInt(page),
      limit: finalLimit,
      total_pages: Math.ceil(count / finalLimit)
    }
  }
}

// ç§æœ‰æ–¹æ³•ï¼šæƒé™æ£€æŸ¥
async _checkViewPermission(viewerId, targetUserId) {
  if (viewerId === targetUserId) return true
  
  const userRoles = await getUserRoles(viewerId)
  if (!userRoles.isAdmin) {
    throw new Error('æ— æƒé™æŸ¥çœ‹å…¶ä»–ç”¨æˆ·åº“å­˜')
  }
  
  return true
}

// ç§æœ‰æ–¹æ³•ï¼šæ•°æ®å¤„ç†
_processInventoryData(inventory) {
  return inventory.map(item => {
    const itemData = item.toJSON()
    itemData.status_description = this._getStatusDescription(itemData.status)
    if (itemData.expires_at) {
      itemData.is_expired = new Date() > new Date(itemData.expires_at)
    }
    return itemData
  })
}

// ç§æœ‰æ–¹æ³•ï¼šè·å–çŠ¶æ€æè¿°
_getStatusDescription(status) {
  const statusMap = {
    available: 'å¯ç”¨',
    used: 'å·²ä½¿ç”¨',
    expired: 'å·²è¿‡æœŸ',
    transferred: 'å·²è½¬è®©'
  }
  return statusMap[status] || 'æœªçŸ¥'
}

// ç§æœ‰æ–¹æ³•ï¼šè·å–æ•°æ®çº§åˆ«
async _getDataLevel(viewerId) {
  const userRoles = await getUserRoles(viewerId)
  return userRoles.isAdmin ? 'full' : 'basic'
}
```

- [ ] **Step 2**ï¼šä¿®æ”¹è·¯ç”±æ–‡ä»¶ `inventory.js`

```javascript
// routes/v4/unified-engine/inventory.js
router.get('/user/:user_id', authenticateToken, async (req, res) => {
  try {
    const { user_id } = req.params
    const { status, type, page = 1, limit = 20 } = req.query
    
    // å‚æ•°éªŒè¯
    const requestedUserId = parseInt(user_id, 10)
    if (isNaN(requestedUserId) || requestedUserId <= 0) {
      return res.apiError('æ— æ•ˆçš„ç”¨æˆ·ID', 'BAD_REQUEST', null, 400)
    }
    
    // è°ƒç”¨ Service
    const inventoryService = req.app.locals.services.getService('inventory')
    const result = await inventoryService.getUserInventory(
      requestedUserId,
      { status, type, page, limit },
      { viewerId: req.user.user_id }
    )
    
    return res.apiSuccess(result, 'è·å–åº“å­˜åˆ—è¡¨æˆåŠŸ')
  } catch (error) {
    logger.error('è·å–ç”¨æˆ·åº“å­˜å¤±è´¥', { error: error.message, user_id: req.params.user_id })
    
    if (error.message.includes('æ— æƒé™')) {
      return res.apiError(error.message, 'FORBIDDEN', null, 403)
    }
    
    return res.apiError('è·å–åº“å­˜åˆ—è¡¨å¤±è´¥', 'INTERNAL_ERROR', null, 500)
  }
})
```

- [ ] **Step 3**ï¼šè¿è¡Œå›å½’æµ‹è¯•

```bash
npm test -- tests/integration/inventory-api.test.js
```

- [ ] **Step 4**ï¼šå¯¹æ¯”å“åº”æ ¼å¼ï¼Œç¡®ä¿å®Œå…¨ä¸€è‡´

**éªŒæ”¶æ ‡å‡†**ï¼š

- è·¯ç”±æ–‡ä»¶è¯¥æ¥å£è¡Œæ•°å‡å°‘ 50%+
- æ‰€æœ‰ä¸šåŠ¡é€»è¾‘åœ¨ Service ä¸­
- å›å½’æµ‹è¯•é€šè¿‡
- å“åº”æ ¼å¼ä¸ä¹‹å‰å®Œå…¨ä¸€è‡´

#### 2.3 è¿ç§» useItem å’Œ transferItem æ¥å£ï¼ˆ2-3 å¤©ï¼‰

**ä»»åŠ¡æ¸…å•**ï¼š

- [ ] **è¿ç§» useItem**ï¼šå®ç° `InventoryService.useItem()` æ–¹æ³•

```javascript
// services/InventoryService.js
async useItem(actorId, itemId, context = {}) {
  const transaction = await this.models.sequelize.transaction()
  
  try {
    // 1. æŸ¥è¯¢ç‰©å“ï¼ˆåŠ è¡Œçº§é”ï¼‰
    const item = await this.UserInventory.findOne({
      where: { inventory_id: itemId },
      lock: transaction.LOCK.UPDATE,
      transaction
    })
    
    if (!item) {
      throw new Error('ç‰©å“ä¸å­˜åœ¨')
    }
    
    // 2. æƒé™æ£€æŸ¥
    if (item.user_id !== actorId) {
      const userRoles = await getUserRoles(actorId)
      if (!userRoles.isAdmin) {
        throw new Error('æ— æƒé™æ“ä½œæ­¤ç‰©å“')
      }
    }
    
    // 3. çŠ¶æ€æ£€æŸ¥
    if (item.status !== 'available') {
      throw new Error(`ç‰©å“çŠ¶æ€ä¸º${item.status}ï¼Œæ— æ³•ä½¿ç”¨`)
    }
    
    // 4. æ›´æ–°çŠ¶æ€
    await item.update({
      status: 'used',
      used_at: new Date(),
      operator_id: actorId
    }, { transaction })
    
    // 5. è®°å½•æ“ä½œæ—¥å¿—
    await this._logOperation(actorId, 'use_item', itemId, context, transaction)
    
    // 6. æäº¤äº‹åŠ¡
    await transaction.commit()
    
    // 7. å‘é€é€šçŸ¥ï¼ˆå¼‚æ­¥ï¼Œä¸å½±å“ä¸»æµç¨‹ï¼‰
    this._sendNotification(item.user_id, 'item_used', { itemId, itemName: item.name })
      .catch(err => logger.error('å‘é€é€šçŸ¥å¤±è´¥', { error: err.message }))
    
    return {
      item_id: itemId,
      status: 'used',
      used_at: item.used_at
    }
  } catch (error) {
    await transaction.rollback()
    throw error
  }
}
```

- [ ] **è¿ç§» transferItem**ï¼šå®ç° `InventoryService.transferItem()` æ–¹æ³•

  ```javascript
// services/InventoryService.js
async transferItem(fromUserId, toUserId, itemId, context = {}) {
  const transaction = await this.models.sequelize.transaction()
  
  try {
    // 1. æŸ¥è¯¢ç‰©å“
    const item = await this.UserInventory.findOne({
      where: { inventory_id: itemId, user_id: fromUserId },
      lock: transaction.LOCK.UPDATE,
      transaction
    })
    
    if (!item) {
      throw new Error('ç‰©å“ä¸å­˜åœ¨æˆ–ä¸å±äºæ‚¨')
    }
    
    // 2. çŠ¶æ€æ£€æŸ¥
    if (item.status !== 'available') {
      throw new Error('åªæœ‰å¯ç”¨çŠ¶æ€çš„ç‰©å“æ‰èƒ½è½¬è®©')
    }
    
    // 3. æ£€æŸ¥æ¥æ”¶æ–¹æ˜¯å¦å­˜åœ¨
    const toUser = await this.User.findByPk(toUserId, { transaction })
    if (!toUser) {
      throw new Error('æ¥æ”¶æ–¹ç”¨æˆ·ä¸å­˜åœ¨')
    }
    
    // 4. æ›´æ–°ç‰©å“çŠ¶æ€
    await item.update({
      status: 'transferred',
      transfer_to_user_id: toUserId,
      transfer_at: new Date(),
      transfer_count: (item.transfer_count || 0) + 1,
      last_transfer_at: new Date(),
      last_transfer_from: fromUserId
    }, { transaction })
    
    // 5. åˆ›å»ºäº¤æ˜“è®°å½•
    await this.TradeRecord.create({
      from_user_id: fromUserId,
      to_user_id: toUserId,
      item_id: itemId,
      item_name: item.name,
      trade_type: 'transfer',
      trade_time: new Date()
    }, { transaction })
    
    // 6. æäº¤äº‹åŠ¡
    await transaction.commit()
    
    // 7. å‘é€é€šçŸ¥
    this._sendNotification(toUserId, 'item_received', { itemId, itemName: item.name, fromUserId })
      .catch(err => logger.error('å‘é€é€šçŸ¥å¤±è´¥', { error: err.message }))
    
    return {
      item_id: itemId,
      status: 'transferred',
      transfer_to_user_id: toUserId,
      transfer_at: item.transfer_at
    }
  } catch (error) {
    await transaction.rollback()
    throw error
  }
}
```

- [ ] ä¿®æ”¹è·¯ç”±æ–‡ä»¶å¯¹åº”æ¥å£
- [ ] è¿è¡Œå›å½’æµ‹è¯•

**éªŒæ”¶æ ‡å‡†**ï¼š

- æ‰€æœ‰å†™æ“ä½œä½¿ç”¨äº‹åŠ¡
- å¤±è´¥æ—¶æ­£ç¡®å›æ»š
- æ“ä½œæ—¥å¿—å®Œæ•´
- å›å½’æµ‹è¯•é€šè¿‡

#### 2.4 é¢„æœŸæ•ˆæœä¸å®é™…æŒ‘æˆ˜

**ç†æƒ³ç›®æ ‡**ï¼š
- `inventory.js` ä» **2933 è¡Œ** å‡å°‘åˆ° **< 800 è¡Œ**ï¼ˆå‡å°‘ 70%+ï¼‰
- ç›´æ¥æ“ä½œ models ä» **28 æ¬¡** å‡å°‘åˆ° **0 æ¬¡**ï¼ˆæ¶ˆé™¤ 100%ï¼‰

**å®é™…æƒ…å†µåˆ†æï¼ˆåŸºäº 20 ä¸ªç«¯ç‚¹ï¼‰**ï¼š

| ç«¯ç‚¹ç±»å‹ | æ•°é‡ | å½“å‰è¡Œæ•°ä¼°ç®— | é‡æ„åè¡Œæ•°ä¼°ç®— | å¤„ç†æ–¹æ¡ˆ |
|---------|------|------------|--------------|---------|
| æ ¸å¿ƒåº“å­˜ï¼ˆ6 ä¸ªï¼‰ | 6 | ~900 è¡Œ | ~300 è¡Œ | âœ… è¿ç§»åˆ° InventoryService |
| å…‘æ¢ç³»ç»Ÿï¼ˆ3 ä¸ªï¼‰ | 3 | ~600 è¡Œ | ~150 è¡Œ | ğŸŸ¡ è€ƒè™‘å¤ç”¨ ExchangeMarketService |
| å¸‚åœºåŠŸèƒ½ï¼ˆ5 ä¸ªï¼‰ | 5 | ~900 è¡Œ | ~250 è¡Œ | ğŸ”´ å¯èƒ½éœ€è¦ç‹¬ç«‹ MarketService |
| ç®¡ç†å‘˜æ¥å£ï¼ˆ4 ä¸ªï¼‰ | 4 | ~400 è¡Œ | ~200 è¡Œ | âœ… è¿ç§»åˆ° InventoryService |
| å…¶ä»–ï¼ˆ2 ä¸ªï¼‰ | 2 | ~133 è¡Œ | ~100 è¡Œ | âœ… ä¿æŒç®€å• |

**å®ç”¨ä¸»ä¹‰å»ºè®®**ï¼š

1. **ç¬¬ä¸€é˜¶æ®µé‡æ„ç›®æ ‡**ï¼ˆ2 å‘¨å†…å®Œæˆï¼‰ï¼š
   - åªè¿ç§»æ ¸å¿ƒ 6 ä¸ªåº“å­˜ç«¯ç‚¹åˆ° InventoryService
   - é¢„æœŸå‡å°‘ï¼š900 è¡Œ â†’ 300 è¡Œï¼ˆèŠ‚çœ 600 è¡Œï¼‰
   - inventory.js ä» 2933 è¡Œ â†’ 2333 è¡Œï¼ˆå‡å°‘ 20%ï¼‰

2. **ç¬¬äºŒé˜¶æ®µä¼˜åŒ–**ï¼ˆåç»­è¿­ä»£ï¼‰ï¼š
   - è¯„ä¼°æ˜¯å¦éœ€è¦åˆ›å»º MarketService
   - è¯„ä¼°å…‘æ¢ç³»ç»Ÿæ˜¯å¦å¤ç”¨ç°æœ‰ ExchangeMarketService
   - è¿›ä¸€æ­¥æ‹†åˆ†è·¯ç”±æ–‡ä»¶

3. **ä¸è¿‡åº¦è®¾è®¡**ï¼š
   - âŒ ä¸å¼ºæ±‚ä¸€æ¬¡æ€§å‡å°‘åˆ° 800 è¡Œ
   - âœ… ä¼˜å…ˆä¿è¯æ ¸å¿ƒåŠŸèƒ½ç¨³å®š
   - âœ… æ¸è¿›å¼é‡æ„ï¼Œæ¯æ¬¡éªŒè¯æ•ˆæœ

---

### é˜¶æ®µ 3ï¼šæ•´ç†å’Œä¼˜åŒ–ï¼ˆé¢„è®¡ 3-5 å¤©ï¼‰

**ç›®æ ‡ï¼šå®Œå–„ ServiceManagerï¼Œæ¸…ç†å‰©ä½™ç›´æ¥æ“ä½œ models çš„åœ°æ–¹**

#### 3.1 æ‰©å±• ServiceManagerï¼ˆ1 å¤©ï¼‰

**ä»»åŠ¡æ¸…å•**ï¼š

- [ ] åœ¨ `services/index.js` ä¸­æ³¨å†Œæ‰€æœ‰é¢†åŸŸ Serviceï¼š

```javascript
// services/index.js ç¬¬ 140-156 è¡Œ
async initialize() {
  if (this._initialized) {
    return
  }

  try {
    console.log('ğŸš€ åˆå§‹åŒ–V4æœåŠ¡ç®¡ç†å™¨...')

    // âœ… æ³¨å†Œæ‰€æœ‰é¢†åŸŸ Service
    this._services.set('unifiedLotteryEngine', new UnifiedLotteryEngine(this.models))
    this._services.set('thumbnail', new ThumbnailService(this.models))
    this._services.set('lotteryContainer', lottery_service_container)
    
    // âœ… æ–°å¢ï¼šæ³¨å†Œé¢†åŸŸ Service
  this._services.set('points', new PointsService(this.models))
  this._services.set('inventory', new InventoryService(this.models))
  this._services.set('exchangeMarket', new ExchangeMarketService(this.models))
    this._services.set('exchangeOperation', new ExchangeOperationService(this.models))
    this._services.set('contentAudit', new ContentAuditEngine(this.models))
  this._services.set('announcement', new AnnouncementService(this.models))
  this._services.set('notification', new NotificationService(this.models))
    this._services.set('consumption', new ConsumptionService(this.models))
    this._services.set('customerServiceSession', new CustomerServiceSessionService(this.models))
    this._services.set('hierarchyManagement', new HierarchyManagementService(this.models))
    this._services.set('userRole', new UserRoleService(this.models))

    this._initialized = true
    console.log('âœ… V4æœåŠ¡ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ')
    console.log(`ğŸ“Š å·²æ³¨å†ŒæœåŠ¡: ${Array.from(this._services.keys()).join(', ')}`)
  } catch (error) {
    console.error('âŒ æœåŠ¡ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error)
    throw error
  }
}
```

- [ ] ä¿®æ”¹è·¯ç”±æ–‡ä»¶ï¼Œç»Ÿä¸€é€šè¿‡ `req.app.locals.services.getService('xxx')` è·å– Service
- [ ] ç§»é™¤è·¯ç”±æ–‡ä»¶ä¸­çš„ `require('../../../services/XXXService')`

**éªŒæ”¶æ ‡å‡†**ï¼š

- æ‰€æœ‰ Service é€šè¿‡ ServiceManager ç®¡ç†
- è·¯ç”±æ–‡ä»¶ä¸å†ç›´æ¥ require Service
- ä¾¿äºåç»­ä¾èµ–æ³¨å…¥å’Œæµ‹è¯•

#### 3.2 æ¸…ç† points.js ä¸­çš„ç›´æ¥ models æ“ä½œï¼ˆ1-2 å¤©ï¼‰

**ä»»åŠ¡æ¸…å•**ï¼š

- [ ] ä½¿ç”¨ grep æŸ¥æ‰¾ `points.js` ä¸­å‰©ä½™çš„ç›´æ¥ models æ“ä½œï¼š
```bash
  grep -n "models\." routes/v4/unified-engine/points.js
  ```
- [ ] å°†å‘ç°çš„ 3 å¤„ç›´æ¥æ“ä½œæ”¹ä¸ºè°ƒç”¨ `PointsService` å¯¹åº”æ–¹æ³•
- [ ] å¦‚æœ `PointsService` ç¼ºå°‘å¯¹åº”æ–¹æ³•ï¼Œè¡¥å……å®ç°
- [ ] è¿è¡Œå›å½’æµ‹è¯•

**éªŒæ”¶æ ‡å‡†**ï¼š

- `points.js` ä¸å†ç›´æ¥æ“ä½œ models
- æ‰€æœ‰ç§¯åˆ†ç›¸å…³æ“ä½œé€šè¿‡ `PointsService`
- å›å½’æµ‹è¯•é€šè¿‡

#### 3.3 ~~ç»Ÿä¸€é”™è¯¯å¤„ç†~~ï¼ˆå·²å–æ¶ˆï¼‰

**å–æ¶ˆåŸå› **ï¼š

âŒ **ä¸ç¬¦åˆç°æœ‰æŠ€æœ¯è·¯çº¿**ï¼š
- ç°æœ‰ä»£ç ï¼ˆPointsServiceã€ExchangeMarketServiceã€inventory.jsï¼‰éƒ½ç›´æ¥ throw Error
- æ²¡æœ‰ä½¿ç”¨è‡ªå®šä¹‰é”™è¯¯ç±»
- Controller å±‚é€šè¿‡ error.message åˆ¤æ–­é”™è¯¯ç±»å‹

âœ… **ä¿æŒç°æœ‰æ¨¡å¼**ï¼š

```javascript
// Service å±‚ï¼ˆä¸ PointsService ä¿æŒä¸€è‡´ï¼‰
static async useItem(actorId, itemId, context = {}) {
  if (item.status !== 'available') {
    throw new Error(`ç‰©å“çŠ¶æ€ä¸º${item.status}ï¼Œæ— æ³•ä½¿ç”¨`)
    }
  }

// Controller å±‚ï¼ˆä¸ inventory.js ä¿æŒä¸€è‡´ï¼‰
catch (error) {
  logger.error('ä½¿ç”¨ç‰©å“å¤±è´¥', { error: error.message, item_id })
  
  if (error.message.includes('æ— æƒé™')) {
    return res.apiError(error.message, 'FORBIDDEN', null, 403)
  } else if (error.message.includes('çŠ¶æ€')) {
    return res.apiError(error.message, 'BAD_REQUEST', null, 400)
    } else {
    return res.apiError('ä½¿ç”¨ç‰©å“å¤±è´¥', 'INTERNAL_ERROR', null, 500)
  }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… ä¸ç°æœ‰ä»£ç é£æ ¼ä¸€è‡´
- âœ… ä¸å¼•å…¥æ–°çš„ä¾èµ–å’Œæ¦‚å¿µ
- âœ… ç®€å•ç›´æ¥ï¼Œæ˜“äºç†è§£

---

## å››ã€å®æ–½æ£€æŸ¥æ¸…å•

### 4.1 æ¯æ¬¡æäº¤å‰æ£€æŸ¥

- [ ] è·¯ç”±æ–‡ä»¶æ˜¯å¦åªåš 4 ä»¶äº‹ï¼ˆé‰´æƒã€å‚æ•°è§£æã€è°ƒç”¨ Serviceã€ç»Ÿä¸€å“åº”ï¼‰
- [ ] æ˜¯å¦æœ‰ç›´æ¥æ“ä½œ Model çš„ä»£ç ï¼ˆ`models.XXX.findAll()` / `update()`ï¼‰
- [ ] Service æ–¹æ³•æ˜¯å¦æœ‰å®Œæ•´çš„ JSDoc æ³¨é‡Š
- [ ] æ˜¯å¦æœ‰é€‚å½“çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- [ ] æ˜¯å¦æœ‰å•å…ƒæµ‹è¯•æˆ–é›†æˆæµ‹è¯•è¦†ç›–

### 4.2 ä»£ç å®¡æŸ¥è¦ç‚¹

- [ ] ä¸šåŠ¡é€»è¾‘æ˜¯å¦åœ¨ Service å±‚
- [ ] è·¨é¢†åŸŸæ“ä½œæ˜¯å¦é€šè¿‡å¯¹åº” Service
- [ ] äº‹åŠ¡å¤„ç†æ˜¯å¦æ­£ç¡®ï¼ˆæœ‰ commit å’Œ rollbackï¼‰
- [ ] æ•æ„Ÿæ“ä½œæ˜¯å¦è®°å½•å®¡è®¡æ—¥å¿—
- [ ] å“åº”æ ¼å¼æ˜¯å¦ç¬¦åˆè§„èŒƒ

### 4.3 åŠŸèƒ½éªŒè¯æ£€æŸ¥

**æ¯ä¸ªæ¥å£é‡æ„åéªŒè¯**ï¼š

- [ ] è¿è¡Œå›å½’æµ‹è¯•ï¼Œç¡®ä¿å“åº”æ ¼å¼ä¸€è‡´
- [ ] æ‰‹åŠ¨æµ‹è¯•æ­£å¸¸æµç¨‹
- [ ] æ‰‹åŠ¨æµ‹è¯•å¼‚å¸¸æµç¨‹ï¼ˆæƒé™ä¸è¶³ã€å‚æ•°é”™è¯¯ç­‰ï¼‰
- [ ] æ£€æŸ¥æ•°æ®åº“æ•°æ®æ˜¯å¦æ­£ç¡®
- [ ] æ£€æŸ¥æ—¥å¿—æ˜¯å¦å®Œæ•´

**æ€§èƒ½éªŒè¯**ï¼š

- [ ] å“åº”æ—¶é—´æ˜¯å¦åœ¨å¯æ¥å—èŒƒå›´ï¼ˆ< 500msï¼‰
- [ ] æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°æ˜¯å¦åˆç†ï¼ˆé¿å… N+1 é—®é¢˜ï¼‰
- [ ] æ˜¯å¦æœ‰ä¸å¿…è¦çš„å…¨è¡¨æ‰«æ

---

## äº”ã€é£é™©æ§åˆ¶ä¸å›æ»šç­–ç•¥

### 5.1 é£é™©ç­‰çº§è¯„ä¼°

| æ“ä½œç±»å‹ | é£é™©ç­‰çº§ | é£é™©æè¿° | æ§åˆ¶æªæ–½ |
|---------|---------|---------|---------|
| æ¸…ç†æœªæŒ‚è½½æ–‡ä»¶ | æä½ | ä¸å½±å“è¿è¡Œä»£ç  | ç§»åŠ¨å‰å†æ¬¡ç¡®è®¤æœªè¢«å¼•ç”¨ |
| è¿ç§»æŸ¥è¯¢æ¥å£ | ä½ | åªè¯»æ“ä½œï¼Œä¸æ”¹æ•°æ® | å¯¹æ¯”å“åº”æ ¼å¼ï¼Œå›å½’æµ‹è¯• |
| è¿ç§»å†™æ“ä½œæ¥å£ | ä¸­ | å¯èƒ½å½±å“æ•°æ®ä¸€è‡´æ€§ | å°æ­¥æ¨è¿›ï¼Œå……åˆ†æµ‹è¯•ï¼Œäº‹åŠ¡ä¿æŠ¤ |

### 5.2 å›æ»šç­–ç•¥

**Git åˆ†æ”¯ç­–ç•¥**ï¼š

```
main (ç”Ÿäº§åˆ†æ”¯)
  â†“
develop (å¼€å‘åˆ†æ”¯)
  â†“
feature/refactor-inventory (é‡æ„åˆ†æ”¯)
```

**å›æ»šæ­¥éª¤**ï¼š

1. **å‘ç°é—®é¢˜**ï¼šç›‘æ§å‘Šè­¦æˆ–ç”¨æˆ·åé¦ˆ
2. **è¯„ä¼°å½±å“**ï¼šç¡®å®šå½±å“èŒƒå›´å’Œä¸¥é‡ç¨‹åº¦
3. **å†³ç­–å›æ»š**ï¼š
   - è½»å¾®é—®é¢˜ï¼šçƒ­ä¿®å¤ï¼ˆhotfixï¼‰
   - ä¸¥é‡é—®é¢˜ï¼šå›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬
4. **æ‰§è¡Œå›æ»š**ï¼š
   ```bash
   # å›æ»šåˆ°ä¸Šä¸€ä¸ªæäº¤
   git revert <commit-hash>
   
   # æˆ–å›æ»šæ•´ä¸ªåˆ†æ”¯
   git reset --hard <stable-commit-hash>
   ```
5. **éªŒè¯æ¢å¤**ï¼šè¿è¡Œå›å½’æµ‹è¯•ï¼Œç¡®è®¤åŠŸèƒ½æ­£å¸¸

---

## å…­ã€å…¨å±€é—®é¢˜ç›˜ç‚¹ä¸åç»­é˜¶æ®µè§„åˆ’

> æœ¬ç« èŠ‚çš„ç›®æ ‡ï¼šåœ¨ä¿æŒæœ¬æ–¹æ¡ˆâ€œå…ˆè§£å†³åº“å­˜/ç§¯åˆ†ä¸»é“¾è·¯â€çš„å‰æä¸‹ï¼Œç»™å‡º**å…¨é¡¹ç›®è§†è§’**çš„é—®é¢˜æ¸…å•ä¸åç»­è·¯çº¿å›¾ï¼Œé¿å…â€œåªæ”¶æ‹¾ä¸€å—ã€æ•´ä½“ä»ç„¶æ··ä¹±â€ã€‚

### 6.1 å…¨å±€é—®é¢˜ç›˜ç‚¹ï¼ˆæŒ‰é¢†åŸŸä¸æŠ€æœ¯ç»´åº¦ï¼‰

**ä»ç°æœ‰ä»£ç å’Œç›®å½•ç»“æ„æŠ½è±¡å‡ºçš„å…¨å±€é—®é¢˜ï¼Œå¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼šé¢†åŸŸç»´åº¦ + æŠ€æœ¯ç»´åº¦ã€‚**

- **é¢†åŸŸç»´åº¦é—®é¢˜ï¼ˆæŒ‰ä¸šåŠ¡æ¨¡å—åˆ’åˆ†ï¼‰**
  - **åº“å­˜ / å…‘æ¢ / å¸‚åœºé“¾è·¯**
    - `inventory.js` è¿‡èƒ–ï¼ˆæœ¬æ–¹æ¡ˆå·²è¦†ç›–ç¬¬ä¸€é˜¶æ®µï¼‰
    - å¸‚åœºåŠŸèƒ½æ˜¯å¦åº”è¯¥ç‹¬ç«‹ä¸º `MarketService`ï¼ˆå°šæœªå†³ç­–ï¼‰
    - å…‘æ¢ç›¸å…³é€»è¾‘åœ¨ `inventory.js` ä¸ `ExchangeMarketService` ä¹‹é—´è¾¹ç•Œæ¨¡ç³Š
  - **ç§¯åˆ†é“¾è·¯**
    - `points.js` ä»æœ‰ç›´æ¥æ“ä½œ `models` çš„é€»è¾‘ï¼ˆæœ¬æ–¹æ¡ˆé˜¶æ®µ 3 è®¡åˆ’æ¸…ç†ï¼‰
    - ç§¯åˆ†ä¸åº“å­˜/å…‘æ¢ä¹‹é—´çš„è·¨é¢†åŸŸè°ƒç”¨ï¼Œç¼ºå°‘ç»Ÿä¸€è§„åˆ™ï¼ˆè°å¯ä»¥ç›´æ¥æ”¹è°ï¼‰
  - **é€šçŸ¥ / å…¬å‘Šæ¨¡å—**
    - å­˜åœ¨å¤šä¸ª `*_refactored.js` è‰æ¡ˆï¼Œä¸ç°æœ‰ `AnnouncementService` / `NotificationService` é£æ ¼ä¸ä¸€
    - è·¯ç”±æ˜¯å¦è¶³å¤Ÿâ€œè–„â€ã€æ˜¯å¦éƒ½é€šè¿‡ Service è°ƒç”¨ï¼Œå°šæœªç³»ç»Ÿæ¢³ç†
  - **å®¢æœ / èŠå¤© / å®¡æ ¸é“¾è·¯**
    - ç°æœ‰ `CustomerServiceSessionService` / `ContentAuditEngine` è®¾è®¡æ€»ä½“åˆç†ï¼Œä½†ï¼š
      - è·¯ç”±å±‚æ˜¯å¦å®Œå…¨åšåˆ°ä¸ç›´æ¥æ“ä½œ `models` ä»éœ€æ£€æŸ¥
      - å®¡æ ¸ç»“æœæ˜¯å¦åœ¨å„ä¸šåŠ¡æ¨¡å—ä¸­ç»Ÿä¸€é€šè¿‡ Service è°ƒç”¨è¿˜æœªå½¢æˆè§„èŒƒ

- **æŠ€æœ¯ç»´åº¦é—®é¢˜ï¼ˆè·¨é¢†åŸŸçš„é€šç”¨é—®é¢˜ï¼‰**
  - **åˆ†å±‚ä¸€è‡´æ€§**
    - éƒ¨åˆ†è·¯ç”±å·²ç»æ˜¯â€œè–„ Controller + Serviceâ€ï¼Œéƒ¨åˆ†ä»æ˜¯â€œèƒ–è·¯ç”±ç›´è¿ modelsâ€
    - Service æœ‰é™æ€ç±»ã€å®ä¾‹åŒ–ç±»ã€å·¥å…·å‡½æ•°å‹å¤šç§é£æ ¼å¹¶å­˜
  - **äº‹åŠ¡ä¸æ•°æ®ä¸€è‡´æ€§**
    - `PointsService` æœ‰ç›¸å¯¹å®Œå–„çš„äº‹åŠ¡/å¹‚ç­‰æ¨¡å¼
    - å…¶ä»–å†™æ“ä½œï¼ˆåº“å­˜ã€å¸‚åœºã€éƒ¨åˆ†ç®¡ç†æ“ä½œï¼‰å­˜åœ¨â€œæœ‰äº‹åŠ¡ / æ— äº‹åŠ¡ / æ··ç”¨â€ç°è±¡
  - **é”™è¯¯å¤„ç†ä¸æ—¥å¿—**
    - å½“å‰ä»¥ `throw Error + Controller åˆ†ç±»å¤„ç†` ä¸ºä¸»ï¼Œä½†å®ç°ä¸å®Œå…¨ç»Ÿä¸€
    - æ—¥å¿—å­—æ®µä¸ç»Ÿä¸€ï¼ˆæœ‰çš„åªæ‰“ messageï¼Œæœ‰çš„å¸¦ user_id / item_idï¼‰
  - **æµ‹è¯•ä¸å›å½’ä¿æŠ¤**
    - æŠ½å¥–ã€éƒ¨åˆ† Service å·²æœ‰ä¸€å®šæµ‹è¯•åŸºç¡€
    - V4 ç»Ÿä¸€å¼•æ“ä¸‹çš„åº“å­˜/ç§¯åˆ†/é€šçŸ¥ç­‰è·¯ç”±ï¼Œæµ‹è¯•è¦†ç›–ä¸¥é‡ä¸è¶³

> æ€»ç»“ï¼š**æœ¬æ–¹æ¡ˆå½“å‰èšç„¦åœ¨â€œåº“å­˜/ç§¯åˆ†ä¸»é“¾è·¯ + ServiceManager + è·¯ç”±ç›®å½•å«ç”Ÿâ€ï¼Œåªæ˜¯æ•´ä¸ªé—®é¢˜ç©ºé—´çš„ä¸€éƒ¨åˆ†ï¼Œä½†è¿™éƒ¨åˆ†æ˜¯é«˜ä»·å€¼ P0/P1 åŒºåŸŸã€‚**

### 6.2 å¤šé˜¶æ®µæ•´ä½“è·¯çº¿å›¾ï¼ˆä» V4 æ ¸å¿ƒåˆ°å…¨é¡¹ç›®ï¼‰

åœ¨ä¸æ¨ç¿»ç°æœ‰æŠ€æœ¯è·¯çº¿çš„å‰æä¸‹ï¼Œå»ºè®®é‡‡ç”¨**â€œä» V4 ç»Ÿä¸€å¼•æ“å‘å¤–æ‰©æ•£â€**çš„æ–¹å¼åšå…¨é¡¹ç›®æ¼”è¿›ï¼š

#### é˜¶æ®µ G1ï¼šV4 æ ¸å¿ƒé“¾è·¯ç¨³å®šåŒ–ï¼ˆå½“å‰æ–‡æ¡£ = G1.1ï¼‰ã€1â€“2 å‘¨ã€‘

- **G1.1 åº“å­˜ / ç§¯åˆ†ä¸»é“¾è·¯**
  - å†…å®¹ï¼šæœ¬æ–‡ä»¶å·²è¯¦ç»†è§„åˆ’çš„ **inventory.js + InventoryService + PointsService æ¸…ç†**
  - ç›®æ ‡ï¼š
    - `inventory.js` è¡Œæ•°é™ä½ 20â€“35%
    - å…³é”®å†™æ“ä½œï¼ˆuse / transferï¼‰éƒ½æœ‰äº‹åŠ¡å’Œå›å½’æµ‹è¯•ä¿æŠ¤
    - `points.js` ä¸å†ç›´æ¥æ“ä½œ `models`
- **G1.2 ServiceManager ç»Ÿä¸€åŒ–**
  - å†…å®¹ï¼šè¡¥é½ `services/index.js` ä¸­æ‰€æœ‰é¢†åŸŸ Service çš„æ³¨å†Œ
  - ç›®æ ‡ï¼š
    - æ‰€æœ‰è·¯ç”±åªé€šè¿‡ `req.app.locals.services.getService('xxx')` è·å– Service
    - å½»åº•ç§»é™¤â€œè·¯ç”±ç›´æ¥ `require('./XXXService')`â€çš„æ¨¡å¼

#### é˜¶æ®µ G2ï¼šå‘¨è¾¹é«˜é¢‘æ¨¡å—æ”¶æ•›ï¼ˆé€šçŸ¥ / å…¬å‘Š / å®¡æ ¸ / å®¢æœï¼‰ã€2â€“3 å‘¨ã€‘

- **G2.1 é€šçŸ¥ / å…¬å‘Šæ¨¡å—é‡æ„**
  - è¾“å…¥ï¼š
    - ç°æœ‰ `AnnouncementService` / `NotificationService`
    - `_archived/refactored-drafts` ä¸­çš„è‰æ¡ˆæ–‡ä»¶ï¼ˆåªä½œä¸ºæ€è·¯å‚è€ƒï¼‰
  - è¾“å‡ºï¼š
    - é€šçŸ¥/å…¬å‘Šç›¸å…³è·¯ç”±ç»Ÿä¸€ä¸ºâ€œè–„ Controller + Serviceâ€
    - æ˜ç¡®ï¼šå“ªäº›åœºæ™¯è§¦å‘é€šçŸ¥ï¼ˆåº“å­˜å˜æ›´ã€ç§¯åˆ†å˜æ›´ã€å…‘æ¢æˆåŠŸ/å¤±è´¥ç­‰ï¼‰ï¼Œç»Ÿä¸€ä»é¢†åŸŸ Service è§¦å‘

- **G2.2 å®¡æ ¸ / å®¢æœé“¾è·¯æ¢³ç†**
  - å†…å®¹ï¼š
    - å¤æŸ¥ `CustomerServiceSessionService` / `ContentAuditEngine` çš„è·¯ç”±ä½¿ç”¨æƒ…å†µ
    - æ¸…ç†å¯èƒ½å­˜åœ¨çš„ç›´è¿ `models` è¡Œä¸º
  - ç›®æ ‡ï¼š
    - æ‰€æœ‰â€œæ¶‰åŠé‡è¦çŠ¶æ€å˜æ›´ï¼ˆå®¡æ ¸é€šè¿‡/æ‹’ç»ã€å®¢æœæ ‡è®°ç­‰ï¼‰â€éƒ½é€šè¿‡å¯¹åº” Service å®Œæˆ
    - ä¸ºåç»­é£æ§ / å®¡è®¡éœ€æ±‚æ‰“åŸºç¡€

#### é˜¶æ®µ G3ï¼šæ¨ªå‘æŠ€æœ¯è§„èŒƒè½åœ°ï¼ˆè·¨å…¨éƒ¨æ¨¡å—ï¼‰ã€æŒç»­æ¼”è¿›ã€‘

- **G3.1 åˆ†å±‚ä¸ä¾èµ–è¾¹ç•Œç»Ÿä¸€**
  - ç›®æ ‡ï¼šå…¨é¡¹ç›®éµå¾ªæœ¬æ–‡ä»¶ 2.2/2.3 ä¸­çš„åˆ†å±‚ä¸é¢†åŸŸè¾¹ç•Œè§„åˆ™ï¼š
    - Controller ä¸ç›´æ¥æ“ä½œä»»ä½• `models`
    - Service ä¸èƒ½è·¨é¢†åŸŸç›´æ¥åŠ¨åˆ«äººçš„è¡¨ï¼Œå¿…é¡»é€šè¿‡å¯¹æ–¹ Service

- **G3.2 äº‹åŠ¡ / å¹‚ç­‰ / æ—¥å¿—æ¨¡å¼æ ‡å‡†åŒ–**
  - å‚ç…§å¯¹è±¡ï¼š`PointsService` + æœ¬æ–‡ä»¶å¯¹ `InventoryService` çš„è®¾è®¡è¦æ±‚
  - ç›®æ ‡ï¼š
    - æ‰€æœ‰â€œå†™æ“ä½œâ€å‹ Service éƒ½æ”¯æŒï¼š
      - å¤–éƒ¨äº‹åŠ¡ä¼ å…¥
      - ä¸šåŠ¡ ID çº§å¹‚ç­‰ï¼ˆbusiness_idï¼‰
      - æ ‡å‡†åŒ–æ“ä½œæ—¥å¿—å­—æ®µï¼ˆwho / what / when / contextï¼‰

- **G3.3 æœ€å°å¿…è¦æµ‹è¯•çŸ©é˜µ**
  - æ¯ä¸ªé¢†åŸŸé€‰å‡º 2â€“3 ä¸ªâ€œæ ¸å¿ƒæ¥å£â€ï¼Œè¡¥è¶³æœ€å°é›†æˆæµ‹è¯•ï¼š
    - æ­£å¸¸æµç¨‹
    - æƒé™ä¸è¶³
    - éæ³•å‚æ•° / å¼‚å¸¸è·¯å¾„

### 6.3 ä¼˜å…ˆçº§ä¸èŠ‚å¥å»ºè®®ï¼ˆé¿å…â€œå…¨ç›˜æ¨å€’â€ï¼‰

**æ•´ä½“åŸåˆ™ï¼šå…ˆè§£å†³é«˜é¢‘ + é«˜é£é™©é“¾è·¯ï¼Œé€æ­¥æ‰©æ•£ï¼Œä¸æâ€œå¤§é‡æ„ä¸€é”®å®Œæˆâ€ã€‚**

- **ç¬¬ä¸€æ³¢ï¼ˆå½“å‰å³å¯æ‰§è¡Œï¼‰**
  - æŒ‰æœ¬æ–‡ä»¶æ—¢æœ‰å†…å®¹æ¨è¿›ï¼š`inventory.js` / `InventoryService` / `points.js` / `services/index.js`
  - è¾“å‡ºï¼šä¸€æ¡â€œä» Controller åˆ° Service åˆ° models çš„å®Œæ•´æ ·æ¿é“¾è·¯â€

- **ç¬¬äºŒæ³¢ï¼ˆé€šçŸ¥ / å…¬å‘Š + å®¡æ ¸ / å®¢æœï¼‰**
  - åœ¨ä¸æ”¹å˜å¯¹å¤–è¡Œä¸ºçš„å‰æä¸‹ï¼Œåªåšâ€œç˜¦è·¯ç”± + Service æ”¶å£â€
  - æŠŠæœªæŒ‚è½½çš„ `*_refactored.js` è‰æ¡ˆï¼Œæ‹†æˆå¯ä»¥å¤ç”¨çš„å±€éƒ¨å®ç°ï¼ˆæ¯”å¦‚å‚æ•°æ ¡éªŒã€åˆ†é¡µæ¨¡å¼ï¼‰ï¼ŒæŒ‰ç»Ÿä¸€è§„èŒƒæ¥å…¥

- **ç¬¬ä¸‰æ³¢ï¼ˆæŠ€æœ¯è§„èŒƒæ¨ªæ‰«ï¼‰**
  - ç”¨ grep / è„šæœ¬æ‰«æï¼š
    - `routes/**/*.js` ä¸­çš„ `models.` ä½¿ç”¨æƒ…å†µ
    - `services/**/*.js` ä¸­çš„äº‹åŠ¡å†™æ³•
  - æŒ‰æ¨¡å—é€ä¸ªæ¢³ç†ï¼Œå¤ç”¨æœ¬æ–‡ä»¶å®šä¹‰çš„æ¨¡å¼

> ç›®æ ‡çŠ¶æ€ï¼šæœ¬æ–¹æ¡ˆä¸å†åªæ˜¯â€œinventory.js é‡æ„æ–‡æ¡£â€ï¼Œè€Œæ˜¯**V4 ç»Ÿä¸€å¼•æ“åç«¯çš„åˆ†å±‚æ ·æ¿ + å…¨é¡¹ç›®æ¼”è¿›è·¯çº¿å›¾çš„â€œæ¯æ–‡æ¡£â€**ã€‚

---

## é™„å½• Aï¼šé‡æ„å‰åå¯¹æ¯”

### A.1 inventory.js é‡æ„å¯¹æ¯”

**é‡æ„å‰ï¼ˆèƒ–è·¯ç”±ï¼‰**ï¼š

```javascript
// routes/v4/unified-engine/inventory.jsï¼ˆéƒ¨åˆ†ä»£ç ï¼‰
router.get('/user/:user_id', authenticateToken, async (req, res) => {
  try {
    const { user_id } = req.params
    const { status, type, page = 1, limit = 20 } = req.query
    
    // âŒ æƒé™æ£€æŸ¥é€»è¾‘åœ¨ Controller
    const userRoles = await getUserRoles(req.user.user_id)
    if (requestedUserId !== req.user.user_id && !userRoles.isAdmin) {
      return res.apiError('æ— æƒé™', 'FORBIDDEN', null, 403)
    }
    
    // âŒ æ„å»ºæŸ¥è¯¢æ¡ä»¶åœ¨ Controller
    const whereConditions = { user_id }
    if (status) whereConditions.status = status
    if (type) whereConditions.type = type
    
    // âŒ ç›´æ¥æ“ä½œ Model
    const { count, rows } = await models.UserInventory.findAndCountAll({
      where: whereConditions,
      order: [['acquired_at', 'DESC']],
      limit: finalLimit,
      offset
    })
    
    // âŒ ä¸šåŠ¡é€»è¾‘åœ¨ Controller
    const processed = rows.map(item => {
      const data = item.toJSON()
      data.status_description = getStatusDescription(data.status)
      return data
    })
    
    // âŒ æ•°æ®è„±æ•åœ¨ Controller
    const sanitized = DataSanitizer.sanitize(processed, dataLevel)
    
    return res.apiSuccess({ inventory: sanitized, ... })
  } catch (error) {
    // é”™è¯¯å¤„ç†...
  }
})
```

**é‡æ„åï¼ˆè–„è·¯ç”±ï¼‰**ï¼š

```javascript
// routes/v4/unified-engine/inventory.jsï¼ˆé‡æ„åï¼‰
router.get('/user/:user_id', authenticateToken, async (req, res) => {
  try {
    const { user_id } = req.params
    const { status, type, page = 1, limit = 20 } = req.query
    
    // âœ… å‚æ•°éªŒè¯
    const userId = parseInt(user_id, 10)
    if (isNaN(userId) || userId <= 0) {
      return res.apiError('æ— æ•ˆçš„ç”¨æˆ·ID', 'BAD_REQUEST', null, 400)
    }
    
    // âœ… è°ƒç”¨ Service
    const inventoryService = req.app.locals.services.getService('inventory')
    const result = await inventoryService.getUserInventory(
      userId,
      { status, type, page, limit },
      { viewerId: req.user.user_id }
    )
    
    // âœ… ç»Ÿä¸€å“åº”
    return res.apiSuccess(result, 'è·å–åº“å­˜åˆ—è¡¨æˆåŠŸ')
  } catch (error) {
    // âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†
    if (error instanceof BusinessError) {
      return res.apiError(error.message, error.code, null, error.statusCode)
    }
    return res.apiError('è·å–åº“å­˜å¤±è´¥', 'INTERNAL_ERROR', null, 500)
  }
})
```

### A.2 å¸¸è§é—®é¢˜ FAQ

**Q1ï¼šä¸ºä»€ä¹ˆè¦åšè¿™æ¬¡é‡æ„ï¼Ÿ**

Aï¼šå½“å‰ `inventory.js` æœ‰ 2933 è¡Œï¼Œç›´æ¥æ“ä½œ models 28 æ¬¡ï¼Œä¸šåŠ¡é€»è¾‘ä¸ HTTP å±‚è€¦åˆï¼Œéš¾ä»¥æµ‹è¯•å’Œç»´æŠ¤ã€‚é‡æ„åä»£ç åˆ†å±‚æ¸…æ™°ï¼Œä¾¿äºå¤ç”¨å’Œæ‰©å±•ã€‚

**Q2ï¼šé‡æ„ä¼šä¸ä¼šå½±å“ç°æœ‰åŠŸèƒ½ï¼Ÿ**

Aï¼šä¸ä¼šã€‚é‡æ„éµå¾ª"ä¸æ”¹å˜ä¸šåŠ¡è¡Œä¸º"åŸåˆ™ï¼Œæ‰€æœ‰æ¥å£çš„è¾“å…¥è¾“å‡ºä¿æŒä¸å˜ï¼Œä¸”æœ‰å®Œæ•´çš„å›å½’æµ‹è¯•ä¿æŠ¤ã€‚

**Q3ï¼šé‡æ„éœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿ**

Aï¼šé¢„è®¡ 2-3 å‘¨å®Œæˆæ ¸å¿ƒæ¨¡å—é‡æ„ã€‚å¯ä»¥åˆ†é˜¶æ®µæ¨è¿›ï¼Œæ¯ä¸ªé˜¶æ®µç‹¬ç«‹éªŒæ”¶ã€‚

**Q4ï¼šå¦‚ä½•ä¿è¯é‡æ„è´¨é‡ï¼Ÿ**

Aï¼šé€šè¿‡ä»¥ä¸‹æªæ–½ï¼š
- å®Œæ•´çš„å›å½’æµ‹è¯•
- åˆ†æ¨¡å—å°æ­¥æ¨è¿›
- æ¯æ­¥éƒ½å¯å›æ»š
- å……åˆ†çš„æ–‡æ¡£è®°å½•

**Q5ï¼šé‡æ„åå¦‚ä½•é¿å…ä»£ç å†æ¬¡å˜èƒ–ï¼Ÿ**

Aï¼šå»ºç«‹ä»£ç è§„èŒƒå’Œå®¡æŸ¥æœºåˆ¶ï¼š
- è·¯ç”±æ–‡ä»¶è¡Œæ•°é™åˆ¶ï¼ˆ< 800 è¡Œï¼‰
- ç¦æ­¢åœ¨ Controller ç›´æ¥æ“ä½œ Model
- æ‰€æœ‰ PR å¿…é¡»ç»è¿‡ Code Review

---

## é™„å½• Bï¼šå®æ–½æ—¶é—´è¡¨

### B.1 æ—¶é—´å®‰æ’ï¼ˆé¢„è®¡ 2 å‘¨ï¼Œå®ç”¨ä¸»ä¹‰ç‰ˆï¼‰

```
Week 1: é˜¶æ®µ 1ï¼ˆä¿æŠ¤ç°çŠ¶ + æ ¸å¿ƒé‡æ„ï¼‰
â”œâ”€ Day 1: è¡¥å……å›å½’æµ‹è¯•ï¼ˆä»… 2 ä¸ªæ ¸å¿ƒç«¯ç‚¹ï¼‰+ æ¸…ç†æœªæŒ‚è½½æ–‡ä»¶
â”œâ”€ Day 2: åˆ›å»º InventoryService éª¨æ¶ + æ³¨å†Œåˆ° ServiceManager
â”œâ”€ Day 3: è¿ç§» getUserInventory æ¥å£ï¼ˆP0 - æŸ¥è¯¢ç±»ï¼Œé£é™©ä½ï¼‰
â”œâ”€ Day 4-5: è¿ç§» useItem æ¥å£ï¼ˆP0 - å†™æ“ä½œï¼Œéœ€è¦äº‹åŠ¡ä¿æŠ¤ï¼‰

Week 2: é˜¶æ®µ 2ï¼ˆæ‰©å±•é‡æ„ + éªŒæ”¶ï¼‰
â”œâ”€ Day 1-2: è¿ç§» transferItem æ¥å£ï¼ˆP1 - å¤æ‚å†™æ“ä½œï¼‰
â”œâ”€ Day 3: è¿ç§» getItemDetail æ¥å£ï¼ˆP1 - ç®€å•æŸ¥è¯¢ï¼‰
â”œâ”€ Day 4: æ‰©å±• ServiceManager + æ¸…ç† points.js ç›´æ¥ models æ“ä½œ
â”œâ”€ Day 5: å…¨é¢å›å½’æµ‹è¯• + æ€§èƒ½éªŒè¯ + æ–‡æ¡£æ›´æ–°
```

### B.2 é‡Œç¨‹ç¢‘ï¼ˆåŸºäºçœŸå®ä¸šåŠ¡ä»·å€¼ï¼‰

| é‡Œç¨‹ç¢‘ | å®Œæˆæ ‡å¿— | é¢„è®¡æ—¶é—´ | ä¸šåŠ¡ä»·å€¼ |
|--------|---------|---------|---------|
| M1: å®‰å…¨ç½‘å»ºç«‹ | å›å½’æµ‹è¯•é€šè¿‡ + æœªæŒ‚è½½æ–‡ä»¶æ¸…ç† | Day 1 | ğŸŸ¢ ä¿æŠ¤ç°çŠ¶ |
| M2: InventoryService åˆ›å»º | Service éª¨æ¶ + ServiceManager æ³¨å†Œ | Day 2 | ğŸŸ¢ åŸºç¡€è®¾æ–½ |
| M3: æŸ¥è¯¢æ¥å£è¿ç§» | getUserInventory è¿ç§» + æµ‹è¯•é€šè¿‡ | Day 3 | ğŸ”´ é«˜é¢‘æ¥å£ |
| M4: æ ¸å¿ƒå†™æ“ä½œè¿ç§» | useItem è¿ç§» + äº‹åŠ¡æµ‹è¯•é€šè¿‡ | Day 5 | ğŸ”´ æ ¸å¿ƒä¸šåŠ¡ |
| M5: æ‰©å±•é‡æ„ | transferItem + getItemDetail è¿ç§» | Day 8 | ğŸŸ¡ ä¸­ç­‰ä¼˜å…ˆçº§ |
| M6: é‡æ„éªŒæ”¶ | æµ‹è¯•é€šè¿‡ + inventory.js < 2333 è¡Œ | Day 10 | ğŸŸ¢ é˜¶æ®µæ€§æˆæœ |

**è°ƒæ•´è¯´æ˜**ï¼š
- âœ… M6 ç›®æ ‡ä»"< 800 è¡Œ"è°ƒæ•´ä¸º"< 2333 è¡Œ"ï¼ˆå‡å°‘ 600 è¡Œï¼Œ20%ï¼‰
- âœ… ç¬¬ä¸€é˜¶æ®µåªå¤„ç† 4 ä¸ªç«¯ç‚¹ï¼ˆå æ€»æ•° 20%ï¼Œä½†è¦†ç›– 80% ä¸šåŠ¡ä»·å€¼ï¼‰
- âœ… æ¯ä¸ªé‡Œç¨‹ç¢‘éƒ½æœ‰æ˜ç¡®çš„ä¸šåŠ¡ä»·å€¼æ ‡æ³¨

---

## é™„å½• Cï¼šåŸºäºçœŸå®ä¸šåŠ¡çš„å…³é”®å†³ç­–

### C.1 ä¸ºä»€ä¹ˆ InventoryService é‡‡ç”¨é™æ€æ–¹æ³•ï¼Ÿ

**å‚è€ƒç°æœ‰ä»£ç **ï¼š
- `PointsService`ï¼šå…¨éƒ¨ä½¿ç”¨é™æ€æ–¹æ³•ï¼ˆstatic async addPoints()ï¼‰
- `ExchangeMarketService`ï¼šå…¨éƒ¨ä½¿ç”¨é™æ€æ–¹æ³•ï¼ˆstatic async getMarketItems()ï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… æ— éœ€å®ä¾‹åŒ–ï¼Œç›´æ¥è°ƒç”¨ï¼š`PointsService.addPoints()`
- âœ… æ— çŠ¶æ€è®¾è®¡ï¼Œçº¿ç¨‹å®‰å…¨
- âœ… ä¸ç°æœ‰ Service é£æ ¼ä¸€è‡´

**ç¼ºç‚¹**ï¼š
- âŒ æµ‹è¯•æ—¶éœ€è¦ mock æ•´ä¸ªç±»ï¼ˆä½†é¡¹ç›®ç›®å‰æ²¡æœ‰å•å…ƒæµ‹è¯•ï¼‰
- âŒ æ— æ³•ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼ˆä½†é¡¹ç›®ç›®å‰ä¹Ÿæ²¡ç”¨ DIï¼‰

**ç»“è®º**ï¼šâœ… **é‡‡ç”¨é™æ€æ–¹æ³•**ï¼Œä¸ç°æœ‰æŠ€æœ¯è·¯çº¿ä¿æŒä¸€è‡´ã€‚

### C.2 äº‹åŠ¡å¤„ç†æ¨¡å¼

**ç°æœ‰ä»£ç çš„äº‹åŠ¡å¤„ç†æ–¹å¼**ï¼ˆæ¥è‡ª PointsServiceï¼‰ï¼š

```javascript
// PointsService.js ç¬¬ 84-96 è¡Œçš„å®é™…æ¨¡å¼
static async consumePoints(userId, amount, options = {}) {
  const { transaction: externalTransaction } = options
  
  // æ”¯æŒå¤–éƒ¨äº‹åŠ¡ä¼ å…¥
  const transaction = externalTransaction || await sequelize.transaction()
  const shouldCommit = !externalTransaction
  
  try {
    // ä¸šåŠ¡é€»è¾‘...
    
    if (shouldCommit) {
    await transaction.commit()
    }
    return result
  } catch (error) {
    if (shouldCommit) {
    await transaction.rollback()
    }
    throw error
  }
}
```

**å…³é”®è®¾è®¡**ï¼š
- âœ… æ”¯æŒå¤–éƒ¨äº‹åŠ¡ä¼ å…¥ï¼ˆè·¨ Service è°ƒç”¨æ—¶å…±äº«äº‹åŠ¡ï¼‰
- âœ… åªæœ‰è‡ªå·±åˆ›å»ºçš„äº‹åŠ¡æ‰ commit/rollback
- âœ… ä½¿ç”¨æ‚²è§‚é”ï¼ˆFOR UPDATEï¼‰é˜²æ­¢å¹¶å‘é—®é¢˜

**InventoryService å¿…é¡»éµå¾ªç›¸åŒæ¨¡å¼**ã€‚

### C.3 å¹‚ç­‰æ€§æ§åˆ¶

**PointsService çš„å¹‚ç­‰æ€§å®ç°**ï¼ˆç¬¬ 200-220 è¡Œï¼‰ï¼š

```javascript
// é€šè¿‡ business_id é˜²æ­¢é‡å¤æäº¤
if (business_id) {
  const existingTx = await PointsTransaction.findOne({
    where: { business_id },
    transaction
  })
  
  if (existingTx) {
    // å·²å­˜åœ¨ï¼Œè¿”å›åŸç»“æœï¼ˆå¹‚ç­‰ï¼‰
    return { success: true, transaction_id: existingTx.transaction_id }
  }
}
```

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… å…‘æ¢æ‰£ç§¯åˆ†ï¼ˆbusiness_id: `exchange_${exchangeId}`ï¼‰
- âœ… é€€æ¬¾æ“ä½œï¼ˆbusiness_id: `refund_${orderId}`ï¼‰
- âœ… æ¶ˆè´¹å¥–åŠ±ï¼ˆbusiness_id: `consumption_${recordId}`ï¼‰

**InventoryService çš„å¹‚ç­‰æ€§éœ€æ±‚**ï¼š
- âœ… è½¬è®©ç‰©å“ï¼š`transfer_${itemId}_${timestamp}`
- âœ… ä½¿ç”¨ç‰©å“ï¼š`use_${itemId}_${timestamp}`
- âŒ æŸ¥è¯¢æ“ä½œï¼šä¸éœ€è¦å¹‚ç­‰æ€§

### C.4 æ•°æ®è„±æ•ç­–ç•¥

**ç°æœ‰ä»£ç çš„æ•°æ®è„±æ•**ï¼ˆinventory.js ç¬¬ 251-252 è¡Œï¼‰ï¼š

```javascript
// ç§»é™¤ mobile å­—æ®µï¼Œä¿æŠ¤ç”¨æˆ·éšç§
attributes: ['user_id', 'nickname'] // ä¸åŒ…å« mobile
```

**DataSanitizer çš„ä½¿ç”¨**ï¼ˆinventory.js ä¸­æœªå®é™…ä½¿ç”¨ï¼Œä½†å·²å¼•å…¥ï¼‰ï¼š

```javascript
const DataSanitizer = require('../../../services/DataSanitizer')
// ä½†å®é™…ä»£ç ä¸­æ²¡æœ‰è°ƒç”¨ DataSanitizer.sanitize()
```

**å®ç”¨ä¸»ä¹‰å»ºè®®**ï¼š
- âœ… **ç¬¬ä¸€é˜¶æ®µä¸å®ç° DataSanitizer**ï¼ˆç°æœ‰ä»£ç ä¹Ÿæ²¡ç”¨ï¼‰
- âœ… é€šè¿‡ Sequelize attributes æ§åˆ¶å­—æ®µï¼ˆæ›´ç®€å•ç›´æ¥ï¼‰
- âœ… ç®¡ç†å‘˜æŸ¥çœ‹æ—¶è®°å½•å®¡è®¡æ—¥å¿—ï¼ˆå·²æœ‰å®ç°ï¼Œç¬¬ 262-269 è¡Œï¼‰

### C.5 é”™è¯¯å¤„ç†ç­–ç•¥

**ç°æœ‰ä»£ç çš„é”™è¯¯å¤„ç†**ï¼ˆinventory.js ç¬¬ 196-214 è¡Œï¼‰ï¼š

```javascript
catch (error) {
  logger.error('è·å–ç”¨æˆ·åº“å­˜å¤±è´¥', { error: error.message })
  
  // åˆ†ç±»é”™è¯¯å¤„ç†
  if (error.name === 'SequelizeDatabaseError') {
    return res.apiError('æ•°æ®åº“è¿æ¥å¤±è´¥', 'SERVICE_UNAVAILABLE', null, 503)
  } else if (error.name === 'SequelizeValidationError') {
    return res.apiError('æ•°æ®éªŒè¯å¤±è´¥', 'BAD_REQUEST', null, 400)
  } else {
    return res.apiError('è·å–åº“å­˜åˆ—è¡¨å¤±è´¥', 'INTERNAL_ERROR', null, 500)
  }
}
```

**å®ç”¨ä¸»ä¹‰å»ºè®®**ï¼š
- âœ… **ç¬¬ä¸€é˜¶æ®µä¸å¼•å…¥ BusinessError ç±»**ï¼ˆå¢åŠ å¤æ‚åº¦ï¼‰
- âœ… ä¿æŒç°æœ‰çš„ç®€å•é”™è¯¯å¤„ç†æ¨¡å¼
- âœ… Service å±‚ç›´æ¥ throw Errorï¼ŒController å±‚æ•è·åˆ†ç±»

### C.6 é€šçŸ¥å‘é€ç­–ç•¥

**ç°æœ‰ä»£ç çš„é€šçŸ¥å‘é€**ï¼ˆinventory.js ä¸­å·²å¼•å…¥ä½†æœªä½¿ç”¨ï¼‰ï¼š

```javascript
const NotificationService = require('../../../services/NotificationService')
// ä½†å®é™…ä»£ç ä¸­æ²¡æœ‰è°ƒç”¨
```

**å®ç”¨ä¸»ä¹‰å»ºè®®**ï¼š
- âœ… **ç¬¬ä¸€é˜¶æ®µä¸å®ç°é€šçŸ¥åŠŸèƒ½**ï¼ˆéæ ¸å¿ƒåŠŸèƒ½ï¼‰
- âœ… åœ¨ Service æ–¹æ³•ä¸­é¢„ç•™é€šçŸ¥æ¥å£ï¼ˆæ³¨é‡Šæ ‡æ³¨ TODOï¼‰
- âœ… ç¬¬äºŒé˜¶æ®µæ ¹æ®å®é™…éœ€æ±‚è¡¥å……

### C.7 é‡æ„ä¼˜å…ˆçº§çŸ©é˜µï¼ˆåŸºäºçœŸå®ä¸šåŠ¡ä»·å€¼ï¼‰

| ç«¯ç‚¹ | è°ƒç”¨é¢‘ç‡ | ä¸šåŠ¡é‡è¦æ€§ | ä»£ç å¤æ‚åº¦ | é‡æ„ä¼˜å…ˆçº§ | é¢„è®¡å·¥æ—¶ |
|------|---------|-----------|-----------|-----------|---------|
| GET /user/:user_id | ğŸ”´ é«˜ | ğŸ”´ é«˜ | ğŸŸ¡ ä¸­ | **P0** | 1 å¤© |
| POST /use/:item_id | ğŸŸ¡ ä¸­ | ğŸ”´ é«˜ | ğŸ”´ é«˜ | **P0** | 1.5 å¤© |
| POST /transfer | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | ğŸ”´ é«˜ | **P1** | 1.5 å¤© |
| GET /item/:item_id | ğŸŸ¢ ä½ | ğŸŸ¡ ä¸­ | ğŸŸ¢ ä½ | **P1** | 0.5 å¤© |
| POST /generate-code | ğŸŸ¢ ä½ | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | **P2** | 1 å¤© |
| POST /verification/verify | ğŸŸ¢ ä½ | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | **P2** | 1 å¤© |

**ç¬¬ä¸€é˜¶æ®µï¼ˆ1 å‘¨ï¼‰**ï¼šåªé‡æ„ P0 ç«¯ç‚¹ï¼ˆ2.5 å¤©å·¥æ—¶ï¼‰
**ç¬¬äºŒé˜¶æ®µï¼ˆ1 å‘¨ï¼‰**ï¼šé‡æ„ P1 ç«¯ç‚¹ï¼ˆ2 å¤©å·¥æ—¶ï¼‰
**ç¬¬ä¸‰é˜¶æ®µï¼ˆå¯é€‰ï¼‰**ï¼šé‡æ„ P2 ç«¯ç‚¹ï¼ˆ2 å¤©å·¥æ—¶ï¼‰

---

## ç»“è¯­

æœ¬é‡æ„æ–¹æ¡ˆåŸºäºå¯¹ç°æœ‰ä»£ç åº“çš„æ·±å…¥åˆ†æï¼Œ**ä¸¥æ ¼éµå¾ªé¡¹ç›®ç°æœ‰æŠ€æœ¯è·¯çº¿**ï¼š

**æŠ€æœ¯è·¯çº¿å¯¹é½**ï¼š
- âœ… Service å±‚é‡‡ç”¨é™æ€æ–¹æ³•ï¼ˆä¸ PointsService/ExchangeMarketService ä¸€è‡´ï¼‰
- âœ… äº‹åŠ¡å¤„ç†æ”¯æŒå¤–éƒ¨ä¼ å…¥ï¼ˆä¸ PointsService æ¨¡å¼ä¸€è‡´ï¼‰
- âœ… å¹‚ç­‰æ€§é€šè¿‡ business_id æ§åˆ¶ï¼ˆä¸ PointsService ä¸€è‡´ï¼‰
- âœ… é”™è¯¯å¤„ç†ä¿æŒç®€å•ç›´æ¥ï¼ˆä¸å¼•å…¥æ–°çš„é”™è¯¯ç±»ï¼‰
- âœ… æ•°æ®è„±æ•é€šè¿‡ Sequelize attributesï¼ˆä¸å¼ºåˆ¶ä½¿ç”¨ DataSanitizerï¼‰

**å®ç”¨ä¸»ä¹‰åŸåˆ™**ï¼š
- âœ… æ¸è¿›å¼é‡æ„ï¼šç¬¬ä¸€é˜¶æ®µåªå¤„ç† 2 ä¸ªæ ¸å¿ƒç«¯ç‚¹ï¼ˆP0ï¼‰
- âœ… ä¸è¿‡åº¦è®¾è®¡ï¼šä¸å¼•å…¥é¡¹ç›®å½“å‰ä¸éœ€è¦çš„å¤æ‚æœºåˆ¶
- âœ… åŸºäºçœŸå®æ•°æ®ï¼šæ‰€æœ‰å†³ç­–éƒ½åŸºäºå®é™…ä»£ç åˆ†æ
- âœ… å¯å›æ»šï¼šæ¯ä¸ªé˜¶æ®µç‹¬ç«‹éªŒæ”¶ï¼Œå¤±è´¥å¯å¿«é€Ÿå›æ»š

**é¢„æœŸæ•ˆæœ**ï¼š
- ç¬¬ä¸€é˜¶æ®µï¼šinventory.js å‡å°‘ 600 è¡Œï¼ˆ20%ï¼‰ï¼Œå·¥æ—¶ 1 å‘¨
- ç¬¬äºŒé˜¶æ®µï¼šç»§ç»­å‡å°‘ 400 è¡Œï¼ˆ14%ï¼‰ï¼Œå·¥æ—¶ 1 å‘¨
- æ€»è®¡ï¼šå‡å°‘ 1000 è¡Œï¼ˆ34%ï¼‰ï¼Œå·¥æ—¶ 2 å‘¨

é‡æ„ä¸æ˜¯ç›®çš„ï¼Œè€Œæ˜¯æ‰‹æ®µã€‚æœ€ç»ˆç›®æ ‡æ˜¯å»ºç«‹ä¸€ä¸ª**æ¸…æ™°åˆ†å±‚ã€èŒè´£æ˜ç¡®ã€æ˜“äºç»´æŠ¤å’Œæ‰©å±•**çš„åç«¯æ¶æ„ï¼ŒåŒæ—¶**ä¸ç ´åç°æœ‰æŠ€æœ¯è·¯çº¿çš„ä¸€è‡´æ€§**ã€‚

---

**æ–‡æ¡£ç»´æŠ¤**ï¼š

- åˆ›å»ºäººï¼šAI Assistant
- åˆ›å»ºæ—¶é—´ï¼š2025-12-09
- æœ€åæ›´æ–°ï¼š2025-12-09
- ç‰ˆæœ¬ï¼šv2.0ï¼ˆç²¾ç®€å®ç”¨ç‰ˆï¼‰
- å®¡æ ¸çŠ¶æ€ï¼šå¾…å®¡æ ¸

**å˜æ›´è®°å½•**ï¼š

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | å˜æ›´äºº |
|------|------|---------|--------|
| v1.0 | 2025-12-09 | åˆå§‹ç‰ˆæœ¬åˆ›å»º | AI Assistant |
| v2.0 | 2025-12-09 | åŸºäºçœŸå®ä»£ç ç²¾ç®€é‡å†™ï¼Œåˆ é™¤ç†è®ºå†…å®¹ï¼Œå‹ç¼©è‡³ 1000 è¡Œ | AI Assistant |
