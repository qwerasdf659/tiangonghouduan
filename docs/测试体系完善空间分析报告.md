# æµ‹è¯•ä½“ç³»å®Œå–„ç©ºé—´åˆ†ææŠ¥å‘Š

> **ç”Ÿæˆæ—¶é—´**: 2026-01-29 åŒ—äº¬æ—¶é—´  
> **åˆ†æèŒƒå›´**: `/home/devbox/project/tests` ç›®å½•  
> **æœåŠ¡æ–‡ä»¶æ•°**: 93ä¸ª  
> **æµ‹è¯•æ–‡ä»¶æ•°**: 161ä¸ª  
> **æ€»æµ‹è¯•ç”¨ä¾‹æ•°**: ~1,900+  
> **æŠ€æœ¯æ ˆ**: Node.js + Jest + Sequelize + MySQL + Redis

---

## ğŸ“‹ ä»»åŠ¡æ¸…å•ï¼ˆè¯¦ç»†åˆ†è§£ï¼‰

### ğŸ”´ P0 çº§ä»»åŠ¡ - æ ¸å¿ƒæœåŠ¡å•å…ƒæµ‹è¯•ï¼ˆé¢„è®¡ 9 å°æ—¶ï¼‰

#### P0-1: AssetService.test.jsï¼ˆé¢„è®¡ 4 å°æ—¶ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶/ä½ç½® | é¢„è®¡æ—¶é—´ | çŠ¶æ€ |
|-----|-------|----------|---------|------|
| P0-1-1 | åˆ›å»ºæµ‹è¯•æ–‡ä»¶éª¨æ¶ | `tests/services/AssetService.test.js` | 15min | â¬œ |
| P0-1-2 | å®ç° `getOrCreateAccount` æµ‹è¯•ç”¨ä¾‹ | è´¦æˆ·è·å–/åˆ›å»ºï¼ˆç”¨æˆ·è´¦æˆ·ã€ç³»ç»Ÿè´¦æˆ·ã€å‚æ•°æ ¡éªŒï¼‰ | 30min | â¬œ |
| P0-1-3 | å®ç° `getOrCreateBalance` æµ‹è¯•ç”¨ä¾‹ | ä½™é¢è·å–ï¼ˆPOINTSã€DIAMONDã€red_shardï¼‰ | 30min | â¬œ |
| P0-1-4 | å®ç° `getBalance` æµ‹è¯•ç”¨ä¾‹ | ä½™é¢æŸ¥è¯¢ï¼ˆå¯ç”¨/å†»ç»“/æ€»è®¡ï¼‰ | 20min | â¬œ |
| P0-1-5 | å®ç° `changeBalance` å¢åŠ ä½™é¢æµ‹è¯• | æ­£å¸¸å¢åŠ ã€å¤§é¢å¢åŠ ã€å¹‚ç­‰æ£€æŸ¥ | 30min | â¬œ |
| P0-1-6 | å®ç° `changeBalance` æ‰£å‡ä½™é¢æµ‹è¯• | æ­£å¸¸æ‰£å‡ã€ä½™é¢ä¸è¶³ã€è¾¹ç•Œå€¼ | 30min | â¬œ |
| P0-1-7 | å®ç° `freeze/unfreeze` æµ‹è¯•ç”¨ä¾‹ | å†»ç»“èµ„äº§ã€è§£å†»èµ„äº§ã€å†»ç»“ä¸è¶³ | 30min | â¬œ |
| P0-1-8 | å®ç° `settleFromFrozen` æµ‹è¯•ç”¨ä¾‹ | ä»å†»ç»“ä½™é¢ç»“ç®—ã€ç»“ç®—ä¸è¶³ | 20min | â¬œ |
| P0-1-9 | å®ç°å¹‚ç­‰æ€§ä¿æŠ¤æµ‹è¯• | ç›¸åŒå¹‚ç­‰é”®ã€ä¸åŒå¹‚ç­‰é”®ã€å¹¶å‘å¹‚ç­‰ | 25min | â¬œ |
| P0-1-10 | å®ç°äº‹åŠ¡è¾¹ç•Œæµ‹è¯• | æ— äº‹åŠ¡æŠ¥é”™ã€äº‹åŠ¡å›æ»šéªŒè¯ | 20min | â¬œ |
| P0-1-11 | è¿è¡Œæµ‹è¯•å¹¶ä¿®å¤é—®é¢˜ | `npm test -- tests/services/AssetService.test.js` | 30min | â¬œ |

#### P0-2: IdempotencyService.test.jsï¼ˆé¢„è®¡ 2 å°æ—¶ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶/ä½ç½® | é¢„è®¡æ—¶é—´ | çŠ¶æ€ |
|-----|-------|----------|---------|------|
| P0-2-1 | åˆ›å»ºæµ‹è¯•æ–‡ä»¶éª¨æ¶ | `tests/services/IdempotencyService.test.js` | 10min | âœ… |
| P0-2-2 | å®ç° `getOrCreateRequest` æ–°è¯·æ±‚æµ‹è¯• | åˆ›å»º processing çŠ¶æ€è®°å½• | 20min | âœ… |
| P0-2-3 | å®ç° `getOrCreateRequest` é‡å¤è¯·æ±‚æµ‹è¯• | processing/completed/failed çŠ¶æ€å¤„ç† | 20min | âœ… |
| P0-2-4 | å®ç° `markAsCompleted` æµ‹è¯•ç”¨ä¾‹ | æ ‡è®°å®Œæˆã€ç»“æœå¿«ç…§å­˜å‚¨ | 15min | âœ… |
| P0-2-5 | å®ç° `markAsFailed` æµ‹è¯•ç”¨ä¾‹ | æ ‡è®°å¤±è´¥ã€é”™è¯¯ä¿¡æ¯å­˜å‚¨ | 15min | âœ… |
| P0-2-6 | å®ç°å¹¶å‘å®‰å…¨æµ‹è¯• | 100å¹¶å‘ç›¸åŒkeyåªæœ‰1ä¸ªæˆåŠŸ | 20min | âœ… |
| P0-2-7 | å®ç°è¶…æ—¶å¤„ç†æµ‹è¯• | `autoFailProcessingTimeout` | 10min | âœ… |
| P0-2-8 | å®ç°è¿‡æœŸæ¸…ç†æµ‹è¯• | `cleanupExpired` | 10min | âœ… |
| P0-2-9 | è¿è¡Œæµ‹è¯•å¹¶ä¿®å¤é—®é¢˜ | `npm test -- tests/services/IdempotencyService.test.js` | 20min | âœ… |

#### P0-3: AssetConversionService.test.jsï¼ˆé¢„è®¡ 3 å°æ—¶ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶/ä½ç½® | é¢„è®¡æ—¶é—´ | çŠ¶æ€ |
|-----|-------|----------|---------|------|
| P0-3-1 | åˆ›å»ºæµ‹è¯•æ–‡ä»¶éª¨æ¶ | `tests/services/AssetConversionService.test.js` | 10min | â¬œ |
| P0-3-2 | å®ç° `getConversionRules` æµ‹è¯•ç”¨ä¾‹ | è·å–è§„åˆ™åˆ—è¡¨ã€çŠ¶æ€è¿‡æ»¤ | 20min | â¬œ |
| P0-3-3 | å®ç° `convertMaterial` æ­£å¸¸è½¬æ¢æµ‹è¯• | æœ‰æ•ˆè§„åˆ™è½¬æ¢æˆåŠŸ | 25min | â¬œ |
| P0-3-4 | å®ç° `convertMaterial` é”™è¯¯å¤„ç†æµ‹è¯• | æ— æ•ˆè§„åˆ™ã€ä½™é¢ä¸è¶³ã€æ•°é‡è¶…é™ | 30min | â¬œ |
| P0-3-5 | å®ç°äº‹åŠ¡è¾¹ç•Œæµ‹è¯• | æ— äº‹åŠ¡æŠ¥é”™ã€äº‹åŠ¡å›æ»š | 15min | â¬œ |
| P0-3-6 | å®ç°è½¬æ¢å¹‚ç­‰æ€§æµ‹è¯• | ç›¸åŒå¹‚ç­‰é”®é‡å¤è¯·æ±‚ | 20min | â¬œ |
| P0-3-7 | å®ç°æ‰‹ç»­è´¹è®¡ç®—æµ‹è¯• | fee_rate è®¡ç®—ã€fee_min_amount | 20min | â¬œ |
| P0-3-8 | å®ç° `convertRedShardToDiamond` ä¾¿æ·æ–¹æ³•æµ‹è¯• | ç¢çº¢æ°´æ™¶â†’é’»çŸ³ | 15min | â¬œ |
| P0-3-9 | å®ç°æ•°é‡é™åˆ¶æµ‹è¯• | min_from_amountã€max_from_amount | 15min | â¬œ |
| P0-3-10 | è¿è¡Œæµ‹è¯•å¹¶ä¿®å¤é—®é¢˜ | `npm test -- tests/services/AssetConversionService.test.js` | 30min | â¬œ |

---

### ğŸŸ¡ P1 çº§ä»»åŠ¡ - è¾¹ç•Œæ¡ä»¶å’Œé”æµ‹è¯•ï¼ˆé¢„è®¡ 4 å°æ—¶ï¼‰

#### P1-1: balance_boundary.test.jsï¼ˆé¢„è®¡ 2 å°æ—¶ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶/ä½ç½® | é¢„è®¡æ—¶é—´ | çŠ¶æ€ |
|-----|-------|----------|---------|------|
| P1-1-1 | åˆ›å»ºæµ‹è¯•æ–‡ä»¶éª¨æ¶ | `tests/integration/balance_boundary.test.js` | 10min | â¬œ |
| P1-1-2 | å®ç°é›¶ä½™é¢è¾¹ç•Œæµ‹è¯• | ä½™é¢=æ‰£å‡é¢ã€ä½™é¢=0æ—¶æ‰£å‡ | 25min | â¬œ |
| P1-1-3 | å®ç°å¤§æ•°å€¼è¾¹ç•Œæµ‹è¯• | 1äº¿çº§å¢åŠ /æ‰£å‡ã€æº¢å‡ºæ£€æµ‹ | 25min | â¬œ |
| P1-1-4 | å®ç°è´Ÿæ•°è¾¹ç•Œæµ‹è¯• | è´Ÿä½™é¢ï¼ˆå€ºåŠ¡ï¼‰å¤„ç† | 20min | â¬œ |
| P1-1-5 | å®ç°å°æ•°ç²¾åº¦æµ‹è¯• | æµ®ç‚¹æ•°èˆå…¥ã€ç²¾åº¦ä¸¢å¤± | 20min | â¬œ |
| P1-1-6 | è¿è¡Œæµ‹è¯•å¹¶ä¿®å¤é—®é¢˜ | `npm test -- tests/integration/balance_boundary.test.js` | 20min | â¬œ |

#### P1-2: distributed_lock_stress.test.jsï¼ˆé¢„è®¡ 2 å°æ—¶ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶/ä½ç½® | é¢„è®¡æ—¶é—´ | çŠ¶æ€ |
|-----|-------|----------|---------|------|
| P1-2-1 | åˆ›å»ºæµ‹è¯•æ–‡ä»¶éª¨æ¶ | `tests/integration/distributed_lock_stress.test.js` | 10min | â¬œ |
| P1-2-2 | å®ç°é”ç«äº‰æµ‹è¯• | 100å¹¶å‘è·å–åŒä¸€æŠŠé” | 25min | â¬œ |
| P1-2-3 | å®ç°é”è¶…æ—¶æµ‹è¯• | TTL è‡ªåŠ¨é‡Šæ”¾éªŒè¯ | 20min | â¬œ |
| P1-2-4 | å®ç°é”é‡å…¥æµ‹è¯• | åŒä¸€çº¿ç¨‹é‡å¤è·å– | 20min | â¬œ |
| P1-2-5 | å®ç°é”é™çº§æµ‹è¯• | Redis æ•…éšœæ—¶çš„å¤„ç† | 25min | â¬œ |
| P1-2-6 | è¿è¡Œæµ‹è¯•å¹¶ä¿®å¤é—®é¢˜ | `npm test -- tests/integration/distributed_lock_stress.test.js` | 20min | â¬œ |

---

### ğŸŸ¢ P2 çº§ä»»åŠ¡ - æ”¯æ’‘æœåŠ¡å•å…ƒæµ‹è¯•ï¼ˆé¢„è®¡ 8 å°æ—¶ï¼‰

#### P2-1: DebtManagementService.test.jsï¼ˆé¢„è®¡ 2 å°æ—¶ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶/ä½ç½® | é¢„è®¡æ—¶é—´ | çŠ¶æ€ |
|-----|-------|----------|---------|------|
| P2-1-1 | åˆ›å»ºæµ‹è¯•æ–‡ä»¶éª¨æ¶ | `tests/services/DebtManagementService.test.js` | 10min | â¬œ |
| P2-1-2 | å®ç°å€ºåŠ¡è®°å½•åˆ›å»ºæµ‹è¯• | è´Ÿç§¯åˆ†äº§ç”Ÿå€ºåŠ¡ | 25min | â¬œ |
| P2-1-3 | å®ç°å€ºåŠ¡è¿˜æ¬¾æµ‹è¯• | ç§¯åˆ†å…¥è´¦æ—¶è‡ªåŠ¨è¿˜æ¬¾ | 25min | â¬œ |
| P2-1-4 | å®ç°å€ºåŠ¡æŸ¥è¯¢æµ‹è¯• | ç”¨æˆ·å€ºåŠ¡åˆ—è¡¨ã€æ€»é¢ | 20min | â¬œ |
| P2-1-5 | å®ç°å€ºåŠ¡é™åˆ¶æµ‹è¯• | å€ºåŠ¡ä¸Šé™ã€è¿˜æ¬¾ä¼˜å…ˆçº§ | 20min | â¬œ |
| P2-1-6 | è¿è¡Œæµ‹è¯•å¹¶ä¿®å¤é—®é¢˜ | æ‰§è¡Œæµ‹è¯•å‘½ä»¤ | 20min | â¬œ |

#### P2-2: PrizePoolService.test.jsï¼ˆé¢„è®¡ 2 å°æ—¶ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶/ä½ç½® | é¢„è®¡æ—¶é—´ | çŠ¶æ€ |
|-----|-------|----------|---------|------|
| P2-2-1 | åˆ›å»ºæµ‹è¯•æ–‡ä»¶éª¨æ¶ | `tests/services/PrizePoolService.test.js` | 10min | â¬œ |
| P2-2-2 | å®ç°å¥–å“æŸ¥è¯¢æµ‹è¯• | è·å–æ´»åŠ¨å¥–å“åˆ—è¡¨ | 20min | â¬œ |
| P2-2-3 | å®ç°åº“å­˜æ‰£å‡æµ‹è¯• | åŸå­æ‰£å‡ã€å¹¶å‘å®‰å…¨ | 30min | â¬œ |
| P2-2-4 | å®ç°åº“å­˜å›æ»šæµ‹è¯• | å¥–å“å‘æ”¾å¤±è´¥å›æ»š | 20min | â¬œ |
| P2-2-5 | å®ç°åº“å­˜è¾¹ç•Œæµ‹è¯• | åº“å­˜=0ã€æœ€å1ä»¶ | 20min | â¬œ |
| P2-2-6 | è¿è¡Œæµ‹è¯•å¹¶ä¿®å¤é—®é¢˜ | æ‰§è¡Œæµ‹è¯•å‘½ä»¤ | 20min | â¬œ |

#### P2-3: StoreService.test.jsï¼ˆé¢„è®¡ 2 å°æ—¶ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶/ä½ç½® | é¢„è®¡æ—¶é—´ | çŠ¶æ€ |
|-----|-------|----------|---------|------|
| P2-3-1 | åˆ›å»ºæµ‹è¯•æ–‡ä»¶éª¨æ¶ | `tests/services/StoreService.test.js` | 10min | âœ… |
| P2-3-2 | å®ç°åº—é“ºæŸ¥è¯¢æµ‹è¯• | è·å–åº—é“ºåˆ—è¡¨ã€è¯¦æƒ… | 20min | âœ… |
| P2-3-3 | å®ç°åº—é“ºåˆ›å»ºæµ‹è¯• | åˆ›å»ºæ–°åº—é“º | 20min | âœ… |
| P2-3-4 | å®ç°åº—é“ºæ›´æ–°æµ‹è¯• | æ›´æ–°åº—é“ºä¿¡æ¯ | 20min | âœ… |
| P2-3-5 | å®ç°åº—é“ºçŠ¶æ€æµ‹è¯• | å¯ç”¨/ç¦ç”¨åº—é“º | 20min | âœ… |
| P2-3-6 | è¿è¡Œæµ‹è¯•å¹¶ä¿®å¤é—®é¢˜ | æ‰§è¡Œæµ‹è¯•å‘½ä»¤ | 20min | âœ… |

#### P2-4: UserRoleService.test.jsï¼ˆé¢„è®¡ 2 å°æ—¶ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶/ä½ç½® | é¢„è®¡æ—¶é—´ | çŠ¶æ€ |
|-----|-------|----------|---------|------|
| P2-4-1 | åˆ›å»ºæµ‹è¯•æ–‡ä»¶éª¨æ¶ | `tests/services/UserRoleService.test.js` | 10min | â¬œ |
| P2-4-2 | å®ç°è§’è‰²æŸ¥è¯¢æµ‹è¯• | è·å–ç”¨æˆ·è§’è‰²ã€æƒé™åˆ—è¡¨ | 20min | â¬œ |
| P2-4-3 | å®ç°è§’è‰²åˆ†é…æµ‹è¯• | åˆ†é…/å–æ¶ˆè§’è‰² | 25min | â¬œ |
| P2-4-4 | å®ç°æƒé™æ£€æŸ¥æµ‹è¯• | `hasPermission` éªŒè¯ | 25min | â¬œ |
| P2-4-5 | å®ç°è§’è‰²ç»§æ‰¿æµ‹è¯• | è§’è‰²å±‚çº§ã€æƒé™ç»§æ‰¿ | 20min | â¬œ |
| P2-4-6 | è¿è¡Œæµ‹è¯•å¹¶ä¿®å¤é—®é¢˜ | æ‰§è¡Œæµ‹è¯•å‘½ä»¤ | 20min | â¬œ |

---

### ğŸ”µ P3 çº§ä»»åŠ¡ - å¯é€‰ä¼˜åŒ–ï¼ˆé¢„è®¡ 12 å°æ—¶ï¼‰

#### P3-1: æ›´é«˜å¹¶å‘æµ‹è¯•ï¼ˆé¢„è®¡ 4 å°æ—¶ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶/ä½ç½® | é¢„è®¡æ—¶é—´ | çŠ¶æ€ |
|-----|-------|----------|---------|------|
| P3-1-1 | 20,000 å¹¶å‘æŠ½å¥–å‹åŠ›æµ‹è¯• | `tests/specialized/ultra_high_concurrency.test.js` | 2h | â¬œ |
| P3-1-2 | çªå‘æµé‡æµ‹è¯•ï¼ˆ10ç§’å†…100â†’5000ï¼‰ | å¼¹æ€§èƒ½åŠ›éªŒè¯ | 1h | â¬œ |
| P3-1-3 | 5,000 WebSocket è¿æ¥ç¨³å®šæ€§æµ‹è¯• | è¿æ¥ä¸Šé™æŒç»­éªŒè¯ | 1h | â¬œ |

#### P3-2: ç¨³å®šæ€§æµ‹è¯•ï¼ˆé¢„è®¡ 4 å°æ—¶ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶/ä½ç½® | é¢„è®¡æ—¶é—´ | çŠ¶æ€ |
|-----|-------|----------|---------|------|
| P3-2-1 | 1å°æ—¶æŒç»­é«˜å‹æµ‹è¯• | å†…å­˜æ³„æ¼æ£€æµ‹ | 2h | â¬œ |
| P3-2-2 | èµ„æºæ± è€—å°½æ¢å¤æµ‹è¯• | è¿æ¥æ± è€—å°½åæ¢å¤ | 1h | â¬œ |
| P3-2-3 | æ­»é”æ£€æµ‹æµ‹è¯• | æ•°æ®åº“æ­»é”è‡ªåŠ¨æ¢å¤ | 1h | â¬œ |

#### P3-3: å…¶ä»–æ”¯æ’‘æœåŠ¡ï¼ˆé¢„è®¡ 4 å°æ—¶ï¼‰

| åºå· | å­ä»»åŠ¡ | æ–‡ä»¶/ä½ç½® | é¢„è®¡æ—¶é—´ | çŠ¶æ€ |
|-----|-------|----------|---------|------|
| P3-3-1 | ExchangeService.test.js | å…‘æ¢æœåŠ¡æµ‹è¯• | 1h | â¬œ |
| P3-3-2 | AnnouncementService.test.js | å…¬å‘ŠæœåŠ¡æµ‹è¯• | 1h | â¬œ |
| P3-3-3 | DictionaryService.test.js | å­—å…¸é…ç½®æµ‹è¯• | 1h | â¬œ |
| P3-3-4 | StaffManagementService.test.js | å‘˜å·¥ç®¡ç†æµ‹è¯• | 1h | â¬œ |

---

### ğŸ“Š ä»»åŠ¡æ€»è§ˆ

| ä¼˜å…ˆçº§ | ä»»åŠ¡æ•° | é¢„è®¡å·¥æ—¶ | ç´¯è®¡å·¥æ—¶ |
|-------|-------|---------|---------|
| ğŸ”´ P0 | 30 ä¸ªå­ä»»åŠ¡ | 9 å°æ—¶ | 9 å°æ—¶ |
| ğŸŸ¡ P1 | 12 ä¸ªå­ä»»åŠ¡ | 4 å°æ—¶ | 13 å°æ—¶ |
| ğŸŸ¢ P2 | 24 ä¸ªå­ä»»åŠ¡ | 8 å°æ—¶ | 21 å°æ—¶ |
| ğŸ”µ P3 | 10 ä¸ªå­ä»»åŠ¡ | 12 å°æ—¶ | 33 å°æ—¶ |
| **æ€»è®¡** | **76 ä¸ªå­ä»»åŠ¡** | **33 å°æ—¶** | - |

### ğŸš€ å»ºè®®æ‰§è¡Œé¡ºåº

```
Day 1 (8h): P0-1 + P0-2 éƒ¨åˆ†
  â”œâ”€â”€ ä¸Šåˆ: P0-1-1 ~ P0-1-6 (AssetService æ ¸å¿ƒæµ‹è¯•)
  â””â”€â”€ ä¸‹åˆ: P0-1-7 ~ P0-1-11 + P0-2-1 ~ P0-2-4

Day 2 (8h): P0-2 å®Œæˆ + P0-3 + P1-1
  â”œâ”€â”€ ä¸Šåˆ: P0-2-5 ~ P0-2-9 + P0-3-1 ~ P0-3-5
  â””â”€â”€ ä¸‹åˆ: P0-3-6 ~ P0-3-10 + P1-1-1 ~ P1-1-6

Day 3 (8h): P1-2 + P2-1 + P2-2
  â”œâ”€â”€ ä¸Šåˆ: P1-2-1 ~ P1-2-6 + P2-1-1 ~ P2-1-3
  â””â”€â”€ ä¸‹åˆ: P2-1-4 ~ P2-1-6 + P2-2-1 ~ P2-2-6

Day 4 (8h): P2-3 + P2-4 + å›å½’æµ‹è¯•
  â”œâ”€â”€ ä¸Šåˆ: P2-3-1 ~ P2-3-6 + P2-4-1 ~ P2-4-3
  â””â”€â”€ ä¸‹åˆ: P2-4-4 ~ P2-4-6 + å…¨é‡å›å½’æµ‹è¯•

Day 5+ (å¯é€‰): P3 çº§ä¼˜åŒ–ä»»åŠ¡
```

---

## ä¸€ã€é¡¹ç›®æŠ€æœ¯æ¡†æ¶è¯´æ˜

### 1.1 æµ‹è¯•æŠ€æœ¯æ ˆ

| æŠ€æœ¯ç»„ä»¶ | ç‰ˆæœ¬/è¯´æ˜ | ç”¨é€” |
|---------|----------|------|
| Jest | æµ‹è¯•æ¡†æ¶ | å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•æ‰§è¡Œ |
| Sequelize | ORM | æ•°æ®åº“æ“ä½œã€äº‹åŠ¡ç®¡ç† |
| MySQL | restaurant_points_dev | çœŸå®æ•°æ®åº“æµ‹è¯•ï¼ˆä¸ä½¿ç”¨Mockï¼‰ |
| Redis | ç¼“å­˜/åˆ†å¸ƒå¼é” | å¹‚ç­‰æ€§ã€é™æµæµ‹è¯• |
| supertest | HTTPæµ‹è¯• | APIç«¯ç‚¹æµ‹è¯• |
| socket.io-client | WebSocketæµ‹è¯• | å®æ—¶é€šä¿¡æµ‹è¯• |

### 1.2 æ ¸å¿ƒæŠ€æœ¯è§„èŒƒ

```javascript
// âœ… æœåŠ¡è·å–æ–¹å¼ï¼šé€šè¿‡ ServiceManagerï¼ˆsnake_case keyï¼‰
const AssetService = global.getTestService('asset')
const IdempotencyService = global.getTestService('idempotency')

// âœ… æµ‹è¯•æ•°æ®è·å–ï¼šä» global.testData åŠ¨æ€è·å–
const testUserId = global.testData.testUser.user_id
const testCampaignId = global.testData.testCampaign.campaign_id

// âœ… äº‹åŠ¡è¾¹ç•Œï¼šè·¨è¡¨å†™å…¥å¿…é¡»ä¼ å…¥å¤–éƒ¨äº‹åŠ¡
await AssetService.changeBalance(params, { transaction })

// âœ… å‘½åè§„èŒƒï¼šå…¨å±€ snake_case
// âŒ ç¦æ­¢ï¼šcamelCaseï¼ˆå¦‚ getUserIdï¼‰
// âœ… æ­£ç¡®ï¼šsnake_caseï¼ˆå¦‚ get_user_idï¼‰
```

### 1.3 æµ‹è¯•æ–‡ä»¶ç»“æ„è§„èŒƒ

```
tests/
â”œâ”€â”€ helpers/                    # æµ‹è¯•åŸºç¡€è®¾æ–½
â”‚   â”œâ”€â”€ UnifiedTestManager.js   # ServiceManageré›†æˆ
â”‚   â”œâ”€â”€ test-setup.js           # æµ‹è¯•ç¯å¢ƒåˆå§‹åŒ–
â”‚   â”œâ”€â”€ test-data.js            # ç»Ÿä¸€æµ‹è¯•æ•°æ®ç®¡ç†
â”‚   â””â”€â”€ test-concurrent-utils.js # å¹¶å‘æµ‹è¯•å·¥å…·
â”œâ”€â”€ services/                   # æœåŠ¡å±‚å•å…ƒæµ‹è¯•ï¼ˆå¾…è¡¥å……ï¼‰
â”œâ”€â”€ integration/                # é›†æˆæµ‹è¯•
â”œâ”€â”€ business/                   # ä¸šåŠ¡æµ‹è¯•
â””â”€â”€ specialized/                # ç‰¹æ®Šåœºæ™¯æµ‹è¯•
```

---

## äºŒã€æµ‹è¯•ä½“ç³»ç°çŠ¶è¯„ä¼°

### 2.1 æµ‹è¯•æ–‡ä»¶åˆ†å¸ƒç»Ÿè®¡

| æµ‹è¯•ç±»å‹ | ç›®å½• | æ–‡ä»¶æ•° | æµ‹è¯•ç”¨ä¾‹æ•° | è¦†ç›–çŠ¶æ€ |
|---------|------|--------|-----------|---------|
| é›†æˆæµ‹è¯• | `tests/integration/` | 30 | ~558 | âœ… å…¨é¢ |
| ä¸šåŠ¡æµ‹è¯• | `tests/business/` | 34 | ~671 | âœ… å…¨é¢ |
| æœåŠ¡æµ‹è¯• | `tests/services/` | 22 | ~619 | âš ï¸ å¯è¡¥å…… |
| APIå¥‘çº¦æµ‹è¯• | `tests/api-contracts/` | 8 | ~80 | âœ… å®Œå–„ |
| E2Eæµ‹è¯• | `tests/e2e/` | 3 | ~45 | âœ… å®Œå–„ |
| ç‰¹æ®Šåœºæ™¯æµ‹è¯• | `tests/specialized/` | 10 | ~200 | âœ… å…¨é¢ |
| æ··æ²Œå·¥ç¨‹æµ‹è¯• | `tests/chaos/` | 5 | ~50 | âœ… å®Œå–„ |
| å®šæ—¶ä»»åŠ¡æµ‹è¯• | `tests/jobs/` | 11 | ~80 | âœ… å®Œå–„ |
| æ ¸å¿ƒæµ‹è¯• | `tests/core/` | 7 | ~60 | âœ… å®Œå–„ |
| ä¸­é—´ä»¶æµ‹è¯• | `tests/middleware/` | 4 | ~40 | âœ… å®Œå–„ |
| å®‰å…¨æµ‹è¯• | `tests/security/` | 8 | ~70 | âœ… å®Œå–„ |
| å•å…ƒæµ‹è¯• | `tests/unit/` | 12 | ~150 | âœ… å®Œå–„ |

### 2.2 é«˜å¹¶å‘æµ‹è¯•èƒ½åŠ›ç°çŠ¶

```
ç°æœ‰å¹¶å‘æµ‹è¯•è§„æ¨¡ï¼š
â”œâ”€â”€ 10,000å¹¶å‘ç§’æ€æµ‹è¯•ï¼ˆflash_sale_10000.test.jsï¼‰        âœ… å·²å®ç°
â”œâ”€â”€ 5,000å¹¶å‘å‹åŠ›æµ‹è¯•ï¼ˆhigh_concurrency_5000.test.jsï¼‰    âœ… å·²å®ç°
â”œâ”€â”€ 5,000çº§WebSocketè¿æ¥æµ‹è¯•ï¼ˆwebsocket_5000_connections.test.jsï¼‰âœ… å·²å®ç°
â”œâ”€â”€ æ··åˆè´Ÿè½½åœºæ™¯æµ‹è¯•ï¼ˆ1000æŠ½å¥–+500äº¤æ˜“+200èŠå¤©ï¼‰           âœ… å·²å®ç°
â”œâ”€â”€ é˜¶æ¢¯å¼å¢å‹æµ‹è¯•ï¼ˆ100â†’500â†’1000â†’2000â†’5000ï¼‰             âœ… å·²å®ç°
â”œâ”€â”€ 1,000å¹¶å‘æŠ½å¥–è¯·æ±‚ï¼ˆstress_test.test.jsï¼‰              âœ… å·²å®ç°
â””â”€â”€ 100äººåŒæ—¶æŠ¢è´­æµ‹è¯•                                      âœ… å·²å®ç°
```

---

## ä¸‰ã€å¯å®Œå–„çš„æµ‹è¯•ç©ºç™½åŒºåŸŸ

### 3.1 æœåŠ¡å±‚å•å…ƒæµ‹è¯•ç¼ºå£

#### 3.1.1 P0çº§ - æ ¸å¿ƒä¸šåŠ¡æœåŠ¡ï¼ˆç«‹å³è¡¥å……ï¼‰

| æœåŠ¡æ–‡ä»¶ | åŠŸèƒ½æè¿° | æµ‹è¯•çŠ¶æ€ | å»ºè®®æ–‡ä»¶å |
|---------|---------|---------|-----------|
| `AssetService.js` | èµ„äº§æ ¸å¿ƒæœåŠ¡ | âŒ æ— ç‹¬ç«‹å•å…ƒæµ‹è¯• | `AssetService.test.js` |
| `IdempotencyService.js` | å¹‚ç­‰æœåŠ¡ | âŒ æ— ç‹¬ç«‹å•å…ƒæµ‹è¯• | `IdempotencyService.test.js` |
| `AssetConversionService.js` | ç‰©æ–™è½¬æ¢æœåŠ¡ | âŒ æ— ç‹¬ç«‹å•å…ƒæµ‹è¯• | `AssetConversionService.test.js` |

#### 3.1.2 P1çº§ - é‡è¦ä¸šåŠ¡æœåŠ¡

| æœåŠ¡æ–‡ä»¶ | åŠŸèƒ½æè¿° | æµ‹è¯•çŠ¶æ€ | å»ºè®®æ–‡ä»¶å |
|---------|---------|---------|-----------|
| `DebtManagementService.js` | å€ºåŠ¡ç®¡ç†æœåŠ¡ | âŒ æ— ç‹¬ç«‹å•å…ƒæµ‹è¯• | `DebtManagementService.test.js` |
| `PrizePoolService.js` | å¥–æ± æœåŠ¡ | âŒ æ— ç‹¬ç«‹å•å…ƒæµ‹è¯• | `PrizePoolService.test.js` |
| `ExchangeService.js` | å…‘æ¢æœåŠ¡ | âŒ æ— ç‹¬ç«‹å•å…ƒæµ‹è¯• | `ExchangeService.test.js` |

#### 3.1.3 P2çº§ - æ”¯æ’‘åŠŸèƒ½æœåŠ¡

| æœåŠ¡æ–‡ä»¶ | åŠŸèƒ½æè¿° | æµ‹è¯•çŠ¶æ€ | å»ºè®®æ–‡ä»¶å |
|---------|---------|---------|-----------|
| `StoreService.js` | åº—é“ºæœåŠ¡ | âŒ æ— æµ‹è¯• | `StoreService.test.js` |
| `UserRoleService.js` | ç”¨æˆ·è§’è‰²æœåŠ¡ | âŒ æ— æµ‹è¯• | `UserRoleService.test.js` |
| `StaffManagementService.js` | å‘˜å·¥ç®¡ç†æœåŠ¡ | âŒ æ— æµ‹è¯• | `StaffManagementService.test.js` |
| `DictionaryService.js` | å­—å…¸é…ç½®æœåŠ¡ | âŒ æ— æµ‹è¯• | `DictionaryService.test.js` |
| `AnnouncementService.js` | å…¬å‘ŠæœåŠ¡ | âŒ æ— æµ‹è¯• | `AnnouncementService.test.js` |

---

## å››ã€æ‰§è¡Œæ­¥éª¤å’Œä»£ç å®ç°

### 4.1 P0-1: AssetService å•å…ƒæµ‹è¯•

**æ–‡ä»¶è·¯å¾„**: `tests/services/AssetService.test.js`

```javascript
/**
 * AssetService å•å…ƒæµ‹è¯•
 * èµ„äº§æ ¸å¿ƒæœåŠ¡æµ‹è¯•ï¼ˆä½™é¢æŸ¥è¯¢ã€è½¬è´¦ã€æ‰£å‡ã€å†»ç»“/è§£å†»ï¼‰
 *
 * åˆ›å»ºæ—¶é—´ï¼š2026-01-29 åŒ—äº¬æ—¶é—´
 * æŠ€æœ¯è§„èŒƒï¼š
 * - P1-9 J2-RepoWideï¼šé€šè¿‡ global.getTestService() è·å–æœåŠ¡
 * - E2-Strictï¼šä½¿ç”¨ snake_case å‘½å
 * - äº‹åŠ¡è¾¹ç•Œï¼šè·¨è¡¨å†™å…¥ä¼ å…¥å¤–éƒ¨äº‹åŠ¡
 */

'use strict'

const { sequelize, User, Account, AccountAssetBalance } = require('../../models')
const TransactionManager = require('../../utils/TransactionManager')
const { v4: uuidv4 } = require('uuid')

// é€šè¿‡ ServiceManager è·å–æœåŠ¡
let AssetService

// æµ‹è¯•è¶…æ—¶è®¾ç½®
jest.setTimeout(30000)

describe('AssetService - èµ„äº§æ ¸å¿ƒæœåŠ¡', () => {
  // æµ‹è¯•æ•°æ®
  let test_user_id
  let test_account_id

  beforeAll(async () => {
    // æ•°æ®åº“è¿æ¥éªŒè¯
    await sequelize.authenticate()
    console.log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ')

    // è·å–æœåŠ¡å®ä¾‹ï¼ˆP1-9 è§„èŒƒï¼‰
    AssetService = global.getTestService('asset')
    expect(AssetService).toBeDefined()

    // è·å–æµ‹è¯•ç”¨æˆ·
    if (global.testData && global.testData.testUser) {
      test_user_id = global.testData.testUser.user_id
    } else {
      const user = await User.findOne({ where: { mobile: '13612227930' } })
      test_user_id = user?.user_id
    }

    expect(test_user_id).toBeDefined()
    console.log(`ğŸ‘¤ æµ‹è¯•ç”¨æˆ·ID: ${test_user_id}`)
  })

  afterAll(async () => {
    console.log('ğŸ AssetService æµ‹è¯•å®Œæˆ')
  })

  // ==================== è´¦æˆ·ç®¡ç†æµ‹è¯• ====================

  describe('getOrCreateAccount - è´¦æˆ·è·å–/åˆ›å»º', () => {
    test('åº”è¯¥è·å–å·²å­˜åœ¨çš„ç”¨æˆ·è´¦æˆ·', async () => {
      await TransactionManager.execute(async (transaction) => {
        const account = await AssetService.getOrCreateAccount(
          { user_id: test_user_id },
          { transaction }
        )

        expect(account).toBeDefined()
        expect(account.account_type).toBe('user')
        expect(account.user_id).toBe(test_user_id)
        expect(account.status).toBe('active')

        test_account_id = account.account_id
      })
    })

    test('åº”è¯¥è·å–ç³»ç»Ÿè´¦æˆ·', async () => {
      await TransactionManager.execute(async (transaction) => {
        const account = await AssetService.getOrCreateAccount(
          { system_code: 'SYSTEM_PLATFORM_FEE' },
          { transaction }
        )

        expect(account).toBeDefined()
        expect(account.account_type).toBe('system')
        expect(account.system_code).toBe('SYSTEM_PLATFORM_FEE')
      })
    })

    test('user_id å’Œ system_code åŒæ—¶æä¾›åº”æŠ¥é”™', async () => {
      await expect(
        TransactionManager.execute(async (transaction) => {
          await AssetService.getOrCreateAccount(
            { user_id: test_user_id, system_code: 'SYSTEM_PLATFORM_FEE' },
            { transaction }
          )
        })
      ).rejects.toThrow('user_id å’Œ system_code ä¸èƒ½åŒæ—¶æä¾›')
    })

    test('æ— å‚æ•°åº”æŠ¥é”™', async () => {
      await expect(
        TransactionManager.execute(async (transaction) => {
          await AssetService.getOrCreateAccount({}, { transaction })
        })
      ).rejects.toThrow('user_id æˆ– system_code å¿…é¡»æä¾›å…¶ä¸­ä¹‹ä¸€')
    })
  })

  // ==================== ä½™é¢æ“ä½œæµ‹è¯• ====================

  describe('getOrCreateBalance - ä½™é¢è·å–/åˆ›å»º', () => {
    test('åº”è¯¥è·å– POINTS ä½™é¢', async () => {
      await TransactionManager.execute(async (transaction) => {
        const balance = await AssetService.getOrCreateBalance(
          { user_id: test_user_id, asset_code: 'POINTS' },
          { transaction }
        )

        expect(balance).toBeDefined()
        expect(balance.asset_code).toBe('POINTS')
        expect(typeof balance.available_balance).toBe('number')
        expect(typeof balance.frozen_balance).toBe('number')
        expect(balance.available_balance).toBeGreaterThanOrEqual(0)
      })
    })

    test('åº”è¯¥è·å– DIAMOND ä½™é¢', async () => {
      await TransactionManager.execute(async (transaction) => {
        const balance = await AssetService.getOrCreateBalance(
          { user_id: test_user_id, asset_code: 'DIAMOND' },
          { transaction }
        )

        expect(balance).toBeDefined()
        expect(balance.asset_code).toBe('DIAMOND')
      })
    })
  })

  describe('getBalance - ä½™é¢æŸ¥è¯¢', () => {
    test('åº”è¯¥è¿”å›å¯ç”¨ä½™é¢å’Œå†»ç»“ä½™é¢', async () => {
      const balance = await AssetService.getBalance({
        user_id: test_user_id,
        asset_code: 'POINTS'
      })

      expect(balance).toBeDefined()
      expect(typeof balance.available).toBe('number')
      expect(typeof balance.frozen).toBe('number')
      expect(typeof balance.total).toBe('number')
      expect(balance.total).toBe(balance.available + balance.frozen)
    })
  })

  // ==================== ä½™é¢å˜åŠ¨æµ‹è¯• ====================

  describe('changeBalance - ä½™é¢å˜åŠ¨', () => {
    test('å¢åŠ ä½™é¢åº”æˆåŠŸ', async () => {
      const idempotency_key = `test_add_${uuidv4()}`
      const add_amount = 100

      await TransactionManager.execute(async (transaction) => {
        // è·å–å˜åŠ¨å‰ä½™é¢
        const before_balance = await AssetService.getBalance({
          user_id: test_user_id,
          asset_code: 'POINTS'
        })

        // æ‰§è¡Œå¢åŠ 
        const result = await AssetService.changeBalance({
          user_id: test_user_id,
          asset_code: 'POINTS',
          amount: add_amount,
          business_type: 'test_add',
          idempotency_key,
          description: 'å•å…ƒæµ‹è¯•-å¢åŠ ä½™é¢'
        }, { transaction })

        expect(result).toBeDefined()
        expect(result.after_balance).toBe(before_balance.available + add_amount)
      })
    })

    test('æ‰£å‡ä½™é¢åº”æˆåŠŸï¼ˆä½™é¢å……è¶³ï¼‰', async () => {
      const idempotency_key = `test_deduct_${uuidv4()}`
      const deduct_amount = -10 // è´Ÿæ•°è¡¨ç¤ºæ‰£å‡

      await TransactionManager.execute(async (transaction) => {
        // å…ˆå¢åŠ ä½™é¢ç¡®ä¿è¶³å¤Ÿ
        await AssetService.changeBalance({
          user_id: test_user_id,
          asset_code: 'POINTS',
          amount: 100,
          business_type: 'test_prepare',
          idempotency_key: `prepare_${uuidv4()}`,
          description: 'æµ‹è¯•å‡†å¤‡-å¢åŠ ä½™é¢'
        }, { transaction })

        // æ‰§è¡Œæ‰£å‡
        const result = await AssetService.changeBalance({
          user_id: test_user_id,
          asset_code: 'POINTS',
          amount: deduct_amount,
          business_type: 'test_deduct',
          idempotency_key,
          description: 'å•å…ƒæµ‹è¯•-æ‰£å‡ä½™é¢'
        }, { transaction })

        expect(result).toBeDefined()
        expect(result.delta).toBe(deduct_amount)
      })
    })

    test('ä½™é¢ä¸è¶³åº”æŠ›å‡ºå¼‚å¸¸', async () => {
      const idempotency_key = `test_insufficient_${uuidv4()}`

      await expect(
        TransactionManager.execute(async (transaction) => {
          await AssetService.changeBalance({
            user_id: test_user_id,
            asset_code: 'POINTS',
            amount: -999999999, // å·¨é¢æ‰£å‡
            business_type: 'test_insufficient',
            idempotency_key,
            description: 'æµ‹è¯•ä½™é¢ä¸è¶³'
          }, { transaction })
        })
      ).rejects.toThrow()
    })

    test('æ— äº‹åŠ¡åº”æŠ›å‡ºå¼‚å¸¸', async () => {
      await expect(
        AssetService.changeBalance({
          user_id: test_user_id,
          asset_code: 'POINTS',
          amount: 10,
          business_type: 'test_no_tx',
          idempotency_key: `no_tx_${uuidv4()}`,
          description: 'æµ‹è¯•æ— äº‹åŠ¡'
        }, {}) // ä¸ä¼ äº‹åŠ¡
      ).rejects.toThrow('å¿…é¡»åœ¨äº‹åŠ¡ä¸­è°ƒç”¨')
    })
  })

  // ==================== å†»ç»“/è§£å†»æµ‹è¯• ====================

  describe('freeze/unfreeze - å†»ç»“è§£å†»', () => {
    test('å†»ç»“èµ„äº§åº”æˆåŠŸ', async () => {
      const idempotency_key = `test_freeze_${uuidv4()}`
      const freeze_amount = 50

      await TransactionManager.execute(async (transaction) => {
        // å…ˆå¢åŠ ä½™é¢
        await AssetService.changeBalance({
          user_id: test_user_id,
          asset_code: 'POINTS',
          amount: 100,
          business_type: 'test_prepare_freeze',
          idempotency_key: `prepare_freeze_${uuidv4()}`,
          description: 'å‡†å¤‡å†»ç»“æµ‹è¯•'
        }, { transaction })

        // æ‰§è¡Œå†»ç»“
        const result = await AssetService.freeze({
          user_id: test_user_id,
          asset_code: 'POINTS',
          amount: freeze_amount,
          business_type: 'test_freeze',
          idempotency_key,
          description: 'å•å…ƒæµ‹è¯•-å†»ç»“èµ„äº§'
        }, { transaction })

        expect(result).toBeDefined()
        expect(result.frozen_amount).toBe(freeze_amount)
      })
    })
  })

  // ==================== å¹‚ç­‰æ€§æµ‹è¯• ====================

  describe('å¹‚ç­‰æ€§ä¿æŠ¤', () => {
    test('ç›¸åŒå¹‚ç­‰é”®é‡å¤è¯·æ±‚åº”è¿”å›é¦–æ¬¡ç»“æœ', async () => {
      const idempotency_key = `test_idempotent_${uuidv4()}`
      const amount = 10

      // ç¬¬ä¸€æ¬¡è¯·æ±‚
      const result1 = await TransactionManager.execute(async (transaction) => {
        return await AssetService.changeBalance({
          user_id: test_user_id,
          asset_code: 'POINTS',
          amount,
          business_type: 'test_idempotent',
          idempotency_key,
          description: 'å¹‚ç­‰æµ‹è¯•-é¦–æ¬¡'
        }, { transaction })
      })

      // ç¬¬äºŒæ¬¡è¯·æ±‚ï¼ˆç›¸åŒå¹‚ç­‰é”®ï¼‰
      const result2 = await TransactionManager.execute(async (transaction) => {
        return await AssetService.changeBalance({
          user_id: test_user_id,
          asset_code: 'POINTS',
          amount,
          business_type: 'test_idempotent',
          idempotency_key,
          description: 'å¹‚ç­‰æµ‹è¯•-é‡å¤'
        }, { transaction })
      })

      // éªŒè¯å¹‚ç­‰æ€§
      expect(result2.is_duplicate).toBe(true)
      expect(result2.transaction_id).toBe(result1.transaction_id)
    })
  })

  // ==================== è¾¹ç•Œæ¡ä»¶æµ‹è¯• ====================

  describe('è¾¹ç•Œæ¡ä»¶', () => {
    test('ä½™é¢åˆšå¥½ä¸º0æ—¶æ‰£å‡åº”å¤±è´¥', async () => {
      const idempotency_key = `test_zero_balance_${uuidv4()}`

      // åˆ›å»ºæ–°çš„èµ„äº§ç±»å‹æµ‹è¯•ï¼ˆé¿å…å½±å“å…¶ä»–æµ‹è¯•ï¼‰
      await expect(
        TransactionManager.execute(async (transaction) => {
          // è·å–å½“å‰ä½™é¢
          const balance = await AssetService.getBalance({
            user_id: test_user_id,
            asset_code: 'POINTS'
          })

          // å°è¯•æ‰£å‡è¶…è¿‡å¯ç”¨ä½™é¢
          await AssetService.changeBalance({
            user_id: test_user_id,
            asset_code: 'POINTS',
            amount: -(balance.available + 1),
            business_type: 'test_over_deduct',
            idempotency_key,
            description: 'æµ‹è¯•è¶…é¢æ‰£å‡'
          }, { transaction })
        })
      ).rejects.toThrow()
    })

    test('å¤§é¢ä½™é¢æ“ä½œåº”æ­£å¸¸å¤„ç†', async () => {
      const idempotency_key = `test_large_amount_${uuidv4()}`
      const large_amount = 1000000 // 100ä¸‡

      await TransactionManager.execute(async (transaction) => {
        const result = await AssetService.changeBalance({
          user_id: test_user_id,
          asset_code: 'POINTS',
          amount: large_amount,
          business_type: 'test_large',
          idempotency_key,
          description: 'å¤§é¢æ“ä½œæµ‹è¯•'
        }, { transaction })

        expect(result).toBeDefined()
        expect(result.delta).toBe(large_amount)
      })
    })
  })
})
```

---

### 4.2 P0-2: IdempotencyService å•å…ƒæµ‹è¯•

**æ–‡ä»¶è·¯å¾„**: `tests/services/IdempotencyService.test.js`

```javascript
/**
 * IdempotencyService å•å…ƒæµ‹è¯•
 * å…¥å£å¹‚ç­‰æœåŠ¡æµ‹è¯•ï¼ˆé‡å¤è¯·æ±‚æ£€æµ‹ã€è¶…æ—¶å¤„ç†ã€æ¸…ç†ï¼‰
 *
 * åˆ›å»ºæ—¶é—´ï¼š2026-01-29 åŒ—äº¬æ—¶é—´
 * æŠ€æœ¯è§„èŒƒï¼š
 * - P1-9 J2-RepoWideï¼šé€šè¿‡ global.getTestService() è·å–æœåŠ¡
 * - E2-Strictï¼šä½¿ç”¨ snake_case å‘½å
 */

'use strict'

const { sequelize } = require('../../models')
const { v4: uuidv4 } = require('uuid')

// é€šè¿‡ ServiceManager è·å–æœåŠ¡
let IdempotencyService

jest.setTimeout(30000)

describe('IdempotencyService - å…¥å£å¹‚ç­‰æœåŠ¡', () => {
  let test_user_id

  beforeAll(async () => {
    await sequelize.authenticate()
    console.log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ')

    // è·å–æœåŠ¡å®ä¾‹
    IdempotencyService = global.getTestService('idempotency')
    expect(IdempotencyService).toBeDefined()

    // è·å–æµ‹è¯•ç”¨æˆ·ID
    if (global.testData && global.testData.testUser) {
      test_user_id = global.testData.testUser.user_id
    }
  })

  afterAll(async () => {
    console.log('ğŸ IdempotencyService æµ‹è¯•å®Œæˆ')
  })

  // ==================== æ ¸å¿ƒåŠŸèƒ½æµ‹è¯• ====================

  describe('getOrCreateRequest - å¹‚ç­‰è¯·æ±‚è·å–/åˆ›å»º', () => {
    test('æ–°è¯·æ±‚åº”åˆ›å»º processing çŠ¶æ€è®°å½•', async () => {
      const idempotency_key = `test_new_${uuidv4()}`

      const result = await IdempotencyService.getOrCreateRequest({
        idempotency_key,
        user_id: test_user_id,
        canonical_operation: 'TEST_OPERATION',
        fingerprint: 'test_fingerprint_hash'
      })

      expect(result).toBeDefined()
      expect(result.is_new).toBe(true)
      expect(result.status).toBe('processing')
      expect(result.idempotency_key).toBe(idempotency_key)
    })

    test('é‡å¤è¯·æ±‚ï¼ˆprocessing çŠ¶æ€ï¼‰åº”è¿”å›ç­‰å¾…ç»“æœ', async () => {
      const idempotency_key = `test_duplicate_${uuidv4()}`

      // ç¬¬ä¸€æ¬¡è¯·æ±‚
      await IdempotencyService.getOrCreateRequest({
        idempotency_key,
        user_id: test_user_id,
        canonical_operation: 'TEST_OPERATION',
        fingerprint: 'test_fingerprint_hash'
      })

      // ç¬¬äºŒæ¬¡è¯·æ±‚ï¼ˆç›¸åŒkeyï¼‰
      const result = await IdempotencyService.getOrCreateRequest({
        idempotency_key,
        user_id: test_user_id,
        canonical_operation: 'TEST_OPERATION',
        fingerprint: 'test_fingerprint_hash'
      })

      expect(result.is_new).toBe(false)
      expect(result.status).toBe('processing')
    })
  })

  describe('markAsCompleted - æ ‡è®°å®Œæˆ', () => {
    test('åº”æˆåŠŸæ ‡è®°è¯·æ±‚ä¸ºå®ŒæˆçŠ¶æ€', async () => {
      const idempotency_key = `test_complete_${uuidv4()}`

      // åˆ›å»ºè¯·æ±‚
      await IdempotencyService.getOrCreateRequest({
        idempotency_key,
        user_id: test_user_id,
        canonical_operation: 'TEST_OPERATION',
        fingerprint: 'test_fingerprint_hash'
      })

      // æ ‡è®°å®Œæˆ
      const result = await IdempotencyService.markAsCompleted(idempotency_key, {
        success: true,
        data: { test_result: 'success' }
      })

      expect(result).toBeDefined()

      // å†æ¬¡è·å–åº”è¿”å›å·²å®ŒæˆçŠ¶æ€å’Œç»“æœå¿«ç…§
      const check = await IdempotencyService.getOrCreateRequest({
        idempotency_key,
        user_id: test_user_id,
        canonical_operation: 'TEST_OPERATION',
        fingerprint: 'test_fingerprint_hash'
      })

      expect(check.status).toBe('completed')
      expect(check.response_snapshot).toBeDefined()
    })
  })

  describe('markAsFailed - æ ‡è®°å¤±è´¥', () => {
    test('åº”æˆåŠŸæ ‡è®°è¯·æ±‚ä¸ºå¤±è´¥çŠ¶æ€', async () => {
      const idempotency_key = `test_failed_${uuidv4()}`

      // åˆ›å»ºè¯·æ±‚
      await IdempotencyService.getOrCreateRequest({
        idempotency_key,
        user_id: test_user_id,
        canonical_operation: 'TEST_OPERATION',
        fingerprint: 'test_fingerprint_hash'
      })

      // æ ‡è®°å¤±è´¥
      await IdempotencyService.markAsFailed(idempotency_key, {
        error_code: 'TEST_ERROR',
        error_message: 'æµ‹è¯•é”™è¯¯'
      })

      // å†æ¬¡è·å–åº”è¿”å›å¤±è´¥çŠ¶æ€
      const check = await IdempotencyService.getOrCreateRequest({
        idempotency_key,
        user_id: test_user_id,
        canonical_operation: 'TEST_OPERATION',
        fingerprint: 'test_fingerprint_hash'
      })

      expect(check.status).toBe('failed')
    })
  })

  // ==================== å¹¶å‘å®‰å…¨æµ‹è¯• ====================

  describe('å¹¶å‘å®‰å…¨', () => {
    test('100å¹¶å‘ç›¸åŒkeyåªæœ‰1ä¸ªæˆåŠŸåˆ›å»º', async () => {
      const idempotency_key = `test_concurrent_${uuidv4()}`
      const concurrent_count = 100

      const promises = Array(concurrent_count).fill(null).map(() =>
        IdempotencyService.getOrCreateRequest({
          idempotency_key,
          user_id: test_user_id,
          canonical_operation: 'TEST_CONCURRENT',
          fingerprint: 'concurrent_test_hash'
        })
      )

      const results = await Promise.all(promises)

      // ç»Ÿè®¡æ–°åˆ›å»ºæ•°é‡
      const new_count = results.filter(r => r.is_new).length

      expect(new_count).toBe(1) // åªæœ‰1ä¸ªæ–°åˆ›å»º
      expect(results.length - new_count).toBe(concurrent_count - 1) // å…¶ä½™éƒ½æ˜¯é‡å¤
    })
  })

  // ==================== è¶…æ—¶å¤„ç†æµ‹è¯• ====================

  describe('è¶…æ—¶å¤„ç†', () => {
    test('autoFailProcessingTimeout åº”å°†è¶…æ—¶è®°å½•è½¬ä¸º failed', async () => {
      // æ³¨æ„ï¼šæ­¤æµ‹è¯•ä¾èµ–äº PROCESSING_TIMEOUT_SECONDS é…ç½®
      // å®é™…ç”Ÿäº§ä¸­è¶…æ—¶æ—¶é—´ä¸º60ç§’ï¼Œæµ‹è¯•ä¸­å¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†

      const count = await IdempotencyService.autoFailProcessingTimeout()

      expect(typeof count).toBe('number')
      expect(count).toBeGreaterThanOrEqual(0)
    })
  })

  // ==================== æ¸…ç†æµ‹è¯• ====================

  describe('cleanupExpired - è¿‡æœŸæ¸…ç†', () => {
    test('åº”æ¸…ç†è¶…è¿‡TTLçš„è®°å½•', async () => {
      const count = await IdempotencyService.cleanupExpired()

      expect(typeof count).toBe('number')
      expect(count).toBeGreaterThanOrEqual(0)
    })
  })
})
```

---

### 4.3 P0-3: AssetConversionService å•å…ƒæµ‹è¯•

**æ–‡ä»¶è·¯å¾„**: `tests/services/AssetConversionService.test.js`

```javascript
/**
 * AssetConversionService å•å…ƒæµ‹è¯•
 * èµ„äº§è½¬æ¢æœåŠ¡æµ‹è¯•ï¼ˆææ–™è½¬æ¢ã€è§„åˆ™éªŒè¯ã€æ‰‹ç»­è´¹è®¡ç®—ï¼‰
 *
 * åˆ›å»ºæ—¶é—´ï¼š2026-01-29 åŒ—äº¬æ—¶é—´
 * æŠ€æœ¯è§„èŒƒï¼š
 * - P1-9 J2-RepoWideï¼šé€šè¿‡ global.getTestService() è·å–æœåŠ¡
 * - äº‹åŠ¡è¾¹ç•Œï¼šæ‰€æœ‰å†™æ“ä½œå¿…é¡»ä¼ å…¥å¤–éƒ¨äº‹åŠ¡
 */

'use strict'

const { sequelize, MaterialConversionRule } = require('../../models')
const TransactionManager = require('../../utils/TransactionManager')
const { v4: uuidv4 } = require('uuid')

let AssetConversionService
let AssetService

jest.setTimeout(30000)

describe('AssetConversionService - èµ„äº§è½¬æ¢æœåŠ¡', () => {
  let test_user_id

  beforeAll(async () => {
    await sequelize.authenticate()
    console.log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ')

    // è·å–æœåŠ¡å®ä¾‹
    AssetConversionService = global.getTestService('asset_conversion')
    AssetService = global.getTestService('asset')

    expect(AssetConversionService).toBeDefined()
    expect(AssetService).toBeDefined()

    // è·å–æµ‹è¯•ç”¨æˆ·ID
    if (global.testData && global.testData.testUser) {
      test_user_id = global.testData.testUser.user_id
    }

    console.log(`ğŸ‘¤ æµ‹è¯•ç”¨æˆ·ID: ${test_user_id}`)
  })

  afterAll(async () => {
    console.log('ğŸ AssetConversionService æµ‹è¯•å®Œæˆ')
  })

  // ==================== è§„åˆ™æŸ¥è¯¢æµ‹è¯• ====================

  describe('getConversionRules - è·å–è½¬æ¢è§„åˆ™', () => {
    test('åº”è¿”å›å¯ç”¨çš„è½¬æ¢è§„åˆ™åˆ—è¡¨', async () => {
      const rules = await AssetConversionService.getConversionRules()

      expect(Array.isArray(rules)).toBe(true)

      if (rules.length > 0) {
        const rule = rules[0]
        expect(rule).toHaveProperty('rule_id')
        expect(rule).toHaveProperty('from_asset_code')
        expect(rule).toHaveProperty('to_asset_code')
        expect(rule).toHaveProperty('conversion_rate')
        expect(rule).toHaveProperty('status')
      }
    })

    test('åº”åªè¿”å›å¯ç”¨çŠ¶æ€çš„è§„åˆ™', async () => {
      const rules = await AssetConversionService.getConversionRules()

      rules.forEach(rule => {
        expect(rule.status).toBe('active')
      })
    })
  })

  // ==================== è½¬æ¢åŠŸèƒ½æµ‹è¯• ====================

  describe('convertMaterial - ææ–™è½¬æ¢', () => {
    test('æœ‰æ•ˆè½¬æ¢è§„åˆ™åº”æˆåŠŸæ‰§è¡Œ', async () => {
      // æŸ¥æ‰¾ä¸€æ¡æœ‰æ•ˆçš„è½¬æ¢è§„åˆ™
      const rules = await AssetConversionService.getConversionRules()
      if (rules.length === 0) {
        console.warn('âš ï¸ æ— å¯ç”¨è½¬æ¢è§„åˆ™ï¼Œè·³è¿‡æµ‹è¯•')
        return
      }

      const rule = rules[0]
      const idempotency_key = `test_convert_${uuidv4()}`

      await TransactionManager.execute(async (transaction) => {
        // å…ˆç¡®ä¿ç”¨æˆ·æœ‰è¶³å¤Ÿçš„æºèµ„äº§
        await AssetService.changeBalance({
          user_id: test_user_id,
          asset_code: rule.from_asset_code,
          amount: rule.min_from_amount || 100,
          business_type: 'test_prepare_convert',
          idempotency_key: `prepare_convert_${uuidv4()}`,
          description: 'å‡†å¤‡è½¬æ¢æµ‹è¯•'
        }, { transaction })

        // æ‰§è¡Œè½¬æ¢
        const result = await AssetConversionService.convertMaterial({
          user_id: test_user_id,
          from_asset_code: rule.from_asset_code,
          to_asset_code: rule.to_asset_code,
          from_amount: rule.min_from_amount || 10,
          idempotency_key
        }, { transaction })

        expect(result).toBeDefined()
        expect(result.from_asset_code).toBe(rule.from_asset_code)
        expect(result.to_asset_code).toBe(rule.to_asset_code)
        expect(result.from_amount).toBe(rule.min_from_amount || 10)
        expect(result.to_amount).toBeGreaterThan(0)
      })
    })

    test('æ— æ•ˆè½¬æ¢è§„åˆ™åº”æŠ›å‡ºé”™è¯¯', async () => {
      const idempotency_key = `test_invalid_rule_${uuidv4()}`

      await expect(
        TransactionManager.execute(async (transaction) => {
          await AssetConversionService.convertMaterial({
            user_id: test_user_id,
            from_asset_code: 'INVALID_ASSET',
            to_asset_code: 'ALSO_INVALID',
            from_amount: 100,
            idempotency_key
          }, { transaction })
        })
      ).rejects.toThrow()
    })

    test('ä½™é¢ä¸è¶³åº”æŠ›å‡ºé”™è¯¯', async () => {
      const rules = await AssetConversionService.getConversionRules()
      if (rules.length === 0) {
        console.warn('âš ï¸ æ— å¯ç”¨è½¬æ¢è§„åˆ™ï¼Œè·³è¿‡æµ‹è¯•')
        return
      }

      const rule = rules[0]
      const idempotency_key = `test_insufficient_convert_${uuidv4()}`

      await expect(
        TransactionManager.execute(async (transaction) => {
          await AssetConversionService.convertMaterial({
            user_id: test_user_id,
            from_asset_code: rule.from_asset_code,
            to_asset_code: rule.to_asset_code,
            from_amount: 999999999, // å·¨é¢è½¬æ¢
            idempotency_key
          }, { transaction })
        })
      ).rejects.toThrow()
    })

    test('æ— äº‹åŠ¡åº”æŠ›å‡ºé”™è¯¯', async () => {
      await expect(
        AssetConversionService.convertMaterial({
          user_id: test_user_id,
          from_asset_code: 'red_shard',
          to_asset_code: 'DIAMOND',
          from_amount: 10,
          idempotency_key: `no_tx_${uuidv4()}`
        }, {}) // ä¸ä¼ äº‹åŠ¡
      ).rejects.toThrow()
    })
  })

  // ==================== å¹‚ç­‰æ€§æµ‹è¯• ====================

  describe('è½¬æ¢å¹‚ç­‰æ€§', () => {
    test('ç›¸åŒå¹‚ç­‰é”®é‡å¤è¯·æ±‚åº”è¿”å›é¦–æ¬¡ç»“æœ', async () => {
      const rules = await AssetConversionService.getConversionRules()
      if (rules.length === 0) {
        console.warn('âš ï¸ æ— å¯ç”¨è½¬æ¢è§„åˆ™ï¼Œè·³è¿‡æµ‹è¯•')
        return
      }

      const rule = rules[0]
      const idempotency_key = `test_convert_idempotent_${uuidv4()}`

      // å‡†å¤‡ä½™é¢
      await TransactionManager.execute(async (transaction) => {
        await AssetService.changeBalance({
          user_id: test_user_id,
          asset_code: rule.from_asset_code,
          amount: 200,
          business_type: 'test_prepare_idempotent',
          idempotency_key: `prepare_idempotent_${uuidv4()}`,
          description: 'å‡†å¤‡å¹‚ç­‰æµ‹è¯•'
        }, { transaction })
      })

      // ç¬¬ä¸€æ¬¡è½¬æ¢
      const result1 = await TransactionManager.execute(async (transaction) => {
        return await AssetConversionService.convertMaterial({
          user_id: test_user_id,
          from_asset_code: rule.from_asset_code,
          to_asset_code: rule.to_asset_code,
          from_amount: rule.min_from_amount || 10,
          idempotency_key
        }, { transaction })
      })

      // ç¬¬äºŒæ¬¡è½¬æ¢ï¼ˆç›¸åŒå¹‚ç­‰é”®ï¼‰
      const result2 = await TransactionManager.execute(async (transaction) => {
        return await AssetConversionService.convertMaterial({
          user_id: test_user_id,
          from_asset_code: rule.from_asset_code,
          to_asset_code: rule.to_asset_code,
          from_amount: rule.min_from_amount || 10,
          idempotency_key
        }, { transaction })
      })

      // éªŒè¯å¹‚ç­‰æ€§
      expect(result2.is_duplicate).toBe(true)
    })
  })

  // ==================== ä¾¿æ·æ–¹æ³•æµ‹è¯• ====================

  describe('convertRedShardToDiamond - ä¾¿æ·æ–¹æ³•', () => {
    test('ç¢çº¢æ°´æ™¶è½¬é’»çŸ³åº”æˆåŠŸ', async () => {
      const idempotency_key = `test_red_shard_${uuidv4()}`

      // æ£€æŸ¥æ˜¯å¦æœ‰ red_shard -> DIAMOND è§„åˆ™
      const rules = await AssetConversionService.getConversionRules()
      const shardRule = rules.find(r =>
        r.from_asset_code === 'red_shard' && r.to_asset_code === 'DIAMOND'
      )

      if (!shardRule) {
        console.warn('âš ï¸ æ—  red_shard -> DIAMOND è§„åˆ™ï¼Œè·³è¿‡æµ‹è¯•')
        return
      }

      await TransactionManager.execute(async (transaction) => {
        // å‡†å¤‡çº¢è‰²ç¢ç‰‡
        await AssetService.changeBalance({
          user_id: test_user_id,
          asset_code: 'red_shard',
          amount: 100,
          business_type: 'test_prepare_shard',
          idempotency_key: `prepare_shard_${uuidv4()}`,
          description: 'å‡†å¤‡ç¢ç‰‡è½¬æ¢æµ‹è¯•'
        }, { transaction })

        // æ‰§è¡Œä¾¿æ·æ–¹æ³•
        const result = await AssetConversionService.convertRedShardToDiamond({
          user_id: test_user_id,
          shard_amount: shardRule.min_from_amount || 10,
          idempotency_key
        }, { transaction })

        expect(result).toBeDefined()
        expect(result.from_asset_code).toBe('red_shard')
        expect(result.to_asset_code).toBe('DIAMOND')
      })
    })
  })
})
```

---

### 4.4 P1-1: è¾¹ç•Œæ¡ä»¶æµ‹è¯•

**æ–‡ä»¶è·¯å¾„**: `tests/integration/balance_boundary.test.js`

```javascript
/**
 * ä½™é¢è¾¹ç•Œæ¡ä»¶æµ‹è¯•
 * éªŒè¯èµ„äº§ç³»ç»Ÿåœ¨è¾¹ç•Œæ¡ä»¶ä¸‹çš„è¡Œä¸º
 *
 * åˆ›å»ºæ—¶é—´ï¼š2026-01-29 åŒ—äº¬æ—¶é—´
 */

'use strict'

const { sequelize } = require('../../models')
const TransactionManager = require('../../utils/TransactionManager')
const { v4: uuidv4 } = require('uuid')

let AssetService

jest.setTimeout(60000)

describe('ä½™é¢è¾¹ç•Œæ¡ä»¶æµ‹è¯•', () => {
  let test_user_id

  beforeAll(async () => {
    await sequelize.authenticate()
    AssetService = global.getTestService('asset')

    if (global.testData && global.testData.testUser) {
      test_user_id = global.testData.testUser.user_id
    }
  })

  describe('é›¶ä½™é¢è¾¹ç•Œ', () => {
    test('ä½™é¢åˆšå¥½ç­‰äºæ‰£å‡é‡‘é¢æ—¶åº”æˆåŠŸ', async () => {
      const test_asset = 'POINTS'
      const idempotency_prefix = `zero_boundary_${uuidv4()}`

      await TransactionManager.execute(async (transaction) => {
        // è·å–å½“å‰ä½™é¢
        const current = await AssetService.getBalance({
          user_id: test_user_id,
          asset_code: test_asset
        })

        // å¢åŠ ä¸€ä¸ªå›ºå®šé‡‘é¢
        const test_amount = 100
        await AssetService.changeBalance({
          user_id: test_user_id,
          asset_code: test_asset,
          amount: test_amount,
          business_type: 'boundary_test_add',
          idempotency_key: `${idempotency_prefix}_add`,
          description: 'è¾¹ç•Œæµ‹è¯•-å¢åŠ '
        }, { transaction })

        // æ‰£å‡ç›¸åŒé‡‘é¢ï¼ˆæ¨¡æ‹Ÿåˆšå¥½ç”¨å®Œï¼‰
        const result = await AssetService.changeBalance({
          user_id: test_user_id,
          asset_code: test_asset,
          amount: -test_amount,
          business_type: 'boundary_test_deduct',
          idempotency_key: `${idempotency_prefix}_deduct`,
          description: 'è¾¹ç•Œæµ‹è¯•-æ‰£å‡'
        }, { transaction })

        expect(result).toBeDefined()
        // æ‰£å‡åä½™é¢åº”è¯¥å›åˆ°åŸå€¼
        expect(result.after_balance).toBe(current.available)
      })
    })

    test('ä½™é¢ä¸º0æ—¶æ‰£å‡1åº”å¤±è´¥', async () => {
      // ä½¿ç”¨ä¸€ä¸ªä¸å¸¸ç”¨çš„èµ„äº§ç±»å‹æ¥æµ‹è¯•
      const test_asset = 'orange_shard' // å‡è®¾è¿™ä¸ªç”¨æˆ·ä½™é¢ä¸º0
      const idempotency_key = `zero_deduct_${uuidv4()}`

      // å…ˆæŸ¥è¯¢ä½™é¢
      const balance = await AssetService.getBalance({
        user_id: test_user_id,
        asset_code: test_asset
      })

      if (balance.available > 0) {
        console.log(`âš ï¸ ${test_asset} ä½™é¢ä¸ä¸º0ï¼Œè·³è¿‡æ­¤æµ‹è¯•`)
        return
      }

      await expect(
        TransactionManager.execute(async (transaction) => {
          await AssetService.changeBalance({
            user_id: test_user_id,
            asset_code: test_asset,
            amount: -1,
            business_type: 'zero_test',
            idempotency_key,
            description: 'é›¶ä½™é¢æ‰£å‡æµ‹è¯•'
          }, { transaction })
        })
      ).rejects.toThrow()
    })
  })

  describe('å¤§æ•°å€¼è¾¹ç•Œ', () => {
    test('å¢åŠ å¤§é¢ä½™é¢åº”æ­£å¸¸å¤„ç†', async () => {
      const large_amount = 100000000 // 1äº¿
      const idempotency_key = `large_add_${uuidv4()}`

      await TransactionManager.execute(async (transaction) => {
        const before = await AssetService.getBalance({
          user_id: test_user_id,
          asset_code: 'POINTS'
        })

        const result = await AssetService.changeBalance({
          user_id: test_user_id,
          asset_code: 'POINTS',
          amount: large_amount,
          business_type: 'large_test_add',
          idempotency_key,
          description: 'å¤§æ•°å€¼æµ‹è¯•'
        }, { transaction })

        expect(result.after_balance).toBe(before.available + large_amount)

        // æ¢å¤åŸçŠ¶
        await AssetService.changeBalance({
          user_id: test_user_id,
          asset_code: 'POINTS',
          amount: -large_amount,
          business_type: 'large_test_restore',
          idempotency_key: `${idempotency_key}_restore`,
          description: 'å¤§æ•°å€¼æµ‹è¯•-æ¢å¤'
        }, { transaction })
      })
    })
  })
})
```

---

### 4.5 P1-2: åˆ†å¸ƒå¼é”å‹åŠ›æµ‹è¯•

**æ–‡ä»¶è·¯å¾„**: `tests/integration/distributed_lock_stress.test.js`

```javascript
/**
 * åˆ†å¸ƒå¼é”å‹åŠ›æµ‹è¯•
 * éªŒè¯ Redis åˆ†å¸ƒå¼é”åœ¨é«˜å¹¶å‘ä¸‹çš„æ­£ç¡®æ€§
 *
 * åˆ›å»ºæ—¶é—´ï¼š2026-01-29 åŒ—äº¬æ—¶é—´
 */

'use strict'

const { sequelize } = require('../../models')
const { executeConcurrent } = require('../helpers/test-concurrent-utils')
const { v4: uuidv4 } = require('uuid')

jest.setTimeout(120000)

describe('åˆ†å¸ƒå¼é”å‹åŠ›æµ‹è¯•', () => {
  let DistributedLock

  beforeAll(async () => {
    await sequelize.authenticate()

    // å°è¯•è·å–åˆ†å¸ƒå¼é”æœåŠ¡
    try {
      DistributedLock = require('../../utils/DistributedLock')
    } catch (e) {
      console.warn('âš ï¸ DistributedLock ä¸å­˜åœ¨ï¼Œè·³è¿‡æµ‹è¯•')
    }
  })

  describe('é”ç«äº‰æµ‹è¯•', () => {
    test('100å¹¶å‘è·å–åŒä¸€æŠŠé”åªæœ‰1ä¸ªæˆåŠŸ', async () => {
      if (!DistributedLock) {
        console.warn('âš ï¸ è·³è¿‡ï¼šDistributedLock ä¸å¯ç”¨')
        return
      }

      const lock_key = `test_lock_${uuidv4()}`
      const concurrent_count = 100
      let success_count = 0

      const tasks = Array(concurrent_count).fill(null).map(() => async () => {
        try {
          const acquired = await DistributedLock.acquire(lock_key, {
            ttl: 5000,
            retries: 0 // ä¸é‡è¯•
          })

          if (acquired) {
            success_count++
            // æ¨¡æ‹ŸæŒæœ‰é”çš„æ“ä½œ
            await new Promise(resolve => setTimeout(resolve, 100))
            await DistributedLock.release(lock_key)
          }

          return acquired
        } catch (e) {
          return false
        }
      })

      await executeConcurrent(tasks, concurrent_count)

      // ç”±äºæ²¡æœ‰é‡è¯•ï¼Œåªæœ‰1ä¸ªèƒ½è·å–æˆåŠŸ
      expect(success_count).toBe(1)
    })

    test('é”è¶…æ—¶åè‡ªåŠ¨é‡Šæ”¾', async () => {
      if (!DistributedLock) {
        console.warn('âš ï¸ è·³è¿‡ï¼šDistributedLock ä¸å¯ç”¨')
        return
      }

      const lock_key = `test_ttl_lock_${uuidv4()}`

      // è·å–ä¸€æŠŠçŸ­TTLçš„é”
      const acquired1 = await DistributedLock.acquire(lock_key, {
        ttl: 1000 // 1ç§’è¶…æ—¶
      })
      expect(acquired1).toBe(true)

      // ç­‰å¾…é”è¶…æ—¶
      await new Promise(resolve => setTimeout(resolve, 1500))

      // å†æ¬¡è·å–åº”è¯¥æˆåŠŸï¼ˆé”å·²è‡ªåŠ¨é‡Šæ”¾ï¼‰
      const acquired2 = await DistributedLock.acquire(lock_key, {
        ttl: 5000
      })
      expect(acquired2).toBe(true)

      await DistributedLock.release(lock_key)
    })
  })
})
```

---

## äº”ã€æ‰§è¡Œè®¡åˆ’

### 5.1 ä¸€æ¬¡æ€§æŠ•å…¥æ‰§è¡Œé¡ºåº

```bash
# ç¬¬ä¸€æ‰¹ï¼šP0 æ ¸å¿ƒæœåŠ¡æµ‹è¯•ï¼ˆ1å¤©ï¼‰
# æ–‡ä»¶åˆ›å»ºé¡ºåºï¼š
1. tests/services/AssetService.test.js           # 4å°æ—¶
2. tests/services/IdempotencyService.test.js     # 2å°æ—¶
3. tests/services/AssetConversionService.test.js # 3å°æ—¶

# ç¬¬äºŒæ‰¹ï¼šP1 è¾¹ç•Œå’Œé”æµ‹è¯•ï¼ˆ0.5å¤©ï¼‰
4. tests/integration/balance_boundary.test.js       # 2å°æ—¶
5. tests/integration/distributed_lock_stress.test.js # 2å°æ—¶

# ç¬¬ä¸‰æ‰¹ï¼šP2 æ”¯æ’‘æœåŠ¡æµ‹è¯•ï¼ˆ1å¤©ï¼‰
6. tests/services/StoreService.test.js           # 2å°æ—¶
7. tests/services/UserRoleService.test.js        # 2å°æ—¶
8. tests/services/DebtManagementService.test.js  # 2å°æ—¶
9. tests/services/PrizePoolService.test.js       # 2å°æ—¶
```

### 5.2 éªŒè¯å‘½ä»¤

```bash
# è¿è¡Œå•ä¸ªæµ‹è¯•æ–‡ä»¶
npm test -- tests/services/AssetService.test.js --verbose

# è¿è¡Œæ‰€æœ‰æœåŠ¡æµ‹è¯•
npm test -- tests/services/ --verbose

# è¿è¡Œè¾¹ç•Œæµ‹è¯•
npm test -- tests/integration/balance_boundary.test.js --verbose

# è¿è¡Œå…¨éƒ¨æµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
npm test -- --coverage
```

---

## å…­ã€æµ‹è¯•ä½“ç³»è¯„åˆ†

### 6.1 è¡¥å……å®Œæˆåé¢„æœŸè¯„åˆ†

| è¯„ä¼°ç»´åº¦ | å½“å‰å¾—åˆ† | è¡¥å……åé¢„æœŸ | æå‡å¹…åº¦ |
|---------|---------|-----------|---------|
| **å¹¿åº¦è¦†ç›–** | 85 | 95 | +10 |
| **æ·±åº¦æµ‹è¯•** | 90 | 98 | +8 |
| **å¤æ‚åœºæ™¯** | 92 | 95 | +3 |
| **å¹¶å‘èƒ½åŠ›** | 95 | 98 | +3 |
| **ä»£ç è´¨é‡** | 90 | 95 | +5 |
| **å¯ç»´æŠ¤æ€§** | 88 | 95 | +7 |

### 6.2 ç»¼åˆè¯„åˆ†é¢„æœŸ

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘        è¡¥å……å‰ç»¼åˆè¯„åˆ†ï¼š90/100ï¼ˆä¼˜ç§€ Aï¼‰           â•‘
â•‘        è¡¥å……åé¢„æœŸè¯„åˆ†ï¼š96/100ï¼ˆå“è¶Š A+ï¼‰          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ä¸ƒã€é•¿æœŸç»´æŠ¤æˆæœ¬åˆ†æ

### 7.1 æŠ€æœ¯å€ºåŠ¡é™ä½ç‚¹

| é™ä½é¡¹ | è¯´æ˜ |
|-------|------|
| æœåŠ¡å±‚æµ‹è¯•è¦†ç›– | é¿å…æœåŠ¡é‡æ„æ—¶çš„å›å½’é£é™© |
| è¾¹ç•Œæ¡ä»¶è¦†ç›– | å‡å°‘ç”Ÿäº§ç¯å¢ƒè¾¹ç•Œé—®é¢˜ |
| å¹‚ç­‰æ€§æµ‹è¯• | ç¡®ä¿é‡å¤è¯·æ±‚å®‰å…¨ |
| äº‹åŠ¡è¾¹ç•Œæµ‹è¯• | ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ |

### 7.2 ç»´æŠ¤æˆæœ¬å¯¹æ¯”

| ç»´åº¦ | æ— æµ‹è¯• | æœ‰æµ‹è¯• |
|-----|-------|-------|
| é‡æ„é£é™© | é«˜ï¼ˆæ‰‹åŠ¨éªŒè¯ï¼‰ | ä½ï¼ˆè‡ªåŠ¨å›å½’ï¼‰ |
| é—®é¢˜å®šä½ | æ…¢ï¼ˆç”Ÿäº§æ’æŸ¥ï¼‰ | å¿«ï¼ˆæµ‹è¯•å¤ç°ï¼‰ |
| ä»£ç ä¿¡å¿ƒ | ä½ | é«˜ |
| æ–°äººä¸Šæ‰‹ | éš¾ï¼ˆç¼ºä¹æ–‡æ¡£ï¼‰ | æ˜“ï¼ˆæµ‹è¯•å³æ–‡æ¡£ï¼‰ |

---

**æ–‡æ¡£ç¼–å†™**: Claude AI  
**æœ€åæ›´æ–°**: 2026-01-29  
**ç‰ˆæœ¬**: v2.0 - å«æ‰§è¡Œæ­¥éª¤å’Œä»£ç å®ç°
