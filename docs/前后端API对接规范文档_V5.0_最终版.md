# å‰åç«¯APIå¯¹æ¥è§„èŒƒæ–‡æ¡£ V5.0 - å®Œæ•´ç›®å½•ç´¢å¼•

**æ–‡æ¡£ç‰ˆæœ¬**: V5.0 å®é™…ä»£ç éªŒè¯ç‰ˆ
**æ–‡æ¡£è¡Œæ•°**: 11300+è¡Œ
**åˆ›å»ºæ—¶é—´**: 2025å¹´01æœˆ21æ—¥ (åŒ—äº¬æ—¶é—´)
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ22æ—¥ 01:30:00 (åŒ—äº¬æ—¶é—´) âœ¨
**é€‚ç”¨ç³»ç»Ÿ**: V4.0 ç»Ÿä¸€æŠ½å¥–å¼•æ“æ¶æ„
**å‰ç«¯å¹³å°**: å¾®ä¿¡å°ç¨‹åº
**éªŒè¯çŠ¶æ€**: âœ… åŸºäºå®é™…ä»£ç å®Œæ•´éªŒè¯ + è¡¥å……å®ç°ç»†èŠ‚
**ä½¿ç”¨æ¨¡å‹**: Claude 4 Sonnet

---

## ğŸ” æœ¬æ¬¡æ›´æ–°éªŒè¯è¯´æ˜

**éªŒè¯æ—¶é—´**: 2025å¹´10æœˆ22æ—¥ 00:25:06 (åŒ—äº¬æ—¶é—´)

**ä½¿ç”¨æ¨¡å‹**: Claude 4 Sonnet

### ğŸ“‹ éªŒè¯çš„ä»£ç æ–‡ä»¶
1. âœ… éªŒè¯äº†åç«¯ä¸»åº”ç”¨å…¥å£ `app.js` - æ‰€æœ‰è·¯ç”±é…ç½®å’Œä¸­é—´ä»¶
2. âœ… éªŒè¯äº†è®¤è¯è·¯ç”± `routes/v4/unified-engine/auth.js` - ç™»å½•ã€Tokenç®¡ç†
3. âœ… éªŒè¯äº†å›¾ç‰‡ä¸Šä¼ è·¯ç”± `routes/v4/unified-engine/photo.js` - ä¸Šä¼ ã€å®¡æ ¸ã€ç»Ÿè®¡
4. âœ… éªŒè¯äº†æŠ½å¥–è·¯ç”± `routes/v4/unified-engine/lottery.js` - æŠ½å¥–æ‰§è¡Œã€å¥–å“åˆ—è¡¨
5. âœ… éªŒè¯äº†åº“å­˜ç®¡ç†è·¯ç”± `routes/v4/unified-engine/inventory.js` - åº“å­˜æŸ¥è¯¢ã€ä½¿ç”¨
6. âœ… éªŒè¯äº†ç§¯åˆ†ç³»ç»Ÿè·¯ç”± `routes/v4/unified-engine/points.js` - ç§¯åˆ†å®Œæ•´åŠŸèƒ½
7. âœ… éªŒè¯äº†ç³»ç»ŸåŠŸèƒ½è·¯ç”± `routes/v4/system.js` - å…¬å‘Šã€åé¦ˆã€å®¢æœèŠå¤©ã€é…ç½®
8. âœ… éªŒè¯äº†æƒé™ç®¡ç†è·¯ç”± `routes/v4/permissions.js` - æƒé™æŸ¥è¯¢ã€è§’è‰²ç®¡ç†
9. âœ… éªŒè¯äº†è®¤è¯ä¸­é—´ä»¶ `middleware/auth.js` - TokenéªŒè¯ã€è§’è‰²æƒé™
10. âœ… éªŒè¯äº†Sealoså¯¹è±¡å­˜å‚¨æœåŠ¡ `services/sealosStorage.js` - å®Œæ•´å­˜å‚¨å‚æ•°
11. âœ… éªŒè¯äº†æ•°æ®è„±æ•æœåŠ¡ `DataSanitizer` - æ•°æ®å®‰å…¨ä¿æŠ¤æœºåˆ¶
12. âœ… éªŒè¯äº†æ•°æ®åº“æ¨¡å‹å…³è”å…³ç³» - 18ä¸ªæ ¸å¿ƒæ•°æ®æ¨¡å‹

### ğŸ”§ ä¸»è¦æ›´æ–°å†…å®¹

#### 1. **APIå“åº”å­—æ®µåä¿®æ­£**ï¼ˆé‡è¦âš ï¸ï¼‰
- âœ… **ç§¯åˆ†ä½™é¢API**: `current_points` â†’ `available_points`ï¼Œ`total_spent` â†’ `total_consumed`
- âœ… **ç§¯åˆ†äº¤æ˜“API**: `items` â†’ `transactions`ï¼Œ`type` â†’ `transaction_type`ï¼Œ`amount` â†’ `points_amount`
- âœ… **åº“å­˜åˆ—è¡¨API**: `items` â†’ `inventory`ï¼Œ`id` â†’ `inventory_id`ï¼Œ`unused` â†’ `available`

#### 2. **Sealoså¯¹è±¡å­˜å‚¨é…ç½®ä¿®æ­£**
- âœ… ç¯å¢ƒå˜é‡åç§°: `SEALOS_ACCESS_KEY_ID` â†’ `SEALOS_ACCESS_KEY`
- âœ… ç¯å¢ƒå˜é‡åç§°: `SEALOS_SECRET_ACCESS_KEY` â†’ `SEALOS_SECRET_KEY`
- âœ… æ˜ç¡®æ ‡æ³¨bucketåç§°ç¡¬ç¼–ç : `br0za7uc-tiangong`
- âœ… è¡¥å……Sealoså¯¹è±¡å­˜å‚¨å®Œæ•´é…ç½®ä¿¡æ¯

#### 3. **WebSocketå®¢æœèŠå¤©ç³»ç»Ÿå®Œæ•´è¡¥å……**ï¼ˆé‡è¦âš ï¸ï¼‰
- âœ… **æ–°å¢10ä¸ªAPI**: å®¢æœèŠå¤©ç³»ç»Ÿå®Œæ•´APIè¯´æ˜ï¼ˆ5.13-5.22ï¼‰
- âœ… **WebSocketè¿æ¥é…ç½®**: è¿æ¥URLã€è®¤è¯æ–¹å¼ã€å¾®ä¿¡å°ç¨‹åºé™åˆ¶
- âœ… **å®Œæ•´ä»£ç ç¤ºä¾‹**: åŒ…å«èŠå¤©å®¤ã€WebSocketè¿æ¥ã€å®æ—¶æ¨é€å¤„ç†
- âœ… **ç®¡ç†å‘˜åŠŸèƒ½**: ä¼šè¯ç®¡ç†ã€åˆ†é…ã€å›å¤ã€å…³é—­ã€ç»Ÿè®¡
- âœ… **æ˜ç¡®æ ‡æ³¨**: åç«¯æ‰§è¡Œã€å‰ç«¯æ‰§è¡Œã€æ•°æ®æµå‘

#### 4. **å›¾ç‰‡ä¸Šä¼ APIä¿®æ­£**
- âœ… è¡¨å•å­—æ®µå: `image` â†’ `photo`ï¼ˆå¿…é¡»ä½¿ç”¨photoï¼‰
- âœ… å¿…å¡«å‚æ•°: å¢åŠ  `user_id` å­—æ®µè¯´æ˜

#### 5. **æ•°æ®å®‰å…¨è¯´æ˜å¢å¼º**
- âœ… æ–°å¢è¯¦ç»†çš„æ•°æ®è„±æ•åˆ†çº§è¯´æ˜
- âœ… æ˜ç¡®æ ‡æ³¨å“ªäº›å­—æ®µä¼šè¢«è„±æ•ï¼ˆæ¦‚ç‡ã€åº“å­˜ã€æˆæœ¬ç­‰ï¼‰
- âœ… è¡¥å……æ•°æ®æµå‘æ ‡æ³¨ï¼ˆåç«¯â†’å‰ç«¯ï¼Œå‰ç«¯â†’åç«¯ï¼‰

#### 6. **å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹ä»£ç ä¿®æ­£**
- âœ… æ‰€æœ‰APIè°ƒç”¨ç¤ºä¾‹ä¸­çš„å­—æ®µåå·²æ›´æ–°ä¸ºå®é™…è¿”å›çš„å­—æ®µå
- âœ… ä¿®æ­£äº† `user_info.id` â†’ `user_info.user_id`
- âœ… æ–°å¢å®Œæ•´WebSocketèŠå¤©å®¤ç¤ºä¾‹ä»£ç 

### ğŸ†• æœ€æ–°è¡¥å……å†…å®¹ (2025-10-22 01:30)

**è¡¥å……äº†ä»¥ä¸‹å®ç°ç»†èŠ‚**:
1. âœ… **æŠ½å¥–é™æµè§„åˆ™è¯¦è§£** - 20æ¬¡/åˆ†é’Ÿ/ç”¨æˆ·ï¼ŒåŒ…å«å‰ç«¯é˜²æŠ–å»ºè®®
2. âœ… **æ´»åŠ¨æƒé™æœºåˆ¶è¯¦è§£** - ç®¡ç†å‘˜è‡ªåŠ¨æˆæƒã€æ™®é€šç”¨æˆ·éœ€åˆ†é…ã€403é”™è¯¯å¤„ç†
3. âœ… **æ•°æ®è„±æ•æœºåˆ¶è¯´æ˜** - ç®¡ç†å‘˜vsæ™®é€šç”¨æˆ·çš„æ•°æ®å·®å¼‚å¯¹æ¯”è¡¨
4. âœ… **é™æµé”™è¯¯å“åº”æ ¼å¼** - æ›´æ–°ä¸ºå®é™…çš„429é”™è¯¯å“åº”ç»“æ„
5. âœ… **å‰ç«¯é”™è¯¯å¤„ç†ç¤ºä¾‹** - æƒé™ä¸è¶³ã€é™æµè§¦å‘çš„å®Œæ•´å¤„ç†ä»£ç 

### âš ï¸ é‡è¦æç¤º

**å‰ç«¯å¼€å‘è€…è¯·æ³¨æ„**: 
1. æœ¬æ¬¡æ›´æ–°ä¿®æ­£äº†å¤šä¸ªAPIå“åº”å­—æ®µåï¼Œè¯·åŠ¡å¿…æŒ‰ç…§æ–‡æ¡£ä¸­æ ‡æ³¨"âœ… å®é™…ä»£ç éªŒè¯"çš„å­—æ®µåè¿›è¡Œå¼€å‘
2. æ‰€æœ‰æ ‡æ³¨å®é™…éªŒè¯çš„å“åº”æ ¼å¼å‡å·²ä¸åç«¯ä»£ç æ ¸å¯¹ç¡®è®¤
3. Sealoså­˜å‚¨é…ç½®å·²æ›´æ–°ä¸ºå®é™…ä½¿ç”¨çš„ç¯å¢ƒå˜é‡å
4. å›¾ç‰‡ä¸Šä¼ è¡¨å•å­—æ®µå¿…é¡»ä½¿ç”¨ `photo`ï¼Œä¸æ˜¯ `image`
5. æ‰€æœ‰æ—¶é—´å­—æ®µç»Ÿä¸€ä½¿ç”¨åŒ—äº¬æ—¶é—´ï¼ˆ+08:00ï¼‰æ ¼å¼
6. **æ–°å¢**: æŠ½å¥–APIæœ‰20æ¬¡/åˆ†é’Ÿé™æµï¼Œå»ºè®®å‰ç«¯æ·»åŠ é˜²æŠ–å¤„ç† ğŸ†•
7. **æ–°å¢**: æŠ½å¥–éœ€è¦æ´»åŠ¨æƒé™ï¼Œæ³¨æ„å¤„ç†403é”™è¯¯ç  ğŸ†•

---

## ğŸ“‘ å®Œæ•´ç›®å½•ç´¢å¼•

### Part 1: æ€»è§ˆå’Œæ¶æ„è¯´æ˜

- **ğŸ“Œ æ–‡æ¡£è¯´æ˜**
  - æ–‡æ¡£ç›®çš„
  - é€‚ç”¨äººå‘˜  
  - å‰åç«¯èŒè´£åˆ’åˆ†

- **ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ**
  - æŠ€æœ¯æ¶æ„å›¾
  - V4.0 ç»Ÿä¸€æŠ½å¥–å¼•æ“æ¶æ„
  - æ ¸å¿ƒç‰¹æ€§

- **ğŸ“¡ APIé€šç”¨è§„èŒƒ**
  - 1. åŸºç¡€URLé…ç½®
  - 2. ç»Ÿä¸€å“åº”æ ¼å¼(æˆåŠŸ/å¤±è´¥)
  - 3. é€šç”¨é”™è¯¯ç åˆ—è¡¨
  - 4. è¯·æ±‚è®¤è¯æœºåˆ¶(Tokenç®¡ç†)
  - 5. è¯·æ±‚å¤´è§„èŒƒ
  - 6. åˆ†é¡µè§„èŒƒ
  - 7. æ—¶é—´æ ¼å¼è§„èŒƒ(åŒ—äº¬æ—¶é—´)
  - 8. æ•°æ®è„±æ•è¯´æ˜
  - 9. å›¾ç‰‡èµ„æºè®¿é—®

- **ğŸ” æƒé™ç³»ç»Ÿè¯´æ˜**
  - è§’è‰²å®šä¹‰
  - æ´»åŠ¨æƒé™æœºåˆ¶(V2.0æ–°å¢)
  - æƒé™æ£€æŸ¥æµç¨‹
  - å‰ç«¯å¤„ç†å»ºè®®

- **ğŸ“Š APIæ¨¡å—æ¦‚è§ˆ**
  - æ ¸å¿ƒAPIæ¨¡å—è¡¨
  - APIæ•°é‡ç»Ÿè®¡

- **ğŸ¯ å¿«é€Ÿå¼€å§‹**
  - ç”¨æˆ·ç™»å½•æµç¨‹
  - è·å–å¥–å“åˆ—è¡¨
  - æ‰§è¡ŒæŠ½å¥–

- **ğŸ“ å¼€å‘ç¯å¢ƒé…ç½®**
  - å¾®ä¿¡å°ç¨‹åºé…ç½®
  - æœåŠ¡å™¨åŸŸåé…ç½®
  - å…¨å±€APIé…ç½®(utils/api.js)

- **ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹**
  - Tokenå®‰å…¨
  - æ•æ„Ÿä¿¡æ¯ä¿æŠ¤
  - HTTPSå¼ºåˆ¶
  - æ•°æ®éªŒè¯

---

### Part 2: è®¤è¯å’Œæƒé™æ¨¡å—

- **ğŸ“– æ¨¡å—æ¦‚è¿°**
  - è®¤è¯æ¨¡å—èŒè´£
  - æƒé™æ¨¡å—èŒè´£

- **ğŸ” è®¤è¯æ¨¡å—API**
  - 2.1 ç”¨æˆ·ç™»å½•(æ‰‹æœºå·éªŒè¯ç ) `POST /auth/login`
  - 2.2 å¿«é€Ÿç™»å½•(å…éªŒè¯ç ) `POST /auth/quick-login`
  - 2.3 è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ `GET /auth/profile`
  - 2.4 éªŒè¯Tokenæœ‰æ•ˆæ€§ `POST /auth/verify`
  - 2.5 åˆ·æ–°Token `POST /auth/refresh`

- **ğŸ”‘ æƒé™æ¨¡å—API**
  - 2.6 æŸ¥è¯¢ç”¨æˆ·æƒé™(æŒ‡å®šç”¨æˆ·) `GET /permissions/user/:user_id`
  - 2.7 æŸ¥è¯¢å½“å‰ç”¨æˆ·æƒé™ `GET /permissions/current`
  - 2.8 æ£€æŸ¥ç‰¹å®šæƒé™ `POST /permissions/check`
  - 2.9 è·å–ç®¡ç†å‘˜åˆ—è¡¨ `GET /permissions/admins`
  - 2.10 æƒé™ç»Ÿè®¡ä¿¡æ¯ `GET /permissions/statistics`

- **ğŸ“ è®¤è¯æƒé™æ¨¡å—æ€»ç»“**
  - APIæ¸…å•
  - å‰ç«¯å¼€å‘å»ºè®®

---

### Part 3: æŠ½å¥–æ ¸å¿ƒæ¨¡å—

- **ğŸ“– æ¨¡å—æ¦‚è¿°**
  - æŠ½å¥–æ¨¡å—èŒè´£
  - æ´»åŠ¨æƒé™ç³»ç»Ÿè¯´æ˜

- **ğŸ æŠ½å¥–æ ¸å¿ƒAPI**
  - 3.1 è·å–å¥–å“åˆ—è¡¨ `GET /lottery/prizes/:campaignCode`
  - 3.2 è·å–æ´»åŠ¨é…ç½® `GET /lottery/config/:campaignCode`
  - 3.3 æ‰§è¡ŒæŠ½å¥–(æ ¸å¿ƒåŠŸèƒ½) `POST /lottery/draw` â­
  - 3.4 æŸ¥è¯¢ç”¨æˆ·æŠ½å¥–å†å² `GET /lottery/history/:user_id`
  - 3.5 æŸ¥è¯¢ç”¨æˆ·æŠ½å¥–ç»Ÿè®¡ `GET /lottery/statistics/:user_id`
  - 3.6 è·å–æ´»åŠ¨åˆ—è¡¨ `GET /lottery/campaigns`
  - 3.7 ç³»ç»Ÿå¥åº·æ£€æŸ¥ `GET /lottery/health`

- **ğŸ“ æŠ½å¥–æ¨¡å—æ€»ç»“**
  - APIæ¸…å•
  - æ•°æ®è„±æ•è§„åˆ™
  - æ´»åŠ¨æƒé™æ§åˆ¶
  - å‰ç«¯å¼€å‘å»ºè®®

---

### Part 4: åº“å­˜å’Œç§¯åˆ†æ¨¡å—

- **ğŸ“– æ¨¡å—æ¦‚è¿°**
  - åº“å­˜ç®¡ç†æ¨¡å—èŒè´£
  - ç§¯åˆ†ç³»ç»Ÿæ¨¡å—èŒè´£

- **ğŸ“¦ åº“å­˜ç®¡ç†API**
  - 4.1 æŸ¥è¯¢ç”¨æˆ·åº“å­˜åˆ—è¡¨ `GET /inventory/user/:user_id`
  - 4.2 æŸ¥è¯¢åº“å­˜ç‰©å“è¯¦æƒ… `GET /inventory/item/:item_id`
  - 4.3 ä½¿ç”¨åº“å­˜ç‰©å“ `POST /inventory/use/:item_id`
  - 4.4 æŸ¥è¯¢å¯å…‘æ¢å•†å“åˆ—è¡¨ `GET /inventory/products`
  - 4.5 å…‘æ¢å•†å“ `POST /inventory/exchange`
  - 4.6 æŸ¥è¯¢å…‘æ¢è®°å½• `GET /inventory/exchange-records`
  - 4.7 ç”Ÿæˆæ ¸é”€ç  `POST /inventory/generate-code/:item_id`
  - 4.8 å–æ¶ˆå…‘æ¢è®¢å• `POST /inventory/exchange-records/:id/cancel`
  - 4.9 è½¬ç§»ç‰©å“ç»™å…¶ä»–ç”¨æˆ· `POST /inventory/transfer`
  - 4.10 æŸ¥è¯¢è½¬ç§»å†å² `GET /inventory/transfer-history`
  - 4.11 æ ¸é”€ç‰©å“(ä½¿ç”¨æ ¸é”€ç ) `POST /inventory/verification/verify`
  - 4.12 æŸ¥è¯¢å¸‚åœºå•†å“åˆ—è¡¨ `GET /inventory/market/products`
  - 4.13 è´­ä¹°å¸‚åœºå•†å“ `POST /inventory/market/products/:id/purchase`

- **ğŸ’° ç§¯åˆ†ç³»ç»ŸAPI**
  - 4.14 æŸ¥è¯¢å½“å‰ç”¨æˆ·ç§¯åˆ†ä½™é¢ `GET /points/balance`
  - 4.15 æŸ¥è¯¢æŒ‡å®šç”¨æˆ·ç§¯åˆ†ä½™é¢ `GET /points/balance/:user_id`
  - 4.16 æŸ¥è¯¢ç§¯åˆ†äº¤æ˜“è®°å½• `GET /points/transactions/:user_id`
  - 4.17 ç®¡ç†å‘˜è°ƒæ•´ç”¨æˆ·ç§¯åˆ† `POST /points/admin/adjust`
  - 4.18 ç®¡ç†å‘˜ç§¯åˆ†ç»Ÿè®¡ `GET /points/admin/statistics`
  - 4.19 ç”¨æˆ·ç»¼åˆç»Ÿè®¡ä¿¡æ¯ `GET /points/user/statistics/:user_id`

- **ğŸ“ åº“å­˜ç§¯åˆ†æ¨¡å—æ€»ç»“**
  - APIæ¸…å•
  - å‰ç«¯å¼€å‘å»ºè®®

---

### Part 5: å›¾ç‰‡å’Œç³»ç»Ÿæ¨¡å—

- **ğŸ“– æ¨¡å—æ¦‚è¿°**
  - å›¾ç‰‡ç®¡ç†æ¨¡å—èŒè´£
  - ç³»ç»ŸåŠŸèƒ½æ¨¡å—èŒè´£

- **ğŸ“· å›¾ç‰‡ç®¡ç†API**
  - 5.1 ä¸Šä¼ å›¾ç‰‡ `POST /photo/upload`
  - 5.2 æŸ¥è¯¢å¾…å®¡æ ¸å›¾ç‰‡åˆ—è¡¨ `GET /photo/pending-reviews`
  - 5.3 å®¡æ ¸å›¾ç‰‡ `POST /photo/review/:resourceId`
  - 5.4 æŸ¥è¯¢æˆ‘çš„ä¸Šä¼ è®°å½• `GET /photo/my-uploads`
  - 5.5 æŸ¥è¯¢æˆ‘çš„ä¸Šä¼ ç»Ÿè®¡ `GET /photo/my-stats`
  - 5.6 åˆ é™¤å›¾ç‰‡ `DELETE /photo/:id`

- **ğŸ”§ ç³»ç»ŸåŠŸèƒ½API**
  - 5.7 æŸ¥è¯¢ç³»ç»Ÿå…¬å‘Šåˆ—è¡¨ `GET /system/announcements`
  - 5.8 æŸ¥è¯¢é¦–é¡µå…¬å‘Š `GET /system/announcements/home`
  - 5.9 æäº¤ç”¨æˆ·åé¦ˆ `POST /system/feedback`
  - 5.10 æŸ¥è¯¢æˆ‘çš„åé¦ˆåˆ—è¡¨ `GET /system/feedback/my`
  - 5.11 æŸ¥è¯¢åé¦ˆè¯¦æƒ… `GET /system/feedback/:id`
  - 5.12 æŸ¥è¯¢ç³»ç»ŸçŠ¶æ€ `GET /system/status`

---

### Part 6: ç®¡ç†åå°æ¨¡å—

- **ğŸ“– æ¨¡å—æ¦‚è¿°**
  - ç®¡ç†åå°æ¨¡å—èŒè´£
  - æ¨¡å—åŒ–ç®¡ç†æ¶æ„

- **ğŸ”‘ ç®¡ç†åå°è®¿é—®è¯´æ˜**
  - æƒé™è¦æ±‚
  - ç»Ÿä¸€æƒé™éªŒè¯å“åº”

- **ğŸ‘¤ ç”¨æˆ·ç®¡ç†API**
  - 6.1 æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨ `GET /admin/users`
  - 6.2 æŸ¥è¯¢ç”¨æˆ·è¯¦æƒ… `GET /admin/users/:user_id`
  - 6.3 æ›´æ–°ç”¨æˆ·çŠ¶æ€ `PUT /admin/users/:user_id/status`
  - 6.4 åˆ†é…ç”¨æˆ·è§’è‰² `POST /admin/users/:user_id/roles`

- **ğŸ° æŠ½å¥–æ´»åŠ¨ç®¡ç†API**
  - 6.5 æŸ¥è¯¢æ‰€æœ‰æŠ½å¥–æ´»åŠ¨ `GET /admin/campaigns`
  - 6.6 åˆ›å»ºæŠ½å¥–æ´»åŠ¨ `POST /admin/campaigns`
  - 6.7 æ›´æ–°æŠ½å¥–æ´»åŠ¨ `PUT /admin/campaigns/:id`

- **ğŸ å¥–å“æ± ç®¡ç†API**
  - 6.8 æŸ¥è¯¢æ´»åŠ¨å¥–å“æ±  `GET /admin/campaigns/:id/prizes`
  - 6.9 æ·»åŠ æ´»åŠ¨å¥–å“ `POST /admin/campaigns/:id/prizes`
  - 6.10 æ›´æ–°å¥–å“é…ç½® `PUT /admin/prizes/:prize_id`

- **âš™ï¸ ç³»ç»Ÿé…ç½®ç®¡ç†API**
  - 6.11 æŸ¥è¯¢ç³»ç»Ÿé…ç½® `GET /admin/config`
  - 6.12 æ›´æ–°ç³»ç»Ÿé…ç½® `PUT /admin/config`

- **ğŸ“Š æ•°æ®åˆ†æç»Ÿè®¡API**
  - 6.13 æŸ¥è¯¢æŠ½å¥–åˆ†ææ•°æ® `GET /admin/analytics/lottery`
  - 6.14 æŸ¥è¯¢ç”¨æˆ·åˆ†ææ•°æ® `GET /admin/analytics/users`

- **ğŸ” å®¡è®¡æ—¥å¿—ç®¡ç†API**
  - 6.15 æŸ¥è¯¢å®¡è®¡æ—¥å¿— `GET /audit-management/logs`

- **ğŸ” æ´»åŠ¨æƒé™ç®¡ç†API**
  - 6.16 åˆ†é…æ´»åŠ¨æƒé™ `POST /admin/campaign-permissions/assign`
  - 6.17 æ’¤é”€æ´»åŠ¨æƒé™ `DELETE /admin/campaign-permissions/revoke`
  - 6.18 æŸ¥è¯¢æ´»åŠ¨æƒé™åˆ—è¡¨ `GET /admin/campaign-permissions/list`
  - 6.19 æ£€æŸ¥ç”¨æˆ·æ´»åŠ¨æƒé™ `GET /admin/campaign-permissions/check`

- **ğŸ“ ç®¡ç†åå°æ¨¡å—æ€»ç»“**
  - APIæ¸…å•
  - æƒé™éªŒè¯æµç¨‹
  - å‰ç«¯å¼€å‘å»ºè®®

- **ğŸ¯ å®Œæ•´APIç»Ÿè®¡**
  - æ€»ä½“ç»Ÿè®¡
  - è®¤è¯è¦æ±‚åˆ†å¸ƒ

---

### é™„å½•: æ•°æ®åº“æ¨¡å‹ã€é”™è¯¯ç ã€éƒ¨ç½²è¯´æ˜

- **ğŸ“š é™„å½• A: æ•°æ®åº“æ¨¡å‹è¯¦ç»†è¯´æ˜**
  - A.1 ç”¨æˆ·è¡¨ (`users`)
  - A.2 è§’è‰²è¡¨ (`roles`)
  - A.3 ç”¨æˆ·è§’è‰²å…³è”è¡¨ (`user_roles`)
  - A.4 æŠ½å¥–æ´»åŠ¨è¡¨ (`lottery_campaigns`)
  - A.5 æŠ½å¥–å¥–å“è¡¨ (`lottery_prizes`)
  - A.6 æŠ½å¥–è®°å½•è¡¨ (`lottery_draws`)
  - A.7 ç”¨æˆ·åº“å­˜è¡¨ (`user_inventory`)
  - A.8 ç”¨æˆ·ç§¯åˆ†è´¦æˆ·è¡¨ (`user_points_accounts`)
  - A.9 ç§¯åˆ†äº¤æ˜“è®°å½•è¡¨ (`points_transactions`)
  - A.10 å›¾ç‰‡èµ„æºè¡¨ (`image_resources`)
  - A.11 ç³»ç»Ÿå…¬å‘Šè¡¨ (`system_announcements`)
  - A.12 ç”¨æˆ·åé¦ˆè¡¨ (`feedback`)
  - A.13 å…‘æ¢å•†å“è¡¨ (`products`)
  - A.14 å…‘æ¢è®°å½•è¡¨ (`exchange_records`)
  - A.15 ç®¡ç†å‘˜æ“ä½œæ—¥å¿—è¡¨ (`admin_operation_logs`)

- **ğŸ“‹ é™„å½• B: å®Œæ•´é”™è¯¯ç å¤§å…¨**
  - B.1 è®¤è¯ç›¸å…³é”™è¯¯(1xx)
  - B.2 æƒé™ç›¸å…³é”™è¯¯(2xx)
  - B.3 èµ„æºç›¸å…³é”™è¯¯(3xx)
  - B.4 ä¸šåŠ¡è§„åˆ™é”™è¯¯(4xx)
  - B.5 æ–‡ä»¶ä¸Šä¼ é”™è¯¯(5xx)
  - B.6 ç³»ç»Ÿé”™è¯¯(9xx)

- **ğŸš€ é™„å½• C: éƒ¨ç½²è¯´æ˜**
  - C.1 ç¯å¢ƒå˜é‡é…ç½®
  - C.2 Sealoséƒ¨ç½²é…ç½®
  - C.3 æ•°æ®åº“åˆå§‹åŒ–
  - C.4 é¦–æ¬¡å¯åŠ¨æ£€æŸ¥æ¸…å•

- **ğŸ› ï¸ é™„å½• D: å¾®ä¿¡å°ç¨‹åºå·¥å…·ç±»å®Œæ•´å®ç°**
  - D.1 ç»Ÿä¸€è¯·æ±‚å°è£… (`utils/request.js`)
  - D.2 APIè°ƒç”¨å°è£… (`utils/api.js`)
  - D.3 æ—¶é—´æ ¼å¼åŒ–å·¥å…· (`utils/time.js`)
  - D.4 æƒé™æ£€æŸ¥å·¥å…· (`utils/permission.js`)

- **ğŸ“– é™„å½• E: å¸¸è§é—®é¢˜FAQ**
  - E.1 Tokenç®¡ç†ç›¸å…³
  - E.2 æ´»åŠ¨æƒé™ç›¸å…³
  - E.3 æ•°æ®è„±æ•ç›¸å…³
  - E.4 å›¾ç‰‡ä¸Šä¼ ç›¸å…³
  - E.5 ç§¯åˆ†ç³»ç»Ÿç›¸å…³

- **ğŸ§ª é™„å½• F: APIæµ‹è¯•æŒ‡å—**
  - F.1 ä½¿ç”¨Postmanæµ‹è¯•
  - F.2 ä½¿ç”¨curlæµ‹è¯•

---

## ğŸ“Š APIå®Œæ•´æ¸…å•

### ç”¨æˆ·ç«¯API (46ä¸ª)

#### è®¤è¯æƒé™ (5ä¸ª)
1. `POST /auth/login` - ç”¨æˆ·ç™»å½•
2. `POST /auth/quick-login` - å¿«é€Ÿç™»å½•(æµ‹è¯•)
3. `GET /auth/profile` - è·å–ç”¨æˆ·ä¿¡æ¯
4. `POST /auth/verify` - éªŒè¯Token
5. `POST /auth/refresh` - åˆ·æ–°Token

#### æŠ½å¥–æ ¸å¿ƒ (7ä¸ª)
6. `GET /lottery/prizes/:campaignCode` - è·å–å¥–å“åˆ—è¡¨
7. `GET /lottery/config/:campaignCode` - è·å–æ´»åŠ¨é…ç½®
8. `POST /lottery/draw` - æ‰§è¡ŒæŠ½å¥– â­
9. `GET /lottery/history/:user_id` - æŠ½å¥–å†å²
10. `GET /lottery/statistics/:user_id` - ç”¨æˆ·ç»Ÿè®¡
11. `GET /lottery/campaigns` - æ´»åŠ¨åˆ—è¡¨
12. `GET /lottery/health` - å¥åº·æ£€æŸ¥

#### åº“å­˜ç®¡ç† (12ä¸ª)
13. `GET /inventory/user/:user_id` - åº“å­˜åˆ—è¡¨
14. `GET /inventory/item/:item_id` - ç‰©å“è¯¦æƒ…
15. `POST /inventory/use/:item_id` - ä½¿ç”¨ç‰©å“
16. `GET /inventory/products` - å¯å…‘æ¢å•†å“
17. `POST /inventory/exchange` - å…‘æ¢å•†å“
18. `GET /inventory/exchange-records` - å…‘æ¢è®°å½•
19. `POST /inventory/generate-code/:item_id` - ç”Ÿæˆæ ¸é”€ç 
20. `POST /inventory/exchange-records/:id/cancel` - å–æ¶ˆå…‘æ¢
21. `POST /inventory/transfer` - è½¬ç§»ç‰©å“
22. `GET /inventory/transfer-history` - è½¬ç§»å†å²
23. `POST /inventory/verification/verify` - æ ¸é”€ç‰©å“(ç®¡ç†å‘˜)
24. `GET /inventory/market/products` - å¸‚åœºå•†å“

#### ç§¯åˆ†ç³»ç»Ÿ (4ä¸ª)
25. `GET /points/balance` - å½“å‰ç”¨æˆ·ç§¯åˆ†
26. `GET /points/balance/:user_id` - æŒ‡å®šç”¨æˆ·ç§¯åˆ†
27. `GET /points/transactions/:user_id` - äº¤æ˜“è®°å½•
28. `GET /points/user/statistics/:user_id` - ç”¨æˆ·ç»Ÿè®¡

#### å›¾ç‰‡ç®¡ç† (4ä¸ª)
29. `POST /photo/upload` - ä¸Šä¼ å›¾ç‰‡
30. `GET /photo/my-uploads` - æˆ‘çš„ä¸Šä¼ 
31. `GET /photo/my-stats` - ä¸Šä¼ ç»Ÿè®¡
32. `DELETE /photo/:id` - åˆ é™¤å›¾ç‰‡

#### ç³»ç»ŸåŠŸèƒ½ (10ä¸ª)
33. `GET /system/announcements` - å…¬å‘Šåˆ—è¡¨
34. `GET /system/announcements/home` - é¦–é¡µå…¬å‘Š
35. `POST /system/feedback` - æäº¤åé¦ˆ
36. `GET /system/feedback/my` - æˆ‘çš„åé¦ˆ
37. `GET /system/feedback/:id` - åé¦ˆè¯¦æƒ…
38. `GET /system/status` - ç³»ç»ŸçŠ¶æ€
39. `GET /permissions/current` - å½“å‰ç”¨æˆ·æƒé™
40. `POST /permissions/check` - æ£€æŸ¥æƒé™
41. `GET /permissions/admins` - ç®¡ç†å‘˜åˆ—è¡¨(ç®¡ç†å‘˜)
42. `GET /permissions/statistics` - æƒé™ç»Ÿè®¡(ç®¡ç†å‘˜)

### ç®¡ç†ç«¯API (37+ä¸ª)

#### ç”¨æˆ·ç®¡ç† (4+ä¸ª)
43. `GET /admin/users` - ç”¨æˆ·åˆ—è¡¨
44. `GET /admin/users/:user_id` - ç”¨æˆ·è¯¦æƒ…
45. `PUT /admin/users/:user_id/status` - æ›´æ–°ç”¨æˆ·çŠ¶æ€
46. `POST /admin/users/:user_id/roles` - åˆ†é…è§’è‰²

#### æŠ½å¥–ç®¡ç† (6+ä¸ª)
47. `GET /admin/campaigns` - æ´»åŠ¨åˆ—è¡¨
48. `POST /admin/campaigns` - åˆ›å»ºæ´»åŠ¨
49. `PUT /admin/campaigns/:id` - æ›´æ–°æ´»åŠ¨
50. `GET /admin/campaigns/:id/prizes` - æ´»åŠ¨å¥–å“
51. `POST /admin/campaigns/:id/prizes` - æ·»åŠ å¥–å“
52. `PUT /admin/prizes/:prize_id` - æ›´æ–°å¥–å“

#### ç³»ç»Ÿé…ç½® (2ä¸ª)
53. `GET /admin/config` - æŸ¥è¯¢é…ç½®
54. `PUT /admin/config` - æ›´æ–°é…ç½®

#### æ•°æ®åˆ†æ (4+ä¸ª)
55. `GET /admin/analytics/lottery` - æŠ½å¥–åˆ†æ
56. `GET /admin/analytics/users` - ç”¨æˆ·åˆ†æ
57. `GET /points/admin/statistics` - ç§¯åˆ†ç»Ÿè®¡
58. `GET /admin/analytics/photos` - å›¾ç‰‡ç»Ÿè®¡

#### å›¾ç‰‡å®¡æ ¸ (3ä¸ª)
59. `GET /photo/pending-reviews` - å¾…å®¡æ ¸åˆ—è¡¨
60. `POST /photo/review/:resourceId` - å®¡æ ¸å›¾ç‰‡
61. `GET /photo/admin/stats` - å›¾ç‰‡ç»Ÿè®¡

#### å®¡è®¡æ—¥å¿— (1ä¸ª)
62. `GET /audit-management/logs` - å®¡è®¡æ—¥å¿—

#### æ´»åŠ¨æƒé™ (4ä¸ª)
63. `POST /admin/campaign-permissions/assign` - åˆ†é…æƒé™
64. `DELETE /admin/campaign-permissions/revoke` - æ’¤é”€æƒé™
65. `GET /admin/campaign-permissions/list` - æƒé™åˆ—è¡¨
66. `GET /admin/campaign-permissions/check` - æ£€æŸ¥æƒé™

**æ€»è®¡**: 90+ APIæ¥å£

---

## ğŸ¯ å¿«é€ŸæŸ¥æ‰¾æŒ‡å—

### æŒ‰åŠŸèƒ½æŸ¥æ‰¾

- **ç”¨æˆ·æƒ³ç™»å½•**: â†’ Part 2, API 2.1
- **ç”¨æˆ·æƒ³æŠ½å¥–**: â†’ Part 3, API 3.3
- **æŸ¥çœ‹ä¸­å¥–è®°å½•**: â†’ Part 3, API 3.4
- **æŸ¥çœ‹åº“å­˜**: â†’ Part 4, API 4.1
- **ä½¿ç”¨å¥–å“**: â†’ Part 4, API 4.3
- **å…‘æ¢å•†å“**: â†’ Part 4, API 4.5
- **æŸ¥çœ‹ç§¯åˆ†**: â†’ Part 4, API 4.14
- **ä¸Šä¼ å›¾ç‰‡**: â†’ Part 5, API 5.1
- **æŸ¥çœ‹å…¬å‘Š**: â†’ Part 5, API 5.7
- **æäº¤åé¦ˆ**: â†’ Part 5, API 5.9

### æŒ‰è§’è‰²æŸ¥æ‰¾

**æ™®é€šç”¨æˆ·**:
- Part 2: è®¤è¯å’Œæƒé™
- Part 3: æŠ½å¥–åŠŸèƒ½
- Part 4: åº“å­˜å’Œç§¯åˆ†
- Part 5: å›¾ç‰‡å’Œç³»ç»Ÿ

**ç®¡ç†å‘˜**:
- Part 6: ç®¡ç†åå°(æ‰€æœ‰ç®¡ç†åŠŸèƒ½)
- é™„å½• A: æ•°æ®åº“æ¨¡å‹(äº†è§£æ•°æ®ç»“æ„)
- é™„å½• B: é”™è¯¯ç å¤§å…¨

**å‰ç«¯å¼€å‘äººå‘˜**:
- Part 1: é€šç”¨è§„èŒƒ(å¿…è¯»)
- é™„å½• D: å·¥å…·ç±»å®ç°(å¿…è¯»)
- é™„å½• E: å¸¸è§é—®é¢˜FAQ
- å„Partçš„å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹ä»£ç 

**æµ‹è¯•äººå‘˜**:
- Part 1: APIé€šç”¨è§„èŒƒ
- é™„å½• B: é”™è¯¯ç å¤§å…¨
- é™„å½• F: APIæµ‹è¯•æŒ‡å—

---

## ğŸ“– æ–‡æ¡£ä½¿ç”¨å»ºè®®

### æ–°æ‰‹å…¥é—¨(ç¬¬1-2å¤©)
1. é˜…è¯» **Part 1: æ€»è§ˆå’Œæ¶æ„è¯´æ˜**
2. é…ç½®å¾®ä¿¡å°ç¨‹åºå¼€å‘ç¯å¢ƒ
3. å®ç°ç”¨æˆ·ç™»å½•åŠŸèƒ½ (Part 2)
4. æµ‹è¯•Tokenç®¡ç†æœºåˆ¶

### æ ¸å¿ƒåŠŸèƒ½å¼€å‘(ç¬¬3-5å¤©)
5. å®ç°æŠ½å¥–åŠŸèƒ½ (Part 3)
6. å®ç°åº“å­˜ç®¡ç† (Part 4)
7. å®ç°ç§¯åˆ†ç³»ç»Ÿ (Part 4)
8. å¤„ç†å„ç§é”™è¯¯æƒ…å†µ (é™„å½• B)

### é«˜çº§åŠŸèƒ½å¼€å‘(ç¬¬6-7å¤©)
9. å®ç°å›¾ç‰‡ä¸Šä¼  (Part 5)
10. å®ç°ç³»ç»ŸåŠŸèƒ½ (Part 5)
11. å®ç°ç®¡ç†åå° (Part 6, å¦‚æœæœ‰éœ€è¦)

### æµ‹è¯•å’Œä¼˜åŒ–(ç¬¬8-10å¤©)
12. å®Œæ•´åŠŸèƒ½æµ‹è¯• (é™„å½• F)
13. æ€§èƒ½ä¼˜åŒ–
14. é”™è¯¯å¤„ç†ä¼˜åŒ–

---

## âœ… æ–‡æ¡£ç‰¹è‰²

1. **åŸºäºå®é™…ä»£ç éªŒè¯**: æ‰€æœ‰APIéƒ½åŸºäºå®é™…åç«¯ä»£ç éªŒè¯,ç¡®ä¿å‡†ç¡®æ€§
2. **å®Œæ•´çš„å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹**: æ¯ä¸ªé‡è¦APIéƒ½æœ‰å®Œæ•´çš„å‰ç«¯è°ƒç”¨ç¤ºä¾‹
3. **è¯¦ç»†çš„æ•°æ®è„±æ•è¯´æ˜**: æ˜ç¡®æ ‡æ³¨å“ªäº›å­—æ®µè¢«è„±æ•,ä¸ºä»€ä¹ˆ
4. **æ´»åŠ¨æƒé™ç³»ç»Ÿå®Œæ•´è¯´æ˜**: V2.0æ–°å¢çš„æ´»åŠ¨æƒé™ç³»ç»Ÿè¯¦ç»†æ–‡æ¡£
5. **å·¥å…·ç±»å®Œæ•´å®ç°**: æä¾›å¯ç›´æ¥ä½¿ç”¨çš„utilså·¥å…·ç±»ä»£ç 
6. **å¸¸è§é—®é¢˜FAQ**: è§£ç­”å¼€å‘è¿‡ç¨‹ä¸­çš„å¸¸è§ç–‘æƒ‘
7. **å®Œæ•´çš„é”™è¯¯ç å¤§å…¨**: æ‰€æœ‰é”™è¯¯ç åŠå‰ç«¯å¤„ç†å»ºè®®

---

**ğŸ“˜ æ–‡æ¡£æ€»è®¡**: 9497è¡Œï¼Œè¦†ç›–90+ä¸ªAPIæ¥å£

**é€‚ç”¨åœºæ™¯**: å¾®ä¿¡å°ç¨‹åºå‰ç«¯ä¸Node.jsåç«¯APIå¯¹æ¥

**æ›´æ–°æ—¥æœŸ**: 2025å¹´01æœˆ21æ—¥ (åŒ—äº¬æ—¶é—´)


# é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ - å‰åç«¯APIå¯¹æ¥è§„èŒƒæ–‡æ¡£ V5.0

**æ–‡æ¡£ç‰ˆæœ¬**: V5.0 åŸºäºå®é™…ä»£ç éªŒè¯ç‰ˆ
**åˆ›å»ºæ—¶é—´**: 2025å¹´01æœˆ21æ—¥ (åŒ—äº¬æ—¶é—´)
**æœ€åæ›´æ–°**: 2025å¹´01æœˆ21æ—¥ 20:35 (åŒ—äº¬æ—¶é—´)
**é€‚ç”¨ç³»ç»Ÿ**: V4.0 ç»Ÿä¸€æŠ½å¥–å¼•æ“æ¶æ„
**å‰ç«¯å¹³å°**: å¾®ä¿¡å°ç¨‹åº
**åç«¯æŠ€æœ¯æ ˆ**: Node.js 20+ + Express + MySQL + Sequelize + Redis + Sealoså¯¹è±¡å­˜å‚¨

---

## ğŸ“Œ æ–‡æ¡£è¯´æ˜

### æ–‡æ¡£ç›®çš„
æœ¬æ–‡æ¡£æ˜¯**å‰ç«¯å¼€å‘äººå‘˜ä¸åç«¯APIå¯¹æ¥çš„å®Œæ•´æŒ‡å—**,åŸºäº**å®é™…åç«¯ä»£ç éªŒè¯**ç¼–å†™,ç¡®ä¿æ‰€æœ‰APIè·¯å¾„ã€å‚æ•°ã€è¿”å›å€¼éƒ½ä¸å®é™…å®ç°å®Œå…¨ä¸€è‡´ã€‚

### é€‚ç”¨äººå‘˜
- **å‰ç«¯å¼€å‘äººå‘˜**: å¾®ä¿¡å°ç¨‹åºå¼€å‘è€…,è´Ÿè´£é¡µé¢å±•ç¤ºå’Œç”¨æˆ·äº¤äº’
- **æµ‹è¯•äººå‘˜**: APIæ¥å£æµ‹è¯•å’ŒåŠŸèƒ½éªŒè¯
- **é¡¹ç›®ç®¡ç†äººå‘˜**: äº†è§£ç³»ç»ŸåŠŸèƒ½å’ŒæŠ€æœ¯å®ç°

### å‰åç«¯èŒè´£åˆ’åˆ†

#### ğŸ¨ å‰ç«¯èŒè´£(å¾®ä¿¡å°ç¨‹åº)
1. **é¡µé¢å±•ç¤º**: æ ¹æ®åç«¯è¿”å›çš„æ•°æ®å±•ç¤ºç•Œé¢
2. **ç”¨æˆ·äº¤äº’**: å¤„ç†ç”¨æˆ·è¾“å…¥ã€æŒ‰é’®ç‚¹å‡»ç­‰æ“ä½œ
3. **APIè°ƒç”¨**: è°ƒç”¨åç«¯APIæ¥å£è·å–/æäº¤æ•°æ®
4. **æ•°æ®ç»‘å®š**: å°†åç«¯è¿”å›çš„æ•°æ®ç»‘å®šåˆ°é¡µé¢ç»„ä»¶
5. **çŠ¶æ€ç®¡ç†**: ç®¡ç†æœ¬åœ°é¡µé¢çŠ¶æ€å’Œç”¨æˆ·ç™»å½•çŠ¶æ€
6. **é”™è¯¯æç¤º**: å±•ç¤ºå‹å¥½çš„é”™è¯¯æç¤ºä¿¡æ¯

**âŒ å‰ç«¯ä¸è´Ÿè´£**:
- ä¸šåŠ¡é€»è¾‘è®¡ç®—(æŠ½å¥–æ¦‚ç‡ã€ç§¯åˆ†è®¡ç®—ç­‰)
- æ•°æ®å­˜å‚¨å’ŒæŒä¹…åŒ–
- æƒé™éªŒè¯å’Œå®‰å…¨æ§åˆ¶
- æ•æ„Ÿæ•°æ®å¤„ç†

#### ğŸ”§ åç«¯èŒè´£(Node.jsæœåŠ¡å™¨)
1. **ä¸šåŠ¡é€»è¾‘**: æ‰€æœ‰ä¸šåŠ¡è§„åˆ™çš„å®ç°å’Œæ‰§è¡Œ
2. **æ•°æ®å¤„ç†**: æ•°æ®çš„å¢åˆ æ”¹æŸ¥ã€è®¡ç®—ã€éªŒè¯
3. **æƒé™æ§åˆ¶**: ç”¨æˆ·æƒé™éªŒè¯ã€è§’è‰²ç®¡ç†
4. **æ•°æ®å®‰å…¨**: æ•æ„Ÿæ•°æ®è„±æ•ã€åŠ å¯†å¤„ç†
5. **äº‹åŠ¡ç®¡ç†**: æ•°æ®åº“äº‹åŠ¡æ§åˆ¶å’Œä¸€è‡´æ€§ä¿è¯
6. **æ–‡ä»¶å­˜å‚¨**: å›¾ç‰‡ä¸Šä¼ åˆ°Sealoså¯¹è±¡å­˜å‚¨

**âœ… åç«¯è¿”å›ç»™å‰ç«¯**:
- æ ‡å‡†åŒ–JSONå“åº”æ•°æ®
- å·²è„±æ•çš„å®‰å…¨æ•°æ®
- æ˜ç¡®çš„æˆåŠŸ/å¤±è´¥çŠ¶æ€
- å‹å¥½çš„é”™è¯¯æç¤ºä¿¡æ¯

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å¾®ä¿¡å°ç¨‹åºå‰ç«¯                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç”¨æˆ·é¡µé¢  â”‚  â”‚ æŠ½å¥–é¡µé¢  â”‚  â”‚ åº“å­˜é¡µé¢  â”‚  â”‚ç®¡ç†åå° â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â”‚
â”‚       â”‚             â”‚              â”‚             â”‚       â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                         â”‚ HTTP/HTTPS API                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Express APIæœåŠ¡å™¨(åç«¯)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚          ç»Ÿä¸€APIå“åº”æ ¼å¼ä¸­é—´ä»¶                       â”‚ â”‚
â”‚  â”‚  âœ… æˆåŠŸ: { success: true, data, message }         â”‚ â”‚
â”‚  â”‚  âŒ å¤±è´¥: { success: false, error, message }       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚è®¤è¯æƒé™ â”‚ â”‚æŠ½å¥–å¼•æ“ â”‚ â”‚åº“å­˜ç®¡ç† â”‚ â”‚ç§¯åˆ†ç³»ç»Ÿ â”‚ â”‚ç³»ç»Ÿ  â”‚ â”‚
â”‚  â”‚  æ¨¡å—  â”‚ â”‚  æ¨¡å—  â”‚ â”‚  æ¨¡å—  â”‚ â”‚  æ¨¡å—  â”‚ â”‚æ¨¡å—  â”‚ â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜ â”‚
â”‚      â”‚          â”‚           â”‚          â”‚          â”‚     â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                        Sequelize ORM                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MySQLæ•°æ®åº“ + Redisç¼“å­˜                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç”¨æˆ·è¡¨  â”‚ â”‚æŠ½å¥–è®°å½• â”‚ â”‚åº“å­˜è¡¨  â”‚ â”‚ç§¯åˆ†è¡¨  â”‚ â”‚Redis â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### V4.0 ç»Ÿä¸€æŠ½å¥–å¼•æ“æ¶æ„

**æ ¸å¿ƒç‰¹æ€§**:
1. **ç»Ÿä¸€å¼•æ“**: UnifiedLotteryEngineç»Ÿä¸€ç®¡ç†3ç§æŠ½å¥–ç­–ç•¥
2. **æ™ºèƒ½å†³ç­–**: è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æŠ½å¥–ç­–ç•¥
3. **æ•°æ®è„±æ•**: DataSanitizerè‡ªåŠ¨ä¿æŠ¤æ•æ„Ÿæ•°æ®
4. **åŒ—äº¬æ—¶é—´**: å…¨ç³»ç»Ÿç»Ÿä¸€ä½¿ç”¨åŒ—äº¬æ—¶é—´(Asia/Shanghai)
5. **æ´»åŠ¨æƒé™ç³»ç»Ÿ**: åŸºäºUUIDè§’è‰²çš„æ´»åŠ¨æƒé™æ§åˆ¶

---

## ğŸ“¡ APIé€šç”¨è§„èŒƒ

### 1. åŸºç¡€URL

**ç”Ÿäº§ç¯å¢ƒ**:
```
https://omqktqrtntnn.sealosbja.site
```

**å¼€å‘ç¯å¢ƒ**:
```
http://localhost:3000
```

**æ‰€æœ‰APIè·¯å¾„å‰ç¼€**:
```
/api/v4
```

**å®Œæ•´API URLç¤ºä¾‹**:
```
https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/auth/login
```

### 2. ç»Ÿä¸€å“åº”æ ¼å¼

æ‰€æœ‰APIå“åº”éƒ½éµå¾ªç»Ÿä¸€çš„JSONæ ¼å¼:

#### âœ… æˆåŠŸå“åº”æ ¼å¼
```json
{
  "success": true,
  "data": {
    // å®é™…ä¸šåŠ¡æ•°æ®
  },
  "message": "æ“ä½œæˆåŠŸæç¤ºä¿¡æ¯",
  "code": "SUCCESS_CODE", // ä¸šåŠ¡æˆåŠŸç (å¯é€‰)
  "timestamp": "2025-01-21T20:35:00.000+08:00" // åŒ—äº¬æ—¶é—´
}
```

#### âŒ å¤±è´¥å“åº”æ ¼å¼
```json
{
  "success": false,
  "error": "ERROR_CODE", // é”™è¯¯ä»£ç ,ç”¨äºå‰ç«¯åˆ¤æ–­é”™è¯¯ç±»å‹
  "message": "ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤ºä¿¡æ¯",
  "details": {
    // è¯¦ç»†é”™è¯¯ä¿¡æ¯(å¯é€‰,ä»…å¼€å‘ç¯å¢ƒ)
  },
  "timestamp": "2025-01-21T20:35:00.000+08:00" // åŒ—äº¬æ—¶é—´
}
```

### 3. é€šç”¨é”™è¯¯ç 

| é”™è¯¯ç  | HTTPçŠ¶æ€ç  | è¯´æ˜ | å‰ç«¯å¤„ç†å»ºè®® |
|-------|-----------|------|------------|
| `UNAUTHORIZED` | 401 | æœªç™»å½•æˆ–Tokenè¿‡æœŸ | è·³è½¬åˆ°ç™»å½•é¡µ |
| `FORBIDDEN` | 403 | æƒé™ä¸è¶³ | æ˜¾ç¤º"æ— æƒé™"æç¤º |
| `NOT_FOUND` | 404 | èµ„æºä¸å­˜åœ¨ | æ˜¾ç¤º"æœªæ‰¾åˆ°"æç¤º |
| `VALIDATION_ERROR` | 400 | å‚æ•°éªŒè¯å¤±è´¥ | æ˜¾ç¤ºå…·ä½“å‚æ•°é”™è¯¯ä¿¡æ¯ |
| `RATE_LIMIT_EXCEEDED` | 429 | è¯·æ±‚è¿‡äºé¢‘ç¹ | æç¤º"è¯·æ±‚è¿‡å¿«,è¯·ç¨åå†è¯•" |
| `INTERNAL_ERROR` | 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ | æ˜¾ç¤º"ç³»ç»Ÿé”™è¯¯,è¯·ç¨åé‡è¯•" |
| `INSUFFICIENT_POINTS` | 400 | ç§¯åˆ†ä¸è¶³ | æç¤ºç”¨æˆ·ç§¯åˆ†ä¸è¶³ |
| `NO_CAMPAIGN_PERMISSION` | 403 | æ— æ´»åŠ¨æƒé™ | æç¤ºç”¨æˆ·æ— è¯¥æ´»åŠ¨æƒé™ |
| `CAMPAIGN_NOT_FOUND` | 404 | æ´»åŠ¨ä¸å­˜åœ¨ | æç¤ºæ´»åŠ¨å·²ç»“æŸæˆ–ä¸å­˜åœ¨ |

### 4. è¯·æ±‚è®¤è¯

#### Tokenè®¤è¯æœºåˆ¶

**ç™»å½•åè·å–Token**:
```
POST /api/v4/unified-engine/auth/login
```

**å“åº”åŒ…å«Token**:
```json
{
  "success": true,
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...", // è®¿é—®Token(7å¤©æœ‰æ•ˆ)
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." // åˆ·æ–°Token(30å¤©æœ‰æ•ˆ)
  }
}
```

**åç»­è¯·æ±‚æºå¸¦Token**:
```javascript
// å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹
wx.request({
  url: 'https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/lottery/prizes/LUCKY2025',
  method: 'GET',
  header: {
    'Authorization': 'Bearer ' + access_token, // å¿…é¡»æºå¸¦Token
    'Content-Type': 'application/json'
  },
  success: (res) => {
    console.log('APIå“åº”:', res.data)
  }
})
```

**Tokenåˆ·æ–°**:
å½“`access_token`è¿‡æœŸ(7å¤©å),ä½¿ç”¨`refresh_token`åˆ·æ–°:
```
POST /api/v4/unified-engine/auth/refresh
Body: { "refresh_token": "..." }
```

### 5. è¯·æ±‚å¤´è§„èŒƒ

#### å¿…éœ€çš„è¯·æ±‚å¤´

| è¯·æ±‚å¤´ | å€¼ | è¯´æ˜ |
|-------|-----|------|
| `Content-Type` | `application/json` | è¯·æ±‚ä½“æ ¼å¼(POST/PUTè¯·æ±‚) |
| `Authorization` | `Bearer {token}` | è®¤è¯Token(éœ€è¦ç™»å½•çš„API) |

#### å¯é€‰çš„è¯·æ±‚å¤´

| è¯·æ±‚å¤´ | å€¼ç¤ºä¾‹ | è¯´æ˜ |
|-------|-------|------|
| `X-Platform` | `wechat-miniprogram` | å¹³å°æ ‡è¯† |
| `X-App-Version` | `1.0.0` | åº”ç”¨ç‰ˆæœ¬å· |

### 6. åˆ†é¡µè§„èŒƒ

æ‰€æœ‰åˆ—è¡¨ç±»APIéƒ½æ”¯æŒåˆ†é¡µ:

**åˆ†é¡µå‚æ•°**:
```
GET /api/v4/inventory/user/123?page=1&limit=20
```

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | æœ€å¤§å€¼ | è¯´æ˜ |
|-----|------|-------|-------|------|
| `page` | number | 1 | - | é¡µç (ä»1å¼€å§‹) |
| `limit` | number | 20 | 100 | æ¯é¡µæ¡æ•° |

**åˆ†é¡µå“åº”æ ¼å¼**:
```json
{
  "success": true,
  "data": {
    "items": [...], // æ•°æ®æ•°ç»„
    "pagination": {
      "page": 1,           // å½“å‰é¡µç 
      "limit": 20,         // æ¯é¡µæ¡æ•°
      "total": 156,        // æ€»è®°å½•æ•°
      "total_pages": 8,    // æ€»é¡µæ•°
      "has_next": true,    // æ˜¯å¦æœ‰ä¸‹ä¸€é¡µ
      "has_prev": false    // æ˜¯å¦æœ‰ä¸Šä¸€é¡µ
    }
  }
}
```

### 7. æ—¶é—´æ ¼å¼è§„èŒƒ

**ğŸ• å…¨ç³»ç»Ÿç»Ÿä¸€ä½¿ç”¨åŒ—äº¬æ—¶é—´(GMT+8/Asia/Shanghai)**

**æ—¶é—´æ ¼å¼æ ‡å‡†**:
```
ISO 8601æ ¼å¼(åŒ…å«æ—¶åŒº): 2025-01-21T20:35:00.000+08:00
æ˜¾ç¤ºæ ¼å¼:              2025-01-21 20:35:00
ä¸­æ–‡æ˜¾ç¤ºæ ¼å¼:          2025å¹´01æœˆ21æ—¥ 20:35:00
```

**å‰ç«¯å¤„ç†å»ºè®®**:
```javascript
// å¾®ä¿¡å°ç¨‹åºæ—¶é—´å¤„ç†ç¤ºä¾‹
function formatTime(isoString) {
  // åç«¯è¿”å›çš„æ˜¯å¸¦æ—¶åŒºçš„ISOæ ¼å¼: "2025-01-21T20:35:00.000+08:00"
  const date = new Date(isoString);
  
  // æ ¼å¼åŒ–ä¸º YYYY-MM-DD HH:mm:ss
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const seconds = String(date.getSeconds()).padStart(2, '0');
  
  return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

// ä½¿ç”¨ç¤ºä¾‹
const displayTime = formatTime(response.data.created_at);
// è¾“å‡º: "2025-01-21 20:35:00"
```

### 8. æ•°æ®è„±æ•è¯´æ˜

**âš ï¸ é‡è¦ï¼šæ•°æ®å®‰å…¨å’Œé˜²æ³„å¯†æœºåˆ¶**

ä¸ºé˜²æ­¢å•†ä¸šæœºå¯†æ³„éœ²å’Œç”¨æˆ·éšç§ä¿æŠ¤ï¼Œåç«¯å·²å®ç°è‡ªåŠ¨æ•°æ®è„±æ•æœºåˆ¶ã€‚

**åç«¯è‡ªåŠ¨è„±æ•çš„æ•æ„Ÿå­—æ®µ**:
- **æŠ½å¥–æ¦‚ç‡** (`probability`): ğŸ”´ æ ¸å¿ƒå•†ä¸šæœºå¯†ï¼Œæ™®é€šç”¨æˆ·å®Œå…¨ä¸å¯è§
- **åº“å­˜æ•°é‡** (`stock`, `initial_stock`): ğŸ”´ è¿è¥æœºå¯†ï¼Œæ™®é€šç”¨æˆ·ä¸å¯è§
- **æˆæœ¬ä»·æ ¼** (`cost_price`): ğŸ”´ è´¢åŠ¡æœºå¯†ï¼Œæ™®é€šç”¨æˆ·ä¸å¯è§
- **ä¿åº•é…ç½®** (`guarantee_config`): ğŸ”´ ä¸šåŠ¡è§„åˆ™æœºå¯†ï¼Œæ™®é€šç”¨æˆ·ä¸å¯è§
- **æ‰‹æœºå·**: ğŸŸ¡ è„±æ•æ˜¾ç¤ºä¸º `138****5678` (ä»…æ˜¾ç¤ºåç«¯è¿”å›çš„æ‰‹æœºå·ï¼Œä¸åšäºŒæ¬¡è„±æ•)
- **çœŸå®å§“å**: ğŸŸ¡ ä»…ç®¡ç†å‘˜å¯è§
- **å†…éƒ¨æ•°æ®åº“ID**: ä½¿ç”¨`campaign_code`ç­‰ä»£ç ä»£æ›¿æ•°æ®åº“ä¸»é”®ID

**æ•°æ®è„±æ•åˆ†çº§**:

| ç”¨æˆ·ç±»å‹ | æ•°æ®çº§åˆ« | å¯è§å†…å®¹ | ä¸å¯è§å†…å®¹ |
|---------|---------|---------|----------|
| æ™®é€šç”¨æˆ· | `basic` | å¥–å“åç§°ã€æè¿°ã€å›¾ç‰‡ã€ç”¨æˆ·è‡ªå·±çš„æ•°æ® | æ¦‚ç‡ã€åº“å­˜ã€æˆæœ¬ã€ä¿åº•è§„åˆ™ã€å…¶ä»–ç”¨æˆ·éšç§ |
| ç®¡ç†å‘˜ | `full` | æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬æ•æ„Ÿå­—æ®µ | æ— é™åˆ¶ |

**å‰ç«¯å¼€å‘æ³¨æ„äº‹é¡¹**:
1. âœ… **ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„æ•°æ®**ï¼Œåç«¯å·²å®Œæˆè„±æ•å¤„ç†
2. âŒ **ä¸è¦å°è¯•æ¨æµ‹æˆ–è®¡ç®—**æ¦‚ç‡ã€åº“å­˜ç­‰æ•æ„Ÿæ•°æ®
3. âŒ **ä¸è¦åœ¨å‰ç«¯ç¼“å­˜**æ•æ„Ÿä¿¡æ¯
4. âŒ **ä¸è¦åœ¨console.logä¸­æ‰“å°**Tokenã€å¯†ç ç­‰è®¤è¯ä¿¡æ¯
5. âœ… **æ‰‹æœºå·æ˜¾ç¤º**ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„å€¼ï¼Œå‰ç«¯ä¸åšäºŒæ¬¡è„±æ•

**é˜²æ­¢æŠ“åŒ…æ³„å¯†æªæ–½**:
- ğŸ”’ æ‰€æœ‰æ•æ„Ÿä¸šåŠ¡é€»è¾‘åœ¨åç«¯æ‰§è¡Œ
- ğŸ”’ å‰ç«¯åªæ¥æ”¶å¿…è¦çš„å±•ç¤ºæ•°æ®
- ğŸ”’ ä½¿ç”¨HTTPSåŠ å¯†ä¼ è¾“
- ğŸ”’ Tokenæœ‰æ•ˆæœŸç®¡ç†ï¼ˆ7å¤©è¿‡æœŸï¼‰
- ğŸ”’ æ•æ„Ÿæ“ä½œéœ€è¦æƒé™éªŒè¯

### 9. å›¾ç‰‡èµ„æºè®¿é—®

**å›¾ç‰‡URLæ ¼å¼**:
```
https://sealos-objectstorage.com/bucket-name/path/to/image.jpg
```

**å¾®ä¿¡å°ç¨‹åºå›¾ç‰‡æ˜¾ç¤º**:
```xml
<!-- ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„URL -->
<image src="{{imageUrl}}" mode="aspectFill"></image>
```

**ç¼©ç•¥å›¾æ”¯æŒ**:
åç«¯è‡ªåŠ¨ç”Ÿæˆ3ç§å°ºå¯¸çš„ç¼©ç•¥å›¾:
- `thumbnail_small`: 150x150px (åˆ—è¡¨æ˜¾ç¤º)
- `thumbnail_medium`: 500x500px (è¯¦æƒ…é¡µæ˜¾ç¤º)
- `thumbnail_large`: 1000x1000px (æŸ¥çœ‹å¤§å›¾)

```json
{
  "image_url": "åŸå›¾URL",
  "thumbnails": {
    "small": "å°ç¼©ç•¥å›¾URL",
    "medium": "ä¸­ç¼©ç•¥å›¾URL",
    "large": "å¤§ç¼©ç•¥å›¾URL"
  }
}
```

---

## ğŸ” æƒé™ç³»ç»Ÿè¯´æ˜

### è§’è‰²å®šä¹‰

| è§’è‰²åç§° | role_name | æƒé™è¯´æ˜ |
|---------|-----------|----------|
| è¶…çº§ç®¡ç†å‘˜ | `admin` | æ‹¥æœ‰æ‰€æœ‰æƒé™,å¯ç®¡ç†æ‰€æœ‰åŠŸèƒ½ |
| æ™®é€šç”¨æˆ· | `user` | åŸºç¡€ç”¨æˆ·æƒé™,å¯å‚ä¸æŠ½å¥–å’Œå…‘æ¢ |
| æ´»åŠ¨ä¸“å±è§’è‰² | `campaign_{æ´»åŠ¨ID}` | å¯å‚ä¸æŒ‡å®šæ´»åŠ¨çš„æŠ½å¥– |

### æ´»åŠ¨æƒé™æœºåˆ¶(V2.0æ–°å¢)

**æƒé™åˆ¤æ–­é€»è¾‘**:
1. **è¶…çº§ç®¡ç†å‘˜(admin)**: è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æ´»åŠ¨æƒé™
2. **æ™®é€šç”¨æˆ·**: éœ€è¦æ˜ç¡®åˆ†é…æ´»åŠ¨è§’è‰²æ‰èƒ½å‚ä¸æŒ‡å®šæ´»åŠ¨
3. **æ´»åŠ¨è§’è‰²å‘½å**: `campaign_{campaign_id}` (ä¾‹å¦‚: `campaign_123`)

**æƒé™æ£€æŸ¥æµç¨‹**:
```
ç”¨æˆ·è¯·æ±‚æŠ½å¥– 
  â†“
åç«¯æ£€æŸ¥ç”¨æˆ·è§’è‰²
  â†“
æ˜¯å¦æ˜¯admin? â†’ æ˜¯ â†’ å…è®¸æŠ½å¥–
  â†“ å¦
æ˜¯å¦æœ‰campaign_{æ´»åŠ¨ID}è§’è‰²? â†’ æ˜¯ â†’ å…è®¸æŠ½å¥–
  â†“ å¦
è¿”å›403é”™è¯¯: NO_CAMPAIGN_PERMISSION
```

**å‰ç«¯å¤„ç†å»ºè®®**:
```javascript
// è°ƒç”¨æŠ½å¥–API
wx.request({
  url: '/api/v4/unified-engine/lottery/draw',
  method: 'POST',
  data: {
    campaign_code: 'LUCKY2025',
    draw_count: 1
  },
  success: (res) => {
    if (res.data.success) {
      // æŠ½å¥–æˆåŠŸ
    }
  },
  fail: (err) => {
    if (err.error === 'NO_CAMPAIGN_PERMISSION') {
      // æ˜¾ç¤º: "æ‚¨æ²¡æœ‰å‚åŠ æ­¤æ´»åŠ¨çš„æƒé™,è¯·è”ç³»ç®¡ç†å‘˜"
      wx.showModal({
        title: 'æ— æƒé™',
        content: 'æ‚¨è¿˜æ²¡æœ‰è·å¾—è¯¥æ´»åŠ¨çš„å‚ä¸èµ„æ ¼,è¯·è”ç³»ç®¡ç†å‘˜å¼€é€šæƒé™',
        showCancel: false
      });
    }
  }
});
```

---

## ğŸ“Š APIæ¨¡å—æ¦‚è§ˆ

### æ ¸å¿ƒAPIæ¨¡å—

| æ¨¡å— | åŸºç¡€è·¯å¾„ | è¯´æ˜ | è®¤è¯è¦æ±‚ |
|------|---------|------|---------|
| è®¤è¯æƒé™ | `/api/v4/unified-engine/auth` | ç”¨æˆ·ç™»å½•ã€Tokenç®¡ç†ã€æƒé™æŸ¥è¯¢ | éƒ¨åˆ†éœ€è¦ |
| æŠ½å¥–æ ¸å¿ƒ | `/api/v4/unified-engine/lottery` | æŠ½å¥–æ‰§è¡Œã€å¥–å“æŸ¥è¯¢ã€å†å²è®°å½• | éœ€è¦ |
| åº“å­˜ç®¡ç† | `/api/v4/inventory` | ç”¨æˆ·åº“å­˜ã€å•†å“å…‘æ¢ã€ç‰©å“ä½¿ç”¨ | éœ€è¦ |
| ç§¯åˆ†ç³»ç»Ÿ | `/api/v4/unified-engine/points` | ç§¯åˆ†æŸ¥è¯¢ã€äº¤æ˜“è®°å½•ã€ç»Ÿè®¡ä¿¡æ¯ | éœ€è¦ |
| å›¾ç‰‡ç®¡ç† | `/api/v4/photo` | å›¾ç‰‡ä¸Šä¼ ã€å®¡æ ¸ã€ç¼©ç•¥å›¾ | éœ€è¦ |
| ç³»ç»ŸåŠŸèƒ½ | `/api/v4/system` | ç³»ç»Ÿå…¬å‘Šã€åé¦ˆã€èŠå¤©ã€é…ç½® | éƒ¨åˆ†éœ€è¦ |
| æƒé™ç®¡ç† | `/api/v4/permissions` | æƒé™æŸ¥è¯¢ã€è§’è‰²ç®¡ç† | éœ€è¦ |
| ç®¡ç†åå° | `/api/v4/unified-engine/admin` | ç®¡ç†å‘˜ä¸“ç”¨åŠŸèƒ½ | éœ€è¦ç®¡ç†å‘˜æƒé™ |

### APIæ•°é‡ç»Ÿè®¡

| æ¨¡å— | ç”¨æˆ·ç«¯API | ç®¡ç†ç«¯API | æ€»è®¡ |
|------|----------|----------|------|
| è®¤è¯æƒé™ | 5 | 0 | 5 |
| æŠ½å¥–æ ¸å¿ƒ | 7 | 0 | 7 |
| åº“å­˜ç®¡ç† | 12 | 2 | 14 |
| ç§¯åˆ†ç³»ç»Ÿ | 4 | 2 | 6 |
| å›¾ç‰‡ç®¡ç† | 4 | 3 | 7 |
| ç³»ç»ŸåŠŸèƒ½ | 10 | 6 | 16 |
| æƒé™ç®¡ç† | 4 | 1 | 5 |
| ç®¡ç†åå° | 0 | 30+ | 30+ |
| **æ€»è®¡** | **46** | **44+** | **90+** |

---

## ğŸ¯ å¿«é€Ÿå¼€å§‹

### 1. ç”¨æˆ·ç™»å½•æµç¨‹

```javascript
// Step 1: è°ƒç”¨ç™»å½•API
wx.request({
  url: 'https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/auth/login',
  method: 'POST',
  data: {
    mobile: '13800138000',
    verification_code: '123456' // å¼€å‘ç¯å¢ƒä¸‡èƒ½éªŒè¯ç 
  },
  success: (res) => {
    if (res.data.success) {
      // Step 2: ä¿å­˜Tokenåˆ°æœ¬åœ°å­˜å‚¨
      wx.setStorageSync('access_token', res.data.data.access_token);
      wx.setStorageSync('refresh_token', res.data.data.refresh_token);
      wx.setStorageSync('user_info', res.data.data.user);
      
      // Step 3: è·³è½¬åˆ°é¦–é¡µ
      wx.switchTab({
        url: '/pages/index/index'
      });
    }
  }
});
```

### 2. è·å–å¥–å“åˆ—è¡¨

```javascript
// è°ƒç”¨å¥–å“åˆ—è¡¨API
wx.request({
  url: 'https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/lottery/prizes/LUCKY2025',
  method: 'GET',
  header: {
    'Authorization': 'Bearer ' + wx.getStorageSync('access_token')
  },
  success: (res) => {
    if (res.data.success) {
      // å±•ç¤ºå¥–å“åˆ—è¡¨
      this.setData({
        prizes: res.data.data
      });
    }
  }
});
```

### 3. æ‰§è¡ŒæŠ½å¥–

```javascript
// è°ƒç”¨æŠ½å¥–API
wx.request({
  url: 'https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/lottery/draw',
  method: 'POST',
  header: {
    'Authorization': 'Bearer ' + wx.getStorageSync('access_token')
  },
  data: {
    campaign_code: 'LUCKY2025',
    draw_count: 1
  },
  success: (res) => {
    if (res.data.success) {
      // å±•ç¤ºæŠ½å¥–ç»“æœ
      const result = res.data.data;
      wx.showModal({
        title: result.prizes[0].is_winner ? 'æ­å–œä¸­å¥–!' : 'æœªä¸­å¥–',
        content: result.prizes[0].name
      });
    }
  }
});
```

---

## ğŸ“ å¼€å‘ç¯å¢ƒé…ç½®

### å¾®ä¿¡å°ç¨‹åºé…ç½®

**1. æœåŠ¡å™¨åŸŸåé…ç½®**
```
å¼€å‘è®¾ç½® -> æœåŠ¡å™¨åŸŸå -> requeståˆæ³•åŸŸå
æ·»åŠ : https://omqktqrtntnn.sealosbja.site
```

**2. ä¸æ ¡éªŒåˆæ³•åŸŸå(å¼€å‘è°ƒè¯•)**
```
å¾®ä¿¡å¼€å‘è€…å·¥å…· -> è¯¦æƒ… -> æœ¬åœ°è®¾ç½®
å‹¾é€‰: ä¸æ ¡éªŒåˆæ³•åŸŸåã€web-view(ä¸šåŠ¡åŸŸå)ã€TLSç‰ˆæœ¬ä»¥åŠHTTPSè¯ä¹¦
```

**3. å…¨å±€APIé…ç½®(æ¨è)**

åˆ›å»º `utils/api.js`:
```javascript
const BASE_URL = 'https://omqktqrtntnn.sealosbja.site';
const API_PREFIX = '/api/v4';

/**
 * ç»Ÿä¸€APIè¯·æ±‚å‡½æ•°
 */
function request(options) {
  return new Promise((resolve, reject) => {
    wx.request({
      url: BASE_URL + API_PREFIX + options.url,
      method: options.method || 'GET',
      data: options.data || {},
      header: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + wx.getStorageSync('access_token'),
        ...options.header
      },
      success: (res) => {
        if (res.data.success) {
          resolve(res.data.data);
        } else {
          // ç»Ÿä¸€é”™è¯¯å¤„ç†
          wx.showToast({
            title: res.data.message || 'æ“ä½œå¤±è´¥',
            icon: 'none'
          });
          reject(res.data);
        }
      },
      fail: (err) => {
        wx.showToast({
          title: 'ç½‘ç»œè¯·æ±‚å¤±è´¥',
          icon: 'none'
        });
        reject(err);
      }
    });
  });
}

module.exports = {
  // è®¤è¯ç›¸å…³
  login: (data) => request({ url: '/unified-engine/auth/login', method: 'POST', data }),
  getProfile: () => request({ url: '/unified-engine/auth/profile', method: 'GET' }),
  
  // æŠ½å¥–ç›¸å…³
  getPrizes: (campaignCode) => request({ url: `/unified-engine/lottery/prizes/${campaignCode}`, method: 'GET' }),
  draw: (data) => request({ url: '/unified-engine/lottery/draw', method: 'POST', data }),
  
  // æ›´å¤šAPI...
};
```

ä½¿ç”¨ç¤ºä¾‹:
```javascript
const API = require('../../utils/api.js');

// è°ƒç”¨ç™»å½•
API.login({ mobile: '13800138000', verification_code: '123456' })
  .then(data => {
    console.log('ç™»å½•æˆåŠŸ:', data);
  })
  .catch(err => {
    console.error('ç™»å½•å¤±è´¥:', err);
  });
```

---

## ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. Tokenå®‰å…¨
- **ä¸è¦åœ¨URLä¸­ä¼ é€’Token**, å¿…é¡»æ”¾åœ¨è¯·æ±‚å¤´ `Authorization: Bearer {token}`
- **Tokenè¿‡æœŸå¤„ç†**: access_tokenæœ‰æ•ˆæœŸ7å¤©, è¿‡æœŸåä½¿ç”¨refresh_tokenåˆ·æ–°
- **ä¸è¦å°†Tokenå­˜å‚¨åœ¨é¡µé¢dataä¸­**, ä½¿ç”¨ `wx.getStorageSync()` è¯»å–

### 2. æ•æ„Ÿä¿¡æ¯ä¿æŠ¤
- åç«¯å·²è‡ªåŠ¨è„±æ•æ‰‹æœºå·ã€çœŸå®å§“åç­‰æ•æ„Ÿä¿¡æ¯
- å‰ç«¯**ä¸è¦ç¼“å­˜æ•æ„Ÿæ•°æ®**, æ¯æ¬¡ä»APIè·å–æœ€æ–°æ•°æ®
- **ä¸è¦åœ¨console.logä¸­æ‰“å°Tokenæˆ–å¯†ç **

### 3. HTTPSå¼ºåˆ¶
- ç”Ÿäº§ç¯å¢ƒ**å¿…é¡»ä½¿ç”¨HTTPS**
- å¾®ä¿¡å°ç¨‹åº**ä¸å…è®¸HTTPè¯·æ±‚**(å¼€å‘è°ƒè¯•é™¤å¤–)

### 4. æ•°æ®éªŒè¯
- åç«¯å·²è¿›è¡Œå‚æ•°éªŒè¯,ä½†**å‰ç«¯ä¹Ÿåº”åšåŸºç¡€éªŒè¯**
- ä¾‹å¦‚: æ‰‹æœºå·æ ¼å¼ã€éªŒè¯ç é•¿åº¦ã€å¿…å¡«é¡¹æ£€æŸ¥

---

**ğŸ“„ æ–‡æ¡£ç¬¬1éƒ¨åˆ†å®Œæˆ**

**ä¸‹ä¸€éƒ¨åˆ†**: Part2 - è®¤è¯å’Œæƒé™æ¨¡å—è¯¦ç»†API


---


**æ–‡æ¡£éƒ¨åˆ†**: ç¬¬2éƒ¨åˆ† - è®¤è¯å’Œæƒé™æ¨¡å—
**åˆ›å»ºæ—¶é—´**: 2025å¹´01æœˆ21æ—¥ (åŒ—äº¬æ—¶é—´)
**åŸºäºå®é™…ä»£ç éªŒè¯**: âœ…

---

## ğŸ“– æ¨¡å—æ¦‚è¿°

### è®¤è¯æ¨¡å—(`/api/v4/unified-engine/auth`)
è´Ÿè´£ç”¨æˆ·èº«ä»½è®¤è¯ã€Tokenç®¡ç†ã€ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢

### æƒé™æ¨¡å—(`/api/v4/permissions`)
è´Ÿè´£è§’è‰²æƒé™æŸ¥è¯¢ã€æƒé™éªŒè¯ã€ç®¡ç†å‘˜åˆ—è¡¨

---

## ğŸ” è®¤è¯æ¨¡å—API

### 2.1 ç”¨æˆ·ç™»å½•(æ‰‹æœºå·éªŒè¯ç )

**APIè·¯å¾„**: `POST /api/v4/unified-engine/auth/login`

**åŠŸèƒ½è¯´æ˜**:
- ç”¨æˆ·é€šè¿‡æ‰‹æœºå·å’ŒéªŒè¯ç ç™»å½•
- **è‡ªåŠ¨æ³¨å†Œ**: é¦–æ¬¡ç™»å½•è‡ªåŠ¨åˆ›å»ºè´¦å·
- **è‡ªåŠ¨åˆå§‹åŒ–**: è‡ªåŠ¨åˆ›å»ºç§¯åˆ†è´¦æˆ·ã€åˆ†é…é»˜è®¤è§’è‰²
- **å¼€å‘ç¯å¢ƒ**: ä¸‡èƒ½éªŒè¯ç `123456`å¯ç”¨äºä»»ä½•æ‰‹æœºå·

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/auth.js` - loginç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

```json
{
  "mobile": "13800138000",           // å¿…å¡«, ä¸­å›½å¤§é™†æ‰‹æœºå·
  "verification_code": "123456"      // å¿…å¡«, 6ä½æ•°å­—éªŒè¯ç 
}
```

**å‚æ•°éªŒè¯è§„åˆ™**:
| å‚æ•° | ç±»å‹ | å¿…å¡« | éªŒè¯è§„åˆ™ | é”™è¯¯æç¤º |
|------|------|------|---------|---------|
| `mobile` | string | æ˜¯ | 11ä½æ•°å­—,1å¼€å¤´ | "æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®" |
| `verification_code` | string | æ˜¯ | 6ä½æ•°å­— | "éªŒè¯ç æ ¼å¼ä¸æ­£ç¡®" |

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "ç™»å½•æˆåŠŸ",
  "code": "SUCCESS",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",  // è®¿é—®Token(7å¤©æœ‰æ•ˆ)
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...", // åˆ·æ–°Token(30å¤©æœ‰æ•ˆ)
    "user": {
      "user_id": 1,                   // ç”¨æˆ·ID (åç«¯ä½¿ç”¨user_idå­—æ®µ)
      "mobile": "13800138000",        // æ‰‹æœºå·(åç«¯è¿”å›å®Œæ•´æ‰‹æœºå·ï¼Œå‰ç«¯å¯é€‰æ‹©è„±æ•æ˜¾ç¤º)
      "nickname": "ç”¨æˆ·0000",         // ç”¨æˆ·æ˜µç§° (è‡ªåŠ¨ç”Ÿæˆ: ç”¨æˆ·+æ‰‹æœºå·å4ä½)
      "role_based_admin": false,      // æ˜¯å¦æ˜¯ç®¡ç†å‘˜(åŸºäºè§’è‰²è®¡ç®—)
      "roles": [                      // ç”¨æˆ·è§’è‰²æ•°ç»„
        {
          "role_id": "550e8400-e29b-41d4-a716-446655440002",  // è§’è‰²UUID
          "role_name": "user",        // è§’è‰²åç§°
          "role_level": 0,            // è§’è‰²çº§åˆ«: 0=æ™®é€šç”¨æˆ·, >=100=ç®¡ç†å‘˜
          "description": "æ™®é€šç”¨æˆ·",  // è§’è‰²æè¿°
          "is_active": true           // è§’è‰²æ˜¯å¦æ¿€æ´»
        }
      ],
      "status": "active",             // ç”¨æˆ·çŠ¶æ€: active(æ­£å¸¸)/inactive(ç¦ç”¨)
      "last_login": "2025-10-22T00:06:10.000+08:00",  // æœ€åç™»å½•æ—¶é—´(åŒ—äº¬æ—¶é—´)
      "login_count": 1                // ç™»å½•æ¬¡æ•°
    },
    "is_new_user": true,              // æ˜¯å¦æ˜¯æ–°æ³¨å†Œç”¨æˆ·
    "expires_in": 604800,             // access_tokenè¿‡æœŸæ—¶é—´(ç§’), 7å¤©=604800ç§’
    "timestamp": "2025-10-22T00:06:10.000+08:00"  // å“åº”æ—¶é—´æˆ³(åŒ—äº¬æ—¶é—´)
  },
  "timestamp": "2025-10-22T00:06:10.000+08:00"
}
```

#### å¤±è´¥å“åº”

**éªŒè¯ç é”™è¯¯**:
```json
{
  "success": false,
  "error": "VERIFICATION_CODE_INVALID",
  "message": "éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸ",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

**æ‰‹æœºå·æ ¼å¼é”™è¯¯**:
```json
{
  "success": false,
  "error": "VALIDATION_ERROR",
  "message": "æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

#### å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹ä»£ç 

```javascript
// pages/login/login.js

Page({
  data: {
    mobile: '',
    code: ''
  },
  
  // è¾“å…¥æ‰‹æœºå·
  onMobileInput(e) {
    this.setData({
      mobile: e.detail.value
    });
  },
  
  // è¾“å…¥éªŒè¯ç 
  onCodeInput(e) {
    this.setData({
      code: e.detail.value
    });
  },
  
  // ç™»å½•
  async handleLogin() {
    const { mobile, code } = this.data;
    
    // å‰ç«¯åŸºç¡€éªŒè¯
    if (!mobile || !/^1[3-9]\d{9}$/.test(mobile)) {
      wx.showToast({
        title: 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·',
        icon: 'none'
      });
      return;
    }
    
    if (!code || code.length !== 6) {
      wx.showToast({
        title: 'è¯·è¾“å…¥6ä½éªŒè¯ç ',
        icon: 'none'
      });
      return;
    }
    
    // æ˜¾ç¤ºåŠ è½½æç¤º
    wx.showLoading({
      title: 'ç™»å½•ä¸­...',
      mask: true
    });
    
    try {
      // è°ƒç”¨ç™»å½•API
      const res = await wx.request({
        url: 'https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/auth/login',
        method: 'POST',
        data: {
          mobile: mobile,
          verification_code: code
        },
        header: {
          'Content-Type': 'application/json'
        }
      });
      
      wx.hideLoading();
      
      if (res.data.success) {
        // ä¿å­˜Tokenåˆ°æœ¬åœ°å­˜å‚¨
        wx.setStorageSync('access_token', res.data.data.access_token);
        wx.setStorageSync('refresh_token', res.data.data.refresh_token);
        wx.setStorageSync('user_info', res.data.data.user);
        
        wx.showToast({
          title: 'ç™»å½•æˆåŠŸ',
          icon: 'success'
        });
        
        // è·³è½¬åˆ°é¦–é¡µ
        setTimeout(() => {
          wx.switchTab({
            url: '/pages/index/index'
          });
        }, 1500);
      } else {
        wx.showToast({
          title: res.data.message || 'ç™»å½•å¤±è´¥',
          icon: 'none'
        });
      }
    } catch (error) {
      wx.hideLoading();
      wx.showToast({
        title: 'ç½‘ç»œè¯·æ±‚å¤±è´¥',
        icon: 'none'
      });
      console.error('ç™»å½•å¤±è´¥:', error);
    }
  }
});
```

```xml
<!-- pages/login/login.wxml -->
<view class="login-container">
  <view class="logo">
    <image src="/images/logo.png" mode="aspectFit"></image>
  </view>
  
  <view class="form">
    <input 
      class="input" 
      type="number" 
      placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
      maxlength="11"
      bindinput="onMobileInput"
      value="{{mobile}}"
    />
    
    <view class="code-row">
      <input 
        class="input code-input" 
        type="number" 
        placeholder="è¯·è¾“å…¥éªŒè¯ç "
        maxlength="6"
        bindinput="onCodeInput"
        value="{{code}}"
      />
      <button class="send-code-btn" size="mini">å‘é€éªŒè¯ç </button>
    </view>
    
    <button class="login-btn" type="primary" bindtap="handleLogin">
      ç™»å½•
    </button>
    
    <view class="tips">
      é¦–æ¬¡ç™»å½•å°†è‡ªåŠ¨æ³¨å†Œè´¦å·
    </view>
  </view>
</view>
```

---

### 2.2 å¿«é€Ÿç™»å½•(å…éªŒè¯ç )

**APIè·¯å¾„**: `POST /api/v4/unified-engine/auth/quick-login`

**åŠŸèƒ½è¯´æ˜**:
- **æµ‹è¯•ä¸“ç”¨**: ä»…ç”¨äºå¼€å‘æµ‹è¯•ç¯å¢ƒ
- æ— éœ€éªŒè¯ç ,ç›´æ¥é€šè¿‡æ‰‹æœºå·ç™»å½•
- è‡ªåŠ¨æ³¨å†Œé€»è¾‘ä¸å¸¸è§„ç™»å½•ç›¸åŒ

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/auth.js` - quickLoginç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

```json
{
  "mobile": "13800138000"            // å¿…å¡«, æ‰‹æœºå·
}
```

#### æˆåŠŸå“åº”

å“åº”æ ¼å¼ä¸ `POST /login` å®Œå…¨ç›¸åŒ,åŒ…å«:
- userå¯¹è±¡(ç”¨æˆ·ä¿¡æ¯)
- access_token(è®¿é—®Token)
- refresh_token(åˆ·æ–°Token)
- expires_in(è¿‡æœŸæ—¶é—´)

#### å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹

```javascript
// å¿«é€Ÿç™»å½•(ä»…å¼€å‘æµ‹è¯•ä½¿ç”¨)
async quickLogin(mobile) {
  try {
    const res = await wx.request({
      url: 'https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/auth/quick-login',
      method: 'POST',
      data: { mobile }
    });
    
    if (res.data.success) {
      // ä¿å­˜Token
      wx.setStorageSync('access_token', res.data.data.access_token);
      wx.setStorageSync('refresh_token', res.data.data.refresh_token);
      
      return res.data.data.user;
    }
  } catch (error) {
    console.error('å¿«é€Ÿç™»å½•å¤±è´¥:', error);
    throw error;
  }
}
```

---

### 2.3 è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯

**APIè·¯å¾„**: `GET /api/v4/unified-engine/auth/profile`

**åŠŸèƒ½è¯´æ˜**:
- è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„å®Œæ•´ä¿¡æ¯
- **éœ€è¦Tokenè®¤è¯**
- åŒ…å«ç”¨æˆ·è§’è‰²ã€æƒé™ã€ç»Ÿè®¡ä¿¡æ¯

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/auth.js` - profileç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

æ— è¯·æ±‚å‚æ•°,é€šè¿‡Tokenè¯†åˆ«ç”¨æˆ·

#### è¯·æ±‚å¤´

```
Authorization: Bearer {access_token}
```

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "id": 1,
    "mobile": "138****8000",          // è„±æ•æ‰‹æœºå·
    "real_name": null,                // çœŸå®å§“å(éœ€ç”¨æˆ·ä¸»åŠ¨å¡«å†™)
    "nickname": "ç”¨æˆ·æ˜µç§°",
    "avatar": "https://...",
    "email": null,
    "gender": null,                   // æ€§åˆ«: null/male/female
    "birthday": null,                 // ç”Ÿæ—¥
    "address": null,                  // åœ°å€
    "roles": [                        // ç”¨æˆ·è§’è‰²åˆ—è¡¨
      {
        "id": 2,
        "role_name": "user",
        "description": "æ™®é€šç”¨æˆ·",
        "role_level": 0,
        "permissions": [              // è§’è‰²æ‹¥æœ‰çš„æƒé™åˆ—è¡¨
          {
            "id": 10,
            "resource": "lottery",    // èµ„æºç±»å‹
            "action": "draw",         // æ“ä½œç±»å‹
            "description": "æ‰§è¡ŒæŠ½å¥–"
          },
          {
            "id": 11,
            "resource": "inventory",
            "action": "view",
            "description": "æŸ¥çœ‹åº“å­˜"
          }
        ]
      }
    ],
    "role_based_admin": false,        // æ˜¯å¦æ˜¯ç®¡ç†å‘˜
    "status": "active",               // è´¦å·çŠ¶æ€: active/inactive/banned
    "created_at": "2025-01-21T20:35:00.000+08:00",
    "updated_at": "2025-01-21T20:35:00.000+08:00",
    "last_login_at": "2025-01-21T20:35:00.000+08:00"
  }
}
```

#### å¤±è´¥å“åº”

**Tokenè¿‡æœŸ**:
```json
{
  "success": false,
  "error": "UNAUTHORIZED",
  "message": "Tokenå·²è¿‡æœŸ,è¯·é‡æ–°ç™»å½•",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

**Tokenæ— æ•ˆ**:
```json
{
  "success": false,
  "error": "UNAUTHORIZED",
  "message": "æ— æ•ˆçš„Token",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

#### å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹

```javascript
// pages/profile/profile.js

Page({
  data: {
    userInfo: null,
    isAdmin: false
  },
  
  onLoad() {
    this.loadUserProfile();
  },
  
  async loadUserProfile() {
    try {
      const access_token = wx.getStorageSync('access_token');
      
      if (!access_token) {
        // æœªç™»å½•,è·³è½¬åˆ°ç™»å½•é¡µ
        wx.redirectTo({
          url: '/pages/login/login'
        });
        return;
      }
      
      const res = await wx.request({
        url: 'https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/auth/profile',
        method: 'GET',
        header: {
          'Authorization': 'Bearer ' + access_token
        }
      });
      
      if (res.data.success) {
        this.setData({
          userInfo: res.data.data,
          isAdmin: res.data.data.role_based_admin
        });
        
        // åŒæ—¶æ›´æ–°æœ¬åœ°ç¼“å­˜
        wx.setStorageSync('user_info', res.data.data);
      } else if (res.data.error === 'UNAUTHORIZED') {
        // Tokenè¿‡æœŸ,å°è¯•åˆ·æ–°
        this.refreshToken();
      }
    } catch (error) {
      wx.showToast({
        title: 'åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥',
        icon: 'none'
      });
    }
  },
  
  // åˆ·æ–°Token
  async refreshToken() {
    const refresh_token = wx.getStorageSync('refresh_token');
    
    if (!refresh_token) {
      // æ— åˆ·æ–°Token,è·³è½¬åˆ°ç™»å½•
      wx.redirectTo({
        url: '/pages/login/login'
      });
      return;
    }
    
    try {
      const res = await wx.request({
        url: 'https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/auth/refresh',
        method: 'POST',
        data: {
          refresh_token: refresh_token
        }
      });
      
      if (res.data.success) {
        // æ›´æ–°Token
        wx.setStorageSync('access_token', res.data.data.access_token);
        wx.setStorageSync('refresh_token', res.data.data.refresh_token);
        
        // é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯
        this.loadUserProfile();
      } else {
        // åˆ·æ–°å¤±è´¥,è·³è½¬åˆ°ç™»å½•
        wx.redirectTo({
          url: '/pages/login/login'
        });
      }
    } catch (error) {
      wx.redirectTo({
        url: '/pages/login/login'
      });
    }
  }
});
```

---

### 2.4 éªŒè¯Tokenæœ‰æ•ˆæ€§

**APIè·¯å¾„**: `POST /api/v4/unified-engine/auth/verify`

**åŠŸèƒ½è¯´æ˜**:
- éªŒè¯å½“å‰Tokenæ˜¯å¦æœ‰æ•ˆ
- ç”¨äºé¡µé¢åŠ è½½å‰çš„å¿«é€ŸéªŒè¯
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/auth.js` - verifyç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

æ— è¯·æ±‚å‚æ•°,é€šè¿‡è¯·æ±‚å¤´ä¸­çš„TokenéªŒè¯

#### è¯·æ±‚å¤´

```
Authorization: Bearer {access_token}
```

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "Tokenæœ‰æ•ˆ",
  "data": {
    "valid": true,
    "user_id": 1,                     // ç”¨æˆ·ID
    "expires_at": "2025-01-28T20:35:00.000+08:00"  // Tokenè¿‡æœŸæ—¶é—´
  }
}
```

#### å¤±è´¥å“åº”

```json
{
  "success": false,
  "error": "UNAUTHORIZED",
  "message": "Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ",
  "data": {
    "valid": false
  }
}
```

#### å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹

```javascript
// utils/auth.js - ç»Ÿä¸€è®¤è¯å·¥å…·

/**
 * æ£€æŸ¥ç™»å½•çŠ¶æ€
 * @returns {Promise<boolean>} æ˜¯å¦å·²ç™»å½•
 */
async function checkLoginStatus() {
  const access_token = wx.getStorageSync('access_token');
  
  if (!access_token) {
    return false;
  }
  
  try {
    const res = await wx.request({
      url: 'https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/auth/verify',
      method: 'POST',
      header: {
        'Authorization': 'Bearer ' + access_token
      }
    });
    
    return res.data.success && res.data.data.valid;
  } catch (error) {
    return false;
  }
}

/**
 * ç¡®ä¿å·²ç™»å½•,æœªç™»å½•åˆ™è·³è½¬
 */
async function ensureLogin() {
  const isLoggedIn = await checkLoginStatus();
  
  if (!isLoggedIn) {
    wx.showModal({
      title: 'æç¤º',
      content: 'è¯·å…ˆç™»å½•',
      success: (res) => {
        if (res.confirm) {
          wx.redirectTo({
            url: '/pages/login/login'
          });
        }
      }
    });
    return false;
  }
  
  return true;
}

module.exports = {
  checkLoginStatus,
  ensureLogin
};
```

ä½¿ç”¨ç¤ºä¾‹:
```javascript
// pages/lottery/lottery.js
const AuthUtil = require('../../utils/auth.js');

Page({
  async onLoad() {
    // ç¡®ä¿ç”¨æˆ·å·²ç™»å½•
    const isLoggedIn = await AuthUtil.ensureLogin();
    if (!isLoggedIn) {
      return; // æœªç™»å½•,å·²è·³è½¬åˆ°ç™»å½•é¡µ
    }
    
    // å·²ç™»å½•,åŠ è½½æŠ½å¥–æ•°æ®
    this.loadLotteryData();
  }
});
```

---

### 2.5 åˆ·æ–°Token

**APIè·¯å¾„**: `POST /api/v4/unified-engine/auth/refresh`

**åŠŸèƒ½è¯´æ˜**:
- ä½¿ç”¨refresh_tokenè·å–æ–°çš„access_tokenå’Œrefresh_token
- access_tokenæœ‰æ•ˆæœŸ7å¤©,refresh_tokenæœ‰æ•ˆæœŸ30å¤©
- **ä¸éœ€è¦access_token**, ä½¿ç”¨refresh_tokenè¯·æ±‚

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/auth.js` - refreshç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

```json
{
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."  // å¿…å¡«, åˆ·æ–°Token
}
```

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "Tokenåˆ·æ–°æˆåŠŸ",
  "data": {
    "access_token": "æ–°çš„access_token",      // æ–°çš„è®¿é—®Token(7å¤©æœ‰æ•ˆ)
    "refresh_token": "æ–°çš„refresh_token",    // æ–°çš„åˆ·æ–°Token(30å¤©æœ‰æ•ˆ)
    "expires_in": 604800,                   // è¿‡æœŸæ—¶é—´(ç§’)
    "token_type": "Bearer"
  }
}
```

#### å¤±è´¥å“åº”

**refresh_tokenæ— æ•ˆæˆ–è¿‡æœŸ**:
```json
{
  "success": false,
  "error": "UNAUTHORIZED",
  "message": "åˆ·æ–°Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ,è¯·é‡æ–°ç™»å½•",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

#### å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹

```javascript
// utils/token.js - Tokenç®¡ç†å·¥å…·

/**
 * è‡ªåŠ¨åˆ·æ–°Token
 * @returns {Promise<boolean>} æ˜¯å¦åˆ·æ–°æˆåŠŸ
 */
async function autoRefreshToken() {
  const refresh_token = wx.getStorageSync('refresh_token');
  
  if (!refresh_token) {
    console.error('æ— refresh_token,æ— æ³•åˆ·æ–°');
    return false;
  }
  
  try {
    const res = await wx.request({
      url: 'https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/auth/refresh',
      method: 'POST',
      data: {
        refresh_token: refresh_token
      }
    });
    
    if (res.data.success) {
      // æ›´æ–°Token
      wx.setStorageSync('access_token', res.data.data.access_token);
      wx.setStorageSync('refresh_token', res.data.data.refresh_token);
      
      console.log('Tokenåˆ·æ–°æˆåŠŸ');
      return true;
    } else {
      console.error('Tokenåˆ·æ–°å¤±è´¥:', res.data.message);
      return false;
    }
  } catch (error) {
    console.error('Tokenåˆ·æ–°è¯·æ±‚å¤±è´¥:', error);
    return false;
  }
}

/**
 * å¸¦è‡ªåŠ¨åˆ·æ–°çš„è¯·æ±‚å°è£…
 */
async function requestWithAutoRefresh(options) {
  const access_token = wx.getStorageSync('access_token');
  
  // ç¬¬ä¸€æ¬¡è¯·æ±‚
  try {
    const res = await wx.request({
      ...options,
      header: {
        'Authorization': 'Bearer ' + access_token,
        ...options.header
      }
    });
    
    // è¯·æ±‚æˆåŠŸ
    if (res.data.success) {
      return res.data;
    }
    
    // Tokenè¿‡æœŸ,å°è¯•åˆ·æ–°
    if (res.data.error === 'UNAUTHORIZED') {
      console.log('Tokenè¿‡æœŸ,å°è¯•åˆ·æ–°...');
      const refreshed = await autoRefreshToken();
      
      if (refreshed) {
        // åˆ·æ–°æˆåŠŸ,é‡è¯•åŸè¯·æ±‚
        const newToken = wx.getStorageSync('access_token');
        const retryRes = await wx.request({
          ...options,
          header: {
            'Authorization': 'Bearer ' + newToken,
            ...options.header
          }
        });
        
        return retryRes.data;
      } else {
        // åˆ·æ–°å¤±è´¥,è·³è½¬ç™»å½•
        wx.redirectTo({
          url: '/pages/login/login'
        });
        throw new Error('Tokenåˆ·æ–°å¤±è´¥,è¯·é‡æ–°ç™»å½•');
      }
    }
    
    // å…¶ä»–é”™è¯¯
    throw new Error(res.data.message || 'è¯·æ±‚å¤±è´¥');
  } catch (error) {
    console.error('è¯·æ±‚å¤±è´¥:', error);
    throw error;
  }
}

module.exports = {
  autoRefreshToken,
  requestWithAutoRefresh
};
```

ä½¿ç”¨ç¤ºä¾‹:
```javascript
const TokenUtil = require('../../utils/token.js');

// è‡ªåŠ¨å¤„ç†Tokenåˆ·æ–°çš„è¯·æ±‚
const data = await TokenUtil.requestWithAutoRefresh({
  url: 'https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/lottery/prizes/LUCKY2025',
  method: 'GET'
});

console.log('å¥–å“åˆ—è¡¨:', data.data);
```

---

## ğŸ”‘ æƒé™æ¨¡å—API

### 2.6 æŸ¥è¯¢ç”¨æˆ·æƒé™(æŒ‡å®šç”¨æˆ·)

**APIè·¯å¾„**: `GET /api/v4/permissions/user/:user_id`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢æŒ‡å®šç”¨æˆ·çš„è§’è‰²å’Œæƒé™
- **ç®¡ç†å‘˜å¯æŸ¥è¯¢ä»»ä½•ç”¨æˆ·**, æ™®é€šç”¨æˆ·åªèƒ½æŸ¥è¯¢è‡ªå·±
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/permissions.js` - getUserPermissionsç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**è·¯å¾„å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `user_id` | number | ç”¨æˆ·ID |

**ç¤ºä¾‹**: `/api/v4/permissions/user/123`

#### è¯·æ±‚å¤´

```
Authorization: Bearer {access_token}
```

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "user_id": 123,
    "roles": [
      {
        "id": 2,
        "role_name": "user",              // è§’è‰²åç§°
        "description": "æ™®é€šç”¨æˆ·",        // è§’è‰²æè¿°
        "role_level": 0,                  // è§’è‰²çº§åˆ«
        "permissions": [                  // è¯¥è§’è‰²çš„æƒé™åˆ—è¡¨
          {
            "id": 10,
            "resource": "lottery",        // èµ„æº: lottery/inventory/pointsç­‰
            "action": "draw",             // æ“ä½œ: draw/view/create/update/deleteç­‰
            "description": "æ‰§è¡ŒæŠ½å¥–"
          },
          {
            "id": 11,
            "resource": "inventory",
            "action": "view",
            "description": "æŸ¥çœ‹åº“å­˜"
          }
        ]
      },
      {
        "id": 15,
        "role_name": "campaign_LUCKY2025", // æ´»åŠ¨ä¸“å±è§’è‰²
        "description": "å¯å‚ä¸LUCKY2025æ´»åŠ¨",
        "role_level": 0,
        "permissions": []                   // æ´»åŠ¨è§’è‰²æ— é¢å¤–æƒé™
      }
    ],
    "all_permissions": [                   // ç”¨æˆ·æ‰€æœ‰æƒé™çš„æ±‡æ€»
      "lottery:draw",
      "inventory:view",
      "inventory:use",
      "points:view"
    ],
    "is_admin": false                      // æ˜¯å¦æ˜¯ç®¡ç†å‘˜
  }
}
```

#### å¤±è´¥å“åº”

**æƒé™ä¸è¶³**:
```json
{
  "success": false,
  "error": "FORBIDDEN",
  "message": "æ‚¨åªèƒ½æŸ¥è¯¢è‡ªå·±çš„æƒé™",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

#### å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹

```javascript
// pages/admin/user-detail.js - ç®¡ç†å‘˜æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…

Page({
  data: {
    userId: 0,
    userPermissions: null
  },
  
  onLoad(options) {
    this.setData({
      userId: options.id
    });
    this.loadUserPermissions();
  },
  
  async loadUserPermissions() {
    try {
      const res = await wx.request({
        url: `https://omqktqrtntnn.sealosbja.site/api/v4/permissions/user/${this.data.userId}`,
        method: 'GET',
        header: {
          'Authorization': 'Bearer ' + wx.getStorageSync('access_token')
        }
      });
      
      if (res.data.success) {
        this.setData({
          userPermissions: res.data.data
        });
      }
    } catch (error) {
      wx.showToast({
        title: 'åŠ è½½æƒé™å¤±è´¥',
        icon: 'none'
      });
    }
  }
});
```

---

### 2.7 æŸ¥è¯¢å½“å‰ç”¨æˆ·æƒé™

**APIè·¯å¾„**: `GET /api/v4/permissions/current`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢å½“å‰ç™»å½•ç”¨æˆ·çš„è§’è‰²å’Œæƒé™
- **æ— éœ€æŒ‡å®šuser_id**, è‡ªåŠ¨è¯†åˆ«å½“å‰ç”¨æˆ·
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/permissions.js` - getCurrentUserPermissionsç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

æ— è¯·æ±‚å‚æ•°,é€šè¿‡Tokenè¯†åˆ«ç”¨æˆ·

#### è¯·æ±‚å¤´

```
Authorization: Bearer {access_token}
```

#### æˆåŠŸå“åº”

å“åº”æ ¼å¼ä¸ `GET /permissions/user/:user_id` å®Œå…¨ç›¸åŒ

#### å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹

```javascript
// app.js - åº”ç”¨å…¨å±€é€»è¾‘

App({
  globalData: {
    userPermissions: null,
    isAdmin: false
  },
  
  onLaunch() {
    this.loadUserPermissions();
  },
  
  // åŠ è½½ç”¨æˆ·æƒé™
  async loadUserPermissions() {
    try {
      const access_token = wx.getStorageSync('access_token');
      if (!access_token) return;
      
      const res = await wx.request({
        url: 'https://omqktqrtntnn.sealosbja.site/api/v4/permissions/current',
        method: 'GET',
        header: {
          'Authorization': 'Bearer ' + access_token
        }
      });
      
      if (res.data.success) {
        this.globalData.userPermissions = res.data.data;
        this.globalData.isAdmin = res.data.data.is_admin;
        
        console.log('ç”¨æˆ·æƒé™åŠ è½½å®Œæˆ:', res.data.data.all_permissions);
      }
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·æƒé™å¤±è´¥:', error);
    }
  },
  
  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŸä¸ªæƒé™
  hasPermission(resource, action) {
    if (!this.globalData.userPermissions) {
      return false;
    }
    
    const permission = `${resource}:${action}`;
    return this.globalData.userPermissions.all_permissions.includes(permission);
  },
  
  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ç®¡ç†å‘˜
  isAdmin() {
    return this.globalData.isAdmin;
  }
});
```

ä½¿ç”¨ç¤ºä¾‹:
```javascript
// pages/lottery/lottery.js
const app = getApp();

Page({
  onLoad() {
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŠ½å¥–æƒé™
    if (!app.hasPermission('lottery', 'draw')) {
      wx.showModal({
        title: 'æç¤º',
        content: 'æ‚¨æ²¡æœ‰æŠ½å¥–æƒé™',
        showCancel: false
      });
      return;
    }
    
    // æœ‰æƒé™,åŠ è½½æŠ½å¥–é¡µé¢
    this.loadLotteryData();
  }
});
```

---

### 2.8 æ£€æŸ¥ç‰¹å®šæƒé™

**APIè·¯å¾„**: `POST /api/v4/permissions/check`

**åŠŸèƒ½è¯´æ˜**:
- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æŒ‡å®šçš„æƒé™
- è¿”å›å¸ƒå°”å€¼,ç”¨äºå‰ç«¯åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºæŸä¸ªåŠŸèƒ½
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/permissions.js` - checkPermissionç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

```json
{
  "user_id": 123,                    // å¯é€‰, ä¸æä¾›åˆ™æ£€æŸ¥å½“å‰ç”¨æˆ·
  "resource": "lottery",             // å¿…å¡«, èµ„æºç±»å‹
  "action": "draw"                   // å¿…å¡«, æ“ä½œç±»å‹
}
```

**å¸¸è§æƒé™åˆ—è¡¨**:
| resource | action | è¯´æ˜ |
|----------|--------|------|
| `lottery` | `draw` | æ‰§è¡ŒæŠ½å¥– |
| `lottery` | `view` | æŸ¥çœ‹æŠ½å¥–æ´»åŠ¨ |
| `inventory` | `view` | æŸ¥çœ‹åº“å­˜ |
| `inventory` | `use` | ä½¿ç”¨ç‰©å“ |
| `inventory` | `transfer` | è½¬ç§»ç‰©å“ |
| `points` | `view` | æŸ¥çœ‹ç§¯åˆ† |
| `admin` | `manage` | ç®¡ç†åå°è®¿é—® |

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "has_permission": true,          // æ˜¯å¦æœ‰æƒé™
    "resource": "lottery",
    "action": "draw"
  }
}
```

#### å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹

```javascript
// utils/permission.js - æƒé™æ£€æŸ¥å·¥å…·

/**
 * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŸä¸ªæƒé™
 * @param {string} resource - èµ„æºç±»å‹
 * @param {string} action - æ“ä½œç±»å‹
 * @returns {Promise<boolean>} æ˜¯å¦æœ‰æƒé™
 */
async function checkPermission(resource, action) {
  try {
    const res = await wx.request({
      url: 'https://omqktqrtntnn.sealosbja.site/api/v4/permissions/check',
      method: 'POST',
      header: {
        'Authorization': 'Bearer ' + wx.getStorageSync('access_token'),
        'Content-Type': 'application/json'
      },
      data: {
        resource: resource,
        action: action
      }
    });
    
    return res.data.success && res.data.data.has_permission;
  } catch (error) {
    console.error('æƒé™æ£€æŸ¥å¤±è´¥:', error);
    return false;
  }
}

module.exports = {
  checkPermission
};
```

ä½¿ç”¨ç¤ºä¾‹:
```javascript
const PermissionUtil = require('../../utils/permission.js');

Page({
  data: {
    canDraw: false,
    canTransfer: false
  },
  
  async onLoad() {
    // æ£€æŸ¥æŠ½å¥–æƒé™
    const canDraw = await PermissionUtil.checkPermission('lottery', 'draw');
    
    // æ£€æŸ¥è½¬ç§»ç‰©å“æƒé™
    const canTransfer = await PermissionUtil.checkPermission('inventory', 'transfer');
    
    this.setData({
      canDraw: canDraw,
      canTransfer: canTransfer
    });
  }
});
```

```xml
<!-- æ ¹æ®æƒé™åŠ¨æ€æ˜¾ç¤ºæŒ‰é’® -->
<button wx:if="{{canDraw}}" bindtap="handleDraw">æŠ½å¥–</button>
<view wx:else class="no-permission">æ‚¨æ²¡æœ‰æŠ½å¥–æƒé™</view>

<button wx:if="{{canTransfer}}" bindtap="handleTransfer">è½¬ç§»ç‰©å“</button>
```

---

### 2.9 è·å–ç®¡ç†å‘˜åˆ—è¡¨

**APIè·¯å¾„**: `GET /api/v4/permissions/admins`

**åŠŸèƒ½è¯´æ˜**:
- è·å–æ‰€æœ‰ç®¡ç†å‘˜åˆ—è¡¨
- **ä»…ç®¡ç†å‘˜å¯è°ƒç”¨**
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/permissions.js` - getAdminsç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

æ— è¯·æ±‚å‚æ•°

#### è¯·æ±‚å¤´

```
Authorization: Bearer {access_token}
```

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "admins": [
      {
        "id": 1,
        "mobile": "138****0001",
        "nickname": "è¶…çº§ç®¡ç†å‘˜",
        "avatar": "https://...",
        "roles": [
          {
            "id": 1,
            "role_name": "admin",
            "role_level": 100,
            "description": "è¶…çº§ç®¡ç†å‘˜"
          }
        ],
        "last_login_at": "2025-01-21T20:35:00.000+08:00"
      }
    ],
    "total": 5                       // ç®¡ç†å‘˜æ€»æ•°
  }
}
```

#### å¤±è´¥å“åº”

**æƒé™ä¸è¶³**:
```json
{
  "success": false,
  "error": "FORBIDDEN",
  "message": "éœ€è¦ç®¡ç†å‘˜æƒé™",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

---

### 2.10 æƒé™ç»Ÿè®¡ä¿¡æ¯

**APIè·¯å¾„**: `GET /api/v4/permissions/statistics`

**åŠŸèƒ½è¯´æ˜**:
- è·å–æƒé™ç³»ç»Ÿçš„ç»Ÿè®¡ä¿¡æ¯
- **ä»…ç®¡ç†å‘˜å¯è°ƒç”¨**
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/permissions.js` - getStatisticsç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

æ— è¯·æ±‚å‚æ•°

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "total_users": 12580,            // æ€»ç”¨æˆ·æ•°
    "total_roles": 8,                // æ€»è§’è‰²æ•°
    "total_permissions": 45,         // æ€»æƒé™æ•°
    "admin_count": 5,                // ç®¡ç†å‘˜æ•°é‡
    "role_distribution": {           // è§’è‰²åˆ†å¸ƒ
      "user": 12575,
      "admin": 5
    }
  }
}
```

---

## ğŸ“ è®¤è¯æƒé™æ¨¡å—æ€»ç»“

### APIæ¸…å•

| API | æ–¹æ³• | è·¯å¾„ | è®¤è¯ | è¯´æ˜ |
|-----|------|------|------|------|
| ç™»å½• | POST | `/api/v4/unified-engine/auth/login` | âŒ | æ‰‹æœºå·éªŒè¯ç ç™»å½•,è‡ªåŠ¨æ³¨å†Œ |
| å¿«é€Ÿç™»å½• | POST | `/api/v4/unified-engine/auth/quick-login` | âŒ | æµ‹è¯•ä¸“ç”¨,å…éªŒè¯ç ç™»å½• |
| è·å–ç”¨æˆ·ä¿¡æ¯ | GET | `/api/v4/unified-engine/auth/profile` | âœ… | è·å–å½“å‰ç”¨æˆ·å®Œæ•´ä¿¡æ¯ |
| éªŒè¯Token | POST | `/api/v4/unified-engine/auth/verify` | âœ… | éªŒè¯Tokenæ˜¯å¦æœ‰æ•ˆ |
| åˆ·æ–°Token | POST | `/api/v4/unified-engine/auth/refresh` | âŒ | ä½¿ç”¨refresh_tokenåˆ·æ–° |
| æŸ¥è¯¢ç”¨æˆ·æƒé™ | GET | `/api/v4/permissions/user/:user_id` | âœ… | æŸ¥è¯¢æŒ‡å®šç”¨æˆ·çš„æƒé™ |
| æŸ¥è¯¢å½“å‰ç”¨æˆ·æƒé™ | GET | `/api/v4/permissions/current` | âœ… | æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„æƒé™ |
| æ£€æŸ¥æƒé™ | POST | `/api/v4/permissions/check` | âœ… | æ£€æŸ¥æ˜¯å¦æœ‰æŸä¸ªæƒé™ |
| ç®¡ç†å‘˜åˆ—è¡¨ | GET | `/api/v4/permissions/admins` | âœ…ğŸ”‘ | è·å–æ‰€æœ‰ç®¡ç†å‘˜(ä»…ç®¡ç†å‘˜) |
| æƒé™ç»Ÿè®¡ | GET | `/api/v4/permissions/statistics` | âœ…ğŸ”‘ | æƒé™ç³»ç»Ÿç»Ÿè®¡(ä»…ç®¡ç†å‘˜) |

**å›¾ä¾‹**:
- âœ… éœ€è¦Tokenè®¤è¯
- âŒ ä¸éœ€è¦è®¤è¯
- ğŸ”‘ éœ€è¦ç®¡ç†å‘˜æƒé™

### å‰ç«¯å¼€å‘å»ºè®®

1. **Tokenç®¡ç†**:
   - ä½¿ç”¨ `wx.setStorageSync()` å­˜å‚¨Token
   - å°è£…ç»Ÿä¸€çš„è¯·æ±‚å·¥å…·,è‡ªåŠ¨æºå¸¦Token
   - å®ç°Tokenè‡ªåŠ¨åˆ·æ–°æœºåˆ¶

2. **æƒé™åˆ¤æ–­**:
   - åº”ç”¨å¯åŠ¨æ—¶åŠ è½½ç”¨æˆ·æƒé™
   - æ ¹æ®æƒé™åŠ¨æ€æ˜¾ç¤º/éšè—åŠŸèƒ½æŒ‰é’®
   - è°ƒç”¨æ•æ„ŸAPIå‰å…ˆæ£€æŸ¥æƒé™

3. **é”™è¯¯å¤„ç†**:
   - Tokenè¿‡æœŸæ—¶è‡ªåŠ¨åˆ·æ–°æˆ–è·³è½¬ç™»å½•
   - æƒé™ä¸è¶³æ—¶æ˜¾ç¤ºå‹å¥½æç¤º
   - ç½‘ç»œé”™è¯¯æ—¶æä¾›é‡è¯•é€‰é¡¹

4. **ç”¨æˆ·ä½“éªŒ**:
   - ä¿æŒç™»å½•çŠ¶æ€(è®°ä½Token)
   - è‡ªåŠ¨åˆ·æ–°é¿å…é¢‘ç¹ç™»å½•
   - æ˜¾ç¤ºåŠ è½½çŠ¶æ€å’Œé”™è¯¯æç¤º

---

**ğŸ“„ æ–‡æ¡£ç¬¬2éƒ¨åˆ†å®Œæˆ**

**ä¸‹ä¸€éƒ¨åˆ†**: Part3 - æŠ½å¥–æ ¸å¿ƒæ¨¡å—è¯¦ç»†API


---


**æ–‡æ¡£éƒ¨åˆ†**: ç¬¬3éƒ¨åˆ† - æŠ½å¥–æ ¸å¿ƒæ¨¡å—  
**åˆ›å»ºæ—¶é—´**: 2025å¹´01æœˆ21æ—¥ (åŒ—äº¬æ—¶é—´)  
**åŸºäºå®é™…ä»£ç éªŒè¯**: âœ…

---

## ğŸ“– æ¨¡å—æ¦‚è¿°

### æŠ½å¥–æ¨¡å—(`/api/v4/unified-engine/lottery`)
è´Ÿè´£æŠ½å¥–æ´»åŠ¨çš„æ ¸å¿ƒåŠŸèƒ½,åŒ…æ‹¬:
- ğŸ å¥–å“åˆ—è¡¨æŸ¥è¯¢(æ•°æ®è„±æ•)
- âš™ï¸ æ´»åŠ¨é…ç½®æŸ¥è¯¢
- ğŸ² æ‰§è¡ŒæŠ½å¥–(V4ç»Ÿä¸€å¼•æ“)
- ğŸ“œ æŠ½å¥–å†å²è®°å½•
- ğŸ“Š ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
- ğŸ† æ´»åŠ¨åˆ—è¡¨æŸ¥è¯¢

### ğŸ”’ æ´»åŠ¨æƒé™ç³»ç»Ÿ(V2.0æ–°å¢)

**æƒé™è§„åˆ™**:
1. **ç®¡ç†å‘˜(admin)**: è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æ´»åŠ¨æƒé™
2. **æ™®é€šç”¨æˆ·**: éœ€è¦åˆ†é…`campaign_{æ´»åŠ¨ID}`è§’è‰²æ‰èƒ½å‚ä¸æ´»åŠ¨
3. **æ— æƒé™ç”¨æˆ·**: è°ƒç”¨æŠ½å¥–APIè¿”å›`403 NO_CAMPAIGN_PERMISSION`é”™è¯¯

**å‰ç«¯å¤„ç†å»ºè®®**:
```javascript
// æŠ½å¥–å‰æ£€æŸ¥æƒé™
if (error.code === 'NO_CAMPAIGN_PERMISSION') {
  wx.showModal({
    title: 'æ— æƒé™',
    content: 'æ‚¨è¿˜æ²¡æœ‰è·å¾—è¯¥æ´»åŠ¨çš„å‚ä¸èµ„æ ¼,è¯·è”ç³»ç®¡ç†å‘˜å¼€é€šæƒé™',
    showCancel: false
  });
}
```

---

## ğŸ æŠ½å¥–æ ¸å¿ƒAPI

### 3.1 è·å–å¥–å“åˆ—è¡¨

**APIè·¯å¾„**: `GET /api/v4/unified-engine/lottery/prizes/:campaignCode`

**åŠŸèƒ½è¯´æ˜**:
- è·å–æŒ‡å®šæ´»åŠ¨çš„å¥–å“åˆ—è¡¨
- **è‡ªåŠ¨æ•°æ®è„±æ•**: æ™®é€šç”¨æˆ·çœ‹ä¸åˆ°æŠ½å¥–æ¦‚ç‡ã€åº“å­˜æ•°é‡ç­‰æ•æ„Ÿä¿¡æ¯
- **ç®¡ç†å‘˜ç‰¹æƒ**: ç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°å®Œæ•´æ•°æ®(`full`çº§åˆ«)
- **ä¸­é—´ä»¶**: `authenticateToken`, `dataAccessControl` (æ•°æ®è„±æ•) ğŸ†•
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/lottery.js` - getPrizesç«¯ç‚¹

#### ğŸ›¡ï¸ æ•°æ®è„±æ•æœºåˆ¶è¯¦è§£

**è„±æ•å­—æ®µå¯¹æ¯”è¡¨**:
| å­—æ®µ | æ™®é€šç”¨æˆ· | ç®¡ç†å‘˜ | è¯´æ˜ |
|------|----------|--------|------|
| `win_probability` | âŒ ä¸è¿”å› | âœ… è¿”å› | ä¸­å¥–æ¦‚ç‡(å•†ä¸šæ ¸å¿ƒæ•°æ®) |
| `stock_quantity` | âŒ ä¸è¿”å› | âœ… è¿”å› | åº“å­˜æ•°é‡(è½¬ä¸ºavailableå¸ƒå°”å€¼) |
| `prize_value` | âŒ ä¸è¿”å› | âœ… è¿”å› | å¥–å“ä»·å€¼(è½¬ä¸ºdisplay_valueæ¨¡ç³Šæè¿°) |
| `cost_points` | âŒ ä¸è¿”å› | âœ… è¿”å› | æˆæœ¬ç§¯åˆ† |
| `max_daily_wins` | âŒ ä¸è¿”å› | âœ… è¿”å› | æ¯æ—¥ä¸­å¥–ä¸Šé™ |

**æ›¿ä»£å­—æ®µè¯´æ˜**:
- `win_probability` â†’ `rarity` (ç¨€æœ‰åº¦: common/uncommon/rare/epic/legendary)
- `stock_quantity` â†’ `available` (æ˜¯å¦å¯ç”¨: true/false)
- `prize_value` â†’ `display_value` (æ˜¾ç¤ºå€¼: "é«˜ä»·å€¼"/"ä¸­ä»·å€¼"/"åŸºç¡€ä»·å€¼")

#### è¯·æ±‚å‚æ•°

**è·¯å¾„å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `campaignCode` | string | æ´»åŠ¨ä»£ç ,ä¾‹å¦‚: `LUCKY2025` |

**ç¤ºä¾‹**: `/api/v4/unified-engine/lottery/prizes/LUCKY2025`

#### è¯·æ±‚å¤´

```
Authorization: Bearer {access_token}
```

#### æˆåŠŸå“åº”(æ™®é€šç”¨æˆ· - è„±æ•æ•°æ®)

```json
{
  "success": true,
  "data": [
    {
      "id": 101,                              // å¥–å“ID
      "name": "ç‰¹ç­‰å¥– - iPhone 15 Pro Max",  // å¥–å“åç§°
      "description": "256GB æ·±ç©ºé»‘",         // å¥–å“æè¿°
      "type": "physical",                     // å¥–å“ç±»å‹: physical/virtual/points
      "value": "9999",                        // å¥–å“ä»·å€¼(å…ƒ)
      "image_url": "https://sealos.../prize101.jpg",  // å¥–å“å›¾ç‰‡URL
      "rank": 1                               // å¥–å“ç­‰çº§(1-5, 1ä¸ºæœ€é«˜)
      // âŒ æ™®é€šç”¨æˆ·çœ‹ä¸åˆ°: probability(æ¦‚ç‡), stock(åº“å­˜), cost_price(æˆæœ¬ä»·)
    },
    {
      "id": 102,
      "name": "ä¸€ç­‰å¥– - 500ç§¯åˆ†",
      "description": "å¯ç”¨äºå…‘æ¢å•†å“",
      "type": "points",
      "value": "500",
      "image_url": "https://sealos.../prize102.jpg",
      "rank": 2
    },
    {
      "id": 103,
      "name": "è°¢è°¢å‚ä¸",
      "description": "å†æ¥å†å‰",
      "type": "virtual",
      "value": "0",
      "image_url": "https://sealos.../prize103.jpg",
      "rank": 5
    }
  ],
  "metadata": {
    "campaign_code": "LUCKY2025",
    "data_level": "public",                   // æ•°æ®çº§åˆ«: public(è„±æ•) / full(å®Œæ•´)
    "total_prizes": 10,                       // å¥–å“æ€»æ•°
    "visible_count": 10                       // å¯è§å¥–å“æ•°(æ™®é€šç”¨æˆ·=æ‰€æœ‰å¥–å“)
  }
}
```

#### æˆåŠŸå“åº”(ç®¡ç†å‘˜ - å®Œæ•´æ•°æ®)

```json
{
  "success": true,
  "data": [
    {
      "id": 101,
      "name": "ç‰¹ç­‰å¥– - iPhone 15 Pro Max",
      "description": "256GB æ·±ç©ºé»‘",
      "type": "physical",
      "value": "9999",
      "image_url": "https://sealos.../prize101.jpg",
      "rank": 1,
      
      // âœ… ç®¡ç†å‘˜å¯è§çš„æ•æ„Ÿå­—æ®µ
      "probability": "0.1",                   // ä¸­å¥–æ¦‚ç‡(%)
      "stock": 5,                             // å‰©ä½™åº“å­˜æ•°é‡
      "initial_stock": 10,                    // åˆå§‹åº“å­˜æ•°é‡
      "cost_price": "7500.00",                // æˆæœ¬ä»·(å…ƒ)
      "guarantee_config": {                   // ä¿åº•æœºåˆ¶é…ç½®
        "enabled": true,
        "attempts_required": 100              // 100æ¬¡å¿…ä¸­
      },
      "statistics": {                         // ç»Ÿè®¡ä¿¡æ¯
        "total_won": 3,                       // å·²ä¸­å¥–æ¬¡æ•°
        "last_won_at": "2025-01-20T15:30:00.000+08:00"
      }
    }
  ],
  "metadata": {
    "campaign_code": "LUCKY2025",
    "data_level": "full",                     // ç®¡ç†å‘˜çœ‹åˆ°å®Œæ•´æ•°æ®
    "total_prizes": 10,
    "visible_count": 10,
    "admin_stats": {                          // ç®¡ç†å‘˜ä¸“å±ç»Ÿè®¡
      "total_draws": 15680,                   // æ€»æŠ½å¥–æ¬¡æ•°
      "total_wins": 3456,                     // æ€»ä¸­å¥–æ¬¡æ•°
      "win_rate": "22.04%"                    // ä¸­å¥–ç‡
    }
  }
}
```

#### å¤±è´¥å“åº”

**æ´»åŠ¨ä¸å­˜åœ¨**:
```json
{
  "success": false,
  "error": "CAMPAIGN_NOT_FOUND",
  "message": "æ´»åŠ¨LUCKY2025ä¸å­˜åœ¨æˆ–å·²ç»“æŸ",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

**æ— æƒé™**:
```json
{
  "success": false,
  "error": "NO_CAMPAIGN_PERMISSION",
  "message": "æ‚¨æ²¡æœ‰å‚åŠ æ­¤æ´»åŠ¨çš„æƒé™",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

#### å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹

```javascript
// pages/lottery/lottery.js

Page({
  data: {
    campaignCode: 'LUCKY2025',
    prizes: [],
    isLoading: true
  },
  
  onLoad(options) {
    // ä»é¡µé¢å‚æ•°æˆ–å…¨å±€é…ç½®è·å–æ´»åŠ¨ä»£ç 
    if (options.code) {
      this.setData({
        campaignCode: options.code
      });
    }
    
    this.loadPrizes();
  },
  
  async loadPrizes() {
    try {
      this.setData({ isLoading: true });
      
      const res = await wx.request({
        url: `https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/lottery/prizes/${this.data.campaignCode}`,
        method: 'GET',
        header: {
          'Authorization': 'Bearer ' + wx.getStorageSync('access_token')
        }
      });
      
      if (res.data.success) {
        this.setData({
          prizes: res.data.data,
          isLoading: false
        });
      } else if (res.data.error === 'NO_CAMPAIGN_PERMISSION') {
        // æ— æƒé™
        wx.showModal({
          title: 'æ— æƒé™',
          content: 'æ‚¨è¿˜æ²¡æœ‰è·å¾—è¯¥æ´»åŠ¨çš„å‚ä¸èµ„æ ¼,è¯·è”ç³»ç®¡ç†å‘˜å¼€é€šæƒé™',
          showCancel: false,
          success: () => {
            wx.navigateBack();
          }
        });
      } else if (res.data.error === 'CAMPAIGN_NOT_FOUND') {
        // æ´»åŠ¨ä¸å­˜åœ¨
        wx.showModal({
          title: 'æ´»åŠ¨å·²ç»“æŸ',
          content: 'è¯¥æŠ½å¥–æ´»åŠ¨å·²ç»“æŸæˆ–ä¸å­˜åœ¨',
          showCancel: false,
          success: () => {
            wx.navigateBack();
          }
        });
      }
    } catch (error) {
      this.setData({ isLoading: false });
      wx.showToast({
        title: 'åŠ è½½å¥–å“å¤±è´¥',
        icon: 'none'
      });
    }
  }
});
```

```xml
<!-- pages/lottery/lottery.wxml -->
<view class="lottery-page">
  <!-- åŠ è½½ä¸­ -->
  <view wx:if="{{isLoading}}" class="loading">
    <text>åŠ è½½ä¸­...</text>
  </view>
  
  <!-- å¥–å“åˆ—è¡¨ -->
  <view wx:else class="prizes-container">
    <view class="prize-item" wx:for="{{prizes}}" wx:key="id">
      <image class="prize-image" src="{{item.image_url}}" mode="aspectFill"></image>
      <view class="prize-info">
        <text class="prize-name">{{item.name}}</text>
        <text class="prize-desc">{{item.description}}</text>
        <text class="prize-value">ä»·å€¼: Â¥{{item.value}}</text>
      </view>
    </view>
  </view>
</view>
```

---

### 3.2 è·å–æ´»åŠ¨é…ç½®

**APIè·¯å¾„**: `GET /api/v4/unified-engine/lottery/config/:campaignCode`

**åŠŸèƒ½è¯´æ˜**:
- è·å–æŠ½å¥–æ´»åŠ¨çš„é…ç½®ä¿¡æ¯
- **è‡ªåŠ¨æ•°æ®è„±æ•**: æ™®é€šç”¨æˆ·çœ‹ä¸åˆ°æ•æ„Ÿçš„é…ç½®å‚æ•°
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/lottery.js` - getCampaignConfigç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**è·¯å¾„å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `campaignCode` | string | æ´»åŠ¨ä»£ç  |

#### æˆåŠŸå“åº”(æ™®é€šç”¨æˆ· - è„±æ•é…ç½®)

```json
{
  "success": true,
  "data": {
    "campaign_code": "LUCKY2025",           // æ´»åŠ¨ä»£ç  (åç«¯å®é™…å­—æ®µ)
    "campaign_name": "2025æ–°æ˜¥å¤§æŠ½å¥–",      // æ´»åŠ¨åç§° (åç«¯å®é™…å­—æ®µ)
    "description": "å‚ä¸æŠ½å¥–,èµ¢å–ä¸°åšå¥–å“!", // æ´»åŠ¨æè¿°
    "status": "active",                     // çŠ¶æ€: active/inactive/ended
    "start_time": "2025-01-01T00:00:00.000+08:00",  // å¼€å§‹æ—¶é—´(åŒ—äº¬æ—¶é—´)
    "end_time": "2025-03-01T23:59:59.999+08:00",    // ç»“æŸæ—¶é—´(åŒ—äº¬æ—¶é—´)
    "cost_per_draw": 10,                    // âœ… åç«¯å®é™…å­—æ®µ: æ¯æ¬¡æŠ½å¥–æ¶ˆè€—ç§¯åˆ†
    "max_draws_per_user_daily": 10,         // âœ… åç«¯å®é™…å­—æ®µ: æ¯ç”¨æˆ·æ¯æ—¥æœ€å¤§æŠ½å¥–æ¬¡æ•°
    "image_url": "https://sealos.../banner.jpg",    // æ´»åŠ¨æ¨ªå¹…å›¾ç‰‡
    "rules": [                              // æ´»åŠ¨è§„åˆ™(å±•ç¤ºç»™ç”¨æˆ·)
      "æ¯æ¬¡æŠ½å¥–æ¶ˆè€—10ç§¯åˆ†",
      "æ¯æ—¥æœ€å¤šæŠ½å¥–10æ¬¡",
      "ä¸­å¥–åå¥–å“å°†è‡ªåŠ¨å‘æ”¾åˆ°åº“å­˜",
      "æ´»åŠ¨æœ€ç»ˆè§£é‡Šæƒå½’æœ¬å¹³å°æ‰€æœ‰"
    ],
    "guarantee_info": {                     // ä¿åº•ä¿¡æ¯(è„±æ•)
      "exists": true,                       // æ˜¯å¦æœ‰ä¿åº•æœºåˆ¶
      "description": "è¿ç»­æŠ½å¥–æœ‰æƒŠå–œå“¦~"    // æ¨¡ç³Šæè¿°
    }
    // âŒ æ™®é€šç”¨æˆ·çœ‹ä¸åˆ°: probability_strategy(æ¦‚ç‡ç­–ç•¥), guarantee_config(ä¿åº•é…ç½®è¯¦æƒ…)
  },
  "metadata": {
    "data_level": "public"
  }
}
```

#### æˆåŠŸå“åº”(ç®¡ç†å‘˜ - å®Œæ•´é…ç½®)

```json
{
  "success": true,
  "data": {
    "campaign_id": 1,                       // âœ… ç®¡ç†å‘˜å¯è§: æ´»åŠ¨ID
    "campaign_code": "LUCKY2025",           // æ´»åŠ¨ä»£ç 
    "campaign_name": "2025æ–°æ˜¥å¤§æŠ½å¥–",      // æ´»åŠ¨åç§°
    "campaign_type": "daily",               // æ´»åŠ¨ç±»å‹: daily/weekly/event/permanent
    "description": "å‚ä¸æŠ½å¥–,èµ¢å–ä¸°åšå¥–å“!", // æ´»åŠ¨æè¿°
    "status": "active",                     // çŠ¶æ€: draft/active/paused/completed
    "start_time": "2025-01-01T00:00:00.000+08:00",  // å¼€å§‹æ—¶é—´(åŒ—äº¬æ—¶é—´)
    "end_time": "2025-03-01T23:59:59.999+08:00",    // ç»“æŸæ—¶é—´(åŒ—äº¬æ—¶é—´)
    "cost_per_draw": 10,                    // âœ… åç«¯å®é™…å­—æ®µ: æ¯æ¬¡æŠ½å¥–æ¶ˆè€—ç§¯åˆ†
    "max_draws_per_user_daily": 10,         // âœ… åç«¯å®é™…å­—æ®µ: æ¯ç”¨æˆ·æ¯æ—¥æœ€å¤§æŠ½å¥–æ¬¡æ•°
    "max_draws_per_user_total": null,       // æ¯ç”¨æˆ·æ€»æœ€å¤§æŠ½å¥–æ¬¡æ•°(nullè¡¨ç¤ºæ— é™åˆ¶)
    "banner_image_url": "https://sealos.../banner.jpg",
    "rules_text": "æ´»åŠ¨è§„åˆ™è¯¦ç»†è¯´æ˜...",
    
    // âœ… ç®¡ç†å‘˜å¯è§çš„æ•æ„Ÿé…ç½®
    "total_prize_pool": 50000.00,           // æ€»å¥–æ± ä»·å€¼
    "remaining_prize_pool": 35000.00,       // å‰©ä½™å¥–æ± ä»·å€¼
    "prize_distribution_config": { /* å¥–å“åˆ†å¸ƒé…ç½® */ },
    "total_participants": 120,              // æ€»å‚ä¸äººæ•°
    "total_draws": 450,                     // æ€»æŠ½å¥–æ¬¡æ•°
    "total_prizes_awarded": 89,             // æ€»ä¸­å¥–æ¬¡æ•°
    "daily_reset_time": "00:00:00",         // æ¯æ—¥é‡ç½®æ—¶é—´
    "created_at": "2024-12-01T10:00:00.000+08:00",
    "updated_at": "2025-01-15T14:30:00.000+08:00"
  },
  "metadata": {
    "data_level": "full"
  }
}
```

#### å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹

```javascript
// pages/lottery/lottery.js - åŠ è½½æ´»åŠ¨é…ç½®

async loadCampaignConfig() {
  try {
    const res = await wx.request({
      url: `https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/lottery/config/${this.data.campaignCode}`,
      method: 'GET',
      header: {
        'Authorization': 'Bearer ' + wx.getStorageSync('access_token')
      }
    });
    
    if (res.data.success) {
      const config = res.data.data;
      
      // âœ… ä½¿ç”¨åç«¯å®é™…è¿”å›çš„å­—æ®µå
      this.setData({
        campaignName: config.campaign_name,           // âœ… åç«¯å­—æ®µ: campaign_name
        campaignDescription: config.description,
        costPerDraw: config.cost_per_draw,           // âœ… åç«¯å­—æ®µ: cost_per_draw (æ¯æ¬¡æ¶ˆè€—ç§¯åˆ†)
        maxDrawsPerDay: config.max_draws_per_user_daily, // âœ… åç«¯å­—æ®µ: max_draws_per_user_daily
        rules: config.rules,
        guaranteeExists: config.guarantee_info?.exists || false
      });
      
      // æ£€æŸ¥æ´»åŠ¨çŠ¶æ€
      if (config.status !== 'active') {
        wx.showModal({
          title: 'æ´»åŠ¨å·²ç»“æŸ',
          content: 'è¯¥æŠ½å¥–æ´»åŠ¨å·²ç»“æŸ',
          showCancel: false
        });
      }
    }
  } catch (error) {
    wx.showToast({
      title: 'åŠ è½½æ´»åŠ¨é…ç½®å¤±è´¥',
      icon: 'none'
    });
  }
}
```

---

### 3.3 æ‰§è¡ŒæŠ½å¥– â­æ ¸å¿ƒåŠŸèƒ½

**APIè·¯å¾„**: `POST /api/v4/unified-engine/lottery/draw`

**åŠŸèƒ½è¯´æ˜**:
- **æ ¸å¿ƒæŠ½å¥–åŠŸèƒ½**, V4ç»Ÿä¸€æŠ½å¥–å¼•æ“
- **3ç§æŠ½å¥–ç­–ç•¥**: åŸºç¡€ç­–ç•¥ã€ä¿åº•ç­–ç•¥ã€æˆæœ¬ç®¡ç†ç­–ç•¥(åç«¯è‡ªåŠ¨é€‰æ‹©)
- **å®æ—¶æ¦‚ç‡è°ƒæ•´**: è¿ç»­æœªä¸­å¥–æ—¶è‡ªåŠ¨æå‡ä¸­å¥–æ¦‚ç‡
- **æ´»åŠ¨æƒé™éªŒè¯**: å¿…é¡»æœ‰`campaign_{æ´»åŠ¨ID}`è§’è‰²æˆ–æ˜¯ç®¡ç†å‘˜
- **é¢‘ç‡é™åˆ¶**: æ¯ç”¨æˆ·æ¯åˆ†é’Ÿæœ€å¤š20æ¬¡æŠ½å¥–è¯·æ±‚ ğŸ†•
- **æ•°æ®è„±æ•**: æ ¹æ®ç”¨æˆ·è§’è‰²è¿”å›ä¸åŒè¯¦ç»†ç¨‹åº¦çš„æ•°æ®
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/lottery.js` - executeDrawç«¯ç‚¹

#### â±ï¸ é™æµè§„åˆ™è¯¦è§£ (V4.3æ–°å¢)

| é™æµç»´åº¦ | é™åˆ¶ | é”™è¯¯ç  | è¯´æ˜ |
|---------|------|--------|------|
| **å•ç”¨æˆ·é™æµ** | 20æ¬¡/åˆ†é’Ÿ | `RATE_LIMIT_EXCEEDED` (429) | æŒ‰ç”¨æˆ·IDé™æµ,é˜²æ­¢æ¶æ„åˆ·å¥– |
| **å…¨å±€é™æµ** | æ— ç¡¬æ€§é™åˆ¶ | - | ç³»ç»Ÿè‡ªåŠ¨è´Ÿè½½å‡è¡¡ |
| **é‡è¯•å»ºè®®** | ç­‰å¾…60ç§’ | - | å»ºè®®å‰ç«¯åšé˜²æŠ–å¤„ç† |

**å‰ç«¯å¤„ç†å»ºè®®**:
```javascript
// å»ºè®®åœ¨å‰ç«¯æ·»åŠ é˜²æŠ–å¤„ç†
let lastDrawTime = 0;
const DRAW_COOLDOWN = 3000; // 3ç§’å†·å´æ—¶é—´

async function handleDraw() {
  const now = Date.now();
  if (now - lastDrawTime < DRAW_COOLDOWN) {
    wx.showToast({ title: 'æ“ä½œå¤ªå¿«äº†,è¯·ç¨åå†è¯•', icon: 'none' });
    return;
  }
  lastDrawTime = now;
  // æ‰§è¡ŒæŠ½å¥–é€»è¾‘...
}
```

#### ğŸ” æ´»åŠ¨æƒé™æœºåˆ¶è¯¦è§£ (V2.0)

**æƒé™æ£€æŸ¥é€»è¾‘**:
1. âœ… **ç®¡ç†å‘˜ç”¨æˆ·**(adminè§’è‰²): è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æ´»åŠ¨æƒé™,æ— éœ€é¢å¤–åˆ†é…
2. âœ… **æ™®é€šç”¨æˆ·**: éœ€è¦æ˜ç¡®åˆ†é…æ´»åŠ¨è§’è‰² `campaign_{campaign_id}`
3. âŒ **æœªæˆæƒç”¨æˆ·**: è¿”å›403é”™è¯¯ç  `NO_CAMPAIGN_PERMISSION`

**æƒé™åˆ†é…æ–¹å¼**:
```javascript
// ç®¡ç†å‘˜ä¸ºç”¨æˆ·åˆ†é…æ´»åŠ¨æƒé™
POST /api/v4/unified-engine/admin/campaign-permissions/assign
{
  "user_id": 123,
  "campaign_id": 1,
  "expiry_date": "2025-12-31"  // å¯é€‰: æƒé™è¿‡æœŸæ—¶é—´
}
```

**å‰ç«¯é”™è¯¯å¤„ç†**:
```javascript
// 403é”™è¯¯å¤„ç†ç¤ºä¾‹
if (res.statusCode === 403 && res.data.error === 'NO_CAMPAIGN_PERMISSION') {
  wx.showModal({
    title: 'æƒé™ä¸è¶³',
    content: 'æ‚¨æ²¡æœ‰å‚åŠ æ­¤æ´»åŠ¨çš„æƒé™,è¯·è”ç³»ç®¡ç†å‘˜è·å–æƒé™',
    confirmText: 'è”ç³»å®¢æœ',
    success(modalRes) {
      if (modalRes.confirm) {
        // è·³è½¬åˆ°å®¢æœé¡µé¢
        wx.navigateTo({ url: '/pages/customer-service/index' });
      }
    }
  });
}
```

#### ğŸ›¡ï¸ æ•°æ®è„±æ•æœºåˆ¶è¯´æ˜

**ä¸­é—´ä»¶**: `dataAccessControl`

**è„±æ•è§„åˆ™**:
- **ç®¡ç†å‘˜** (`dataLevel='full'`): è¿”å›å®Œæ•´æ•°æ®,åŒ…æ‹¬æ¦‚ç‡ã€æˆæœ¬ã€åº“å­˜ç­‰æ•æ„Ÿä¿¡æ¯
- **æ™®é€šç”¨æˆ·** (`dataLevel='public'`): è¿”å›è„±æ•æ•°æ®,éšè—å•†ä¸šæ•æ„Ÿä¿¡æ¯

**è„±æ•å­—æ®µå¯¹æ¯”**:
| å­—æ®µ | æ™®é€šç”¨æˆ· | ç®¡ç†å‘˜ | è¯´æ˜ |
|------|----------|--------|------|
| å¥–å“æ¦‚ç‡ | âŒ éšè— | âœ… æ˜¾ç¤º | ç”¨ç¨€æœ‰åº¦(rarity)æ›¿ä»£ |
| å¥–å“åº“å­˜ | âŒ éšè— | âœ… æ˜¾ç¤º | åªæ˜¾ç¤ºæ˜¯å¦å¯ç”¨(available) |
| å¥–å“æˆæœ¬ | âŒ éšè— | âœ… æ˜¾ç¤º | ä¸è¿”å›cost_pointså­—æ®µ |
| ç­–ç•¥ç±»å‹ | âŒ éšè— | âœ… æ˜¾ç¤º | ä¸æš´éœ²æŠ½å¥–ç­–ç•¥ |

#### è¯·æ±‚å‚æ•°

```json
{
  "campaign_code": "LUCKY2025",           // å¿…å¡«, æ´»åŠ¨ä»£ç 
  "draw_count": 1                         // å¿…å¡«, æŠ½å¥–æ¬¡æ•°(1-10), é»˜è®¤1
}
```

**å‚æ•°é™åˆ¶**:
| å‚æ•° | ç±»å‹ | å¿…å¡« | èŒƒå›´ | è¯´æ˜ |
|------|------|------|------|------|
| `campaign_code` | string | æ˜¯ | - | æ´»åŠ¨ä»£ç  |
| `draw_count` | number | æ˜¯ | 1-10 | å•æ¬¡æœ€å¤šæŠ½å¥–10æ¬¡ |

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "æŠ½å¥–æˆåŠŸ",
  "data": {
    "draw_id": "draw_20250121203500_a1b2c3d4",  // æŠ½å¥–è®°å½•ID(å”¯ä¸€)
    "campaign_code": "LUCKY2025",
    "user_id": 123,
    "draw_count": 1,                             // æœ¬æ¬¡æŠ½å¥–æ¬¡æ•°
    "total_cost": 10,                            // æ¶ˆè€—ç§¯åˆ†æ€»æ•°
    "prizes": [                                  // æŠ½ä¸­çš„å¥–å“æ•°ç»„
      {
        "id": 102,                               // å¥–å“ID
        "name": "ä¸€ç­‰å¥– - 500ç§¯åˆ†",              // å¥–å“åç§°
        "description": "å¯ç”¨äºå…‘æ¢å•†å“",
        "type": "points",
        "value": "500",
        "image_url": "https://sealos.../prize102.jpg",
        "is_winner": true,                       // æ˜¯å¦ä¸­å¥–: true/false
        "inventory_id": 5678,                    // åº“å­˜è®°å½•ID(ä¸­å¥–æ—¶è‡ªåŠ¨åˆ›å»º)
        "rank": 2                                // å¥–å“ç­‰çº§
        // âŒ æ™®é€šç”¨æˆ·çœ‹ä¸åˆ°: probability(æ¦‚ç‡), stock_before(æŠ½å¥–å‰åº“å­˜)
      }
    ],
    "remaining_points": 490,                     // æŠ½å¥–åå‰©ä½™ç§¯åˆ†
    "remaining_draws_today": 9,                  // ä»Šæ—¥å‰©ä½™æŠ½å¥–æ¬¡æ•°
    "created_at": "2025-01-21T20:35:00.000+08:00"
  }
}
```

**æœªä¸­å¥–å“åº”**:
```json
{
  "success": true,
  "message": "æŠ½å¥–å®Œæˆ",
  "data": {
    "draw_id": "draw_20250121203505_e5f6g7h8",
    "campaign_code": "LUCKY2025",
    "user_id": 123,
    "draw_count": 1,
    "total_cost": 10,
    "prizes": [
      {
        "id": 103,
        "name": "è°¢è°¢å‚ä¸",
        "description": "å†æ¥å†å‰",
        "type": "virtual",
        "value": "0",
        "image_url": "https://sealos.../prize103.jpg",
        "is_winner": false,                      // æœªä¸­å¥–
        "inventory_id": null,                    // æœªä¸­å¥–æ²¡æœ‰åº“å­˜è®°å½•
        "rank": 5
      }
    ],
    "remaining_points": 480,
    "remaining_draws_today": 8,
    "created_at": "2025-01-21T20:35:05.000+08:00"
  }
}
```

#### å¤±è´¥å“åº”

**ç§¯åˆ†ä¸è¶³**:
```json
{
  "success": false,
  "error": "INSUFFICIENT_POINTS",
  "message": "ç§¯åˆ†ä¸è¶³,å½“å‰ç§¯åˆ†: 5, éœ€è¦: 10",
  "data": {
    "current_points": 5,
    "required_points": 10,
    "deficit": 5                                // å·®é¢
  },
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

**æ— æ´»åŠ¨æƒé™**:
```json
{
  "success": false,
  "error": "NO_CAMPAIGN_PERMISSION",
  "message": "æ‚¨æ²¡æœ‰å‚åŠ æ­¤æ´»åŠ¨çš„æƒé™",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

**è¯·æ±‚è¿‡äºé¢‘ç¹** (é™æµè§¦å‘):
```json
{
  "success": false,
  "error": "RATE_LIMIT_EXCEEDED",
  "message": "æŠ½å¥–è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•",
  "data": {
    "limit": 20,                                // é™åˆ¶: 20æ¬¡/åˆ†é’Ÿ
    "window": 60,                               // æ—¶é—´çª—å£: 60ç§’
    "retry_after": 45                           // å»ºè®®45ç§’åé‡è¯•
  },
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

**è¯´æ˜**: 
- è§¦å‘æ¡ä»¶: 1åˆ†é’Ÿå†…è¶…è¿‡20æ¬¡æŠ½å¥–è¯·æ±‚
- HTTPçŠ¶æ€ç : 429 (Too Many Requests)
- å‰ç«¯å»ºè®®: æ·»åŠ é˜²æŠ–å¤„ç†,é¿å…ç”¨æˆ·å¿«é€Ÿé‡å¤ç‚¹å‡»

**ä»Šæ—¥æŠ½å¥–æ¬¡æ•°å·²ç”¨å®Œ**:
```json
{
  "success": false,
  "error": "DAILY_LIMIT_EXCEEDED",
  "message": "ä»Šæ—¥æŠ½å¥–æ¬¡æ•°å·²ç”¨å®Œ,è¯·æ˜å¤©å†æ¥",
  "data": {
    "max_draws_per_day": 10,
    "used_draws_today": 10
  },
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

#### å¾®ä¿¡å°ç¨‹åºå®Œæ•´ç¤ºä¾‹

```javascript
// pages/lottery/lottery.js - å®Œæ•´æŠ½å¥–é€»è¾‘

Page({
  data: {
    campaignCode: 'LUCKY2025',
    prizes: [],
    currentPoints: 0,
    remainingDraws: 10,
    pointsPerDraw: 10,
    isDrawing: false,                         // æ˜¯å¦æ­£åœ¨æŠ½å¥–
    drawResult: null                          // æŠ½å¥–ç»“æœ
  },
  
  onLoad() {
    this.loadPrizes();
    this.loadUserPoints();
  },
  
  // åŠ è½½ç”¨æˆ·ç§¯åˆ†
  async loadUserPoints() {
    try {
      const res = await wx.request({
        url: 'https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/points/balance',
        method: 'GET',
        header: {
          'Authorization': 'Bearer ' + wx.getStorageSync('access_token')
        }
      });
      
      if (res.data.success) {
        this.setData({
          currentPoints: res.data.data.current_points
        });
      }
    } catch (error) {
      console.error('åŠ è½½ç§¯åˆ†å¤±è´¥:', error);
    }
  },
  
  // æ‰§è¡ŒæŠ½å¥–
  async handleDraw() {
    const { isDrawing, currentPoints, pointsPerDraw, campaignCode } = this.data;
    
    // é˜²æ­¢é‡å¤ç‚¹å‡»
    if (isDrawing) {
      return;
    }
    
    // æ£€æŸ¥ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
    if (currentPoints < pointsPerDraw) {
      wx.showModal({
        title: 'ç§¯åˆ†ä¸è¶³',
        content: `å½“å‰ç§¯åˆ†: ${currentPoints}, éœ€è¦: ${pointsPerDraw}`,
        showCancel: false
      });
      return;
    }
    
    // å¼€å§‹æŠ½å¥–
    this.setData({ isDrawing: true });
    
    // æ˜¾ç¤ºæŠ½å¥–åŠ¨ç”»
    wx.showLoading({
      title: 'æŠ½å¥–ä¸­...',
      mask: true
    });
    
    try {
      const res = await wx.request({
        url: 'https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/lottery/draw',
        method: 'POST',
        header: {
          'Authorization': 'Bearer ' + wx.getStorageSync('access_token'),
          'Content-Type': 'application/json'
        },
        data: {
          campaign_code: campaignCode,
          draw_count: 1
        }
      });
      
      wx.hideLoading();
      this.setData({ isDrawing: false });
      
      if (res.data.success) {
        const result = res.data.data;
        const prize = result.prizes[0];
        
        // æ›´æ–°ç§¯åˆ†å’Œå‰©ä½™æ¬¡æ•°
        this.setData({
          currentPoints: result.remaining_points,
          remainingDraws: result.remaining_draws_today,
          drawResult: result
        });
        
        // æ˜¾ç¤ºæŠ½å¥–ç»“æœ
        if (prize.is_winner) {
          // ä¸­å¥–
          wx.showModal({
            title: 'ğŸ‰ æ­å–œä¸­å¥–!',
            content: `æ‚¨æŠ½ä¸­äº†: ${prize.name}\nå¥–å“å·²è‡ªåŠ¨å‘æ”¾åˆ°åº“å­˜`,
            confirmText: 'æŸ¥çœ‹åº“å­˜',
            cancelText: 'ç»§ç»­æŠ½å¥–',
            success: (modalRes) => {
              if (modalRes.confirm) {
                // è·³è½¬åˆ°åº“å­˜é¡µé¢
                wx.navigateTo({
                  url: '/pages/inventory/inventory'
                });
              }
            }
          });
        } else {
          // æœªä¸­å¥–
          wx.showModal({
            title: 'æœªä¸­å¥–',
            content: `${prize.name}\nå†æ¥å†å‰!`,
            showCancel: false
          });
        }
      } else {
        // å¤„ç†é”™è¯¯
        this.handleDrawError(res.data);
      }
    } catch (error) {
      wx.hideLoading();
      this.setData({ isDrawing: false });
      
      wx.showToast({
        title: 'ç½‘ç»œè¯·æ±‚å¤±è´¥',
        icon: 'none'
      });
      console.error('æŠ½å¥–å¤±è´¥:', error);
    }
  },
  
  // å¤„ç†æŠ½å¥–é”™è¯¯
  handleDrawError(errorData) {
    switch (errorData.error) {
      case 'INSUFFICIENT_POINTS':
        wx.showModal({
          title: 'ç§¯åˆ†ä¸è¶³',
          content: errorData.message,
          confirmText: 'å»èµšç§¯åˆ†',
          success: (res) => {
            if (res.confirm) {
              // è·³è½¬åˆ°èµšç§¯åˆ†é¡µé¢
              wx.navigateTo({
                url: '/pages/earn-points/earn-points'
              });
            }
          }
        });
        break;
        
      case 'NO_CAMPAIGN_PERMISSION':
        wx.showModal({
          title: 'æ— æƒé™',
          content: 'æ‚¨è¿˜æ²¡æœ‰è·å¾—è¯¥æ´»åŠ¨çš„å‚ä¸èµ„æ ¼,è¯·è”ç³»ç®¡ç†å‘˜å¼€é€šæƒé™',
          showCancel: false
        });
        break;
        
      case 'RATE_LIMIT_EXCEEDED':
        wx.showToast({
          title: 'æŠ½å¥–è¿‡äºé¢‘ç¹,è¯·ç¨åå†è¯•',
          icon: 'none',
          duration: 2000
        });
        break;
        
      case 'DAILY_LIMIT_EXCEEDED':
        wx.showModal({
          title: 'ä»Šæ—¥æŠ½å¥–æ¬¡æ•°å·²ç”¨å®Œ',
          content: 'æ˜å¤©å†æ¥å§!',
          showCancel: false
        });
        break;
        
      default:
        wx.showToast({
          title: errorData.message || 'æŠ½å¥–å¤±è´¥',
          icon: 'none'
        });
    }
  }
});
```

```xml
<!-- pages/lottery/lottery.wxml - æŠ½å¥–é¡µé¢UI -->
<view class="lottery-page">
  <!-- æ´»åŠ¨ä¿¡æ¯ -->
  <view class="header">
    <text class="title">{{campaignName}}</text>
    <view class="info">
      <text>å½“å‰ç§¯åˆ†: {{currentPoints}}</text>
      <text>ä»Šæ—¥å‰©ä½™æ¬¡æ•°: {{remainingDraws}}</text>
    </view>
  </view>
  
  <!-- å¥–å“å±•ç¤ºåŒº -->
  <view class="prizes-grid">
    <view class="prize-item" wx:for="{{prizes}}" wx:key="id">
      <image src="{{item.image_url}}" mode="aspectFit"></image>
      <text>{{item.name}}</text>
    </view>
  </view>
  
  <!-- æŠ½å¥–æŒ‰é’® -->
  <view class="draw-button-container">
    <button 
      class="draw-button" 
      type="primary"
      bindtap="handleDraw"
      disabled="{{isDrawing || currentPoints < pointsPerDraw}}"
    >
      {{isDrawing ? 'æŠ½å¥–ä¸­...' : 'æŠ½å¥–(' + pointsPerDraw + 'ç§¯åˆ†)'}}
    </button>
  </view>
  
  <!-- æ´»åŠ¨è§„åˆ™ -->
  <view class="rules">
    <text class="rules-title">æ´»åŠ¨è§„åˆ™</text>
    <view class="rule-item" wx:for="{{rules}}" wx:key="index">
      <text>{{index + 1}}. {{item}}</text>
    </view>
  </view>
</view>
```

---

### 3.4 æŸ¥è¯¢ç”¨æˆ·æŠ½å¥–å†å²

**APIè·¯å¾„**: `GET /api/v4/unified-engine/lottery/history/:user_id`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢ç”¨æˆ·çš„æŠ½å¥–å†å²è®°å½•
- **æƒé™æ§åˆ¶**: ç®¡ç†å‘˜å¯æŸ¥è¯¢ä»»ä½•ç”¨æˆ·, æ™®é€šç”¨æˆ·åªèƒ½æŸ¥è¯¢è‡ªå·±
- **æ”¯æŒåˆ†é¡µ**
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/lottery.js` - getDrawHistoryç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**è·¯å¾„å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `user_id` | number | ç”¨æˆ·ID |

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|-------|------|
| `page` | number | 1 | é¡µç  |
| `limit` | number | 20 | æ¯é¡µæ¡æ•° |
| `campaign_code` | string | - | å¯é€‰,ç­›é€‰æŒ‡å®šæ´»åŠ¨ |

**ç¤ºä¾‹**: `/api/v4/unified-engine/lottery/history/123?page=1&limit=20&campaign_code=LUCKY2025`

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 1001,
        "draw_id": "draw_20250121203500_a1b2c3d4",
        "campaign_code": "LUCKY2025",
        "campaign_name": "2025æ–°æ˜¥å¤§æŠ½å¥–",
        "prize_id": 102,
        "prize_name": "ä¸€ç­‰å¥– - 500ç§¯åˆ†",
        "prize_type": "points",
        "prize_value": "500",
        "is_winner": true,                        // æ˜¯å¦ä¸­å¥–
        "points_cost": 10,                        // æ¶ˆè€—ç§¯åˆ†
        "created_at": "2025-01-21T20:35:00.000+08:00"
      },
      {
        "id": 1000,
        "draw_id": "draw_20250121203000_x9y8z7",
        "campaign_code": "LUCKY2025",
        "campaign_name": "2025æ–°æ˜¥å¤§æŠ½å¥–",
        "prize_id": 103,
        "prize_name": "è°¢è°¢å‚ä¸",
        "prize_type": "virtual",
        "prize_value": "0",
        "is_winner": false,
        "points_cost": 10,
        "created_at": "2025-01-21T20:30:00.000+08:00"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 156,                               // æ€»è®°å½•æ•°
      "total_pages": 8,                           // æ€»é¡µæ•°
      "has_next": true,                           // æ˜¯å¦æœ‰ä¸‹ä¸€é¡µ
      "has_prev": false                           // æ˜¯å¦æœ‰ä¸Šä¸€é¡µ
    },
    "summary": {                                  // ç»Ÿè®¡æ‘˜è¦
      "total_draws": 156,                         // æ€»æŠ½å¥–æ¬¡æ•°
      "total_wins": 34,                           // æ€»ä¸­å¥–æ¬¡æ•°
      "win_rate": "21.79%",                       // ä¸­å¥–ç‡
      "total_points_spent": 1560                  // æ€»æ¶ˆè€—ç§¯åˆ†
    }
  }
}
```

#### å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹

```javascript
// pages/lottery-history/lottery-history.js

Page({
  data: {
    historyList: [],
    page: 1,
    limit: 20,
    hasMore: true,
    isLoading: false,
    summary: null
  },
  
  onLoad() {
    this.loadHistory();
  },
  
  async loadHistory(isLoadMore = false) {
    if (this.data.isLoading) return;
    
    try {
      this.setData({ isLoading: true });
      
      const user_id = wx.getStorageSync('user_info').user_id;
      const page = isLoadMore ? this.data.page + 1 : 1;
      
      const res = await wx.request({
        url: `https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/lottery/history/${user_id}?page=${page}&limit=${this.data.limit}`,
        method: 'GET',
        header: {
          'Authorization': 'Bearer ' + wx.getStorageSync('access_token')
        }
      });
      
      if (res.data.success) {
        const items = res.data.data.items;
        const pagination = res.data.data.pagination;
        
        this.setData({
          historyList: isLoadMore ? [...this.data.historyList, ...items] : items,
          page: page,
          hasMore: pagination.has_next,
          isLoading: false,
          summary: res.data.data.summary
        });
      } else {
        this.setData({ isLoading: false });
      }
    } catch (error) {
      this.setData({ isLoading: false });
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      });
    }
  },
  
  // ä¸Šæ‹‰åŠ è½½æ›´å¤š
  onReachBottom() {
    if (this.data.hasMore && !this.data.isLoading) {
      this.loadHistory(true);
    }
  }
});
```

---

### 3.5 æŸ¥è¯¢ç”¨æˆ·æŠ½å¥–ç»Ÿè®¡

**APIè·¯å¾„**: `GET /api/v4/unified-engine/lottery/statistics/:user_id`

**åŠŸèƒ½è¯´æ˜**:
- è·å–ç”¨æˆ·çš„æŠ½å¥–ç»Ÿè®¡ä¿¡æ¯
- åŒ…å«æ€»æŠ½å¥–æ¬¡æ•°ã€ä¸­å¥–æ¬¡æ•°ã€ä¸­å¥–ç‡ç­‰
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/lottery.js` - getUserStatisticsç«¯ç‚¹

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "user_id": 123,
    "total_draws": 156,                         // æ€»æŠ½å¥–æ¬¡æ•°
    "total_wins": 34,                           // æ€»ä¸­å¥–æ¬¡æ•°
    "win_rate": "21.79%",                       // ä¸­å¥–ç‡
    "total_points_spent": 1560,                 // æ€»æ¶ˆè€—ç§¯åˆ†
    "total_value_won": 12500,                   // æ€»ä¸­å¥–ä»·å€¼(å…ƒ)
    "campaigns_participated": 3,                // å‚ä¸æ´»åŠ¨æ•°
    "favorite_campaign": "LUCKY2025",           // æœ€å¸¸å‚ä¸çš„æ´»åŠ¨
    "last_draw_at": "2025-01-21T20:35:00.000+08:00",  // æœ€åä¸€æ¬¡æŠ½å¥–æ—¶é—´
    "lucky_rank": "å¹¸è¿æ˜Ÿ",                     // å¹¸è¿ç­‰çº§
    "achievements": [                           // æˆå°±åˆ—è¡¨
      {
        "name": "åˆæ¥ä¹åˆ°",
        "description": "å®Œæˆé¦–æ¬¡æŠ½å¥–",
        "achieved_at": "2025-01-01T10:00:00.000+08:00"
      },
      {
        "name": "æŠ½å¥–è¾¾äºº",
        "description": "ç´¯è®¡æŠ½å¥–100æ¬¡",
        "achieved_at": "2025-01-15T16:30:00.000+08:00"
      }
    ]
  }
}
```

---

### 3.6 è·å–æ´»åŠ¨åˆ—è¡¨

**APIè·¯å¾„**: `GET /api/v4/unified-engine/lottery/campaigns`

**åŠŸèƒ½è¯´æ˜**:
- è·å–æ‰€æœ‰æ´»åŠ¨çš„åˆ—è¡¨
- **è‡ªåŠ¨è¿‡æ»¤**: ä»…è¿”å›ç”¨æˆ·æœ‰æƒé™å‚ä¸çš„æ´»åŠ¨
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/lottery.js` - getCampaignsç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|-------|------|
| `status` | string | `active` | æ´»åŠ¨çŠ¶æ€: active/inactive/ended/all |

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "code": "LUCKY2025",
      "name": "2025æ–°æ˜¥å¤§æŠ½å¥–",
      "description": "å‚ä¸æŠ½å¥–,èµ¢å–ä¸°åšå¥–å“!",
      "status": "active",
      "start_time": "2025-01-01T00:00:00.000+08:00",
      "end_time": "2025-03-01T23:59:59.999+08:00",
      "points_per_draw": 10,
      "max_draws_per_day": 10,
      "image_url": "https://sealos.../banner.jpg",
      "has_permission": true,                   // ç”¨æˆ·æ˜¯å¦æœ‰æƒé™å‚ä¸
      "participation_count": 156                // ç”¨æˆ·å‚ä¸æ¬¡æ•°
    },
    {
      "id": 2,
      "code": "SPRING2025",
      "name": "æ˜¥å­£ç‰¹æƒ æŠ½å¥–",
      "description": "æ˜¥æš–èŠ±å¼€,å¥½ç¤¼ç›¸é€",
      "status": "active",
      "start_time": "2025-03-01T00:00:00.000+08:00",
      "end_time": "2025-04-30T23:59:59.999+08:00",
      "points_per_draw": 20,
      "max_draws_per_day": 5,
      "image_url": "https://sealos.../spring-banner.jpg",
      "has_permission": false,                  // æ— æƒé™å‚ä¸
      "participation_count": 0
    }
  ],
  "metadata": {
    "total_campaigns": 2,
    "accessible_campaigns": 1,                  // æœ‰æƒé™å‚ä¸çš„æ´»åŠ¨æ•°
    "user_id": 123
  }
}
```

#### å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹

```javascript
// pages/campaigns/campaigns.js - æ´»åŠ¨åˆ—è¡¨é¡µ

Page({
  data: {
    campaigns: [],
    activeTab: 'active'
  },
  
  onLoad() {
    this.loadCampaigns();
  },
  
  async loadCampaigns(status = 'active') {
    try {
      const res = await wx.request({
        url: `https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/lottery/campaigns?status=${status}`,
        method: 'GET',
        header: {
          'Authorization': 'Bearer ' + wx.getStorageSync('access_token')
        }
      });
      
      if (res.data.success) {
        this.setData({
          campaigns: res.data.data
        });
      }
    } catch (error) {
      wx.showToast({
        title: 'åŠ è½½æ´»åŠ¨åˆ—è¡¨å¤±è´¥',
        icon: 'none'
      });
    }
  },
  
  // è¿›å…¥æŠ½å¥–é¡µé¢
  goToLottery(e) {
    const campaign = e.currentTarget.dataset.campaign;
    
    if (!campaign.has_permission) {
      wx.showModal({
        title: 'æ— æƒé™',
        content: 'æ‚¨è¿˜æ²¡æœ‰è·å¾—è¯¥æ´»åŠ¨çš„å‚ä¸èµ„æ ¼',
        showCancel: false
      });
      return;
    }
    
    wx.navigateTo({
      url: `/pages/lottery/lottery?code=${campaign.code}`
    });
  }
});
```

---

### 3.7 ç³»ç»Ÿå¥åº·æ£€æŸ¥

**APIè·¯å¾„**: `GET /api/v4/unified-engine/lottery/health`

**åŠŸèƒ½è¯´æ˜**:
- æ£€æŸ¥æŠ½å¥–ç³»ç»Ÿçš„å¥åº·çŠ¶æ€
- **å…¬å¼€API**, ä¸éœ€è¦Tokenè®¤è¯
- ç”¨äºç›‘æ§ç³»ç»Ÿå¯ç”¨æ€§

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/lottery.js` - healthç«¯ç‚¹

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "status": "healthy",                        // çŠ¶æ€: healthy/degraded/unhealthy
    "timestamp": "2025-01-21T20:35:00.000+08:00",
    "version": "V4.0",
    "uptime": 86400,                            // è¿è¡Œæ—¶é—´(ç§’)
    "checks": {
      "database": "healthy",                    // æ•°æ®åº“çŠ¶æ€
      "redis": "healthy",                       // RedisçŠ¶æ€
      "lottery_engine": "healthy"               // æŠ½å¥–å¼•æ“çŠ¶æ€
    }
  }
}
```

---

## ğŸ“ æŠ½å¥–æ¨¡å—æ€»ç»“

### APIæ¸…å•

| API | æ–¹æ³• | è·¯å¾„ | è®¤è¯ | è¯´æ˜ |
|-----|------|------|------|------|
| è·å–å¥–å“åˆ—è¡¨ | GET | `/api/v4/unified-engine/lottery/prizes/:campaignCode` | âœ… | æŸ¥è¯¢æ´»åŠ¨å¥–å“,è‡ªåŠ¨è„±æ• |
| è·å–æ´»åŠ¨é…ç½® | GET | `/api/v4/unified-engine/lottery/config/:campaignCode` | âœ… | æŸ¥è¯¢æ´»åŠ¨é…ç½®,è‡ªåŠ¨è„±æ• |
| æ‰§è¡ŒæŠ½å¥– | POST | `/api/v4/unified-engine/lottery/draw` | âœ… | æ ¸å¿ƒæŠ½å¥–åŠŸèƒ½,V4å¼•æ“ |
| æŠ½å¥–å†å² | GET | `/api/v4/unified-engine/lottery/history/:user_id` | âœ… | æŸ¥è¯¢ç”¨æˆ·æŠ½å¥–å†å² |
| ç”¨æˆ·ç»Ÿè®¡ | GET | `/api/v4/unified-engine/lottery/statistics/:user_id` | âœ… | æŸ¥è¯¢ç”¨æˆ·æŠ½å¥–ç»Ÿè®¡ |
| æ´»åŠ¨åˆ—è¡¨ | GET | `/api/v4/unified-engine/lottery/campaigns` | âœ… | æŸ¥è¯¢æ‰€æœ‰æ´»åŠ¨ |
| å¥åº·æ£€æŸ¥ | GET | `/api/v4/unified-engine/lottery/health` | âŒ | ç³»ç»Ÿå¥åº·çŠ¶æ€ |

### æ•°æ®è„±æ•è§„åˆ™

**æ™®é€šç”¨æˆ·(publicçº§åˆ«)**:
- âŒ çœ‹ä¸åˆ°: `probability`(æŠ½å¥–æ¦‚ç‡), `stock`(åº“å­˜æ•°é‡), `cost_price`(æˆæœ¬ä»·)
- âœ… å¯ä»¥çœ‹: `name`(å¥–å“åç§°), `description`(æè¿°), `type`(ç±»å‹), `value`(ä»·å€¼), `image_url`(å›¾ç‰‡)

**ç®¡ç†å‘˜(fullçº§åˆ«)**:
- âœ… å¯ä»¥çœ‹åˆ°æ‰€æœ‰å­—æ®µ,åŒ…æ‹¬æ•æ„Ÿçš„æ¦‚ç‡é…ç½®ã€åº“å­˜æ•°æ®ã€æˆæœ¬ç®¡ç†ä¿¡æ¯

### æ´»åŠ¨æƒé™æ§åˆ¶

**æƒé™è¦æ±‚**:
1. ç®¡ç†å‘˜(role_level >= 100): è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æ´»åŠ¨æƒé™
2. æ™®é€šç”¨æˆ·: å¿…é¡»æ‹¥æœ‰`campaign_{æ´»åŠ¨ID}`è§’è‰²æ‰èƒ½å‚ä¸

**å‰ç«¯å¤„ç†**:
- è°ƒç”¨æŠ½å¥–APIå‰,æ£€æŸ¥æ´»åŠ¨æƒé™
- æ— æƒé™æ—¶æ˜¾ç¤ºå‹å¥½æç¤º: "æ‚¨è¿˜æ²¡æœ‰è·å¾—è¯¥æ´»åŠ¨çš„å‚ä¸èµ„æ ¼,è¯·è”ç³»ç®¡ç†å‘˜å¼€é€šæƒé™"

### å‰ç«¯å¼€å‘å»ºè®®

1. **æŠ½å¥–æµç¨‹**:
   - åŠ è½½æ´»åŠ¨é…ç½® â†’ æ£€æŸ¥ç”¨æˆ·ç§¯åˆ† â†’ æ£€æŸ¥æ´»åŠ¨æƒé™ â†’ æ‰§è¡ŒæŠ½å¥– â†’ æ˜¾ç¤ºç»“æœ

2. **é”™è¯¯å¤„ç†**:
   - ç§¯åˆ†ä¸è¶³: æç¤ºå¹¶å¼•å¯¼ç”¨æˆ·èµšç§¯åˆ†
   - æ— æƒé™: æç¤ºè”ç³»ç®¡ç†å‘˜
   - é¢‘ç‡é™åˆ¶: æç¤º5ç§’åé‡è¯•
   - æ¯æ—¥æ¬¡æ•°ç”¨å®Œ: æç¤ºæ˜å¤©å†æ¥

3. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**:
   - æ˜¾ç¤ºæŠ½å¥–åŠ¨ç”»(åŠ è½½ä¸­...)
   - ä¸­å¥–åæ’­æ”¾åº†ç¥åŠ¨ç”»å’ŒéŸ³æ•ˆ
   - å®æ—¶æ˜¾ç¤ºå‰©ä½™ç§¯åˆ†å’ŒæŠ½å¥–æ¬¡æ•°
   - æä¾›æŠ½å¥–å†å²æŸ¥è¯¢åŠŸèƒ½

---

**ğŸ“„ æ–‡æ¡£ç¬¬3éƒ¨åˆ†å®Œæˆ**

**ä¸‹ä¸€éƒ¨åˆ†**: Part4 - åº“å­˜å’Œç§¯åˆ†æ¨¡å—è¯¦ç»†API


---


**æ–‡æ¡£éƒ¨åˆ†**: ç¬¬4éƒ¨åˆ† - åº“å­˜å’Œç§¯åˆ†æ¨¡å—
**åˆ›å»ºæ—¶é—´**: 2025å¹´01æœˆ21æ—¥ (åŒ—äº¬æ—¶é—´)
**åŸºäºå®é™…ä»£ç éªŒè¯**: âœ…

---

## ğŸ“– æ¨¡å—æ¦‚è¿°

### åº“å­˜ç®¡ç†æ¨¡å—(`/api/v4/inventory`)
è´Ÿè´£ç”¨æˆ·åº“å­˜ç‰©å“çš„ç®¡ç†,åŒ…æ‹¬:
- ğŸ“¦ åº“å­˜æŸ¥è¯¢å’Œç‰©å“è¯¦æƒ…
- âœ… ç‰©å“ä½¿ç”¨å’Œæ ¸é”€
- ğŸ å•†å“å…‘æ¢ç³»ç»Ÿ
- ğŸ”„ ç‰©å“è½¬ç§»åŠŸèƒ½
- ğŸª å¸‚åœºäº¤æ˜“ç³»ç»Ÿ

### ç§¯åˆ†ç³»ç»Ÿæ¨¡å—(`/api/v4/unified-engine/points`)
è´Ÿè´£ç”¨æˆ·ç§¯åˆ†çš„ç®¡ç†,åŒ…æ‹¬:
- ğŸ’° ç§¯åˆ†ä½™é¢æŸ¥è¯¢
- ğŸ“Š äº¤æ˜“è®°å½•æŸ¥è¯¢
- ğŸ”§ ç®¡ç†å‘˜ç§¯åˆ†è°ƒæ•´
- ğŸ“ˆ ç»¼åˆç»Ÿè®¡ä¿¡æ¯

---

## ğŸ“¦ åº“å­˜ç®¡ç†API

### 4.1 æŸ¥è¯¢ç”¨æˆ·åº“å­˜åˆ—è¡¨

**APIè·¯å¾„**: `GET /api/v4/inventory/user/:user_id`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢ç”¨æˆ·çš„åº“å­˜ç‰©å“åˆ—è¡¨
- **æƒé™æ§åˆ¶**: ç®¡ç†å‘˜å¯æŸ¥è¯¢ä»»ä½•ç”¨æˆ·,æ™®é€šç”¨æˆ·åªèƒ½æŸ¥è¯¢è‡ªå·±
- **è‡ªåŠ¨è¡¥å……**: åç«¯è‡ªåŠ¨æ·»åŠ é»˜è®¤å›¾æ ‡å’ŒçŠ¶æ€æè¿°
- **æ”¯æŒåˆ†é¡µ**
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/inventory.js` - getUserInventoryç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**è·¯å¾„å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `user_id` | number | ç”¨æˆ·ID |

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|-------|------|
| `page` | number | 1 | é¡µç  |
| `limit` | number | 20 | æ¯é¡µæ¡æ•°(æœ€å¤§100) |
| `status` | string | - | å¯é€‰,ç­›é€‰çŠ¶æ€: unused/used/expired |
| `type` | string | - | å¯é€‰,ç­›é€‰ç±»å‹: physical/virtual/points |

**ç¤ºä¾‹**: `/api/v4/inventory/user/123?page=1&limit=20&status=unused`

#### è¯·æ±‚å¤´

```
Authorization: Bearer {access_token}
```

#### æˆåŠŸå“åº”ï¼ˆâœ… å®é™…ä»£ç éªŒè¯ 2025-10-22ï¼‰

```json
{
  "success": true,
  "message": "è·å–åº“å­˜åˆ—è¡¨æˆåŠŸ",
  "data": {
    "inventory": [                               // æ³¨æ„ï¼šå­—æ®µåä¸ºinventoryï¼Œä¸æ˜¯items
      {
        "inventory_id": 5678,                    // æ³¨æ„ï¼šå­—æ®µåä¸ºinventory_idï¼Œä¸æ˜¯id
        "user_id": 123,
        "prize_id": 102,
        "prize_name": "ä¸€ç­‰å¥– - 500ç§¯åˆ†",        // å¥–å“åç§°
        "prize_type": "points",                  // ç±»å‹: physical/virtual/points
        "prize_value": "500",                    // ä»·å€¼
        "prize_description": "å¯ç”¨äºå…‘æ¢å•†å“",   // æè¿°
        "image_url": "https://sealos.../prize102.jpg",  // å›¾ç‰‡URL
        "default_icon": "ğŸ’°",                    // é»˜è®¤å›¾æ ‡(åç«¯è‡ªåŠ¨æ·»åŠ )
        "status": "unused",                      // çŠ¶æ€: unused/used/expired
        "status_text": "æœªä½¿ç”¨",                // çŠ¶æ€æ–‡æœ¬(åç«¯è‡ªåŠ¨æ·»åŠ )
        "verification_code": null,               // æ ¸é”€ç (ç”Ÿæˆåæ˜¾ç¤º)
        "used_at": null,                         // ä½¿ç”¨æ—¶é—´
        "expires_at": "2025-12-31T23:59:59.999+08:00",  // è¿‡æœŸæ—¶é—´
        "source": "lottery",                     // æ¥æº: lottery/exchange/transfer/admin
        "source_text": "æŠ½å¥–è·å¾—",               // æ¥æºæ–‡æœ¬(åç«¯è‡ªåŠ¨æ·»åŠ )
        "campaign_code": "LUCKY2025",            // æ´»åŠ¨ä»£ç 
        "acquired_at": "2025-01-21T20:35:00.000+08:00"  // è·å¾—æ—¶é—´
      },
      {
        "inventory_id": 5677,
        "user_id": 123,
        "prize_id": 101,
        "prize_name": "ç‰¹ç­‰å¥– - iPhone 15 Pro Max",
        "prize_type": "physical",
        "prize_value": "9999",
        "prize_description": "256GB æ·±ç©ºé»‘",
        "image_url": "https://sealos.../prize101.jpg",
        "icon": "ğŸ“±",                            // æ³¨æ„ï¼šå­—æ®µåä¸ºiconï¼Œä¸æ˜¯default_icon
        "status": "available",                   // æ³¨æ„ï¼šå®é™…ä»£ç ä½¿ç”¨availableï¼Œä¸æ˜¯unused
        "status_description": "æœªä½¿ç”¨",         // æ³¨æ„ï¼šå­—æ®µåä¸ºstatus_description
        "verification_code": "ABC123456",        // å·²ç”Ÿæˆæ ¸é”€ç 
        "used_at": null,                         // ä½¿ç”¨æ—¶é—´
        "expires_at": "2025-06-30T23:59:59.999+08:00",
        "is_expired": false,                     // æ˜¯å¦è¿‡æœŸï¼ˆåç«¯è‡ªåŠ¨è®¡ç®—ï¼‰
        "source": "lottery",
        "source_text": "æŠ½å¥–è·å¾—",
        "campaign_code": "LUCKY2025",
        "acquired_at": "2025-01-20T15:30:00.000+08:00",
        "created_at": "2025-01-20T15:30:00.000+08:00"
      }
    ],
    "pagination": {
      "total": 35,                               // æ€»è®°å½•æ•°
      "page": 1,                                 // å½“å‰é¡µç 
      "limit": 20,                               // æ¯é¡µæ¡æ•°
      "total_pages": 2                           // æ€»é¡µæ•°
    }
  }
}
```

#### å¤±è´¥å“åº”

**æƒé™ä¸è¶³**:
```json
{
  "success": false,
  "error": "FORBIDDEN",
  "message": "æ‚¨åªèƒ½æŸ¥è¯¢è‡ªå·±çš„åº“å­˜",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

#### å¾®ä¿¡å°ç¨‹åºå®Œæ•´ç¤ºä¾‹

```javascript
// pages/inventory/inventory.js - åº“å­˜åˆ—è¡¨é¡µ

Page({
  data: {
    inventoryList: [],
    page: 1,
    limit: 20,
    hasMore: true,
    isLoading: false,
    summary: null,
    filterStatus: 'all',                        // ç­›é€‰çŠ¶æ€: all/unused/used/expired
    filterType: 'all'                           // ç­›é€‰ç±»å‹: all/physical/virtual/points
  },
  
  onLoad() {
    this.loadInventory();
  },
  
  async loadInventory(isLoadMore = false) {
    if (this.data.isLoading) return;
    
    try {
      this.setData({ isLoading: true });
      
      const user_id = wx.getStorageSync('user_info').user_id;
      const page = isLoadMore ? this.data.page + 1 : 1;
      
      // æ„å»ºæŸ¥è¯¢å‚æ•°
      let queryParams = `page=${page}&limit=${this.data.limit}`;
      if (this.data.filterStatus !== 'all') {
        queryParams += `&status=${this.data.filterStatus}`;
      }
      if (this.data.filterType !== 'all') {
        queryParams += `&type=${this.data.filterType}`;
      }
      
      const res = await wx.request({
        url: `https://omqktqrtntnn.sealosbja.site/api/v4/inventory/user/${user_id}?${queryParams}`,
        method: 'GET',
        header: {
          'Authorization': 'Bearer ' + wx.getStorageSync('access_token')
        }
      });
      
      if (res.data.success) {
        // æ³¨æ„ï¼šä½¿ç”¨actualä»£ç è¿”å›çš„å­—æ®µå
        const inventory = res.data.data.inventory; // ä¸æ˜¯items
        const pagination = res.data.data.pagination;
        
        this.setData({
          inventoryList: isLoadMore ? [...this.data.inventoryList, ...inventory] : inventory,
          page: page,
          hasMore: pagination.page < pagination.total_pages, // æ ¹æ®total_pagesè®¡ç®—
          isLoading: false
        });
      } else {
        this.setData({ isLoading: false });
        wx.showToast({
          title: res.data.message || 'åŠ è½½å¤±è´¥',
          icon: 'none'
        });
      }
    } catch (error) {
      this.setData({ isLoading: false });
      wx.showToast({
        title: 'ç½‘ç»œè¯·æ±‚å¤±è´¥',
        icon: 'none'
      });
      console.error('åŠ è½½åº“å­˜å¤±è´¥:', error);
    }
  },
  
  // ç­›é€‰çŠ¶æ€
  onFilterStatusChange(e) {
    this.setData({
      filterStatus: e.detail.value,
      page: 1
    });
    this.loadInventory();
  },
  
  // ç­›é€‰ç±»å‹
  onFilterTypeChange(e) {
    this.setData({
      filterType: e.detail.value,
      page: 1
    });
    this.loadInventory();
  },
  
  // æŸ¥çœ‹ç‰©å“è¯¦æƒ…
  viewItemDetail(e) {
    const item_id = e.currentTarget.dataset.id;
    wx.navigateTo({
      url: `/pages/inventory-detail/inventory-detail?id=${item_id}`
    });
  },
  
  // ä½¿ç”¨ç‰©å“
  async useItem(e) {
    const item = e.currentTarget.dataset.item;
    
    // æ£€æŸ¥ç‰©å“çŠ¶æ€
    if (item.status !== 'unused') {
      wx.showToast({
        title: 'è¯¥ç‰©å“å·²ä½¿ç”¨æˆ–å·²è¿‡æœŸ',
        icon: 'none'
      });
      return;
    }
    
    // æ ¹æ®ç‰©å“ç±»å‹æç¤ºä¸åŒçš„ä½¿ç”¨æ–¹å¼
    let content = 'ç¡®å®šä½¿ç”¨è¯¥ç‰©å“å—?';
    if (item.prize_type === 'physical') {
      content = 'å®ç‰©å¥–å“éœ€è¦ç”Ÿæˆæ ¸é”€ç ååˆ°æŒ‡å®šåœ°ç‚¹é¢†å–';
    } else if (item.prize_type === 'points') {
      content = 'ç§¯åˆ†å°†è‡ªåŠ¨å‘æ”¾åˆ°æ‚¨çš„è´¦æˆ·';
    }
    
    wx.showModal({
      title: 'ä½¿ç”¨ç‰©å“',
      content: content,
      success: async (modalRes) => {
        if (modalRes.confirm) {
          try {
            const res = await wx.request({
              url: `https://omqktqrtntnn.sealosbja.site/api/v4/inventory/use/${item.id}`,
              method: 'POST',
              header: {
                'Authorization': 'Bearer ' + wx.getStorageSync('access_token')
              }
            });
            
            if (res.data.success) {
              wx.showToast({
                title: 'ä½¿ç”¨æˆåŠŸ',
                icon: 'success'
              });
              
              // é‡æ–°åŠ è½½åº“å­˜
              this.loadInventory();
            } else {
              wx.showToast({
                title: res.data.message || 'ä½¿ç”¨å¤±è´¥',
                icon: 'none'
              });
            }
          } catch (error) {
            wx.showToast({
              title: 'ç½‘ç»œè¯·æ±‚å¤±è´¥',
              icon: 'none'
            });
          }
        }
      }
    });
  },
  
  // ä¸Šæ‹‰åŠ è½½æ›´å¤š
  onReachBottom() {
    if (this.data.hasMore && !this.data.isLoading) {
      this.loadInventory(true);
    }
  },
  
  // ä¸‹æ‹‰åˆ·æ–°
  onPullDownRefresh() {
    this.setData({ page: 1 });
    this.loadInventory().then(() => {
      wx.stopPullDownRefresh();
    });
  }
});
```

```xml
<!-- pages/inventory/inventory.wxml - åº“å­˜åˆ—è¡¨UI -->
<view class="inventory-page">
  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <view class="summary-card" wx:if="{{summary}}">
    <view class="summary-item">
      <text class="label">æ€»ç‰©å“æ•°</text>
      <text class="value">{{summary.total_items}}</text>
    </view>
    <view class="summary-item">
      <text class="label">æœªä½¿ç”¨</text>
      <text class="value primary">{{summary.unused_items}}</text>
    </view>
    <view class="summary-item">
      <text class="label">æ€»ä»·å€¼</text>
      <text class="value gold">Â¥{{summary.total_value}}</text>
    </view>
  </view>
  
  <!-- ç­›é€‰æ  -->
  <view class="filter-bar">
    <picker 
      mode="selector" 
      range="{{['å…¨éƒ¨çŠ¶æ€', 'æœªä½¿ç”¨', 'å·²ä½¿ç”¨', 'å·²è¿‡æœŸ']}}" 
      value="{{['all','unused','used','expired'].indexOf(filterStatus)}}"
      bindchange="onFilterStatusChange"
    >
      <view class="filter-item">
        çŠ¶æ€ç­›é€‰ <text class="arrow">â–¼</text>
      </view>
    </picker>
    
    <picker 
      mode="selector" 
      range="{{['å…¨éƒ¨ç±»å‹', 'å®ç‰©', 'è™šæ‹Ÿ', 'ç§¯åˆ†']}}" 
      value="{{['all','physical','virtual','points'].indexOf(filterType)}}"
      bindchange="onFilterTypeChange"
    >
      <view class="filter-item">
        ç±»å‹ç­›é€‰ <text class="arrow">â–¼</text>
      </view>
    </picker>
  </view>
  
  <!-- åº“å­˜åˆ—è¡¨ -->
  <view class="inventory-list">
    <view 
      class="inventory-item {{item.status !== 'unused' ? 'disabled' : ''}}" 
      wx:for="{{inventoryList}}" 
      wx:key="id"
      bindtap="viewItemDetail"
      data-id="{{item.id}}"
    >
      <view class="item-left">
        <!-- ç‰©å“å›¾ç‰‡ -->
        <image class="item-image" src="{{item.image_url}}" mode="aspectFill"></image>
        
        <!-- é»˜è®¤å›¾æ ‡è¦†ç›– -->
        <text class="default-icon">{{item.default_icon}}</text>
      </view>
      
      <view class="item-middle">
        <text class="item-name">{{item.prize_name}}</text>
        <text class="item-desc">{{item.prize_description}}</text>
        <view class="item-meta">
          <text class="meta-item">{{item.source_text}}</text>
          <text class="meta-item">{{item.acquired_at}}</text>
        </view>
      </view>
      
      <view class="item-right">
        <!-- çŠ¶æ€æ ‡ç­¾ -->
        <view class="status-tag {{item.status}}">
          {{item.status_text}}
        </view>
        
        <!-- ä½¿ç”¨æŒ‰é’® -->
        <button 
          wx:if="{{item.status === 'unused'}}"
          class="use-btn" 
          size="mini"
          catchtap="useItem"
          data-item="{{item}}"
        >
          ä½¿ç”¨
        </button>
      </view>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{!isLoading && inventoryList.length === 0}}" class="empty-state">
      <image src="/images/empty-inventory.png" mode="aspectFit"></image>
      <text>æš‚æ— åº“å­˜ç‰©å“</text>
    </view>
    
    <!-- åŠ è½½ä¸­ -->
    <view wx:if="{{isLoading}}" class="loading-more">
      <text>åŠ è½½ä¸­...</text>
    </view>
    
    <!-- æ²¡æœ‰æ›´å¤š -->
    <view wx:if="{{!hasMore && inventoryList.length > 0}}" class="no-more">
      <text>æ²¡æœ‰æ›´å¤šäº†</text>
    </view>
  </view>
</view>
```

---

### 4.2 æŸ¥è¯¢åº“å­˜ç‰©å“è¯¦æƒ…

**APIè·¯å¾„**: `GET /api/v4/inventory/item/:item_id`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢æŒ‡å®šåº“å­˜ç‰©å“çš„è¯¦ç»†ä¿¡æ¯
- **æƒé™æ§åˆ¶**: åªèƒ½æŸ¥è¯¢è‡ªå·±çš„åº“å­˜ç‰©å“,ç®¡ç†å‘˜å¯æŸ¥è¯¢æ‰€æœ‰
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/inventory.js` - getInventoryItemç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**è·¯å¾„å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `item_id` | number | åº“å­˜ç‰©å“ID |

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "id": 5678,
    "user_id": 123,
    "prize_id": 102,
    "prize_name": "ä¸€ç­‰å¥– - 500ç§¯åˆ†",
    "prize_type": "points",
    "prize_value": "500",
    "prize_description": "å¯ç”¨äºå…‘æ¢å•†å“",
    "image_url": "https://sealos.../prize102.jpg",
    "default_icon": "ğŸ’°",
    "status": "unused",
    "status_text": "æœªä½¿ç”¨",
    "verification_code": null,
    "used_at": null,
    "expires_at": "2025-12-31T23:59:59.999+08:00",
    "source": "lottery",
    "source_text": "æŠ½å¥–è·å¾—",
    "campaign_code": "LUCKY2025",
    "campaign_name": "2025æ–°æ˜¥å¤§æŠ½å¥–",
    "acquired_at": "2025-01-21T20:35:00.000+08:00",
    
    // é¢å¤–çš„è¯¦ç»†ä¿¡æ¯
    "usage_instructions": "ç‚¹å‡»ä½¿ç”¨æŒ‰é’®å³å¯é¢†å–ç§¯åˆ†åˆ°è´¦æˆ·",  // ä½¿ç”¨è¯´æ˜
    "expiry_days_remaining": 344,                         // è·ç¦»è¿‡æœŸå‰©ä½™å¤©æ•°
    "can_transfer": true,                                 // æ˜¯å¦å¯è½¬ç§»
    "can_sell": true,                                     // æ˜¯å¦å¯å‡ºå”®åˆ°å¸‚åœº
    "estimated_market_price": 450                         // é¢„ä¼°å¸‚åœºä»·æ ¼(ç§¯åˆ†)
  }
}
```

#### å¤±è´¥å“åº”

**ç‰©å“ä¸å­˜åœ¨**:
```json
{
  "success": false,
  "error": "NOT_FOUND",
  "message": "åº“å­˜ç‰©å“ä¸å­˜åœ¨",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

**æ— æƒé™æŸ¥çœ‹**:
```json
{
  "success": false,
  "error": "FORBIDDEN",
  "message": "æ‚¨æ²¡æœ‰æƒé™æŸ¥çœ‹æ­¤ç‰©å“",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

#### å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹

```javascript
// pages/inventory-detail/inventory-detail.js - ç‰©å“è¯¦æƒ…é¡µ

Page({
  data: {
    item: null,
    itemId: 0
  },
  
  onLoad(options) {
    this.setData({
      itemId: options.id
    });
    this.loadItemDetail();
  },
  
  async loadItemDetail() {
    try {
      wx.showLoading({ title: 'åŠ è½½ä¸­...' });
      
      const res = await wx.request({
        url: `https://omqktqrtntnn.sealosbja.site/api/v4/inventory/item/${this.data.itemId}`,
        method: 'GET',
        header: {
          'Authorization': 'Bearer ' + wx.getStorageSync('access_token')
        }
      });
      
      wx.hideLoading();
      
      if (res.data.success) {
        this.setData({
          item: res.data.data
        });
      } else {
        wx.showModal({
          title: 'åŠ è½½å¤±è´¥',
          content: res.data.message || 'æ— æ³•åŠ è½½ç‰©å“è¯¦æƒ…',
          showCancel: false,
          success: () => {
            wx.navigateBack();
          }
        });
      }
    } catch (error) {
      wx.hideLoading();
      wx.showToast({
        title: 'ç½‘ç»œè¯·æ±‚å¤±è´¥',
        icon: 'none'
      });
    }
  },
  
  // ä½¿ç”¨ç‰©å“
  handleUse() {
    const item = this.data.item;
    
    if (item.status !== 'unused') {
      wx.showToast({
        title: 'è¯¥ç‰©å“å·²ä½¿ç”¨æˆ–å·²è¿‡æœŸ',
        icon: 'none'
      });
      return;
    }
    
    wx.showModal({
      title: 'ç¡®è®¤ä½¿ç”¨',
      content: item.usage_instructions || 'ç¡®å®šä½¿ç”¨è¯¥ç‰©å“å—?',
      success: async (res) => {
        if (res.confirm) {
          // è°ƒç”¨ä½¿ç”¨API
          this.useItem();
        }
      }
    });
  },
  
  async useItem() {
    try {
      wx.showLoading({ title: 'ä½¿ç”¨ä¸­...' });
      
      const res = await wx.request({
        url: `https://omqktqrtntnn.sealosbja.site/api/v4/inventory/use/${this.data.itemId}`,
        method: 'POST',
        header: {
          'Authorization': 'Bearer ' + wx.getStorageSync('access_token')
        }
      });
      
      wx.hideLoading();
      
      if (res.data.success) {
        wx.showToast({
          title: 'ä½¿ç”¨æˆåŠŸ',
          icon: 'success'
        });
        
        // é‡æ–°åŠ è½½è¯¦æƒ…
        setTimeout(() => {
          this.loadItemDetail();
        }, 1500);
      } else {
        wx.showToast({
          title: res.data.message || 'ä½¿ç”¨å¤±è´¥',
          icon: 'none'
        });
      }
    } catch (error) {
      wx.hideLoading();
      wx.showToast({
        title: 'ç½‘ç»œè¯·æ±‚å¤±è´¥',
        icon: 'none'
      });
    }
  },
  
  // ç”Ÿæˆæ ¸é”€ç 
  async generateCode() {
    const item = this.data.item;
    
    if (item.verification_code) {
      wx.showToast({
        title: 'æ ¸é”€ç å·²å­˜åœ¨',
        icon: 'none'
      });
      return;
    }
    
    try {
      wx.showLoading({ title: 'ç”Ÿæˆä¸­...' });
      
      const res = await wx.request({
        url: `https://omqktqrtntnn.sealosbja.site/api/v4/inventory/generate-code/${this.data.itemId}`,
        method: 'POST',
        header: {
          'Authorization': 'Bearer ' + wx.getStorageSync('access_token')
        }
      });
      
      wx.hideLoading();
      
      if (res.data.success) {
        wx.showModal({
          title: 'æ ¸é”€ç å·²ç”Ÿæˆ',
          content: `æ ¸é”€ç : ${res.data.data.verification_code}\n\nè¯·åˆ°æŒ‡å®šåœ°ç‚¹å‡ºç¤ºæ­¤æ ¸é”€ç é¢†å–å¥–å“`,
          showCancel: false
        });
        
        // é‡æ–°åŠ è½½è¯¦æƒ…
        this.loadItemDetail();
      } else {
        wx.showToast({
          title: res.data.message || 'ç”Ÿæˆå¤±è´¥',
          icon: 'none'
        });
      }
    } catch (error) {
      wx.hideLoading();
      wx.showToast({
        title: 'ç½‘ç»œè¯·æ±‚å¤±è´¥',
        icon: 'none'
      });
    }
  },
  
  // è½¬ç§»ç‰©å“
  handleTransfer() {
    wx.navigateTo({
      url: `/pages/transfer-item/transfer-item?itemId=${this.data.itemId}`
    });
  }
});
```

---

### 4.3 ä½¿ç”¨åº“å­˜ç‰©å“

**APIè·¯å¾„**: `POST /api/v4/inventory/use/:item_id`

**åŠŸèƒ½è¯´æ˜**:
- ä½¿ç”¨åº“å­˜ä¸­çš„ç‰©å“
- **ç§¯åˆ†ç±»ç‰©å“**: è‡ªåŠ¨å‘æ”¾ç§¯åˆ†åˆ°ç”¨æˆ·è´¦æˆ·
- **å®ç‰©ç±»ç‰©å“**: æ ‡è®°ä¸ºå·²ä½¿ç”¨,éœ€æ ¸é”€ç åˆ°æŒ‡å®šåœ°ç‚¹é¢†å–
- **è™šæ‹Ÿç±»ç‰©å“**: æ ‡è®°ä¸ºå·²ä½¿ç”¨
- **å¯é€‰æ ¸é”€ç éªŒè¯**: å®ç‰©ç±»ç‰©å“å¯è¦æ±‚æ ¸é”€ç éªŒè¯åä½¿ç”¨
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/inventory.js` - useInventoryItemç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**è·¯å¾„å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `item_id` | number | åº“å­˜ç‰©å“ID |

**è¯·æ±‚ä½“**:
```json
{
  "verification_code": "ABC123456"             // å¯é€‰,æ ¸é”€ç (å®ç‰©ç±»ç‰©å“éœ€è¦)
}
```

#### æˆåŠŸå“åº”(ç§¯åˆ†ç±»ç‰©å“)

```json
{
  "success": true,
  "message": "ç‰©å“ä½¿ç”¨æˆåŠŸ,500ç§¯åˆ†å·²å‘æ”¾åˆ°è´¦æˆ·",
  "data": {
    "item_id": 5678,
    "status": "used",
    "used_at": "2025-01-21T20:35:00.000+08:00",
    "prize_type": "points",
    "points_awarded": 500,                       // è·å¾—çš„ç§¯åˆ†
    "new_balance": 990                           // ä½¿ç”¨åçš„ç§¯åˆ†ä½™é¢
  }
}
```

#### æˆåŠŸå“åº”(å®ç‰©ç±»ç‰©å“)

```json
{
  "success": true,
  "message": "ç‰©å“å·²æ ‡è®°ä¸ºä½¿ç”¨,è¯·åˆ°æŒ‡å®šåœ°ç‚¹é¢†å–",
  "data": {
    "item_id": 5677,
    "status": "used",
    "used_at": "2025-01-21T20:35:00.000+08:00",
    "prize_type": "physical",
    "verification_code": "ABC123456",            // æ ¸é”€ç 
    "pickup_location": "XXé¤å…å‰å°"              // é¢†å–åœ°ç‚¹
  }
}
```

#### å¤±è´¥å“åº”

**ç‰©å“å·²ä½¿ç”¨**:
```json
{
  "success": false,
  "error": "ITEM_ALREADY_USED",
  "message": "è¯¥ç‰©å“å·²ä½¿ç”¨",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

**æ ¸é”€ç é”™è¯¯**:
```json
{
  "success": false,
  "error": "INVALID_VERIFICATION_CODE",
  "message": "æ ¸é”€ç é”™è¯¯æˆ–å·²å¤±æ•ˆ",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

**ç‰©å“å·²è¿‡æœŸ**:
```json
{
  "success": false,
  "error": "ITEM_EXPIRED",
  "message": "è¯¥ç‰©å“å·²è¿‡æœŸ,æ— æ³•ä½¿ç”¨",
  "data": {
    "expired_at": "2025-01-15T23:59:59.999+08:00"
  },
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

---

### 4.4 æŸ¥è¯¢å¯å…‘æ¢å•†å“åˆ—è¡¨

**APIè·¯å¾„**: `GET /api/v4/inventory/products`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢å¯ç”¨ç§¯åˆ†å…‘æ¢çš„å•†å“åˆ—è¡¨
- **è‡ªåŠ¨æ•°æ®è„±æ•**: æ™®é€šç”¨æˆ·çœ‹ä¸åˆ°æˆæœ¬ä»·ã€åº“å­˜ç­‰æ•æ„Ÿä¿¡æ¯
- **æ”¯æŒåˆ†é¡µ**
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/inventory.js` - getExchangeProductsç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|-------|------|
| `page` | number | 1 | é¡µç  |
| `limit` | number | 20 | æ¯é¡µæ¡æ•° |
| `category` | string | - | å¯é€‰,å•†å“åˆ†ç±»ç­›é€‰ |
| `min_points` | number | - | å¯é€‰,æœ€ä½ç§¯åˆ†ç­›é€‰ |
| `max_points` | number | - | å¯é€‰,æœ€é«˜ç§¯åˆ†ç­›é€‰ |

**ç¤ºä¾‹**: `/api/v4/inventory/products?page=1&limit=20&min_points=100&max_points=1000`

#### æˆåŠŸå“åº”(æ™®é€šç”¨æˆ· - è„±æ•æ•°æ®)

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 201,                               // å•†å“ID
        "name": "ç²¾ç¾æŠ±æ•",                      // å•†å“åç§°
        "description": "è¶…æŸ”è½¯èˆ’é€‚æŠ±æ•,å¤šç§å›¾æ¡ˆå¯é€‰",
        "type": "physical",                      // ç±»å‹: physical/virtual
        "points_required": 200,                  // æ‰€éœ€ç§¯åˆ†
        "value": "89",                           // å•†å“ä»·å€¼(å…ƒ)
        "image_url": "https://sealos.../product201.jpg",
        "category": "ç”Ÿæ´»ç”¨å“",                  // å•†å“åˆ†ç±»
        "available": true,                       // æ˜¯å¦å¯å…‘æ¢
        "exchange_count": 156                    // å·²å…‘æ¢æ¬¡æ•°
        // âŒ æ™®é€šç”¨æˆ·çœ‹ä¸åˆ°: stock(åº“å­˜), cost_price(æˆæœ¬ä»·)
      },
      {
        "id": 202,
        "name": "200ç§¯åˆ†å……å€¼å¡",
        "description": "å¯ç›´æ¥å……å€¼åˆ°è´¦æˆ·",
        "type": "virtual",
        "points_required": 180,
        "value": "180",
        "image_url": "https://sealos.../product202.jpg",
        "category": "è™šæ‹Ÿå•†å“",
        "available": true,
        "exchange_count": 523
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 45,
      "total_pages": 3,
      "has_next": true,
      "has_prev": false
    },
    "categories": [                              // å¯ç”¨çš„å•†å“åˆ†ç±»
      "ç”Ÿæ´»ç”¨å“",
      "è™šæ‹Ÿå•†å“",
      "ç¾é£Ÿä¼˜æƒ åˆ¸",
      "ç”µå­äº§å“"
    ]
  }
}
```

#### å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹

```javascript
// pages/exchange-products/exchange-products.js - å•†å“å…‘æ¢é¡µ

Page({
  data: {
    products: [],
    categories: [],
    selectedCategory: 'all',
    page: 1,
    limit: 20,
    hasMore: true,
    isLoading: false,
    currentPoints: 0
  },
  
  onLoad() {
    this.loadCurrentPoints();
    this.loadProducts();
  },
  
  // åŠ è½½å½“å‰ç”¨æˆ·ç§¯åˆ†
  async loadCurrentPoints() {
    try {
      const res = await wx.request({
        url: 'https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/points/balance',
        method: 'GET',
        header: {
          'Authorization': 'Bearer ' + wx.getStorageSync('access_token')
        }
      });
      
      if (res.data.success) {
        this.setData({
          currentPoints: res.data.data.current_points
        });
      }
    } catch (error) {
      console.error('åŠ è½½ç§¯åˆ†å¤±è´¥:', error);
    }
  },
  
  // åŠ è½½å•†å“åˆ—è¡¨
  async loadProducts(isLoadMore = false) {
    if (this.data.isLoading) return;
    
    try {
      this.setData({ isLoading: true });
      
      const page = isLoadMore ? this.data.page + 1 : 1;
      
      // æ„å»ºæŸ¥è¯¢å‚æ•°
      let queryParams = `page=${page}&limit=${this.data.limit}`;
      if (this.data.selectedCategory !== 'all') {
        queryParams += `&category=${encodeURIComponent(this.data.selectedCategory)}`;
      }
      
      const res = await wx.request({
        url: `https://omqktqrtntnn.sealosbja.site/api/v4/inventory/products?${queryParams}`,
        method: 'GET',
        header: {
          'Authorization': 'Bearer ' + wx.getStorageSync('access_token')
        }
      });
      
      if (res.data.success) {
        const items = res.data.data.items;
        const pagination = res.data.data.pagination;
        
        this.setData({
          products: isLoadMore ? [...this.data.products, ...items] : items,
          categories: res.data.data.categories || [],
          page: page,
          hasMore: pagination.has_next,
          isLoading: false
        });
      } else {
        this.setData({ isLoading: false });
      }
    } catch (error) {
      this.setData({ isLoading: false });
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      });
    }
  },
  
  // åˆ‡æ¢åˆ†ç±»
  onCategoryChange(e) {
    this.setData({
      selectedCategory: e.detail.value,
      page: 1
    });
    this.loadProducts();
  },
  
  // å…‘æ¢å•†å“
  async exchangeProduct(e) {
    const product = e.currentTarget.dataset.product;
    
    // æ£€æŸ¥ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
    if (this.data.currentPoints < product.points_required) {
      wx.showModal({
        title: 'ç§¯åˆ†ä¸è¶³',
        content: `å½“å‰ç§¯åˆ†: ${this.data.currentPoints}\néœ€è¦ç§¯åˆ†: ${product.points_required}`,
        showCancel: false
      });
      return;
    }
    
    // ç¡®è®¤å…‘æ¢
    wx.showModal({
      title: 'ç¡®è®¤å…‘æ¢',
      content: `å…‘æ¢ ${product.name}\næ¶ˆè€—ç§¯åˆ†: ${product.points_required}`,
      success: async (modalRes) => {
        if (modalRes.confirm) {
          try {
            wx.showLoading({ title: 'å…‘æ¢ä¸­...' });
            
            const res = await wx.request({
              url: 'https://omqktqrtntnn.sealosbja.site/api/v4/inventory/exchange',
              method: 'POST',
              header: {
                'Authorization': 'Bearer ' + wx.getStorageSync('access_token'),
                'Content-Type': 'application/json'
              },
              data: {
                product_id: product.id,
                quantity: 1
              }
            });
            
            wx.hideLoading();
            
            if (res.data.success) {
              wx.showModal({
                title: 'å…‘æ¢æˆåŠŸ',
                content: 'å•†å“å·²æ·»åŠ åˆ°æ‚¨çš„åº“å­˜',
                confirmText: 'æŸ¥çœ‹åº“å­˜',
                cancelText: 'ç»§ç»­å…‘æ¢',
                success: (confirmRes) => {
                  if (confirmRes.confirm) {
                    wx.switchTab({
                      url: '/pages/inventory/inventory'
                    });
                  } else {
                    // åˆ·æ–°å½“å‰é¡µ
                    this.loadCurrentPoints();
                    this.loadProducts();
                  }
                }
              });
            } else {
              wx.showToast({
                title: res.data.message || 'å…‘æ¢å¤±è´¥',
                icon: 'none'
              });
            }
          } catch (error) {
            wx.hideLoading();
            wx.showToast({
              title: 'ç½‘ç»œè¯·æ±‚å¤±è´¥',
              icon: 'none'
            });
          }
        }
      }
    });
  },
  
  // ä¸Šæ‹‰åŠ è½½æ›´å¤š
  onReachBottom() {
    if (this.data.hasMore && !this.data.isLoading) {
      this.loadProducts(true);
    }
  }
});
```

```xml
<!-- pages/exchange-products/exchange-products.wxml -->
<view class="exchange-page">
  <!-- ç§¯åˆ†ä½™é¢å¡ç‰‡ -->
  <view class="points-card">
    <text class="label">å½“å‰ç§¯åˆ†</text>
    <text class="points">{{currentPoints}}</text>
  </view>
  
  <!-- åˆ†ç±»ç­›é€‰ -->
  <view class="category-tabs">
    <scroll-view scroll-x="true">
      <view class="tab-item {{selectedCategory === 'all' ? 'active' : ''}}" 
            bindtap="onCategoryChange" 
            data-value="all">
        å…¨éƒ¨
      </view>
      <view 
        class="tab-item {{selectedCategory === item ? 'active' : ''}}" 
        wx:for="{{categories}}" 
        wx:key="*this"
        bindtap="onCategoryChange"
        data-value="{{item}}"
      >
        {{item}}
      </view>
    </scroll-view>
  </view>
  
  <!-- å•†å“åˆ—è¡¨ -->
  <view class="products-grid">
    <view class="product-item" wx:for="{{products}}" wx:key="id">
      <image class="product-image" src="{{item.image_url}}" mode="aspectFill"></image>
      <view class="product-info">
        <text class="product-name">{{item.name}}</text>
        <text class="product-desc">{{item.description}}</text>
        <view class="product-footer">
          <view class="points-tag">
            <text class="points-icon">ğŸ’°</text>
            <text class="points-text">{{item.points_required}}ç§¯åˆ†</text>
          </view>
          <button 
            class="exchange-btn {{currentPoints < item.points_required ? 'disabled' : ''}}" 
            size="mini"
            bindtap="exchangeProduct"
            data-product="{{item}}"
            disabled="{{currentPoints < item.points_required}}"
          >
            {{currentPoints >= item.points_required ? 'å…‘æ¢' : 'ç§¯åˆ†ä¸è¶³'}}
          </button>
        </view>
      </view>
    </view>
  </view>
  
  <!-- ç©ºçŠ¶æ€ -->
  <view wx:if="{{!isLoading && products.length === 0}}" class="empty-state">
    <text>æš‚æ— å¯å…‘æ¢å•†å“</text>
  </view>
</view>
```

---

### 4.5 å…‘æ¢å•†å“

**APIè·¯å¾„**: `POST /api/v4/inventory/exchange`

**åŠŸèƒ½è¯´æ˜**:
- ä½¿ç”¨ç§¯åˆ†å…‘æ¢å•†å“
- **äº‹åŠ¡å¤„ç†**: æ‰£é™¤ç§¯åˆ†ã€å‡å°‘åº“å­˜ã€åˆ›å»ºåº“å­˜è®°å½•(åŸå­æ“ä½œ)
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/inventory.js` - exchangeProductç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

```json
{
  "product_id": 201,                           // å¿…å¡«, å•†å“ID
  "quantity": 1                                // å¿…å¡«, å…‘æ¢æ•°é‡(1-10)
}
```

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "å…‘æ¢æˆåŠŸ",
  "data": {
    "exchange_record_id": 8001,                // å…‘æ¢è®°å½•ID
    "product_id": 201,
    "product_name": "ç²¾ç¾æŠ±æ•",
    "quantity": 1,
    "total_points": 200,                       // æ¶ˆè€—ç§¯åˆ†æ€»æ•°
    "remaining_points": 790,                   // å‰©ä½™ç§¯åˆ†
    "inventory_items": [                       // åˆ›å»ºçš„åº“å­˜è®°å½•
      {
        "id": 5680,
        "prize_name": "ç²¾ç¾æŠ±æ•",
        "status": "unused"
      }
    ],
    "created_at": "2025-01-21T20:35:00.000+08:00"
  }
}
```

#### å¤±è´¥å“åº”

**ç§¯åˆ†ä¸è¶³**:
```json
{
  "success": false,
  "error": "INSUFFICIENT_POINTS",
  "message": "ç§¯åˆ†ä¸è¶³,å½“å‰ç§¯åˆ†: 150, éœ€è¦: 200",
  "data": {
    "current_points": 150,
    "required_points": 200,
    "deficit": 50
  },
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

**å•†å“åº“å­˜ä¸è¶³**:
```json
{
  "success": false,
  "error": "INSUFFICIENT_STOCK",
  "message": "å•†å“åº“å­˜ä¸è¶³",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

---

### 4.6 æŸ¥è¯¢å…‘æ¢è®°å½•

**APIè·¯å¾„**: `GET /api/v4/inventory/exchange-records`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢ç”¨æˆ·çš„å•†å“å…‘æ¢è®°å½•
- **æ”¯æŒåˆ†é¡µ**
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/inventory.js` - getExchangeRecordsç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|-------|------|
| `page` | number | 1 | é¡µç  |
| `limit` | number | 20 | æ¯é¡µæ¡æ•° |
| `status` | string | - | å¯é€‰,ç­›é€‰çŠ¶æ€: pending/completed/cancelled |

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 8001,
        "product_id": 201,
        "product_name": "ç²¾ç¾æŠ±æ•",
        "quantity": 1,
        "total_points": 200,
        "status": "completed",                   // çŠ¶æ€: pending/completed/cancelled
        "status_text": "å·²å®Œæˆ",
        "inventory_item_id": 5680,               // å…³è”çš„åº“å­˜è®°å½•ID
        "created_at": "2025-01-21T20:35:00.000+08:00",
        "completed_at": "2025-01-21T20:35:00.000+08:00"
      },
      {
        "id": 8000,
        "product_id": 202,
        "product_name": "200ç§¯åˆ†å……å€¼å¡",
        "quantity": 1,
        "total_points": 180,
        "status": "pending",
        "status_text": "å¾…å¤„ç†",
        "inventory_item_id": null,
        "created_at": "2025-01-21T20:30:00.000+08:00",
        "completed_at": null
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 23,
      "total_pages": 2,
      "has_next": true,
      "has_prev": false
    },
    "summary": {
      "total_exchanges": 23,                     // æ€»å…‘æ¢æ¬¡æ•°
      "total_points_spent": 4600,                // æ€»æ¶ˆè€—ç§¯åˆ†
      "pending_count": 2,                        // å¾…å¤„ç†è®¢å•æ•°
      "completed_count": 20,                     // å·²å®Œæˆè®¢å•æ•°
      "cancelled_count": 1                       // å·²å–æ¶ˆè®¢å•æ•°
    }
  }
}
```

---

### 4.7 ç”Ÿæˆæ ¸é”€ç 

**APIè·¯å¾„**: `POST /api/v4/inventory/generate-code/:item_id`

**åŠŸèƒ½è¯´æ˜**:
- ä¸ºå®ç‰©ç±»åº“å­˜ç‰©å“ç”Ÿæˆæ ¸é”€ç 
- **æ ¸é”€ç å”¯ä¸€**: æ¯ä¸ªç‰©å“åªèƒ½ç”Ÿæˆä¸€æ¬¡æ ¸é”€ç 
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/inventory.js` - generateVerificationCodeç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**è·¯å¾„å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `item_id` | number | åº“å­˜ç‰©å“ID |

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "æ ¸é”€ç å·²ç”Ÿæˆ",
  "data": {
    "item_id": 5677,
    "verification_code": "ABC123456",          // æ ¸é”€ç (8ä½å¤§å†™å­—æ¯+æ•°å­—)
    "expires_at": "2025-06-30T23:59:59.999+08:00",  // æ ¸é”€ç è¿‡æœŸæ—¶é—´
    "pickup_location": "XXé¤å…å‰å°",           // é¢†å–åœ°ç‚¹
    "pickup_hours": "10:00-22:00",             // é¢†å–æ—¶é—´
    "pickup_instructions": "è¯·æºå¸¦æœ¬äººèº«ä»½è¯åˆ°å‰å°å‡ºç¤ºæ ¸é”€ç é¢†å–"  // é¢†å–è¯´æ˜
  }
}
```

#### å¤±è´¥å“åº”

**æ ¸é”€ç å·²å­˜åœ¨**:
```json
{
  "success": false,
  "error": "CODE_ALREADY_EXISTS",
  "message": "è¯¥ç‰©å“å·²ç”Ÿæˆæ ¸é”€ç ",
  "data": {
    "existing_code": "ABC123456"
  },
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

---

### 4.8 å–æ¶ˆå…‘æ¢è®¢å•

**APIè·¯å¾„**: `POST /api/v4/inventory/exchange-records/:id/cancel`

**åŠŸèƒ½è¯´æ˜**:
- å–æ¶ˆå¾…å¤„ç†çš„å…‘æ¢è®¢å•
- **é€€è¿˜ç§¯åˆ†**: è‡ªåŠ¨é€€è¿˜æ¶ˆè€—çš„ç§¯åˆ†
- **æ¢å¤åº“å­˜**: è‡ªåŠ¨æ¢å¤å•†å“åº“å­˜
- **ä»…é™å¾…å¤„ç†è®¢å•**: å·²å®Œæˆçš„è®¢å•æ— æ³•å–æ¶ˆ
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/inventory.js` - cancelExchangeRecordç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**è·¯å¾„å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `id` | number | å…‘æ¢è®°å½•ID |

**è¯·æ±‚ä½“**:
```json
{
  "reason": "ä¸éœ€è¦äº†"                         // å¯é€‰, å–æ¶ˆåŸå› 
}
```

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "è®¢å•å·²å–æ¶ˆ,ç§¯åˆ†å·²é€€è¿˜",
  "data": {
    "exchange_record_id": 8000,
    "refunded_points": 180,                    // é€€è¿˜çš„ç§¯åˆ†
    "new_balance": 970,                        // é€€è¿˜åçš„ç§¯åˆ†ä½™é¢
    "cancelled_at": "2025-01-21T20:35:00.000+08:00"
  }
}
```

#### å¤±è´¥å“åº”

**è®¢å•å·²å®Œæˆ,æ— æ³•å–æ¶ˆ**:
```json
{
  "success": false,
  "error": "CANNOT_CANCEL_COMPLETED",
  "message": "è®¢å•å·²å®Œæˆ,æ— æ³•å–æ¶ˆ",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

---

### 4.9 è½¬ç§»ç‰©å“ç»™å…¶ä»–ç”¨æˆ·

**APIè·¯å¾„**: `POST /api/v4/inventory/transfer`

**åŠŸèƒ½è¯´æ˜**:
- å°†åº“å­˜ç‰©å“è½¬ç§»ç»™å…¶ä»–ç”¨æˆ·
- **è½¬ç§»é™åˆ¶**: æ¯ä¸ªç‰©å“æœ€å¤šè½¬ç§»3æ¬¡
- **äº‹åŠ¡è®°å½•**: è‡ªåŠ¨è®°å½•è½¬ç§»å†å²,å¯è¿½æº¯
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/inventory.js` - transferInventoryItemç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

```json
{
  "item_id": 5678,                             // å¿…å¡«, åº“å­˜ç‰©å“ID
  "to_user_id": 456,                           // å¿…å¡«, æ¥æ”¶ç”¨æˆ·ID
  "message": "é€ä½ ä¸ªç¤¼ç‰©"                      // å¯é€‰, è½¬ç§»ç•™è¨€
}
```

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "ç‰©å“è½¬ç§»æˆåŠŸ",
  "data": {
    "transfer_id": 9001,                       // è½¬ç§»è®°å½•ID
    "item_id": 5678,
    "from_user_id": 123,
    "to_user_id": 456,
    "prize_name": "ä¸€ç­‰å¥– - 500ç§¯åˆ†",
    "message": "é€ä½ ä¸ªç¤¼ç‰©",
    "transfer_count": 1,                       // è¯¥ç‰©å“çš„è½¬ç§»æ¬¡æ•°
    "max_transfers": 3,                        // æœ€å¤§è½¬ç§»æ¬¡æ•°
    "created_at": "2025-01-21T20:35:00.000+08:00"
  }
}
```

#### å¤±è´¥å“åº”

**è¶…è¿‡è½¬ç§»æ¬¡æ•°é™åˆ¶**:
```json
{
  "success": false,
  "error": "TRANSFER_LIMIT_EXCEEDED",
  "message": "è¯¥ç‰©å“å·²è¾¾æœ€å¤§è½¬ç§»æ¬¡æ•°(3æ¬¡)",
  "data": {
    "current_transfers": 3,
    "max_transfers": 3
  },
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

**ç‰©å“å·²ä½¿ç”¨,æ— æ³•è½¬ç§»**:
```json
{
  "success": false,
  "error": "ITEM_USED",
  "message": "å·²ä½¿ç”¨çš„ç‰©å“æ— æ³•è½¬ç§»",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

**æ¥æ”¶ç”¨æˆ·ä¸å­˜åœ¨**:
```json
{
  "success": false,
  "error": "USER_NOT_FOUND",
  "message": "æ¥æ”¶ç”¨æˆ·ä¸å­˜åœ¨",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

#### å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹

```javascript
// pages/transfer-item/transfer-item.js - ç‰©å“è½¬ç§»é¡µ

Page({
  data: {
    itemId: 0,
    toUserId: '',
    message: ''
  },
  
  onLoad(options) {
    this.setData({
      itemId: options.itemId
    });
  },
  
  onUserIdInput(e) {
    this.setData({
      toUserId: e.detail.value
    });
  },
  
  onMessageInput(e) {
    this.setData({
      message: e.detail.value
    });
  },
  
  async handleTransfer() {
    const { itemId, toUserId, message } = this.data;
    
    // éªŒè¯è¾“å…¥
    if (!toUserId) {
      wx.showToast({
        title: 'è¯·è¾“å…¥æ¥æ”¶ç”¨æˆ·ID',
        icon: 'none'
      });
      return;
    }
    
    // ç¡®è®¤è½¬ç§»
    wx.showModal({
      title: 'ç¡®è®¤è½¬ç§»',
      content: `ç¡®å®šå°†ç‰©å“è½¬ç§»ç»™ç”¨æˆ·${toUserId}å—?\nè½¬ç§»åæ— æ³•æ’¤å›`,
      success: async (res) => {
        if (res.confirm) {
          try {
            wx.showLoading({ title: 'è½¬ç§»ä¸­...' });
            
            const res = await wx.request({
              url: 'https://omqktqrtntnn.sealosbja.site/api/v4/inventory/transfer',
              method: 'POST',
              header: {
                'Authorization': 'Bearer ' + wx.getStorageSync('access_token'),
                'Content-Type': 'application/json'
              },
              data: {
                item_id: parseInt(itemId),
                to_user_id: parseInt(toUserId),
                message: message
              }
            });
            
            wx.hideLoading();
            
            if (res.data.success) {
              wx.showModal({
                title: 'è½¬ç§»æˆåŠŸ',
                content: 'ç‰©å“å·²æˆåŠŸè½¬ç§»',
                showCancel: false,
                success: () => {
                  wx.navigateBack();
                }
              });
            } else {
              wx.showToast({
                title: res.data.message || 'è½¬ç§»å¤±è´¥',
                icon: 'none'
              });
            }
          } catch (error) {
            wx.hideLoading();
            wx.showToast({
              title: 'ç½‘ç»œè¯·æ±‚å¤±è´¥',
              icon: 'none'
            });
          }
        }
      }
    });
  }
});
```

---

### 4.10 æŸ¥è¯¢è½¬ç§»å†å²

**APIè·¯å¾„**: `GET /api/v4/inventory/transfer-history`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢ç”¨æˆ·çš„ç‰©å“è½¬ç§»å†å²
- **åŒ…å«å‘å‡ºå’Œæ”¶åˆ°çš„è½¬ç§»è®°å½•**
- **æ”¯æŒåˆ†é¡µ**
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/inventory.js` - getTransferHistoryç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|-------|------|
| `page` | number | 1 | é¡µç  |
| `limit` | number | 20 | æ¯é¡µæ¡æ•° |
| `direction` | string | `all` | ç­›é€‰æ–¹å‘: sent(å‘å‡º)/received(æ”¶åˆ°)/all(å…¨éƒ¨) |

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 9001,
        "item_id": 5678,
        "prize_name": "ä¸€ç­‰å¥– - 500ç§¯åˆ†",
        "from_user_id": 123,
        "from_user_nickname": "ç”¨æˆ·A",
        "to_user_id": 456,
        "to_user_nickname": "ç”¨æˆ·B",
        "direction": "sent",                     // sent=å‘å‡º, received=æ”¶åˆ°
        "message": "é€ä½ ä¸ªç¤¼ç‰©",
        "created_at": "2025-01-21T20:35:00.000+08:00"
      },
      {
        "id": 9000,
        "item_id": 5670,
        "prize_name": "ç‰¹ç­‰å¥– - iPhone 15",
        "from_user_id": 789,
        "from_user_nickname": "ç”¨æˆ·C",
        "to_user_id": 123,
        "to_user_nickname": "ç”¨æˆ·A",
        "direction": "received",
        "message": "æ­å–œä½ ",
        "created_at": "2025-01-20T18:20:00.000+08:00"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 12,
      "total_pages": 1,
      "has_next": false,
      "has_prev": false
    },
    "summary": {
      "sent_count": 5,                           // å‘å‡ºè½¬ç§»æ•°
      "received_count": 7,                       // æ”¶åˆ°è½¬ç§»æ•°
      "total_count": 12                          // æ€»è½¬ç§»æ•°
    }
  }
}
```

---

### 4.11 æ ¸é”€ç‰©å“(ä½¿ç”¨æ ¸é”€ç )

**APIè·¯å¾„**: `POST /api/v4/inventory/verification/verify`

**åŠŸèƒ½è¯´æ˜**:
- å•†å®¶ç«¯ä½¿ç”¨æ ¸é”€ç éªŒè¯å’Œä½¿ç”¨ç‰©å“
- **éœ€è¦ç®¡ç†å‘˜æƒé™**
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/inventory.js` - verifyAndUseItemç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

```json
{
  "verification_code": "ABC123456"             // å¿…å¡«, æ ¸é”€ç 
}
```

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "æ ¸é”€æˆåŠŸ",
  "data": {
    "item_id": 5677,
    "prize_name": "ç‰¹ç­‰å¥– - iPhone 15 Pro Max",
    "user_id": 123,
    "user_mobile": "138****8000",
    "verification_code": "ABC123456",
    "verified_at": "2025-01-21T20:35:00.000+08:00",
    "verified_by": 1                             // æ ¸é”€æ“ä½œå‘˜ID
  }
}
```

#### å¤±è´¥å“åº”

**æ ¸é”€ç æ— æ•ˆ**:
```json
{
  "success": false,
  "error": "INVALID_CODE",
  "message": "æ ¸é”€ç æ— æ•ˆæˆ–å·²ä½¿ç”¨",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

---

### 4.12 æŸ¥è¯¢å¸‚åœºå•†å“åˆ—è¡¨

**APIè·¯å¾„**: `GET /api/v4/inventory/market/products`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢ç”¨æˆ·ä¸Šæ¶åˆ°å¸‚åœºçš„äºŒæ‰‹ç‰©å“
- **æ•°æ®è„±æ•**: å–å®¶æ‰‹æœºå·è„±æ•
- **æ”¯æŒåˆ†é¡µå’Œç­›é€‰**
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/inventory.js` - getMarketProductsç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|-------|------|
| `page` | number | 1 | é¡µç  |
| `limit` | number | 20 | æ¯é¡µæ¡æ•° |
| `min_price` | number | - | å¯é€‰,æœ€ä½ä»·æ ¼(ç§¯åˆ†) |
| `max_price` | number | - | å¯é€‰,æœ€é«˜ä»·æ ¼(ç§¯åˆ†) |

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 10001,                             // å¸‚åœºå•†å“ID
        "inventory_item_id": 5678,               // åŸåº“å­˜ç‰©å“ID
        "prize_name": "ä¸€ç­‰å¥– - 500ç§¯åˆ†",
        "prize_type": "points",
        "prize_value": "500",
        "image_url": "https://sealos.../prize102.jpg",
        "seller_id": 456,
        "seller_nickname": "ç”¨æˆ·B",
        "seller_mobile": "139****5678",          // è„±æ•æ‰‹æœºå·
        "price": 450,                            // å”®ä»·(ç§¯åˆ†)
        "original_price": 500,                   // åŸä»·
        "discount": "90%",                       // æŠ˜æ‰£ç‡
        "description": "ä¾¿å®œå‡ºå”®,éœ€è¦çš„è”ç³»",     // å–å®¶æè¿°
        "status": "active",                      // çŠ¶æ€: active/sold/withdrawn
        "listed_at": "2025-01-21T10:00:00.000+08:00"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 67,
      "total_pages": 4,
      "has_next": true,
      "has_prev": false
    }
  }
}
```

---

### 4.13 è´­ä¹°å¸‚åœºå•†å“

**APIè·¯å¾„**: `POST /api/v4/inventory/market/products/:id/purchase`

**åŠŸèƒ½è¯´æ˜**:
- è´­ä¹°å¸‚åœºä¸Šçš„äºŒæ‰‹ç‰©å“
- **ç§¯åˆ†è½¬ç§»**: ä¹°å®¶ç§¯åˆ†è½¬ç»™å–å®¶(æ‰£é™¤5%å¹³å°æ‰‹ç»­è´¹)
- **ç‰©å“è½¬ç§»**: è‡ªåŠ¨è½¬ç§»ç‰©å“ç»™ä¹°å®¶
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/inventory.js` - purchaseMarketProductç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**è·¯å¾„å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `id` | number | å¸‚åœºå•†å“ID |

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "è´­ä¹°æˆåŠŸ",
  "data": {
    "transaction_id": 11001,
    "market_product_id": 10001,
    "prize_name": "ä¸€ç­‰å¥– - 500ç§¯åˆ†",
    "price": 450,                                // è´­ä¹°ä»·æ ¼
    "platform_fee": 23,                          // å¹³å°æ‰‹ç»­è´¹(5%)
    "seller_received": 427,                      // å–å®¶å®é™…æ”¶åˆ°
    "buyer_paid": 450,                           // ä¹°å®¶æ”¯ä»˜
    "buyer_balance": 540,                        // ä¹°å®¶å‰©ä½™ç§¯åˆ†
    "inventory_item_id": 5678,                   // æ–°çš„åº“å­˜è®°å½•ID
    "purchased_at": "2025-01-21T20:35:00.000+08:00"
  }
}
```

#### å¤±è´¥å“åº”

**ç§¯åˆ†ä¸è¶³**:
```json
{
  "success": false,
  "error": "INSUFFICIENT_POINTS",
  "message": "ç§¯åˆ†ä¸è¶³,å½“å‰ç§¯åˆ†: 400, éœ€è¦: 450",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

**å•†å“å·²å”®å‡º**:
```json
{
  "success": false,
  "error": "PRODUCT_SOLD",
  "message": "è¯¥å•†å“å·²è¢«å…¶ä»–ç”¨æˆ·è´­ä¹°",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

---

## ğŸ’° ç§¯åˆ†ç³»ç»ŸAPI

### 4.14 æŸ¥è¯¢å½“å‰ç”¨æˆ·ç§¯åˆ†ä½™é¢

**APIè·¯å¾„**: `GET /api/v4/unified-engine/points/balance`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢å½“å‰ç™»å½•ç”¨æˆ·çš„ç§¯åˆ†ä½™é¢
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/points.js` - getCurrentUserBalanceç«¯ç‚¹

#### æˆåŠŸå“åº”ï¼ˆâœ… å®é™…ä»£ç éªŒè¯ï¼‰

```json
{
  "success": true,
  "message": "ç§¯åˆ†ä½™é¢æŸ¥è¯¢æˆåŠŸ",
  "data": {
    "user_id": 123,                              // ç”¨æˆ·ID
    "available_points": 990,                     // å½“å‰å¯ç”¨ç§¯åˆ†ï¼ˆæ³¨æ„ï¼šå­—æ®µåä¸ºavailable_pointsï¼Œä¸æ˜¯current_pointsï¼‰
    "total_earned": 5600,                        // ç´¯è®¡è·å¾—ç§¯åˆ†
    "total_consumed": 4610,                      // ç´¯è®¡æ¶ˆè€—ç§¯åˆ†ï¼ˆæ³¨æ„ï¼šå­—æ®µåä¸ºtotal_consumedï¼Œä¸æ˜¯total_spentï¼‰
    "timestamp": "2025-10-22T00:06:10.000+08:00" // æŸ¥è¯¢æ—¶é—´æˆ³ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
  }
}
```

#### å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹

```javascript
// pages/points/points.js - ç§¯åˆ†é¡µé¢

Page({
  data: {
    pointsInfo: null
  },
  
  onLoad() {
    this.loadPointsInfo();
  },
  
  async loadPointsInfo() {
    try {
      wx.showLoading({ title: 'åŠ è½½ä¸­...' });
      
      const res = await wx.request({
        url: 'https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/points/balance',
        method: 'GET',
        header: {
          'Authorization': 'Bearer ' + wx.getStorageSync('access_token')
        }
      });
      
      wx.hideLoading();
      
      if (res.data.success) {
        // æ³¨æ„ï¼šä½¿ç”¨actualä»£ç è¿”å›çš„å­—æ®µå
        const pointsData = res.data.data;
        this.setData({
          pointsInfo: {
            user_id: pointsData.user_id,
            available_points: pointsData.available_points,  // ä¸æ˜¯current_points
            total_earned: pointsData.total_earned,
            total_consumed: pointsData.total_consumed       // ä¸æ˜¯total_spent
          }
        });
      }
    } catch (error) {
      wx.hideLoading();
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      });
    }
  }
});
```

---

### 4.15 æŸ¥è¯¢æŒ‡å®šç”¨æˆ·ç§¯åˆ†ä½™é¢

**APIè·¯å¾„**: `GET /api/v4/unified-engine/points/balance/:user_id`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢æŒ‡å®šç”¨æˆ·çš„ç§¯åˆ†ä½™é¢
- **æƒé™æ§åˆ¶**: ç®¡ç†å‘˜å¯æŸ¥è¯¢ä»»ä½•ç”¨æˆ·,æ™®é€šç”¨æˆ·åªèƒ½æŸ¥è¯¢è‡ªå·±
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/points.js` - getUserBalanceç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**è·¯å¾„å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `user_id` | number | ç”¨æˆ·ID |

#### æˆåŠŸå“åº”

å“åº”æ ¼å¼ä¸ `GET /balance` ç›¸åŒ

---

### 4.16 æŸ¥è¯¢ç§¯åˆ†äº¤æ˜“è®°å½•

**APIè·¯å¾„**: `GET /api/v4/unified-engine/points/transactions/:user_id`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢ç”¨æˆ·çš„ç§¯åˆ†äº¤æ˜“æ˜ç»†
- **æ”¯æŒåˆ†é¡µ**
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/points.js` - getUserTransactionsç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**è·¯å¾„å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `user_id` | number | ç”¨æˆ·ID |

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|-------|------|
| `page` | number | 1 | é¡µç  |
| `limit` | number | 20 | æ¯é¡µæ¡æ•° |
| `type` | string | - | å¯é€‰,ç­›é€‰ç±»å‹: earn(è·å¾—)/spend(æ¶ˆè€—) |

#### æˆåŠŸå“åº”ï¼ˆâœ… å®é™…ä»£ç éªŒè¯ 2025-10-22ï¼‰

```json
{
  "success": true,
  "message": "ç§¯åˆ†äº¤æ˜“è®°å½•æŸ¥è¯¢æˆåŠŸ",
  "data": {
    "user_id": 123,                              // ç”¨æˆ·ID
    "transactions": [                            // æ³¨æ„ï¼šå­—æ®µåä¸ºtransactionsï¼Œä¸æ˜¯items
      {
        "id": 12001,                             // äº¤æ˜“ID
        "user_id": 123,
        "transaction_type": "earn",              // æ³¨æ„ï¼šå­—æ®µåä¸ºtransaction_typeï¼Œä¸æ˜¯type (earn=è·å¾—, consume=æ¶ˆè€—)
        "points_amount": 500,                    // æ³¨æ„ï¼šå­—æ®µåä¸ºpoints_amountï¼Œä¸æ˜¯amount  
        "balance_after": 990,                    // äº¤æ˜“åä½™é¢
        "business_type": "lottery",              // æ³¨æ„ï¼šå­—æ®µåä¸ºbusiness_typeï¼Œä¸æ˜¯source
        "source_text": "æŠ½å¥–è·å¾—",               // æ¥æºæ–‡æœ¬
        "description": "æŠ½å¥–è·å¾—ä¸€ç­‰å¥–500ç§¯åˆ†",   // æè¿°
        "reference_id": 5678,                    // å…³è”è®°å½•ID
        "created_at": "2025-01-21T20:35:00.000+08:00"
      },
      {
        "id": 12000,
        "user_id": 123,
        "transaction_type": "consume",           // consume=æ¶ˆè€—
        "points_amount": 10,                     // æ¶ˆè€—ç§¯åˆ†ï¼ˆæ³¨æ„ï¼šå®é™…ä»£ç å­˜å‚¨ä¸ºæ­£æ•°ï¼‰
        "balance_after": 490,
        "business_type": "lottery",
        "source_text": "æŠ½å¥–æ¶ˆè€—",
        "description": "å‚ä¸LUCKY2025æŠ½å¥–æ¶ˆè€—10ç§¯åˆ†",
        "reference_id": 1001,
        "created_at": "2025-01-21T20:30:00.000+08:00"
      },
      {
        "id": 11999,
        "user_id": 123,
        "transaction_type": "earn",
        "points_amount": 50,
        "balance_after": 500,
        "business_type": "photo_review",
        "source_text": "å›¾ç‰‡å®¡æ ¸é€šè¿‡",
        "description": "ä¸Šä¼ å›¾ç‰‡å®¡æ ¸é€šè¿‡å¥–åŠ±50ç§¯åˆ†",
        "reference_id": 3456,
        "created_at": "2025-01-21T15:20:00.000+08:00"
      }
    ],
    "pagination": {
      "page": 1,                                 // å½“å‰é¡µç 
      "limit": 20,                               // æ¯é¡µæ¡æ•°
      "total": 345,                              // æ€»è®°å½•æ•°
      "pages": 18,                               // æ€»é¡µæ•°ï¼ˆæ³¨æ„ï¼šå­—æ®µåä¸ºpagesï¼Œä¸æ˜¯total_pagesï¼‰
      "has_next": true,                          // æ˜¯å¦æœ‰ä¸‹ä¸€é¡µï¼ˆéœ€å‰ç«¯æ ¹æ®paginationè®¡ç®—ï¼Œæˆ–åç«¯è¿”å›ï¼‰
      "has_prev": false                          // æ˜¯å¦æœ‰ä¸Šä¸€é¡µï¼ˆéœ€å‰ç«¯æ ¹æ®paginationè®¡ç®—ï¼Œæˆ–åç«¯è¿”å›ï¼‰
    },
    "timestamp": "2025-10-22T00:06:10.000+08:00" // æŸ¥è¯¢æ—¶é—´æˆ³
  }
}
```

#### å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹

```javascript
// pages/points-transactions/points-transactions.js - ç§¯åˆ†æ˜ç»†é¡µ

Page({
  data: {
    transactions: [],
    page: 1,
    limit: 20,
    hasMore: true,
    isLoading: false,
    filterType: 'all',                           // all/earn/spend
    summary: null
  },
  
  onLoad() {
    const user_id = wx.getStorageSync('user_info').user_id;
    this.setData({ userId: user_id });
    this.loadTransactions();
  },
  
  async loadTransactions(isLoadMore = false) {
    if (this.data.isLoading) return;
    
    try {
      this.setData({ isLoading: true });
      
      const page = isLoadMore ? this.data.page + 1 : 1;
      
      // æ„å»ºæŸ¥è¯¢å‚æ•°
      let queryParams = `page=${page}&limit=${this.data.limit}`;
      if (this.data.filterType !== 'all') {
        queryParams += `&type=${this.data.filterType}`;
      }
      
      const res = await wx.request({
        url: `https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/points/transactions/${this.data.userId}?${queryParams}`,
        method: 'GET',
        header: {
          'Authorization': 'Bearer ' + wx.getStorageSync('access_token')
        }
      });
      
      if (res.data.success) {
        // æ³¨æ„ï¼šä½¿ç”¨actualä»£ç è¿”å›çš„å­—æ®µå
        const transactions = res.data.data.transactions; // ä¸æ˜¯items
        const pagination = res.data.data.pagination;
        
        this.setData({
          transactions: isLoadMore ? [...this.data.transactions, ...transactions] : transactions,
          page: page,
          hasMore: pagination.page < pagination.pages, // æ ¹æ®pagesè®¡ç®—
          isLoading: false
        });
      } else {
        this.setData({ isLoading: false });
      }
    } catch (error) {
      this.setData({ isLoading: false });
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      });
    }
  },
  
  // åˆ‡æ¢ç­›é€‰ç±»å‹
  onFilterChange(e) {
    this.setData({
      filterType: e.detail.value,
      page: 1
    });
    this.loadTransactions();
  },
  
  // ä¸Šæ‹‰åŠ è½½æ›´å¤š
  onReachBottom() {
    if (this.data.hasMore && !this.data.isLoading) {
      this.loadTransactions(true);
    }
  }
});
```

```xml
<!-- pages/points-transactions/points-transactions.wxml -->
<view class="transactions-page">
  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <view class="summary-card" wx:if="{{summary}}">
    <view class="summary-item">
      <text class="label">æ€»è·å¾—</text>
      <text class="value earn">+{{summary.total_earned}}</text>
    </view>
    <view class="summary-item">
      <text class="label">æ€»æ¶ˆè€—</text>
      <text class="value spend">-{{summary.total_spent}}</text>
    </view>
    <view class="summary-item">
      <text class="label">å½“å‰ä½™é¢</text>
      <text class="value current">{{summary.net_points}}</text>
    </view>
  </view>
  
  <!-- ç­›é€‰æ  -->
  <view class="filter-bar">
    <picker 
      mode="selector" 
      range="{{['å…¨éƒ¨', 'è·å¾—', 'æ¶ˆè€—']}}" 
      value="{{['all','earn','spend'].indexOf(filterType)}}"
      bindchange="onFilterChange"
    >
      <view class="filter-item">
        ç±»å‹ç­›é€‰ <text class="arrow">â–¼</text>
      </view>
    </picker>
  </view>
  
  <!-- äº¤æ˜“åˆ—è¡¨ -->
  <view class="transaction-list">
    <view class="transaction-item" wx:for="{{transactions}}" wx:key="id">
      <view class="item-left">
        <text class="source">{{item.source_text}}</text>
        <text class="time">{{item.created_at}}</text>
      </view>
      <view class="item-right">
        <text class="amount {{item.type}}">
          {{item.type === 'earn' ? '+' : ''}}{{item.amount}}
        </text>
        <text class="balance">ä½™é¢: {{item.balance_after}}</text>
      </view>
    </view>
  </view>
  
  <!-- ç©ºçŠ¶æ€ -->
  <view wx:if="{{!isLoading && transactions.length === 0}}" class="empty-state">
    <text>æš‚æ— äº¤æ˜“è®°å½•</text>
  </view>
</view>
```

---

### 4.17 ç®¡ç†å‘˜è°ƒæ•´ç”¨æˆ·ç§¯åˆ†

**APIè·¯å¾„**: `POST /api/v4/unified-engine/points/admin/adjust`

**åŠŸèƒ½è¯´æ˜**:
- ç®¡ç†å‘˜æ‰‹åŠ¨è°ƒæ•´ç”¨æˆ·ç§¯åˆ†
- **ä»…ç®¡ç†å‘˜å¯ç”¨**
- **äº‹åŠ¡è®°å½•**: è‡ªåŠ¨è®°å½•è°ƒæ•´åŸå› å’Œæ“ä½œå‘˜
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/points.js` - adminAdjustPointsç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

```json
{
  "user_id": 123,                              // å¿…å¡«, ç”¨æˆ·ID
  "amount": 100,                               // å¿…å¡«, è°ƒæ•´æ•°é‡(æ­£æ•°=å¢åŠ ,è´Ÿæ•°=æ‰£é™¤)
  "reason": "è¡¥å¿ç§¯åˆ†"                         // å¿…å¡«, è°ƒæ•´åŸå› 
}
```

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "ç§¯åˆ†è°ƒæ•´æˆåŠŸ",
  "data": {
    "user_id": 123,
    "amount": 100,
    "old_balance": 990,                        // è°ƒæ•´å‰ä½™é¢
    "new_balance": 1090,                       // è°ƒæ•´åä½™é¢
    "reason": "è¡¥å¿ç§¯åˆ†",
    "admin_id": 1,                             // æ“ä½œç®¡ç†å‘˜ID
    "created_at": "2025-01-21T20:35:00.000+08:00"
  }
}
```

#### å¤±è´¥å“åº”

**æƒé™ä¸è¶³**:
```json
{
  "success": false,
  "error": "FORBIDDEN",
  "message": "éœ€è¦ç®¡ç†å‘˜æƒé™",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

**æ‰£é™¤ç§¯åˆ†è¶…è¿‡ä½™é¢**:
```json
{
  "success": false,
  "error": "INSUFFICIENT_BALANCE",
  "message": "æ‰£é™¤ç§¯åˆ†ä¸èƒ½è¶…è¿‡ç”¨æˆ·å½“å‰ä½™é¢",
  "data": {
    "current_balance": 990,
    "requested_deduction": -1500
  },
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

---

### 4.18 ç®¡ç†å‘˜ç§¯åˆ†ç»Ÿè®¡

**APIè·¯å¾„**: `GET /api/v4/unified-engine/points/admin/statistics`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢ç§¯åˆ†ç³»ç»Ÿçš„æ•´ä½“ç»Ÿè®¡ä¿¡æ¯
- **ä»…ç®¡ç†å‘˜å¯ç”¨**
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/points.js` - getAdminStatisticsç«¯ç‚¹

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "total_users": 12580,                      // æ€»ç”¨æˆ·æ•°
    "active_users": 8456,                      // æœ‰ç§¯åˆ†çš„ç”¨æˆ·æ•°
    "total_points_issued": 3456780,            // ç´¯è®¡å‘æ”¾ç§¯åˆ†
    "total_points_spent": 2345678,             // ç´¯è®¡æ¶ˆè€—ç§¯åˆ†
    "total_points_in_circulation": 1111102,    // æµé€šä¸­ç§¯åˆ†
    "average_points_per_user": 88,             // äººå‡ç§¯åˆ†
    "top_earners": [                           // ç§¯åˆ†æœ€å¤šçš„ç”¨æˆ·
      {
        "user_id": 456,
        "nickname": "ç”¨æˆ·B",
        "current_points": 15600
      },
      {
        "user_id": 789,
        "nickname": "ç”¨æˆ·C",
        "current_points": 12300
      }
    ],
    "daily_statistics": {                      // ä»Šæ—¥ç»Ÿè®¡
      "earned_today": 56780,                   // ä»Šæ—¥å‘æ”¾ç§¯åˆ†
      "spent_today": 34560,                    // ä»Šæ—¥æ¶ˆè€—ç§¯åˆ†
      "net_change": 22220                      // å‡€å˜åŒ–
    }
  }
}
```

---

### 4.19 ç”¨æˆ·ç»¼åˆç»Ÿè®¡ä¿¡æ¯

**APIè·¯å¾„**: `GET /api/v4/unified-engine/points/user/statistics/:user_id`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢ç”¨æˆ·çš„ç»¼åˆç»Ÿè®¡ä¿¡æ¯
- **åŒ…å«**: æŠ½å¥–ç»Ÿè®¡ã€å…‘æ¢ç»Ÿè®¡ã€ä¸Šä¼ ç»Ÿè®¡ã€åº“å­˜ç»Ÿè®¡ã€ç§¯åˆ†ç»Ÿè®¡ã€æˆå°±åˆ—è¡¨
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/points.js` - getUserStatisticsç«¯ç‚¹

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "user_id": 123,
    "nickname": "ç”¨æˆ·A",
    "avatar": "https://...",
    "member_since": "2025-01-01T10:00:00.000+08:00",
    
    // æŠ½å¥–ç»Ÿè®¡
    "lottery_stats": {
      "total_draws": 156,
      "total_wins": 34,
      "win_rate": "21.79%",
      "total_value_won": 12500
    },
    
    // å…‘æ¢ç»Ÿè®¡
    "exchange_stats": {
      "total_exchanges": 23,
      "total_points_spent": 4600,
      "favorite_product": "ç²¾ç¾æŠ±æ•"
    },
    
    // ä¸Šä¼ ç»Ÿè®¡
    "upload_stats": {
      "total_uploads": 67,
      "approved_count": 52,
      "rejected_count": 15,
      "approval_rate": "77.61%",
      "points_earned_from_uploads": 2600,
      "upload_level": 3
    },
    
    // åº“å­˜ç»Ÿè®¡
    "inventory_stats": {
      "total_items": 35,
      "unused_items": 32,
      "total_value": 25500
    },
    
    // ç§¯åˆ†ç»Ÿè®¡
    "points_stats": {
      "current_points": 990,
      "total_earned": 5600,
      "total_spent": 4610,
      "rank": 156                                // ç§¯åˆ†æ’å
    },
    
    // æˆå°±åˆ—è¡¨
    "achievements": [
      {
        "id": 1,
        "name": "åˆæ¥ä¹åˆ°",
        "description": "å®Œæˆé¦–æ¬¡æŠ½å¥–",
        "icon": "ğŸ‰",
        "achieved_at": "2025-01-01T10:30:00.000+08:00"
      },
      {
        "id": 2,
        "name": "æŠ½å¥–è¾¾äºº",
        "description": "ç´¯è®¡æŠ½å¥–100æ¬¡",
        "icon": "ğŸ²",
        "achieved_at": "2025-01-15T16:30:00.000+08:00"
      }
    ]
  }
}
```

---

## ğŸ“ åº“å­˜ç§¯åˆ†æ¨¡å—æ€»ç»“

### APIæ¸…å•

**åº“å­˜ç®¡ç†æ¨¡å—**:
| API | æ–¹æ³• | è·¯å¾„ | è®¤è¯ | è¯´æ˜ |
|-----|------|------|------|------|
| æŸ¥è¯¢åº“å­˜åˆ—è¡¨ | GET | `/api/v4/inventory/user/:user_id` | âœ… | åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·åº“å­˜ |
| æŸ¥è¯¢ç‰©å“è¯¦æƒ… | GET | `/api/v4/inventory/item/:item_id` | âœ… | æŸ¥è¯¢å•ä¸ªç‰©å“è¯¦æƒ… |
| ä½¿ç”¨ç‰©å“ | POST | `/api/v4/inventory/use/:item_id` | âœ… | ä½¿ç”¨åº“å­˜ç‰©å“ |
| å•†å“åˆ—è¡¨ | GET | `/api/v4/inventory/products` | âœ… | æŸ¥è¯¢å¯å…‘æ¢å•†å“ |
| å…‘æ¢å•†å“ | POST | `/api/v4/inventory/exchange` | âœ… | ä½¿ç”¨ç§¯åˆ†å…‘æ¢å•†å“ |
| å…‘æ¢è®°å½• | GET | `/api/v4/inventory/exchange-records` | âœ… | æŸ¥è¯¢å…‘æ¢è®°å½• |
| ç”Ÿæˆæ ¸é”€ç  | POST | `/api/v4/inventory/generate-code/:item_id` | âœ… | ä¸ºç‰©å“ç”Ÿæˆæ ¸é”€ç  |
| å–æ¶ˆå…‘æ¢ | POST | `/api/v4/inventory/exchange-records/:id/cancel` | âœ… | å–æ¶ˆå¾…å¤„ç†è®¢å• |
| è½¬ç§»ç‰©å“ | POST | `/api/v4/inventory/transfer` | âœ… | è½¬ç§»ç‰©å“ç»™å…¶ä»–ç”¨æˆ· |
| è½¬ç§»å†å² | GET | `/api/v4/inventory/transfer-history` | âœ… | æŸ¥è¯¢è½¬ç§»è®°å½• |
| æ ¸é”€ç‰©å“ | POST | `/api/v4/inventory/verification/verify` | âœ…ğŸ”‘ | å•†å®¶æ ¸é”€(ç®¡ç†å‘˜) |
| å¸‚åœºå•†å“ | GET | `/api/v4/inventory/market/products` | âœ… | æŸ¥è¯¢å¸‚åœºå•†å“ |
| è´­ä¹°å•†å“ | POST | `/api/v4/inventory/market/products/:id/purchase` | âœ… | è´­ä¹°å¸‚åœºå•†å“ |

**ç§¯åˆ†ç³»ç»Ÿæ¨¡å—**:
| API | æ–¹æ³• | è·¯å¾„ | è®¤è¯ | è¯´æ˜ |
|-----|------|------|------|------|
| æŸ¥è¯¢å½“å‰ç”¨æˆ·ç§¯åˆ† | GET | `/api/v4/unified-engine/points/balance` | âœ… | æŸ¥è¯¢å½“å‰ç”¨æˆ·ç§¯åˆ† |
| æŸ¥è¯¢æŒ‡å®šç”¨æˆ·ç§¯åˆ† | GET | `/api/v4/unified-engine/points/balance/:user_id` | âœ… | æŸ¥è¯¢æŒ‡å®šç”¨æˆ·ç§¯åˆ† |
| æŸ¥è¯¢äº¤æ˜“è®°å½• | GET | `/api/v4/unified-engine/points/transactions/:user_id` | âœ… | æŸ¥è¯¢ç§¯åˆ†æ˜ç»† |
| è°ƒæ•´ç”¨æˆ·ç§¯åˆ† | POST | `/api/v4/unified-engine/points/admin/adjust` | âœ…ğŸ”‘ | ç®¡ç†å‘˜è°ƒæ•´ç§¯åˆ† |
| ç§¯åˆ†ç»Ÿè®¡ | GET | `/api/v4/unified-engine/points/admin/statistics` | âœ…ğŸ”‘ | ç®¡ç†å‘˜ç»Ÿè®¡ä¿¡æ¯ |
| ç”¨æˆ·ç»¼åˆç»Ÿè®¡ | GET | `/api/v4/unified-engine/points/user/statistics/:user_id` | âœ… | ç”¨æˆ·å…¨é¢ç»Ÿè®¡ |

### å‰ç«¯å¼€å‘å»ºè®®

1. **åº“å­˜ç®¡ç†**:
   - ä½¿ç”¨åˆ†é¡µåŠ è½½,é¿å…ä¸€æ¬¡åŠ è½½è¿‡å¤šæ•°æ®
   - æ ¹æ®ç‰©å“çŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æ“ä½œæŒ‰é’®
   - æä¾›ç­›é€‰åŠŸèƒ½(çŠ¶æ€ã€ç±»å‹)

2. **å•†å“å…‘æ¢**:
   - å®æ—¶æ˜¾ç¤ºç”¨æˆ·ç§¯åˆ†ä½™é¢
   - å…‘æ¢å‰æ£€æŸ¥ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
   - å…‘æ¢æˆåŠŸåå¼•å¯¼ç”¨æˆ·æŸ¥çœ‹åº“å­˜

3. **ç‰©å“è½¬ç§»**:
   - è½¬ç§»å‰äºŒæ¬¡ç¡®è®¤
   - æ˜ç¡®æç¤ºè½¬ç§»åæ— æ³•æ’¤å›
   - è®°å½•è½¬ç§»å†å²ä¾›æŸ¥è¯¢

4. **ç§¯åˆ†æ˜ç»†**:
   - æ¸…æ™°åŒºåˆ†è·å¾—å’Œæ¶ˆè€—è®°å½•
   - æä¾›ç±»å‹ç­›é€‰åŠŸèƒ½
   - æ˜¾ç¤ºäº¤æ˜“åä½™é¢

---

**ğŸ“„ æ–‡æ¡£ç¬¬4éƒ¨åˆ†å®Œæˆ**

**ä¸‹ä¸€éƒ¨åˆ†**: Part5 - å›¾ç‰‡å’Œç³»ç»Ÿæ¨¡å—è¯¦ç»†API


---


**æ–‡æ¡£éƒ¨åˆ†**: ç¬¬5éƒ¨åˆ† - å›¾ç‰‡å’Œç³»ç»Ÿæ¨¡å—
**åˆ›å»ºæ—¶é—´**: 2025å¹´01æœˆ21æ—¥ (åŒ—äº¬æ—¶é—´)
**åŸºäºå®é™…ä»£ç éªŒè¯**: âœ…

---

## ğŸ“– æ¨¡å—æ¦‚è¿°

### å›¾ç‰‡ç®¡ç†æ¨¡å—(`/api/v4/photo`)
è´Ÿè´£ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡çš„ç®¡ç†å’Œå®¡æ ¸,åŒ…æ‹¬:
- ğŸ“¤ å›¾ç‰‡ä¸Šä¼ (Sealoså¯¹è±¡å­˜å‚¨)
- ğŸ–¼ï¸ è‡ªåŠ¨ç¼©ç•¥å›¾ç”Ÿæˆ
- âœ… å›¾ç‰‡å®¡æ ¸æµç¨‹
- ğŸ“Š ä¸Šä¼ ç»Ÿè®¡å’Œç­‰çº§ç³»ç»Ÿ
- ğŸ—‘ï¸ å›¾ç‰‡åˆ é™¤ç®¡ç†

### ç³»ç»ŸåŠŸèƒ½æ¨¡å—(`/api/v4/system`)
è´Ÿè´£ç³»ç»Ÿé€šç”¨åŠŸèƒ½,åŒ…æ‹¬:
- ğŸ“¢ ç³»ç»Ÿå…¬å‘Šç®¡ç†
- ğŸ’¬ ç”¨æˆ·åé¦ˆç³»ç»Ÿ
- ğŸ’¬ å®¢æœèŠå¤©ç³»ç»Ÿ
- âš™ï¸ ç³»ç»Ÿé…ç½®å’ŒçŠ¶æ€
- ğŸ“Š ç³»ç»Ÿæ€»è§ˆ

---

## ğŸ“· å›¾ç‰‡ç®¡ç†API

### 5.1 ä¸Šä¼ å›¾ç‰‡

**APIè·¯å¾„**: `POST /api/v4/photo/upload`

**åŠŸèƒ½è¯´æ˜**:
- ä¸Šä¼ å›¾ç‰‡åˆ°Sealoså¯¹è±¡å­˜å‚¨
- **è‡ªåŠ¨ç”Ÿæˆç¼©ç•¥å›¾**: å°(150x150)ã€ä¸­(500x500)ã€å¤§(1000x1000)
- **ç§¯åˆ†å¥–åŠ±**: å®¡æ ¸é€šè¿‡åå¥–åŠ±ç§¯åˆ†(50ç§¯åˆ†/å¼ )
- **æ ¼å¼é™åˆ¶**: æ”¯æŒjpgã€jpegã€pngã€gifã€webp
- **å¤§å°é™åˆ¶**: å•å¼ æœ€å¤§10MB
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/photo.js` - uploadImageç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**Content-Type**: `multipart/form-data`

**è¡¨å•å­—æ®µ**:
| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `photo` | File | æ˜¯ | å›¾ç‰‡æ–‡ä»¶ï¼ˆæ³¨æ„ï¼šå­—æ®µåä¸ºphotoï¼Œä¸æ˜¯imageï¼‰ |
| `user_id` | number | æ˜¯ | ç”¨æˆ·IDï¼ˆä»ç™»å½•Tokenè·å–æˆ–ä¼ é€’ï¼‰ |
| `business_type` | string | å¦ | ä¸šåŠ¡ç±»å‹ï¼Œé»˜è®¤: user_upload_review |
| `category` | string | å¦ | åˆ†ç±»ï¼Œé»˜è®¤: pending_review |

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "å›¾ç‰‡ä¸Šä¼ æˆåŠŸ",
  "code": "SUCCESS",
  "data": {
    "resource_id": 3456,                       // å›¾ç‰‡èµ„æºIDï¼ˆåç«¯ä½¿ç”¨resource_idå­—æ®µï¼‰
    "user_id": 123,                            // ç”¨æˆ·ID
    "business_type": "user_upload_review",     // ä¸šåŠ¡ç±»å‹
    "category": "pending_review",              // åˆ†ç±»
    "file_path": "20251022_abc123xyz.jpg",    // æ–‡ä»¶è·¯å¾„ï¼ˆç›¸å¯¹è·¯å¾„ï¼‰
    "original_filename": "photo.jpg",          // åŸå§‹æ–‡ä»¶å
    "file_size": 2567890,                      // æ–‡ä»¶å¤§å°(å­—èŠ‚)
    "mime_type": "image/jpeg",                 // MIMEç±»å‹
    "review_status": "pending",                // å®¡æ ¸çŠ¶æ€: pending/reviewing/approved/rejected
    "is_upload_review": true,                  // æ˜¯å¦éœ€è¦å®¡æ ¸
    "source_module": "user_upload",            // æ¥æºæ¨¡å—
    "thumbnail_paths": {                       // ç¼©ç•¥å›¾è·¯å¾„ï¼ˆJSONå¯¹è±¡ï¼‰
      "small": "thumbnails/small_abc123.jpg",
      "medium": "thumbnails/medium_abc123.jpg",
      "large": "thumbnails/large_abc123.jpg"
    },
    "uploaded_at": "2025-10-22T00:06:10.000+08:00",  // ä¸Šä¼ æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
    "hasThumbails": true,                      // æ˜¯å¦æœ‰ç¼©ç•¥å›¾
    "uploadStatus": "success",                 // ä¸Šä¼ çŠ¶æ€
    "created_at": "2025-10-22T00:06:10.000+08:00",   // åˆ›å»ºæ—¶é—´
    "updated_at": "2025-10-22T00:06:10.000+08:00"    // æ›´æ–°æ—¶é—´
  },
  "timestamp": "2025-10-22T00:06:10.000+08:00"
}
```

#### å¤±è´¥å“åº”

**æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒ**:
```json
{
  "success": false,
  "error": "INVALID_FILE_TYPE",
  "message": "ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼,è¯·ä¸Šä¼ jpgã€pngã€gifã€webpæ ¼å¼çš„å›¾ç‰‡",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

**æ–‡ä»¶è¿‡å¤§**:
```json
{
  "success": false,
  "error": "FILE_TOO_LARGE",
  "message": "æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶,æœ€å¤§10MB",
  "data": {
    "file_size": 12567890,
    "max_size": 10485760
  },
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

**ä¸Šä¼ å¤±è´¥**:
```json
{
  "success": false,
  "error": "UPLOAD_FAILED",
  "message": "å›¾ç‰‡ä¸Šä¼ å¤±è´¥,è¯·é‡è¯•",
  "timestamp": "2025-01-21T20:35:00.000+08:00"
}
```

#### å¾®ä¿¡å°ç¨‹åºå®Œæ•´ç¤ºä¾‹

```javascript
// pages/upload-photo/upload-photo.js - å›¾ç‰‡ä¸Šä¼ é¡µ

Page({
  data: {
    selectedImage: null,                       // é€‰ä¸­çš„å›¾ç‰‡ä¸´æ—¶è·¯å¾„
    description: '',                           // å›¾ç‰‡æè¿°
    tags: '',                                  // æ ‡ç­¾
    isUploading: false                         // æ˜¯å¦æ­£åœ¨ä¸Šä¼ 
  },
  
  // é€‰æ‹©å›¾ç‰‡
  async chooseImage() {
    try {
      const res = await wx.chooseImage({
        count: 1,                              // ä¸€æ¬¡åªèƒ½é€‰ä¸€å¼ 
        sizeType: ['original', 'compressed'],  // å¯é€‰åŸå›¾æˆ–å‹ç¼©å›¾
        sourceType: ['album', 'camera']        // å¯ä»ç›¸å†Œæˆ–ç›¸æœºé€‰æ‹©
      });
      
      const tempFilePath = res.tempFilePaths[0];
      
      // è·å–å›¾ç‰‡ä¿¡æ¯
      const imageInfo = await wx.getImageInfo({
        src: tempFilePath
      });
      
      // æ£€æŸ¥å›¾ç‰‡å¤§å°(10MBé™åˆ¶)
      if (imageInfo.size && imageInfo.size > 10 * 1024 * 1024) {
        wx.showModal({
          title: 'æ–‡ä»¶è¿‡å¤§',
          content: 'å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡10MB',
          showCancel: false
        });
        return;
      }
      
      this.setData({
        selectedImage: tempFilePath
      });
    } catch (error) {
      console.error('é€‰æ‹©å›¾ç‰‡å¤±è´¥:', error);
    }
  },
  
  // è¾“å…¥æè¿°
  onDescriptionInput(e) {
    this.setData({
      description: e.detail.value
    });
  },
  
  // è¾“å…¥æ ‡ç­¾
  onTagsInput(e) {
    this.setData({
      tags: e.detail.value
    });
  },
  
  // ä¸Šä¼ å›¾ç‰‡
  async uploadImage() {
    const { selectedImage, description, tags, isUploading } = this.data;
    
    // æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©å›¾ç‰‡
    if (!selectedImage) {
      wx.showToast({
        title: 'è¯·å…ˆé€‰æ‹©å›¾ç‰‡',
        icon: 'none'
      });
      return;
    }
    
    // é˜²æ­¢é‡å¤ä¸Šä¼ 
    if (isUploading) {
      return;
    }
    
    this.setData({ isUploading: true });
    
    // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
    wx.showLoading({
      title: 'ä¸Šä¼ ä¸­...',
      mask: true
    });
    
    try {
      // ä½¿ç”¨wx.uploadFileä¸Šä¼ å›¾ç‰‡
      const uploadRes = await wx.uploadFile({
        url: 'https://omqktqrtntnn.sealosbja.site/api/v4/photo/upload',
        filePath: selectedImage,
        name: 'photo',                         // åç«¯æ¥æ”¶çš„å­—æ®µåï¼ˆå¿…é¡»æ˜¯photoï¼‰
        header: {
          'Authorization': 'Bearer ' + wx.getStorageSync('access_token')
        },
        formData: {
          user_id: wx.getStorageSync('user_info').user_id,  // ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
          business_type: 'user_upload_review',  // ä¸šåŠ¡ç±»å‹ï¼ˆå¯é€‰ï¼‰
          category: 'pending_review'            // åˆ†ç±»ï¼ˆå¯é€‰ï¼‰
        }
      });
      
      wx.hideLoading();
      this.setData({ isUploading: false });
      
      // è§£æå“åº”
      const response = JSON.parse(uploadRes.data);
      
      if (response.success) {
        wx.showModal({
          title: 'ä¸Šä¼ æˆåŠŸ',
          content: 'å›¾ç‰‡å®¡æ ¸é€šè¿‡åå°†è·å¾—50ç§¯åˆ†å¥–åŠ±',
          showCancel: false,
          success: () => {
            // è¿”å›ä¸Šä¸€é¡µæˆ–è·³è½¬åˆ°æˆ‘çš„ä¸Šä¼ 
            wx.navigateTo({
              url: '/pages/my-uploads/my-uploads'
            });
          }
        });
        
        // æ¸…ç©ºè¡¨å•
        this.setData({
          selectedImage: null,
          description: '',
          tags: ''
        });
      } else {
        wx.showModal({
          title: 'ä¸Šä¼ å¤±è´¥',
          content: response.message || 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥,è¯·é‡è¯•',
          showCancel: false
        });
      }
    } catch (error) {
      wx.hideLoading();
      this.setData({ isUploading: false });
      
      wx.showModal({
        title: 'ä¸Šä¼ å¤±è´¥',
        content: 'ç½‘ç»œè¯·æ±‚å¤±è´¥,è¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•',
        showCancel: false
      });
      
      console.error('ä¸Šä¼ å›¾ç‰‡å¤±è´¥:', error);
    }
  }
});
```

```xml
<!-- pages/upload-photo/upload-photo.wxml - å›¾ç‰‡ä¸Šä¼ UI -->
<view class="upload-page">
  <view class="upload-header">
    <text class="title">ä¸Šä¼ å›¾ç‰‡</text>
    <text class="subtitle">å®¡æ ¸é€šè¿‡åè·å¾—50ç§¯åˆ†å¥–åŠ±</text>
  </view>
  
  <!-- å›¾ç‰‡é¢„è§ˆåŒº -->
  <view class="image-preview">
    <view wx:if="{{!selectedImage}}" class="choose-placeholder" bindtap="chooseImage">
      <text class="icon">ğŸ“·</text>
      <text class="text">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</text>
      <text class="hint">æ”¯æŒjpgã€pngã€gifæ ¼å¼,æœ€å¤§10MB</text>
    </view>
    
    <view wx:else class="selected-image">
      <image src="{{selectedImage}}" mode="aspectFit"></image>
      <button class="reselect-btn" size="mini" bindtap="chooseImage">é‡æ–°é€‰æ‹©</button>
    </view>
  </view>
  
  <!-- è¡¨å•åŒº -->
  <view class="upload-form">
    <view class="form-item">
      <text class="label">å›¾ç‰‡æè¿°</text>
      <textarea 
        class="textarea" 
        placeholder="è¯·è¾“å…¥å›¾ç‰‡æè¿°(å¯é€‰)"
        maxlength="200"
        value="{{description}}"
        bindinput="onDescriptionInput"
      ></textarea>
    </view>
    
    <view class="form-item">
      <text class="label">å›¾ç‰‡æ ‡ç­¾</text>
      <input 
        class="input" 
        type="text" 
        placeholder="ç”¨é€—å·åˆ†éš”,å¦‚: ç¾é£Ÿ,é¤å…"
        value="{{tags}}"
        bindinput="onTagsInput"
      />
    </view>
  </view>
  
  <!-- ä¸Šä¼ æŒ‰é’® -->
  <view class="upload-button-container">
    <button 
      class="upload-btn" 
      type="primary"
      bindtap="uploadImage"
      disabled="{{!selectedImage || isUploading}}"
    >
      {{isUploading ? 'ä¸Šä¼ ä¸­...' : 'ä¸Šä¼ å›¾ç‰‡'}}
    </button>
  </view>
  
  <!-- ä¸Šä¼ è§„åˆ™ -->
  <view class="upload-rules">
    <text class="rules-title">ä¸Šä¼ è§„åˆ™</text>
    <view class="rule-item">
      <text>â€¢ å›¾ç‰‡å†…å®¹éœ€çœŸå®åˆæ³•,ä¸å¾—åŒ…å«è¿è§„ä¿¡æ¯</text>
    </view>
    <view class="rule-item">
      <text>â€¢ å›¾ç‰‡æ¸…æ™°åº¦éœ€è¾¾åˆ°å®¡æ ¸æ ‡å‡†</text>
    </view>
    <view class="rule-item">
      <text>â€¢ å®¡æ ¸é€šè¿‡åå¥–åŠ±50ç§¯åˆ†</text>
    </view>
    <view class="rule-item">
      <text>â€¢ å®¡æ ¸ä¸é€šè¿‡ä¸æ‰£é™¤ç§¯åˆ†</text>
    </view>
  </view>
</view>
```

---

### 5.2 æŸ¥è¯¢å¾…å®¡æ ¸å›¾ç‰‡åˆ—è¡¨

**APIè·¯å¾„**: `GET /api/v4/photo/pending-reviews`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢æ‰€æœ‰å¾…å®¡æ ¸çš„å›¾ç‰‡
- **ä»…ç®¡ç†å‘˜å¯ç”¨**
- **æ”¯æŒåˆ†é¡µ**
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/photo.js` - getPendingReviewsç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|-------|------|
| `page` | number | 1 | é¡µç  |
| `limit` | number | 20 | æ¯é¡µæ¡æ•° |

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 3456,
        "user_id": 123,
        "user_nickname": "ç”¨æˆ·A",
        "user_mobile": "138****8000",
        "original_filename": "photo.jpg",
        "url": "https://sealos.../images/20250121/abc123.jpg",
        "thumbnails": {
          "small": "https://sealos.../thumbnails/small_abc123.jpg",
          "medium": "https://sealos.../thumbnails/medium_abc123.jpg",
          "large": "https://sealos.../thumbnails/large_abc123.jpg"
        },
        "size": 2567890,
        "mime_type": "image/jpeg",
        "width": 1920,
        "height": 1080,
        "description": "ç¾é£Ÿç…§ç‰‡",
        "tags": ["ç¾é£Ÿ", "é¤å…"],
        "status": "pending",
        "uploaded_at": "2025-01-21T20:35:00.000+08:00",
        "waiting_time": "5åˆ†é’Ÿ"                // ç­‰å¾…å®¡æ ¸æ—¶é—´
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 45,
      "total_pages": 3,
      "has_next": true,
      "has_prev": false
    },
    "summary": {
      "pending_count": 45,                     // å¾…å®¡æ ¸æ€»æ•°
      "average_waiting_time": "15åˆ†é’Ÿ"        // å¹³å‡ç­‰å¾…æ—¶é—´
    }
  }
}
```

---

### 5.3 å®¡æ ¸å›¾ç‰‡

**APIè·¯å¾„**: `POST /api/v4/photo/review/:resourceId`

**åŠŸèƒ½è¯´æ˜**:
- ç®¡ç†å‘˜å®¡æ ¸ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡
- **é€šè¿‡**: å¥–åŠ±ç”¨æˆ·50ç§¯åˆ†
- **æ‹’ç»**: ä¸æ‰£ç§¯åˆ†,è®°å½•æ‹’ç»åŸå› 
- **ä»…ç®¡ç†å‘˜å¯ç”¨**
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/photo.js` - reviewImageç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**è·¯å¾„å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `resourceId` | number | å›¾ç‰‡èµ„æºID |

**è¯·æ±‚ä½“**:
```json
{
  "action": "approve",                         // å¿…å¡«, approve=é€šè¿‡ / reject=æ‹’ç»
  "reason": "å›¾ç‰‡è´¨é‡ä¸ä½³"                     // æ‹’ç»æ—¶å¿…å¡«, æ‹’ç»åŸå› 
}
```

#### æˆåŠŸå“åº”(å®¡æ ¸é€šè¿‡)

```json
{
  "success": true,
  "message": "å®¡æ ¸é€šè¿‡,å·²å¥–åŠ±ç”¨æˆ·50ç§¯åˆ†",
  "data": {
    "resource_id": 3456,
    "action": "approve",
    "status": "approved",
    "user_id": 123,
    "points_awarded": 50,                      // å¥–åŠ±çš„ç§¯åˆ†
    "reviewed_at": "2025-01-21T20:40:00.000+08:00",
    "reviewer_id": 1                           // å®¡æ ¸å‘˜ID
  }
}
```

#### æˆåŠŸå“åº”(å®¡æ ¸æ‹’ç»)

```json
{
  "success": true,
  "message": "å®¡æ ¸å·²æ‹’ç»",
  "data": {
    "resource_id": 3456,
    "action": "reject",
    "status": "rejected",
    "reason": "å›¾ç‰‡è´¨é‡ä¸ä½³",
    "user_id": 123,
    "reviewed_at": "2025-01-21T20:40:00.000+08:00",
    "reviewer_id": 1
  }
}
```

#### å¤±è´¥å“åº”

**æƒé™ä¸è¶³**:
```json
{
  "success": false,
  "error": "FORBIDDEN",
  "message": "éœ€è¦ç®¡ç†å‘˜æƒé™",
  "timestamp": "2025-01-21T20:40:00.000+08:00"
}
```

**å›¾ç‰‡å·²å®¡æ ¸**:
```json
{
  "success": false,
  "error": "ALREADY_REVIEWED",
  "message": "è¯¥å›¾ç‰‡å·²è¢«å®¡æ ¸",
  "data": {
    "current_status": "approved",
    "reviewed_at": "2025-01-21T20:38:00.000+08:00"
  },
  "timestamp": "2025-01-21T20:40:00.000+08:00"
}
```

---

### 5.4 æŸ¥è¯¢æˆ‘çš„ä¸Šä¼ è®°å½•

**APIè·¯å¾„**: `GET /api/v4/photo/my-uploads`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„å›¾ç‰‡ä¸Šä¼ è®°å½•
- **æ”¯æŒåˆ†é¡µå’ŒçŠ¶æ€ç­›é€‰**
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/photo.js` - getMyUploadsç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|-------|------|
| `page` | number | 1 | é¡µç  |
| `limit` | number | 20 | æ¯é¡µæ¡æ•° |
| `status` | string | - | å¯é€‰,ç­›é€‰çŠ¶æ€: pending/approved/rejected |

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 3456,
        "url": "https://sealos.../images/20250121/abc123.jpg",
        "thumbnails": {
          "small": "https://sealos.../thumbnails/small_abc123.jpg",
          "medium": "https://sealos.../thumbnails/medium_abc123.jpg",
          "large": "https://sealos.../thumbnails/large_abc123.jpg"
        },
        "description": "ç¾é£Ÿç…§ç‰‡",
        "tags": ["ç¾é£Ÿ", "é¤å…"],
        "status": "approved",                  // pending/approved/rejected
        "status_text": "å®¡æ ¸é€šè¿‡",
        "points_awarded": 50,                  // è·å¾—çš„ç§¯åˆ†(é€šè¿‡æ—¶)
        "rejection_reason": null,              // æ‹’ç»åŸå› (æ‹’ç»æ—¶)
        "uploaded_at": "2025-01-21T20:35:00.000+08:00",
        "reviewed_at": "2025-01-21T20:40:00.000+08:00"
      },
      {
        "id": 3455,
        "url": "https://sealos.../images/20250121/def456.jpg",
        "thumbnails": { "..." },
        "description": "é¤å…ç¯å¢ƒ",
        "tags": ["é¤å…"],
        "status": "rejected",
        "status_text": "å®¡æ ¸æ‹’ç»",
        "points_awarded": 0,
        "rejection_reason": "å›¾ç‰‡æ¨¡ç³Šä¸æ¸…",
        "uploaded_at": "2025-01-21T18:20:00.000+08:00",
        "reviewed_at": "2025-01-21T18:25:00.000+08:00"
      },
      {
        "id": 3454,
        "url": "https://sealos.../images/20250121/ghi789.jpg",
        "thumbnails": { "..." },
        "description": "ç‰¹è‰²èœå“",
        "tags": ["ç¾é£Ÿ"],
        "status": "pending",
        "status_text": "å¾…å®¡æ ¸",
        "points_awarded": 0,
        "rejection_reason": null,
        "uploaded_at": "2025-01-21T19:50:00.000+08:00",
        "reviewed_at": null
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 67,
      "total_pages": 4,
      "has_next": true,
      "has_prev": false
    },
    "summary": {
      "total_uploads": 67,                     // æ€»ä¸Šä¼ æ•°
      "pending_count": 12,                     // å¾…å®¡æ ¸æ•°
      "approved_count": 52,                    // å·²é€šè¿‡æ•°
      "rejected_count": 3,                     // å·²æ‹’ç»æ•°
      "total_points_earned": 2600              // ç´¯è®¡è·å¾—ç§¯åˆ†
    }
  }
}
```

#### å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹

```javascript
// pages/my-uploads/my-uploads.js - æˆ‘çš„ä¸Šä¼ è®°å½•

Page({
  data: {
    uploads: [],
    page: 1,
    limit: 20,
    hasMore: true,
    isLoading: false,
    filterStatus: 'all',                       // all/pending/approved/rejected
    summary: null
  },
  
  onLoad() {
    this.loadUploads();
  },
  
  async loadUploads(isLoadMore = false) {
    if (this.data.isLoading) return;
    
    try {
      this.setData({ isLoading: true });
      
      const page = isLoadMore ? this.data.page + 1 : 1;
      
      // æ„å»ºæŸ¥è¯¢å‚æ•°
      let queryParams = `page=${page}&limit=${this.data.limit}`;
      if (this.data.filterStatus !== 'all') {
        queryParams += `&status=${this.data.filterStatus}`;
      }
      
      const res = await wx.request({
        url: `https://omqktqrtntnn.sealosbja.site/api/v4/photo/my-uploads?${queryParams}`,
        method: 'GET',
        header: {
          'Authorization': 'Bearer ' + wx.getStorageSync('access_token')
        }
      });
      
      if (res.data.success) {
        const items = res.data.data.items;
        const pagination = res.data.data.pagination;
        
        this.setData({
          uploads: isLoadMore ? [...this.data.uploads, ...items] : items,
          page: page,
          hasMore: pagination.has_next,
          isLoading: false,
          summary: res.data.data.summary
        });
      } else {
        this.setData({ isLoading: false });
      }
    } catch (error) {
      this.setData({ isLoading: false });
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      });
    }
  },
  
  // åˆ‡æ¢ç­›é€‰çŠ¶æ€
  onFilterChange(e) {
    this.setData({
      filterStatus: e.detail.value,
      page: 1
    });
    this.loadUploads();
  },
  
  // é¢„è§ˆå›¾ç‰‡
  previewImage(e) {
    const url = e.currentTarget.dataset.url;
    wx.previewImage({
      current: url,
      urls: [url]
    });
  },
  
  // åˆ é™¤å›¾ç‰‡
  async deleteImage(e) {
    const id = e.currentTarget.dataset.id;
    
    wx.showModal({
      title: 'ç¡®è®¤åˆ é™¤',
      content: 'ç¡®å®šåˆ é™¤è¿™å¼ å›¾ç‰‡å—?',
      success: async (res) => {
        if (res.confirm) {
          try {
            wx.showLoading({ title: 'åˆ é™¤ä¸­...' });
            
            const delRes = await wx.request({
              url: `https://omqktqrtntnn.sealosbja.site/api/v4/photo/${id}`,
              method: 'DELETE',
              header: {
                'Authorization': 'Bearer ' + wx.getStorageSync('access_token')
              }
            });
            
            wx.hideLoading();
            
            if (delRes.data.success) {
              wx.showToast({
                title: 'åˆ é™¤æˆåŠŸ',
                icon: 'success'
              });
              
              // é‡æ–°åŠ è½½åˆ—è¡¨
              this.loadUploads();
            } else {
              wx.showToast({
                title: delRes.data.message || 'åˆ é™¤å¤±è´¥',
                icon: 'none'
              });
            }
          } catch (error) {
            wx.hideLoading();
            wx.showToast({
              title: 'ç½‘ç»œè¯·æ±‚å¤±è´¥',
              icon: 'none'
            });
          }
        }
      }
    });
  },
  
  // ä¸Šæ‹‰åŠ è½½æ›´å¤š
  onReachBottom() {
    if (this.data.hasMore && !this.data.isLoading) {
      this.loadUploads(true);
    }
  }
});
```

---

### 5.5 æŸ¥è¯¢æˆ‘çš„ä¸Šä¼ ç»Ÿè®¡

**APIè·¯å¾„**: `GET /api/v4/photo/my-stats`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„ä¸Šä¼ ç»Ÿè®¡ä¿¡æ¯
- **åŒ…å«**: ä¸Šä¼ æ€»æ•°ã€å®¡æ ¸æƒ…å†µã€ç§¯åˆ†æ”¶ç›Šã€ä¸Šä¼ ç­‰çº§
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/photo.js` - getMyUploadStatsç«¯ç‚¹

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "user_id": 123,
    "total_uploads": 67,                       // æ€»ä¸Šä¼ æ•°
    "pending_count": 12,                       // å¾…å®¡æ ¸æ•°
    "approved_count": 52,                      // å·²é€šè¿‡æ•°
    "rejected_count": 3,                       // å·²æ‹’ç»æ•°
    "approval_rate": "94.55%",                 // é€šè¿‡ç‡
    "total_points_earned": 2600,               // ç´¯è®¡è·å¾—ç§¯åˆ†
    "upload_level": 3,                         // ä¸Šä¼ ç­‰çº§(1-5)
    "level_name": "æ´»è·ƒä¸Šä¼ è€…",                // ç­‰çº§åç§°
    "next_level_threshold": 100,               // ä¸‹ä¸€ç­‰çº§æ‰€éœ€ä¸Šä¼ æ•°
    "achievement_badges": [                    // æˆå°±å¾½ç« 
      {
        "name": "åˆè¯•å•¼å£°",
        "description": "å®Œæˆé¦–æ¬¡ä¸Šä¼ ",
        "icon": "ğŸ‰",
        "unlocked_at": "2025-01-01T10:00:00.000+08:00"
      },
      {
        "name": "ä¸Šä¼ è¾¾äºº",
        "description": "ç´¯è®¡ä¸Šä¼ 50å¼ å›¾ç‰‡",
        "icon": "ğŸ“·",
        "unlocked_at": "2025-01-20T16:30:00.000+08:00"
      }
    ],
    "recent_uploads": [                        // æœ€è¿‘3æ¬¡ä¸Šä¼ 
      {
        "id": 3456,
        "status": "approved",
        "uploaded_at": "2025-01-21T20:35:00.000+08:00"
      }
    ]
  }
}
```

---

### 5.6 åˆ é™¤å›¾ç‰‡

**APIè·¯å¾„**: `DELETE /api/v4/photo/:id`

**åŠŸèƒ½è¯´æ˜**:
- åˆ é™¤ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡
- **æƒé™æ§åˆ¶**: åªèƒ½åˆ é™¤è‡ªå·±ä¸Šä¼ çš„å›¾ç‰‡,ç®¡ç†å‘˜å¯åˆ é™¤æ‰€æœ‰
- **å®Œå…¨åˆ é™¤**: åˆ é™¤æ•°æ®åº“è®°å½•ã€æœ¬åœ°æ–‡ä»¶ã€Sealoså¯¹è±¡å­˜å‚¨ã€ç¼©ç•¥å›¾
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/photo.js` - deleteImageç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**è·¯å¾„å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `id` | number | å›¾ç‰‡èµ„æºID |

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "å›¾ç‰‡å·²åˆ é™¤",
  "data": {
    "deleted_id": 3456,
    "deleted_at": "2025-01-21T20:45:00.000+08:00"
  }
}
```

#### å¤±è´¥å“åº”

**æƒé™ä¸è¶³**:
```json
{
  "success": false,
  "error": "FORBIDDEN",
  "message": "æ‚¨åªèƒ½åˆ é™¤è‡ªå·±ä¸Šä¼ çš„å›¾ç‰‡",
  "timestamp": "2025-01-21T20:45:00.000+08:00"
}
```

**å›¾ç‰‡ä¸å­˜åœ¨**:
```json
{
  "success": false,
  "error": "NOT_FOUND",
  "message": "å›¾ç‰‡ä¸å­˜åœ¨",
  "timestamp": "2025-01-21T20:45:00.000+08:00"
}
```

---

## ğŸ”§ ç³»ç»ŸåŠŸèƒ½API

### 5.7 æŸ¥è¯¢ç³»ç»Ÿå…¬å‘Šåˆ—è¡¨

**APIè·¯å¾„**: `GET /api/v4/system/announcements`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢ç³»ç»Ÿå…¬å‘Šåˆ—è¡¨
- **è‡ªåŠ¨æ•°æ®è„±æ•**: æ™®é€šç”¨æˆ·çœ‹ä¸åˆ°å†…éƒ¨å¤‡æ³¨ç­‰æ•æ„Ÿä¿¡æ¯
- **æ”¯æŒåˆ†é¡µ**
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/system.js` - getAnnouncementsç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|-------|------|
| `page` | number | 1 | é¡µç  |
| `limit` | number | 20 | æ¯é¡µæ¡æ•° |
| `type` | string | - | å¯é€‰,ç­›é€‰ç±»å‹: system/event/maintenance |

#### æˆåŠŸå“åº”(æ™®é€šç”¨æˆ· - è„±æ•æ•°æ®)

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 201,
        "title": "ç³»ç»Ÿç»´æŠ¤é€šçŸ¥",                // å…¬å‘Šæ ‡é¢˜
        "content": "æœ¬ç³»ç»Ÿå°†äº2025å¹´1æœˆ25æ—¥å‡Œæ™¨2:00-4:00è¿›è¡Œç³»ç»Ÿç»´æŠ¤...",  // å…¬å‘Šå†…å®¹
        "type": "maintenance",                 // ç±»å‹: system/event/maintenance
        "type_text": "ç»´æŠ¤é€šçŸ¥",
        "priority": "high",                    // ä¼˜å…ˆçº§: low/medium/high
        "is_pinned": true,                     // æ˜¯å¦ç½®é¡¶
        "published_at": "2025-01-21T10:00:00.000+08:00",
        "expires_at": "2025-01-26T00:00:00.000+08:00"
        // âŒ æ™®é€šç”¨æˆ·çœ‹ä¸åˆ°: internal_notes(å†…éƒ¨å¤‡æ³¨), created_by(åˆ›å»ºäºº)
      },
      {
        "id": 200,
        "title": "æ˜¥èŠ‚æ´»åŠ¨é¢„å‘Š",
        "content": "æ˜¥èŠ‚æœŸé—´å‚ä¸æŠ½å¥–æ´»åŠ¨,èµ¢å–ä¸°åšå¥–å“...",
        "type": "event",
        "type_text": "æ´»åŠ¨å…¬å‘Š",
        "priority": "medium",
        "is_pinned": false,
        "published_at": "2025-01-20T15:00:00.000+08:00",
        "expires_at": "2025-02-15T23:59:59.999+08:00"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 15,
      "total_pages": 1,
      "has_next": false,
      "has_prev": false
    }
  }
}
```

#### å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹

```javascript
// pages/announcements/announcements.js - å…¬å‘Šåˆ—è¡¨é¡µ

Page({
  data: {
    announcements: [],
    page: 1,
    limit: 20,
    hasMore: true,
    isLoading: false
  },
  
  onLoad() {
    this.loadAnnouncements();
  },
  
  async loadAnnouncements(isLoadMore = false) {
    if (this.data.isLoading) return;
    
    try {
      this.setData({ isLoading: true });
      
      const page = isLoadMore ? this.data.page + 1 : 1;
      
      const res = await wx.request({
        url: `https://omqktqrtntnn.sealosbja.site/api/v4/system/announcements?page=${page}&limit=${this.data.limit}`,
        method: 'GET',
        header: {
          'Authorization': 'Bearer ' + wx.getStorageSync('access_token')
        }
      });
      
      if (res.data.success) {
        const items = res.data.data.items;
        const pagination = res.data.data.pagination;
        
        this.setData({
          announcements: isLoadMore ? [...this.data.announcements, ...items] : items,
          page: page,
          hasMore: pagination.has_next,
          isLoading: false
        });
      } else {
        this.setData({ isLoading: false });
      }
    } catch (error) {
      this.setData({ isLoading: false });
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      });
    }
  },
  
  // æŸ¥çœ‹å…¬å‘Šè¯¦æƒ…
  viewDetail(e) {
    const id = e.currentTarget.dataset.id;
    wx.navigateTo({
      url: `/pages/announcement-detail/announcement-detail?id=${id}`
    });
  },
  
  // ä¸Šæ‹‰åŠ è½½æ›´å¤š
  onReachBottom() {
    if (this.data.hasMore && !this.data.isLoading) {
      this.loadAnnouncements(true);
    }
  }
});
```

---

### 5.8 æŸ¥è¯¢é¦–é¡µå…¬å‘Š(é‡è¦å…¬å‘Š)

**APIè·¯å¾„**: `GET /api/v4/system/announcements/home`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢é¦–é¡µå±•ç¤ºçš„é‡è¦å…¬å‘Š
- **ä»…è¿”å›å‰5æ¡ç½®é¡¶æˆ–é«˜ä¼˜å…ˆçº§å…¬å‘Š**
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/system.js` - getHomeAnnouncementsç«¯ç‚¹

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": [
    {
      "id": 201,
      "title": "ç³»ç»Ÿç»´æŠ¤é€šçŸ¥",
      "content": "æœ¬ç³»ç»Ÿå°†äº2025å¹´1æœˆ25æ—¥å‡Œæ™¨2:00-4:00è¿›è¡Œç³»ç»Ÿç»´æŠ¤...",
      "type": "maintenance",
      "priority": "high",
      "is_pinned": true,
      "published_at": "2025-01-21T10:00:00.000+08:00"
    },
    {
      "id": 200,
      "title": "æ˜¥èŠ‚æ´»åŠ¨é¢„å‘Š",
      "content": "æ˜¥èŠ‚æœŸé—´å‚ä¸æŠ½å¥–æ´»åŠ¨,èµ¢å–ä¸°åšå¥–å“...",
      "type": "event",
      "priority": "medium",
      "is_pinned": true,
      "published_at": "2025-01-20T15:00:00.000+08:00"
    }
  ]
}
```

---

### 5.9 æäº¤ç”¨æˆ·åé¦ˆ

**APIè·¯å¾„**: `POST /api/v4/system/feedback`

**åŠŸèƒ½è¯´æ˜**:
- ç”¨æˆ·æäº¤åé¦ˆæ„è§æˆ–é—®é¢˜æŠ¥å‘Š
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/system.js` - submitFeedbackç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

```json
{
  "type": "bug",                               // å¿…å¡«, bug/suggestion/complaint/other
  "title": "å›¾ç‰‡ä¸Šä¼ å¤±è´¥",                     // å¿…å¡«, åé¦ˆæ ‡é¢˜
  "content": "ä¸Šä¼ å›¾ç‰‡æ—¶æç¤ºç½‘ç»œé”™è¯¯...",       // å¿…å¡«, åé¦ˆå†…å®¹
  "contact": "138****8000"                     // å¯é€‰, è”ç³»æ–¹å¼
}
```

**typeç±»å‹è¯´æ˜**:
| ç±»å‹ | è¯´æ˜ |
|------|------|
| `bug` | BugæŠ¥å‘Š |
| `suggestion` | åŠŸèƒ½å»ºè®® |
| `complaint` | æŠ•è¯‰ |
| `other` | å…¶ä»– |

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "åé¦ˆå·²æäº¤,æ„Ÿè°¢æ‚¨çš„åé¦ˆ",
  "data": {
    "id": 5001,                                // åé¦ˆID
    "type": "bug",
    "title": "å›¾ç‰‡ä¸Šä¼ å¤±è´¥",
    "content": "ä¸Šä¼ å›¾ç‰‡æ—¶æç¤ºç½‘ç»œé”™è¯¯...",
    "status": "pending",                       // çŠ¶æ€: pending/in_progress/resolved/closed
    "created_at": "2025-01-21T20:50:00.000+08:00"
  }
}
```

#### å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹

```javascript
// pages/feedback/feedback.js - ç”¨æˆ·åé¦ˆé¡µ

Page({
  data: {
    type: 'bug',                               // åé¦ˆç±»å‹
    title: '',                                 // æ ‡é¢˜
    content: '',                               // å†…å®¹
    contact: ''                                // è”ç³»æ–¹å¼
  },
  
  onTypeChange(e) {
    this.setData({
      type: e.detail.value
    });
  },
  
  onTitleInput(e) {
    this.setData({
      title: e.detail.value
    });
  },
  
  onContentInput(e) {
    this.setData({
      content: e.detail.value
    });
  },
  
  onContactInput(e) {
    this.setData({
      contact: e.detail.value
    });
  },
  
  async submitFeedback() {
    const { type, title, content, contact } = this.data;
    
    // éªŒè¯è¾“å…¥
    if (!title || !content) {
      wx.showToast({
        title: 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯',
        icon: 'none'
      });
      return;
    }
    
    if (content.length < 10) {
      wx.showToast({
        title: 'åé¦ˆå†…å®¹è‡³å°‘10ä¸ªå­—',
        icon: 'none'
      });
      return;
    }
    
    try {
      wx.showLoading({ title: 'æäº¤ä¸­...' });
      
      const res = await wx.request({
        url: 'https://omqktqrtntnn.sealosbja.site/api/v4/system/feedback',
        method: 'POST',
        header: {
          'Authorization': 'Bearer ' + wx.getStorageSync('access_token'),
          'Content-Type': 'application/json'
        },
        data: {
          type: type,
          title: title,
          content: content,
          contact: contact
        }
      });
      
      wx.hideLoading();
      
      if (res.data.success) {
        wx.showModal({
          title: 'æäº¤æˆåŠŸ',
          content: 'æ„Ÿè°¢æ‚¨çš„åé¦ˆ,æˆ‘ä»¬ä¼šå°½å¿«å¤„ç†',
          showCancel: false,
          success: () => {
            wx.navigateBack();
          }
        });
      } else {
        wx.showToast({
          title: res.data.message || 'æäº¤å¤±è´¥',
          icon: 'none'
        });
      }
    } catch (error) {
      wx.hideLoading();
      wx.showToast({
        title: 'ç½‘ç»œè¯·æ±‚å¤±è´¥',
        icon: 'none'
      });
    }
  }
});
```

```xml
<!-- pages/feedback/feedback.wxml - åé¦ˆé¡µé¢UI -->
<view class="feedback-page">
  <view class="form">
    <view class="form-item">
      <text class="label">åé¦ˆç±»å‹</text>
      <picker 
        mode="selector" 
        range="{{['BugæŠ¥å‘Š', 'åŠŸèƒ½å»ºè®®', 'æŠ•è¯‰', 'å…¶ä»–']}}" 
        value="{{['bug','suggestion','complaint','other'].indexOf(type)}}"
        bindchange="onTypeChange"
      >
        <view class="picker">
          {{['BugæŠ¥å‘Š', 'åŠŸèƒ½å»ºè®®', 'æŠ•è¯‰', 'å…¶ä»–'][['bug','suggestion','complaint','other'].indexOf(type)]}}
        </view>
      </picker>
    </view>
    
    <view class="form-item">
      <text class="label">åé¦ˆæ ‡é¢˜ *</text>
      <input 
        class="input" 
        type="text" 
        placeholder="è¯·è¾“å…¥æ ‡é¢˜"
        value="{{title}}"
        bindinput="onTitleInput"
        maxlength="50"
      />
    </view>
    
    <view class="form-item">
      <text class="label">åé¦ˆå†…å®¹ *</text>
      <textarea 
        class="textarea" 
        placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„é—®é¢˜æˆ–å»ºè®®,è‡³å°‘10ä¸ªå­—"
        value="{{content}}"
        bindinput="onContentInput"
        maxlength="500"
      ></textarea>
    </view>
    
    <view class="form-item">
      <text class="label">è”ç³»æ–¹å¼(å¯é€‰)</text>
      <input 
        class="input" 
        type="text" 
        placeholder="æ–¹ä¾¿æˆ‘ä»¬è”ç³»æ‚¨"
        value="{{contact}}"
        bindinput="onContactInput"
      />
    </view>
  </view>
  
  <view class="submit-button-container">
    <button class="submit-btn" type="primary" bindtap="submitFeedback">
      æäº¤åé¦ˆ
    </button>
  </view>
</view>
```

---

### 5.10 æŸ¥è¯¢æˆ‘çš„åé¦ˆåˆ—è¡¨

**APIè·¯å¾„**: `GET /api/v4/system/feedback/my`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„åé¦ˆè®°å½•
- **æ”¯æŒåˆ†é¡µ**
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/system.js` - getMyFeedbackç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|-------|------|
| `page` | number | 1 | é¡µç  |
| `limit` | number | 20 | æ¯é¡µæ¡æ•° |
| `status` | string | - | å¯é€‰,ç­›é€‰çŠ¶æ€: pending/in_progress/resolved/closed |

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 5001,
        "type": "bug",
        "type_text": "BugæŠ¥å‘Š",
        "title": "å›¾ç‰‡ä¸Šä¼ å¤±è´¥",
        "content": "ä¸Šä¼ å›¾ç‰‡æ—¶æç¤ºç½‘ç»œé”™è¯¯...",
        "status": "in_progress",               // pending/in_progress/resolved/closed
        "status_text": "å¤„ç†ä¸­",
        "contact": "138****8000",
        "admin_reply": "å·²æ”¶åˆ°åé¦ˆ,æ­£åœ¨æ’æŸ¥é—®é¢˜",  // ç®¡ç†å‘˜å›å¤
        "created_at": "2025-01-21T20:50:00.000+08:00",
        "updated_at": "2025-01-21T21:00:00.000+08:00"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 8,
      "total_pages": 1,
      "has_next": false,
      "has_prev": false
    },
    "summary": {
      "total_feedback": 8,                     // æ€»åé¦ˆæ•°
      "pending_count": 2,                      // å¾…å¤„ç†æ•°
      "in_progress_count": 3,                  // å¤„ç†ä¸­æ•°
      "resolved_count": 3                      // å·²è§£å†³æ•°
    }
  }
}
```

---

### 5.11 æŸ¥è¯¢åé¦ˆè¯¦æƒ…

**APIè·¯å¾„**: `GET /api/v4/system/feedback/:id`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢æŒ‡å®šåé¦ˆçš„è¯¦æƒ…
- **æƒé™æ§åˆ¶**: åªèƒ½æŸ¥çœ‹è‡ªå·±çš„åé¦ˆ,ç®¡ç†å‘˜å¯æŸ¥çœ‹æ‰€æœ‰
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/system.js` - getFeedbackDetailç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**è·¯å¾„å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `id` | number | åé¦ˆID |

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "id": 5001,
    "user_id": 123,
    "type": "bug",
    "type_text": "BugæŠ¥å‘Š",
    "title": "å›¾ç‰‡ä¸Šä¼ å¤±è´¥",
    "content": "ä¸Šä¼ å›¾ç‰‡æ—¶æç¤ºç½‘ç»œé”™è¯¯,å°è¯•å¤šæ¬¡éƒ½å¤±è´¥...",
    "status": "in_progress",
    "status_text": "å¤„ç†ä¸­",
    "contact": "138****8000",
    "admin_reply": "å·²æ”¶åˆ°åé¦ˆ,æ­£åœ¨æ’æŸ¥é—®é¢˜",
    "created_at": "2025-01-21T20:50:00.000+08:00",
    "updated_at": "2025-01-21T21:00:00.000+08:00",
    
    // é¢å¤–çš„æ—¶é—´çº¿ä¿¡æ¯
    "timeline": [
      {
        "action": "submitted",
        "description": "ç”¨æˆ·æäº¤åé¦ˆ",
        "timestamp": "2025-01-21T20:50:00.000+08:00"
      },
      {
        "action": "assigned",
        "description": "åé¦ˆå·²åˆ†é…ç»™ç®¡ç†å‘˜A",
        "timestamp": "2025-01-21T20:55:00.000+08:00"
      },
      {
        "action": "replied",
        "description": "ç®¡ç†å‘˜å›å¤",
        "timestamp": "2025-01-21T21:00:00.000+08:00"
      }
    ]
  }
}
```

---

### 5.12 æŸ¥è¯¢ç³»ç»ŸçŠ¶æ€

**APIè·¯å¾„**: `GET /api/v4/system/status`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢ç³»ç»Ÿè¿è¡ŒçŠ¶æ€å’Œå¥åº·ä¿¡æ¯
- **å…¬å¼€API**, ä¸éœ€è¦Tokenè®¤è¯
- ç”¨äºç›‘æ§å’Œå±•ç¤ºç³»ç»Ÿå¯ç”¨æ€§

**åç«¯å®ç°ä½ç½®**: `routes/v4/system.js` - getSystemStatusç«¯ç‚¹

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "status": "healthy",                       // çŠ¶æ€: healthy/degraded/unhealthy
    "version": "V4.0",
    "environment": "production",               // ç¯å¢ƒ: development/production
    "uptime": 86400,                           // è¿è¡Œæ—¶é—´(ç§’)
    "uptime_text": "1å¤©",                      // è¿è¡Œæ—¶é—´(å¯è¯»)
    "services": {                              // å„æœåŠ¡çŠ¶æ€
      "database": "healthy",
      "redis": "healthy",
      "object_storage": "healthy",
      "websocket": "healthy"
    },
    "statistics": {                            // ç»Ÿè®¡ä¿¡æ¯
      "total_users": 12580,
      "active_users_today": 856,
      "total_draws_today": 2345,
      "system_load": "normal"                  // ç³»ç»Ÿè´Ÿè½½: low/normal/high
    },
    "maintenance": {                           // ç»´æŠ¤ä¿¡æ¯
      "scheduled": false,                      // æ˜¯å¦æœ‰è®¡åˆ’ç»´æŠ¤
      "start_time": null,
      "end_time": null,
      "message": null
    },
    "timestamp": "2025-01-21T20:55:00.000+08:00"
  }
}
```

#### å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹

```javascript
// pages/system-status/system-status.js - ç³»ç»ŸçŠ¶æ€é¡µ

Page({
  data: {
    systemStatus: null
  },
  
  onLoad() {
    this.loadSystemStatus();
  },
  
  async loadSystemStatus() {
    try {
      const res = await wx.request({
        url: 'https://omqktqrtntnn.sealosbja.site/api/v4/system/status',
        method: 'GET'
      });
      
      if (res.data.success) {
        this.setData({
          systemStatus: res.data.data
        });
      }
    } catch (error) {
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      });
    }
  }
});
```

---

## ğŸ’¬ å®¢æœèŠå¤©ç³»ç»ŸAPI(WebSocketå®æ—¶é€šä¿¡)

### ğŸ“– å®¢æœèŠå¤©ç³»ç»Ÿæ¦‚è¿°

**ç³»ç»Ÿç‰¹æ€§**:
- ğŸ”— **WebSocketå®æ—¶æ¨é€**: æ¶ˆæ¯å®æ—¶é€è¾¾,æ— éœ€è½®è¯¢
- ğŸ‘¥ **ä¼šè¯ç®¡ç†**: ç”¨æˆ·ä¸ç®¡ç†å‘˜ä¸€å¯¹ä¸€èŠå¤©
- ğŸ“‹ **å†å²è®°å½•**: å®Œæ•´ä¿å­˜èŠå¤©å†å²
- ğŸ”” **æ¶ˆæ¯é€šçŸ¥**: æ–°æ¶ˆæ¯å®æ—¶é€šçŸ¥åœ¨çº¿ç®¡ç†å‘˜
- ğŸ“Š **æ•°æ®ç»Ÿè®¡**: ä¼šè¯æ•°é‡ã€å“åº”æ—¶é—´ç­‰ç»Ÿè®¡

**åç«¯å®ç°ä½ç½®**: 
- RESTful API: `routes/v4/system.js` - chatç›¸å…³ç«¯ç‚¹
- WebSocketæœåŠ¡: `services/ChatWebSocketService.js`
- æ•°æ®æ¨¡å‹: `models/CustomerServiceSession.js`, `models/ChatMessage.js`

**WebSocketè¿æ¥ä¿¡æ¯**:
- **WebSocket URL**: `wss://omqktqrtntnn.sealosbja.site/ws` (ç”Ÿäº§ç¯å¢ƒ)
- **WebSocket URL**: `ws://localhost:3000/ws` (å¼€å‘ç¯å¢ƒ)
- **è®¤è¯æ–¹å¼**: è¿æ¥æ—¶ä¼ é€’`token`æŸ¥è¯¢å‚æ•°
- **è¿æ¥ç¤ºä¾‹**: `wss://omqktqrtntnn.sealosbja.site/ws?token=your_access_token&user_id=123&role=user`

**å¾®ä¿¡å°ç¨‹åºWebSocketé™åˆ¶**:
- å¾®ä¿¡å°ç¨‹åºä¸æ”¯æŒè‡ªå®šä¹‰HTTPå¤´,éœ€è¦é€šè¿‡URLæŸ¥è¯¢å‚æ•°ä¼ é€’token
- æ¯ä¸ªå°ç¨‹åºåŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªWebSocketè¿æ¥
- éœ€è¦åœ¨`app.json`ä¸­é…ç½®WebSocketåŸŸåç™½åå•

---

### 5.13 åˆ›å»ºå®¢æœä¼šè¯

**APIè·¯å¾„**: `POST /api/v4/system/chat/create`

**åŠŸèƒ½è¯´æ˜**:
- ç”¨æˆ·åˆ›å»ºå®¢æœå’¨è¯¢ä¼šè¯
- **è‡ªåŠ¨æ£€æµ‹**: å¦‚æœå·²æœ‰æ´»è·ƒä¼šè¯,è¿”å›ç°æœ‰ä¼šè¯
- **ä¼šè¯çŠ¶æ€**: åˆ›å»ºæ—¶çŠ¶æ€ä¸º`waiting`(ç­‰å¾…ç®¡ç†å‘˜æ¥å…¥)
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/system.js` - createChatSessionç«¯ç‚¹
**åç«¯æ‰§è¡Œ**: åˆ›å»ºä¼šè¯è®°å½•,ç”Ÿæˆå”¯ä¸€ä¼šè¯ID,åˆå§‹åŒ–ä¼šè¯çŠ¶æ€
**è¿”å›å‰ç«¯**: ä¼šè¯IDã€çŠ¶æ€ã€åˆ›å»ºæ—¶é—´ç­‰ä¼šè¯ä¿¡æ¯
**å‰ç«¯å‘é€**: ç”¨æˆ·ID(ä»Tokenè·å–)ã€é—®é¢˜åˆ†ç±»(å¯é€‰)
**å‰ç«¯æ‰§è¡Œ**: æ¥æ”¶ä¼šè¯ä¿¡æ¯,ä¿å­˜ä¼šè¯ID,è·³è½¬åˆ°èŠå¤©é¡µé¢

#### è¯·æ±‚å‚æ•°

```json
{
  "subject": "å•†å“å…‘æ¢é—®é¢˜",                  // å¯é€‰, ä¼šè¯ä¸»é¢˜/é—®é¢˜åˆ†ç±»
  "initial_message": "æˆ‘æƒ³å’¨è¯¢ä¸€ä¸‹..."         // å¯é€‰, åˆå§‹æ¶ˆæ¯å†…å®¹
}
```

#### æˆåŠŸå“åº”

**æ–°å»ºä¼šè¯**:
```json
{
  "success": true,
  "message": "å®¢æœä¼šè¯å·²åˆ›å»º",
  "data": {
    "session_id": 5001,                       // ä¼šè¯IDï¼ˆåç«¯æ•°æ®åº“ä¸»é”®ï¼‰
    "user_id": 123,                           // ç”¨æˆ·ID
    "admin_id": null,                         // åˆ†é…çš„ç®¡ç†å‘˜ID(åˆå§‹ä¸ºnull)
    "subject": "å•†å“å…‘æ¢é—®é¢˜",                 // ä¼šè¯ä¸»é¢˜
    "status": "waiting",                      // çŠ¶æ€: waiting/active/closed
    "status_text": "ç­‰å¾…ç®¡ç†å‘˜æ¥å…¥",           // çŠ¶æ€æ–‡æœ¬
    "unread_user": 0,                         // ç”¨æˆ·æœªè¯»æ¶ˆæ¯æ•°
    "unread_admin": 0,                        // ç®¡ç†å‘˜æœªè¯»æ¶ˆæ¯æ•°
    "created_at": "2025-10-22T00:06:10.000+08:00",  // åˆ›å»ºæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
    "updated_at": "2025-10-22T00:06:10.000+08:00"   // æ›´æ–°æ—¶é—´
  },
  "timestamp": "2025-10-22T00:06:10.000+08:00"
}
```

**å·²æœ‰æ´»è·ƒä¼šè¯**:
```json
{
  "success": true,
  "message": "å·²æœ‰æ´»è·ƒä¼šè¯",
  "data": {
    "session_id": 4998,
    "user_id": 123,
    "admin_id": 10,                           // å·²åˆ†é…ç®¡ç†å‘˜
    "subject": "ç§¯åˆ†é—®é¢˜å’¨è¯¢",
    "status": "active",                       // æ´»è·ƒçŠ¶æ€
    "status_text": "å¯¹è¯ä¸­",
    "unread_user": 2,                         // æœ‰2æ¡æœªè¯»æ¶ˆæ¯
    "unread_admin": 0,
    "admin_info": {                           // ç®¡ç†å‘˜ä¿¡æ¯
      "id": 10,
      "nickname": "å®¢æœå°ç‹",
      "avatar": "https://..."
    },
    "created_at": "2025-10-22T00:00:00.000+08:00",
    "updated_at": "2025-10-22T00:05:00.000+08:00"
  },
  "timestamp": "2025-10-22T00:06:10.000+08:00"
}
```

#### å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹

```javascript
// pages/customer-service/customer-service.js - å®¢æœèŠå¤©å…¥å£

Page({
  data: {
    sessionId: null,
    sessionStatus: null
  },
  
  /**
   * å¯åŠ¨å®¢æœä¼šè¯
   */
  async startCustomerService() {
    try {
      wx.showLoading({ title: 'è¿æ¥å®¢æœ...' });
      
      // 1. åˆ›å»ºæˆ–è·å–ä¼šè¯
      const res = await wx.request({
        url: 'https://omqktqrtntnn.sealosbja.site/api/v4/system/chat/create',
        method: 'POST',
        header: {
          'Authorization': 'Bearer ' + wx.getStorageSync('access_token'),
          'Content-Type': 'application/json'
        },
        data: {
          subject: 'å’¨è¯¢',                     // å¯é€‰çš„ä¼šè¯ä¸»é¢˜
          initial_message: ''                   // å¯é€‰çš„åˆå§‹æ¶ˆæ¯
        }
      });
      
      wx.hideLoading();
      
      if (res.data.success) {
        const session = res.data.data;
        
        // ä¿å­˜ä¼šè¯ä¿¡æ¯
        this.setData({
          sessionId: session.session_id,
          sessionStatus: session.status
        });
        
        // è·³è½¬åˆ°èŠå¤©é¡µé¢
        wx.navigateTo({
          url: `/pages/chat-room/chat-room?sessionId=${session.session_id}`
        });
      } else {
        wx.showModal({
          title: 'è¿æ¥å¤±è´¥',
          content: res.data.message || 'æ— æ³•è¿æ¥å®¢æœ,è¯·ç¨åé‡è¯•',
          showCancel: false
        });
      }
    } catch (error) {
      wx.hideLoading();
      wx.showToast({
        title: 'ç½‘ç»œè¯·æ±‚å¤±è´¥',
        icon: 'none'
      });
      console.error('åˆ›å»ºå®¢æœä¼šè¯å¤±è´¥:', error);
    }
  }
});
```

---

### 5.14 è·å–ç”¨æˆ·ä¼šè¯åˆ—è¡¨

**APIè·¯å¾„**: `GET /api/v4/system/chat/sessions`

**åŠŸèƒ½è¯´æ˜**:
- è·å–å½“å‰ç”¨æˆ·çš„æ‰€æœ‰å®¢æœä¼šè¯
- **æŒ‰æ›´æ–°æ—¶é—´é™åºæ’åˆ—**
- **åŒ…å«æœªè¯»æ¶ˆæ¯æ•°**
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/system.js` - getUserChatSessionsç«¯ç‚¹
**åç«¯æ‰§è¡Œ**: æŸ¥è¯¢ç”¨æˆ·çš„ä¼šè¯è®°å½•,åŒ…å«ä¼šè¯çŠ¶æ€ã€æœªè¯»æ•°ã€æœ€åæ¶ˆæ¯
**è¿”å›å‰ç«¯**: ä¼šè¯åˆ—è¡¨,æ¯ä¸ªä¼šè¯åŒ…å«åŸºæœ¬ä¿¡æ¯å’Œæœªè¯»æ¶ˆæ¯æ•°
**å‰ç«¯å‘é€**: æ— éœ€é¢å¤–å‚æ•°(ç”¨æˆ·IDä»Tokenè·å–)
**å‰ç«¯æ‰§è¡Œ**: å±•ç¤ºä¼šè¯åˆ—è¡¨,æ ‡è¯†æœªè¯»æ¶ˆæ¯,æ”¯æŒç‚¹å‡»è¿›å…¥èŠå¤©

#### è¯·æ±‚å‚æ•°

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|-------|------|
| `status` | string | - | å¯é€‰,ç­›é€‰çŠ¶æ€: waiting/active/closed |

**ç¤ºä¾‹**: `/api/v4/system/chat/sessions?status=active`

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "sessions": [
      {
        "session_id": 5001,
        "subject": "å•†å“å…‘æ¢é—®é¢˜",
        "status": "active",                   // waiting/active/closed
        "status_text": "å¯¹è¯ä¸­",
        "admin_id": 10,                       // åˆ†é…çš„ç®¡ç†å‘˜ID
        "admin_info": {                       // ç®¡ç†å‘˜ä¿¡æ¯
          "id": 10,
          "nickname": "å®¢æœå°ç‹",
          "avatar": "https://..."
        },
        "unread_user": 3,                     // ç”¨æˆ·æœªè¯»æ¶ˆæ¯æ•°
        "last_message": {                     // æœ€åä¸€æ¡æ¶ˆæ¯
          "content": "å¥½çš„,æˆ‘æ¥å¸®æ‚¨æŸ¥çœ‹ä¸€ä¸‹",
          "sender_type": "admin",             // user/admin
          "created_at": "2025-10-22T00:05:00.000+08:00"
        },
        "created_at": "2025-10-22T00:00:00.000+08:00",
        "updated_at": "2025-10-22T00:05:00.000+08:00"
      },
      {
        "session_id": 4998,
        "subject": "ç§¯åˆ†é—®é¢˜å’¨è¯¢",
        "status": "closed",                   // å·²å…³é—­
        "status_text": "å·²ç»“æŸ",
        "admin_id": 11,
        "admin_info": {
          "id": 11,
          "nickname": "å®¢æœå°æ",
          "avatar": "https://..."
        },
        "unread_user": 0,
        "last_message": {
          "content": "æ„Ÿè°¢æ‚¨çš„å’¨è¯¢,ç¥æ‚¨ä½¿ç”¨æ„‰å¿«!",
          "sender_type": "admin",
          "created_at": "2025-10-21T23:50:00.000+08:00"
        },
        "created_at": "2025-10-21T23:30:00.000+08:00",
        "updated_at": "2025-10-21T23:50:00.000+08:00"
      }
    ],
    "summary": {
      "total": 2,
      "waiting": 0,
      "active": 1,
      "closed": 1,
      "total_unread": 3
    }
  }
}
```

---

### 5.15 è·å–èŠå¤©å†å²è®°å½•

**APIè·¯å¾„**: `GET /api/v4/system/chat/history/:sessionId`

**åŠŸèƒ½è¯´æ˜**:
- è·å–æŒ‡å®šä¼šè¯çš„èŠå¤©æ¶ˆæ¯å†å²
- **æƒé™æ£€æŸ¥**: åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ä¼šè¯æˆ–ç®¡ç†å‘˜æŸ¥çœ‹æ‰€æœ‰
- **è‡ªåŠ¨æ ‡è®°å·²è¯»**: è·å–å†å²åè‡ªåŠ¨æ ‡è®°ç”¨æˆ·æœªè¯»æ¶ˆæ¯ä¸ºå·²è¯»
- **æ”¯æŒåˆ†é¡µ**: æ”¯æŒåŠ è½½æ›´å¤šå†å²æ¶ˆæ¯
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/system.js` - getChatHistoryç«¯ç‚¹
**åç«¯æ‰§è¡Œ**: æŸ¥è¯¢æ¶ˆæ¯è®°å½•,æƒé™éªŒè¯,æ ‡è®°å·²è¯»,åˆ†é¡µåŠ è½½
**è¿”å›å‰ç«¯**: æ¶ˆæ¯åˆ—è¡¨(æŒ‰æ—¶é—´å‡åº),å‘é€è€…ä¿¡æ¯,æ¶ˆæ¯çŠ¶æ€
**å‰ç«¯å‘é€**: ä¼šè¯ID(è·¯å¾„å‚æ•°),åˆ†é¡µå‚æ•°(å¯é€‰)
**å‰ç«¯æ‰§è¡Œ**: å±•ç¤ºèŠå¤©æ¶ˆæ¯,åŒºåˆ†ç”¨æˆ·/ç®¡ç†å‘˜æ¶ˆæ¯,æ”¯æŒæ»šåŠ¨åŠ è½½æ›´å¤š

#### è¯·æ±‚å‚æ•°

**è·¯å¾„å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `sessionId` | number | ä¼šè¯ID |

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|-------|------|
| `page` | number | 1 | é¡µç  |
| `limit` | number | 50 | æ¯é¡µæ¡æ•°(æœ€å¤§100) |

**ç¤ºä¾‹**: `/api/v4/system/chat/history/5001?page=1&limit=50`

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "session": {                              // ä¼šè¯åŸºæœ¬ä¿¡æ¯
      "session_id": 5001,
      "subject": "å•†å“å…‘æ¢é—®é¢˜",
      "status": "active",
      "admin_id": 10
    },
    "messages": [                             // æ¶ˆæ¯åˆ—è¡¨(æŒ‰æ—¶é—´å‡åº)
      {
        "id": 10001,                          // æ¶ˆæ¯ID
        "session_id": 5001,
        "sender_id": 123,                     // å‘é€è€…ID
        "sender_type": "user",                // user/admin
        "sender_info": {                      // å‘é€è€…ä¿¡æ¯
          "id": 123,
          "nickname": "ç”¨æˆ·A",
          "avatar": "https://..."
        },
        "content": "æˆ‘æƒ³å’¨è¯¢ä¸€ä¸‹å•†å“å…‘æ¢é—®é¢˜",  // æ¶ˆæ¯å†…å®¹
        "content_type": "text",               // text/image/file
        "is_read": true,                      // æ˜¯å¦å·²è¯»
        "created_at": "2025-10-22T00:01:00.000+08:00"
      },
      {
        "id": 10002,
        "session_id": 5001,
        "sender_id": 10,
        "sender_type": "admin",               // ç®¡ç†å‘˜æ¶ˆæ¯
        "sender_info": {
          "id": 10,
          "nickname": "å®¢æœå°ç‹",
          "avatar": "https://..."
        },
        "content": "æ‚¨å¥½,è¯·é—®å…·ä½“æ˜¯ä»€ä¹ˆå•†å“å‘¢?",
        "content_type": "text",
        "is_read": true,
        "created_at": "2025-10-22T00:02:00.000+08:00"
      },
      {
        "id": 10003,
        "session_id": 5001,
        "sender_id": 123,
        "sender_type": "user",
        "sender_info": {
          "id": 123,
          "nickname": "ç”¨æˆ·A",
          "avatar": "https://..."
        },
        "content": "æ˜¯iPhone 15 Pro",
        "content_type": "text",
        "is_read": false,                     // ç®¡ç†å‘˜æœªè¯»
        "created_at": "2025-10-22T00:03:00.000+08:00"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 50,
      "total": 3,
      "total_pages": 1,
      "has_next": false,
      "has_prev": false
    }
  }
}
```

#### æƒé™ä¸è¶³å“åº”

```json
{
  "success": false,
  "error": "FORBIDDEN",
  "message": "æ— æƒæŸ¥çœ‹æ­¤ä¼šè¯",
  "timestamp": "2025-10-22T00:06:10.000+08:00"
}
```

---

### 5.16 å‘é€èŠå¤©æ¶ˆæ¯(ç”¨æˆ·ç«¯)

**APIè·¯å¾„**: `POST /api/v4/system/chat/send`

**åŠŸèƒ½è¯´æ˜**:
- ç”¨æˆ·åœ¨ä¼šè¯ä¸­å‘é€æ¶ˆæ¯
- **å®æ—¶æ¨é€**: é€šè¿‡WebSocketæ¨é€ç»™åœ¨çº¿ç®¡ç†å‘˜
- **æœªè¯»è®¡æ•°**: è‡ªåŠ¨å¢åŠ ç®¡ç†å‘˜æœªè¯»æ¶ˆæ¯æ•°
- **éœ€è¦Tokenè®¤è¯**

**åç«¯å®ç°ä½ç½®**: `routes/v4/system.js` - sendChatMessageç«¯ç‚¹
**åç«¯æ‰§è¡Œ**: åˆ›å»ºæ¶ˆæ¯è®°å½•,æ›´æ–°ä¼šè¯çŠ¶æ€,WebSocketæ¨é€ç»™ç®¡ç†å‘˜
**è¿”å›å‰ç«¯**: æ¶ˆæ¯IDã€å‘é€æ—¶é—´ã€æ¶ˆæ¯çŠ¶æ€
**å‰ç«¯å‘é€**: ä¼šè¯IDã€æ¶ˆæ¯å†…å®¹ã€æ¶ˆæ¯ç±»å‹
**å‰ç«¯æ‰§è¡Œ**: å‘é€æ¶ˆæ¯,ç­‰å¾…åç«¯ç¡®è®¤,å±•ç¤ºå‘é€çŠ¶æ€,æ¥æ”¶æ¨é€

#### è¯·æ±‚å‚æ•°

```json
{
  "session_id": 5001,                         // å¿…å¡«, ä¼šè¯ID
  "content": "æ˜¯iPhone 15 Pro",               // å¿…å¡«, æ¶ˆæ¯å†…å®¹
  "content_type": "text"                      // å¯é€‰, æ¶ˆæ¯ç±»å‹: text/image/file, é»˜è®¤text
}
```

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "æ¶ˆæ¯å·²å‘é€",
  "data": {
    "id": 10004,                              // æ¶ˆæ¯ID
    "session_id": 5001,
    "sender_id": 123,
    "sender_type": "user",
    "content": "æ˜¯iPhone 15 Pro",
    "content_type": "text",
    "is_read": false,                         // åˆå§‹æœªè¯»
    "created_at": "2025-10-22T00:06:10.000+08:00",
    "websocket_pushed": true                  // æ˜¯å¦å·²é€šè¿‡WebSocketæ¨é€
  },
  "timestamp": "2025-10-22T00:06:10.000+08:00"
}
```

#### å¤±è´¥å“åº”

**ä¼šè¯å·²å…³é—­**:
```json
{
  "success": false,
  "error": "SESSION_CLOSED",
  "message": "ä¼šè¯å·²å…³é—­,æ— æ³•å‘é€æ¶ˆæ¯",
  "timestamp": "2025-10-22T00:06:10.000+08:00"
}
```

**ä¼šè¯ä¸å­˜åœ¨**:
```json
{
  "success": false,
  "error": "NOT_FOUND",
  "message": "ä¼šè¯ä¸å­˜åœ¨",
  "timestamp": "2025-10-22T00:06:10.000+08:00"
}
```

#### å¾®ä¿¡å°ç¨‹åºå®Œæ•´èŠå¤©å®¤ç¤ºä¾‹

```javascript
// pages/chat-room/chat-room.js - èŠå¤©å®¤é¡µé¢

Page({
  data: {
    sessionId: null,                          // ä¼šè¯ID
    messages: [],                             // æ¶ˆæ¯åˆ—è¡¨
    inputText: '',                            // è¾“å…¥æ¡†å†…å®¹
    socketConnected: false,                   // WebSocketè¿æ¥çŠ¶æ€
    scrollToBottom: false                     // æ˜¯å¦æ»šåŠ¨åˆ°åº•éƒ¨
  },
  
  socketTask: null,                           // WebSocketä»»åŠ¡å¯¹è±¡
  
  /**
   * é¡µé¢åŠ è½½
   */
  onLoad(options) {
    const { sessionId } = options;
    
    if (!sessionId) {
      wx.showToast({
        title: 'ä¼šè¯IDç¼ºå¤±',
        icon: 'none'
      });
      setTimeout(() => wx.navigateBack(), 1500);
      return;
    }
    
    this.setData({ sessionId });
    
    // åŠ è½½èŠå¤©å†å²
    this.loadChatHistory();
    
    // è¿æ¥WebSocket
    this.connectWebSocket();
  },
  
  /**
   * é¡µé¢å¸è½½æ—¶å…³é—­WebSocket
   */
  onUnload() {
    this.disconnectWebSocket();
  },
  
  /**
   * åŠ è½½èŠå¤©å†å²
   */
  async loadChatHistory() {
    try {
      wx.showLoading({ title: 'åŠ è½½ä¸­...' });
      
      const res = await wx.request({
        url: `https://omqktqrtntnn.sealosbja.site/api/v4/system/chat/history/${this.data.sessionId}`,
        method: 'GET',
        header: {
          'Authorization': 'Bearer ' + wx.getStorageSync('access_token')
        }
      });
      
      wx.hideLoading();
      
      if (res.data.success) {
        this.setData({
          messages: res.data.data.messages,
          scrollToBottom: true
        });
      } else {
        wx.showToast({
          title: res.data.message || 'åŠ è½½å¤±è´¥',
          icon: 'none'
        });
      }
    } catch (error) {
      wx.hideLoading();
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      });
      console.error('åŠ è½½èŠå¤©å†å²å¤±è´¥:', error);
    }
  },
  
  /**
   * è¿æ¥WebSocket
   */
  connectWebSocket() {
    const token = wx.getStorageSync('access_token');
    const userInfo = wx.getStorageSync('user_info');
    
    if (!token || !userInfo) {
      console.error('ç¼ºå°‘è®¤è¯ä¿¡æ¯,æ— æ³•è¿æ¥WebSocket');
      return;
    }
    
    // åˆ›å»ºWebSocketè¿æ¥
    this.socketTask = wx.connectSocket({
      url: `wss://omqktqrtntnn.sealosbja.site/ws?token=${token}&user_id=${userInfo.user_id}&role=user`,
      success: () => {
        console.log('WebSocketè¿æ¥è¯·æ±‚å·²å‘é€');
      },
      fail: (error) => {
        console.error('WebSocketè¿æ¥å¤±è´¥:', error);
        wx.showToast({
          title: 'è¿æ¥å¤±è´¥',
          icon: 'none'
        });
      }
    });
    
    // ç›‘å¬WebSocketè¿æ¥æ‰“å¼€
    this.socketTask.onOpen(() => {
      console.log('WebSocketè¿æ¥å·²å»ºç«‹');
      this.setData({ socketConnected: true });
      
      wx.showToast({
        title: 'å·²è¿æ¥',
        icon: 'success',
        duration: 1000
      });
    });
    
    // ç›‘å¬WebSocketæ¥æ”¶æ¶ˆæ¯
    this.socketTask.onMessage((res) => {
      console.log('æ”¶åˆ°WebSocketæ¶ˆæ¯:', res.data);
      
      try {
        const message = JSON.parse(res.data);
        
        // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯
        if (message.type === 'chat_message') {
          // æ–°æ¶ˆæ¯æ¨é€
          this.handleNewMessage(message.data);
        } else if (message.type === 'session_assigned') {
          // ä¼šè¯å·²åˆ†é…ç»™ç®¡ç†å‘˜
          wx.showToast({
            title: 'å®¢æœå·²æ¥å…¥',
            icon: 'success'
          });
        } else if (message.type === 'session_closed') {
          // ä¼šè¯å·²å…³é—­
          wx.showModal({
            title: 'ä¼šè¯å·²ç»“æŸ',
            content: 'å®¢æœå·²å…³é—­æ­¤ä¼šè¯',
            showCancel: false,
            success: () => {
              wx.navigateBack();
            }
          });
        }
      } catch (error) {
        console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', error);
      }
    });
    
    // ç›‘å¬WebSocketé”™è¯¯
    this.socketTask.onError((error) => {
      console.error('WebSocketé”™è¯¯:', error);
      this.setData({ socketConnected: false });
    });
    
    // ç›‘å¬WebSocketå…³é—­
    this.socketTask.onClose((res) => {
      console.log('WebSocketè¿æ¥å·²å…³é—­:', res);
      this.setData({ socketConnected: false });
      
      // å¦‚æœä¸æ˜¯æ­£å¸¸å…³é—­,å°è¯•é‡è¿
      if (res.code !== 1000) {
        console.log('å°è¯•é‡æ–°è¿æ¥WebSocket...');
        setTimeout(() => {
          this.connectWebSocket();
        }, 3000);
      }
    });
  },
  
  /**
   * æ–­å¼€WebSocketè¿æ¥
   */
  disconnectWebSocket() {
    if (this.socketTask) {
      this.socketTask.close({
        code: 1000,
        reason: 'ç”¨æˆ·ä¸»åŠ¨å…³é—­'
      });
      this.socketTask = null;
    }
  },
  
  /**
   * å¤„ç†æ–°æ¶ˆæ¯æ¨é€
   */
  handleNewMessage(message) {
    // æ·»åŠ æ–°æ¶ˆæ¯åˆ°æ¶ˆæ¯åˆ—è¡¨
    const messages = [...this.data.messages, message];
    
    this.setData({
      messages,
      scrollToBottom: true
    });
    
    // æ’­æ”¾æ¶ˆæ¯æç¤ºéŸ³(å¯é€‰)
    // wx.vibrateShort();
  },
  
  /**
   * è¾“å…¥æ¡†å†…å®¹å˜åŒ–
   */
  onInputChange(e) {
    this.setData({
      inputText: e.detail.value
    });
  },
  
  /**
   * å‘é€æ¶ˆæ¯
   */
  async sendMessage() {
    const { inputText, sessionId } = this.data;
    
    // éªŒè¯è¾“å…¥
    if (!inputText || !inputText.trim()) {
      wx.showToast({
        title: 'è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹',
        icon: 'none'
      });
      return;
    }
    
    try {
      const res = await wx.request({
        url: 'https://omqktqrtntnn.sealosbja.site/api/v4/system/chat/send',
        method: 'POST',
        header: {
          'Authorization': 'Bearer ' + wx.getStorageSync('access_token'),
          'Content-Type': 'application/json'
        },
        data: {
          session_id: sessionId,
          content: inputText.trim(),
          content_type: 'text'
        }
      });
      
      if (res.data.success) {
        // æ¸…ç©ºè¾“å…¥æ¡†
        this.setData({
          inputText: ''
        });
        
        // æ·»åŠ æ¶ˆæ¯åˆ°åˆ—è¡¨
        const newMessage = res.data.data;
        const messages = [...this.data.messages, {
          id: newMessage.id,
          session_id: newMessage.session_id,
          sender_id: newMessage.sender_id,
          sender_type: 'user',
          sender_info: wx.getStorageSync('user_info'),
          content: newMessage.content,
          content_type: 'text',
          is_read: false,
          created_at: newMessage.created_at
        }];
        
        this.setData({
          messages,
          scrollToBottom: true
        });
      } else {
        wx.showToast({
          title: res.data.message || 'å‘é€å¤±è´¥',
          icon: 'none'
        });
      }
    } catch (error) {
      wx.showToast({
        title: 'å‘é€å¤±è´¥',
        icon: 'none'
      });
      console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
    }
  }
});
```

```xml
<!-- pages/chat-room/chat-room.wxml - èŠå¤©å®¤UI -->
<view class="chat-room">
  <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
  <view class="status-bar">
    <text class="status-icon">{{socketConnected ? 'â—' : 'â—‹'}}</text>
    <text class="status-text">{{socketConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}}</text>
  </view>
  
  <!-- æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view 
    class="message-list" 
    scroll-y 
    scroll-into-view="{{scrollToBottom ? 'msg-' + (messages.length - 1) : ''}}"
  >
    <view 
      wx:for="{{messages}}" 
      wx:key="id" 
      id="msg-{{index}}"
      class="message-item {{item.sender_type === 'user' ? 'user-message' : 'admin-message'}}"
    >
      <image class="avatar" src="{{item.sender_info.avatar || '/images/default-avatar.png'}}"></image>
      <view class="message-content">
        <text class="sender-name">{{item.sender_info.nickname}}</text>
        <view class="message-bubble">
          <text>{{item.content}}</text>
        </view>
        <text class="message-time">{{item.created_at}}</text>
      </view>
    </view>
  </scroll-view>
  
  <!-- è¾“å…¥æ¡† -->
  <view class="input-bar">
    <input 
      class="message-input" 
      type="text" 
      placeholder="è¯·è¾“å…¥æ¶ˆæ¯..." 
      value="{{inputText}}"
      bindinput="onInputChange"
      confirm-type="send"
      bindconfirm="sendMessage"
    />
    <button class="send-btn" type="primary" size="mini" bindtap="sendMessage">
      å‘é€
    </button>
  </view>
</view>
```

---

### 5.17 ç®¡ç†å‘˜å›å¤æ¶ˆæ¯

**APIè·¯å¾„**: `POST /api/v4/system/chat/admin-reply`

**åŠŸèƒ½è¯´æ˜**:
- **ä»…ç®¡ç†å‘˜å¯ç”¨**
- ç®¡ç†å‘˜å‘ç”¨æˆ·å›å¤æ¶ˆæ¯
- **å®æ—¶æ¨é€**: é€šè¿‡WebSocketæ¨é€ç»™åœ¨çº¿ç”¨æˆ·
- **æœªè¯»è®¡æ•°**: è‡ªåŠ¨å¢åŠ ç”¨æˆ·æœªè¯»æ¶ˆæ¯æ•°
- **éœ€è¦ç®¡ç†å‘˜æƒé™**

**åç«¯å®ç°ä½ç½®**: `routes/v4/system.js` - adminReplyChatMessageç«¯ç‚¹
**åç«¯æ‰§è¡Œ**: åˆ›å»ºç®¡ç†å‘˜æ¶ˆæ¯,æ›´æ–°ä¼šè¯çŠ¶æ€,WebSocketæ¨é€ç»™ç”¨æˆ·
**è¿”å›å‰ç«¯**: æ¶ˆæ¯IDã€å‘é€æ—¶é—´ã€æ¨é€çŠ¶æ€
**å‰ç«¯å‘é€**: ä¼šè¯IDã€æ¶ˆæ¯å†…å®¹(ç®¡ç†å‘˜åå°)
**å‰ç«¯æ‰§è¡Œ**: ç®¡ç†å‘˜å‘é€æ¶ˆæ¯,å±•ç¤ºåœ¨ç®¡ç†ç«¯èŠå¤©ç•Œé¢

#### è¯·æ±‚å‚æ•°

```json
{
  "session_id": 5001,                         // å¿…å¡«, ä¼šè¯ID
  "content": "å¥½çš„,æˆ‘æ¥å¸®æ‚¨æŸ¥çœ‹ä¸€ä¸‹",           // å¿…å¡«, æ¶ˆæ¯å†…å®¹
  "content_type": "text"                      // å¯é€‰, æ¶ˆæ¯ç±»å‹, é»˜è®¤text
}
```

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "å›å¤å·²å‘é€",
  "data": {
    "id": 10005,
    "session_id": 5001,
    "sender_id": 10,                          // ç®¡ç†å‘˜ID
    "sender_type": "admin",
    "content": "å¥½çš„,æˆ‘æ¥å¸®æ‚¨æŸ¥çœ‹ä¸€ä¸‹",
    "content_type": "text",
    "is_read": false,
    "created_at": "2025-10-22T00:06:10.000+08:00",
    "websocket_pushed": true                  // å·²æ¨é€ç»™ç”¨æˆ·
  },
  "timestamp": "2025-10-22T00:06:10.000+08:00"
}
```

---

### 5.18 ç®¡ç†å‘˜æŸ¥çœ‹æ‰€æœ‰ä¼šè¯

**APIè·¯å¾„**: `GET /api/v4/unified-engine/admin/chat/sessions`

**åŠŸèƒ½è¯´æ˜**:
- **ä»…ç®¡ç†å‘˜å¯ç”¨**
- æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·çš„å®¢æœä¼šè¯
- **æ”¯æŒç­›é€‰**: æŒ‰çŠ¶æ€ã€åˆ†é…çŠ¶æ€ç­›é€‰
- **æ”¯æŒåˆ†é¡µ**
- **éœ€è¦ç®¡ç†å‘˜æƒé™**

**åç«¯å®ç°ä½ç½®**: `routes/v4/system.js` - getAdminChatSessionsç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|-------|------|
| `page` | number | 1 | é¡µç  |
| `limit` | number | 20 | æ¯é¡µæ¡æ•° |
| `status` | string | - | å¯é€‰,ç­›é€‰çŠ¶æ€: waiting/active/closed |
| `assigned` | boolean | - | å¯é€‰,ç­›é€‰å·²åˆ†é…/æœªåˆ†é…ä¼šè¯ |
| `admin_id` | number | - | å¯é€‰,ç­›é€‰æŒ‡å®šç®¡ç†å‘˜çš„ä¼šè¯ |

**ç¤ºä¾‹**: `/api/v4/unified-engine/admin/chat/sessions?status=waiting&assigned=false`

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "sessions": [
      {
        "session_id": 5002,
        "user_id": 125,
        "user_info": {                        // ç”¨æˆ·ä¿¡æ¯
          "id": 125,
          "nickname": "ç”¨æˆ·B",
          "mobile": "138****0002",            // æ‰‹æœºå·è„±æ•
          "avatar": "https://..."
        },
        "subject": "ç§¯åˆ†å……å€¼é—®é¢˜",
        "status": "waiting",                  // ç­‰å¾…æ¥å…¥
        "status_text": "ç­‰å¾…ä¸­",
        "admin_id": null,                     // æœªåˆ†é…
        "unread_admin": 5,                    // ç®¡ç†å‘˜æœªè¯»æ•°
        "last_message": {
          "content": "æœ‰äººå—?",
          "sender_type": "user",
          "created_at": "2025-10-22T00:10:00.000+08:00"
        },
        "created_at": "2025-10-22T00:05:00.000+08:00",
        "updated_at": "2025-10-22T00:10:00.000+08:00"
      },
      {
        "session_id": 5001,
        "user_id": 123,
        "user_info": {
          "id": 123,
          "nickname": "ç”¨æˆ·A",
          "mobile": "138****0001",
          "avatar": "https://..."
        },
        "subject": "å•†å“å…‘æ¢é—®é¢˜",
        "status": "active",                   // å¯¹è¯ä¸­
        "status_text": "å¯¹è¯ä¸­",
        "admin_id": 10,                       // å·²åˆ†é…ç»™ç®¡ç†å‘˜10
        "admin_info": {
          "id": 10,
          "nickname": "å®¢æœå°ç‹"
        },
        "unread_admin": 2,
        "last_message": {
          "content": "æ˜¯iPhone 15 Pro",
          "sender_type": "user",
          "created_at": "2025-10-22T00:06:10.000+08:00"
        },
        "created_at": "2025-10-22T00:00:00.000+08:00",
        "updated_at": "2025-10-22T00:06:10.000+08:00"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 2,
      "total_pages": 1
    },
    "summary": {
      "total": 50,
      "waiting": 5,
      "active": 25,
      "closed": 20,
      "total_unread": 15
    }
  }
}
```

---

### 5.19 ç®¡ç†å‘˜åˆ†é…ä¼šè¯

**APIè·¯å¾„**: `PUT /api/v4/unified-engine/admin/chat/sessions/:sessionId/assign`

**åŠŸèƒ½è¯´æ˜**:
- **ä»…ç®¡ç†å‘˜å¯ç”¨**
- å°†ä¼šè¯åˆ†é…ç»™æŒ‡å®šç®¡ç†å‘˜(åŒ…æ‹¬è‡ªå·±)
- **è‡ªåŠ¨æ›´æ–°çŠ¶æ€**: ä»`waiting`æ›´æ–°ä¸º`active`
- **WebSocketé€šçŸ¥**: é€šçŸ¥ç”¨æˆ·å·²æ¥å…¥
- **éœ€è¦ç®¡ç†å‘˜æƒé™**

**åç«¯å®ç°ä½ç½®**: `routes/v4/system.js` - assignChatSessionç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**è·¯å¾„å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `sessionId` | number | ä¼šè¯ID |

**Bodyå‚æ•°**:
```json
{
  "admin_id": 10                              // å¿…å¡«, åˆ†é…ç»™çš„ç®¡ç†å‘˜ID
}
```

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "ä¼šè¯å·²åˆ†é…",
  "data": {
    "session_id": 5002,
    "admin_id": 10,
    "status": "active",                       // çŠ¶æ€å·²æ›´æ–°
    "assigned_at": "2025-10-22T00:15:00.000+08:00"
  }
}
```

---

### 5.20 ç®¡ç†å‘˜å…³é—­ä¼šè¯

**APIè·¯å¾„**: `PUT /api/v4/unified-engine/admin/chat/sessions/:sessionId/close`

**åŠŸèƒ½è¯´æ˜**:
- **ä»…ç®¡ç†å‘˜å¯ç”¨**
- å…³é—­å®¢æœä¼šè¯
- **WebSocketé€šçŸ¥**: é€šçŸ¥ç”¨æˆ·ä¼šè¯å·²ç»“æŸ
- **éœ€è¦ç®¡ç†å‘˜æƒé™**

**åç«¯å®ç°ä½ç½®**: `routes/v4/system.js` - closeChatSessionç«¯ç‚¹

#### è¯·æ±‚å‚æ•°

**è·¯å¾„å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `sessionId` | number | ä¼šè¯ID |

**Bodyå‚æ•°**(å¯é€‰):
```json
{
  "close_reason": "é—®é¢˜å·²è§£å†³"                 // å¯é€‰, å…³é—­åŸå› 
}
```

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "ä¼šè¯å·²å…³é—­",
  "data": {
    "session_id": 5001,
    "status": "closed",
    "closed_at": "2025-10-22T00:20:00.000+08:00",
    "close_reason": "é—®é¢˜å·²è§£å†³"
  }
}
```

---

### 5.21 ç®¡ç†å‘˜èŠå¤©ç»Ÿè®¡

**APIè·¯å¾„**: `GET /api/v4/unified-engine/admin/chat/stats`

**åŠŸèƒ½è¯´æ˜**:
- **ä»…ç®¡ç†å‘˜å¯ç”¨**
- è·å–å®¢æœèŠå¤©ç³»ç»Ÿçš„ç»Ÿè®¡æ•°æ®
- **éœ€è¦ç®¡ç†å‘˜æƒé™**

**åç«¯å®ç°ä½ç½®**: `routes/v4/system.js` - getAdminChatStatsç«¯ç‚¹

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "overview": {
      "total_sessions": 156,                  // æ€»ä¼šè¯æ•°
      "today_sessions": 23,                   // ä»Šæ—¥ä¼šè¯æ•°
      "waiting_sessions": 5,                  // ç­‰å¾…ä¸­ä¼šè¯æ•°
      "active_sessions": 18,                  // è¿›è¡Œä¸­ä¼šè¯æ•°
      "closed_sessions": 133                  // å·²å…³é—­ä¼šè¯æ•°
    },
    "response_time": {
      "average": 120,                         // å¹³å‡å“åº”æ—¶é—´(ç§’)
      "median": 90                            // ä¸­ä½æ•°å“åº”æ—¶é—´(ç§’)
    },
    "admin_performance": [                    // ç®¡ç†å‘˜å·¥ä½œé‡
      {
        "admin_id": 10,
        "nickname": "å®¢æœå°ç‹",
        "assigned_sessions": 45,
        "closed_sessions": 40,
        "average_response_time": 95
      },
      {
        "admin_id": 11,
        "nickname": "å®¢æœå°æ",
        "assigned_sessions": 38,
        "closed_sessions": 35,
        "average_response_time": 110
      }
    ],
    "hourly_distribution": [                  // æ¯å°æ—¶åˆ†å¸ƒ
      {
        "hour": 0,
        "count": 2
      },
      {
        "hour": 1,
        "count": 1
      }
      // ... å…±24å°æ—¶æ•°æ®
    ]
  }
}
```

---

### 5.22 WebSocketæœåŠ¡çŠ¶æ€

**APIè·¯å¾„**: `GET /api/v4/system/chat/ws-status`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢WebSocketæœåŠ¡è¿è¡ŒçŠ¶æ€
- **å…¬å¼€API**, ä¸éœ€è¦Tokenè®¤è¯
- ç”¨äºå‰ç«¯æ£€æµ‹WebSocketæœåŠ¡å¯ç”¨æ€§

**åç«¯å®ç°ä½ç½®**: `routes/v4/system.js` - getWebSocketStatusç«¯ç‚¹

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "status": "running",                      // running/stopped
    "connected_clients": 45,                  // å½“å‰è¿æ¥æ•°
    "active_users": 28,                       // æ´»è·ƒç”¨æˆ·æ•°
    "active_admins": 5,                       // æ´»è·ƒç®¡ç†å‘˜æ•°
    "uptime": 86400,                          // WebSocketæœåŠ¡è¿è¡Œæ—¶é—´(ç§’)
    "version": "1.0.0"
  }
}
```

---

### ğŸ’¡ å®¢æœèŠå¤©ç³»ç»Ÿå¼€å‘å»ºè®®

#### å‰ç«¯å¼€å‘è¦ç‚¹

1. **WebSocketè¿æ¥ç®¡ç†**:
   - é¡µé¢åŠ è½½æ—¶è¿æ¥WebSocket
   - é¡µé¢å¸è½½æ—¶å…³é—­è¿æ¥
   - æ–­çº¿è‡ªåŠ¨é‡è¿(3ç§’å»¶è¿Ÿ)
   - è¿æ¥çŠ¶æ€å®æ—¶æ˜¾ç¤º

2. **æ¶ˆæ¯å±•ç¤ºä¼˜åŒ–**:
   - ç”¨æˆ·æ¶ˆæ¯å±…å³,ç®¡ç†å‘˜æ¶ˆæ¯å±…å·¦
   - æ˜¾ç¤ºå‘é€è€…å¤´åƒå’Œæ˜µç§°
   - æ˜¾ç¤ºæ¶ˆæ¯æ—¶é—´(ç›¸å¯¹æ—¶é—´æˆ–ç»å¯¹æ—¶é—´)
   - æ–°æ¶ˆæ¯è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨

3. **å®æ—¶æ¨é€å¤„ç†**:
   - ç›‘å¬WebSocketæ¶ˆæ¯äº‹ä»¶
   - æ ¹æ®æ¶ˆæ¯ç±»å‹æ‰§è¡Œä¸åŒå¤„ç†
   - æ–°æ¶ˆæ¯åˆ°è¾¾æ—¶æ’­æ”¾æç¤ºéŸ³(å¯é€‰)
   - æ˜¾ç¤º"å¯¹æ–¹æ­£åœ¨è¾“å…¥..."çŠ¶æ€(é«˜çº§åŠŸèƒ½)

4. **ä¼šè¯åˆ—è¡¨ç®¡ç†**:
   - æ˜¾ç¤ºæ‰€æœ‰ä¼šè¯,åŒºåˆ†çŠ¶æ€
   - æœªè¯»æ¶ˆæ¯æ•°çº¢ç‚¹æç¤º
   - æœ€åæ¶ˆæ¯å†…å®¹é¢„è§ˆ
   - æ”¯æŒä¸‹æ‹‰åˆ·æ–°å’Œä¸Šæ‹‰åŠ è½½

5. **é”™è¯¯å¤„ç†**:
   - ç½‘ç»œè¯·æ±‚å¤±è´¥å‹å¥½æç¤º
   - WebSocketæ–­çº¿æç¤ºç”¨æˆ·
   - ä¼šè¯å…³é—­åç¦ç”¨è¾“å…¥
   - æ¶ˆæ¯å‘é€å¤±è´¥é‡è¯•æœºåˆ¶

#### ç®¡ç†å‘˜åå°å»ºè®®

1. **ä¼šè¯ç®¡ç†**:
   - å®æ—¶æ˜¾ç¤ºç­‰å¾…æ¥å…¥çš„ä¼šè¯
   - å¿«é€Ÿåˆ†é…ä¼šè¯ç»™è‡ªå·±
   - æ”¯æŒå¤šä¼šè¯å¹¶è¡Œå¤„ç†
   - ä¸€é”®å…³é—­ä¼šè¯åŠŸèƒ½

2. **æ¶ˆæ¯å¤„ç†**:
   - å¿«æ·å›å¤æ¨¡æ¿
   - æ¶ˆæ¯å·²è¯»æœªè¯»æ ‡è®°
   - æ”¯æŒå‘é€å›¾ç‰‡å’Œæ–‡ä»¶(æ‰©å±•åŠŸèƒ½)
   - å†å²æ¶ˆæ¯å¿«é€ŸæŸ¥çœ‹

3. **ç»Ÿè®¡ç›‘æ§**:
   - å®æ—¶ä¼šè¯æ•°é‡ç»Ÿè®¡
   - å¹³å‡å“åº”æ—¶é—´ç›‘æ§
   - ä¸ªäººå·¥ä½œé‡ç»Ÿè®¡
   - ç”¨æˆ·æ»¡æ„åº¦è¯„ä»·(æ‰©å±•åŠŸèƒ½)

---

**ğŸ“„ WebSocketå®¢æœèŠå¤©ç³»ç»Ÿå®Œæ•´è¯´æ˜å·²è¡¥å……å®Œæ¯•**


---


**æ–‡æ¡£éƒ¨åˆ†**: ç¬¬6éƒ¨åˆ† - ç®¡ç†åå°æ¨¡å—(ç®¡ç†å‘˜ä¸“ç”¨)
**åˆ›å»ºæ—¶é—´**: 2025å¹´01æœˆ21æ—¥ (åŒ—äº¬æ—¶é—´)
**åŸºäºå®é™…ä»£ç éªŒè¯**: âœ…

---

## ğŸ“– æ¨¡å—æ¦‚è¿°

### ç®¡ç†åå°æ¨¡å—(`/api/v4/unified-engine/admin`)
æ‰€æœ‰ç®¡ç†åå°APIéƒ½éœ€è¦**ç®¡ç†å‘˜æƒé™**(`role_level >= 100`),åŒ…æ‹¬:
- ğŸ‘¤ ç”¨æˆ·ç®¡ç†
- ğŸ° æŠ½å¥–æ´»åŠ¨ç®¡ç†
- ğŸ å¥–å“æ± ç®¡ç†
- âš™ï¸ ç³»ç»Ÿé…ç½®ç®¡ç†
- ğŸ“Š æ•°æ®åˆ†æç»Ÿè®¡
- ğŸ” å®¡è®¡æ—¥å¿—ç®¡ç†
- ğŸ” æ´»åŠ¨æƒé™ç®¡ç†

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/admin/` (æ¨¡å—åŒ–ç®¡ç†)

---

## ğŸ”‘ ç®¡ç†åå°è®¿é—®è¯´æ˜

### æƒé™è¦æ±‚
- **å¿…éœ€**: ç®¡ç†å‘˜è§’è‰² (`role_level >= 100`)
- **Token**: å¿…é¡»æºå¸¦æœ‰æ•ˆçš„access_token
- **å¤±è´¥å“åº”**: æ— æƒé™æ—¶è¿”å›403é”™è¯¯

### ç»Ÿä¸€æƒé™éªŒè¯å“åº”

**æƒé™ä¸è¶³**:
```json
{
  "success": false,
  "error": "FORBIDDEN",
  "message": "éœ€è¦ç®¡ç†å‘˜æƒé™",
  "timestamp": "2025-01-21T22:00:00.000+08:00"
}
```

---

## ğŸ‘¤ ç”¨æˆ·ç®¡ç†API

### 6.1 æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨

**APIè·¯å¾„**: `GET /api/v4/unified-engine/admin/users`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨
- **æ”¯æŒåˆ†é¡µå’Œæœç´¢**
- **å®Œæ•´æ•°æ®**: ç®¡ç†å‘˜å¯è§æ‰€æœ‰å­—æ®µ

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/admin/user-management.js`

#### è¯·æ±‚å‚æ•°

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|-------|------|
| `page` | number | 1 | é¡µç  |
| `limit` | number | 20 | æ¯é¡µæ¡æ•° |
| `search` | string | - | å¯é€‰,æœç´¢æ‰‹æœºå·/æ˜µç§°/ID |
| `status` | string | - | å¯é€‰,ç­›é€‰çŠ¶æ€: active/inactive/banned |
| `sort_by` | string | `created_at` | æ’åºå­—æ®µ |
| `sort_order` | string | `desc` | æ’åºæ–¹å‘: asc/desc |

**ç¤ºä¾‹**: `/api/v4/unified-engine/admin/users?page=1&limit=20&search=138&status=active`

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 123,
        "mobile": "13800138000",             // ç®¡ç†å‘˜å¯è§å®Œæ•´æ‰‹æœºå·
        "real_name": "å¼ ä¸‰",                 // çœŸå®å§“å
        "nickname": "ç”¨æˆ·A",
        "avatar": "https://...",
        "email": "user@example.com",
        "gender": "male",
        "birthday": "1990-01-01",
        "address": "åŒ—äº¬å¸‚æœé˜³åŒº",
        "roles": [                           // ç”¨æˆ·è§’è‰²
          {
            "id": 2,
            "role_name": "user",
            "role_level": 0
          }
        ],
        "role_based_admin": false,
        "status": "active",                  // active/inactive/banned
        "points": {
          "current": 990,
          "total_earned": 5600,
          "total_spent": 4610
        },
        "statistics": {
          "total_draws": 156,
          "total_wins": 34,
          "total_uploads": 67
        },
        "created_at": "2025-01-01T10:00:00.000+08:00",
        "last_login_at": "2025-01-21T22:00:00.000+08:00"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 12580,
      "total_pages": 629,
      "has_next": true,
      "has_prev": false
    },
    "summary": {
      "total_users": 12580,
      "active_users": 11234,
      "inactive_users": 1200,
      "banned_users": 146,
      "new_users_today": 23
    }
  }
}
```

---

### 6.2 æŸ¥è¯¢ç”¨æˆ·è¯¦æƒ…

**APIè·¯å¾„**: `GET /api/v4/unified-engine/admin/users/:user_id`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢æŒ‡å®šç”¨æˆ·çš„å®Œæ•´è¯¦æƒ…
- **åŒ…å«**: åŸºæœ¬ä¿¡æ¯ã€è§’è‰²æƒé™ã€ç§¯åˆ†ç»Ÿè®¡ã€æ´»åŠ¨æ•°æ®

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/admin/user-management.js`

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "user": {
      "id": 123,
      "mobile": "13800138000",
      "real_name": "å¼ ä¸‰",
      "nickname": "ç”¨æˆ·A",
      "avatar": "https://...",
      "email": "user@example.com",
      "status": "active",
      "created_at": "2025-01-01T10:00:00.000+08:00",
      "last_login_at": "2025-01-21T22:00:00.000+08:00"
    },
    "roles_and_permissions": {
      "roles": [
        {
          "id": 2,
          "role_name": "user",
          "description": "æ™®é€šç”¨æˆ·",
          "role_level": 0
        },
        {
          "id": 15,
          "role_name": "campaign_LUCKY2025",
          "description": "å¯å‚ä¸LUCKY2025æ´»åŠ¨",
          "role_level": 0
        }
      ],
      "all_permissions": [
        "lottery:draw",
        "inventory:view",
        "points:view"
      ]
    },
    "points_data": {
      "current_points": 990,
      "total_earned": 5600,
      "total_spent": 4610,
      "recent_transactions": [
        {
          "type": "earn",
          "amount": 500,
          "source": "lottery",
          "created_at": "2025-01-21T20:35:00.000+08:00"
        }
      ]
    },
    "lottery_data": {
      "total_draws": 156,
      "total_wins": 34,
      "win_rate": "21.79%",
      "favorite_campaign": "LUCKY2025",
      "last_draw_at": "2025-01-21T20:35:00.000+08:00"
    },
    "inventory_data": {
      "total_items": 35,
      "unused_items": 32,
      "used_items": 3,
      "total_value": 25500
    },
    "upload_data": {
      "total_uploads": 67,
      "approved_count": 52,
      "approval_rate": "77.61%",
      "total_points_earned": 2600
    }
  }
}
```

---

### 6.3 æ›´æ–°ç”¨æˆ·çŠ¶æ€

**APIè·¯å¾„**: `PUT /api/v4/unified-engine/admin/users/:user_id/status`

**åŠŸèƒ½è¯´æ˜**:
- ç®¡ç†å‘˜ä¿®æ”¹ç”¨æˆ·çŠ¶æ€(æ¿€æ´»/åœç”¨/å°ç¦)

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/admin/user-management.js`

#### è¯·æ±‚å‚æ•°

**è¯·æ±‚ä½“**:
```json
{
  "status": "banned",                        // å¿…å¡«, active/inactive/banned
  "reason": "è¿åç”¨æˆ·åè®®"                   // å¯é€‰, æ“ä½œåŸå› 
}
```

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "ç”¨æˆ·çŠ¶æ€å·²æ›´æ–°",
  "data": {
    "user_id": 123,
    "old_status": "active",
    "new_status": "banned",
    "reason": "è¿åç”¨æˆ·åè®®",
    "updated_by": 1,                         // æ“ä½œç®¡ç†å‘˜ID
    "updated_at": "2025-01-21T22:05:00.000+08:00"
  }
}
```

---

### 6.4 åˆ†é…ç”¨æˆ·è§’è‰²

**APIè·¯å¾„**: `POST /api/v4/unified-engine/admin/users/:user_id/roles`

**åŠŸèƒ½è¯´æ˜**:
- ä¸ºç”¨æˆ·æ·»åŠ è§’è‰²(åŒ…æ‹¬æ´»åŠ¨æƒé™è§’è‰²)

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/admin/user-management.js`

#### è¯·æ±‚å‚æ•°

**è¯·æ±‚ä½“**:
```json
{
  "role_id": 15,                             // å¯é€‰, è§’è‰²ID
  "role_name": "campaign_LUCKY2025"          // å¯é€‰, è§’è‰²åç§°(äºŒé€‰ä¸€)
}
```

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "è§’è‰²å·²åˆ†é…",
  "data": {
    "user_id": 123,
    "role": {
      "id": 15,
      "role_name": "campaign_LUCKY2025",
      "description": "å¯å‚ä¸LUCKY2025æ´»åŠ¨"
    },
    "assigned_by": 1,
    "assigned_at": "2025-01-21T22:10:00.000+08:00"
  }
}
```

---

## ğŸ° æŠ½å¥–æ´»åŠ¨ç®¡ç†API

### 6.5 æŸ¥è¯¢æ‰€æœ‰æŠ½å¥–æ´»åŠ¨

**APIè·¯å¾„**: `GET /api/v4/unified-engine/admin/campaigns`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢æ‰€æœ‰æŠ½å¥–æ´»åŠ¨(åŒ…æ‹¬æœªå…¬å¼€çš„)
- **å®Œæ•´æ•°æ®**: åŒ…å«æ•æ„Ÿçš„é…ç½®ä¿¡æ¯

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/admin/lottery-management.js`

#### è¯·æ±‚å‚æ•°

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|-------|------|
| `page` | number | 1 | é¡µç  |
| `limit` | number | 20 | æ¯é¡µæ¡æ•° |
| `status` | string | - | å¯é€‰,ç­›é€‰çŠ¶æ€: active/inactive/ended |

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 1,
        "code": "LUCKY2025",
        "name": "2025æ–°æ˜¥å¤§æŠ½å¥–",
        "description": "å‚ä¸æŠ½å¥–,èµ¢å–ä¸°åšå¥–å“!",
        "status": "active",
        "start_time": "2025-01-01T00:00:00.000+08:00",
        "end_time": "2025-03-01T23:59:59.999+08:00",
        "points_per_draw": 10,
        "max_draws_per_day": 10,
        
        // ç®¡ç†å‘˜å¯è§çš„æ•æ„Ÿé…ç½®
        "probability_strategy": "dynamic",
        "guarantee_config": {
          "enabled": true,
          "max_attempts": 100
        },
        "cost_management": {
          "max_cost_per_user": 1000,
          "total_budget": 50000,
          "current_spent": 15678
        },
        
        // ç»Ÿè®¡æ•°æ®
        "statistics": {
          "total_draws": 15680,
          "total_wins": 3456,
          "win_rate": "22.04%",
          "total_participants": 1234,
          "total_cost": 15678,
          "average_cost_per_user": 12.7
        },
        
        "created_at": "2024-12-15T10:00:00.000+08:00",
        "created_by": 1,
        "updated_at": "2025-01-21T15:30:00.000+08:00"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 5,
      "total_pages": 1,
      "has_next": false,
      "has_prev": false
    }
  }
}
```

---

### 6.6 åˆ›å»ºæŠ½å¥–æ´»åŠ¨

**APIè·¯å¾„**: `POST /api/v4/unified-engine/admin/campaigns`

**åŠŸèƒ½è¯´æ˜**:
- åˆ›å»ºæ–°çš„æŠ½å¥–æ´»åŠ¨

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/admin/lottery-management.js`

#### è¯·æ±‚å‚æ•°

```json
{
  "code": "SPRING2025",                      // å¿…å¡«, æ´»åŠ¨ä»£ç (å”¯ä¸€)
  "name": "2025æ˜¥å­£æŠ½å¥–",                    // å¿…å¡«, æ´»åŠ¨åç§°
  "description": "æ˜¥æš–èŠ±å¼€,å¥½ç¤¼ç›¸é€",        // å¿…å¡«, æ´»åŠ¨æè¿°
  "start_time": "2025-03-01T00:00:00.000+08:00",  // å¿…å¡«, å¼€å§‹æ—¶é—´
  "end_time": "2025-04-30T23:59:59.999+08:00",    // å¿…å¡«, ç»“æŸæ—¶é—´
  "points_per_draw": 20,                     // å¿…å¡«, æ¯æ¬¡æ¶ˆè€—ç§¯åˆ†
  "max_draws_per_day": 5,                    // å¿…å¡«, æ¯æ—¥æœ€å¤šæŠ½å¥–æ¬¡æ•°
  "probability_strategy": "dynamic",         // å¿…å¡«, æ¦‚ç‡ç­–ç•¥
  "guarantee_config": {                      // å¯é€‰, ä¿åº•é…ç½®
    "enabled": true,
    "max_attempts": 100
  },
  "cost_management": {                       // å¯é€‰, æˆæœ¬ç®¡ç†
    "max_cost_per_user": 500,
    "total_budget": 30000
  }
}
```

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "æ´»åŠ¨åˆ›å»ºæˆåŠŸ",
  "data": {
    "id": 6,
    "code": "SPRING2025",
    "name": "2025æ˜¥å­£æŠ½å¥–",
    "status": "inactive",                    // é»˜è®¤æœªæ¿€æ´»
    "created_at": "2025-01-21T22:15:00.000+08:00",
    "created_by": 1
  }
}
```

---

### 6.7 æ›´æ–°æŠ½å¥–æ´»åŠ¨

**APIè·¯å¾„**: `PUT /api/v4/unified-engine/admin/campaigns/:id`

**åŠŸèƒ½è¯´æ˜**:
- æ›´æ–°æŠ½å¥–æ´»åŠ¨é…ç½®

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/admin/lottery-management.js`

#### è¯·æ±‚å‚æ•°

```json
{
  "name": "2025æ˜¥å­£ç‰¹æƒ æŠ½å¥–",              // å¯é€‰, æ›´æ–°åç§°
  "description": "æ˜¥æš–èŠ±å¼€,å¥½ç¤¼ç›¸é€!",     // å¯é€‰, æ›´æ–°æè¿°
  "status": "active",                       // å¯é€‰, æ›´æ–°çŠ¶æ€
  "max_draws_per_day": 10                   // å¯é€‰, æ›´æ–°æ¯æ—¥æŠ½å¥–æ¬¡æ•°
}
```

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "æ´»åŠ¨å·²æ›´æ–°",
  "data": {
    "id": 6,
    "updated_fields": ["name", "description", "status", "max_draws_per_day"],
    "updated_at": "2025-01-21T22:20:00.000+08:00",
    "updated_by": 1
  }
}
```

---

## ğŸ å¥–å“æ± ç®¡ç†API

### 6.8 æŸ¥è¯¢æ´»åŠ¨å¥–å“æ± 

**APIè·¯å¾„**: `GET /api/v4/unified-engine/admin/campaigns/:id/prizes`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢æŒ‡å®šæ´»åŠ¨çš„æ‰€æœ‰å¥–å“
- **å®Œæ•´æ•°æ®**: åŒ…å«æ¦‚ç‡ã€æˆæœ¬ã€åº“å­˜ç­‰æ•æ„Ÿä¿¡æ¯

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/admin/prize_pool.js`

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "campaign_id": 1,
    "campaign_code": "LUCKY2025",
    "prizes": [
      {
        "id": 101,
        "name": "ç‰¹ç­‰å¥– - iPhone 15 Pro Max",
        "description": "256GB æ·±ç©ºé»‘",
        "type": "physical",
        "value": "9999",
        "image_url": "https://...",
        "rank": 1,
        
        // ç®¡ç†å‘˜å¯è§çš„æ•æ„Ÿæ•°æ®
        "probability": "0.1",                // ä¸­å¥–æ¦‚ç‡(%)
        "stock": 5,                          // å‰©ä½™åº“å­˜
        "initial_stock": 10,                 // åˆå§‹åº“å­˜
        "cost_price": "7500.00",             // æˆæœ¬ä»·
        "guarantee_config": {
          "enabled": true,
          "attempts_required": 100
        },
        
        // ç»Ÿè®¡æ•°æ®
        "statistics": {
          "total_won": 3,
          "last_won_at": "2025-01-20T15:30:00.000+08:00",
          "total_cost": 22500
        }
      }
    ],
    "summary": {
      "total_prizes": 10,
      "total_value": 125000,
      "total_cost": 78000,
      "profit_margin": "37.6%"
    }
  }
}
```

---

### 6.9 æ·»åŠ æ´»åŠ¨å¥–å“

**APIè·¯å¾„**: `POST /api/v4/unified-engine/admin/campaigns/:id/prizes`

**åŠŸèƒ½è¯´æ˜**:
- ä¸ºæ´»åŠ¨æ·»åŠ æ–°å¥–å“

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/admin/prize_pool.js`

#### è¯·æ±‚å‚æ•°

```json
{
  "name": "ä¸€ç­‰å¥– - iPad Air",            // å¿…å¡«, å¥–å“åç§°
  "description": "64GB WiFiç‰ˆ",          // å¿…å¡«, å¥–å“æè¿°
  "type": "physical",                    // å¿…å¡«, physical/virtual/points
  "value": "4299",                       // å¿…å¡«, å¥–å“ä»·å€¼
  "probability": "0.5",                  // å¿…å¡«, ä¸­å¥–æ¦‚ç‡(%)
  "stock": 20,                           // å¿…å¡«, åº“å­˜æ•°é‡
  "cost_price": "3500",                  // å¿…å¡«, æˆæœ¬ä»·
  "rank": 2,                             // å¿…å¡«, å¥–å“ç­‰çº§(1-5)
  "image_url": "https://...",            // å¯é€‰, å›¾ç‰‡URL
  "guarantee_config": {                  // å¯é€‰, ä¿åº•é…ç½®
    "enabled": false
  }
}
```

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "å¥–å“å·²æ·»åŠ ",
  "data": {
    "id": 110,
    "campaign_id": 1,
    "name": "ä¸€ç­‰å¥– - iPad Air",
    "created_at": "2025-01-21T22:25:00.000+08:00"
  }
}
```

---

### 6.10 æ›´æ–°å¥–å“é…ç½®

**APIè·¯å¾„**: `PUT /api/v4/unified-engine/admin/prizes/:prize_id`

**åŠŸèƒ½è¯´æ˜**:
- æ›´æ–°å¥–å“çš„é…ç½®(æ¦‚ç‡ã€åº“å­˜ç­‰)

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/admin/prize_pool.js`

#### è¯·æ±‚å‚æ•°

```json
{
  "probability": "1.0",                  // å¯é€‰, æ›´æ–°æ¦‚ç‡
  "stock": 30,                           // å¯é€‰, æ›´æ–°åº“å­˜
  "status": "active"                     // å¯é€‰, active/inactive
}
```

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "å¥–å“é…ç½®å·²æ›´æ–°",
  "data": {
    "prize_id": 110,
    "updated_fields": ["probability", "stock"],
    "old_values": {
      "probability": "0.5",
      "stock": 20
    },
    "new_values": {
      "probability": "1.0",
      "stock": 30
    },
    "updated_at": "2025-01-21T22:30:00.000+08:00"
  }
}
```

---

## âš™ï¸ ç³»ç»Ÿé…ç½®ç®¡ç†API

### 6.11 æŸ¥è¯¢ç³»ç»Ÿé…ç½®

**APIè·¯å¾„**: `GET /api/v4/unified-engine/admin/config`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢ç³»ç»Ÿçš„æ‰€æœ‰é…ç½®é¡¹

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/admin/config.js`

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "lottery": {
      "default_points_per_draw": 10,
      "default_max_draws_per_day": 10,
      "probability_adjustment_enabled": true,
      "guarantee_mechanism_enabled": true
    },
    "points": {
      "initial_points": 100,
      "photo_approval_reward": 50,
      "daily_check_in_reward": 10,
      "min_transfer_amount": 10
    },
    "upload": {
      "max_file_size": 10485760,
      "allowed_formats": ["jpg", "jpeg", "png", "gif", "webp"],
      "auto_thumbnail_enabled": true,
      "thumbnail_sizes": {
        "small": 150,
        "medium": 500,
        "large": 1000
      }
    },
    "exchange": {
      "min_exchange_points": 50,
      "platform_fee_rate": 0.05,
      "max_transfer_count": 3
    },
    "system": {
      "maintenance_mode": false,
      "registration_enabled": true,
      "max_concurrent_users": 10000,
      "session_timeout": 7200,
      "api_rate_limit": 100
    }
  }
}
```

---

### 6.12 æ›´æ–°ç³»ç»Ÿé…ç½®

**APIè·¯å¾„**: `PUT /api/v4/unified-engine/admin/config`

**åŠŸèƒ½è¯´æ˜**:
- æ›´æ–°ç³»ç»Ÿé…ç½®é¡¹

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/admin/config.js`

#### è¯·æ±‚å‚æ•°

```json
{
  "category": "points",                      // å¿…å¡«, é…ç½®åˆ†ç±»
  "key": "photo_approval_reward",            // å¿…å¡«, é…ç½®é”®
  "value": 100                               // å¿…å¡«, æ–°å€¼
}
```

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "é…ç½®å·²æ›´æ–°",
  "data": {
    "category": "points",
    "key": "photo_approval_reward",
    "old_value": 50,
    "new_value": 100,
    "updated_by": 1,
    "updated_at": "2025-01-21T22:35:00.000+08:00"
  }
}
```

---

## ğŸ“Š æ•°æ®åˆ†æç»Ÿè®¡API

### 6.13 æŸ¥è¯¢æŠ½å¥–åˆ†ææ•°æ®

**APIè·¯å¾„**: `GET /api/v4/unified-engine/admin/analytics/lottery`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢æŠ½å¥–ç³»ç»Ÿçš„è¯¦ç»†åˆ†ææ•°æ®

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/admin/analytics.js`

#### è¯·æ±‚å‚æ•°

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|-------|------|
| `start_date` | string | - | å¯é€‰,å¼€å§‹æ—¥æœŸ(YYYY-MM-DD) |
| `end_date` | string | - | å¯é€‰,ç»“æŸæ—¥æœŸ(YYYY-MM-DD) |
| `campaign_code` | string | - | å¯é€‰,ç­›é€‰æ´»åŠ¨ |

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "overview": {
      "total_draws": 156780,
      "total_wins": 34523,
      "win_rate": "22.01%",
      "total_participants": 8456,
      "total_points_spent": 1567800,
      "total_cost": 345678
    },
    "trend": [                               // æ¯æ—¥è¶‹åŠ¿
      {
        "date": "2025-01-21",
        "draws": 2345,
        "wins": 523,
        "win_rate": "22.3%",
        "participants": 856
      },
      {
        "date": "2025-01-20",
        "draws": 2156,
        "wins": 478,
        "win_rate": "22.2%",
        "participants": 789
      }
    ],
    "campaign_performance": [                // å„æ´»åŠ¨è¡¨ç°
      {
        "campaign_code": "LUCKY2025",
        "draws": 115680,
        "wins": 25456,
        "win_rate": "22.0%",
        "revenue": 1156800,
        "cost": 254560,
        "profit": 902240,
        "roi": "354.2%"
      }
    ],
    "prize_distribution": [                  // å¥–å“åˆ†å¸ƒ
      {
        "prize_name": "ç‰¹ç­‰å¥– - iPhone 15",
        "total_won": 15,
        "win_rate": "0.01%",
        "total_cost": 112500
      }
    ],
    "user_behavior": {
      "average_draws_per_user": 18.5,
      "peak_hours": ["20:00-22:00"],
      "retention_rate": "68.5%"
    }
  }
}
```

---

### 6.14 æŸ¥è¯¢ç”¨æˆ·åˆ†ææ•°æ®

**APIè·¯å¾„**: `GET /api/v4/unified-engine/admin/analytics/users`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢ç”¨æˆ·ç›¸å…³çš„åˆ†ææ•°æ®

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/admin/analytics.js`

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "overview": {
      "total_users": 12580,
      "active_users": 8456,
      "new_users_last_7_days": 256,
      "growth_rate": "+2.08%"
    },
    "user_distribution": {
      "by_status": {
        "active": 11234,
        "inactive": 1200,
        "banned": 146
      },
      "by_role": {
        "user": 12575,
        "admin": 5
      }
    },
    "engagement": {
      "daily_active_users": 856,
      "weekly_active_users": 3456,
      "monthly_active_users": 8456,
      "retention_rate_7_day": "68.5%",
      "retention_rate_30_day": "45.2%"
    },
    "activity_trend": [
      {
        "date": "2025-01-21",
        "new_users": 23,
        "active_users": 856,
        "total_actions": 5678
      }
    ]
  }
}
```

---

## ğŸ” å®¡è®¡æ—¥å¿—ç®¡ç†API

### 6.15 æŸ¥è¯¢å®¡è®¡æ—¥å¿—

**APIè·¯å¾„**: `GET /api/v4/audit-management/logs`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢ç³»ç»Ÿæ“ä½œå®¡è®¡æ—¥å¿—
- **è®°å½•æ‰€æœ‰æ•æ„Ÿæ“ä½œ**: ç”¨æˆ·çŠ¶æ€ä¿®æ”¹ã€è§’è‰²åˆ†é…ã€é…ç½®æ›´æ”¹ç­‰

**åç«¯å®ç°ä½ç½®**: `routes/audit-management.js`

#### è¯·æ±‚å‚æ•°

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|-------|------|
| `page` | number | 1 | é¡µç  |
| `limit` | number | 50 | æ¯é¡µæ¡æ•° |
| `action_type` | string | - | å¯é€‰,ç­›é€‰æ“ä½œç±»å‹ |
| `admin_id` | number | - | å¯é€‰,ç­›é€‰æ“ä½œå‘˜ |
| `start_date` | string | - | å¯é€‰,å¼€å§‹æ—¥æœŸ |
| `end_date` | string | - | å¯é€‰,ç»“æŸæ—¥æœŸ |

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 20001,
        "admin_id": 1,
        "admin_nickname": "ç®¡ç†å‘˜A",
        "action_type": "user_status_update",   // æ“ä½œç±»å‹
        "action_description": "ä¿®æ”¹ç”¨æˆ·çŠ¶æ€",
        "target_type": "user",                 // ç›®æ ‡ç±»å‹
        "target_id": 123,
        "target_info": {
          "user_id": 123,
          "user_nickname": "ç”¨æˆ·A"
        },
        "changes": {                           // å˜æ›´è¯¦æƒ…
          "old_status": "active",
          "new_status": "banned",
          "reason": "è¿åç”¨æˆ·åè®®"
        },
        "ip_address": "192.168.1.100",
        "user_agent": "Mozilla/5.0...",
        "created_at": "2025-01-21T22:05:00.000+08:00"
      },
      {
        "id": 20000,
        "admin_id": 1,
        "admin_nickname": "ç®¡ç†å‘˜A",
        "action_type": "config_update",
        "action_description": "æ›´æ–°ç³»ç»Ÿé…ç½®",
        "target_type": "config",
        "target_id": null,
        "target_info": {
          "category": "points",
          "key": "photo_approval_reward"
        },
        "changes": {
          "old_value": 50,
          "new_value": 100
        },
        "ip_address": "192.168.1.100",
        "user_agent": "Mozilla/5.0...",
        "created_at": "2025-01-21T22:35:00.000+08:00"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 50,
      "total": 2345,
      "total_pages": 47,
      "has_next": true,
      "has_prev": false
    },
    "summary": {
      "total_logs": 2345,
      "unique_admins": 3,
      "most_common_action": "user_status_update"
    }
  }
}
```

---

## ğŸ” æ´»åŠ¨æƒé™ç®¡ç†API

### 6.16 åˆ†é…æ´»åŠ¨æƒé™

**APIè·¯å¾„**: `POST /api/v4/unified-engine/admin/campaign-permissions/assign`

**åŠŸèƒ½è¯´æ˜**:
- ä¸ºç”¨æˆ·åˆ†é…æŒ‡å®šæ´»åŠ¨çš„å‚ä¸æƒé™
- **è‡ªåŠ¨åˆ›å»º**: `campaign_{æ´»åŠ¨ID}` è§’è‰²

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/admin/campaign-permissions.js`

#### è¯·æ±‚å‚æ•°

```json
{
  "user_id": 123,                            // å¿…å¡«, ç”¨æˆ·ID
  "campaign_id": 1                           // å¿…å¡«, æ´»åŠ¨ID
}
```

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "æ´»åŠ¨æƒé™å·²åˆ†é…",
  "data": {
    "user_id": 123,
    "campaign_id": 1,
    "campaign_code": "LUCKY2025",
    "role_name": "campaign_1",               // è‡ªåŠ¨åˆ›å»ºçš„è§’è‰²å
    "assigned_by": 1,
    "assigned_at": "2025-01-21T22:40:00.000+08:00"
  }
}
```

---

### 6.17 æ’¤é”€æ´»åŠ¨æƒé™

**APIè·¯å¾„**: `DELETE /api/v4/unified-engine/admin/campaign-permissions/revoke`

**åŠŸèƒ½è¯´æ˜**:
- æ’¤é”€ç”¨æˆ·çš„æ´»åŠ¨å‚ä¸æƒé™

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/admin/campaign-permissions.js`

#### è¯·æ±‚å‚æ•°

```json
{
  "user_id": 123,                            // å¿…å¡«, ç”¨æˆ·ID
  "campaign_id": 1                           // å¿…å¡«, æ´»åŠ¨ID
}
```

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "æ´»åŠ¨æƒé™å·²æ’¤é”€",
  "data": {
    "user_id": 123,
    "campaign_id": 1,
    "campaign_code": "LUCKY2025",
    "revoked_by": 1,
    "revoked_at": "2025-01-21T22:45:00.000+08:00"
  }
}
```

---

### 6.18 æŸ¥è¯¢æ´»åŠ¨æƒé™åˆ—è¡¨

**APIè·¯å¾„**: `GET /api/v4/unified-engine/admin/campaign-permissions/list`

**åŠŸèƒ½è¯´æ˜**:
- æŸ¥è¯¢æ‰€æœ‰æ´»åŠ¨æƒé™åˆ†é…è®°å½•

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/admin/campaign-permissions.js`

#### è¯·æ±‚å‚æ•°

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|-------|------|
| `page` | number | 1 | é¡µç  |
| `limit` | number | 50 | æ¯é¡µæ¡æ•° |
| `campaign_id` | number | - | å¯é€‰,ç­›é€‰æ´»åŠ¨ |
| `user_id` | number | - | å¯é€‰,ç­›é€‰ç”¨æˆ· |

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 5001,
        "user_id": 123,
        "user_nickname": "ç”¨æˆ·A",
        "campaign_id": 1,
        "campaign_code": "LUCKY2025",
        "campaign_name": "2025æ–°æ˜¥å¤§æŠ½å¥–",
        "assigned_by": 1,
        "assigned_by_nickname": "ç®¡ç†å‘˜A",
        "assigned_at": "2025-01-21T22:40:00.000+08:00"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 50,
      "total": 1234,
      "total_pages": 25,
      "has_next": true,
      "has_prev": false
    },
    "summary": {
      "total_permissions": 1234,
      "campaigns_with_permissions": 5,
      "users_with_permissions": 856
    }
  }
}
```

---

### 6.19 æ£€æŸ¥ç”¨æˆ·æ´»åŠ¨æƒé™

**APIè·¯å¾„**: `GET /api/v4/unified-engine/admin/campaign-permissions/check`

**åŠŸèƒ½è¯´æ˜**:
- æ£€æŸ¥æŒ‡å®šç”¨æˆ·æ˜¯å¦æœ‰æŸä¸ªæ´»åŠ¨çš„æƒé™

**åç«¯å®ç°ä½ç½®**: `routes/v4/unified-engine/admin/campaign-permissions.js`

#### è¯·æ±‚å‚æ•°

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `user_id` | number | æ˜¯ | ç”¨æˆ·ID |
| `campaign_id` | number | æ˜¯ | æ´»åŠ¨ID |

**ç¤ºä¾‹**: `/api/v4/unified-engine/admin/campaign-permissions/check?user_id=123&campaign_id=1`

#### æˆåŠŸå“åº”

```json
{
  "success": true,
  "data": {
    "user_id": 123,
    "campaign_id": 1,
    "has_permission": true,
    "permission_source": "campaign_role",    // campaign_role/admin
    "assigned_at": "2025-01-21T22:40:00.000+08:00"
  }
}
```

---

## ğŸ“ ç®¡ç†åå°æ¨¡å—æ€»ç»“

### APIæ¸…å•

| æ¨¡å— | APIæ•°é‡ | ä¸»è¦åŠŸèƒ½ |
|------|--------|---------|
| ç”¨æˆ·ç®¡ç† | 4+ | ç”¨æˆ·åˆ—è¡¨ã€è¯¦æƒ…ã€çŠ¶æ€ç®¡ç†ã€è§’è‰²åˆ†é… |
| æŠ½å¥–ç®¡ç† | 6+ | æ´»åŠ¨ç®¡ç†ã€å¥–å“æ± ç®¡ç†ã€é…ç½®è°ƒæ•´ |
| ç³»ç»Ÿé…ç½® | 2+ | é…ç½®æŸ¥è¯¢ã€é…ç½®æ›´æ–° |
| æ•°æ®åˆ†æ | 4+ | æŠ½å¥–åˆ†æã€ç”¨æˆ·åˆ†æã€ç§¯åˆ†ç»Ÿè®¡ã€å›¾ç‰‡ç»Ÿè®¡ |
| å®¡è®¡æ—¥å¿— | 1+ | æ“ä½œæ—¥å¿—æŸ¥è¯¢å’Œå®¡è®¡ |
| æ´»åŠ¨æƒé™ | 4 | æƒé™åˆ†é…ã€æ’¤é”€ã€æŸ¥è¯¢ã€æ£€æŸ¥ |

### æƒé™éªŒè¯æµç¨‹

```
ç”¨æˆ·è¯·æ±‚ â†’ TokenéªŒè¯ â†’ è§£æç”¨æˆ·ä¿¡æ¯ â†’ æ£€æŸ¥role_level
   â†“
role_level >= 100? â†’ æ˜¯ â†’ å…è®¸è®¿é—®ç®¡ç†åå°
   â†“ å¦
è¿”å›403é”™è¯¯: FORBIDDEN
```

### å‰ç«¯å¼€å‘å»ºè®®

1. **æƒé™æ§åˆ¶**:
   - å‰ç«¯æ ¹æ®ç”¨æˆ·çš„`role_based_admin`å­—æ®µåˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºç®¡ç†åå°å…¥å£
   - æ‰€æœ‰ç®¡ç†åå°APIè°ƒç”¨éƒ½è¦å¤„ç†403æƒé™é”™è¯¯

2. **æ•°æ®å±•ç¤º**:
   - ç®¡ç†åå°å¯ä»¥æ˜¾ç¤ºå®Œæ•´çš„æ•æ„Ÿæ•°æ®(æ¦‚ç‡ã€æˆæœ¬ç­‰)
   - ä½¿ç”¨å›¾è¡¨å±•ç¤ºç»Ÿè®¡å’Œåˆ†ææ•°æ®
   - æä¾›ç­›é€‰ã€æœç´¢ã€æ’åºåŠŸèƒ½

3. **æ“ä½œç¡®è®¤**:
   - æ•æ„Ÿæ“ä½œ(å°ç¦ç”¨æˆ·ã€ä¿®æ”¹é…ç½®ç­‰)éœ€è¦äºŒæ¬¡ç¡®è®¤
   - æ˜¾ç¤ºæ“ä½œå‰åçš„æ•°æ®å¯¹æ¯”
   - è®°å½•æ“ä½œåŸå› 

4. **å®¡è®¡è¿½è¸ª**:
   - æ‰€æœ‰ç®¡ç†æ“ä½œéƒ½ä¼šè®°å½•å®¡è®¡æ—¥å¿—
   - ç®¡ç†å‘˜å¯æŸ¥çœ‹æ“ä½œå†å²
   - æ˜¾ç¤ºæ“ä½œå‘˜ã€æ—¶é—´ã€å˜æ›´å†…å®¹

---

**ğŸ“„ æ–‡æ¡£ç¬¬6éƒ¨åˆ†å®Œæˆ**

**ä¸‹ä¸€æ­¥**: åˆå¹¶æ‰€æœ‰éƒ¨åˆ†ä¸ºæœ€ç»ˆå®Œæ•´ç‰ˆæœ¬

---

## ğŸ¯ å®Œæ•´APIç»Ÿè®¡

### æ€»ä½“ç»Ÿè®¡
| æ¨¡å— | ç”¨æˆ·ç«¯API | ç®¡ç†ç«¯API | æ€»è®¡ |
|------|----------|----------|------|
| è®¤è¯æƒé™ | 5 | 5 | 10 |
| æŠ½å¥–æ ¸å¿ƒ | 7 | 0 | 7 |
| åº“å­˜ç®¡ç† | 12 | 2 | 14 |
| ç§¯åˆ†ç³»ç»Ÿ | 4 | 2 | 6 |
| å›¾ç‰‡ç®¡ç† | 4 | 3 | 7 |
| ç³»ç»ŸåŠŸèƒ½ | 10 | 6 | 16 |
| ç®¡ç†åå° | 0 | 19+ | 19+ |
| **æ€»è®¡** | **42** | **37+** | **79+** |

### è®¤è¯è¦æ±‚åˆ†å¸ƒ
- âŒ æ— éœ€è®¤è¯: 3ä¸ªAPI (ç³»ç»ŸçŠ¶æ€ã€å¥åº·æ£€æŸ¥ã€WebSocketçŠ¶æ€)
- âœ… éœ€è¦è®¤è¯: 42ä¸ªAPI (ç”¨æˆ·åŠŸèƒ½)
- âœ…ğŸ”‘ éœ€è¦ç®¡ç†å‘˜: 37+ä¸ªAPI (ç®¡ç†åå°)

---

**ğŸ“˜ å‰åç«¯APIå¯¹æ¥æ–‡æ¡£V5.0 - æ‰€æœ‰éƒ¨åˆ†åˆ›å»ºå®Œæˆ!**


---


**æ–‡æ¡£éƒ¨åˆ†**: é™„å½• - æ•°æ®åº“ã€é”™è¯¯ç ã€éƒ¨ç½²ã€å·¥å…·ç±»
**åˆ›å»ºæ—¶é—´**: 2025å¹´01æœˆ21æ—¥ (åŒ—äº¬æ—¶é—´)
**åŸºäºå®é™…ä»£ç éªŒè¯**: âœ…

---

## ğŸ“š é™„å½• A: æ•°æ®åº“æ¨¡å‹è¯¦ç»†è¯´æ˜

### æ ¸å¿ƒæ•°æ®åº“è¡¨ç»“æ„

#### A.1 ç”¨æˆ·è¡¨ (`users`)

**æ¨¡å‹æ–‡ä»¶**: `models/User.js`

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|-------|------|------|------|
| `user_id` | INTEGER | PK, AUTO_INCREMENT | ç”¨æˆ·å”¯ä¸€æ ‡è¯† |
| `mobile` | VARCHAR(20) | UNIQUE, NOT NULL | æ‰‹æœºå·,ç™»å½•å‡­è¯ |
| `nickname` | VARCHAR(50) | NULL | ç”¨æˆ·æ˜µç§° |
| `avatar` | VARCHAR(255) | NULL | å¤´åƒURL |
| `email` | VARCHAR(100) | NULL | é‚®ç®± |
| `gender` | ENUM('male','female') | NULL | æ€§åˆ« |
| `birthday` | DATE | NULL | ç”Ÿæ—¥ |
| `status` | ENUM('active','inactive','banned') | DEFAULT 'active' | è´¦å·çŠ¶æ€ |
| `consecutive_fail_count` | INTEGER | DEFAULT 0 | è¿ç»­æœªä¸­å¥–æ¬¡æ•°(ä¿åº•æœºåˆ¶) |
| `history_total_points` | INTEGER | DEFAULT 0 | å†å²ç´¯è®¡ç§¯åˆ†(è§£é”è‡»é€‰ç©ºé—´) |
| `last_login` | DATETIME | NULL | æœ€åç™»å½•æ—¶é—´ |
| `login_count` | INTEGER | DEFAULT 0 | ç™»å½•æ¬¡æ•° |
| `created_at` | DATETIME | NOT NULL | åˆ›å»ºæ—¶é—´ |
| `updated_at` | DATETIME | NOT NULL | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**:
- PRIMARY KEY: `user_id`
- UNIQUE INDEX: `mobile`
- INDEX: `status`, `history_total_points`, `last_login`

**å…³è”å…³ç³»**:
- hasMany `UserRole`: ç”¨æˆ·è§’è‰²å…³è”(å¤šå¯¹å¤š)
- hasOne `UserPointsAccount`: ç§¯åˆ†è´¦æˆ·(ä¸€å¯¹ä¸€)
- hasMany `LotteryDraw`: æŠ½å¥–è®°å½•
- hasMany `UserInventory`: ç”¨æˆ·åº“å­˜

---

#### A.2 è§’è‰²è¡¨ (`roles`)

**æ¨¡å‹æ–‡ä»¶**: `models/Role.js`

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|-------|------|------|------|
| `role_id` | INTEGER | PK, AUTO_INCREMENT | è§’è‰²ID |
| `role_name` | VARCHAR(50) | UNIQUE, NOT NULL | è§’è‰²åç§° |
| `description` | VARCHAR(200) | NULL | è§’è‰²æè¿° |
| `role_level` | INTEGER | DEFAULT 0 | è§’è‰²çº§åˆ«(0=æ™®é€š,>=100=ç®¡ç†å‘˜) |
| `created_at` | DATETIME | NOT NULL | åˆ›å»ºæ—¶é—´ |
| `updated_at` | DATETIME | NOT NULL | æ›´æ–°æ—¶é—´ |

**é¢„è®¾è§’è‰²**:
- `admin`: è¶…çº§ç®¡ç†å‘˜ (role_level: 100)
- `user`: æ™®é€šç”¨æˆ· (role_level: 0)
- `campaign_{æ´»åŠ¨ID}`: æ´»åŠ¨ä¸“å±è§’è‰² (role_level: 0)

**å…³è”å…³ç³»**:
- hasMany `UserRole`: ç”¨æˆ·è§’è‰²å…³è”
- belongsToMany `User` through `UserRole`: æ‹¥æœ‰è¯¥è§’è‰²çš„ç”¨æˆ·

---

#### A.3 ç”¨æˆ·è§’è‰²å…³è”è¡¨ (`user_roles`)

**æ¨¡å‹æ–‡ä»¶**: `models/UserRole.js`

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|-------|------|------|------|
| `id` | INTEGER | PK, AUTO_INCREMENT | å…³è”ID |
| `user_id` | INTEGER | NOT NULL, FK â†’ users.user_id | ç”¨æˆ·ID |
| `role_id` | INTEGER | NOT NULL, FK â†’ roles.role_id | è§’è‰²ID |
| `assigned_at` | DATETIME | NOT NULL | åˆ†é…æ—¶é—´ |
| `assigned_by` | INTEGER | NULL, FK â†’ users.user_id | åˆ†é…æ“ä½œå‘˜ID |

**å¤åˆå”¯ä¸€ç´¢å¼•**: `(user_id, role_id)` - é˜²æ­¢é‡å¤åˆ†é…

---

#### A.4 æŠ½å¥–æ´»åŠ¨è¡¨ (`lottery_campaigns`)

**æ¨¡å‹æ–‡ä»¶**: `models/LotteryCampaign.js`

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|-------|------|------|------|
| `campaign_id` | INTEGER | PK, AUTO_INCREMENT | æ´»åŠ¨ID |
| `campaign_code` | VARCHAR(50) | UNIQUE, NOT NULL | æ´»åŠ¨ä»£ç æ ‡è¯†ç¬¦ |
| `name` | VARCHAR(100) | NOT NULL | æ´»åŠ¨åç§° |
| `description` | TEXT | NULL | æ´»åŠ¨æè¿° |
| `status` | ENUM('draft','active','paused','ended','cancelled') | DEFAULT 'draft' | æ´»åŠ¨çŠ¶æ€ |
| `start_time` | DATETIME | NOT NULL | å¼€å§‹æ—¶é—´ |
| `end_time` | DATETIME | NOT NULL | ç»“æŸæ—¶é—´ |
| `points_per_draw` | INTEGER | NOT NULL | æ¯æ¬¡æŠ½å¥–æ¶ˆè€—ç§¯åˆ† |
| `max_draws_per_day` | INTEGER | DEFAULT 10 | æ¯æ—¥æœ€å¤šæŠ½å¥–æ¬¡æ•° |
| `probability_strategy` | ENUM('static','dynamic','guarantee') | DEFAULT 'static' | æ¦‚ç‡ç­–ç•¥ |
| `guarantee_config` | JSON | NULL | ä¿åº•é…ç½® |
| `cost_management` | JSON | NULL | æˆæœ¬ç®¡ç†é…ç½® |
| `rules` | JSON | NULL | æ´»åŠ¨è§„åˆ™ |
| `created_at` | DATETIME | NOT NULL | åˆ›å»ºæ—¶é—´ |
| `updated_at` | DATETIME | NOT NULL | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**:
- UNIQUE INDEX: `campaign_code`
- INDEX: `status`, `start_time`, `end_time`

**å…³è”å…³ç³»**:
- hasMany `LotteryPrize`: æ´»åŠ¨å¥–å“
- hasMany `LotteryDraw`: æŠ½å¥–è®°å½•

---

#### A.5 æŠ½å¥–å¥–å“è¡¨ (`lottery_prizes`)

**æ¨¡å‹æ–‡ä»¶**: `models/LotteryPrize.js`

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|-------|------|------|------|
| `prize_id` | INTEGER | PK, AUTO_INCREMENT | å¥–å“ID |
| `campaign_id` | INTEGER | NOT NULL, FK â†’ lottery_campaigns.campaign_id | æ´»åŠ¨ID |
| `name` | VARCHAR(100) | NOT NULL | å¥–å“åç§° |
| `description` | TEXT | NULL | å¥–å“æè¿° |
| `prize_type` | ENUM('physical','virtual','points','coupon','service') | NOT NULL | å¥–å“ç±»å‹ |
| `value` | DECIMAL(10,2) | NOT NULL | å¥–å“ä»·å€¼ |
| `image_id` | INTEGER | NULL, FK â†’ image_resources.id | å¥–å“å›¾ç‰‡ID |
| `rank` | INTEGER | NOT NULL | å¥–å“ç­‰çº§(1-5) |
| `win_probability` | DECIMAL(8,6) | NOT NULL | ä¸­å¥–æ¦‚ç‡(0-1) |
| `stock_quantity` | INTEGER | NULL | åº“å­˜æ•°é‡(NULL=æ— é™) |
| `initial_stock` | INTEGER | NULL | åˆå§‹åº“å­˜ |
| `cost_price` | DECIMAL(10,2) | NULL | æˆæœ¬ä»· |
| `status` | ENUM('active','inactive','out_of_stock','expired') | DEFAULT 'active' | å¥–å“çŠ¶æ€ |
| `guarantee_config` | JSON | NULL | ä¿åº•é…ç½® |
| `max_daily_wins` | INTEGER | NULL | æ¯æ—¥æœ€å¤šä¸­å¥–æ¬¡æ•° |
| `daily_win_count` | INTEGER | DEFAULT 0 | ä»Šæ—¥ä¸­å¥–æ¬¡æ•° |
| `created_at` | DATETIME | NOT NULL | åˆ›å»ºæ—¶é—´ |
| `updated_at` | DATETIME | NOT NULL | æ›´æ–°æ—¶é—´ |

**å…³è”å…³ç³»**:
- belongsTo `LotteryCampaign`: æ‰€å±æ´»åŠ¨
- hasMany `LotteryDraw`: ä¸­å¥–è®°å½•
- belongsTo `ImageResources`: å¥–å“å›¾ç‰‡

---

#### A.6 æŠ½å¥–è®°å½•è¡¨ (`lottery_draws`)

**æ¨¡å‹æ–‡ä»¶**: `models/LotteryDraw.js`

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|-------|------|------|------|
| `draw_id` | INTEGER | PK, AUTO_INCREMENT | æŠ½å¥–è®°å½•ID |
| `user_id` | INTEGER | NOT NULL, FK â†’ users.user_id | ç”¨æˆ·ID |
| `campaign_id` | INTEGER | NOT NULL, FK â†’ lottery_campaigns.campaign_id | æ´»åŠ¨ID |
| `prize_id` | INTEGER | NOT NULL, FK â†’ lottery_prizes.prize_id | å¥–å“ID |
| `is_winner` | BOOLEAN | DEFAULT FALSE | æ˜¯å¦ä¸­å¥– |
| `points_cost` | INTEGER | NOT NULL | æ¶ˆè€—ç§¯åˆ† |
| `draw_probability` | DECIMAL(8,6) | NULL | å®é™…æ¦‚ç‡(åŠ¨æ€è°ƒæ•´å) |
| `created_at` | DATETIME | NOT NULL | æŠ½å¥–æ—¶é—´ |

**ç´¢å¼•**:
- INDEX: `user_id`, `campaign_id`, `created_at`
- COMPOSITE INDEX: `(user_id, campaign_id, created_at)`

---

#### A.7 ç”¨æˆ·åº“å­˜è¡¨ (`user_inventory`)

**æ¨¡å‹æ–‡ä»¶**: `models/UserInventory.js`

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|-------|------|------|------|
| `inventory_id` | INTEGER | PK, AUTO_INCREMENT | åº“å­˜è®°å½•ID |
| `user_id` | INTEGER | NOT NULL, FK â†’ users.user_id | ç”¨æˆ·ID |
| `name` | VARCHAR(100) | NOT NULL | ç‰©å“åç§° |
| `description` | TEXT | NULL | ç‰©å“æè¿° |
| `type` | ENUM('voucher','product','service') | NOT NULL | ç‰©å“ç±»å‹ |
| `value` | INTEGER | NOT NULL | ç‰©å“ä»·å€¼(ç§¯åˆ†) |
| `status` | ENUM('available','pending','used','expired','transferred') | DEFAULT 'available' | ç‰©å“çŠ¶æ€ |
| `source_type` | VARCHAR(50) | NOT NULL | æ¥æºç±»å‹ |
| `source_id` | VARCHAR(32) | NULL | æ¥æºè®°å½•ID |
| `verification_code` | VARCHAR(16) | NULL | æ ¸é”€ç  |
| `acquired_at` | DATETIME | NOT NULL | è·å¾—æ—¶é—´ |
| `expires_at` | DATETIME | NULL | è¿‡æœŸæ—¶é—´ |
| `used_at` | DATETIME | NULL | ä½¿ç”¨æ—¶é—´ |
| `created_at` | DATETIME | NOT NULL | åˆ›å»ºæ—¶é—´ |
| `updated_at` | DATETIME | NOT NULL | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**:
- INDEX: `user_id`, `status`, `verification_code`

---

#### A.8 ç”¨æˆ·ç§¯åˆ†è´¦æˆ·è¡¨ (`user_points_accounts`)

**æ¨¡å‹æ–‡ä»¶**: `models/UserPointsAccount.js`

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|-------|------|------|------|
| `account_id` | INTEGER | PK, AUTO_INCREMENT | è´¦æˆ·ID |
| `user_id` | INTEGER | UNIQUE, NOT NULL, FK â†’ users.user_id | ç”¨æˆ·ID(ä¸€å¯¹ä¸€) |
| `current_points` | INTEGER | DEFAULT 0 | å½“å‰ç§¯åˆ†ä½™é¢ |
| `total_earned` | INTEGER | DEFAULT 0 | ç´¯è®¡è·å¾—ç§¯åˆ† |
| `total_spent` | INTEGER | DEFAULT 0 | ç´¯è®¡æ¶ˆè€—ç§¯åˆ† |
| `is_active` | BOOLEAN | DEFAULT TRUE | è´¦æˆ·æ˜¯å¦æ¿€æ´» |
| `freeze_reason` | VARCHAR(200) | NULL | å†»ç»“åŸå›  |
| `last_transaction_at` | DATETIME | NULL | æœ€åäº¤æ˜“æ—¶é—´ |
| `created_at` | DATETIME | NOT NULL | åˆ›å»ºæ—¶é—´ |
| `updated_at` | DATETIME | NOT NULL | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**:
- UNIQUE INDEX: `user_id`
- INDEX: `current_points`, `is_active`

---

#### A.9 ç§¯åˆ†äº¤æ˜“è®°å½•è¡¨ (`points_transactions`)

**æ¨¡å‹æ–‡ä»¶**: `models/PointsTransaction.js`

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|-------|------|------|------|
| `transaction_id` | INTEGER | PK, AUTO_INCREMENT | äº¤æ˜“ID |
| `account_id` | INTEGER | NOT NULL, FK â†’ user_points_accounts.account_id | è´¦æˆ·ID |
| `user_id` | INTEGER | NOT NULL, FK â†’ users.user_id | ç”¨æˆ·ID(å†—ä½™å­—æ®µ) |
| `type` | ENUM('earn','spend','adjust','transfer') | NOT NULL | äº¤æ˜“ç±»å‹ |
| `amount` | INTEGER | NOT NULL | ç§¯åˆ†å˜åŠ¨é‡(æ­£=è·å¾—,è´Ÿ=æ¶ˆè€—) |
| `balance_after` | INTEGER | NOT NULL | äº¤æ˜“åä½™é¢ |
| `source` | VARCHAR(50) | NOT NULL | æ¥æº: lottery/exchange/admin/photo_reviewç­‰ |
| `description` | VARCHAR(200) | NULL | äº¤æ˜“æè¿° |
| `reference_id` | VARCHAR(32) | NULL | å…³è”è®°å½•ID |
| `created_at` | DATETIME | NOT NULL | äº¤æ˜“æ—¶é—´ |

**ç´¢å¼•**:
- INDEX: `account_id`, `user_id`, `created_at`
- COMPOSITE INDEX: `(user_id, type, created_at)`

---

#### A.10 å›¾ç‰‡èµ„æºè¡¨ (`image_resources`)

**æ¨¡å‹æ–‡ä»¶**: `models/ImageResources.js`

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|-------|------|------|------|
| `id` | INTEGER | PK, AUTO_INCREMENT | å›¾ç‰‡ID |
| `user_id` | INTEGER | NOT NULL, FK â†’ users.user_id | ä¸Šä¼ ç”¨æˆ·ID |
| `original_filename` | VARCHAR(255) | NOT NULL | åŸå§‹æ–‡ä»¶å |
| `file_path` | VARCHAR(500) | NOT NULL | Sealoså­˜å‚¨è·¯å¾„ |
| `url` | VARCHAR(500) | NOT NULL | è®¿é—®URL |
| `thumbnail_small` | VARCHAR(500) | NULL | å°ç¼©ç•¥å›¾URL(150x150) |
| `thumbnail_medium` | VARCHAR(500) | NULL | ä¸­ç¼©ç•¥å›¾URL(500x500) |
| `thumbnail_large` | VARCHAR(500) | NULL | å¤§ç¼©ç•¥å›¾URL(1000x1000) |
| `file_size` | INTEGER | NOT NULL | æ–‡ä»¶å¤§å°(å­—èŠ‚) |
| `mime_type` | VARCHAR(50) | NOT NULL | MIMEç±»å‹ |
| `width` | INTEGER | NULL | å›¾ç‰‡å®½åº¦ |
| `height` | INTEGER | NULL | å›¾ç‰‡é«˜åº¦ |
| `description` | TEXT | NULL | å›¾ç‰‡æè¿° |
| `tags` | JSON | NULL | æ ‡ç­¾æ•°ç»„ |
| `status` | ENUM('pending','approved','rejected','deleted') | DEFAULT 'pending' | å®¡æ ¸çŠ¶æ€ |
| `reviewed_by` | INTEGER | NULL, FK â†’ users.user_id | å®¡æ ¸å‘˜ID |
| `reviewed_at` | DATETIME | NULL | å®¡æ ¸æ—¶é—´ |
| `rejection_reason` | VARCHAR(200) | NULL | æ‹’ç»åŸå›  |
| `points_awarded` | INTEGER | DEFAULT 0 | å¥–åŠ±çš„ç§¯åˆ† |
| `created_at` | DATETIME | NOT NULL | ä¸Šä¼ æ—¶é—´ |
| `updated_at` | DATETIME | NOT NULL | æ›´æ–°æ—¶é—´ |

---

#### A.11 ç³»ç»Ÿå…¬å‘Šè¡¨ (`system_announcements`)

**æ¨¡å‹æ–‡ä»¶**: `models/SystemAnnouncement.js`

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|-------|------|------|------|
| `id` | INTEGER | PK, AUTO_INCREMENT | å…¬å‘ŠID |
| `title` | VARCHAR(200) | NOT NULL | å…¬å‘Šæ ‡é¢˜ |
| `content` | TEXT | NOT NULL | å…¬å‘Šå†…å®¹ |
| `type` | ENUM('system','event','maintenance','other') | DEFAULT 'system' | å…¬å‘Šç±»å‹ |
| `priority` | ENUM('low','medium','high','urgent') | DEFAULT 'medium' | ä¼˜å…ˆçº§ |
| `is_pinned` | BOOLEAN | DEFAULT FALSE | æ˜¯å¦ç½®é¡¶ |
| `status` | ENUM('draft','published','archived') | DEFAULT 'draft' | å‘å¸ƒçŠ¶æ€ |
| `published_at` | DATETIME | NULL | å‘å¸ƒæ—¶é—´ |
| `expires_at` | DATETIME | NULL | è¿‡æœŸæ—¶é—´ |
| `created_by` | INTEGER | NOT NULL, FK â†’ users.user_id | åˆ›å»ºäººID |
| `created_at` | DATETIME | NOT NULL | åˆ›å»ºæ—¶é—´ |
| `updated_at` | DATETIME | NOT NULL | æ›´æ–°æ—¶é—´ |

---

#### A.12 ç”¨æˆ·åé¦ˆè¡¨ (`feedback`)

**æ¨¡å‹æ–‡ä»¶**: `models/Feedback.js`

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|-------|------|------|------|
| `id` | INTEGER | PK, AUTO_INCREMENT | åé¦ˆID |
| `user_id` | INTEGER | NOT NULL, FK â†’ users.user_id | ç”¨æˆ·ID |
| `type` | ENUM('bug','suggestion','complaint','other') | NOT NULL | åé¦ˆç±»å‹ |
| `title` | VARCHAR(200) | NOT NULL | åé¦ˆæ ‡é¢˜ |
| `content` | TEXT | NOT NULL | åé¦ˆå†…å®¹ |
| `contact` | VARCHAR(100) | NULL | è”ç³»æ–¹å¼ |
| `status` | ENUM('pending','in_progress','resolved','closed') | DEFAULT 'pending' | å¤„ç†çŠ¶æ€ |
| `admin_reply` | TEXT | NULL | ç®¡ç†å‘˜å›å¤ |
| `replied_by` | INTEGER | NULL, FK â†’ users.user_id | å›å¤ç®¡ç†å‘˜ID |
| `replied_at` | DATETIME | NULL | å›å¤æ—¶é—´ |
| `created_at` | DATETIME | NOT NULL | æäº¤æ—¶é—´ |
| `updated_at` | DATETIME | NOT NULL | æ›´æ–°æ—¶é—´ |

---

#### A.13 å…‘æ¢å•†å“è¡¨ (`products`)

**æ¨¡å‹æ–‡ä»¶**: `models/Product.js`

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|-------|------|------|------|
| `product_id` | INTEGER | PK, AUTO_INCREMENT | å•†å“ID |
| `name` | VARCHAR(100) | NOT NULL | å•†å“åç§° |
| `description` | TEXT | NULL | å•†å“æè¿° |
| `type` | ENUM('physical','virtual') | NOT NULL | å•†å“ç±»å‹ |
| `category` | VARCHAR(50) | NULL | å•†å“åˆ†ç±» |
| `points_required` | INTEGER | NOT NULL | æ‰€éœ€ç§¯åˆ† |
| `value` | DECIMAL(10,2) | NOT NULL | å•†å“ä»·å€¼(å…ƒ) |
| `stock_quantity` | INTEGER | NULL | åº“å­˜æ•°é‡(NULL=æ— é™) |
| `image_id` | INTEGER | NULL, FK â†’ image_resources.id | å•†å“å›¾ç‰‡ID |
| `status` | ENUM('active','inactive','out_of_stock') | DEFAULT 'active' | å•†å“çŠ¶æ€ |
| `exchange_count` | INTEGER | DEFAULT 0 | å…‘æ¢æ¬¡æ•°ç»Ÿè®¡ |
| `created_at` | DATETIME | NOT NULL | åˆ›å»ºæ—¶é—´ |
| `updated_at` | DATETIME | NOT NULL | æ›´æ–°æ—¶é—´ |

---

#### A.14 å…‘æ¢è®°å½•è¡¨ (`exchange_records`)

**æ¨¡å‹æ–‡ä»¶**: `models/ExchangeRecords.js`

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|-------|------|------|------|
| `exchange_id` | INTEGER | PK, AUTO_INCREMENT | å…‘æ¢è®°å½•ID |
| `user_id` | INTEGER | NOT NULL, FK â†’ users.user_id | ç”¨æˆ·ID |
| `product_id` | INTEGER | NOT NULL, FK â†’ products.product_id | å•†å“ID |
| `quantity` | INTEGER | NOT NULL | å…‘æ¢æ•°é‡ |
| `total_points` | INTEGER | NOT NULL | æ¶ˆè€—ç§¯åˆ†æ€»æ•° |
| `status` | ENUM('pending','completed','cancelled') | DEFAULT 'pending' | å…‘æ¢çŠ¶æ€ |
| `inventory_item_id` | INTEGER | NULL, FK â†’ user_inventory.inventory_id | åˆ›å»ºçš„åº“å­˜è®°å½•ID |
| `created_at` | DATETIME | NOT NULL | å…‘æ¢æ—¶é—´ |
| `completed_at` | DATETIME | NULL | å®Œæˆæ—¶é—´ |

---

#### A.15 ç®¡ç†å‘˜æ“ä½œæ—¥å¿—è¡¨ (`admin_operation_logs`)

**æ¨¡å‹æ–‡ä»¶**: `models/AdminOperationLog.js`

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|-------|------|------|------|
| `id` | INTEGER | PK, AUTO_INCREMENT | æ—¥å¿—ID |
| `admin_id` | INTEGER | NOT NULL, FK â†’ users.user_id | æ“ä½œç®¡ç†å‘˜ID |
| `action_type` | VARCHAR(50) | NOT NULL | æ“ä½œç±»å‹ |
| `action_description` | VARCHAR(200) | NULL | æ“ä½œæè¿° |
| `target_type` | VARCHAR(50) | NULL | ç›®æ ‡ç±»å‹ |
| `target_id` | INTEGER | NULL | ç›®æ ‡ID |
| `changes` | JSON | NULL | å˜æ›´è¯¦æƒ… |
| `ip_address` | VARCHAR(45) | NULL | æ“ä½œIP |
| `user_agent` | VARCHAR(255) | NULL | ç”¨æˆ·ä»£ç† |
| `created_at` | DATETIME | NOT NULL | æ“ä½œæ—¶é—´ |

---

## ğŸ“‹ é™„å½• B: å®Œæ•´é”™è¯¯ç å¤§å…¨

### B.1 è®¤è¯ç›¸å…³é”™è¯¯(1xx)

| é”™è¯¯ç  | HTTPçŠ¶æ€ | è¯´æ˜ | å‰ç«¯å¤„ç†å»ºè®® |
|-------|---------|------|------------|
| `UNAUTHORIZED` | 401 | æœªç™»å½•æˆ–Tokenæ— æ•ˆ | è·³è½¬åˆ°ç™»å½•é¡µ |
| `TOKEN_EXPIRED` | 401 | Tokenå·²è¿‡æœŸ | å°è¯•åˆ·æ–°Token,å¤±è´¥åˆ™è·³è½¬ç™»å½• |
| `INVALID_TOKEN` | 401 | Tokenæ ¼å¼é”™è¯¯æˆ–è¢«ç¯¡æ”¹ | æ¸…é™¤æœ¬åœ°Token,è·³è½¬ç™»å½• |
| `REFRESH_TOKEN_EXPIRED` | 401 | åˆ·æ–°Tokenå·²è¿‡æœŸ | è·³è½¬åˆ°ç™»å½•é¡µ |
| `VERIFICATION_CODE_INVALID` | 400 | éªŒè¯ç é”™è¯¯æˆ–è¿‡æœŸ | æç¤ºç”¨æˆ·é‡æ–°è·å–éªŒè¯ç  |
| `MOBILE_NOT_REGISTERED` | 400 | æ‰‹æœºå·æœªæ³¨å†Œ | å¼•å¯¼ç”¨æˆ·æ³¨å†Œ |

### B.2 æƒé™ç›¸å…³é”™è¯¯(2xx)

| é”™è¯¯ç  | HTTPçŠ¶æ€ | è¯´æ˜ | å‰ç«¯å¤„ç†å»ºè®® |
|-------|---------|------|------------|
| `FORBIDDEN` | 403 | æƒé™ä¸è¶³ | æ˜¾ç¤º"æ— æƒé™"æç¤º,éšè—ç›¸å…³åŠŸèƒ½ |
| `NO_CAMPAIGN_PERMISSION` | 403 | æ— æ´»åŠ¨å‚ä¸æƒé™ | æç¤ºè”ç³»ç®¡ç†å‘˜å¼€é€šæƒé™ |
| `ADMIN_REQUIRED` | 403 | éœ€è¦ç®¡ç†å‘˜æƒé™ | æ˜¾ç¤º"ä»…ç®¡ç†å‘˜å¯ç”¨" |
| `PERMISSION_DENIED` | 403 | ç‰¹å®šæƒé™ä¸è¶³ | æ˜¾ç¤ºç¼ºå°‘çš„å…·ä½“æƒé™ |

### B.3 èµ„æºç›¸å…³é”™è¯¯(3xx)

| é”™è¯¯ç  | HTTPçŠ¶æ€ | è¯´æ˜ | å‰ç«¯å¤„ç†å»ºè®® |
|-------|---------|------|------------|
| `NOT_FOUND` | 404 | èµ„æºä¸å­˜åœ¨ | æ˜¾ç¤º"æœªæ‰¾åˆ°"æç¤º,è¿”å›ä¸Šä¸€é¡µ |
| `USER_NOT_FOUND` | 404 | ç”¨æˆ·ä¸å­˜åœ¨ | æç¤º"ç”¨æˆ·ä¸å­˜åœ¨" |
| `CAMPAIGN_NOT_FOUND` | 404 | æ´»åŠ¨ä¸å­˜åœ¨ | æç¤º"æ´»åŠ¨å·²ç»“æŸæˆ–ä¸å­˜åœ¨" |
| `PRIZE_NOT_FOUND` | 404 | å¥–å“ä¸å­˜åœ¨ | æç¤º"å¥–å“ä¸å­˜åœ¨" |
| `ITEM_NOT_FOUND` | 404 | åº“å­˜ç‰©å“ä¸å­˜åœ¨ | æç¤º"ç‰©å“ä¸å­˜åœ¨" |
| `PRODUCT_NOT_FOUND` | 404 | å…‘æ¢å•†å“ä¸å­˜åœ¨ | æç¤º"å•†å“ä¸å­˜åœ¨" |

### B.4 ä¸šåŠ¡è§„åˆ™é”™è¯¯(4xx)

| é”™è¯¯ç  | HTTPçŠ¶æ€ | è¯´æ˜ | å‰ç«¯å¤„ç†å»ºè®® |
|-------|---------|------|------------|
| `INSUFFICIENT_POINTS` | 400 | ç§¯åˆ†ä¸è¶³ | æ˜¾ç¤ºå½“å‰ç§¯åˆ†å’Œæ‰€éœ€ç§¯åˆ†,å¼•å¯¼èµšç§¯åˆ† |
| `DAILY_LIMIT_EXCEEDED` | 400 | æ¯æ—¥æ¬¡æ•°å·²ç”¨å®Œ | æç¤º"æ˜å¤©å†æ¥" |
| `RATE_LIMIT_EXCEEDED` | 429 | è¯·æ±‚è¿‡äºé¢‘ç¹ | æç¤º"è¯·æ±‚è¿‡å¿«,è¯·ç¨åå†è¯•" |
| `INSUFFICIENT_STOCK` | 400 | åº“å­˜ä¸è¶³ | æç¤º"åº“å­˜ä¸è¶³" |
| `ITEM_ALREADY_USED` | 400 | ç‰©å“å·²ä½¿ç”¨ | æç¤º"è¯¥ç‰©å“å·²ä½¿ç”¨" |
| `ITEM_EXPIRED` | 400 | ç‰©å“å·²è¿‡æœŸ | æç¤º"è¯¥ç‰©å“å·²è¿‡æœŸ" |
| `TRANSFER_LIMIT_EXCEEDED` | 400 | è¶…è¿‡è½¬ç§»æ¬¡æ•°é™åˆ¶ | æç¤º"è¯¥ç‰©å“å·²è¾¾æœ€å¤§è½¬ç§»æ¬¡æ•°" |
| `INVALID_VERIFICATION_CODE` | 400 | æ ¸é”€ç æ— æ•ˆ | æç¤º"æ ¸é”€ç é”™è¯¯æˆ–å·²å¤±æ•ˆ" |
| `CODE_ALREADY_EXISTS` | 400 | æ ¸é”€ç å·²å­˜åœ¨ | æç¤º"å·²ç”Ÿæˆæ ¸é”€ç " |

### B.5 æ–‡ä»¶ä¸Šä¼ é”™è¯¯(5xx)

| é”™è¯¯ç  | HTTPçŠ¶æ€ | è¯´æ˜ | å‰ç«¯å¤„ç†å»ºè®® |
|-------|---------|------|------------|
| `INVALID_FILE_TYPE` | 400 | ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ | æç¤ºæ”¯æŒçš„æ ¼å¼åˆ—è¡¨ |
| `FILE_TOO_LARGE` | 400 | æ–‡ä»¶è¿‡å¤§ | æç¤ºæœ€å¤§æ–‡ä»¶å¤§å°é™åˆ¶ |
| `UPLOAD_FAILED` | 500 | ä¸Šä¼ å¤±è´¥ | æç¤º"ä¸Šä¼ å¤±è´¥,è¯·é‡è¯•" |
| `ALREADY_REVIEWED` | 400 | å›¾ç‰‡å·²å®¡æ ¸ | æç¤º"è¯¥å›¾ç‰‡å·²è¢«å®¡æ ¸" |

### B.6 ç³»ç»Ÿé”™è¯¯(9xx)

| é”™è¯¯ç  | HTTPçŠ¶æ€ | è¯´æ˜ | å‰ç«¯å¤„ç†å»ºè®® |
|-------|---------|------|------------|
| `INTERNAL_ERROR` | 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ | æç¤º"ç³»ç»Ÿé”™è¯¯,è¯·ç¨åé‡è¯•" |
| `DATABASE_ERROR` | 500 | æ•°æ®åº“é”™è¯¯ | æç¤º"ç³»ç»Ÿç¹å¿™,è¯·ç¨åé‡è¯•" |
| `VALIDATION_ERROR` | 400 | å‚æ•°éªŒè¯å¤±è´¥ | æ˜¾ç¤ºå…·ä½“å‚æ•°é”™è¯¯ä¿¡æ¯ |
| `SERVICE_UNAVAILABLE` | 503 | æœåŠ¡ä¸å¯ç”¨ | æç¤º"æœåŠ¡æš‚æ—¶ä¸å¯ç”¨" |

---

## ğŸš€ é™„å½• C: éƒ¨ç½²è¯´æ˜

### C.1 ç¯å¢ƒå˜é‡é…ç½®

**`.env` æ–‡ä»¶é…ç½®**:
```bash
# æœåŠ¡å™¨é…ç½®
NODE_ENV=production
PORT=3000
TRUST_PROXY=true                              # Sealoséƒ¨ç½²å¿…éœ€

# æ•°æ®åº“é…ç½®
DB_HOST=your-mysql-host.sealos.io
DB_PORT=3306
DB_NAME=restaurant_lottery
DB_USER=your_db_user
DB_PASSWORD=your_db_password
DB_TIMEZONE=+08:00                            # åŒ—äº¬æ—¶é—´

# JWTé…ç½®
JWT_SECRET=your_very_secure_jwt_secret_key_here
JWT_ACCESS_EXPIRY=7d                          # access_tokenæœ‰æ•ˆæœŸ7å¤©
JWT_REFRESH_EXPIRY=30d                        # refresh_tokenæœ‰æ•ˆæœŸ30å¤©

# Redisé…ç½®(å¯é€‰)
REDIS_ENABLED=true
REDIS_HOST=your-redis-host.sealos.io
REDIS_PORT=6379
REDIS_PASSWORD=your_redis_password

# Sealoså¯¹è±¡å­˜å‚¨é…ç½® (å®é™…ä»£ç éªŒè¯ âœ…)
SEALOS_ACCESS_KEY=br0za7uc
SEALOS_SECRET_KEY=skxg8mk5gqfhf9xz
SEALOS_ENDPOINT=https://objectstorageapi.bja.sealos.run
SEALOS_REGION=bja
# æ³¨æ„: bucketåç§°åœ¨ä»£ç ä¸­ç¡¬ç¼–ç ä¸º 'br0za7uc-tiangong'

# ç³»ç»Ÿé…ç½®
INITIAL_POINTS=100                            # æ–°ç”¨æˆ·åˆå§‹ç§¯åˆ†
PHOTO_APPROVAL_REWARD=50                      # å›¾ç‰‡å®¡æ ¸é€šè¿‡å¥–åŠ±
MAX_FILE_SIZE=10485760                        # å›¾ç‰‡æœ€å¤§10MB
```

### C.2 Sealoséƒ¨ç½²é…ç½®

**å…³é”®é…ç½®é¡¹**:

1. **åº”ç”¨é…ç½®**:
   - Node.jsç‰ˆæœ¬: 20.18.0+
   - å†…å­˜: 512MB - 1GB
   - CPU: 0.5 - 1 core
   - å¯åŠ¨å‘½ä»¤: `npm start`

2. **åŸŸåé…ç½®**:
   - ç”Ÿäº§åŸŸå: `https://omqktqrtntnn.sealosbja.site`
   - å…¬ç½‘è®¿é—®ç«¯å£: 3000

3. **ç¯å¢ƒå˜é‡**:
   - åœ¨Sealosæ§åˆ¶å°é…ç½®æ‰€æœ‰ç¯å¢ƒå˜é‡
   - ç¡®ä¿ `TRUST_PROXY=true`

4. **æ•°æ®åº“é…ç½®**:
   - ä½¿ç”¨Sealos MySQL 8.0
   - æ—¶åŒºè®¾ç½®: `Asia/Shanghai` (UTC+8)
   - è¿æ¥æ± : 5-20ä¸ªè¿æ¥

5. **å¯¹è±¡å­˜å‚¨é…ç½®**:
   - ä½¿ç”¨Sealoså¯¹è±¡å­˜å‚¨
   - Bucket: `br0za7uc-tiangong`
   - å…¬å…±è¯»æƒé™: ACL='public-read'

### C.3 æ•°æ®åº“åˆå§‹åŒ–

**æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬**:
```sql
-- è®¾ç½®æ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´
SET time_zone = '+08:00';
SET SESSION time_zone = 'Asia/Shanghai';

-- åˆå§‹åŒ–è§’è‰²æ•°æ®
INSERT INTO roles (role_name, description, role_level) VALUES
('admin', 'è¶…çº§ç®¡ç†å‘˜', 100),
('user', 'æ™®é€šç”¨æˆ·', 0);

-- åˆå§‹åŒ–ç³»ç»Ÿå…¬å‘Š
INSERT INTO system_announcements (title, content, type, priority, status, created_by, published_at) VALUES
('æ¬¢è¿ä½¿ç”¨é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ', 'ç³»ç»Ÿå·²ä¸Šçº¿,å¿«æ¥å‚ä¸æŠ½å¥–å§!', 'system', 'high', 'published', 1, NOW());
```

### C.4 é¦–æ¬¡å¯åŠ¨æ£€æŸ¥æ¸…å•

- [ ] ç¯å¢ƒå˜é‡é…ç½®å®Œæˆ
- [ ] æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸ
- [ ] Redisè¿æ¥æµ‹è¯•æˆåŠŸ(å¯é€‰)
- [ ] Sealoså¯¹è±¡å­˜å‚¨æµ‹è¯•æˆåŠŸ
- [ ] æ•°æ®åº“è¡¨ç»“æ„åŒæ­¥å®Œæˆ
- [ ] åˆå§‹æ•°æ®æ’å…¥å®Œæˆ
- [ ] JWT_SECRETå·²è®¾ç½®ä¸ºå®‰å…¨å¯†é’¥
- [ ] å¥åº·æ£€æŸ¥æ¥å£æ­£å¸¸å“åº”
- [ ] å¾®ä¿¡å°ç¨‹åºæœåŠ¡å™¨åŸŸåå·²é…ç½®

---

## ğŸ› ï¸ é™„å½• D: å¾®ä¿¡å°ç¨‹åºå·¥å…·ç±»å®Œæ•´å®ç°

### D.1 ç»Ÿä¸€è¯·æ±‚å°è£… (`utils/request.js`)

```javascript
/**
 * å¾®ä¿¡å°ç¨‹åºç»Ÿä¸€APIè¯·æ±‚å·¥å…·
 * åŠŸèƒ½: è‡ªåŠ¨Tokenç®¡ç†ã€é”™è¯¯å¤„ç†ã€è¯·æ±‚é‡è¯•
 */

const BASE_URL = 'https://omqktqrtntnn.sealosbja.site';
const API_PREFIX = '/api/v4';

// Tokenåˆ·æ–°é”
let isRefreshing = false;
let refreshSubscribers = [];

/**
 * æ·»åŠ åˆ·æ–°è®¢é˜…è€…
 */
function subscribeTokenRefresh(callback) {
  refreshSubscribers.push(callback);
}

/**
 * é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…Tokenå·²åˆ·æ–°
 */
function onTokenRefreshed(newToken) {
  refreshSubscribers.forEach(callback => callback(newToken));
  refreshSubscribers = [];
}

/**
 * åˆ·æ–°Token
 */
async function refreshToken() {
  const refresh_token = wx.getStorageSync('refresh_token');
  
  if (!refresh_token) {
    throw new Error('æ— refresh_token');
  }
  
  try {
    const res = await wx.request({
      url: BASE_URL + API_PREFIX + '/unified-engine/auth/refresh',
      method: 'POST',
      data: {
        refresh_token: refresh_token
      }
    });
    
    if (res.data.success) {
      // ä¿å­˜æ–°Token
      wx.setStorageSync('access_token', res.data.data.access_token);
      wx.setStorageSync('refresh_token', res.data.data.refresh_token);
      
      return res.data.data.access_token;
    } else {
      throw new Error('Tokenåˆ·æ–°å¤±è´¥');
    }
  } catch (error) {
    console.error('Tokenåˆ·æ–°å¤±è´¥:', error);
    throw error;
  }
}

/**
 * ç»Ÿä¸€è¯·æ±‚å‡½æ•°
 * @param {Object} options - è¯·æ±‚é€‰é¡¹
 * @returns {Promise} è¯·æ±‚Promise
 */
function request(options) {
  return new Promise((resolve, reject) => {
    const access_token = wx.getStorageSync('access_token');
    
    wx.request({
      url: BASE_URL + API_PREFIX + options.url,
      method: options.method || 'GET',
      data: options.data || {},
      header: {
        'Content-Type': 'application/json',
        'Authorization': access_token ? 'Bearer ' + access_token : '',
        ...options.header
      },
      timeout: options.timeout || 30000,
      success: async (res) => {
        // è¯·æ±‚æˆåŠŸ
        if (res.data.success) {
          resolve(res.data);
        } 
        // Tokenè¿‡æœŸ,å°è¯•åˆ·æ–°
        else if (res.data.error === 'UNAUTHORIZED' || res.data.error === 'TOKEN_EXPIRED') {
          if (!isRefreshing) {
            isRefreshing = true;
            
            try {
              const newToken = await refreshToken();
              isRefreshing = false;
              
              // é€šçŸ¥æ‰€æœ‰ç­‰å¾…çš„è¯·æ±‚
              onTokenRefreshed(newToken);
              
              // é‡è¯•åŸè¯·æ±‚
              const retryRes = await wx.request({
                ...options,
                url: BASE_URL + API_PREFIX + options.url,
                header: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + newToken,
                  ...options.header
                }
              });
              
              if (retryRes.data.success) {
                resolve(retryRes.data);
              } else {
                reject(retryRes.data);
              }
            } catch (refreshError) {
              isRefreshing = false;
              
              // Tokenåˆ·æ–°å¤±è´¥,è·³è½¬ç™»å½•
              wx.redirectTo({
                url: '/pages/login/login'
              });
              
              reject({ error: 'TOKEN_REFRESH_FAILED', message: 'ç™»å½•å·²è¿‡æœŸ,è¯·é‡æ–°ç™»å½•' });
            }
          } else {
            // æ­£åœ¨åˆ·æ–°,ç­‰å¾…åˆ·æ–°å®Œæˆ
            subscribeTokenRefresh((newToken) => {
              // ä½¿ç”¨æ–°Tokené‡è¯•è¯·æ±‚
              request(options).then(resolve).catch(reject);
            });
          }
        }
        // å…¶ä»–é”™è¯¯
        else {
          // æ˜¾ç¤ºé”™è¯¯æç¤º
          if (!options.silent) {
            wx.showToast({
              title: res.data.message || 'æ“ä½œå¤±è´¥',
              icon: 'none',
              duration: 2000
            });
          }
          reject(res.data);
        }
      },
      fail: (err) => {
        // ç½‘ç»œé”™è¯¯
        if (!options.silent) {
          wx.showToast({
            title: 'ç½‘ç»œè¯·æ±‚å¤±è´¥',
            icon: 'none',
            duration: 2000
          });
        }
        reject({ error: 'NETWORK_ERROR', message: 'ç½‘ç»œè¯·æ±‚å¤±è´¥', details: err });
      }
    });
  });
}

/**
 * ä¸Šä¼ æ–‡ä»¶
 * @param {Object} options - ä¸Šä¼ é€‰é¡¹
 * @returns {Promise} ä¸Šä¼ Promise
 */
function uploadFile(options) {
  return new Promise((resolve, reject) => {
    const access_token = wx.getStorageSync('access_token');
    
    const uploadTask = wx.uploadFile({
      url: BASE_URL + API_PREFIX + options.url,
      filePath: options.filePath,
      name: options.name || 'file',
      formData: options.formData || {},
      header: {
        'Authorization': 'Bearer ' + access_token,
        ...options.header
      },
      timeout: options.timeout || 60000,
      success: (res) => {
        try {
          const data = JSON.parse(res.data);
          
          if (data.success) {
            resolve(data);
          } else {
            if (!options.silent) {
              wx.showToast({
                title: data.message || 'ä¸Šä¼ å¤±è´¥',
                icon: 'none'
              });
            }
            reject(data);
          }
        } catch (error) {
          reject({ error: 'PARSE_ERROR', message: 'å“åº”è§£æå¤±è´¥' });
        }
      },
      fail: (err) => {
        if (!options.silent) {
          wx.showToast({
            title: 'ä¸Šä¼ å¤±è´¥',
            icon: 'none'
          });
        }
        reject({ error: 'UPLOAD_ERROR', message: 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥', details: err });
      }
    });
    
    // è¿”å›ä¸Šä¼ ä»»åŠ¡(å¯ç”¨äºæ˜¾ç¤ºè¿›åº¦)
    if (options.onProgress) {
      uploadTask.onProgressUpdate(options.onProgress);
    }
  });
}

module.exports = {
  request,
  uploadFile,
  BASE_URL,
  API_PREFIX
};
```

### D.2 APIè°ƒç”¨å°è£… (`utils/api.js`)

```javascript
/**
 * APIè°ƒç”¨å°è£…
 * æä¾›æ‰€æœ‰ä¸šåŠ¡APIçš„ä¾¿æ·è°ƒç”¨æ–¹æ³•
 */

const { request, uploadFile } = require('./request.js');

const API = {
  // ========== è®¤è¯ç›¸å…³ ==========
  
  /**
   * ç”¨æˆ·ç™»å½•
   * @param {string} mobile - æ‰‹æœºå·
   * @param {string} verification_code - éªŒè¯ç 
   */
  login: (mobile, verification_code) => request({
    url: '/unified-engine/auth/login',
    method: 'POST',
    data: { mobile, verification_code }
  }),
  
  /**
   * å¿«é€Ÿç™»å½•(æµ‹è¯•ä¸“ç”¨)
   * @param {string} mobile - æ‰‹æœºå·
   */
  quickLogin: (mobile) => request({
    url: '/unified-engine/auth/quick-login',
    method: 'POST',
    data: { mobile }
  }),
  
  /**
   * è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
   */
  getProfile: () => request({
    url: '/unified-engine/auth/profile',
    method: 'GET'
  }),
  
  /**
   * éªŒè¯Token
   */
  verifyToken: () => request({
    url: '/unified-engine/auth/verify',
    method: 'POST',
    silent: true  // é™é»˜è¯·æ±‚,ä¸æ˜¾ç¤ºé”™è¯¯æç¤º
  }),
  
  // ========== æŠ½å¥–ç›¸å…³ ==========
  
  /**
   * è·å–æ´»åŠ¨å¥–å“åˆ—è¡¨
   * @param {string} campaignCode - æ´»åŠ¨ä»£ç 
   */
  getPrizes: (campaignCode) => request({
    url: `/unified-engine/lottery/prizes/${campaignCode}`,
    method: 'GET'
  }),
  
  /**
   * è·å–æ´»åŠ¨é…ç½®
   * @param {string} campaignCode - æ´»åŠ¨ä»£ç 
   */
  getCampaignConfig: (campaignCode) => request({
    url: `/unified-engine/lottery/config/${campaignCode}`,
    method: 'GET'
  }),
  
  /**
   * æ‰§è¡ŒæŠ½å¥–
   * @param {string} campaign_code - æ´»åŠ¨ä»£ç 
   * @param {number} draw_count - æŠ½å¥–æ¬¡æ•°
   */
  draw: (campaign_code, draw_count = 1) => request({
    url: '/unified-engine/lottery/draw',
    method: 'POST',
    data: { campaign_code, draw_count }
  }),
  
  /**
   * è·å–æŠ½å¥–å†å²
   * @param {number} user_id - ç”¨æˆ·ID
   * @param {Object} params - æŸ¥è¯¢å‚æ•°
   */
  getDrawHistory: (user_id, params = {}) => request({
    url: `/unified-engine/lottery/history/${user_id}`,
    method: 'GET',
    data: params
  }),
  
  /**
   * è·å–æ´»åŠ¨åˆ—è¡¨
   * @param {string} status - æ´»åŠ¨çŠ¶æ€ç­›é€‰
   */
  getCampaigns: (status = 'active') => request({
    url: `/unified-engine/lottery/campaigns?status=${status}`,
    method: 'GET'
  }),
  
  // ========== åº“å­˜ç›¸å…³ ==========
  
  /**
   * è·å–ç”¨æˆ·åº“å­˜åˆ—è¡¨
   * @param {number} user_id - ç”¨æˆ·ID
   * @param {Object} params - æŸ¥è¯¢å‚æ•°
   */
  getUserInventory: (user_id, params = {}) => request({
    url: `/inventory/user/${user_id}`,
    method: 'GET',
    data: params
  }),
  
  /**
   * æŸ¥è¯¢åº“å­˜ç‰©å“è¯¦æƒ…
   * @param {number} item_id - ç‰©å“ID
   */
  getInventoryItem: (item_id) => request({
    url: `/inventory/item/${item_id}`,
    method: 'GET'
  }),
  
  /**
   * ä½¿ç”¨åº“å­˜ç‰©å“
   * @param {number} item_id - ç‰©å“ID
   * @param {string} verification_code - æ ¸é”€ç (å¯é€‰)
   */
  useInventoryItem: (item_id, verification_code = null) => request({
    url: `/inventory/use/${item_id}`,
    method: 'POST',
    data: { verification_code }
  }),
  
  /**
   * ç”Ÿæˆæ ¸é”€ç 
   * @param {number} item_id - ç‰©å“ID
   */
  generateVerificationCode: (item_id) => request({
    url: `/inventory/generate-code/${item_id}`,
    method: 'POST'
  }),
  
  /**
   * è½¬ç§»ç‰©å“
   * @param {number} item_id - ç‰©å“ID
   * @param {number} to_user_id - æ¥æ”¶ç”¨æˆ·ID
   * @param {string} message - ç•™è¨€
   */
  transferItem: (item_id, to_user_id, message = '') => request({
    url: '/inventory/transfer',
    method: 'POST',
    data: { item_id, to_user_id, message }
  }),
  
  /**
   * è·å–å¯å…‘æ¢å•†å“åˆ—è¡¨
   * @param {Object} params - æŸ¥è¯¢å‚æ•°
   */
  getExchangeProducts: (params = {}) => request({
    url: '/inventory/products',
    method: 'GET',
    data: params
  }),
  
  /**
   * å…‘æ¢å•†å“
   * @param {number} product_id - å•†å“ID
   * @param {number} quantity - æ•°é‡
   */
  exchangeProduct: (product_id, quantity = 1) => request({
    url: '/inventory/exchange',
    method: 'POST',
    data: { product_id, quantity }
  }),
  
  // ========== ç§¯åˆ†ç›¸å…³ ==========
  
  /**
   * è·å–å½“å‰ç”¨æˆ·ç§¯åˆ†ä½™é¢
   */
  getPointsBalance: () => request({
    url: '/unified-engine/points/balance',
    method: 'GET'
  }),
  
  /**
   * è·å–ç§¯åˆ†äº¤æ˜“è®°å½•
   * @param {number} user_id - ç”¨æˆ·ID
   * @param {Object} params - æŸ¥è¯¢å‚æ•°
   */
  getPointsTransactions: (user_id, params = {}) => request({
    url: `/unified-engine/points/transactions/${user_id}`,
    method: 'GET',
    data: params
  }),
  
  // ========== å›¾ç‰‡ç›¸å…³ ==========
  
  /**
   * ä¸Šä¼ å›¾ç‰‡
   * @param {string} filePath - æœ¬åœ°å›¾ç‰‡è·¯å¾„
   * @param {Object} formData - è¡¨å•æ•°æ®
   * @param {Function} onProgress - è¿›åº¦å›è°ƒ
   */
  uploadPhoto: (filePath, formData = {}, onProgress = null) => uploadFile({
    url: '/photo/upload',
    filePath: filePath,
    name: 'image',
    formData: formData,
    onProgress: onProgress
  }),
  
  /**
   * è·å–æˆ‘çš„ä¸Šä¼ è®°å½•
   * @param {Object} params - æŸ¥è¯¢å‚æ•°
   */
  getMyUploads: (params = {}) => request({
    url: '/photo/my-uploads',
    method: 'GET',
    data: params
  }),
  
  /**
   * åˆ é™¤å›¾ç‰‡
   * @param {number} id - å›¾ç‰‡ID
   */
  deletePhoto: (id) => request({
    url: `/photo/${id}`,
    method: 'DELETE'
  }),
  
  // ========== ç³»ç»Ÿç›¸å…³ ==========
  
  /**
   * è·å–ç³»ç»Ÿå…¬å‘Šåˆ—è¡¨
   * @param {Object} params - æŸ¥è¯¢å‚æ•°
   */
  getAnnouncements: (params = {}) => request({
    url: '/system/announcements',
    method: 'GET',
    data: params
  }),
  
  /**
   * è·å–é¦–é¡µå…¬å‘Š
   */
  getHomeAnnouncements: () => request({
    url: '/system/announcements/home',
    method: 'GET'
  }),
  
  /**
   * æäº¤åé¦ˆ
   * @param {Object} feedbackData - åé¦ˆæ•°æ®
   */
  submitFeedback: (feedbackData) => request({
    url: '/system/feedback',
    method: 'POST',
    data: feedbackData
  }),
  
  /**
   * è·å–æˆ‘çš„åé¦ˆåˆ—è¡¨
   * @param {Object} params - æŸ¥è¯¢å‚æ•°
   */
  getMyFeedback: (params = {}) => request({
    url: '/system/feedback/my',
    method: 'GET',
    data: params
  }),
  
  /**
   * è·å–ç³»ç»ŸçŠ¶æ€
   */
  getSystemStatus: () => request({
    url: '/system/status',
    method: 'GET'
  }),
  
  // ========== æƒé™ç›¸å…³ ==========
  
  /**
   * è·å–å½“å‰ç”¨æˆ·æƒé™
   */
  getCurrentPermissions: () => request({
    url: '/permissions/current',
    method: 'GET'
  }),
  
  /**
   * æ£€æŸ¥æƒé™
   * @param {string} resource - èµ„æºç±»å‹
   * @param {string} action - æ“ä½œç±»å‹
   */
  checkPermission: (resource, action) => request({
    url: '/permissions/check',
    method: 'POST',
    data: { resource, action }
  })
};

module.exports = API;
```

### D.3 æ—¶é—´æ ¼å¼åŒ–å·¥å…· (`utils/time.js`)

```javascript
/**
 * æ—¶é—´æ ¼å¼åŒ–å·¥å…·
 * å¤„ç†åç«¯è¿”å›çš„åŒ—äº¬æ—¶é—´ISOæ ¼å¼
 */

/**
 * æ ¼å¼åŒ–ISOæ—¶é—´ä¸ºå¯è¯»æ ¼å¼
 * @param {string} isoString - ISOæ ¼å¼æ—¶é—´å­—ç¬¦ä¸²
 * @param {string} format - æ ¼å¼: 'datetime'/'date'/'time'
 * @returns {string} æ ¼å¼åŒ–åçš„æ—¶é—´
 */
function formatTime(isoString, format = 'datetime') {
  if (!isoString) return '';
  
  const date = new Date(isoString);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const seconds = String(date.getSeconds()).padStart(2, '0');
  
  switch (format) {
    case 'datetime':
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    case 'date':
      return `${year}-${month}-${day}`;
    case 'time':
      return `${hours}:${minutes}:${seconds}`;
    case 'cn':
      return `${year}å¹´${month}æœˆ${day}æ—¥ ${hours}:${minutes}`;
    default:
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
  }
}

/**
 * ç›¸å¯¹æ—¶é—´æ˜¾ç¤º
 * @param {string} isoString - ISOæ ¼å¼æ—¶é—´å­—ç¬¦ä¸²
 * @returns {string} ç›¸å¯¹æ—¶é—´,å¦‚"1å°æ—¶å‰"
 */
function timeAgo(isoString) {
  if (!isoString) return '';
  
  const now = new Date();
  const time = new Date(isoString);
  const diffMs = now - time;
  const diffMinutes = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMinutes / 60);
  const diffDays = Math.floor(diffHours / 24);
  
  if (diffDays > 0) return `${diffDays}å¤©å‰`;
  if (diffHours > 0) return `${diffHours}å°æ—¶å‰`;
  if (diffMinutes > 0) return `${diffMinutes}åˆ†é’Ÿå‰`;
  return 'åˆšåˆš';
}

module.exports = {
  formatTime,
  timeAgo
};
```

### D.4 æƒé™æ£€æŸ¥å·¥å…· (`utils/permission.js`)

```javascript
/**
 * æƒé™æ£€æŸ¥å·¥å…·
 */

const API = require('./api.js');

/**
 * æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
 * @returns {boolean} æ˜¯å¦å·²ç™»å½•
 */
function isLoggedIn() {
  const access_token = wx.getStorageSync('access_token');
  return !!access_token;
}

/**
 * æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜
 * @returns {boolean} æ˜¯å¦æ˜¯ç®¡ç†å‘˜
 */
function isAdmin() {
  const user_info = wx.getStorageSync('user_info');
  return user_info && user_info.role_based_admin === true;
}

/**
 * ç¡®ä¿ç”¨æˆ·å·²ç™»å½•,æœªç™»å½•åˆ™è·³è½¬
 * @returns {boolean} æ˜¯å¦å·²ç™»å½•
 */
function ensureLogin() {
  if (!isLoggedIn()) {
    wx.showModal({
      title: 'æç¤º',
      content: 'è¯·å…ˆç™»å½•',
      success: (res) => {
        if (res.confirm) {
          wx.redirectTo({
            url: '/pages/login/login'
          });
        }
      }
    });
    return false;
  }
  return true;
}

/**
 * æ£€æŸ¥ç”¨æˆ·æƒé™
 * @param {string} resource - èµ„æºç±»å‹
 * @param {string} action - æ“ä½œç±»å‹
 * @returns {Promise<boolean>} æ˜¯å¦æœ‰æƒé™
 */
async function checkPermission(resource, action) {
  try {
    const res = await API.checkPermission(resource, action);
    return res.data.has_permission;
  } catch (error) {
    console.error('æƒé™æ£€æŸ¥å¤±è´¥:', error);
    return false;
  }
}

module.exports = {
  isLoggedIn,
  isAdmin,
  ensureLogin,
  checkPermission
};
```

---

## ğŸ“– é™„å½• E: å¸¸è§é—®é¢˜FAQ

### E.1 Tokenç®¡ç†ç›¸å…³

**Q1: Tokenä»€ä¹ˆæ—¶å€™ä¼šè¿‡æœŸ?**
- access_tokenæœ‰æ•ˆæœŸ: 7å¤©
- refresh_tokenæœ‰æ•ˆæœŸ: 30å¤©
- è¶…è¿‡æœ‰æ•ˆæœŸåéœ€è¦é‡æ–°ç™»å½•

**Q2: å¦‚ä½•åˆ¤æ–­Tokenå·²è¿‡æœŸ?**
- APIè¿”å›é”™è¯¯ç  `UNAUTHORIZED` æˆ– `TOKEN_EXPIRED`
- æ­¤æ—¶åº”è‡ªåŠ¨è°ƒç”¨åˆ·æ–°Tokenæ¥å£

**Q3: Tokenåˆ·æ–°å¤±è´¥æ€ä¹ˆåŠ?**
- æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„Token
- è·³è½¬åˆ°ç™»å½•é¡µé¢
- æç¤ºç”¨æˆ·é‡æ–°ç™»å½•

### E.2 æ´»åŠ¨æƒé™ç›¸å…³

**Q1: å¦‚ä½•åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰æŸä¸ªæ´»åŠ¨çš„æƒé™?**
- æ–¹å¼1: æŸ¥çœ‹ç”¨æˆ·çš„rolesæ•°ç»„ä¸­æ˜¯å¦æœ‰ `campaign_{æ´»åŠ¨ID}` è§’è‰²
- æ–¹å¼2: ç›´æ¥è°ƒç”¨æŠ½å¥–API,å¦‚æœè¿”å› `NO_CAMPAIGN_PERMISSION` é”™è¯¯åˆ™æ— æƒé™
- æ–¹å¼3: è°ƒç”¨æ´»åŠ¨åˆ—è¡¨API,æŸ¥çœ‹ `has_permission` å­—æ®µ

**Q2: æ™®é€šç”¨æˆ·å¦‚ä½•è·å¾—æ´»åŠ¨æƒé™?**
- éœ€è¦ç®¡ç†å‘˜åˆ†é…æ´»åŠ¨æƒé™
- ç®¡ç†å‘˜è°ƒç”¨ `/api/v4/unified-engine/admin/campaign-permissions/assign` API

**Q3: ç®¡ç†å‘˜æ˜¯å¦éœ€è¦æ´»åŠ¨æƒé™?**
- ä¸éœ€è¦,ç®¡ç†å‘˜(role_level >= 100)è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æ´»åŠ¨çš„æƒé™

### E.3 æ•°æ®è„±æ•ç›¸å…³

**Q1: ä¸ºä»€ä¹ˆçœ‹ä¸åˆ°æŠ½å¥–æ¦‚ç‡?**
- è¿™æ˜¯å•†ä¸šæœºå¯†,ä»…ç®¡ç†å‘˜å¯è§
- æ™®é€šç”¨æˆ·è°ƒç”¨APIæ—¶,åç«¯è‡ªåŠ¨ç§»é™¤ `probability`ã€`stock` ç­‰æ•æ„Ÿå­—æ®µ

**Q2: å“ªäº›æ•°æ®è¢«è„±æ•äº†?**
- **å¥–å“**: æ¦‚ç‡ã€åº“å­˜ã€æˆæœ¬ä»·
- **æ´»åŠ¨é…ç½®**: æ¦‚ç‡ç­–ç•¥ã€ä¿åº•é…ç½®ã€æˆæœ¬ç®¡ç†
- **ç”¨æˆ·æ‰‹æœºå·**: æ˜¾ç¤ºä¸º `138****8000` æ ¼å¼
- **çœŸå®å§“å**: ä»…ç®¡ç†å‘˜å¯è§

**Q3: ç®¡ç†å‘˜èƒ½çœ‹åˆ°å®Œæ•´æ•°æ®å—?**
- å¯ä»¥,ç®¡ç†å‘˜è¯·æ±‚æ—¶åç«¯è¿”å› `full` çº§åˆ«æ•°æ®,åŒ…å«æ‰€æœ‰æ•æ„Ÿå­—æ®µ

### E.4 å›¾ç‰‡ä¸Šä¼ ç›¸å…³

**Q1: æ”¯æŒå“ªäº›å›¾ç‰‡æ ¼å¼?**
- æ”¯æŒ: jpgã€jpegã€pngã€gifã€webp
- æœ€å¤§æ–‡ä»¶å¤§å°: 10MB

**Q2: ç¼©ç•¥å›¾æ˜¯æ€ä¹ˆç”Ÿæˆçš„?**
- åç«¯è‡ªåŠ¨ç”Ÿæˆ3ç§å°ºå¯¸: å°(150x150)ã€ä¸­(500x500)ã€å¤§(1000x1000)
- å‰ç«¯å¯æ ¹æ®ä½¿ç”¨åœºæ™¯é€‰æ‹©åˆé€‚çš„ç¼©ç•¥å›¾

**Q3: å›¾ç‰‡å®¡æ ¸é€šè¿‡åä¼šæ€æ ·?**
- è‡ªåŠ¨å¥–åŠ±ç”¨æˆ·50ç§¯åˆ†
- å›¾ç‰‡çŠ¶æ€å˜æ›´ä¸º `approved`
- ç”¨æˆ·å¯åœ¨"æˆ‘çš„ä¸Šä¼ "ä¸­æŸ¥çœ‹

### E.5 ç§¯åˆ†ç³»ç»Ÿç›¸å…³

**Q1: ç§¯åˆ†å¦‚ä½•è·å¾—?**
- æŠ½å¥–ä¸­å¥–: æ ¹æ®å¥–å“ä»·å€¼è·å¾—ç§¯åˆ†
- å›¾ç‰‡å®¡æ ¸é€šè¿‡: æ¯å¼ 50ç§¯åˆ†
- æ¯æ—¥ç­¾åˆ°: 10ç§¯åˆ†(å¦‚æœå¼€å¯)
- ç®¡ç†å‘˜è°ƒæ•´: ç®¡ç†å‘˜å¯æ‰‹åŠ¨å¢åŠ /æ‰£é™¤ç§¯åˆ†

**Q2: ç§¯åˆ†å¦‚ä½•ä½¿ç”¨?**
- å‚ä¸æŠ½å¥–: æ¯æ¬¡æ¶ˆè€—é…ç½®çš„ç§¯åˆ†æ•°
- å…‘æ¢å•†å“: ä½¿ç”¨ç§¯åˆ†å…‘æ¢å®ç‰©/è™šæ‹Ÿå•†å“
- å¸‚åœºäº¤æ˜“: è´­ä¹°å…¶ä»–ç”¨æˆ·ä¸Šæ¶çš„äºŒæ‰‹ç‰©å“

**Q3: ç§¯åˆ†ä½™é¢ä¸ºè´Ÿæ•°æ€ä¹ˆåŠ?**
- ç³»ç»Ÿä¸å…è®¸ç§¯åˆ†ä½™é¢ä¸ºè´Ÿæ•°
- æŠ½å¥–æˆ–å…‘æ¢å‰ä¼šå…ˆæ£€æŸ¥ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
- ç§¯åˆ†ä¸è¶³æ—¶è¿”å› `INSUFFICIENT_POINTS` é”™è¯¯

---

## ğŸ§ª é™„å½• F: APIæµ‹è¯•æŒ‡å—

### F.1 ä½¿ç”¨Postmanæµ‹è¯•

**1. é…ç½®ç¯å¢ƒå˜é‡**:
```
BASE_URL: https://omqktqrtntnn.sealosbja.site
API_PREFIX: /api/v4
```

**2. æµ‹è¯•ç™»å½•æ¥å£**:
```
POST {{BASE_URL}}{{API_PREFIX}}/unified-engine/auth/login
Body:
{
  "mobile": "13800138000",
  "verification_code": "123456"
}
```

**3. ä¿å­˜Token**:
- ä»ç™»å½•å“åº”ä¸­å¤åˆ¶ `access_token`
- åœ¨Postmanä¸­è®¾ç½®ä¸ºç¯å¢ƒå˜é‡æˆ–å…¨å±€å˜é‡

**4. æµ‹è¯•éœ€è¦è®¤è¯çš„æ¥å£**:
```
GET {{BASE_URL}}{{API_PREFIX}}/unified-engine/auth/profile
Headers:
Authorization: Bearer {{access_token}}
```

### F.2 ä½¿ç”¨curlæµ‹è¯•

**ç™»å½•æµ‹è¯•**:
```bash
curl -X POST https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "mobile": "13800138000",
    "verification_code": "123456"
  }'
```

**è·å–å¥–å“åˆ—è¡¨**:
```bash
curl -X GET https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/lottery/prizes/LUCKY2025 \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

**æ‰§è¡ŒæŠ½å¥–**:
```bash
curl -X POST https://omqktqrtntnn.sealosbja.site/api/v4/unified-engine/lottery/draw \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "campaign_code": "LUCKY2025",
    "draw_count": 1
  }'
```

---

**ğŸ“„ é™„å½•æ–‡æ¡£å®Œæˆ**


