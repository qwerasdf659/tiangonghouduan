# ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“è¿ç§»æœ€ä½³å®è·µ

**æ›´æ–°æ—¶é—´**: 2025å¹´10æœˆ13æ—¥  
**åŸºäºç»éªŒ**: æ–¹æ¡ˆCå¤±è´¥æ•™è®­æ€»ç»“

---

## âŒ **ä¸è¦ä½¿ç”¨çš„æ–¹æ³•**

### 1. sequelize.sync()

```javascript
// âŒ é”™è¯¯æ–¹æ³• - ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼
await models.sequelize.sync({ force: false, alter: false })
```

**ä¸ºä»€ä¹ˆä¸èƒ½ç”¨ï¼Ÿ**

1. **è¡¨ç»“æ„ä¸å®Œæ•´**
   - `belongsToMany`çš„throughæ¨¡å‹åªåˆ›å»ºæœ€å°å­—æ®µ
   - è·³è¿‡ä¸šåŠ¡å­—æ®µï¼ˆå¦‚`assigned_at`, `assigned_by`, `is_active`ï¼‰
   
2. **ä¸å¯æ§**
   - ä¾èµ–ORMçš„è‡ªåŠ¨æ¨æ–­é€»è¾‘
   - ä¸åŒSequelizeç‰ˆæœ¬è¡Œä¸ºå¯èƒ½ä¸åŒ
   - æ— æ³•å®¡æŸ¥å®é™…æ‰§è¡Œçš„SQL

3. **æ— æ³•å›æ»š**
   - æ²¡æœ‰æ˜ç¡®çš„downæ–¹æ³•
   - å‡ºé—®é¢˜å¾ˆéš¾æ¢å¤

**å®é™…æ¡ˆä¾‹**ï¼š
```javascript
// ä½¿ç”¨sync()åçš„user_rolesè¡¨ï¼ˆé”™è¯¯ï¼‰
CREATE TABLE user_roles (
  user_id INT NOT NULL,
  role_id INT NOT NULL,
  created_at DATETIME,      // âœ… æœ‰
  updated_at DATETIME,      // âœ… æœ‰
  // âŒ ç¼ºå°‘ assigned_at
  // âŒ ç¼ºå°‘ assigned_by  
  // âŒ ç¼ºå°‘ is_active
  PRIMARY KEY (user_id, role_id)
)
```

---

## âœ… **æ­£ç¡®æ–¹æ³•ï¼šæ˜¾å¼æ‰‹å†™è¿ç§»**

### æ–¹æ³•1ï¼šä½¿ç”¨é¡¹ç›®æ¨¡æ¿ï¼ˆæ¨èï¼‰

**æ¨¡æ¿ä½ç½®**: `migrations/TEMPLATE-baseline-explicit.js`

**æ ¸å¿ƒç‰¹ç‚¹**:
1. âœ… **æ˜¾å¼å®šä¹‰æ¯ä¸ªå­—æ®µ**
2. âœ… **æ˜ç¡®æ‰€æœ‰ç´¢å¼•å’Œå¤–é”®**
3. âœ… **æ’å…¥å®Œæ•´åˆå§‹æ•°æ®**
4. âœ… **åŒ…å«æ•°æ®éªŒè¯**
5. âœ… **å¯ä»¥å›æ»š**

**ä½¿ç”¨ç¤ºä¾‹**:

```javascript
// âœ… æ­£ç¡®æ–¹æ³• - æ˜¾å¼å®šä¹‰å®Œæ•´è¡¨ç»“æ„
'use strict'

module.exports = {
  up: async (queryInterface, Sequelize) => {
    const transaction = await queryInterface.sequelize.transaction()
    
    try {
      // 1. åˆ›å»ºè¡¨ï¼ˆå®Œæ•´å®šä¹‰æ‰€æœ‰å­—æ®µï¼‰
      await queryInterface.createTable('user_roles', {
        user_id: {
          type: Sequelize.INTEGER,
          allowNull: false,
          primaryKey: true,
          comment: 'ç”¨æˆ·ID'
        },
        role_id: {
          type: Sequelize.INTEGER,
          allowNull: false,
          primaryKey: true,
          comment: 'è§’è‰²ID'
        },
        // âœ… ä¸šåŠ¡å­—æ®µå¿…é¡»æ˜¾å¼å®šä¹‰
        assigned_at: {
          type: Sequelize.DATE,
          allowNull: true,
          comment: 'è§’è‰²åˆ†é…æ—¶é—´'
        },
        assigned_by: {
          type: Sequelize.INTEGER,
          allowNull: true,
          comment: 'è§’è‰²åˆ†é…è€…ID'
        },
        is_active: {
          type: Sequelize.BOOLEAN,
          allowNull: false,
          defaultValue: true,
          comment: 'è§’è‰²æ˜¯å¦æ¿€æ´»'
        },
        created_at: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
        },
        updated_at: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.literal('CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP')
        }
      }, { transaction })
      
      // 2. åˆ›å»ºç´¢å¼•
      await queryInterface.addIndex('user_roles', ['user_id'], {
        name: 'idx_user_roles_user',
        transaction
      })
      
      // 3. æ·»åŠ å¤–é”®
      await queryInterface.addConstraint('user_roles', {
        fields: ['user_id'],
        type: 'foreign key',
        name: 'fk_user_roles_user_id',
        references: {
          table: 'users',
          field: 'user_id'
        },
        onDelete: 'CASCADE',
        onUpdate: 'CASCADE',
        transaction
      })
      
      // 4. æ’å…¥åˆå§‹æ•°æ®ï¼ˆä½¿ç”¨è‹±æ–‡æ ‡è¯†ç¬¦ï¼‰
      await queryInterface.bulkInsert('roles', [
        {
          role_id: 1,
          role_name: 'super_admin',      // âœ… è‹±æ–‡å
          role_display_name: 'è¶…çº§ç®¡ç†å‘˜', // âœ… ä¸­æ–‡æ˜¾ç¤ºåï¼ˆå¯é€‰ï¼‰
          role_level: 100,
          is_active: true,
          created_at: new Date(),
          updated_at: new Date()
        },
        {
          role_id: 2,
          role_name: 'admin',            // âœ… è‹±æ–‡å
          role_display_name: 'ç®¡ç†å‘˜',
          role_level: 50,
          is_active: true,
          created_at: new Date(),
          updated_at: new Date()
        }
      ], { transaction })
      
      // 5. éªŒè¯æ•°æ®å®Œæ•´æ€§
      const [roles] = await queryInterface.sequelize.query(
        'SELECT COUNT(*) as count FROM roles',
        { transaction }
      )
      
      if (roles[0].count < 2) {
        throw new Error('åˆå§‹æ•°æ®æ’å…¥å¤±è´¥')
      }
      
      await transaction.commit()
      console.log('âœ… è¿ç§»æˆåŠŸ')
      
    } catch (error) {
      await transaction.rollback()
      console.error('âŒ è¿ç§»å¤±è´¥:', error.message)
      throw error
    }
  },
  
  down: async (queryInterface, Sequelize) => {
    const transaction = await queryInterface.sequelize.transaction()
    
    try {
      await queryInterface.dropTable('user_roles', { transaction })
      await transaction.commit()
      console.log('âœ… å›æ»šæˆåŠŸ')
    } catch (error) {
      await transaction.rollback()
      throw error
    }
  }
}
```

---

## ğŸ“‹ **è¿ç§»æ–‡ä»¶æ¸…å•ï¼ˆ21ä¸ªæ ¸å¿ƒè¡¨ï¼‰**

### åŸºç¡€è¡¨ï¼ˆ3ä¸ªï¼‰
```javascript
// 1. roles - è§’è‰²è¡¨
// 2. users - ç”¨æˆ·è¡¨
// 3. user_roles - ç”¨æˆ·è§’è‰²å…³è”ï¼ˆé‡ç‚¹ï¼ï¼‰
```

### ç§¯åˆ†ç³»ç»Ÿï¼ˆ3ä¸ªï¼‰
```javascript
// 4. user_points_accounts - ç§¯åˆ†è´¦æˆ·
// 5. points_transactions - ç§¯åˆ†æµæ°´
// 6. exchange_records - å…‘æ¢è®°å½•
```

### æŠ½å¥–ç³»ç»Ÿï¼ˆ4ä¸ªï¼‰
```javascript
// 7. lottery_campaigns - æŠ½å¥–æ´»åŠ¨
// 8. lottery_prizes - å¥–å“é…ç½®
// 9. lottery_draws - æŠ½å¥–è®°å½•
// 10. lottery_presets - æ´»åŠ¨é¢„è®¾
```

### å•†å“äº¤æ˜“ï¼ˆ3ä¸ªï¼‰
```javascript
// 11. products - å•†å“ç®¡ç†
// 12. trade_records - äº¤æ˜“è®°å½•
// 13. user_inventory - ç”¨æˆ·åº“å­˜
```

### å®¢æœç³»ç»Ÿï¼ˆ3ä¸ªï¼‰
```javascript
// 14. customer_sessions - å®¢æœä¼šè¯
// 15. chat_messages - èŠå¤©æ¶ˆæ¯
// 16. feedbacks - ç”¨æˆ·åé¦ˆ
```

### å®¡è®¡ç³»ç»Ÿï¼ˆ2ä¸ªï¼‰
```javascript
// 17. audit_logs - æ“ä½œå®¡è®¡
// 18. audit_records - å†…å®¹å®¡æ ¸
```

### ç³»ç»Ÿç®¡ç†ï¼ˆ3ä¸ªï¼‰
```javascript
// 19. system_announcements - ç³»ç»Ÿå…¬å‘Š
// 20. image_resources - å›¾ç‰‡èµ„æº
// 21. user_sessions - ç”¨æˆ·ä¼šè¯
```

---

## ğŸ”§ **åˆ›å»ºè¿ç§»çš„æ ‡å‡†æµç¨‹**

### æ­¥éª¤1ï¼šä½¿ç”¨åˆ›å»ºå·¥å…·

```bash
# ä½¿ç”¨é¡¹ç›®çš„è¿ç§»åˆ›å»ºå·¥å…·
npm run migration:create

# é€‰æ‹©æ“ä½œç±»å‹ï¼ˆ15ç§æ ‡å‡†ç±»å‹ï¼‰
# 1. create-table - åˆ›å»ºæ–°è¡¨
# 2. alter-column - ä¿®æ”¹åˆ—
# 3. add-column - æ·»åŠ åˆ—
# 4. drop-column - åˆ é™¤åˆ—
# 5. add-index - æ·»åŠ ç´¢å¼•
# ... ç­‰
```

### æ­¥éª¤2ï¼šç¼–å†™è¿ç§»æ–‡ä»¶

**å…³é”®åŸåˆ™**:
1. âœ… ä½¿ç”¨äº‹åŠ¡åŒ…è£…æ‰€æœ‰æ“ä½œ
2. âœ… æ˜¾å¼å®šä¹‰æ‰€æœ‰å­—æ®µï¼ˆåŒ…æ‹¬ä¸šåŠ¡å­—æ®µï¼‰
3. âœ… ä½¿ç”¨è‹±æ–‡ä½œä¸ºæ ‡è¯†ç¬¦ï¼ˆrole_name: 'admin'ï¼‰
4. âœ… æ·»åŠ ä¸­æ–‡æ˜¾ç¤ºåï¼ˆå¯é€‰ï¼Œrole_display_name: 'ç®¡ç†å‘˜'ï¼‰
5. âœ… åŒ…å«å®Œæ•´çš„ç´¢å¼•å’Œå¤–é”®
6. âœ… æ’å…¥å¿…è¦çš„åˆå§‹æ•°æ®
7. âœ… éªŒè¯æ•°æ®å®Œæ•´æ€§
8. âœ… å®ç°downæ–¹æ³•ï¼ˆå›æ»šï¼‰

### æ­¥éª¤3ï¼šéªŒè¯è¿ç§»

```bash
# åœ¨å¼€å‘ç¯å¢ƒæµ‹è¯•
npm run migration:verify   # éªŒè¯æ–‡ä»¶å‘½åè§„èŒƒ
npm run migration:up       # æ‰§è¡Œè¿ç§»
npm run migration:status   # æ£€æŸ¥çŠ¶æ€

# éªŒè¯æ•°æ®å®Œæ•´æ€§
node scripts/database/check-user-data.js

# æµ‹è¯•å›æ»š
npm run migration:down
```

### æ­¥éª¤4ï¼šç”Ÿäº§ç¯å¢ƒæ‰§è¡Œ

```bash
# 1. å¤‡ä»½å½“å‰æ•°æ®åº“
node scripts/database/backup-database.js

# 2. æ‰§è¡Œè¿ç§»
npm run migration:up

# 3. éªŒè¯ç»“æœ
curl http://localhost:3000/health

# 4. å¦‚æœ‰é—®é¢˜ï¼Œç«‹å³å›æ»š
npm run migration:down
```

---

## ğŸ“Š **æ–¹æ³•å¯¹æ¯”è¡¨**

| ç‰¹æ€§ | sequelize.sync() | æ˜¾å¼æ‰‹å†™è¿ç§» |
|------|-----------------|-------------|
| **è¡¨ç»“æ„å®Œæ•´æ€§** | âŒ ä¸å®Œæ•´ï¼ˆç¼ºä¸šåŠ¡å­—æ®µï¼‰ | âœ… 100%å®Œæ•´ |
| **å¯æ§æ€§** | âŒ ä¾èµ–ORMæ¨æ–­ | âœ… å®Œå…¨å¯æ§ |
| **å¯å®¡æŸ¥æ€§** | âŒ æ— æ³•é¢„è§ˆSQL | âœ… å¯ä»¥å®¡æŸ¥ |
| **å¯å›æ»šæ€§** | âŒ æ— æ³•å›æ»š | âœ… å®Œæ•´å›æ»š |
| **ç‰ˆæœ¬å…¼å®¹** | âŒ ä¸åŒç‰ˆæœ¬è¡Œä¸ºä¸åŒ | âœ… è¡Œä¸ºä¸€è‡´ |
| **åˆå§‹æ•°æ®** | âŒ éœ€è¦é¢å¤–ä»£ç  | âœ… é›†æˆåœ¨è¿ç§»ä¸­ |
| **æ•°æ®éªŒè¯** | âŒ æ— éªŒè¯ | âœ… å†…ç½®éªŒè¯ |
| **é€‚ç”¨åœºæ™¯** | âš ï¸ ä»…å¼€å‘ç¯å¢ƒåŸå‹ | âœ… æ‰€æœ‰ç¯å¢ƒ |

---

## ğŸ¯ **å…³é”®æ£€æŸ¥æ¸…å•**

### âœ… è¿ç§»æ–‡ä»¶å¿…é¡»åŒ…å«

- [ ] ä½¿ç”¨äº‹åŠ¡åŒ…è£…æ‰€æœ‰æ“ä½œ
- [ ] æ˜¾å¼å®šä¹‰æ‰€æœ‰å­—æ®µï¼ˆä¸ä¾èµ–syncï¼‰
- [ ] åŒ…å«æ‰€æœ‰ä¸šåŠ¡å­—æ®µï¼ˆassigned_atç­‰ï¼‰
- [ ] ä½¿ç”¨è‹±æ–‡æ ‡è¯†ç¬¦ï¼ˆrole_name: 'admin'ï¼‰
- [ ] åˆ›å»ºæ‰€æœ‰å¿…è¦çš„ç´¢å¼•
- [ ] æ·»åŠ æ‰€æœ‰å¤–é”®çº¦æŸ
- [ ] æ’å…¥å¿…è¦çš„åˆå§‹æ•°æ®
- [ ] éªŒè¯æ•°æ®å®Œæ•´æ€§
- [ ] å®ç°å®Œæ•´çš„downæ–¹æ³•
- [ ] æ·»åŠ è¯¦ç»†çš„æ³¨é‡Šè¯´æ˜

### âŒ è¿ç§»æ–‡ä»¶ä¸èƒ½åŒ…å«

- [ ] sequelize.sync()è°ƒç”¨
- [ ] ä¾èµ–ORMè‡ªåŠ¨åˆ›å»ºè¡¨
- [ ] ä½¿ç”¨ä¸­æ–‡ä½œä¸ºæ ‡è¯†ç¬¦
- [ ] ç¼ºå°‘ä¸šåŠ¡å­—æ®µå®šä¹‰
- [ ] æ²¡æœ‰äº‹åŠ¡ä¿æŠ¤
- [ ] æ²¡æœ‰é”™è¯¯å¤„ç†
- [ ] æ²¡æœ‰å›æ»šæ–¹æ³•

---

## ğŸ“š **å‚è€ƒèµ„æ–™**

### é¡¹ç›®æ–‡æ¡£
- `migrations/TEMPLATE-baseline-explicit.js` - å®Œæ•´ç¤ºä¾‹æ¨¡æ¿
- `migrations/README.md` - è¿ç§»ç³»ç»Ÿä½¿ç”¨æŒ‡å—
- `scripts/database/README.md` - æ•°æ®åº“å·¥å…·æ–‡æ¡£
- `docs/æ•°æ®åº“æ¢å¤æŠ¥å‘Š_ç´§æ€¥ä¿®å¤_20251013.md` - å®é™…æ¡ˆä¾‹

### Sequelizeå®˜æ–¹æ–‡æ¡£
- [Migrationså®˜æ–¹æŒ‡å—](https://sequelize.org/docs/v6/other-topics/migrations/)
- [QueryInterface API](https://sequelize.org/api/v6/class/src/dialects/abstract/query-interface.js~queryinterface)

---

## ğŸ’¡ **å¿«é€Ÿå¼€å§‹**

### åˆ›å»ºæ–°çš„åŸºå‡†è¿ç§»

```bash
# 1. å¤åˆ¶æ¨¡æ¿
cp migrations/TEMPLATE-baseline-explicit.js \
   migrations/20251014000000-create-baseline-v2.js

# 2. ä¿®æ”¹å†…å®¹
# - æ›´æ–°æ—¥æœŸå’Œç‰ˆæœ¬å·
# - æ·»åŠ æ‰€æœ‰21ä¸ªè¡¨çš„å®šä¹‰
# - æ’å…¥å®Œæ•´çš„åˆå§‹æ•°æ®

# 3. éªŒè¯å’Œæ‰§è¡Œ
npm run migration:verify
npm run migration:up

# 4. éªŒè¯ç»“æœ
node scripts/database/check-user-data.js
```

---

## ğŸš¨ **ç´§æ€¥æ¢å¤æµç¨‹**

å¦‚æœè¿ç§»å‡ºé”™å¯¼è‡´æ•°æ®é—®é¢˜ï¼š

```bash
# 1. ç«‹å³ä»å¤‡ä»½æ¢å¤
node scripts/database/full-restore.js

# 2. ä¿®å¤ç¼ºå¤±æ•°æ®
node scripts/database/fix-missing-data.js

# 3. é‡å¯æœåŠ¡
pm2 restart all

# 4. éªŒè¯åŠŸèƒ½
curl http://localhost:3000/health
```

---

**æ ¸å¿ƒåŸåˆ™**: åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œ**æ°¸è¿œä¸è¦ä¾èµ–ORMçš„è‡ªåŠ¨æ¨æ–­**ï¼Œå¿…é¡»**æ˜¾å¼å®šä¹‰æ¯ä¸ªå­—æ®µã€æ¯ä¸ªç´¢å¼•ã€æ¯ä¸ªçº¦æŸ**ï¼Œå¹¶**éªŒè¯æ•°æ®å®Œæ•´æ€§**ã€‚

**è®°ä½**: æ•°æ®åº“æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œè¿ç§»æ˜¯æœ€å±é™©çš„æ“ä½œä¹‹ä¸€ã€‚**å®æ„¿å¤šå†™å‡ è¡Œä»£ç ï¼Œä¹Ÿä¸è¦å†’é™©ä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·ã€‚**

