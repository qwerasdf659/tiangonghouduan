# 🔐 会话管理功能补齐方案

> **文档类型**：功能补齐方案
> 
> **生成时间**：2026-01-21
> 
> **关联页面**：`sessions.html`（Web管理平台）
> 
> **决策状态**：✅ 已拍板（2026-01-21 二次确认）

---

## 🎯 核心决策汇总（2026-01-21 拍板）

| 决策项 | 决策结果 | 说明 |
|--------|---------|------|
| **实施方案** | ✅ 方案A：启用会话存储 | 完整实现会话管理功能 |
| **认证中间件改造** | ✅ 需要改造 | 修改 `middleware/auth.js` |
| **会话检查策略** | ✅ **仅敏感操作检查** | 支付、修改密码等场景才验证会话 |
| **兼容性策略** | ✅ **不兼容旧接口** | 项目未上线，直接采用最优架构 |
| **投入策略** | ✅ 一次性投入 | 愿意投入大量成本，追求长期维护成本低 |
| **技术债务** | ✅ 最小化原则 | 从长期维护成本低、降低技术债务角度出发 |
| **会话过期时间** | ✅ **独立短期2小时（可续期）** | 强制登出即时生效，会话控制更精细 |
| **敏感操作范围** | ✅ **含市场/背包操作** | 市场挂牌/下架、物品转赠纳入敏感操作 |

---

## 📋 问题描述

在 Web管理平台前端功能补齐方案 中，`sessions.html` 是 **唯一一个后端API未实现** 的页面。

### 当前状态

| 检查项 | 状态 | 详情 |
|--------|------|------|
| 数据库表 | ✅ 已存在 | `authentication_sessions` |
| 数据库模型 | ✅ 已实现 | `models/AuthenticationSession.js` |
| 模型方法 | ✅ 已实现 | 6个类方法 + 5个实例方法 |
| Console API路由 | ❌ **未实现** | 无 `/console/sessions/*` 端点 |
| Service层封装 | ❌ **未实现** | 无 `SessionManagementService` |
| 当前数据量 | 0条 | 表存在但无数据 |
| **登录流程是否使用** | ❌ **未启用** | 当前为无状态JWT认证 |

### 🔍 关键发现（2026-01-21 真实数据库验证）

通过检查 `routes/v4/auth/login.js` 和 `middleware/auth.js`，发现：

| 当前实现 | 说明 |
|----------|------|
| JWT认证方式 | **无状态认证**（Stateless JWT） |
| 登录流程 | 直接生成JWT Token，不存储到数据库 |
| `generateTokens()` | 只生成Token，**未调用** `AuthenticationSession.createSession()` |
| `authentication_sessions` 表 | **预留能力，从未启用** |

**结论**：需要先修改登录流程启用会话存储，然后才能开发管理页面。

---

## 🗄️ 数据库模型能力分析

### 表结构：`authentication_sessions`

```sql
CREATE TABLE authentication_sessions (
  user_session_id INT PRIMARY KEY AUTO_INCREMENT,  -- 主键
  session_token VARCHAR(255) NOT NULL UNIQUE,      -- JWT Token的jti
  user_type ENUM('user', 'admin') NOT NULL,        -- 用户类型
  user_id INT NOT NULL,                            -- 用户ID
  login_ip VARCHAR(45),                            -- 登录IP
  is_active BOOLEAN DEFAULT TRUE,                  -- 是否活跃
  last_activity DATETIME NOT NULL,                 -- 最后活动时间
  expires_at DATETIME NOT NULL,                    -- 过期时间
  created_at DATETIME,
  updated_at DATETIME
);

-- 索引
UNIQUE INDEX (session_token)
INDEX (user_type, user_id, is_active)
INDEX (expires_at, is_active)
INDEX (last_activity)
```

### 已实现的模型方法

**实例方法**（5个）：

| 方法名 | 功能 |
|--------|------|
| `isExpired()` | 检查会话是否过期 |
| `isValid()` | 检查会话是否有效（活跃且未过期） |
| `updateActivity()` | 更新最后活动时间 |
| `deactivate(reason)` | 失效会话（强制登出） |
| `extendExpiry(minutes)` | 延长过期时间 |

**类方法**（6个）：

| 方法名 | 功能 | 可用于API |
|--------|------|----------|
| `createSession(data)` | 创建新会话 | 内部调用 |
| `findByToken(token)` | 按Token查找会话 | ✅ 详情查询 |
| `findValidByToken(token)` | 查找有效会话 | ✅ 验证检查 |
| `findUserActiveSessions(type, id)` | 查找用户活跃会话 | ✅ 列表查询 |
| `deactivateUserSessions(type, id)` | 失效用户所有会话 | ✅ 强制登出 |
| `cleanupExpiredSessions()` | 清理过期会话 | ✅ 维护操作 |
| `getActiveSessionStats()` | 获取活跃会话统计 | ✅ 统计面板 |

---

## 🔧 需要开发的后端API

### API端点设计

```
/api/v4/console/sessions/
├── GET    /                      # 会话列表（分页、筛选）
├── GET    /stats                 # 会话统计
├── GET    /:session_id           # 会话详情
├── POST   /:session_id/deactivate # 失效单个会话
├── POST   /deactivate-user       # 失效用户所有会话
├── POST   /cleanup               # 清理过期会话
└── GET    /online-users          # 在线用户列表
```

### 详细API规格

#### 1. GET /api/v4/console/sessions - 会话列表

```javascript
// 请求参数
{
  page: 1,
  page_size: 20,
  user_type: 'user' | 'admin' | null,  // 筛选用户类型
  is_active: true | false | null,       // 筛选活跃状态
  user_id: number | null,               // 筛选特定用户
  sort_by: 'last_activity' | 'created_at' | 'expires_at',
  sort_order: 'asc' | 'desc'
}

// 响应
{
  success: true,
  code: 'SUCCESS',
  data: {
    sessions: [
      {
        user_session_id: 1,
        session_token: '***masked***',  // 脱敏显示
        user_type: 'user',
        user_id: 123,
        user_info: { nickname: '用户A', avatar: '...' },  // 关联用户信息
        login_ip: '192.168.1.1',
        is_active: true,
        last_activity: '2026-01-21T10:30:00+08:00',
        expires_at: '2026-01-21T12:30:00+08:00',
        created_at: '2026-01-21T10:30:00+08:00'
      }
    ],
    pagination: { page: 1, page_size: 20, total: 100, total_pages: 5 }
  }
}
```

#### 2. GET /api/v4/console/sessions/stats - 会话统计

```javascript
// 响应
{
  success: true,
  code: 'SUCCESS',
  data: {
    total_active_sessions: 50,
    by_user_type: {
      user: { active_sessions: 45, unique_users: 30 },
      admin: { active_sessions: 5, unique_users: 3 }
    },
    expired_pending_cleanup: 120,  // 待清理的过期会话
    last_cleanup_at: '2026-01-21T09:00:00+08:00'
  }
}
```

#### 3. POST /api/v4/console/sessions/:session_id/deactivate - 失效单个会话

```javascript
// 请求
{
  reason: '管理员手动登出'  // 可选
}

// 响应
{
  success: true,
  code: 'SESSION_DEACTIVATED',
  message: '会话已失效',
  data: { session_id: 1, deactivated_at: '...' }
}
```

#### 4. POST /api/v4/console/sessions/deactivate-user - 失效用户所有会话

```javascript
// 请求
{
  user_type: 'user',
  user_id: 123,
  reason: '账户安全问题'
}

// 响应
{
  success: true,
  code: 'USER_SESSIONS_DEACTIVATED',
  message: '已失效该用户的 3 个会话',
  data: { affected_count: 3 }
}
```

#### 5. POST /api/v4/console/sessions/cleanup - 清理过期会话

```javascript
// 响应
{
  success: true,
  code: 'CLEANUP_COMPLETED',
  message: '已清理 120 个过期会话',
  data: { deleted_count: 120 }
}
```

#### 6. GET /api/v4/console/sessions/online-users - 在线用户列表

```javascript
// 响应
{
  success: true,
  code: 'SUCCESS',
  data: {
    online_users: [
      {
        user_id: 123,
        user_type: 'user',
        nickname: '用户A',
        avatar: '...',
        active_sessions: 2,
        last_activity: '2026-01-21T10:30:00+08:00',
        login_ips: ['192.168.1.1', '10.0.0.1']
      }
    ],
    total_online: 33
  }
}
```

---

## 📁 需要创建的文件

### 1. 路由文件

**路径**：`routes/v4/console/sessions.js`

```javascript
/**
 * 会话管理路由 - Console API
 * 
 * 功能：
 * - 查看所有认证会话
 * - 强制登出用户
 * - 清理过期会话
 * - 在线用户统计
 */

const express = require('express')
const router = express.Router()
const { authenticateToken, requireAdmin } = require('../../../middleware/auth')
const { AuthenticationSession, User } = require('../../../models')

// GET / - 会话列表
router.get('/', authenticateToken, requireAdmin, async (req, res) => {
  // 实现代码...
})

// GET /stats - 会话统计
router.get('/stats', authenticateToken, requireAdmin, async (req, res) => {
  const stats = await AuthenticationSession.getActiveSessionStats()
  return res.apiSuccess(stats, '获取会话统计成功')
})

// POST /:id/deactivate - 失效单个会话
router.post('/:id/deactivate', authenticateToken, requireAdmin, async (req, res) => {
  // 实现代码...
})

// POST /deactivate-user - 失效用户所有会话
router.post('/deactivate-user', authenticateToken, requireAdmin, async (req, res) => {
  const { user_type, user_id, reason } = req.body
  const count = await AuthenticationSession.deactivateUserSessions(user_type, user_id)
  return res.apiSuccess({ affected_count: count }, `已失效 ${count} 个会话`)
})

// POST /cleanup - 清理过期会话
router.post('/cleanup', authenticateToken, requireAdmin, async (req, res) => {
  const count = await AuthenticationSession.cleanupExpiredSessions()
  return res.apiSuccess({ deleted_count: count }, `已清理 ${count} 个过期会话`)
})

// GET /online-users - 在线用户列表
router.get('/online-users', authenticateToken, requireAdmin, async (req, res) => {
  // 实现代码...
})

module.exports = router
```

### 2. 路由挂载

**修改文件**：`routes/v4/console/index.js`

```javascript
// 新增挂载
const sessionsRoutes = require('./sessions')
router.use('/sessions', sessionsRoutes)
```

---

## 📱 前端页面功能

### sessions.html 页面功能

| 功能模块 | 说明 |
|----------|------|
| **统计卡片** | 活跃会话数、在线用户数、待清理会话数 |
| **在线用户列表** | 当前在线用户、最后活动时间、登录IP |
| **会话列表** | 分页展示所有会话，支持筛选 |
| **强制登出** | 单个会话失效 / 用户所有会话失效 |
| **清理操作** | 手动触发过期会话清理 |

### 页面布局

```
+------------------------------------------+
|  📊 统计卡片区域                          |
|  [活跃会话: 50] [在线用户: 33] [待清理: 120] |
+------------------------------------------+
|  🔍 筛选区域                              |
|  [用户类型 ▼] [状态 ▼] [用户ID输入] [搜索] |
+------------------------------------------+
|  📋 会话列表表格                          |
|  ID | 用户 | 类型 | IP | 最后活动 | 操作   |
|  1  | 用户A | user | ... | 10:30 | [登出] |
+------------------------------------------+
|  [清理过期会话] [刷新列表]                 |
+------------------------------------------+
```

---

## ⏱️ 工作量评估（已拍板：2-3天）

### 阶段1：启用会话存储（1天）

| 任务 | 预估时间 | 修改文件 |
|------|----------|----------|
| 修改登录流程，调用 `AuthenticationSession.createSession()` | 2小时 | `routes/v4/auth/login.js` |
| 修改Token验证，检查会话有效性 | 2小时 | `middleware/auth.js` |
| 添加登出时失效会话逻辑 | 1小时 | `routes/v4/auth/logout.js` |
| 测试登录/登出/Token验证流程 | 2小时 | - |
| **小计** | **约8小时（1天）** | |

### 阶段2：后端管理API（0.5天）

| 任务 | 预估时间 | 修改文件 |
|------|----------|----------|
| 创建 `routes/v4/console/sessions.js` | 2小时 | 新建文件 |
| 修改 `routes/v4/console/index.js` 挂载路由 | 10分钟 | 已有文件 |
| API测试验证 | 1小时 | - |
| **小计** | **约4小时** | |

### 阶段3：前端页面（0.5天）

| 任务 | 预估时间 | 修改文件 |
|------|----------|----------|
| 创建 `sessions.html` 页面结构 | 1小时 | 新建文件 |
| 创建 `js/pages/sessions.js` 逻辑 | 2小时 | 新建文件 |
| 更新 `api-config.js` 端点配置 | 10分钟 | 已有文件 |
| 联调测试 | 1小时 | - |
| **小计** | **约4小时** | |

### 总计

| 阶段 | 工作量 | 说明 |
|------|--------|------|
| 阶段1：启用会话存储 | 1天 | **新增**：修改登录流程 |
| 阶段2：后端管理API | 0.5天 | 原计划 |
| 阶段3：前端页面 | 0.5天 | 原计划 |
| **总计** | **2天**（含缓冲0.5-1天） | |

---

## ✅ 决策结果

### ✅ 已选择：选项A - 启用会话存储 + 开发管理页面

**决策理由**：
- 需要查看当前在线用户
- 需要强制登出特定用户（安全事件响应）
- 需要管理JWT会话生命周期
- 完善系统安全管控能力

**实施步骤**：

| 阶段 | 任务 | 工作量 | 产出 |
|------|------|--------|------|
| 1 | 修改登录流程，启用会话存储 | 1天 | 登录时写入 `authentication_sessions` 表 |
| 2 | 开发后端管理API | 0.5天 | `routes/v4/console/sessions.js` |
| 3 | 开发前端管理页面 | 0.5天 | `sessions.html` |
| **总计** | | **2-3天** | |

---

## 🔐 会话检查策略（2026-01-21 拍板）

### ✅ 采用策略：仅敏感操作检查

**核心原则**：不在每次请求都验证会话，只在**敏感操作**时检查会话有效性。

| 对比项 | 每次请求都检查 | **仅敏感操作检查（已选）** |
|--------|--------------|-------------------------|
| 性能开销 | 高（每次请求都查库/缓存） | **低** |
| 安全性 | 高（秒级失效） | 中（延迟失效，可接受） |
| 复杂度 | 高 | **低** |
| 长期维护成本 | 高 | **低** |

### 敏感操作清单（需要检查会话有效性）

| 操作类型 | 说明 | 端点示例 | 检查方式 |
|----------|------|----------|---------|
| **支付相关** | 积分支付、钻石支付、资产转移 | `/assets/transfer` | 调用 `AuthenticationSession.findValidByToken()` |
| **密码/安全** | 修改密码、绑定手机号、解绑设备 | `/auth/change-password` | 调用会话验证 |
| **账户操作** | 账户注销、权限变更 | `/console/user-management/*/role` | 调用会话验证 |
| **高风险操作** | 批量删除、导出敏感数据 | `/console/*/batch-delete` | 调用会话验证 |
| **市场交易** | 市场挂牌、市场下架 | `/market/listings` POST/DELETE | 调用会话验证 |
| **物品操作** | 物品转赠、背包物品转移 | `/backpack/*/transfer` | 调用会话验证 |

### 实现方案：新增敏感操作中间件

```javascript
// middleware/sensitiveOperation.js
const { AuthenticationSession } = require('../models')

/**
 * 敏感操作会话验证中间件
 * 用于支付、修改密码等高风险操作前验证会话有效性
 */
async function requireValidSession(req, res, next) {
  try {
    // 从JWT中提取session_token（jti）
    const sessionToken = req.user?.session_token
    
    if (!sessionToken) {
      return res.apiError('会话信息缺失', 'SESSION_REQUIRED', null, 401)
    }
    
    // 验证会话是否仍然有效
    const session = await AuthenticationSession.findValidByToken(sessionToken)
    
    if (!session) {
      return res.apiError('会话已失效，请重新登录', 'SESSION_INVALID', null, 401)
    }
    
    // 更新最后活动时间
    await session.updateActivity()
    
    next()
  } catch (error) {
    return res.apiError('会话验证失败', 'SESSION_CHECK_FAILED', null, 500)
  }
}

module.exports = { requireValidSession }
```

### 使用示例

```javascript
// routes/v4/points/transfer.js
const { requireValidSession } = require('../../../middleware/sensitiveOperation')

// 积分转账 - 敏感操作，需要验证会话
router.post('/transfer', 
  authenticateToken, 
  requireValidSession,  // 🔐 仅敏感操作加此中间件
  async (req, res) => {
    // ...
  }
)
```

### 普通操作（无需会话检查）

| 操作类型 | 说明 |
|----------|------|
| 查询类 | 获取用户信息、查看列表、搜索 |
| 浏览类 | 查看详情、获取统计数据 |
| 轻量操作 | 更新昵称、修改头像 |

---

## ⏱️ 会话过期时间决策（2026-01-21 拍板）

### ✅ 采用方案：独立短期2小时（可续期）

| 对比项 | 方案A：与JWT同步（7天） | **方案B：独立短期2小时（已选）** |
|--------|------------------------|-------------------------------|
| 会话控制精度 | 低（需等待JWT过期） | **高**（强制登出即时生效） |
| 续期逻辑 | 无需 | 需要（敏感操作时自动续期） |
| 实现复杂度 | 简单 | 略高（需续期逻辑） |
| 安全性 | 一般 | **高**（会话窗口短） |
| 长期维护成本 | 低 | **低**（逻辑清晰独立） |

**选择理由**：
- ✅ 强制登出即时生效，无需等待JWT过期
- ✅ 会话控制更精细，安全事件响应更快
- ✅ 续期逻辑集中在 `sensitiveOperation.js` 中间件，单一职责
- ✅ 符合"一次性投入换取长期低维护成本"的决策原则

---

## 🏗️ 技术架构决策（2026-01-21 拍板）

### ✅ 不兼容旧接口，采用最优架构

**背景**：项目尚未上线，无历史包袱。

**决策**：
- **不需要**兼容无状态JWT的旧逻辑
- **直接**采用有状态JWT + 会话存储架构
- **一次性**完成所有改造，避免渐进式带来的复杂度

### JWT Payload 新增字段

```javascript
// 登录时生成的JWT Payload
const payload = {
  user_id: user.user_id,
  mobile: user.mobile,
  nickname: user.nickname,
  status: user.status,
  role_level: userRoles.role_level,
  user_role: userRole,
  session_token: sessionToken,  // 🆕 新增：关联会话的唯一标识（jti）
  iat: Math.floor(BeijingTimeHelper.timestamp() / 1000)
}
```

### 登录流程改造

```javascript
// routes/v4/auth/login.js 改造要点
// 1. 生成唯一的 session_token（使用 uuid）
const sessionToken = require('uuid').v4()

// 2. 创建会话记录（2小时短期会话，可续期）
await AuthenticationSession.createSession({
  session_token: sessionToken,
  user_type: userRoles.role_level >= 100 ? 'admin' : 'user',
  user_id: user.user_id,
  login_ip: req.ip || req.headers['x-forwarded-for'],
  expires_in_minutes: 120  // 🔐 2小时短期会话（独立于JWT，可通过续期延长）
})

// 3. 将 session_token 放入 JWT payload
const tokens = await generateTokens(user, { session_token: sessionToken })
```

### 会话续期机制（配合2小时短期会话）

```javascript
// middleware/sensitiveOperation.js 中的续期逻辑
async function requireValidSession(req, res, next) {
  // ... 验证会话有效性 ...
  
  if (session) {
    // 🔄 每次敏感操作时自动续期（延长30分钟）
    await session.extendExpiry(30)
    
    // 更新最后活动时间
    await session.updateActivity()
  }
  
  next()
}
```

**续期策略说明**：
- 会话初始有效期：**2小时**
- 敏感操作续期：每次通过验证后延长 **30分钟**
- JWT有效期：**7天**（不受会话过期影响）
- 强制登出：通过 `deactivate()` 立即失效，无需等待过期

---

## 📋 需要修改的文件清单（完整版）

| 文件 | 修改类型 | 说明 | 优先级 |
|------|----------|------|--------|
| `routes/v4/auth/login.js` | 修改 | 登录成功后调用 `AuthenticationSession.createSession()` | P0 |
| `routes/v4/auth/quick-login.js` | 修改 | 微信快捷登录同样启用会话存储 | P0 |
| `middleware/auth.js` | 修改 | `generateTokens()` 支持传入 session_token | P0 |
| `middleware/sensitiveOperation.js` | **新建** | 敏感操作会话验证中间件 | P0 |
| `routes/v4/auth/logout.js` | 修改 | 登出时调用 `AuthenticationSession.deactivate()` | P1 |
| `routes/v4/console/sessions.js` | **新建** | 会话管理API | P1 |
| `routes/v4/console/index.js` | 修改 | 挂载sessions路由 | P1 |
| `public/admin/sessions.html` | **新建** | 会话管理页面 | P2 |
| `public/admin/js/pages/sessions.js` | **新建** | 页面逻辑 | P2 |
| `public/admin/js/api-config.js` | 修改 | 添加SESSIONS端点 | P2 |

### ~~选项B：暂不开发~~（未选择）

~~理由：当前数据库0条数据，说明该功能尚未在业务中启用~~

---

## 📝 决策记录

| 决策项 | 选项 | 决策人 | 决策时间 |
|--------|------|--------|----------|
| sessions.html 是否开发 | ✅ **选项A：启用会话存储 + 开发管理页面** | 用户 | 2026-01-21 |
| 认证中间件是否改造 | ✅ **需要改造** | 用户 | 2026-01-21 |
| 会话检查策略 | ✅ **仅敏感操作检查**（支付、修改密码等场景） | 用户 | 2026-01-21 |
| 是否兼容旧接口 | ✅ **不兼容**（项目未上线，直接采用最优架构） | 用户 | 2026-01-21 |
| 投入策略 | ✅ **一次性投入**（追求长期维护成本低、降低技术债务） | 用户 | 2026-01-21 |
| 会话过期时间 | ✅ **选项B：独立短期2小时（可续期）**，强制登出即时生效 | 用户 | 2026-01-21 |
| 敏感操作范围 | ✅ **含市场/背包**：市场挂牌/下架、物品转赠纳入 | 用户 | 2026-01-21 |

---

## 📅 实施计划

建议在 P0/P1 核心页面完成后，作为 **P2监控运维类** 的一部分实施：

| 周次 | 任务 | 说明 |
|------|------|------|
| 第三周 Day 1 | 阶段1：修改登录流程 | 启用会话存储 |
| 第三周 Day 2 | 阶段2：后端API | 创建管理API |
| 第三周 Day 2-3 | 阶段3：前端页面 | 创建sessions.html |

---

## 🔄 技术债务控制说明

本方案遵循以下原则，确保长期维护成本最低：

1. **不引入兼容层**：项目未上线，无需兼容旧接口，直接采用最优架构
2. **单一职责**：会话验证逻辑独立为 `sensitiveOperation.js` 中间件，不污染通用认证逻辑
3. **按需检查**：仅敏感操作验证会话，避免全局性能开销
4. **复用现有模型**：`AuthenticationSession` 模型已完整实现，无需额外开发
5. **标准化设计**：遵循项目现有的路由、API响应、前端结构规范
6. **短期会话+续期**：2小时短期会话配合续期机制，强制登出即时生效，会话控制更精细
7. **敏感操作全覆盖**：支付、安全、账户、市场、背包操作全部纳入会话验证范围

---

**文档维护人**：AI Assistant  
**最后更新**：2026-01-21（三次确认决策：会话过期时间+敏感操作范围）  
**决策状态**：✅ 已拍板（全部决策点已确认）

