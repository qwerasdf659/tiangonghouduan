# é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ - åŠŸèƒ½é‡å¤æ£€æŸ¥æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**ï¼š2026å¹´01æœˆ08æ—¥  
**æ•°æ®åº“**ï¼š`restaurant_points_dev`ï¼ˆçœŸå®åº“ï¼Œéå¤‡ä»½ï¼‰  
**ä»£ç ç‰ˆæœ¬**ï¼šå½“å‰å·¥ä½œåŒºæœ€æ–°ä»£ç   
**æ£€æŸ¥èŒƒå›´**ï¼šæ¥å£é‡å¤ã€å®¡æ ¸æ¨¡å—é‡å ã€APIåŠŸèƒ½é‡å¤ã€åŒä¸€åŠŸèƒ½éœ€æ±‚å¤šç§å®ç°

---

## ğŸ“Š æ‰§è¡Œæ‘˜è¦ï¼ˆExecutive Summaryï¼‰

### æ£€æŸ¥æ–¹æ³•

- âœ… è¿æ¥çœŸå®æ•°æ®åº“ï¼ˆ`restaurant_points_dev`ï¼‰è·å–è¡¨è¡Œæ•°å’Œæœ€æ–°æ•°æ®æ—¶é—´
- âœ… æ‰«æå½“å‰ä»£ç åº“æ‰€æœ‰è·¯ç”±ã€æœåŠ¡ã€æ¨¡å‹å®šä¹‰
- âœ… å¯¹æ¯”"ä»£ç å­˜åœ¨"ä¸"æ•°æ®åº“å®é™…ä½¿ç”¨"ï¼ŒåŒºåˆ†"å†å²é—ç•™"ä¸"æ´»è·ƒåŠŸèƒ½"
- âœ… åˆ†æä¸šåŠ¡é€»è¾‘å’Œå•†ä¸šæ¨¡å¼ï¼Œè¯†åˆ«åŠŸèƒ½è¯­ä¹‰é‡å¤

### æ ¸å¿ƒå‘ç°ï¼ˆ3å¤§ç±»ã€8ä¸ªå…·ä½“é—®é¢˜ï¼‰

#### ğŸ”´ P0çº§ï¼ˆå½±å“åŠŸèƒ½å¯ç”¨æ€§ï¼‰

1. **è·¯ç”±å†²çª**ï¼š`POST /api/v4/auth/refresh` è¢«æ³¨å†Œä¸¤æ¬¡ï¼Œæƒé™ç¼“å­˜åˆ·æ–°æ¥å£**ä¸å¯è¾¾**

#### ğŸŸ  P1çº§ï¼ˆå½±å“æ¶æ„ä¸€è‡´æ€§ï¼‰

2. **å®¡è®¡å…¥å£é‡å¤**ï¼š`AuditLogService` ä¸ `middleware/auditLog.js` åŒæ—¶å†™ `admin_operation_logs`ï¼Œæ¥å£ä¸ç»Ÿä¸€
3. **å®¡æ ¸ç³»ç»Ÿé‡å **ï¼š`ContentReviewRecord`ï¼ˆ0è¡Œï¼‰+ `MerchantPointsReview`ï¼ˆ0è¡Œï¼‰+ `AdminOperationLog`ï¼ˆ1046è¡Œï¼‰ä¸‰å¥—å¹¶å­˜
4. **è§’è‰²å®¡è®¡é‡å¤**ï¼š`role_change_logs`ï¼ˆ0è¡Œï¼‰+ `AdminOperationLog.operation_type=role_change`ï¼ˆ85æ¡ï¼‰+ `PermissionAuditLogger`ï¼ˆæ–‡ä»¶ï¼‰ä¸‰å¥—å¹¶è¡Œ

#### ğŸŸ¡ P2çº§ï¼ˆæŠ€æœ¯å€ºåŠ¡ï¼‰

5. **äº¤æ˜“æµæ°´åŒè½¨**ï¼š`AssetTransaction`ï¼ˆ846è¡Œï¼Œæ´»è·ƒï¼‰+ `TradeRecord`ï¼ˆ2è¡Œï¼Œæ®‹ç•™ï¼‰+ `TradeOrder`ï¼ˆ0è¡Œï¼Œæœªå¯ç”¨ï¼‰
6. **å…‘æ¢ç³»ç»Ÿè¯­ä¹‰æ··æ·†**ï¼š`ExchangeService`ï¼ˆB2Cææ–™å…‘æ¢ï¼‰+ `RedemptionService`ï¼ˆæ ¸é”€ç ç³»ç»Ÿï¼‰åŠŸèƒ½è¾¹ç•Œä¸æ¸…
7. **é—ç•™ç©ºè¡¨**ï¼š`audit_records`ï¼ˆ0è¡Œï¼Œæ— æ¨¡å‹ï¼‰ã€`role_change_logs`ï¼ˆ0è¡Œï¼Œæœ‰æ¨¡å‹ä½†æœªç”¨ï¼‰

#### ğŸ“‹ P3çº§ï¼ˆä»£ç è´¨é‡ï¼‰

8. **è·¯ç”±æŒ‚è½½è·¯å¾„ä¸ä¸€è‡´**ï¼š`/api/v4/shop/exchange/*` ä»£ç æ³¨é‡Šå†™çš„æ˜¯ `/api/v4/exchange_market`ï¼Œå®é™…æŒ‚è½½è·¯å¾„ä¸åŒ¹é…

---

## ğŸ” è¯¦ç»†åˆ†æï¼ˆæŒ‰ä¸šåŠ¡åŸŸåˆ†ç±»ï¼‰

### 1. è®¤è¯æˆæƒåŸŸï¼ˆAuth & Permissionsï¼‰

#### 1.1 è·¯ç”±å†²çªï¼ˆP0ï¼‰

**é—®é¢˜æè¿°**ï¼š`POST /api/v4/auth/refresh` è¢«æ³¨å†Œä¸¤æ¬¡

**è¯æ®é“¾**ï¼š

1. **æŒ‚è½½æ–¹å¼**ï¼ˆ`routes/v4/auth/index.js`ï¼‰ï¼š

```javascript
router.use('/', tokenRoutes) // åŒ…å« POST /refresh
router.use('/', permissionRoutes) // ä¹ŸåŒ…å« POST /refresh
```

2. **Tokenåˆ·æ–°æ¥å£**ï¼ˆ`routes/v4/auth/token.js:104`ï¼‰ï¼š

```javascript
router.post('/refresh', async (req, res) => {
  const refresh_token = req.cookies.refresh_token
  // ... éªŒè¯å¹¶ç”Ÿæˆæ–° access_token ...
})
```

3. **æƒé™ç¼“å­˜åˆ·æ–°æ¥å£**ï¼ˆ`routes/v4/auth/permissions.js:181`ï¼‰ï¼š

```javascript
router.post('/refresh', authenticateToken, async (req, res) => {
  const { user_id } = req.body
  await invalidateUserPermissions(user_id, 'manual_refresh', request_user_id)
  // ... æ¸…é™¤æƒé™ç¼“å­˜ ...
})
```

**å½±å“**ï¼š

- âŒ æƒé™ç¼“å­˜åˆ·æ–°æ¥å£**å®Œå…¨ä¸å¯è¾¾**ï¼ˆè¢« token åˆ·æ–°æ¥å£é®è”½ï¼‰
- âŒ å‰ç«¯æ— æ³•æ‰‹åŠ¨åˆ·æ–°æƒé™ç¼“å­˜ï¼ˆæƒé™å˜æ›´åéœ€è¦ç­‰ç¼“å­˜è‡ªç„¶è¿‡æœŸï¼‰
- âš ï¸ å¯èƒ½å¯¼è‡´æƒé™å˜æ›´ä¸åŠæ—¶ç”Ÿæ•ˆçš„é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼ˆäºŒé€‰ä¸€ï¼‰ï¼š

**æ–¹æ¡ˆAï¼ˆæ¨èï¼‰**ï¼šæ‹†åˆ† permissions åˆ°ç‹¬ç«‹åŸŸ

```javascript
// app.js
app.use('/api/v4/auth', require('./routes/v4/auth'))           // ä»…è®¤è¯ç›¸å…³
app.use('/api/v4/permissions', require('./routes/v4/permissions')) // æƒé™ç®¡ç†ç‹¬ç«‹

// routes/v4/permissions/index.jsï¼ˆæ–°å»ºï¼‰
router.post('/refresh', ...)        // å˜æˆ POST /api/v4/permissions/refresh
router.get('/me', ...)              // å˜æˆ GET /api/v4/permissions/me
router.post('/check', ...)          // å˜æˆ POST /api/v4/permissions/check
```

**æ–¹æ¡ˆBï¼ˆæœ€å°æ”¹åŠ¨ï¼‰**ï¼šåœ¨ auth åŸŸå†…ä½¿ç”¨å­è·¯å¾„

```javascript
// routes/v4/auth/index.js
router.use('/', tokenRoutes) // POST /refreshï¼ˆtokenï¼‰
router.use('/permissions', permissionRoutes) // POST /permissions/refreshï¼ˆæƒé™ç¼“å­˜ï¼‰
```

**è¿ç§»é£é™©**ï¼š

- éœ€è¦æ›´æ–°å‰ç«¯è°ƒç”¨è·¯å¾„
- éœ€è¦æ›´æ–° API æ–‡æ¡£
- å»ºè®®ä¿ç•™æ—§è·¯å¾„ 90 å¤©å¹¶è¿”å› 301 é‡å®šå‘

---

### 2. å®¡è®¡å®¡æ ¸åŸŸï¼ˆAudit & Reviewï¼‰

#### 2.1 æ“ä½œå®¡è®¡å…¥å£é‡å¤ï¼ˆP1ï¼‰

**é—®é¢˜æè¿°**ï¼šä¸¤å¥—ä»£ç åŒæ—¶å†™ `admin_operation_logs` è¡¨

**è¯æ®é“¾**ï¼š

1. **æœåŠ¡å±‚å…¥å£**ï¼ˆ`services/AuditLogService.js`ï¼‰ï¼š
   - å¯¼å‡ºæ–¹æ³•ï¼š`logOperation()`, `logAdminOperation()`, `logPointsAdd()`, `logInventoryTransfer()`, `logConsumptionAudit()` ç­‰
   - è°ƒç”¨æ–¹ï¼š`AdminLotteryService`ï¼ˆ5å¤„ï¼‰ã€`PrizePoolService`ï¼ˆ4å¤„ï¼‰ã€`ConsumptionService`ï¼ˆ2å¤„ï¼‰ã€`UserRoleService`ï¼ˆ1å¤„ï¼‰ã€`middleware/auth.js`ï¼ˆ1å¤„ï¼‰
   - å…±è®¡ï¼š**13+ å¤„è°ƒç”¨**

2. **ä¸­é—´ä»¶å…¥å£**ï¼ˆ`middleware/auditLog.js`ï¼‰ï¼š
   - å¯¼å‡ºæ–¹æ³•ï¼š`logOperation()`, `logAssetAdjust()`, `logExchangeAudit()`, `logProductConfig()`, `logUserStatusChange()`, `logPrizeConfig()`, `logCampaignConfig()`, `logRoleAssign()`
   - è°ƒç”¨æ–¹ï¼š**0 å¤„ç›´æ¥è°ƒç”¨**ï¼ˆä»…åœ¨ `routes/v4/console/asset-adjustment.js` ä¸­é€šè¿‡ `AuditLogService.log()` é—´æ¥è°ƒç”¨ï¼Œä½†è¯¥æ–¹æ³•ä¸å­˜åœ¨ï¼‰

3. **operation_type è¯è¡¨ä¸ä¸€è‡´**ï¼š
   - `AuditLogService` æ”¯æŒï¼š`points_adjust`, `exchange_audit`, `role_change`, `consumption_audit`, `inventory_transfer`, `lottery_force_win`, `lottery_probability_adjust` ç­‰ï¼ˆ15ç§ï¼‰
   - `middleware/auditLog.js` æ”¯æŒï¼š`points_adjust`, `exchange_audit`, `product_update`, `user_status_change`, `prize_config`, `campaign_config`, `role_assign`, `session_assign`, `inventory_operation`, `consumption_audit` ç­‰ï¼ˆ10ç§ï¼‰
   - âš ï¸ éƒ¨åˆ†ç±»å‹åä¸ä¸€è‡´ï¼ˆå¦‚ `role_change` vs `role_assign`ï¼‰

**çœŸå®åº“æ•°æ®**ï¼ˆ`admin_operation_logs`ï¼‰ï¼š

```json
{
  "count": 1046,
  "min_time": "2025-11-09 04:43:40",
  "max_time": "2026-01-07 08:56:23",
  "top_operation_types": [
    { "operation_type": "points_adjust", "cnt": 528 },
    { "operation_type": "session_assign", "cnt": 349 },
    { "operation_type": "role_change", "cnt": 85 },
    { "operation_type": "consumption_audit", "cnt": 81 },
    { "operation_type": "exchange_audit", "cnt": 2 },
    { "operation_type": "inventory_transfer", "cnt": 1 }
  ]
}
```

**å½±å“**ï¼š

- âŒ è°ƒç”¨æ–¹ä¸çŸ¥é“è¯¥ç”¨å“ªä¸ªå…¥å£ï¼ˆæœåŠ¡å±‚ vs ä¸­é—´ä»¶ï¼‰
- âŒ `operation_type` è¯è¡¨ä¸ç»Ÿä¸€ï¼Œå¯¼è‡´ç»Ÿè®¡å’ŒæŸ¥è¯¢å›°éš¾
- âŒ `routes/v4/console/asset-adjustment.js` è°ƒç”¨äº†ä¸å­˜åœ¨çš„ `AuditLogService.log()` æ–¹æ³•ï¼ˆåº”ä¸º `logOperation()`ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š

**ç»Ÿä¸€å…¥å£ï¼ˆæ¨èï¼‰**ï¼š

- âœ… ä¿ç•™ `AuditLogService` ä½œä¸º**å”¯ä¸€æœåŠ¡å±‚å…¥å£**
- âœ… `middleware/auditLog.js` æ”¹ä¸ºè–„å°è£…ï¼ˆä»…ä» `req` æå–å‚æ•°ï¼Œè½¬è°ƒ `AuditLogService.logOperation()`ï¼‰
- âœ… ç»Ÿä¸€ `operation_type` è¯è¡¨åˆ°å•ä¸€æšä¸¾å®šä¹‰æ–‡ä»¶ï¼ˆå¦‚ `constants/AuditOperationTypes.js`ï¼‰
- âœ… ä¿®å¤ `routes/v4/console/asset-adjustment.js` è°ƒç”¨é”™è¯¯ï¼ˆ`log()` â†’ `logOperation()`ï¼‰

**operation_type æ ‡å‡†åŒ–**ï¼š

```javascript
// constants/AuditOperationTypes.jsï¼ˆæ–°å»ºï¼‰
module.exports = {
  POINTS_ADJUST: 'points_adjust',
  ASSET_ADJUSTMENT: 'asset_adjustment', // æ–°å¢ï¼ˆè¦†ç›–æ‰€æœ‰èµ„äº§è°ƒæ•´ï¼‰
  EXCHANGE_AUDIT: 'exchange_audit',
  CONSUMPTION_AUDIT: 'consumption_audit',
  ROLE_CHANGE: 'role_change', // ç»Ÿä¸€ä½¿ç”¨æ­¤åç§°
  INVENTORY_TRANSFER: 'inventory_transfer',
  LOTTERY_FORCE_WIN: 'lottery_force_win'
  // ... å…¶ä»–ç±»å‹
}
```

#### 2.2 å®¡æ ¸ç³»ç»Ÿé‡å ï¼ˆP1ï¼‰

**é—®é¢˜æè¿°**ï¼šä¸‰å¥—"å®¡æ ¸/å®¡æ‰¹"æœºåˆ¶å¹¶å­˜ï¼Œè¾¹ç•Œä¸æ¸…

**è¯æ®é“¾**ï¼š

| æ¨¡å—                                             | è¡¨å                      | çœŸå®åº“è¡Œæ•° | ä¸»è¦ç”¨é€”                                    | ä»£ç çŠ¶æ€                      |
| ------------------------------------------------ | ------------------------- | ---------- | ------------------------------------------- | ----------------------------- |
| `ContentReviewRecord` + `ContentAuditEngine`     | `content_review_records`  | **0è¡Œ**    | é€šç”¨ä¸šåŠ¡å®¡æ ¸æµï¼ˆå…‘æ¢/å›¾ç‰‡/åé¦ˆï¼‰            | âœ… ä»£ç å®Œæ•´ï¼Œä½†**æœªå®é™…ä½¿ç”¨** |
| `MerchantPointsReview` + `MerchantReviewService` | `merchant_points_reviews` | **0è¡Œ**    | å•†å®¶æ‰«ç å®¡æ ¸å†»ç»“ç§¯åˆ†                        | âœ… ä»£ç å®Œæ•´ï¼Œä½†**æœªå®é™…ä½¿ç”¨** |
| `AdminOperationLog` + `AuditLogService`          | `admin_operation_logs`    | **1046è¡Œ** | æ“ä½œå®¡è®¡æ—¥å¿—ï¼ˆå« `consumption_audit` 81æ¡ï¼‰ | âœ… **æ´»è·ƒä½¿ç”¨ä¸­**             |

**ä»£ç å±‚è¯æ®**ï¼š

1. **ConsumptionService ä½¿ç”¨ ContentReviewRecord**ï¼š

```javascript
// services/ConsumptionService.js:310
await ContentReviewRecord.create({
  auditable_type: 'consumption',
  auditable_id: record.record_id,
  audit_status: 'pending',
  ...
}, { transaction })
```

2. **ä½†å®¡æ ¸é€šè¿‡/æ‹’ç»æ—¶åˆå†™ AdminOperationLog**ï¼š

```javascript
// services/ConsumptionService.js:480
await AuditLogService.logConsumptionAudit({
  operator_id: auditor_id,
  consumption_id: record_id,
  action: 'approve',
  ...
})
```

3. **MerchantReviewService ç‹¬ç«‹å®ç°å†»ç»“-å®¡æ ¸-ç»“ç®—é“¾è·¯**ï¼š

```javascript
// services/MerchantReviewService.js
submitReview() â†’ freeze points â†’ create MerchantPointsReview
approveReview() â†’ settleFromFrozen â†’ update status
```

**çœŸå®åº“æ•°æ®è¡¨æ˜**ï¼š

- âŒ `content_review_records`: **0 è¡Œ**ï¼ˆä»£ç å†™äº†ä½†æ²¡è·‘èµ·æ¥ï¼‰
- âŒ `merchant_points_reviews`: **0 è¡Œ**ï¼ˆä»£ç å†™äº†ä½†æ²¡è·‘èµ·æ¥ï¼‰
- âœ… `admin_operation_logs`: **1046 è¡Œ**ï¼Œå…¶ä¸­ `consumption_audit` æœ‰ **81 æ¡**ï¼ˆè¯´æ˜æ¶ˆè´¹å®¡æ ¸å®é™…èµ°çš„æ˜¯ AdminOperationLogï¼‰

**å½±å“**ï¼š

- âŒ ä¸‰å¥—å®¡æ ¸æœºåˆ¶ä»£ç å¹¶å­˜ï¼Œä½†åªæœ‰ä¸€å¥—åœ¨è·‘
- âŒ `ConsumptionService` åŒæ—¶å†™ä¸¤å¼ è¡¨ï¼ˆ`ContentReviewRecord` + `AdminOperationLog`ï¼‰ï¼Œä½†å‰è€…æ˜¯ç©ºè¡¨
- âŒ æœªæ¥æ–°å¢å®¡æ ¸åœºæ™¯æ—¶ï¼Œå¼€å‘è€…ä¸çŸ¥é“è¯¥ç”¨å“ªå¥—

**è§£å†³æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆAï¼ˆæ¨èï¼‰**ï¼šç¡®å®šå•ä¸€å®¡æ ¸æ¶æ„

- âœ… **æ“ä½œå®¡è®¡**ï¼šç»Ÿä¸€ç”¨ `AdminOperationLog`ï¼ˆå·²æ´»è·ƒï¼Œä¿ç•™ï¼‰
- âœ… **ä¸šåŠ¡å®¡æ ¸æµ**ï¼š
  - è‹¥éœ€è¦"çŠ¶æ€æœº+å®¡æ‰¹æµ"ï¼Œç»Ÿä¸€ç”¨ `ContentReviewRecord` + `ContentAuditEngine`
  - è‹¥ä¸éœ€è¦ï¼Œ**æ˜ç¡®åºŸå¼ƒ**å¹¶ä» `ConsumptionService` ç­‰å¤„ç§»é™¤ç›¸å…³ä»£ç 
- âœ… **å•†æˆ·ç§¯åˆ†å®¡æ ¸**ï¼š
  - è‹¥ä¸šåŠ¡ç¡®å®éœ€è¦"å†»ç»“-å®¡æ ¸-ç»“ç®—"çš„ç‰¹æ®Šæµç¨‹ï¼Œä¿ç•™ `MerchantPointsReview` ä½œä¸ºä¸“ç”¨æ¨¡å—
  - è‹¥ä¸éœ€è¦ï¼Œ**æ˜ç¡®åºŸå¼ƒ**

**æ–¹æ¡ˆBï¼ˆæœ€å°æ”¹åŠ¨ï¼‰**ï¼šæ˜ç¡®åˆ†å·¥

- `AdminOperationLog`ï¼š**æ“ä½œè¿½æº¯**ï¼ˆè°/ä½•æ—¶/æ”¹äº†ä»€ä¹ˆï¼Œä¸å¯å˜ï¼Œappend-onlyï¼‰
- `ContentReviewRecord`ï¼š**ä¸šåŠ¡å®¡æ‰¹æµ**ï¼ˆå¾…å®¡æ ¸â†’å·²å®¡æ ¸ï¼ŒçŠ¶æ€å¯å˜ï¼‰
- `MerchantPointsReview`ï¼š**å•†æˆ·ç§¯åˆ†å®¡æ ¸**ï¼ˆå†»ç»“â†’ç»“ç®—ï¼Œä¸“ç”¨çŠ¶æ€æœºï¼‰
- å¹¶åœ¨ä»£ç æ³¨é‡Šå’Œæ–‡æ¡£ä¸­**æ˜ç¡®åŒºåˆ†**ä¸‰è€…çš„ä½¿ç”¨åœºæ™¯

#### 2.3 è§’è‰²å®¡è®¡é‡å¤ï¼ˆP1ï¼‰

**é—®é¢˜æè¿°**ï¼šè§’è‰²å˜æ›´å®¡è®¡æœ‰ä¸‰å¥—å¹¶è¡Œæœºåˆ¶

**è¯æ®é“¾**ï¼š

| æ¨¡å—                    | å­˜å‚¨ä½ç½®                           | çœŸå®åº“è¡Œæ•°             | ä¸»è¦ç”¨é€”         | ä»£ç çŠ¶æ€                      |
| ----------------------- | ---------------------------------- | ---------------------- | ---------------- | ----------------------------- |
| `AdminOperationLog`     | `admin_operation_logs`             | **85æ¡** `role_change` | æ“ä½œå®¡è®¡æ—¥å¿—     | âœ… **æ´»è·ƒä½¿ç”¨ä¸­**             |
| `RoleChangeLog`         | `role_change_logs`                 | **0è¡Œ**                | è§’è‰²å˜æ›´ä¸“ç”¨æ—¥å¿— | âœ… ä»£ç å®Œæ•´ï¼Œä½†**æœªå®é™…ä½¿ç”¨** |
| `PermissionAuditLogger` | `logs/permission_config_audit.log` | æ–‡ä»¶                   | æƒé™é…ç½®å˜æ›´æ—¥å¿— | âœ… **æ´»è·ƒä½¿ç”¨ä¸­**             |

**çœŸå®åº“æ•°æ®**ï¼š

```json
{
  "admin_operation_logs": {
    "role_change": 85,
    "latest": "2026-01-07 08:56:23"
  },
  "role_change_logs": {
    "count": 0
  }
}
```

**ä»£ç è°ƒç”¨**ï¼š

- `UserRoleService.updateUserRole()` â†’ å†™ `AdminOperationLog`ï¼ˆé€šè¿‡ `AuditLogService.logOperation()`ï¼‰
- `HierarchyManagementService` â†’ å†™ `RoleChangeLog`ï¼ˆç›´æ¥ `RoleChangeLog.create()`ï¼‰
- `routes/v4/auth/permissions.js` â†’ å†™ `PermissionAuditLogger`ï¼ˆæ–‡ä»¶ï¼‰

**å½±å“**ï¼š

- âŒ è§’è‰²å˜æ›´å®¡è®¡åˆ†æ•£åœ¨ä¸‰å¤„ï¼ŒæŸ¥è¯¢å›°éš¾
- âŒ `role_change_logs` è¡¨æœ‰å®Œæ•´çš„å¤–é”®å’Œç´¢å¼•ï¼Œä½†**ä»æœªå†™å…¥è¿‡æ•°æ®**ï¼ˆèµ„æºæµªè´¹ï¼‰
- âŒ æ–‡ä»¶æ—¥å¿—ä¸ DB æ—¥å¿—ä¸åŒæ­¥ï¼Œæ— æ³•ç»Ÿä¸€æŸ¥è¯¢

**è§£å†³æ–¹æ¡ˆ**ï¼š

**ç»Ÿä¸€åˆ°ä¸¤å±‚ï¼ˆæ¨èï¼‰**ï¼š

- âœ… **DB å±‚**ï¼šç»Ÿä¸€ç”¨ `AdminOperationLog`ï¼ˆå·²æ´»è·ƒï¼Œä¿ç•™ï¼‰
  - è®°å½•å…³é”®å˜æ›´ï¼šè§’è‰²åˆ†é…ã€æƒé™æå‡ã€è´¦å·ç¦ç”¨ç­‰
  - æ”¯æŒç»“æ„åŒ–æŸ¥è¯¢å’Œç»Ÿè®¡
- âœ… **æ—¥å¿—å±‚**ï¼šä¿ç•™ `PermissionAuditLogger`ï¼ˆæ–‡ä»¶ï¼‰
  - è®°å½•é«˜é¢‘æ£€æŸ¥ï¼šæƒé™æ£€æŸ¥ã€æ‰¹é‡æ£€æŸ¥ç­‰
  - ç”¨äºæ€§èƒ½ç›‘æ§å’Œå¼‚å¸¸æ£€æµ‹
- âŒ **åºŸå¼ƒ**ï¼š`RoleChangeLog` è¡¨å’Œæ¨¡å‹ï¼ˆä»æœªä½¿ç”¨ï¼Œå¯å®‰å…¨åˆ é™¤ï¼‰

**æ•°æ®è¿ç§»**ï¼šæ— éœ€è¿ç§»ï¼ˆ`role_change_logs` æ˜¯ç©ºè¡¨ï¼‰

---

### 2. èµ„äº§äº¤æ˜“åŸŸï¼ˆAssets & Transactionsï¼‰

#### 2.1 äº¤æ˜“æµæ°´åŒè½¨ï¼ˆP2ï¼‰

**é—®é¢˜æè¿°**ï¼šèµ„äº§å˜åŠ¨è®°å½•æœ‰ä¸¤å¥—å®ç°

**è¯æ®é“¾**ï¼š

| æ¨¡å—               | è¡¨å                 | çœŸå®åº“è¡Œæ•° | ä¸»è¦ç”¨é€”                 | ä»£ç çŠ¶æ€                      |
| ------------------ | -------------------- | ---------- | ------------------------ | ----------------------------- |
| `AssetTransaction` | `asset_transactions` | **846è¡Œ**  | ç»Ÿä¸€èµ„äº§æµæ°´ï¼ˆè´¦æœ¬ä½“ç³»ï¼‰ | âœ… **æ´»è·ƒä½¿ç”¨ä¸­**             |
| `TradeRecord`      | `trade_records`      | **2è¡Œ**    | ç”¨æˆ·é—´äº¤æ˜“è®°å½•           | âš ï¸ æ®‹ç•™ä½¿ç”¨                   |
| `TradeOrder`       | `trade_orders`       | **0è¡Œ**    | C2C å¸‚åœºäº¤æ˜“è®¢å•         | âœ… ä»£ç å®Œæ•´ï¼Œä½†**æœªå®é™…ä½¿ç”¨** |

**çœŸå®åº“æ•°æ®**ï¼š

```json
{
  "asset_transactions": {
    "count": 846,
    "min_time": "2026-01-02 20:24:20",
    "max_time": "2026-01-07 08:56:03",
    "top_business_types": [
      { "business_type": "exchange_debit", "cnt": 378 },
      { "business_type": "test_recharge", "cnt": 377 },
      { "business_type": "admin_adjustment", "cnt": 90 },
      { "business_type": "lottery_consume", "cnt": 1 }
    ]
  },
  "trade_records": {
    "count": 2,
    "trade_types": [{ "trade_type": "inventory_transfer", "cnt": 2 }],
    "time_range": "2025-11-11 ~ 2025-12-12"
  },
  "trade_orders": {
    "count": 0
  }
}
```

**ä»£ç è°ƒç”¨åˆ†æ**ï¼š

1. **AssetTransactionï¼ˆä¸»å¹²ï¼‰**ï¼š
   - å†™å…¥æ–¹ï¼š`AssetService.changeBalance()`, `AssetService.freeze()`, `AssetService.settleFromFrozen()`
   - è°ƒç”¨æ–¹ï¼š`UnifiedLotteryEngine`ï¼ˆæŠ½å¥–æ‰£åˆ†ï¼‰ã€`ExchangeService`ï¼ˆå…‘æ¢æ‰£ææ–™ï¼‰ã€`TradeOrderService`ï¼ˆå¸‚åœºäº¤æ˜“ï¼‰ã€`AssetConversionService`ï¼ˆææ–™è½¬æ¢ï¼‰ã€`routes/v4/console/asset-adjustment`ï¼ˆç®¡ç†å‘˜è°ƒæ•´ï¼‰
   - æŸ¥è¯¢æ–¹ï¼š`routes/v4/assets/transactions`ï¼ˆç”¨æˆ·æŸ¥è¯¢æµæ°´ï¼‰ã€`ReportingService`ï¼ˆç»Ÿè®¡æŠ¥è¡¨ï¼‰

2. **TradeRecordï¼ˆæ®‹ç•™ï¼‰**ï¼š
   - å†™å…¥æ–¹ï¼š`FeeCalculator.createTradeRecord()`ï¼ˆä½†è¯¥æ–¹æ³•åœ¨ `TradeOrderService` ä¸­**æœªè¢«è°ƒç”¨**ï¼‰
   - æŸ¥è¯¢æ–¹ï¼š`BackpackService.getTransferHistory()`ï¼ˆæŸ¥è¯¢ç‰©å“è½¬è®©å†å²ï¼‰

3. **TradeOrderï¼ˆæœªå¯ç”¨ï¼‰**ï¼š
   - å†™å…¥æ–¹ï¼š`TradeOrderService.createOrder()`, `completeOrder()`, `cancelOrder()`
   - è°ƒç”¨æ–¹ï¼š`routes/v4/market/buy.js`ï¼ˆå¸‚åœºè´­ä¹°æ¥å£ï¼‰
   - âš ï¸ ä½†çœŸå®åº“ **0 è¡Œ**ï¼Œè¯´æ˜å¸‚åœºäº¤æ˜“åŠŸèƒ½**æœªå®é™…è¿è¡Œ**

**å½±å“**ï¼š

- âš ï¸ `TradeRecord` ä»…å‰© 2 æ¡å†å²æ•°æ®ï¼Œä½†ä»£ç ä»åœ¨ç»´æŠ¤ï¼ˆ`FeeCalculator`ã€`BackpackService`ï¼‰
- âš ï¸ `TradeOrder` ä»£ç å®Œæ•´ä½†æœªå¯ç”¨ï¼Œå ç”¨ç»´æŠ¤æˆæœ¬
- âš ï¸ åŒä¸€ç¬”äº¤æ˜“å¯èƒ½åŒæ—¶å†™ `AssetTransaction` + `TradeOrder`ï¼ˆå¦‚å¸‚åœºè´­ä¹°ï¼‰ï¼Œä½†ç›®å‰æœªå®é™…å‘ç”Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š

**ç¡®å®šå•ä¸€äº‹å®æ¨¡å‹ï¼ˆæ¨èï¼‰**ï¼š

- âœ… **èµ„äº§å˜åŠ¨äº‹å®**ï¼šç»Ÿä¸€ç”¨ `AssetTransaction`ï¼ˆå·²æ˜¯ä¸»å¹²ï¼‰
- âœ… **è®¢å•äº‹å®**ï¼š
  - C2C å¸‚åœºï¼šç”¨ `TradeOrder`ï¼ˆå·²å®ç°ï¼Œå¾…å¯ç”¨ï¼‰
  - B2C å…‘æ¢ï¼šç”¨ `ExchangeRecord`ï¼ˆå·²å®ç°ï¼Œä½†å½“å‰ 0 è¡Œï¼‰
  - æ ¸é”€ç³»ç»Ÿï¼šç”¨ `RedemptionOrder`ï¼ˆå·²æ´»è·ƒï¼Œ188 è¡Œï¼‰
- âš ï¸ **TradeRecord å®šä½**ï¼š
  - **æ–¹æ¡ˆA**ï¼šé€€ä¸º"è¯»æ¨¡å‹"ï¼ˆä¸å†å†™å…¥ï¼Œä»…ä» `AssetTransaction` + `TradeOrder` + `ItemInstanceEvent` ç»„åˆç”Ÿæˆå†å²è§†å›¾ï¼‰
  - **æ–¹æ¡ˆB**ï¼šä¿ç•™ä½†é™åˆ¶å†™å…¥æƒé™ï¼ˆä»…å…è®¸åå°ä»»åŠ¡/å•ä¸€æœåŠ¡å†™å…¥ï¼Œç¦æ­¢ `FeeCalculator` ç­‰é›¶æ•£ä»£ç ç›´æ¥å†™ï¼‰

**è¿ç§»ç­–ç•¥**ï¼š

- ä¿ç•™ `trade_records` è¡¨ä¸­çš„ 2 æ¡å†å²æ•°æ®
- æ–°å¢ `is_legacy` å­—æ®µæ ‡è®°å†å²æ•°æ®
- æ–°äº¤æ˜“ä¸å†å†™å…¥ `trade_records`
- `BackpackService.getTransferHistory()` æ”¹ä¸ºæŸ¥è¯¢ `ItemInstanceEvent`ï¼ˆå·²æœ‰ 236 è¡Œæ•°æ®ï¼‰

#### 2.2 å…‘æ¢ç³»ç»Ÿè¯­ä¹‰æ··æ·†ï¼ˆP2ï¼‰

**é—®é¢˜æè¿°**ï¼š`ExchangeService` ä¸ `RedemptionService` åŠŸèƒ½è¾¹ç•Œä¸æ¸…

**è¯æ®é“¾**ï¼š

| æœåŠ¡                | è¡¨å                | çœŸå®åº“è¡Œæ•° | ä¸»è¦ç”¨é€”                 | è·¯ç”±è·¯å¾„                    |
| ------------------- | ------------------- | ---------- | ------------------------ | --------------------------- |
| `ExchangeService`   | `exchange_records`  | **0è¡Œ**    | B2C ææ–™å…‘æ¢ï¼ˆå®˜æ–¹å•†åŸï¼‰ | `/api/v4/shop/exchange/*`   |
| `RedemptionService` | `redemption_orders` | **188è¡Œ**  | æ ¸é”€ç ç³»ç»Ÿï¼ˆ12ä½Base32ï¼‰ | `/api/v4/shop/redemption/*` |

**ä¸šåŠ¡æµç¨‹å¯¹æ¯”**ï¼š

**ExchangeServiceï¼ˆB2C ææ–™å…‘æ¢ï¼‰**ï¼š

1. ç”¨æˆ·æµè§ˆå•†å“ï¼ˆ`exchange_items`ï¼Œ24 ä»¶å•†å“ï¼‰
2. é€‰æ‹©å•†å“å¹¶æ”¯ä»˜ææ–™èµ„äº§ï¼ˆå¦‚ 100 ä¸ªç¢çº¢æ°´æ™¶ï¼‰
3. é€šè¿‡ `AssetService.changeBalance()` æ‰£å‡ææ–™ï¼ˆå†™ `asset_transactions`ï¼‰
4. åˆ›å»ºå…‘æ¢è®¢å•ï¼ˆå†™ `exchange_records`ï¼‰
5. å‘è´§å’Œè®¢å•çŠ¶æ€ç®¡ç†

**RedemptionServiceï¼ˆæ ¸é”€ç ç³»ç»Ÿï¼‰**ï¼š

1. ç”¨æˆ·å·²æ‹¥æœ‰ç‰©å“å®ä¾‹ï¼ˆ`item_instances`ï¼Œ431 ä»¶ï¼‰
2. ç”Ÿæˆ 12 ä½æ ¸é”€ç ï¼ˆå†™ `redemption_orders`ï¼Œ188 æ¡ï¼‰
3. å•†å®¶æ‰«ç æ ¸é”€ï¼ˆæ›´æ–°è®¢å•çŠ¶æ€ + ç‰©å“çŠ¶æ€ï¼‰

**çœŸå®åº“æ•°æ®è¡¨æ˜**ï¼š

- âœ… `redemption_orders`: **188 è¡Œ**ï¼ˆæ ¸é”€ç³»ç»Ÿåœ¨è·‘ï¼‰
- âŒ `exchange_records`: **0 è¡Œ**ï¼ˆå…‘æ¢ç³»ç»Ÿæœªå¯ç”¨ï¼‰
- âœ… `asset_transactions`: **378 æ¡** `exchange_debit`ï¼ˆä½†æ²¡æœ‰å¯¹åº”çš„ `exchange_records`ï¼‰

**çŸ›ç›¾ç‚¹**ï¼š

- âš ï¸ `asset_transactions` æœ‰ 378 æ¡ `exchange_debit` æµæ°´ï¼Œä½† `exchange_records` æ˜¯ç©ºè¡¨
- âš ï¸ è¯´æ˜ææ–™æ‰£å‡åœ¨æ‰§è¡Œï¼Œä½†è®¢å•è®°å½•æœªåˆ›å»ºï¼ˆå¯èƒ½æ˜¯æµ‹è¯•ä»£ç /æˆ–è®¢å•åˆ›å»ºå¤±è´¥ï¼‰

**å½±å“**ï¼š

- âŒ ä¸¤ä¸ªæœåŠ¡åå­—éƒ½å«"å…‘æ¢"ï¼ˆExchange/Redemptionï¼‰ï¼Œä½†å®é™…æ˜¯ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„ä¸šåŠ¡
- âŒ å‰ç«¯/æ–‡æ¡£å¯èƒ½æ··æ·†ä¸¤è€…çš„ä½¿ç”¨åœºæ™¯
- âš ï¸ `ExchangeService` ä»£ç å®Œæ•´ä½†æœªå®é™…è¿è¡Œï¼Œå ç”¨ç»´æŠ¤æˆæœ¬

**è§£å†³æ–¹æ¡ˆ**ï¼š

**æ˜ç¡®å‘½åå’ŒèŒè´£ï¼ˆæ¨èï¼‰**ï¼š

- âœ… `ExchangeService` â†’ é‡å‘½åä¸º `MaterialShopService`ï¼ˆææ–™å•†åŸæœåŠ¡ï¼‰
  - èŒè´£ï¼šB2C å®˜æ–¹å•†åŸï¼Œç”¨æˆ·ç”¨ææ–™å…‘æ¢å®ç‰©å•†å“
  - è·¯ç”±ï¼š`/api/v4/shop/material-shop/*`ï¼ˆæˆ–ä¿æŒ `/shop/exchange/*` ä½†æ–‡æ¡£æ˜ç¡®è¯´æ˜ï¼‰
- âœ… `RedemptionService` â†’ ä¿æŒåŸåï¼ˆæ ¸é”€æœåŠ¡ï¼‰
  - èŒè´£ï¼šä¸ºå·²æ‹¥æœ‰çš„ç‰©å“ç”Ÿæˆæ ¸é”€ç ï¼Œå•†å®¶æ‰«ç æ ¸é”€
  - è·¯ç”±ï¼š`/api/v4/shop/redemption/*`ï¼ˆä¿æŒä¸å˜ï¼‰

**æ•°æ®ä¸€è‡´æ€§ä¿®å¤**ï¼š

- è°ƒæŸ¥ä¸ºä½•æœ‰ 378 æ¡ `exchange_debit` ä½† 0 æ¡ `exchange_records`
- è‹¥æ˜¯æµ‹è¯•æ•°æ®ï¼Œæ¸…ç† `asset_transactions` ä¸­çš„æµ‹è¯•è®°å½•
- è‹¥æ˜¯ bugï¼Œä¿®å¤ `ExchangeService.exchangeItem()` çš„è®¢å•åˆ›å»ºé€»è¾‘

---

### 3. é—ç•™ç©ºè¡¨ï¼ˆP2ï¼‰

**é—®é¢˜æè¿°**ï¼šæ•°æ®åº“ä¸­å­˜åœ¨å¤šå¼ ä»æœªä½¿ç”¨çš„è¡¨

**è¯æ®é“¾**ï¼š

| è¡¨å                      | çœŸå®åº“è¡Œæ•° | Sequelize æ¨¡å‹ | ä»£ç å¼•ç”¨                        | å»ºè®®           |
| ------------------------- | ---------- | -------------- | ------------------------------- | -------------- |
| `audit_records`           | **0è¡Œ**    | âŒ ä¸å­˜åœ¨      | âŒ æ— å¼•ç”¨                       | **å¯å®‰å…¨åˆ é™¤** |
| `role_change_logs`        | **0è¡Œ**    | âœ… å­˜åœ¨        | âœ… `HierarchyManagementService` | **åºŸå¼ƒæˆ–å¯ç”¨** |
| `content_review_records`  | **0è¡Œ**    | âœ… å­˜åœ¨        | âœ… `ConsumptionService`         | **åºŸå¼ƒæˆ–å¯ç”¨** |
| `merchant_points_reviews` | **0è¡Œ**    | âœ… å­˜åœ¨        | âœ… `MerchantReviewService`      | **åºŸå¼ƒæˆ–å¯ç”¨** |
| `trade_orders`            | **0è¡Œ**    | âœ… å­˜åœ¨        | âœ… `TradeOrderService`          | **å¾…å¯ç”¨**     |
| `exchange_records`        | **0è¡Œ**    | âœ… å­˜åœ¨        | âœ… `ExchangeService`            | **å¾…å¯ç”¨**     |
| `consumption_records`     | **0è¡Œ**    | âœ… å­˜åœ¨        | âœ… `ConsumptionService`         | **å¾…å¯ç”¨**     |

**åˆ†ç±»å¤„ç†**ï¼š

**A. å¯ç«‹å³åˆ é™¤ï¼ˆæ— ä»£ç å¼•ç”¨ï¼‰**ï¼š

- `audit_records`ï¼ˆæ— æ¨¡å‹ã€æ— å¼•ç”¨ã€0 è¡Œï¼‰

**B. éœ€è¦å†³ç­–ï¼ˆæœ‰ä»£ç ä½†æœªå¯ç”¨ï¼‰**ï¼š

- `role_change_logs`ï¼šè‹¥ä¸ç”¨ï¼Œåˆ é™¤æ¨¡å‹å’Œè¡¨ï¼›è‹¥ç”¨ï¼Œå¯ç”¨å†™å…¥é€»è¾‘
- `content_review_records`ï¼šè‹¥ä¸ç”¨ï¼Œä» `ConsumptionService` ç§»é™¤ç›¸å…³ä»£ç ï¼›è‹¥ç”¨ï¼Œå¯ç”¨å®¡æ ¸æµ
- `merchant_points_reviews`ï¼šè‹¥ä¸ç”¨ï¼Œåˆ é™¤æœåŠ¡å’Œæ¨¡å‹ï¼›è‹¥ç”¨ï¼Œå¯ç”¨å•†æˆ·å®¡æ ¸åŠŸèƒ½
- `consumption_records`ï¼šè‹¥ä¸ç”¨ï¼Œåˆ é™¤æœåŠ¡å’Œæ¨¡å‹ï¼›è‹¥ç”¨ï¼Œå¯ç”¨æ¶ˆè´¹è®°å½•åŠŸèƒ½

**C. å¾…å¯ç”¨ï¼ˆä»£ç å®Œæ•´ï¼Œç­‰å¾…ä¸šåŠ¡ä¸Šçº¿ï¼‰**ï¼š

- `trade_orders`ï¼šC2C å¸‚åœºäº¤æ˜“è®¢å•ï¼ˆä»£ç å·²å°±ç»ªï¼‰
- `exchange_records`ï¼šB2C ææ–™å…‘æ¢è®¢å•ï¼ˆä»£ç å·²å°±ç»ªï¼‰

---

### 4. è·¯ç”±æŒ‚è½½è·¯å¾„ä¸ä¸€è‡´ï¼ˆP3ï¼‰

**é—®é¢˜æè¿°**ï¼šä»£ç æ³¨é‡Šä¸å®é™…æŒ‚è½½è·¯å¾„ä¸åŒ¹é…

**è¯æ®**ï¼š

**ä»£ç æ³¨é‡Š**ï¼ˆ`routes/v4/shop/exchange/exchange.js`ï¼‰ï¼š

```javascript
/**
 * @route /api/v4/exchange_market
 * ...
 * @route POST /api/v4/exchange_market/exchange
 */
router.post('/exchange', ...)
```

**å®é™…æŒ‚è½½è·¯å¾„**ï¼ˆ`routes/v4/shop/index.js` + `app.js`ï¼‰ï¼š

```javascript
// routes/v4/shop/index.js
router.use('/exchange', exchangeRoutes)

// app.js
app.use('/api/v4/shop', require('./routes/v4/shop'))
```

**å®é™…ç”Ÿæ•ˆè·¯å¾„**ï¼š`POST /api/v4/shop/exchange/exchange`

**å½±å“**ï¼š

- âš ï¸ æ³¨é‡Šè¯¯å¯¼å¼€å‘è€…ï¼ˆå†™çš„æ˜¯ `/exchange_market`ï¼Œå®é™…æ˜¯ `/shop/exchange`ï¼‰
- âš ï¸ API æ–‡æ¡£å¯èƒ½ä¸å‡†ç¡®

**è§£å†³æ–¹æ¡ˆ**ï¼š

- æ‰¹é‡æ›´æ–°æ‰€æœ‰ `routes/v4/shop/exchange/*.js` çš„æ³¨é‡Šè·¯å¾„
- æˆ–åœ¨ `routes/v4/shop/exchange/index.js` é¡¶éƒ¨æ·»åŠ ç»Ÿä¸€è¯´æ˜

---

## ğŸ—ï¸ ä¸šåŠ¡é€»è¾‘ä¸å•†ä¸šæ¨¡å¼æ€»ç»“

### æ ¸å¿ƒä¸šåŠ¡æµç¨‹

#### 1. æŠ½å¥–ç³»ç»Ÿï¼ˆLotteryï¼‰

- **ç”¨æˆ·ç«¯**ï¼š`/api/v4/lottery/*`
  - ç”¨æˆ·æ¶ˆè€—ç§¯åˆ†æŠ½å¥–ï¼ˆå†™ `asset_transactions`ï¼Œ`business_type=lottery_consume`ï¼‰
  - ä¸­å¥–è·å¾—ç‰©å“å®ä¾‹ï¼ˆå†™ `item_instances`ï¼‰
  - ä¸­å¥–è·å¾—ææ–™èµ„äº§ï¼ˆå†™ `asset_transactions`ï¼Œ`business_type=lottery_reward`ï¼‰
- **ç®¡ç†ç«¯**ï¼š`/api/v4/console/lottery/*`
  - é…ç½®å¥–å“æ± ã€æ¦‚ç‡ã€ä¿åº•æœºåˆ¶
  - å¼ºåˆ¶ä¸­å¥–/ä¸ä¸­å¥–ï¼ˆå†™ `admin_operation_logs`ï¼‰
- **æ•°æ®æµ**ï¼š`User` â†’ `AssetService` â†’ `AssetTransaction` â†’ `UnifiedLotteryEngine` â†’ `ItemInstance` / `AssetTransaction`

#### 2. ææ–™å•†åŸï¼ˆMaterial Shopï¼‰

- **ç”¨æˆ·ç«¯**ï¼š`/api/v4/shop/exchange/*`
  - æµè§ˆå•†å“ï¼ˆæŸ¥ `exchange_items`ï¼Œ24 ä»¶ï¼‰
  - ç”¨ææ–™å…‘æ¢å•†å“ï¼ˆæ‰£ `asset_transactions`ï¼Œå†™ `exchange_records`ï¼‰
- **ç®¡ç†ç«¯**ï¼š`/api/v4/console/material/*`
  - é…ç½®å•†å“ã€æˆæœ¬ã€åº“å­˜
- **æ•°æ®æµ**ï¼š`User` â†’ `AssetService.changeBalance()` â†’ `AssetTransaction` â†’ `ExchangeService` â†’ `ExchangeRecord`
- âš ï¸ **å½“å‰çŠ¶æ€**ï¼š`exchange_records` æ˜¯ç©ºè¡¨ï¼Œä½† `asset_transactions` æœ‰ 378 æ¡ `exchange_debit`

#### 3. æ ¸é”€ç³»ç»Ÿï¼ˆRedemptionï¼‰

- **ç”¨æˆ·ç«¯**ï¼š`/api/v4/shop/redemption/*`
  - ä¸ºç‰©å“ç”Ÿæˆæ ¸é”€ç ï¼ˆå†™ `redemption_orders`ï¼Œ188 æ¡ï¼‰
  - æŸ¥è¯¢æ ¸é”€è®¢å•
- **å•†å®¶ç«¯**ï¼š`/api/v4/shop/redemption/fulfill`
  - æ‰«ç æ ¸é”€ï¼ˆæ›´æ–°è®¢å•çŠ¶æ€ + ç‰©å“çŠ¶æ€ï¼‰
- **æ•°æ®æµ**ï¼š`ItemInstance` â†’ `RedemptionService` â†’ `RedemptionOrder` â†’ `ItemInstance.status=used`

#### 4. C2C å¸‚åœºï¼ˆMarketï¼‰

- **ç”¨æˆ·ç«¯**ï¼š`/api/v4/market/*`
  - æŒ‚ç‰Œå‡ºå”®ç‰©å“ï¼ˆå†™ `market_listings`ï¼Œ1 è¡Œï¼‰
  - è´­ä¹°ä»–äººæŒ‚ç‰Œï¼ˆå†™ `trade_orders`ï¼Œ0 è¡Œï¼‰
- **æ•°æ®æµ**ï¼š`ItemInstance` â†’ `MarketListingService` â†’ `MarketListing` â†’ `TradeOrderService` â†’ `TradeOrder` + `AssetTransaction`
- âš ï¸ **å½“å‰çŠ¶æ€**ï¼šä»£ç å®Œæ•´ä½†**æœªå®é™…è¿è¡Œ**ï¼ˆ`trade_orders` æ˜¯ç©ºè¡¨ï¼‰

#### 5. èµ„äº§ç®¡ç†ï¼ˆAssetsï¼‰

- **ç”¨æˆ·ç«¯**ï¼š`/api/v4/assets/*`
  - æŸ¥è¯¢ä½™é¢ï¼ˆæŸ¥ `account_asset_balances`ï¼‰
  - æŸ¥è¯¢æµæ°´ï¼ˆæŸ¥ `asset_transactions`ï¼‰
- **ç®¡ç†ç«¯**ï¼š`/api/v4/console/asset-adjustment/*`
  - è°ƒæ•´ç”¨æˆ·èµ„äº§ï¼ˆå†™ `asset_transactions`ï¼Œ`business_type=admin_adjustment`ï¼Œ90 æ¡ï¼‰
- **æ•°æ®æµ**ï¼š`User` â†’ `Account` â†’ `AccountAssetBalance` â†’ `AssetTransaction`

### å•†ä¸šæ¨¡å¼åˆ†æ

**æ ¸å¿ƒèµ„äº§ç±»å‹**ï¼š

1. **POINTSï¼ˆç§¯åˆ†ï¼‰**ï¼šç”¨æˆ·ä¸»è¦è´§å¸ï¼Œç”¨äºæŠ½å¥–
2. **DIAMONDï¼ˆé’»çŸ³ï¼‰**ï¼šC2C å¸‚åœºç»“ç®—è´§å¸
3. **ææ–™èµ„äº§**ï¼š
   - `red_shard`ï¼ˆç¢çº¢æ°´æ™¶ï¼‰ï¼šæŠ½å¥–è·å¾—ï¼Œç”¨äºå…‘æ¢å•†å“
   - å…¶ä»–ææ–™ï¼šå¯è½¬æ¢ä¸ºé’»çŸ³

**èµ„é‡‘æµå‘**ï¼ˆåŸºäº `asset_transactions` åˆ†æï¼‰ï¼š

1. **ç”¨æˆ·è·å¾—ç§¯åˆ†**ï¼š
   - ç®¡ç†å‘˜è°ƒæ•´ï¼ˆ`admin_adjustment`ï¼Œ90 æ¡ï¼‰
   - æµ‹è¯•å……å€¼ï¼ˆ`test_recharge`ï¼Œ377 æ¡ï¼‰
2. **ç”¨æˆ·æ¶ˆè€—ç§¯åˆ†**ï¼š
   - æŠ½å¥–æ¶ˆè€—ï¼ˆ`lottery_consume`ï¼Œ1 æ¡ï¼‰
3. **ç”¨æˆ·è·å¾—ææ–™**ï¼š
   - æŠ½å¥–å¥–åŠ±ï¼ˆ`lottery_reward`ï¼‰
4. **ç”¨æˆ·æ¶ˆè€—ææ–™**ï¼š
   - å…‘æ¢å•†å“ï¼ˆ`exchange_debit`ï¼Œ378 æ¡ï¼‰

**å•†ä¸šé—­ç¯**ï¼š

- ç”¨æˆ·å……å€¼/è·å¾—ç§¯åˆ† â†’ æŠ½å¥–è·å¾—ææ–™ â†’ å…‘æ¢å®ç‰©å•†å“ â†’ æ ¸é”€æè´§
- C2C å¸‚åœºï¼šç”¨æˆ·é—´äº¤æ˜“ç‰©å“ï¼ˆç”¨é’»çŸ³ç»“ç®—ï¼‰

---

## ğŸ“‹ å»é‡æ•´åˆæ–¹æ¡ˆï¼ˆConsolidation Proposalï¼‰

### æ–¹æ¡ˆæ€»è§ˆ

| é—®é¢˜ç±»åˆ«     | ä¼˜å…ˆçº§ | æ•´åˆç›®æ ‡                              | é¢„æœŸæ”¶ç›Š             |
| ------------ | ------ | ------------------------------------- | -------------------- |
| è·¯ç”±å†²çª     | P0     | æ‹†åˆ†/é‡å‘½å `/refresh` æ¥å£           | æ¢å¤æƒé™ç¼“å­˜åˆ·æ–°åŠŸèƒ½ |
| å®¡è®¡å…¥å£é‡å¤ | P1     | ç»Ÿä¸€åˆ° `AuditLogService`              | ç®€åŒ–è°ƒç”¨ã€ç»Ÿä¸€è¯è¡¨   |
| å®¡æ ¸ç³»ç»Ÿé‡å  | P1     | ç¡®å®šå•ä¸€å®¡æ ¸æ¶æ„                      | å‡å°‘ç»´æŠ¤æˆæœ¬         |
| è§’è‰²å®¡è®¡é‡å¤ | P1     | ç»Ÿä¸€åˆ° `AdminOperationLog` + æ–‡ä»¶æ—¥å¿— | åˆ é™¤ç©ºè¡¨ã€ç»Ÿä¸€æŸ¥è¯¢   |
| äº¤æ˜“æµæ°´åŒè½¨ | P2     | ç¡®å®š `AssetTransaction` ä¸ºä¸»å¹²        | ç®€åŒ–å¯¹è´¦é€»è¾‘         |
| å…‘æ¢ç³»ç»Ÿæ··æ·† | P2     | æ˜ç¡®å‘½åå’ŒèŒè´£                        | å‡å°‘ç†è§£æˆæœ¬         |
| é—ç•™ç©ºè¡¨     | P2     | åˆ é™¤/åºŸå¼ƒæœªä½¿ç”¨çš„è¡¨                   | å‡å°‘æ•°æ®åº“ç»´æŠ¤æˆæœ¬   |

---

### æ–¹æ¡ˆ1ï¼šä¿®å¤è·¯ç”±å†²çªï¼ˆP0ï¼‰

**ç›®æ ‡**ï¼šè§£å†³ `POST /api/v4/auth/refresh` è·¯ç”±å†²çª

**å®æ–½æ­¥éª¤**ï¼š

1. **æ‹†åˆ†æƒé™ç®¡ç†è·¯ç”±**ï¼ˆæ¨èæ–¹æ¡ˆAï¼‰ï¼š

   ```javascript
   // app.jsï¼ˆæ–°å¢æŒ‚è½½ï¼‰
   app.use('/api/v4/permissions', require('./routes/v4/permissions'))

   // routes/v4/permissions/index.jsï¼ˆæ–°å»ºï¼‰
   const router = express.Router()
   router.use('/', require('./auth/permissions')) // å¤ç”¨ç°æœ‰ä»£ç 
   module.exports = router
   ```

2. **æ›´æ–°å‰ç«¯è°ƒç”¨è·¯å¾„**ï¼š
   - `POST /api/v4/auth/refresh` â†’ Token åˆ·æ–°ï¼ˆä¿æŒä¸å˜ï¼‰
   - `POST /api/v4/permissions/refresh` â†’ æƒé™ç¼“å­˜åˆ·æ–°ï¼ˆæ–°è·¯å¾„ï¼‰

3. **å…¼å®¹æ€§å¤„ç†**ï¼ˆå¯é€‰ï¼‰ï¼š
   - ä¿ç•™æ—§è·¯å¾„ 90 å¤©ï¼Œè¿”å› 301 é‡å®šå‘
   - åœ¨å“åº”å¤´æ·»åŠ  `X-Deprecated-Path: true`

**éªŒè¯æ–¹æ³•**ï¼š

```bash
# éªŒè¯ä¸¤ä¸ªæ¥å£éƒ½å¯è¾¾
curl -X POST http://localhost:3000/api/v4/auth/refresh \
  -H "Cookie: refresh_token=xxx"

curl -X POST http://localhost:3000/api/v4/permissions/refresh \
  -H "Authorization: Bearer xxx" \
  -d '{"user_id": 123}'
```

**é£é™©**ï¼š

- éœ€è¦æ›´æ–°å‰ç«¯ä»£ç ï¼ˆå½±å“èŒƒå›´ï¼šæƒé™ç®¡ç†ç›¸å…³é¡µé¢ï¼‰
- éœ€è¦æ›´æ–° API æ–‡æ¡£

---

### æ–¹æ¡ˆ2ï¼šç»Ÿä¸€å®¡è®¡å…¥å£ï¼ˆP1ï¼‰

**ç›®æ ‡**ï¼šç¡®å®šå”¯ä¸€å†™å…¥ `admin_operation_logs` çš„å…¥å£

**å®æ–½æ­¥éª¤**ï¼š

1. **ç¡®å®š `AuditLogService` ä¸ºå”¯ä¸€æœåŠ¡å±‚å…¥å£**ï¼š
   - ä¿ç•™ `services/AuditLogService.js`
   - æ‰€æœ‰æœåŠ¡å±‚è°ƒç”¨ç»Ÿä¸€ä½¿ç”¨ `AuditLogService.logOperation()`

2. **middleware/auditLog.js æ”¹ä¸ºè–„å°è£…**ï¼š

   ```javascript
   // middleware/auditLog.jsï¼ˆæ”¹é€ ï¼‰
   const AuditLogService = require('../services/AuditLogService')

   exports.logOperation = async (req, operationType, ...) => {
     // ä»…ä» req æå–å‚æ•°ï¼Œè½¬è°ƒ AuditLogService
     return AuditLogService.logOperation({
       operator_id: req.user.user_id,
       operation_type: operationType,
       ip_address: req.ip,
       user_agent: req.get('User-Agent'),
       ...
     })
   }
   ```

3. **ç»Ÿä¸€ operation_type è¯è¡¨**ï¼š

   ```javascript
   // constants/AuditOperationTypes.jsï¼ˆæ–°å»ºï¼‰
   module.exports = {
     POINTS_ADJUST: 'points_adjust',
     ASSET_ADJUSTMENT: 'asset_adjustment', // æ–°å¢
     EXCHANGE_AUDIT: 'exchange_audit',
     CONSUMPTION_AUDIT: 'consumption_audit',
     ROLE_CHANGE: 'role_change',
     INVENTORY_TRANSFER: 'inventory_transfer',
     LOTTERY_FORCE_WIN: 'lottery_force_win',
     LOTTERY_PROBABILITY_ADJUST: 'lottery_probability_adjust'
     // ... å…¶ä»–ç±»å‹
   }
   ```

4. **ä¿®å¤é”™è¯¯è°ƒç”¨**ï¼š
   - `routes/v4/console/asset-adjustment.js:119`ï¼š`AuditLogService.log()` â†’ `AuditLogService.logOperation()`
   - æ·»åŠ  `asset_adjustment` åˆ° `validOperationTypes`

**éªŒè¯æ–¹æ³•**ï¼š

```javascript
// æµ‹è¯•è„šæœ¬
const AuditLogService = require('./services/AuditLogService')
const result = await AuditLogService.logOperation({
  operator_id: 1,
  operation_type: 'asset_adjustment', // æ–°ç±»å‹
  target_type: 'user_asset',
  target_id: 123,
  action: 'update',
  reason: 'æµ‹è¯•'
})
console.log('å®¡è®¡æ—¥å¿—ID:', result.log_id)
```

**é£é™©**ï¼š

- éœ€è¦å›å½’æµ‹è¯•æ‰€æœ‰å®¡è®¡æ—¥å¿—è®°å½•ç‚¹
- éœ€è¦ç¡®è®¤ `operation_type` è¯è¡¨å®Œæ•´æ€§

---

### æ–¹æ¡ˆ3ï¼šå®¡æ ¸ç³»ç»Ÿæ”¶æ•›ï¼ˆP1ï¼‰

**ç›®æ ‡**ï¼šç¡®å®šå•ä¸€å®¡æ ¸æ¶æ„ï¼ŒåºŸå¼ƒæœªä½¿ç”¨çš„æ¨¡å—

**å®æ–½æ­¥éª¤**ï¼š

#### 3.1 ç¡®å®šä¸šåŠ¡éœ€æ±‚

- **é—®é¢˜1**ï¼šæ˜¯å¦éœ€è¦"ä¸šåŠ¡å®¡æ ¸æµ"ï¼ˆå¾…å®¡æ ¸â†’å·²å®¡æ ¸çš„çŠ¶æ€æœºï¼‰ï¼Ÿ
  - è‹¥**éœ€è¦**ï¼šå¯ç”¨ `ContentReviewRecord` + `ContentAuditEngine`
  - è‹¥**ä¸éœ€è¦**ï¼šåºŸå¼ƒå¹¶ä»ä»£ç ä¸­ç§»é™¤

- **é—®é¢˜2**ï¼šæ˜¯å¦éœ€è¦"å•†æˆ·ç§¯åˆ†å®¡æ ¸"ï¼ˆå†»ç»“â†’ç»“ç®—çš„ä¸“ç”¨æµç¨‹ï¼‰ï¼Ÿ
  - è‹¥**éœ€è¦**ï¼šå¯ç”¨ `MerchantPointsReview` + `MerchantReviewService`
  - è‹¥**ä¸éœ€è¦**ï¼šåºŸå¼ƒå¹¶ä»ä»£ç ä¸­ç§»é™¤

#### 3.2 è‹¥åºŸå¼ƒ ContentReviewRecord

**æ¸…ç†èŒƒå›´**ï¼š

- åˆ é™¤æ¨¡å‹ï¼š`models/ContentReviewRecord.js`
- åˆ é™¤æœåŠ¡ï¼š`services/ContentAuditEngine.js`
- åˆ é™¤è¡¨ï¼š`DROP TABLE content_review_records`
- ä¿®æ”¹æœåŠ¡ï¼š
  - `ConsumptionService`ï¼šç§»é™¤ `ContentReviewRecord.create()` è°ƒç”¨
  - å®¡æ ¸é€šè¿‡/æ‹’ç»ç›´æ¥å†™ `AdminOperationLog`ï¼ˆå·²åœ¨åšï¼‰

**æ•°æ®è¿ç§»**ï¼šæ— éœ€è¿ç§»ï¼ˆè¡¨æ˜¯ç©ºçš„ï¼‰

#### 3.3 è‹¥åºŸå¼ƒ MerchantPointsReview

**æ¸…ç†èŒƒå›´**ï¼š

- åˆ é™¤æ¨¡å‹ï¼š`models/MerchantPointsReview.js`
- åˆ é™¤æœåŠ¡ï¼š`services/MerchantReviewService.js`
- åˆ é™¤è·¯ç”±ï¼š`routes/v4/merchant/reviews.js`
- åˆ é™¤è¡¨ï¼š`DROP TABLE merchant_points_reviews`

**æ•°æ®è¿ç§»**ï¼šæ— éœ€è¿ç§»ï¼ˆè¡¨æ˜¯ç©ºçš„ï¼‰

#### 3.4 è‹¥ä¿ç•™å¹¶å¯ç”¨

**éœ€è¦è¡¥å……**ï¼š

- å‰ç«¯å®¡æ ¸ç•Œé¢
- å®¡æ ¸å·¥ä½œæµæµ‹è¯•
- ä¸ `AdminOperationLog` çš„å¯¹è´¦æœºåˆ¶

---

### æ–¹æ¡ˆ4ï¼šè§’è‰²å®¡è®¡æ”¶æ•›ï¼ˆP1ï¼‰

**ç›®æ ‡**ï¼šç»Ÿä¸€è§’è‰²å˜æ›´å®¡è®¡åˆ°ä¸¤å±‚

**å®æ–½æ­¥éª¤**ï¼š

1. **åºŸå¼ƒ role_change_logs è¡¨**ï¼š

   ```sql
   -- 1. ç¡®è®¤è¡¨æ˜¯ç©ºçš„
   SELECT COUNT(*) FROM role_change_logs;  -- åº”ä¸º 0

   -- 2. åˆ é™¤å¤–é”®çº¦æŸ
   ALTER TABLE role_change_logs DROP FOREIGN KEY role_change_logs_ibfk_1;
   ALTER TABLE role_change_logs DROP FOREIGN KEY role_change_logs_ibfk_2;
   ALTER TABLE role_change_logs DROP FOREIGN KEY role_change_logs_ibfk_3;
   ALTER TABLE role_change_logs DROP FOREIGN KEY role_change_logs_ibfk_4;

   -- 3. åˆ é™¤è¡¨
   DROP TABLE role_change_logs;
   ```

2. **åˆ é™¤ Sequelize æ¨¡å‹**ï¼š
   - åˆ é™¤æ–‡ä»¶ï¼š`models/RoleChangeLog.js`
   - ä» `models/index.js` ç§»é™¤å¼•ç”¨

3. **ä¿®æ”¹ HierarchyManagementService**ï¼š
   - ç§»é™¤ `RoleChangeLog.create()` è°ƒç”¨
   - æ”¹ç”¨ `AuditLogService.logOperation({ operation_type: 'role_change', ... })`

4. **ä¿ç•™ PermissionAuditLoggerï¼ˆæ–‡ä»¶æ—¥å¿—ï¼‰**ï¼š
   - ç”¨äºè®°å½•é«˜é¢‘æƒé™æ£€æŸ¥ï¼ˆä¸è¿› DBï¼‰
   - ç”¨äºæ€§èƒ½ç›‘æ§å’Œå¼‚å¸¸æ£€æµ‹

**éªŒè¯æ–¹æ³•**ï¼š

```javascript
// æµ‹è¯•è§’è‰²å˜æ›´å®¡è®¡
const UserRoleService = require('./services/UserRoleService')
await UserRoleService.updateUserRole(123, 'admin', { transaction })

// éªŒè¯å®¡è®¡æ—¥å¿—å·²å†™å…¥
const { AdminOperationLog } = require('./models')
const logs = await AdminOperationLog.findAll({
  where: { operation_type: 'role_change', target_id: 123 },
  order: [['created_at', 'DESC']],
  limit: 1
})
console.log('æœ€æ–°å®¡è®¡æ—¥å¿—:', logs[0])
```

**é£é™©**ï¼š

- éœ€è¦å›å½’æµ‹è¯•æ‰€æœ‰è§’è‰²å˜æ›´åœºæ™¯
- éœ€è¦ç¡®è®¤ `HierarchyManagementService` çš„æ‰€æœ‰è°ƒç”¨ç‚¹

---

### æ–¹æ¡ˆ5ï¼šäº¤æ˜“æµæ°´ç»Ÿä¸€çœŸç›¸æ¨¡å‹ï¼ˆP2ï¼‰

**ç›®æ ‡**ï¼šç¡®å®š `AssetTransaction` ä¸ºèµ„äº§å˜åŠ¨å”¯ä¸€äº‹å®æ¥æº

**å®æ–½æ­¥éª¤**ï¼š

1. **ç¡®å®šäº‹å®æ¨¡å‹**ï¼š
   - **èµ„äº§å˜åŠ¨äº‹å®**ï¼š`AssetTransaction`ï¼ˆå·²æ˜¯ä¸»å¹²ï¼Œ846 è¡Œï¼‰
   - **è®¢å•äº‹å®**ï¼š
     - C2C å¸‚åœºï¼š`TradeOrder`ï¼ˆä»£ç å·²å°±ç»ªï¼Œå¾…å¯ç”¨ï¼‰
     - B2C å…‘æ¢ï¼š`ExchangeRecord`ï¼ˆä»£ç å·²å°±ç»ªï¼Œå¾…å¯ç”¨ï¼‰
     - æ ¸é”€ç³»ç»Ÿï¼š`RedemptionOrder`ï¼ˆå·²æ´»è·ƒï¼Œ188 è¡Œï¼‰
   - **ç‰©å“äº‹å®**ï¼š`ItemInstance` + `ItemInstanceEvent`ï¼ˆ431/236 è¡Œï¼‰

2. **TradeRecord é€€ä¸ºè¯»æ¨¡å‹**ï¼š
   - ä¿ç•™è¡¨å’Œæ¨¡å‹ï¼ˆä¿å­˜ 2 æ¡å†å²æ•°æ®ï¼‰
   - æ·»åŠ  `is_legacy` å­—æ®µæ ‡è®°å†å²æ•°æ®
   - ç¦æ­¢æ–°å†™å…¥ï¼ˆç§»é™¤ `FeeCalculator.createTradeRecord()` è°ƒç”¨ï¼‰
   - `BackpackService.getTransferHistory()` æ”¹ä¸ºæŸ¥è¯¢ `ItemInstanceEvent`

3. **ä¿®å¤ FeeCalculator é›†æˆ**ï¼š
   - `TradeOrderService` ä¸­å·²è®¡ç®—æ‰‹ç»­è´¹ï¼ˆé€šè¿‡ `FeeCalculator.calculateItemFee()`ï¼‰
   - ä½†æœªå†™å…¥ `TradeRecord`ï¼ˆæ­£ç¡®è¡Œä¸ºï¼Œå› ä¸ºå·²å†™ `TradeOrder` + `AssetTransaction`ï¼‰
   - åˆ é™¤ `FeeCalculator.createTradeRecord()` æ–¹æ³•ï¼ˆæœªè¢«è°ƒç”¨ï¼‰

4. **è°ƒæŸ¥ exchange_debit ä¸ exchange_records ä¸ä¸€è‡´**ï¼š

   ```javascript
   // æ£€æŸ¥è„šæœ¬
   const { sequelize } = require('./config/database')

   const [exchangeDebits] = await sequelize.query(`
     SELECT COUNT(*) AS cnt
     FROM asset_transactions
     WHERE business_type = 'exchange_debit'
   `)

   const [exchangeRecords] = await sequelize.query(`
     SELECT COUNT(*) AS cnt
     FROM exchange_records
   `)

   console.log('exchange_debit æµæ°´:', exchangeDebits[0].cnt) // 378
   console.log('exchange_records è®¢å•:', exchangeRecords[0].cnt) // 0
   // è‹¥ä¸ä¸€è‡´ï¼Œè¯´æ˜è®¢å•åˆ›å»ºé€»è¾‘æœ‰ bug
   ```

**éªŒè¯æ–¹æ³•**ï¼š

```javascript
// éªŒè¯æ–°äº¤æ˜“ä¸å†å†™ TradeRecord
const { TradeRecord } = require('./models')
const countBefore = await TradeRecord.count()

// æ‰§è¡Œä¸€ç¬”å¸‚åœºäº¤æ˜“
// ...

const countAfter = await TradeRecord.count()
assert(countBefore === countAfter, 'TradeRecord ä¸åº”å†å†™å…¥')
```

**é£é™©**ï¼š

- `BackpackService.getTransferHistory()` éœ€è¦æ”¹é€ ï¼ˆæŸ¥è¯¢ `ItemInstanceEvent` æ›¿ä»£ `TradeRecord`ï¼‰
- éœ€è¦ç¡®è®¤ 2 æ¡å†å² `TradeRecord` æ•°æ®æ˜¯å¦éœ€è¦è¿ç§»åˆ°æ–°æ¨¡å‹

---

### æ–¹æ¡ˆ6ï¼šæ˜ç¡®å…‘æ¢ç³»ç»Ÿå‘½åï¼ˆP2ï¼‰

**ç›®æ ‡**ï¼šæ¶ˆé™¤ `ExchangeService` ä¸ `RedemptionService` çš„è¯­ä¹‰æ··æ·†

**å®æ–½æ­¥éª¤**ï¼š

1. **é‡å‘½åæœåŠ¡å’Œè·¯ç”±**ï¼ˆå¯é€‰ï¼Œå½±å“è¾ƒå¤§ï¼‰ï¼š
   - `ExchangeService` â†’ `MaterialShopService`
   - `/api/v4/shop/exchange/*` â†’ `/api/v4/shop/material-shop/*`
   - æˆ–ä¿æŒè·¯å¾„ä¸å˜ï¼Œä½†åœ¨æ–‡æ¡£ä¸­æ˜ç¡®è¯´æ˜

2. **æ›´æ–°ä»£ç æ³¨é‡Š**ï¼ˆæœ€å°æ”¹åŠ¨ï¼‰ï¼š

   ```javascript
   // routes/v4/shop/exchange/index.js
   /**
    * B2Cææ–™å…‘æ¢æ¨¡å—ï¼ˆMaterial Shopï¼‰
    *
    * ä¸šåŠ¡åœºæ™¯ï¼šç”¨æˆ·ä½¿ç”¨ææ–™èµ„äº§å…‘æ¢å®ç‰©å•†å“ï¼ˆå®˜æ–¹å•†åŸï¼‰
    * ä¸æ ¸é”€ç³»ç»Ÿçš„åŒºåˆ«ï¼š
    * - ExchangeServiceï¼šææ–™ â†’ å•†å“ï¼ˆB2Cï¼Œå®˜æ–¹å•†åŸï¼‰
    * - RedemptionServiceï¼šç‰©å“ â†’ æ ¸é”€ç  â†’ æè´§ï¼ˆæ ¸é”€æµç¨‹ï¼‰
    */
   ```

3. **è°ƒæŸ¥æ•°æ®ä¸ä¸€è‡´**ï¼š
   - ä¸ºä½•æœ‰ 378 æ¡ `exchange_debit` ä½† 0 æ¡ `exchange_records`ï¼Ÿ
   - æ£€æŸ¥ `ExchangeService.exchangeItem()` çš„è®¢å•åˆ›å»ºé€»è¾‘
   - è‹¥æ˜¯æµ‹è¯•æ•°æ®ï¼Œæ¸…ç† `asset_transactions` ä¸­çš„æµ‹è¯•è®°å½•

**éªŒè¯æ–¹æ³•**ï¼š

```javascript
// æµ‹è¯•å…‘æ¢æµç¨‹å®Œæ•´æ€§
const ExchangeService = require('./services/ExchangeService')
const { sequelize } = require('./config/database')

await sequelize.transaction(async transaction => {
  const result = await ExchangeService.exchangeItem(user_id, item_id, quantity, {
    transaction,
    idempotency_key: 'test_exchange_123'
  })

  // éªŒè¯è®¢å•å·²åˆ›å»º
  const { ExchangeRecord } = require('./models')
  const order = await ExchangeRecord.findOne({
    where: { idempotency_key: 'test_exchange_123' },
    transaction
  })
  assert(order !== null, 'ExchangeRecord åº”è¯¥è¢«åˆ›å»º')

  // éªŒè¯æµæ°´å·²å†™å…¥
  const { AssetTransaction } = require('./models')
  const txn = await AssetTransaction.findOne({
    where: {
      business_type: 'exchange_debit',
      idempotency_key: { [Op.like]: '%test_exchange_123%' }
    },
    transaction
  })
  assert(txn !== null, 'AssetTransaction åº”è¯¥è¢«åˆ›å»º')
})
```

**é£é™©**ï¼š

- è‹¥é‡å‘½åæœåŠ¡ï¼Œå½±å“èŒƒå›´è¾ƒå¤§ï¼ˆéœ€è¦æ›´æ–°æ‰€æœ‰è°ƒç”¨æ–¹ï¼‰
- å»ºè®®å…ˆä¿®å¤æ•°æ®ä¸ä¸€è‡´ï¼Œå†è€ƒè™‘é‡å‘½å

---

### æ–¹æ¡ˆ7ï¼šæ¸…ç†é—ç•™ç©ºè¡¨ï¼ˆP2ï¼‰

**ç›®æ ‡**ï¼šåˆ é™¤ä»æœªä½¿ç”¨çš„æ•°æ®åº“è¡¨

**å®æ–½æ­¥éª¤**ï¼š

#### 7.1 ç«‹å³åˆ é™¤ï¼ˆæ— ä»£ç å¼•ç”¨ï¼‰

**audit_records**ï¼š

```sql
-- 1. ç¡®è®¤æ— æ•°æ®
SELECT COUNT(*) FROM audit_records;  -- åº”ä¸º 0

-- 2. ç¡®è®¤æ— å¤–é”®ä¾èµ–
SELECT
  TABLE_NAME, CONSTRAINT_NAME, REFERENCED_TABLE_NAME
FROM information_schema.KEY_COLUMN_USAGE
WHERE REFERENCED_TABLE_NAME = 'audit_records';

-- 3. åˆ é™¤è¡¨
DROP TABLE audit_records;
```

**éªŒè¯**ï¼š

```bash
# ç¡®è®¤ä»£ç ä¸­æ— å¼•ç”¨
grep -r "audit_records\|AuditRecord" services/ routes/ models/ middleware/
# åº”æ— ç»“æœï¼ˆæˆ–ä»…åœ¨è¿ç§»æ–‡ä»¶/å¤‡ä»½æ–‡ä»¶ä¸­ï¼‰
```

#### 7.2 éœ€è¦å†³ç­–ååˆ é™¤

**role_change_logs**ï¼ˆè‹¥å†³å®šåºŸå¼ƒï¼‰ï¼š

```sql
-- 1. åˆ é™¤å¤–é”®
ALTER TABLE role_change_logs DROP FOREIGN KEY role_change_logs_ibfk_1;
ALTER TABLE role_change_logs DROP FOREIGN KEY role_change_logs_ibfk_2;
ALTER TABLE role_change_logs DROP FOREIGN KEY role_change_logs_ibfk_3;
ALTER TABLE role_change_logs DROP FOREIGN KEY role_change_logs_ibfk_4;

-- 2. åˆ é™¤è¡¨
DROP TABLE role_change_logs;
```

**ä»£ç æ¸…ç†**ï¼š

- åˆ é™¤ `models/RoleChangeLog.js`
- ä» `models/index.js` ç§»é™¤å¼•ç”¨
- ä» `HierarchyManagementService` ç§»é™¤ `RoleChangeLog.create()` è°ƒç”¨

**content_review_records**ï¼ˆè‹¥å†³å®šåºŸå¼ƒï¼‰ï¼š

```sql
DROP TABLE content_review_records;
```

**ä»£ç æ¸…ç†**ï¼š

- åˆ é™¤ `models/ContentReviewRecord.js`
- åˆ é™¤ `services/ContentAuditEngine.js`
- ä» `ConsumptionService` ç§»é™¤ `ContentReviewRecord.create()` è°ƒç”¨

**merchant_points_reviews**ï¼ˆè‹¥å†³å®šåºŸå¼ƒï¼‰ï¼š

```sql
DROP TABLE merchant_points_reviews;
```

**ä»£ç æ¸…ç†**ï¼š

- åˆ é™¤ `models/MerchantPointsReview.js`
- åˆ é™¤ `services/MerchantReviewService.js`
- åˆ é™¤ `routes/v4/merchant/reviews.js`
- ä» `routes/v4/merchant/index.js` ç§»é™¤æŒ‚è½½

**é£é™©**ï¼š

- è‹¥æœªæ¥éœ€è¦è¿™äº›åŠŸèƒ½ï¼Œéœ€è¦é‡æ–°å®ç°
- å»ºè®®å…ˆæ ‡è®°ä¸º `@deprecated`ï¼Œè§‚å¯Ÿ 3 ä¸ªæœˆåå†åˆ é™¤

---

## ğŸ“Š æ•°æ®åº“è¡¨ä½¿ç”¨æƒ…å†µçŸ©é˜µ

### æ´»è·ƒè¡¨ï¼ˆæœ‰æ•°æ®ä¸”ä»£ç åœ¨ç”¨ï¼‰

| è¡¨å                       | è¡Œæ•° | æœ€æ–°æ—¶é—´   | ä¸»è¦æœåŠ¡             | ä¸»è¦è·¯ç”±                    | ä¸šåŠ¡åŸŸ |
| -------------------------- | ---- | ---------- | -------------------- | --------------------------- | ------ |
| `admin_operation_logs`     | 1046 | 2026-01-07 | `AuditLogService`    | `/api/v4/console/*`         | å®¡è®¡   |
| `asset_transactions`       | 846  | 2026-01-07 | `AssetService`       | `/api/v4/assets/*`          | èµ„äº§   |
| `item_instances`           | 431  | -          | `ItemInstance`       | `/api/v4/backpack/*`        | ç‰©å“   |
| `api_idempotency_requests` | 306  | -          | `IdempotencyService` | æ‰€æœ‰ API                    | å¹‚ç­‰   |
| `item_instance_events`     | 236  | -          | `ItemInstance`       | -                           | ç‰©å“   |
| `redemption_orders`        | 188  | -          | `RedemptionService`  | `/api/v4/shop/redemption/*` | æ ¸é”€   |
| `exchange_items`           | 24   | -          | `ExchangeService`    | `/api/v4/shop/exchange/*`   | å…‘æ¢   |
| `users`                    | 23   | -          | `UserService`        | `/api/v4/user/*`            | ç”¨æˆ·   |

### ç©ºè¡¨ï¼ˆæœ‰ä»£ç ä½†æ— æ•°æ®ï¼‰

| è¡¨å                      | è¡Œæ•° | æ¨¡å‹å­˜åœ¨ | æœåŠ¡å­˜åœ¨ | è·¯ç”±å­˜åœ¨ | å»ºè®®                         |
| ------------------------- | ---- | -------- | -------- | -------- | ---------------------------- |
| `exchange_records`        | 0    | âœ…       | âœ…       | âœ…       | **å¾…å¯ç”¨** æˆ– è°ƒæŸ¥æ•°æ®ä¸ä¸€è‡´ |
| `trade_orders`            | 0    | âœ…       | âœ…       | âœ…       | **å¾…å¯ç”¨**ï¼ˆC2C å¸‚åœºï¼‰       |
| `content_review_records`  | 0    | âœ…       | âœ…       | âŒ       | **åºŸå¼ƒ** æˆ– å¯ç”¨å®¡æ ¸æµ       |
| `merchant_points_reviews` | 0    | âœ…       | âœ…       | âœ…       | **åºŸå¼ƒ** æˆ– å¯ç”¨å•†æˆ·å®¡æ ¸     |
| `role_change_logs`        | 0    | âœ…       | âŒ       | âŒ       | **åºŸå¼ƒ**ï¼ˆæ¨èåˆ é™¤ï¼‰         |
| `audit_records`           | 0    | âŒ       | âŒ       | âŒ       | **åºŸå¼ƒ**ï¼ˆç«‹å³åˆ é™¤ï¼‰         |
| `consumption_records`     | 0    | âœ…       | âœ…       | âœ…       | **å¾…å¯ç”¨** æˆ– åºŸå¼ƒ           |

### æ®‹ç•™è¡¨ï¼ˆæœ‰å°‘é‡å†å²æ•°æ®ï¼‰

| è¡¨å            | è¡Œæ•° | æœ€æ–°æ—¶é—´   | å»ºè®®                           |
| --------------- | ---- | ---------- | ------------------------------ |
| `trade_records` | 2    | 2025-12-12 | æ ‡è®°ä¸º `is_legacy`ï¼Œé€€ä¸ºè¯»æ¨¡å‹ |

---

## ğŸ¯ å®æ–½ä¼˜å…ˆçº§ä¸æ—¶é—´è¡¨

### ç¬¬ä¸€é˜¶æ®µï¼ˆP0ï¼Œç«‹å³æ‰§è¡Œï¼Œ1-2å¤©ï¼‰

**ç›®æ ‡**ï¼šä¿®å¤å½±å“åŠŸèƒ½å¯ç”¨æ€§çš„é—®é¢˜

- [ ] ä¿®å¤ `POST /api/v4/auth/refresh` è·¯ç”±å†²çª
  - æ‹†åˆ†æƒé™è·¯ç”±åˆ° `/api/v4/permissions/*`
  - æ›´æ–°å‰ç«¯è°ƒç”¨è·¯å¾„
  - å›å½’æµ‹è¯• Token åˆ·æ–°å’Œæƒé™ç¼“å­˜åˆ·æ–°

**éªŒæ”¶æ ‡å‡†**ï¼š

- âœ… `POST /api/v4/auth/refresh` è¿”å›æ–° Token
- âœ… `POST /api/v4/permissions/refresh` æ¸…é™¤æƒé™ç¼“å­˜
- âœ… ä¸¤ä¸ªæ¥å£äº’ä¸å¹²æ‰°

---

### ç¬¬äºŒé˜¶æ®µï¼ˆP1ï¼Œ1å‘¨å†…ï¼Œ3-5å¤©ï¼‰

**ç›®æ ‡**ï¼šç»Ÿä¸€å®¡è®¡å®¡æ ¸æ¶æ„

- [ ] ç»Ÿä¸€å®¡è®¡å…¥å£åˆ° `AuditLogService`
  - æ”¹é€  `middleware/auditLog.js` ä¸ºè–„å°è£…
  - ç»Ÿä¸€ `operation_type` è¯è¡¨
  - ä¿®å¤ `routes/v4/console/asset-adjustment.js` é”™è¯¯è°ƒç”¨
  - å›å½’æµ‹è¯•æ‰€æœ‰å®¡è®¡æ—¥å¿—è®°å½•ç‚¹

- [ ] å†³ç­–å®¡æ ¸ç³»ç»Ÿæ¶æ„
  - ç¡®å®šæ˜¯å¦éœ€è¦ `ContentReviewRecord`ï¼ˆä¸šåŠ¡å®¡æ ¸æµï¼‰
  - ç¡®å®šæ˜¯å¦éœ€è¦ `MerchantPointsReview`ï¼ˆå•†æˆ·ç§¯åˆ†å®¡æ ¸ï¼‰
  - è‹¥åºŸå¼ƒï¼Œæ‰§è¡Œä»£ç å’Œè¡¨æ¸…ç†

- [ ] ç»Ÿä¸€è§’è‰²å®¡è®¡
  - åºŸå¼ƒ `role_change_logs` è¡¨å’Œæ¨¡å‹
  - ä¿®æ”¹ `HierarchyManagementService` ä½¿ç”¨ `AuditLogService`
  - ä¿ç•™ `PermissionAuditLogger` ç”¨äºé«˜é¢‘æ£€æŸ¥

**éªŒæ”¶æ ‡å‡†**ï¼š

- âœ… æ‰€æœ‰å®¡è®¡æ—¥å¿—ç»Ÿä¸€ä» `AuditLogService.logOperation()` å†™å…¥
- âœ… `operation_type` è¯è¡¨ç»Ÿä¸€ä¸”å®Œæ•´
- âœ… è§’è‰²å˜æ›´å®¡è®¡ç»Ÿä¸€åˆ° `admin_operation_logs`
- âœ… å®¡æ ¸ç³»ç»Ÿæ¶æ„æ˜ç¡®ï¼ˆä¿ç•™æˆ–åºŸå¼ƒï¼‰

---

### ç¬¬ä¸‰é˜¶æ®µï¼ˆP2ï¼Œ2-3å‘¨ï¼Œé•¿æœŸä¼˜åŒ–ï¼‰

**ç›®æ ‡**ï¼šæ¸…ç†æŠ€æœ¯å€ºåŠ¡ï¼Œä¼˜åŒ–æ•°æ®æ¨¡å‹

- [ ] äº¤æ˜“æµæ°´ç»Ÿä¸€çœŸç›¸æ¨¡å‹
  - ç¡®å®š `AssetTransaction` ä¸ºèµ„äº§å˜åŠ¨å”¯ä¸€äº‹å®æ¥æº
  - `TradeRecord` é€€ä¸ºè¯»æ¨¡å‹æˆ–åºŸå¼ƒ
  - ä¿®å¤ `BackpackService.getTransferHistory()` æŸ¥è¯¢é€»è¾‘

- [ ] æ˜ç¡®å…‘æ¢ç³»ç»Ÿå‘½å
  - æ›´æ–°ä»£ç æ³¨é‡Šå’Œæ–‡æ¡£
  - è°ƒæŸ¥å¹¶ä¿®å¤ `exchange_debit` ä¸ `exchange_records` ä¸ä¸€è‡´

- [ ] æ¸…ç†é—ç•™ç©ºè¡¨
  - åˆ é™¤ `audit_records`ï¼ˆç«‹å³ï¼‰
  - åˆ é™¤ `role_change_logs`ï¼ˆè‹¥å†³å®šåºŸå¼ƒï¼‰
  - åˆ é™¤ `content_review_records`ï¼ˆè‹¥å†³å®šåºŸå¼ƒï¼‰
  - åˆ é™¤ `merchant_points_reviews`ï¼ˆè‹¥å†³å®šåºŸå¼ƒï¼‰

**éªŒæ”¶æ ‡å‡†**ï¼š

- âœ… æ•°æ®åº“ä¸­æ— æœªä½¿ç”¨çš„è¡¨
- âœ… äº¤æ˜“æµæ°´æŸ¥è¯¢é€»è¾‘ç»Ÿä¸€
- âœ… å…‘æ¢ç³»ç»Ÿå‘½åæ¸…æ™°

---

## ğŸ›¡ï¸ é˜²æ­¢é‡å¤çš„æ²»ç†è§„åˆ™

### è§„åˆ™1ï¼šè·¯ç”±å”¯ä¸€æ€§å¼ºåˆ¶æ£€æŸ¥

**å®æ–½æ–¹æ³•**ï¼š

- å‡çº§ `scripts/check-route-duplicates.js` æ”¯æŒé€’å½’è§£æ `router.use()`
- åœ¨ CI ä¸­å¼ºåˆ¶æ‰§è¡Œï¼š`npm run check-routes`
- è‹¥å‘ç°é‡å¤è·¯ç”±ï¼Œæ„å»ºå¤±è´¥

**æ£€æŸ¥è„šæœ¬å¢å¼º**ï¼š

```javascript
// scripts/check-route-duplicates.jsï¼ˆå¢å¼ºç‰ˆï¼‰
// 1. é€’å½’è§£ææ‰€æœ‰ router.use() æŒ‚è½½
// 2. æ„å»ºå®Œæ•´çš„ method + path æ˜ å°„
// 3. æ£€æµ‹å†²çªï¼ˆåŒä¸€ method + path è¢«å¤šæ¬¡æ³¨å†Œï¼‰
// 4. æ£€æµ‹é®è”½ï¼ˆåŒä¸€æŒ‚è½½ç‚¹ä¸‹æœ‰å¤šä¸ªå­è·¯ç”±å®šä¹‰ç›¸åŒè·¯å¾„ï¼‰
```

### è§„åˆ™2ï¼šå®¡è®¡å…¥å£å•ä¸€çœŸç›¸æº

**å¼ºåˆ¶è§„èŒƒ**ï¼š

- âœ… æ‰€æœ‰å®¡è®¡æ—¥å¿—**å¿…é¡»**é€šè¿‡ `AuditLogService.logOperation()` å†™å…¥
- âŒ ç¦æ­¢ç›´æ¥ `AdminOperationLog.create()`
- âŒ ç¦æ­¢åœ¨å¤šå¤„å®šä¹‰ `operation_type` è¯è¡¨

**ä»£ç å®¡æŸ¥æ£€æŸ¥ç‚¹**ï¼š

```bash
# æ£€æŸ¥æ˜¯å¦æœ‰ç›´æ¥å†™ AdminOperationLog çš„ä»£ç 
grep -r "AdminOperationLog.create" services/ routes/ middleware/
# åº”ä»…åœ¨ AuditLogService.js ä¸­å‡ºç°
```

### è§„åˆ™3ï¼šæ•°æ®æ¨¡å‹å˜æ›´è¯„å®¡

**å¼ºåˆ¶æµç¨‹**ï¼š

- æ–°å¢è¡¨å‰ï¼Œæ£€æŸ¥æ˜¯å¦å·²æœ‰ç±»ä¼¼åŠŸèƒ½çš„è¡¨
- æ–°å¢æœåŠ¡å‰ï¼Œæ£€æŸ¥æ˜¯å¦å·²æœ‰ç±»ä¼¼èŒè´£çš„æœåŠ¡
- æ‰€æœ‰æ•°æ®æ¨¡å‹å˜æ›´éœ€è¦æ¶æ„å¸ˆè¯„å®¡

**è¯„å®¡æ£€æŸ¥æ¸…å•**ï¼š

- [ ] æ˜¯å¦ä¸ç°æœ‰è¡¨åŠŸèƒ½é‡å¤ï¼Ÿ
- [ ] æ˜¯å¦å¯ä»¥å¤ç”¨ç°æœ‰æœåŠ¡ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æ–°å¢ `operation_type`ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æ–°å¢è·¯ç”±åŸŸï¼Ÿ

### è§„åˆ™4ï¼šç©ºè¡¨å®šæœŸæ¸…ç†

**å®šæœŸæ£€æŸ¥**ï¼ˆæ¯å­£åº¦ï¼‰ï¼š

```sql
-- æŸ¥æ‰¾ç©ºè¡¨
SELECT
  t.TABLE_NAME,
  t.TABLE_ROWS,
  t.CREATE_TIME,
  t.UPDATE_TIME
FROM information_schema.TABLES t
WHERE t.TABLE_SCHEMA = DATABASE()
  AND t.TABLE_TYPE = 'BASE TABLE'
  AND t.TABLE_ROWS = 0
ORDER BY t.CREATE_TIME DESC;
```

**æ¸…ç†æµç¨‹**ï¼š

1. ç¡®è®¤è¡¨æ˜¯å¦æœ‰ä»£ç å¼•ç”¨ï¼ˆ`grep -r "table_name"`ï¼‰
2. è‹¥æ— å¼•ç”¨ï¼Œç›´æ¥åˆ é™¤
3. è‹¥æœ‰å¼•ç”¨ä½†æœªä½¿ç”¨ï¼Œæ ‡è®°ä¸º `@deprecated`ï¼Œ3 ä¸ªæœˆååˆ é™¤
4. è‹¥æœ‰å¼•ç”¨ä¸”è®¡åˆ’å¯ç”¨ï¼Œæ·»åŠ åˆ°"å¾…å¯ç”¨åŠŸèƒ½æ¸…å•"

---

## ğŸ“ˆ é¢„æœŸæ”¶ç›Š

### ä»£ç è´¨é‡æå‡

- âœ… å‡å°‘ **4 ä¸ªé‡å¤æ¨¡å—**ï¼ˆ`middleware/auditLog` è–„å°è£…ã€`ContentAuditEngine` åºŸå¼ƒã€`RoleChangeLog` åºŸå¼ƒã€`TradeRecord` é€€ä¸ºè¯»æ¨¡å‹ï¼‰
- âœ… ç»Ÿä¸€ **3 ä¸ªå…¥å£**ï¼ˆå®¡è®¡ã€å®¡æ ¸ã€äº¤æ˜“æµæ°´ï¼‰
- âœ… åˆ é™¤ **2-4 å¼ ç©ºè¡¨**ï¼ˆ`audit_records`ã€`role_change_logs`ã€å¯é€‰ `content_review_records`ã€`merchant_points_reviews`ï¼‰

### ç»´æŠ¤æˆæœ¬é™ä½

- âœ… å®¡è®¡æ—¥å¿—è°ƒç”¨æ–¹å¼ç»Ÿä¸€ï¼Œå‡å°‘å­¦ä¹ æˆæœ¬
- âœ… æ•°æ®åº“è¡¨æ•°é‡å‡å°‘ï¼Œå‡å°‘ç»´æŠ¤æˆæœ¬
- âœ… ä»£ç æ³¨é‡Šå’Œå®é™…è·¯å¾„ä¸€è‡´ï¼Œå‡å°‘ç†è§£æˆæœ¬

### åŠŸèƒ½å¯ç”¨æ€§æå‡

- âœ… ä¿®å¤æƒé™ç¼“å­˜åˆ·æ–°æ¥å£ä¸å¯è¾¾é—®é¢˜
- âœ… ç»Ÿä¸€å®¡è®¡è¯è¡¨ï¼Œæå‡æŸ¥è¯¢å’Œç»Ÿè®¡å‡†ç¡®æ€§
- âœ… æ˜ç¡®å…‘æ¢ç³»ç»Ÿå‘½åï¼Œå‡å°‘ä¸šåŠ¡æ··æ·†

---

## ğŸ” é™„å½•ï¼šå®Œæ•´è·¯ç”±æ¸…å•

### è®¤è¯æˆæƒåŸŸï¼ˆ/api/v4/authï¼‰

- `POST /api/v4/auth/login` - æ‰‹æœºå·å¯†ç ç™»å½•
- `POST /api/v4/auth/quick-login` - å¾®ä¿¡å¿«æ·ç™»å½•
- `POST /api/v4/auth/decrypt-phone` - è§£å¯†æ‰‹æœºå·
- `GET /api/v4/auth/verify` - éªŒè¯ Token
- `POST /api/v4/auth/refresh` - åˆ·æ–° Token âš ï¸ **å†²çª**
- `POST /api/v4/auth/logout` - é€€å‡ºç™»å½•
- `GET /api/v4/auth/profile` - è·å–ç”¨æˆ·ä¿¡æ¯
- `GET /api/v4/auth/permissions/me` - è·å–æˆ‘çš„æƒé™
- `POST /api/v4/auth/permissions/check` - æ£€æŸ¥æƒé™
- `POST /api/v4/auth/permissions/refresh` - åˆ·æ–°æƒé™ç¼“å­˜ âš ï¸ **è¢«é®è”½**
- `POST /api/v4/auth/permissions/batch-check` - æ‰¹é‡æ£€æŸ¥æƒé™
- `GET /api/v4/auth/permissions/admins` - è·å–ç®¡ç†å‘˜åˆ—è¡¨
- `GET /api/v4/auth/permissions/statistics` - æƒé™ç»Ÿè®¡

### èµ„äº§åŸŸï¼ˆ/api/v4/assetsï¼‰

- `GET /api/v4/assets/balance` - æŸ¥è¯¢å•ä¸ªèµ„äº§ä½™é¢
- `GET /api/v4/assets/balances` - æŸ¥è¯¢æ‰€æœ‰èµ„äº§ä½™é¢
- `GET /api/v4/assets/transactions` - æŸ¥è¯¢èµ„äº§æµæ°´

### èƒŒåŒ…åŸŸï¼ˆ/api/v4/backpackï¼‰

- `GET /api/v4/backpack` - æŸ¥è¯¢ç”¨æˆ·èƒŒåŒ…ï¼ˆèµ„äº§+ç‰©å“ï¼‰
- `GET /api/v4/backpack/assets` - æŸ¥è¯¢å¯å åŠ èµ„äº§
- `GET /api/v4/backpack/items` - æŸ¥è¯¢éå åŠ ç‰©å“
- `GET /api/v4/backpack/items/:item_instance_id` - æŸ¥è¯¢ç‰©å“è¯¦æƒ…
- `GET /api/v4/backpack/items/:item_instance_id/history` - æŸ¥è¯¢ç‰©å“å†å²

### å•†åŸåŸŸï¼ˆ/api/v4/shopï¼‰

- **å…‘æ¢å­åŸŸ**ï¼ˆ`/shop/exchange`ï¼‰ï¼š
  - `GET /api/v4/shop/exchange/items` - å•†å“åˆ—è¡¨
  - `GET /api/v4/shop/exchange/items/:item_id` - å•†å“è¯¦æƒ…
  - `POST /api/v4/shop/exchange/exchange` - å…‘æ¢å•†å“
  - `GET /api/v4/shop/exchange/orders` - è®¢å•åˆ—è¡¨
  - `GET /api/v4/shop/exchange/orders/:order_no` - è®¢å•è¯¦æƒ…
  - `POST /api/v4/shop/exchange/orders/:order_no/status` - æ›´æ–°è®¢å•çŠ¶æ€
  - `GET /api/v4/shop/exchange/statistics` - ç»Ÿè®¡æ•°æ®

- **æ ¸é”€å­åŸŸ**ï¼ˆ`/shop/redemption`ï¼‰ï¼š
  - `POST /api/v4/shop/redemption/orders` - ç”Ÿæˆæ ¸é”€è®¢å•
  - `POST /api/v4/shop/redemption/fulfill` - æ ¸é”€è®¢å•
  - `GET /api/v4/shop/redemption/orders/:order_id` - æŸ¥è¯¢è®¢å•è¯¦æƒ…
  - `POST /api/v4/shop/redemption/orders/:order_id/cancel` - å–æ¶ˆè®¢å•
  - `GET /api/v4/shop/redemption/items/:item_instance_id/order` - æŸ¥è¯¢ç‰©å“çš„æ ¸é”€è®¢å•

- **èµ„äº§è½¬æ¢å­åŸŸ**ï¼ˆ`/shop/assets`ï¼‰ï¼š
  - `POST /api/v4/shop/assets/convert` - ææ–™è½¬æ¢ï¼ˆç¢çº¢æ°´æ™¶â†’é’»çŸ³ï¼‰
  - `GET /api/v4/shop/assets/conversion-rules` - è½¬æ¢è§„åˆ™æŸ¥è¯¢

### å¸‚åœºåŸŸï¼ˆ/api/v4/marketï¼‰

- `GET /api/v4/market/listings` - æŒ‚ç‰Œåˆ—è¡¨
- `POST /api/v4/market/listings` - åˆ›å»ºæŒ‚ç‰Œ
- `GET /api/v4/market/listings/:listing_id` - æŒ‚ç‰Œè¯¦æƒ…
- `DELETE /api/v4/market/listings/:listing_id` - å–æ¶ˆæŒ‚ç‰Œ
- `POST /api/v4/market/buy` - è´­ä¹°æŒ‚ç‰Œ

### æŠ½å¥–åŸŸï¼ˆ/api/v4/lotteryï¼‰

- `GET /api/v4/lottery/prizes` - å¥–å“åˆ—è¡¨
- `POST /api/v4/lottery/draw` - æ‰§è¡ŒæŠ½å¥–
- `GET /api/v4/lottery/history` - æŠ½å¥–å†å²
- `GET /api/v4/lottery/points` - ç”¨æˆ·ç§¯åˆ†
- `GET /api/v4/lottery/presets` - æŠ½å¥–é¢„è®¾

### ç®¡ç†åå°ï¼ˆ/api/v4/consoleï¼‰

- **ç³»ç»Ÿç®¡ç†**ï¼ˆ`/console/system`ï¼‰
- **ç”¨æˆ·ç®¡ç†**ï¼ˆ`/console/users`ï¼‰
- **æŠ½å¥–ç®¡ç†**ï¼ˆ`/console/lottery`ï¼‰
- **èµ„äº§è°ƒæ•´**ï¼ˆ`/console/asset-adjustment`ï¼‰
- **ææ–™ç®¡ç†**ï¼ˆ`/console/material`ï¼‰
- **å®¢æœç®¡ç†**ï¼ˆ`/console/customer-service`ï¼‰
- **æ•°æ®åˆ†æ**ï¼ˆ`/console/analytics`ï¼‰

---

## ğŸ”„ æ•°æ®è¿ç§»ç­–ç•¥

### æ— éœ€è¿ç§»ï¼ˆç©ºè¡¨ç›´æ¥åˆ é™¤ï¼‰

- `audit_records`
- `role_change_logs`ï¼ˆè‹¥å†³å®šåºŸå¼ƒï¼‰
- `content_review_records`ï¼ˆè‹¥å†³å®šåºŸå¼ƒï¼‰
- `merchant_points_reviews`ï¼ˆè‹¥å†³å®šåºŸå¼ƒï¼‰

### éœ€è¦æ ‡è®°ï¼ˆå†å²æ•°æ®ä¿ç•™ï¼‰

- `trade_records`ï¼ˆ2 è¡Œï¼‰ï¼š
  ```sql
  ALTER TABLE trade_records ADD COLUMN is_legacy TINYINT(1) DEFAULT 0;
  UPDATE trade_records SET is_legacy = 1;
  ```

### éœ€è¦å¯¹è´¦ï¼ˆæ•°æ®ä¸ä¸€è‡´ï¼‰

- `asset_transactions` çš„ `exchange_debit`ï¼ˆ378 æ¡ï¼‰vs `exchange_records`ï¼ˆ0 æ¡ï¼‰ï¼š
  - è‹¥æ˜¯æµ‹è¯•æ•°æ®ï¼Œæ¸…ç† `asset_transactions`
  - è‹¥æ˜¯ bugï¼Œä¿®å¤ `ExchangeService` è®¢å•åˆ›å»ºé€»è¾‘

---

## ğŸ“ æ€»ç»“ä¸å»ºè®®

### æ ¸å¿ƒå‘ç°

1. âœ… **è·¯ç”±å†²çª**ï¼š`POST /api/v4/auth/refresh` è¢«æ³¨å†Œä¸¤æ¬¡ï¼Œæƒé™ç¼“å­˜åˆ·æ–°æ¥å£ä¸å¯è¾¾
2. âœ… **å®¡è®¡å…¥å£é‡å¤**ï¼š`AuditLogService` ä¸ `middleware/auditLog.js` åŒæ—¶å†™åŒä¸€å¼ è¡¨
3. âœ… **å®¡æ ¸ç³»ç»Ÿé‡å **ï¼šä¸‰å¥—å®¡æ ¸æœºåˆ¶å¹¶å­˜ï¼Œä½†åªæœ‰ä¸€å¥—åœ¨è·‘
4. âœ… **è§’è‰²å®¡è®¡é‡å¤**ï¼šä¸‰å¥—è§’è‰²å®¡è®¡å¹¶è¡Œï¼Œä½†åªæœ‰ä¸€å¥—åœ¨ç”¨
5. âœ… **äº¤æ˜“æµæ°´åŒè½¨**ï¼š`AssetTransaction` å·²æ˜¯ä¸»å¹²ï¼Œ`TradeRecord` æ®‹ç•™
6. âœ… **é—ç•™ç©ºè¡¨**ï¼š6 å¼ ç©ºè¡¨å ç”¨èµ„æº

### ä¼˜å…ˆçº§å»ºè®®

- **P0ï¼ˆç«‹å³ï¼‰**ï¼šä¿®å¤è·¯ç”±å†²çªï¼ˆ1-2 å¤©ï¼‰
- **P1ï¼ˆ1å‘¨å†…ï¼‰**ï¼šç»Ÿä¸€å®¡è®¡å®¡æ ¸æ¶æ„ï¼ˆ3-5 å¤©ï¼‰
- **P2ï¼ˆ2-3å‘¨ï¼‰**ï¼šæ¸…ç†æŠ€æœ¯å€ºåŠ¡ï¼ˆé•¿æœŸä¼˜åŒ–ï¼‰

### å…³é”®å†³ç­–ç‚¹

1. **å®¡æ ¸ç³»ç»Ÿæ¶æ„**ï¼šä¿ç•™ `ContentReviewRecord` è¿˜æ˜¯åºŸå¼ƒï¼Ÿ
2. **å•†æˆ·ç§¯åˆ†å®¡æ ¸**ï¼šå¯ç”¨ `MerchantPointsReview` è¿˜æ˜¯åºŸå¼ƒï¼Ÿ
3. **TradeRecord å®šä½**ï¼šé€€ä¸ºè¯»æ¨¡å‹è¿˜æ˜¯å®Œå…¨åºŸå¼ƒï¼Ÿ
4. **ç©ºè¡¨æ¸…ç†**ï¼šç«‹å³åˆ é™¤è¿˜æ˜¯è§‚å¯Ÿ 3 ä¸ªæœˆï¼Ÿ

### å®æ–½å»ºè®®

- ä¼˜å…ˆä¿®å¤ P0 é—®é¢˜ï¼ˆè·¯ç”±å†²çªï¼‰
- P1 é—®é¢˜éœ€è¦ä¸šåŠ¡æ–¹ç¡®è®¤éœ€æ±‚åå†æ‰§è¡Œ
- P2 é—®é¢˜å¯ä»¥é€æ­¥ä¼˜åŒ–ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2026å¹´01æœˆ08æ—¥  
**æ•°æ®åº“è¿æ¥**ï¼š`restaurant_points_dev`ï¼ˆçœŸå®åº“ï¼‰  
**ä»£ç ç‰ˆæœ¬**ï¼šå½“å‰å·¥ä½œåŒºæœ€æ–°ä»£ç   
**æ£€æŸ¥æ–¹æ³•**ï¼šä»£ç æ‰«æ + çœŸå®åº“æ•°æ®æŸ¥è¯¢ + ä¸šåŠ¡é€»è¾‘åˆ†æ
