# èƒŒåŒ…ç‰©å“"å¯å åŠ /ä¸å¯å åŠ "è®¾è®¡å£å¾„ - å¯¹é½æ‰§è¡Œæ–¹æ¡ˆ

> **ç›®æ ‡**ï¼šå°†å½“å‰é¡¹ç›®ä»£ç å®ç°å¯¹é½åˆ°ã€ŠèƒŒåŒ…ç‰©å“å åŠ ä¸éå åŠ è®¾è®¡è¯´æ˜.mdã€‹æ‹æ¿å£å¾„  
> **æ ¸å¿ƒå˜æ›´**ï¼š
>
> 1. ææ–™/ç¢ç‰‡/æ¬¡æ•°**ç»Ÿä¸€èµ° AssetService è´¦æœ¬èµ„äº§**ï¼ˆä¸å¼•å…¥ `inventory_balances` äºŒè½¨ï¼‰
> 2. å…‘æ¢ç **ç»Ÿä¸€ä¸º 12 ä½ Base32 + TTL 30 å¤© + æ•°æ®åº“åªå­˜ hash**ï¼ˆæŒ‚åœ¨å…‘æ¢è®¢å•ï¼‰
> 3. èƒŒåŒ…æ¥å£è¿”å› `assets[]`ï¼ˆè´¦æœ¬ä½™é¢ï¼‰+ `items[]`ï¼ˆå®ä¾‹ï¼‰ä¸¤å—æ•°æ®

---

## ğŸ“Š å½“å‰å®ç° vs ç›®æ ‡å£å¾„å¯¹ç…§è¡¨

| åŠŸèƒ½åŸŸ             | æ–‡æ¡£å£å¾„                    | å½“å‰å®ç°çŠ¶æ€                                                     | å·®è·                                                      |
| ------------------ | --------------------------- | ---------------------------------------------------------------- | --------------------------------------------------------- |
| **ææ–™/ç¢ç‰‡/æ¬¡æ•°** | èµ° AssetService è´¦æœ¬èµ„äº§    | âœ… éƒ¨åˆ†å·²èµ°è´¦æœ¬ï¼ˆ`AccountAssetBalance`/`AssetTransaction`ï¼‰      | âš ï¸ æ—§ä»£ç é‡Œè¿˜æœ‰ `UserInventory.item_type='material'` æ®‹ç•™ |
| **å®ç‰©é“å…·/æƒç›Š**  | èµ° `item_instances` å®ä¾‹è½¨  | âœ… å·²å»ºè¡¨å¹¶ç”¨äºäº¤æ˜“å¸‚åœº                                          | âš ï¸ èƒŒåŒ…æ ¸å¿ƒæŸ¥è¯¢ä»ä¸»è¦è¯» `UserInventory`                   |
| **èƒŒåŒ…æ¥å£**       | è¿”å› `assets[]` + `items[]` | âŒ å½“å‰è¿”å›å•ä¸€ `items[]`ï¼Œä¸”å…¨ä» `UserInventory` è¯»             | éœ€é‡æ„                                                    |
| **å…‘æ¢ç ç”Ÿæˆ**     | 12 ä½ Base32ï¼ŒTTL 30 å¤©     | âŒ æœ‰ 6 ä½æ•°å­—/5 åˆ†é’Ÿã€8 ä½ HEX/24 å°æ—¶ä¸¤å¥—å†²çªè§„åˆ™              | éœ€ç»Ÿä¸€                                                    |
| **å…‘æ¢ç å­˜å‚¨**     | åªå­˜ hashï¼ŒæŒ‚åœ¨å…‘æ¢è®¢å•     | âŒ `UserInventory.verification_code` å­˜æ˜æ–‡ï¼Œæ— å…‘æ¢è®¢å•è¡¨        | éœ€æ–°å»ºè¡¨+è¿ç§»                                             |
| **äº¤æ˜“å¸‚åœºå–æ•°é‡** | èµ°è´¦æœ¬å†»ç»“/ç»“ç®—             | âš ï¸ ç›®å‰èµ° `item_instances` + å¸‚åœºè®¢å•ï¼Œå†»ç»“é€»è¾‘åœ¨ `AssetService` | éœ€æ¢³ç†çŠ¶æ€æœº                                              |

---

## ğŸ¯ åˆ†é˜¶æ®µæ‰§è¡Œè·¯çº¿å›¾

### **Phase 0ï¼šå‡†å¤‡é˜¶æ®µï¼ˆ1-2 å¤©ï¼‰**

**ç›®æ ‡**ï¼šç¡®è®¤ç°çŠ¶ã€å†»ç»“éœ€æ±‚ã€å‡†å¤‡æµ‹è¯•æ•°æ®

| ä»»åŠ¡                | è´Ÿè´£äºº    | äº¤ä»˜ç‰©                    | éªŒæ”¶æ ‡å‡†                                 |
| ------------------- | --------- | ------------------------- | ---------------------------------------- |
| ğŸ“‹ å»ºç«‹è¿ç§»æµ‹è¯•ç¯å¢ƒ | åç«¯      | ç‹¬ç«‹æµ‹è¯•æ•°æ®åº“ + ç§å­æ•°æ® | åŒ…å«å„ç±»å‹é“å…·ã€ç”¨æˆ·ä½™é¢ã€æ—§æ ¸é”€ç è®°å½•   |
| ğŸ“‹ å†»ç»“ API å¥‘çº¦    | äº§å“/å‰ç«¯ | èƒŒåŒ…æ¥å£æ–°å¥‘çº¦æ–‡æ¡£        | æ˜ç¡® `assets[]` / `items[]` å­—æ®µç»“æ„     |
| ğŸ“‹ æ¢³ç†ä¾èµ–é“¾è·¯     | åç«¯      | ä¾èµ–å…³ç³»å›¾                | åˆ—å‡ºæ‰€æœ‰è¯»å†™ `UserInventory` çš„æœåŠ¡/æ¥å£ |
| ğŸ” ç¡®è®¤æ•°æ®å¤‡ä»½ç­–ç•¥ | è¿ç»´      | å¤‡ä»½è„šæœ¬ + å›æ»šé¢„æ¡ˆ       | èƒ½åœ¨ 30 åˆ†é’Ÿå†…å›æ»šç”Ÿäº§æ•°æ®               |

**é£é™©ç‚¹**ï¼š

- å¦‚æœç°æœ‰èƒŒåŒ…æ¥å£å¥‘çº¦ä¸æ˜ç¡®ï¼Œå‰åç«¯éœ€å…ˆå¯¹é½ï¼›å¦åˆ™ Phase 1 é‡æ„ä¼šåå¤è¿”å·¥

---

### **Phase 1ï¼šå…‘æ¢ç å£å¾„ç»Ÿä¸€ï¼ˆ3-5 å¤©ï¼ŒP0ï¼‰**

**ç›®æ ‡**ï¼šåºŸå¼ƒæ—§æ ¸é”€ç é€»è¾‘ï¼Œå…¨é¢åˆ‡æ¢åˆ° 12 ä½ Base32 + å…‘æ¢è®¢å•æ¨¡å‹

#### 1.1 æ•°æ®åº“å˜æ›´ï¼ˆ2 å¤©ï¼‰

| ä»»åŠ¡                        | æ–‡ä»¶/æ¨¡å—                                                                | å…³é”®ç‚¹                                                                                                                                                                                         |
| --------------------------- | ------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| åˆ›å»º `redemption_orders` è¡¨ | `migrations/YYYYMMDDHHMMSS-create-redemption-orders.js`                  | å­—æ®µï¼š`order_id`ï¼ˆUUIDï¼‰ã€`code_hash`ï¼ˆSHA-256ï¼‰ã€`item_instance_id`ã€`redeemer_id`ã€`status`ï¼ˆ`pending` / `fulfilled` / `cancelled` / `expired`ï¼‰ã€`expires_at`ã€`created_at`ã€`fulfilled_at` |
| åˆ›å»º Model                  | `models/RedemptionOrder.js`                                              | å…³è” `ItemInstance`ã€`User`ï¼›æ·»åŠ  `status` ç´¢å¼• + `code_hash` å”¯ä¸€ç´¢å¼•                                                                                                                         |
| `UserInventory` æ–°å¢å­—æ®µ    | `migrations/YYYYMMDDHHMMSS-add-redemption-order-id-to-user-inventory.js` | æ–°å¢ `redemption_order_id` å¤–é”®ï¼ˆå¯ä¸ºç©ºï¼Œç”¨äºè¿‡æ¸¡æœŸåŒå†™ï¼‰                                                                                                                                      |

#### 1.2 æ ¸é”€ç å·¥å…·ç±»é‡æ„ï¼ˆ1 å¤©ï¼‰

| ä»»åŠ¡         | æ–‡ä»¶                               | è¦ç‚¹                                                                         |
| ------------ | ---------------------------------- | ---------------------------------------------------------------------------- |
| ç»Ÿä¸€ç”Ÿæˆé€»è¾‘ | `utils/RedemptionCodeGenerator.js` | 12 ä½ Base32ï¼ˆå»é™¤æ˜“æ··æ·†å­—ç¬¦ `0OIL1`ï¼‰ï¼Œå†…ç½®ç¢°æ’é‡è¯•                         |
| ç»Ÿä¸€æ ¡éªŒé€»è¾‘ | `utils/RedemptionCodeValidator.js` | æ ¼å¼æ ¡éªŒ + hash è®¡ç®—ï¼Œ**ä¸å†å­˜æ˜æ–‡**                                         |
| åºŸå¼ƒæ—§å·¥å…·ç±» | `utils/QRCodeValidator.js`         | ä¿ç•™ä½†æ ‡è®° `@deprecated`ï¼Œ6 ä½/8 ä½åˆ†æ”¯å…¨éƒ¨æŠ›å‡º `UnsupportedCodeFormatError` |

#### 1.3 å…‘æ¢è®¢å•æœåŠ¡ï¼ˆ1-2 å¤©ï¼‰

| ä»»åŠ¡          | æ–‡ä»¶                                                                  | å…³é”®é€»è¾‘                                                                                                                                                                                   |
| ------------- | --------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| åˆ›å»ºå…‘æ¢è®¢å•  | `services/RedemptionOrderService.js#createOrder()`                    | ç”Ÿæˆ 12 ä½ç  â†’ è®¡ç®— hash â†’ æ’å…¥è®¢å•ï¼ˆ`expires_at = now + 30 å¤©`ï¼‰â†’ è¿”å›æ˜æ–‡ç ï¼ˆ**ä»…ä¸€æ¬¡**ï¼‰                                                                                                |
| æ ¸é”€è®¢å•      | `services/RedemptionOrderService.js#fulfillOrder()`                   | æ¥æ”¶æ˜æ–‡ç  â†’ è®¡ç®— hash â†’ æŸ¥ `code_hash` + `status='pending'` + `expires_at > now` â†’ CAS æ›´æ–° `status='fulfilled'`ã€`fulfilled_at`ã€`redeemer_id` â†’ å›è°ƒ `InventoryService.addItemToUser()` |
| æ’¤é”€/è¿‡æœŸå¤„ç† | `services/RedemptionOrderService.js#cancelOrder()` / `expireOrders()` | æ‰¹é‡æ‰«æ `expires_at < now` â†’ æ›´æ–° `status='expired'` â†’ å›æ»šåº“å­˜ï¼ˆè‹¥å·²æ‰£å‡ï¼‰                                                                                                               |
| å¹‚ç­‰ä¿æŠ¤      | åˆ©ç”¨ `Idempotency-Key` å¤´ + `code_hash` å”¯ä¸€ç´¢å¼•                      | æ ¸é”€å¤±è´¥è¿”å› `409 IDEMPOTENCY_KEY_CONFLICT`                                                                                                                                                |

#### 1.4 æ¥å£å±‚é€‚é…ï¼ˆ1 å¤©ï¼‰

| ä»»åŠ¡           | æ–‡ä»¶                                                                       | å˜æ›´ç‚¹                                                                       |
| -------------- | -------------------------------------------------------------------------- | ---------------------------------------------------------------------------- |
| ç”Ÿæˆå…‘æ¢ç æ¥å£ | `routes/v4/unified-engine/inventory-core.js#POST /items/:id/generate-code` | è°ƒç”¨ `RedemptionOrderService.createOrder()` â†’ è¿”å› `{ code, expires_at }`    |
| æ ¸é”€æ¥å£       | `routes/v4/unified-engine/inventory-core.js#POST /redeem`                  | è°ƒç”¨ `RedemptionOrderService.fulfillOrder()` â†’ è¿”å›æ–°å¢çš„ `item_instance_id` |
| æƒé™æ ¡éªŒ       | ä¸­é—´ä»¶ `requireRoleLevel(50)`                                              | ä»… `role_level >= 50` å¯ç”Ÿæˆç                                                |

**éªŒæ”¶æ ‡å‡†**ï¼š

- âœ… ç”Ÿæˆçš„ç æ ¼å¼å›ºå®š 12 ä½ Base32ï¼ˆå¦‚ `3K7J-2MQP-WXYZ`ï¼‰
- âœ… æ•°æ®åº“ `redemption_orders.code_hash` é•¿åº¦ 64ï¼ˆSHA-256 hexï¼‰
- âœ… é‡å¤æ ¸é”€è¿”å› `409`ï¼Œè¿‡æœŸæ ¸é”€è¿”å› `410 GONE`
- âœ… å®šæ—¶ä»»åŠ¡æ¯å°æ—¶æ‰«æå¹¶æ ‡è®°è¿‡æœŸè®¢å•ï¼ˆ`status='expired'`ï¼‰

**é£é™©ç‚¹**ï¼š

- æ—§ä»£ç è‹¥ç›´æ¥è¯» `UserInventory.verification_code` ä¼šå–åˆ° `NULL`ï¼›éœ€åœ¨ Phase 2 è¿ç§»å†å²æ•°æ®æˆ–å¢åŠ å…¼å®¹é€»è¾‘

---

### **Phase 2ï¼šèƒŒåŒ…æ¥å£é‡æ„ â€”â€” `assets[]` + `items[]` åŒè½¨è¿”å›ï¼ˆ5-7 å¤©ï¼ŒP0ï¼‰**

**ç›®æ ‡**ï¼šèƒŒåŒ…æŸ¥è¯¢æ¥å£ä¸å†ä¾èµ– `UserInventory`ï¼Œæ”¹ä¸ºèšåˆè´¦æœ¬èµ„äº§ + å®ä¾‹è½¨

#### 2.1 æ•°æ®æŸ¥è¯¢å±‚æ‹†åˆ†ï¼ˆ3 å¤©ï¼‰

| ä»»åŠ¡                 | æ–‡ä»¶                                                 | å®ç°é€»è¾‘                                                                                                                                                                                  |
| -------------------- | ---------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| æŸ¥è¯¢è´¦æœ¬èµ„äº§         | `services/AssetService.js#getUserAssets(user_id)`    | æŸ¥ `account_asset_balances` WHERE `user_id` + `balance > 0` â†’ è¿”å› `{ asset_id, quantity, frozen_quantity }[]`                                                                            |
| æŸ¥è¯¢å®ä¾‹é“å…·         | `services/InventoryService.js#getUserItems(user_id)` | æŸ¥ `item_instances` WHERE `owner_id` + `status NOT IN ('consumed', 'transferred', 'expired')` â†’ å…³è” `item_template_id` â†’ è¿”å› `{ instance_id, template_id, status, expires_at, meta }[]` |
| èšåˆåˆ†ç»„ï¼ˆå‰ç«¯å…³æ³¨ï¼‰ | `services/InventoryService.js#groupItems()`          | æŒ‰ `(template_id, status bucket, expires_at æŒ‰æ—¥, store/scope, meta_hash)` èšåˆ â†’ è¿”å› `{ group_key, instances[], count }[]`                                                              |

#### 2.2 æ¥å£å±‚é‡æ„ï¼ˆ2 å¤©ï¼‰

| ä»»åŠ¡         | æ–‡ä»¶                                                            | å˜æ›´ç‚¹                                                                                                     |
| ------------ | --------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------- |
| èƒŒåŒ…æ¦‚è§ˆæ¥å£ | `routes/v4/unified-engine/inventory.js#GET /backpack`           | å¹¶è¡Œè°ƒç”¨ `AssetService.getUserAssets()` + `InventoryService.getUserItems()` â†’ è¿”å› `{ assets[], items[] }` |
| èµ„äº§è¯¦æƒ…æ¥å£ | `routes/v4/unified-engine/assets.js#GET /assets/:asset_id`      | æŸ¥ `account_asset_balances` + æœ€è¿‘ 10 ç¬”æµæ°´ï¼ˆ`asset_transactions`ï¼‰                                       |
| é“å…·è¯¦æƒ…æ¥å£ | `routes/v4/unified-engine/inventory.js#GET /items/:instance_id` | æŸ¥ `item_instances` + å…³è” `redemption_orders`ï¼ˆè‹¥æœ‰æ ¸é”€ç ï¼‰                                               |

#### 2.3 å‰ç«¯é€‚é…ï¼ˆ2-3 å¤©ï¼‰

| ä»»åŠ¡          | è´Ÿè´£äºº    | å·¥ä½œå†…å®¹                                                              |
| ------------- | --------- | --------------------------------------------------------------------- |
| UI åˆ†åŒºæ¸²æŸ“   | å‰ç«¯      | `assets[]` æ”¾åœ¨é¡¶éƒ¨"è´§å¸/èµ„äº§"åˆ†ç»„ï¼Œ`items[]` æ”¾åœ¨ä¸‹æ–¹"é“å…·/æƒç›Š"åˆ†ç»„ |
| å›¾æ ‡/æ–‡æ¡ˆé€‚é… | äº§å“/å‰ç«¯ | åŒºåˆ†"ä½™é¢"ï¼ˆæ•°å­—+å•ä½ï¼‰vs"å®ä¾‹"ï¼ˆå¡ç‰‡+çŠ¶æ€ï¼‰                          |
| é”™è¯¯å¤„ç†      | å‰ç«¯      | å…¼å®¹éƒ¨åˆ†ç”¨æˆ· `assets[]` ä¸ºç©ºçš„æƒ…å†µ                                    |

**éªŒæ”¶æ ‡å‡†**ï¼š

- âœ… èƒŒåŒ…æ¥å£è¿”å›ç»“æ„ç¬¦åˆå¥‘çº¦ï¼ˆ`{ assets: [], items: [] }`ï¼‰
- âœ… é’»çŸ³/æ°´æ™¶/ææ–™/ç¢ç‰‡åªå‡ºç°åœ¨ `assets[]`ï¼Œä¸å‡ºç°åœ¨ `items[]`
- âœ… é“å…·/æƒç›Š/å¥–å“åªå‡ºç°åœ¨ `items[]`ï¼ˆstatus åŒ…å« `pending` / `active` / `locked` ç­‰ï¼‰
- âœ… æ€§èƒ½ï¼šå•æ¬¡æŸ¥è¯¢ < 200msï¼ˆ1000+ é“å…·ç”¨æˆ·ï¼‰

**é£é™©ç‚¹**ï¼š

- å‰ç«¯è‹¥ç¼“å­˜äº†æ—§æ•°æ®ç»“æ„ä¼šç™½å±ï¼›éœ€æå‰åšå…¼å®¹æˆ–å¼ºåˆ¶åˆ·æ–°

---

### **Phase 3ï¼š`UserInventory` å†å²æ•°æ®è¿ç§» + ä¸‹çº¿ï¼ˆ7-10 å¤©ï¼ŒP1ï¼‰**

**ç›®æ ‡**ï¼šå°†æ—§è¡¨æ•°æ®å®Œæ•´è¿ç§»åˆ°æ–°æ¨¡å‹ï¼Œé€æ­¥ä¸‹çº¿ `UserInventory` è¡¨

#### 3.1 è¿ç§»è„šæœ¬å‡çº§ï¼ˆ3 å¤©ï¼‰

| ä»»åŠ¡                 | æ–‡ä»¶                                                                             | é€»è¾‘                                                                                                                   |
| -------------------- | -------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------- |
| ææ–™/ç¢ç‰‡ â†’ è´¦æœ¬èµ„äº§ | `migrations/20251215220102-migrate-user-inventory-to-item-instances.js` æ–°å¢åˆ†æ”¯ | `item_type='material'` â†’ æ’å…¥ `account_asset_balances` + `asset_transactions`ï¼ˆ`type='migration'`ï¼‰                    |
| é“å…·/æƒç›Š â†’ å®ä¾‹è½¨   | åŸæœ‰é€»è¾‘                                                                         | `item_type='product'` â†’ æ’å…¥ `item_instances`ï¼ˆå·²å®ç°ï¼‰                                                                |
| æ ¸é”€ç  â†’ å…‘æ¢è®¢å•    | æ–°å¢è¿ç§»è„šæœ¬                                                                     | `verification_code IS NOT NULL` â†’ è®¡ç®— hash â†’ æ’å…¥ `redemption_orders`ï¼ˆ`status='fulfilled'`ï¼Œ`fulfilled_at=used_at`ï¼‰ |
| å¹‚ç­‰å¤„ç†             | æ‰€æœ‰è¿ç§»è„šæœ¬                                                                     | æ£€æŸ¥ `UserInventory.redemption_order_id` / `item_instances.id` æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤æ’å…¥                                |

#### 3.2 åŒå†™/åŒè¯»è¿‡æ¸¡ï¼ˆ2-3 å¤©ï¼‰

| ä»»åŠ¡             | ç­–ç•¥     | å®ç°                                                                                                    |
| ---------------- | -------- | ------------------------------------------------------------------------------------------------------- |
| å‘æ”¾é“å…·åŒå†™     | ç°åº¦æœŸ   | `InventoryService.addItemToUser()` â†’ å…ˆå†™ `item_instances`ï¼ŒæˆåŠŸåå†å†™ `UserInventory`ï¼ˆè½¯åˆ é™¤/ä¸å¯è§ï¼‰ |
| èƒŒåŒ…æŸ¥è¯¢åŒè¯»éªŒè¯ | ç°åº¦æœŸ   | åŒæ—¶æŸ¥æ–°æ—§æ¨¡å‹ï¼Œå¯¹æ¯”ç»“æœï¼Œè¾“å‡ºå·®å¼‚æ—¥å¿—ï¼ˆä¸é˜»å¡å“åº”ï¼‰                                                    |
| å¼€å…³æ§åˆ¶         | é…ç½®ä¸­å¿ƒ | `ENABLE_INVENTORY_DUAL_WRITE=true` / `ENABLE_INVENTORY_NEW_MODEL=true`                                  |

#### 3.3 æ—§è¡¨ä¸‹çº¿ï¼ˆ2-3 å¤©ï¼‰

| ä»»åŠ¡           | æ—¶æœº                | æ“ä½œ                                                        |
| -------------- | ------------------- | ----------------------------------------------------------- |
| ç§»é™¤æ—§è¡¨è¯»ä¾èµ– | åŒè¯»éªŒè¯é€šè¿‡å      | åˆ é™¤æ‰€æœ‰ `UserInventory.findAll()` è°ƒç”¨                     |
| ç§»é™¤æ—§è¡¨å†™ä¾èµ– | åŒå†™è¿è¡Œ 1 å‘¨æ— è¯¯å | åˆ é™¤åŒå†™é€»è¾‘ï¼Œåªä¿ç•™æ–°æ¨¡å‹                                  |
| è¡¨é‡å‘½å       | ä¸Šçº¿ 2 å‘¨å         | `RENAME TABLE user_inventory TO _deprecated_user_inventory` |
| æœ€ç»ˆåˆ é™¤       | ä¸Šçº¿ 1 æœˆå         | `DROP TABLE _deprecated_user_inventory`                     |

**éªŒæ”¶æ ‡å‡†**ï¼š

- âœ… 100% å†å²æ•°æ®å·²è¿ç§»ï¼ˆé€šè¿‡å¯¹è´¦è„šæœ¬éªŒè¯ï¼š`SUM(quantity)` / `COUNT(instance_id)` ä¸€è‡´ï¼‰
- âœ… ç°åº¦æœŸåŒè¯»å·®å¼‚ç‡ < 0.1%
- âœ… æ—§è¡¨ä¸‹çº¿åçº¿ä¸Šæ—  500 é”™è¯¯ã€æ— å›æ»š

**é£é™©ç‚¹**ï¼š

- è¿ç§»è„šæœ¬è‹¥è¯¯åˆ æ•°æ®éœ€ç«‹å³å›æ»šï¼›**å¿…é¡»åœ¨æµ‹è¯•ç¯å¢ƒå¤šæ¬¡æ¼”ç»ƒ**
- æ ¸é”€ç  hash è®¡ç®—é€»è¾‘è‹¥ä¸ç”Ÿæˆæ—¶ä¸ä¸€è‡´ï¼Œä¼šå¯¼è‡´å†å²ç æ— æ³•æ ¸é”€ï¼ˆéœ€äººå·¥è¡¥å¿ï¼‰

---

### **Phase 4ï¼šäº¤æ˜“å¸‚åœº"å–æ•°é‡"é“¾è·¯å¯¹é½ï¼ˆ5-7 å¤©ï¼ŒP1ï¼‰**

**ç›®æ ‡**ï¼šç¡®ä¿å–åŒè´¨èµ„äº§ï¼ˆè´¦æœ¬ä½™é¢ï¼‰èµ°å†»ç»“/ç»“ç®—æ¨¡å‹ï¼Œä¸æ–‡æ¡£å£å¾„ä¸€è‡´

#### 4.1 å¸‚åœºä¸Šæ¶é€»è¾‘ï¼ˆ2 å¤©ï¼‰

| ä»»åŠ¡               | æ–‡ä»¶                                                | å˜æ›´ç‚¹                                                                                                                         |
| ------------------ | --------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------ |
| åŒºåˆ†èµ„äº§ vs å®ä¾‹   | `services/ExchangeMarketService.js#createListing()` | åˆ¤æ–­ `asset_id IS NOT NULL` â†’ è°ƒç”¨ `AssetService.freeze(user_id, asset_id, quantity)` â†’ åˆ›å»ºè®¢å•æ—¶è®°å½• `frozen_transaction_id` |
| å®ä¾‹ä¸Šæ¶ï¼ˆåŸé€»è¾‘ï¼‰ | åŒä¸Š                                                | `item_instance_id IS NOT NULL` â†’ æ›´æ–° `item_instances.status='locked'` + `lock_until`                                          |

#### 4.2 æˆäº¤ç»“ç®—é€»è¾‘ï¼ˆ2 å¤©ï¼‰

| ä»»åŠ¡               | æ–‡ä»¶                                                 | é€»è¾‘                                                                               |
| ------------------ | ---------------------------------------------------- | ---------------------------------------------------------------------------------- |
| èµ„äº§æˆäº¤           | `services/ExchangeMarketService.js#fulfillListing()` | è°ƒç”¨ `AssetService.settle(frozen_transaction_id)` â†’ å–å®¶å‡ä½™é¢ï¼ˆè§£å†»ï¼‰ã€ä¹°å®¶åŠ ä½™é¢ |
| å®ä¾‹æˆäº¤ï¼ˆåŸé€»è¾‘ï¼‰ | åŒä¸Š                                                 | æ›´æ–° `item_instances.owner_id` + `status='active'`                                 |

#### 4.3 æ’¤é”€/è¿‡æœŸé€»è¾‘ï¼ˆ1 å¤©ï¼‰

| ä»»åŠ¡                   | æ–‡ä»¶                                                | é€»è¾‘                                                           |
| ---------------------- | --------------------------------------------------- | -------------------------------------------------------------- |
| èµ„äº§è®¢å•æ’¤é”€           | `services/ExchangeMarketService.js#cancelListing()` | è°ƒç”¨ `AssetService.unfreeze(frozen_transaction_id)` â†’ è§£å†»ä½™é¢ |
| å®ä¾‹è®¢å•æ’¤é”€ï¼ˆåŸé€»è¾‘ï¼‰ | åŒä¸Š                                                | æ›´æ–° `item_instances.status='active'` + `lock_until=NULL`      |

**éªŒæ”¶æ ‡å‡†**ï¼š

- âœ… ä¸Šæ¶ææ–™/ç¢ç‰‡åï¼Œ`account_asset_balances.frozen_quantity` å¢åŠ 
- âœ… æˆäº¤åï¼Œå–å®¶ `balance` å‡å°‘ã€ä¹°å®¶ `balance` å¢åŠ ï¼Œæµæ°´ç±»å‹ä¸º `market_settlement`
- âœ… æ’¤é”€åï¼Œ`frozen_quantity` å½’é›¶ï¼Œ`balance` æ¢å¤

**é£é™©ç‚¹**ï¼š

- è‹¥å†»ç»“/ç»“ç®—é€»è¾‘æœ‰å¹¶å‘ bugï¼Œå¯èƒ½å¯¼è‡´ä½™é¢ä¸ä¸€è‡´ï¼›éœ€åŠ è¡Œé”ï¼ˆ`FOR UPDATE`ï¼‰+ è¡¥å¿æœºåˆ¶

---

### **Phase 5ï¼šç›‘æ§ + è¡¥å¿æœºåˆ¶ï¼ˆ3-5 å¤©ï¼ŒP2ï¼‰**

**ç›®æ ‡**ï¼šå»ºç«‹æ•°æ®ä¸€è‡´æ€§ç›‘æ§ã€å¼‚å¸¸å‘Šè­¦ã€äººå·¥è¡¥å¿å·¥å…·

#### 5.1 å¯¹è´¦å®šæ—¶ä»»åŠ¡ï¼ˆ2 å¤©ï¼‰

| ä»»åŠ¡         | æ–‡ä»¶                               | é€»è¾‘                                                                                |
| ------------ | ---------------------------------- | ----------------------------------------------------------------------------------- |
| è´¦æœ¬èµ„äº§å¯¹è´¦ | `jobs/AssetReconciliation.js`      | æ¯æ—¥å¯¹æ¯” `account_asset_balances` vs `asset_transactions` èšåˆç»“æœï¼Œè¾“å‡ºå·®å¼‚æŠ¥å‘Š    |
| å®ä¾‹è½¨å¯¹è´¦   | `jobs/InventoryReconciliation.js`  | æ¯æ—¥ç»Ÿè®¡ `item_instances` å„çŠ¶æ€åˆ†å¸ƒï¼Œæ£€æµ‹å¼‚å¸¸ï¼ˆå¦‚å¤§é‡ `pending` è¶…è¿‡ 30 å¤©æœªæ¶ˆè´¹ï¼‰ |
| å…‘æ¢è®¢å•å¯¹è´¦ | `jobs/RedemptionReconciliation.js` | æ¯æ—¥æ‰«æ `expires_at < now - 7å¤©` ä¸” `status='pending'` çš„è®¢å•ï¼Œè‡ªåŠ¨æ ‡è®° `expired`  |

#### 5.2 å¼‚å¸¸å‘Šè­¦ï¼ˆ1 å¤©ï¼‰

| ç›‘æ§é¡¹       | é˜ˆå€¼                              | å‘Šè­¦æ¸ é“          |
| ------------ | --------------------------------- | ----------------- |
| ä½™é¢ä¸ä¸€è‡´ç‡ | > 0.1%                            | ä¼ä¸šå¾®ä¿¡ / é’‰é’‰   |
| æ ¸é”€å¤±è´¥ç‡   | > 5%                              | æ—¥å¿—å¹³å° + Sentry |
| è¿ç§»é—æ¼æ•°æ® | `UserInventory` ä»æœ‰ `migrated=0` | æ•°æ®åº“ç›‘æ§        |

#### 5.3 è¡¥å¿å·¥å…·ï¼ˆ2 å¤©ï¼‰

| å·¥å…·             | æ–‡ä»¶                                   | ç”¨é€”                 |
| ---------------- | -------------------------------------- | -------------------- |
| æ‰‹åŠ¨åˆ›å»ºå…‘æ¢è®¢å• | `scripts/create-redemption-order.js`   | çº¿ä¸Šç´§æ€¥è¡¥å‘æ ¸é”€ç    |
| é‡ç®—èµ„äº§ä½™é¢     | `scripts/recalculate-asset-balance.js` | ä¿®å¤ä½™é¢ä¸ä¸€è‡´é—®é¢˜   |
| æ‰¹é‡è¿ç§»è¡¥å¿     | `scripts/retry-failed-migration.js`    | é‡è·‘è¿ç§»è„šæœ¬å¤±è´¥è®°å½• |

**éªŒæ”¶æ ‡å‡†**ï¼š

- âœ… å¯¹è´¦ä»»åŠ¡æ¯æ—¥å‡Œæ™¨ 2 ç‚¹è‡ªåŠ¨è¿è¡Œï¼Œå‘ç°å·®å¼‚è‡ªåŠ¨å‘Šè­¦
- âœ… è¡¥å¿å·¥å…·æœ‰æ“ä½œæ—¥å¿—ï¼ˆ`admin_operations` è¡¨ï¼‰+ å®¡è®¡è®°å½•

---

## ğŸ“… æ•´ä½“æ—¶é—´çº¿ï¼ˆé¢„ä¼°ï¼‰

| é˜¶æ®µ                  | å·¥æœŸ    | ä¾èµ–    | å…³é”®äº§å‡º                                            |
| --------------------- | ------- | ------- | --------------------------------------------------- |
| **Phase 0ï¼šå‡†å¤‡**     | 1-2 å¤©  | æ—       | è¿ç§»ç¯å¢ƒ + API å¥‘çº¦ + ä¾èµ–å…³ç³»å›¾                    |
| **Phase 1ï¼šå…‘æ¢ç **   | 3-5 å¤©  | Phase 0 | `redemption_orders` è¡¨ + 12 ä½ Base32 ç»Ÿä¸€ç”Ÿæˆ/æ ¸é”€ |
| **Phase 2ï¼šèƒŒåŒ…æ¥å£** | 5-7 å¤©  | Phase 1 | èƒŒåŒ…æ¥å£è¿”å› `assets[]` + `items[]`                 |
| **Phase 3ï¼šè¿ç§»ä¸‹çº¿** | 7-10 å¤© | Phase 2 | å†å²æ•°æ®è¿ç§» + `UserInventory` ä¸‹çº¿                 |
| **Phase 4ï¼šå¸‚åœºå¯¹é½** | 5-7 å¤©  | Phase 3 | äº¤æ˜“å¸‚åœºèµ°è´¦æœ¬å†»ç»“/ç»“ç®—                             |
| **Phase 5ï¼šç›‘æ§è¡¥å¿** | 3-5 å¤©  | Phase 4 | å¯¹è´¦ä»»åŠ¡ + å‘Šè­¦ + è¡¥å¿å·¥å…·                          |

**æ€»å·¥æœŸ**ï¼š24-36 å¤©ï¼ˆçº¦ 1-1.5 æœˆï¼ŒæŒ‰ 1 äººå…¨èŒè®¡ç®—ï¼‰

**å¹¶è¡Œç­–ç•¥**ï¼š

- Phase 1 å’Œ Phase 2 å¯éƒ¨åˆ†å¹¶è¡Œï¼ˆå…‘æ¢ç æ¥å£ vs èƒŒåŒ…æŸ¥è¯¢æ¥å£äº’ä¸å¹²æ‰°ï¼‰
- Phase 4 å¯åœ¨ Phase 3 è¿ç§»å®Œæˆå‰æå‰å¼€å‘ï¼ˆä½†ä¸èƒ½ä¸Šçº¿ï¼‰

---

## ğŸš¨ é£é™©æ§åˆ¶ + åº”æ€¥é¢„æ¡ˆ

| é£é™©é¡¹                 | æ¦‚ç‡ | å½±å“ | åº”å¯¹ç­–ç•¥                                                             |
| ---------------------- | ---- | ---- | -------------------------------------------------------------------- |
| **è¿ç§»è„šæœ¬è¯¯åˆ æ•°æ®**   | ä¸­   | é«˜   | 1. æµ‹è¯•ç¯å¢ƒå¤šæ¬¡æ¼”ç»ƒï¼›2. ç”Ÿäº§è¿ç§»å‰å…¨é‡å¤‡ä»½ï¼›3. ç°åº¦ 10% ç”¨æˆ·å…ˆè¡ŒéªŒè¯ |
| **å‰ç«¯å…¼å®¹æ€§é—®é¢˜**     | é«˜   | ä¸­   | 1. åç«¯æ¥å£ä¿ç•™ `v3` æ—§æ ¼å¼å…¼å®¹å±‚ï¼›2. å‰ç«¯åˆ†ç‰ˆæœ¬ç°åº¦å‘å¸ƒ             |
| **æ ¸é”€ç  hash ä¸åŒ¹é…** | ä½   | é«˜   | 1. è¿ç§»æ—¶è®°å½•åŸå§‹æ˜æ–‡ç åˆ°ä¸´æ—¶è¡¨ï¼›2. æä¾›äººå·¥æ ¸å¯¹å·¥å…·                 |
| **æ€§èƒ½å›å½’**           | ä¸­   | ä¸­   | 1. å‹æµ‹ 10 ä¸‡ç”¨æˆ·èƒŒåŒ…æŸ¥è¯¢ï¼›2. æ·»åŠ  Redis ç¼“å­˜å±‚ï¼›3. æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–   |
| **è´¦æœ¬ä½™é¢ä¸ä¸€è‡´**     | ä½   | é«˜   | 1. äº‹åŠ¡ + è¡Œé”ä¿æŠ¤ï¼›2. æ¯æ—¥å¯¹è´¦ä»»åŠ¡ï¼›3. è¡¥å¿å·¥å…·å¿«é€Ÿä¿®å¤             |

**å›æ»šé¢„æ¡ˆ**ï¼š

- Phase 1/2ï¼šå¯å¿«é€Ÿå›æ»šä»£ç ï¼Œæ—§è¡¨æ•°æ®æœªå—å½±å“
- Phase 3ï¼šè‹¥å‘ç°ä¸¥é‡é—®é¢˜ï¼Œåœæ­¢è¿ç§»ï¼Œä¿ç•™ `UserInventory` è¡¨ç»§ç»­æœåŠ¡
- Phase 4/5ï¼šç‹¬ç«‹åŠŸèƒ½ï¼Œä¸å½±å“æ ¸å¿ƒé“¾è·¯

---

## âœ… éªŒæ”¶æ¸…å•ï¼ˆå…¨é˜¶æ®µï¼‰

- [ ] **å…‘æ¢ç **ï¼š100% é‡‡ç”¨ 12 ä½ Base32ï¼Œæ•°æ®åº“æ— æ˜æ–‡å­˜å‚¨ï¼ŒTTL å›ºå®š 30 å¤©
- [ ] **èƒŒåŒ…æ¥å£**ï¼š`assets[]` + `items[]` åŒè½¨è¿”å›ï¼Œæ€§èƒ½ < 200ms
- [ ] **æ•°æ®è¿ç§»**ï¼šæ—§è¡¨ 100% è¿ç§»ï¼Œå¯¹è´¦è„šæœ¬éªŒè¯é€šè¿‡
- [ ] **äº¤æ˜“å¸‚åœº**ï¼šå–èµ„äº§èµ°è´¦æœ¬å†»ç»“/ç»“ç®—ï¼Œè®¢å•çŠ¶æ€æœºå®Œæ•´
- [ ] **ç›‘æ§å‘Šè­¦**ï¼šå¯¹è´¦ä»»åŠ¡æ¯æ—¥è¿è¡Œï¼Œå¼‚å¸¸è‡ªåŠ¨å‘Šè­¦
- [ ] **æ–‡æ¡£**ï¼šAPI æ–‡æ¡£ã€æ•°æ®åº“ Schemaã€è¿ç§»æŒ‡å—æ›´æ–°å®Œæ¯•
- [ ] **æµ‹è¯•è¦†ç›–**ï¼šæ ¸å¿ƒé“¾è·¯å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%

---

## ğŸ“Œ åç»­ä¼˜åŒ–æ–¹å‘ï¼ˆéæœ¬æœŸèŒƒå›´ï¼‰

1. **Redis ç¼“å­˜**ï¼šèƒŒåŒ…æŸ¥è¯¢ç»“æœç¼“å­˜ 5 åˆ†é’Ÿï¼Œä½™é¢å˜åŠ¨ä¸»åŠ¨å¤±æ•ˆ
2. **åˆ†é¡µ/æ‡’åŠ è½½**ï¼š1000+ é“å…·ç”¨æˆ·æ”¯æŒåˆ†é¡µæŸ¥è¯¢
3. **å®æ—¶åŒæ­¥**ï¼šWebSocket æ¨é€ä½™é¢/é“å…·å˜åŠ¨äº‹ä»¶
4. **æ•°æ®å½’æ¡£**ï¼šå·²æ¶ˆè´¹/è¿‡æœŸå®ä¾‹è¿ç§»åˆ°å½’æ¡£è¡¨ï¼Œå‡å°‘ä¸»è¡¨å‹åŠ›

---

**æœ€ç»ˆç›®æ ‡**ï¼šä»£ç å®ç°ä¸ã€ŠèƒŒåŒ…ç‰©å“å åŠ ä¸éå åŠ è®¾è®¡è¯´æ˜.mdã€‹å£å¾„ 100% ä¸€è‡´ï¼Œä¸ºåç»­ä¸šåŠ¡æ‰©å±•ï¼ˆå¦‚äº¤æ˜“ç¨ã€ç§Ÿèµã€ç¢ç‰‡åˆæˆï¼‰æ‰“ä¸‹åšå®åŸºç¡€ã€‚
