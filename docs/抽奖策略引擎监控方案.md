# 抽奖策略引擎监控方案

> **文档版本**：v1.0  
> **创建时间**：2026-01-20  
> **技术架构**：Node.js + MySQL + Redis + Bootstrap 前端  
> **目标**：基于现有技术栈实现类似 Prometheus（数据采集）+ Grafana（可视化仪表盘）的监控效果

---

## 一、整体架构设计

```
┌─────────────────────────────────────────────────────────────────────┐
│                        监控数据流向                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐           │
│  │  抽奖引擎    │ ──> │  指标采集器  │ ──> │   MySQL     │           │
│  │  业务代码    │     │  (埋点)     │     │ (指标存储)   │           │
│  └─────────────┘     └─────────────┘     └─────────────┘           │
│                                                 │                   │
│                                                 ▼                   │
│                      ┌─────────────┐     ┌─────────────┐           │
│                      │  前端页面    │ <── │  统计 API   │           │
│                      │  (仪表盘)    │     │  (聚合查询)  │           │
│                      └─────────────┘     └─────────────┘           │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.1 核心组件

| 组件 | 技术选型 | 职责 |
|-----|---------|------|
| **数据采集** | 业务代码埋点 + 定时任务 | 收集抽奖过程中的各项指标 |
| **实时存储** | Redis | 存储实时计数器和短期数据 |
| **持久存储** | MySQL (lottery_hourly_metrics) | 存储历史聚合数据 |
| **数据聚合** | Node.js 定时任务 | 定时汇总 Redis 数据到 MySQL |
| **API 层** | Express 路由 | 提供统计数据查询接口 |
| **可视化** | Bootstrap + Chart.js | 前端仪表盘页面 |

---

## 二、数据采集层

### 2.1 采集时机

| 采集方式 | 说明 | 适用场景 |
|---------|------|---------|
| **实时埋点** | 每次抽奖结束时同步写入 | 关键指标（Budget Tier、Pity 触发） |
| **异步聚合** | 定时任务每小时聚合 | 汇总统计（小时级报表） |
| **按需计算** | API 请求时实时计算 | 低频查询、灵活维度 |

### 2.2 采集的指标清单

#### 2.2.1 流量指标

| 指标名 | 说明 | 数据类型 |
|-------|------|---------|
| `total_draws` | 总抽奖次数 | Counter |
| `unique_users` | 独立用户数 | Gauge |

#### 2.2.2 分层分布指标

| 指标名 | 说明 | 数据类型 |
|-------|------|---------|
| `budget_tier_b0_count` | B0 档（预算不足）次数 | Counter |
| `budget_tier_b1_count` | B1 档（低预算）次数 | Counter |
| `budget_tier_b2_count` | B2 档（中预算）次数 | Counter |
| `budget_tier_b3_count` | B3 档（高预算）次数 | Counter |
| `pressure_tier_p0_count` | P0 档（低压）次数 | Counter |
| `pressure_tier_p1_count` | P1 档（中压）次数 | Counter |
| `pressure_tier_p2_count` | P2 档（高压）次数 | Counter |

#### 2.2.3 体验指标

| 指标名 | 说明 | 数据类型 |
|-------|------|---------|
| `empty_prize_count` | 空奖次数 | Counter |
| `empty_rate` | 空奖率 | Gauge |
| `pity_soft_trigger_count` | Pity 软保底触发次数 | Counter |
| `pity_hard_trigger_count` | Pity 硬保底触发次数 | Counter |
| `anti_empty_trigger_count` | 反连空触发次数 | Counter |
| `anti_high_trigger_count` | 反连高触发次数 | Counter |
| `luck_debt_apply_count` | 运气债务补偿次数 | Counter |
| `avg_empty_streak` | 平均连续空奖次数 | Gauge |

#### 2.2.4 预算指标

| 指标名 | 说明 | 数据类型 |
|-------|------|---------|
| `total_budget_consumed` | 总预算消耗 | Counter |
| `avg_budget_per_draw` | 平均单次消耗 | Gauge |
| `pressure_index` | 活动压力指数 | Gauge |

### 2.3 埋点位置

| 位置 | Stage | 采集内容 |
|-----|-------|---------|
| 预算上下文计算后 | `BudgetContextStage` | budget_tier, pressure_tier, effective_budget |
| 档位选择后 | `TierPickStage` | pity_triggered, anti_empty_triggered, selected_tier |
| 结算完成后 | `SettleStage` | prize_value, is_empty, budget_consumed |
| 决策快照记录时 | `DecisionSnapshotStage` | 完整决策数据（已有） |

---

## 三、数据存储层

### 3.1 存储方案

#### 3.1.1 Redis 实时存储（短期数据）

**Key 设计规范**：

```
lottery:metrics:{campaign_id}:{metric_name}:{time_bucket}
```

**示例**：

| Redis Key | 说明 | 数据类型 |
|-----------|------|---------|
| `lottery:metrics:1:total_draws:2026012010` | 活动1在2026-01-20 10点的抽奖次数 | String (Counter) |
| `lottery:metrics:1:budget_tier:2026012010` | 活动1在2026-01-20 10点的 Tier 分布 | Hash |
| `lottery:metrics:1:unique_users:20260120` | 活动1在2026-01-20的独立用户 | Set |

**数据保留策略**：

| 数据类型 | 保留时间 | 说明 |
|---------|---------|------|
| 小时级计数器 | 48 小时 | 用于实时仪表盘 |
| 日级计数器 | 7 天 | 用于短期趋势 |
| 用户集合 | 24 小时 | 用于独立用户统计 |

#### 3.1.2 MySQL 持久存储（历史数据）

**复用现有表**：`lottery_hourly_metrics`

| 字段 | 类型 | 说明 |
|-----|------|------|
| `metric_id` | BIGINT | 主键 |
| `campaign_id` | INT | 活动 ID |
| `metric_hour` | DATETIME | 统计小时（整点） |
| `total_draws` | INT | 总抽奖次数 |
| `unique_users` | INT | 独立用户数 |
| `total_budget_consumed` | BIGINT | 总预算消耗 |
| `avg_budget_per_draw` | DECIMAL | 平均单次消耗 |
| `b0_count` | INT | B0 档次数 |
| `b1_count` | INT | B1 档次数 |
| `b2_count` | INT | B2 档次数 |
| `b3_count` | INT | B3 档次数 |
| `empty_rate` | DECIMAL | 空奖率 |
| `anti_empty_trigger_rate` | DECIMAL | 反连空触发率 |
| `avg_empty_streak` | DECIMAL | 平均连续空奖 |
| `created_at` | DATETIME | 创建时间 |

**数据保留策略**：

| 数据粒度 | 保留时间 | 存储位置 |
|---------|---------|---------|
| 小时级 | 90 天 | lottery_hourly_metrics |
| 日级 | 永久 | lottery_daily_metrics（可选新增） |

### 3.2 时序数据存储策略

```
┌─────────────────────────────────────────────────┐
│  数据粒度与保留策略                               │
├─────────────────────────────────────────────────┤
│                                                 │
│  实时数据（Redis）                               │
│  ├── 粒度：每次抽奖                              │
│  ├── 保留：24-48小时                            │
│  └── 用途：实时仪表盘、当前小时统计               │
│                                                 │
│  小时数据（lottery_hourly_metrics）              │
│  ├── 粒度：每小时聚合                            │
│  ├── 保留：90天                                 │
│  └── 用途：趋势图表、历史对比                     │
│                                                 │
│  日报数据（lottery_daily_metrics，可选）          │
│  ├── 粒度：每日聚合                              │
│  ├── 保留：永久                                 │
│  └── 用途：长期历史报表                          │
│                                                 │
└─────────────────────────────────────────────────┘
```

---

## 四、数据聚合任务

### 4.1 聚合任务清单

| 任务名 | 执行频率 | 数据源 | 写入目标 | 说明 |
|-------|---------|-------|---------|------|
| **实时计数器更新** | 每次抽奖 | 抽奖结果 | Redis | 同步写入，低延迟 |
| **小时聚合任务** | 每小时整点 | Redis | lottery_hourly_metrics | 汇总上一小时数据 |
| **日报聚合任务** | 每日凌晨 01:00 | lottery_hourly_metrics | lottery_daily_metrics | 汇总前一天数据 |
| **Redis 清理任务** | 每小时 | Redis | - | 清理过期 Key |

### 4.2 小时聚合任务流程

```
1. 获取上一小时的时间范围
2. 从 Redis 读取各项计数器
3. 计算派生指标（空奖率、触发率等）
4. 写入 lottery_hourly_metrics
5. 清理已聚合的 Redis 数据
```

### 4.3 定时任务配置

| 任务 | Cron 表达式 | 说明 |
|-----|------------|------|
| 小时聚合 | `0 5 * * * *` | 每小时第 5 分钟执行（等待数据落盘） |
| 日报聚合 | `0 0 1 * * *` | 每日凌晨 1 点执行 |
| Redis 清理 | `0 30 * * * *` | 每小时第 30 分钟执行 |

---

## 五、API 设计

### 5.1 接口清单

| 接口路径 | 方法 | 说明 |
|---------|------|------|
| `/api/v4/admin/lottery/strategy-stats/realtime` | GET | 实时概览数据 |
| `/api/v4/admin/lottery/strategy-stats/hourly` | GET | 小时趋势数据 |
| `/api/v4/admin/lottery/strategy-stats/daily` | GET | 日报趋势数据 |
| `/api/v4/admin/lottery/strategy-stats/tier-distribution` | GET | Budget Tier 分布 |
| `/api/v4/admin/lottery/strategy-stats/experience-triggers` | GET | 体验机制触发统计 |

### 5.2 接口详细设计

#### 5.2.1 实时概览

**请求**：

```
GET /api/v4/admin/lottery/strategy-stats/realtime?campaign_id=1
```

**响应**：

```json
{
  "success": true,
  "code": "SUCCESS",
  "data": {
    "today": {
      "total_draws": 12345,
      "unique_users": 2341,
      "empty_rate": 0.325,
      "total_budget_consumed": 456789,
      "avg_budget_per_draw": 37
    },
    "current_hour": {
      "total_draws": 456,
      "empty_rate": 0.312,
      "pressure_index": 0.85
    },
    "tier_distribution": {
      "B0": 0.15,
      "B1": 0.30,
      "B2": 0.35,
      "B3": 0.20
    },
    "experience_triggers": {
      "pity_soft_rate": 0.082,
      "pity_hard_rate": 0.012,
      "anti_empty_rate": 0.051,
      "luck_debt_rate": 0.034
    }
  },
  "timestamp": "2026-01-20T10:30:00.000+08:00"
}
```

#### 5.2.2 小时趋势

**请求**：

```
GET /api/v4/admin/lottery/strategy-stats/hourly?campaign_id=1&hours=24
```

**响应**：

```json
{
  "success": true,
  "code": "SUCCESS",
  "data": {
    "time_range": {
      "start": "2026-01-19T11:00:00+08:00",
      "end": "2026-01-20T10:00:00+08:00"
    },
    "metrics": [
      {
        "hour": "2026-01-19T11:00:00+08:00",
        "total_draws": 523,
        "empty_rate": 0.32,
        "avg_budget_per_draw": 35
      },
      {
        "hour": "2026-01-19T12:00:00+08:00",
        "total_draws": 612,
        "empty_rate": 0.28,
        "avg_budget_per_draw": 42
      }
      // ... 更多小时数据
    ]
  }
}
```

#### 5.2.3 分层分布

**请求**：

```
GET /api/v4/admin/lottery/strategy-stats/tier-distribution?campaign_id=1&date=2026-01-20
```

**响应**：

```json
{
  "success": true,
  "code": "SUCCESS",
  "data": {
    "budget_tier": {
      "B0": { "count": 1850, "percentage": 0.15 },
      "B1": { "count": 3700, "percentage": 0.30 },
      "B2": { "count": 4320, "percentage": 0.35 },
      "B3": { "count": 2475, "percentage": 0.20 }
    },
    "pressure_tier": {
      "P0": { "count": 4000, "percentage": 0.32 },
      "P1": { "count": 5500, "percentage": 0.45 },
      "P2": { "count": 2845, "percentage": 0.23 }
    },
    "matrix": {
      "B0_P0": 500,
      "B0_P1": 800,
      "B0_P2": 550,
      "B1_P0": 1200,
      "B1_P1": 1600,
      "B1_P2": 900
      // ... 更多组合
    }
  }
}
```

---

## 六、前端仪表盘设计

### 6.1 页面结构

```
public/admin/lottery-strategy-monitor.html
├── 顶部导航栏（与现有后台一致）
├── 活动选择器（下拉框）
├── 时间范围选择器
├── 实时概览卡片区
│   ├── 今日抽奖次数
│   ├── 空奖率
│   ├── Pity 触发率
│   └── 活动压力指数
├── 图表区
│   ├── Budget Tier 分布饼图
│   ├── 体验机制触发率柱状图
│   └── 空奖率趋势折线图
├── 数据表格区（可选）
│   └── 小时级明细数据
└── 页脚
```

### 6.2 图表库选择

推荐使用 **Chart.js**：

| 优点 | 说明 |
|-----|------|
| 轻量 | 压缩后约 70KB |
| 简单 | 上手容易，文档清晰 |
| 兼容 | 与 Bootstrap 配合良好 |
| 响应式 | 自动适配屏幕尺寸 |

备选：ECharts（功能更强大，但体积较大）

### 6.3 仪表盘布局示意

```
┌────────────────────────────────────────────────────────────────┐
│  📊 抽奖策略引擎监控仪表盘                          🔄 自动刷新  │
├────────────────────────────────────────────────────────────────┤
│  活动：[餐厅积分抽奖 ▼]    时间：[今日 ▼]    [刷新]            │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │
│  │ 今日抽奖  │ │  空奖率   │ │ Pity触发 │ │ 压力指数  │          │
│  │  12,345  │ │  32.5%   │ │  8.2%    │ │   0.85   │          │
│  │ ↑12.3%   │ │ ↓2.1%    │ │ ↑0.5%    │ │  正常    │          │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘          │
│                                                                │
│  ┌─────────────────────────┐ ┌─────────────────────────┐      │
│  │  Budget Tier 分布        │ │  体验机制触发率          │      │
│  │                         │ │                         │      │
│  │       ╭───╮             │ │  ████████ Pity 8.2%    │      │
│  │      ╱ B3 ╲             │ │  █████   反连空 5.1%   │      │
│  │     │ 20% │             │ │  ███     运气债 3.4%   │      │
│  │    ╱───────╲            │ │  ██      反连高 1.8%   │      │
│  │   │   B2    │           │ │                         │      │
│  │   │   35%   │           │ │                         │      │
│  │   ╰─────────╯           │ │                         │      │
│  │  B1:30%  B0:15%         │ │                         │      │
│  └─────────────────────────┘ └─────────────────────────┘      │
│                                                                │
│  ┌──────────────────────────────────────────────────────┐     │
│  │  空奖率趋势（24小时）                                   │     │
│  │                                                      │     │
│  │  40% ─                                               │     │
│  │  35% ─╮    ╭──╮                                      │     │
│  │  30% ─┼────╯  ╰──────────────────                    │     │
│  │  25% ─╯                                              │     │
│  │  20% ─                                               │     │
│  │       00  04  08  12  16  20  24                     │     │
│  └──────────────────────────────────────────────────────┘     │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 6.4 自动刷新机制

| 配置项 | 默认值 | 说明 |
|-------|-------|------|
| 刷新间隔 | 60 秒 | 实时数据自动刷新 |
| 手动刷新 | 按钮 | 用户可手动触发刷新 |
| 暂停刷新 | 开关 | 用户可暂停自动刷新 |

---

## 七、实现路径（分阶段）

### Phase 1：基础统计 API（0.5 天）

**目标**：提供基本的统计数据接口

**任务清单**：
- [ ] 创建 `services/LotteryStrategyStatsService.js`
- [ ] 实现 `getRealtimeStats()` 方法（从 lottery_draws 实时计算）
- [ ] 实现 `getHourlyStats()` 方法（从 lottery_hourly_metrics 查询）
- [ ] 创建 `routes/admin/lottery-strategy-stats.js` 路由
- [ ] 注册路由到 ServiceManager

### Phase 2：前端仪表盘页面（0.5 天）

**目标**：可视化展示统计数据

**任务清单**：
- [ ] 创建 `public/admin/lottery-strategy-monitor.html`
- [ ] 引入 Chart.js 库
- [ ] 实现概览卡片组件
- [ ] 实现 Budget Tier 分布饼图
- [ ] 实现体验机制触发率柱状图
- [ ] 添加页面到后台导航菜单

### Phase 3：Redis 实时计数器（1 天）

**目标**：实现低延迟的实时统计

**任务清单**：
- [ ] 创建 `services/LotteryMetricsCollector.js` 指标采集器
- [ ] 在 SettleStage 中添加埋点调用
- [ ] 实现 Redis 计数器写入逻辑
- [ ] 创建小时聚合定时任务
- [ ] 创建 Redis 清理定时任务
- [ ] 修改 API 优先从 Redis 读取实时数据

### Phase 4：完善图表和交互（0.5 天）

**目标**：提升用户体验

**任务清单**：
- [ ] 实现空奖率趋势折线图
- [ ] 添加自动刷新功能
- [ ] 添加时间范围选择器
- [ ] 添加活动切换下拉框
- [ ] 优化移动端响应式布局

---

## 八、与 Prometheus/Grafana 方案对比

| 对比维度 | Prometheus/Grafana | 本方案 |
|---------|-------------------|-------|
| **部署复杂度** | 需要额外部署 2 个服务 | 无需额外部署 |
| **学习成本** | 需要学习 PromQL 查询语言 | 使用熟悉的 SQL |
| **UI 一致性** | 独立的 Grafana UI | 集成在现有后台，风格统一 |
| **数据存储** | 专用时序数据库 | 复用 MySQL + Redis |
| **维护成本** | 需要维护额外服务 | 与主项目统一维护 |
| **扩展性** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| **功能完整度** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐（满足业务需求） |
| **适用场景** | 大规模分布式系统 | 中小型单体应用 |

---

## 九、注意事项

### 9.1 性能考虑

- **埋点开销**：使用异步写入 Redis，不阻塞主流程
- **查询优化**：API 优先查询 Redis，降低 MySQL 压力
- **索引优化**：确保 `lottery_hourly_metrics` 表有合适的索引

### 9.2 数据一致性

- **聚合延迟**：小时聚合有 5 分钟延迟，前端需提示
- **Redis 故障**：聚合任务应有重试机制和告警
- **数据校验**：可定期对比 Redis 和 MySQL 数据一致性

### 9.3 安全性

- **接口鉴权**：所有 API 需要管理员权限验证
- **数据脱敏**：不返回用户敏感信息
- **请求限流**：防止频繁刷新导致服务压力

---

## 十、参考资料

- [Chart.js 官方文档](https://www.chartjs.org/docs/)
- [Redis INCR 命令](https://redis.io/commands/incr/)
- [Node.js 定时任务 node-cron](https://www.npmjs.com/package/node-cron)
- 项目现有表：`lottery_hourly_metrics`、`lottery_draw_decisions`

---

**文档结束**

> **维护者**：后端开发团队  
> **最后更新**：2026-01-20

