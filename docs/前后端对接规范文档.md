# é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ V4.0 å‰åç«¯å¯¹æ¥è§„èŒƒæ–‡æ¡£

**æ–‡æ¡£ç‰ˆæœ¬**: v4.0.0  
**åˆ›å»ºæ—¶é—´**: 2025å¹´09æœˆ25æ—¥ 14:08 UTC (åŒ—äº¬æ—¶é—´ 22:08)  
**æŠ€æœ¯æ¶æ„**: V4ç»Ÿä¸€æŠ½å¥–å¼•æ“æ¶æ„  
**é€‚ç”¨åŒºåŸŸ**: ä¸­å›½ (ä½¿ç”¨åŒ—äº¬æ—¶é—´ Asia/Shanghai)

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
3. [ç¯å¢ƒé…ç½®](#ç¯å¢ƒé…ç½®)
4. [è®¤è¯ä½“ç³»](#è®¤è¯ä½“ç³»)
5. [APIæ¥å£è§„èŒƒ](#apiæ¥å£è§„èŒƒ)
6. [æ•°æ®æ¨¡å‹](#æ•°æ®æ¨¡å‹)
7. [å¯¹è±¡å­˜å‚¨](#å¯¹è±¡å­˜å‚¨)
8. [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
9. [å‰ç«¯é›†æˆæŒ‡å—](#å‰ç«¯é›†æˆæŒ‡å—)
10. [æµ‹è¯•éªŒè¯](#æµ‹è¯•éªŒè¯)

---

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

### é¡¹ç›®ä¿¡æ¯
- **é¡¹ç›®åç§°**: é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ
- **ç‰ˆæœ¬**: V4.0.0 ç»Ÿä¸€å¼•æ“æ¶æ„
- **æŠ€æœ¯æ ˆ**: Node.js 20+ + Express + V4ç»Ÿä¸€å¼•æ“ + MySQL + Sequelize + Redis
- **å­˜å‚¨æ–¹æ¡ˆ**: Sealoså¯¹è±¡å­˜å‚¨ + æœ¬åœ°ç¼“å­˜
- **è®¤è¯æ–¹å¼**: JWT Token + æ‰‹æœºå·éªŒè¯ç 
- **æ—¶åŒºæ ‡å‡†**: åŒ—äº¬æ—¶é—´ (UTC+8)

### æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
1. **V4ç»Ÿä¸€è®¤è¯å¼•æ“** - ç”¨æˆ·å’Œç®¡ç†å‘˜ç»Ÿä¸€è®¤è¯
2. **V4ç»Ÿä¸€æŠ½å¥–å¼•æ“** - æ”¯æŒåŸºç¡€/ä¿åº•/ç®¡ç†3ç§ç­–ç•¥
3. **V4ç»Ÿä¸€ç®¡ç†å¼•æ“** - ç³»ç»Ÿç®¡ç†å’Œç›‘æ§
4. **æƒé™ç®¡ç†ç³»ç»Ÿ** - åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶
5. **åº“å­˜ç®¡ç†ç³»ç»Ÿ** - ç”¨æˆ·ç‰©å“åº“å­˜ç®¡ç†
6. **å›¾ç‰‡ä¸Šä¼ ç³»ç»Ÿ** - é›†æˆSealoså¯¹è±¡å­˜å‚¨

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### åç«¯æ¶æ„
```
é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ V4.0
â”œâ”€â”€ åº”ç”¨å±‚ (Express.js)
â”‚   â”œâ”€â”€ V4ç»Ÿä¸€è®¤è¯å¼•æ“
â”‚   â”œâ”€â”€ V4ç»Ÿä¸€æŠ½å¥–å¼•æ“
â”‚   â”œâ”€â”€ V4ç»Ÿä¸€ç®¡ç†å¼•æ“
â”‚   â”œâ”€â”€ æƒé™ç®¡ç†ç³»ç»Ÿ
â”‚   â”œâ”€â”€ åº“å­˜ç®¡ç†ç³»ç»Ÿ
â”‚   â””â”€â”€ å›¾ç‰‡ä¸Šä¼ ç³»ç»Ÿ
â”œâ”€â”€ æœåŠ¡å±‚ (Services)
â”‚   â”œâ”€â”€ UnifiedLotteryEngine (V4æ ¸å¿ƒ)
â”‚   â”œâ”€â”€ SealosStorageService
â”‚   â”œâ”€â”€ ThumbnailService
â”‚   â””â”€â”€ è¾…åŠ©æœåŠ¡
â”œâ”€â”€ æ•°æ®å±‚ (MySQL + Sequelize)
â”‚   â”œâ”€â”€ ç”¨æˆ·æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ æŠ½å¥–æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ ç§¯åˆ†æ•°æ®æ¨¡å‹
â”‚   â””â”€â”€ ä¸šåŠ¡æ•°æ®æ¨¡å‹
â””â”€â”€ å­˜å‚¨å±‚
    â”œâ”€â”€ Sealoså¯¹è±¡å­˜å‚¨ (å›¾ç‰‡)
    â”œâ”€â”€ Redisç¼“å­˜
    â””â”€â”€ æœ¬åœ°ä¸´æ—¶å­˜å‚¨
```

### APIç‰ˆæœ¬ç®¡ç†
- **å½“å‰ç‰ˆæœ¬**: v4.0 (æ¨èä½¿ç”¨)
- **APIåŸºç¡€è·¯å¾„**: `/api/v4/`
- **ç‰ˆæœ¬æ§åˆ¶**: é€šè¿‡URLè·¯å¾„ç‰ˆæœ¬åŒ–

---

## âš™ï¸ ç¯å¢ƒé…ç½®

### å¿…éœ€ç¯å¢ƒå˜é‡
```bash
# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=restaurant_lottery
DB_TIMEZONE=+08:00

# åº”ç”¨é…ç½®
NODE_ENV=development
PORT=3000
JWT_SECRET=your_jwt_secret_here

# Sealoså¯¹è±¡å­˜å‚¨é…ç½®
SEALOS_ENDPOINT=https://objectstorageapi.bja.sealos.run
SEALOS_ACCESS_KEY=br0za7uc
SEALOS_SECRET_KEY=skxg8mk5gqfhf9xz
SEALOS_BUCKET=br0za7uc-tiangong
SEALOS_REGION=bja

# CORSé…ç½®
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8080

# Redisé…ç½® (å¯é€‰)
REDIS_URL=redis://localhost:6379
```

### æœåŠ¡å™¨éƒ¨ç½²è¦æ±‚
- **Node.jsç‰ˆæœ¬**: >= 20.18.0
- **npmç‰ˆæœ¬**: >= 8.0.0
- **MySQLç‰ˆæœ¬**: >= 8.0
- **Redisç‰ˆæœ¬**: >= 6.0 (å¯é€‰)
- **å†…å­˜è¦æ±‚**: >= 512MB
- **ç£ç›˜ç©ºé—´**: >= 1GB

---

## ğŸ” è®¤è¯ä½“ç³»

### è®¤è¯æ–¹å¼
1. **æ‰‹æœºå· + éªŒè¯ç ç™»å½•** (ä¸»è¦æ–¹å¼)
2. **JWT Tokenè®¤è¯** (APIè°ƒç”¨)
3. **å¼€å‘ç¯å¢ƒä¸‡èƒ½éªŒè¯ç **: `123456`

### JWT Tokenæ ¼å¼
```javascript
// TokenåŒ…å«ä¿¡æ¯
{
  "id": 123,           // ç”¨æˆ·ID
  "mobile": "13812345678", // æ‰‹æœºå·
  "is_admin": false,   // æ˜¯å¦ç®¡ç†å‘˜
  "iat": 1632123456,   // ç­¾å‘æ—¶é—´
  "exp": 1632209856    // è¿‡æœŸæ—¶é—´
}
```

### æƒé™ç­‰çº§
- **æ™®é€šç”¨æˆ·** (`is_admin: false`): åŸºç¡€åŠŸèƒ½æƒé™
- **ç®¡ç†å‘˜** (`is_admin: true`): å®Œæ•´ç®¡ç†æƒé™

### Tokenä½¿ç”¨æ–¹å¼
```javascript
// è¯·æ±‚å¤´æ ¼å¼
{
  "Authorization": "Bearer your_jwt_token_here",
  "Content-Type": "application/json"
}
```

---

## ğŸ“¡ APIæ¥å£è§„èŒƒ

### ç»Ÿä¸€å“åº”æ ¼å¼

#### æˆåŠŸå“åº”
```javascript
{
  "success": true,
  "code": "SUCCESS",
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    // å…·ä½“ä¸šåŠ¡æ•°æ®
  },
  "timestamp": "2025-09-25T14:08:31+08:00",
  "version": "v4.0"
}
```

#### é”™è¯¯å“åº”
```javascript
{
  "success": false,
  "code": "ERROR_CODE",
  "message": "é”™è¯¯æè¿°",
  "data": {
    // é”™è¯¯è¯¦æƒ…
  },
  "timestamp": "2025-09-25T14:08:31+08:00",
  "version": "v4.0"
}
```

#### åˆ†é¡µå“åº”
```javascript
{
  "success": true,
  "code": "PAGINATION_SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": [
    // æ•°æ®æ•°ç»„
  ],
  "pagination": {
    "total": 100,
    "page": 1,
    "limit": 20,
    "totalPages": 5,
    "hasNext": true,
    "hasPrev": false
  },
  "timestamp": "2025-09-25T14:08:31+08:00",
  "version": "v4.0"
}
```

### APIç«¯ç‚¹æ€»è§ˆ

#### 1. ç³»ç»Ÿä¿¡æ¯
| æ–¹æ³• | è·¯å¾„ | æè¿° | è®¤è¯ |
|------|------|------|------|
| GET | `/health` | å¥åº·æ£€æŸ¥ | å¦ |
| GET | `/api/v4` | V4å¼•æ“ä¿¡æ¯ | å¦ |
| GET | `/api/v4/docs` | APIæ–‡æ¡£ | å¦ |

#### 2. è®¤è¯ç³»ç»Ÿ (`/api/v4/unified-engine/auth`)
| æ–¹æ³• | è·¯å¾„ | æè¿° | è®¤è¯ |
|------|------|------|------|
| POST | `/login` | ç”¨æˆ·ç™»å½•/æ³¨å†Œ | å¦ |
| POST | `/logout` | ç”¨æˆ·ç™»å‡º | æ˜¯ |
| GET | `/verify` | TokenéªŒè¯ | æ˜¯ |
| POST | `/refresh` | åˆ·æ–°Token | æ˜¯ |

#### 3. æŠ½å¥–å¼•æ“ (`/api/v4/unified-engine/lottery`)
| æ–¹æ³• | è·¯å¾„ | æè¿° | è®¤è¯ |
|------|------|------|------|
| POST | `/basic` | åŸºç¡€æŠ½å¥– | æ˜¯ |
| POST | `/execute` | æ‰§è¡ŒæŠ½å¥– | æ˜¯ |
| GET | `/strategies` | è·å–ç­–ç•¥åˆ—è¡¨ | æ˜¯ |
| GET | `/metrics` | å¼•æ“æŒ‡æ ‡ | æ˜¯ |
| POST | `/validate` | éªŒè¯æŠ½å¥–æ¡ä»¶ | æ˜¯ |

#### 4. ç®¡ç†ç³»ç»Ÿ (`/api/v4/unified-engine/admin`)
| æ–¹æ³• | è·¯å¾„ | æè¿° | è®¤è¯ |
|------|------|------|------|
| GET | `/dashboard` | ç®¡ç†ä»ªè¡¨æ¿ | ç®¡ç†å‘˜ |
| POST | `/config` | æ›´æ–°å¼•æ“é…ç½® | ç®¡ç†å‘˜ |
| GET | `/logs` | è·å–æ‰§è¡Œæ—¥å¿— | ç®¡ç†å‘˜ |
| POST | `/maintenance` | ç»´æŠ¤æ¨¡å¼æ§åˆ¶ | ç®¡ç†å‘˜ |

#### 5. æƒé™ç®¡ç† (`/api/v4/permissions`)
| æ–¹æ³• | è·¯å¾„ | æè¿° | è®¤è¯ |
|------|------|------|------|
| GET | `/user/:userId` | è·å–ç”¨æˆ·æƒé™ | æ˜¯ |
| POST | `/check` | æ£€æŸ¥æƒé™ | æ˜¯ |
| POST | `/promote` | æå‡æƒé™ | ç®¡ç†å‘˜ |
| POST | `/create-admin` | åˆ›å»ºç®¡ç†å‘˜ | ç®¡ç†å‘˜ |
| GET | `/me` | è·å–æˆ‘çš„æƒé™ | æ˜¯ |

#### 6. åº“å­˜ç®¡ç† (`/api/v4/inventory`)
| æ–¹æ³• | è·¯å¾„ | æè¿° | è®¤è¯ |
|------|------|------|------|
| GET | `/list` | è·å–åº“å­˜åˆ—è¡¨ | æ˜¯ |
| POST | `/use` | ä½¿ç”¨ç‰©å“ | æ˜¯ |
| POST | `/transfer` | è½¬è®©ç‰©å“ | æ˜¯ |
| POST | `/generate-code` | ç”Ÿæˆæ ¸é”€ç  | æ˜¯ |

#### 7. å›¾ç‰‡ä¸Šä¼  (`/api/v4/photo`)
| æ–¹æ³• | è·¯å¾„ | æè¿° | è®¤è¯ |
|------|------|------|------|
| POST | `/upload` | ä¸Šä¼ å›¾ç‰‡ | æ˜¯ |
| DELETE | `/:id` | åˆ é™¤å›¾ç‰‡ | æ˜¯ |
| GET | `/list` | è·å–å›¾ç‰‡åˆ—è¡¨ | æ˜¯ |
| POST | `/approve` | å®¡æ ¸å›¾ç‰‡ | ç®¡ç†å‘˜ |

---

## ğŸ“Š æ•°æ®æ¨¡å‹

### æ ¸å¿ƒæ•°æ®æ¨¡å‹ç»“æ„

#### User (ç”¨æˆ·è¡¨)
```javascript
{
  id: 'INTEGER PRIMARY KEY',
  mobile: 'STRING(11) UNIQUE',
  nickname: 'STRING(50)',
  avatar: 'TEXT',
  is_admin: 'BOOLEAN DEFAULT false',
  status: 'ENUM(active, inactive, banned)',
  last_login: 'DATE',
  created_at: 'DATE',
  updated_at: 'DATE'
}
```

#### UserPointsAccount (ç”¨æˆ·ç§¯åˆ†è´¦æˆ·)
```javascript
{
  id: 'INTEGER PRIMARY KEY',
  user_id: 'INTEGER REFERENCES User(id)',
  balance: 'INTEGER DEFAULT 0',
  total_earned: 'INTEGER DEFAULT 0',
  total_spent: 'INTEGER DEFAULT 0',
  created_at: 'DATE',
  updated_at: 'DATE'
}
```

#### LotteryCampaign (æŠ½å¥–æ´»åŠ¨)
```javascript
{
  id: 'INTEGER PRIMARY KEY',
  title: 'STRING(100)',
  description: 'TEXT',
  status: 'ENUM(draft, active, paused, ended)',
  start_time: 'DATE',
  end_time: 'DATE',
  cost_points: 'INTEGER',
  created_at: 'DATE',
  updated_at: 'DATE'
}
```

#### LotteryDraw (æŠ½å¥–è®°å½•)
```javascript
{
  id: 'INTEGER PRIMARY KEY',
  user_id: 'INTEGER REFERENCES User(id)',
  campaign_id: 'INTEGER REFERENCES LotteryCampaign(id)',
  prize_id: 'INTEGER REFERENCES LotteryPrize(id)',
  strategy_type: 'STRING(50)',
  result_type: 'ENUM(prize, empty)',
  points_cost: 'INTEGER',
  draw_time: 'DATE',
  created_at: 'DATE'
}
```

#### UserInventory (ç”¨æˆ·åº“å­˜)
```javascript
{
  id: 'INTEGER PRIMARY KEY',
  user_id: 'INTEGER REFERENCES User(id)',
  prize_id: 'INTEGER REFERENCES LotteryPrize(id)',
  quantity: 'INTEGER DEFAULT 1',
  status: 'ENUM(available, used, transferred)',
  acquired_at: 'DATE',
  used_at: 'DATE',
  created_at: 'DATE',
  updated_at: 'DATE'
}
```

#### ImageResources (å›¾ç‰‡èµ„æº)
```javascript
{
  id: 'INTEGER PRIMARY KEY',
  user_id: 'INTEGER REFERENCES User(id)',
  filename: 'STRING(255)',
  original_name: 'STRING(255)',
  url: 'TEXT',
  thumbnail_url: 'TEXT',
  file_size: 'INTEGER',
  mime_type: 'STRING(50)',
  storage_type: 'ENUM(local, sealos)',
  business_type: 'STRING(50)',
  category: 'STRING(50)',
  review_status: 'ENUM(pending, approved, rejected)',
  created_at: 'DATE',
  updated_at: 'DATE'
}
```

---

## ğŸ—„ï¸ å¯¹è±¡å­˜å‚¨

### Sealoså­˜å‚¨é…ç½®
```javascript
// å­˜å‚¨é…ç½®
{
  endpoint: 'https://objectstorageapi.bja.sealos.run',
  bucket: 'br0za7uc-tiangong',
  region: 'bja',
  accessKeyId: 'br0za7uc',
  secretAccessKey: 'skxg8mk5gqfhf9xz'
}
```

### å­˜å‚¨ç›®å½•ç»“æ„
```
br0za7uc-tiangong/
â”œâ”€â”€ photos/           # ç”¨æˆ·ä¸Šä¼ çš„ç…§ç‰‡
â”œâ”€â”€ thumbnails/       # å›¾ç‰‡ç¼©ç•¥å›¾
â”œâ”€â”€ avatars/          # ç”¨æˆ·å¤´åƒ
â”œâ”€â”€ prizes/           # å¥–å“å›¾ç‰‡
â””â”€â”€ system/           # ç³»ç»Ÿå›¾ç‰‡
```

### å›¾ç‰‡ä¸Šä¼ æµç¨‹
1. **å‰ç«¯ä¸Šä¼ ** â†’ é€‰æ‹©å›¾ç‰‡æ–‡ä»¶
2. **åç«¯æ¥æ”¶** â†’ éªŒè¯æ–‡ä»¶ç±»å‹å’Œå¤§å°
3. **æœ¬åœ°å¤„ç†** â†’ ç”Ÿæˆç¼©ç•¥å›¾
4. **ä¸Šä¼ å­˜å‚¨** â†’ ä¸Šä¼ åˆ°Sealoså¯¹è±¡å­˜å‚¨
5. **æ•°æ®åº“è®°å½•** â†’ ä¿å­˜å›¾ç‰‡ä¿¡æ¯åˆ°ImageResourcesè¡¨
6. **è¿”å›ç»“æœ** â†’ è¿”å›å›¾ç‰‡URLç»™å‰ç«¯

### æ”¯æŒçš„å›¾ç‰‡æ ¼å¼
- **æ ¼å¼**: JPG, JPEG, PNG, GIF, WebP
- **å¤§å°é™åˆ¶**: æœ€å¤§10MB
- **ç¼©ç•¥å›¾**: è‡ªåŠ¨ç”Ÿæˆ150x150åƒç´ ç¼©ç•¥å›¾

---

## âŒ é”™è¯¯å¤„ç†

### é”™è¯¯ä»£ç è§„èŒƒ

#### ç³»ç»Ÿçº§é”™è¯¯ (1000-1999)
| ä»£ç  | è¯´æ˜ |
|------|------|
| SYSTEM_ERROR | ç³»ç»Ÿå†…éƒ¨é”™è¯¯ |
| DATABASE_ERROR | æ•°æ®åº“é”™è¯¯ |
| REDIS_ERROR | Redisè¿æ¥é”™è¯¯ |
| STORAGE_ERROR | å­˜å‚¨æœåŠ¡é”™è¯¯ |

#### è®¤è¯é”™è¯¯ (2000-2999)
| ä»£ç  | è¯´æ˜ |
|------|------|
| UNAUTHORIZED | æœªæˆæƒè®¿é—® |
| TOKEN_EXPIRED | Tokenå·²è¿‡æœŸ |
| TOKEN_INVALID | Tokenæ— æ•ˆ |
| INSUFFICIENT_PERMISSIONS | æƒé™ä¸è¶³ |
| VERIFICATION_CODE_ERROR | éªŒè¯ç é”™è¯¯ |

#### ä¸šåŠ¡é”™è¯¯ (3000-3999)
| ä»£ç  | è¯´æ˜ |
|------|------|
| INSUFFICIENT_POINTS | ç§¯åˆ†ä¸è¶³ |
| LOTTERY_NOT_AVAILABLE | æŠ½å¥–ä¸å¯ç”¨ |
| INVENTORY_NOT_FOUND | åº“å­˜ç‰©å“ä¸å­˜åœ¨ |
| FILE_UPLOAD_ERROR | æ–‡ä»¶ä¸Šä¼ å¤±è´¥ |
| INVALID_PARAMETERS | å‚æ•°æ— æ•ˆ |

#### è¯·æ±‚é”™è¯¯ (4000-4999)
| ä»£ç  | è¯´æ˜ |
|------|------|
| BAD_REQUEST | è¯·æ±‚æ ¼å¼é”™è¯¯ |
| NOT_FOUND | èµ„æºä¸å­˜åœ¨ |
| METHOD_NOT_ALLOWED | è¯·æ±‚æ–¹æ³•ä¸å…è®¸ |
| RATE_LIMIT_EXCEEDED | è¯·æ±‚é¢‘ç‡è¶…é™ |

### é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

#### å‰ç«¯é”™è¯¯å¤„ç†
```javascript
// ç»Ÿä¸€é”™è¯¯å¤„ç†å‡½æ•°
function handleApiError(error) {
  if (error.response && error.response.data) {
    const { code, message } = error.response.data;
    
    switch (code) {
      case 'TOKEN_EXPIRED':
        // è·³è½¬åˆ°ç™»å½•é¡µ
        redirectToLogin();
        break;
      case 'INSUFFICIENT_POINTS':
        // æ˜¾ç¤ºç§¯åˆ†ä¸è¶³æç¤º
        showPointsInsufficientDialog();
        break;
      case 'RATE_LIMIT_EXCEEDED':
        // æ˜¾ç¤ºè¯·æ±‚é¢‘ç‡é™åˆ¶æç¤º
        showRateLimitDialog();
        break;
      default:
        // æ˜¾ç¤ºé€šç”¨é”™è¯¯æç¤º
        showErrorMessage(message || 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  } else {
    // ç½‘ç»œé”™è¯¯æˆ–å…¶ä»–é”™è¯¯
    showErrorMessage('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®');
  }
}
```

---

## ğŸ¨ å‰ç«¯é›†æˆæŒ‡å—

### HTTPå®¢æˆ·ç«¯é…ç½®
```javascript
// axiosé…ç½®ç¤ºä¾‹
import axios from 'axios';

const apiClient = axios.create({
  baseURL: 'http://localhost:3000/api/v4',
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json'
  }
});

// è¯·æ±‚æ‹¦æˆªå™¨ - æ·»åŠ Token
apiClient.interceptors.request.use(config => {
  const token = localStorage.getItem('jwt_token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// å“åº”æ‹¦æˆªå™¨ - ç»Ÿä¸€é”™è¯¯å¤„ç†
apiClient.interceptors.response.use(
  response => response.data,
  error => {
    handleApiError(error);
    return Promise.reject(error);
  }
);
```

### APIè°ƒç”¨ç¤ºä¾‹

#### 1. ç”¨æˆ·ç™»å½•
```javascript
// ç™»å½•æ¥å£
async function login(mobile, verificationCode) {
  try {
    const response = await apiClient.post('/unified-engine/auth/login', {
      mobile,
      verification_code: verificationCode
    });
    
    if (response.success) {
      // ä¿å­˜Token
      localStorage.setItem('jwt_token', response.data.token);
      localStorage.setItem('user_info', JSON.stringify(response.data.user));
      return response.data;
    }
  } catch (error) {
    console.error('ç™»å½•å¤±è´¥:', error);
    throw error;
  }
}
```

#### 2. æ‰§è¡ŒæŠ½å¥–
```javascript
// åŸºç¡€æŠ½å¥–
async function performBasicLottery(campaignId) {
  try {
    const response = await apiClient.post('/unified-engine/lottery/basic', {
      campaign_id: campaignId,
      strategy_type: 'basic_guarantee'
    });
    
    if (response.success) {
      return response.data;
    }
  } catch (error) {
    console.error('æŠ½å¥–å¤±è´¥:', error);
    throw error;
  }
}
```

#### 3. è·å–ç”¨æˆ·åº“å­˜
```javascript
// è·å–åº“å­˜åˆ—è¡¨
async function getUserInventory(page = 1, limit = 20) {
  try {
    const response = await apiClient.get('/inventory/list', {
      params: { page, limit }
    });
    
    if (response.success) {
      return {
        items: response.data,
        pagination: response.pagination
      };
    }
  } catch (error) {
    console.error('è·å–åº“å­˜å¤±è´¥:', error);
    throw error;
  }
}
```

#### 4. ä¸Šä¼ å›¾ç‰‡
```javascript
// å›¾ç‰‡ä¸Šä¼ 
async function uploadPhoto(file, businessType = 'user_upload') {
  try {
    const formData = new FormData();
    formData.append('photo', file);
    formData.append('business_type', businessType);
    formData.append('user_id', getCurrentUserId());
    
    const response = await apiClient.post('/photo/upload', formData, {
      headers: {
        'Content-Type': 'multipart/form-data'
      }
    });
    
    if (response.success) {
      return response.data;
    }
  } catch (error) {
    console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
    throw error;
  }
}
```

### çŠ¶æ€ç®¡ç†å»ºè®®
```javascript
// Vuex/ReduxçŠ¶æ€ç®¡ç†ç¤ºä¾‹
const userModule = {
  state: {
    isAuthenticated: false,
    userInfo: null,
    token: null,
    permissions: []
  },
  
  mutations: {
    SET_AUTH(state, { token, user }) {
      state.isAuthenticated = true;
      state.token = token;
      state.userInfo = user;
      state.permissions = user.permissions || [];
    },
    
    CLEAR_AUTH(state) {
      state.isAuthenticated = false;
      state.token = null;
      state.userInfo = null;
      state.permissions = [];
    }
  },
  
  actions: {
    async login({ commit }, { mobile, verificationCode }) {
      const result = await login(mobile, verificationCode);
      commit('SET_AUTH', result);
      return result;
    },
    
    logout({ commit }) {
      localStorage.removeItem('jwt_token');
      localStorage.removeItem('user_info');
      commit('CLEAR_AUTH');
    }
  }
};
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### APIæµ‹è¯•å‘½ä»¤
```bash
# å¥åº·æ£€æŸ¥
curl -X GET http://localhost:3000/health

# ç”¨æˆ·ç™»å½• (å¼€å‘ç¯å¢ƒ)
curl -X POST http://localhost:3000/api/v4/unified-engine/auth/login \
  -H "Content-Type: application/json" \
  -d '{"mobile":"13812345678","verification_code":"123456"}'

# è·å–ç”¨æˆ·ä¿¡æ¯ (éœ€è¦Token)
curl -X GET http://localhost:3000/api/v4/unified-engine/auth/verify \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# æ‰§è¡ŒåŸºç¡€æŠ½å¥– (éœ€è¦Token)
curl -X POST http://localhost:3000/api/v4/unified-engine/lottery/basic \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"campaign_id":1,"strategy_type":"basic_guarantee"}'
```

### å‰ç«¯æµ‹è¯•æ¸…å•
- [ ] ç”¨æˆ·ç™»å½•/æ³¨å†ŒåŠŸèƒ½
- [ ] Tokenè‡ªåŠ¨åˆ·æ–°æœºåˆ¶
- [ ] æƒé™éªŒè¯å’Œè·¯ç”±å®ˆå«
- [ ] æŠ½å¥–åŠŸèƒ½å®Œæ•´æµç¨‹
- [ ] åº“å­˜ç®¡ç†åŠŸèƒ½
- [ ] å›¾ç‰‡ä¸Šä¼ å’Œæ˜¾ç¤º
- [ ] é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º
- [ ] å“åº”å¼è®¾è®¡é€‚é…

### æ€§èƒ½æµ‹è¯•æŒ‡æ ‡
- **APIå“åº”æ—¶é—´**: < 100ms
- **æ–‡ä»¶ä¸Šä¼ æ—¶é—´**: < 2s
- **å¹¶å‘ç”¨æˆ·æ•°**: 1000+
- **ç³»ç»Ÿå¯ç”¨æ€§**: > 99.95%

---

## ğŸ“ å¼€å‘æ³¨æ„äº‹é¡¹

### 1. æ—¶åŒºå¤„ç†
- **ç»Ÿä¸€ä½¿ç”¨åŒ—äº¬æ—¶é—´** (UTC+8)
- **APIæ—¶é—´æˆ³æ ¼å¼**: ISO 8601æ ¼å¼
- **å‰ç«¯æ˜¾ç¤º**: æ ¹æ®ç”¨æˆ·åå¥½æ˜¾ç¤ºæ—¶åŒº

### 2. æ•°æ®éªŒè¯
- **å‰ç«¯éªŒè¯**: ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- **åç«¯éªŒè¯**: æ•°æ®å®‰å…¨ä¿è¯
- **åŒé‡éªŒè¯**: ç¡®ä¿æ•°æ®å®Œæ•´æ€§

### 3. ç¼“å­˜ç­–ç•¥
- **Redisç¼“å­˜**: çƒ­ç‚¹æ•°æ®ç¼“å­˜
- **æµè§ˆå™¨ç¼“å­˜**: é™æ€èµ„æºç¼“å­˜
- **CDNç¼“å­˜**: å›¾ç‰‡èµ„æºåŠ é€Ÿ

### 4. å®‰å…¨è€ƒè™‘
- **è¾“å…¥éªŒè¯**: é˜²æ­¢SQLæ³¨å…¥å’ŒXSSæ”»å‡»
- **æƒé™æ£€æŸ¥**: ä¸¥æ ¼çš„æƒé™éªŒè¯æœºåˆ¶
- **è¯·æ±‚é™åˆ¶**: é˜²æ­¢æ¶æ„è¯·æ±‚å’ŒDDOSæ”»å‡»
- **HTTPS**: ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨HTTPS

### 5. ç›‘æ§å’Œæ—¥å¿—
- **APIç›‘æ§**: ç›‘æ§æ¥å£å“åº”æ—¶é—´å’ŒæˆåŠŸç‡
- **é”™è¯¯æ—¥å¿—**: è®°å½•ç³»ç»Ÿé”™è¯¯å’Œå¼‚å¸¸
- **ä¸šåŠ¡æ—¥å¿—**: è®°å½•å…³é”®ä¸šåŠ¡æ“ä½œ
- **æ€§èƒ½ç›‘æ§**: ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ

---

## ğŸ”„ ç‰ˆæœ¬æ›´æ–°è®°å½•

### v4.0.0 (2025-09-25)
- âœ… V4ç»Ÿä¸€å¼•æ“æ¶æ„å‘å¸ƒ
- âœ… ç»Ÿä¸€è®¤è¯ã€æŠ½å¥–ã€ç®¡ç†ä¸‰å¤§å¼•æ“
- âœ… Sealoså¯¹è±¡å­˜å‚¨é›†æˆ
- âœ… å®Œæ•´çš„æƒé™ç®¡ç†ç³»ç»Ÿ
- âœ… æ ‡å‡†åŒ–APIå“åº”æ ¼å¼
- âœ… åŒ—äº¬æ—¶é—´æ”¯æŒ
- âœ… å¼€å‘ç¯å¢ƒä¸‡èƒ½éªŒè¯ç 

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### å¼€å‘å›¢é˜Ÿè”ç³»æ–¹å¼
- **é¡¹ç›®ç»´æŠ¤**: Restaurant Lottery Team
- **æŠ€æœ¯æ¶æ„**: V4ç»Ÿä¸€å¼•æ“æ¶æ„
- **éƒ¨ç½²å¹³å°**: Sealosäº‘å¹³å°åŸç”Ÿæ”¯æŒ

### å¸¸è§é—®é¢˜è§£å†³
1. **Tokenè¿‡æœŸ**: å®ç°è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
2. **å›¾ç‰‡ä¸Šä¼ å¤±è´¥**: æ£€æŸ¥Sealoså­˜å‚¨é…ç½®
3. **æ•°æ®åº“è¿æ¥è¶…æ—¶**: ä¼˜åŒ–è¿æ¥æ± é…ç½®
4. **è·¨åŸŸé—®é¢˜**: é…ç½®æ­£ç¡®çš„CORSè®¾ç½®

---

**æ–‡æ¡£ç»“æŸ** - é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ V4.0 å‰åç«¯å¯¹æ¥è§„èŒƒæ–‡æ¡£ 