# 餐厅积分抽奖系统 V4.0 前后端对接规范文档

**文档版本**: v4.0.0  
**创建时间**: 2025年09月25日 14:08 UTC (北京时间 22:08)  
**技术架构**: V4统一抽奖引擎架构  
**适用区域**: 中国 (使用北京时间 Asia/Shanghai)

---

## 📋 目录

1. [系统概述](#系统概述)
2. [技术架构](#技术架构)
3. [环境配置](#环境配置)
4. [认证体系](#认证体系)
5. [API接口规范](#api接口规范)
6. [数据模型](#数据模型)
7. [对象存储](#对象存储)
8. [错误处理](#错误处理)
9. [前端集成指南](#前端集成指南)
10. [测试验证](#测试验证)

---

## 🎯 系统概述

### 项目信息
- **项目名称**: 餐厅积分抽奖系统
- **版本**: V4.0.0 统一引擎架构
- **技术栈**: Node.js 20+ + Express + V4统一引擎 + MySQL + Sequelize + Redis
- **存储方案**: Sealos对象存储 + 本地缓存
- **认证方式**: JWT Token + 手机号验证码
- **时区标准**: 北京时间 (UTC+8)

### 核心功能模块
1. **V4统一认证引擎** - 用户和管理员统一认证
2. **V4统一抽奖引擎** - 支持基础/保底/管理3种策略
3. **V4统一管理引擎** - 系统管理和监控
4. **权限管理系统** - 基于角色的权限控制
5. **库存管理系统** - 用户物品库存管理
6. **图片上传系统** - 集成Sealos对象存储

---

## 🏗️ 技术架构

### 后端架构
```
餐厅积分抽奖系统 V4.0
├── 应用层 (Express.js)
│   ├── V4统一认证引擎
│   ├── V4统一抽奖引擎
│   ├── V4统一管理引擎
│   ├── 权限管理系统
│   ├── 库存管理系统
│   └── 图片上传系统
├── 服务层 (Services)
│   ├── UnifiedLotteryEngine (V4核心)
│   ├── SealosStorageService
│   ├── ThumbnailService
│   └── 辅助服务
├── 数据层 (MySQL + Sequelize)
│   ├── 用户数据模型
│   ├── 抽奖数据模型
│   ├── 积分数据模型
│   └── 业务数据模型
└── 存储层
    ├── Sealos对象存储 (图片)
    ├── Redis缓存
    └── 本地临时存储
```

### API版本管理
- **当前版本**: v4.0 (推荐使用)
- **API基础路径**: `/api/v4/`
- **版本控制**: 通过URL路径版本化

---

## ⚙️ 环境配置

### 必需环境变量
```bash
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=restaurant_lottery
DB_TIMEZONE=+08:00

# 应用配置
NODE_ENV=development
PORT=3000
JWT_SECRET=your_jwt_secret_here

# Sealos对象存储配置
SEALOS_ENDPOINT=https://objectstorageapi.bja.sealos.run
SEALOS_ACCESS_KEY=br0za7uc
SEALOS_SECRET_KEY=skxg8mk5gqfhf9xz
SEALOS_BUCKET=br0za7uc-tiangong
SEALOS_REGION=bja

# CORS配置
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8080

# Redis配置 (可选)
REDIS_URL=redis://localhost:6379
```

### 服务器部署要求
- **Node.js版本**: >= 20.18.0
- **npm版本**: >= 8.0.0
- **MySQL版本**: >= 8.0
- **Redis版本**: >= 6.0 (可选)
- **内存要求**: >= 512MB
- **磁盘空间**: >= 1GB

---

## 🔐 认证体系

### 认证方式
1. **手机号 + 验证码登录** (主要方式)
2. **JWT Token认证** (API调用)
3. **开发环境万能验证码**: `123456`

### JWT Token格式
```javascript
// Token包含信息
{
  "id": 123,           // 用户ID
  "mobile": "13812345678", // 手机号
  "is_admin": false,   // 是否管理员
  "iat": 1632123456,   // 签发时间
  "exp": 1632209856    // 过期时间
}
```

### 权限等级
- **普通用户** (`is_admin: false`): 基础功能权限
- **管理员** (`is_admin: true`): 完整管理权限

### Token使用方式
```javascript
// 请求头格式
{
  "Authorization": "Bearer your_jwt_token_here",
  "Content-Type": "application/json"
}
```

---

## 📡 API接口规范

### 统一响应格式

#### 成功响应
```javascript
{
  "success": true,
  "code": "SUCCESS",
  "message": "操作成功",
  "data": {
    // 具体业务数据
  },
  "timestamp": "2025-09-25T14:08:31+08:00",
  "version": "v4.0"
}
```

#### 错误响应
```javascript
{
  "success": false,
  "code": "ERROR_CODE",
  "message": "错误描述",
  "data": {
    // 错误详情
  },
  "timestamp": "2025-09-25T14:08:31+08:00",
  "version": "v4.0"
}
```

#### 分页响应
```javascript
{
  "success": true,
  "code": "PAGINATION_SUCCESS",
  "message": "获取成功",
  "data": [
    // 数据数组
  ],
  "pagination": {
    "total": 100,
    "page": 1,
    "limit": 20,
    "totalPages": 5,
    "hasNext": true,
    "hasPrev": false
  },
  "timestamp": "2025-09-25T14:08:31+08:00",
  "version": "v4.0"
}
```

### API端点总览

#### 1. 系统信息
| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| GET | `/health` | 健康检查 | 否 |
| GET | `/api/v4` | V4引擎信息 | 否 |
| GET | `/api/v4/docs` | API文档 | 否 |

#### 2. 认证系统 (`/api/v4/unified-engine/auth`)
| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| POST | `/login` | 用户登录/注册 | 否 |
| POST | `/logout` | 用户登出 | 是 |
| GET | `/verify` | Token验证 | 是 |
| POST | `/refresh` | 刷新Token | 是 |

#### 3. 抽奖引擎 (`/api/v4/unified-engine/lottery`)
| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| POST | `/basic` | 基础抽奖 | 是 |
| POST | `/execute` | 执行抽奖 | 是 |
| GET | `/strategies` | 获取策略列表 | 是 |
| GET | `/metrics` | 引擎指标 | 是 |
| POST | `/validate` | 验证抽奖条件 | 是 |

#### 4. 管理系统 (`/api/v4/unified-engine/admin`)
| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| GET | `/dashboard` | 管理仪表板 | 管理员 |
| POST | `/config` | 更新引擎配置 | 管理员 |
| GET | `/logs` | 获取执行日志 | 管理员 |
| POST | `/maintenance` | 维护模式控制 | 管理员 |

#### 5. 权限管理 (`/api/v4/permissions`)
| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| GET | `/user/:userId` | 获取用户权限 | 是 |
| POST | `/check` | 检查权限 | 是 |
| POST | `/promote` | 提升权限 | 管理员 |
| POST | `/create-admin` | 创建管理员 | 管理员 |
| GET | `/me` | 获取我的权限 | 是 |

#### 6. 库存管理 (`/api/v4/inventory`)
| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| GET | `/list` | 获取库存列表 | 是 |
| POST | `/use` | 使用物品 | 是 |
| POST | `/transfer` | 转让物品 | 是 |
| POST | `/generate-code` | 生成核销码 | 是 |

#### 7. 图片上传 (`/api/v4/photo`)
| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| POST | `/upload` | 上传图片 | 是 |
| DELETE | `/:id` | 删除图片 | 是 |
| GET | `/list` | 获取图片列表 | 是 |
| POST | `/approve` | 审核图片 | 管理员 |

---

## 📊 数据模型

### 核心数据模型结构

#### User (用户表)
```javascript
{
  id: 'INTEGER PRIMARY KEY',
  mobile: 'STRING(11) UNIQUE',
  nickname: 'STRING(50)',
  avatar: 'TEXT',
  is_admin: 'BOOLEAN DEFAULT false',
  status: 'ENUM(active, inactive, banned)',
  last_login: 'DATE',
  created_at: 'DATE',
  updated_at: 'DATE'
}
```

#### UserPointsAccount (用户积分账户)
```javascript
{
  id: 'INTEGER PRIMARY KEY',
  user_id: 'INTEGER REFERENCES User(id)',
  balance: 'INTEGER DEFAULT 0',
  total_earned: 'INTEGER DEFAULT 0',
  total_spent: 'INTEGER DEFAULT 0',
  created_at: 'DATE',
  updated_at: 'DATE'
}
```

#### LotteryCampaign (抽奖活动)
```javascript
{
  id: 'INTEGER PRIMARY KEY',
  title: 'STRING(100)',
  description: 'TEXT',
  status: 'ENUM(draft, active, paused, ended)',
  start_time: 'DATE',
  end_time: 'DATE',
  cost_points: 'INTEGER',
  created_at: 'DATE',
  updated_at: 'DATE'
}
```

#### LotteryDraw (抽奖记录)
```javascript
{
  id: 'INTEGER PRIMARY KEY',
  user_id: 'INTEGER REFERENCES User(id)',
  campaign_id: 'INTEGER REFERENCES LotteryCampaign(id)',
  prize_id: 'INTEGER REFERENCES LotteryPrize(id)',
  strategy_type: 'STRING(50)',
  result_type: 'ENUM(prize, empty)',
  points_cost: 'INTEGER',
  draw_time: 'DATE',
  created_at: 'DATE'
}
```

#### UserInventory (用户库存)
```javascript
{
  id: 'INTEGER PRIMARY KEY',
  user_id: 'INTEGER REFERENCES User(id)',
  prize_id: 'INTEGER REFERENCES LotteryPrize(id)',
  quantity: 'INTEGER DEFAULT 1',
  status: 'ENUM(available, used, transferred)',
  acquired_at: 'DATE',
  used_at: 'DATE',
  created_at: 'DATE',
  updated_at: 'DATE'
}
```

#### ImageResources (图片资源)
```javascript
{
  id: 'INTEGER PRIMARY KEY',
  user_id: 'INTEGER REFERENCES User(id)',
  filename: 'STRING(255)',
  original_name: 'STRING(255)',
  url: 'TEXT',
  thumbnail_url: 'TEXT',
  file_size: 'INTEGER',
  mime_type: 'STRING(50)',
  storage_type: 'ENUM(local, sealos)',
  business_type: 'STRING(50)',
  category: 'STRING(50)',
  review_status: 'ENUM(pending, approved, rejected)',
  created_at: 'DATE',
  updated_at: 'DATE'
}
```

---

## 🗄️ 对象存储

### Sealos存储配置
```javascript
// 存储配置
{
  endpoint: 'https://objectstorageapi.bja.sealos.run',
  bucket: 'br0za7uc-tiangong',
  region: 'bja',
  accessKeyId: 'br0za7uc',
  secretAccessKey: 'skxg8mk5gqfhf9xz'
}
```

### 存储目录结构
```
br0za7uc-tiangong/
├── photos/           # 用户上传的照片
├── thumbnails/       # 图片缩略图
├── avatars/          # 用户头像
├── prizes/           # 奖品图片
└── system/           # 系统图片
```

### 图片上传流程
1. **前端上传** → 选择图片文件
2. **后端接收** → 验证文件类型和大小
3. **本地处理** → 生成缩略图
4. **上传存储** → 上传到Sealos对象存储
5. **数据库记录** → 保存图片信息到ImageResources表
6. **返回结果** → 返回图片URL给前端

### 支持的图片格式
- **格式**: JPG, JPEG, PNG, GIF, WebP
- **大小限制**: 最大10MB
- **缩略图**: 自动生成150x150像素缩略图

---

## ❌ 错误处理

### 错误代码规范

#### 系统级错误 (1000-1999)
| 代码 | 说明 |
|------|------|
| SYSTEM_ERROR | 系统内部错误 |
| DATABASE_ERROR | 数据库错误 |
| REDIS_ERROR | Redis连接错误 |
| STORAGE_ERROR | 存储服务错误 |

#### 认证错误 (2000-2999)
| 代码 | 说明 |
|------|------|
| UNAUTHORIZED | 未授权访问 |
| TOKEN_EXPIRED | Token已过期 |
| TOKEN_INVALID | Token无效 |
| INSUFFICIENT_PERMISSIONS | 权限不足 |
| VERIFICATION_CODE_ERROR | 验证码错误 |

#### 业务错误 (3000-3999)
| 代码 | 说明 |
|------|------|
| INSUFFICIENT_POINTS | 积分不足 |
| LOTTERY_NOT_AVAILABLE | 抽奖不可用 |
| INVENTORY_NOT_FOUND | 库存物品不存在 |
| FILE_UPLOAD_ERROR | 文件上传失败 |
| INVALID_PARAMETERS | 参数无效 |

#### 请求错误 (4000-4999)
| 代码 | 说明 |
|------|------|
| BAD_REQUEST | 请求格式错误 |
| NOT_FOUND | 资源不存在 |
| METHOD_NOT_ALLOWED | 请求方法不允许 |
| RATE_LIMIT_EXCEEDED | 请求频率超限 |

### 错误处理最佳实践

#### 前端错误处理
```javascript
// 统一错误处理函数
function handleApiError(error) {
  if (error.response && error.response.data) {
    const { code, message } = error.response.data;
    
    switch (code) {
      case 'TOKEN_EXPIRED':
        // 跳转到登录页
        redirectToLogin();
        break;
      case 'INSUFFICIENT_POINTS':
        // 显示积分不足提示
        showPointsInsufficientDialog();
        break;
      case 'RATE_LIMIT_EXCEEDED':
        // 显示请求频率限制提示
        showRateLimitDialog();
        break;
      default:
        // 显示通用错误提示
        showErrorMessage(message || '操作失败，请重试');
    }
  } else {
    // 网络错误或其他错误
    showErrorMessage('网络连接失败，请检查网络设置');
  }
}
```

---

## 🎨 前端集成指南

### HTTP客户端配置
```javascript
// axios配置示例
import axios from 'axios';

const apiClient = axios.create({
  baseURL: 'http://localhost:3000/api/v4',
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json'
  }
});

// 请求拦截器 - 添加Token
apiClient.interceptors.request.use(config => {
  const token = localStorage.getItem('jwt_token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// 响应拦截器 - 统一错误处理
apiClient.interceptors.response.use(
  response => response.data,
  error => {
    handleApiError(error);
    return Promise.reject(error);
  }
);
```

### API调用示例

#### 1. 用户登录
```javascript
// 登录接口
async function login(mobile, verificationCode) {
  try {
    const response = await apiClient.post('/unified-engine/auth/login', {
      mobile,
      verification_code: verificationCode
    });
    
    if (response.success) {
      // 保存Token
      localStorage.setItem('jwt_token', response.data.token);
      localStorage.setItem('user_info', JSON.stringify(response.data.user));
      return response.data;
    }
  } catch (error) {
    console.error('登录失败:', error);
    throw error;
  }
}
```

#### 2. 执行抽奖
```javascript
// 基础抽奖
async function performBasicLottery(campaignId) {
  try {
    const response = await apiClient.post('/unified-engine/lottery/basic', {
      campaign_id: campaignId,
      strategy_type: 'basic_guarantee'
    });
    
    if (response.success) {
      return response.data;
    }
  } catch (error) {
    console.error('抽奖失败:', error);
    throw error;
  }
}
```

#### 3. 获取用户库存
```javascript
// 获取库存列表
async function getUserInventory(page = 1, limit = 20) {
  try {
    const response = await apiClient.get('/inventory/list', {
      params: { page, limit }
    });
    
    if (response.success) {
      return {
        items: response.data,
        pagination: response.pagination
      };
    }
  } catch (error) {
    console.error('获取库存失败:', error);
    throw error;
  }
}
```

#### 4. 上传图片
```javascript
// 图片上传
async function uploadPhoto(file, businessType = 'user_upload') {
  try {
    const formData = new FormData();
    formData.append('photo', file);
    formData.append('business_type', businessType);
    formData.append('user_id', getCurrentUserId());
    
    const response = await apiClient.post('/photo/upload', formData, {
      headers: {
        'Content-Type': 'multipart/form-data'
      }
    });
    
    if (response.success) {
      return response.data;
    }
  } catch (error) {
    console.error('图片上传失败:', error);
    throw error;
  }
}
```

### 状态管理建议
```javascript
// Vuex/Redux状态管理示例
const userModule = {
  state: {
    isAuthenticated: false,
    userInfo: null,
    token: null,
    permissions: []
  },
  
  mutations: {
    SET_AUTH(state, { token, user }) {
      state.isAuthenticated = true;
      state.token = token;
      state.userInfo = user;
      state.permissions = user.permissions || [];
    },
    
    CLEAR_AUTH(state) {
      state.isAuthenticated = false;
      state.token = null;
      state.userInfo = null;
      state.permissions = [];
    }
  },
  
  actions: {
    async login({ commit }, { mobile, verificationCode }) {
      const result = await login(mobile, verificationCode);
      commit('SET_AUTH', result);
      return result;
    },
    
    logout({ commit }) {
      localStorage.removeItem('jwt_token');
      localStorage.removeItem('user_info');
      commit('CLEAR_AUTH');
    }
  }
};
```

---

## 🧪 测试验证

### API测试命令
```bash
# 健康检查
curl -X GET http://localhost:3000/health

# 用户登录 (开发环境)
curl -X POST http://localhost:3000/api/v4/unified-engine/auth/login \
  -H "Content-Type: application/json" \
  -d '{"mobile":"13812345678","verification_code":"123456"}'

# 获取用户信息 (需要Token)
curl -X GET http://localhost:3000/api/v4/unified-engine/auth/verify \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# 执行基础抽奖 (需要Token)
curl -X POST http://localhost:3000/api/v4/unified-engine/lottery/basic \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"campaign_id":1,"strategy_type":"basic_guarantee"}'
```

### 前端测试清单
- [ ] 用户登录/注册功能
- [ ] Token自动刷新机制
- [ ] 权限验证和路由守卫
- [ ] 抽奖功能完整流程
- [ ] 库存管理功能
- [ ] 图片上传和显示
- [ ] 错误处理和用户提示
- [ ] 响应式设计适配

### 性能测试指标
- **API响应时间**: < 100ms
- **文件上传时间**: < 2s
- **并发用户数**: 1000+
- **系统可用性**: > 99.95%

---

## 📝 开发注意事项

### 1. 时区处理
- **统一使用北京时间** (UTC+8)
- **API时间戳格式**: ISO 8601格式
- **前端显示**: 根据用户偏好显示时区

### 2. 数据验证
- **前端验证**: 用户体验优化
- **后端验证**: 数据安全保证
- **双重验证**: 确保数据完整性

### 3. 缓存策略
- **Redis缓存**: 热点数据缓存
- **浏览器缓存**: 静态资源缓存
- **CDN缓存**: 图片资源加速

### 4. 安全考虑
- **输入验证**: 防止SQL注入和XSS攻击
- **权限检查**: 严格的权限验证机制
- **请求限制**: 防止恶意请求和DDOS攻击
- **HTTPS**: 生产环境必须使用HTTPS

### 5. 监控和日志
- **API监控**: 监控接口响应时间和成功率
- **错误日志**: 记录系统错误和异常
- **业务日志**: 记录关键业务操作
- **性能监控**: 监控系统资源使用情况

---

## 🔄 版本更新记录

### v4.0.0 (2025-09-25)
- ✅ V4统一引擎架构发布
- ✅ 统一认证、抽奖、管理三大引擎
- ✅ Sealos对象存储集成
- ✅ 完整的权限管理系统
- ✅ 标准化API响应格式
- ✅ 北京时间支持
- ✅ 开发环境万能验证码

---

## 📞 技术支持

### 开发团队联系方式
- **项目维护**: Restaurant Lottery Team
- **技术架构**: V4统一引擎架构
- **部署平台**: Sealos云平台原生支持

### 常见问题解决
1. **Token过期**: 实现自动刷新机制
2. **图片上传失败**: 检查Sealos存储配置
3. **数据库连接超时**: 优化连接池配置
4. **跨域问题**: 配置正确的CORS设置

---

**文档结束** - 餐厅积分抽奖系统 V4.0 前后端对接规范文档 