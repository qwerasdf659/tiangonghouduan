# åç«¯æ•°æ®åº“æŠ€æœ¯å€ºåŠ¡å…¨æ™¯åˆ†æ

**ç”Ÿæˆæ—¶é—´**: 2026-02-06  
**åˆ†æèŒƒå›´**: `models/`ã€`migrations/`ã€`services/`ã€`config/`ã€`scripts/`ã€`utils/`  
**åˆ†ææ–¹æ³•**: ä»£ç é™æ€æ‰«æ + è¿ç§»å†å²è¿½æº¯ + å·²æœ‰éªŒè¯è„šæœ¬äº¤å‰å¯¹ç…§

---

## ğŸ“Š é¡¹ç›®æ•°æ®åº“æ¦‚å†µ

| æŒ‡æ ‡ | æ•°å€¼ |
|---|---|
| æ¨¡å‹æ–‡ä»¶ (`models/`) | **80+ ä¸ª** |
| è¿ç§»æ–‡ä»¶ (`migrations/`) | **100+ ä¸ª**ï¼ˆå¦æœ‰ archive å­˜æ¡£ï¼‰ |
| æ•°æ®åº“æ€»è¡¨æ•° | **~72 å¼ ** |
| æœåŠ¡æ–‡ä»¶ (`services/`) | **50+ ä¸ª** |

---

## ğŸ”´ P0 çº§ï¼šå½±å“æ•°æ®ä¸€è‡´æ€§/å®‰å…¨

### 1. ç©ºè¡¨æœªæ¸…ç†ï¼ˆ12+ å¼ è¡¨æ— ä¸šåŠ¡æ•°æ®ï¼‰

éªŒè¯è„šæœ¬ `scripts/verify-doc-decisions.js` ä¸­å·²æ ‡è®°ä»¥ä¸‹ç©ºè¡¨ï¼š

```
authentication_sessions, image_resources, lottery_daily_metrics,
lottery_hourly_metrics, lottery_draw_decisions, lottery_campaign_quota_grants,
lottery_campaign_user_quota, lottery_user_experience_state, lottery_user_global_state,
preset_budget_debt, preset_inventory_debt, trade_orders
```

**é—®é¢˜**ï¼šè¿™äº›è¡¨æœ‰å®Œæ•´çš„æ¨¡å‹å®šä¹‰å’Œå…³è”ï¼Œä½†ä»æœªäº§ç”Ÿè¿‡ä¸šåŠ¡æ•°æ®ã€‚ç»´æŠ¤æˆæœ¬æŒç»­å­˜åœ¨ï¼ˆæ¯æ¬¡è¿ç§»ã€syncã€å¥åº·æ£€æŸ¥éƒ½æ¶‰åŠï¼‰ï¼Œä½†æœªå¸¦æ¥ä¸šåŠ¡ä»·å€¼ã€‚

**å»ºè®®**ï¼šè¯„ä¼°ååˆ é™¤æˆ–å†»ç»“æ¨¡å‹æ³¨å†Œã€‚

### 2. å­¤å„¿æ•°æ®é—®é¢˜

é¡¹ç›®å·²ä¸“é—¨å»ºè®¾äº† `OrphanFrozenCleanupService`ï¼ˆ`services/OrphanFrozenCleanupService.js`ï¼‰æ¥æ£€æµ‹**å­¤å„¿å†»ç»“é‡‘é¢**â€”â€”å³ `frozen_amount` å¤§äºå®é™…æ´»è·ƒæŒ‚ç‰Œå†»ç»“æ€»é¢çš„è®°å½•ã€‚

åŒæ—¶ `scripts/database/database_toolkit.js` å’Œ `scripts/database/validate_all_tables.js` ä¸­æœ‰å­¤å„¿è®°å½•æ£€æµ‹é€»è¾‘ï¼ˆé€šè¿‡ LEFT JOIN æ£€æŸ¥å¤–é”®æŒ‡å‘ä¸å­˜åœ¨çš„çˆ¶è®°å½•ï¼‰ï¼Œè¯´æ˜**å¤–é”®å…³è”çš„æ•°æ®å®Œæ•´æ€§é—®é¢˜**æ˜¯å·²çŸ¥çš„ç³»ç»Ÿæ€§é—®é¢˜ã€‚

**å»ºè®®**ï¼šå®šæ—¶ Job è‡ªåŠ¨æ¸…ç† + å¤–é”®çº¦æŸåŠ å›ºã€‚

### 3. æµ‹è¯•æ•°æ®ä¸ç”Ÿäº§æ•°æ®æ··æ‚

è¿ç§» `20260109123000-add-test-data-legacy-flags.js` æ˜ç¡®è®°å½•ï¼š

> - asset_transactions ä¸­æœ‰ 378 æ¡ exchange_debit æµæ°´ï¼Œä½† exchange_records æ˜¯ç©ºè¡¨
> - è¯´æ˜è¿™äº›æ˜¯æµ‹è¯•æ•°æ®ï¼Œéœ€è¦æ ‡è®°éš”ç¦»
> - trade_records ä»…å‰© 2 æ¡å†å²æ•°æ®ï¼Œéœ€è¦æ ‡è®°ä¸ºé—ç•™æ•°æ®

å½“å‰é€šè¿‡ `is_test_data` / `is_legacy` æ ‡è®°éš”ç¦»è€Œéæ¸…é™¤ï¼Œå¢åŠ äº†æŸ¥è¯¢å¤æ‚åº¦ï¼ˆæ‰€æœ‰æ¶‰åŠè¿™äº›è¡¨çš„æŸ¥è¯¢éƒ½éœ€è¦é¢å¤–è¿‡æ»¤æ¡ä»¶ï¼‰ã€‚

**å»ºè®®**ï¼šç¯å¢ƒéš”ç¦»æˆ–å½»åº•æ¸…é™¤æµ‹è¯•æ•°æ®ã€‚

---

## ğŸŸ  P1 çº§ï¼šå½±å“æ€§èƒ½/å¯ç»´æŠ¤æ€§

### 4. å¤–é”®çº¦æŸä¸å®Œæ•´

æ¨¡å‹ä¸­æœ‰ `references` å£°æ˜çš„çº¦æŸåˆ†å¸ƒä¸å‡ï¼ˆçº¦ 35 ä¸ªæ¨¡å‹æ–‡ä»¶æœ‰å¤–é”®å£°æ˜ï¼‰ï¼Œä½†å¤§é‡å…³è”å…³ç³»ä»…åœ¨ Sequelize çš„ `associate()` ä¸­é€šè¿‡ ORM å±‚å®šä¹‰ï¼Œ**æ•°æ®åº“å±‚é¢ç¼ºå¤±å¤–é”®çº¦æŸ**ã€‚ä¾‹å¦‚ï¼š

- `lottery_draws.user_id â†’ users.user_id` â€” ORMæœ‰å…³è”ï¼Œä½†æ•°æ®åº“å±‚çº¦æŸéœ€éªŒè¯
- å¤šæ¬¡è¿ç§»ï¼ˆå¦‚ `20260201075523-rename-remaining-pks-and-fks.js`ï¼‰åå¤ä¿®è¡¥å¤–é”®

**é£é™©**ï¼šORM å±‚çº¦æŸä¸èƒ½é˜²æ­¢ç›´æ¥ SQL æ“ä½œå¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´ã€‚

**å»ºè®®**ï¼šé€è¡¨å®¡æŸ¥ï¼Œè¡¥å……æ•°æ®åº“å±‚ FK çº¦æŸã€‚

### 5. ä¸»é”®/å¤–é”®å‘½åè§„èŒƒå¤šæ¬¡é‡æ„

è¿ç§»å†å²æ˜¾ç¤ºäº†**è‡³å°‘ 8 æ¬¡**ä¸»é”®/å¤–é”®é‡å‘½åæ“ä½œï¼š

| è¿ç§»æ–‡ä»¶ | ä¿®å¤å†…å®¹ |
|---|---|
| `20260201075523-rename-remaining-pks-and-fks.js` | å‰©ä½™ä¸»é”®å’Œå¤–é”®è§„èŒƒåŒ– |
| `20260201081734-fix-remaining-campaign-id-columns.js` | ä¿®å¤ campaign_id åˆ— |
| `20260201102516-fix-draw-id-to-lottery-draw-id.js` | draw_id â†’ lottery_draw_id |
| `20260201235341-rename-preset-id-to-lottery-preset-id.js` | preset_id â†’ lottery_preset_id |
| `20260201235434-rename-last-campaign-id-to-last-lottery-campaign-id.js` | å¤–é”®é‡å‘½å |
| `20260201235436-rename-fallback-prize-ids.js` | å¤–é”®é‡å‘½å |
| `20260201235438-rename-debt-decision-ids.js` | å¤–é”®é‡å‘½å |
| `20260201235441-rename-batch-session-ids.js` | å¤–é”®é‡å‘½å |

**æ ¹å› **ï¼šæ—©æœŸå»ºè¡¨æ—¶ä¸»é”®å‘½åä¸è§„èŒƒï¼ˆå¦‚ `id` è€Œé `{table_name}_id`ï¼‰ï¼Œåç»­è¡¥æ•‘å¼è¿ç§»å¢åŠ äº†ç³»ç»Ÿå¤æ‚åº¦ã€‚å½“å‰è§„èŒƒå·²ç¡®ç«‹ä¸º `{table_name}_id` æ ¼å¼ã€‚

### 6. å­—æ®µå‘½åä¸ä¸€è‡´çš„è¡¥æ•‘è¿ç§»

å¤šæ¬¡è¿ç§»ä¸“é—¨ä¿®å¤å­—æ®µå‘½åé—®é¢˜ï¼š

| è¿ç§»æ–‡ä»¶ | ä¿®å¤å†…å®¹ |
|---|---|
| `20260129200000-rename-qty-to-quantity.js` | `qty` â†’ `quantity` |
| `20260129201000-rename-bare-name-fields.js` | bare name å­—æ®µä¿®å¤ |
| `20260102000000-breaking-rename-business-id-to-idempotency-key.js` | `business_id` â†’ `idempotency_key` |

**æ ¹å› **ï¼šæ—©æœŸå­—æ®µå‘½åç¼ºä¹ç»Ÿä¸€è§„èŒƒï¼ˆç¼©å†™ vs å…¨ç§°ã€ä¸šåŠ¡è¯­ä¹‰ vs é€šç”¨è¯­ä¹‰ï¼‰ã€‚

### 7. è¿ç§»æ–‡ä»¶è†¨èƒ€

- ä¸»è¿ç§»ç›®å½• **100+ ä¸ªæ–‡ä»¶** + archive ç›®å½•ä¸­çš„å†å²è¿ç§»
- baseline è¿ç§» `20260104000000-baseline-v2.0.0-from-production.js` æœ‰ **6000+ è¡Œ**
- å¤šä¸ªè¿ç§»æ–‡ä»¶åšç›¸åŒç±»å‹çš„ä¿®è¡¥ï¼ˆå¦‚å¤šæ¬¡ä¿®å¤ `campaign_id` åˆ—åï¼‰

**å»ºè®®**ï¼šå®šæœŸ squash ä¸ºæ–° baselineï¼Œå½’æ¡£å†å²è¿ç§»ã€‚

### 8. ç´¢å¼•è¦†ç›–ä¸è¶³

è¿ç§» `20260102400000-add-composite-indexes-query-optimization.js` ä¸­è®°å½•äº†å®é™… EXPLAIN éªŒè¯ç»“æœï¼š

> - `item_instances`ï¼šå½“å‰åªæœ‰å•åˆ—ç´¢å¼•ï¼ŒORDER BY created_at éœ€è¦ filesort
> - `redemption_orders`ï¼šstatus éœ€å›è¡¨è¿‡æ»¤ï¼ˆfiltered=49.87%ï¼‰
> - `lottery_draws`ï¼šæœ€è¿‘é«˜æ¡£å¥–åŠ±æŸ¥è¯¢éœ€è¦é¢å¤–æ’åº

è™½ç„¶è¿™äº›å·²é€šè¿‡è¿ç§»ä¿®å¤ï¼Œä½†è¯´æ˜**æ¨¡å‹å®šä¹‰æ—¶çš„ç´¢å¼•è®¾è®¡ä¸å¤Ÿå®Œå–„**ï¼Œå­˜åœ¨åè¡¥å¤åˆç´¢å¼•çš„ç³»ç»Ÿæ€§é—®é¢˜ã€‚

**å»ºè®®**ï¼šå®šæœŸå¯¹é«˜é¢‘æŸ¥è¯¢è·¯å¾„åš EXPLAIN å®¡æŸ¥ã€‚

---

## ğŸŸ¡ P2 çº§ï¼šæŠ€æœ¯å€ºåŠ¡/ä»£ç è´¨é‡

### 9. æ—§è¡¨æ¸…ç†ä¸å½»åº•

éªŒè¯è„šæœ¬ `scripts/verify-doc-decisions.js` ä¸­åˆ—å‡ºäº† 12 å¼ éœ€ç¡®è®¤å·²åˆ é™¤çš„æ—§è¡¨ï¼š

```
user_points_accounts, points_transactions, trade_records,
audit_records, user_inventory, user_inventories,
lottery_histories, prize_records, merchant_points_reviews,
role_change_logs, item_template_aliases, points_logs
```

å¦å¤–æµ‹è¯•ç¯å¢ƒè¿˜å­˜åœ¨åƒåœ¾è¡¨ `deadlock_test_1769781752856`ï¼ˆæµ‹è¯•äº§ç”Ÿçš„ä¸´æ—¶è¡¨ï¼‰ã€‚

**å»ºè®®**ï¼šè¿è¡ŒéªŒè¯è„šæœ¬ç¡®è®¤å DROPï¼Œå¹¶ä»ä»£ç ä¸­ç§»é™¤ä»»ä½•æ®‹ç•™å¼•ç”¨ã€‚

### 10. æ¨¡å‹æ•°é‡è¿‡å¤šï¼ˆ80+ï¼‰ï¼Œéƒ¨åˆ†èŒè´£æ¨¡ç³Š

80+ ä¸ªæ¨¡å‹æ–‡ä»¶ä¸­å­˜åœ¨ä»¥ä¸‹å¯ä¼˜åŒ–åŒºåŸŸï¼š

| ç±»åˆ« | æ¶‰åŠæ¨¡å‹ | é—®é¢˜ |
|---|---|---|
| å®¡è®¡è¿½è¸ªç±» | `UserStatusChangeRecord`ã€`UserRoleChangeRecord`ã€`LotteryClearSettingRecord` | ä»…ç”¨äºç”Ÿæˆå®¡è®¡æ—¥å¿—çš„ `target_id`ï¼Œå¯è€ƒè™‘åˆå¹¶ä¸ºé€šç”¨å®¡è®¡é”šç‚¹è¡¨ |
| é…ç½®ç±»è¡¨ | `SystemSettings`ã€`SystemConfig`ã€`FeatureFlag`ã€`SystemDictionary` | 4 ç§é…ç½®è¡¨å¹¶å­˜ï¼ŒèŒè´£åˆ’åˆ†æœ‰é‡å  |
| æŒ‡æ ‡ç±» | `LotteryHourlyMetrics`ã€`LotteryDailyMetrics` | ç©ºè¡¨ï¼ŒæŒ‡æ ‡é‡‡é›†æœºåˆ¶æœªæŠ•å…¥ä½¿ç”¨ |

### 11. è¿æ¥æ± å‚æ•°ç¡¬ç¼–ç 

`config/database.js` ä¸­è¿æ¥æ± å‚æ•°ï¼š

```javascript
pool: {
  max: 40,     // "å·²æ‹æ¿"
  min: 5,
  acquire: 10000,
  idle: 60000,
  evict: 30000,
  handleDisconnects: true
}
```

`max: 40` å¯¹äº 72 å¼ è¡¨ + 80 ä¸ªæ¨¡å‹çš„ç³»ç»Ÿæ¥è¯´ï¼Œåœ¨å¤šå®ä¾‹éƒ¨ç½²æˆ–è´Ÿè½½å¢é•¿æ—¶å¯èƒ½æˆä¸ºç“¶é¢ˆã€‚å»ºè®®é€šè¿‡ç¯å¢ƒå˜é‡åŠ¨æ€é…ç½®ã€‚

### 12. `UnifiedDatabaseHelper` ä¸­çš„ `standardSchema` ä¸å®Œæ•´

`utils/UnifiedDatabaseHelper.js` ä¸­ï¼š

- `standardSchema` åªå®šä¹‰äº† **3 å¼ è¡¨**ï¼ˆ`users`ã€`lottery_draws`ã€`lottery_prizes`ï¼‰
- `coreTables` åˆ—äº† **6 å¼ è¡¨**ï¼ˆé¢å¤–åŒ…å« `accounts`ã€`account_asset_balances`ã€`asset_transactions`ï¼‰

éªŒè¯è¦†ç›–ä¸å…¨ï¼Œ`coreTables` ä¸­æœ‰ 3 å¼ è¡¨ç¼ºå°‘ schema å®šä¹‰ï¼Œå¥åº·æ£€æŸ¥çš„å­—æ®µæ˜ å°„å’Œä¸»é”®éªŒè¯æ— æ³•è¦†ç›–æ–°è´¦æœ¬æ¶æ„çš„æ ¸å¿ƒè¡¨ã€‚

### 13. æŠ½å¥–å¼•æ“ Pipeline ç¼ºå°‘ç»“æ„åŒ–æ—¥å¿—

ä»¥ä¸‹ 5 ä¸ªæ–‡ä»¶ä»ä½¿ç”¨ `console.log` è€Œéç»“æ„åŒ– loggerï¼š

| æ–‡ä»¶ |
|---|
| `services/lottery/LotteryPricingService.js` |
| `services/UnifiedLotteryEngine/pipeline/budget/BudgetProvider.js` |
| `services/UnifiedLotteryEngine/pipeline/DrawOrchestrator.js` |
| `services/UnifiedLotteryEngine/pipeline/PipelineRunner.js` |
| `services/UnifiedLotteryEngine/pipeline/stages/BaseStage.js` |

é›†ä¸­åœ¨æŠ½å¥–å¼•æ“ Pipeline æ ¸å¿ƒé“¾è·¯ï¼Œ**ç¼ºå°‘ request_id å…³è”çš„ç»“æ„åŒ–æ—¥å¿—**ï¼Œä¸åˆ©äºé—®é¢˜æ’æŸ¥å’Œé“¾è·¯è¿½è¸ªã€‚

---

## ğŸ“‹ å€ºåŠ¡ä¼˜å…ˆçº§æ€»ç»“

| ä¼˜å…ˆçº§ | # | å€ºåŠ¡é¡¹ | æ•°é‡/è§„æ¨¡ | å»ºè®®å¤„ç†æ–¹å¼ |
|:---:|:---:|---|---|---|
| ğŸ”´ P0 | 1 | ç©ºè¡¨å ç”¨ | 12+ å¼  | è¯„ä¼°ååˆ é™¤æˆ–å†»ç»“æ¨¡å‹æ³¨å†Œ |
| ğŸ”´ P0 | 2 | å­¤å„¿æ•°æ® | æŒç»­æ€§é—®é¢˜ | å®šæ—¶ Job è‡ªåŠ¨æ¸…ç† + å¤–é”®åŠ å›º |
| ğŸ”´ P0 | 3 | æµ‹è¯•æ•°æ®æ··å…¥ | 378+ æ¡ | ç¯å¢ƒéš”ç¦»æˆ–å½»åº•æ¸…é™¤ |
| ğŸŸ  P1 | 4 | å¤–é”®çº¦æŸç¼ºå¤± | å¤šå¼ å…³è”è¡¨ | è¡¥å……æ•°æ®åº“å±‚ FK çº¦æŸ |
| ğŸŸ  P1 | 5 | PK/FK å‘½åè§„èŒƒè¡¥ä¸ | 8+ æ¬¡è¿ç§» | å·²å®Œæˆï¼Œé˜²æ­¢å›é€€ |
| ğŸŸ  P1 | 6 | å­—æ®µå‘½åè¡¥æ•‘ | 3+ æ¬¡è¿ç§» | å·²å®Œæˆï¼Œå»ºç«‹å‘½åè§„èŒƒ |
| ğŸŸ  P1 | 7 | è¿ç§»æ–‡ä»¶è†¨èƒ€ | 100+ ä¸ª | å®šæœŸ squash baseline |
| ğŸŸ  P1 | 8 | ç´¢å¼•è¦†ç›–ä¸è¶³ | æŒç»­æ€§ | å®šæœŸ EXPLAIN å®¡æŸ¥ |
| ğŸŸ¡ P2 | 9 | æ—§è¡¨/åƒåœ¾è¡¨æ®‹ç•™ | 12+ å¼ å¾…éªŒè¯ | è¿è¡ŒéªŒè¯è„šæœ¬ç¡®è®¤å DROP |
| ğŸŸ¡ P2 | 10 | æ¨¡å‹èŒè´£æ¨¡ç³Š | å®¡è®¡3ä¸ª/é…ç½®4ç§/ç©ºæŒ‡æ ‡2ä¸ª | ä¸­æœŸç»Ÿä¸€è¯„ä¼° |
| ğŸŸ¡ P2 | 11 | è¿æ¥æ± å‚æ•°ç¡¬ç¼–ç  | 1 å¤„ | æ”¹ä¸ºç¯å¢ƒå˜é‡é…ç½® |
| ğŸŸ¡ P2 | 12 | standardSchema è¦†ç›–ä¸å…¨ | ä»… 3/6 è¡¨ | è¡¥é½æ ¸å¿ƒè¡¨ schema |
| ğŸŸ¡ P2 | 13 | Pipeline ç¼ºå°‘ç»“æ„åŒ–æ—¥å¿— | 5 ä¸ªæ–‡ä»¶ | æ›¿æ¢ console.log â†’ logger |

---

## ğŸ”§ å·²å®Œæˆçš„å€ºåŠ¡æ¸…ç†ï¼ˆå‚è€ƒï¼‰

ä»¥ä¸‹å€ºåŠ¡é¡¹å·²é€šè¿‡å†å²è¿ç§»/é‡æ„å®Œæˆï¼š

| å·²å®Œæˆé¡¹ | ç›¸å…³è¿ç§»/å˜æ›´ |
|---|---|
| v1 äºŒç»´ç å­—æ®µæ¸…ç† | `20260111213816-remove-v1-qrcode-fields.js` |
| `user_points_accounts` åºŸå¼ƒ | ç”¨æˆ·ç§¯åˆ†ç°é€šè¿‡ `account_asset_balances` ç®¡ç† |
| PK å‘½åç»Ÿä¸€ä¸º `{table}_id` | 8 æ¬¡è¿ç§»ï¼ˆ2026-02-01 æ‰¹é‡å®Œæˆï¼‰ |
| `business_id` â†’ `idempotency_key` è¯­ä¹‰åŒ– | `20260102000000-breaking-rename-business-id-to-idempotency-key.js` |
| å¤åˆç´¢å¼•è¡¥å…… | `20260102400000-add-composite-indexes-query-optimization.js` |
| feedbacks è¡¨æ€§èƒ½ç´¢å¼• | `archive/20251109202000-add-feedbacks-performance-indexes.js` |

