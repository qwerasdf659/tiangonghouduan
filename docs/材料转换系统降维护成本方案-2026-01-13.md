# ææ–™è½¬æ¢ç³»ç»Ÿé™ç»´æŠ¤æˆæœ¬æ–¹æ¡ˆï¼ˆè§„åˆ™é©±åŠ¨+å¤šå¯¹å¤š+æŸè€—æ¨¡å‹ï¼‰

**æ–‡æ¡£ç‰ˆæœ¬**: V1.0  
**åˆ›å»ºæ—¶é—´**: 2026-01-13  
**é€‚ç”¨ç³»ç»Ÿ**: é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ V4.5.0 ææ–™ç³»ç»Ÿæ¶æ„  
**å†³ç­–èƒŒæ™¯**: ä¿ç•™ææ–™è½¬æ¢èƒ½åŠ›ï¼Œæ”¯æŒæœªæ¥æ‰©å±•å¤šç§ææ–™/å¤šç›®æ ‡èµ„äº§ï¼Œé™ä½è¿ç»´å’Œè¿­ä»£æˆæœ¬

---

## ğŸ“Š å½“å‰çŠ¶æ€è¯Šæ–­ï¼ˆåŸºäºçœŸå®ä»£ç +DBï¼‰

### ä»£ç å±‚ç°çŠ¶ï¼ˆ2026-01-13 å®é™…æ£€æŸ¥ï¼‰

- âœ… **æœåŠ¡å·²æ¥å…¥ç»Ÿä¸€è´¦æœ¬**ï¼š`AssetConversionService` é€šè¿‡ `AssetService.changeBalance()` åšåŒåˆ†å½•
- âœ… **API è·¯ç”±å·²å°±ç»ª**ï¼š`POST /api/v4/shop/assets/convert` + `GET /api/v4/shop/assets/conversion-rules`
- âœ… **å¹‚ç­‰æ¶æ„å®Œæ•´**ï¼šå…¥å£å¹‚ç­‰ï¼ˆ`IdempotencyService`ï¼‰+ ä¸šåŠ¡å¹‚ç­‰ï¼ˆæ´¾ç”Ÿ `:debit/:credit`ï¼‰
- âš ï¸ **è·¯ç”±å±‚ç¡¬ç¼–ç é™åˆ¶**ï¼šåªå…è®¸ `red_shard â†’ DIAMOND`ï¼Œæ–°å¢è½¬æ¢éœ€æ”¹ä»£ç å‘ç‰ˆ
- âš ï¸ **å¹‚ç­‰å›æ”¾ä½æ•ˆ**ï¼šæ‰«æ 1000 æ¡æµæ°´æŸ¥é‡ï¼Œæœªæ¥æµæ°´å¢å¤šä¼šå½±å“æ€§èƒ½

### æ•°æ®åº“å±‚ç°çŠ¶ï¼ˆrestaurant_points_dev çœŸå®æ•°æ®ï¼‰

- âœ… **è§„åˆ™è¡¨å·²å°±ç»ª**ï¼š`material_conversion_rules` æœ‰ 1 æ¡å¯ç”¨è§„åˆ™ï¼ˆ`red_shard:1 â†’ DIAMOND:20`ï¼‰
- âœ… **è´¦æœ¬è¡¨å·²å°±ç»ª**ï¼š`asset_transactions` æ”¯æŒ `material_convert_debit/credit`
- âœ… **ä½™é¢è¡¨å·²å°±ç»ª**ï¼š`account_asset_balances` å·²æœ‰ `red_shard`ï¼ˆ2 è´¦æˆ·ï¼‰ã€`DIAMOND`ï¼ˆ1 è´¦æˆ·ï¼‰ä½™é¢è®°å½•
- âš ï¸ **å°šæœªå®é™…ä½¿ç”¨**ï¼š0 æ¡è½¬æ¢æµæ°´ï¼Œ0 æ¬¡ API è°ƒç”¨ï¼ˆåŠŸèƒ½å°±ç»ªä½†æœªè§¦å‘ï¼‰

### ç»´æŠ¤æˆæœ¬ç—›ç‚¹è¯†åˆ«

| ç—›ç‚¹            | ç°çŠ¶                      | ç»´æŠ¤æˆæœ¬                            |
| --------------- | ------------------------- | ----------------------------------- |
| æ–°å¢è½¬æ¢ç±»å‹    | éœ€æ”¹è·¯ç”±ç¡¬ç¼–ç  + å‘ç‰ˆ     | **é«˜**ï¼šæ¯æ¬¡éƒ½è¦æ”¹ä»£ç               |
| è°ƒæ•´è½¬æ¢æ¯”ä¾‹    | éœ€æ”¹ DB è§„åˆ™ + å¯èƒ½æ”¹ä»£ç  | **ä¸­**ï¼šè§„åˆ™å·²åœ¨ DBï¼Œä½†è·¯ç”±æœ‰ç¡¬ç¼–ç  |
| å¹‚ç­‰å›æ”¾æŸ¥è¯¢    | æ‰«æ 1000 æ¡æµæ°´          | **ä¸­**ï¼šæµæ°´å¢å¤šåæ€§èƒ½ä¸‹é™          |
| åŠŸèƒ½ä¸Šä¸‹çº¿      | æ”¹ä»£ç æˆ–åˆ æ–‡ä»¶            | **é«˜**ï¼šæ— è¿è¥å¼€å…³ï¼Œä¾èµ–å‘ç‰ˆ        |
| è½¬æ¢æŸè€—/æ‰‹ç»­è´¹ | æœªå®ç°                    | **é«˜**ï¼šæœªæ¥åŠ éœ€è¦æ”¹å¤šå¤„            |

---

## ğŸ¯ é™ç»´æŠ¤æˆæœ¬æœ€ç»ˆå½¢æ€è®¾è®¡

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **è§„åˆ™é©±åŠ¨**ï¼šæ–°å¢è½¬æ¢=æ’å…¥ DB è§„åˆ™ï¼Œä¸æ”¹ä»£ç 
2. **å¤šå¯¹å¤šæ”¯æŒ**ï¼šä»»æ„ææ–™ â†” ä»»æ„ç›®æ ‡èµ„äº§ï¼ˆç”±è§„åˆ™è¡¨æ§åˆ¶ï¼‰
3. **æŸè€—æ¨¡å‹**ï¼šé«˜çº§ææ–™è½¬æ¢å¸¦æ‰‹ç»­è´¹ï¼Œè¿›ç³»ç»Ÿè´¦æˆ·ï¼Œå‰ç«¯å¯è§æŸè€—æ¯”ä¾‹
4. **è¿è¥å¯æ§**ï¼šå¯ç”¨/ç¦ç”¨/è°ƒæ•´æ¯”ä¾‹/è°ƒæ•´æŸè€—=æ”¹æ•°æ®ï¼Œä¸å‘ç‰ˆ
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¹‚ç­‰ç‚¹æŸ¥ï¼Œé¿å…æ‰«æå¤§é‡æµæ°´

---

## ğŸ“ æ•°æ®åº“æ¶æ„å‡çº§æ–¹æ¡ˆ

### æ–¹æ¡ˆ A1ï¼šæ‰©å±•è§„åˆ™è¡¨å­—æ®µï¼ˆæ¨èï¼Œæ”¹åŠ¨æœ€å°ï¼‰

åœ¨ç°æœ‰ `material_conversion_rules` è¡¨åŸºç¡€ä¸Šè¿½åŠ å­—æ®µï¼š

```sql
-- æ‰©å±•å­—æ®µï¼ˆé€šè¿‡è¿ç§»æ·»åŠ ï¼Œä¿ç•™ç°æœ‰æ•°æ®ï¼‰
ALTER TABLE material_conversion_rules
  -- è½¬æ¢é™åˆ¶
  ADD COLUMN min_from_amount INT UNSIGNED DEFAULT 1 COMMENT 'æœ€å°è½¬æ¢æ•°é‡ï¼ˆé˜²æ­¢å°é¢åˆ·ï¼‰',
  ADD COLUMN max_from_amount INT UNSIGNED DEFAULT NULL COMMENT 'æœ€å¤§è½¬æ¢æ•°é‡ï¼ˆé˜²æ­¢å¤§é¢å¥—åˆ©ï¼ŒNULL=æ— é™åˆ¶ï¼‰',

  -- æŸè€—æ¨¡å‹ï¼ˆæ‰‹ç»­è´¹ï¼‰
  ADD COLUMN fee_rate DECIMAL(5,4) DEFAULT 0.0000 COMMENT 'æ‰‹ç»­è´¹æ¯”ä¾‹ï¼ˆ0-1ä¹‹é—´ï¼Œå¦‚0.02è¡¨ç¤º2%æŸè€—ï¼‰',
  ADD COLUMN fee_min_amount INT UNSIGNED DEFAULT 0 COMMENT 'æœ€ä½æ‰‹ç»­è´¹æ•°é‡ï¼ˆä¿åº•æ”¶è´¹ï¼‰',
  ADD COLUMN fee_asset_code VARCHAR(50) DEFAULT NULL COMMENT 'æ‰‹ç»­è´¹èµ„äº§ç±»å‹ï¼ˆé»˜è®¤ä¸to_asset_codeç›¸åŒï¼‰',

  -- å±•ç¤ºä¸è¿è¥
  ADD COLUMN title VARCHAR(100) DEFAULT NULL COMMENT 'è½¬æ¢æ ‡é¢˜ï¼ˆå‰ç«¯å±•ç¤ºï¼‰',
  ADD COLUMN description VARCHAR(500) DEFAULT NULL COMMENT 'è½¬æ¢è¯´æ˜ï¼ˆå‰ç«¯å±•ç¤ºï¼‰',
  ADD COLUMN display_icon VARCHAR(50) DEFAULT NULL COMMENT 'å±•ç¤ºå›¾æ ‡ï¼ˆå‰ç«¯ç”¨ï¼‰',
  ADD COLUMN risk_level ENUM('low','medium','high') DEFAULT 'low' COMMENT 'é£é™©ç­‰çº§ï¼ˆè¿è¥ç°åº¦ï¼‰',
  ADD COLUMN is_visible TINYINT(1) DEFAULT 1 COMMENT 'æ˜¯å¦å‰ç«¯å¯è§ï¼ˆ0=åå°é…ç½®ä½†ä¸å±•ç¤ºï¼‰',

  -- å–æ•´è§„åˆ™
  ADD COLUMN rounding_mode ENUM('floor','ceil','round','exact') DEFAULT 'floor' COMMENT 'å–æ•´æ¨¡å¼ï¼ˆfloor=å‘ä¸‹ï¼Œceil=å‘ä¸Šï¼Œround=å››èˆäº”å…¥ï¼Œexact=å¿…é¡»æ•´é™¤ï¼‰',

  -- å®¡è®¡è¿½æº¯
  ADD COLUMN created_by INT UNSIGNED DEFAULT NULL COMMENT 'åˆ›å»ºäººï¼ˆç®¡ç†å‘˜user_idï¼‰',
  ADD COLUMN updated_by INT UNSIGNED DEFAULT NULL COMMENT 'æœ€åæ›´æ–°äººï¼ˆç®¡ç†å‘˜user_idï¼‰';

-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_conversion_rules_visibility
  ON material_conversion_rules(is_enabled, is_visible, effective_at);

CREATE INDEX idx_conversion_rules_from_to
  ON material_conversion_rules(from_asset_code, to_asset_code, is_enabled);
```

**å­—æ®µè®¾è®¡è¯´æ˜**ï¼š

| å­—æ®µ                  | ç”¨é€”                   | ç»´æŠ¤æˆæœ¬æ”¶ç›Š                                                            |
| --------------------- | ---------------------- | ----------------------------------------------------------------------- |
| `fee_rate`            | æ‰‹ç»­è´¹æ¯”ä¾‹ï¼ˆ0.02=2%ï¼‰  | **å‰ç«¯å¯å±•ç¤ºå®é™…åˆ°æ‰‹æ•°é‡**ï¼Œè¿è¥å¯åŠ¨æ€è°ƒæ•´                              |
| `fee_min_amount`      | æœ€ä½æ‰‹ç»­è´¹ï¼ˆä¿åº•æ”¶è´¹ï¼‰ | é˜²æ­¢å°é¢è½¬æ¢æ‰‹ç»­è´¹ä¸º 0                                                  |
| `fee_asset_code`      | æ‰‹ç»­è´¹èµ„äº§ç±»å‹         | é»˜è®¤ä¸ `to_asset_code` ç›¸åŒï¼Œæ”¯æŒç‰¹æ®Šåœºæ™¯ï¼ˆå¦‚è½¬æ¢å¾—é’»çŸ³ï¼Œæ‰‹ç»­è´¹æ‰£ææ–™ï¼‰ |
| `min/max_from_amount` | æ•°é‡é™åˆ¶               | é˜²åˆ·+å¥—åˆ©ä¿æŠ¤ï¼Œè¿è¥å¯è°ƒæ•´                                               |
| `title/description`   | å‰ç«¯æ–‡æ¡ˆ               | é¿å…å‰åç«¯å„å†™ä¸€ä»½ï¼Œæ”¹æ–‡æ¡ˆåªæ”¹ DB                                       |
| `is_visible`          | ç°åº¦å¼€å…³               | è§„åˆ™å­˜åœ¨ä½†æš‚ä¸å±•ç¤ºï¼ˆå†…æµ‹/ç‰¹å®šç”¨æˆ·å¯è§ï¼‰                                 |
| `rounding_mode`       | å–æ•´è§„åˆ™               | ç»Ÿä¸€è¾¹ç•Œè¡Œä¸ºï¼Œé¿å…äº‰è®®                                                  |

---

### æ–¹æ¡ˆ A2ï¼šç³»ç»Ÿè´¦æˆ·å‡†å¤‡ï¼ˆæ‰‹ç»­è´¹æ”¶å£ï¼‰

ç¡®ä¿ç³»ç»Ÿè´¦æˆ·å·²åˆ›å»ºï¼ˆç”¨äºæ”¶å–è½¬æ¢æ‰‹ç»­è´¹ï¼‰ï¼š

```sql
-- æ£€æŸ¥ç³»ç»Ÿè´¦æˆ·æ˜¯å¦å­˜åœ¨
SELECT account_id, system_code, status
FROM accounts
WHERE account_type='system' AND system_code='SYSTEM_PLATFORM_FEE';

-- å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºç³»ç»Ÿæ‰‹ç»­è´¹è´¦æˆ·
INSERT INTO accounts (account_type, system_code, user_id, status, created_at, updated_at)
VALUES ('system', 'SYSTEM_PLATFORM_FEE', NULL, 'active', NOW(), NOW());

-- ä¸ºç³»ç»Ÿè´¦æˆ·åˆ›å»ºå„èµ„äº§ä½™é¢è®°å½•ï¼ˆæŒ‰éœ€ï¼‰
INSERT INTO account_asset_balances (account_id, asset_code, campaign_id, available_amount, frozen_amount, created_at, updated_at)
SELECT
  a.account_id,
  'DIAMOND' AS asset_code,
  NULL AS campaign_id,
  0 AS available_amount,
  0 AS frozen_amount,
  NOW() AS created_at,
  NOW() AS updated_at
FROM accounts a
WHERE a.account_type='system' AND a.system_code='SYSTEM_PLATFORM_FEE'
ON DUPLICATE KEY UPDATE updated_at=NOW();
```

---

## ğŸ”§ æœåŠ¡å±‚æ”¹é€ æ–¹æ¡ˆï¼ˆæœ€å°æ”¹åŠ¨ï¼Œæœ€å¤§æ”¶ç›Šï¼‰

### æ”¹é€  1ï¼šå¹‚ç­‰å›æ”¾ä»"æ‰«æ"æ”¹"ç‚¹æŸ¥"

**ç°çŠ¶ä»£ç **ï¼ˆ`AssetConversionService.convertMaterial` ç¬¬ 227-241 è¡Œï¼‰ï¼š

```javascript
// ğŸ”´ ç°çŠ¶ï¼šæ‰«æ 1000 æ¡æµæ°´æŸ¥é‡ï¼ˆä½æ•ˆï¼‰
const existing_debit_tx = await AssetService.getTransactions(
  { user_id },
  {
    asset_code: from_asset_code,
    business_type: 'material_convert_debit',
    page_size: 1000 // æ‹‰ä¸€æ‰¹å†åœ¨å†…å­˜é‡Œæ‰¾
  },
  { transaction }
)

const debit_idempotency_key = `${idempotency_key}:debit`
const existing_record = existing_debit_tx.transactions.find(
  tx => tx.idempotency_key === debit_idempotency_key
)
```

**æ”¹é€ å**ï¼ˆç‚¹æŸ¥æ´¾ç”Ÿå¹‚ç­‰é”®ï¼‰ï¼š

```javascript
// âœ… æ”¹é€ ï¼šç›´æ¥æŒ‰å¹‚ç­‰é”®ç‚¹æŸ¥ï¼ˆé«˜æ•ˆï¼‰
const debit_idempotency_key = `${idempotency_key}:debit`
const credit_idempotency_key = `${idempotency_key}:credit`

// ç‚¹æŸ¥ debit æµæ°´ï¼ˆåˆ©ç”¨å”¯ä¸€ç´¢å¼•ï¼‰
const existing_debit_tx = await AssetService.getTransactionByIdempotencyKey(debit_idempotency_key, {
  transaction
})

if (existing_debit_tx) {
  // å‚æ•°ä¸€è‡´æ€§éªŒè¯ï¼ˆ409 å†²çªä¿æŠ¤ï¼‰
  const existing_meta = existing_debit_tx.meta || {}
  const is_params_match =
    existing_meta.from_asset_code === from_asset_code &&
    existing_meta.to_asset_code === to_asset_code &&
    Math.abs(existing_debit_tx.delta_amount) === from_amount

  if (!is_params_match) {
    // å‚æ•°ä¸ä¸€è‡´ï¼Œè¿”å› 409 å†²çª
    const conflictError = new Error(
      `å¹‚ç­‰é”®å†²çªï¼šidempotency_key="${idempotency_key}" å·²è¢«ä½¿ç”¨äºä¸åŒå‚æ•°çš„è½¬æ¢æ“ä½œã€‚` +
        `åŸè½¬æ¢ï¼š${existing_meta.from_asset_code || 'unknown'} â†’ ${existing_meta.to_asset_code || 'unknown'}, ` +
        `æ•°é‡=${Math.abs(existing_debit_tx.delta_amount || 0)}ï¼›` +
        `å½“å‰è¯·æ±‚ï¼š${from_asset_code} â†’ ${to_asset_code}, æ•°é‡=${from_amount}ã€‚` +
        'è¯·ä½¿ç”¨ä¸åŒçš„å¹‚ç­‰é”®æˆ–ç¡®è®¤è¯·æ±‚å‚æ•°æ­£ç¡®ã€‚'
    )
    conflictError.statusCode = 409
    conflictError.errorCode = 'IDEMPOTENCY_KEY_CONFLICT'
    throw conflictError
  }

  // å‚æ•°ä¸€è‡´ï¼ŒæŸ¥è¯¢å¯¹åº”çš„ credit æµæ°´å¹¶è¿”å›å¹‚ç­‰ç»“æœ
  const existing_credit_tx = await AssetService.getTransactionByIdempotencyKey(
    credit_idempotency_key,
    { transaction }
  )

  // è·å–å½“å‰ä½™é¢
  const from_balance_obj = await AssetService.getBalance(
    { user_id, asset_code: from_asset_code },
    { transaction }
  )
  const to_balance_obj = await AssetService.getBalance(
    { user_id, asset_code: to_asset_code },
    { transaction }
  )

  logger.info('âš ï¸ å¹‚ç­‰æ€§æ£€æŸ¥ï¼šææ–™è½¬æ¢å·²å­˜åœ¨ï¼Œå‚æ•°ä¸€è‡´ï¼Œè¿”å›åŸç»“æœ', {
    user_id,
    from_asset_code,
    to_asset_code,
    from_amount,
    idempotency_key
  })

  return {
    success: true,
    from_asset_code,
    to_asset_code,
    from_amount,
    to_amount: existing_meta.to_amount,
    fee_amount: existing_meta.fee_amount || 0,
    actual_received: existing_meta.actual_received || existing_meta.to_amount,
    from_tx_id: existing_debit_tx.transaction_id,
    to_tx_id: existing_credit_tx?.transaction_id || null,
    fee_tx_id: existing_meta.fee_tx_id || null,
    from_balance: from_balance_obj.available_amount,
    to_balance: to_balance_obj.available_amount,
    is_duplicate: true
  }
}
```

**éœ€è¦åœ¨ `AssetService` æ–°å¢çš„è¾…åŠ©æ–¹æ³•**ï¼š

```javascript
// services/AssetService.js æ–°å¢
/**
 * æ ¹æ®å¹‚ç­‰é”®æŸ¥è¯¢å•æ¡æµæ°´ï¼ˆç”¨äºå¹‚ç­‰å›æ”¾ï¼‰
 *
 * @param {string} idempotency_key - å¹‚ç­‰é”®
 * @param {Object} options - é€‰é¡¹
 * @param {Transaction} options.transaction - äº‹åŠ¡å¯¹è±¡
 * @returns {Promise<Object|null>} æµæ°´è®°å½•æˆ– null
 */
static async getTransactionByIdempotencyKey(idempotency_key, options = {}) {
  const { transaction } = options
  const { AssetTransaction } = require('../models')

  const tx = await AssetTransaction.findOne({
    where: { idempotency_key },
    transaction,
    raw: true
  })

  return tx
}
```

**æ”¶ç›Š**ï¼š

- æŸ¥è¯¢ä» O(n) é™åˆ° O(1)ï¼ˆåˆ©ç”¨å”¯ä¸€ç´¢å¼•ï¼‰
- æœªæ¥æµæ°´ç™¾ä¸‡çº§ä¹Ÿä¸å½±å“æ€§èƒ½
- ä»£ç é€»è¾‘æ›´æ¸…æ™°ï¼ˆç›´æ¥ç‚¹æŸ¥ï¼Œä¸ç”¨å¾ªç¯ï¼‰

---

### æ”¹é€  2ï¼šè·¯ç”±å±‚ç§»é™¤ç¡¬ç¼–ç ï¼Œæ”¹ä¸ºè§„åˆ™é©±åŠ¨

**ç°çŠ¶ä»£ç **ï¼ˆ`routes/v4/shop/assets/convert.js` ç¬¬ 144-169 è¡Œï¼‰ï¼š

```javascript
// âŒ ç°çŠ¶ï¼šç¡¬ç¼–ç åªæ”¯æŒ red_shard â†’ DIAMOND
if (from_asset_code !== 'red_shard') {
  return res.apiError(
    'ä¸æ”¯æŒçš„æºææ–™ç±»å‹ï¼šå½“å‰åªæ”¯æŒ"red_shard"ï¼ˆç¢çº¢æ°´æ™¶ï¼‰',
    'BAD_REQUEST',
    { from_asset_code, supported_types: ['red_shard'] },
    400
  )
}

if (to_asset_code !== 'DIAMOND') {
  return res.apiError(
    'ä¸æ”¯æŒçš„ç›®æ ‡èµ„äº§ç±»å‹ï¼šå½“å‰åªæ”¯æŒ"DIAMOND"ï¼ˆé’»çŸ³ï¼‰',
    'BAD_REQUEST',
    { to_asset_code, supported_types: ['DIAMOND'] },
    400
  )
}
```

**æ”¹é€ å**ï¼ˆè§„åˆ™é©±åŠ¨ï¼Œæ”¯æŒå¤šå¯¹å¤šï¼‰ï¼š

```javascript
// âœ… æ”¹é€ ï¼šé€šç”¨å‚æ•°æ ¡éªŒï¼Œæ”¯æŒç”±è§„åˆ™åˆ¤æ–­
// è·¯ç”±å±‚åªåšåŸºç¡€æ ¡éªŒï¼ˆéç©ºã€ç±»å‹ã€æ ¼å¼ï¼‰
if (!from_asset_code || typeof from_asset_code !== 'string') {
  return res.apiError('ç¼ºå°‘å¿…å¡«å‚æ•°ï¼šfrom_asset_codeï¼ˆæºææ–™èµ„äº§ä»£ç ï¼‰', 'BAD_REQUEST', null, 400)
}

if (!to_asset_code || typeof to_asset_code !== 'string') {
  return res.apiError('ç¼ºå°‘å¿…å¡«å‚æ•°ï¼što_asset_codeï¼ˆç›®æ ‡èµ„äº§ä»£ç ï¼‰', 'BAD_REQUEST', null, 400)
}

// è½¬æ¢æ•°é‡éªŒè¯
const parsedAmount = parseInt(from_amount)
if (isNaN(parsedAmount) || parsedAmount <= 0) {
  return res.apiError(
    'è½¬æ¢æ•°é‡å¿…é¡»æ˜¯å¤§äº0çš„æ­£æ•´æ•°',
    'BAD_REQUEST',
    { from_amount, parsed_amount: parsedAmount },
    400
  )
}

// âœ… æ”¯æŒæ€§æ ¡éªŒäº¤ç»™æœåŠ¡å±‚ï¼ˆé€šè¿‡æŸ¥è¯¢ DB è§„åˆ™åˆ¤æ–­ï¼‰
// æœåŠ¡å±‚ä¼šæŠ›å‡ºæ˜ç¡®é”™è¯¯ï¼š
// - "ä¸æ”¯æŒçš„ææ–™è½¬æ¢ï¼šxxx â†’ yyyï¼ˆæœªæ‰¾åˆ°ç”Ÿæ•ˆçš„è½¬æ¢è§„åˆ™ï¼‰"
// - "ææ–™è½¬æ¢è§„åˆ™å·²ç¦ç”¨ï¼šxxx â†’ yyy"
// - "è½¬æ¢æ•°é‡ä¸ç¬¦åˆé™åˆ¶ï¼šéœ€è¦ 1-100ï¼Œå®é™… 500"
```

**æ”¶ç›Š**ï¼š

- æ–°å¢è½¬æ¢ç±»å‹ï¼šæ’å…¥ DB è§„åˆ™å³å¯ï¼Œè·¯ç”±ä»£ç ä¸ç”¨æ”¹
- å‰ç«¯å±•ç¤ºå¯é€‰é¡¹ï¼šè°ƒç”¨ `GET /api/v4/shop/assets/conversion-rules` è·å–å½“å‰å¯ç”¨è§„åˆ™
- ç°åº¦/AB æµ‹è¯•ï¼šé€šè¿‡ `is_visible` æ§åˆ¶ï¼Œä¸ç”¨å‘ç‰ˆ

---

### æ”¹é€  3ï¼šæœåŠ¡å±‚æ”¯æŒæŸè€—æ¨¡å‹ï¼ˆæ‰‹ç»­è´¹ä¸‰æ–¹è®°è´¦ï¼‰

**æ ¸å¿ƒä¸šåŠ¡é€»è¾‘**ï¼š

```
ç”¨æˆ·è½¬æ¢ 100 ä¸ª red_shard â†’ DIAMONDï¼ˆè§„åˆ™ 1:20ï¼Œæ‰‹ç»­è´¹ 2%ï¼‰
1. æ‰£å‡ç”¨æˆ· 100 ä¸ª red_shardï¼ˆmaterial_convert_debitï¼‰
2. è®¡ç®—ç›®æ ‡æ•°é‡ï¼š100 * 20 = 2000 ä¸ª DIAMOND
3. è®¡ç®—æ‰‹ç»­è´¹ï¼š2000 * 0.02 = 40 ä¸ª DIAMOND
4. å®é™…åˆ°è´¦ï¼š2000 - 40 = 1960 ä¸ª DIAMONDï¼ˆmaterial_convert_creditï¼‰
5. æ‰‹ç»­è´¹å…¥ç³»ç»Ÿè´¦æˆ·ï¼š40 ä¸ª DIAMONDï¼ˆmaterial_convert_feeï¼‰
```

**æ”¹é€ åçš„ `convertMaterial` æ–¹æ³•**ï¼ˆä¼ªä»£ç ï¼Œå…³é”®é€»è¾‘ï¼‰ï¼š

```javascript
static async convertMaterial(user_id, from_asset_code, to_asset_code, from_amount, options = {}) {
  const transaction = assertAndGetTransaction(options, 'AssetConversionService.convertMaterial')

  // å‚æ•°éªŒè¯...

  // æŸ¥è¯¢è½¬æ¢è§„åˆ™ï¼ˆæ”¯æŒç‰ˆæœ¬åŒ–ï¼‰
  const rule = await MaterialConversionRule.getEffectiveRule(
    from_asset_code,
    to_asset_code,
    new Date(),
    { transaction }
  )

  if (!rule) {
    throw new Error(`ä¸æ”¯æŒçš„ææ–™è½¬æ¢ï¼š${from_asset_code} â†’ ${to_asset_code}ï¼ˆæœªæ‰¾åˆ°ç”Ÿæ•ˆçš„è½¬æ¢è§„åˆ™ï¼‰`)
  }

  if (!rule.is_enabled) {
    throw new Error(`ææ–™è½¬æ¢è§„åˆ™å·²ç¦ç”¨ï¼š${from_asset_code} â†’ ${to_asset_code}`)
  }

  // éªŒè¯æ•°é‡é™åˆ¶
  if (rule.min_from_amount && from_amount < rule.min_from_amount) {
    throw new Error(`è½¬æ¢æ•°é‡ä¸è¶³ï¼šæœ€å°‘éœ€è¦ ${rule.min_from_amount}ï¼Œå®é™… ${from_amount}`)
  }
  if (rule.max_from_amount && from_amount > rule.max_from_amount) {
    throw new Error(`è½¬æ¢æ•°é‡è¶…é™ï¼šæœ€å¤šå…è®¸ ${rule.max_from_amount}ï¼Œå®é™… ${from_amount}`)
  }

  // è®¡ç®—è½¬æ¢åçš„ç›®æ ‡èµ„äº§æ•°é‡ï¼ˆæŒ‰å–æ•´è§„åˆ™ï¼‰
  const raw_to_amount = (from_amount / rule.from_amount) * rule.to_amount
  let to_amount

  switch (rule.rounding_mode) {
    case 'floor':
      to_amount = Math.floor(raw_to_amount)
      break
    case 'ceil':
      to_amount = Math.ceil(raw_to_amount)
      break
    case 'round':
      to_amount = Math.round(raw_to_amount)
      break
    case 'exact':
      if (raw_to_amount !== Math.floor(raw_to_amount)) {
        throw new Error(`è½¬æ¢æ•°é‡å¿…é¡»æ•´é™¤ï¼š${from_amount} ä¸ª ${from_asset_code} æ— æ³•æ•´é™¤è½¬æ¢`)
      }
      to_amount = raw_to_amount
      break
    default:
      to_amount = Math.floor(raw_to_amount)
  }

  // ğŸ”¥ è®¡ç®—æ‰‹ç»­è´¹ï¼ˆæŸè€—æ¨¡å‹ï¼‰
  const fee_rate = parseFloat(rule.fee_rate || 0)
  let fee_amount = 0
  let actual_received = to_amount

  if (fee_rate > 0) {
    // æŒ‰æ¯”ä¾‹è®¡ç®—æ‰‹ç»­è´¹
    fee_amount = Math.max(
      Math.floor(to_amount * fee_rate),
      rule.fee_min_amount || 0
    )
    actual_received = to_amount - fee_amount

    if (actual_received <= 0) {
      throw new Error(`è½¬æ¢æ•°é‡è¿‡å°ï¼Œæ‰‹ç»­è´¹åæ— å‰©ä½™ï¼šè½¬æ¢å¾— ${to_amount}ï¼Œæ‰‹ç»­è´¹ ${fee_amount}`)
    }
  }

  const idempotency_key = options.idempotency_key
  const title = options.title || rule.title || `ææ–™è½¬æ¢ï¼š${from_asset_code} â†’ ${to_asset_code}`
  const meta = {
    ...options.meta,
    from_asset_code,
    to_asset_code,
    from_amount,
    to_amount, // è½¬æ¢å¾—åˆ°çš„æ€»æ•°é‡ï¼ˆå«æ‰‹ç»­è´¹ï¼‰
    fee_amount, // æ‰‹ç»­è´¹æ•°é‡
    actual_received, // å®é™…åˆ°è´¦æ•°é‡
    fee_rate, // æ‰‹ç»­è´¹æ¯”ä¾‹
    rule_id: rule.rule_id,
    rule_effective_at: rule.effective_at,
    conversion_rate: rule.to_amount / rule.from_amount,
    rounding_mode: rule.rounding_mode
  }

  // ğŸ”´ å¹‚ç­‰å›æ”¾ç‚¹æŸ¥ï¼ˆæ”¹é€ ç‚¹ 1ï¼‰
  const debit_idempotency_key = `${idempotency_key}:debit`
  const existing_debit_tx = await AssetService.getTransactionByIdempotencyKey(
    debit_idempotency_key,
    { transaction }
  )

  if (existing_debit_tx) {
    // å‚æ•°ä¸€è‡´æ€§éªŒè¯ + è¿”å›å¹‚ç­‰ç»“æœï¼ˆåŒä¸Šï¼‰
    // ...
  }

  /*
   * æ­¥éª¤ 1ï¼šæ‰£å‡æºææ–™ï¼ˆmaterial_convert_debitï¼‰
   */
  const from_result = await AssetService.changeBalance(
    {
      user_id,
      asset_code: from_asset_code,
      delta_amount: -from_amount,
      idempotency_key: debit_idempotency_key,
      business_type: 'material_convert_debit',
      meta: {
        ...meta,
        title: `${title}ï¼ˆæ‰£å‡${from_asset_code}ï¼‰`
      }
    },
    { transaction }
  )

  /*
   * æ­¥éª¤ 2ï¼šå¢åŠ ç›®æ ‡èµ„äº§ï¼ˆç”¨æˆ·å®é™…åˆ°è´¦ï¼Œmaterial_convert_creditï¼‰
   */
  const to_result = await AssetService.changeBalance(
    {
      user_id,
      asset_code: to_asset_code,
      delta_amount: actual_received, // ğŸ”¥ æ‰£é™¤æ‰‹ç»­è´¹åçš„å®é™…åˆ°è´¦æ•°é‡
      idempotency_key: `${idempotency_key}:credit`,
      business_type: 'material_convert_credit',
      meta: {
        ...meta,
        title: `${title}ï¼ˆè·å¾—${to_asset_code}ï¼‰`
      }
    },
    { transaction }
  )

  /*
   * æ­¥éª¤ 3ï¼šæ‰‹ç»­è´¹å…¥ç³»ç»Ÿè´¦æˆ·ï¼ˆå¦‚æœæœ‰æ‰‹ç»­è´¹ï¼Œmaterial_convert_feeï¼‰
   */
  let fee_tx_id = null
  if (fee_amount > 0) {
    const fee_asset_code = rule.fee_asset_code || to_asset_code

    // è·å–ç³»ç»Ÿæ‰‹ç»­è´¹è´¦æˆ·
    const systemAccount = await AssetService.getOrCreateAccount(
      { system_code: 'SYSTEM_PLATFORM_FEE' },
      { transaction }
    )

    const fee_result = await AssetService.changeBalance(
      {
        account_id: systemAccount.account_id, // ğŸ”¥ ç›´æ¥ä¼  account_idï¼ˆç³»ç»Ÿè´¦æˆ·ï¼‰
        asset_code: fee_asset_code,
        delta_amount: fee_amount,
        idempotency_key: `${idempotency_key}:fee`,
        business_type: 'material_convert_fee', // ğŸ”¥ æ–°å¢ä¸šåŠ¡ç±»å‹
        meta: {
          ...meta,
          source_user_id: user_id, // è®°å½•æ‰‹ç»­è´¹æ¥æºç”¨æˆ·
          title: `${title}ï¼ˆå¹³å°æ‰‹ç»­è´¹ï¼‰`
        }
      },
      { transaction }
    )

    fee_tx_id = fee_result.transaction_record.transaction_id
  }

  logger.info('âœ… ææ–™è½¬æ¢æˆåŠŸï¼ˆç»Ÿä¸€è´¦æœ¬ä¸‰æ–¹è®°è´¦ï¼‰', {
    user_id,
    from_asset_code,
    to_asset_code,
    from_amount,
    to_amount,
    fee_amount,
    actual_received,
    from_tx_id: from_result.transaction_record.transaction_id,
    to_tx_id: to_result.transaction_record.transaction_id,
    fee_tx_id,
    idempotency_key
  })

  return {
    success: true,
    from_asset_code,
    to_asset_code,
    from_amount,
    to_amount, // è½¬æ¢å¾—åˆ°çš„æ€»æ•°é‡
    fee_amount, // æ‰‹ç»­è´¹æ•°é‡
    actual_received, // å®é™…åˆ°è´¦æ•°é‡
    fee_rate, // æ‰‹ç»­è´¹æ¯”ä¾‹ï¼ˆå‰ç«¯å±•ç¤ºç”¨ï¼‰
    from_tx_id: from_result.transaction_record.transaction_id,
    to_tx_id: to_result.transaction_record.transaction_id,
    fee_tx_id, // æ‰‹ç»­è´¹æµæ°´ ID
    from_balance: from_result.balance.available_amount,
    to_balance: to_result.balance.available_amount,
    is_duplicate: false
  }
}
```

---

### æ”¹é€  3ï¼šå‰ç«¯å“åº”æ ¼å¼å¢å¼ºï¼ˆå±•ç¤ºæŸè€—ï¼‰

**è·¯ç”±å±‚å“åº”æ•°æ®**ï¼ˆ`routes/v4/shop/assets/convert.js` ç¬¬ 223-240 è¡Œæ”¹é€ ï¼‰ï¼š

```javascript
// æ„å»ºå“åº”æ•°æ®ï¼ˆå¢å¼ºç‰ˆï¼šåŒ…å«æ‰‹ç»­è´¹ä¿¡æ¯ï¼‰
const responseData = {
  from_asset_code: result.from_asset_code,
  to_asset_code: result.to_asset_code,
  from_amount: result.from_amount,
  to_amount: result.to_amount, // è½¬æ¢å¾—åˆ°çš„æ€»æ•°é‡
  fee_amount: result.fee_amount || 0, // ğŸ”¥ æ‰‹ç»­è´¹æ•°é‡
  actual_received: result.actual_received, // ğŸ”¥ å®é™…åˆ°è´¦æ•°é‡
  fee_rate: result.fee_rate || 0, // ğŸ”¥ æ‰‹ç»­è´¹æ¯”ä¾‹ï¼ˆå‰ç«¯å±•ç¤ºï¼‰
  from_tx_id: result.from_tx_id,
  to_tx_id: result.to_tx_id,
  fee_tx_id: result.fee_tx_id || null, // ğŸ”¥ æ‰‹ç»­è´¹æµæ°´ ID
  from_balance: result.from_balance,
  to_balance: result.to_balance,
  is_duplicate: result.is_duplicate || false,
  conversion_info: {
    rule_description: `${result.from_amount} ${result.from_asset_code} â†’ ${result.to_amount} ${result.to_asset_code}`,
    rate_description: `è½¬æ¢æ¯”ä¾‹ ${rule.from_amount}:${rule.to_amount}`,
    fee_description:
      result.fee_amount > 0
        ? `æ‰‹ç»­è´¹ ${(result.fee_rate * 100).toFixed(2)}%ï¼ˆ${result.fee_amount} ${result.to_asset_code}ï¼‰`
        : 'æ— æ‰‹ç»­è´¹',
    actual_received_description: `å®é™…åˆ°è´¦ ${result.actual_received} ${result.to_asset_code}`,
    display_icon: rule.display_icon || 'ğŸ’'
  }
}
```

**å‰ç«¯å±•ç¤ºæ•ˆæœ**ï¼ˆå°ç¨‹åº/H5ï¼‰ï¼š

```
è½¬æ¢ææ–™
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æºææ–™ï¼šç¢çº¢æ°´æ™¶ (red_shard)
è½¬æ¢æ•°é‡ï¼š100 ä¸ª
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
è½¬æ¢æ¯”ä¾‹ï¼š1:20
è½¬æ¢å¾—åˆ°ï¼š2000 ğŸ’ é’»çŸ³
æ‰‹ç»­è´¹ï¼š40 ğŸ’ é’»çŸ³ (2%)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å®é™…åˆ°è´¦ï¼š1960 ğŸ’ é’»çŸ³
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[ç¡®è®¤è½¬æ¢]  [å–æ¶ˆ]
```

---

### æ”¹é€  4ï¼šè§„åˆ™æŸ¥è¯¢æ¥å£å¢å¼ºï¼ˆå‰ç«¯åŠ¨æ€å±•ç¤ºï¼‰

**æ”¹é€  `GET /api/v4/shop/assets/conversion-rules` å“åº”**ï¼ˆ`routes/v4/shop/assets/rules.js` ç¬¬ 65-76 è¡Œï¼‰ï¼š

```javascript
// è½¬æ¢ä¸ºå‰ç«¯éœ€è¦çš„æ ¼å¼ï¼ˆå¢å¼ºç‰ˆï¼‰
const rules = dbRules.map(rule => ({
  rule_id: rule.rule_id,
  from_asset_code: rule.from_asset_code,
  to_asset_code: rule.to_asset_code,
  from_amount: rule.from_amount,
  to_amount: rule.to_amount,
  conversion_rate: `${rule.from_amount}:${rule.to_amount}`,

  // ğŸ”¥ æ‰‹ç»­è´¹ä¿¡æ¯ï¼ˆå‰ç«¯å±•ç¤ºæŸè€—ï¼‰
  fee_rate: parseFloat(rule.fee_rate || 0),
  fee_rate_display: `${(parseFloat(rule.fee_rate || 0) * 100).toFixed(2)}%`,
  fee_min_amount: rule.fee_min_amount || 0,
  has_fee: parseFloat(rule.fee_rate || 0) > 0,

  // ğŸ”¥ æ•°é‡é™åˆ¶ï¼ˆå‰ç«¯è¡¨å•æ ¡éªŒï¼‰
  min_from_amount: rule.min_from_amount || 1,
  max_from_amount: rule.max_from_amount || null,

  // ğŸ”¥ å±•ç¤ºä¿¡æ¯ï¼ˆå‰ç«¯ UIï¼‰
  title:
    rule.title ||
    `${rule.from_amount} ${rule.from_asset_code} â†’ ${rule.to_amount} ${rule.to_asset_code}`,
  description: rule.description || `è½¬æ¢æ¯”ä¾‹ ${rule.from_amount}:${rule.to_amount}`,
  display_icon: rule.display_icon || 'ğŸ’',
  risk_level: rule.risk_level || 'low',

  // å–æ•´è§„åˆ™ï¼ˆå‰ç«¯æç¤ºï¼‰
  rounding_mode: rule.rounding_mode || 'floor',
  rounding_description: getRoundingDescription(rule.rounding_mode),

  effective_at: rule.effective_at,
  enabled: rule.is_enabled
}))

// å–æ•´è§„åˆ™è¯´æ˜
function getRoundingDescription(mode) {
  const descriptions = {
    floor: 'å‘ä¸‹å–æ•´ï¼ˆä¸è¶³1ä¸ªèˆå»ï¼‰',
    ceil: 'å‘ä¸Šå–æ•´ï¼ˆä¸è¶³1ä¸ªæŒ‰1ä¸ªè®¡ï¼‰',
    round: 'å››èˆäº”å…¥',
    exact: 'å¿…é¡»æ•´é™¤ï¼ˆå¦åˆ™æ‹’ç»è½¬æ¢ï¼‰'
  }
  return descriptions[mode] || 'å‘ä¸‹å–æ•´'
}
```

---

## ğŸ›ï¸ è¿è¥é…ç½®ç¤ºä¾‹ï¼ˆåŠ¨æ€è°ƒæ•´æŸè€—æ¯”ä¾‹ï¼‰

### åœºæ™¯ 1ï¼šæ–°å¢è½¬æ¢ç±»å‹ï¼ˆå®Œæ•´çº¢æ°´æ™¶ â†’ é’»çŸ³ï¼Œæ— æŸè€—ï¼‰

```sql
-- æ’å…¥æ–°è§„åˆ™ï¼ˆä¸æ”¹ä»£ç ï¼‰
INSERT INTO material_conversion_rules (
  from_asset_code, to_asset_code, from_amount, to_amount,
  fee_rate, fee_min_amount, fee_asset_code,
  min_from_amount, max_from_amount,
  title, description, display_icon,
  rounding_mode, risk_level, is_visible, is_enabled,
  effective_at, created_at, updated_at
) VALUES (
  'red_crystal', 'DIAMOND', 1, 100,
  0.0000, 0, NULL, -- æ— æ‰‹ç»­è´¹
  1, 50, -- æœ€å°‘1ä¸ªï¼Œæœ€å¤š50ä¸ª
  'å®Œæ•´çº¢æ°´æ™¶è½¬é’»çŸ³', 'é«˜ä»·å€¼ææ–™ï¼Œæ— æŸè€—è½¬æ¢', 'ğŸ’',
  'floor', 'low', 1, 1,
  NOW(), NOW(), NOW()
);
```

### åœºæ™¯ 2ï¼šè°ƒæ•´ç°æœ‰è§„åˆ™çš„æ‰‹ç»­è´¹ï¼ˆåŠ¨æ€è°ƒæ•´æŸè€—ï¼‰

```sql
-- è°ƒæ•´ red_shard â†’ DIAMOND çš„æ‰‹ç»­è´¹ä» 0% â†’ 2%
UPDATE material_conversion_rules
SET
  fee_rate = 0.0200, -- 2% æ‰‹ç»­è´¹
  fee_min_amount = 10, -- æœ€ä½æ”¶ 10 ä¸ªé’»çŸ³
  fee_asset_code = 'DIAMOND',
  updated_at = NOW(),
  updated_by = 1 -- è®°å½•æ“ä½œäºº
WHERE rule_id = 1;

-- æˆ–è€…ï¼šç‰ˆæœ¬åŒ–ç®¡ç†ï¼ˆæ¨èï¼Œä¿ç•™å†å²ï¼‰
-- ç¦ç”¨æ—§è§„åˆ™
UPDATE material_conversion_rules
SET is_enabled = 0, updated_at = NOW()
WHERE rule_id = 1;

-- æ–°å¢æ–°è§„åˆ™ï¼ˆæ–°è´¹ç‡ï¼‰
INSERT INTO material_conversion_rules (
  from_asset_code, to_asset_code, from_amount, to_amount,
  fee_rate, fee_min_amount, fee_asset_code,
  min_from_amount, max_from_amount,
  title, description, display_icon,
  rounding_mode, risk_level, is_visible, is_enabled,
  effective_at, created_at, updated_at
) VALUES (
  'red_shard', 'DIAMOND', 1, 20,
  0.0200, 10, 'DIAMOND', -- 2% æ‰‹ç»­è´¹ï¼Œæœ€ä½ 10 ä¸ª
  1, NULL,
  'ç¢çº¢æ°´æ™¶åˆ†è§£ä¸ºé’»çŸ³', 'è½¬æ¢æ¯”ä¾‹ 1:20ï¼Œæ‰‹ç»­è´¹ 2%', 'ğŸ’',
  'floor', 'low', 1, 1,
  NOW(), NOW(), NOW()
);
```

### åœºæ™¯ 3ï¼šé«˜çº§ææ–™å¸¦é«˜æŸè€—ï¼ˆé˜²å¥—åˆ©ï¼‰

```sql
-- ç¨€æœ‰ææ–™è½¬æ¢ï¼ˆé«˜æ‰‹ç»­è´¹ï¼‰
INSERT INTO material_conversion_rules (
  from_asset_code, to_asset_code, from_amount, to_amount,
  fee_rate, fee_min_amount, fee_asset_code,
  min_from_amount, max_from_amount,
  title, description, display_icon,
  rounding_mode, risk_level, is_visible, is_enabled,
  effective_at, created_at, updated_at
) VALUES (
  'rare_gem', 'DIAMOND', 1, 500,
  0.1000, 50, 'DIAMOND', -- 10% æ‰‹ç»­è´¹ï¼Œæœ€ä½ 50 ä¸ª
  1, 10, -- æœ€å°‘1ä¸ªï¼Œæœ€å¤š10ä¸ªï¼ˆé™åˆ¶å¤§é¢ï¼‰
  'ç¨€æœ‰å®çŸ³è½¬é’»çŸ³', 'é«˜ä»·å€¼ææ–™ï¼Œ10%å¹³å°æŸè€—', 'ğŸ’ ',
  'floor', 'high', 1, 1,
  NOW(), NOW(), NOW()
);
```

### åœºæ™¯ 4ï¼šç°åº¦æµ‹è¯•ï¼ˆè§„åˆ™å­˜åœ¨ä½†ä¸å±•ç¤ºï¼‰

```sql
-- å†…æµ‹è§„åˆ™ï¼ˆis_visible=0ï¼‰
INSERT INTO material_conversion_rules (
  from_asset_code, to_asset_code, from_amount, to_amount,
  fee_rate, fee_min_amount,
  title, description, display_icon,
  rounding_mode, risk_level, is_visible, is_enabled, -- is_visible=0
  effective_at, created_at, updated_at
) VALUES (
  'test_material', 'DIAMOND', 1, 10,
  0.0500, 5,
  'æµ‹è¯•ææ–™è½¬é’»çŸ³', 'å†…æµ‹ä¸“ç”¨ï¼Œ5%æ‰‹ç»­è´¹', 'ğŸ§ª',
  'floor', 'medium', 0, 1, -- å¯ç”¨ä½†ä¸å¯è§
  NOW(), NOW(), NOW()
);

-- ç‰¹å®šç”¨æˆ·å¯é€šè¿‡ç›´æ¥è°ƒç”¨ APIï¼ˆä¼ å‚ï¼‰è®¿é—®ï¼Œå‰ç«¯åˆ—è¡¨ä¸å±•ç¤º
```

---

## ğŸ“Š ä¸šåŠ¡ç±»å‹æ‰©å±•ï¼ˆæ”¯æŒæ‰‹ç»­è´¹è®°è´¦ï¼‰

### æ–°å¢ä¸šåŠ¡ç±»å‹å¸¸é‡

åœ¨ `models/AssetTransaction.js` çš„ `BUSINESS_TYPES` ä¸­è¿½åŠ ï¼š

```javascript
static BUSINESS_TYPES = {
  // ... ç°æœ‰ç±»å‹ ...

  // ææ–™è½¬æ¢ç›¸å…³ï¼ˆMaterial Conversion - ææ–™â†’DIAMONDï¼Œæ”¯æŒæ‰‹ç»­è´¹ï¼‰
  MATERIAL_CONVERT_DEBIT: 'material_convert_debit', // ææ–™è½¬æ¢æ‰£å‡
  MATERIAL_CONVERT_CREDIT: 'material_convert_credit', // ææ–™è½¬æ¢å…¥è´¦ï¼ˆç”¨æˆ·å®é™…åˆ°è´¦ï¼‰
  MATERIAL_CONVERT_FEE: 'material_convert_fee', // ğŸ”¥ ææ–™è½¬æ¢æ‰‹ç»­è´¹ï¼ˆå…¥ç³»ç»Ÿè´¦æˆ·ï¼‰

  // ... å…¶ä»–ç±»å‹ ...
}
```

---

## ğŸ” å¯¹è´¦ä¸å®¡è®¡æ”¯æŒ

### æ‰‹ç»­è´¹å¯¹è´¦æŸ¥è¯¢

```sql
-- æŸ¥è¯¢æŸæ—¶é—´æ®µå†…çš„è½¬æ¢æ‰‹ç»­è´¹æ”¶å…¥ï¼ˆç³»ç»Ÿè´¦æˆ·ç»´åº¦ï¼‰
SELECT
  DATE(t.created_at) AS date,
  t.asset_code,
  SUM(t.delta_amount) AS total_fee,
  COUNT(*) AS conversion_count
FROM asset_transactions t
JOIN accounts a ON a.account_id = t.account_id
WHERE
  a.account_type = 'system'
  AND a.system_code = 'SYSTEM_PLATFORM_FEE'
  AND t.business_type = 'material_convert_fee'
  AND t.created_at >= '2026-01-01'
  AND t.created_at < '2026-02-01'
GROUP BY DATE(t.created_at), t.asset_code
ORDER BY date DESC, asset_code;

-- æŸ¥è¯¢ç”¨æˆ·è½¬æ¢å†å²ï¼ˆå«æ‰‹ç»­è´¹æ˜ç»†ï¼‰
SELECT
  t.transaction_id,
  t.created_at,
  t.asset_code,
  t.delta_amount,
  t.business_type,
  t.idempotency_key,
  JSON_EXTRACT(t.meta, '$.from_asset_code') AS from_asset,
  JSON_EXTRACT(t.meta, '$.to_asset_code') AS to_asset,
  JSON_EXTRACT(t.meta, '$.fee_amount') AS fee_amount,
  JSON_EXTRACT(t.meta, '$.actual_received') AS actual_received
FROM asset_transactions t
JOIN accounts a ON a.account_id = t.account_id
WHERE
  a.user_id = 123
  AND t.business_type IN ('material_convert_debit', 'material_convert_credit', 'material_convert_fee')
ORDER BY t.transaction_id DESC
LIMIT 20;
```

---

## ğŸ“‹ å®æ–½æ£€æŸ¥æ¸…å•ï¼ˆåˆ†é˜¶æ®µè½åœ°ï¼‰

### P0 - ç«‹å³å¯åšï¼ˆä¸æ”¹ä»£ç ï¼Œé™è¿ç»´æˆæœ¬ï¼‰

- [ ] ç¡®è®¤ç³»ç»Ÿè´¦æˆ· `SYSTEM_PLATFORM_FEE` å·²åˆ›å»º
- [ ] ç¡®è®¤ç³»ç»Ÿè´¦æˆ·å·²æœ‰ `DIAMOND` ä½™é¢è®°å½•ï¼ˆç”¨äºæ”¶æ‰‹ç»­è´¹ï¼‰
- [ ] ä¸ºç°æœ‰è§„åˆ™è¡¥å…… `title/description`ï¼ˆæ”¹å–„å‰ç«¯å±•ç¤ºï¼‰
- [ ] è®¾ç½®åˆç†çš„ `min_from_amount`ï¼ˆé˜²æ­¢å°é¢åˆ·æ¥å£ï¼‰

### P1 - æ ¸å¿ƒæ”¹é€ ï¼ˆé™è¿­ä»£æˆæœ¬ï¼Œæ”¯æŒæ‰©å±•ï¼‰

- [ ] **æ”¹é€  1**ï¼šå¹‚ç­‰å›æ”¾ä»"æ‰«æ"æ”¹"ç‚¹æŸ¥"ï¼ˆ`AssetService.getTransactionByIdempotencyKey`ï¼‰
- [ ] **æ”¹é€  2**ï¼šè·¯ç”±å±‚ç§»é™¤ç¡¬ç¼–ç ï¼Œæ”¹ä¸ºè§„åˆ™é©±åŠ¨ï¼ˆåˆ é™¤ `if (from_asset_code !== 'red_shard')` åˆ¤æ–­ï¼‰
- [ ] **æ”¹é€  3**ï¼šæœåŠ¡å±‚æ”¯æŒæŸè€—æ¨¡å‹ï¼ˆä¸‰æ–¹è®°è´¦ï¼šdebit + credit + feeï¼‰
- [ ] **æ”¹é€  4**ï¼šå‰ç«¯å“åº”æ ¼å¼å¢å¼ºï¼ˆè¿”å› `fee_amount/actual_received/fee_rate`ï¼‰

### P2 - è¿è¥èƒ½åŠ›å¢å¼ºï¼ˆé™é…ç½®æˆæœ¬ï¼‰

- [ ] è§„åˆ™æŸ¥è¯¢æ¥å£è¿”å›æ‰‹ç»­è´¹/é™åˆ¶/å±•ç¤ºä¿¡æ¯ï¼ˆå‰ç«¯åŠ¨æ€æ¸²æŸ“ï¼‰
- [ ] ç®¡ç†åå°æ”¯æŒè§„åˆ™ CRUDï¼ˆ`/api/v4/console/material/conversion-rules`ï¼‰
- [ ] è§„åˆ™ç‰ˆæœ¬åŒ–ç®¡ç†ï¼ˆæ–°å¢è§„åˆ™è€Œéä¿®æ”¹æ—§è§„åˆ™ï¼Œä¿ç•™å†å²ï¼‰
- [ ] æ‰‹ç»­è´¹æ”¶å…¥ç»Ÿè®¡æŠ¥è¡¨ï¼ˆç³»ç»Ÿè´¦æˆ·ç»´åº¦ï¼‰

### P3 - é•¿æœŸä¼˜åŒ–ï¼ˆé™æ’éšœæˆæœ¬ï¼‰

- [ ] è½¬æ¢æµæ°´ç›‘æ§å‘Šè­¦ï¼ˆå¼‚å¸¸å¤§é¢ã€é¢‘ç¹è½¬æ¢ã€æ‰‹ç»­è´¹å¼‚å¸¸ï¼‰
- [ ] è§„åˆ™ç”Ÿæ•ˆæ—¶é—´è‡ªåŠ¨åˆ‡æ¢ï¼ˆå®šæ—¶ä»»åŠ¡æ‰«æ `effective_at`ï¼‰
- [ ] è½¬æ¢é™é¢æ§åˆ¶ï¼ˆç”¨æˆ·ç»´åº¦æ—¥/å‘¨/æœˆé™é¢ï¼‰
- [ ] A/B æµ‹è¯•æ”¯æŒï¼ˆä¸åŒç”¨æˆ·ç¾¤ä½“ä¸åŒè´¹ç‡ï¼‰

---

## ğŸ¯ ç»´æŠ¤æˆæœ¬å¯¹æ¯”ï¼ˆæ”¹é€ å‰ vs æ”¹é€ åï¼‰

| è¿è¥åœºæ™¯       | æ”¹é€ å‰               | æ”¹é€ å                                     | æˆæœ¬é™ä½   |
| -------------- | -------------------- | ------------------------------------------ | ---------- |
| æ–°å¢è½¬æ¢ç±»å‹   | æ”¹è·¯ç”±ç¡¬ç¼–ç  + å‘ç‰ˆ  | æ’å…¥ DB è§„åˆ™                               | **90%**    |
| è°ƒæ•´è½¬æ¢æ¯”ä¾‹   | æ”¹ DB + å¯èƒ½æ”¹ä»£ç    | ä»…æ”¹ DBï¼ˆæˆ–æ–°å¢è§„åˆ™ï¼‰                      | **70%**    |
| è°ƒæ•´æ‰‹ç»­è´¹æ¯”ä¾‹ | æ”¹ä»£ç  + å‘ç‰ˆ        | ä»…æ”¹ DB `fee_rate`                         | **95%**    |
| åŠŸèƒ½ä¸Šä¸‹çº¿     | åˆ æ–‡ä»¶/æ”¹ä»£ç  + å‘ç‰ˆ | æ”¹ DB `is_enabled`                         | **95%**    |
| ç°åº¦æµ‹è¯•       | æ”¹ä»£ç  + å‘ç‰ˆ        | æ”¹ DB `is_visible`                         | **90%**    |
| æ’æŸ¥è½¬æ¢é—®é¢˜   | ç¿»ä»£ç +æ—¥å¿—          | æŸ¥ `asset_transactions` æŒ‰ `business_type` | **60%**    |
| æ‰‹ç»­è´¹å¯¹è´¦     | æ— ï¼ˆéœ€å¼€å‘ï¼‰         | æŸ¥ç³»ç»Ÿè´¦æˆ·æµæ°´                             | **æ–°èƒ½åŠ›** |

**ç»¼åˆç»´æŠ¤æˆæœ¬é™ä½é¢„ä¼°**ï¼š**75-85%**ï¼ˆå¤§éƒ¨åˆ†è¿è¥éœ€æ±‚ä¸å†éœ€è¦å‘ç‰ˆï¼‰

---

## ğŸš€ æœ€å°å¯è¡Œå®æ–½è·¯å¾„ï¼ˆMVPï¼‰

### ç¬¬ä¸€æ­¥ï¼šæ•°æ®åº“è¿ç§»ï¼ˆæ‰©å±•è§„åˆ™è¡¨ï¼‰

```bash
# åˆ›å»ºè¿ç§»æ–‡ä»¶
npm run migration:create add-conversion-rule-fee-and-limits

# ç¼–è¾‘è¿ç§»æ–‡ä»¶ï¼ˆmigrations/YYYYMMDDHHMMSS-add-conversion-rule-fee-and-limits.jsï¼‰
# å†…å®¹ï¼šä¸Šé¢çš„ ALTER TABLE è¯­å¥

# æ‰§è¡Œè¿ç§»
npm run db:migrate
```

### ç¬¬äºŒæ­¥ï¼šæœåŠ¡å±‚æ”¹é€ ï¼ˆæ”¯æŒæ‰‹ç»­è´¹ä¸‰æ–¹è®°è´¦ï¼‰

æ”¹é€ æ–‡ä»¶ï¼š`services/AssetConversionService.js`

- æ–°å¢ `AssetService.getTransactionByIdempotencyKey()` è¾…åŠ©æ–¹æ³•
- æ”¹é€  `convertMaterial()` æ–¹æ³•ï¼š
  - å¹‚ç­‰å›æ”¾æ”¹ç‚¹æŸ¥
  - è®¡ç®—æ‰‹ç»­è´¹
  - ä¸‰æ–¹è®°è´¦ï¼ˆdebit + credit + feeï¼‰

### ç¬¬ä¸‰æ­¥ï¼šè·¯ç”±å±‚æ”¹é€ ï¼ˆç§»é™¤ç¡¬ç¼–ç ï¼‰

æ”¹é€ æ–‡ä»¶ï¼š`routes/v4/shop/assets/convert.js`

- åˆ é™¤ `if (from_asset_code !== 'red_shard')` ç¡¬ç¼–ç åˆ¤æ–­
- å¢å¼ºå“åº”æ•°æ®ï¼ˆåŒ…å«æ‰‹ç»­è´¹ä¿¡æ¯ï¼‰

æ”¹é€ æ–‡ä»¶ï¼š`routes/v4/shop/assets/rules.js`

- å¢å¼ºè§„åˆ™æŸ¥è¯¢å“åº”ï¼ˆåŒ…å«æ‰‹ç»­è´¹/é™åˆ¶/å±•ç¤ºä¿¡æ¯ï¼‰

### ç¬¬å››æ­¥ï¼šè¡¥å……ç°æœ‰è§„åˆ™æ•°æ®ï¼ˆå®Œå–„é…ç½®ï¼‰

```sql
-- ä¸ºç°æœ‰è§„åˆ™è¡¥å……æ‰©å±•å­—æ®µ
UPDATE material_conversion_rules
SET
  min_from_amount = 1,
  max_from_amount = 1000,
  fee_rate = 0.0000, -- æš‚ä¸æ”¶è´¹
  fee_min_amount = 0,
  title = 'ç¢çº¢æ°´æ™¶åˆ†è§£ä¸ºé’»çŸ³',
  description = 'è½¬æ¢æ¯”ä¾‹ 1:20ï¼Œæ— æ‰‹ç»­è´¹',
  display_icon = 'ğŸ’',
  rounding_mode = 'floor',
  risk_level = 'low',
  is_visible = 1
WHERE rule_id = 1;
```

### ç¬¬äº”æ­¥ï¼šéªŒè¯ä¸ç›‘æ§

```bash
# 1. éªŒè¯è§„åˆ™æŸ¥è¯¢æ¥å£
curl -H "Authorization: Bearer <token>" \
  http://localhost:3000/api/v4/shop/assets/conversion-rules

# 2. æµ‹è¯•è½¬æ¢æ¥å£ï¼ˆå°é¢ï¼‰
curl -X POST http://localhost:3000/api/v4/shop/assets/convert \
  -H "Authorization: Bearer <token>" \
  -H "Idempotency-Key: test_convert_$(date +%s)" \
  -H "Content-Type: application/json" \
  -d '{
    "from_asset_code": "red_shard",
    "to_asset_code": "DIAMOND",
    "from_amount": 10
  }'

# 3. éªŒè¯æ‰‹ç»­è´¹å…¥è´¦ï¼ˆæŸ¥ç³»ç»Ÿè´¦æˆ·æµæ°´ï¼‰
node <<'NODE'
require('dotenv').config()
const { sequelize } = require('./models')
;(async () => {
  const [rows] = await sequelize.query(`
    SELECT t.*, a.system_code
    FROM asset_transactions t
    JOIN accounts a ON a.account_id = t.account_id
    WHERE a.account_type='system'
      AND t.business_type='material_convert_fee'
    ORDER BY t.transaction_id DESC
    LIMIT 5
  `)
  console.log(JSON.stringify(rows, null, 2))
  await sequelize.close()
})()
NODE
```

---

## ğŸ” é£é™©æ§åˆ¶ä¸å®‰å…¨å»ºè®®

### é˜²å¥—åˆ©æœºåˆ¶

- **æ•°é‡é™åˆ¶**ï¼š`max_from_amount` é™åˆ¶å•æ¬¡è½¬æ¢ä¸Šé™
- **é¢‘ç‡é™åˆ¶**ï¼šåœ¨ `IdempotencyService` å±‚å¯åŠ ç”¨æˆ·ç»´åº¦æ—¥è½¬æ¢æ¬¡æ•°é™åˆ¶
- **æ‰‹ç»­è´¹é˜¶æ¢¯**ï¼šé«˜ä»·å€¼ææ–™è®¾ç½®æ›´é«˜ `fee_rate`
- **å®¡è®¡å‘Šè­¦**ï¼šç›‘æ§å¼‚å¸¸å¤§é¢è½¬æ¢ã€é¢‘ç¹è½¬æ¢ç”¨æˆ·

### ç°åº¦ä¸å›æ»š

- **ç°åº¦ä¸Šçº¿**ï¼šæ–°è§„åˆ™å…ˆ `is_visible=0`ï¼Œå†…æµ‹é€šè¿‡åæ”¹ä¸º 1
- **ç´§æ€¥ä¸‹çº¿**ï¼š`is_enabled=0` ç«‹å³ç”Ÿæ•ˆï¼Œä¸éœ€è¦å‘ç‰ˆ
- **ç‰ˆæœ¬å›é€€**ï¼šç¦ç”¨æ–°è§„åˆ™ï¼Œå¯ç”¨æ—§è§„åˆ™ï¼ˆé€šè¿‡ `effective_at` æ§åˆ¶ï¼‰

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### ç»´æŠ¤æˆæœ¬é™ä½

- **ä»£ç æ”¹åŠ¨é¢‘ç‡**ï¼šä»"æ¯æ¬¡æ–°å¢è½¬æ¢éƒ½æ”¹ä»£ç "é™åˆ°"åŸºæœ¬ä¸æ”¹ä»£ç "
- **å‘ç‰ˆé¢‘ç‡**ï¼šè½¬æ¢ç›¸å…³è¿è¥éœ€æ±‚ä¸å†éœ€è¦å‘ç‰ˆ
- **é…ç½®å¤æ‚åº¦**ï¼šé›†ä¸­åœ¨ DB è§„åˆ™è¡¨ï¼Œè¿è¥/è¿ç»´å¯ç›´æ¥æ“ä½œ

### åŠŸèƒ½æ‰©å±•æ€§

- **æ”¯æŒä»»æ„ææ–™ â†” ä»»æ„ç›®æ ‡èµ„äº§**ï¼ˆå¤šå¯¹å¤šï¼‰
- **æ”¯æŒåŠ¨æ€è°ƒæ•´æ‰‹ç»­è´¹æ¯”ä¾‹**ï¼ˆè¿è¥å®æ—¶è°ƒæ•´ï¼‰
- **æ”¯æŒç°åº¦/AB æµ‹è¯•**ï¼ˆ`is_visible` æ§åˆ¶ï¼‰
- **æ”¯æŒç‰ˆæœ¬åŒ–ç®¡ç†**ï¼ˆ`effective_at` æ—¶é—´æ—…è¡Œï¼‰

### ç³»ç»Ÿç¨³å®šæ€§

- **å¹‚ç­‰æ€§èƒ½ä¼˜åŒ–**ï¼šç‚¹æŸ¥ä»£æ›¿æ‰«æï¼Œæ”¯æŒç™¾ä¸‡çº§æµæ°´
- **æ‰‹ç»­è´¹å¯¹è´¦å®Œæ•´**ï¼šç³»ç»Ÿè´¦æˆ·ç‹¬ç«‹è®°è´¦ï¼Œå®¡è®¡æ¸…æ™°
- **è§„åˆ™éš”ç¦»**ï¼šå•æ¡è§„åˆ™å¼‚å¸¸ä¸å½±å“å…¶ä»–è½¬æ¢

---

## ğŸ“ æ ¸å¿ƒè®¾è®¡ç†å¿µ

1. **é…ç½®å³ä»£ç **ï¼šè§„åˆ™è¡¨æ˜¯è½¬æ¢èƒ½åŠ›çš„"çœŸç›¸æº"ï¼Œä»£ç åªæ˜¯æ‰§è¡Œå™¨
2. **ä¸‰æ–¹è®°è´¦**ï¼šç”¨æˆ·æ‰£å‡ + ç”¨æˆ·å…¥è´¦ + ç³»ç»Ÿæ‰‹ç»­è´¹ï¼Œè´¦ç›®æ¸…æ™°å¯å®¡è®¡
3. **è¿è¥è‡ªä¸»**ï¼š90% çš„è¿è¥éœ€æ±‚é€šè¿‡æ”¹æ•°æ®å®Œæˆï¼Œä¸ä¾èµ–ç ”å‘æ’æœŸ
4. **æ€§èƒ½ä¼˜å…ˆ**ï¼šåˆ©ç”¨ DB çº¦æŸï¼ˆå”¯ä¸€ç´¢å¼•ï¼‰åšå¹‚ç­‰ï¼Œé¿å…åº”ç”¨å±‚æ‰«æ
5. **å‘åå…¼å®¹**ï¼šæ”¹é€ åç°æœ‰è½¬æ¢é€»è¾‘ä¸å—å½±å“ï¼Œå¹³æ»‘å‡çº§

---

**ç»“è®º**ï¼šä¿ç•™ `AssetConversionService`ï¼Œä½†è®©å®ƒå˜æˆ"è–„è–„çš„è§„åˆ™é©±åŠ¨ç¼–æ’å±‚"ï¼Œåº•å±‚è´¦æœ¬/æ‰‹ç»­è´¹/å¹‚ç­‰å…¨éƒ¨æ ‡å‡†åŒ–ï¼Œæœªæ¥æ‰©å±•ææ–™è½¬æ¢åŸºæœ¬é›¶ä»£ç æ”¹åŠ¨ã€‚
