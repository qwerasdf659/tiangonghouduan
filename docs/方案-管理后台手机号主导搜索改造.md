# ç®¡ç†åå°ã€Œæ‰‹æœºå·ä¸»å¯¼æœç´¢ã€æ”¹é€ æ–¹æ¡ˆ

## å·¥ä½œå†…å®¹æ€»è§ˆ

### åç«¯ï¼ˆNode.js + Express + Sequelize + MySQLï¼‰

| é¡¹ | æ–‡ä»¶ | å·¥ä½œ |
|---|---|---|
| 1 | `routes/v4/console/user_management.js` | æ–°å¢ `GET /users/resolve?mobile=xxx` è·¯ç”±ï¼ˆçº¦ 40 è¡Œï¼‰ |

- å¤ç”¨ `UserService.findByMobile()`ï¼ˆå·²æœ‰ Redis ç¼“å­˜ï¼Œé›¶æ–°å¢ Service/Model/ä¸­é—´ä»¶ï¼‰
- æŸ¥è¯¢ï¼š`users.mobile` UNIQUE INDEX ç²¾ç¡®åŒ¹é…
- æƒé™ï¼š`authenticateToken` + `requireRoleLevel(100)` å·²å…¨å±€æŒ‚è½½
- å“åº”ï¼šæ ‡å‡† `ApiResponse`ï¼ˆ`res.apiSuccess` / `res.apiError`ï¼‰

### å‰ç«¯ï¼ˆVite + Alpine.js + Tailwind CSSï¼‰

| é¡¹ | æ–‡ä»¶ | å·¥ä½œ |
|---|---|---|
| 1 | `admin/src/alpine/mixins/user-resolver.js` | **æ–°å»º** userResolverMixinï¼ˆçº¦ 80 è¡Œï¼‰ |
| 2 | `admin/src/alpine/mixins/index.js` | **ä¿®æ”¹** æ³¨å†Œ mixinï¼Œ`createPageMixin` æ–°å¢ `userResolver` é…ç½®é¡¹ |
| 3 | `admin/src/api/user.js` | **ä¿®æ”¹** æ–°å¢ `RESOLVE` ç«¯ç‚¹ + `resolveUser()` æ–¹æ³• |
| 4 | `finance-management.html` + JS | **æ”¹é€ ** 4 å¤„ user_id è¾“å…¥æ¡† â†’ æ‰‹æœºå· |
| 5 | `asset-management.html` + JS | **æ”¹é€ ** 4 å¤„ |
| 6 | `lottery-management.html` + JS | **æ”¹é€ ** 3 å¤„ï¼ˆå«æ‰¹é‡æ‰‹æœºå·ï¼‰ |
| 7 | `asset-adjustment.html` + JS | **æ”¹é€ ** 1 å¤„ï¼ˆè§„èŒƒåŒ–å·²æœ‰çš„ searchMobileï¼‰ |
| 8 | `assets-portfolio.html` + JS | **æ”¹é€ ** 1 å¤„ |
| 9 | `user-management.html` + JS | **æ”¹é€ ** 3 å¤„ |
| 10 | `trade-management.html` + JS | **æ”¹é€ ** 2 å¤„ï¼ˆä¹°å®¶/å–å®¶ç‹¬ç«‹è§£æï¼‰ |
| 11 | `sessions.html` + JS | **æ”¹é€ ** 1 å¤„ |
| 12 | `user-hierarchy.html` + JS | **æ”¹é€ ** 2 å¤„ |

**åˆè®¡**ï¼šåç«¯ 1 ä¸ªæ–‡ä»¶ ~40 è¡Œ | å‰ç«¯ 3 ä¸ªåŸºç¡€æ–‡ä»¶ + 9 ä¸ªé¡µé¢å…± 21 ä¸ªæ”¹é€ ç‚¹ | é¢„ä¼° 2.5 å¤©

---

## 1. èƒŒæ™¯ä¸å†³ç­–

### 1.1 ç°çŠ¶é—®é¢˜

ç®¡ç†åå° **9 ä¸ª HTML é¡µé¢ã€23 ä¸ªæœç´¢/è¾“å…¥æ¡†**è¦æ±‚è¿è¥äººå‘˜è¾“å…¥"ç”¨æˆ·ID"ï¼ˆæ•°æ®åº“è‡ªå¢ä¸»é”®ï¼‰ã€‚

è¿è¥äººå‘˜ä¸å¯èƒ½çŸ¥é“ç”¨æˆ·çš„å†…éƒ¨ IDã€‚å®é™…åœºæ™¯ä¸­ï¼Œé¤å…åº—å‘˜å’Œé¡¾å®¢çš„äº¤äº’çº½å¸¦æ˜¯**æ‰‹æœºå·**â€”â€”ç•™æ‰‹æœºå·åŠä¼šå‘˜ã€å¾®ä¿¡æˆæƒæ‰‹æœºå·ç™»å½•ã€æ¥å®¢è¯‰ç”µè¯ã€‚

### 1.2 è¡Œä¸šå¯¹æ ‡

æœ¬é¡¹ç›®å±äºã€Œå¾®ä¿¡å°ç¨‹åº + é¤é¥®æœ¬åœ°ç”Ÿæ´»ã€ç±»å‹ï¼Œä¸ä»¥ä¸‹äº§å“åŒç±»ï¼š

| äº§å“ | ç®¡ç†ç«¯æœç´¢æ–¹å¼ |
|---|---|
| ç¾å›¢å•†å®¶ç‰ˆ | æ‰‹æœºå· |
| å®¢å¦‚äº‘ / äºŒç»´ç« | æ‰‹æœºå· |
| å°ç¨‹åºæ´»åŠ¨å¹³å° | æ‰‹æœºå· |
| å¤§ä¼—ç‚¹è¯„å•†å®¶ä¸­å¿ƒ | æ‰‹æœºå· |

**ç»“è®º**ï¼šæ‰‹æœºå·ä¸»å¯¼æ˜¯æœ¬ç±»å‹é¡¹ç›®çš„è¡Œä¸šæ ‡å‡†åšæ³•ã€‚

### 1.3 å†³ç­–

- **å”¯ä¸€æœç´¢æ ‡è¯†**ï¼šæ‰‹æœºå·ï¼ˆç²¾ç¡®åŒ¹é…ï¼Œ`users.mobile` UNIQUE INDEXï¼‰
- **ä¸åšæ˜µç§°æœç´¢**ï¼šå†³ç­– 1 å·²ç¡®è®¤ï¼Œæ˜µç§°å¯èƒ½ä¸ºç©ºï¼Œä¸ä½œä¸ºæœç´¢å…¥å£
- **å½»åº•ç§»é™¤**ï¼šæ‰€æœ‰"ç”¨æˆ·ID"æœç´¢è¾“å…¥æ¡†
- **user_id å®šä½**ï¼šä»…åœ¨è¡¨æ ¼ä¸­ä½œä¸ºåªè¯»å‚è€ƒåˆ—æ˜¾ç¤ºï¼Œä¸ä½œä¸ºæœç´¢å…¥å£

### 1.4 æ•°æ®åº“ç°çŠ¶éªŒè¯

é€šè¿‡è¿æ¥çœŸå®æ•°æ®åº“ç¡®è®¤ï¼š

| æŒ‡æ ‡ | å€¼ |
|---|---|
| ç”¨æˆ·æ€»æ•° | 59 |
| æ‰‹æœºå·å”¯ä¸€æ•° | 59ï¼ˆ100% è¦†ç›–ï¼Œæ— ç©ºå€¼ï¼‰ |
| æ´»è·ƒç”¨æˆ· | 59ï¼ˆå…¨éƒ¨ activeï¼‰ |
| mobile å­—æ®µ | `varchar(20), NOT NULL, UNIQUE INDEX` |
| nickname å­—æ®µ | `varchar(50), NULL`ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰ |

**ç»“è®º**ï¼šmobile å­—æ®µ 100% æœ‰å€¼ä¸”æœ‰å”¯ä¸€ç´¢å¼•ï¼Œé€‚åˆä½œä¸ºä¸»æœç´¢æ ‡è¯†ã€‚

---

## 2. é¡¹ç›®æŠ€æœ¯æ ˆç°çŠ¶ï¼ˆåŸºäºå®é™…ä»£ç å®¡æŸ¥ï¼‰

### 2.1 åç«¯æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯ | ç‰ˆæœ¬ |
|---|---|---|
| è¿è¡Œæ—¶ | Node.js | â‰¥ 20.18.0 |
| æ¡†æ¶ | Express | 4.18.2 |
| ORM | Sequelize | 6.35.2 |
| æ•°æ®åº“ | MySQLï¼ˆmysql2 é©±åŠ¨ï¼‰ | 3.6.5 |
| ç¼“å­˜ | Redisï¼ˆioredisï¼‰ | 5.7.0 |
| è®¤è¯ | JWT + RBACï¼ˆrole_levelï¼‰ | jsonwebtoken 9.0.2 |
| éªŒè¯ | Joi | 17.11.0 |
| æ—¥å¿— | Winston | 3.11.0 |

**æ¶æ„åˆ†å±‚**ï¼š
```
Routeï¼ˆè·¯ç”±å±‚ï¼‰â†’ Serviceï¼ˆä¸šåŠ¡å±‚ï¼‰â†’ Modelï¼ˆæ•°æ®å±‚ï¼‰
```
- è·¯ç”±å±‚**ä¸ç›´è¿ models**ï¼Œæ‰€æœ‰æ•°æ®åº“æ“ä½œé€šè¿‡ Service
- å†™æ“ä½œç”¨ `TransactionManager.execute()` ç»Ÿä¸€ç®¡ç†äº‹åŠ¡
- æœåŠ¡é€šè¿‡ `req.app.locals.services.getService('service_name')` è·å–ï¼ˆServiceManager æ¨¡å¼ï¼‰
- API è·¯å¾„ç»Ÿä¸€å‰ç¼€ `/api/v4/console/...`
- å“åº”æ ¼å¼ï¼š`res.apiSuccess(data, message)` / `res.apiError(message, code, details, httpStatus)`

### 2.2 å‰ç«¯æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯ | ç‰ˆæœ¬ |
|---|---|---|
| æ„å»º | Vite | 6.4.1 |
| æ¡†æ¶ | Alpine.js | 3.15.4 |
| æ ·å¼ | Tailwind CSS | 3.4.19 |
| å›¾è¡¨ | ECharts | 6.0.0 |
| å®æ—¶é€šä¿¡ | Socket.io-client | 4.8.3 |

**å‰ç«¯æ¶æ„æ¨¡å¼**ï¼š
```
HTML é¡µé¢ï¼ˆx-dataï¼‰
  â†“ å¼•ç”¨
modules/{domain}/pages/*.jsï¼ˆé¡µé¢ä¸»å…¥å£ï¼‰
  â†“ ç»„åˆ
modules/{domain}/composables/*.jsï¼ˆä¸šåŠ¡é€»è¾‘æ‹†åˆ†ï¼‰
  â†“ è°ƒç”¨
api/*.jsï¼ˆAPI è¯·æ±‚å°è£…ï¼‰
  â†“ åŸºäº
api/base.jsï¼ˆç»Ÿä¸€è¯·æ±‚å‡½æ•°ã€Token ç®¡ç†ï¼‰
  â†“ æ··å…¥
alpine/mixins/ï¼ˆåˆ†é¡µã€æ¨¡æ€æ¡†ã€è¡¨æ ¼é€‰æ‹©ã€è¡¨å•éªŒè¯ç­‰å¯å¤ç”¨ mixinï¼‰
```

- **å¤šé¡µåº”ç”¨**ï¼ˆMPAï¼‰æ¶æ„ï¼šæ¯ä¸ª `.html` é¡µé¢ç‹¬ç«‹ï¼Œç”¨ Alpine.js `x-data` ç»‘å®šçŠ¶æ€
- **Mixin ç»„åˆæ¨¡å¼**ï¼š`createPageMixin({ pagination, modal, tableSelection, ... }, customProps)` ç»Ÿä¸€ç»„åˆ
- **API æ¨¡å—åŒ–**ï¼š`api/user.js` å¯¼å‡º `USER_ENDPOINTS`ï¼ˆç«¯ç‚¹å¸¸é‡ï¼‰+ `UserAPI`ï¼ˆæ–¹æ³•å¯¹è±¡ï¼‰

---

## 3. ç°æœ‰å¯å¤ç”¨èµ„äº§æ¸…å•

### 3.1 åç«¯å¯å¤ç”¨

| èµ„äº§ | ä½ç½® | è¯´æ˜ |
|---|---|---|
| `UserService.findByMobile(mobile)` | `services/UserService.js` | âœ… **å·²å­˜åœ¨**ï¼Œå¸¦ Redis ç¼“å­˜ï¼ˆ120s TTLï¼‰ |
| `User.findByMobile(mobile)` | `models/User.js` | âœ… **å·²å­˜åœ¨**ï¼ŒModel ç±»æ–¹æ³•ï¼ˆä»…æŸ¥ active ç”¨æˆ·ï¼‰ |
| `BusinessCacheHelper.getUserByMobile()` | `utils/BusinessCacheHelper.js` | âœ… **å·²å­˜åœ¨**ï¼ŒRedis ç¼“å­˜å±‚ï¼ˆ120s TTLï¼‰ |
| `authenticateToken + requireRoleLevel(100)` | `middleware/auth.js` | âœ… user_management è·¯ç”±å·²æŒ‚è½½ |
| `res.apiSuccess() / res.apiError()` | å…¨å±€ä¸­é—´ä»¶ | âœ… æ ‡å‡†å“åº”æ ¼å¼ |
| `TransactionManager.execute()` | `utils/TransactionManager.js` | âœ… å†™æ“ä½œäº‹åŠ¡ç®¡ç†ï¼ˆresolve æ˜¯åªè¯»ï¼Œä¸éœ€è¦ï¼‰ |
| `ServiceManager` æ¨¡å¼ | `req.app.locals.services` | âœ… æœåŠ¡è·å–æ–¹å¼ |

### 3.2 å‰ç«¯å¯å¤ç”¨

| èµ„äº§ | ä½ç½® | è¯´æ˜ |
|---|---|---|
| `createPageMixin()` | `alpine/mixins/index.js` | âœ… æ”¯æŒ pagination/modal/formValidation/authGuard |
| `request()` + `buildURL()` + `buildQueryString()` | `api/base.js` | âœ… ç»Ÿä¸€è¯·æ±‚å‡½æ•° |
| `API_PREFIX` | `api/base.js` | âœ… å€¼ä¸º `/api/v4` |
| `UserAPI` + `USER_ENDPOINTS` | `api/user.js` | âœ… å·²æœ‰ç”¨æˆ·ç›¸å…³ APIï¼Œéœ€æ–°å¢ `resolveUser()` |
| `asyncDataMixin()` | `alpine/mixins/async-data.js` | âœ… åŠ è½½çŠ¶æ€ç®¡ç† |
| `formValidationMixin()` | `alpine/mixins/form-validation.js` | âœ… è¡¨å•æ ¡éªŒ |

### 3.3 å·²æœ‰ç±»ä¼¼å®ç°å‚è€ƒ

`asset-adjustment.js` ä¸­å·²æœ‰ **æ‰‹æœºå·æœç´¢â†’è§£æç”¨æˆ·â†’æ“ä½œ** çš„å®Œæ•´æ¨¡å¼ï¼š

```js
// admin/src/modules/asset/composables/adjustment.js ç¬¬ 218-257 è¡Œ
async handleSearch() {
  let targetUserId = this.searchUserId
  if (!targetUserId && this.searchMobile) {
    const userResult = await request({
      url: `${API_BASE_URL}/admin/users`,
      params: { search: this.searchMobile }
    })
    if (userResult.success && userResult.data?.users?.length > 0) {
      targetUserId = userResult.data.users[0].user_id
    }
  }
  await this.loadUserAssets(targetUserId)
}
```

**é—®é¢˜**ï¼šè¯¥å®ç°è°ƒç”¨çš„æ˜¯ `/admin/users`ï¼ˆæ—§è·¯å¾„ï¼‰ï¼Œä¸”æœªåšæ‰‹æœºå·æ ¼å¼æ ¡éªŒã€‚æ–°æ–¹æ¡ˆå°†æä¾›ç»Ÿä¸€çš„ resolve ç«¯ç‚¹å’Œå‰ç«¯ mixin æ¥è§„èŒƒåŒ–æ­¤æ¨¡å¼ã€‚

---

## 4. å·²æ‹æ¿å†³ç­–è®°å½•

> ä»¥ä¸‹ 5 é¡¹å†³ç­–å·²äº 2026-02-06 ç¡®è®¤ï¼Œå…¨éƒ¨é€‰ Aã€‚

| # | å†³ç­– | ç»“è®º | è¯´æ˜ |
|---|---|---|---|
| 1 | æ˜µç§°æœç´¢æ˜¯å¦å®ç°ï¼Ÿ | âœ… **ä»…æ‰‹æœºå·** | åªåšæ‰‹æœºå·ç²¾ç¡®æœç´¢ï¼Œä¸åšæ˜µç§°æ¨¡ç³Šæœç´¢ã€‚ç”¨æˆ· 100% æœ‰æ‰‹æœºå·ï¼Œæ˜µç§°å¯èƒ½ä¸ºç©ºã€‚ |
| 2 | resolveUserParam ä¸­é—´ä»¶ï¼Ÿ | âœ… **ä¸åšä¸­é—´ä»¶** | ä»…æ–°å¢ resolve ç«¯ç‚¹ï¼Œå‰ç«¯å…ˆè°ƒ resolve æ‹¿åˆ° user_id å†è°ƒä¸šåŠ¡ APIã€‚è¡Œä¸šæ ‡å‡†åšæ³•ï¼ˆç¾å›¢/é˜¿é‡Œ/è…¾è®¯/æ¸¸æˆå…¬å¸å‡ä¸ºæ­¤æ¨¡å¼ï¼‰ï¼Œä¸åœ¨ URL è·¯å¾„ä¸­æ··ç”¨æ‰‹æœºå·å’Œ IDï¼Œé¿å…æ­§ä¹‰å’Œè€¦åˆã€‚ |
| 3 | asset-adjustment åŒæ¨¡å¼ï¼Ÿ | âœ… **ç»Ÿä¸€æ‰‹æœºå·ä¸»å¯¼** | ç§»é™¤ `searchUserId` è¾“å…¥æ¡†ï¼Œä»…ä¿ç•™æ‰‹æœºå·æœç´¢ï¼Œä¸å…¨å±€æ–¹æ¡ˆä¸€è‡´ã€‚ |
| 4 | user-hierarchy çš„ä¸Šçº§ IDï¼Ÿ | âœ… **æ”¹ä¸ºä¸Šçº§æ‰‹æœºå·** | `filters.superior_user_id` æ”¹ä¸º `filters.superior_mobile`ï¼Œç»Ÿä¸€ä½“éªŒã€‚ |
| 5 | lottery æ‰¹é‡é…é¢ï¼Ÿ | âœ… **æ”¹ä¸ºæ‰¹é‡æ‰‹æœºå·** | textarea è¾“å…¥å¤šä¸ªæ‰‹æœºå·ï¼Œé€ä¸ª resolveã€‚**éƒ¨åˆ†å¤±è´¥ç­–ç•¥ï¼šè·³è¿‡å¤±è´¥é¡¹ï¼Œç»§ç»­æäº¤æˆåŠŸé¡¹**â€”â€”å¤±è´¥çš„æ‰‹æœºå·é«˜äº®æ ‡çº¢æç¤º"æœªæ‰¾åˆ°"ï¼ŒæˆåŠŸçš„æ­£å¸¸æäº¤ï¼Œä¸é˜»å¡æ•´æ‰¹æ“ä½œã€‚ |

---

## 5. æŠ€æœ¯æ–¹æ¡ˆï¼ˆå¯¹é½å®é™…æŠ€æœ¯æ ˆï¼‰

### 5.1 åç«¯ï¼šæ–°å¢ resolve ç«¯ç‚¹

**æ–‡ä»¶**ï¼š`routes/v4/console/user_management.js`

**è·¯ç”±**ï¼š
```
GET /api/v4/console/user-management/users/resolve?mobile=13800138000
```

> âš ï¸ æ³¨æ„ï¼šåç«¯è·¯ç”±æ–‡ä»¶åæ˜¯ `user_management.js`ï¼ˆä¸‹åˆ’çº¿ï¼‰ï¼Œä½†æŒ‚è½½è·¯å¾„æ˜¯ `/user-management`ï¼ˆè¿å­—ç¬¦ï¼‰ï¼Œè§ `routes/v4/console/index.js` ç¬¬ 86 è¡Œã€‚

**å®ç°è¦ç‚¹**ï¼ˆä¸¥æ ¼å¯¹é½ `user_management.js` ç°æœ‰ä»£ç é£æ ¼ï¼‰ï¼š

**æ–‡ä»¶é¡¶éƒ¨æ–°å¢å¯¼å…¥**ï¼ˆä¸ç°æœ‰ `logger`ã€`TransactionManager` åŒçº§ï¼‰ï¼š
```js
// ç°æœ‰å¯¼å…¥ï¼ˆä¸åŠ¨ï¼‰
const logger = require('../../../utils/logger').logger
const TransactionManager = require('../../../utils/TransactionManager')

// æ–°å¢å¯¼å…¥
const UserService = require('../../../services/UserService')
```

> âš ï¸ `UserService` æ˜¯é™æ€ç±»ï¼Œç›´æ¥ require å¯¼å…¥ï¼ˆä¸èµ° ServiceManagerï¼‰ã€‚
> åŒæ–‡ä»¶ä¸­ `UserRoleService` é€šè¿‡ `req.app.locals.services.getService('user_role')` è·å–ï¼Œ
> ä½† `UserService` åœ¨é¡¹ç›®ä¸­ç»Ÿä¸€ä»¥é¡¶å±‚ require æ–¹å¼ä½¿ç”¨ï¼ˆå‚è€ƒ `routes/v4/auth.js` ç­‰ï¼‰ã€‚

**è·¯ç”±ä»£ç **ï¼ˆæ’å…¥ä½ç½®ï¼š`router.get('/users', ...)` ä¹‹å‰ï¼‰ï¼š
```js
/**
 * ğŸ” æ ¹æ®æ‰‹æœºå·è§£æç”¨æˆ·
 * GET /api/v4/console/user-management/users/resolve?mobile=13800138000
 *
 * ä¸šåŠ¡åœºæ™¯ï¼š
 * - ç®¡ç†åå°æ‰€æœ‰é¡µé¢çš„"æ‰‹æœºå·æœç´¢ç”¨æˆ·"ç»Ÿä¸€å…¥å£
 * - è¿è¥è¾“å…¥æ‰‹æœºå· â†’ è§£æå‡º user_id â†’ å‰ç«¯ç”¨ user_id è°ƒåç»­ä¸šåŠ¡ API
 * - æ›¿ä»£åŸæ¥ 23 ä¸ªé¡µé¢è¦æ±‚è¿è¥è¾“å…¥ user_id çš„è®¾è®¡
 *
 * æ•°æ®åº“æŸ¥è¯¢ï¼š
 * - UserService.findByMobile(mobile) â†’ User.findOne({ where: { mobile } })
 * - æŸ¥è¯¢æ¡ä»¶ï¼šusers.mobileï¼ˆUNIQUE INDEXï¼Œç²¾ç¡®åŒ¹é…ï¼‰
 * - ä¸è¿‡æ»¤ statusï¼šç®¡ç†å‘˜éœ€è¦èƒ½æœåˆ° inactive/banned ç”¨æˆ·ï¼ˆæŸ¥çœ‹çŠ¶æ€ã€è§£å°ç­‰æ“ä½œï¼‰
 *
 * ç¼“å­˜ï¼š
 * - UserService.findByMobile() å†…ç½® Redis ç¼“å­˜ï¼ˆBusinessCacheHelper, 120s TTLï¼‰
 * - æ— éœ€é¢å¤–ç¼“å­˜ä»£ç 
 *
 * æƒé™ï¼šauthenticateToken + requireRoleLevel(100)ï¼ˆå·²åœ¨ router.use() å…¨å±€æŒ‚è½½ï¼‰
 *
 * å“åº”æ ¼å¼ï¼šæ ‡å‡† ApiResponseï¼ˆres.apiSuccess / res.apiErrorï¼‰
 *
 * @since 2026-02-06ï¼ˆæ‰‹æœºå·ä¸»å¯¼æœç´¢æ”¹é€ ï¼‰
 */
router.get('/users/resolve', async (req, res) => {
  try {
    const { mobile } = req.query

    // å‚æ•°æ ¡éªŒ
    if (!mobile) {
      return res.apiError('è¯·æä¾›æ‰‹æœºå·å‚æ•°', 'MISSING_PARAM', null, 400)
    }

    // æ‰‹æœºå·æ ¼å¼æ ¡éªŒï¼ˆ11ä½æ•°å­—ï¼Œ1å¼€å¤´ï¼‰
    if (!/^1\d{10}$/.test(mobile)) {
      return res.apiError('æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥11ä½æ‰‹æœºå·', 'INVALID_MOBILE', null, 400)
    }

    // å¤ç”¨ UserService.findByMobile()
    // æ³¨æ„ï¼šè¯¥æ–¹æ³•æŸ¥è¯¢ User.findOne({ where: { mobile } })ï¼Œä¸è¿‡æ»¤ status
    // ç®¡ç†å‘˜éœ€è¦èƒ½æœåˆ°æ‰€æœ‰çŠ¶æ€çš„ç”¨æˆ·ï¼ˆactive/inactive/bannedï¼‰
    const user = await UserService.findByMobile(mobile)

    if (!user) {
      return res.apiError('æœªæ‰¾åˆ°è¯¥æ‰‹æœºå·å¯¹åº”çš„ç”¨æˆ·', 'USER_NOT_FOUND', null, 404)
    }

    // è½¬æ¢ä¸ºæ™®é€šå¯¹è±¡ï¼ˆç¼“å­˜å‘½ä¸­æ—¶å·²æ˜¯æ™®é€šå¯¹è±¡ï¼ŒDB æŸ¥è¯¢æ—¶æ˜¯ Sequelize å®ä¾‹ï¼‰
    const userData = user.get ? user.get({ plain: true }) : user

    // è¿”å›å­—æ®µè¯´æ˜ï¼ˆå…¨éƒ¨å¯¹é½ users è¡¨å­—æ®µåï¼‰ï¼š
    // - user_id:    users.user_id (INT, PK) â€” åç»­ä¸šåŠ¡ API æ‰€éœ€çš„å†…éƒ¨æ ‡è¯†
    // - mobile:     users.mobile (VARCHAR(20), UNIQUE) â€” è„±æ•è¿”å›ï¼Œæ ¼å¼ 138****8000
    // - nickname:   users.nickname (VARCHAR(50), NULL) â€” å¯èƒ½ä¸ºç©ºï¼Œç©ºæ—¶ç”¨"ç”¨æˆ·+å4ä½"å…œåº•
    // - status:     users.status (ENUM: active/inactive/banned) â€” ç®¡ç†å‘˜éœ€çœ‹åˆ°ç”¨æˆ·å½“å‰çŠ¶æ€
    // - avatar_url: users.avatar_url (VARCHAR(500), NULL) â€” ç”¨æˆ·å¤´åƒ
    // - user_level: users.user_level (ENUM: normal/vip/merchant) â€” ç”¨æˆ·ç­‰çº§
    return res.apiSuccess({
      user_id: userData.user_id,
      mobile: userData.mobile.substring(0, 3) + '****' + userData.mobile.substring(7),
      nickname: userData.nickname || `ç”¨æˆ·${userData.mobile.slice(-4)}`,
      status: userData.status,
      avatar_url: userData.avatar_url || null,
      user_level: userData.user_level || 'normal'
    }, 'ç”¨æˆ·è§£ææˆåŠŸ')
  } catch (error) {
    logger.error('âŒ ç”¨æˆ·è§£æå¤±è´¥:', error.message)
    return res.apiError('ç”¨æˆ·è§£æå¤±è´¥', 'RESOLVE_USER_FAILED', { error: error.message }, 500)
  }
})
```

**å“åº”æ ¼å¼å¯¹ç…§**ï¼ˆç”± `ApiResponse.middleware()` è‡ªåŠ¨åŒ…è£…ï¼‰ï¼š

æˆåŠŸæ—¶ï¼ˆHTTP 200ï¼‰ï¼š
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "ç”¨æˆ·è§£ææˆåŠŸ",
  "data": {
    "user_id": 31,
    "mobile": "136****7930",
    "nickname": "ç®¡ç†å‘˜ç”¨æˆ·",
    "status": "active",
    "avatar_url": null,
    "user_level": "normal"
  },
  "timestamp": "2026-02-06 14:30:00",
  "version": "v4.0",
  "request_id": "req_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
}
```

å¤±è´¥æ—¶ï¼ˆHTTP 404ï¼‰ï¼š
```json
{
  "success": false,
  "code": "USER_NOT_FOUND",
  "message": "æœªæ‰¾åˆ°è¯¥æ‰‹æœºå·å¯¹åº”çš„ç”¨æˆ·",
  "data": {},
  "timestamp": "2026-02-06 14:30:00",
  "version": "v4.0",
  "request_id": "req_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "httpStatus": 404
}
```

**ç¼“å­˜è·¯å¾„ï¼ˆä¸‰çº§ç¼“å­˜ï¼Œé›¶æ–°å¢ï¼‰**ï¼š
```
å‰ç«¯ mixin Map ç¼“å­˜ï¼ˆé¡µé¢ä¼šè¯çº§ï¼Œæ–°å¢ï¼‰
  â†“ miss
åç«¯ Redis ç¼“å­˜ï¼ˆBusinessCacheHelper.getUserByMobileï¼Œ120s TTLï¼Œå·²æœ‰ï¼‰
  â†“ miss
MySQL æŸ¥è¯¢ï¼ˆusers.mobile UNIQUE INDEXï¼Œå·²æœ‰ï¼‰
```

### 5.2 å‰ç«¯ï¼šæ–°å¢ resolveUser API æ–¹æ³•

**æ–‡ä»¶**ï¼š`admin/src/api/user.js`

**å˜æ›´**ï¼šåœ¨ `USER_ENDPOINTS` ä¸­æ–°å¢ç«¯ç‚¹ï¼Œåœ¨ `UserAPI` ä¸­æ–°å¢æ–¹æ³•ã€‚

```js
// USER_ENDPOINTS æ–°å¢ï¼š
RESOLVE: `${API_PREFIX}/console/user-management/users/resolve`,

// UserAPI æ–°å¢æ–¹æ³•ï¼š
async resolveUser(params) {
  // params: { mobile: '13800138000' }
  const url = USER_ENDPOINTS.RESOLVE + buildQueryString(params)
  return await request({ url, method: 'GET' })
}
```

### 5.3 å‰ç«¯ï¼šæ–°å¢ userResolverMixin

**æ–°å»ºæ–‡ä»¶**ï¼š`admin/src/alpine/mixins/user-resolver.js`

**è®¾è®¡åŸåˆ™**ï¼š
- éµå¾ªé¡¹ç›®ç°æœ‰ mixin æ¨¡å¼ï¼ˆå¯¼å‡ºå·¥å‚å‡½æ•°ï¼Œè¿”å› plain objectï¼‰
- å†…ç½®å‰ç«¯ Map ç¼“å­˜ï¼ˆé¡µé¢ä¼šè¯çº§ï¼‰
- å†…ç½®æ‰‹æœºå·æ ¼å¼æ ¡éªŒï¼ˆä¸å‘æ— æ•ˆè¯·æ±‚ï¼‰
- ä¸ `createPageMixin()` å¯ç»„åˆ

```js
/**
 * ç”¨æˆ·è§£æ Mixin
 *
 * æä¾›æ‰‹æœºå·â†’ç”¨æˆ·è§£æèƒ½åŠ›ï¼Œå†…ç½®å‰ç«¯ç¼“å­˜å’Œæ ¼å¼æ ¡éªŒã€‚
 * ä¸ createPageMixin ç»„åˆä½¿ç”¨ã€‚
 *
 * @returns {Object} mixin å¯¹è±¡
 */
export function userResolverMixin() {
  // é¡µé¢ä¼šè¯çº§ç¼“å­˜ï¼ˆåˆ·æ–°å³å¤±æ•ˆï¼‰
  const resolveCache = new Map()

  return {
    // çŠ¶æ€
    resolvedUser: null,       // { user_id, mobile, nickname, status, avatar_url, user_level }
    resolving: false,
    resolveError: '',

    // æ‰‹æœºå·æ ¼å¼æ ¡éªŒ
    isValidMobile(mobile) {
      return /^1\d{10}$/.test(mobile)
    },

    // æ‰‹æœºå·ç²¾ç¡®è§£æ
    async resolveUserByMobile(mobile) {
      if (!mobile) {
        this.resolveError = 'è¯·è¾“å…¥æ‰‹æœºå·'
        return null
      }

      const trimmed = mobile.trim()
      if (!this.isValidMobile(trimmed)) {
        this.resolveError = 'è¯·è¾“å…¥11ä½æ‰‹æœºå·'
        return null
      }

      // å‘½ä¸­ç¼“å­˜
      if (resolveCache.has(trimmed)) {
        this.resolvedUser = resolveCache.get(trimmed)
        this.resolveError = ''
        return this.resolvedUser
      }

      this.resolving = true
      this.resolveError = ''

      try {
        const result = await UserAPI.resolveUser({ mobile: trimmed })
        if (result.success && result.data) {
          this.resolvedUser = result.data
          resolveCache.set(trimmed, result.data)
          return result.data
        } else {
          this.resolveError = result.message || 'æœªæ‰¾åˆ°è¯¥æ‰‹æœºå·å¯¹åº”çš„ç”¨æˆ·'
          this.resolvedUser = null
          return null
        }
      } catch (error) {
        this.resolveError = error.message || 'è§£æå¤±è´¥'
        this.resolvedUser = null
        return null
      } finally {
        this.resolving = false
      }
    },

    // æ¸…ç©ºè§£æç»“æœ
    clearResolvedUser() {
      this.resolvedUser = null
      this.resolveError = ''
    }
  }
}
```

**æ³¨å†Œåˆ° mixin å…¥å£**ï¼šåœ¨ `admin/src/alpine/mixins/index.js` ä¸­ï¼š

```js
// æ–°å¢å¯¼å…¥
import { userResolverMixin } from './user-resolver.js'
export { userResolverMixin } from './user-resolver.js'

// createPageMixin æ–°å¢é…ç½®é¡¹
export function createPageMixin(mixinConfig = {}, customProps = {}) {
  const {
    // ...existing...
    userResolver = false  // æ–°å¢
  } = mixinConfig

  // ...existing code...

  // æ–°å¢ï¼šç”¨æˆ·è§£æ
  if (userResolver) {
    Object.assign(composed, userResolverMixin())
  }

  // ...rest...
}
```

### 5.4 å‰ç«¯ï¼šé¡µé¢æ”¹é€ æ¨¡å¼

#### æ¨¡å¼ A â€” ç­›é€‰å‹ï¼ˆåˆ—è¡¨é¡µç­›é€‰åŒºåŸŸï¼‰

**æ”¹é€ å‰**ï¼ˆä»¥ `finance-management.html` ä¸ºä¾‹ï¼‰ï¼š
```html
<input type="text" x-model="consumptionFilters.user_id" placeholder="ç”¨æˆ·ID" class="px-3 py-2 border rounded">
```

**æ”¹é€ å**ï¼š
```html
<div class="flex gap-2 items-center">
  <input type="text" x-model="consumptionFilters.mobile" placeholder="æ‰‹æœºå·"
         maxlength="11" class="px-3 py-2 border rounded" @keyup.enter="resolveAndSearchConsumption()">
  <template x-if="resolvedUser">
    <span class="text-xs text-green-600">âœ… <span x-text="resolvedUser.nickname"></span></span>
  </template>
</div>
```

**å¯¹åº” JS å˜æ›´**ï¼š
```js
// filters ä¸­ user_id æ”¹ä¸º mobile
consumptionFilters: { mobile: '', /* ...other filters */ },

// æœç´¢æ–¹æ³•æ”¹ä¸ºå…ˆ resolve å†æŸ¥è¯¢
async resolveAndSearchConsumption() {
  if (this.consumptionFilters.mobile) {
    const user = await this.resolveUserByMobile(this.consumptionFilters.mobile)
    if (!user) return  // resolveError å·²è®¾ç½®ï¼ŒUI ä¼šæ˜¾ç¤º
    // ç”¨ resolvedUser.user_id è°ƒä¸šåŠ¡ API
    await this.loadConsumptionRecords({ user_id: user.user_id })
  } else {
    await this.loadConsumptionRecords({})
  }
}
```

#### æ¨¡å¼ B â€” å®šå‘æ“ä½œå‹ï¼ˆè¡¨å•ä¸­è¾“å…¥ç›®æ ‡ç”¨æˆ·ï¼‰

**æ”¹é€ å‰**ï¼ˆä»¥ `asset-adjustment.html` ä¸ºä¾‹ï¼‰ï¼š
```html
<input type="text" x-model="form.user_id" placeholder="è¾“å…¥ç”¨æˆ·ID" @keyup.enter="searchUser()">
```

**æ”¹é€ å**ï¼š
```html
<div class="flex gap-2">
  <input type="text" x-model="form.mobile" placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
         maxlength="11" class="flex-1 px-3 py-2 border rounded-lg"
         @keyup.enter="resolveAndLoad()">
  <button @click="resolveAndLoad()" class="px-4 py-2 themed-bg-primary text-white rounded-lg"
          :disabled="resolving">
    <span x-show="!resolving">æŸ¥æ‰¾</span>
    <span x-show="resolving">æŸ¥æ‰¾ä¸­...</span>
  </button>
</div>
<div x-show="resolvedUser" class="mt-2 p-2 bg-blue-50 rounded text-sm">
  âœ… <span x-text="resolvedUser?.nickname"></span>
  (<span x-text="resolvedUser?.mobile"></span>)
  Â· <span x-text="resolvedUser?.status === 'active' ? 'æ´»è·ƒ' : 'å¼‚å¸¸'"></span>
</div>
<div x-show="resolveError" class="mt-1 text-sm text-red-500" x-text="resolveError"></div>
```

#### æ¨¡å¼ C â€” æ‰¹é‡å‹ï¼ˆæ‰¹é‡æ“ä½œï¼Œå¦‚æ‰¹é‡å‘é…é¢ï¼‰

**æ”¹é€ å‰**ï¼ˆ`lottery-management.html`ï¼‰ï¼š
```html
<textarea placeholder="è¾“å…¥ç”¨æˆ·IDï¼Œæ”¯æŒé€—å·åˆ†éš”"></textarea>
```

**æ”¹é€ å**ï¼š
```html
<textarea x-model="batchMobiles" placeholder="è¾“å…¥æ‰‹æœºå·ï¼Œæ”¯æŒé€—å·ã€æ¢è¡Œåˆ†éš”&#10;ä¾‹å¦‚ï¼š13800001111, 13800002222"
          class="w-full px-3 py-2 border rounded" rows="3"></textarea>
```

**æ‰¹é‡è§£æç­–ç•¥ï¼ˆå·²æ‹æ¿ï¼šè·³è¿‡å¤±è´¥é¡¹ï¼‰**ï¼š
- æäº¤æ—¶é€ä¸ªè°ƒ resolve
- è§£ææˆåŠŸçš„ï¼šç»¿è‰² âœ… æ ‡è®°ï¼Œæ­£å¸¸çº³å…¥æäº¤
- è§£æå¤±è´¥çš„ï¼šçº¢è‰² âŒ é«˜äº®ï¼Œæç¤º"æœªæ‰¾åˆ°å¯¹åº”ç”¨æˆ·"ï¼Œ**è·³è¿‡è¯¥é¡¹ï¼Œä¸é˜»å¡æ•´æ‰¹æäº¤**
- æäº¤æŒ‰é’®æ˜¾ç¤ºï¼šã€Œæäº¤ï¼ˆ8/10 ä¸ªç”¨æˆ·ï¼‰ã€ï¼Œæ˜ç¡®å‘ŠçŸ¥è¿è¥æœ‰ 2 ä¸ªè¢«è·³è¿‡
- æäº¤å®Œæˆåæ±‡æ€»ï¼šæˆåŠŸ 8 ä¸ªã€è·³è¿‡ 2 ä¸ªï¼ˆé™„å¤±è´¥æ‰‹æœºå·åˆ—è¡¨ä¾›è¿è¥æ ¸æŸ¥ï¼‰

---

## 6. å—å½±å“æ–‡ä»¶æ¸…å•ï¼ˆåŸºäºå®é™…ä»£ç å®¡æŸ¥ï¼‰

### 6.1 åç«¯å˜æ›´ï¼ˆ1 ä¸ªæ–‡ä»¶ï¼‰

| æ–‡ä»¶ | æ“ä½œ | å˜æ›´å†…å®¹ |
|---|---|---|
| `routes/v4/console/user_management.js` | **ä¿®æ”¹** | æ–°å¢ `GET /users/resolve?mobile=xxx` è·¯ç”±ï¼ˆçº¦ 40 è¡Œï¼‰ |

> ä¸éœ€è¦æ–°å¢ Serviceã€Modelã€ä¸­é—´ä»¶ã€‚resolve ç«¯ç‚¹ç›´æ¥å¤ç”¨ `UserService.findByMobile()`ï¼Œè¯¥æ–¹æ³•å·²æœ‰ Redis ç¼“å­˜ã€‚

### 6.2 å‰ç«¯æ–°å¢ï¼ˆ2 ä¸ªæ–‡ä»¶ï¼‰

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|---|---|---|
| `admin/src/alpine/mixins/user-resolver.js` | **æ–°å»º** | ç”¨æˆ·è§£æ mixinï¼ˆçº¦ 80 è¡Œï¼‰ |
| `admin/src/api/user.js` | **ä¿®æ”¹** | æ–°å¢ `RESOLVE` ç«¯ç‚¹ + `resolveUser()` æ–¹æ³•ï¼ˆçº¦ 10 è¡Œï¼‰ |

### 6.3 å‰ç«¯ mixin æ³¨å†Œï¼ˆ1 ä¸ªæ–‡ä»¶ï¼‰

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|---|---|---|
| `admin/src/alpine/mixins/index.js` | **ä¿®æ”¹** | å¯¼å…¥ + å¯¼å‡º `userResolverMixin`ï¼Œ`createPageMixin` æ–°å¢ `userResolver` é…ç½®é¡¹ |

### 6.4 å‰ç«¯é¡µé¢æ”¹é€ ï¼ˆ9 ä¸ª HTML + å¯¹åº” JSï¼‰

| é¡µé¢æ–‡ä»¶ | æ”¹é€ ç‚¹æ•° | æ”¹é€ æ¨¡å¼ | å…·ä½“å­—æ®µ |
|---|---|---|---|
| `finance-management.html` + JS | 4 | AÃ—2 + BÃ—2 | `consumptionFilters.user_id` â†’ `.mobile`, `merchantFilters.user_id` â†’ `.mobile`, `diamondFilters.user_id` â†’ `.mobile`, `diamondAdjustForm.user_id` â†’ `.mobile` |
| `asset-management.html` + JS | 4 | AÃ—4 | `materialAccountFilters.user_id`, `logFilters.user_id`, `virtualAccountFilters.user_id`, `virtualTxFilters.user_id` â†’ å„è‡ª `.mobile` |
| `lottery-management.html` + JS | 3 | AÃ—1 + BÃ—1 + CÃ—1 | `redemptionFilters.user_id`, `quotaForm.target_user_id`, æ‰¹é‡é…é¢ `user_ids` |
| `asset-adjustment.html` + JS | 1 | B | `searchUserId` ç§»é™¤ï¼Œç»Ÿä¸€ç”¨ `searchMobile`ï¼ˆå·²æœ‰éƒ¨åˆ†å®ç°ï¼Œéœ€è§„èŒƒåŒ–ï¼‰ |
| `assets-portfolio.html` + JS | 1 | A | `searchForm.user_id` â†’ `.mobile` |
| `user-management.html` + JS | 3 | AÃ—3 | `premiumFilters.user_id`, `roleHistoryFilters.user_id`, `statusHistoryFilters.user_id` â†’ å„è‡ª `.mobile` |
| `trade-management.html` + JS | 2 | AÃ—2 | `tradeFilters.buyer_user_id` â†’ `.buyer_mobile`, `tradeFilters.seller_user_id` â†’ `.seller_mobile` |
| `sessions.html` + JS | 1 | A | `filters.user_id` â†’ `.mobile` |
| `user-hierarchy.html` + JS | 2 | A + B | `filters.superior_user_id` â†’ `.superior_mobile`, `form.user_id` â†’ `.mobile` |

**åˆè®¡**ï¼šçº¦ 21 ä¸ªè¾“å…¥æ¡†æ”¹é€ ç‚¹ã€‚

### 6.5 å¯¹åº” JS æ¨¡å—æ–‡ä»¶

| JS æ–‡ä»¶ | è¯´æ˜ |
|---|---|
| `admin/src/modules/analytics/composables/diamond-accounts.js` | é’»çŸ³è´¦æˆ·æœç´¢ |
| `admin/src/modules/analytics/composables/merchant-points.js` | å•†å®¶ç§¯åˆ†ç­›é€‰ |
| `admin/src/modules/asset/composables/adjustment.js` | èµ„äº§è°ƒæ•´ï¼ˆå·²æœ‰ searchMobileï¼Œéœ€è§„èŒƒåŒ–ï¼‰ |
| `admin/src/modules/asset/pages/asset-management.js` | èµ„äº§ç®¡ç†å¤š tab ç­›é€‰ |
| `admin/src/modules/asset/pages/assets-portfolio.js` | èµ„äº§ç»„åˆæœç´¢ |
| `admin/src/modules/lottery/composables/redemption.js` | å…‘æ¢ç ç­›é€‰ |
| `admin/src/modules/lottery/composables/quota.js` | é…é¢è¡¨å• target_user_id |
| `admin/src/modules/user/composables/users.js` | ç”¨æˆ·ç®¡ç†ç­›é€‰ |
| `admin/src/modules/user/composables/advanced-status.js` | é«˜çº§çŠ¶æ€ç­›é€‰ |
| `admin/src/modules/user/composables/roles-permissions.js` | è§’è‰²/çŠ¶æ€å†å²ç­›é€‰ |
| `admin/src/modules/user/pages/user-hierarchy.js` | å±‚çº§ç®¡ç†ç­›é€‰ |
| `admin/src/modules/system/pages/sessions.js` | ä¼šè¯ç­›é€‰ |

---

## 7. äº¤äº’è§„èŒƒ

### 7.1 æœç´¢æ¡†æ ‡å‡†äº¤äº’

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“± è¯·è¾“å…¥æ‰‹æœºå·                [ğŸ” æŸ¥è¯¢]      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ 13800138000              â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è§£ææˆåŠŸåï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… ç®¡ç†å‘˜ç”¨æˆ· (138****7930) Â· æ´»è·ƒ            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 äº¤äº’çŠ¶æ€

| çŠ¶æ€ | è¡¨ç° |
|---|---|
| ç©ºè¾“å…¥ | æ˜¾ç¤º placeholder "è¯·è¾“å…¥æ‰‹æœºå·" |
| è§£æä¸­ | æŒ‰é’®å˜ä¸º loading çŠ¶æ€ï¼ˆ`:disabled="resolving"`ï¼‰ï¼Œè¾“å…¥æ¡†ä¸ç¦ç”¨ |
| è§£ææˆåŠŸ | è¾“å…¥æ¡†ä¸‹æ–¹æ˜¾ç¤ºç”¨æˆ·å¡ç‰‡ï¼ˆæ˜µç§° + è„±æ•æ‰‹æœºå· + çŠ¶æ€ï¼‰ï¼Œä½¿ç”¨ Tailwind `bg-blue-50 rounded` |
| è§£æå¤±è´¥ | çº¢è‰²æç¤º `text-red-500`"æœªæ‰¾åˆ°è¯¥æ‰‹æœºå·å¯¹åº”çš„ç”¨æˆ·" |
| æ ¼å¼é”™è¯¯ | çº¢è‰²æç¤º"è¯·è¾“å…¥ 11 ä½æ‰‹æœºå·"ï¼ˆå‰ç«¯æ‹¦æˆªï¼Œä¸å‘è¯·æ±‚ï¼‰ |

### 7.3 æ‰‹æœºå·æ ¼å¼æ ¡éªŒ

å‰ç«¯åœ¨è°ƒ API å‰åšåŸºç¡€æ ¡éªŒï¼ˆåœ¨ `userResolverMixin.isValidMobile()` ä¸­ï¼‰ï¼š
- é•¿åº¦ 11 ä½
- ä»¥ 1 å¼€å¤´
- å…¨éƒ¨ä¸ºæ•°å­—

ä¸é€šè¿‡åˆ™ä¸å‘è¯·æ±‚ï¼Œç›´æ¥è®¾ç½® `resolveError`ã€‚

---

## 8. ä¸æ”¹åŠ¨çš„éƒ¨åˆ†

| é¡¹ç›® | è¯´æ˜ |
|---|---|
| åç«¯ç°æœ‰ console è·¯ç”± | æ‰€æœ‰ `/users/:user_id/xxx` è·¯ç”±é›¶æ”¹åŠ¨ï¼Œç»§ç»­ç”¨ user_id |
| åç«¯ Service å±‚ | UserService / UserRoleService é›¶æ”¹åŠ¨ |
| åç«¯ Model å±‚ | User model é›¶æ”¹åŠ¨ï¼ˆmobile å­—æ®µå’Œç´¢å¼•å·²å°±ç»ªï¼‰ |
| åç«¯ Redis ç¼“å­˜å±‚ | BusinessCacheHelper é›¶æ”¹åŠ¨ï¼ˆgetUserByMobile å·²æœ‰ï¼‰ |
| åç«¯æ•°æ®åº“ | users è¡¨ç»“æ„é›¶æ”¹åŠ¨ï¼Œuser_id ä»ä¸ºä¸»é”® |
| å‰ç«¯è¡¨æ ¼ä¸­çš„ user_id åˆ— | ä¿ç•™ä¸ºåªè¯»å±•ç¤ºåˆ—ï¼Œæ–¹ä¾¿æŠ€æœ¯æ’æŸ¥ |
| ç”¨æˆ·ç®¡ç†ä¸»åˆ—è¡¨ | å·²æœ‰æ‰‹æœºå·æœç´¢ï¼ˆ`userFilters.phone`ï¼‰ï¼Œä¸éœ€è¦æ”¹ |
| `api/base.js` | é›¶æ”¹åŠ¨ |

---

## 9. æ‰§è¡Œæ­¥éª¤

### Phase 1ï¼šåŸºç¡€è®¾æ–½æ­å»ºï¼ˆ0.5 å¤©ï¼‰

**Step 1.1 â€” åç«¯ resolve ç«¯ç‚¹**

æ–‡ä»¶ï¼š`routes/v4/console/user_management.js`
- åœ¨ `router.get('/users/:user_id', ...)` ä¹‹å‰æ’å…¥ `router.get('/users/resolve', ...)`
- å®ç°ä»£ç è§ Â§5.1
- å¤ç”¨ï¼š`UserService.findByMobile()`ã€`res.apiSuccess()`ã€å·²æœ‰çš„ auth ä¸­é—´ä»¶

**Step 1.2 â€” å‰ç«¯ resolve API**

æ–‡ä»¶ï¼š`admin/src/api/user.js`
- `USER_ENDPOINTS` æ–°å¢ `RESOLVE` å¸¸é‡
- `UserAPI` æ–°å¢ `resolveUser(params)` æ–¹æ³•
- ä»£ç è§ Â§5.2

**Step 1.3 â€” å‰ç«¯ userResolverMixin**

æ–°å»ºæ–‡ä»¶ï¼š`admin/src/alpine/mixins/user-resolver.js`
- å®ç°ä»£ç è§ Â§5.3
- å¯¼å‡º `userResolverMixin()` å·¥å‚å‡½æ•°

**Step 1.4 â€” æ³¨å†Œ mixin**

æ–‡ä»¶ï¼š`admin/src/alpine/mixins/index.js`
- å¯¼å…¥å¹¶å¯¼å‡º `userResolverMixin`
- `createPageMixin` æ–°å¢ `userResolver` é…ç½®é¡¹

### Phase 2ï¼šé«˜é¢‘é¡µé¢æ”¹é€ ï¼ˆ1 å¤©ï¼‰

æŒ‰è¿è¥ä½¿ç”¨é¢‘ç‡ä¼˜å…ˆæ”¹é€ ï¼š

| åºå· | é¡µé¢ | æ”¹é€ ç‚¹ | æ¶‰åŠ JS æ–‡ä»¶ |
|---|---|---|---|
| 2.1 | `finance-management.html` | 4 å¤„ | `analytics/composables/diamond-accounts.js`, `analytics/composables/merchant-points.js` |
| 2.2 | `asset-management.html` | 4 å¤„ | `asset/pages/asset-management.js` |
| 2.3 | `asset-adjustment.html` | 1 å¤„ | `asset/composables/adjustment.js`ï¼ˆè§„èŒƒåŒ–å·²æœ‰çš„ searchMobileï¼‰ |
| 2.4 | `lottery-management.html` | 3 å¤„ | `lottery/composables/redemption.js`, `lottery/composables/quota.js` |

### Phase 3ï¼šå…¶ä½™é¡µé¢æ”¹é€ ï¼ˆ0.5 å¤©ï¼‰

| åºå· | é¡µé¢ | æ”¹é€ ç‚¹ | æ¶‰åŠ JS æ–‡ä»¶ |
|---|---|---|---|
| 3.1 | `assets-portfolio.html` | 1 å¤„ | `asset/pages/assets-portfolio.js` |
| 3.2 | `user-management.html` | 3 å¤„ | `user/composables/advanced-status.js`, `user/composables/roles-permissions.js` |
| 3.3 | `trade-management.html` | 2 å¤„ | å¯¹åº” composable |
| 3.4 | `sessions.html` | 1 å¤„ | `system/pages/sessions.js` |
| 3.5 | `user-hierarchy.html` | 2 å¤„ | `user/pages/user-hierarchy.js` |

### Phase 4ï¼šæµ‹è¯•éªŒè¯ï¼ˆ0.5 å¤©ï¼‰

- æ¯ä¸ªæ”¹é€ é¡µé¢æ‰‹åŠ¨éªŒè¯ï¼šæ‰‹æœºå·æœç´¢ â†’ æ˜¾ç¤ºç”¨æˆ·å¡ç‰‡ â†’ ä¸šåŠ¡æ“ä½œæ­£å¸¸
- éªŒè¯ä¸å­˜åœ¨çš„æ‰‹æœºå·é”™è¯¯æç¤º
- éªŒè¯æ ¼å¼é”™è¯¯æç¤ºï¼ˆé 11 ä½ã€éæ•°å­—ï¼‰
- éªŒè¯ Redis ç¼“å­˜å‘½ä¸­ï¼ˆåŒä¸€æ‰‹æœºå·ç¬¬äºŒæ¬¡æœç´¢åº”æ›´å¿«ï¼‰
- éªŒè¯ `asset-adjustment.html` çš„è§„èŒƒåŒ–æ•ˆæœ

**æ€»è®¡ï¼šçº¦ 2.5 å¤©**

---

## 10. æŠ€æœ¯è¦ç‚¹å¤‡å¿˜

### 10.1 ç¼“å­˜ç­–ç•¥ï¼ˆä¸‰çº§ï¼Œé›¶æ–°å¢åç«¯ç¼“å­˜ä»£ç ï¼‰

```
å‰ç«¯ mixin Map ç¼“å­˜ï¼ˆé¡µé¢ä¼šè¯çº§ï¼ŒMap å­˜å‚¨ï¼Œé¡µé¢åˆ·æ–°å¤±æ•ˆï¼‰
  â†“ miss
åç«¯ Redis ç¼“å­˜ï¼ˆBusinessCacheHelper.getUserByMobileï¼Œ120s TTLï¼Œå·²æœ‰ï¼‰
  â†“ miss
MySQL æŸ¥è¯¢ï¼ˆusers è¡¨ï¼Œmobile å­—æ®µæœ‰ UNIQUE INDEXï¼Œå·²æœ‰ï¼‰
```

### 10.2 å®‰å…¨è€ƒè™‘

- resolve ç«¯ç‚¹åœ¨ `authenticateToken` + `requireRoleLevel(100)` ä¿æŠ¤ä¸‹ï¼ˆ`user_management.js` å¤´éƒ¨å·²å…¨å±€æŒ‚è½½ï¼‰
- è¿”å›çš„æ‰‹æœºå·åšè„±æ•å¤„ç†ï¼ˆ`138****8000`ï¼‰
- ä¸è¿”å›æ•æ„Ÿå­—æ®µï¼ˆpasswordã€token ç­‰ï¼Œusers è¡¨æœ¬èº«æ—  password å­—æ®µï¼Œå¯†ç åœ¨ JWT ä½“ç³»ä¸­ï¼‰

### 10.3 è·¯ç”±æ³¨å†Œä½ç½®

resolve è·¯ç”±å¿…é¡»åœ¨ `/users/:user_id` ä¹‹å‰æ³¨å†Œï¼Œå¦åˆ™ Express ä¼šæŠŠ `resolve` å½“ä½œ `:user_id` å‚æ•°åŒ¹é…ã€‚

```js
// âœ… æ­£ç¡®é¡ºåº
router.get('/users/resolve', async (req, res) => { ... })  // å…ˆæ³¨å†Œ
router.get('/users/:user_id', async (req, res) => { ... })  // åæ³¨å†Œ
```

### 10.4 trade-management ç‰¹æ®Šå¤„ç†

äº¤æ˜“ç®¡ç†çš„"ä¹°å®¶"å’Œ"å–å®¶"æ˜¯ä¸¤ä¸ªç‹¬ç«‹ç”¨æˆ·è¾“å…¥ï¼š
- `buyer_user_id` â†’ `buyer_mobile`ï¼ˆä¹°å®¶æ‰‹æœºå·ï¼‰
- `seller_user_id` â†’ `seller_mobile`ï¼ˆå–å®¶æ‰‹æœºå·ï¼‰
- å„è‡ªç‹¬ç«‹è°ƒ resolveï¼Œäº’ä¸å½±å“
- éœ€è¦ä¸¤ä¸ªç‹¬ç«‹çš„ `resolvedBuyer` / `resolvedSeller` çŠ¶æ€

### 10.5 API ç«¯ç‚¹è·¯å¾„ä¸€è‡´æ€§

å‰ç«¯ `USER_ENDPOINTS` ä½¿ç”¨çš„è·¯å¾„æ˜¯ `/console/user-management/...`ï¼ˆè¿å­—ç¬¦ï¼‰ï¼Œä¸åç«¯è·¯ç”±æŒ‚è½½è·¯å¾„ä¸€è‡´ï¼ˆ`index.js` ç¬¬ 86 è¡Œï¼š`router.use('/user-management', userManagementRoutes)`ï¼‰ã€‚

### 10.6 å‰ç«¯ mixin ç»„åˆç¤ºä¾‹

æ”¹é€ åçš„é¡µé¢ JS ä½¿ç”¨æ–¹å¼ï¼š

```js
import { createPageMixin } from '../../alpine/mixins/index.js'
import { UserAPI } from '../../api/user.js'

export function financeManagementPage() {
  return createPageMixin({
    pagination: { page_size: 20 },
    modal: true,
    userResolver: true,  // â† æ–°å¢ï¼šå¯ç”¨ç”¨æˆ·è§£æ
    authGuard: true
  }, {
    consumptionFilters: { mobile: '' },

    async resolveAndSearchConsumption() {
      if (this.consumptionFilters.mobile) {
        const user = await this.resolveUserByMobile(this.consumptionFilters.mobile)
        if (!user) return
        await this.loadConsumptionRecords({ user_id: user.user_id })
      } else {
        await this.loadConsumptionRecords({})
      }
    }
  })
}
```
