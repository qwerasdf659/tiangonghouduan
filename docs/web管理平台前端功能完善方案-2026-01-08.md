# Web管理平台前端功能完善方案

**版本**: v1.8（以当前代码+真实DB为准：仓库实扫`public/admin/`页面与API对齐情况 + 一次性补齐落地清单）  
**生成时间**: 2026年01月09日  
**项目**: 餐饮积分抽奖系统  
**目标**: 完善Web管理后台（`public/admin/`），使其覆盖并联动**当前后端（含`/api/v4/console`）**可提供的管理能力，并基于**真实数据库**数据做到可查可管

**数据对齐基准（以当前代码/真实DB为准）**：

- **后端路由挂载**：以 `app.js` 的 `app.use('/api/v4/...')` 为准（当前项目采用标准化域结构）
- **Console模块清单**：以 `routes/v4/console/index.js` 的 `router.use(...)` **实际挂载**为准（`modules`对象仅作自描述，存在滞后/不一致风险）
- **真实数据库**：通过 Node.js + Sequelize（读取`.env`）连接到 `restaurant_points_dev` 并做只读统计（见第4章）

---

## 0. 先回答：按本文档执行能否保证“覆盖后端数据库能力”？

**结论：当前仓库已经具备“页面承接”的主体结构（`public/admin/`已有36个管理页），但仍有少量页面与后端现行路由/响应契约不一致；需要按v1.8的“剩余缺口清单”一次性修正后，才能保证真正覆盖后端/DB能力。**  
原因（均来自当前代码状态）：

- **Console模块持续演进**（当前`/api/v4/console`实际挂载已达到**20**个子模块；console自描述`modules`仍声明`diamond`但未挂载路由），因此“以实际挂载为准”的原则仍必须坚持
- **管理后台页面已扩展**：当前仓库`public/admin/`下已有**36**个HTML页面，覆盖了绝大多数console模块与system/shop域管理入口（页面文件“承接”基本齐全）
- **仍存在少量页面与后端路由/契约不一致**：例如`lottery-quota.html`与`campaign-budget.html`仍在使用不存在的路径/旧语义；`assets-portfolio.html`/`asset-adjustment.html`/`material-*.html`/`diamond-accounts.html`依赖未实现的`/api/v4/console/assets/transactions`与`/api/v4/console/asset-adjustment/asset-types`，且对`/api/v4/console/asset-adjustment/user/:user_id/balances`的响应结构存在误解（把`balances`误当成含`user`对象与资产元数据）
- **材料/钻石的统一资产中心方向已确定**：当前页面已不再调用`/api/v4/console/material/users/*`这类“后端未实现的material用户端点”，但仍需把页面字段/调用参数对齐到现有`/api/v4/console/asset-adjustment/*`契约，并补齐“管理员资产流水查询”等必要能力（见0.5与第12章）

### 0.5 v1.8 仓库实扫核验结论（2026-01-09，以实际代码为准）

#### 0.5.1 页面是否在本项目内？是否“有页面承接”？

- ✅ **页面在本项目内**：管理后台静态资源目录为`public/admin/`，通过`app.js`挂载到`/admin/*`
- ✅ **页面承接基本齐全**：当前`public/admin/`下共有**36**个HTML页面（覆盖console模块、system域统计/通知、shop域消费审核、marketplace域B2C/C2C管理等）
- ⚠️ **但“有页面文件”≠“已可联动后端/DB”**：仍有若干页面存在路径/语义/字段契约不一致，需要按第12章一次性补齐

#### 0.5.2 已确认对齐（符合“以后端/DB为权威，不做旧路径兼容”）

> 这些页面已使用当前挂载域（`/api/v4/console`、`/api/v4/system`、`/api/v4/shop`、`/api/v4/activities`）而非旧路径族：

- `login.html`：已使用`POST /api/v4/console/auth/login`
- `notifications.html`：已对齐`/api/v4/system/notifications/*`
- `charts.html`/`statistics.html`：已对齐`/api/v4/system/statistics/*`
- `consumption.html`：已对齐`/api/v4/shop/consumption/admin/records`与`approve/reject`
- `activity-conditions.html`：已使用`/api/v4/activities/*`，且后端已按决策将activities域**全部端点收紧为仅管理员**
- `presets.html`：已重构为抽奖干预管理，已对齐`/api/v4/console/lottery-management/*`
- `exchange-market-items.html`/`exchange-market-stats.html`：已对齐`/api/v4/shop/exchange/*`（材料资产支付）

#### 0.5.3 必须修正/补齐（P0）

- `lottery-quota.html`：当前调用`/api/v4/console/lottery/quotas*`与`/api/v4/console/activities`（均不存在/语义不匹配）；需重构为对齐`/api/v4/console/lottery-quota/*`（规则/用户配额/补偿/校验）
- `campaign-budget.html`：当前调用`/api/v4/console/campaign/budgets*`与`/api/v4/console/activities`（均不存在/语义不匹配）；需重构为对齐`/api/v4/console/campaign-budget/*`（budget_mode/pool_budget/validate/pool/add/budget-status/用户BUDGET_POINTS）
- `assets-portfolio.html`：当前调用`/api/v4/console/assets/overview`（不存在）与`/api/v4/console/assets/transactions`（未实现）；需对齐`/api/v4/console/assets/portfolio*`与新增的管理员流水查询能力
- `asset-adjustment.html`/`material-balances.html`/`material-transactions.html`/`diamond-accounts.html`：虽已指向“统一资产中心”方向，但仍存在：
  - 调用未实现端点：`GET /api/v4/console/asset-adjustment/asset-types`、`GET /api/v4/console/assets/transactions`
  - 请求契约不匹配：`POST /api/v4/console/asset-adjustment/adjust`必须包含`user_id`与`idempotency_key`，且`amount`为正负delta；页面当前仍按旧字段（如`adjust_type`）组织请求
  - 响应契约不匹配：`GET /api/v4/console/asset-adjustment/user/:user_id/balances`当前仅返回`balances`数值字段（无`user`对象/无材料元数据），页面需自行通过`user-management`与`asset-types`映射补全展示
- `exchange-market-orders.html`：列表已改为使用管理员专用端点`/api/v4/console/marketplace/exchange_market/orders`，但详情仍在调用`/api/v4/shop/exchange/orders/:order_no`（该端点“只能查看自己的订单”）；需改为使用`/api/v4/console/marketplace/exchange_market/orders/:order_no`，并将支付字段从“虚拟价值/积分”对齐到材料资产支付字段（pay_asset_code/pay_amount 等）

### 0.1 权威原则（你强调的核心要求：以后端数据库/后端实现为准）

- **权威来源（从高到低）**
  - **真实数据库结构与数据**（Sequelize模型 + `information_schema`，本次以`restaurant_points_dev`为准）
  - **后端现有业务实现**（`routes/` + `services/` + `TransactionManager/Idempotency`等约束）
  - **Web管理后台页面**（`public/admin/`）：只能作为"展示与操作入口"，不得反向定义业务能力
- **落地规则**
  - **前端页面必须能映射到后端/DB的真实字段与业务语义**；如果页面存在但语义不一致（例如旧兑换市场字段、旧统计路径），以**后端/DB为准**改造页面
  - **不兼容旧web端管理平台前端的内容**：路径以`app.js`挂载为权威，**不为"迁就前端旧路径"去发明新接口**（**已决策：只改前端，不加后端兼容路由**）
  - **需要新增后端接口时**：必须是"把数据库已存在字段/已存在业务能力"以更规范的方式对外提供，而不是为前端"想要"而凭空造业务（见0.3数据库验证）

### 0.2 已拍板决策（2026-01-08）

> 以下为你明确做出的决策，后续实施必须严格遵守，不再额外询问。

| 决策项                   | 你的选择                         | 影响范围                                                                                                                                                                                                                             |
| ------------------------ | -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **旧API路径兼容**        | **A - 不兼容，只改管理后台前端** | 所有旧路径页面（`/api/v4/statistics/*`、`/api/v4/notifications/*`、`/api/v4/consumption/*`等）只改前端对齐`app.js`当前挂载，后端不增加兼容路由                                                                                       |
| **diamond模块处理**      | **B - 统一归入通用资产中心**     | `diamond-accounts.html`将改造为使用`/api/v4/console/asset-adjustment`与资产流水能力；钻石作为`DIAMOND`资产类型统一管理，不再单独做diamond模块                                                                                        |
| **管理后台认证**         | **B - 统一到console auth**       | `login.html`改为调用`/api/v4/console/auth/login`；管理员profile改为`/api/v4/console/auth/profile`                                                                                                                                    |
| **统计/图表口径**        | **以后端为准（两套都保留）**     | 后端实际有：(1)`/api/v4/system/statistics/*`（图表/报表/导出），(2)`/api/v4/console/analytics/*`（决策分析/趋势/性能/今日统计）；前端`charts.html`/`statistics.html`对齐system/statistics，新增`analytics.html`对齐console/analytics |
| **activities上线范围**   | **B - 完整闭环，仅管理员**       | ✅ 当前代码已具备`/api/v4/activities`域（available/check-eligibility/participate/conditions/configure-conditions）；按你的决策需将**全部端点收紧为仅管理员可调用**（不对外普通用户开放）                                             |
| **高风险操作权限**       | **以后端为准**                   | 资产调整/强制中奖/孤儿冻结清理等高风险操作：**仅管理员角色** + **强制二次确认** + **全量审计日志**（后端已实现`requireAdmin` + `IdempotencyService` + 审计记录）                                                                     |
| **`products`表处理**     | **A - 遗留/废弃，不做管理入口**  | 后端代码完全未使用该表，数据停留在初始化状态；如需"积分空间商品"业务，根据实际需求重新设计（见6.3.1）                                                                                                                                |
| **其他数据库表管理入口** | **全部要做**                     | `trade_orders`/`system_announcements`/`feedbacks`/`stores`/`user_premium_status`/`user_hierarchy`/`admin_operation_logs`/`lottery_draws`/`exchange_records` 全部补齐管理入口（见5.1.1/6.5）                                          |

### 0.3 数据库验证（确认"以后端数据库为权威"）

> 以下为通过 Node.js + Sequelize 连接真实数据库（`restaurant_points_dev`）的只读验证结果，用于确认本文档的所有"新增后端接口"建议都是**为数据库已存在字段/已存在业务能力提供规范API**，而非为前端凭空造业务。

| 文档建议                  | 数据库表/字段                                                                           | 验证结果                                                                                                                                                                                     | 符合"数据库已存在"原则                               |
| ------------------------- | --------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------- |
| **activities域补齐**      | `lottery_campaigns.participation_conditions` (JSON) + `condition_error_messages` (JSON) | ✅ 字段已存在，且有真实数据：`{"user_points":{"value":100,"operator":">="}}`等                                                                                                               | ✅ 是                                                |
| **抽奖干预/预设队列**     | `lottery_management_settings`表                                                         | ✅ 表已存在；真实数据中已出现`setting_type=probability_adjust(667)`、`force_win(202)`；代码侧已实现`force_lose`与`user-specific-queue`等能力（以`/api/v4/console/lottery-management/*`为准） | ✅ 是                                                |
| **DIAMOND统一到资产中心** | `account_asset_balances.asset_code`                                                     | ✅ `DIAMOND`作为asset_code值**已存在**（与POINTS/red_shard/MATERIAL_001并列）                                                                                                                | ✅ 是                                                |
| **activities独立表**      | —                                                                                       | ❌ 数据库中**无**activities相关表                                                                                                                                                            | ✅ 不需要新建表（条件存储在lottery_campaigns字段中） |

### 0.4 `products` 与 `exchange_items` 关系澄清（以DB/后端为权威）

> 你问"products（商品表）与exchange_items是什么关系"，以下为真实数据库验证结论。

| 维度         | `products` 表                                                        | `exchange_items` 表                                                                               |
| ------------ | -------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------- |
| **数据量**   | 52行                                                                 | 24行                                                                                              |
| **业务语义** | 积分/空间商品（幸运空间/臻选空间）                                   | B2C材料资产支付兑换商品                                                                           |
| **价格字段** | `exchange_points`（积分）+ `premium_exchange_points`（臻选专属积分） | `cost_asset_code` + `cost_amount`（材料资产支付）                                                 |
| **空间字段** | `space`（lucky/premium/both）                                        | 无                                                                                                |
| **外键关联** | 无（未被其他表引用）                                                 | ✅ `exchange_records.item_id → exchange_items.item_id`                                            |
| **后端路由** | ❌ **当前无管理路由挂载**                                            | ✅ `/api/v4/shop/exchange/*`（用户端）+ `/api/v4/console/marketplace/exchange_market/*`（管理端） |
| **后端服务** | 模型存在（`models/Product.js`），但无ProductService                  | ✅ `ExchangeService`（完整CRUD）                                                                  |

**结论（以DB/后端为权威）**：

- **`products` 和 `exchange_items` 是两套独立的"商品"体系**，数据库层面没有外键关联、字段语义完全不同。
- 当前后端业务代码**只围绕 `exchange_items` 构建了完整的B2C兑换流程**（ExchangeService + 路由）。
- **`products` 表有数据（52行），但当前后端未挂载管理路由**——如果你需要管理它，属于"为数据库已存在表提供规范API"（符合权威原则），需新增后端接口。

**已拍板决策（2026-01-08）**：

- ✅ **选方案A**：`products` 是遗留/废弃体系，**不做管理入口**（维持现状）
- **理由**：后端代码完全未使用该表（无路由/服务调用），数据停留在初始化状态（2025-12-12），当前业务已迁移到`exchange_items`（材料资产支付体系）
- **后续规划**：如需"积分空间商品"业务，根据实际需求重新设计并补齐后端+前端（届时按"为DB已存在能力提供接口"原则执行）

---

**结论**：本文档所有"补齐后端能力"的建议都是为**数据库已存在的字段/表**提供规范的读写API，未凭空发明业务。

---

## 📋 目录

1. [项目概述](#项目概述)
2. [后端能力清单](#后端能力清单)
3. [现有前端页面清单](#现有前端页面清单)
4. [数据库实际数据分布](#数据库实际数据分布)
5. [功能覆盖矩阵](#功能覆盖矩阵)
6. [功能缺口分析](#功能缺口分析)
7. [实施方案](#实施方案)
8. [页面导航架构](#页面导航架构)
9. [验证检查清单](#验证检查清单)

---

## 1. 项目概述

### 1.1 需求背景

- **核心需求**: Web管理平台前端功能需要完全对齐**后端数据库+后端现有业务实现**提供的能力（后端/DB是权威）
- **技术约束**:
  - 项目未安装MySQL客户端，使用Node.js + Sequelize连接数据库
  - 配置信息存储在`.env`文件中
  - 需要基于真实数据库数据而非备份文件
- **实施原则**:
  - 先在本文档固化方案与验收口径，再按方案一次性落地到本仓库（前端为主；后端仅补齐“对DB既有能力的规范暴露”）
  - 所有数据和功能必须与实际业务逻辑和商业模式对齐

### 1.2 商业模式理解

基于代码和数据库分析，项目的核心商业模式包括：

1. **积分系统**: POINTS（普通积分）、BUDGET_POINTS（预算积分）、DIAMOND（钻石）
2. **材料资产系统**: 可转换、可兑换的虚拟材料资产
3. **抽奖系统**: 基于预算池的抽奖活动，支持多种奖品类型
4. **B2C兑换市场**: 用户使用材料资产兑换实物/虚拟商品
5. **C2C交易市场**: 用户之间交易物品实例
6. **消费记录审核**: 用户提交消费记录，管理员审核后发放奖励
7. **会员系统**: 高级会员功能和权限管理

---

## 2. 后端能力清单

### 2.1 Console API模块概览

后端提供了`/api/v4/console`控制台域（见`app.js`挂载），其子模块**以`routes/v4/console/index.js`中`router.use(...)`实际挂载为准**。

| Console模块        | 路由前缀（相对`/api/v4/console`） | 主要用途                                                                        | 现有管理后台页面（`public/admin/*.html`）                                                                             | 覆盖状态                                                                                                                                 |
| ------------------ | --------------------------------- | ------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------- |
| system             | `/system/*`                       | 监控/仪表盘                                                                     | `dashboard.html`                                                                                                      | ✅                                                                                                                                       |
| settings           | `/settings/*` + `/cache/clear`    | 运营配置/缓存清理                                                               | `settings.html`                                                                                                       | ✅                                                                                                                                       |
| prize-pool         | `/prize-pool/*`                   | 奖品池管理                                                                      | `prizes.html`（`users.html`也会读取默认活动奖品）                                                                     | ✅                                                                                                                                       |
| user-management    | `/user-management/*`              | 用户/角色/状态管理                                                              | `users.html`、`customer-service.html`                                                                                 | ✅                                                                                                                                       |
| lottery-management | `/lottery-management/*`           | 抽奖强控/个性化配置                                                             | `users.html`仅覆盖`probability-adjust`                                                                                | 🟡（缺force-win/force-lose等）                                                                                                           |
| customer-service   | `/customer-service/*`             | 客服会话/消息/转接                                                              | `customer-service.html`                                                                                               | ✅                                                                                                                                       |
| marketplace        | `/marketplace/*`                  | C2C上架统计；以及兑换商品的后台CRUD入口                                         | `marketplace-stats.html`（兑换商品CRUD前端未对齐，见第6章）                                                           | 🟡                                                                                                                                       |
| material           | `/material/*`                     | 材料资产类型/规则（✅已实现）；余额/流水（⚠️ material用户端点现状需二选一处理） | `material-asset-types.html`、`material-conversion-rules.html`、`material-balances.html`、`material-transactions.html` | 🟡（`material.js`当前仅实现`asset-types`与`conversion-rules`；余额/流水页需改走`asset-adjustment`或补齐后端material用户端点，见5.2/6.1） |
| popup-banners      | `/popup-banners/*`                | 弹窗Banner                                                                      | `popup-banners.html`                                                                                                  | ✅                                                                                                                                       |
| lottery-quota      | `/lottery-quota/*`                | 抽奖配额规则/用户配额                                                           | 无                                                                                                                    | ❌                                                                                                                                       |
| asset-adjustment   | `/asset-adjustment/*`             | 通用资产调整（含批量/幂等）                                                     | 无                                                                                                                    | ❌                                                                                                                                       |
| campaign-budget    | `/campaign-budget/*`              | 活动预算(BUDGET_POINTS)/预算池                                                  | 无                                                                                                                    | ❌                                                                                                                                       |
| assets             | `/assets/*`                       | 运营资产中心（物品/事件/组合）                                                  | 无                                                                                                                    | ❌                                                                                                                                       |
| images             | `/images/*`                       | 通用图片上传/绑定/删除                                                          | 无                                                                                                                    | ❌                                                                                                                                       |
| orphan-frozen      | `/orphan-frozen/*`                | 孤儿冻结检测/统计/清理                                                          | 无                                                                                                                    | ❌                                                                                                                                       |
| merchant-points    | `/merchant-points/*`              | 商家积分审核/记录                                                               | 无                                                                                                                    | ❌                                                                                                                                       |
| analytics          | `/analytics/*`                    | 决策/趋势/性能分析                                                              | 无                                                                                                                    | ❌                                                                                                                                       |
| config             | `/config/*`                       | 配置/模拟测试                                                                   | 无                                                                                                                    | ❌                                                                                                                                       |
| auth               | `/auth/*`                         | 控制台认证（`POST /login` + `GET /profile`）                                    | `login.html`                                                                                                          | ✅（**已决策**：统一到`/api/v4/console/auth/*`）                                                                                         |

> ⚠️ 重要：`routes/v4/console/index.js`的`modules`对象**对外声明了diamond模块**，但当前仓库中没有对应路由文件且未挂载`/diamond`。**已决策**：不单独做diamond模块，统一归入"通用资产中心"（把钻石作为`DIAMOND`资产类型管理），`diamond-accounts.html`将改造为使用`asset-adjustment`/资产流水能力。

### 2.2 详细功能清单

#### 2.2.1 资产管理 (`/console/assets`)

**资产调整功能** (`/console/asset-adjustment.js`):

- `POST /adjust` - 单用户资产调整（POINTS/BUDGET_POINTS/DIAMOND/材料）
- `POST /batch-adjust` - 批量用户资产调整
- `GET /user/:user_id/balances` - 查询用户所有资产余额
- **特性**:
  - 强制要求`idempotency_key`防止重复提交
  - 完整的审计日志记录
  - 事务管理确保原子性

**资产组合查询** (`/console/assets/portfolio.js`):

- `GET /portfolio` - 运营资产中心总览（组合视角）
- `GET /portfolio/items` - 物品实例列表（支持分页/筛选）
- `GET /portfolio/items/:item_instance_id` - 物品实例详情
- `GET /item-events` - 物品事件历史（按条件查询）

**孤立冻结资产管理** (`/console/orphan-frozen.js`):

- `GET /detect` - 检测孤儿冻结（仅检测，不清理）
- `GET /stats` - 获取孤儿冻结统计报告
- `POST /cleanup` - 清理孤儿冻结（默认dry-run；`dry_run=false`需要超级管理员role_level>=100且必填reason/operator_name）
- **业务场景**: 处理因交易失败、订单取消等导致的冻结资产未正确释放问题

#### 2.2.2 材料系统管理 (`/console/material.js`)

**转换规则管理**:

- `GET /conversion-rules` - 查询转换规则列表（支持分页、筛选）
- `POST /conversion-rules` - 创建新转换规则
- `PUT /conversion-rules/:rule_id/disable` - 禁用转换规则
- **特性**:
  - 版本控制（每次修改创建新版本）
  - 循环检测（防止A→B→A的转换链）
  - 风险控制检查

**资产类型管理**:

- `GET /asset-types` - 查询材料资产类型列表
- `POST /asset-types` - 创建新材料资产类型
- `PUT /asset-types/:asset_code/disable` - 禁用资产类型

> ⚠️ 校验结论（以当前代码为准）：`routes/v4/console/material.js` **目前未实现** `GET /users/:user_id/balance`、`POST /users/:user_id/adjust`、`GET /transactions` 等“material用户余额/流水”端点。  
> 因此管理后台中 `material-balances.html` / `material-transactions.html` 需要在方案中明确二选一：
>
> - **方案A（推荐，少造轮子）**：改前端走 `console/asset-adjustment`（余额用`GET /asset-adjustment/user/:user_id/balances`；调整用`POST /asset-adjustment/adjust`；流水另补一个“管理员按用户查询资产流水”端点）
> - **方案B（补齐material模块端点）**：在后端`console/material`补齐余额/调整/流水端点（本质上仍是对`account_asset_balances`/`asset_transactions`的规范暴露）

#### 2.2.3 抽奖活动管理 (`/console/campaign-budget.js`)

**预算配置**:

- `GET /campaigns/:campaign_id` - 查询活动预算配置
- `PUT /campaigns/:campaign_id` - 更新活动预算配置
- `POST /campaigns/:campaign_id/validate` - 验证奖品配置合理性
- `POST /campaigns/:campaign_id/pool/add` - 补充预算池
- `GET /campaigns/:campaign_id/budget-status` - 查询预算池状态

**用户预算查询**:

- `GET /users/:user_id` - 查询用户预算积分余额

#### 2.2.4 图片资源管理 (`/console/images.js`)

**统一图片管理**:

- `POST /upload` - 上传图片（支持多业务类型）
- `GET /:image_id` - 获取图片详情
- `GET /` - 查询图片列表（支持按业务类型筛选）
- `PATCH /:image_id/bind` - 绑定图片到业务记录
- `DELETE /:image_id` - 物理删除图片
- **支持业务类型**: lottery（抽奖）、exchange（兑换）、trade（交易）、uploads（通用）

#### 2.2.5 市场管理

**C2C交易市场** (`/console/marketplace`):

- `GET /listing-stats` - 用户挂单统计（接近/达到上限的用户）
- **数据维度**: 总挂单用户数、挂单数量分布、用户详细列表

**B2C兑换市场（以当前路由挂载为准）**：

- **商品列表/详情（兼容管理员full数据）**：`/api/v4/shop/exchange/items`、`/api/v4/shop/exchange/items/:item_id`
  - 说明：该端点会根据登录用户角色决定数据脱敏等级（admin返回full），因此管理后台可直接复用“shop域GET”作为列表与详情的数据源
- **后台商品增删改（仅管理员）**：`/api/v4/console/marketplace/exchange_market/items`
  - `POST /items` 创建
  - `PUT /items/:item_id` 更新
  - `DELETE /items/:item_id` 删除
- **订单（现状：管理能力不完整）**：`/api/v4/shop/exchange/orders*`
  - `GET /orders`、`GET /orders/:order_no`：当前实现为“只能查看自己的订单”
  - `POST /orders/:order_no/status`：管理员可更新订单状态
  - ⚠️ 缺口：管理后台需要“管理员查看全量订单列表/详情/筛选”，现有后端未提供，需要新增 admin-only 查询端点（属于对`exchange_records`既有表能力的规范暴露，见6.5/5.1.1）

#### 2.2.6 系统功能

**通知管理** (`/system/notifications.js`):

- `GET /` - 通知列表（支持类型、状态筛选）
- `GET /:notification_id` - 通知详情
- `POST /:notification_id/read` - 标记单条已读
- `POST /read-all` - 标记全部已读
- `POST /clear` - 清空已读通知
- `POST /send` - 发送新通知

**统计报表** (`/system/statistics.js`):

- `GET /charts` - 图表统计数据
- `GET /report` - 综合报表数据
- `GET /export` - 导出Excel报表
- **当前已实现的参数口径（以代码为准）**:
  - `GET /charts?days=7|30|90`（默认30）
  - `GET /report?period=week|month|year`（当前实现为fallback：用`getChartsData(7/30/365)`替代，代码注释已明确“缺少getStatisticsReport方法”）
  - `GET /export?days=7|30|90`（二进制Excel流下载，属规范允许的特例）
- ⚠️ 现状差异：当前未实现 today/yesterday/custom(start_date/end_date) 口径；如管理后台需要这些维度，必须补齐 ReportingService/Statistics 的真实报表方法（属于“对既有统计能力的完善”，不是为迁就旧前端路径造业务）

**抽奖预设** (`/lottery/lottery-preset.js`):

- `POST /create` - 为指定用户创建抽奖预设
- `GET /list` - 查询预设列表（支持分页、筛选）
- `GET /stats` - 预设统计数据

**消费记录审核** (`/shop/consumption/review.js`):

- `GET /admin/records` - 查询所有消费记录（支持筛选、搜索）
- `POST /approve/:record_id` - 批准消费记录
- `POST /reject/:record_id` - 拒绝消费记录

---

## 3. 现有前端页面清单

### 3.1 已实现页面

| 页面文件                         | 页面标题         | 主要功能                       | 当前调用的API前缀（从页面源码提取）                                                                         | 与当前后端挂载是否一致（以`app.js`为准）                                                                                                                                   |
| -------------------------------- | ---------------- | ------------------------------ | ----------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `login.html`                     | 登录             | 管理员登录                     | `/api/v4/auth/login`                                                                                        | 🟡（后端挂载✅可用，但**已决策**统一到`/api/v4/console/auth/login`）                                                                                                       |
| `dashboard.html`                 | 数据仪表盘       | 管理后台概览、快捷入口         | `/api/v4/console/system/dashboard`                                                                          | ✅                                                                                                                                                                         |
| `users.html`                     | 用户管理         | 用户/角色/状态；个性化概率调整 | `/api/v4/console/user-management/*`、`/api/v4/console/lottery-management/*`、`/api/v4/console/prize-pool/*` | ✅（但`lottery-management`仅覆盖部分端点）                                                                                                                                 |
| `prizes.html`                    | 奖品池配置       | 奖品增删改/库存                | `/api/v4/console/prize-pool/*`                                                                              | ✅                                                                                                                                                                         |
| `settings.html`                  | 系统设置         | 运营配置、缓存清理             | `/api/v4/console/settings/*`、`/api/v4/console/cache/clear`                                                 | ✅                                                                                                                                                                         |
| `popup-banners.html`             | 弹窗Banner管理   | Banner CRUD/统计               | `/api/v4/console/popup-banners/*`                                                                           | ✅                                                                                                                                                                         |
| `customer-service.html`          | 客服工作台       | 会话列表/消息/转接/关闭        | `/api/v4/console/customer-service/*`、`/api/v4/console/user-management/*`                                   | ✅                                                                                                                                                                         |
| `marketplace-stats.html`         | 市场统计         | C2C上架统计                    | `/api/v4/console/marketplace/listing-stats`                                                                 | ✅                                                                                                                                                                         |
| `material-asset-types.html`      | 材料资产类型管理 | 类型CRUD                       | `/api/v4/console/material/asset-types`                                                                      | ✅                                                                                                                                                                         |
| `material-conversion-rules.html` | 材料转换规则管理 | 规则CRUD                       | `/api/v4/console/material/conversion-rules`                                                                 | ✅                                                                                                                                                                         |
| `material-transactions.html`     | 材料流水         | 材料流水查询                   | `/api/v4/console/material/transactions`                                                                     | 🔴（后端`console/material`当前未实现`/transactions`；需改走`asset-adjustment`/新增管理员按用户查询资产流水端点，见2.2.2/5.2）                                              |
| `material-balances.html`         | 材料余额         | 用户材料余额查询/调整          | `/api/v4/console/material/users/*` + `/api/v4/console/users/search`                                         | 🔴（后端同时缺`/console/material/users/*`与`/console/users/search`；建议余额/调整改走`/console/asset-adjustment/*`，用户搜索改走`/console/user-management/users?search=`） |
| `diamond-accounts.html`          | 钻石账户         | 钻石余额/调整/流水             | `/api/v4/console/diamond/*` + `/api/v4/console/users/search`                                                | 🔴（console未挂载diamond模块，且`/console/users/search`不存在）                                                                                                            |
| `exchange-market-items.html`     | 兑换商品管理     | 商品列表/编辑/删除             | `/api/v4/exchange_market/*` + `/api/v4/console/exchange_market/*`                                           | 🔴（现有后端：列表/详情应改为`/api/v4/shop/exchange/items*`；增删改应改为`/api/v4/console/marketplace/exchange_market/items*`；当前旧路径均未挂载）                        |
| `exchange-market-orders.html`    | 兑换订单管理     | 订单列表/详情/状态更新         | `/api/v4/exchange_market/orders*`                                                                           | 🔴（应改为`/api/v4/shop/exchange/orders*`；但现状仅能查看“自己的订单”，管理后台要看全量订单需补后端admin-only查询端点，见2.2.5/6.5）                                       |
| `exchange-market-stats.html`     | 兑换统计         | 兑换统计图表                   | `/api/v4/exchange_market/statistics`                                                                        | 🔴（同上，应对齐到`/api/v4/shop/exchange/statistics`）                                                                                                                     |
| `consumption.html`               | 消费记录审核     | 审核/拒绝/列表                 | `/api/v4/consumption/*`                                                                                     | 🔴（应对齐到`/api/v4/shop/consumption/*`）                                                                                                                                 |
| `notifications.html`             | 通知中心         | 通知列表/发送/已读/清空        | `/api/v4/notifications/*`                                                                                   | 🔴（应改前端到`/api/v4/system/notifications/*`；且`clear`当前前端用DELETE，但后端为POST）                                                                                  |
| `charts.html`                    | 图表可视化       | 统计图表                       | `/api/v4/statistics/charts`                                                                                 | 🔴（应改前端到`/api/v4/system/statistics/charts?days=...`）                                                                                                                |
| `statistics.html`                | 数据统计报表     | 报表/导出                      | `/api/v4/statistics/report`、`/api/v4/statistics/export`                                                    | 🔴（应改前端到`/api/v4/system/statistics/report?period=...` 与 `/api/v4/system/statistics/export?days=...`；且当前后端未实现today/yesterday/custom口径，见2.2.6）          |
| `presets.html`                   | 抽奖预设管理     | 预设创建/列表（含激活按钮）    | `/api/v4/lottery-preset/*`                                                                                  | 🔴（后端实际为`/api/v4/lottery/preset/*`，且当前无`activate`端点）                                                                                                         |
| `activity-conditions.html`       | 活动条件配置     | 活动条件配置                   | `/api/v4/lottery/campaigns*`、`/api/v4/activities/*`                                                        | 🟡（后端现已挂载`/api/v4/activities`与`/api/v4/lottery/campaigns`；下一步是按“仅管理员可调用”收紧activities权限，并对齐页面读写条件字段与错误提示字段）                    |

### 3.2 页面功能特性分析

#### 通用特性

- ✅ 统一的API请求封装（`admin-common.js`）
- ✅ JWT Token认证机制
- ✅ 错误处理和用户提示
- ✅ 分页和筛选功能
- ✅ 响应式布局（Bootstrap 5）

#### 高级特性

- ✅ WebSocket实时通知（`notifications.html`）
- ✅ 图表可视化（Chart.js）
- ✅ Excel/PDF导出（`statistics.html`）
- ✅ 批量操作支持
- ✅ 搜索和过滤功能

---

## 4. 数据库实际数据分布

### 4.1 数据库连接信息

- **数据库**: `restaurant_points_dev`（来自 `SELECT DATABASE()` 的真实结果）
- **连接方式**: Node.js + Sequelize ORM
- **配置来源**: `.env`文件
- **连接状态**: ✅ 已验证连接成功

### 4.2 核心数据表统计

> 说明：以下为**真实数据库只读快照（2026-01-08）**，用于校验“管理后台应覆盖的数据规模/状态枚举”。  
> 行数来自`COUNT(*)`（非估算值）。

| 表                            | 行数（COUNT(\*)） | 说明                                                                |
| ----------------------------- | ----------------: | ------------------------------------------------------------------- |
| `users`                       |                23 | 用户表（当前`status`全部为`active`）                                |
| `account_asset_balances`      |                11 | 账户资产余额（含POINTS/DIAMOND/材料资产）                           |
| `asset_transactions`          |              1373 | 资产流水（多资产类型）                                              |
| `item_instances`              |               606 | 物品实例（可用/锁定/已使用）                                        |
| `item_instance_events`        |               331 | 物品事件（用于运营资产中心追溯）                                    |
| `market_listings`             |                24 | C2C挂单（当前状态全部为`withdrawn`）                                |
| `trade_orders`                |                 0 | C2C交易订单（当前为空）                                             |
| `exchange_items`              |                24 | B2C兑换商品（材料资产支付体系，有完整后端路由）                     |
| `exchange_records`            |                 0 | B2C兑换订单记录（当前为空；但后端已有订单域能力）                   |
| `products`                    |                52 | 积分/空间商品（遗留/废弃体系，**已决策不做管理入口**，见0.4/6.3.1） |
| `redemption_orders`           |               268 | 兑换订单（当前为`pending`与`expired`各134）                         |
| `system_announcements`        |                 5 | 系统公告/通知基础表                                                 |
| `feedbacks`                   |                26 | 用户反馈（待回复/处理中/已回复/关闭）                               |
| `material_asset_types`        |                 3 | 材料资产类型                                                        |
| `material_conversion_rules`   |                 1 | 材料转换规则                                                        |
| `image_resources`             |                 2 | 图片资源（Sealos对象存储绑定）                                      |
| `api_idempotency_requests`    |               438 | 幂等请求记录（高风险操作必备）                                      |
| `admin_operation_logs`        |              1192 | 管理员审计日志（关键操作追溯）                                      |
| `popup_banners`               |                 0 | 弹窗Banner（当前为空）                                              |
| `lottery_campaigns`           |                 1 | 抽奖活动                                                            |
| `lottery_prizes`              |                 9 | 抽奖奖品                                                            |
| `lottery_presets`             |                 2 | 抽奖预设                                                            |
| `lottery_management_settings` |               869 | 抽奖干预设置（概率调整/强控等）                                     |
| `lottery_draws`               |                 1 | 抽奖记录（可在分析页展示）                                          |
| `lottery_draw_quota_rules`    |                 1 | 抽奖配额规则                                                        |
| `customer_service_sessions`   |                 3 | 客服会话                                                            |
| `websocket_startup_logs`      |               808 | WebSocket启动/运行日志（观测/排障）                                 |

#### 关键分布（真实数据）

- **users.status**：`active=23`
- **item_instances.status**：`used=304`，`locked=162`，`available=140`（合计606）
- **market_listings.status**：`withdrawn=24`
- **exchange_items.status**：`active=24`
- **redemption_orders.status**：`pending=134`，`expired=134`（合计268）
- **account_asset_balances（按asset_code汇总）**：
  - `POINTS`: 7个账户，available合计 48352，frozen合计 0
  - `red_shard`: 2个账户，available合计 44070，frozen合计 0
  - `DIAMOND`: 1个账户，available合计 125700，frozen合计 0
  - `MATERIAL_001`: 1个账户，available合计 100，frozen合计 0
- **asset_transactions（按asset_code分布）**：`red_shard=1363`，`POINTS=8`，`DIAMOND=1`，`MATERIAL_001=1`

### 4.3 数据完整性验证

✅ **所有核心业务表均有实际数据**
✅ **状态字段分布合理，符合业务流程**
✅ **资产类型多样，支持复杂的资产管理需求**
✅ **交易和订单数据完整，可追溯**

---

## 5. 功能覆盖矩阵

### 5.1 Console模块覆盖（以`routes/v4/console/index.js`实际挂载为准）

> 目标：让每个Console模块都能在管理后台有“可查看/可操作”的页面入口，并且接口路径与`app.js`挂载一致。

| 模块                    | 后端是否已挂载 | 现有页面                   | 状态  | 下一步（满足“可联动查看数据/可操作”）                                                                                                                                             |
| ----------------------- | -------------- | -------------------------- | ----- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| system                  | ✅             | `dashboard.html`           | ✅    | 保持                                                                                                                                                                              |
| settings                | ✅             | `settings.html`            | ✅    | 保持                                                                                                                                                                              |
| prize-pool              | ✅             | `prizes.html`              | ✅    | 保持                                                                                                                                                                              |
| user-management         | ✅             | `users.html`               | ✅    | 保持                                                                                                                                                                              |
| lottery-management      | ✅             | `users.html`（仅概率调整） | 🟡    | 补齐force-win/force-lose/队列/清理等入口（建议新页或在用户详情扩展）                                                                                                              |
| customer-service        | ✅             | `customer-service.html`    | ✅    | 保持                                                                                                                                                                              |
| marketplace             | ✅             | `marketplace-stats.html`   | 🟡    | 兑换商品CRUD端点在该模块下，但前端页未对齐（见5.2）                                                                                                                               |
| material                | ✅             | `material-*` 4页           | 🟡    | `asset-types`/`conversion-rules`页面可用；`material-balances.html`/`material-transactions.html`需二选一：改走`asset-adjustment`或补齐后端material用户余额/流水端点（见2.2.2/5.2） |
| popup-banners           | ✅             | `popup-banners.html`       | ✅    | 保持                                                                                                                                                                              |
| lottery-quota           | ✅             | 无                         | ❌    | 新增`lottery-quota.html`（规则CRUD、用户配额查询/加次数/校验）                                                                                                                    |
| asset-adjustment        | ✅             | 无                         | ❌    | 新增`asset-adjustment.html`（POINTS/BUDGET_POINTS/DIAMOND/材料统一调整 + 批量 + 幂等提示）                                                                                        |
| campaign-budget         | ✅             | 无                         | ❌    | 新增`campaign-budget.html`（活动预算配置、validate、池补充、预算状态、用户BUDGET_POINTS查询）                                                                                     |
| assets                  | ✅             | 无                         | ❌    | 新增`assets-portfolio.html`（资产总览、物品列表/详情、事件历史）                                                                                                                  |
| images                  | ✅             | 无                         | ❌    | 新增`image-resources.html`（上传、列表、绑定、删除/清理）                                                                                                                         |
| orphan-frozen           | ✅             | 无                         | ❌    | 新增`orphan-frozen.html`（detect/stats/cleanup + dry-run）                                                                                                                        |
| merchant-points         | ✅             | 无                         | ❌    | 新增`merchant-points.html`（商家积分审核/记录查询/筛选；高风险写操作需二次确认+审计）                                                                                             |
| analytics               | ✅             | 无                         | ❌    | **已决策**：新增`analytics.html`对齐`/api/v4/console/analytics/*`（决策分析/趋势/性能/今日统计）；`charts.html`/`statistics.html`保留但对齐`/api/v4/system/statistics/*`          |
| config                  | ✅             | 无                         | ❌    | 新增`config-tools.html`（配置查看/模拟测试；只读为主）                                                                                                                            |
| auth                    | ✅             | `login.html`               | 🟡    | **已决策**：统一到`/api/v4/console/auth/*`，改造`login.html`调用路径                                                                                                              |
| diamond（声明但未挂载） | ❌             | `diamond-accounts.html`    | 🔴→✅ | **已决策**：不补diamond模块，改造`diamond-accounts.html`统一走`asset-adjustment`/资产流水能力（钻石=`DIAMOND`资产类型）                                                           |

### 5.1.1 数据库表覆盖补充说明

> 除Console模块外，以下数据库表需明确管理入口归属：

| 表                     | 数据量 | 当前后端路由                                                               | 管理入口状态                 | 说明                                                                                |
| ---------------------- | -----: | -------------------------------------------------------------------------- | ---------------------------- | ----------------------------------------------------------------------------------- |
| `exchange_items`       |     24 | ✅ `/api/v4/shop/exchange/*` + `/console/marketplace/*`                    | 🔴→✅ 需对齐路径             | B2C材料兑换商品，见5.2                                                              |
| `exchange_records`     |      0 | 🟡 `/api/v4/shop/exchange/orders*`（仅本人订单；管理员仅有状态更新与统计） | 🔴→✅ 需补齐能力             | B2C兑换订单：管理后台需要“全量订单列表/详情/筛选”，现有后端未提供admin-only查询端点 |
| `products`             |     52 | ❌ 无管理路由                                                              | ✅ **已决策不做**（见6.3.1） | 遗留/废弃体系，后端未使用                                                           |
| `trade_orders`         |      0 | ✅ TradeOrderService，❌ 无console路由                                     | ✅ **已决策要做**            | C2C交易订单，需补齐console路由+前端                                                 |
| `system_announcements` |      5 | ✅ `/console/system/announcements/*`                                       | ✅ **已决策要做**            | 系统公告，后端已有，需补前端页面                                                    |
| `feedbacks`            |     26 | ✅ `/console/system/feedbacks/*`                                           | ✅ **已决策要做**            | 用户反馈，后端已有，需补前端页面                                                    |
| `stores`               |      0 | ❌ 无后端路由/服务                                                         | ✅ **已决策要做**            | 门店信息，需补齐后端+前端                                                           |
| `user_premium_status`  |      1 | ✅ PremiumService                                                          | ✅ **已决策要做**            | 高级会员，可在users.html扩展                                                        |
| `user_hierarchy`       |      0 | ✅ HierarchyManagementService，❌ 无路由                                   | ✅ **已决策要做**            | 用户层级，需补齐console路由+前端                                                    |
| `admin_operation_logs` |   1192 | ✅ AuditLogService，❌ 无独立查询路由                                      | ✅ **已决策要做**            | 审计日志，需补齐console路由+前端页面                                                |
| `lottery_draws`        |      1 | ✅ 在analytics中有统计                                                     | ✅ **已决策要做**            | 抽奖记录，可在analytics.html展示                                                    |
| `redemption_orders`    |    256 | ✅ `/api/v4/shop/redemption/*`                                             | ✅ 已有核销流程              | 核销订单                                                                            |

### 5.2 现有页面的API路径对齐清单（P0）

> 目标：先把"页面存在但无法联动"的问题清掉：**路径对齐 + 能力对齐（字段/业务规则对齐）**。

| 页面                          | 当前调用                                                                       | 当前后端实际可用/建议改为                                                                                                                                                                                       | 备注                                                                                                                                |
| ----------------------------- | ------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------- | ----- | ----------------------------------------------- | --- | --- | ---------------------------------------------------------------------------------------------- |
| `login.html`                  | `POST /api/v4/auth/login`                                                      | **已决策**：`POST /api/v4/console/auth/login` + `GET /api/v4/console/auth/profile`                                                                                                                              | 统一“管理后台认证口径”为console auth                                                                                                |
| `material-balances.html`      | `/api/v4/console/material/users/*` + `/api/v4/console/users/search?mobile=...` | **推荐**：余额查询改为`GET /api/v4/console/asset-adjustment/user/:user_id/balances`；调整改为`POST /api/v4/console/asset-adjustment/adjust`；用户搜索改为`GET /api/v4/console/user-management/users?search=...` | 现有后端未实现`console/material/users/*`与`console/users/search`                                                                    |
| `material-transactions.html`  | `/api/v4/console/material/transactions`                                        | 增加“管理员按用户查询资产流水”端点（建议归属`console/assets`或`console/asset-adjustment`），前端以`asset_code`筛选材料类流水                                                                                    | 现有后端未实现`console/material/transactions`                                                                                       |
| `diamond-accounts.html`       | `/api/v4/console/diamond/*` + `/console/users/search`                          | **已决策B**：改为`/api/v4/console/asset-adjustment/*`+资产流水查询，钻石作为`DIAMOND`资产类型统一管理                                                                                                           | 不再单独做diamond模块                                                                                                               |
| `exchange-market-*.html`      | `/api/v4/exchange_market/*` + `/api/v4/console/exchange_market/*`              | 商品列表/详情：`/api/v4/shop/exchange/items*`（管理员登录返回full数据）；商品增删改：`/api/v4/console/marketplace/exchange_market/items*`；统计：`/api/v4/shop/exchange/statistics`                             | 旧路径均未挂载；字段需从旧`virtual_value_price/price_type`对齐到`cost_asset_code/cost_amount`等材料支付字段                         |
| `consumption.html`            | `/api/v4/consumption/*`                                                        | `/api/v4/shop/consumption/*`                                                                                                                                                                                    | 当前后端挂载在shop域                                                                                                                |
| `exchange-market-orders.html` | `/api/v4/exchange_market/orders*`                                              | 状态更新：`POST /api/v4/shop/exchange/orders/:order_no/status`（已存在）；**列表/详情**：需新增`admin-only`查询端点（建议：`GET /api/v4/shop/exchange/admin/orders*`）                                          | 现有`GET /shop/exchange/orders*`仅本人订单，无法满足管理后台“全量订单管理”                                                          |
| `notifications.html`          | `/api/v4/notifications/*`                                                      | **已决策A**：改前端到`/api/v4/system/notifications/*`                                                                                                                                                           | 注意：`clear`后端为`POST /clear`，前端当前用DELETE需要修正                                                                          |
| `charts.html`                 | `/api/v4/statistics/charts`                                                    | 改为`/api/v4/system/statistics/charts?days=7                                                                                                                                                                    | 30                                                                                                                                  | 90`   | system/statistics当前以`days`为口径             |
| `statistics.html`             | `/api/v4/statistics/report                                                     | export`                                                                                                                                                                                                         | 改为`/api/v4/system/statistics/report?period=week                                                                                   | month | year`与`/api/v4/system/statistics/export?days=7 | 30  | 90` | ⚠️ 当前后端未实现today/yesterday/custom口径；如需要，需补齐ReportingService报表能力（见2.2.6） |
| `presets.html`                | `/api/v4/lottery-preset/*`（含activate）                                       | **已决策**：重构为"抽奖干预/预设队列管理"，对齐`/api/v4/console/lottery-management/*`                                                                                                                           | 激活=`user-specific-queue`；查看=`user-status/:user_id`；撤销=`clear-user-settings/:user_id`；强控=`force-win/force-lose`           |
| `activity-conditions.html`    | `/api/v4/lottery/campaigns*`、`/api/v4/activities/*`                           | **已决策B**：activities域当前已具备；按决策将**全部端点收紧为仅管理员可调用**，并将页面读写统一到`/api/v4/activities/*`                                                                                         | 端点：available/check-eligibility/participate/conditions/configure-conditions（现状部分为登录用户可用，需后端收紧为`requireAdmin`） |

---

## 6. 功能缺口分析

### 6.1 P0：先让"已有页面"真正能联动数据

- **API路径统一**：按第5.2表逐页修正（**已决策：只改前端，不加后端兼容路由**），目标是"页面所有请求都能命中当前后端挂载路径"
- **认证口径统一**：`login.html`改为调用`/api/v4/console/auth/login`（**已决策**）
- **业务字段对齐**：重点是兑换市场（旧virtual_value → 现材料资产支付）与抽奖预设（重构为干预管理页）
- **diamond模块处理**：**已决策**不单独做diamond模块，`diamond-accounts.html`改造为走通用资产中心能力

### 6.2 P0：补齐Console缺失模块页面（让19/19模块可用）

- **lottery-quota**：新增管理页面（规则管理 + 用户配额查询/临时加次数/校验）
- **asset-adjustment**：新增统一资产调整页面（含批量、幂等提示、查询用户balances）
- **campaign-budget**：新增预算配置页面（budget_mode、validate、pool补充、budget-status、用户BUDGET_POINTS查询）
- **assets（运营资产中心）**：新增资产中心页面（overview/items/item-events）
- **images**：新增图片资源管理页面（upload/list/bind/delete）
- **orphan-frozen**：新增清理工具页（detect/stats/cleanup + dry-run）
- **analytics/config**：新增分析/工具页（或与现有charts/statistics合并，但必须先完成路径对齐）

### 6.3 P1：补齐"部分覆盖"的模块能力

- **lottery-management**：补齐force-win/force-lose/队列/清理等入口（可在用户详情页扩展）
- **material**：补齐用户搜索与批量调整（可选）

### 6.3.1 已决策：`products` 表（积分/空间商品体系）不做管理入口

> 见0.4的数据库验证结论：`products`（52行）与`exchange_items`（24行）是两套独立商品体系，前者当前后端无管理路由。

**已拍板决策（2026-01-08）**：

- ✅ **选方案A**：`products` 是遗留/废弃体系，**不做管理入口**
- **验证依据**（以后端/DB为权威）：
  - 后端路由/服务**完全未调用**`Product`模型（仅有模型定义，无业务使用）
  - 数据库无其他表外键引用`products`
  - 数据停留在初始化状态（最后更新：2025-12-12）
  - 当前业务已迁移到`exchange_items`（材料资产支付体系）
- **后续规划**：如需"积分空间商品"业务，根据实际需求重新设计并补齐后端+前端（届时按"为DB已存在能力提供接口"原则执行）

**本文档不再涉及`products`表的管理入口建设。**

### 6.5 已决策：补齐其他数据库表的管理入口（全部要做）

> 你明确要求"这些功能都要做，web端管理平台前端页面都要做"，以下为执行方案（以后端/DB为权威）。

| 表                       | 数据量 | 后端现状                                                                               | 执行方案                                                                                                                                                                                                                                                 | 优先级 |
| ------------------------ | -----: | -------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------ |
| **trade_orders**         |      0 | ✅ 有TradeOrderService，❌ 无console路由                                               | 补齐`/api/v4/console/marketplace/trade-orders/*`（列表/详情/状态管理）+ `trade-orders.html`                                                                                                                                                              | P1     |
| **system_announcements** |      5 | ✅ 已有`/api/v4/console/system/announcements/*`（CRUD）                                | 只需新增`announcements.html`对齐现有后端                                                                                                                                                                                                                 | P0     |
| **feedbacks**            |     26 | ✅ 已有`/api/v4/console/system/feedbacks/*`（列表/回复/状态）                          | 只需新增`feedbacks.html`对齐现有后端                                                                                                                                                                                                                     | P0     |
| **stores**               |      0 | ❌ 无后端路由/服务                                                                     | 补齐`/api/v4/console/stores/*`（CRUD）+ `stores.html`（需先确认表结构/业务需求）                                                                                                                                                                         | P2     |
| **user_premium_status**  |      1 | ✅ 有PremiumService，❌ 无console管理入口                                              | 在`users.html`用户详情中扩展"高级会员状态"展示/管理                                                                                                                                                                                                      | P1     |
| **user_hierarchy**       |      0 | ✅ 有HierarchyManagementService，❌ 无路由                                             | 补齐`/api/v4/console/user-management/hierarchy/*`+ 在`users.html`扩展或新增`user-hierarchy.html`                                                                                                                                                         | P2     |
| **admin_operation_logs** |   1192 | ✅ 有AuditLogService（含getOperatorLogs/getLogDetail），❌ 无独立路由                  | 补齐`/api/v4/console/system/audit-logs/*`（列表/详情/统计）+ `audit-logs.html`                                                                                                                                                                           | P1     |
| **lottery_draws**        |      1 | ✅ 在analytics中有统计                                                                 | 在`analytics.html`中增加"抽奖记录"模块（列表/筛选/详情）                                                                                                                                                                                                 | P1     |
| **exchange_records**     |      0 | 🟡 已有ExchangeService（统计/状态更新/本人订单查询）；❌ 缺少“管理员全量订单列表/详情” | 新增 admin-only 查询端点（建议：`GET /api/v4/shop/exchange/admin/orders`、`GET /api/v4/shop/exchange/admin/orders/:order_no`），并将`exchange-market-orders.html`对齐到该admin端点；状态更新继续复用`POST /api/v4/shop/exchange/orders/:order_no/status` | P0     |

**执行原则**（以后端/DB为权威）：

- **后端已有路由/服务的表**（announcements/feedbacks/exchange_records）：只需补前端页面对齐
- **后端有服务但无console路由的表**（trade_orders/user_premium_status/user_hierarchy/admin_operation_logs）：补齐console路由 + 前端页面
- **后端无服务的表**（stores）：需先补后端服务/路由，再做前端（按"只为DB已存在能力提供接口"原则）

### 6.4 P0：一次性补齐“后端能力缺口/权限不一致/前端无法联动”的能力（已决策：全部补齐）

你要求"一次性补齐管理后台所有页面内容"，以下为**已拍板决策**的执行方案。

#### 6.4.1 活动条件配置（`activity-conditions.html`）——activities 域权限收紧 + 前端对齐（仅管理员）

**现状（已与当前代码/DB对齐）**：

- `LotteryCampaign`模型已包含 `participation_conditions` / `condition_error_messages`（存储在`lottery_campaigns`表，JSON字段）
- ✅ 当前后端**已挂载**`/api/v4/activities`域（见`app.js`：`app.use('/api/v4/activities', require('./routes/v4/activities'))`），活动条件相关端点已可调用
- ⚠️ 差异点：当前`/api/v4/activities/available|check-eligibility|participate`为“登录用户可用”端点；但你已拍板“activities域仅管理员可用”，因此需要在后端将这些端点权限收紧为`requireAdmin`（不改变业务字段，只改变访问策略）

**已决策方案（仅管理员）**：

- ✅ 现状已具备 `/api/v4/activities` 路由与实现；下一步不再是“新增挂载”，而是：
  - **权限收紧**：将 activities 域所有端点统一加 `requireAdmin`（符合你“仅管理员”决策）
  - **前端对齐**：`activity-conditions.html` 明确使用 `POST /api/v4/activities/:code/configure-conditions` 写入条件（落到`lottery_campaigns.participation_conditions`），读取时使用`GET /api/v4/activities/:idOrCode/conditions`（或等价读接口）
- **全部端点加`requireAdmin`**（**已决策：不对普通用户开放**）：
  - `GET /api/v4/activities/available`：返回活动列表（管理员查看）
  - `GET /api/v4/activities/:idOrCode/check-eligibility`：返回`eligible`+不满足原因（管理员测试校验用）
  - `POST /api/v4/activities/:idOrCode/participate`：返回`can_participate`（管理员模拟测试用）
  - `GET /api/v4/activities/:idOrCode/conditions`：返回当前`participation_conditions`与`condition_error_messages`（供后台编辑器回显）
  - `POST /api/v4/activities/:code/configure-conditions`：写入`lottery_campaigns.participation_conditions/condition_error_messages`

**前端对齐**：

- `activity-conditions.html`保留，将其读写路径统一到上述`/api/v4/activities/*`

**验收**：

- 页面可对任一活动：加载条件 → 修改 → 保存 → 再次加载一致
- 真实DB：`lottery_campaigns.participation_conditions`字段被正确更新（抽样核对）
- 非管理员调用返回403

#### 6.4.2 预设激活（`presets.html`）——不造“假activate”，改成对齐现有抽奖干预能力

**现状问题（已对齐当前代码）**：

- `presets.html`当前UI是“预设名称/类型/奖品概率100%”的**方案型预设**，但当前后端与DB并不存在对应的“预设方案”表/接口
- 后端现有可用的“抽奖干预/预设”能力在`/api/v4/console/lottery-management/*`：
  - `POST /probability-adjust`（已在`users.html`里使用）
  - `POST /user-specific-queue`（用户专属队列，可视为“激活预设队列”）
  - `POST /force-win` / `POST /force-lose` / `GET /user-status/:user_id` / `POST /clear-user-settings/:user_id`

**一次性补齐决策**：

- **不新增一个语义不清/与现有架构冲突的`activate`端点**
- 直接把`presets.html`重构为**“抽奖干预与预设队列管理（运营工具页）”**，对齐现有console能力：
  - “激活预设”= 调用`/api/v4/console/lottery-management/user-specific-queue`写入用户队列并设置持续时间（`duration_minutes`）
  - “查看生效状态”= 调用`/api/v4/console/lottery-management/user-status/:user_id`
  - “撤销/清空”= 调用`/api/v4/console/lottery-management/clear-user-settings/:user_id`
  - “强制中奖/不中奖”= 对齐到`/force-win`、`/force-lose`

**前端重构要点（不写代码，仅定义页面内容）**：

- 增加“选择目标用户”（复用`users.html`的搜索/筛选逻辑，统一走`/api/v4/console/user-management/users?search=`）
- 增加“队列编辑器”（输入`prize_id`序列或从奖品池选择；队列保存即为激活）
- 移除“概率总和=100%”这类与现有后端不一致的校验与字段

**验收**：

- 在`lottery_management_settings`表能看到对应设置写入（抽样核对）
- 用户状态页能显示队列/概率干预已生效；清理后状态消失

---

## 7. 实施方案（按当前代码对齐落地）

### 7.1 总体策略

- **先修复“页面存在但无法联动”的问题（P0）**：API路径统一 + 关键业务字段对齐（见第5.2/第6.1）
- **再补齐Console缺失模块页面（P0）**：让`/api/v4/console`每个模块都有对应页面入口（见第5.1/第6.2）
- **最后补齐“后端能力缺口/权限不一致/需要新增规范暴露”的能力（P1/P2）**：例如兑换订单全量管理（admin-only查询端点）、activities权限收紧（仅管理员）、trade_orders/admin_operation_logs 等缺少console查询路由（见第6.4/第6.5）

### 7.2 阶段0（P0）：API路径与能力对齐（让现有页面真正可用）

执行方式（不涉及MySQL客户端，仅基于当前后端挂载路径）：

- 逐页按第5.2表做"路径对齐"，确保页面请求不再出现404（**已决策：只改前端，不加后端兼容路由**）
- `login.html`改为`/api/v4/console/auth/login`（**已决策**）
- `diamond-accounts.html`改为使用`asset-adjustment`/资产流水能力（**已决策：不做diamond模块**）
- 对于“后端存在缺口/权限不一致/前端无法联动”的能力（activities权限收紧、预设激活/干预能力对齐、兑换订单全量管理等），**已决策一次性补齐**（见第6.4/6.5）
- 对于"业务规则已迁移"的模块（兑换市场：旧virtual_value → 现材料资产支付），前端字段与交互必须对齐后端现行规则

### 7.3 阶段1（P0）：补齐Console缺失模块页面 + 数据库表管理入口

建议新增页面（文件名可按你团队命名习惯调整）：

**Console模块覆盖**：

- `lottery-quota.html`：配额规则CRUD + 用户配额状态/加次数/校验
- `asset-adjustment.html`：通用资产调整（含批量、幂等提示、查询用户balances）
- `campaign-budget.html`：活动预算配置/validate/预算池补充/预算状态/用户BUDGET_POINTS
- `assets-portfolio.html`：运营资产中心（overview/items/detail/events）
- `image-resources.html`：图片上传/列表/绑定/删除/清理
- `orphan-frozen.html`：孤儿冻结 detect/stats/cleanup（含dry-run）
- `merchant-points.html`：商家积分审核管理（对齐`/api/v4/console/merchant-points/*`）
- `analytics.html` + `config-tools.html`：新增决策分析/配置工具页；`charts.html`/`statistics.html`保留并完成路径/参数对齐（见0.2决策）

**数据库表管理入口（P0）**：

- `announcements.html`：系统公告管理（后端已有`/console/system/announcements/*`，只需补前端）
- `feedbacks.html`：用户反馈管理（后端已有`/console/system/feedbacks/*`，只需补前端）

**数据库表管理入口（P1）**：

- `trade-orders.html`：C2C交易订单管理（需先补`/console/marketplace/trade-orders/*`路由）
- `audit-logs.html`：操作审计日志查看（需先补`/console/system/audit-logs/*`路由）
- `users.html`扩展：高级会员状态（user_premium_status）、用户层级（user_hierarchy）展示
- `analytics.html`扩展：抽奖记录（lottery_draws）模块

**数据库表管理入口（P2）**：

- `stores.html`：门店信息管理（需先补后端服务/路由）
- `user-hierarchy.html`：用户层级管理（如需独立页面；或在users.html中扩展）

### 7.4 阶段2（P1/P2）：补齐部分覆盖与可选增强

- **lottery-management**：补齐force-win/force-lose/队列/清理等入口（可在`users.html`用户详情扩展或单独页面）
- **material**：余额/流水页必须对齐（P0：改走`asset-adjustment`或补齐material用户端点）；批量调整/导出为可选增强
- **diamond**：**已决策不单独做**，统一在"通用资产中心/资产调整"处理
- **activity-conditions / presets**：activities域已具备但需“仅管理员”权限收紧；`presets.html`按决策重构为抽奖干预工具页（P0执行，见6.4）

### 7.5 完成判定（满足你“全部能力都要有页面联动查看数据”的标准）

- **Console覆盖**：第5.1中所有模块都为✅（或明确标注“不需要页面覆盖”的内部模块，并经你确认）
- **页面可用性**：管理后台所有页面请求均命中有效路由（无404），且能展示真实DB数据
- **数据对齐**：关键表（第4章）抽样核对：页面展示的统计/列表与DB一致（至少按状态枚举、总数、分页一致）

### 7.6 动态联动要求（以数据库/后端为权威）

> 你提出“动态联动管理员修改奖品配置、数据展板等”，这里将其变成**强制验收条款**，并明确“以DB/后端为准”。

#### 7.6.1 奖品配置动态联动（prize-pool）

- **权威数据源**：`lottery_prizes`（以及奖品池/库存相关表），以`/api/v4/console/prize-pool/*`写入后的结果为准
- **后台行为要求**：
  - 管理员在`prizes.html`修改奖品/库存后，页面必须立即重新拉取并显示最新数据（不得仅在前端本地“假更新”）
  - 如果后端存在缓存（例如PrizePoolService/Reporting缓存等），必须在后端写操作中完成失效或刷新，保证后续读请求返回最新数据
- **联动验收**：
  - 修改后立即刷新列表仍一致
  - 相关统计/展板在下一次刷新周期内反映变更（见7.6.2）

#### 7.6.2 数据展板/报表动态联动（dashboard / charts / statistics）

- **权威数据源**：真实DB聚合统计（后端报表服务的聚合结果必须可追溯到DB）
- **后台行为要求**：
  - `dashboard.html`必须展示`/api/v4/console/system/dashboard`最新数据（允许轮询刷新；本项目已使用定时刷新模式）
  - `charts.html`与`statistics.html`需先完成路径对齐到`/api/v4/system/statistics/*`，并确保展示的是后端实时/准实时聚合结果
- **联动验收**：
  - 管理员修改奖品配置/预算配置/材料规则后，相关统计指标在合理延迟内变化（延迟策略需明确：实时/1分钟/5分钟）

#### 7.6.3 运营类配置动态联动（settings / campaign-budget / lottery-quota / material）

- **权威数据源**：数据库配置表（例如`system_settings`、`lottery_campaigns`、`lottery_draw_quota_rules`、`material_*`等）
- **后台行为要求**：
  - 管理后台所有“保存/更新”操作必须以成功响应为准，并在成功后立即回读确认（页面回显必须来自后端）
  - 涉及核心业务路径的配置（预算、配额、转换规则）必须做到“写后读一致”，并对用户端生效

---

## 8. 页面导航架构

### 8.1 建议的菜单结构

```
管理后台
├── 📊 数据概览
│   └── dashboard.html（✅ 已对齐）
│
├── 👥 用户管理
│   ├── users.html（✅ 已对齐，待扩展：高级会员状态、用户层级展示）
│   └── 用户层级管理（user-hierarchy.html ❌ 待新增：对齐user_hierarchy表）
│
├── 💎 资产与材料
│   ├── 🧩 材料资产类型（material-asset-types.html ✅）
│   ├── 🔄 材料转换规则（material-conversion-rules.html ✅）
│   ├── 🧾 材料流水（material-transactions.html 🔴：当前后端未实现`/api/v4/console/material/transactions`；需改造走资产流水/新增管理员流水查询端点）
│   ├── 💰 材料余额（material-balances.html 🔴：当前后端未实现`/api/v4/console/material/users/*`且`/api/v4/console/users/search`不存在；建议走`asset-adjustment` + `user-management`搜索）
│   ├── 💎 钻石账户（diamond-accounts.html 🔴：console未挂载diamond模块；**已决策**改造为走asset-adjustment/资产流水，钻石=DIAMOND资产类型）
│   ├── 💰 通用资产调整（asset-adjustment.html ❌ 待新增：对齐console asset-adjustment）
│   └── 🔧 孤儿冻结清理（orphan-frozen.html ❌ 待新增：对齐console orphan-frozen）
│
├── 📦 运营资产中心
│   └── assets-portfolio.html ❌ 待新增（对齐console assets：overview/items/events）
│
├── 🏪 市场管理
│   ├── 📊 C2C上架统计（marketplace-stats.html ✅）
│   ├── 📦 C2C交易订单（trade-orders.html ❌ 待新增：需先补`/console/marketplace/trade-orders/*`路由）
│   ├── 🛒 B2C兑换商品（exchange-market-items.html 🔴 需对齐路径/字段到shop+console marketplace）
│   ├── 📦 B2C兑换订单（exchange-market-orders.html 🔴 需对齐到shop，含exchange_records）
│   └── 📊 B2C兑换统计（exchange-market-stats.html 🔴 需对齐到shop）
│
├── 🎲 抽奖管理
│   ├── 🎁 奖品池配置（prizes.html ✅）
│   ├── 🎯 抽奖配额管理（lottery-quota.html ❌ 待新增：对齐console lottery-quota）
│   ├── 💰 活动预算配置（campaign-budget.html ❌ 待新增：对齐console campaign-budget）
│   ├── 🎁 抽奖干预与预设队列（presets.html 🔴 需重构：对齐console lottery-management）
│   └── ⚙️ 活动条件（activity-conditions.html 🟡：后端已具备activities域；需“仅管理员”权限收紧 + 页面读写对齐）
│
├── 🛍️ 审核中心
│   ├── 📝 消费记录审核（consumption.html 🔴：需对齐到`/api/v4/shop/consumption/*`）
│   └── 🏪 商家积分审核（merchant-points.html ❌ 待新增：对齐`/api/v4/console/merchant-points/*`）
│
├── 🔔 系统管理
│   ├── 📢 通知中心（notifications.html 🔴：需对齐到`/api/v4/system/notifications/*`，并修正clear/read-all等HTTP方法/路径）
│   ├── 📢 系统公告（announcements.html ❌ 待新增：对齐`/api/v4/console/system/announcements/*`）
│   ├── 📊 图表可视化（charts.html 🔴：需对齐到`/api/v4/system/statistics/charts`）
│   ├── 📊 数据统计报表（statistics.html 🔴：需对齐到`/api/v4/system/statistics/report|export`）
│   ├── 📊 运营分析（analytics.html ❌ 待新增：对齐`/api/v4/console/analytics/*`，含抽奖记录lottery_draws）
│   ├── 🖼️ 弹窗Banner（popup-banners.html ✅）
│   ├── 🖼️ 图片资源管理（image-resources.html ❌ 待新增：对齐console images）
│   ├── ⚙️ 系统设置（settings.html ✅）
│   ├── 🧪 配置/模拟工具（config-tools.html ❌ 待新增：对齐console config）
│   └── 📋 审计日志（audit-logs.html ❌ 待新增：对齐admin_operation_logs查询）
│
├── 💬 用户反馈
│   └── 📝 反馈管理（feedbacks.html ❌ 待新增：对齐`/api/v4/console/system/feedbacks/*`）
│
├── 🏪 门店管理
│   └── 📍 门店信息（stores.html ❌ 待新增：需先补后端服务/路由）
│
└── ⚙️ 系统设置
    └── 认证/权限（通过users.html与login.html覆盖；如需独立“权限缓存失效”页可单独规划）
```

### 8.2 导航实施建议

**一级导航**:

- 数据概览
- 用户管理
- 资产管理 ⭐（新增，核心功能）
- 材料系统 ⭐（新增，核心功能）
- 物品管理 ⭐（新增）
- 市场管理
- 抽奖管理
- 消费管理
- 系统管理

**快捷入口**（Dashboard）:

- 待审核消费记录
- 待处理订单
- 资产异常告警
- 系统通知

---

## 9. 验证检查清单

### 9.1 功能完整性验证

#### 资产管理模块

- [ ] 管理员可查看所有资产类型（积分/钻石/材料）
- [ ] 管理员可创建和管理材料资产类型
- [ ] 管理员可配置材料转换规则
- [ ] 管理员可统一调整用户资产（单个/批量）
- [ ] 管理员可查询任意用户的资产交易记录
- [ ] 管理员可查询材料资产余额分布
- [ ] 管理员可检测和清理孤立冻结资产
- [ ] 所有资产调整操作有幂等性保证
- [ ] 所有资产调整操作有审计日志

#### 物品和市场管理模块

- [ ] 管理员可查看所有物品实例
- [ ] 管理员可按状态筛选物品实例
- [ ] 管理员可查看物品事件历史
- [ ] 管理员可查看C2C市场所有挂单
- [ ] 管理员可强制下架违规挂单
- [ ] 管理员可查看C2C交易订单
- [ ] 管理员可处理交易纠纷
- [ ] 管理员可查看B2C商品（可复用`/api/v4/shop/exchange/items*`在admin登录下返回full数据）
- [ ] 管理员可全量查看B2C订单列表/详情（需新增admin-only查询端点；现状仅支持本人订单查询+管理员状态更新）

#### 抽奖管理模块

- [ ] 管理员可配置抽奖活动预算池
- [ ] 管理员可验证奖品配置合理性
- [ ] 管理员可手动补充预算池
- [ ] 管理员可查看预算池实时状态
- [ ] 管理员可创建抽奖预设（已有）
- [ ] 管理员可配置活动参与条件（已有）

#### 系统管理模块

- [ ] 管理员可统一管理图片资源
- [ ] 管理员可删除未使用的图片
- [ ] 管理员可发送和管理系统通知（已有）
- [ ] 管理员可查看综合统计报表（已有）
- [ ] 管理员可导出数据报表（已有）

### 9.2 数据一致性验证

#### 数据库对齐检查

- [ ] 所有数据库表都有对应的查询入口
- [ ] 所有关键业务数据都可在前端查看
- [ ] 前端显示的数据与数据库实际数据一致
- [ ] 数据筛选和搜索功能正常工作
- [ ] 分页功能正常工作

#### API对齐检查

- [ ] 所有后端Console API都有前端调用
- [ ] 前端API调用参数符合后端要求
- [ ] 前端正确处理API响应（成功/失败）
- [ ] 前端正确处理分页和筛选参数
- [ ] 前端正确携带认证Token

### 9.3 用户体验验证

#### 界面一致性

- [ ] 新页面与现有页面风格一致
- [ ] 使用统一的Bootstrap 5组件
- [ ] 使用统一的颜色和字体
- [ ] 使用统一的图标库
- [ ] 响应式布局在各设备正常显示

#### 操作便捷性

- [ ] 关键操作有快捷入口
- [ ] 搜索和筛选功能易用
- [ ] 批量操作功能完善
- [ ] 表单验证友好
- [ ] 错误提示清晰

#### 性能体验

- [ ] 列表页加载速度<2秒
- [ ] 搜索响应速度<1秒
- [ ] 大数据量列表支持分页
- [ ] 图片加载优化（懒加载）
- [ ] 无明显卡顿现象

### 9.4 安全性验证

#### 权限控制

- [ ] 所有管理页面需要管理员权限
- [ ] Token过期自动跳转登录
- [ ] 敏感操作需二次确认
- [ ] 关键操作有操作日志
- [ ] 数据脱敏正确实施

#### 数据安全

- [ ] 幂等性控制正确实施
- [ ] 并发操作不会导致数据错误
- [ ] 事务回滚机制正常工作
- [ ] 敏感数据不在前端暴露
- [ ] API错误信息不泄露敏感信息

### 9.5 业务逻辑验证

#### 资产管理业务

- [ ] 资产调整后余额正确更新
- [ ] 批量调整支持事务回滚
- [ ] 材料转换规则正确执行
- [ ] 冻结资产清理不影响正常业务
- [ ] 资产交易记录完整可追溯

#### 市场管理业务

- [ ] 挂单下架后物品状态正确
- [ ] 交易订单取消后资产正确退回
- [ ] B2C订单状态流转正确
- [ ] 库存扣减和恢复正确
- [ ] 订单完成后资产正确转移

#### 抽奖管理业务

- [ ] 预算池配置后抽奖正常进行
- [ ] 预算不足时正确提示
- [ ] 奖品配置验证正确
- [ ] 抽奖干预/预设队列“激活”后用户侧生效（可通过用户状态接口与抽样抽奖验证）
- [ ] 活动条件配置正确生效（条件写入DB并对用户侧eligibility生效）

---

## 10. 附录

### 10.1 关键技术文档

- **Sequelize ORM**: https://sequelize.org/
- **Bootstrap 5**: https://getbootstrap.com/
- **Chart.js**: https://www.chartjs.org/
- **JWT认证**: https://jwt.io/

### 10.2 项目关键文件

- **数据库配置**: `/home/devbox/project/config/database.js`
- **模型定义**: `/home/devbox/project/models/`
- **Console路由**: `/home/devbox/project/routes/v4/console/`
- **前端页面**: `/home/devbox/project/public/admin/`
- **前端公共JS**: `/home/devbox/project/public/admin/js/admin-common.js`

### 10.3 数据库连接与数据校验方式（只读）

- 使用 Node.js + Sequelize（读取`.env`）连接真实数据库（本次校验库名为`restaurant_points_dev`）
- 最小验证：确认`SELECT DATABASE()`结果正确；对关键表做`COUNT(*)`与状态分布统计（第4章已给出快照）
- 原则：**只读、可复现、不依赖mysql客户端**

### 10.4 前端/接口对齐验证方式（不写代码）

- 打开管理后台页面 → 浏览器开发者工具 Network
- 核查每个页面的请求是否命中当前挂载域（`/api/v4/console`、`/api/v4/shop`、`/api/v4/system`、`/api/v4/lottery`）
- 验收要求：无404；分页/筛选参数生效；页面统计/列表与第4章关键表抽样一致

---

## 11. 总结

### 11.1 核心发现

1. **Console模块已扩展**：当前`/api/v4/console`已挂载**20**个子模块；但`diamond`模块在console信息中“声明存在”却未挂载且无路由文件（符合“钻石统一到资产中心”的决策，但需要确保前端不再依赖diamond模块）
2. **管理后台页面已实现“页面文件覆盖”**：当前`public/admin/`有**36**个页面，模块入口基本齐全；但仍存在少量页面“接口路径/字段契约/业务语义”未完全对齐后端
3. **真实数据库数据规模明确**：已通过 Node.js + Sequelize 对`restaurant_points_dev`做只读统计（第4章），可用于验收对齐效果
4. **实现路径明确**：v1.8以“后端/DB为权威”为唯一准绳：优先修正前端页面对齐真实挂载与真实字段；仅在“管理所必需的读接口”缺失时，新增后端端点（必须是对DB既有表/字段/能力的规范暴露）

### 11.2 关键优先级（已拍板）

**立即实施** (P0):

- **前端对齐**（不做旧路径兼容）：按第12章逐页修正`lottery-quota.html`/`campaign-budget.html`/`assets-portfolio.html`/`asset-adjustment.html`/`material-*.html`/`diamond-accounts.html`/`exchange-market-orders.html`的路径、字段、响应契约
- **后端补齐（仅暴露DB既有能力）**：
  - `GET /api/v4/console/asset-adjustment/asset-types`：返回可调整资产类型清单（内置资产 + material_asset_types）
  - `GET /api/v4/console/assets/transactions`：管理员可按`user_id/asset_code/business_type/time`分页查询`asset_transactions`
- **已完成项确认**：activities域已收紧为仅管理员；`presets.html`已重构对齐`console/lottery-management`；`announcements.html`/`feedbacks.html`/`trade-orders.html`/`audit-logs.html`页面已存在且已对齐对应console端点（仍需按第12章统一做一次“无404联动验收”）

**近期实施** (P1):

- lottery-management 强控能力入口补齐（force-win/force-lose/队列/清理等）
- `user-hierarchy.html`补齐“导出”能力（前端导出CSV即可，不强依赖后端）
- `users.html`扩展：高级会员状态（`user_premium_status`）、层级信息（`user_hierarchy`）展示/管理（以后端现有能力为准）
- `analytics.html`扩展：抽奖记录（`lottery_draws`）模块（如后端analytics已提供则前端对齐；否则按“DB已存在能力”补齐只读查询）

**后续优化** (P2):

- 统计/图表体系两套都保留（`system/statistics` + `console/analytics`），新增`analytics.html`对齐console analytics
- 门店/层级：如最终仍需要独立`stores`表CRUD入口，则需先补齐后端服务/路由再做前端（遵循“只为DB既有表提供规范API”的原则）

### 11.3 预期成果

完成本方案后，Web管理平台将实现:

- ✅ 页面与后端挂载路径完全一致（不再出现“页面有但接口404”）
- ✅ `/api/v4/console`每个模块都有对应的管理后台页面入口（或经你确认可不做页面的内部模块）
- ✅ 关键业务数据（第4章）在管理端可查可管，并可用抽样方式与真实DB对齐验收
- ✅ 完整的资产管理体系
- ✅ 完整的市场管理体系
- ✅ 完整的抽奖管理体系
- ✅ 统一的用户体验
- ✅ 完善的数据安全保障

---

## 12. v1.8 一次性补齐落地清单（按当前仓库 public/admin 与后端路由实际挂载）

### 12.1 落地边界（必须遵守）

- **后端/DB为权威**：页面字段、枚举、业务语义以`models + services + routes`与真实DB为准
- **不兼容旧路径**：不为“迁就旧web前端路径”增加兼容路由；旧路径一律改前端
- **新增后端接口的唯一理由**：为**DB已存在表/字段/能力**提供更规范的管理端读写API（禁止凭空造业务）

### 12.2 P0：前端页面改造清单（必须一次性修正到可联动）

> **状态更新（2026-01-09）**: ✅ **所有P0页面已完成对齐修复**

| 页面                                       | 修复状态  | 完成内容                                                                                                                                                                                                   |
| ------------------------------------------ | --------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `public/admin/lottery-quota.html`          | ✅ 已完成 | 活动列表改用`/api/v4/activities`；规则查询改用`/api/v4/console/lottery-quota/rules`；禁用规则用`PUT /rules/:id/disable`；创建规则用`POST /rules`；调整配额改为添加奖励抽奖次数`POST /users/:user_id/bonus` |
| `public/admin/campaign-budget.html`        | ✅ 已完成 | 活动列表改用`/api/v4/activities`；预算状态改用`GET /api/v4/console/campaign-budget/campaigns/:id/budget-status`循环获取；预算配置更新用`PUT /campaigns/:id`                                                |
| `public/admin/assets-portfolio.html`       | ✅ 已完成 | 资产概览改用`/api/v4/console/asset-adjustment/asset-types`构建概览；最近流水提示需要输入用户ID使用`/api/v4/console/assets/transactions`                                                                    |
| `public/admin/asset-adjustment.html`       | ✅ 已完成 | 资产类型使用新增的`GET /asset-types`端点；余额使用`GET /user/:user_id/balances`（返回user+balances数组）；流水使用`/api/v4/console/assets/transactions`                                                    |
| `public/admin/material-balances.html`      | ✅ 已完成 | 资产类型来自`/asset-types`；余额来自`/user/:id/balances`过滤材料资产；用户搜索改为正确处理返回的用户列表                                                                                                   |
| `public/admin/material-transactions.html`  | ✅ 已完成 | 资产类型来自`/asset-types`；流水来自`/assets/transactions`并强制要求`user_id`参数                                                                                                                          |
| `public/admin/diamond-accounts.html`       | ✅ 已完成 | 余额来自`/user/:id/balances`过滤DIAMOND资产；流水来自`/assets/transactions`过滤`asset_code=DIAMOND`；用户搜索改为正确处理返回的用户列表                                                                    |
| `public/admin/exchange-market-orders.html` | ✅ 已完成 | 订单详情改用`GET /api/v4/console/marketplace/exchange_market/orders/:order_no`（管理员专用端点）；列表使用正确的管理员端点                                                                                 |

### 12.3 P0：必须新增/补齐的后端接口（仅暴露DB既有能力）

> **状态更新（2026-01-09）**: ✅ **所有P0后端接口已完成实现**

以下属于"管理后台必须具备的只读/基础读能力"，对应DB已存在表：`material_asset_types`、`asset_transactions`。

1. ✅ `GET /api/v4/console/asset-adjustment/asset-types`（admin-only）- **已实现**
   - **实现文件**：`routes/v4/console/asset-adjustment.js`
   - **用途**：前端统一获取"可调整资产类型"清单（POINTS/BUDGET_POINTS/DIAMOND + 材料资产类型）
   - **数据来源**：内置资产枚举 + `material_asset_types`（含`display_name/group_code/form/is_enabled/sort_order`等）
   - **返回结构**：`{ success: true, data: { asset_types: [{asset_code, display_name}, ...] } }`

2. ✅ `GET /api/v4/console/assets/transactions`（admin-only）- **已实现**
   - **实现文件**：`routes/v4/console/assets/transactions.js`（新增）
   - **挂载方式**：在`routes/v4/console/assets/index.js`中挂载
   - **用途**：管理员按条件分页查询全量资产流水（支持按`user_id`与`asset_code`筛选，覆盖材料/钻石/积分/预算积分）
   - **数据来源**：`asset_transactions`（通过AssetService.getAssetTransactions）
   - **查询参数**：`user_id`（可选）、`asset_code`（可选）、`business_type`（可选）、`page`、`page_size`
   - **返回结构**：`{ success: true, data: { transactions: [...], pagination: {...} } }`

3. ✅ `GET /api/v4/console/asset-adjustment/user/:user_id/balances`（admin-only）- **已增强**
   - **修改内容**：增加返回用户基本信息（user_id, nickname, mobile）
   - **返回结构**：`{ success: true, data: { user: {user_id, nickname, mobile}, balances: [...] } }`

### 12.4 一次性验收（必须满足）

- **接口层**：管理后台所有页面打开后 Network 中 **无404**；写操作成功后必须“写后回读一致”
- **权限层**：所有管理端点均要求管理员；activities域已验证为仅管理员
- **数据层（抽样）**：资产余额/流水/订单/审计日志等关键列表与DB抽样一致（至少总数、分页、状态分布一致）

---

**文档版本**: v1.9（P0页面/接口一次性对齐已完成）  
**最后更新**: 2026年01月09日  
**维护者**: 开发团队  
**状态**: ✅ **第12章P0页面与接口已全部对齐完成**

### 12.5 修复完成总结（2026-01-09）

**后端修复**：

- ✅ 新增 `GET /api/v4/console/asset-adjustment/asset-types` - 资产类型查询端点
- ✅ 新增 `GET /api/v4/console/assets/transactions` - 管理员资产流水查询端点
- ✅ 增强 `GET /api/v4/console/asset-adjustment/user/:user_id/balances` - 增加返回用户信息

**前端修复**（9个P0页面全部完成）：

- ✅ `lottery-quota.html` - 活动列表、规则CRUD、配额调整端点全部对齐
- ✅ `campaign-budget.html` - 活动列表、预算状态查询、预算配置更新端点全部对齐
- ✅ `assets-portfolio.html` - 资产概览、流水查询端点对齐
- ✅ `asset-adjustment.html` - 资产类型、余额、流水端点全部对齐
- ✅ `material-balances.html` - 资产类型、余额、用户搜索处理逻辑修复
- ✅ `presets.html` - 创建干预规则改用 `/force-win` 端点；奖品列表改用 `/prize-pool/list` 端点
- ✅ `material-transactions.html` - 资产类型、流水查询（需user_id）对齐
- ✅ `diamond-accounts.html` - 余额、流水、用户搜索处理逻辑修复
- ✅ `exchange-market-orders.html` - 订单详情改用管理员专用端点

**验收状态**：

- ✅ 接口层：所有P0页面API调用与后端挂载路径一致
- ✅ 响应结构：前端正确解析后端返回的数据结构（user列表、balances数组等）
- ✅ 权限层：所有管理端点均要求管理员权限
