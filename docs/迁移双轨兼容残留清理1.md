# 迁移双轨兼容残留清理 - 实际检查报告

**生成日期**: 2026-01-13  
**检查方法**: 代码静态扫描 + Node.js直连真实数据库核对  
**数据库**: `restaurant_points_dev` (真实环境)  
**检查范围**: 运行时代码目录 (models/ services/ routes/ utils/ config/)

---

## 一、检查结论

### ✅ 确认问题存在

你项目**确实存在**"迁移/双轨兼容残留注释"问题，且与真实数据库状态不一致：

1. **代码侧**: 运行时代码中存在大量"已废弃/已删除/已迁移"的历史注释（与迁移方案文档一致）
2. **数据库侧**: 旧表在真实数据库中**已完全删除**，业务已切换到新体系
3. **脱节现象**: 代码注释还在描述"旧表/旧字段如何迁移"，但这些对象在运行时数据库中根本不存在

### 🎯 影响评估

- **运维混淆**: 新人/运维看到"已删除"注释会误以为需要回滚或兼容旧逻辑
- **技术债务**: 历史注释占用代码空间，干扰当前业务理解
- **维护成本**: 每次改动需区分"历史遗留"vs"当前有效"注释

---

## 二、真实数据库状态核对

### 2.1 核对方法

使用项目自身的 **dotenv + Sequelize** 配置直连真实数据库：

```javascript
require('dotenv').config()
const { sequelize } = require('./config/database')
// 查询表结构、行数、关键字段
```

### 2.2 核对结果

**当前数据库**: `restaurant_points_dev`

#### A. 旧表状态（文档提到的典型对象）

| 表名                  | 是否存在  | 行数 | 说明                         |
| --------------------- | --------- | ---- | ---------------------------- |
| `trade_records`       | ❌ 不存在 | -    | 已于 2026-01-08 迁移删除     |
| `user_asset_accounts` | ❌ 不存在 | -    | 已于 2025-12-31 架构升级删除 |
| `role_change_logs`    | ❌ 不存在 | -    | 已于 2026-01-09 功能合并删除 |

#### B. 新体系表状态（业务主线已切换）

| 表名                     | 是否存在 | 行数 | 说明                         |
| ------------------------ | -------- | ---- | ---------------------------- |
| `asset_transactions`     | ✅ 存在  | 2442 | 资产流水主账本（替代旧流水） |
| `trade_orders`           | ✅ 存在  | 0    | C2C交易订单表                |
| `item_instance_events`   | ✅ 存在  | 537  | 物品事件溯源表               |
| `accounts`               | ✅ 存在  | 23   | 统一账户主体表               |
| `account_asset_balances` | ✅ 存在  | 21   | 账户资产余额表（含冻结模型） |
| `content_review_records` | ✅ 存在  | 46   | 统一审批审核流               |
| `lottery_draws`          | ✅ 存在  | 2    | 抽奖记录表                   |
| `lottery_prizes`         | ✅ 存在  | 9    | 奖品配置表                   |

#### C. 关键字段核对（语义一致性）

| 表名                   | 字段名          | 是否存在  | 说明                     |
| ---------------------- | --------------- | --------- | ------------------------ |
| lottery_draws          | `is_winner`     | ❌ 不存在 | V4.0已删除（语义升级）   |
| lottery_draws          | `reward_tier`   | ✅ 存在   | V4.0新增（奖励档位语义） |
| trade_records          | `is_legacy`     | ❌ 不存在 | 表本身已删除             |
| account_asset_balances | `frozen_amount` | ✅ 存在   | 冻结余额（新架构特性）   |

---

## 三、代码残留注释清单

### 3.1 文档点名的文件（与迁移方案对齐）

#### A. `models/index.js`

**问题1**: TradeRecord 整块注释（约15行）

```javascript
/**
 * ❌ TradeRecord：已删除（2026-01-08 交易流水收敛决策执行完成）
 *    - 删除原因：职责混乱，与 AssetTransaction、TradeOrder 功能重叠
 *    - 替代方案：
 *      - 资产变动 → AssetTransaction（asset_transactions 表）
 *      - C2C交易 → TradeOrder（trade_orders 表）
 *      - 物品事件 → ItemInstanceEvent（item_instance_events 表）
 *    - 数据库：trade_records 表已于 2026-01-08 删除（迁移 20260108210000）
 *    - 模型文件：models/TradeRecord.js 已删除
 *    - 文档：详见 docs/交易流水收敛方案-AssetTransaction-TradeOrder-TradeRecord-2026-01-08.md
 */
```

**清理建议**: 整块删除（行115-124）

---

**问题2**: UserAssetAccount 废弃注释

```javascript
/*
 * 🔥 统一资产底座系统（2025年12月15日新增）
 *    ⚠️ UserAssetAccount 已废弃并删除（2025-12-31）
 *    新架构使用：Account + AccountAssetBalance + AssetTransaction
 */
```

**清理建议**: 删除"已废弃并删除"措辞，改为现状说明：

```javascript
/*
 * 🔥 统一资产底座系统（V4.5.0 资产域标准架构）
 *    当前架构：Account + AccountAssetBalance + AssetTransaction
 *    - Account: 账户主体（用户账户 + 系统账户）
 *    - AccountAssetBalance: 资产余额（支持冻结模型）
 *    - AssetTransaction: 资产流水（业界标准幂等架构）
 */
```

---

#### B. `services/index.js`

**问题**: 迁移说明注释（行216-220）

```javascript
 * 架构升级说明：
 * - V4版本移除了所有向后兼容代码
 * - 移除了旧版LotteryDrawService（替换为UnifiedLotteryEngine）
 * - 采用模块化设计（lottery服务独立容器）
 * - P1-9（2026-01-09）：统一 snake_case key，不兼容 camelCase
```

**清理建议**: 删除"移除了旧版…替换为…"历史叙述，仅保留现状：

```javascript
 * 服务管理器架构：
 * - V4 统一引擎架构（UnifiedLotteryEngine + 策略模式）
 * - 模块化服务容器（lottery_container）
 * - Snake_case 服务键规范（P1-9标准）
```

---

#### C. `services/ContentAuditEngine.js`

**问题**: 变更记录注释（行44-46）

```javascript
 * 变更记录：
 * - 2026-01-08: 移除 image 类型支持（用户上传凭证审核业务已废弃）
```

**清理建议**: 改为现状说明：

```javascript
 * 支持的审核类型：
 * - exchange: 兑换申请审核
 * - feedback: 用户反馈审核
 * - consumption: 消费记录审核
 * - merchant_points: 商家积分审核
```

---

#### D. `services/FeeCalculator.js`

**问题**: 变更记录注释（行22-24）

```javascript
 * 变更记录：
 * - 2026-01-08: 移除 createTradeRecord 方法（TradeRecord 已废弃，统一使用 TradeOrder）
 */
```

**清理建议**: 整块删除（保留业务说明部分）

---

#### E. `services/UnifiedLotteryEngine/strategies/BasicGuaranteeStrategy.js`

**问题**: 语义迁移说明（行12-16）

```javascript
 * V4.0语义更新（2026-01-01）：
 * - 删除 is_winner 字段（"中/没中"二分法已废弃）
 * - 新增 reward_tier 字段（奖励档位：low/mid/high）
 * - 每次抽奖100%从奖品池选择一个奖品，只讨论"抽到了什么"
```

**清理建议**: 改为当前语义描述：

```javascript
 * V4.0 抽奖语义：
 * - reward_tier: 奖励档位（low/mid/high），表达"抽到了什么"
 * - 抽奖机制：每次从奖品池按概率选取一个奖品（100%命中）
 * - 保底机制：累计10次触发九八折券保底
```

---

### 3.2 额外发现的残留（建议同步清理）

#### F. `models/User.js` (行158-165)

```javascript
/**
 * ❌ TradeRecord 关联已删除（2026-01-08 交易流水收敛决策执行完成）
 * - 删除原因：TradeRecord 模型和表已完全删除
 * - 替代关联路径：
 *   - C2C交易：User → TradeOrder (buyer_user_id / seller_user_id)
 *   - 资产变动：User → Account → AssetTransaction
 *   - 物品事件：User → ItemInstance → ItemInstanceEvent
 */
```

**清理建议**: 删除"已删除"历史说明，改为现状：

```javascript
/**
 * 当前关联路径：
 * - C2C交易：User → TradeOrder (buyer_user_id / seller_user_id)
 * - 资产变动：User → Account → AssetTransaction
 * - 物品事件：User → ItemInstance → ItemInstanceEvent
 */
```

---

#### G. `services/HierarchyManagementService.js` (行32)

```javascript
 * - 所有操作记录到role_change_logs表
```

**问题**: 真实数据库中 `role_change_logs` 表不存在（2026-01-09已删除）

**清理建议**: 改为实际审计路径：

```javascript
 * - 权限操作记录到统一审计日志（AdminOperationLog + UserRoleChangeRecord）
```

---

## 四、项目当前业务逻辑与技术路线（基于真实代码归纳）

### 4.1 商业模式

**核心业务**: 餐厅积分抽奖系统

1. **积分体系**
   - 用户通过消费、运营活动获得 POINTS（积分）
   - 积分用于抽奖、兑换商品、C2C交易市场支付

2. **抽奖主线** (V4 统一抽奖引擎)
   - 每次抽奖从奖品池按 `win_probability` 选取奖品（100%命中）
   - 保底机制：累计10次抽奖触发九八折券
   - 奖品形态：积分、优惠券/实物（ItemInstance）、材料资产（AccountAssetBalance）

3. **C2C交易市场**
   - 用户可挂牌出售物品（MarketListing）
   - 平台收取手续费（FeeCalculator: 3%-10%分档）
   - 订单流水统一到 TradeOrder

4. **统一审核流**
   - 兑换申请、反馈、消费记录、商家积分申请统一走 `ContentReviewRecord`
   - 审核回调机制（ExchangeAuditCallback / ConsumptionAuditCallback 等）

### 4.2 技术路线

**技术栈**: Node.js 20 + Express + MySQL + Sequelize + Redis + Socket.io

1. **API架构** (V4 RESTful标准化域结构)
   - 8个标准域：/auth, /lottery, /market, /shop, /user, /system, /assets, /backpack
   - 统一响应格式：ApiResponse.middleware() 注入 request_id

2. **数据层**
   - MySQL + Sequelize（事务边界统一管理 TransactionManager）
   - Redis（限流 + 缓存 + 健康检查）
   - 连接池配置：max=40, min=5, acquire=10s, idle=60s

3. **权限系统** (V15.0 UUID角色系统)
   - RBAC：roles + user_roles（多对多关联）
   - 替代旧的 `is_admin` 字段
   - 权限缓存：PermissionManager + Redis

4. **资产域架构** (V4.5.0 统一资产底座)
   - Account（账户主体：用户账户 + 系统账户）
   - AccountAssetBalance（资产余额：available_amount + frozen_amount）
   - AssetTransaction（资产流水：业界标准幂等架构）
   - 支持资产类型：POINTS（积分）、BUDGET_POINTS（预算积分）、材料资产（red_shard等）

5. **审计体系**
   - AdminOperationLog（操作审计日志）
   - UserRoleChangeRecord + UserStatusChangeRecord（业务事件主键）
   - AuditTargetTypes + AuditOperationTypes（统一 ENUM 定义）

---

## 五、清理方案（可执行版）

### 5.1 清理原则

| 类型              | 清理策略                                         | 保留内容                       |
| ----------------- | ------------------------------------------------ | ------------------------------ |
| 历史迁移注释      | **全部删除**                                     | -                              |
| "已废弃/已删除"   | **删除或改为现状说明**                           | "当前架构是…"                  |
| 业务规则说明      | **保留**                                         | 保底规则、审核类型、手续费档位 |
| 架构设计说明      | **保留但压缩**                                   | 避免历史叙述，只描述现状       |
| 迁移决策编号/日期 | **删除**（如"决策5/6/7"、"2026-01-08 迁移完成"） | -                              |
| 替代方案/文档引用 | **删除**（如"详见 docs/xxx 方案"）               | -                              |

### 5.2 清理清单（按优先级）

#### P0 级（文档点名，必须清理）

| 文件                                     | 行号范围 | 清理动作                   | 预计工作量 |
| ---------------------------------------- | -------- | -------------------------- | ---------- |
| `models/index.js`                        | 115-124  | 删除 TradeRecord 整块注释  | 10行       |
| `models/index.js`                        | 190-194  | 改写 UserAssetAccount 注释 | 5行        |
| `services/index.js`                      | 216-220  | 删除迁移说明，保留现状     | 5行        |
| `services/ContentAuditEngine.js`         | 44-46    | 改为支持类型列表           | 3行        |
| `services/FeeCalculator.js`              | 22-24    | 删除变更记录               | 3行        |
| `services/.../BasicGuaranteeStrategy.js` | 12-16    | 改为当前语义描述           | 5行        |

**预计总计**: 31行代码注释清理

---

#### P1 级（额外发现，建议同步清理）

| 文件                                     | 行号    | 问题                          | 清理建议         |
| ---------------------------------------- | ------- | ----------------------------- | ---------------- |
| `models/User.js`                         | 158-165 | TradeRecord 关联已删除注释    | 改为当前关联路径 |
| `services/HierarchyManagementService.js` | 32      | 指向不存在的 role_change_logs | 改为统一审计日志 |

**预计总计**: 9行代码注释清理

---

### 5.3 清理后的验证步骤

#### Step 1: 全仓扫描（运行时代码目录）

```bash
# 在 models/ services/ routes/ utils/ config/ 内扫描关键词
grep -r "已废弃\|已删除\|已迁移\|迁移原因\|deprecated\|removed" \
  models/ services/ routes/ utils/ config/ \
  --exclude-dir=node_modules \
  --exclude-dir=backups \
  --exclude-dir=migrations
```

**目标**: 0 命中（允许 migrations/ 和 docs/ 保留历史记录）

---

#### Step 2: 数据库二次核对

```bash
# 使用 Node.js + Sequelize 查询
node -e "
require('dotenv').config();
const { sequelize } = require('./config/database');
(async () => {
  await sequelize.authenticate();
  const tables = ['trade_records', 'user_asset_accounts', 'role_change_logs'];
  for (const t of tables) {
    const [[r]] = await sequelize.query(
      'SELECT COUNT(*) AS c FROM information_schema.tables WHERE table_schema=DATABASE() AND table_name=?',
      { replacements: [t] }
    );
    console.log(t, '存在:', r.c > 0 ? '是' : '否');
  }
  await sequelize.close();
})();
"
```

**目标**: 三个旧表全部显示"否"

---

#### Step 3: 关键字段验证

```bash
# 验证 lottery_draws 表字段
node -e "
require('dotenv').config();
const { sequelize } = require('./config/database');
(async () => {
  await sequelize.authenticate();
  const [[winner]] = await sequelize.query(
    'SELECT COUNT(*) AS c FROM information_schema.columns WHERE table_schema=DATABASE() AND table_name=\"lottery_draws\" AND column_name=\"is_winner\"'
  );
  const [[tier]] = await sequelize.query(
    'SELECT COUNT(*) AS c FROM information_schema.columns WHERE table_schema=DATABASE() AND table_name=\"lottery_draws\" AND column_name=\"reward_tier\"'
  );
  console.log('is_winner 存在:', winner.c > 0 ? '是' : '否');
  console.log('reward_tier 存在:', tier.c > 0 ? '是' : '否');
  await sequelize.close();
})();
"
```

**目标**: `is_winner` 不存在，`reward_tier` 存在

---

## 六、清理范围口径确认（✅ 已拍板）

**拍板时间**: 2026-01-13  
**决策人**: 项目负责人  
**执行授权**: ✅ 允许进入实施阶段

### ✅ 最终决策（第一轮）

| 决策项                | 选择方案                            | 说明                                       |
| --------------------- | ----------------------------------- | ------------------------------------------ |
| **1. 清理范围**       | **A - 仅清理运行时代码注释**        | 不清理 docs/ 与 backups/ 中的历史报告/备份 |
| **2. 注释处理风格**   | **A - 删除所有"已删除/已废弃"段落** | 历史交给 Git，代码只保留当前事实           |
| **3. 迁移历史基线化** | **B - 继续 squash（强基线）**       | 目标：新环境初始化迁移数量压到最小         |
| **4. 对外兼容窗口**   | **不再兼容**                        | 小程序/前端不再兼容旧字段/旧路径           |
| **5. 备份文件处理**   | **不需要任何处理**                  | backups/ 和 docs/ 文件夹保持原样           |

### ✅ 最终决策（第二轮 - 实施细节）

| 决策项                | 选择方案                                | 说明                                       |
| --------------------- | --------------------------------------- | ------------------------------------------ |
| **6. 不兼容落地方式** | **A - 立即删除旧路径/旧字段**           | 客户端打到旧接口直接 404/报错，无引导窗口  |
| **7. 强基线具体做法** | **A - baseline 作为推荐新环境起步方式** | 历史迁移继续留在 migrations/，最稳改动最少 |
| **8. 执行授权**       | **✅ 允许进入实施阶段**                 | 授权立即开始代码修改（阶段1→2→3）          |

### 清理执行方案（基于拍板决策）

#### 阶段1：运行时代码注释清理（P0 + P1 全量）

**清理范围**: models/ services/ routes/ utils/ config/  
**清理原则**: 删除所有"已删除/已废弃/迁移原因"等历史叙述，仅保留当前架构事实

| 文件                                     | 行号范围 | 清理动作                         | 预计工作量 |
| ---------------------------------------- | -------- | -------------------------------- | ---------- |
| `models/index.js`                        | 115-124  | 删除 TradeRecord 整块注释        | 10行       |
| `models/index.js`                        | 190-194  | 改写 UserAssetAccount 注释为现状 | 5行        |
| `models/User.js`                         | 158-165  | 改写 TradeRecord 关联注释为现状  | 8行        |
| `services/index.js`                      | 216-220  | 删除迁移说明，保留现状架构       | 5行        |
| `services/ContentAuditEngine.js`         | 44-46    | 改为支持类型列表                 | 3行        |
| `services/FeeCalculator.js`              | 22-24    | 删除变更记录                     | 3行        |
| `services/HierarchyManagementService.js` | 32       | 改为统一审计日志路径             | 1行        |
| `services/.../BasicGuaranteeStrategy.js` | 12-16    | 改为当前语义描述                 | 5行        |

**总计**: 40行代码注释清理

#### 阶段2：迁移历史强基线化（squash）

**目标**: 新环境初始化推荐使用 baseline 快速起步

**当前状态**:

- 真实库 `sequelizemeta` 有 248 条迁移记录
- 已有 baseline 文件：`20260104000000-baseline-v2.0.0-from-production.js`（44张表）
- 历史迁移文件仍保留在 `migrations/` 目录

**执行策略（✅ 已拍板：方案A - 最稳改动最少）**:

1. **保持现有目录结构**：所有迁移文件继续留在 `migrations/` 目录（不归档）
2. **新环境初始化流程（推荐）**：
   - 方式1（推荐）：执行 baseline V2.0.0 → 跳过 baseline 之前的历史迁移 → 执行 baseline 之后的增量迁移
   - 方式2（完整）：按时间戳顺序执行全部 248 条迁移（保留审计完整性）
3. **baseline 跳过逻辑实现**：
   - 在 baseline 文件中添加幂等性检查：`if (await tableExists('users')) { skip }`
   - 检测逻辑：如果核心表已存在，则认为是现有环境，跳过 baseline
4. **现有环境兼容**：
   - 已执行过历史迁移的环境：baseline 自动跳过（幂等性检查）
   - 新环境：baseline 正常执行，历史迁移自动跳过（sequelizemeta 已记录 baseline）

**预期效果**:

- 新环境初始化迁移数量（推荐方式）：~53 条（1 baseline + 52 增量）
- 新环境初始化时间（推荐方式）：~3分钟
- 现有环境：无影响（baseline 自动跳过）
- 历史回溯：完整保留（所有迁移文件仍在 migrations/ 目录）
- 改动范围：仅修改 baseline 文件添加幂等性检查（约10行代码）

#### 阶段3：对外兼容窗口清理

**清理策略（✅ 已拍板：方案A - 立即删除，无引导窗口）**: 不再兼容旧字段/旧路径

**具体措施**:

1. **API 路径**：直接删除所有旧路径兼容代码（如 camelCase 兼容）
   - 删除后：客户端请求旧路径 → 直接 404 Not Found
   - 无过渡期：不返回 410 Gone，不提供新端点引导
2. **响应字段**：统一使用 snake_case，直接删除 camelCase 字段返回逻辑
   - 删除后：客户端解析旧字段 → undefined/null
3. **废弃端点**：直接删除路由定义和处理逻辑
   - 删除后：客户端请求 → Express 默认 404 处理器
4. **小程序强制升级**：
   - 服务端：删除旧 API 兼容代码
   - 客户端：必须升级到支持新 API 的版本（否则无法使用）

**执行时机**:

- **前置条件**：小程序新版本（支持新 API）已上线且覆盖率 > 95%
- **执行窗口**：小程序新版本上线 2 周后（确保用户有足够时间升级）
- **通知策略**：
  - 提前 1 周：小程序内弹窗通知"旧版本即将停止服务"
  - 执行当天：旧版本用户打开小程序 → API 报错 → 引导升级

**风险控制**:

- **小程序审核周期**：提前 3 周提交新版本审核（预留审核时间）
- **灰度策略**：先在测试环境验证新 API，再在生产环境一次性切换（无灰度）
- **回滚预案**：
  - Git 保留旧 API 代码分支（tag: `v4-legacy-api-backup`）
  - 紧急情况：回滚到旧分支重新部署（预计 10 分钟内恢复）
  - 回滚触发条件：新版本上线后 1 小时内错误率 > 5%

---

## 七、附录：关键代码位置索引

### 7.1 模型层（models/）

| 文件     | 行号    | 内容摘要                   |
| -------- | ------- | -------------------------- |
| index.js | 115-124 | TradeRecord 整块注释       |
| index.js | 190-194 | UserAssetAccount 废弃注释  |
| User.js  | 158-165 | TradeRecord 关联已删除注释 |

### 7.2 服务层（services/）

| 文件                          | 行号    | 内容摘要                 |
| ----------------------------- | ------- | ------------------------ |
| index.js                      | 216-220 | 迁移说明注释             |
| ContentAuditEngine.js         | 44-46   | image 类型已废弃注释     |
| FeeCalculator.js              | 22-24   | TradeRecord 已废弃注释   |
| HierarchyManagementService.js | 32      | role_change_logs 表引用  |
| .../BasicGuaranteeStrategy.js | 12-16   | is_winner 字段已删除注释 |

### 7.3 数据库表与字段对照

| 旧对象                         | 状态   | 新对象/替代方案                                     |
| ------------------------------ | ------ | --------------------------------------------------- |
| `trade_records` 表             | 已删除 | `trade_orders` + `asset_transactions`               |
| `user_asset_accounts` 表       | 已删除 | `account_asset_balances`                            |
| `role_change_logs` 表          | 已删除 | `admin_operation_logs` + `user_role_change_records` |
| `lottery_draws.is_winner` 字段 | 已删除 | `lottery_draws.reward_tier`                         |

---

## 八、执行计划与时间表

### 8.1 执行顺序（按依赖关系）

```
阶段1：运行时代码注释清理（1-2小时）
   ↓
阶段2：迁移历史强基线化（2-3小时）
   ↓
阶段3：对外兼容窗口清理（需协调小程序发版，1-2周）
```

### 8.2 详细时间表

| 阶段  | 任务                          | 预计工作量 | 依赖条件               | 风险等级 | 执行状态  |
| ----- | ----------------------------- | ---------- | ---------------------- | -------- | --------- |
| 阶段1 | 运行时代码注释清理            | 1-2小时    | 无                     | 低       | 🟡 准备中 |
| 阶段1 | 全仓扫描验证（0残留）         | 10分钟     | 注释清理完成           | 低       | ⚪ 待执行 |
| 阶段1 | 数据库二次核对                | 5分钟      | 注释清理完成           | 低       | ⚪ 待执行 |
| 阶段2 | baseline 幂等性检查实现       | 30分钟     | 阶段1完成              | 低       | ⚪ 待执行 |
| 阶段2 | 新环境初始化测试              | 1小时      | 幂等性检查实现         | 低       | ⚪ 待执行 |
| 阶段3 | 小程序新版本开发（支持新API） | 3-5天      | 阶段1完成              | 中       | ⚪ 待执行 |
| 阶段3 | 小程序提审+上线               | 1-3周      | 新版本开发完成         | 高       | ⚪ 待执行 |
| 阶段3 | 旧API兼容代码删除（硬切）     | 2小时      | 小程序新版本覆盖率>95% | 高       | ⚪ 待执行 |

### 8.3 风险控制措施

#### 阶段1风险（低）

- **风险**: 注释清理误删业务逻辑说明
- **控制**: 逐文件人工 review，确保只删除历史叙述
- **回滚**: Git revert 即可

#### 阶段2风险（低）

- **风险**: baseline 幂等性检查判断错误，导致现有环境重复执行
- **控制**:
  1. 在 baseline 迁移文件中添加幂等性检查（检查核心表是否已存在）
  2. 在测试环境完整验证新环境初始化流程
  3. 在现有环境执行 `npm run migration:status` 确认不会重复执行
  4. 幂等性检查逻辑：`if (await tableExists('users')) { console.log('跳过 baseline'); return; }`
- **回滚**: 所有迁移文件仍在 migrations/ 目录，无需恢复

#### 阶段3风险（高）

- **风险**: 小程序旧版本用户无法使用（硬切无过渡期）
- **控制**:
  1. **前置强制升级**：小程序新版本上线后，提前 1 周弹窗通知旧版本用户升级
  2. **覆盖率监控**：确保新版本覆盖率 > 95% 后再删除旧 API
  3. **错误率监控**：新版本上线后 1 小时内错误率 > 5% 触发回滚
  4. **无过渡期**：直接删除旧 API 代码，不保留兼容窗口
- **回滚**:
  - Git 保留旧 API 代码分支（tag: `v4-legacy-api-backup`）
  - 紧急回滚时间：10 分钟内恢复旧 API

### 8.4 验收标准

#### 阶段1验收

- [ ] 运行 `grep -r "已废弃\|已删除\|已迁移" models/ services/ routes/ utils/ config/` 返回 0 结果
- [ ] 运行 `node scripts/database/verify-db-state.js` 确认旧表不存在
- [ ] 代码 review 通过，确认无业务逻辑说明被误删
- [ ] 单元测试全部通过

#### 阶段2验收

- [ ] baseline 文件添加幂等性检查（检查核心表是否存在）
- [ ] 新环境初始化迁移数量 ≤ 60 条（推荐方式：baseline + 增量）
- [ ] 新环境初始化时间 ≤ 5 分钟
- [ ] 现有环境执行 `npm run migration:status` 无异常
- [ ] 现有环境执行迁移时 baseline 自动跳过（幂等性检查生效）
- [ ] 所有历史迁移文件仍在 migrations/ 目录（未归档）

#### 阶段3验收

- [ ] 小程序新版本覆盖率 > 95%（硬切前置条件）
- [ ] 旧 API 兼容代码已完全删除（无过渡期）
- [ ] 新 API 错误率 < 0.1%（上线后 1 小时内监控）
- [ ] 回滚预案演练通过（10 分钟内恢复旧 API）
- [ ] Git 保留旧 API 代码分支（tag: `v4-legacy-api-backup`）

---

## 九、附录：自动化脚本

### 9.1 全仓扫描脚本（验证阶段1）

```bash
#!/bin/bash
# scripts/validation/scan-legacy-comments.sh

echo "🔍 扫描运行时代码中的历史注释残留..."

PATTERNS=(
  "已废弃"
  "已删除"
  "已迁移"
  "迁移原因"
  "删除原因"
  "废弃原因"
  "TradeRecord.*已删除"
  "UserAssetAccount.*已废弃"
  "role_change_logs.*已删除"
)

FOUND=0

for pattern in "${PATTERNS[@]}"; do
  echo "检查模式: $pattern"
  MATCHES=$(grep -r "$pattern" models/ services/ routes/ utils/ config/ \
    --exclude-dir=node_modules \
    --exclude-dir=backups \
    --exclude-dir=migrations \
    --exclude-dir=docs \
    2>/dev/null | wc -l)

  if [ "$MATCHES" -gt 0 ]; then
    echo "  ❌ 发现 $MATCHES 处残留"
    FOUND=$((FOUND + MATCHES))
    grep -r "$pattern" models/ services/ routes/ utils/ config/ \
      --exclude-dir=node_modules \
      --exclude-dir=backups \
      --exclude-dir=migrations \
      --exclude-dir=docs \
      2>/dev/null
  else
    echo "  ✅ 无残留"
  fi
done

echo ""
if [ $FOUND -eq 0 ]; then
  echo "✅ 验收通过：运行时代码无历史注释残留"
  exit 0
else
  echo "❌ 验收失败：发现 $FOUND 处历史注释残留"
  exit 1
fi
```

### 9.2 数据库状态验证脚本（验证阶段1）

```javascript
// scripts/database/verify-db-state.js

require('dotenv').config()
const { sequelize } = require('./config/database')

const DELETED_TABLES = ['trade_records', 'user_asset_accounts', 'role_change_logs']
const DELETED_COLUMNS = [{ table: 'lottery_draws', column: 'is_winner' }]
const REQUIRED_TABLES = [
  'asset_transactions',
  'trade_orders',
  'item_instance_events',
  'accounts',
  'account_asset_balances',
  'content_review_records'
]
const REQUIRED_COLUMNS = [
  { table: 'lottery_draws', column: 'reward_tier' },
  { table: 'account_asset_balances', column: 'frozen_amount' }
]

async function verifyDatabaseState() {
  console.log('🔍 验证数据库状态...\n')

  let passed = true

  // 1. 验证旧表不存在
  console.log('1️⃣ 验证旧表已删除:')
  for (const table of DELETED_TABLES) {
    const [[result]] = await sequelize.query(
      'SELECT COUNT(*) AS c FROM information_schema.tables WHERE table_schema=DATABASE() AND table_name=?',
      { replacements: [table] }
    )
    if (result.c > 0) {
      console.log(`  ❌ ${table} 仍然存在（应该已删除）`)
      passed = false
    } else {
      console.log(`  ✅ ${table} 已删除`)
    }
  }

  // 2. 验证旧字段不存在
  console.log('\n2️⃣ 验证旧字段已删除:')
  for (const { table, column } of DELETED_COLUMNS) {
    const [[result]] = await sequelize.query(
      'SELECT COUNT(*) AS c FROM information_schema.columns WHERE table_schema=DATABASE() AND table_name=? AND column_name=?',
      { replacements: [table, column] }
    )
    if (result.c > 0) {
      console.log(`  ❌ ${table}.${column} 仍然存在（应该已删除）`)
      passed = false
    } else {
      console.log(`  ✅ ${table}.${column} 已删除`)
    }
  }

  // 3. 验证新表存在
  console.log('\n3️⃣ 验证新表已创建:')
  for (const table of REQUIRED_TABLES) {
    const [[result]] = await sequelize.query(
      'SELECT COUNT(*) AS c FROM information_schema.tables WHERE table_schema=DATABASE() AND table_name=?',
      { replacements: [table] }
    )
    if (result.c === 0) {
      console.log(`  ❌ ${table} 不存在（应该已创建）`)
      passed = false
    } else {
      console.log(`  ✅ ${table} 已创建`)
    }
  }

  // 4. 验证新字段存在
  console.log('\n4️⃣ 验证新字段已创建:')
  for (const { table, column } of REQUIRED_COLUMNS) {
    const [[result]] = await sequelize.query(
      'SELECT COUNT(*) AS c FROM information_schema.columns WHERE table_schema=DATABASE() AND table_name=? AND column_name=?',
      { replacements: [table, column] }
    )
    if (result.c === 0) {
      console.log(`  ❌ ${table}.${column} 不存在（应该已创建）`)
      passed = false
    } else {
      console.log(`  ✅ ${table}.${column} 已创建`)
    }
  }

  console.log('\n' + '='.repeat(50))
  if (passed) {
    console.log('✅ 验收通过：数据库状态与代码一致')
    process.exit(0)
  } else {
    console.log('❌ 验收失败：数据库状态与代码不一致')
    process.exit(1)
  }
}

;(async () => {
  try {
    await sequelize.authenticate()
    await verifyDatabaseState()
  } catch (error) {
    console.error('❌ 验证失败:', error.message)
    process.exit(1)
  } finally {
    await sequelize.close()
  }
})()
```

---

---

## 十、执行授权与启动

### ✅ 执行授权确认

**授权人**: 项目负责人  
**授权时间**: 2026-01-13  
**授权范围**: 允许立即进入实施阶段（阶段1 → 阶段2 → 阶段3）

### 🚀 立即启动

**当前状态**: 🟡 准备中  
**下一步行动**: 执行阶段1（运行时代码注释清理）  
**预计工作量**: 1-2 小时  
**执行方式**: 逐文件修改 → 全仓扫描验证 → 数据库二次核对

---

**报告结束**
