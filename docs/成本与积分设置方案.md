# 成本与积分设置方案文档

## 📊 业务场景概述

### 业务模型
- **用户消费**：1000元
- **平台抽成**：10% = 100元
- **利润目标**：20% = 20元（纯利润）
- **实际成本**：80元（用于生产奖品）
- **奖品价值**：300元（市场价值）
- **成本积分**：240积分（实际预算）
- **展示积分**：300积分（用户可见）

### 核心逻辑
```
消费1000元 → 平台收入100元
           ├─ 纯利润：20元（20%）
           └─ 奖品成本：80元（80%）
                      └─ 生产价值300元的奖品
                         ├─ 内部预算：240积分
                         └─ 用户展示：300积分
```

---

## 🔧 代码实现分析

### 1. 双账户体系

#### 1.1 用户可见账户（积分账户）
- **模型**：`UserPointsAccount.available_points`
- **计算规则**：消费金额 1:1 转换
- **用途**：用户在兑换商城看到并使用的积分
- **示例**：1000元消费 → 1000积分

**代码位置**：
```javascript
// models/UserPointsAccount.js
available_points: {
  type: DataTypes.DECIMAL(10, 2),
  defaultValue: 0,
  comment: '可用积分（用户可见）'
}
```

#### 1.2 预算账户（内部成本账户）
- **模型**：`UserPointsAccount.budget_points` / `remaining_budget_points`
- **计算规则**：消费金额 × `budget_allocation_ratio`
- **默认比例**：0.24（即24%）
- **用途**：平台内部成本核算，抽奖时扣除
- **示例**：1000元消费 × 0.24 = 240预算积分

**代码位置**：
```javascript
// models/UserPointsAccount.js
budget_points: {
  type: DataTypes.DECIMAL(10, 2),
  defaultValue: 0,
  comment: '预算积分总额'
},
remaining_budget_points: {
  type: DataTypes.DECIMAL(10, 2),
  defaultValue: 0,
  comment: '剩余预算积分'
}

// services/ConsumptionService.js
async getBudgetRatio(spaceId) {
  const config = await SpaceConfig.findOne({
    where: { space_id: spaceId }
  });
  return config?.budget_allocation_ratio || 0.24;
}
```

---

## 💰 成本与积分换算方案

### 2.1 核心换算公式

#### 预算积分计算
```
预算积分 = 消费金额 × budget_allocation_ratio
         = 1000 × 0.24
         = 240积分
```

#### 展示积分计算
```
展示积分 = 预算积分 ÷ 成本利用率
         = 240 ÷ 0.8
         = 300积分

其中：成本利用率 = 80元成本 ÷ 100元抽成 = 0.8
```

#### 虚标倍率
```
虚标倍率 = 展示积分 ÷ 预算积分
         = 300 ÷ 240
         = 1.25倍
```

### 2.2 配置参数对照表

| 参数名称 | 代码字段 | 推荐值 | 说明 |
|---------|---------|--------|------|
| 抽成比例 | - | 10% | 平台从商家消费中抽取 |
| 利润比例 | - | 20% | 从抽成中保留的纯利润 |
| 成本比例 | - | 80% | 从抽成中用于奖品成本 |
| 预算分配比例 | `budget_allocation_ratio` | 0.24 | 消费金额→预算积分 |
| 虚标倍率 | `display_multiplier` | 1.25 | 预算积分→展示积分 |

---

## 🎁 兑换商城奖品标注方案

### 3.1 奖品字段配置

#### 方案A：使用 Product 模型（推荐）

**适用场景**：标准商品兑换

```javascript
// models/Product.js
{
  name: '价值300元奖品',
  
  // 用户看到的兑换积分（虚标后）
  exchange_points: 300,
  
  // 内部成本积分（实际预算）
  cost_points: 240,
  
  // 市场价值（元）
  market_value: 300,
  
  // 实际成本（元）
  actual_cost: 80,
  
  space_config: {
    free: {
      exchange_points: 300,  // 普通用户看到300积分
      cost_points: 240       // 内部扣240预算
    },
    premium: {
      exchange_points: 270,  // VIP用户优惠10%
      cost_points: 240       // 成本不变
    }
  }
}
```

#### 方案B：使用 ExchangeItem 模型

**适用场景**：特殊兑换活动

```javascript
// models/ExchangeItem.js
{
  name: '价值300元奖品',
  
  // 用户看到的兑换价格
  points_price: 300,
  
  // 内部成本积分
  budget_cost: 240,
  
  // 市场价值
  market_value: 300,
  
  // 实际成本
  actual_cost: 80
}
```

### 3.2 抽奖奖品配置

```javascript
// models/LotteryPrize.js
{
  name: '价值300元奖品',
  
  // 内部成本积分（从预算账户扣除）
  prize_value_points: 240,
  
  // 用户看到的价值（展示用）
  display_value: 300,
  
  // 市场价值（元）
  market_value: 300,
  
  // 实际成本（元）
  actual_cost: 80,
  
  // 虚标说明
  value_description: '价值300元'
}
```

---

## 📐 实施步骤

### 步骤1：配置预算分配比例

**位置**：后台系统设置 → 空间配置

```javascript
// 在 SpaceConfig 中设置
{
  space_id: 'your_space_id',
  budget_allocation_ratio: 0.24  // 1000元→240预算积分
}
```

**验证方法**：
```bash
# 测试消费1000元
POST /api/v4/consumption/submit
{
  "amount": 1000,
  "merchant_id": "xxx"
}

# 查询用户账户
GET /api/v4/points/account
# 应该看到：
# available_points: 1000（用户可见）
# budget_points: 240（内部预算）
```

### 步骤2：配置商品展示积分

**位置**：后台商品管理 → 添加/编辑商品

```javascript
// 方式1：直接在数据库配置
UPDATE products SET 
  exchange_points = 300,        -- 用户看到的积分
  cost_points = 240,            -- 内部成本积分
  market_value = 300,           -- 市场价值
  actual_cost = 80              -- 实际成本
WHERE id = 'product_id';

// 方式2：通过API配置
POST /api/v4/admin/products
{
  "name": "价值300元奖品",
  "exchange_points": 300,
  "cost_points": 240,
  "market_value": 300,
  "actual_cost": 80
}
```

### 步骤3：配置抽奖奖品

**位置**：后台抽奖管理 → 奖品配置

```javascript
POST /api/v4/admin/lottery/prizes
{
  "name": "价值300元奖品",
  "prize_value_points": 240,    -- 从预算账户扣除
  "display_value": 300,         -- 用户看到的价值
  "market_value": 300,
  "actual_cost": 80
}
```

---

## 🔍 验证与测试

### 测试场景1：消费积分发放

```javascript
// 1. 用户消费1000元
const consumption = await ConsumptionService.createConsumption({
  user_id: 'user_123',
  merchant_id: 'merchant_456',
  amount: 1000
});

// 2. 审核通过
await ConsumptionService.approveConsumption(consumption.id);

// 3. 验证积分账户
const account = await UserPointsAccount.findOne({
  where: { user_id: 'user_123' }
});

console.log('用户可见积分:', account.available_points);  // 应为 1000
console.log('预算积分:', account.budget_points);          // 应为 240
```

### 测试场景2：商城兑换

```javascript
// 1. 查询商品（用户视角）
const product = await Product.findByPk('product_id');
const spaceInfo = product.getSpaceInfo('free');

console.log('展示积分:', spaceInfo.exchange_points);  // 用户看到 300

// 2. 执行兑换
const result = await ExchangeMarketService.exchange({
  user_id: 'user_123',
  product_id: 'product_id',
  quantity: 1
});

// 3. 验证扣款
// - available_points 扣除 300（用户可见）
// - budget_points 扣除 240（内部成本）
```

### 测试场景3：抽奖消耗

```javascript
// 1. 用户抽奖中奖
const prize = await LotteryPrize.findByPk('prize_id');

console.log('奖品展示价值:', prize.display_value);        // 300元
console.log('内部成本积分:', prize.prize_value_points);   // 240积分

// 2. 发放奖品
await UnifiedLotteryEngine.awardPrize({
  user_id: 'user_123',
  prize_id: 'prize_id'
});

// 3. 验证预算扣除
// remaining_budget_points 应减少 240
```

---

## 📊 数据监控与报表

### 关键指标监控

```javascript
// 1. 成本利润分析
SELECT 
  SUM(amount) as total_consumption,           -- 总消费
  SUM(amount * 0.1) as platform_revenue,      -- 平台抽成
  SUM(amount * 0.1 * 0.2) as net_profit,      -- 纯利润
  SUM(amount * 0.1 * 0.8) as prize_budget,    -- 奖品预算
  SUM(budget_points) as total_budget_points   -- 总预算积分
FROM consumptions
WHERE status = 'approved';

// 2. 积分使用率
SELECT 
  SUM(budget_points) as allocated_budget,
  SUM(remaining_budget_points) as unused_budget,
  (SUM(budget_points) - SUM(remaining_budget_points)) / SUM(budget_points) * 100 as usage_rate
FROM user_points_accounts;

// 3. 虚标倍率验证
SELECT 
  p.name,
  p.exchange_points as display_points,
  p.cost_points as budget_points,
  p.exchange_points / p.cost_points as multiplier
FROM products p
WHERE p.cost_points > 0;
```

---

## ⚠️ 注意事项

### 1. 成本控制
- **预算积分总量** = 平台抽成 × 80%
- **展示积分** 可以虚标，但**预算扣除**必须按实际成本
- 定期监控预算使用率，避免超支

### 2. 用户体验
- 用户看到的是**展示积分**（300），感觉价值更高
- 实际扣款时扣**展示积分**（300），但内部成本只记**预算积分**（240）
- 保持一致性：所有奖品的虚标倍率应相同（1.25倍）

### 3. 财务合规
- 虚标倍率应在合理范围内（建议1.2-1.5倍）
- 市场价值应有真实依据
- 定期审计成本与收益

### 4. 系统配置
- `budget_allocation_ratio` 不要轻易修改，会影响历史数据
- 新增商品时必须同时配置 `exchange_points` 和 `cost_points`
- 抽奖奖品的 `prize_value_points` 必须≤用户的 `remaining_budget_points`

---

## 🎯 快速配置清单

### 后台配置项

| 配置项 | 位置 | 推荐值 | 说明 |
|--------|------|--------|------|
| 预算分配比例 | 系统设置 → 空间配置 | 0.24 | 消费金额→预算积分 |
| 商品展示积分 | 商品管理 → 兑换积分 | 300 | 用户看到的积分 |
| 商品成本积分 | 商品管理 → 成本积分 | 240 | 内部预算扣除 |
| 奖品价值积分 | 抽奖管理 → 奖品价值 | 240 | 从预算账户扣除 |
| 奖品展示价值 | 抽奖管理 → 展示价值 | 300 | 用户看到的价值 |

### 数据库字段对照

| 业务含义 | 数据库字段 | 示例值 |
|---------|-----------|--------|
| 用户可见积分 | `UserPointsAccount.available_points` | 1000 |
| 预算积分总额 | `UserPointsAccount.budget_points` | 240 |
| 剩余预算积分 | `UserPointsAccount.remaining_budget_points` | 240 |
| 商品展示积分 | `Product.exchange_points` | 300 |
| 商品成本积分 | `Product.cost_points` | 240 |
| 奖品成本积分 | `LotteryPrize.prize_value_points` | 240 |
| 奖品展示价值 | `LotteryPrize.display_value` | 300 |

---

## 📝 总结

### 核心公式
```
消费1000元 → 用户积分1000 + 预算积分240
预算积分240 → 展示积分300（虚标1.25倍）
平台抽成100元 → 利润20元 + 成本80元
成本80元 → 生产价值300元奖品
```

### 关键原则
1. **双账户分离**：用户可见积分（1000）与预算积分（240）独立核算
2. **虚标合理**：展示积分（300）= 预算积分（240）× 1.25倍
3. **成本可控**：实际扣除预算积分（240），对应80元成本
4. **利润保障**：20%利润（20元）不进入预算系统

### 实施要点
- ✅ 配置 `budget_allocation_ratio = 0.24`
- ✅ 商品设置 `exchange_points = 300`, `cost_points = 240`
- ✅ 抽奖设置 `prize_value_points = 240`, `display_value = 300`
- ✅ 定期监控预算使用率和成本利润比

---

**文档版本**：v1.0  
**最后更新**：2025年1月  
**适用系统**：餐饮抽奖积分系统 v4.x

