# ç§¯åˆ†å­—æ®µè¯¦ç»†è¯´æ˜æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

**æ–‡æ¡£æ ‡é¢˜**ï¼šé¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ - ç§¯åˆ†å­—æ®µè¯¦ç»†è¯´æ˜  
**åˆ›å»ºæ—¶é—´**ï¼š2025å¹´12æœˆ7æ—¥  
**æœ€æ–°ç‰ˆæœ¬**ï¼šv1.1  
**é€‚ç”¨ç³»ç»Ÿ**ï¼šé¤å…ç§¯åˆ†æŠ½å¥–è¥é”€å¹³å° V4.0

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ç³»ç»Ÿä¸­çš„åŒè´¦æˆ·æ¨¡å‹å’Œæ ¸å¿ƒç§¯åˆ†å­—æ®µçš„å«ä¹‰ã€ç”¨é€”å’Œä¸šåŠ¡é€»è¾‘ã€‚

---

## ğŸ¯ æ ¸å¿ƒå­—æ®µæ¦‚è§ˆ

### åŒè´¦æˆ·æ¨¡å‹è¯´æ˜

æœ¬ç³»ç»Ÿé‡‡ç”¨**åŒè´¦æˆ·æ¨¡å‹è®¾è®¡**ï¼Œåœ¨ `user_points_accounts`ï¼ˆç”¨æˆ·ç§¯åˆ†è´¦æˆ·è¡¨ï¼‰ä¸­ç»´æŠ¤ä¸¤å¥—ç‹¬ç«‹çš„ç§¯åˆ†ç³»ç»Ÿï¼š

#### 1ï¸âƒ£ æ˜¾ç¤ºç§¯åˆ†è´¦æˆ·ï¼ˆç”¨æˆ·å¯è§ï¼‰

| å­—æ®µå | ç”¨æˆ·å¯è§ | ä¸»è¦ç”¨é€” | æ•°å€¼ç¤ºä¾‹ |
|--------|---------|---------|---------|
| `available_points` | âœ… æ˜¯ | æ˜¾ç¤ºç»™ç”¨æˆ·çš„å¯ç”¨ç§¯åˆ†ä½™é¢ | 1000ç§¯åˆ† |
| `frozen_points` | âœ… æ˜¯ | å†»ç»“ç§¯åˆ†ï¼ˆå®¡æ ¸ä¸­ï¼‰ | 50ç§¯åˆ† |
| `total_earn` | âœ… æ˜¯ | ç´¯è®¡è·å¾—ç§¯åˆ† | 1500ç§¯åˆ† |
| `total_used` | âœ… æ˜¯ | ç´¯è®¡ä½¿ç”¨ç§¯åˆ† | 500ç§¯åˆ† |

**ç”¨é€”**ï¼šç”¨æˆ·ç”¨è¿™äº›ç§¯åˆ†è¿›è¡ŒæŠ½å¥–ã€å…‘æ¢å•†å“ï¼Œå¯åœ¨å‰ç«¯æŸ¥çœ‹ä½™é¢å’Œæ¶ˆè´¹è®°å½•ã€‚

#### 2ï¸âƒ£ é¢„ç®—ç§¯åˆ†è´¦æˆ·ï¼ˆç³»ç»Ÿå†…éƒ¨ï¼Œç”¨æˆ·ä¸å¯è§ï¼‰

| å­—æ®µå | ç”¨æˆ·å¯è§ | ä¸»è¦ç”¨é€” | æ•°å€¼ç¤ºä¾‹ |
|--------|---------|---------|---------|
| `budget_points` | âŒ å¦ | ç³»ç»Ÿå†…éƒ¨æ€»é¢„ç®—ç§¯åˆ† | 240é¢„ç®—ç§¯åˆ† |
| `remaining_budget_points` | âŒ å¦ | ç³»ç»Ÿå†…éƒ¨å‰©ä½™é¢„ç®— | 180é¢„ç®—ç§¯åˆ† |
| `used_budget_points` | âŒ å¦ | ç³»ç»Ÿå†…éƒ¨å·²ç”¨é¢„ç®— | 60é¢„ç®—ç§¯åˆ† |

**ç”¨é€”**ï¼šæ§åˆ¶ç”¨æˆ·èƒ½ä¸­ä»€ä¹ˆç­‰çº§çš„å¥–å“ï¼Œç”¨æˆ·æ¶ˆè´¹1000å…ƒ â†’ ç³»ç»Ÿè‡ªåŠ¨åˆ†é…240é¢„ç®—ç§¯åˆ†ï¼ŒæŠ½å¥–æ—¶æ ¹æ®å‰©ä½™é¢„ç®—ç­›é€‰å¥–å“æ± ã€‚

#### ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä¸ªè´¦æˆ·ï¼Ÿ

**ä¸šåŠ¡åœºæ™¯ç¤ºä¾‹ï¼š**

```javascript
// ç”¨æˆ·æ¶ˆè´¹1000å…ƒåçš„è´¦æˆ·çŠ¶æ€
{
  // æ˜¾ç¤ºè´¦æˆ·ï¼ˆç”¨æˆ·çœ‹åˆ°çš„ï¼‰
  available_points: 1000,  // âœ… å¯ä»¥æŠ½10æ¬¡å¥–ï¼ˆæ¯æ¬¡100ç§¯åˆ†ï¼‰
  
  // é¢„ç®—è´¦æˆ·ï¼ˆç³»ç»Ÿæ§åˆ¶çš„ï¼‰
  remaining_budget_points: 240  // âŒ åªèƒ½ä¸­ä»·å€¼240å…ƒä»¥å†…çš„å¥–å“
}
```

**æŠ½å¥–æ§åˆ¶é€»è¾‘ï¼š**
1. ç”¨æˆ·èŠ±100ç§¯åˆ†æŠ½å¥–ï¼ˆä»`available_points`æ‰£é™¤ï¼‰
2. ç³»ç»Ÿæ ¹æ®`remaining_budget_points=240`ç­›é€‰å¥–å“æ± ï¼š
   - âœ… å¯ä¸­å¥–ï¼š50å…ƒçº¢åŒ…ï¼ˆ`prize_value_points=50`ï¼‰
   - âœ… å¯ä¸­å¥–ï¼š10ä¸ªæ°´æ™¶ï¼ˆ`prize_value_points=10`ï¼‰
   - âŒ ä¸å¯ä¸­å¥–ï¼šiPhoneï¼ˆ`prize_value_points=5000`ï¼‰è¶…é¢„ç®—
3. ä¸­å¥–åæ‰£é™¤å¯¹åº”é¢„ç®—ï¼š`remaining_budget_points = 240 - 50 = 190`

**è®¾è®¡ä¼˜åŠ¿ï¼š**
- âœ… ç”¨æˆ·ä½“éªŒå¥½ï¼ˆåªçœ‹åˆ°æ™®é€šç§¯åˆ†ï¼Œä¸çŸ¥é“å¤æ‚çš„é¢„ç®—æœºåˆ¶ï¼‰
- âœ… å¹³å°å¯æ§ï¼ˆé€šè¿‡é¢„ç®—ç²¾ç¡®æ§åˆ¶æˆæœ¬ï¼‰
- âœ… é˜²æ­¢è–…ç¾Šæ¯›ï¼ˆç”¨æˆ·æ— æ³•é€šè¿‡æŠ€æœ¯æ‰‹æ®µè·çŸ¥é¢„ç®—è§„åˆ™ï¼‰
- âœ… å…¬å¹³æ€§ï¼ˆæ¶ˆè´¹å¤šçš„ç”¨æˆ·é¢„ç®—å¤šï¼Œèƒ½ä¸­æ›´å¥½çš„å¥–å“ï¼‰

---

### å¥–å“å’Œå•†å“ç›¸å…³å­—æ®µ

ç³»ç»Ÿä¸­è¿˜æœ‰ä¸‰ä¸ªå…³é”®çš„ä»·å€¼æ§åˆ¶å­—æ®µï¼Œåˆ†åˆ«ç”¨äºä¸åŒçš„ä¸šåŠ¡åœºæ™¯ï¼š

| å­—æ®µå | æ‰€å±æ•°æ®è¡¨ | ç”¨æˆ·å¯è§æ€§ | ä¸»è¦ç”¨é€” | æ•°å€¼ç¤ºä¾‹ |
|--------|-----------|-----------|---------|---------|
| **`prize_value_points`** | LotteryPrizeï¼ˆæŠ½å¥–å¥–å“è¡¨ï¼‰ | âŒ ä¸å¯è§ï¼ˆç³»ç»Ÿå†…éƒ¨ï¼‰ | å¹³å°å¥–å“æˆæœ¬é¢„ç®—æ§åˆ¶ | iPhone = 5000é¢„ç®—ç§¯åˆ† |
| **`virtual_value_price`** | ExchangeItemï¼ˆå…‘æ¢å•†å“è¡¨ï¼‰ | âœ… å¯è§ | ç”¨æˆ·å…‘æ¢å•†å“éœ€æ”¯ä»˜çš„è™šæ‹Ÿä»·å€¼ | å•†å“éœ€è¦100è™šæ‹Ÿä»·å€¼ |
| **`points_price`** | ExchangeItemï¼ˆå…‘æ¢å•†å“è¡¨ï¼‰ | âœ… å¯è§ | ç”¨æˆ·å…‘æ¢å•†å“éœ€æ”¯ä»˜çš„æ™®é€šç§¯åˆ† | å•†å“éœ€è¦500ç§¯åˆ† |

---

## 1ï¸âƒ£ prize_value_points - å¥–å“ä»·å€¼ç§¯åˆ†

### ğŸ“ åŸºæœ¬ä¿¡æ¯

- **å­—æ®µä½ç½®**ï¼š`models/LotteryPrize.js`ï¼ˆæŠ½å¥–å¥–å“è¡¨ï¼‰
- **æ•°æ®ç±»å‹**ï¼š`INTEGER`ï¼ˆæ•´æ•°ï¼‰
- **é»˜è®¤å€¼**ï¼š0
- **ç”¨æˆ·å¯è§**ï¼šâŒ å¦ï¼ˆç³»ç»Ÿå†…éƒ¨å­—æ®µï¼‰

### ğŸ¯ å­—æ®µå®šä¹‰

```javascript
/**
 * å¥–å“ä»·å€¼ç§¯åˆ†ï¼ˆåŒè´¦æˆ·æ¨¡å‹æ ¸å¿ƒå­—æ®µï¼‰
 * ç”¨äºé¢„ç®—æ§åˆ¶ï¼Œå†³å®šæŠ½ä¸­è¯¥å¥–å“éœ€è¦æ¶ˆè€—å¤šå°‘é¢„ç®—ç§¯åˆ†
 */
prize_value_points: {
  type: DataTypes.INTEGER,
  allowNull: false,
  defaultValue: 0,
  comment: 'å¥–å“ä»·å€¼ç§¯åˆ†ï¼ˆç»Ÿä¸€ä»·å€¼å•ä½ï¼‰'
}
```

### ğŸ’¡ ä¸šåŠ¡å«ä¹‰

**`prize_value_points`** æ˜¯ç³»ç»Ÿå†…éƒ¨ä½¿ç”¨çš„é¢„ç®—æ§åˆ¶å­—æ®µï¼Œä»£è¡¨**å‘æ”¾è¯¥å¥–å“éœ€è¦æ¶ˆè€—çš„å¹³å°é¢„ç®—æˆæœ¬**ã€‚

#### å®é™…ç¤ºä¾‹

| å¥–å“åç§° | prize_value_points | ä¸šåŠ¡å«ä¹‰ |
|---------|-------------------|---------|
| iPhone 15 Pro | 5000 | å‘æ”¾æ­¤å¥–å“æ¶ˆè€—5000é¢„ç®—ç§¯åˆ† |
| 50å…ƒçº¢åŒ… | 50 | å‘æ”¾æ­¤å¥–å“æ¶ˆè€—50é¢„ç®—ç§¯åˆ† |
| 10ä¸ªæ°´æ™¶ï¼ˆè™šæ‹Ÿå¥–å“ï¼‰ | 10 | å‘æ”¾æ­¤å¥–å“æ¶ˆè€—10é¢„ç®—ç§¯åˆ† |
| è°¢è°¢å‚ä¸ï¼ˆç©ºå¥–ï¼‰ | 0 | ä¸æ¶ˆè€—é¢„ç®—ï¼Œå¯æ— é™å‘æ”¾ |

### ğŸ” æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

#### 1. é¢„ç®—åˆ†é…æœºåˆ¶

```javascript
/**
 * ç”¨æˆ·æ¶ˆè´¹åçš„é¢„ç®—åˆ†é…
 * å…¬å¼ï¼šé¢„ç®—ç§¯åˆ† = æ¶ˆè´¹é‡‘é¢ Ã— é¢„ç®—ç³»æ•°ï¼ˆé»˜è®¤0.24ï¼‰
 */
// ç¤ºä¾‹ï¼šç”¨æˆ·æ¶ˆè´¹1000å…ƒ
const consumeAmount = 1000;
const budgetRatio = 0.24;
const budgetPoints = consumeAmount * budgetRatio; // 1000 Ã— 0.24 = 240é¢„ç®—ç§¯åˆ†

// ç”¨æˆ·è´¦æˆ·æ›´æ–°
UserPointsAccount.update({
  remaining_budget_points: 240  // ç”¨æˆ·è·å¾—240é¢„ç®—ç§¯åˆ†
});
```

#### 2. æŠ½å¥–æ—¶çš„å¥–å“æ± è¿‡æ»¤

```javascript
/**
 * æŠ½å¥–å¼•æ“æ ¹æ®ç”¨æˆ·å‰©ä½™é¢„ç®—ç­›é€‰å¯ä¸­å¥–å“
 * æ ¸å¿ƒè§„åˆ™ï¼šåªèƒ½æŠ½ä¸­ prize_value_points <= remaining_budget_points çš„å¥–å“
 */
async function filterPrizesByBudget(userId, prizes) {
  // æŸ¥è¯¢ç”¨æˆ·å‰©ä½™é¢„ç®—
  const userAccount = await UserPointsAccount.findOne({
    where: { user_id: userId }
  });
  
  const remainingBudget = userAccount.remaining_budget_points; // å‡è®¾ = 240
  
  // ç­›é€‰å¥–å“æ± 
  const availablePrizes = prizes.filter(prize => {
    return prize.prize_value_points <= remainingBudget;
  });
  
  /**
   * ç­›é€‰ç»“æœç¤ºä¾‹ï¼ˆç”¨æˆ·é¢„ç®—240ï¼‰ï¼š
   * âœ… å¯ä¸­å¥–å“ï¼š50å…ƒçº¢åŒ…ï¼ˆprize_value_points=50ï¼‰
   * âœ… å¯ä¸­å¥–å“ï¼š10ä¸ªæ°´æ™¶ï¼ˆprize_value_points=10ï¼‰
   * âœ… å¯ä¸­å¥–å“ï¼šè°¢è°¢å‚ä¸ï¼ˆprize_value_points=0ï¼‰
   * âŒ ä¸å¯ä¸­ï¼šiPhoneï¼ˆprize_value_points=5000ï¼Œè¶…å‡ºé¢„ç®—ï¼‰
   */
  
  return availablePrizes;
}
```

#### 3. ä¸­å¥–åçš„é¢„ç®—æ‰£é™¤

```javascript
/**
 * ç”¨æˆ·æŠ½ä¸­å¥–å“åï¼Œæ‰£é™¤å¯¹åº”çš„é¢„ç®—ç§¯åˆ†
 */
// ç”¨æˆ·æŠ½ä¸­"50å…ƒçº¢åŒ…"
const prize = { name: '50å…ƒçº¢åŒ…', prize_value_points: 50 };

// æ‰£é™¤é¢„ç®—
await UserPointsAccount.decrement({
  remaining_budget_points: prize.prize_value_points // æ‰£é™¤50
}, {
  where: { user_id: userId }
});

// è´¦æˆ·çŠ¶æ€å˜åŒ–
// ä¹‹å‰ï¼šremaining_budget_points = 240
// ä¹‹åï¼šremaining_budget_points = 190
```

#### 4. é¢„ç®—è€—å°½åçš„å¤„ç†

```javascript
/**
 * å½“ç”¨æˆ·é¢„ç®—è€—å°½æ—¶ï¼Œåªèƒ½æŠ½ä¸­0æˆæœ¬ç©ºå¥–
 */
if (remainingBudget === 0) {
  // åªä¿ç•™ç©ºå¥–
  const emptyPrizes = prizes.filter(p => p.prize_value_points === 0);
  
  console.log('âš ï¸ ç”¨æˆ·é¢„ç®—å·²è€—å°½ï¼Œåªèƒ½æŠ½ä¸­ç©ºå¥–');
  return emptyPrizes;
}
```

### ğŸ® å®Œæ•´ä¸šåŠ¡æµç¨‹ç¤ºä¾‹

```
ç”¨æˆ·Aæ¶ˆè´¹1000å…ƒ
  â†“
ç³»ç»Ÿåˆ†é…240é¢„ç®—ç§¯åˆ†ï¼ˆ1000 Ã— 0.24ï¼‰
  â†“
ç¬¬1æ¬¡æŠ½å¥–ï¼šä¸­"50å…ƒçº¢åŒ…"
  - æ‰£é™¤50é¢„ç®—ç§¯åˆ†
  - å‰©ä½™ï¼š190é¢„ç®—ç§¯åˆ†
  â†“
ç¬¬2æ¬¡æŠ½å¥–ï¼šä¸­"100ä¸ªæ°´æ™¶"
  - æ‰£é™¤100é¢„ç®—ç§¯åˆ†
  - å‰©ä½™ï¼š90é¢„ç®—ç§¯åˆ†
  â†“
ç¬¬3æ¬¡æŠ½å¥–ï¼šåªèƒ½ä¸­ prize_value_points â‰¤ 90 çš„å¥–å“
  - é«˜ä»·å€¼å¥–å“ï¼ˆiPhoneç­‰ï¼‰è¢«è¿‡æ»¤æ‰
  - åªèƒ½ä¸­å°é¢å¥–å“æˆ–ç©ºå¥–
  â†“
é¢„ç®—è€—å°½åï¼šåªèƒ½ä¸­ç©ºå¥–ï¼ˆè°¢è°¢å‚ä¸ï¼‰
```

### âš–ï¸ è®¾è®¡ç›®çš„

1. **æˆæœ¬æ§åˆ¶**ï¼šé˜²æ­¢å¹³å°å‘æ”¾å¥–å“æˆæœ¬è¶…å‡ºæ”¶å…¥
2. **å…¬å¹³æ€§**ï¼šæ¶ˆè´¹å¤šçš„ç”¨æˆ·é¢„ç®—å¤šï¼Œèƒ½ä¸­æ›´å¥½çš„å¥–å“
3. **å¯æŒç»­æ€§**ï¼šç¡®ä¿å¹³å°é•¿æœŸè¿è¥ä¸äºæŸ
4. **ç”¨æˆ·ä½“éªŒ**ï¼šé¢„ç®—å†…ä¿è¯æœ‰å¥–å¯ä¸­ï¼Œé¿å…"æ°¸è¿œä¸­ä¸äº†"

---

## 2ï¸âƒ£ virtual_value_price - è™šæ‹Ÿå¥–å“ä»·æ ¼

### ğŸ“ åŸºæœ¬ä¿¡æ¯

- **å­—æ®µä½ç½®**ï¼š`models/ExchangeItem.js`ï¼ˆå…‘æ¢å¸‚åœºå•†å“è¡¨ï¼‰
- **æ•°æ®ç±»å‹**ï¼š`INTEGER`ï¼ˆæ•´æ•°ï¼‰
- **å…è®¸ä¸ºç©º**ï¼šæ˜¯ï¼ˆä»…å½“ `price_type='virtual'` æˆ– `'mixed'` æ—¶æœ‰å€¼ï¼‰
- **ç”¨æˆ·å¯è§**ï¼šâœ… æ˜¯ï¼ˆå‰ç«¯æ˜¾ç¤ºï¼‰

### ğŸ¯ å­—æ®µå®šä¹‰

```javascript
/**
 * è™šæ‹Ÿå¥–å“ä»·æ ¼ï¼ˆä»·å€¼ç§¯åˆ†ï¼‰
 * ç”¨æˆ·ä½¿ç”¨èƒŒåŒ…ä¸­çš„è™šæ‹Ÿå¥–å“ä»·å€¼å…‘æ¢å•†å“æ‰€éœ€æ”¯ä»˜çš„æ•°é‡
 */
virtual_value_price: {
  type: DataTypes.INTEGER,
  allowNull: true,
  comment: 'è™šæ‹Ÿå¥–å“ä»·æ ¼ï¼ˆä»·å€¼ç§¯åˆ†ï¼‰'
}
```

### ğŸ’¡ ä¸šåŠ¡å«ä¹‰

**`virtual_value_price`** æ˜¯å…‘æ¢å¸‚åœºå•†å“çš„**è™šæ‹Ÿä»·å€¼æ ‡ä»·**ï¼Œç”¨æˆ·éœ€è¦æ”¯ä»˜ç›¸åº”æ•°é‡çš„**è™šæ‹Ÿå¥–å“ä»·å€¼ç§¯åˆ†**æ‰èƒ½å…‘æ¢è¯¥å•†å“ã€‚

#### å®é™…ç¤ºä¾‹

| å•†å“åç§° | virtual_value_price | å‰ç«¯æ˜¾ç¤º | ç”¨æˆ·éœ€æ”¯ä»˜ |
|---------|---------------------|---------|-----------|
| æ˜Ÿå·´å…‹å’–å•¡åˆ¸ | 100 | `100 è™šæ‹Ÿä»·å€¼` | 100è™šæ‹Ÿä»·å€¼ç§¯åˆ† |
| å°ç±³è“ç‰™è€³æœº | 500 | `500 è™šæ‹Ÿä»·å€¼` | 500è™šæ‹Ÿä»·å€¼ç§¯åˆ† |
| è¿åŠ¨æ°´æ¯ | 50 | `50 è™šæ‹Ÿä»·å€¼` | 50è™šæ‹Ÿä»·å€¼ç§¯åˆ† |

### ğŸŒŸ è™šæ‹Ÿä»·å€¼ç§¯åˆ†çš„æ¥æº

ç”¨æˆ·é€šè¿‡**æŠ½å¥–è·å¾—è™šæ‹Ÿå¥–å“**ï¼ˆå¦‚æ°´æ™¶ã€è´µé‡‘å±ç­‰ï¼‰ï¼Œè¿™äº›è™šæ‹Ÿå¥–å“ä¼šå­˜å…¥ç”¨æˆ·èƒŒåŒ…ï¼ˆ`UserInventory`è¡¨ï¼‰ï¼Œæ¯ä¸ªè™šæ‹Ÿå¥–å“éƒ½æœ‰å¯¹åº”çš„ä»·å€¼ã€‚

#### è™šæ‹Ÿå¥–å“ç¤ºä¾‹

| è™šæ‹Ÿå¥–å“åç§° | æ•°é‡ | å•ä½ä»·å€¼ | æ€»ä»·å€¼ |
|------------|------|---------|--------|
| æ°´æ™¶ | 100ä¸ª | 1è™šæ‹Ÿä»·å€¼/ä¸ª | 100è™šæ‹Ÿä»·å€¼ |
| é»„é‡‘ | 50å…‹ | 2è™šæ‹Ÿä»·å€¼/å…‹ | 100è™šæ‹Ÿä»·å€¼ |
| é’»çŸ³ | 10é¢— | 10è™šæ‹Ÿä»·å€¼/é¢— | 100è™šæ‹Ÿä»·å€¼ |

### ğŸ” æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

#### 1. å‰ç«¯æ˜¾ç¤ºé€»è¾‘

```javascript
/**
 * å…‘æ¢å¸‚åœºå•†å“åˆ—è¡¨æ˜¾ç¤º
 * æ–‡ä»¶ï¼špublic/admin/exchange-market-items.html
 */
function renderItems(items) {
  items.forEach(item => {
    let priceDisplay = '';
    
    if (item.price_type === 'virtual') {
      // ä»…è™šæ‹Ÿä»·å€¼æ”¯ä»˜
      priceDisplay = `<span class="badge bg-info">${item.virtual_value_price} è™šæ‹Ÿä»·å€¼</span>`;
    } else if (item.price_type === 'mixed') {
      // æ··åˆæ”¯ä»˜ï¼ˆè™šæ‹Ÿä»·å€¼ + ç§¯åˆ†ï¼‰
      priceDisplay = `
        <span class="badge bg-info">${item.virtual_value_price} è™šæ‹Ÿ</span>
        <span class="badge bg-primary">${item.points_price} ç§¯åˆ†</span>
      `;
    }
    
    // æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
    // ç¤ºä¾‹ï¼š[100 è™šæ‹Ÿä»·å€¼] æ˜Ÿå·´å…‹å’–å•¡åˆ¸
  });
}
```

#### 2. å…‘æ¢æ—¶çš„æ”¯ä»˜é€»è¾‘

```javascript
/**
 * ç”¨æˆ·å…‘æ¢å•†å“æ—¶çš„ä»·æ ¼è®¡ç®—å’Œæ‰£é™¤é€»è¾‘
 * æ–‡ä»¶ï¼šservices/ExchangeMarketService.js
 */
async function exchangeItem(user_id, item_id, quantity) {
  // 1. è·å–å•†å“ä¿¡æ¯
  const item = await ExchangeItem.findOne({ where: { item_id } });
  
  // 2. è®¡ç®—æ€»ä»·
  const totalVirtualValue = (item.virtual_value_price || 0) * quantity;
  // ç¤ºä¾‹ï¼šå…‘æ¢2ä¸ªå•†å“ï¼Œæ¯ä¸ª100è™šæ‹Ÿä»·å€¼ = 200è™šæ‹Ÿä»·å€¼
  
  // 3. æ£€æŸ¥ç”¨æˆ·èƒŒåŒ…ä¸­çš„è™šæ‹Ÿä»·å€¼æ˜¯å¦è¶³å¤Ÿ
  const userInventory = await UserInventory.sum('virtual_value_points', {
    where: { 
      user_id,
      item_type: 'virtual' // è™šæ‹Ÿå¥–å“
    }
  });
  
  if (userInventory < totalVirtualValue) {
    throw new Error('è™šæ‹Ÿä»·å€¼ä¸è¶³ï¼Œæ— æ³•å…‘æ¢');
  }
  
  // 4. æ‰£é™¤è™šæ‹Ÿä»·å€¼ï¼ˆä»èƒŒåŒ…æ‰£é™¤ï¼‰
  await deductVirtualValue(user_id, totalVirtualValue, transaction);
  
  // 5. åˆ›å»ºå…‘æ¢è®¢å•
  await ExchangeMarketRecord.create({
    user_id,
    item_id,
    quantity,
    payment_type: 'virtual',
    virtual_value_paid: totalVirtualValue,
    status: 'pending'
  });
}
```

#### 3. è™šæ‹Ÿä»·å€¼çš„æ‰£é™¤æœºåˆ¶

```javascript
/**
 * ä»ç”¨æˆ·èƒŒåŒ…ä¸­æ‰£é™¤è™šæ‹Ÿä»·å€¼
 * æŒ‰ç…§FIFOåŸåˆ™ï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰æ‰£é™¤
 */
async function deductVirtualValue(userId, requiredValue, transaction) {
  // æŸ¥è¯¢ç”¨æˆ·èƒŒåŒ…ä¸­çš„è™šæ‹Ÿå¥–å“ï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰
  const inventoryItems = await UserInventory.findAll({
    where: {
      user_id: userId,
      item_type: 'virtual',
      virtual_value_points: { [Op.gt]: 0 } // è¿˜æœ‰ä»·å€¼çš„
    },
    order: [['created_at', 'ASC']], // FIFOï¼šå…ˆè·å¾—çš„å…ˆä½¿ç”¨
    lock: transaction.LOCK.UPDATE,
    transaction
  });
  
  let remainingRequired = requiredValue; // éœ€è¦æ‰£é™¤çš„æ€»ä»·å€¼
  
  for (const item of inventoryItems) {
    if (remainingRequired <= 0) break;
    
    const itemValue = item.virtual_value_points;
    
    if (itemValue >= remainingRequired) {
      // å½“å‰ç‰©å“ä»·å€¼è¶³å¤Ÿ
      await item.decrement('virtual_value_points', {
        by: remainingRequired,
        transaction
      });
      remainingRequired = 0;
    } else {
      // å½“å‰ç‰©å“ä»·å€¼ä¸å¤Ÿï¼Œå…¨éƒ¨æ‰£é™¤
      await item.update({ virtual_value_points: 0 }, { transaction });
      remainingRequired -= itemValue;
    }
  }
  
  if (remainingRequired > 0) {
    throw new Error('è™šæ‹Ÿä»·å€¼ä¸è¶³');
  }
}
```

### ğŸ® å®Œæ•´ä¸šåŠ¡æµç¨‹ç¤ºä¾‹

```
ç”¨æˆ·æŠ½å¥–è·å¾—è™šæ‹Ÿå¥–å“
  â†“
ã€èƒŒåŒ…ã€‘100ä¸ªæ°´æ™¶å­˜å…¥ï¼ˆä»·å€¼100è™šæ‹Ÿä»·å€¼ç§¯åˆ†ï¼‰
  â†“
ç”¨æˆ·æµè§ˆå…‘æ¢å¸‚åœº
  â†“
å•†å“Aï¼š[100 è™šæ‹Ÿä»·å€¼] æ˜Ÿå·´å…‹å’–å•¡åˆ¸
å•†å“Bï¼š[500 è™šæ‹Ÿä»·å€¼] å°ç±³è“ç‰™è€³æœº
  â†“
ç”¨æˆ·é€‰æ‹©å…‘æ¢å•†å“A
  â†“
ç³»ç»Ÿæ£€æŸ¥ï¼šèƒŒåŒ…æœ‰100è™šæ‹Ÿä»·å€¼ âœ…
  â†“
æ‰£é™¤100è™šæ‹Ÿä»·å€¼ï¼ˆä»èƒŒåŒ…ç§»é™¤æ°´æ™¶ï¼‰
  â†“
åˆ›å»ºå…‘æ¢è®¢å•ï¼Œå‘æ”¾æ˜Ÿå·´å…‹å’–å•¡åˆ¸
```

### âš–ï¸ è®¾è®¡ç›®çš„

1. **è™šå®è½¬æ¢**ï¼šè™šæ‹Ÿå¥–å“å¯ä»¥è½¬æ¢ä¸ºå®ç‰©å•†å“
2. **äºŒæ¬¡æ¶ˆè´¹**ï¼šå¢åŠ ç”¨æˆ·ç²˜æ€§å’Œå‚ä¸åº¦
3. **çµæ´»æ€§**ï¼šç”¨æˆ·å¯ä»¥é€‰æ‹©å–œæ¬¢çš„å•†å“å…‘æ¢
4. **æˆæœ¬æ§åˆ¶**ï¼šè™šæ‹Ÿä»·å€¼å·²åœ¨æŠ½å¥–æ—¶æ¶ˆè€—é¢„ç®—ï¼Œå…‘æ¢ä¸å†æ¶ˆè€—

---

## 3ï¸âƒ£ points_price - ç§¯åˆ†ä»·æ ¼

### ğŸ“ åŸºæœ¬ä¿¡æ¯

- **å­—æ®µä½ç½®**ï¼š`models/ExchangeItem.js`ï¼ˆå…‘æ¢å¸‚åœºå•†å“è¡¨ï¼‰
- **æ•°æ®ç±»å‹**ï¼š`INTEGER`ï¼ˆæ•´æ•°ï¼‰
- **å…è®¸ä¸ºç©º**ï¼šæ˜¯ï¼ˆä»…å½“ `price_type='points'` æˆ– `'mixed'` æ—¶æœ‰å€¼ï¼‰
- **ç”¨æˆ·å¯è§**ï¼šâœ… æ˜¯ï¼ˆå‰ç«¯æ˜¾ç¤ºï¼‰

### ğŸ¯ å­—æ®µå®šä¹‰

```javascript
/**
 * ç§¯åˆ†ä»·æ ¼
 * ç”¨æˆ·ä½¿ç”¨æ™®é€šç§¯åˆ†å…‘æ¢å•†å“æ‰€éœ€æ”¯ä»˜çš„æ•°é‡
 */
points_price: {
  type: DataTypes.INTEGER,
  allowNull: true,
  comment: 'ç§¯åˆ†ä»·æ ¼'
}
```

### ğŸ’¡ ä¸šåŠ¡å«ä¹‰

**`points_price`** æ˜¯å…‘æ¢å¸‚åœºå•†å“çš„**æ™®é€šç§¯åˆ†æ ‡ä»·**ï¼Œç”¨æˆ·éœ€è¦æ”¯ä»˜ç›¸åº”æ•°é‡çš„**å¯ç”¨ç§¯åˆ†ï¼ˆavailable_pointsï¼‰**æ‰èƒ½å…‘æ¢è¯¥å•†å“ã€‚

#### å®é™…ç¤ºä¾‹

| å•†å“åç§° | points_price | å‰ç«¯æ˜¾ç¤º | ç”¨æˆ·éœ€æ”¯ä»˜ |
|---------|-------------|---------|-----------|
| ä¼˜æƒ åˆ¸10å…ƒ | 500 | `500 ç§¯åˆ†` | 500å¯ç”¨ç§¯åˆ† |
| è¿åŠ¨æ‰‹ç¯ | 2000 | `2000 ç§¯åˆ†` | 2000å¯ç”¨ç§¯åˆ† |
| ç”µå½±ç¥¨ | 800 | `800 ç§¯åˆ†` | 800å¯ç”¨ç§¯åˆ† |

### ğŸŒŸ å¯ç”¨ç§¯åˆ†çš„æ¥æº

ç”¨æˆ·é€šè¿‡**æ¶ˆè´¹è·å¾—ç§¯åˆ†**ï¼Œè¿™äº›ç§¯åˆ†å­˜å‚¨åœ¨ `UserPointsAccount` è¡¨çš„ `available_points` å­—æ®µä¸­ã€‚

#### ç§¯åˆ†è·å–æ–¹å¼

| è·å–æ–¹å¼ | ç§¯åˆ†æ•°é‡ | è¯´æ˜ |
|---------|---------|------|
| æ¶ˆè´¹å……å€¼ | æ¶ˆè´¹é‡‘é¢ Ã— 1 | æ¶ˆè´¹100å…ƒ = 100ç§¯åˆ† |
| æ¯æ—¥ç­¾åˆ° | 10ç§¯åˆ† | æ¯å¤©ç­¾åˆ°å¥–åŠ± |
| æ³¨å†Œå¥–åŠ± | 100ç§¯åˆ† | æ–°ç”¨æˆ·æ³¨å†Œèµ é€ |
| æ¨èå¥½å‹ | 50ç§¯åˆ† | æˆåŠŸæ¨èå¥½å‹æ³¨å†Œ |

### ğŸ” æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

#### 1. å‰ç«¯æ˜¾ç¤ºé€»è¾‘

```javascript
/**
 * å…‘æ¢å¸‚åœºå•†å“åˆ—è¡¨æ˜¾ç¤º
 * æ–‡ä»¶ï¼špublic/admin/exchange-market-items.html
 */
function renderItems(items) {
  items.forEach(item => {
    let priceDisplay = '';
    
    if (item.price_type === 'points') {
      // ä»…ç§¯åˆ†æ”¯ä»˜
      priceDisplay = `<span class="badge bg-primary">${item.points_price} ç§¯åˆ†</span>`;
    } else if (item.price_type === 'mixed') {
      // æ··åˆæ”¯ä»˜ï¼ˆè™šæ‹Ÿä»·å€¼ + ç§¯åˆ†ï¼‰
      priceDisplay = `
        <span class="badge bg-info">${item.virtual_value_price} è™šæ‹Ÿ</span>
        <span class="badge bg-primary">${item.points_price} ç§¯åˆ†</span>
      `;
    }
    
    // æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
    // ç¤ºä¾‹ï¼š[500 ç§¯åˆ†] ä¼˜æƒ åˆ¸10å…ƒ
  });
}
```

#### 2. å…‘æ¢æ—¶çš„æ”¯ä»˜é€»è¾‘

```javascript
/**
 * ç”¨æˆ·å…‘æ¢å•†å“æ—¶çš„ç§¯åˆ†æ‰£é™¤é€»è¾‘
 * æ–‡ä»¶ï¼šservices/ExchangeMarketService.js
 */
async function exchangeItem(user_id, item_id, quantity) {
  // 1. è·å–å•†å“ä¿¡æ¯
  const item = await ExchangeItem.findOne({ where: { item_id } });
  
  // 2. è®¡ç®—æ€»ä»·
  const totalPoints = (item.points_price || 0) * quantity;
  // ç¤ºä¾‹ï¼šå…‘æ¢2ä¸ªå•†å“ï¼Œæ¯ä¸ª500ç§¯åˆ† = 1000ç§¯åˆ†
  
  // 3. æ£€æŸ¥ç”¨æˆ·ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
  const userAccount = await UserPointsAccount.findOne({
    where: { user_id },
    lock: transaction.LOCK.UPDATE,
    transaction
  });
  
  if (userAccount.available_points < totalPoints) {
    throw new Error(`ç§¯åˆ†ä¸è¶³ï¼šéœ€è¦${totalPoints}ç§¯åˆ†ï¼Œå½“å‰ä»…æœ‰${userAccount.available_points}ç§¯åˆ†`);
  }
  
  // 4. æ‰£é™¤ç§¯åˆ†ï¼ˆä»å¯ç”¨ç§¯åˆ†æ‰£é™¤ï¼‰
  await PointsService.consumePoints(user_id, totalPoints, {
    transaction,
    business_type: 'exchange',
    title: `å…‘æ¢å•†å“ï¼š${item.name}`,
    description: `ä½¿ç”¨${totalPoints}ç§¯åˆ†å…‘æ¢${quantity}ä¸ª${item.name}`
  });
  
  // 5. åˆ›å»ºå…‘æ¢è®¢å•
  await ExchangeMarketRecord.create({
    user_id,
    item_id,
    quantity,
    payment_type: 'points',
    points_paid: totalPoints,
    status: 'pending'
  });
}
```

#### 3. ç§¯åˆ†æ‰£é™¤çš„è¯¦ç»†é€»è¾‘

```javascript
/**
 * ç§¯åˆ†æœåŠ¡ï¼šæ‰£é™¤ç”¨æˆ·ç§¯åˆ†
 * æ–‡ä»¶ï¼šservices/PointsService.js
 */
async function consumePoints(userId, points, options) {
  const { transaction, business_type, title, description } = options;
  
  // 1. æ‰£é™¤å¯ç”¨ç§¯åˆ†
  await UserPointsAccount.decrement({
    available_points: points
  }, {
    where: { user_id: userId },
    transaction
  });
  
  // 2. è®°å½•ç§¯åˆ†äº¤æ˜“æµæ°´
  await PointsTransaction.create({
    user_id: userId,
    transaction_type: 'consume',
    amount: -points, // è´Ÿæ•°è¡¨ç¤ºæ¶ˆè´¹
    balance_after: userAccount.available_points - points,
    business_type,
    reference_type: 'exchange',
    title,
    description,
    status: 'completed'
  }, { transaction });
  
  // 3. æ›´æ–°è´¦æˆ·ç»Ÿè®¡
  await UserPointsAccount.increment({
    total_redeem_count: 1 // å…‘æ¢æ¬¡æ•°+1
  }, {
    where: { user_id: userId },
    transaction
  });
}
```

### ğŸ® å®Œæ•´ä¸šåŠ¡æµç¨‹ç¤ºä¾‹

```
ç”¨æˆ·æ¶ˆè´¹1000å…ƒ
  â†“
ç³»ç»Ÿå‘æ”¾1000å¯ç”¨ç§¯åˆ†ï¼ˆavailable_pointsï¼‰
  â†“
ç”¨æˆ·ç”¨ç§¯åˆ†æŠ½å¥–ï¼ˆ100ç§¯åˆ†/æ¬¡ï¼‰
  â†“
å‰©ä½™å¯ç”¨ç§¯åˆ†ï¼š900ç§¯åˆ†
  â†“
ç”¨æˆ·æµè§ˆå…‘æ¢å¸‚åœº
  â†“
å•†å“Aï¼š[500 ç§¯åˆ†] ä¼˜æƒ åˆ¸10å…ƒ
å•†å“Bï¼š[2000 ç§¯åˆ†] è¿åŠ¨æ‰‹ç¯ï¼ˆç§¯åˆ†ä¸è¶³ï¼‰
  â†“
ç”¨æˆ·é€‰æ‹©å…‘æ¢å•†å“A
  â†“
ç³»ç»Ÿæ£€æŸ¥ï¼šå¯ç”¨ç§¯åˆ†900 â‰¥ 500 âœ…
  â†“
æ‰£é™¤500ç§¯åˆ†ï¼ˆavailable_points: 900 â†’ 400ï¼‰
  â†“
åˆ›å»ºå…‘æ¢è®¢å•ï¼Œå‘æ”¾ä¼˜æƒ åˆ¸
```

### âš–ï¸ è®¾è®¡ç›®çš„

1. **ç§¯åˆ†ä»·å€¼ä½“ç°**ï¼šè®©ç”¨æˆ·æ„Ÿå—åˆ°ç§¯åˆ†çš„å®é™…ä»·å€¼
2. **å¢åŠ ç²˜æ€§**ï¼šç§¯åˆ†å¯ä»¥ç›´æ¥å…‘æ¢å®ç‰©ï¼Œå¢å¼ºç”¨æˆ·å‚ä¸åº¦
3. **çµæ´»é€‰æ‹©**ï¼šæä¾›å¤šæ ·åŒ–çš„å…‘æ¢æ–¹å¼
4. **æˆæœ¬æ§åˆ¶**ï¼šç§¯åˆ†å…‘æ¢æ¶ˆè€—çš„æ˜¯ç”¨æˆ·è‡ªå·±çš„ç§¯åˆ†ï¼Œä¸æ¶ˆè€—å¹³å°é¢„ç®—

---

## ğŸ“Š ä¸‰å­—æ®µå¯¹æ¯”æ€»ç»“è¡¨

### åŒè´¦æˆ·æ¨¡å‹å®Œæ•´å¯¹æ¯”

| ç»´åº¦ | available_points | remaining_budget_points | prize_value_points | virtual_value_price | points_price |
|------|-----------------|------------------------|-------------------|--------------------|--------------
| **æ‰€å±æ•°æ®è¡¨** | UserPointsAccount | UserPointsAccount | LotteryPrize | ExchangeItem | ExchangeItem |
| **è´¦æˆ·ç±»å‹** | æ˜¾ç¤ºè´¦æˆ· | é¢„ç®—è´¦æˆ· | å¥–å“æˆæœ¬ | å•†å“ä»·æ ¼ | å•†å“ä»·æ ¼ |
| **ç”¨æˆ·å¯è§æ€§** | âœ… å¯è§ | âŒ ä¸å¯è§ | âŒ ä¸å¯è§ | âœ… å¯è§ | âœ… å¯è§ |
| **ä¸šåŠ¡ç”¨é€”** | ç”¨æˆ·æŠ½å¥–æ¶ˆè´¹ | æ§åˆ¶ä¸­å¥–å¥–å“ | æ§åˆ¶å¹³å°æˆæœ¬ | ç”¨æˆ·æ”¯ä»˜è™šæ‹Ÿä»·å€¼ | ç”¨æˆ·æ”¯ä»˜ç§¯åˆ† |
| **å½±å“èŒƒå›´** | ç”¨æˆ·æŠ½å¥–æ¬¡æ•° | æŠ½å¥–å¥–å“æ± ç­›é€‰ | é¢„ç®—æ¶ˆè€—è®¡ç®— | å…‘æ¢å¸‚åœºä»·æ ¼ | å…‘æ¢å¸‚åœºä»·æ ¼ |
| **æ‰£é™¤å¯¹è±¡** | ç”¨æˆ·å¯ç”¨ç§¯åˆ† | ç”¨æˆ·é¢„ç®—ç§¯åˆ† | ç”¨æˆ·é¢„ç®—ç§¯åˆ† | ç”¨æˆ·èƒŒåŒ…è™šæ‹Ÿä»·å€¼ | ç”¨æˆ·å¯ç”¨ç§¯åˆ† |
| **å…¸å‹æ•°å€¼èŒƒå›´** | 100-10000 | 0-5000 | 0-10000 | 10-1000 | 100-5000 |
| **è·å–æ–¹å¼** | æ¶ˆè´¹å……å€¼ | æ¶ˆè´¹è‡ªåŠ¨åˆ†é… | ç³»ç»Ÿé…ç½® | ç³»ç»Ÿé…ç½® | ç³»ç»Ÿé…ç½® |

### æ ¸å¿ƒå·®å¼‚å¯¹æ¯”

| ç»´åº¦ | prize_value_points | virtual_value_price | points_price |
|------|-------------------|--------------------|--------------
| **æ‰€å±æ•°æ®è¡¨** | LotteryPrizeï¼ˆå¥–å“è¡¨ï¼‰ | ExchangeItemï¼ˆå…‘æ¢å•†å“è¡¨ï¼‰ | ExchangeItemï¼ˆå…‘æ¢å•†å“è¡¨ï¼‰ |
| **å­—æ®µæ€§è´¨** | ç³»ç»Ÿå†…éƒ¨å­—æ®µ | å•†å“ä»·æ ¼å­—æ®µ | å•†å“ä»·æ ¼å­—æ®µ |
| **ç”¨æˆ·å¯è§æ€§** | âŒ ä¸å¯è§ | âœ… å¯è§ | âœ… å¯è§ |
| **ä¸šåŠ¡ç”¨é€”** | æ§åˆ¶å¹³å°å¥–å“æˆæœ¬ | ç”¨æˆ·æ”¯ä»˜è™šæ‹Ÿä»·å€¼ | ç”¨æˆ·æ”¯ä»˜ç§¯åˆ† |
| **å½±å“èŒƒå›´** | æŠ½å¥–å¥–å“æ± ç­›é€‰ | å…‘æ¢å¸‚åœºå•†å“ä»·æ ¼ | å…‘æ¢å¸‚åœºå•†å“ä»·æ ¼ |
| **æ‰£é™¤å¯¹è±¡** | ç”¨æˆ·é¢„ç®—ç§¯åˆ† | ç”¨æˆ·èƒŒåŒ…è™šæ‹Ÿä»·å€¼ | ç”¨æˆ·å¯ç”¨ç§¯åˆ† |
| **å…³è”è´¦æˆ·å­—æ®µ** | remaining_budget_points | èƒŒåŒ…è™šæ‹Ÿå¥–å“æ€»ä»·å€¼ | available_points |
| **å…¸å‹æ•°å€¼èŒƒå›´** | 0-10000 | 10-1000 | 100-5000 |

### ä¸šåŠ¡æµç¨‹å…³è”å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·æ¶ˆè´¹1000å…ƒ                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚      ç³»ç»Ÿè‡ªåŠ¨åˆ†é…ï¼ˆåŒè´¦æˆ·ï¼‰         â”‚
         â”‚  ã€æ˜¾ç¤ºè´¦æˆ· - ç”¨æˆ·å¯è§ã€‘            â”‚
         â”‚    - available_points: 1000        â”‚
         â”‚    - frozen_points: 0              â”‚
         â”‚  ã€é¢„ç®—è´¦æˆ· - ç³»ç»Ÿå†…éƒ¨ã€‘            â”‚
         â”‚    - budget_points: 240            â”‚
         â”‚    - remaining_budget_points: 240  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         ç”¨æˆ·æŠ½å¥–             â”‚
        â”‚  - æ¶ˆè€—ï¼š100å¯ç”¨ç§¯åˆ†/æ¬¡      â”‚
        â”‚  - æ‰£é™¤ï¼šavailable_points   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    ç³»ç»Ÿç­›é€‰å¥–å“æ± ï¼ˆå†…éƒ¨é¢„ç®—æ§åˆ¶ï¼‰        â”‚
        â”‚  æ ¹æ® remaining_budget_points = 240     â”‚
        â”‚  ç­›é€‰ prize_value_points â‰¤ 240çš„å¥–å“    â”‚
        â”‚  âœ… å¯ä¸­ï¼š50å…ƒçº¢åŒ…ï¼ˆprize_value=50ï¼‰    â”‚
        â”‚  âœ… å¯ä¸­ï¼šæ°´æ™¶ï¼ˆprize_value=10ï¼‰        â”‚
        â”‚  âŒ ä¸å¯ä¸­ï¼šiPhoneï¼ˆprize_value=5000ï¼‰  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚      æŠ½ä¸­è™šæ‹Ÿå¥–å“            â”‚
        â”‚  - 100ä¸ªæ°´æ™¶ï¼ˆè™šæ‹Ÿï¼‰         â”‚
        â”‚  - ä»·å€¼ï¼š100è™šæ‹Ÿä»·å€¼ç§¯åˆ†     â”‚
        â”‚  - æ‰£é™¤é¢„ç®—ï¼š100é¢„ç®—ç§¯åˆ†     â”‚
        â”‚  - remaining_budget: 240â†’140 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚      å­˜å…¥ç”¨æˆ·èƒŒåŒ…            â”‚
        â”‚  èƒŒåŒ…æ€»ä»·å€¼ï¼š100è™šæ‹Ÿä»·å€¼     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚     æµè§ˆå…‘æ¢å¸‚åœº             â”‚
        â”‚  å•†å“Aï¼š100 è™šæ‹Ÿä»·å€¼         â”‚
        â”‚  å•†å“Bï¼š500 ç§¯åˆ†             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚      å…‘æ¢å•†å“                â”‚
        â”‚  é€‰æ‹©Aï¼šæ‰£100è™šæ‹Ÿä»·å€¼        â”‚
        â”‚  æˆ–é€‰æ‹©Bï¼šæ‰£500å¯ç”¨ç§¯åˆ†      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŒè´¦æˆ·æµè½¬ç¤ºæ„å›¾

```
ã€ç”¨æˆ·æ¶ˆè´¹ã€‘
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ˜¾ç¤ºè´¦æˆ·      â”‚    é¢„ç®—è´¦æˆ·    â”‚
â”‚  (ç”¨æˆ·å¯è§)    â”‚  (ç³»ç»Ÿå†…éƒ¨)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ +1000ç§¯åˆ†      â”‚  +240é¢„ç®—ç§¯åˆ†  â”‚
â”‚ available_pointsâ”‚remaining_budgetâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“                    â†“
ã€ç”¨æˆ·æŠ½å¥–ã€‘        ã€ç³»ç»Ÿç­›é€‰å¥–å“æ± ã€‘
 -100ç§¯åˆ†          åªèƒ½ä¸­â‰¤240çš„å¥–å“
     â†“                    â†“
ã€ç»§ç»­æŠ½å¥–ã€‘        ã€æ‰£é™¤å¥–å“æˆæœ¬ã€‘
 -100ç§¯åˆ†          -100é¢„ç®—ç§¯åˆ†
     â†“                    â†“
ã€å‰©ä½™800ç§¯åˆ†ã€‘     ã€å‰©ä½™140é¢„ç®—ã€‘
     â†“                    â†“
ã€ç”¨äºå…‘æ¢å•†å“ã€‘    ã€ç»§ç»­æ§åˆ¶å¥–å“æ± ã€‘
```

---

## ğŸ¯ å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯1ï¼šæ–°ç”¨æˆ·é¦–æ¬¡ä½“éªŒ

```
1. ç”¨æˆ·æ³¨å†Œ
   - è·å¾—ï¼š100å¯ç”¨ç§¯åˆ†ï¼ˆåˆå§‹å¥–åŠ±ï¼‰
   - è·å¾—ï¼š0é¢„ç®—ç§¯åˆ†ï¼ˆéœ€æ¶ˆè´¹æ‰æœ‰ï¼‰

2. ç”¨æˆ·é¦–æ¬¡æŠ½å¥–
   - æ¶ˆè€—ï¼š100å¯ç”¨ç§¯åˆ†
   - é—®é¢˜ï¼šé¢„ç®—ç§¯åˆ†ä¸º0ï¼Œåªèƒ½æŠ½ prize_value_points=0 çš„ç©ºå¥–
   - ç»“æœï¼šæŠ½ä¸­"è°¢è°¢å‚ä¸"

3. å¼•å¯¼ç”¨æˆ·æ¶ˆè´¹
   - æç¤ºï¼šæ¶ˆè´¹åå¯è·å¾—æ›´å¤šé¢„ç®—ï¼Œèƒ½æŠ½ä¸­æ›´å¥½çš„å¥–å“
```

**è®¾è®¡æ€è€ƒ**ï¼šæ–°ç”¨æˆ·åˆå§‹é¢„ç®—ä¸º0ï¼Œæ˜¯ä¸ºäº†å¼•å¯¼ç”¨æˆ·è¿›è¡ŒçœŸå®æ¶ˆè´¹ï¼Œé¿å…åˆ·å•ã€‚

---

### åœºæ™¯2ï¼šé«˜ä»·å€¼ç”¨æˆ·ä½“éªŒ

```
1. ç”¨æˆ·æ¶ˆè´¹10000å…ƒ
   - è·å¾—ï¼š10000å¯ç”¨ç§¯åˆ†
   - è·å¾—ï¼š2400é¢„ç®—ç§¯åˆ†ï¼ˆ10000 Ã— 0.24ï¼‰

2. ç”¨æˆ·è¿ç»­æŠ½å¥–
   - å¯æŠ½ä¸­ prize_value_points â‰¤ 2400 çš„æ‰€æœ‰å¥–å“
   - åŒ…æ‹¬é«˜ä»·å€¼å¥–å“ï¼ˆå¦‚iPhoneç­‰ï¼‰

3. é¢„ç®—é€æ­¥æ¶ˆè€—
   - ç¬¬1æ¬¡ä¸­iPhoneï¼ˆæ¶ˆè€—2000é¢„ç®—ï¼‰â†’ å‰©ä½™400é¢„ç®—
   - ç¬¬2æ¬¡ä¸­å°å¥–å“ï¼ˆæ¶ˆè€—50é¢„ç®—ï¼‰â†’ å‰©ä½™350é¢„ç®—
   - ...æŒç»­æŠ½å¥–ç›´åˆ°é¢„ç®—è€—å°½

4. é¢„ç®—è€—å°½å
   - åªèƒ½ä¸­ç©ºå¥–ï¼Œæç¤ºç”¨æˆ·"ç»§ç»­æ¶ˆè´¹è·å¾—æ›´å¤šä¸­å¥–æœºä¼š"
```

**è®¾è®¡æ€è€ƒ**ï¼šé«˜æ¶ˆè´¹ç”¨æˆ·é¢„ç®—å¤šï¼Œèƒ½ä¸­å¥½å¥–å“ï¼Œæå‡ç”¨æˆ·æ»¡æ„åº¦å’Œå¿ è¯šåº¦ã€‚

---

### åœºæ™¯3ï¼šè™šæ‹Ÿå¥–å“å…‘æ¢æµç¨‹

```
1. ç”¨æˆ·æŠ½å¥–ä¸­"100ä¸ªæ°´æ™¶"
   - è™šæ‹Ÿå¥–å“ï¼Œå­˜å…¥èƒŒåŒ…
   - ä»·å€¼ï¼š100è™šæ‹Ÿä»·å€¼ç§¯åˆ†
   - æ¶ˆè€—ï¼š100é¢„ç®—ç§¯åˆ†ï¼ˆå·²æ‰£ï¼‰

2. ç”¨æˆ·æŸ¥çœ‹èƒŒåŒ…
   - æ˜¾ç¤ºï¼š100ä¸ªæ°´æ™¶ï¼ˆä»·å€¼100è™šæ‹Ÿä»·å€¼ï¼‰
   - æç¤ºï¼šå¯åœ¨å…‘æ¢å¸‚åœºå…‘æ¢å•†å“

3. ç”¨æˆ·æµè§ˆå…‘æ¢å¸‚åœº
   - å•†å“Aï¼švirtual_value_price = 100ï¼ˆå¯å…‘æ¢ï¼‰
   - å•†å“Bï¼švirtual_value_price = 500ï¼ˆä»·å€¼ä¸è¶³ï¼‰

4. ç”¨æˆ·å…‘æ¢å•†å“A
   - æ‰£é™¤ï¼š100è™šæ‹Ÿä»·å€¼ï¼ˆä»èƒŒåŒ…ç§»é™¤æ°´æ™¶ï¼‰
   - è·å¾—ï¼šå•†å“Aå®ç‰©
   - ä¸æ¶ˆè€—ï¼šå¯ç”¨ç§¯åˆ†ã€é¢„ç®—ç§¯åˆ†
```

**è®¾è®¡æ€è€ƒ**ï¼šè™šæ‹Ÿå¥–å“å¢åŠ è¶£å‘³æ€§ï¼Œè®©ç”¨æˆ·æœ‰"äºŒæ¬¡é€‰æ‹©"çš„ä¹è¶£ã€‚

---

### åœºæ™¯4ï¼šæ··åˆæ”¯ä»˜åœºæ™¯

```
1. å…‘æ¢å¸‚åœºæœ‰ç‰¹æ®Šå•†å“
   - price_type: 'mixed'
   - virtual_value_price: 50ï¼ˆéœ€è¦è™šæ‹Ÿä»·å€¼ï¼‰
   - points_price: 200ï¼ˆéœ€è¦ç§¯åˆ†ï¼‰

2. ç”¨æˆ·æŸ¥çœ‹å•†å“
   - æ˜¾ç¤ºï¼š[50 è™šæ‹Ÿä»·å€¼ + 200 ç§¯åˆ†] é™é‡ç‰ˆæ‰‹åŠ

3. ç”¨æˆ·å…‘æ¢è¯¥å•†å“
   - ç³»ç»Ÿæ£€æŸ¥ï¼š
     âœ… èƒŒåŒ…è™šæ‹Ÿä»·å€¼ â‰¥ 50
     âœ… å¯ç”¨ç§¯åˆ† â‰¥ 200
   - åŒæ—¶æ‰£é™¤ï¼š50è™šæ‹Ÿä»·å€¼ + 200ç§¯åˆ†
   - å‘æ”¾ï¼šé™é‡ç‰ˆæ‰‹åŠ
```

**è®¾è®¡æ€è€ƒ**ï¼šæ··åˆæ”¯ä»˜å¢åŠ ç©æ³•å¤šæ ·æ€§ï¼Œè®©ç¨€ç¼ºå•†å“æ›´æœ‰ä»·å€¼æ„Ÿã€‚

---

## ğŸ’¡ å¸¸è§é—®é¢˜è§£ç­”ï¼ˆFAQï¼‰

### Q0: ä»€ä¹ˆæ˜¯"åŒè´¦æˆ·æ¨¡å‹"ï¼Ÿä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ï¼Ÿ

**A:** åŒè´¦æˆ·æ¨¡å‹æ˜¯æœ¬ç³»ç»Ÿçš„æ ¸å¿ƒè®¾è®¡ï¼Œåœ¨åŒä¸€ä¸ªç”¨æˆ·è´¦æˆ·è¡¨ä¸­ç»´æŠ¤ä¸¤å¥—ç‹¬ç«‹çš„ç§¯åˆ†ç³»ç»Ÿï¼š

**1. æ˜¾ç¤ºè´¦æˆ·ï¼ˆç”¨æˆ·å¯è§ï¼‰**
- `available_points`ï¼šç”¨æˆ·çœ‹åˆ°çš„æ™®é€šç§¯åˆ†
- ç”¨é€”ï¼šæŠ½å¥–ã€å…‘æ¢å•†å“
- è·å–ï¼šæ¶ˆè´¹1000å…ƒ = 1000ç§¯åˆ†

**2. é¢„ç®—è´¦æˆ·ï¼ˆç³»ç»Ÿå†…éƒ¨ï¼‰**
- `remaining_budget_points`ï¼šç³»ç»Ÿæ§åˆ¶çš„é¢„ç®—
- ç”¨é€”ï¼šé™åˆ¶ç”¨æˆ·èƒ½ä¸­ä»€ä¹ˆç­‰çº§çš„å¥–å“
- è·å–ï¼šæ¶ˆè´¹1000å…ƒ = 240é¢„ç®—ç§¯åˆ†ï¼ˆ1000 Ã— 0.24ï¼‰

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**

| å¦‚æœåªæœ‰å•è´¦æˆ· | åŒè´¦æˆ·æ¨¡å‹çš„ä¼˜åŠ¿ |
|--------------|----------------|
| âŒ ç”¨æˆ·æ‹¿1000ç§¯åˆ†å¯èƒ½ä¸­ä»·å€¼5000å…ƒçš„iPhone | âœ… ç³»ç»Ÿé¢„ç®—240å…ƒï¼Œç”¨æˆ·åªèƒ½ä¸­â‰¤240å…ƒçš„å¥–å“ |
| âŒ å¹³å°æˆæœ¬å¤±æ§ï¼Œå®¹æ˜“äºæŸ | âœ… ç²¾ç¡®æ§åˆ¶æˆæœ¬ï¼Œæ¶ˆè´¹å¤šå°‘ç»™å¤šå°‘é¢„ç®— |
| âŒ ç”¨æˆ·å¯èƒ½è–…ç¾Šæ¯›å¥—ç° | âœ… é¢„ç®—å†…éƒ¨æ§åˆ¶ï¼Œç”¨æˆ·æ— æ³•å¯Ÿè§‰è§„åˆ™ |
| âŒ é«˜é¢‘å°é¢ç”¨æˆ·å’Œä½é¢‘å¤§é¢ç”¨æˆ·å¾…é‡ç›¸åŒ | âœ… å…¬å¹³æ€§å¼ºï¼Œæ¶ˆè´¹å¤šçš„ç”¨æˆ·èƒ½ä¸­æ›´å¥½çš„å¥–å“ |

**å®é™…æ•ˆæœï¼š**
- ç”¨æˆ·è§†è§’ï¼šæˆ‘æœ‰1000ç§¯åˆ†ï¼Œå¯ä»¥æŠ½10æ¬¡å¥–ï¼Œä½“éªŒå¾ˆçˆ½ï¼
- ç³»ç»Ÿè§†è§’ï¼šç”¨æˆ·åªæœ‰240é¢„ç®—ï¼Œåªèƒ½ä¸­æˆ‘ä»¬å‡†å¤‡çš„240å…ƒæˆæœ¬å†…çš„å¥–å“ï¼Œæˆæœ¬å¯æ§ï¼

---

### Q1: ä¸ºä»€ä¹ˆç”¨æˆ·çœ‹ä¸åˆ° `prize_value_points`ï¼Ÿ

**A:** è¿™æ˜¯ç³»ç»Ÿå†…éƒ¨çš„é¢„ç®—æ§åˆ¶å­—æ®µï¼Œç”¨äºå¹³å°æˆæœ¬ç®¡ç†ã€‚å¯¹ç”¨æˆ·é€æ˜è¿™ä¸ªå­—æ®µå¯èƒ½ä¼šå¼•èµ·å›°æƒ‘æˆ–ä¸æ»¡ï¼ˆ"ä¸ºä»€ä¹ˆæˆ‘é¢„ç®—å°‘äº†ä¸èƒ½æŠ½å¥½å¥–å“ï¼Ÿ"ï¼‰ï¼Œå› æ­¤è®¾è®¡ä¸ºç³»ç»Ÿå†…éƒ¨å­—æ®µã€‚

ç”¨æˆ·åªéœ€è¦çŸ¥é“ï¼š
- âœ… æˆ‘æœ‰å¤šå°‘å¯ç”¨ç§¯åˆ†å¯ä»¥æŠ½å¥–
- âœ… æˆ‘ä¸­äº†ä»€ä¹ˆå¥–å“
- âŒ ä¸éœ€è¦çŸ¥é“ç³»ç»Ÿçš„é¢„ç®—æ§åˆ¶é€»è¾‘

---

### Q2: `virtual_value_price` å’Œ `prize_value_points` æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**A:** ä¸¤è€…å®Œå…¨ä¸åŒï¼š

| å¯¹æ¯”ç»´åº¦ | prize_value_points | virtual_value_price |
|---------|-------------------|-------------------|
| ä½¿ç”¨é˜¶æ®µ | æŠ½å¥–é˜¶æ®µ | å…‘æ¢é˜¶æ®µ |
| æ§åˆ¶å¯¹è±¡ | å¹³å°æˆæœ¬ | ç”¨æˆ·æ”¯ä»˜ä»·æ ¼ |
| å½±å“èŒƒå›´ | èƒ½ä¸­ä»€ä¹ˆå¥–å“ | èƒ½æ¢ä»€ä¹ˆå•†å“ |
| æ‰£é™¤å¯¹è±¡ | ç”¨æˆ·é¢„ç®—ç§¯åˆ†ï¼ˆç³»ç»Ÿåˆ†é…ï¼‰ | ç”¨æˆ·èƒŒåŒ…è™šæ‹Ÿä»·å€¼ï¼ˆæŠ½å¥–æ‰€å¾—ï¼‰ |

**ä¸¾ä¾‹è¯´æ˜ï¼š**
- ç”¨æˆ·æŠ½ä¸­"100ä¸ªæ°´æ™¶"ï¼ˆå¥–å“ï¼‰
  - `prize_value_points = 100`ï¼šå‘æ”¾è¿™ä¸ªå¥–å“æ¶ˆè€—100é¢„ç®—ç§¯åˆ†
  - æ°´æ™¶å­˜å…¥èƒŒåŒ…åï¼Œä»·å€¼ = 100è™šæ‹Ÿä»·å€¼ç§¯åˆ†
- ç”¨æˆ·ç”¨æ°´æ™¶å…‘æ¢å•†å“
  - å•†å“ `virtual_value_price = 100`ï¼šéœ€è¦æ”¯ä»˜100è™šæ‹Ÿä»·å€¼
  - ä»èƒŒåŒ…æ‰£é™¤100è™šæ‹Ÿä»·å€¼ï¼ˆç§»é™¤æ°´æ™¶ï¼‰

---

### Q3: ä¸ºä»€ä¹ˆè¦è®¾è®¡ä¸¤ç§æ”¯ä»˜æ–¹å¼ï¼ˆè™šæ‹Ÿä»·å€¼ + ç§¯åˆ†ï¼‰ï¼Ÿ

**A:** æä¾›å¤šæ ·åŒ–çš„ç©æ³•å’Œé€‰æ‹©ï¼š

1. **è™šæ‹Ÿä»·å€¼æ”¯ä»˜**ï¼ˆ`virtual_value_price`ï¼‰
   - é€‚åˆï¼šå¸Œæœ›"å¥–å“æ¢å¥–å“"çš„ç”¨æˆ·
   - ä¼˜åŠ¿ï¼šå·²ç»åœ¨æŠ½å¥–æ—¶æ¶ˆè€—äº†é¢„ç®—ï¼Œå…‘æ¢ä¸å†æ¶ˆè€—ç§¯åˆ†
   - ç”¨æˆ·å¿ƒç†ï¼šæŠŠæŠ½åˆ°çš„è™šæ‹Ÿå¥–å“"å‡çº§"ä¸ºå®ç‰©

2. **ç§¯åˆ†æ”¯ä»˜**ï¼ˆ`points_price`ï¼‰
   - é€‚åˆï¼šä¸æƒ³æŠ½å¥–ï¼Œç›´æ¥ç”¨ç§¯åˆ†æ¢å•†å“çš„ç”¨æˆ·
   - ä¼˜åŠ¿ï¼šç¡®å®šæ€§å¼ºï¼ŒçŸ¥é“è¦å¤šå°‘ç§¯åˆ†å°±èƒ½æ¢
   - ç”¨æˆ·å¿ƒç†ï¼šç§¯åˆ†å°±æ˜¯"é’±"ï¼Œç›´æ¥è´­ä¹°

3. **æ··åˆæ”¯ä»˜**
   - é€‚åˆï¼šé«˜ä»·å€¼ç¨€ç¼ºå•†å“
   - æå‡ç”¨æˆ·å‚ä¸åº¦ï¼šæ—¢è¦æŠ½å¥–è·å¾—è™šæ‹Ÿå¥–å“ï¼Œåˆè¦ç§¯æ”’ç§¯åˆ†
   - å¢åŠ å•†å“ä»·å€¼æ„Ÿ

---

### Q4: é¢„ç®—ç§¯åˆ†è€—å°½åï¼Œç”¨æˆ·è¿˜èƒ½ç»§ç»­æŠ½å¥–å—ï¼Ÿ

**A:** å¯ä»¥ï¼Œä½†åªèƒ½æŠ½ä¸­ `prize_value_points = 0` çš„ç©ºå¥–ã€‚

ç³»ç»Ÿä¼šè‡ªåŠ¨ç­›é€‰å¥–å“æ± ï¼Œç¡®ä¿é¢„ç®—è€—å°½çš„ç”¨æˆ·ï¼š
- âœ… ä»ç„¶å¯ä»¥å‚ä¸æŠ½å¥–ï¼ˆæ¶ˆè€—å¯ç”¨ç§¯åˆ†ï¼‰
- âœ… å¯ä»¥ä¸­"è°¢è°¢å‚ä¸"ç­‰0æˆæœ¬ç©ºå¥–
- âŒ æ— æ³•ä¸­é«˜ä»·å€¼å¥–å“ï¼ˆå¦‚iPhoneã€çº¢åŒ…ç­‰ï¼‰

**å¼•å¯¼æœºåˆ¶ï¼š**
```
é¢„ç®—ä¸è¶³æç¤ºï¼š
"æ‚¨çš„ä¸­å¥–è¿æ°”å·²ç”¨å®Œï¼Œç»§ç»­æ¶ˆè´¹å¯è·å¾—æ›´å¤šä¸­å¥–æœºä¼šï¼
- æ¶ˆè´¹100å…ƒ = 24é¢„ç®—ç§¯åˆ†
- æ¶ˆè´¹1000å…ƒ = 240é¢„ç®—ç§¯åˆ†ï¼Œå¯ä¸­æ›´å¤šå¥½ç¤¼ï¼"
```

---

### Q5: è™šæ‹Ÿä»·å€¼å’Œé¢„ç®—ç§¯åˆ†çš„æ¢ç®—å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ

**A:** å®ƒä»¬æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ç§¯åˆ†ä½“ç³»ï¼Œæ²¡æœ‰ç›´æ¥æ¢ç®—å…³ç³»ã€‚

| ç§¯åˆ†ç±»å‹ | è·å–æ–¹å¼ | ä½¿ç”¨åœºæ™¯ | ç”¨æˆ·å¯è§æ€§ |
|---------|---------|---------|-----------|
| **é¢„ç®—ç§¯åˆ†** | æ¶ˆè´¹è‡ªåŠ¨åˆ†é…ï¼ˆæ¶ˆè´¹é¢Ã—0.24ï¼‰ | æ§åˆ¶èƒ½ä¸­ä»€ä¹ˆå¥–å“ | âŒ ä¸å¯è§ |
| **è™šæ‹Ÿä»·å€¼** | æŠ½å¥–è·å¾—è™šæ‹Ÿå¥–å“ | å…‘æ¢å¸‚åœºæ”¯ä»˜ | âœ… å¯è§ |

**æµè½¬å…³ç³»ï¼š**
```
æ¶ˆè´¹1000å…ƒ
  â†“
ç³»ç»Ÿåˆ†é…240é¢„ç®—ç§¯åˆ†ï¼ˆå†…éƒ¨ï¼‰
  â†“
æŠ½å¥–æ¶ˆè€—100é¢„ç®—ç§¯åˆ†
  â†“
ä¸­"100ä¸ªæ°´æ™¶"ï¼ˆè™šæ‹Ÿå¥–å“ï¼‰
  â†“
è½¬åŒ–ä¸º100è™šæ‹Ÿä»·å€¼ç§¯åˆ†ï¼ˆèƒŒåŒ…ï¼‰
  â†“
å¯ä»¥åœ¨å…‘æ¢å¸‚åœºæ”¯ä»˜
```

è™½ç„¶æ•°å€¼ä¸Šå¯èƒ½ç›¸åŒï¼ˆéƒ½æ˜¯100ï¼‰ï¼Œä½†**å«ä¹‰å®Œå…¨ä¸åŒ**ï¼š
- é¢„ç®—ç§¯åˆ†ï¼šå¹³å°çš„æˆæœ¬æ§åˆ¶
- è™šæ‹Ÿä»·å€¼ï¼šç”¨æˆ·çš„å…‘æ¢è´§å¸

---

### Q6: åŒè´¦æˆ·æ¨¡å‹ä¸‹ï¼Œç”¨æˆ·çš„ç§¯åˆ†æµè½¬æ˜¯æ€æ ·çš„ï¼Ÿ

**A:** å®Œæ•´çš„ç§¯åˆ†æµè½¬è¿‡ç¨‹ï¼š

**é˜¶æ®µ1ï¼šæ¶ˆè´¹å……å€¼**
```javascript
ç”¨æˆ·æ¶ˆè´¹1000å…ƒ
  â†“
ç³»ç»Ÿåˆ†é…ï¼š
  - available_points: +1000 (æ˜¾ç¤ºè´¦æˆ·ï¼Œç”¨æˆ·å¯è§)
  - budget_points: +240 (é¢„ç®—è´¦æˆ·ï¼Œç³»ç»Ÿå†…éƒ¨)
  - remaining_budget_points: +240 (å‰©ä½™é¢„ç®—)
```

**é˜¶æ®µ2ï¼šæŠ½å¥–æ¶ˆè´¹**
```javascript
ç”¨æˆ·ç‚¹å‡»æŠ½å¥–ï¼ˆç¬¬1æ¬¡ï¼‰
  â†“
æ‰£é™¤æ˜¾ç¤ºç§¯åˆ†ï¼š
  - available_points: 1000 â†’ 900 (æ‰£é™¤100ç§¯åˆ†)
  â†“
ç³»ç»Ÿç­›é€‰å¥–å“æ± ï¼ˆç”¨æˆ·çœ‹ä¸åˆ°ï¼‰ï¼š
  - æŸ¥è¯¢ remaining_budget_points = 240
  - ç­›é€‰ prize_value_points â‰¤ 240 çš„å¥–å“
  - iPhone (5000) âŒ è¶…é¢„ç®—ï¼Œä¸åœ¨å¥–æ± 
  - 50å…ƒçº¢åŒ… (50) âœ… åœ¨å¥–æ± å†…
  - æ°´æ™¶ (10) âœ… åœ¨å¥–æ± å†…
  â†“
ç”¨æˆ·ä¸­å¥–ï¼š50å…ƒçº¢åŒ…
  â†“
æ‰£é™¤é¢„ç®—ï¼ˆç”¨æˆ·çœ‹ä¸åˆ°ï¼‰ï¼š
  - remaining_budget_points: 240 â†’ 190 (æ‰£é™¤50)
  - used_budget_points: 0 â†’ 50 (è®°å½•å·²ç”¨)
```

**é˜¶æ®µ3ï¼šåç»­æŠ½å¥–**
```javascript
ç”¨æˆ·ç»§ç»­æŠ½å¥–ï¼ˆç¬¬2æ¬¡ï¼‰
  â†“
æ‰£é™¤æ˜¾ç¤ºç§¯åˆ†ï¼š
  - available_points: 900 â†’ 800
  â†“
ç³»ç»Ÿç­›é€‰å¥–å“æ± ï¼š
  - æŸ¥è¯¢ remaining_budget_points = 190
  - ç­›é€‰ prize_value_points â‰¤ 190 çš„å¥–å“
  - å¥–å“æ± è¿›ä¸€æ­¥ç¼©å°
```

**å…³é”®ç‚¹ï¼š**
- æ˜¾ç¤ºç§¯åˆ†ï¼šç”¨æˆ·æ¯æ¬¡æŠ½å¥–éƒ½æ‰£é™¤ï¼ˆå¦‚100ç§¯åˆ†/æ¬¡ï¼‰
- é¢„ç®—ç§¯åˆ†ï¼šç”¨æˆ·ä¸­å¥–æ‰æ‰£é™¤ï¼ˆæ ¹æ®å¥–å“å®é™…æˆæœ¬ï¼‰
- ä¸¤ä¸ªè´¦æˆ·ç‹¬ç«‹è¿ä½œï¼Œäº’ä¸å½±å“

---

### Q7: å¦‚æœç”¨æˆ·çš„é¢„ç®—ç§¯åˆ†è€—å°½ï¼Œæ˜¾ç¤ºç§¯åˆ†è¿˜æœ‰ä½™é¢æ€ä¹ˆåŠï¼Ÿ

**A:** è¿™æ˜¯æ­£å¸¸æƒ…å†µï¼Œç³»ç»Ÿä¼šæ™ºèƒ½å¤„ç†ï¼š

**åœºæ™¯ï¼š**
```javascript
ç”¨æˆ·è´¦æˆ·çŠ¶æ€ï¼š
  - available_points: 500 (è¿˜æœ‰ç§¯åˆ†)
  - remaining_budget_points: 0 (é¢„ç®—è€—å°½)
```

**å¤„ç†æ–¹å¼ï¼š**
1. ç”¨æˆ·ä»ç„¶å¯ä»¥æŠ½å¥–ï¼ˆæ¶ˆè€—available_pointsï¼‰
2. ç³»ç»Ÿç­›é€‰å¥–å“æ± æ—¶ï¼Œåªä¿ç•™ `prize_value_points = 0` çš„ç©ºå¥–
3. ç”¨æˆ·åªèƒ½ä¸­"è°¢è°¢å‚ä¸"ç±»çš„ç©ºå¥–
4. å‰ç«¯æ˜¾ç¤ºæç¤ºï¼š"æ‚¨çš„å¥½è¿æ°”å·²ç”¨å®Œï¼Œç»§ç»­æ¶ˆè´¹å¯è·å¾—æ›´å¤šä¸­å¥–æœºä¼šï¼"

**å¼•å¯¼ç­–ç•¥ï¼š**
```javascript
// å‰ç«¯æç¤ºæ–‡æ¡ˆ
if (remaining_budget_points === 0) {
  showMessage({
    type: 'warning',
    title: 'ä¸­å¥–è¿æ°”å·²ç”¨å®Œ',
    content: `
      æ‚¨è¿˜æœ‰ ${available_points} ç§¯åˆ†å¯ä»¥ç»§ç»­æŠ½å¥–ï¼Œ
      ä½†å½“å‰åªèƒ½ä¸­å°å¥–ã€‚
      
      ğŸ’° æ¶ˆè´¹100å…ƒ = 24é¢„ç®—ç§¯åˆ†
      ğŸ’° æ¶ˆè´¹1000å…ƒ = 240é¢„ç®—ç§¯åˆ†
      
      ç»§ç»­æ¶ˆè´¹å³å¯è§£é”æ›´å¤šé«˜ä»·å€¼å¥–å“ï¼
    `
  });
}
```

**è®¾è®¡ç›®çš„ï¼š**
- âœ… ä¸æµªè´¹ç”¨æˆ·çš„æ˜¾ç¤ºç§¯åˆ†
- âœ… é¼“åŠ±ç”¨æˆ·ç»§ç»­æ¶ˆè´¹
- âœ… å¹³å°æˆæœ¬å¯æ§ï¼ˆä¸ä¼šå› é¢„ç®—è€—å°½å‘æ”¾é«˜ä»·å€¼å¥–å“ï¼‰

---

### Q8: åŒè´¦æˆ·æ¨¡å‹çš„æ•°æ®å®Œæ•´æ€§å¦‚ä½•ä¿è¯ï¼Ÿ

**A:** ç³»ç»Ÿé‡‡ç”¨å¤šé‡æœºåˆ¶ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼š

**1. æ•°æ®åº“äº‹åŠ¡ä¿è¯**
```javascript
const transaction = await sequelize.transaction();
try {
  // 1. æ‰£é™¤æ˜¾ç¤ºç§¯åˆ†ï¼ˆç”¨æˆ·å¯è§ï¼‰
  await UserPointsAccount.decrement({
    available_points: 100
  }, { where: { user_id }, transaction });
  
  // 2. æ‰£é™¤é¢„ç®—ç§¯åˆ†ï¼ˆç³»ç»Ÿå†…éƒ¨ï¼‰
  await UserPointsAccount.decrement({
    remaining_budget_points: prizeValue
  }, { where: { user_id }, transaction });
  
  // 3. å‘æ”¾å¥–å“
  await UserInventory.create({ ... }, { transaction });
  
  // å…¨éƒ¨æˆåŠŸæ‰æäº¤
  await transaction.commit();
} catch (error) {
  // ä»»ä½•å¤±è´¥éƒ½å›æ»š
  await transaction.rollback();
}
```

**2. å­—æ®µçº¦æŸæ£€æŸ¥**
```sql
-- æ•°æ®åº“å±‚é¢çº¦æŸ
ALTER TABLE user_points_accounts
ADD CONSTRAINT check_available_points 
  CHECK (available_points >= 0);

ALTER TABLE user_points_accounts
ADD CONSTRAINT check_remaining_budget 
  CHECK (remaining_budget_points >= 0);
```

**3. ä¸šåŠ¡å±‚éªŒè¯**
```javascript
// æŠ½å¥–å‰éªŒè¯
async function validateBeforeDraw(userId) {
  const account = await UserPointsAccount.findOne({
    where: { user_id: userId }
  });
  
  // æ£€æŸ¥æ˜¾ç¤ºç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
  if (account.available_points < 100) {
    throw new Error('ç§¯åˆ†ä¸è¶³ï¼Œæ— æ³•æŠ½å¥–');
  }
  
  // æ£€æŸ¥é¢„ç®—ç§¯åˆ†ï¼ˆå†³å®šå¥–å“æ± ï¼‰
  if (account.remaining_budget_points <= 0) {
    console.log('âš ï¸ ç”¨æˆ·é¢„ç®—è€—å°½ï¼Œåªèƒ½æŠ½ç©ºå¥–');
  }
  
  return account;
}
```

**4. å®šæœŸæ•°æ®æ ¡éªŒ**
```javascript
// æ¯æ—¥å‡Œæ™¨æ‰§è¡Œæ•°æ®ä¸€è‡´æ€§æ ¡éªŒ
async function dailyDataCheck() {
  // éªŒè¯ï¼šå·²ç”¨é¢„ç®— + å‰©ä½™é¢„ç®— = æ€»é¢„ç®—
  const inconsistentAccounts = await sequelize.query(`
    SELECT user_id, 
      budget_points,
      used_budget_points,
      remaining_budget_points,
      (used_budget_points + remaining_budget_points) as calculated_total
    FROM user_points_accounts
    WHERE budget_points != (used_budget_points + remaining_budget_points)
  `);
  
  if (inconsistentAccounts.length > 0) {
    // å‘é€å‘Šè­¦å¹¶ä¿®å¤
    await fixInconsistentData(inconsistentAccounts);
  }
}
```

---

## ğŸ”§ æŠ€æœ¯å®ç°è¦ç‚¹

### 1. æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–

```sql
-- LotteryPrize è¡¨ç´¢å¼•
CREATE INDEX idx_prize_value_points ON lottery_prizes(prize_value_points);
CREATE INDEX idx_campaign_status ON lottery_prizes(campaign_id, status);

-- ExchangeItem è¡¨ç´¢å¼•
CREATE INDEX idx_price_type_status ON exchange_items(price_type, status);
CREATE INDEX idx_virtual_price ON exchange_items(virtual_value_price);
CREATE INDEX idx_points_price ON exchange_items(points_price);

-- UserPointsAccount è¡¨ç´¢å¼•
CREATE INDEX idx_remaining_budget ON user_points_accounts(remaining_budget_points);
CREATE INDEX idx_available_points ON user_points_accounts(available_points);
```

### 2. äº‹åŠ¡å®‰å…¨ä¿è¯

```javascript
/**
 * æ‰€æœ‰æ¶‰åŠç§¯åˆ†/é¢„ç®—æ‰£é™¤çš„æ“ä½œå¿…é¡»ä½¿ç”¨äº‹åŠ¡
 */
const transaction = await sequelize.transaction({
  isolationLevel: Transaction.ISOLATION_LEVELS.READ_COMMITTED,
  timeout: 30000 // 30ç§’è¶…æ—¶
});

try {
  // 1. æ£€æŸ¥é¢„ç®—/ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
  // 2. æ‰£é™¤é¢„ç®—/ç§¯åˆ†
  // 3. å‘æ”¾å¥–å“/å•†å“
  // 4. è®°å½•æµæ°´
  
  await transaction.commit();
} catch (error) {
  await transaction.rollback();
  throw error;
}
```

### 3. å¹¶å‘æ§åˆ¶

```javascript
/**
 * ä½¿ç”¨æ‚²è§‚é”é˜²æ­¢è¶…å–å’Œä½™é¢ä¸è¶³
 */
const userAccount = await UserPointsAccount.findOne({
  where: { user_id: userId },
  lock: transaction.LOCK.UPDATE, // è¡Œé”
  transaction
});

const item = await ExchangeItem.findOne({
  where: { item_id: itemId },
  lock: transaction.LOCK.UPDATE, // é˜²æ­¢è¶…å–
  transaction
});
```

### 4. ç¼“å­˜ä¼˜åŒ–

```javascript
/**
 * é«˜é¢‘æŸ¥è¯¢æ•°æ®ç¼“å­˜
 */
const Redis = require('ioredis');
const redis = new Redis();

// ç¼“å­˜ç”¨æˆ·é¢„ç®—ç§¯åˆ†ï¼ˆ5åˆ†é’Ÿï¼‰
async function getCachedBudget(userId) {
  const cacheKey = `user:${userId}:budget`;
  let budget = await redis.get(cacheKey);
  
  if (!budget) {
    const userAccount = await UserPointsAccount.findOne({
      where: { user_id: userId },
      attributes: ['remaining_budget_points']
    });
    budget = userAccount.remaining_budget_points;
    await redis.setex(cacheKey, 300, budget); // ç¼“å­˜5åˆ†é’Ÿ
  }
  
  return parseInt(budget);
}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **æ•°æ®åº“è®¾è®¡æ–‡æ¡£**ï¼š`docs/æ•°æ®åº“è¿ç§»è„šæœ¬.sql`
- **åŒè´¦æˆ·æ¨¡å‹è¯´æ˜**ï¼š`migrations/20251206_dual_account_system.sql`
- **APIæ¥å£æ–‡æ¡£**ï¼š`docs/api-duplicate-check-report.md`
- **æŠ€æœ¯æ–¹æ¡ˆæ–‡æ¡£**ï¼š`ç§¯åˆ†æŠ½å¥–è¥é”€å¹³å°æŠ€æœ¯æ–¹æ¡ˆ.md`

---

## ğŸ“ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®æ”¹å†…å®¹ | ä¿®æ”¹äºº |
|------|------|---------|--------|
| v1.1 | 2025-12-07 | æ–°å¢åŒè´¦æˆ·æ¨¡å‹è¯¦ç»†è¯´æ˜ã€å®Œå–„ä¸šåŠ¡æµç¨‹å›¾ã€å¢åŠ FAQ | AI Assistant |
| v1.0 | 2025-12-07 | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæ•´è¯´æ˜ä¸‰ä¸ªç§¯åˆ†å­—æ®µ | AI Assistant |

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»æŠ€æœ¯å›¢é˜Ÿæˆ–æŸ¥é˜…ç›¸å…³æŠ€æœ¯æ–‡æ¡£ã€‚

---

**æ–‡æ¡£ç»“æŸ**

