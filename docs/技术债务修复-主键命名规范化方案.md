# 🔧 技术债务修复 - 主键命名规范化方案

> **文档版本**: v5.2  
> **创建时间**: 2026年1月31日  
> **最后更新**: 2026年2月1日  
> **审计时间**: 2026年2月1日 04:44:56 (北京时间)  
> **项目状态**: 未上线（无需 Git 分支管理、无需数据库备份）  
> **执行状态**: 🚀 **全量修复（主键+技术外键+API一起改）**  
> **审计数据来源**: 真实数据库连接查询（非备份文件）

---

## 📋 执行任务清单（超详细版）

> 📌 **任务状态图例**：⬜ 待执行 | 🔄 进行中 | ✅ 已完成 | ⏸️ 暂停 | ❌ 已取消

---

### 阶段 0：准备工作

| # | 任务 | 状态 | 预计耗时 | 备注 |
|---|------|------|----------|------|
| 0.1 | 通知团队成员暂停开发 | ⬜ | 5 分钟 | 避免迁移期间代码冲突 |
| 0.2 | 删除临时测试表 | ⬜ | 2 分钟 | `DROP TABLE IF EXISTS deadlock_test_1769781752856` |
| 0.3 | 确认开发环境数据库可用 | ⬜ | 2 分钟 | `npm run db:test-connection` 或手动连接测试 |

---

### 阶段 1：数据库迁移脚本

#### 1.1 创建迁移文件

| # | 任务 | 状态 | 预计耗时 | 命令/备注 |
|---|------|------|----------|----------|
| 1.1.1 | 生成迁移文件骨架 | ⬜ | 2 分钟 | `npx sequelize-cli migration:generate --name rename-all-primary-keys` |
| 1.1.2 | 添加迁移脚本头部注释和配置 | ⬜ | 3 分钟 | 禁用外键检查配置 |

#### 1.2 编写主键重命名逻辑（57张表，分5批）

**第1批：核心业务表（10张，高优先级，被外键引用）**

| # | 表名 | 当前主键 → 目标主键 | 状态 | 备注 |
|---|------|---------------------|------|------|
| 1.2.1 | `lottery_campaigns` | `campaign_id` → `lottery_campaign_id` | ⬜ | 被9个FK引用 |
| 1.2.2 | `lottery_prizes` | `prize_id` → `lottery_prize_id` | ⬜ | 被3个FK引用 |
| 1.2.3 | `lottery_draws` | `draw_id` → `lottery_draw_id` | ⬜ | 被1个FK引用 |
| 1.2.4 | `lottery_presets` | `preset_id` → `lottery_preset_id` | ⬜ | 被2个FK引用 |
| 1.2.5 | `market_listings` | `listing_id` → `market_listing_id` | ⬜ | 被1个FK引用 |
| 1.2.6 | `exchange_items` | `item_id` → `exchange_item_id` | ⬜ | 被1个FK引用 |
| 1.2.7 | `image_resources` | `image_id` → `image_resource_id` | ⬜ | 被2个FK引用 |
| 1.2.8 | `customer_service_sessions` | `session_id` → `customer_service_session_id` | ⬜ | 被1个FK引用 |
| 1.2.9 | `consumption_records` | `record_id` → `consumption_record_id` | ⬜ | 被1个FK引用 |
| 1.2.10 | `system_dictionaries` | `dict_id` → `system_dictionary_id` | ⬜ | 被1个FK引用 |

**第2批：日志/记录表（10张）**

| # | 表名 | 当前主键 → 目标主键 | 状态 |
|---|------|---------------------|------|
| 1.2.11 | `admin_operation_logs` | `log_id` → `admin_operation_log_id` | ⬜ |
| 1.2.12 | `batch_operation_logs` | `batch_log_id` → `batch_operation_log_id` | ⬜ |
| 1.2.13 | `merchant_operation_logs` | `merchant_log_id` → `merchant_operation_log_id` | ⬜ |
| 1.2.14 | `websocket_startup_logs` | `log_id` → `websocket_startup_log_id` | ⬜ |
| 1.2.15 | `exchange_records` | `record_id` → `exchange_record_id` | ⬜ |
| 1.2.16 | `user_role_change_records` | `record_id` → `user_role_change_record_id` | ⬜ |
| 1.2.17 | `user_status_change_records` | `record_id` → `user_status_change_record_id` | ⬜ |
| 1.2.18 | `lottery_clear_setting_records` | `record_id` → `lottery_clear_setting_record_id` | ⬜ |
| 1.2.19 | `content_review_records` | `audit_id` → `content_review_record_id` | ⬜ |
| 1.2.20 | `admin_notifications` | `notification_id` → `admin_notification_id` | ⬜ |

**第3批：配置/规则表（10张）**

| # | 表名 | 当前主键 → 目标主键 | 状态 |
|---|------|---------------------|------|
| 1.2.21 | `lottery_draw_quota_rules` | `rule_id` → `lottery_draw_quota_rule_id` | ⬜ |
| 1.2.22 | `material_conversion_rules` | `rule_id` → `material_conversion_rule_id` | ⬜ |
| 1.2.23 | `lottery_tier_rules` | `tier_rule_id` → `lottery_tier_rule_id` | ⬜ |
| 1.2.24 | `lottery_strategy_config` | `strategy_config_id` → `lottery_strategy_config_id` | ⬜ |
| 1.2.25 | `lottery_tier_matrix_config` | `matrix_config_id` → `lottery_tier_matrix_config_id` | ⬜ |
| 1.2.26 | `lottery_campaign_pricing_config` | `config_id` → `lottery_campaign_pricing_config_id` | ⬜ |
| 1.2.27 | `lottery_management_settings` | `setting_id` → `lottery_management_setting_id` | ⬜ |
| 1.2.28 | `system_settings` | `setting_id` → `system_setting_id` | ⬜ |
| 1.2.29 | `system_configs` | `config_id` → `system_config_id` | ⬜ |
| 1.2.30 | `feature_flags` | `flag_id` → `feature_flag_id` | ⬜ |

**第4批：统计/状态表（7张）**

| # | 表名 | 当前主键 → 目标主键 | 状态 |
|---|------|---------------------|------|
| 1.2.31 | `lottery_hourly_metrics` | `metric_id` → `lottery_hourly_metric_id` | ⬜ |
| 1.2.32 | `lottery_daily_metrics` | `daily_metric_id` → `lottery_daily_metric_id` | ⬜ |
| 1.2.33 | `lottery_user_experience_state` | `state_id` → `lottery_user_experience_state_id` | ⬜ |
| 1.2.34 | `lottery_user_global_state` | `global_state_id` → `lottery_user_global_state_id` | ⬜ |
| 1.2.35 | `lottery_user_daily_draw_quota` | `quota_id` → `lottery_user_daily_draw_quota_id` | ⬜ |
| 1.2.36 | `lottery_campaign_user_quota` | `quota_id` → `lottery_campaign_user_quota_id` | ⬜ |
| 1.2.37 | `lottery_campaign_quota_grants` | `grant_id` → `lottery_campaign_quota_grant_id` | ⬜ |

**第5批：其他业务表（20张）**

| # | 表名 | 当前主键 → 目标主键 | 状态 |
|---|------|---------------------|------|
| 1.2.38 | `account_asset_balances` | `balance_id` → `account_asset_balance_id` | ⬜ |
| 1.2.39 | `asset_transactions` | `transaction_id` → `asset_transaction_id` | ⬜ |
| 1.2.40 | `authentication_sessions` | `user_session_id` → `authentication_session_id` | ⬜ |
| 1.2.41 | `chat_messages` | `message_id` → `chat_message_id` | ⬜ |
| 1.2.42 | `item_instance_events` | `event_id` → `item_instance_event_id` | ⬜ |
| 1.2.43 | `lottery_alerts` | `alert_id` → `lottery_alert_id` | ⬜ |
| 1.2.44 | `lottery_draw_decisions` | `decision_id` → `lottery_draw_decision_id` | ⬜ |
| 1.2.45 | `popup_banners` | `banner_id` → `popup_banner_id` | ⬜ |
| 1.2.46 | `preset_budget_debt` | `debt_id` → `preset_budget_debt_id` | ⬜ |
| 1.2.47 | `preset_inventory_debt` | `debt_id` → `preset_inventory_debt_id` | ⬜ |
| 1.2.48 | `preset_debt_limits` | `limit_id` → `preset_debt_limit_id` | ⬜ |
| 1.2.49 | `redemption_orders` | `order_id` → `redemption_order_id` | ⬜ |
| 1.2.50 | `risk_alerts` | `alert_id` → `risk_alert_id` | ⬜ |
| 1.2.51 | `system_announcements` | `announcement_id` → `system_announcement_id` | ⬜ |
| 1.2.52 | `system_dictionary_history` | `history_id` → `system_dictionary_history_id` | ⬜ |
| 1.2.53 | `trade_orders` | `order_id` → `trade_order_id` | ⬜ |
| 1.2.54 | `user_hierarchy` | `hierarchy_id` → `user_hierarchy_id` | ⬜ |
| 1.2.55 | `user_premium_status` | `id` → `user_premium_status_id` | ⬜ |
| 1.2.56 | `user_risk_profiles` | `risk_profile_id` → `user_risk_profile_id` | ⬜ |
| 1.2.57 | `api_idempotency_requests` | `request_id` → `api_idempotency_request_id` | ⬜ |

#### 1.3 编写技术外键重命名逻辑（21个）

**lottery_campaigns 的外键（9个）**

| # | 引用表 | 当前外键 → 目标外键 | 状态 |
|---|--------|---------------------|------|
| 1.3.1 | `lottery_alerts` | `campaign_id` → `lottery_campaign_id` | ⬜ |
| 1.3.2 | `lottery_campaign_pricing_config` | `campaign_id` → `lottery_campaign_id` | ⬜ |
| 1.3.3 | `lottery_campaign_user_quota` | `campaign_id` → `lottery_campaign_id` | ⬜ |
| 1.3.4 | `lottery_daily_metrics` | `campaign_id` → `lottery_campaign_id` | ⬜ |
| 1.3.5 | `lottery_draws` | `campaign_id` → `lottery_campaign_id` | ⬜ |
| 1.3.6 | `lottery_hourly_metrics` | `campaign_id` → `lottery_campaign_id` | ⬜ |
| 1.3.7 | `lottery_prizes` | `campaign_id` → `lottery_campaign_id` | ⬜ |
| 1.3.8 | `lottery_tier_rules` | `campaign_id` → `lottery_campaign_id` | ⬜ |
| 1.3.9 | `lottery_user_experience_state` | `campaign_id` → `lottery_campaign_id` | ⬜ |

**lottery_prizes 的外键（3个）**

| # | 引用表 | 当前外键 → 目标外键 | 状态 |
|---|--------|---------------------|------|
| 1.3.10 | `lottery_draws` | `prize_id` → `lottery_prize_id` | ⬜ |
| 1.3.11 | `lottery_presets` | `prize_id` → `lottery_prize_id` | ⬜ |
| 1.3.12 | `preset_inventory_debt` | `prize_id` → `lottery_prize_id` | ⬜ |

**其他表的外键（9个）**

| # | 引用表 | 当前外键 → 目标外键 | 被引用表 | 状态 |
|---|--------|---------------------|----------|------|
| 1.3.13 | `lottery_draw_decisions` | `draw_id` → `lottery_draw_id` | `lottery_draws` | ⬜ |
| 1.3.14 | `trade_orders` | `listing_id` → `market_listing_id` | `market_listings` | ⬜ |
| 1.3.15 | `exchange_records` | `item_id` → `exchange_item_id` | `exchange_items` | ⬜ |
| 1.3.16 | `lottery_prizes` | `image_id` → `image_resource_id` | `image_resources` | ⬜ |
| 1.3.17 | `preset_budget_debt` | `preset_id` → `lottery_preset_id` | `lottery_presets` | ⬜ |
| 1.3.18 | `preset_inventory_debt` | `preset_id` → `lottery_preset_id` | `lottery_presets` | ⬜ |
| 1.3.19 | `chat_messages` | `session_id` → `customer_service_session_id` | `customer_service_sessions` | ⬜ |
| 1.3.20 | `merchant_operation_logs` | `related_record_id` → `consumption_record_id` | `consumption_records` | ⬜ |
| 1.3.21 | `system_dictionary_history` | `dict_id` → `system_dictionary_id` | `system_dictionaries` | ⬜ |

#### 1.4 编写回滚逻辑

| # | 任务 | 状态 | 预计耗时 | 备注 |
|---|------|------|----------|------|
| 1.4.1 | 编写 down 方法：恢复外键列名（21个） | ⬜ | 15 分钟 | 逆向 1.3 步骤 |
| 1.4.2 | 编写 down 方法：恢复主键列名（57张） | ⬜ | 15 分钟 | 逆向 1.2 步骤 |

#### 1.5 本地测试迁移脚本

| # | 任务 | 状态 | 预计耗时 | 命令/备注 |
|---|------|------|----------|----------|
| 1.5.1 | 执行 up 迁移 | ⬜ | 10 分钟 | `npm run db:migrate` |
| 1.5.2 | 验证数据库表结构变更 | ⬜ | 10 分钟 | `DESCRIBE table_name` 抽查 5 张表 |
| 1.5.3 | 执行 down 回滚 | ⬜ | 5 分钟 | `npm run db:migrate:undo` |
| 1.5.4 | 验证回滚后恢复原状 | ⬜ | 5 分钟 | 确认主键名恢复 |
| 1.5.5 | 重新执行 up 迁移 | ⬜ | 5 分钟 | 保持迁移后状态 |

---

### 阶段 2：模型文件修改

#### 2.1 核心业务模型（10个）

| # | 模型文件 | 主键修改 | 外键修改 | 状态 |
|---|----------|----------|----------|------|
| 2.1.1 | `models/LotteryCampaign.js` | `campaign_id` → `lottery_campaign_id` | 无 | ⬜ |
| 2.1.2 | `models/LotteryPrize.js` | `prize_id` → `lottery_prize_id` | `campaign_id`, `image_id` | ⬜ |
| 2.1.3 | `models/LotteryDraw.js` | `draw_id` → `lottery_draw_id` | `campaign_id`, `prize_id` | ⬜ |
| 2.1.4 | `models/LotteryPreset.js` | `preset_id` → `lottery_preset_id` | `prize_id` | ⬜ |
| 2.1.5 | `models/MarketListing.js` | `listing_id` → `market_listing_id` | 无 | ⬜ |
| 2.1.6 | `models/ExchangeItem.js` | `item_id` → `exchange_item_id` | 无 | ⬜ |
| 2.1.7 | `models/ImageResource.js` | `image_id` → `image_resource_id` | 无 | ⬜ |
| 2.1.8 | `models/CustomerServiceSession.js` | `session_id` → `customer_service_session_id` | 无 | ⬜ |
| 2.1.9 | `models/ConsumptionRecord.js` | `record_id` → `consumption_record_id` | 无 | ⬜ |
| 2.1.10 | `models/SystemDictionary.js` | `dict_id` → `system_dictionary_id` | 无 | ⬜ |

#### 2.2 日志类模型（10个）

| # | 模型文件 | 主键修改 | 状态 |
|---|----------|----------|------|
| 2.2.1 | `models/AdminOperationLog.js` | `log_id` → `admin_operation_log_id` | ⬜ |
| 2.2.2 | `models/BatchOperationLog.js` | `batch_log_id` → `batch_operation_log_id` | ⬜ |
| 2.2.3 | `models/MerchantOperationLog.js` | `merchant_log_id` → `merchant_operation_log_id` | ⬜ |
| 2.2.4 | `models/WebsocketStartupLog.js` | `log_id` → `websocket_startup_log_id` | ⬜ |
| 2.2.5 | `models/ExchangeRecord.js` | `record_id` → `exchange_record_id` | ⬜ |
| 2.2.6 | `models/UserRoleChangeRecord.js` | `record_id` → `user_role_change_record_id` | ⬜ |
| 2.2.7 | `models/UserStatusChangeRecord.js` | `record_id` → `user_status_change_record_id` | ⬜ |
| 2.2.8 | `models/LotteryClearSettingRecord.js` | `record_id` → `lottery_clear_setting_record_id` | ⬜ |
| 2.2.9 | `models/ContentReviewRecord.js` | `audit_id` → `content_review_record_id` | ⬜ |
| 2.2.10 | `models/AdminNotification.js` | `notification_id` → `admin_notification_id` | ⬜ |

#### 2.3 配置/规则类模型（10个）

| # | 模型文件 | 主键修改 | 状态 |
|---|----------|----------|------|
| 2.3.1 | `models/LotteryDrawQuotaRule.js` | `rule_id` → `lottery_draw_quota_rule_id` | ⬜ |
| 2.3.2 | `models/MaterialConversionRule.js` | `rule_id` → `material_conversion_rule_id` | ⬜ |
| 2.3.3 | `models/LotteryTierRule.js` | `tier_rule_id` → `lottery_tier_rule_id` | ⬜ |
| 2.3.4 | `models/LotteryStrategyConfig.js` | `strategy_config_id` → `lottery_strategy_config_id` | ⬜ |
| 2.3.5 | `models/LotteryTierMatrixConfig.js` | `matrix_config_id` → `lottery_tier_matrix_config_id` | ⬜ |
| 2.3.6 | `models/LotteryCampaignPricingConfig.js` | `config_id` → `lottery_campaign_pricing_config_id` | ⬜ |
| 2.3.7 | `models/LotteryManagementSetting.js` | `setting_id` → `lottery_management_setting_id` | ⬜ |
| 2.3.8 | `models/SystemSetting.js` | `setting_id` → `system_setting_id` | ⬜ |
| 2.3.9 | `models/SystemConfig.js` | `config_id` → `system_config_id` | ⬜ |
| 2.3.10 | `models/FeatureFlag.js` | `flag_id` → `feature_flag_id` | ⬜ |

#### 2.4 统计/状态类模型（7个）

| # | 模型文件 | 主键修改 | 外键修改 | 状态 |
|---|----------|----------|----------|------|
| 2.4.1 | `models/LotteryHourlyMetric.js` | `metric_id` → `lottery_hourly_metric_id` | `campaign_id` | ⬜ |
| 2.4.2 | `models/LotteryDailyMetric.js` | `daily_metric_id` → `lottery_daily_metric_id` | `campaign_id` | ⬜ |
| 2.4.3 | `models/LotteryUserExperienceState.js` | `state_id` → `lottery_user_experience_state_id` | `campaign_id` | ⬜ |
| 2.4.4 | `models/LotteryUserGlobalState.js` | `global_state_id` → `lottery_user_global_state_id` | 无 | ⬜ |
| 2.4.5 | `models/LotteryUserDailyDrawQuota.js` | `quota_id` → `lottery_user_daily_draw_quota_id` | 无 | ⬜ |
| 2.4.6 | `models/LotteryCampaignUserQuota.js` | `quota_id` → `lottery_campaign_user_quota_id` | `campaign_id` | ⬜ |
| 2.4.7 | `models/LotteryCampaignQuotaGrant.js` | `grant_id` → `lottery_campaign_quota_grant_id` | 无 | ⬜ |

#### 2.5 其他业务模型（20个）

| # | 模型文件 | 主键修改 | 外键修改 | 状态 |
|---|----------|----------|----------|------|
| 2.5.1 | `models/AccountAssetBalance.js` | `balance_id` → `account_asset_balance_id` | 无 | ⬜ |
| 2.5.2 | `models/AssetTransaction.js` | `transaction_id` → `asset_transaction_id` | 无 | ⬜ |
| 2.5.3 | `models/AuthenticationSession.js` | `user_session_id` → `authentication_session_id` | 无 | ⬜ |
| 2.5.4 | `models/ChatMessage.js` | `message_id` → `chat_message_id` | `session_id` | ⬜ |
| 2.5.5 | `models/ItemInstanceEvent.js` | `event_id` → `item_instance_event_id` | 无 | ⬜ |
| 2.5.6 | `models/LotteryAlert.js` | `alert_id` → `lottery_alert_id` | `campaign_id` | ⬜ |
| 2.5.7 | `models/LotteryDrawDecision.js` | `decision_id` → `lottery_draw_decision_id` | `draw_id` | ⬜ |
| 2.5.8 | `models/PopupBanner.js` | `banner_id` → `popup_banner_id` | 无 | ⬜ |
| 2.5.9 | `models/PresetBudgetDebt.js` | `debt_id` → `preset_budget_debt_id` | `preset_id` | ⬜ |
| 2.5.10 | `models/PresetInventoryDebt.js` | `debt_id` → `preset_inventory_debt_id` | `preset_id`, `prize_id` | ⬜ |
| 2.5.11 | `models/PresetDebtLimit.js` | `limit_id` → `preset_debt_limit_id` | 无 | ⬜ |
| 2.5.12 | `models/RedemptionOrder.js` | `order_id` → `redemption_order_id` | 无 | ⬜ |
| 2.5.13 | `models/RiskAlert.js` | `alert_id` → `risk_alert_id` | 无 | ⬜ |
| 2.5.14 | `models/SystemAnnouncement.js` | `announcement_id` → `system_announcement_id` | 无 | ⬜ |
| 2.5.15 | `models/SystemDictionaryHistory.js` | `history_id` → `system_dictionary_history_id` | `dict_id` | ⬜ |
| 2.5.16 | `models/TradeOrder.js` | `order_id` → `trade_order_id` | `listing_id` | ⬜ |
| 2.5.17 | `models/UserHierarchy.js` | `hierarchy_id` → `user_hierarchy_id` | 无 | ⬜ |
| 2.5.18 | `models/UserPremiumStatus.js` | `id` → `user_premium_status_id` | 无 | ⬜ |
| 2.5.19 | `models/UserRiskProfile.js` | `risk_profile_id` → `user_risk_profile_id` | 无 | ⬜ |
| 2.5.20 | `models/ApiIdempotencyRequest.js` | `request_id` → `api_idempotency_request_id` | 无 | ⬜ |

#### 2.6 模型关联定义更新

| # | 任务 | 状态 | 预计耗时 | 备注 |
|---|------|------|----------|------|
| 2.6.1 | 更新 `models/index.js` 或 `models/associations.js` 中的关联定义 | ⬜ | 15 分钟 | `foreignKey` 引用 |
| 2.6.2 | 检查所有 `hasMany`/`belongsTo` 的 foreignKey 参数 | ⬜ | 10 分钟 | 确保与新列名一致 |
| 2.6.3 | 检查 `through` 表的外键引用（如有多对多关系） | ⬜ | 5 分钟 | |

#### 2.7 模型验证

| # | 任务 | 状态 | 预计耗时 | 命令/备注 |
|---|------|------|----------|----------|
| 2.7.1 | 验证所有模型文件无语法错误 | ⬜ | 5 分钟 | `node -e "require('./models')"` |
| 2.7.2 | 验证模型与数据库同步 | ⬜ | 5 分钟 | `sequelize.sync({ alter: false })` 无报错 |

---

### 阶段 3：服务层修改

#### 3.1 核心业务主键替换

| # | 搜索关键词 | 替换为 | 涉及目录 | 状态 | 注意事项 |
|---|-----------|--------|----------|------|----------|
| 3.1.1 | `campaign_id` (作为 PK/FK 引用) | `lottery_campaign_id` | `services/` | ⬜ | 排除语义外键场景 |
| 3.1.2 | `prize_id` (作为 PK/FK 引用) | `lottery_prize_id` | `services/` | ⬜ | 排除语义外键场景 |
| 3.1.3 | `draw_id` (作为 PK/FK 引用) | `lottery_draw_id` | `services/` | ⬜ | |
| 3.1.4 | `preset_id` (作为 PK/FK 引用) | `lottery_preset_id` | `services/` | ⬜ | |
| 3.1.5 | `listing_id` (作为 PK/FK 引用) | `market_listing_id` | `services/` | ⬜ | |
| 3.1.6 | `session_id` (客服会话) | `customer_service_session_id` | `services/` | ⬜ | 仅 CustomerService 相关 |
| 3.1.7 | `item_id` (兑换物品) | `exchange_item_id` | `services/` | ⬜ | 仅 Exchange 相关 |
| 3.1.8 | `image_id` (图片资源) | `image_resource_id` | `services/` | ⬜ | 仅 ImageResource 相关 |
| 3.1.9 | `dict_id` (系统字典) | `system_dictionary_id` | `services/` | ⬜ | |

#### 3.2 日志/记录类主键替换

| # | 搜索关键词 | 替换为 | 状态 |
|---|-----------|--------|------|
| 3.2.1 | `log_id` (AdminOperationLog) | `admin_operation_log_id` | ⬜ |
| 3.2.2 | `batch_log_id` | `batch_operation_log_id` | ⬜ |
| 3.2.3 | `merchant_log_id` | `merchant_operation_log_id` | ⬜ |
| 3.2.4 | `log_id` (WebsocketStartupLog) | `websocket_startup_log_id` | ⬜ |
| 3.2.5 | `record_id` (ExchangeRecord) | `exchange_record_id` | ⬜ |
| 3.2.6 | `record_id` (UserRoleChangeRecord) | `user_role_change_record_id` | ⬜ |
| 3.2.7 | `record_id` (UserStatusChangeRecord) | `user_status_change_record_id` | ⬜ |
| 3.2.8 | `record_id` (LotteryClearSettingRecord) | `lottery_clear_setting_record_id` | ⬜ |
| 3.2.9 | `record_id` (ConsumptionRecord) | `consumption_record_id` | ⬜ |
| 3.2.10 | `audit_id` | `content_review_record_id` | ⬜ |

#### 3.3 配置/规则/统计类主键替换

| # | 搜索关键词 | 替换为 | 状态 |
|---|-----------|--------|------|
| 3.3.1 | `rule_id` (LotteryDrawQuotaRule) | `lottery_draw_quota_rule_id` | ⬜ |
| 3.3.2 | `rule_id` (MaterialConversionRule) | `material_conversion_rule_id` | ⬜ |
| 3.3.3 | `tier_rule_id` | `lottery_tier_rule_id` | ⬜ |
| 3.3.4 | `strategy_config_id` | `lottery_strategy_config_id` | ⬜ |
| 3.3.5 | `matrix_config_id` | `lottery_tier_matrix_config_id` | ⬜ |
| 3.3.6 | `config_id` (LotteryCampaignPricingConfig) | `lottery_campaign_pricing_config_id` | ⬜ |
| 3.3.7 | `setting_id` (LotteryManagementSetting) | `lottery_management_setting_id` | ⬜ |
| 3.3.8 | `setting_id` (SystemSetting) | `system_setting_id` | ⬜ |
| 3.3.9 | `config_id` (SystemConfig) | `system_config_id` | ⬜ |
| 3.3.10 | `flag_id` | `feature_flag_id` | ⬜ |
| 3.3.11 | `metric_id` | `lottery_hourly_metric_id` | ⬜ |
| 3.3.12 | `daily_metric_id` | `lottery_daily_metric_id` | ⬜ |
| 3.3.13 | `state_id` | `lottery_user_experience_state_id` | ⬜ |
| 3.3.14 | `global_state_id` | `lottery_user_global_state_id` | ⬜ |
| 3.3.15 | `quota_id` (根据上下文区分) | 对应表的 `xxx_id` | ⬜ |
| 3.3.16 | `grant_id` | `lottery_campaign_quota_grant_id` | ⬜ |

#### 3.4 其他业务主键替换

| # | 搜索关键词 | 替换为 | 状态 |
|---|-----------|--------|------|
| 3.4.1 | `balance_id` | `account_asset_balance_id` | ⬜ |
| 3.4.2 | `transaction_id` (AssetTransaction) | `asset_transaction_id` | ⬜ |
| 3.4.3 | `user_session_id` | `authentication_session_id` | ⬜ |
| 3.4.4 | `message_id` (ChatMessage) | `chat_message_id` | ⬜ |
| 3.4.5 | `event_id` (ItemInstanceEvent) | `item_instance_event_id` | ⬜ |
| 3.4.6 | `alert_id` (LotteryAlert) | `lottery_alert_id` | ⬜ |
| 3.4.7 | `decision_id` | `lottery_draw_decision_id` | ⬜ |
| 3.4.8 | `banner_id` | `popup_banner_id` | ⬜ |
| 3.4.9 | `debt_id` (根据上下文区分) | 对应表的 `xxx_id` | ⬜ |
| 3.4.10 | `limit_id` | `preset_debt_limit_id` | ⬜ |
| 3.4.11 | `order_id` (RedemptionOrder) | `redemption_order_id` | ⬜ |
| 3.4.12 | `order_id` (TradeOrder) | `trade_order_id` | ⬜ |
| 3.4.13 | `alert_id` (RiskAlert) | `risk_alert_id` | ⬜ |
| 3.4.14 | `announcement_id` | `system_announcement_id` | ⬜ |
| 3.4.15 | `history_id` | `system_dictionary_history_id` | ⬜ |
| 3.4.16 | `hierarchy_id` | `user_hierarchy_id` | ⬜ |
| 3.4.17 | `risk_profile_id` | `user_risk_profile_id` | ⬜ |
| 3.4.18 | `notification_id` | `admin_notification_id` | ⬜ |

#### 3.5 查询方法检查

| # | 任务 | 状态 | 预计耗时 | 搜索命令 |
|---|------|------|----------|----------|
| 3.5.1 | 检查所有 `findByPk()` 调用参数 | ⬜ | 10 分钟 | `grep -r "findByPk" services/` |
| 3.5.2 | 检查所有 `where: { xxx_id: }` 条件 | ⬜ | 15 分钟 | `grep -r "where:" services/` |
| 3.5.3 | 检查所有 `include` 中的 `attributes` | ⬜ | 10 分钟 | `grep -r "attributes:" services/` |
| 3.5.4 | 检查所有解构赋值中的 ID 字段 | ⬜ | 10 分钟 | `grep -r "const {" services/` |

---

### 阶段 4：路由层修改（方案A - 完整前缀）

#### 4.1 抽奖相关路由

| # | 路由文件 | 修改内容 | 状态 |
|---|----------|----------|------|
| 4.1.1 | `routes/v4/lottery/campaigns.js` | `:campaign_id` → `:lottery_campaign_id` | ⬜ |
| 4.1.2 | `routes/v4/lottery/prizes.js` | `:prize_id` → `:lottery_prize_id` | ⬜ |
| 4.1.3 | `routes/v4/lottery/draws.js` | `:draw_id` → `:lottery_draw_id` | ⬜ |
| 4.1.4 | `routes/v4/lottery/presets.js` | `:preset_id` → `:lottery_preset_id` | ⬜ |
| 4.1.5 | `routes/v4/lottery/index.js` | 嵌套路由参数更新 | ⬜ |

#### 4.2 控制台/管理相关路由

| # | 路由文件 | 修改内容 | 状态 |
|---|----------|----------|------|
| 4.2.1 | `routes/v4/console/lottery.js` | 所有抽奖相关 ID 参数 | ⬜ |
| 4.2.2 | `routes/v4/console/campaigns.js` | `:campaign_id` → `:lottery_campaign_id` | ⬜ |
| 4.2.3 | `routes/v4/console/prizes.js` | `:prize_id` → `:lottery_prize_id` | ⬜ |
| 4.2.4 | `routes/v4/console/settings.js` | `:setting_id` 相关更新 | ⬜ |
| 4.2.5 | `routes/v4/console/logs.js` | `:log_id` 相关更新 | ⬜ |

#### 4.3 市场/交易相关路由

| # | 路由文件 | 修改内容 | 状态 |
|---|----------|----------|------|
| 4.3.1 | `routes/v4/market/listings.js` | `:listing_id` → `:market_listing_id` | ⬜ |
| 4.3.2 | `routes/v4/market/orders.js` | `:order_id` → `:trade_order_id` | ⬜ |
| 4.3.3 | `routes/v4/exchange/items.js` | `:item_id` → `:exchange_item_id` | ⬜ |
| 4.3.4 | `routes/v4/exchange/records.js` | `:record_id` → `:exchange_record_id` | ⬜ |

#### 4.4 客服/聊天相关路由

| # | 路由文件 | 修改内容 | 状态 |
|---|----------|----------|------|
| 4.4.1 | `routes/v4/chat/sessions.js` | `:session_id` → `:customer_service_session_id` | ⬜ |
| 4.4.2 | `routes/v4/chat/messages.js` | `:message_id` → `:chat_message_id` | ⬜ |

#### 4.5 其他业务路由

| # | 路由文件 | 修改内容 | 状态 |
|---|----------|----------|------|
| 4.5.1 | `routes/v4/assets/*.js` | `balance_id`, `transaction_id` 等 | ⬜ |
| 4.5.2 | `routes/v4/system/*.js` | `config_id`, `setting_id`, `dict_id` 等 | ⬜ |
| 4.5.3 | `routes/v4/admin/*.js` | `log_id`, `notification_id` 等 | ⬜ |
| 4.5.4 | `routes/v4/user/*.js` | 用户相关业务 ID | ⬜ |

#### 4.6 路由文档更新

| # | 任务 | 状态 | 预计耗时 | 备注 |
|---|------|------|----------|------|
| 4.6.1 | 更新 Swagger/OpenAPI 文档（如有） | ⬜ | 15 分钟 | API 参数定义 |
| 4.6.2 | 更新路由文件内注释 | ⬜ | 5 分钟 | JSDoc 等 |

---

### 阶段 5：控制器层修改（方案A）

#### 5.1 req.params 解构修改

| # | 搜索模式 | 替换为 | 涉及目录 | 状态 |
|---|----------|--------|----------|------|
| 5.1.1 | `const { campaign_id }` | `const { lottery_campaign_id }` | `controllers/` | ⬜ |
| 5.1.2 | `const { prize_id }` | `const { lottery_prize_id }` | `controllers/` | ⬜ |
| 5.1.3 | `const { draw_id }` | `const { lottery_draw_id }` | `controllers/` | ⬜ |
| 5.1.4 | `const { preset_id }` | `const { lottery_preset_id }` | `controllers/` | ⬜ |
| 5.1.5 | `const { listing_id }` | `const { market_listing_id }` | `controllers/` | ⬜ |
| 5.1.6 | `const { session_id }` (客服) | `const { customer_service_session_id }` | `controllers/` | ⬜ |
| 5.1.7 | `const { item_id }` (兑换) | `const { exchange_item_id }` | `controllers/` | ⬜ |
| 5.1.8 | `req.params.xxx_id` 直接访问 | 对应新名称 | `controllers/` | ⬜ |

#### 5.2 响应 JSON 字段修改

| # | 任务 | 状态 | 预计耗时 | 备注 |
|---|------|------|----------|------|
| 5.2.1 | 修改返回对象中的 `campaign_id` 字段 | ⬜ | 10 分钟 | → `lottery_campaign_id` |
| 5.2.2 | 修改返回对象中的 `prize_id` 字段 | ⬜ | 10 分钟 | → `lottery_prize_id` |
| 5.2.3 | 修改返回对象中的 `draw_id` 字段 | ⬜ | 5 分钟 | → `lottery_draw_id` |
| 5.2.4 | 修改返回对象中的其他 ID 字段 | ⬜ | 15 分钟 | 批量处理 |

#### 5.3 请求体字段解析

| # | 任务 | 状态 | 预计耗时 | 备注 |
|---|------|------|----------|------|
| 5.3.1 | 修改 `req.body.campaign_id` 解析 | ⬜ | 10 分钟 | → `lottery_campaign_id` |
| 5.3.2 | 修改 `req.body.prize_id` 解析 | ⬜ | 10 分钟 | → `lottery_prize_id` |
| 5.3.3 | 修改其他 `req.body.xxx_id` 解析 | ⬜ | 10 分钟 | 批量处理 |

#### 5.4 参数校验修改

| # | 任务 | 状态 | 预计耗时 | 备注 |
|---|------|------|----------|------|
| 5.4.1 | 更新 express-validator 规则（如有） | ⬜ | 10 分钟 | `param('lottery_campaign_id')` |
| 5.4.2 | 更新 Joi 校验 schema（如有） | ⬜ | 10 分钟 | |
| 5.4.3 | 更新自定义校验中间件 | ⬜ | 5 分钟 | |

---

### 阶段 6：测试验证

#### 6.1 基础验证

| # | 任务 | 状态 | 预计耗时 | 命令/备注 |
|---|------|------|----------|----------|
| 6.1.1 | 执行数据库迁移 | ⬜ | 5 分钟 | `npm run db:migrate` |
| 6.1.2 | 验证迁移无报错 | ⬜ | 2 分钟 | 检查迁移日志 |
| 6.1.3 | 启动后端服务 | ⬜ | 3 分钟 | `npm run dev` |
| 6.1.4 | 检查服务启动日志无报错 | ⬜ | 2 分钟 | 模型加载、路由注册 |
| 6.1.5 | 验证健康检查接口 | ⬜ | 1 分钟 | `curl localhost:3000/health` |

#### 6.2 抽奖模块测试

| # | 测试场景 | 状态 | 预计耗时 | 验证要点 |
|---|----------|------|----------|----------|
| 6.2.1 | 创建抽奖活动 (POST) | ⬜ | 3 分钟 | 返回 `lottery_campaign_id` |
| 6.2.2 | 获取活动列表 (GET) | ⬜ | 2 分钟 | 字段名正确 |
| 6.2.3 | 获取单个活动 (GET /:lottery_campaign_id) | ⬜ | 2 分钟 | 路由参数正确 |
| 6.2.4 | 更新活动 (PUT /:lottery_campaign_id) | ⬜ | 2 分钟 | |
| 6.2.5 | 删除活动 (DELETE /:lottery_campaign_id) | ⬜ | 2 分钟 | |
| 6.2.6 | 创建奖品 | ⬜ | 2 分钟 | `lottery_prize_id`, `lottery_campaign_id` |
| 6.2.7 | 获取奖品列表 | ⬜ | 2 分钟 | |
| 6.2.8 | 执行抽奖 | ⬜ | 3 分钟 | 返回 `lottery_draw_id` |
| 6.2.9 | 获取抽奖记录 | ⬜ | 2 分钟 | |

#### 6.3 市场/交易模块测试

| # | 测试场景 | 状态 | 预计耗时 | 验证要点 |
|---|----------|------|----------|----------|
| 6.3.1 | 创建市场挂单 | ⬜ | 2 分钟 | 返回 `market_listing_id` |
| 6.3.2 | 获取挂单列表 | ⬜ | 2 分钟 | |
| 6.3.3 | 获取单个挂单 (GET /:market_listing_id) | ⬜ | 2 分钟 | |
| 6.3.4 | 创建交易订单 | ⬜ | 2 分钟 | 返回 `trade_order_id` |
| 6.3.5 | 获取订单详情 | ⬜ | 2 分钟 | |

#### 6.4 客服/聊天模块测试

| # | 测试场景 | 状态 | 预计耗时 | 验证要点 |
|---|----------|------|----------|----------|
| 6.4.1 | 创建客服会话 | ⬜ | 2 分钟 | 返回 `customer_service_session_id` |
| 6.4.2 | 发送消息 | ⬜ | 2 分钟 | 返回 `chat_message_id` |
| 6.4.3 | 获取会话消息列表 | ⬜ | 2 分钟 | |

#### 6.5 管理后台测试

| # | 测试场景 | 状态 | 预计耗时 | 验证要点 |
|---|----------|------|----------|----------|
| 6.5.1 | 活动管理页面加载 | ⬜ | 3 分钟 | 列表显示正确 |
| 6.5.2 | 奖品管理页面加载 | ⬜ | 3 分钟 | |
| 6.5.3 | 订单管理页面加载 | ⬜ | 3 分钟 | |
| 6.5.4 | 操作日志查看 | ⬜ | 2 分钟 | |
| 6.5.5 | 系统配置管理 | ⬜ | 2 分钟 | |

#### 6.6 数据库验证

| # | 任务 | 状态 | 预计耗时 | 命令/备注 |
|---|------|------|----------|----------|
| 6.6.1 | 验证外键约束生效 | ⬜ | 5 分钟 | 尝试插入无效外键，应报错 |
| 6.6.2 | 验证索引正常 | ⬜ | 3 分钟 | `SHOW INDEX FROM table_name` |
| 6.6.3 | 验证数据完整性 | ⬜ | 5 分钟 | 关联数据查询正确 |

#### 6.7 自动化测试（如有）

| # | 任务 | 状态 | 预计耗时 | 命令/备注 |
|---|------|------|----------|----------|
| 6.7.1 | 运行单元测试 | ⬜ | 10 分钟 | `npm run test:unit` |
| 6.7.2 | 运行集成测试 | ⬜ | 15 分钟 | `npm run test:integration` |
| 6.7.3 | 修复失败的测试用例 | ⬜ | 视情况 | 更新测试中的字段名 |

---

### 阶段 7：收尾工作

| # | 任务 | 状态 | 预计耗时 | 备注 |
|---|------|------|----------|------|
| 7.1 | 代码自审 | ⬜ | 20 分钟 | 检查遗漏的替换 |
| 7.2 | 全局搜索旧字段名确认无遗漏 | ⬜ | 10 分钟 | `grep -r "campaign_id" --include="*.js"` |
| 7.3 | 部署到测试环境 | ⬜ | 10 分钟 | |
| 7.4 | 测试环境验证 | ⬜ | 20 分钟 | 重复阶段6核心测试 |
| 7.5 | 更新 API 文档 | ⬜ | 20 分钟 | 如有 Swagger/Postman 等 |
| 7.6 | 通知团队修复完成 | ⬜ | 5 分钟 | |
| 7.7 | 更新本文档状态 | ⬜ | 5 分钟 | 标记任务完成 |

---

### 📊 任务统计（超详细版）

| 阶段 | 子任务数 | 预计耗时 | 累计耗时 |
|------|----------|----------|----------|
| 阶段 0：准备工作 | 3 | 9 分钟 | 9 分钟 |
| 阶段 1：数据库迁移 | 86 | 4 小时 | 4.2 小时 |
| 阶段 2：模型修改 | 60 | 4 小时 | 8.2 小时 |
| 阶段 3：服务层修改 | 52 | 3.5 小时 | 11.7 小时 |
| 阶段 4：路由层修改 | 18 | 2.5 小时 | 14.2 小时 |
| 阶段 5：控制器修改 | 15 | 2 小时 | 16.2 小时 |
| 阶段 6：测试验证 | 32 | 2.5 小时 | 18.7 小时 |
| 阶段 7：收尾工作 | 7 | 1.5 小时 | **20.2 小时** |

> 💡 **总计**：约 **20 小时**（2.5 个工作日）
> 
> 📌 **子任务总数**：**273 个**可追踪任务项

---

## 🎯 最终决策（2026-02-01 拍板）

### 数据库层决策

| 决策项 | 最终决定 | 说明 |
|--------|----------|------|
| 修复策略 | ✅ **全量修复** | 主键和技术外键一起改成完整前缀 |
| 主键命名 | ✅ **{表名单数}_id** | 如 `lottery_campaign_id` |
| 技术外键 | ✅ **与主键一致** | FK = PK 对称（如 `campaign_id` → `lottery_campaign_id`） |
| 语义化外键 | ✅ **保持不变** | 如 `buyer_user_id`、`primary_image_id`、`operator_id` 不改（行业通用） |
| 临时测试表 | ✅ **删除** | `deadlock_test_*` |
| SequelizeMeta | ✅ **不修改** | Sequelize 内置迁移跟踪表，保持原样 |

### API层决策（方案A - 全量一致）

| 决策项 | 最终决定 | 说明 |
|--------|----------|------|
| API路由参数 | ✅ **完整前缀** | 如 `/lottery/campaigns/:lottery_campaign_id` |
| API响应JSON字段 | ✅ **完整前缀** | 如 `{ "lottery_campaign_id": 123, ... }` |
| 映射层 | ✅ **不需要** | 数据库→API 直通，无需转换 |

### 方案A优势（全量一致方案）

```
┌─────────────────────────────────────────────────────────────────┐
│                     方案A: 全量一致（已选择）                      │
├─────────────────────────────────────────────────────────────────┤
│  数据库主键:  lottery_campaign_id                                │
│       ↓                                                         │
│  Model层:     lottery_campaign_id                                │
│       ↓                                                         │
│  Service层:   lottery_campaign_id                                │
│       ↓                                                         │
│  API路由:     /lottery/campaigns/:lottery_campaign_id           │
│       ↓                                                         │
│  API响应:     { "lottery_campaign_id": 123, "name": "..." }     │
├─────────────────────────────────────────────────────────────────┤
│  ✅ 优势:                                                        │
│  • 无需映射层，架构最简单                                          │
│  • 调试时字段名全程一致，问题定位快                                  │
│  • 代码搜索 lottery_campaign_id 可以找到全链路                     │
│  • 新人上手成本最低                                               │
│  • 未上线项目，无历史包袱，一步到位                                  │
│                                                                 │
│  📌 适用场景:                                                     │
│  • 项目未上线（无兼容性约束）                                       │
│  • 愿意一次性投入成本                                              │
│  • 追求长期维护成本最低                                            │
└─────────────────────────────────────────────────────────────────┘
```

**核心原则**：
- 主键和技术外键改成完整前缀，保持对称
- 语义化外键（有业务含义的）保持简短，不改
- API路由参数和响应字段与数据库主键保持一致
- 一次性全量修复，不留技术债务，无需映射层

---

## 📊 审计结果概览（2026-02-01 真实数据库查询）

| 指标 | 数值 | 说明 |
|------|------|------|
| 总表数 | **78 张** | 包含业务表和系统表 |
| 需修复主键 | **57 张** | 占比 74.0%（排除 SequelizeMeta） |
| 需修改技术外键 | **21 个** | 引用了需修复表的外键 |
| 语义化外键 | **88 个** | 保持不变（user_id、operator_id 等） |
| 已合规 | **15 张** | 无需修改 |
| 业务码主键 | **4 张** | 使用 `xxx_code` 格式 |
| 待删除 | **1 张** | `deadlock_test_1769781752856` |

---

## 🔴 需修复的表清单（57张）

### 第一批：核心业务表（高优先级，有外键依赖）

| # | 表名 | 当前主键 | 目标主键 | 被引用次数 |
|---|------|----------|----------|------------|
| 1 | `lottery_campaigns` | `campaign_id` | `lottery_campaign_id` | 9 |
| 2 | `lottery_prizes` | `prize_id` | `lottery_prize_id` | 3 |
| 3 | `lottery_draws` | `draw_id` | `lottery_draw_id` | 1 |
| 4 | `lottery_presets` | `preset_id` | `lottery_preset_id` | 2 |
| 5 | `market_listings` | `listing_id` | `market_listing_id` | 1 |
| 6 | `exchange_items` | `item_id` | `exchange_item_id` | 1 |
| 7 | `image_resources` | `image_id` | `image_resource_id` | 2 |
| 8 | `customer_service_sessions` | `session_id` | `customer_service_session_id` | 1 |
| 9 | `consumption_records` | `record_id` | `consumption_record_id` | 1 |
| 10 | `system_dictionaries` | `dict_id` | `system_dictionary_id` | 1 |

### 第二批：日志/记录表

| # | 表名 | 当前主键 | 目标主键 |
|---|------|----------|----------|
| 11 | `admin_operation_logs` | `log_id` | `admin_operation_log_id` |
| 12 | `batch_operation_logs` | `batch_log_id` | `batch_operation_log_id` |
| 13 | `merchant_operation_logs` | `merchant_log_id` | `merchant_operation_log_id` |
| 14 | `websocket_startup_logs` | `log_id` | `websocket_startup_log_id` |
| 15 | `consumption_records` | `record_id` | `consumption_record_id` |
| 16 | `exchange_records` | `record_id` | `exchange_record_id` |
| 17 | `user_role_change_records` | `record_id` | `user_role_change_record_id` |
| 18 | `user_status_change_records` | `record_id` | `user_status_change_record_id` |
| 19 | `lottery_clear_setting_records` | `record_id` | `lottery_clear_setting_record_id` |
| 20 | `content_review_records` | `audit_id` | `content_review_record_id` |

### 第三批：配置/规则表

| # | 表名 | 当前主键 | 目标主键 |
|---|------|----------|----------|
| 21 | `lottery_draw_quota_rules` | `rule_id` | `lottery_draw_quota_rule_id` |
| 22 | `material_conversion_rules` | `rule_id` | `material_conversion_rule_id` |
| 23 | `lottery_tier_rules` | `tier_rule_id` | `lottery_tier_rule_id` |
| 24 | `lottery_strategy_config` | `strategy_config_id` | `lottery_strategy_config_id` |
| 25 | `lottery_tier_matrix_config` | `matrix_config_id` | `lottery_tier_matrix_config_id` |
| 26 | `lottery_campaign_pricing_config` | `config_id` | `lottery_campaign_pricing_config_id` |
| 27 | `lottery_management_settings` | `setting_id` | `lottery_management_setting_id` |
| 28 | `system_settings` | `setting_id` | `system_setting_id` |
| 29 | `system_configs` | `config_id` | `system_config_id` |
| 30 | `feature_flags` | `flag_id` | `feature_flag_id` |

### 第四批：统计/状态表

| # | 表名 | 当前主键 | 目标主键 |
|---|------|----------|----------|
| 31 | `lottery_hourly_metrics` | `metric_id` | `lottery_hourly_metric_id` |
| 32 | `lottery_daily_metrics` | `daily_metric_id` | `lottery_daily_metric_id` |
| 33 | `lottery_user_experience_state` | `state_id` | `lottery_user_experience_state_id` |
| 34 | `lottery_user_global_state` | `global_state_id` | `lottery_user_global_state_id` |
| 35 | `lottery_user_daily_draw_quota` | `quota_id` | `lottery_user_daily_draw_quota_id` |
| 36 | `lottery_campaign_user_quota` | `quota_id` | `lottery_campaign_user_quota_id` |
| 37 | `lottery_campaign_quota_grants` | `grant_id` | `lottery_campaign_quota_grant_id` |

### 第五批：其他业务表

| # | 表名 | 当前主键 | 目标主键 |
|---|------|----------|----------|
| 38 | `account_asset_balances` | `balance_id` | `account_asset_balance_id` |
| 39 | `asset_transactions` | `transaction_id` | `asset_transaction_id` |
| 40 | `authentication_sessions` | `user_session_id` | `authentication_session_id` |
| 41 | `chat_messages` | `message_id` | `chat_message_id` |
| 42 | `item_instance_events` | `event_id` | `item_instance_event_id` |
| 43 | `lottery_alerts` | `alert_id` | `lottery_alert_id` |
| 44 | `lottery_draw_decisions` | `decision_id` | `lottery_draw_decision_id` |
| 45 | `popup_banners` | `banner_id` | `popup_banner_id` |
| 46 | `preset_budget_debt` | `debt_id` | `preset_budget_debt_id` |
| 47 | `preset_inventory_debt` | `debt_id` | `preset_inventory_debt_id` |
| 48 | `preset_debt_limits` | `limit_id` | `preset_debt_limit_id` |
| 49 | `redemption_orders` | `order_id` | `redemption_order_id` |
| 50 | `risk_alerts` | `alert_id` | `risk_alert_id` |
| 51 | `system_announcements` | `announcement_id` | `system_announcement_id` |
| 52 | `system_dictionary_history` | `history_id` | `system_dictionary_history_id` |
| 53 | `trade_orders` | `order_id` | `trade_order_id` |
| 54 | `user_hierarchy` | `hierarchy_id` | `user_hierarchy_id` |
| 55 | `user_premium_status` | `id` | `user_premium_status_id` |
| 56 | `user_risk_profiles` | `risk_profile_id` | `user_risk_profile_id` |
| 57 | `api_idempotency_requests` | `request_id` | `api_idempotency_request_id` |
| 58 | `admin_notifications` | `notification_id` | `admin_notification_id` |

---

## 🔗 需同步修改的技术外键（21个）

主键修改后，引用这些主键的**技术外键**也必须同步修改：

### lottery_campaigns 的外键（9个）

| 引用表 | 外键列 | 改为 |
|--------|--------|------|
| `lottery_alerts` | `campaign_id` | `lottery_campaign_id` |
| `lottery_campaign_pricing_config` | `campaign_id` | `lottery_campaign_id` |
| `lottery_campaign_user_quota` | `campaign_id` | `lottery_campaign_id` |
| `lottery_daily_metrics` | `campaign_id` | `lottery_campaign_id` |
| `lottery_draws` | `campaign_id` | `lottery_campaign_id` |
| `lottery_hourly_metrics` | `campaign_id` | `lottery_campaign_id` |
| `lottery_prizes` | `campaign_id` | `lottery_campaign_id` |
| `lottery_tier_rules` | `campaign_id` | `lottery_campaign_id` |
| `lottery_user_experience_state` | `campaign_id` | `lottery_campaign_id` |

### lottery_prizes 的外键（3个）

| 引用表 | 外键列 | 改为 |
|--------|--------|------|
| `lottery_draws` | `prize_id` | `lottery_prize_id` |
| `lottery_presets` | `prize_id` | `lottery_prize_id` |
| `preset_inventory_debt` | `prize_id` | `lottery_prize_id` |

### 其他表的外键（9个）

| 引用表 | 当前外键列 | 被引用表 | 改为 |
|--------|--------|----------|------|
| `lottery_draw_decisions` | `draw_id` | `lottery_draws` | `lottery_draw_id` |
| `trade_orders` | `listing_id` | `market_listings` | `market_listing_id` |
| `exchange_records` | `item_id` | `exchange_items` | `exchange_item_id` |
| `lottery_prizes` | `image_id` | `image_resources` | `image_resource_id` |
| `preset_budget_debt` | `preset_id` | `lottery_presets` | `lottery_preset_id` |
| `preset_inventory_debt` | `preset_id` | `lottery_presets` | `lottery_preset_id` |
| `chat_messages` | `session_id` | `customer_service_sessions` | `customer_service_session_id` |
| `merchant_operation_logs` | `related_record_id` | `consumption_records` | `consumption_record_id` |
| `system_dictionary_history` | `dict_id` | `system_dictionaries` | `system_dictionary_id` |

---

## ✅ 已合规的表（15张，无需修改）

| 表名 | 当前主键 | 状态 |
|------|----------|------|
| `accounts` | `account_id` | ✅ 合规 |
| `feedbacks` | `feedback_id` | ✅ 合规 |
| `item_instances` | `item_instance_id` | ✅ 合规 |
| `item_templates` | `item_template_id` | ✅ 合规 |
| `material_asset_types` | `material_asset_type_id` | ✅ 合规 |
| `products` | `product_id` | ✅ 合规 |
| `reminder_history` | `reminder_history_id` | ✅ 合规 |
| `reminder_rules` | `reminder_rule_id` | ✅ 合规 |
| `report_templates` | `report_template_id` | ✅ 合规 |
| `roles` | `role_id` | ✅ 合规 |
| `store_staff` | `store_staff_id` | ✅ 合规 |
| `stores` | `store_id` | ✅ 合规 |
| `user_behavior_tracks` | `user_behavior_track_id` | ✅ 合规 |
| `user_roles` | `user_role_id` | ✅ 合规 |
| `users` | `user_id` | ✅ 合规 |

---

## 📦 业务码主键（4张，无需修改）

| 表名 | 主键 | 说明 |
|------|------|------|
| `administrative_regions` | `region_code` | 行政区划代码主键 |
| `asset_group_defs` | `group_code` | 资产组代码主键 |
| `category_defs` | `category_code` | 类目代码主键 |
| `rarity_defs` | `rarity_code` | 稀有度代码主键 |

---

## 🗑️ 待删除的临时表

| 表名 | 处理方式 |
|------|----------|
| `deadlock_test_1769781752856` | 🗑️ 删除（死锁测试临时表，无业务价值） |

---

## 🔒 语义化外键清单（88个，保持不变）

这些外键有明确的业务语义，按行业通用做法保持不变：

| 语义 | 外键名示例 | 数量 |
|------|-----------|------|
| 用户ID | `user_id` | 32 |
| 操作者 | `operator_id` | 7 |
| 创建者 | `created_by` | 6 |
| 更新者 | `updated_by` | 3 |
| 管理员 | `admin_id` | 5 |
| 门店 | `store_id` | 6 |
| 买家/卖家 | `buyer_user_id`, `seller_user_id` | 4 |
| 主图 | `primary_image_id` | 1 |
| 账户 | `account_id` | 2 |
| 物品实例 | `item_instance_id` | 2 |
| 其他语义 | `redeemer_user_id`, `superior_user_id`, `target_user_id` 等 | 20 |

---

## 📋 执行步骤（基于项目技术栈：Sequelize + MySQL）

### 技术栈确认

| 技术 | 版本 | 说明 |
|------|------|------|
| Node.js | 20+ | 运行时环境 |
| Express | 4.18.2 | Web框架 |
| Sequelize | 6.35.2 | ORM框架 |
| mysql2 | 3.6.5 | MySQL驱动 |
| sequelize-cli | 6.6.2 | 迁移工具 |

### 执行流程

| 步骤 | 状态 | 操作 | 工具/命令 |
|------|------|------|----------|
| 1 | ⬜ 待执行 | 删除临时测试表 | `DROP TABLE deadlock_test_*` |
| 2 | ⬜ 待执行 | 创建迁移脚本 | `npx sequelize-cli migration:generate --name rename-primary-keys` |
| 3 | ⬜ 待执行 | 编写迁移逻辑 | 使用 `queryInterface.renameColumn()` |
| 4 | ⬜ 待执行 | 修改模型文件 | 57个模型的 `primaryKey` 字段名 + 21个技术外键 |
| 5 | ⬜ 待执行 | 修改服务层 | 全局搜索替换主键和外键变量引用 |
| 6 | ⬜ 待执行 | 修改路由层（方案A） | 路由参数改为完整前缀 `:lottery_campaign_id` |
| 7 | ⬜ 待执行 | 修改控制器层（方案A） | `req.params` 和响应字段改为完整前缀 |
| 8 | ⬜ 待执行 | 执行迁移 | `npm run db:migrate` |
| 9 | ⬜ 待执行 | 验证测试 | 全量回归测试（含API测试） |

### 迁移执行顺序（重要！）

由于外键依赖，必须按以下顺序执行：

```
阶段1: 删除临时表
  └── DROP TABLE deadlock_test_1769781752856

阶段2: 修改被引用的表（主键）- 按依赖深度排序
  ├── Level 0: lottery_campaigns (被9个外键引用)
  ├── Level 0: lottery_prizes (被3个外键引用)
  ├── Level 0: image_resources (被2个外键引用)
  ├── Level 0: lottery_presets (被2个外键引用)
  ├── Level 1: lottery_draws (被1个外键引用，依赖 Level 0)
  ├── Level 1: market_listings (被1个外键引用)
  ├── Level 1: exchange_items (被1个外键引用)
  ├── Level 1: customer_service_sessions (被1个外键引用)
  ├── Level 1: consumption_records (被1个外键引用)
  ├── Level 1: system_dictionaries (被1个外键引用)
  └── Level 2: 其他无外键依赖的表（可并行）

阶段3: 修改引用表的外键列
  └── 21个技术外键同步重命名
```

### 单次迁移脚本结构（Sequelize）

```javascript
// migrations/20260202000000-rename-all-primary-keys.js
'use strict';

module.exports = {
  async up(queryInterface, Sequelize) {
    const transaction = await queryInterface.sequelize.transaction();
    
    try {
      // 阶段1: 删除临时表
      await queryInterface.dropTable('deadlock_test_1769781752856', { transaction });
      
      // 阶段2: 禁用外键检查（MySQL）
      await queryInterface.sequelize.query('SET FOREIGN_KEY_CHECKS = 0', { transaction });
      
      // 阶段3: 重命名主键（按依赖顺序）
      // ... 57个表的主键重命名
      
      // 阶段4: 重命名外键列
      // ... 21个技术外键重命名
      
      // 阶段5: 恢复外键检查
      await queryInterface.sequelize.query('SET FOREIGN_KEY_CHECKS = 1', { transaction });
      
      await transaction.commit();
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  },

  async down(queryInterface, Sequelize) {
    // 回滚逻辑（逆向操作）
  }
};
```

---

## ⏰ 工作量估算

| 阶段 | 工作量 | 说明 |
|------|--------|------|
| 编写迁移脚本 | 3-4 小时 | 57个主键 + 21个技术外键 |
| 修改模型文件 | 3-4 小时 | 57个模型的 primaryKey 字段 |
| 修改服务层 | 3-4 小时 | 全局搜索替换变量名和查询条件 |
| 修改路由层（方案A） | 2-3 小时 | 路由参数改为完整前缀 |
| 修改控制器层 | 2-3 小时 | req.params 和响应字段改为完整前缀 |
| 测试验证 | 3-4 小时 | 全量回归测试（含API测试） |
| **总计** | **16-22 小时** | **约 2-3 个工作日** |

> 💡 **说明**：方案A虽然API层改动稍多，但节省了映射层的开发和维护成本，长期维护成本更低。

---

## 📝 代码修改范围

### 模型文件修改（57个）

```javascript
// 修改前 (models/LotteryCampaign.js)
LotteryCampaign.init({
  campaign_id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  }
  // ...
})

// 修改后
LotteryCampaign.init({
  lottery_campaign_id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  }
  // ...
})
```

### 外键引用修改

```javascript
// 修改前 (models/LotteryPrize.js)
LotteryPrize.init({
  campaign_id: {
    type: DataTypes.INTEGER,
    references: { model: 'lottery_campaigns', key: 'campaign_id' }
  }
})

// 修改后
LotteryPrize.init({
  lottery_campaign_id: {
    type: DataTypes.INTEGER,
    references: { model: 'lottery_campaigns', key: 'lottery_campaign_id' }
  }
})
```

### 服务层修改

```javascript
// 修改前 (services/LotteryCampaignService.js)
const campaign = await LotteryCampaign.findByPk(campaign_id)

// 修改后
const campaign = await LotteryCampaign.findByPk(lottery_campaign_id)
```

### 路由层修改（方案A - 完整前缀）

```javascript
// 修改前
router.get('/campaigns/:campaign_id', ...)
router.get('/campaigns/:campaign_id/prizes/:prize_id', ...)

// 修改后（方案A - 完整前缀，与数据库主键一致）
router.get('/campaigns/:lottery_campaign_id', ...)
router.get('/campaigns/:lottery_campaign_id/prizes/:lottery_prize_id', ...)

// 控制器中使用
const getLotteryCampaign = async (req, res) => {
  const { lottery_campaign_id } = req.params  // 与数据库主键一致
  const campaign = await LotteryCampaign.findByPk(lottery_campaign_id)
  res.json({
    lottery_campaign_id: campaign.lottery_campaign_id,  // 响应字段与数据库一致
    name: campaign.name,
    // ...
  })
}
```

---

## 📝 命名规范总结

### 数据库层规范

```
✅ 主键格式：{表名单数形式}_id

示例：
- lottery_campaigns → lottery_campaign_id
- lottery_prizes → lottery_prize_id  
- merchant_operation_logs → merchant_operation_log_id

✅ 技术外键格式：与被引用的主键名相同

示例：
- lottery_prizes.lottery_campaign_id → lottery_campaigns.lottery_campaign_id
- lottery_draws.lottery_prize_id → lottery_prizes.lottery_prize_id

✅ 语义化外键格式：保持简短，体现业务含义（行业通用）

示例：
- orders.buyer_user_id → users.user_id（买家语义）
- orders.seller_user_id → users.user_id（卖家语义）
- exchange_items.primary_image_id → image_resources.image_resource_id（主图语义）
- logs.operator_id → users.user_id（操作者语义）

❌ 禁止格式：
- 简单 id（无语义）
- 多表共用 rule_id / record_id / config_id（无法区分来源）
```

### API层规范（方案A - 全量一致）

```
✅ API路由参数：使用完整前缀（与数据库主键一致）

示例：
- GET /lottery/campaigns/:lottery_campaign_id
- GET /lottery/campaigns/:lottery_campaign_id/prizes/:lottery_prize_id
- PUT /lottery/campaigns/:lottery_campaign_id
- DELETE /lottery/prizes/:lottery_prize_id

✅ API响应JSON字段：使用完整前缀（与数据库主键一致）

示例：
{
  "lottery_campaign_id": 123,
  "lottery_campaign_name": "春节活动",
  "prizes": [
    {
      "lottery_prize_id": 456,
      "lottery_campaign_id": 123,  // 外键也保持一致
      "name": "一等奖"
    }
  ]
}

✅ 全链路一致性（无映射层）

数据库 → Model → Service → Controller → API响应
lottery_campaign_id → lottery_campaign_id → lottery_campaign_id → lottery_campaign_id

优势：
- 调试时 grep lottery_campaign_id 可找到全链路
- 无需维护字段映射配置
- 新人上手成本最低
```

---

## 🎯 决策变更历史

| 日期 | 版本 | 变更内容 |
|------|------|----------|
| 2026-01-31 | v1.0 | 初始方案：全量修复58张表（仅主键） |
| 2026-02-01 | v2.0 | 最小化策略：仅修复主键为 `id` 的1张表 |
| 2026-02-01 | v3.0 | 全量修复：主键+外键一起改，保持对称 |
| 2026-02-01 | v4.0 | 真实数据库审计更新：57张表 + 21个技术外键 |
| 2026-02-01 | v5.0 | **API层决策拍板：方案A（全量一致）** |
| 2026-02-01 | v5.2 | 移除 Git 分支管理和数据库备份步骤（项目未上线，无需） |

### v5.2 更新说明（简化流程）

1. **移除 Git 分支管理**：项目未上线，无需创建 `feat/pk-rename` 分支
2. **移除数据库备份步骤**：项目未上线，无生产数据需要备份
3. **工作量调整**：总工时从 17-23 小时调整为 16-22 小时
4. **任务数精简**：阶段 0 从 4 个任务精简为 2 个，阶段 7 从 7 个任务精简为 6 个

### v5.0 更新说明（API层决策拍板）

1. **API路由参数**：采用完整前缀（如 `:lottery_campaign_id`）
2. **API响应JSON字段**：采用完整前缀（如 `lottery_campaign_id`）
3. **映射层决策**：不需要映射层，数据库到API直通
4. **架构简化**：全链路命名一致，调试和维护成本最低

### v4.0 更新说明

1. **数据来源更新**：从真实数据库连接查询，非历史报告或备份文件
2. **表数量校正**：从56张更新为57张（新增 `admin_notifications` 表）
3. **SequelizeMeta 排除**：Sequelize 内置迁移跟踪表，不修改
4. **外键数量校正**：技术外键21个（与之前一致）

---

## ✅ 已拍板确认的事项（全部完成）

**以下事项已在 v5.0 决策中全部确认：**

| 事项 | 决策 | 说明 |
|------|------|------|
| SequelizeMeta 表 | ✅ 不修改 | Sequelize 内置表，保持 `name` 主键 |
| primary_image_id | ✅ 语义外键，不改 | "主图"语义，行业通用做法 |
| related_record_id | ✅ 技术外键，需改 | 改为 `consumption_record_id`，保持 FK=PK 对称 |
| 迁移策略 | ✅ 单次迁移 | 禁用外键检查后一次性执行，回滚方便 |
| API 路由参数 | ✅ **完整前缀** | 如 `:lottery_campaign_id`（方案A） |
| API 响应字段 | ✅ **完整前缀** | 如 `lottery_campaign_id`（方案A） |
| 映射层 | ✅ **不需要** | 数据库→API 直通，架构最简（方案A） |

---

**文档结束**

> 📌 **关键数据总结（v5.0 最终方案）**：
> 
> **数据库层**：
> - 全量修复 **57 张表**的主键  
> - 同步修改 **21 个技术外键**（FK=PK 对称）  
> - 保留 **88 个语义化外键**不变（行业通用做法）
> 
> **API层（方案A - 全量一致）**：
> - API路由参数：**完整前缀**（如 `:lottery_campaign_id`）
> - API响应字段：**完整前缀**（如 `lottery_campaign_id`）
> - 映射层：**不需要**（全链路直通）
> 
> **预计工作量**：**2-3 个工作日**（16-22 小时）
> 
> **方案优势**：
> - ✅ 架构最简单，无映射层维护成本
> - ✅ 全链路命名一致，调试定位快
> - ✅ 一次性投入，长期维护成本最低
