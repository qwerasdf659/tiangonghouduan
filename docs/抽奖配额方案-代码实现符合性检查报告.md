# æŠ½å¥–é…é¢æ–¹æ¡ˆ - ä»£ç å®ç°ç¬¦åˆæ€§æ£€æŸ¥æŠ¥å‘Š

**æ£€æŸ¥æ—¥æœŸ**ï¼š2025-12-23ï¼ˆæœ€åæ›´æ–°ï¼š2025-12-24ï¼‰
**æ£€æŸ¥ä¾æ®**ï¼š`docs/æŠ½å¥–æ¬¡æ•°é…é¢æ§åˆ¶æ–¹æ¡ˆï¼ˆåç«¯+ç®¡ç†åå°ï¼‰-V4æ¶æ„ç‰ˆ.md`
**æ£€æŸ¥èŒƒå›´**ï¼šåç«¯ä»£ç  + æ•°æ®åº“è¡¨ç»“æ„ + ç®¡ç†åå°API
**æ£€æŸ¥äºº**ï¼šClaude Code

---

## ğŸ”´ æ¶æ„å†³ç­–ï¼ˆ2025-12-24ï¼‰

**å†³ç­–**ï¼šä»¥å½“å‰æ¨¡å‹ & çœŸå®è¡¨ç»“æ„ä¸ºå‡†ï¼Œè·¯ç”±å®Œå…¨é€‚é…ï¼Œä¸åšä»»ä½•å…¼å®¹æ˜ å°„ã€‚

**æ ¸å¿ƒåŸåˆ™**ï¼š

- âœ… **æ•°æ®åº“è¡¨ç»“æ„ï¼ˆçœŸç›¸ï¼‰**ï¼š`scope_type` / `scope_id` / `status`
- âœ… **æ¨¡å‹å®šä¹‰ï¼ˆçœŸç›¸ï¼‰**ï¼š`LotteryDrawQuotaRule` ä½¿ç”¨ `scope_type/scope_id/status`
- âŒ **ä¸å…¼å®¹æ—§å­—æ®µ**ï¼šç¦æ­¢åœ¨è·¯ç”±å±‚åš `rule_type â†’ scope_type` ç­‰å­—æ®µæ˜ å°„
- âŒ **ä¸ä¿ç•™æ—§æ¥å£**ï¼šç®¡ç†åå°APIå¿…é¡»ç›´æ¥ä½¿ç”¨æ ‡å‡†å­—æ®µï¼Œä¸åšå‘åå…¼å®¹

**ä¿®å¤æ–¹å‘**ï¼š

1. `routes/v4/admin/lottery-quota.js` å®Œå…¨æ”¹ç”¨ `scope_type/scope_id/status`
2. å‰ç«¯/è°ƒç”¨æ–¹åŒæ­¥ä¿®æ”¹ï¼Œä½¿ç”¨æ ‡å‡†å­—æ®µ
3. APIæ–‡æ¡£æ›´æ–°ä¸ºæ ‡å‡†å­—æ®µè§„èŒƒ

**ç†ç”±**ï¼š

- æ•°æ®åº“å·²è½åœ°ä¸º `scope_type/scope_id` ç»Ÿä¸€äº‹å®æºè®¾è®¡ï¼ˆè¿ç§»å·²æ‰§è¡Œï¼ŒSequelizeMetaå·²è®°å½•ï¼‰
- æœåŠ¡å±‚ï¼ˆLotteryQuotaServiceã€æ¨¡å‹é™æ€æ–¹æ³•ï¼‰å¤©ç„¶ä¾èµ– `scope_*` å­—æ®µ
- å­—æ®µæ˜ å°„ä¼šå¼•å…¥ç»´æŠ¤æˆæœ¬å’Œæ½œåœ¨bugï¼Œè¿èƒŒ"å¹²å‡€ç»Ÿä¸€"åŸåˆ™

---

## ä¸€ã€ç¬¦åˆæ–‡æ¡£è¦æ±‚çš„éƒ¨åˆ†

| æ£€æŸ¥é¡¹                                   | çŠ¶æ€ | è¯´æ˜                                                                       |
| ---------------------------------------- | ---- | -------------------------------------------------------------------------- |
| **æ•°æ®åº“è¡¨å·²åˆ›å»º**                       | âœ…   | `lottery_draw_quota_rules` å’Œ `lottery_user_daily_draw_quota` è¡¨å·²å­˜åœ¨     |
| **LotteryQuotaService å®ç°**             | âœ…   | åŒ…å« `getEffectiveDailyLimit`ã€`ensureDailyQuota`ã€`tryDeductQuota` ç­‰æ–¹æ³• |
| **UnifiedLotteryEngine é›†æˆé…é¢æ‰£å‡**    | âœ…   | åœ¨ `execute_draw()` ä¸­è°ƒç”¨ `LotteryQuotaService.tryDeductQuota()`          |
| **é”™è¯¯å¤„ç†æœºåˆ¶**                         | âœ…   | è¿”å› `statusCode=403` å’Œ `errorCode='DAILY_DRAW_LIMIT_EXCEEDED'`           |
| **BasicGuaranteeStrategy ç§»é™¤COUNTé™åˆ¶** | âœ…   | `validateStrategy()` å’Œ `canExecute()` å·²ç§»é™¤æ¯æ—¥æ¬¡æ•°æ£€æŸ¥                  |
| **ç®¡ç†åå°APIè·¯ç”±æ³¨å†Œ**                  | âœ…   | `/api/v4/admin/lottery-quota` å·²æ³¨å†Œ                                       |
| **å››ç»´åº¦ä¼˜å…ˆçº§è§„åˆ™**                     | âœ…   | user > role > campaign > global                                            |
| **åŸå­æ‰£å‡æœºåˆ¶**                         | âœ…   | æ”¯æŒäº‹åŠ¡å†… FOR UPDATE é”å’Œæ¡ä»¶ UPDATE                                      |

---

## äºŒã€ä¸ç¬¦åˆ/å…¼å®¹æ€§é—®é¢˜

### 2.1 P0 - ä¸¥é‡é—®é¢˜ï¼ˆä¼šå¯¼è‡´åŠŸèƒ½ä¸å¯ç”¨ï¼‰

| #   | é—®é¢˜                      | æ–‡ä»¶ä½ç½®                                   | å…·ä½“æè¿°                                                                                                     |
| --- | ------------------------- | ------------------------------------------ | ------------------------------------------------------------------------------------------------------------ |
| 1   | **APIå­—æ®µåä¸æ¨¡å‹ä¸åŒ¹é…** | `routes/v4/admin/lottery-quota.js:131-200` | APIä½¿ç”¨ `rule_type`ã€`campaign_id`ã€`role_uuid`ã€`target_user_id`ï¼Œä½†æ¨¡å‹ä½¿ç”¨ `scope_type` å’Œç»Ÿä¸€ `scope_id` |
| 2   | **æŸ¥è¯¢æ¡ä»¶å­—æ®µé”™è¯¯**      | `routes/v4/admin/lottery-quota.js:52`      | ä½¿ç”¨ `whereClause.rule_type`ï¼Œå®é™…æ•°æ®åº“å­—æ®µæ˜¯ `scope_type`                                                  |
| 3   | **åˆ›å»ºè§„åˆ™å­—æ®µæ˜ å°„ç¼ºå¤±**  | `routes/v4/admin/lottery-quota.js:189-200` | ç›´æ¥ä¼ å…¥ `rule_type`ã€`campaign_id` ç­‰å­—æ®µï¼Œæ¨¡å‹ä¼šå¿½ç•¥/æŠ¥é”™                                                  |

**å½±å“**ï¼šç®¡ç†åå°åˆ›å»º/æŸ¥è¯¢é…é¢è§„åˆ™æ—¶ä¼šå¤±è´¥ã€‚

### 2.2 P1 - ä¸­ç­‰é—®é¢˜ï¼ˆåŠŸèƒ½ç¼ºå¤±ï¼‰

| #   | é—®é¢˜               | è¯´æ˜                                                                                                                  |
| --- | ------------------ | --------------------------------------------------------------------------------------------------------------------- |
| 5   | **APIè·¯å¾„ä¸ä¸€è‡´**  | æ–‡æ¡£è¦æ±‚ `/api/v4/admin/lottery-quota-rules`ï¼Œå®é™…æ˜¯ `/api/v4/admin/lottery-quota/rules`                              |
| 6   | ~~**è¿ç§»æœªè®°å½•**~~ | âœ… **å·²éªŒè¯ä¸å­˜åœ¨**ï¼š`20251223200000-create-lottery-draw-quota-tables.js` **å·²åœ¨** SequelizeMeta ä¸­ï¼ˆ2025-12-24æ ¸å®ï¼‰ |

### 2.3 P2 - è½»å¾®é—®é¢˜ï¼ˆæ–‡æ¡£æè¿°ä¸å®ç°å·®å¼‚ï¼‰

| #   | é—®é¢˜             | æ–‡æ¡£æè¿°               | å®é™…å®ç°                           |
| --- | ---------------- | ---------------------- | ---------------------------------- |
| 7   | å­—æ®µç±»å‹å·®å¼‚     | `is_active` å¸ƒå°”       | `status` enum('active','inactive') |
| 8   | è§„åˆ™è¡¨è¯´è¡¨ä¸å­˜åœ¨ | æ–‡æ¡£ç¬¬52è¡Œå£°æ˜è¡¨ä¸å­˜åœ¨ | è¡¨å·²ç»å­˜åœ¨                         |
| 9   | å­—æ®µå‘½åå·®å¼‚     | `rule_type`            | `scope_type`                       |

---

## ä¸‰ã€è¯¦ç»†é—®é¢˜åˆ†æ

### 3.1 é—®é¢˜ #1-3ï¼šAPIä¸æ¨¡å‹å­—æ®µä¸åŒ¹é…ï¼ˆP0 ä¸¥é‡ï¼‰

**æ–‡ä»¶**ï¼š`routes/v4/admin/lottery-quota.js`

**å½“å‰ä»£ç ï¼ˆæœ‰é—®é¢˜ï¼‰**ï¼š

```javascript
// ç¬¬131-138è¡Œ - APIæ¥æ”¶çš„å­—æ®µ
const { rule_type, campaign_id, role_uuid, target_user_id, limit_value } = req.body

// ç¬¬189-200è¡Œ - åˆ›å»ºè§„åˆ™æ—¶ä¼ å…¥çš„å­—æ®µ
const rule = await LotteryDrawQuotaRule.create({
  rule_type,        // âŒ æ¨¡å‹æ²¡æœ‰æ­¤å­—æ®µï¼Œåº”ä¸º scope_type
  campaign_id,      // âŒ æ¨¡å‹æ²¡æœ‰æ­¤å­—æ®µï¼Œåº”å­˜å…¥ scope_id
  role_uuid,        // âŒ æ¨¡å‹æ²¡æœ‰æ­¤å­—æ®µï¼Œåº”å­˜å…¥ scope_id
  target_user_id,   // âŒ æ¨¡å‹æ²¡æœ‰æ­¤å­—æ®µï¼Œåº”å­˜å…¥ scope_id
  ...
})
```

**æ¨¡å‹å®é™…å­—æ®µ**ï¼ˆ`models/LotteryDrawQuotaRule.js`ï¼‰ï¼š

- `scope_type`ï¼šenum('global', 'campaign', 'role', 'user')
- `scope_id`ï¼šVARCHAR(100) - ç»Ÿä¸€å­˜å‚¨æ‰€æœ‰ID
- `status`ï¼šenum('active', 'inactive')

**çœŸå®æ•°æ®åº“è¡¨ç»“æ„éªŒè¯ï¼ˆ2025-12-24ï¼‰**ï¼š

```sql
-- å®é™…æŸ¥è¯¢ information_schema.COLUMNS ç»“æœ
COLUMN_NAME: scope_type, COLUMN_TYPE: enum('global','campaign','role','user')
COLUMN_NAME: scope_id,   COLUMN_TYPE: varchar(100)
COLUMN_NAME: status,     COLUMN_TYPE: enum('active','inactive')
-- âŒ ä¸å­˜åœ¨å­—æ®µï¼šrule_type, campaign_id, role_uuid, target_user_id, is_active
```

**ä¿®å¤æ–¹æ¡ˆï¼ˆéµå¾ªæ¶æ„å†³ç­–ï¼šä¸åšå­—æ®µæ˜ å°„ï¼‰**ï¼š

```javascript
// âœ… æ­£ç¡®ï¼šç›´æ¥ä½¿ç”¨æ ‡å‡†å­—æ®µï¼ˆå‰ç«¯/è°ƒç”¨æ–¹åŒæ­¥ä¿®æ”¹å…¥å‚ï¼‰
const { scope_type, scope_id, limit_value, status } = req.body

// å‚æ•°éªŒè¯
if (!['global', 'campaign', 'role', 'user'].includes(scope_type)) {
  return res.apiError('æ— æ•ˆçš„ scope_type', 'INVALID_SCOPE_TYPE', null, 400)
}

const rule = await LotteryDrawQuotaRule.create({
  scope_type,
  scope_id,
  limit_value: parseInt(limit_value),
  status: status || 'active',
  priority: priorityMap[scope_type]
  // ...å…¶ä»–å­—æ®µ
})
```

**å‰ç«¯/è°ƒç”¨æ–¹éœ€åŒæ­¥ä¿®æ”¹**ï¼š

- è¯·æ±‚å‚æ•°ï¼š`scope_type` / `scope_id` / `status` æ›¿ä»£ `rule_type` / `campaign_id` / `is_active`
- å“åº”å­—æ®µï¼šç›´æ¥ä½¿ç”¨ `scope_type` / `scope_id` / `status`ï¼Œä¸å†æœ‰æ´¾ç”Ÿå­—æ®µ

---

### 3.2 é—®é¢˜ #6ï¼šè¿ç§»è®°å½•éªŒè¯ï¼ˆå·²è§£å†³ï¼‰

**è¿ç§»çŠ¶æ€æ£€æŸ¥ï¼ˆ2025-12-24 çœŸå®æ•°æ®åº“éªŒè¯ï¼‰**ï¼š

```
âœ… è¡¨ lottery_draw_quota_rules å·²å­˜åœ¨ï¼ˆ15ä¸ªå­—æ®µï¼Œscope_type/scope_id/statusç»“æ„ï¼‰
âœ… è¡¨ lottery_user_daily_draw_quota å·²å­˜åœ¨ï¼ˆ11ä¸ªå­—æ®µï¼ŒåŒ…å«matched_rule_idå¤–é”®ï¼‰
âœ… è¿ç§» 20251223200000-create-lottery-draw-quota-tables.js **å·²åœ¨** SequelizeMeta ä¸­
âœ… å½“å‰æ•°æ®ï¼šlottery_draw_quota_rules æœ‰ 1 æ¡ï¼ˆglobalé»˜è®¤è§„åˆ™ï¼‰
âœ… å½“å‰æ•°æ®ï¼šlottery_user_daily_draw_quota æœ‰ 0 æ¡
```

**éªŒè¯SQLç»“æœ**ï¼š

```sql
SELECT name FROM SequelizeMeta
WHERE name = '20251223200000-create-lottery-draw-quota-tables.js';
-- ç»“æœï¼š[ { name: '20251223200000-create-lottery-draw-quota-tables.js' } ]
```

**ç»“è®º**ï¼šæ­¤é—®é¢˜**ä¸å­˜åœ¨**ï¼Œè¿ç§»å·²æ­£å¸¸æ‰§è¡Œå¹¶è®°å½•ã€‚

---

## å››ã€æ•°æ®åº“è¡¨ç»“æ„éªŒè¯

### 4.1 lottery_draw_quota_rules è¡¨ç»“æ„

| å­—æ®µ           | ç±»å‹                                    | è¯´æ˜             |
| -------------- | --------------------------------------- | ---------------- |
| rule_id        | BIGINT                                  | ä¸»é”®ï¼Œè‡ªå¢       |
| scope_type     | ENUM('global','campaign','role','user') | ä½œç”¨åŸŸç±»å‹       |
| scope_id       | VARCHAR(100)                            | ä½œç”¨åŸŸID         |
| window_type    | ENUM('daily','campaign_total')          | ç»Ÿè®¡çª—å£         |
| limit_value    | INT UNSIGNED                            | é…é¢ä¸Šé™         |
| timezone       | VARCHAR(10)                             | æ—¶åŒºï¼Œé»˜è®¤+08:00 |
| effective_from | DATETIME                                | ç”Ÿæ•ˆå¼€å§‹æ—¶é—´     |
| effective_to   | DATETIME                                | ç”Ÿæ•ˆç»“æŸæ—¶é—´     |
| priority       | INT                                     | ä¼˜å…ˆçº§           |
| status         | ENUM('active','inactive')               | è§„åˆ™çŠ¶æ€         |
| reason         | TEXT                                    | è§„åˆ™è¯´æ˜         |
| created_by     | INT                                     | åˆ›å»ºäººID         |
| updated_by     | INT                                     | æ›´æ–°äººID         |
| created_at     | DATETIME                                | åˆ›å»ºæ—¶é—´         |
| updated_at     | DATETIME                                | æ›´æ–°æ—¶é—´         |

### 4.2 lottery_user_daily_draw_quota è¡¨ç»“æ„

| å­—æ®µ             | ç±»å‹         | è¯´æ˜         |
| ---------------- | ------------ | ------------ |
| quota_id         | BIGINT       | ä¸»é”®ï¼Œè‡ªå¢   |
| user_id          | INT          | ç”¨æˆ·ID       |
| campaign_id      | INT          | æ´»åŠ¨ID       |
| quota_date       | DATE         | é…é¢æ—¥æœŸ     |
| limit_value      | INT UNSIGNED | å½“æ—¥ä¸Šé™     |
| used_draw_count  | INT UNSIGNED | å·²ä½¿ç”¨æ¬¡æ•°   |
| bonus_draw_count | INT UNSIGNED | è¡¥å¿æ¬¡æ•°     |
| last_draw_at     | DATETIME     | æœ€åæŠ½å¥–æ—¶é—´ |
| matched_rule_id  | BIGINT       | å‘½ä¸­çš„è§„åˆ™ID |
| created_at       | DATETIME     | åˆ›å»ºæ—¶é—´     |
| updated_at       | DATETIME     | æ›´æ–°æ—¶é—´     |

**ç´¢å¼•**ï¼š

- `idx_user_campaign_date_unique` (user_id, campaign_id, quota_date) UNIQUE
- `idx_date_campaign` (quota_date, campaign_id)
- `idx_user_id` (user_id)

---

## äº”ã€ä¿®å¤ä¼˜å…ˆçº§ï¼ˆåŸºäºæ¶æ„å†³ç­–ï¼šä»¥æ¨¡å‹ä¸ºå‡†ï¼‰

| ä¼˜å…ˆçº§          | é—®é¢˜                  | ä¿®å¤æ–¹æ¡ˆ                                                                                             |
| --------------- | --------------------- | ---------------------------------------------------------------------------------------------------- |
| **P0-ç«‹å³ä¿®å¤** | APIå­—æ®µåä¸æ¨¡å‹ä¸åŒ¹é… | **å®Œå…¨æ”¹ç”¨æ ‡å‡†å­—æ®µ**ï¼š`routes/v4/admin/lottery-quota.js` æ”¹ä¸º `scope_type/scope_id/status`ï¼Œä¸åšæ˜ å°„ |
| **P0-ç«‹å³ä¿®å¤** | å‰ç«¯/è°ƒç”¨æ–¹å­—æ®µä¸åŒ¹é… | **åŒæ­¥ä¿®æ”¹å‰ç«¯**ï¼šç®¡ç†åå°/APIè°ƒç”¨æ–¹æ”¹ç”¨ `scope_type/scope_id/status` å…¥å‚å’Œå‡ºå‚                     |
| **P1-å°½å¿«ä¿®å¤** | APIè·¯å¾„ä¸ä¸€è‡´         | ç»Ÿä¸€è·¯å¾„ä¸º `/api/v4/admin/lottery-quota/rules`ï¼ˆå½“å‰å®ç°ï¼‰æˆ–æ›´æ–°æ–‡æ¡£                                 |
| **P2-å·²è§£å†³**   | ~~è¿ç§»æœªè®°å½•~~        | âœ… å·²éªŒè¯å­˜åœ¨ï¼Œæ— éœ€ä¿®å¤                                                                              |
| **P2-ä½ä¼˜å…ˆçº§** | æ›´æ–°APIæ–‡æ¡£           | åŒæ­¥APIæ–‡æ¡£ä¸ºæ ‡å‡†å­—æ®µè§„èŒƒï¼ˆ`scope_type/scope_id/status`ï¼‰                                            |

---

## å…­ã€æ€»ç»“

| åˆ†ç±»                      | æ•°é‡    |
| ------------------------- | ------- |
| ç¬¦åˆæ–‡æ¡£è¦æ±‚              | 8 é¡¹ âœ… |
| P0 ä¸¥é‡é—®é¢˜ï¼ˆéœ€ç«‹å³ä¿®å¤ï¼‰ | 2 é¡¹ ğŸ”´ |
| P1 ä¸­ç­‰é—®é¢˜               | 1 é¡¹ ğŸŸ  |
| P2 å·²è§£å†³/ä½ä¼˜å…ˆçº§        | 3 é¡¹ ğŸŸ¢ |

### æ ¸å¿ƒç»“è®ºï¼ˆ2025-12-24 æ›´æ–°ï¼‰

#### âœ… æ•°æ®åº“ & æ¨¡å‹å±‚ï¼ˆå®Œå…¨ç¬¦åˆæ ‡å‡†ï¼‰

- **è¡¨ç»“æ„æ­£ç¡®**ï¼š`lottery_draw_quota_rules` ä½¿ç”¨ `scope_type/scope_id/status`ï¼ˆå·²éªŒè¯çœŸå®DBï¼‰
- **è¿ç§»å·²æ‰§è¡Œ**ï¼š`20251223200000-create-lottery-draw-quota-tables.js` å·²åœ¨ SequelizeMeta ä¸­
- **æœåŠ¡å±‚æ­£ç¡®**ï¼šLotteryQuotaServiceã€UnifiedLotteryEngine ä½¿ç”¨æ ‡å‡†å­—æ®µ
- **ä¸šåŠ¡é€»è¾‘å®Œæ•´**ï¼šå››ç»´åº¦é…é¢è§„åˆ™ã€åŸå­æ‰£å‡æœºåˆ¶ã€é”™è¯¯å¤„ç†å‡å·²å®ç°

#### ğŸ”´ ç®¡ç†åå°APIå±‚ï¼ˆéœ€ç«‹å³ä¿®å¤ï¼‰

**é—®é¢˜æ ¹å› **ï¼š`routes/v4/admin/lottery-quota.js` ä½¿ç”¨äº†**ä¸å­˜åœ¨çš„å­—æ®µ**ï¼š

- âŒ ä½¿ç”¨ `rule_type`ï¼ˆæ•°æ®åº“å®é™…å­—æ®µï¼š`scope_type`ï¼‰
- âŒ ä½¿ç”¨ `campaign_id/role_uuid/target_user_id`ï¼ˆæ•°æ®åº“å®é™…å­—æ®µï¼šç»Ÿä¸€çš„ `scope_id`ï¼‰
- âŒ ä½¿ç”¨ `is_active`ï¼ˆæ•°æ®åº“å®é™…å­—æ®µï¼š`status`ï¼‰

**æ¶æ„å†³ç­–ï¼ˆ2025-12-24ï¼‰**ï¼š

- âœ… **ä»¥æ•°æ®åº“è¡¨ç»“æ„ä¸ºå‡†**ï¼š`scope_type/scope_id/status` æ˜¯å”¯ä¸€çœŸç›¸
- âŒ **ä¸åšå­—æ®µæ˜ å°„**ï¼šç¦æ­¢åœ¨è·¯ç”±å±‚åšå…¼å®¹è½¬æ¢
- âœ… **å…¨é“¾è·¯ç»Ÿä¸€**ï¼šåç«¯è·¯ç”± + å‰ç«¯è°ƒç”¨æ–¹åŒæ­¥æ”¹ç”¨æ ‡å‡†å­—æ®µ

**ä¿®å¤èŒƒå›´**ï¼š

1. **åç«¯**ï¼š`routes/v4/admin/lottery-quota.js` å®Œå…¨æ”¹ç”¨ `scope_type/scope_id/status`
2. **å‰ç«¯**ï¼šç®¡ç†åå°APIè°ƒç”¨æ”¹ç”¨æ ‡å‡†å­—æ®µï¼ˆè¯·æ±‚å‚æ•° + å“åº”è§£æï¼‰
3. **æ–‡æ¡£**ï¼šAPIæ–‡æ¡£æ›´æ–°ä¸ºæ ‡å‡†å­—æ®µè§„èŒƒ

---

## é™„å½•Aï¼šç›¸å…³æ–‡ä»¶æ¸…å•

| æ–‡ä»¶                                                                 | çŠ¶æ€          | è¯´æ˜                                              |
| -------------------------------------------------------------------- | ------------- | ------------------------------------------------- |
| `models/LotteryDrawQuotaRule.js`                                     | âœ… æ­£ç¡®       | é…é¢è§„åˆ™æ¨¡å‹ï¼ˆä½¿ç”¨ `scope_type/scope_id/status`ï¼‰ |
| `models/LotteryUserDailyDrawQuota.js`                                | âœ… æ­£ç¡®       | ç”¨æˆ·æ¯æ—¥é…é¢æ¨¡å‹                                  |
| `services/lottery/LotteryQuotaService.js`                            | âœ… æ­£ç¡®       | é…é¢æœåŠ¡ï¼ˆä½¿ç”¨æ ‡å‡†å­—æ®µï¼‰                          |
| `services/UnifiedLotteryEngine/UnifiedLotteryEngine.js`              | âœ… æ­£ç¡®       | ç»Ÿä¸€æŠ½å¥–å¼•æ“ï¼ˆé›†æˆé…é¢æ‰£å‡ï¼‰                      |
| `services/UnifiedLotteryEngine/strategies/BasicGuaranteeStrategy.js` | âœ… æ­£ç¡®       | åŸºç¡€ä¿åº•ç­–ç•¥ï¼ˆå·²ç§»é™¤é‡å¤é™åˆ¶ï¼‰                    |
| `routes/v4/admin/lottery-quota.js`                                   | ğŸ”´ **éœ€ä¿®å¤** | ç®¡ç†åå°APIè·¯ç”±ï¼ˆä½¿ç”¨é”™è¯¯å­—æ®µï¼‰                   |
| `migrations/20251223200000-create-lottery-draw-quota-tables.js`      | âœ… å·²æ‰§è¡Œ     | æ•°æ®åº“è¿ç§»æ–‡ä»¶ï¼ˆå·²åœ¨SequelizeMetaä¸­ï¼‰             |

---

## é™„å½•Bï¼šæ ‡å‡†å­—æ®µæ˜ å°„è¡¨ï¼ˆä¾›å‰ç«¯/è°ƒç”¨æ–¹å‚è€ƒï¼‰

### è¯·æ±‚å‚æ•°å­—æ®µæ˜ å°„

| âŒ æ—§å­—æ®µï¼ˆé”™è¯¯ï¼‰ | âœ… æ ‡å‡†å­—æ®µï¼ˆæ­£ç¡®ï¼‰ | ç±»å‹   | è¯´æ˜                                    |
| ----------------- | ------------------- | ------ | --------------------------------------- |
| `rule_type`       | `scope_type`        | enum   | 'global' / 'campaign' / 'role' / 'user' |
| `campaign_id`     | `scope_id`          | string | campaignç±»å‹æ—¶ï¼šString(campaign_id)     |
| `role_uuid`       | `scope_id`          | string | roleç±»å‹æ—¶ï¼šrole_uuid                   |
| `target_user_id`  | `scope_id`          | string | userç±»å‹æ—¶ï¼šString(user_id)             |
| `is_active`       | `status`            | enum   | true â†’ 'active', false â†’ 'inactive'     |

### å“åº”å­—æ®µæ˜ å°„

| âŒ æ—§å­—æ®µï¼ˆé”™è¯¯ï¼‰ | âœ… æ ‡å‡†å­—æ®µï¼ˆæ­£ç¡®ï¼‰ | æ´¾ç”Ÿé€»è¾‘                                                                    |
| ----------------- | ------------------- | --------------------------------------------------------------------------- |
| `rule_type`       | `scope_type`        | ç›´æ¥ä½¿ç”¨ `scope_type`                                                       |
| `is_active`       | `status`            | `status === 'active'`                                                       |
| `campaign_id`     | -                   | ä» `scope_id` æ´¾ç”Ÿï¼š`scope_type === 'campaign' ? parseInt(scope_id) : null` |
| `role_uuid`       | -                   | ä» `scope_id` æ´¾ç”Ÿï¼š`scope_type === 'role' ? scope_id : null`               |
| `target_user_id`  | -                   | ä» `scope_id` æ´¾ç”Ÿï¼š`scope_type === 'user' ? parseInt(scope_id) : null`     |

**æ³¨æ„**ï¼šæŒ‰æ¶æ„å†³ç­–ï¼Œ**ä¸åº”åœ¨åç«¯åšæ´¾ç”Ÿå­—æ®µ**ï¼Œå‰ç«¯åº”ç›´æ¥ä½¿ç”¨ `scope_type/scope_id/status`ã€‚

---

## é™„å½•Cï¼šæ•°æ®åº“çœŸå®çŠ¶æ€å¿«ç…§ï¼ˆ2025-12-24ï¼‰

```sql
-- è¡¨ï¼šlottery_draw_quota_rulesï¼ˆå½“å‰1æ¡è®°å½•ï¼‰
SELECT * FROM lottery_draw_quota_rules;
/*
rule_id: 1
scope_type: 'global'
scope_id: 'global'
window_type: 'daily'
limit_value: 50
status: 'active'
priority: 0
created_at: '2025-12-24 04:36:24'
*/

-- è¡¨ï¼šlottery_user_daily_draw_quotaï¼ˆå½“å‰0æ¡è®°å½•ï¼‰
SELECT COUNT(*) FROM lottery_user_daily_draw_quota;
-- ç»“æœï¼š0

-- è¿ç§»è®°å½•éªŒè¯
SELECT name FROM SequelizeMeta
WHERE name LIKE '%quota%';
-- ç»“æœï¼š20251223200000-create-lottery-draw-quota-tables.js
```

---

**æŠ¥å‘Šç»“æŸï¼ˆæœ€åæ›´æ–°ï¼š2025-12-24ï¼‰**
