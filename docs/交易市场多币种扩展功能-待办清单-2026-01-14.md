# äº¤æ˜“å¸‚åœºå¤šå¸ç§æ‰©å±•åŠŸèƒ½ - å®ç°çŠ¶æ€ä¸å¾…åŠæ¸…å•

**æ–‡æ¡£ç‰ˆæœ¬**: V1.7  
**åˆ›å»ºæ—¶é—´**: 2026-01-14  
**æœ€åæ›´æ–°**: 2026-01-15ï¼ˆå®æµ‹ç”Ÿäº§MySQLç‰ˆæœ¬ï¼‰  
**å…³è”æ–‡æ¡£**: `ææ–™è½¬æ¢ç³»ç»Ÿé™ç»´æŠ¤æˆæœ¬æ–¹æ¡ˆ-2026-01-13.md`  
**é€‚ç”¨ç³»ç»Ÿ**: é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ V4.5.0 äº¤æ˜“å¸‚åœºæ¨¡å—

---

## ğŸ“Š å½“å‰çŠ¶æ€æ€»è§ˆï¼ˆ2026-01-15 æ›´æ–°ï¼‰

### âœ… ç”Ÿäº§æ•°æ®åº“ç‰ˆæœ¬å®æµ‹ï¼ˆé€šè¿‡ Node.js ç›´è¿çœŸå®æ•°æ®åº“ï¼‰
- **MySQL ç‰ˆæœ¬**ï¼š**8.0.30**ï¼ˆ`SELECT VERSION()`ï¼‰
- **ç»“è®º**ï¼š
  - âœ… å¯ä½¿ç”¨ **MySQL 8.0** çš„ç‰¹æ€§ï¼ˆå« `CHECK` çº¦æŸè¯­ä¹‰ã€JSON ç±»å‹ä¸è¡¨è¾¾å¼ç­‰ï¼‰
  - âœ… `user_risk_profiles` çš„ JSON æ–¹æ¡ˆå¯æŒ‰ MySQL 8.0 è¿›è¡Œè®¾è®¡ä¸ç´¢å¼•ä¼˜åŒ–

| æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
| --- | --- | --- |
| æ•°æ®åº“è¡¨ç»“æ„ | âœ… å·²å°±ç»ª | `market_listings.price_asset_code`ã€`trade_orders.asset_code` å·²å­˜åœ¨ |
| å¤šå¸ç§é…ç½®ï¼ˆP0+P1ï¼‰ | âœ… å·²å®Œæˆ | è¿ç§» `20260114005930` å·²æ‰§è¡Œï¼Œ13é¡¹ marketplace é…ç½®å·²å…¥åº“ |
| æœåŠ¡å±‚é€»è¾‘ - TradeOrderService | âœ… å·²å®Œæˆ | å·²ä½¿ç”¨ `allowed_settlement_assets` ç™½åå•æ ¡éªŒï¼Œç§»é™¤ DIAMOND ç¡¬ç¼–ç  |
| æœåŠ¡å±‚é€»è¾‘ - FeeCalculator | âœ… å·²å®Œæˆ | å·²å®ç° `calculateFeeByAsset()`ï¼Œæ”¯æŒ DIAMOND åˆ†æ¡£ + red_shard å•ä¸€è´¹ç‡ |
| è·¯ç”±å±‚é€»è¾‘ - sell.js | âœ… å·²å®Œæˆ | å·²æ¥å— `price_asset_code` å‚æ•°ï¼Œé»˜è®¤ DIAMOND |
| **æœåŠ¡å±‚é€»è¾‘ - MarketListingService** | âŒ ç¼ºå£ | ç¼ºå°‘ï¼šå¸ç§ç™½åå•æ ¡éªŒã€ä»·æ ¼åŒºé—´æ ¡éªŒã€åŒç‰©å•å¸æ ¡éªŒ |
| **é£æ§é™é¢æ‰§è¡Œ** | âŒ ç¼ºå£ | DB é…ç½®å­˜åœ¨ä½†ä»£ç æœªæ¶ˆè´¹ï¼ˆdaily_max_* æœªæ‰§è¡Œï¼‰ |
| **é…ç½®æ²»ç†ç™½åå•** | âŒ ç¼ºå£ | æ–°å¢ marketplace key æœªåŠ å…¥ `system-settings-whitelist.js` |

---

## ğŸ¯ æ ¸å¿ƒå†³ç­–ï¼ˆæ¥æºï¼š2026-01-14 æ‹æ¿ï¼‰

### äº¤æ˜“å¸‚åœºåŸŸï¼ˆC2Cæ’®åˆäº¤æ˜“ï¼‰- å¤šå¸ç§æ‰©å±•å†³ç­–

1. **è·¨å¸æ”¯ä»˜**: âŒ **ä¸å…è®¸**ï¼ˆåŒä¸€è®¢å•åªç”¨ä¸€ç§ç»“ç®—å¸ï¼Œåˆ†å¸ç§æ’®åˆï¼‰
2. **åŒç‰©å¤šå¸æŒ‚ç‰Œ**: âŒ **ä¸å…è®¸**ï¼ˆæ¯ä¸ªç‰©å“åŒæ—¶åªèƒ½ä»¥ä¸€ç§å¸ç§æŒ‚ç‰Œï¼Œé¿å…ä»·æ ¼æ··ä¹±ï¼‰
   - **è½åœ°æ–¹å¼**ï¼šåº”ç”¨å±‚äº‹åŠ¡æ ¡éªŒ + é” `item_instances` è¡Œï¼ˆç²’åº¦æ˜ç¡®ï¼Œé˜²å¹¶å‘ç©¿é€ï¼‰
3. **æ‰‹ç»­è´¹ç‡æ¨¡å‹**ï¼š
   - **DIAMOND**ï¼šâœ… ä¿æŒç°çŠ¶åˆ†æ¡£é€»è¾‘ï¼ˆæŒ‰ `itemValue` åˆ†æ¡£ + `ceil` + æœ€ä½è´¹ï¼‰
   - **red_shard**ï¼šâœ… å•ä¸€è´¹ç‡ 5%ï¼Œæœ€ä½æ‰‹ç»­è´¹ 1 red_shardï¼ˆä¸èµ° itemValue åˆ†æ¡£ï¼‰
4. **red_shard ä»·æ ¼åŒºé—´**ï¼š`min_price = 1`, `max_price = 1,000,000`ï¼ˆç¡¬å…œåº•ï¼‰ï¼Œè¶…å‡ºåŒºé—´**ç›´æ¥æ‹’ç»æŒ‚ç‰Œ**
5. **ç™½åå•å¸ç§**ï¼šåˆæœŸåªå¼€ DIAMOND + red_shardï¼Œæ–°å¸ç§å‡†å…¥éœ€æ»¡è¶³ï¼š
   - `material_asset_types.is_tradable = 1`
   - `system_settings.allowed_settlement_assets` åœ¨ç™½åå•
   - è¯¥å¸ç§çš„è´¹ç‡ã€æœ€ä½è´¹ã€ä»·æ ¼åŒºé—´ã€é¢‘æ§é˜ˆå€¼å·²é…ç½®é½å…¨
6. **é£æ§é˜ˆå€¼ï¼ˆMVP å³ä¸Šï¼‰**ï¼šæŒ‰"ç”¨æˆ·+å¸ç§"ç»´åº¦é™åˆ¶ï¼š
   - æ—¥æŒ‚å•æ¬¡æ•°ä¸Šé™ï¼ˆä¾‹å¦‚ï¼šæ¯æ—¥ 20 æ¬¡/å¸ç§ï¼‰
   - æ—¥æˆäº¤æ¬¡æ•°ä¸Šé™ï¼ˆä¾‹å¦‚ï¼šæ¯æ—¥ 10 æ¬¡/å¸ç§ï¼‰
   - æ—¥æˆäº¤é¢ä¸Šé™ï¼ˆä¾‹å¦‚ï¼šæ¯æ—¥ 100,000 DIAMOND æˆ– 50,000 red_shardï¼‰

---

## ğŸ¯ äº§å“æ‹æ¿å†³ç­–ï¼ˆ2026-01-15 ç¡®è®¤ï¼‰

### 1) é£æ§ Redis ä¸å¯ç”¨å¤„ç†ç­–ç•¥
- **é€‰æ‹©**ï¼š**fail-closed**ï¼ˆä¸Šæ¶/è´­ä¹°æ—¶ Redis ä¸å¯ç”¨åˆ™æ‹’ç»æ“ä½œï¼‰
- **ç”¨æˆ·ä½“éªŒå…œåº•ç»†åˆ™**ï¼š
  - âœ… **ä¸Šæ¶/è´­ä¹°**ï¼šfail-closedï¼ˆRedis æŒ‚äº†ç›´æ¥æ‹’ç»ï¼Œè¿”å› 503/å¯é‡è¯•æç¤ºï¼‰
  - âœ… **æ’¤å›æŒ‚ç‰Œã€å–æ¶ˆè®¢å•ã€è§£å†»é“¾è·¯**ï¼šå°½é‡ä¸å—å½±å“ï¼ˆå³ä½¿ Redis æŒ‚äº†ï¼Œä¹Ÿå…è®¸ç”¨æˆ·æŠŠèµ„äº§ä»å¸‚åœºçŠ¶æ€é€€å‡ºæ¥ï¼‰
- **ç†ç”±**ï¼šèµ„é‡‘/èµ„äº§å®‰å…¨ä¼˜å…ˆï¼Œå®å¯çŸ­æ—¶ä¸å¯ç”¨ï¼Œä¹Ÿä¸å…è®¸è§„åˆ™å¤±æ§ï¼›åŒæ—¶ç»™ç”¨æˆ·ç•™"é€€å‡ºé€šé“"

### 2) æ—¥é™é¢è®¡æ•°å£å¾„
- **æŒ‚å•æ¬¡æ•°**ï¼šæŒ‰ **å–å®¶ + å¸ç§** è®¡æ•°
  - ç†ç”±ï¼šå¦åˆ™å–å®¶å¯ä»¥æ— é™åˆ·ä¸Šæ¶/æ’¤å›æ‰“å‹å¸‚åœº
- **æˆäº¤æ¬¡æ•°/æˆäº¤é¢**ï¼šæŒ‰ **ä¹°å®¶ + å¸ç§** è®¡æ•°
  - ç†ç”±ï¼šæŒ¡åˆ·æœ€ç›´æ¥ï¼Œè¯¯ä¼¤æœ€å°
- **ä¸è€ƒè™‘**ï¼šåŠ å–å®¶æˆäº¤é™é¢ï¼ˆæ›´å®¹æ˜“è¯¯ä¼¤æ­£å¸¸ç»è¥å‹å–å®¶ï¼‰

### 3) "æˆäº¤é¢"å£å¾„
- **é€‰æ‹©**ï¼š**gross_amount**ï¼ˆä¹°å®¶æ”¯ä»˜æ€»é¢ï¼Œå«æ‰‹ç»­è´¹ï¼‰
- **ç†ç”±**ï¼šåˆ·é‡/æ´—èµ„äº§çš„æˆæœ¬ä¸é£é™©æ›´è´´è¿‘"ä¹°å®¶æ”¯ä»˜æ€»é¢"ï¼Œæ›´åˆ©äºæ§æˆæœ¬/ååˆ·

### 4) æ‰‹ç»­è´¹/è´¹ç‡è¿è¥åå°å¯æ”¹æ€§
- **é€‰æ‹©**ï¼š**å…è®¸è¿è¥åå°ä¿®æ”¹**
- **å¯æ”¹é…ç½®æ¸…å•**ï¼š
  - `fee_rate_*`ï¼ˆæ‰‹ç»­è´¹ç‡ï¼‰
  - `fee_min_*`ï¼ˆæœ€ä½æ‰‹ç»­è´¹ï¼‰
  - `allowed_listing_assets`ï¼ˆæŒ‚ç‰Œå¸ç§ç™½åå• - æ§åˆ¶æ–°æŒ‚ç‰Œå‡†å…¥ï¼‰
  - `allowed_settlement_assets`ï¼ˆç»“ç®—å¸ç§ç™½åå• - æ§åˆ¶æˆäº¤/ç»“ç®—ï¼Œç´§æ€¥åˆ¹è½¦ï¼‰
  - `daily_max_*`ï¼ˆé£æ§é˜ˆå€¼ï¼šæ—¥é™æ¬¡/é™é¢ï¼‰
  - `min_price_*` / `max_price_*`ï¼ˆä»·æ ¼åŒºé—´ï¼‰
- **é…å¥—è¦æ±‚**ï¼šéœ€åŒæ­¥æ›´æ–° `config/system-settings-whitelist.js`ï¼ŒæŠŠè¿™äº› key åŠ å…¥ç™½åå•

### 5) red_shard æ‰‹ç»­è´¹è®¡ç®—è§„åˆ™
- **å–æ•´æ–¹å¼**ï¼š**floor**ï¼ˆå‘ä¸‹å–æ•´ï¼Œå¯¹ç”¨æˆ·æ›´å‹å¥½ï¼‰
- **æœ€ä½æ‰‹ç»­è´¹**ï¼š**1**ï¼ˆå¯¹æ‰€æœ‰é DIAMOND ä¸€è‡´æ‰§è¡Œï¼‰
- **ç†ç”±**ï¼šç®€å•ã€å¯è§£é‡Šã€ç”¨æˆ·å‹å¥½

### 6) ç°åº¦ä¸‹çº¿å¸ç§åå­˜é‡æŒ‚ç‰Œå¤„ç†
- **é€‰æ‹©**ï¼š**ç¦æ­¢æ–°æŒ‚ç‰Œï¼Œä½†å…è®¸å­˜é‡ç»§ç»­æˆäº¤**
- **å®ç°æ–¹å¼**ï¼šéœ€è¦ä¸¤ä¸ªç‹¬ç«‹å¼€å…³ï¼ˆä¸èƒ½åªé ä¸€ä¸ªç™½åå•ï¼‰
  - **å¼€å…³1ï¼šæŒ‚ç‰Œç™½åå•**
    - **key**ï¼š`marketplace.allowed_listing_assets`ï¼ˆæ–°å¢ï¼‰
    - **é»˜è®¤å€¼**ï¼š`["DIAMOND","red_shard"]`
    - **ä½œç”¨**ï¼šæ§åˆ¶"å–å®¶èƒ½ä¸èƒ½ç”¨è¯¥å¸ç§åˆ›å»ºæ–°æŒ‚ç‰Œ"
  - **å¼€å…³2ï¼šç»“ç®—ç™½åå•**
    - **key**ï¼š`marketplace.allowed_settlement_assets`ï¼ˆæ²¿ç”¨ç°æœ‰ï¼‰
    - **é»˜è®¤å€¼**ï¼š`["DIAMOND","red_shard"]`
    - **ä½œç”¨**ï¼šæ§åˆ¶"ä¹°å®¶èƒ½ä¸èƒ½ç”¨è¯¥å¸ç§ä¸‹å•/æˆäº¤/ç»“ç®—"ï¼ˆç´§æ€¥åˆ¹è½¦æœ€å…³é”®çš„é—¸é—¨ï¼‰
- **ç´§æ€¥åˆ¹è½¦**ï¼šä¿ç•™"ä¸€é”®åˆ‡åˆ°ç¦æ­¢æˆäº¤"çš„èƒ½åŠ›ï¼Œå½“å‘ç°é£é™©æ—¶å¯ç§’åˆ‡åˆ°å®‰å…¨æ€

#### åŒç™½åå•æ“ä½œæ‰‹å†Œ
| åœºæ™¯ | `allowed_listing_assets` | `allowed_settlement_assets` | æ•ˆæœ |
| --- | --- | --- | --- |
| æ­£å¸¸è¿è¥ | `["DIAMOND","red_shard"]` | `["DIAMOND","red_shard"]` | å…¨åŠŸèƒ½å¼€æ”¾ |
| åªç¦æ–°æŒ‚ç‰Œï¼ˆç°åº¦ï¼‰ | å»æ‰ `red_shard` | ä¿ç•™ `red_shard` | ç¦æ­¢æ–° red_shard æŒ‚ç‰Œï¼Œå­˜é‡å¯ç»§ç»­æˆäº¤ |
| ç´§æ€¥åˆ¹è½¦ï¼ˆé£é™©ï¼‰ | å»æ‰ `red_shard` | å»æ‰ `red_shard` | å…¨é‡ç¦æ­¢ red_shard æˆäº¤ï¼Œä»å…è®¸æ’¤å›/è§£å†» |

### 7) ç´§æ€¥åˆ¹è½¦è§¦å‘åå­˜é‡æŒ‚å•å¤„ç†
- **é€‰æ‹©**ï¼š**A - åªç¦æ­¢æˆäº¤ï¼ŒæŒ‚å•ç»§ç»­å±•ç¤ºä½†ä¸å¯ä¹°**ï¼ˆæœ€çœäº‹ï¼‰
- **æ•ˆæœ**ï¼š
  - æŒ‚å•ç»§ç»­åœ¨å¸‚åœºåˆ—è¡¨ä¸­å±•ç¤º
  - ä¹°å®¶ç‚¹å‡»è´­ä¹°æ—¶è¿”å›é”™è¯¯æç¤ºï¼š"è¯¥å¸ç§æš‚åœäº¤æ˜“"
  - å–å®¶å¯æ­£å¸¸æ’¤å›æŒ‚ç‰Œã€è§£å†»èµ„äº§
- **ç†ç”±**ï¼šå®ç°ç®€å•ï¼Œä¸éœ€è¦æ‰¹é‡æ“ä½œå­˜é‡æ•°æ®ï¼Œå–å®¶ä½“éªŒä¹Ÿä¸ä¼šå¤ªå·®

### 8) æ—¥é™é¢å‘½ä¸­åçš„äº§å“ä½“éªŒ
- **æç¤ºæ–‡æ¡ˆ**ï¼š**æ˜ç¡®å‘ŠçŸ¥**ï¼ˆé€æ˜ç­–ç•¥ï¼‰
  - ç¤ºä¾‹ï¼š`"æ‚¨ä»Šæ—¥ red_shard æŒ‚ç‰Œæ¬¡æ•°å·²è¾¾ä¸Šé™ï¼ˆ20æ¬¡ï¼‰ï¼Œæ˜æ—¥ 00:00 åå¯ç»§ç»­æ“ä½œ"`
  - ç¤ºä¾‹ï¼š`"æ‚¨ä»Šæ—¥ DIAMOND æˆäº¤é¢å·²è¾¾ä¸Šé™ï¼ˆ100,000ï¼‰ï¼Œæ˜æ—¥ 00:00 åå¯ç»§ç»­è´­ä¹°"`
- **å†·å´é‡ç½®**ï¼š**è‡ªç„¶æ—¥ 00:00ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰** é‡ç½®
  - ä¸ç°æœ‰ `BeijingTimeHelper.todayStart()` å¯¹é½ï¼Œå®ç°ç®€å•
- **ç™½åå•æé¢**ï¼š**æ”¯æŒ**ï¼ˆè¿è¥å¯è°ƒï¼Œä¸å…è®¸ç¡¬ç¼–ç ï¼‰
  - **ç­‰çº§æ¥æº**ï¼š`users.user_level` å­—æ®µï¼ˆå”¯ä¸€æƒå¨æ¥æºï¼‰ï¼Œç­‰çº§é›†åˆï¼š`normal / vip / merchant`
  - **è°èƒ½å‡é™çº§**ï¼š`admin` åŠä»¥ä¸Šï¼ˆå’Œæ”¹é˜ˆå€¼æƒé™ä¸€è‡´ï¼‰
  - **å®ç°æ–¹å¼**ï¼šæ–°å»º `user_risk_profiles` è¡¨ï¼ŒæŒ‰ç”¨æˆ·/ç”¨æˆ·ç­‰çº§å­˜å‚¨é˜ˆå€¼è¦†ç›–
  - **é˜ˆå€¼å­˜å‚¨**ï¼šJSON æ ¼å¼ï¼ˆ`daily_limits_json`ï¼‰ï¼ŒæŒ‰ `asset_code` å­˜é˜ˆå€¼ï¼Œæ–°å¸ç§ä¸æ”¹è¡¨
  - **ä¼˜å…ˆçº§**ï¼šç”¨æˆ·çº§é…ç½® > ç­‰çº§é…ç½® > ç³»ç»Ÿé»˜è®¤ï¼ˆ`system_settings`ï¼‰
  - **è¯¦è§**ï¼šä¸‹æ–¹"ç”¨æˆ·é£æ§é…ç½®è¡¨è®¾è®¡"ç« èŠ‚
- **ç”³è¯‰é€šé“**ï¼š**å…ˆä¸åš**ï¼ˆäººå·¥æˆæœ¬é«˜ï¼Œç­‰æœ‰é‡å†è¯´ï¼‰

### 9) è´¹ç‡/é˜ˆå€¼é…ç½®ä¿®æ”¹çš„æƒé™ä¸å®¡è®¡
- **è°èƒ½æ”¹**ï¼šå…·æœ‰ `admin` æˆ– `super_admin` è§’è‰²çš„ç”¨æˆ·
- **åŒäººå¤æ ¸/å®¡æ‰¹**ï¼š**ä¸éœ€è¦**ï¼Œå•äººå³å¯ä¿®æ”¹
- **å®¡è®¡å¯¼å‡º**ï¼š**éœ€è¦**ï¼ˆäº‹æ•…è¿½æº¯å¿…å¤‡ï¼‰
  - æ‰€æœ‰é…ç½®å˜æ›´å¿…é¡»è®°å½•åˆ°å®¡è®¡æ—¥å¿—ï¼š`æ“ä½œäºº`ã€`æ“ä½œæ—¶é—´`ã€`ä¿®æ”¹å‰å€¼`ã€`ä¿®æ”¹åå€¼`ã€`æ“ä½œ IP`
  - å»ºè®®ä½¿ç”¨ç°æœ‰ `audit_logs` æˆ– `system_settings_history` è¡¨
- **ç”Ÿæ•ˆçª—å£**ï¼šç«‹å³ç”Ÿæ•ˆï¼ˆä¸åšæ¬¡æ—¥ç”Ÿæ•ˆï¼‰

### 10) ç”¨æˆ·ç­‰çº§æ¥æºè®¾è®¡
- **ç­‰çº§å­—æ®µä½ç½®**ï¼š`users.user_level`ï¼ˆå”¯ä¸€æƒå¨æ¥æºï¼‰
- **ç­‰çº§é›†åˆ**ï¼š`normal`ï¼ˆé»˜è®¤ï¼‰/ `vip` / `merchant`
- **è°èƒ½å‡é™çº§**ï¼š`admin` åŠä»¥ä¸Šï¼ˆå’Œæ”¹é˜ˆå€¼æƒé™ä¸€è‡´ï¼Œå•äººå¯æ”¹ï¼‰
- **ä¸åš**ï¼šç‹¬ç«‹ç”»åƒ/æ ‡ç­¾ç³»ç»Ÿï¼ˆå½“å‰é˜¶æ®µä¸éœ€è¦ï¼‰
- **é…ç½®å±‚æ¬¡**ï¼š
  - **æŒ‰ç”¨æˆ·**ï¼šç»™æŸä¸ª `user_id` å•ç‹¬æé¢/å†»ç»“ï¼ˆå†™å…¥ `user_risk_profiles`ï¼‰
  - **æŒ‰ç­‰çº§**ï¼šç”¨ `users.user_level` å¥—ä¸€æ¡£é»˜è®¤ç­–ç•¥ï¼ˆå†™å…¥ `user_risk_profiles` çš„ç­‰çº§è¡Œï¼‰
  - **æŒ‰æ¡ä»¶æ‰¹é‡**ï¼šæŒ‰æ—¶é—´çª—è®¢å•ç­›é€‰/èµ„äº§æµæ°´ç­›é€‰ â†’ æ‰¹é‡è½åº“

### 11) é˜ˆå€¼å­˜å‚¨å½¢æ€ï¼ˆJSON å¯æ‰©å±•æ–¹æ¡ˆï¼‰
- **é€‰æ‹©**ï¼š**JSON å­˜å‚¨**ï¼ˆä¸æŒ‰åˆ—å­˜å‚¨ï¼‰
- **å­—æ®µ**ï¼š`daily_limits_json`ï¼ŒæŒ‰ `asset_code` å­˜é˜ˆå€¼
- **æ ¼å¼ç¤ºä¾‹**ï¼š
  ```json
  {
    "DIAMOND": { "listings": 50, "trades": 30, "amount": 500000 },
    "red_shard": { "listings": 50, "trades": 30, "amount": 200000 }
  }
  ```
- **å¥½å¤„**ï¼š
  - æ–°å¸ç§ä¸Šçº¿ä¸æ”¹è¡¨
  - è¿è¥åå°é…ç½®ç»Ÿä¸€ï¼ˆ"æŒ‰å¸ç§å±•å¼€"ï¼‰
  - æ›´åƒå¤§å‚/æ¸¸æˆå¸¸ç”¨å½¢æ€

### 12) å†»ç»“æ•°æ®ç»“æ„è®¾è®¡
- **é€‰æ‹©**ï¼š**scopes + asset_codes åˆ†ç¦»**ï¼ˆé€‰é¡¹ Aï¼‰
- **å­—æ®µè®¾è®¡**ï¼š
  - `frozen_scopes`ï¼šJSON æ•°ç»„ï¼Œåªå†™åŠŸèƒ½ï¼ˆ`market_listing`, `market_buy`, `exchange_order`, `exchange_redeem`, `transfer`, `convert`, `full_site`â€¦ï¼‰
  - `frozen_asset_codes`ï¼šJSON æ•°ç»„ï¼Œå†™å¸ç§ï¼ˆå¦‚ `["red_shard"]` æˆ– `["DIAMOND","red_shard"]`ï¼‰
- **ç†ç”±**ï¼šå¯ç»´æŠ¤ã€æŸ¥è¯¢å¥½å†™ã€åå° UI å¥½åšã€å®¡è®¡è§£é‡Šæ¸…æ™°
- **ç»„åˆé€»è¾‘**ï¼šç”¨æˆ·è¢«å†»ç»“æŸåŠŸèƒ½ + æŸå¸ç§æ—¶æ‰æ‹¦æˆªï¼Œä¸¤è€…å–äº¤é›†

### 13) "æ°¸è¿œæ”¾è¡Œçš„é€€å‡ºé€šé“"å£å¾„
- **æ’¤å›æŒ‚ç‰Œ**ï¼š**æ°¸è¿œå…è®¸**ï¼ˆå“ªæ€• Redis æŒ‚äº†/ç”¨æˆ·è¢«å†»ï¼Œä¹Ÿå…è®¸æ’¤å›ä»¥é™ä½æ•å£ï¼‰
- **å–æ¶ˆè®¢å•**ï¼š**æ°¸è¿œå…è®¸**ï¼ˆé™ä½çº çº·ä¸èµ„é‡‘å ç”¨ï¼‰
- **å…‘æ¢è®¢å•é€€æ¬¾/å›æ»š**ï¼š**å…è®¸è¿è¥å¼ºåˆ¶æ‰§è¡Œ**ï¼ˆäº‹æ•…å¤„ç½®å¿…å¤‡ï¼‰
- **è®¾è®¡åŸåˆ™**ï¼šé£æ§åªæ‹¦"æ–°å¢é£é™©æ•å£"ï¼Œä¸æ‹¦"é™ä½æ•å£çš„åŠ¨ä½œ"

### 14) JSON é˜ˆå€¼"ç¼ºå¤±/NULL"è¯­ä¹‰
- **é€‰æ‹©**ï¼š**ç¼ºå¤±/NULL = ç»§æ‰¿ `system_settings` é»˜è®¤**
- **é€»è¾‘**ï¼š
  - `daily_limits_json` ä¸º NULL â†’ å…¨éƒ¨ç»§æ‰¿ç³»ç»Ÿé»˜è®¤
  - `daily_limits_json.{asset_code}` ç¼ºå¤± â†’ è¯¥å¸ç§ç»§æ‰¿ç³»ç»Ÿé»˜è®¤
  - `daily_limits_json.{asset_code}.{limitType}` ç¼ºå¤± â†’ è¯¥é¡¹ç»§æ‰¿ç³»ç»Ÿé»˜è®¤
- **å¥½å¤„**ï¼šè¿è¥æœ€çœå¿ƒï¼Œåªéœ€é…ç½®"è¦†ç›–é¡¹"ï¼Œå…¶ä½™è‡ªåŠ¨ç»§æ‰¿

### 15) `frozen_asset_codes` çš„ NULL è¯­ä¹‰
- **é€‰æ‹©**ï¼š**`null` = å…¨å¸ç§å†»ç»“**
- **é€»è¾‘**ï¼š
  - `frozen_asset_codes = null` â†’ å†»ç»“æ‰€æœ‰å¸ç§
  - `frozen_asset_codes = ["red_shard"]` â†’ ä»…å†»ç»“ red_shard
  - `frozen_asset_codes = []` â†’ ä¸å†»ç»“ä»»ä½•å¸ç§ï¼ˆç­‰åŒæœªé…ç½®å†»ç»“ï¼‰
- **å¥½å¤„**ï¼šè¡¨è¾¾"å…¨ç«™å†»ç»“/å…¨å¸ç§å†»ç»“"æœ€ç®€å•ï¼Œä¸éœ€è¦æšä¸¾æ‰€æœ‰å¸ç§

### 16) `full_site` å…¨ç«™å†»ç»“æ˜¯å¦ä¿ç•™é€€å‡ºé€šé“
- **é€‰æ‹©**ï¼š**ä¿ç•™é€€å‡ºé€šé“**ï¼ˆ`full_site` ä¹Ÿä¸æ‹¦æ’¤å›/å–æ¶ˆ/é€€æ¬¾å›æ»šï¼‰
- **è¢«æ‹¦æ“ä½œ**ï¼ˆæ–°å¢æ•å£ï¼‰ï¼š
  - åˆ›å»ºæŒ‚ç‰Œã€ä¸‹å•è´­ä¹°ã€å…‘æ¢ä¸‹å•ã€è½¬è´¦ã€è½¬æ¢ ç­‰
- **ä¸æ‹¦æ“ä½œ**ï¼ˆé™ä½æ•å£ï¼‰ï¼š
  - æ’¤å›æŒ‚ç‰Œã€å–æ¶ˆè®¢å•ã€è¿è¥é€€æ¬¾/å›æ»š ç­‰
- **ç†ç”±**ï¼šé¿å…æŠŠæ­£å¸¸ç”¨æˆ·èµ„äº§å¡æ­»ï¼Œå‡å°‘å®¢è¯‰ï¼ŒåŒæ—¶é£é™©ç”¨æˆ·ä¹Ÿæ— æ³•åˆ©ç”¨è¿™äº›é€šé“æ‰©å¤§æ•å£

---

## ğŸ›¡ï¸ é£é™©ç”¨æˆ·å¤„ç½®ç­–ç•¥ï¼ˆ2026-01-15 æ‹æ¿ï¼‰

### é£é™©ç”¨æˆ·å†»ç»“ç­–ç•¥
- **é»˜è®¤æ€**ï¼šå†»ç»“è¯¥å¸ç§ + ç¦æ­¢å…¶å¸‚åœº/å…‘æ¢å†™æ“ä½œ
- **å‡çº§æ€**ï¼šå¿…è¦æ—¶å¯å‡çº§ä¸ºå…¨ç«™å†»ç»“
- **è¿è¥åå°èƒ½åŠ›è¦æ±‚**ï¼š
  - å¯æ§åˆ¶å†»ç»“å•ä¸ªç”¨æˆ·æˆ–æ‰¹é‡ç”¨æˆ·
  - å¯é€‰æ‹©å†»ç»“èŒƒå›´ï¼šå•å¸ç§/éƒ¨åˆ†åŠŸèƒ½/å…¨éƒ¨åŠŸèƒ½

### å†»ç»“èŒƒå›´æšä¸¾ï¼ˆç»†ç²’åº¦å¼€å…³ - å…¨éƒ¨éƒ½è¦åšï¼‰

| åŠŸèƒ½åŸŸ | å­åŠŸèƒ½ | å¼€å…³è¯´æ˜ |
| --- | --- | --- |
| **äº¤æ˜“å¸‚åœº** | æŒ‚ç‰Œ | ç¦æ­¢åˆ›å»ºæ–°æŒ‚ç‰Œ |
| | è´­ä¹° | ç¦æ­¢ä¸‹å•è´­ä¹° |
| | æ’¤å› | ç¦æ­¢æ’¤å›æŒ‚ç‰Œï¼ˆä¸€èˆ¬ä¸ç¦ï¼Œä¿ç•™é€€å‡ºé€šé“ï¼‰ |
| **å…‘æ¢å¸‚åœº** | ä¸‹å• | ç¦æ­¢åˆ›å»ºå…‘æ¢è®¢å• |
| | å‘ç  | ç¦æ­¢å‘æ”¾æ ¸é”€ç  |
| | æ ¸é”€ | ç¦æ­¢æ ¸é”€ç ä½¿ç”¨ |
| **èµ„äº§æ“ä½œ** | è½¬è´¦ | ç¦æ­¢ç”¨æˆ·é—´è½¬è´¦ |
| | è½¬æ¢ | ç¦æ­¢èµ„äº§ç±»å‹è½¬æ¢ï¼ˆå¦‚ææ–™â†’çº¢å®çŸ³ï¼‰ |
| **å…¨å±€** | å…¨ç«™å†»ç»“ | ä¸€é”®ç¦æ­¢æ‰€æœ‰å†™æ“ä½œ |

### æ‰¹é‡å†»ç»“è¾“å…¥æ–¹å¼ï¼ˆå…¨éƒ¨éƒ½è¦åšï¼‰

| è¾“å…¥æ–¹å¼ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
| --- | --- | --- |
| **æŒ‰ç”¨æˆ· ID åˆ—è¡¨** | ç›´æ¥è¾“å…¥ç”¨æˆ· IDï¼ˆé€—å·åˆ†éš”æˆ–æ‰¹é‡å¯¼å…¥ï¼‰ | å·²å®šä½åˆ°å…·ä½“é£é™©ç”¨æˆ· |
| **æŒ‰æ—¶é—´çª—è®¢å•ç­›é€‰** | æŒ‡å®šæ—¶é—´èŒƒå›´ + è®¢å•ç±»å‹/çŠ¶æ€/å¸ç§ â†’ è‡ªåŠ¨æå–å…³è”ç”¨æˆ· | å‘ç°æŸæ—¶é—´æ®µæœ‰å¼‚å¸¸ï¼Œéœ€è¦æ‰¹é‡å¤„ç† |
| **æŒ‰èµ„äº§æµæ°´ç­›é€‰** | æŒ‡å®š `business_type` + æ—¶é—´èŒƒå›´ + é‡‘é¢é˜ˆå€¼ â†’ æå–å¼‚å¸¸ç”¨æˆ· | è¿½æº¯å¼‚å¸¸å…¥è´¦æ¥æº |

### è¿è¥åå°å†»ç»“æ“ä½œæµç¨‹
1. **é€‰æ‹©å†»ç»“æ–¹å¼**ï¼šå•ç”¨æˆ· / æ‰¹é‡ï¼ˆIDåˆ—è¡¨ / æ—¶é—´çª—ç­›é€‰ï¼‰
2. **é¢„è§ˆå½±å“èŒƒå›´**ï¼šå±•ç¤ºå°†è¢«å†»ç»“çš„ç”¨æˆ·æ•°é‡ã€æ¶‰åŠè®¢å•æ•°ã€èµ„äº§é‡‘é¢
3. **é€‰æ‹©å†»ç»“ç²’åº¦**ï¼šå‹¾é€‰å…·ä½“åŠŸèƒ½å¼€å…³ï¼ˆæˆ–ç›´æ¥é€‰"å…¨ç«™å†»ç»“"ï¼‰
4. **å¡«å†™å†»ç»“åŸå› **ï¼šå¿…å¡«ï¼Œç”¨äºå®¡è®¡å’Œç”¨æˆ·ç”³è¯‰å‚è€ƒ
5. **ç¡®è®¤æ‰§è¡Œ**ï¼šè®°å½•å®¡è®¡æ—¥å¿—ï¼Œç«‹å³ç”Ÿæ•ˆ

### äº‹æ•…å¤„ç½®ä¸‰æ­¥æ³•

#### 1) å…ˆæ­¢è¡€ï¼šé˜»æ–­ç»§ç»­æ‰©æ•£ï¼ˆåˆ†é’Ÿçº§ï¼‰
- **å†»ç»“é£é™©ç”¨æˆ·çš„è¯¥å¸ç§ä½™é¢**ï¼šç”¨ç»Ÿä¸€è´¦æœ¬æ¨¡å‹åš"å¯ç”¨â†’å†»ç»“"æˆ–ç›´æ¥ç¦æ­¢äº¤æ˜“å…¥å£ï¼ˆæ¨èä¸¤è€…å åŠ ï¼‰
- **æš‚åœå…‘æ¢ä¸‹å•**ï¼ˆåªé’ˆå¯¹è¯¥å¸ç§æˆ–è¯¥æ‰¹é£é™©ç”¨æˆ·ï¼‰ï¼šé¿å…ç»§ç»­æŠŠå¼‚å¸¸å¸è½¬æ¢æˆå•†å“å±¥çº¦
- **ä¿ç•™æ’¤å›/å–æ¶ˆé€šé“**ï¼šè®©æ­£å¸¸ç”¨æˆ·ä¸è¢«å¡æ­»ï¼ŒåŒæ—¶ä¾¿äºå›æ»šå¼‚å¸¸è®¢å•

#### 2) å†å®šä½ï¼šæŠŠ"å¼‚å¸¸å¸"å¯¹åº”åˆ°å…·ä½“ç”¨æˆ·ã€å…·ä½“è®¢å•ï¼ˆå°æ—¶çº§ï¼‰
- **åˆ©ç”¨ asset_transactions è¿½æº¯**ï¼ˆå¸¦ `business_type`ã€`idempotency_key`ã€`meta`ï¼‰
- **å…ˆæ‰¾å¼‚å¸¸æ¥æº**ï¼šæ˜¯å“ªä¸€ç±» `business_type` é€ æˆå¼‚å¸¸å¢å‘ï¼ˆä¾‹å¦‚ï¼šç®¡ç†å‘˜è°ƒæ•´ã€æ´»åŠ¨å‘æ”¾ã€è½¬æ¢ã€æ¼æ´è·¯å¾„é‡å¤å…¥è´¦ï¼‰
- **å†æ‰¾å¼‚å¸¸æ”¯å‡º**ï¼šå“ªäº›å…‘æ¢è®¢å•/æ ¸é”€è®¢å•çš„æ”¯ä»˜èµ„äº§æ¥è‡ªè¯¥å¸ç§çš„å¼‚å¸¸å¢å‘çª—å£
- **ç›®æ ‡**ï¼šåˆ’å‡ºä¸€ä¸ª"å¯æ“ä½œçš„é›†åˆ"ï¼š`ç”¨æˆ·é›†åˆ U` + `è®¢å•é›†åˆ O` + `äº¤æ˜“æµæ°´é›†åˆ T`

#### 3) åˆ†å±‚å¤„ç½®ï¼šæŒ‰å±¥çº¦çŠ¶æ€åš"èƒ½æ‹¦å°±æ‹¦ã€èƒ½å›æ»šå°±å›æ»š"ï¼ˆå¤©çº§ï¼‰
- **æœªæ ¸é”€/æœªå‘è´§**ï¼šç›´æ¥"æŒ‚èµ·/å–æ¶ˆ"è®¢å• + èµ„äº§å›æ»šï¼ˆé€€å›å¸ï¼‰+ ä¿ç•™è¯æ®ï¼ˆæµæ°´ã€åŸå› ã€æ“ä½œè€…ï¼‰
- **å·²å‘ç æœªæ ¸é”€**ï¼šå®šå‘ç¦ç”¨è¿™æ‰¹ç ï¼ˆä¸æ˜¯ç¦ç”¨å…¨ç«™ç ï¼‰ï¼Œå¹¶æç¤º"å¼‚å¸¸è®¢å•å¤„ç†ä¸­"
- **å·²æ ¸é”€/å·²å‘è´§**ï¼šè¿›å…¥äººå·¥å¤„ç†ï¼ˆå°ç¦/è¿½å¿/é»‘åå•/é£æ§å‘Šè­¦é—­ç¯ï¼‰

### å¼€å…³æ‹†åˆ†è®¾è®¡ï¼ˆå¤§å‚å¸¸è§åšæ³•ï¼‰

#### å¼€å…³1ï¼šå¸ç§å‡†å…¥/ç»“ç®—å¼€å…³
- **å½±å“èŒƒå›´**ï¼šäº¤æ˜“å¸‚åœº/å…‘æ¢æ”¯ä»˜ä¾§
- **ä½œç”¨**ï¼šé˜»æ­¢ç»§ç»­ç”¨è¯¥å¸ç§äº§ç”Ÿæ–°äº¤æ˜“æ•å£

#### å¼€å…³2ï¼šå•†å“/å±¥çº¦å¼€å…³
- **å½±å“èŒƒå›´**ï¼šå…‘æ¢å¸‚åœºçš„"èƒ½ä¸èƒ½ä¸‹å•/èƒ½ä¸èƒ½æ ¸é”€/èƒ½ä¸èƒ½å‘è´§"
- **ä½œç”¨**ï¼šé˜»æ­¢"éæ³•å•†å“ç»§ç»­è¢«å±¥çº¦"ï¼Œå“ªæ€•æ”¯ä»˜å¸ç§å·²ç»ä¸‹çº¿
- **æ ¸å¿ƒç†å¿µ**ï¼šå¸ç§ä¸‹çº¿åªèƒ½æ­¢ä½"é’±ä»å“ªæ¥"ï¼Œæ­¢ä¸ä½"è´§å¾€å“ªèµ°"ï¼›å¿…é¡»æœ‰"è´§çš„å¼€å…³"

### æŒ‰è®¢å•çŠ¶æ€åˆ†å±‚å¤„ç½®

| è®¢å•çŠ¶æ€ | åˆ†ç±» | å¤„ç½®æ–¹å¼ |
|---------|------|---------|
| å·²åˆ›å»ºä½†æœªæ ¸é”€/æœªå‘è´§ | Aç±»ï¼ˆå¯æ‹¦æˆªï¼‰ | ç«‹å³ï¼šåœæ­¢è¯¥å•†å“çš„æ–°ä¸‹å• + æŠŠè¿™æ‰¹è®¢å•è½¬ä¸º `hold/pending_review`<br>ç„¶åï¼šé£æ§/è¿è¥äººå·¥å¤æ ¸ï¼Œç¡®è®¤éæ³•åˆ™å–æ¶ˆ/é€€æ¬¾/å›æ»šèµ„äº§ |
| å·²å‘ç ä½†æœªæ ¸é”€ | Bç±»ï¼ˆå…³é”®çª—å£ï¼‰ | ç«‹å³ï¼šæŠŠè¿™äº›æ ¸é”€ç ç½®ä¸ºä¸å¯æ ¸é”€ï¼ˆ`disabled/blocked`ï¼‰<br>ç»™ç”¨æˆ·æ˜ç¡®æç¤º"å¼‚å¸¸è®¢å•å¤„ç†ä¸­" |
| å·²æ ¸é”€/å·²å‘è´§ | Cç±»ï¼ˆåŸºæœ¬ä¸å¯é€†ï¼‰ | è¿›å…¥å”®å/äº‰è®®å¤„ç†æµç¨‹<br>è¿½è´£/è¡¥å¿/é£æ§å°ç¦/é»‘åå•/æ³•å¾‹æ‰‹æ®µ/èµ„äº§è¿½å› |

### è¿½æº¯å›æ»šï¼ˆå†²æ­£ï¼‰ç­–ç•¥
- **é€‰æ‹©**ï¼š**åšå†²æ­£**ï¼ˆé€šè¿‡è´¦æœ¬å†²æ­£æŠŠå¼‚å¸¸å¸æ”¶å›ï¼‰
- **è¦æ±‚**ï¼š
  - âœ… å¯é€†/å¯å®¡è®¡/æœ‰å…œåº•ï¼Œä¸æ˜¯ç›´æ¥ç²—æš´æ‰£
  - âœ… ç”Ÿæˆåå‘æµæ°´ï¼Œä¿è¯è´¦æœ¬é—­ç¯
  - âœ… å¯¹å·²äº§ç”Ÿå±¥çº¦çš„è®¢å•èµ°äººå·¥å¤„ç†ï¼ŒæŠ€æœ¯ä¸Šä¸è½»æ˜“"å›æ»šå±¥çº¦äº‹å®"

### å·²å‘ç æœªæ ¸é”€å¤„ç†
- **é€‰æ‹©**ï¼š**å…è®¸å¼ºåˆ¶ç¦ç”¨ï¼ˆå®šå‘ç¦ç”¨è¿™æ‰¹é£é™©ç ï¼‰**
- **ç†ç”±**ï¼šè¿™æ˜¯æ­¢æŸçš„å…³é”®çª—å£ï¼Œä¸éœ€è¦"ç¦æ­¢å…¨éƒ¨å…‘æ¢ç "ï¼Œåªéœ€è¦å¯¹è¿™æ‰¹é£é™©è®¢å•çš„ç åšå®šå‘æ‹¦æˆª

---

## ğŸšï¸ ç”¨æˆ·é£æ§é…ç½®è¡¨è®¾è®¡ï¼ˆuser_risk_profilesï¼‰

### è®¾è®¡ç›®æ ‡
- æ”¯æŒæŒ‰**ç”¨æˆ·**æˆ–**ç”¨æˆ·ç­‰çº§**é…ç½®ä¸ªæ€§åŒ–é£æ§é˜ˆå€¼
- è¦†ç›–ç³»ç»Ÿé»˜è®¤å€¼ï¼ˆ`system_settings`ï¼‰ï¼Œå®ç°ç™½åå•æé¢
- è¿è¥åå°å¯è§†åŒ–ç®¡ç†ï¼Œä¸å…è®¸ç¡¬ç¼–ç 
- **JSON å­˜å‚¨é˜ˆå€¼**ï¼šæ–°å¸ç§ä¸Šçº¿ä¸æ”¹è¡¨

### users è¡¨æ–°å¢å­—æ®µ

```sql
-- åœ¨ users è¡¨æ–°å¢ user_level å­—æ®µï¼ˆç­‰çº§å”¯ä¸€æƒå¨æ¥æºï¼‰
ALTER TABLE users ADD COLUMN user_level VARCHAR(50) DEFAULT 'normal' 
  COMMENT 'ç”¨æˆ·ç­‰çº§ï¼šnormal/vip/merchant';
ALTER TABLE users ADD INDEX idx_user_level (user_level);
```

### è¡¨ç»“æ„è®¾è®¡ï¼ˆJSON å¯æ‰©å±•ç‰ˆï¼‰

```sql
CREATE TABLE user_risk_profiles (
  id INT PRIMARY KEY AUTO_INCREMENT,
  
  -- é…ç½®ç›®æ ‡ï¼ˆäºŒé€‰ä¸€ï¼‰
  user_id INT NULL COMMENT 'æŒ‡å®šç”¨æˆ·IDï¼ˆä¸user_leveläº’æ–¥ï¼‰',
  user_level VARCHAR(50) NULL COMMENT 'ç”¨æˆ·ç­‰çº§ï¼ˆå¦‚: vip, merchant, normalï¼‰',
  
  -- ========== é˜ˆå€¼é…ç½®ï¼ˆJSON å¯æ‰©å±•ï¼‰ ==========
  daily_limits_json JSON NULL COMMENT 'æ—¥é™é¢é…ç½®ï¼ŒæŒ‰å¸ç§å­˜å‚¨',
  -- æ ¼å¼ç¤ºä¾‹ï¼š
  -- {
  --   "DIAMOND": { "listings": 50, "trades": 30, "amount": 500000 },
  --   "red_shard": { "listings": 50, "trades": 30, "amount": 200000 }
  -- }
  
  -- å…‘æ¢å¸‚åœºé™é¢ï¼ˆJSON é¢„ç•™ï¼‰
  exchange_limits_json JSON NULL COMMENT 'å…‘æ¢å¸‚åœºé™é¢é…ç½®',
  -- æ ¼å¼ç¤ºä¾‹ï¼š{ "max_orders": 10, "max_amount": 100000 }
  
  -- ========== å†»ç»“çŠ¶æ€ï¼ˆscopes + asset_codes åˆ†ç¦»ï¼‰ ==========
  is_frozen TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦è¢«å†»ç»“',
  frozen_scopes JSON NULL COMMENT 'å†»ç»“åŠŸèƒ½èŒƒå›´',
  -- å¯é€‰å€¼ï¼š["market_listing","market_buy","market_withdraw",
  --         "exchange_order","exchange_redeem","transfer","convert","full_site"]
  frozen_asset_codes JSON NULL COMMENT 'å†»ç»“å¸ç§èŒƒå›´',
  -- ç¤ºä¾‹ï¼š["red_shard"] æˆ– ["DIAMOND","red_shard"] æˆ– null(=å…¨éƒ¨)
  frozen_reason VARCHAR(500) NULL COMMENT 'å†»ç»“åŸå› ',
  frozen_at DATETIME NULL COMMENT 'å†»ç»“æ—¶é—´',
  frozen_by INT NULL COMMENT 'å†»ç»“æ“ä½œäºº',
  
  -- ========== å…ƒæ•°æ® ==========
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  created_by INT NULL COMMENT 'åˆ›å»ºäºº',
  updated_by INT NULL COMMENT 'æœ€åä¿®æ”¹äºº',
  
  -- ========== çº¦æŸ ==========
  UNIQUE KEY uk_user_id (user_id),
  UNIQUE KEY uk_user_level (user_level),
  INDEX idx_is_frozen (is_frozen)
  
  -- æ³¨æ„ï¼šMySQL 5.7 ä¼šå¿½ç•¥ CHECK çº¦æŸï¼Œéœ€åœ¨åº”ç”¨å±‚ä¿è¯ user_id/user_level äºŒé€‰ä¸€
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·é£æ§é…ç½®è¡¨ï¼ˆJSONå¯æ‰©å±•ç‰ˆï¼‰';
```

### é…ç½®ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰

| ä¼˜å…ˆçº§ | é…ç½®æ¥æº | è¯´æ˜ |
| --- | --- | --- |
| 1ï¼ˆæœ€é«˜ï¼‰ | `user_risk_profiles` WHERE `user_id = ?` | ç”¨æˆ·çº§ä¸ªæ€§åŒ–é…ç½® |
| 2 | `user_risk_profiles` WHERE `user_level = ?` | ç”¨æˆ·ç­‰çº§é…ç½®ï¼ˆéœ€è¦å…³è”ç”¨æˆ·ç­‰çº§å­—æ®µï¼‰ |
| 3ï¼ˆæœ€ä½ï¼‰ | `system_settings` WHERE `setting_key = 'daily_max_*'` | ç³»ç»Ÿé»˜è®¤é…ç½® |

### é˜ˆå€¼è¯»å–ä¼ªä»£ç ï¼ˆJSON ç‰ˆï¼‰

```javascript
/**
 * è·å–ç”¨æˆ·æ—¥é™é¢ï¼ˆJSON å¯æ‰©å±•ç‰ˆï¼‰
 * @param {number} userId - ç”¨æˆ·ID
 * @param {string} limitType - é™é¢ç±»å‹ï¼šlistings / trades / amount
 * @param {string} assetCode - å¸ç§ä»£ç ï¼šDIAMOND / red_shard
 * @returns {number|null} é™é¢å€¼
 */
async function getDailyLimit(userId, limitType, assetCode) {
  // 1. å°è¯•è¯»å–ç”¨æˆ·çº§é…ç½®
  const userProfile = await UserRiskProfile.findOne({ where: { user_id: userId } });
  if (userProfile?.daily_limits_json?.[assetCode]?.[limitType] !== undefined) {
    return userProfile.daily_limits_json[assetCode][limitType];
  }
  
  // 2. å°è¯•è¯»å–ç­‰çº§é…ç½®ï¼ˆä» users.user_level è·å–ï¼‰
  const user = await User.findByPk(userId, { attributes: ['user_level'] });
  if (user?.user_level) {
    const levelProfile = await UserRiskProfile.findOne({ 
      where: { user_level: user.user_level } 
    });
    if (levelProfile?.daily_limits_json?.[assetCode]?.[limitType] !== undefined) {
      return levelProfile.daily_limits_json[assetCode][limitType];
    }
  }
  
  // 3. å›é€€åˆ°ç³»ç»Ÿé»˜è®¤
  return await SystemSettings.get('marketplace', `daily_max_${limitType}_${assetCode}`);
}

/**
 * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«å†»ç»“æŸåŠŸèƒ½+æŸå¸ç§
 * @param {number} userId - ç”¨æˆ·ID
 * @param {string} scope - åŠŸèƒ½èŒƒå›´ï¼šmarket_listing / market_buy / exchange_order ...
 * @param {string} assetCode - å¸ç§ä»£ç ï¼ˆå¯é€‰ï¼Œnull=æ£€æŸ¥å…¨éƒ¨ï¼‰
 * @returns {boolean} æ˜¯å¦è¢«å†»ç»“
 */
async function isUserFrozen(userId, scope, assetCode = null) {
  const userProfile = await UserRiskProfile.findOne({ where: { user_id: userId } });
  
  if (!userProfile?.is_frozen) return false;
  
  // æ£€æŸ¥åŠŸèƒ½èŒƒå›´
  const scopes = userProfile.frozen_scopes || [];
  if (!scopes.includes(scope) && !scopes.includes('full_site')) {
    return false; // è¯¥åŠŸèƒ½æœªè¢«å†»ç»“
  }
  
  // æ£€æŸ¥å¸ç§èŒƒå›´ï¼ˆnull = å…¨éƒ¨å¸ç§ï¼‰
  const assetCodes = userProfile.frozen_asset_codes;
  if (assetCode && assetCodes && !assetCodes.includes(assetCode)) {
    return false; // è¯¥å¸ç§æœªè¢«å†»ç»“
  }
  
  return true; // è¢«å†»ç»“
}
```

### è¿è¥åå°ç®¡ç†èƒ½åŠ›

| åŠŸèƒ½ | è¯´æ˜ |
| --- | --- |
| **æŸ¥çœ‹é…ç½®** | æŒ‰ç”¨æˆ· ID / ç”¨æˆ·ç­‰çº§ æœç´¢ï¼Œå±•ç¤ºå½“å‰ç”Ÿæ•ˆçš„é˜ˆå€¼ï¼ˆå«ç»§æ‰¿æ¥æºï¼‰ |
| **æ–°å¢/ç¼–è¾‘** | ä¸ºæŒ‡å®šç”¨æˆ·æˆ–ç­‰çº§è®¾ç½®é˜ˆå€¼è¦†ç›–ï¼Œç•™ç©ºè¡¨ç¤ºç»§æ‰¿ä¸Šçº§ |
| **æ‰¹é‡å¯¼å…¥** | æ”¯æŒ CSV æ‰¹é‡å¯¼å…¥ç”¨æˆ·çº§é…ç½® |
| **å†»ç»“ç®¡ç†** | è®¾ç½® `is_frozen`ã€`frozen_scopes`ã€`frozen_reason` |
| **å˜æ›´å®¡è®¡** | æ‰€æœ‰ä¿®æ”¹è®°å½•åˆ°å®¡è®¡æ—¥å¿— |

### é¢„ç½®ç­‰çº§é…ç½®ï¼ˆJSON ç‰ˆï¼‰

```sql
-- é¢„ç½®ç­‰çº§é…ç½®ï¼ˆJSON æ ¼å¼ï¼‰
INSERT INTO user_risk_profiles (user_level, daily_limits_json, created_at) VALUES
  -- æ™®é€šç”¨æˆ·ï¼šç”¨ç³»ç»Ÿé»˜è®¤ï¼ˆnull = ç»§æ‰¿ï¼‰
  ('normal', NULL, NOW()),
  
  -- VIPï¼š2.5å€æé¢
  ('vip', '{
    "DIAMOND": { "listings": 50, "trades": 30, "amount": 500000 },
    "red_shard": { "listings": 50, "trades": 30, "amount": 200000 }
  }', NOW()),
  
  -- è®¤è¯å•†å®¶ï¼š5å€æé¢
  ('merchant', '{
    "DIAMOND": { "listings": 100, "trades": 50, "amount": 1000000 },
    "red_shard": { "listings": 100, "trades": 50, "amount": 500000 }
  }', NOW());
```

### JSON é˜ˆå€¼å­—æ®µè¯´æ˜

| å­—æ®µè·¯å¾„ | ç±»å‹ | NULL/ç¼ºå¤±è¯­ä¹‰ | è¯´æ˜ |
| --- | --- | --- | --- |
| `daily_limits_json` | JSON | NULL = å…¨éƒ¨ç»§æ‰¿ç³»ç»Ÿé»˜è®¤ | æ•´ä¸ªé˜ˆå€¼é…ç½® |
| `daily_limits_json.{asset_code}` | object | ç¼ºå¤± = è¯¥å¸ç§ç»§æ‰¿ç³»ç»Ÿé»˜è®¤ | æŸå¸ç§çš„é˜ˆå€¼é…ç½® |
| `daily_limits_json.{asset_code}.listings` | int | ç¼ºå¤± = ç»§æ‰¿ç³»ç»Ÿé»˜è®¤ | è¯¥å¸ç§æ—¥æŒ‚å•æ¬¡æ•°ä¸Šé™ |
| `daily_limits_json.{asset_code}.trades` | int | ç¼ºå¤± = ç»§æ‰¿ç³»ç»Ÿé»˜è®¤ | è¯¥å¸ç§æ—¥æˆäº¤æ¬¡æ•°ä¸Šé™ |
| `daily_limits_json.{asset_code}.amount` | bigint | ç¼ºå¤± = ç»§æ‰¿ç³»ç»Ÿé»˜è®¤ | è¯¥å¸ç§æ—¥æˆäº¤é¢ä¸Šé™ï¼ˆgross_amountï¼‰ |

### å†»ç»“å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | NULL/ç©ºå€¼è¯­ä¹‰ | è¯´æ˜ |
| --- | --- | --- | --- |
| `frozen_scopes` | JSON array | NULL/[] = æœªå†»ç»“ä»»ä½•åŠŸèƒ½ | å†»ç»“çš„åŠŸèƒ½åˆ—è¡¨ |
| `frozen_asset_codes` | JSON array / null | **null = å…¨å¸ç§å†»ç»“**<br>[] = ä¸å†»ç»“ä»»ä½•å¸ç§ | å†»ç»“çš„å¸ç§èŒƒå›´ |

#### frozen_scopes å¯é€‰å€¼

| å€¼ | åˆ†ç±» | è¯´æ˜ |
| --- | --- | --- |
| `market_listing` | æ–°å¢æ•å£ | ç¦æ­¢åˆ›å»ºæ–°æŒ‚ç‰Œ |
| `market_buy` | æ–°å¢æ•å£ | ç¦æ­¢ä¸‹å•è´­ä¹° |
| `exchange_order` | æ–°å¢æ•å£ | ç¦æ­¢åˆ›å»ºå…‘æ¢è®¢å• |
| `exchange_redeem` | æ–°å¢æ•å£ | ç¦æ­¢æ ¸é”€ç ä½¿ç”¨ |
| `transfer` | æ–°å¢æ•å£ | ç¦æ­¢ç”¨æˆ·é—´è½¬è´¦ |
| `convert` | æ–°å¢æ•å£ | ç¦æ­¢èµ„äº§ç±»å‹è½¬æ¢ |
| `full_site` | æ–°å¢æ•å£ | å…¨ç«™å†»ç»“ï¼ˆè¦†ç›–ä»¥ä¸Šæ‰€æœ‰æ–°å¢æ•å£æ“ä½œï¼‰|

#### âš ï¸ æ°¸è¿œä¸æ‹¦çš„"é€€å‡ºé€šé“"ï¼ˆå³ä½¿ full_site ä¹Ÿæ”¾è¡Œï¼‰

| æ“ä½œ | è¯´æ˜ |
| --- | --- |
| `market_withdraw` | æ’¤å›æŒ‚ç‰Œï¼ˆé™ä½æ•å£ï¼‰|
| `order_cancel` | å–æ¶ˆè®¢å•ï¼ˆé™ä½æ•å£ï¼‰|
| `refund_rollback` | è¿è¥é€€æ¬¾/å›æ»šï¼ˆäº‹æ•…å¤„ç½®ï¼‰|

---

## ğŸ“Œ å¾…åŠäº‹é¡¹æ¸…å•ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰

### P0 - æ•°æ®åº“é…ç½®ï¼ˆéƒ¨åˆ†å®Œæˆ - è¿ç§» 20260114005930 å·²æ‰§è¡Œï¼ŒåŒç™½åå•å¾…æ–°å¢ï¼‰

| åºå· | ä»»åŠ¡                                          | çŠ¶æ€      | SQL/å¤‡æ³¨                       |
| ---- | --------------------------------------------- | --------- | ------------------------------ |
| 1    | åœ¨ `material_asset_types` ä¸­æ·»åŠ  DIAMOND è®°å½• | âœ… å·²å®Œæˆ | `is_tradable=1, is_enabled=1` |
| 2    | æ·»åŠ  `allowed_settlement_assets` é…ç½®         | âœ… å·²å®Œæˆ | `["DIAMOND","red_shard"]`ï¼ˆç»“ç®—ç™½åå•ï¼‰|
| 2.1  | **æ·»åŠ  `allowed_listing_assets` é…ç½®**        | âŒ å¾…å®Œæˆ | `["DIAMOND","red_shard"]`ï¼ˆæŒ‚ç‰Œç™½åå•ï¼ŒåŒç™½åå•æ–°å¢ï¼‰|
| 2.2  | **users è¡¨æ·»åŠ  `user_level` å­—æ®µ**            | âŒ å¾…å®Œæˆ | ç”¨æˆ·ç­‰çº§å”¯ä¸€æƒå¨æ¥æºï¼Œé»˜è®¤ `normal` |
| 2.3  | **åˆ›å»º `user_risk_profiles` è¡¨**              | âŒ å¾…å®Œæˆ | JSON å¯æ‰©å±•ç‰ˆï¼ˆé˜ˆå€¼+å†»ç»“ç®¡ç†ï¼‰|
| 2.4  | **é¢„ç½®ç­‰çº§é…ç½®æ•°æ®**                          | âŒ å¾…å®Œæˆ | normal/vip/merchant ä¸‰ä¸ªç­‰çº§çš„ JSON é˜ˆå€¼ |
| 3    | æ·»åŠ  `fee_rate_DIAMOND` é…ç½®                  | âœ… å·²å®Œæˆ | `0.05`ï¼ˆ5%åˆ†æ¡£é€»è¾‘ï¼‰           |
| 4    | æ·»åŠ  `fee_rate_red_shard` é…ç½®                | âœ… å·²å®Œæˆ | `0.05`ï¼ˆ5%å•ä¸€è´¹ç‡ï¼‰           |
| 5    | æ·»åŠ  `fee_min_DIAMOND` é…ç½®                   | âœ… å·²å®Œæˆ | `1`                            |
| 6    | æ·»åŠ  `fee_min_red_shard` é…ç½®                 | âœ… å·²å®Œæˆ | `1`                            |
| 7    | æ·»åŠ  `min_price_red_shard` é…ç½®               | âœ… å·²å®Œæˆ | `1`ï¼ˆç¡¬å…œåº•ä¸‹é™ï¼‰              |
| 8    | æ·»åŠ  `max_price_red_shard` é…ç½®               | âœ… å·²å®Œæˆ | `1000000`ï¼ˆç¡¬å…œåº•ä¸Šé™ï¼‰        |

**SQL å‚è€ƒ**ï¼š

```sql
-- 1. æ·»åŠ  DIAMOND åˆ° material_asset_types
INSERT INTO material_asset_types (asset_code, display_name, group_code, form, tier, is_tradable, is_enabled)
VALUES ('DIAMOND', 'é’»çŸ³', 'DIAMOND_GROUP', 'currency', 1, 1, 1)
ON DUPLICATE KEY UPDATE is_tradable=1, is_enabled=1;

-- 2. æ·»åŠ å¤šå¸ç§ç›¸å…³é…ç½®
INSERT INTO system_settings (category, setting_key, setting_value, data_type, description, is_visible, is_readonly)
VALUES
  ('marketplace', 'allowed_settlement_assets', '["DIAMOND","red_shard"]', 'json', 'äº¤æ˜“å¸‚åœºå…è®¸çš„ç»“ç®—å¸ç§ç™½åå•ï¼ˆæ§åˆ¶æˆäº¤/ç»“ç®—ï¼‰', 1, 0),
  ('marketplace', 'fee_rate_DIAMOND', '0.05', 'number', 'DIAMONDç»“ç®—æ‰‹ç»­è´¹ç‡ï¼ˆ5%ï¼Œä¿æŒåˆ†æ¡£é€»è¾‘ï¼‰', 1, 0),
  ('marketplace', 'fee_rate_red_shard', '0.05', 'number', 'red_shardç»“ç®—æ‰‹ç»­è´¹ç‡ï¼ˆ5%ï¼Œå•ä¸€è´¹ç‡ï¼‰', 1, 0),
  ('marketplace', 'fee_min_DIAMOND', '1', 'number', 'DIAMONDæœ€ä½æ‰‹ç»­è´¹', 1, 0),
  ('marketplace', 'fee_min_red_shard', '1', 'number', 'red_shardæœ€ä½æ‰‹ç»­è´¹', 1, 0),
  ('marketplace', 'min_price_red_shard', '1', 'number', 'red_shardæœ€ä½æŒ‚ç‰Œä»·ï¼ˆç¡¬å…œåº•ï¼‰', 1, 0),
  ('marketplace', 'max_price_red_shard', '1000000', 'number', 'red_shardæœ€é«˜æŒ‚ç‰Œä»·ï¼ˆç¡¬å…œåº•ï¼‰', 1, 0);

-- 3. ã€æ–°å¢ã€‘åŒç™½åå• - æŒ‚ç‰Œç™½åå•ï¼ˆæ§åˆ¶æ–°æŒ‚ç‰Œå‡†å…¥ï¼‰
INSERT INTO system_settings (category, setting_key, setting_value, data_type, description, is_visible, is_readonly)
VALUES
  ('marketplace', 'allowed_listing_assets', '["DIAMOND","red_shard"]', 'json', 'äº¤æ˜“å¸‚åœºå…è®¸çš„æŒ‚ç‰Œå¸ç§ç™½åå•ï¼ˆæ§åˆ¶æ–°æŒ‚ç‰Œå‡†å…¥ï¼‰', 1, 0)
ON DUPLICATE KEY UPDATE setting_value='["DIAMOND","red_shard"]';
```

---

### P1 - é£æ§é…ç½®ï¼ˆâœ… æ•°æ®åº“å·²å®Œæˆï¼ŒâŒ ä»£ç æ‰§è¡Œæœªå®ç°ï¼‰

| åºå· | ä»»åŠ¡                                     | çŠ¶æ€      | SQL/å¤‡æ³¨                 |
| ---- | ---------------------------------------- | --------- | ------------------------ |
| 9    | æ·»åŠ  `daily_max_listings_DIAMOND` é…ç½®   | âœ… å·²å®Œæˆ | `20`ï¼ˆæ—¥æŒ‚å•ä¸Šé™ï¼‰- æŒ‰å–å®¶+å¸ç§ |
| 10   | æ·»åŠ  `daily_max_listings_red_shard` é…ç½® | âœ… å·²å®Œæˆ | `20` - æŒ‰å–å®¶+å¸ç§       |
| 11   | æ·»åŠ  `daily_max_trades_DIAMOND` é…ç½®     | âœ… å·²å®Œæˆ | `10`ï¼ˆæ—¥æˆäº¤ä¸Šé™ï¼‰- æŒ‰ä¹°å®¶+å¸ç§ |
| 12   | æ·»åŠ  `daily_max_trades_red_shard` é…ç½®   | âœ… å·²å®Œæˆ | `10` - æŒ‰ä¹°å®¶+å¸ç§       |
| 13   | æ·»åŠ  `daily_max_amount_DIAMOND` é…ç½®     | âœ… å·²å®Œæˆ | `100000`ï¼ˆæ—¥æˆäº¤é¢ä¸Šé™ï¼Œgross_amountï¼‰- æŒ‰ä¹°å®¶+å¸ç§ |
| 14   | æ·»åŠ  `daily_max_amount_red_shard` é…ç½®   | âœ… å·²å®Œæˆ | `50000`ï¼ˆgross_amountï¼‰- æŒ‰ä¹°å®¶+å¸ç§ |

**SQL å‚è€ƒ**ï¼š

```sql
INSERT INTO system_settings (category, setting_key, setting_value, data_type, description, is_visible, is_readonly)
VALUES
  ('marketplace', 'daily_max_listings_DIAMOND', '20', 'number', 'DIAMONDæ—¥æŒ‚å•æ¬¡æ•°ä¸Šé™', 1, 0),
  ('marketplace', 'daily_max_listings_red_shard', '20', 'number', 'red_shardæ—¥æŒ‚å•æ¬¡æ•°ä¸Šé™', 1, 0),
  ('marketplace', 'daily_max_trades_DIAMOND', '10', 'number', 'DIAMONDæ—¥æˆäº¤æ¬¡æ•°ä¸Šé™', 1, 0),
  ('marketplace', 'daily_max_trades_red_shard', '10', 'number', 'red_shardæ—¥æˆäº¤æ¬¡æ•°ä¸Šé™', 1, 0),
  ('marketplace', 'daily_max_amount_DIAMOND', '100000', 'number', 'DIAMONDæ—¥æˆäº¤é¢ä¸Šé™', 1, 0),
  ('marketplace', 'daily_max_amount_red_shard', '50000', 'number', 'red_shardæ—¥æˆäº¤é¢ä¸Šé™', 1, 0);
```

---

### P2 - æœåŠ¡å±‚æ”¹é€ ï¼ˆéƒ¨åˆ†å®Œæˆï¼‰

| åºå· | ä»»åŠ¡                                                     | æ–‡ä»¶ä½ç½®                                | çŠ¶æ€      | æ”¹é€ è¯´æ˜                                      |
| ---- | -------------------------------------------------------- | --------------------------------------- | --------- | --------------------------------------------- |
| 15   | FeeCalculator æ–°å¢ `calculateFeeByAsset()` æ–¹æ³•          | `services/FeeCalculator.js`             | âœ… å·²å®Œæˆ | DIAMONDåˆ†æ¡£(ceil)ï¼Œred_shardå•ä¸€è´¹ç‡(floor+æœ€ä½1) |
| 16   | TradeOrderService ç§»é™¤ DIAMOND ç¡¬ç¼–ç æ ¡éªŒ                | `services/TradeOrderService.js`         | âœ… å·²å®Œæˆ | æ”¹ä¸ºä» `allowed_settlement_assets` ç™½åå•æ ¡éªŒ |
| 17   | TradeOrderService æ‰‹ç»­è´¹è®¡ç®—æ”¹ç”¨ `calculateFeeByAsset()` | `services/TradeOrderService.js`         | âœ… å·²å®Œæˆ | æ ¹æ® `listing.price_asset_code` é€‰æ‹©è®¡è´¹æ¨¡å¼  |
| 18   | **MarketListingService æ–°å¢å¸ç§ç™½åå•æ ¡éªŒ**              | `services/MarketListingService.js`      | âŒ å¾…å®Œæˆ | æ ¡éªŒ `price_asset_code` æ˜¯å¦åœ¨ç™½åå•ï¼ˆé˜²è„æŒ‚ç‰Œï¼‰|
| 19   | **MarketListingService æ–°å¢ä»·æ ¼åŒºé—´æ ¡éªŒ**                | `services/MarketListingService.js`      | âŒ å¾…å®Œæˆ | red_shard ä»·æ ¼å¿…é¡»åœ¨ [1, 1000000]             |
| 20   | **MarketListingService æ–°å¢åŒç‰©å•å¸æ ¡éªŒ**                | `services/MarketListingService.js`      | âŒ å¾…å®Œæˆ | è¡Œé”é˜²æ­¢åŒä¸€ç‰©å“å¤šå¸ç§æŒ‚ç‰Œï¼ˆé˜²å¾¡å¼æ ¡éªŒï¼‰      |

**FeeCalculator.calculateFeeByAsset() è®¾è®¡å‚è€ƒ**ï¼š

```javascript
/**
 * æ ¹æ®ç»“ç®—å¸ç§è®¡ç®—æ‰‹ç»­è´¹ï¼ˆå¤šå¸ç§æ‰©å±•ç‰ˆï¼‰
 *
 * @param {string} asset_code - ç»“ç®—å¸ç§ä»£ç ï¼ˆDIAMOND/red_shardï¼‰
 * @param {number} itemValue - å•†å“ä»·å€¼ï¼ˆç”¨äºDIAMONDåˆ†æ¡£ï¼‰
 * @param {number} sellingPrice - ç”¨æˆ·å®šä»·
 * @returns {Object} { fee_amount, fee_rate, net_amount, calculation_mode }
 */
static calculateFeeByAsset(asset_code, itemValue, sellingPrice) {
  if (asset_code === 'DIAMOND') {
    // ä¿æŒç°çŠ¶åˆ†æ¡£é€»è¾‘ï¼ˆåŸºäº itemValue æŸ¥è¡¨ + ceil + æœ€ä½è´¹ 1ï¼‰
    return this.calculateItemFee(itemValue, sellingPrice);
  } else if (asset_code === 'red_shard') {
    // å•ä¸€è´¹ç‡æ¨¡å¼ï¼ˆä» system_settings è¯»å– fee_rate_red_shardï¼‰
    const fee_rate = await SystemSettings.get('marketplace', 'fee_rate_red_shard') || 0.05;
    const fee_min = await SystemSettings.get('marketplace', 'fee_min_red_shard') || 1;

    let fee = Math.floor(sellingPrice * fee_rate); // floor å–æ•´ï¼ˆä¸æ˜¯ ceilï¼‰
    if (fee < fee_min) fee = fee_min;

    return {
      fee: fee,
      rate: fee_rate,
      net_amount: sellingPrice - fee,
      calculation_mode: 'flat' // å•ä¸€è´¹ç‡
    };
  } else {
    throw new Error(`ä¸æ”¯æŒçš„ç»“ç®—å¸ç§: ${asset_code}`);
  }
}
```

**åŒç‰©å•å¸æ ¡éªŒè®¾è®¡å‚è€ƒ**ï¼š

```javascript
// åœ¨ MarketListingService.createListing() äº‹åŠ¡å†…
const item = await ItemInstance.findOne({
  where: { item_instance_id },
  lock: transaction.LOCK.UPDATE, // ğŸ”¥ è¡Œçº§é”ï¼ˆé˜²å¹¶å‘åŒæŒ‚ï¼‰
  transaction
})

const existingListing = await MarketListing.findOne({
  where: {
    offer_item_instance_id: item_instance_id,
    status: { [Op.in]: ['on_sale', 'locked'] }
  },
  transaction
})

if (existingListing && existingListing.price_asset_code !== price_asset_code) {
  throw new Error(`è¯¥ç‰©å“å·²ä»¥ ${existingListing.price_asset_code} æŒ‚ç‰Œï¼Œä¸å…è®¸æ›´æ¢å¸ç§`)
}
```

---

### P3 - è·¯ç”±å±‚æ”¹é€ ï¼ˆéƒ¨åˆ†å®Œæˆï¼‰

| åºå· | ä»»åŠ¡                                 | æ–‡ä»¶ä½ç½®                       | çŠ¶æ€      | æ”¹é€ è¯´æ˜                           |
| ---- | ------------------------------------ | ------------------------------ | --------- | ---------------------------------- |
| 21   | sell.js æ¥å— `price_asset_code` å‚æ•° | `routes/v4/market/sell.js`     | âœ… å·²å®Œæˆ | å·²ä» `req.body.price_asset_code` è·å–ï¼Œé»˜è®¤ DIAMOND |
| 22   | **æ–°å¢é£æ§é™é¢ä¸­é—´ä»¶**               | `routes/v4/market/`            | âŒ å¾…å®Œæˆ | Redis é¢„å +å›æ»šï¼ˆfail-closedï¼Œæ’¤å›ä¸å—å½±å“ï¼‰|
| 23   | **é…ç½®æ²»ç†ç™½åå•æ›´æ–°**               | `config/system-settings-whitelist.js` | âŒ å¾…å®Œæˆ | æ–°å¢ fee_rate_*/daily_max_*/min_price_*/max_price_* |

**è·¯ç”±å±‚æ”¹é€ å‚è€ƒ**ï¼š

```javascript
// routes/v4/market/sell.js
// æ”¹é€ å‰ï¼š
price_asset_code: 'DIAMOND'

// æ”¹é€ åï¼š
price_asset_code: req.body.price_asset_code || 'DIAMOND' // é»˜è®¤ DIAMONDï¼Œå…¼å®¹æ—§ç‰ˆ
```

**API å‚æ•°å˜æ›´**ï¼š

```
POST /api/v4/market/listings

Request Body:
{
  "item_instance_id": 123,
  "price_amount": 1000,
  "price_asset_code": "red_shard"  // æ–°å¢å‚æ•°ï¼Œå¯é€‰ï¼Œé»˜è®¤ DIAMOND
}
```

---

### P4 - æµ‹è¯•ä¸éªŒè¯

| åºå· | ä»»åŠ¡                   | çŠ¶æ€      | å¤‡æ³¨                             |
| ---- | ---------------------- | --------- | -------------------------------- |
| 25   | ç¼–å†™å¤šå¸ç§äº¤æ˜“é›†æˆæµ‹è¯• | âŒ å¾…å®Œæˆ | æµ‹è¯• red_shard æŒ‚ç‰Œ/è´­ä¹°æµç¨‹     |
| 26   | éªŒè¯æ‰‹ç»­è´¹è®¡ç®—æ­£ç¡®æ€§   | âŒ å¾…å®Œæˆ | DIAMONDåˆ†æ¡£ vs red_shardå•ä¸€è´¹ç‡ |
| 27   | éªŒè¯é£æ§é™åˆ¶ç”Ÿæ•ˆ       | âŒ å¾…å®Œæˆ | æ—¥é™æ¬¡/é™é¢                      |

---

## ğŸ“Š å®ç°è¿›åº¦ç»Ÿè®¡ï¼ˆ2026-01-15 æ›´æ–°ï¼‰

| ç±»åˆ«                | å·²å®Œæˆ   | å¾…å®Œæˆ | å®Œæˆç‡ |
| ------------------- | -------- | ------ | ------ |
| æ•°æ®åº“è¡¨ç»“æ„        | 2/4      | 2      | 50%    |
| æ•°æ®åº“é…ç½®ï¼ˆP0+P1ï¼‰ | 14/18    | 4      | 78%    |
| æœåŠ¡å±‚æ”¹é€ ï¼ˆP2ï¼‰    | 3/6      | 3      | 50%    |
| è·¯ç”±å±‚æ”¹é€ ï¼ˆP3ï¼‰    | 1/3      | 2      | 33%    |
| æµ‹è¯•éªŒè¯ï¼ˆP4ï¼‰      | 0/3      | 3      | 0%     |
| **æ€»è®¡**            | **20/34** | **14** | **59%** |

### ğŸ”´ å…³é”®ç¼ºå£ï¼ˆä¸Šçº¿ red_shard å‰å¿…é¡»å®Œæˆï¼‰

| ç¼ºå£ | é£é™©ç­‰çº§ | è¯´æ˜ |
| --- | --- | --- |
| **æ–°å¢ `allowed_listing_assets` é…ç½®** | ğŸ”´ é«˜ | åŒç™½åå•æœºåˆ¶ä¾èµ–ï¼Œå¦åˆ™æ— æ³•å®ç°"ç¦æ–°æŒ‚ç‰Œã€å­˜é‡å¯æˆäº¤" |
| **users è¡¨æ·»åŠ  `user_level` å­—æ®µ** | ğŸ”´ é«˜ | ç”¨æˆ·ç­‰çº§å”¯ä¸€æƒå¨æ¥æºï¼Œç™½åå•æé¢ä¾èµ– |
| **åˆ›å»º `user_risk_profiles` è¡¨ï¼ˆJSONç‰ˆï¼‰** | ğŸ”´ é«˜ | ç™½åå•æé¢ + ç”¨æˆ·å†»ç»“ç®¡ç†ä¾èµ– |
| MarketListingService å¸ç§ç™½åå•æ ¡éªŒ | ğŸ”´ é«˜ | éœ€æ”¹ç”¨ `allowed_listing_assets` æ ¡éªŒæŒ‚ç‰Œå‡†å…¥ |
| MarketListingService ä»·æ ¼åŒºé—´æ ¡éªŒ | ğŸ”´ é«˜ | red_shard æç«¯ä»·æ ¼ä¸ä¼šè¢«æ‹¦æˆª |
| é£æ§é™é¢æ‰§è¡Œï¼ˆRedisï¼‰ | ğŸ”´ é«˜ | daily_max_* é…ç½®æœªè¢«æ¶ˆè´¹ï¼Œæ— æ³•æŒ¡åˆ· |
| é…ç½®æ²»ç†ç™½åå• | ğŸŸ¡ ä¸­ | è¿è¥åå°æ— æ³•è°ƒæ•´è´¹ç‡/é˜ˆå€¼/åŒç™½åå• |
| MarketListingService åŒç‰©å•å¸æ ¡éªŒ | ğŸŸ¢ ä½ | ç°æœ‰ item çŠ¶æ€æœºå·²å¤©ç„¶é˜²æ­¢ï¼ˆé˜²å¾¡æ€§å¢å¼ºï¼‰ |

---

## ğŸš€ å»ºè®®å®æ–½é¡ºåº

### é˜¶æ®µä¸€ï¼šæ•°æ®åº“è¿ç§»ï¼ˆé¢„è®¡ 1-2 å°æ—¶ï¼‰

1. åˆ›å»ºè¿ç§»æ–‡ä»¶ `add-marketplace-multi-currency-config.js`
2. æ·»åŠ  DIAMOND åˆ° `material_asset_types`
3. æ·»åŠ æ‰€æœ‰ `system_settings` é…ç½®é¡¹ï¼ˆP0 + P1 å…± 14 é¡¹ï¼‰
4. æ‰§è¡Œè¿ç§»å¹¶éªŒè¯

### é˜¶æ®µäºŒï¼šFeeCalculator æ‰©å±•ï¼ˆé¢„è®¡ 2-3 å°æ—¶ï¼‰

1. æ–°å¢ `calculateFeeByAsset()` æ–¹æ³•
2. æ”¯æŒä» `system_settings` è¯»å–å¸ç§è´¹ç‡
3. ç¼–å†™å•å…ƒæµ‹è¯•éªŒè¯ DIAMONDåˆ†æ¡£ å’Œ red_shardå•ä¸€è´¹ç‡

### é˜¶æ®µä¸‰ï¼šService å±‚æ”¹é€ ï¼ˆé¢„è®¡ 3-4 å°æ—¶ï¼‰

1. æ”¹é€  `TradeOrderService` ç§»é™¤ç¡¬ç¼–ç 
2. æ”¹é€  `MarketListingService` æ–°å¢æ ¡éªŒé€»è¾‘
3. å®ç°åŒç‰©å•å¸æ ¡éªŒï¼ˆè¡Œé”é˜²å¹¶å‘ï¼‰

### é˜¶æ®µå››ï¼šRoute å±‚æ”¹é€ ï¼ˆé¢„è®¡ 1-2 å°æ—¶ï¼‰

1. æ”¹é€  `sell.js` æ¥å— `price_asset_code` å‚æ•°
2. æ–°å¢é£æ§æ ¡éªŒä¸­é—´ä»¶

### é˜¶æ®µäº”ï¼šé›†æˆæµ‹è¯•ï¼ˆé¢„è®¡ 2-3 å°æ—¶ï¼‰

1. ç¼–å†™ç«¯åˆ°ç«¯æµ‹è¯•ç”¨ä¾‹
2. éªŒè¯å®Œæ•´æµç¨‹
3. éªŒè¯è¾¹ç•Œæƒ…å†µå’Œé”™è¯¯å¤„ç†

---

## ğŸ” é£é™©æ§åˆ¶ä¸å®‰å…¨å»ºè®®

### é˜²å¥—åˆ©æœºåˆ¶

- **ä»·æ ¼ç¡¬å…œåº•**ï¼šred_shard ä»·æ ¼å¿…é¡»åœ¨ [1, 1000000]ï¼Œè¶…å‡ºç›´æ¥æ‹’ç»
- **æ—¥é™æ¬¡/é™é¢**ï¼š
  - æŒ‚å•æ¬¡æ•°ï¼šæŒ‰ **å–å®¶+å¸ç§** è®¡æ•°ï¼ˆé˜²åˆ·ä¸Šæ¶/æ’¤å›ï¼‰
  - æˆäº¤æ¬¡æ•°/æˆäº¤é¢ï¼šæŒ‰ **ä¹°å®¶+å¸ç§** è®¡æ•°ï¼ˆé˜²åˆ·å•æ´—èµ„äº§ï¼‰
  - æˆäº¤é¢å£å¾„ï¼š**gross_amount**ï¼ˆä¹°å®¶æ”¯ä»˜æ€»é¢ï¼‰
- **åŒç‰©å•å¸**ï¼šç¦æ­¢åŒä¸€ç‰©å“ä»¥å¤šç§å¸ç§æŒ‚ç‰Œï¼Œé¿å…ä»·æ ¼æ··ä¹±

### ç°åº¦ä¸å›æ»š

- **ç°åº¦ä¸Šçº¿**ï¼šåˆæœŸåªå¼€æ”¾ DIAMOND + red_shardï¼Œå…¶ä»–å¸ç§éœ€é…ç½®é½å…¨åæ‰èƒ½åŠ å…¥ç™½åå•
- **å¸ç§ä¸‹çº¿ç­–ç•¥ï¼ˆåŒç™½åå•æœºåˆ¶ï¼‰**ï¼š
  - **æŒ‚ç‰Œç™½åå•**ï¼š`marketplace.allowed_listing_assets` - æ§åˆ¶æ–°æŒ‚ç‰Œå‡†å…¥
  - **ç»“ç®—ç™½åå•**ï¼š`marketplace.allowed_settlement_assets` - æ§åˆ¶æˆäº¤/ç»“ç®—ï¼ˆç´§æ€¥åˆ¹è½¦ï¼‰
  - **ç°åº¦ä¸‹çº¿**ï¼šä» `allowed_listing_assets` ç§»é™¤æŸå¸ç§ â‡’ ç¦æ­¢æ–°æŒ‚ç‰Œï¼Œå­˜é‡å¯ç»§ç»­æˆäº¤
  - **ç´§æ€¥åˆ¹è½¦**ï¼šä» `allowed_settlement_assets` ä¹Ÿç§»é™¤ â‡’ å…¨é‡ç¦æ­¢æˆäº¤ï¼Œä»å…è®¸æ’¤å›/è§£å†»
- **æ•°æ®å…¼å®¹**ï¼šæ‰€æœ‰æ”¹é€ ä¿æŒå‘åå…¼å®¹ï¼Œé»˜è®¤ä»ä¸º DIAMOND

### é£æ§ Redis ç­–ç•¥

- **fail-closed**ï¼šä¸Šæ¶/è´­ä¹°æ—¶ Redis ä¸å¯ç”¨åˆ™æ‹’ç»æ“ä½œ
- **ç”¨æˆ·ä½“éªŒå…œåº•**ï¼šæ’¤å›æŒ‚ç‰Œã€å–æ¶ˆè®¢å•ã€è§£å†»é“¾è·¯å°½é‡ä¸å— Redis çŠ¶æ€å½±å“

### è¿è¥åå°é…ç½®èƒ½åŠ›

- **å¯ä¿®æ”¹é…ç½®**ï¼š
  - `fee_rate_*`ï¼ˆæ‰‹ç»­è´¹ç‡ï¼‰
  - `fee_min_*`ï¼ˆæœ€ä½æ‰‹ç»­è´¹ï¼‰
  - `allowed_listing_assets`ï¼ˆæŒ‚ç‰Œå¸ç§ç™½åå• - æ§åˆ¶æ–°æŒ‚ç‰Œå‡†å…¥ï¼‰
  - `allowed_settlement_assets`ï¼ˆç»“ç®—å¸ç§ç™½åå• - æ§åˆ¶æˆäº¤/ç»“ç®—ï¼Œç´§æ€¥åˆ¹è½¦ï¼‰
  - `daily_max_*`ï¼ˆé£æ§é˜ˆå€¼ï¼‰
  - `min_price_*` / `max_price_*`ï¼ˆä»·æ ¼åŒºé—´ï¼‰
- **é…å¥—è¦æ±‚**ï¼šæ›´æ–° `config/system-settings-whitelist.js`

---

## ğŸ“ æ›´æ–°è®°å½•

| æ—¥æœŸ       | ç‰ˆæœ¬ | æ›´æ–°å†…å®¹                           | ä½œè€…         |
| ---------- | ---- | ---------------------------------- | ------------ |
| 2026-01-14 | V1.0 | åˆå§‹ç‰ˆæœ¬ï¼ŒåŸºäºæ–‡æ¡£åˆ†æç”Ÿæˆå¾…åŠæ¸…å• | AI Assistant |
| 2026-01-15 | V1.1 | æ·»åŠ äº§å“æ‹æ¿å†³ç­–ï¼šRedis fail-closedã€æ—¥é™é¢å£å¾„ã€æ‰‹ç»­è´¹é…ç½®ã€ç°åº¦ç­–ç•¥ã€é£é™©ç”¨æˆ·å¤„ç½®ç­–ç•¥ | äº§å“å›¢é˜Ÿ |
| 2026-01-15 | V1.2 | åŒç™½åå•é…ç½®è½åœ°ï¼š`allowed_listing_assets`ï¼ˆæŒ‚ç‰Œï¼‰+ `allowed_settlement_assets`ï¼ˆç»“ç®—ï¼‰ï¼Œæ”¯æŒ"ç¦æ–°æŒ‚ç‰Œã€å­˜é‡å¯æˆäº¤"ç°åº¦ç­–ç•¥ | äº§å“å›¢é˜Ÿ |
| 2026-01-15 | V1.3 | è¿è¥ä½“éªŒä¸æƒé™ç­–ç•¥ï¼šæ—¥é™é¢æç¤ºæ–‡æ¡ˆï¼ˆæ˜ç¡®å‘ŠçŸ¥+è‡ªç„¶æ—¥é‡ç½®+ç™½åå•æé¢æ”¯æŒï¼‰ã€ç´§æ€¥åˆ¹è½¦å­˜é‡æŒ‚å•å¤„ç†ã€é…ç½®ä¿®æ”¹æƒé™ä¸å®¡è®¡ã€é£é™©ç”¨æˆ·å†»ç»“ç²’åº¦å¼€å…³æšä¸¾ä¸æ‰¹é‡è¾“å…¥æ–¹å¼ | äº§å“å›¢é˜Ÿ |
| 2026-01-15 | V1.4 | ç”¨æˆ·é£æ§é…ç½®è¡¨è®¾è®¡ï¼šæ–°å»º `user_risk_profiles` è¡¨ï¼Œæ”¯æŒç”¨æˆ·çº§/ç­‰çº§çº§é˜ˆå€¼è¦†ç›–ï¼Œå«å†»ç»“ç®¡ç†å­—æ®µï¼Œé…ç½®ä¼˜å…ˆçº§è§„åˆ™ï¼Œé¢„ç½®ç­‰çº§é…ç½® | äº§å“å›¢é˜Ÿ |
| 2026-01-15 | V1.5 | ç­‰çº§æ¥æº+JSONé˜ˆå€¼+å†»ç»“ç»“æ„+é€€å‡ºé€šé“ï¼šç­‰çº§æ”¾`users.user_level`ã€é˜ˆå€¼ç”¨JSONå­˜å‚¨ï¼ˆå¯æ‰©å±•ï¼‰ã€å†»ç»“scopes+asset_codesåˆ†ç¦»ã€æ’¤å›/å–æ¶ˆæ°¸è¿œå…è®¸ | äº§å“å›¢é˜Ÿ |
| 2026-01-15 | V1.6 | NULLè¯­ä¹‰+å…¨ç«™å†»ç»“é€€å‡ºé€šé“ï¼šé˜ˆå€¼ç¼ºå¤±=ç»§æ‰¿ç³»ç»Ÿé»˜è®¤ã€`frozen_asset_codes=null`=å…¨å¸ç§å†»ç»“ã€`full_site`ä¹Ÿä¿ç•™é€€å‡ºé€šé“ï¼ˆæ’¤å›/å–æ¶ˆ/é€€æ¬¾å›æ»šæ°¸è¿œæ”¾è¡Œï¼‰| äº§å“å›¢é˜Ÿ |
| 2026-01-15 | V1.7 | å®æµ‹ç”Ÿäº§MySQLç‰ˆæœ¬ï¼šé€šè¿‡ Node.js è¯»å– `.env` ç›´è¿çœŸå®æ•°æ®åº“ï¼Œç¡®è®¤ MySQL 8.0.30ï¼ˆæ”¯æŒCHECK/JSONç­‰ç‰¹æ€§ï¼‰ | äº§å“å›¢é˜Ÿ |

---

**æ–‡æ¡£ç»“æŸ**
