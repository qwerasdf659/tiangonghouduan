# 抽奖策略与算法全览

> 调研日期：2026-02-22（数据库实时求证更新），代码验证日期：2026-02-23
> 数据来源：真实数据库查询（restaurant_points_dev）+ 当前代码分析（非备份、非历史报告）
> 策略总数：12 套策略模块，2 个不可剥离 + 10 个可关闭/可剥离
> 算法体系：2 种算法（百分比算法 normalize、权重算法 tier_first）
> 文档性质：后端抽奖系统 + Web 管理后台技术文档（以后端数据库项目为权威基准）
> 后端技术栈：Node.js 20+ / Express / Sequelize ORM / MySQL / Redis / Pipeline 管线架构
> Web 管理后台技术栈：Alpine.js 3.x / Vite / Tailwind CSS / ECharts / 多页应用
> 原则：接口、字段、响应格式以后端数据库为准，前端直接使用后端字段名，不做映射

---

## 背景：项目的抽奖概率算法体系

抽奖算法分为两大类：百分比算法和权重算法。`tier_first` 不是第三种算法，它只是权重算法加了分档位的功能，本质还是权重算法。

```
抽奖算法
  │
  ├── 百分比算法（normalize）
  │     运营填：30%、20%、50%（总和必须 = 100%）
  │     特点：直观，但改一个要动其他的
  │     使用字段：win_probability
  │
  └── 权重算法
        运营填：3、2、5（或 700000、200000、100000，总和随便）
        特点：灵活，改一个其他自动调整，系统自动算出百分比
        使用字段：win_weight
        │
        ├── 单层权重（所有奖品一个池子）         ❌ 未实现
        │     不区分用户群，所有人概率一样
        │
        └── 分层权重 tier_first                 ✅ 当前使用
              先选档位（high/mid/low），再在档位内选奖品
              支持新客/VIP/普通用户差异化概率
              额外使用字段：reward_tier（所属档位）
```

### 两大类算法使用完全不同的数据库字段，互不干扰

| 字段 | 百分比算法（normalize） | 权重算法（单层权重 / tier_first） |
|------|----------------------|-------------------------------|
| `win_probability` | 算法使用 | 不使用 |
| `win_weight` | 不使用 | 算法使用 |
| `reward_tier` | 不需要（没有档位概念） | tier_first 使用 |

### 两种算法对比（拍板决定：是 2 种"算法"，不是"选奖方式"）

后台下拉框里的 `normalize` 和 `tier_first`，本质上是在选用哪种算法，不只是"方式"的区别。两种算法走完全不同的代码路径，用完全不同的数据库字段：

| 对比维度 | 百分比算法（normalize） | 权重算法（tier_first） |
|----------|----------------------|---------------------|
| 对应 `pick_method` | `normalize` | `tier_first` |
| 运营填什么 | 百分比（总和 = 100%） | 权重（总和随便） + 档位 |
| 使用字段 | `win_probability` | `win_weight` + `reward_tier` |
| TierPickStage | **直接跳过** | 执行（分群→预算→压力→矩阵→体验平滑→选档位） |
| 12 套策略 | 大部分不生效 | 全部生效 |
| 用户分群 | 不支持（所有人相同概率） | 支持差异化 |
| 实现状态 | ✅ 已实现，但无活动使用 | ✅ 已实现（推荐），所有活动都在用 |

代码确认：`TierPickStage.js` 第 196 行，`normalize` 模式直接 `return this.success({ skip_reason: 'normalize_mode' })`，整个 Stage 被跳过。

> 注：单层权重（所有奖品一个池子按权重选，不分档位）是权重算法的另一种实现，❌ 未实现。

### 运营创建活动时的选择

- 选了**百分比算法**（normalize）→ 填百分比（`win_probability`），所有人概率一样，12 套策略大部分不生效
- 选了**权重算法**（tier_first）→ 填权重（`win_weight`）+ 档位（`reward_tier`），可按用户群差异化，12 套策略全部生效

### 当前各活动实际使用情况（数据库实时查询）

| 活动ID | 活动名称 | 算法 | 前端展示模式 | 特效主题 | 状态 |
|--------|---------|------|-------------|---------|------|
| 1 | 餐厅积分抽奖 | tier_first | card_flip | gold_luxury | active |
| 25 | 走走走 | tier_first | grid_3x3 | default | ended |
| 26 | 再找找 | tier_first | grid_3x3 | gold_luxury | paused |
| 27 | 12312 | tier_first | scratch_card | default | ended |

所有活动都使用权重算法（tier_first），百分比算法（normalize）代码已实现但未被任何活动使用。

---

## 算法与策略的关系

### 核心概念

```
算法   = 骨架（必须选一个，决定怎么选奖品）
策略   = 加装件（可以全拆，选奖照样能跑）
```

算法和策略是两个独立的维度。算法不能关闭（必须选一个），策略可以全部关闭或设为无效果模式。

抽奖引擎是一条流水线（Pipeline），每次抽奖按顺序经过多个 Stage：

```
用户点抽奖
  → PricingStage（定价阶段：扣多少积分）
  → LoadCampaignStage（加载活动配置）
  → BuildPrizePoolStage（构建奖品池）
  → TierPickStage（选档位阶段：选 high/mid/low）  ← 权重算法的核心
  → PrizePickStage（选奖品阶段：从档位内选具体奖品）
  → SettleStage（结算阶段：发放奖品）
  → DecisionSnapshotStage（快照阶段：记录决策过程）
```

TierPickStage 是整个引擎最核心的一步，12 套策略中的大部分（分群、预算、压力、矩阵、保底、防连空等）都在这个 Stage 里执行。选了 normalize 算法时，这个 Stage 直接跳过。

### normalize 算法下的策略生效情况

选了百分比算法后，代码直接跳过 TierPickStage，12 套策略大部分自动失效：

| 策略 | 状态 | 原因 |
|------|------|------|
| 用户分群 | 不生效 | 没有档位，分群没意义 |
| 预算分层 | 不生效 | 没有档位可限制 |
| 活动压力 | 不生效 | 没有档位权重可调整 |
| BxPx 矩阵 | 不生效 | 没有档位权重可乘 |
| 保底/运气债务/防连空/防连高 | 不生效 | 这些都是调档位的 |
| 定价 | **生效** | 抽一次扣多少积分，和选奖无关 |
| 管理干预 | **生效** | 强制中奖/不中奖仍然有效 |

normalize 本身就约等于"关掉大部分策略，纯按百分比抽"。

### tier_first 算法下的策略开关能力（拍板决定）

**结论：12 个策略里，只有定价和动态配置是真正的骨架，其余 10 个要么已经能关，要么加个开关就能关。**

| 策略 | 能独立关闭吗 | 怎么关 | 说明 |
|------|-------------|--------|------|
| 保底（Pity） | ✅ 能关 | `PITY_ENABLED=false` | 有真正的开关 |
| 运气债务（Luck Debt） | ✅ 能关 | `LUCK_DEBT_ENABLED=false` | 有真正的开关 |
| 防连空（Anti-Empty） | ✅ 能关 | `ANTI_EMPTY_ENABLED=false` | 有真正的开关 |
| 防连高（Anti-High） | ✅ 能关 | `ANTI_HIGH_ENABLED=false` | 有真正的开关 |
| 管理干预 | ✅ 默认就没开 | 没人设置就不生效 | 数据库现有 ≥10 条记录全是 `cancelled`（force_win 类型测试数据） |
| 用户分群 | ✅ 可设为无效 | `segment_resolver_version='default'` | 不分群 = 所有人一样 |
| 预算分层 | ✅ 可设为无效 | `budget_mode=none` | 不限预算 = 不做限制 |
| 活动压力 | ✅ 可剥离 | 已决策加活动级开关 `pressure.enabled`（`lottery_strategy_config` 表） | 关闭后固定返回 P0，乘数恒为 1.0 |
| BxPx 矩阵 | ✅ 可剥离 | 已决策加活动级开关 `matrix.enabled`（`lottery_strategy_config` 表） | 关闭后直接返回原始权重 |
| 灰度发布 | ✅ 不用关 | 默认 100% = 透明通道 | 它是体验平滑策略的上线控制机制 |
| 定价 | ❌ **不可剥离** | 管线必需阶段 | 抽奖必须知道扣多少积分 |
| 动态配置 | ❌ **不可剥离** | 它就是配置加载系统 | 去掉它其他策略参数都没法读 |

### 策略按可控性分类（拍板决定）

| 分类 | 策略 | 数量 | 说明 |
|------|------|------|------|
| 不可剥离（引擎骨架） | 定价、动态配置 | **2 个** | 去掉引擎跑不起来 |
| 有真正的开关 | 保底、运气债务、防连空、防连高 | 4 个 | 环境变量设 `false` 即关 |
| 可设为无效果模式 | 用户分群、预算分层 | 2 个 | 设成"不分群"+"不限预算" |
| 可剥离（已决策加活动级开关） | 活动压力、BxPx 矩阵 | 2 个 | 已决策：通过 `lottery_strategy_config` 表加 `pressure.enabled` / `matrix.enabled` |
| 默认就没开 / 透明 | 管理干预、灰度发布 | 2 个 | 不用管 |

### tier_first 最小化运行模式

如果把 10 个可关的全关、可设无效的全设无效，tier_first 就退化成一个**纯静态权重选奖**：

- 按 `lottery_tier_rules` 表配置的固定权重选 high/mid/low 档位
- 档位内按 `win_weight` 选奖品
- 没有任何动态调整
- 功能上完全能跑

---

## 概览

抽奖引擎共 12 套策略模块，**2 个不可剥离 + 10 个可关闭/可剥离**：

| 类别 | 策略数量 | 包含 | 说明 |
|------|---------|------|------|
| 不可剥离（引擎骨架） | 2 | 定价、动态配置 | 去掉引擎跑不起来 |
| 有开关（可关闭） | 4 | 保底、运气债务、防连空、防连高 | 环境变量设 false 即关 |
| 可设无效（等于关了） | 2 | 用户分群、预算分层 | 选"不分群"+"不限预算" |
| 可剥离（已决策加活动级开关） | 2 | 活动压力、BxPx 矩阵 | 已决策加 `pressure.enabled` / `matrix.enabled` 到 `lottery_strategy_config` 表 |
| 默认没开 / 透明 | 2 | 管理干预、灰度发布 | 不用管 |

---

## 一、可关闭/可剥离的策略（10 个）

### 1. 用户分群策略（Segment Strategy）——可设为无效

根据用户身份分群，决定档位概率分配。

系统内置 5 套策略，存储在 `segment_rule_configs` 表：

| 版本 | 名称 | 怎么分 | 适用场景 |
|------|------|--------|----------|
| `default` | 不分群 | 所有用户一视同仁 | 公平抽奖，不做区别对待 |
| `v1` | 新老用户分层 | 注册 ≤7 天 = 新用户，其他 = 老用户 | 新用户激励 |
| `v2` | VIP用户分层 | 历史积分 ≥10万 = 高级VIP，≥1万 = 普通VIP，其他 = 普通 | VIP 回馈活动 |
| `v3` | 组合分层 | 同时看注册时间 + 消费等级，分 4 档 | 综合运营活动 |
| `v4` | 活跃度分层 | 7天内活跃 / 30天内活跃 / 超30天不活跃 | 老用户召回 |

#### 各策略分群明细

**default — 不分群**

| 分群 | 条件 | 优先级 |
|------|------|--------|
| `default` | 所有用户 | 0 |

**v1 — 新老用户分层**

| 分群 | 条件 | 优先级 |
|------|------|--------|
| `new_user` | 注册时间距今 ≤ 7 天 | 10 |
| `regular_user` | 其他所有用户 | 0 |

**v2 — VIP用户分层**

| 分群 | 条件 | 优先级 |
|------|------|--------|
| `vip_premium` | 历史总积分 ≥ 100,000 | 20 |
| `vip_basic` | 历史总积分 ≥ 10,000 | 10 |
| `regular_user` | 其他所有用户 | 0 |

**v3 — 组合分层**

| 分群 | 条件 | 优先级 |
|------|------|--------|
| `new_vip` | 注册 ≤ 7 天 **且** 历史积分 ≥ 10,000 | 30 |
| `new_user` | 注册 ≤ 7 天 | 20 |
| `vip_user` | 历史积分 ≥ 10,000 | 10 |
| `regular_user` | 其他所有用户 | 0 |

**v4 — 活跃度分层**

| 分群 | 条件 | 优先级 |
|------|------|--------|
| `highly_active` | 最后活跃时间距今 ≤ 7 天 | 20 |
| `moderately_active` | 最后活跃时间距今 ≤ 30 天 | 10 |
| `inactive_user` | 其他所有用户 | 0 |

#### 匹配规则

- 规则按**优先级从高到低**依次判断
- **第一个匹配的规则**决定用户的分群
- 如果全部不匹配，兜底返回 `default`

#### 分群对档位概率的影响（活动1 真实数据）

数据来源：`lottery_tier_rules` 表

| 用户分群 | high 档概率 | mid 档概率 | low 档概率 |
|----------|------------|-----------|-----------|
| `default`（普通用户） | 5% | 15% | **80%** |
| `new_user`（新用户） | **10%** | 20% | 70% |
| `vip_user`（VIP用户） | **8%** | **22%** | 70% |

权重总和固定为 1,000,000（百万分制），概率 = 权重 / 1,000,000。

#### 各档位包含哪些奖品

| 档位 | 奖品 | 特点 |
|------|------|------|
| **high**（高档） | 八八折、100积分、2000积分券、500积分券、九八折券 | 有实际价值 |
| **mid**（中档） | 甜品1份、精品首饰、生腌拼盘158 | 实物奖品 |
| **low**（低档） | 青菜1份、神秘彩蛋、好运加持、美食推荐、厨师祝福、下次好运、参与有礼 | 空奖/安慰奖 |

#### 分群规则的两套来源

优先级：**数据库 > 代码内置**。

| 来源 | 位置 | 谁维护 | 优先级 |
|------|------|--------|--------|
| 数据库 | `segment_rule_configs` 表 | 运营通过后台条件构建器 | 高（优先使用） |
| 代码内置 | `config/segment_rules.js` | 开发人员 | 低（数据库没有时兜底） |

运营可用的条件字段（安全白名单）：

| 字段 | 显示名称 | 类型 | 可用运算符 |
|------|---------|------|-----------|
| `created_at` | 注册时间 | 日期 | 距今 ≤ N 天、距今 > N 天 |
| `last_active_at` | 最后活跃时间 | 日期 | 距今 ≤ N 天、距今 > N 天 |
| `history_total_points` | 历史总积分 | 数字 | ≥、≤、等于、在范围内 |
| `user_level` | 用户等级 | 枚举 | 等于、不等于、属于 |
| `consecutive_fail_count` | 连续未中奖次数 | 数字 | ≥、≤、等于 |

#### 关键代码文件

| 文件 | 职责 |
|------|------|
| `config/segment_rules.js` | 5 套内置分群规则 + SegmentResolver 类 |
| `config/segment_field_registry.js` | 运营条件构建器的字段白名单和运算符 |
| `models/SegmentRuleConfig.js` | 运营自定义规则的数据库模型 |
| `services/UnifiedLotteryEngine/pipeline/stages/TierPickStage.js` | 抽奖引擎中使用分群结果选档位 |

#### 当前实际使用数据（数据库实时查询）

数据来源：`lottery_draw_decisions` 表（3,064 次抽奖记录，全部来自活动 1）

| 实际分群 | 抽奖次数 | 占比 | 说明 |
|----------|---------|------|------|
| `regular_user` | 1,669 | 54.5% | 老用户（注册超过7天） |
| `default` | 1,395 | 45.5% | 走了默认兜底 |
| `new_user` | 0 | 0% | 没有新用户参与过抽奖 |

---

### 2. 预算分层策略（Budget Tier）——可设为无效

根据用户**剩余预算积分**决定能抽到哪些档位的奖品。

| 预算等级 | 条件 | 能抽到的档位 |
|----------|------|-------------|
| B3（富裕） | 预算 ≥ 1000 | high + mid + low |
| B2（中等） | 预算 ≥ 500 | mid + low |
| B1（紧张） | 预算 ≥ 100 | low |
| B0（耗尽） | 预算 < 100 | 只能抽空奖 |

通俗说：**钱多选择多，钱少只能抽便宜的。**

| 参数 | 环境变量 | 默认值 |
|------|---------|--------|
| B3 阈值 | `BUDGET_TIER_THRESHOLD_HIGH` | 1000 |
| B2 阈值 | `BUDGET_TIER_THRESHOLD_MID` | 500 |
| B1 阈值 | `BUDGET_TIER_THRESHOLD_LOW` | 100 |

关键代码：`services/UnifiedLotteryEngine/compute/calculators/BudgetTierCalculator.js`

---

### 3. 活动压力策略（Pressure Tier）——可剥离（已决策加活动级开关）

根据活动**预算消耗速度 vs 时间进度**，动态调整发奖力度。

> **已决策**：通过 `DynamicConfigLoader` 加**活动级开关** — 在 `lottery_strategy_config` 表增加 `pressure.enabled` 配置项，运营可按活动单独开关。关闭后固定返回 P0，压力乘数恒为 1.0，不再影响权重。

| 压力等级 | 条件 | 效果 |
|----------|------|------|
| P0（轻松） | 消耗率 < 50%（花得慢） | 正常发奖 |
| P1（正常） | 消耗率 50%-80% | 略微收紧 |
| P2（紧张） | 消耗率 > 80%（快花完了） | 压低高档概率，保护预算 |

通俗说：**活动前期大方发，后期预算紧了就收着发。**

| 参数 | 环境变量 | 默认值 |
|------|---------|--------|
| P2 阈值 | `PRESSURE_TIER_THRESHOLD_HIGH` | 0.8 |
| P1 阈值 | `PRESSURE_TIER_THRESHOLD_LOW` | 0.5 |

关键代码：`services/UnifiedLotteryEngine/compute/calculators/PressureTierCalculator.js`

---

### 4. BxPx 矩阵策略（Budget × Pressure Matrix）——可剥离（已决策加活动级开关）

把预算分层和活动压力**交叉组合**，形成 12 种情况，每种有不同的权重乘数。

> **已决策**：通过 `DynamicConfigLoader` 加**活动级开关** — 在 `lottery_strategy_config` 表增加 `matrix.enabled` 配置项，运营可按活动单独开关。关闭后 `computeWeightAdjustment()` 直接返回原始权重，所有乘数恒为 1.0。

```
            P0(轻松)     P1(正常)     P2(紧张)
B3(富裕)    正常发       正常发       适当收紧
B2(中等)    正常发       适当收紧     明显收紧
B1(紧张)    适当收紧     明显收紧     大幅收紧
B0(耗尽)    只发空奖     只发空奖     只发空奖
```

通俗说：**根据"用户有没有钱"和"活动还剩多少预算"两个维度，精细控制发奖力度。**

- 数据库配置：`lottery_tier_matrix_config` 表（支持活动级隔离）
- 关键代码：`services/UnifiedLotteryEngine/compute/calculators/TierMatrixCalculator.js`

---

## 二、不可剥离的策略（2 个，引擎骨架）

### 5. 定价策略（Pricing）——不可剥离

管理抽奖的花费和折扣：单抽多少积分、连抽打几折。

> **拍板决定**：管线必需阶段。抽奖必须知道扣多少积分，去掉等于不收费，破坏基本商业模式。

| 配置项 | 说明 |
|--------|------|
| 基础费用 | 单抽消耗多少积分 |
| 连抽折扣 | 10连抽打 9 折之类 |
| 版本管理 | 支持定时生效、多版本切换 |

- 数据库配置：`lottery_campaign_pricing_config` 表（版本化管理）
- 关键代码：`services/UnifiedLotteryEngine/pipeline/stages/PricingStage.js`、`services/lottery/LotteryPricingService.js`

---

## 项目中的 4 种"保底"机制区分

项目里一共有 4 种"保底"，名字里都带"保底"但干的事完全不同：

| # | 名称 | 触发条件 | 发什么 | 目的 | 对应字段/代码 |
|---|------|---------|--------|------|-------------|
| 1 | **Pity 软/硬保底** | 连续空奖 5 次开始提概率，10 次强制出奖 | 非空奖品（系统自动选） | 体验兜底：别让用户觉得"怎么老是不中" | `PITY_ENABLED`、`PITY_SOFT_THRESHOLD`、`PITY_HARD_THRESHOLD` |
| 2 | **防连空保底** | 连续空奖 8 次 | 强制出一个非空奖品 | 暴力兜底：比 Pity 更粗暴的最后防线 | `ANTI_EMPTY_ENABLED`、`ANTI_EMPTY_THRESHOLD` |
| 3 | **固定间隔保底** | 每抽 N 次（默认10次）必出一次 | 指定奖品或自动选最高档 | 营销承诺："每10次必出大奖" | `guarantee_enabled`、`guarantee_threshold`、`guarantee_prize_id` |
| 4 | **档位降级保底** | 所有档位（high/mid/low）都没有可用奖品 | 指定的空奖 | 系统兜底：奖品全部发完了也不能报错 | `tier_fallback_lottery_prize_id`、`is_fallback` |

### 通俗区分（排队买奶茶比喻）

- **Pity 保底** = "排了好久队，店员偷偷给你加个小料"（温和补偿，概率逐渐提高）
- **防连空保底** = "排了 8 次都没买到限定款，店长直接从后厨拿一杯给你"（暴力干预）
- **固定间隔保底** = 门口贴着"每 10 位顾客必送一杯"（营销活动，对外承诺）
- **档位降级保底** = 所有奶茶都卖完了，给你一杯白水（系统兜底，不能让你空手走）

### 当前数据库实际状态（实时查询）

| 保底机制 | 当前状态 | 数据库实际值 |
|----------|---------|-------------|
| Pity 软/硬保底 | **开启** | `lottery_strategy_config` 表 pity.enabled=true, hard_guarantee_threshold=10 |
| 防连空保底 | **开启** | `lottery_strategy_config` 表 anti_empty.enabled=true, empty_streak_threshold=**3**（不是代码默认的 8） |
| 防连高保底 | **开启** | `lottery_strategy_config` 表 anti_high.enabled=true, recent_draw_window=**5**, high_streak_threshold=**2** |
| 固定间隔保底 | **关闭** | 所有 4 个活动 `guarantee_enabled=0` |
| 档位降级保底 | **未配置指定奖品** | `tier_fallback_lottery_prize_id=null`，但 low 档有 6 个 `is_fallback=true` 的空奖可兜底 |

### 4 种保底的触发优先级

```
用户抽奖
  │
  ① 固定间隔保底检查（最先）
  │   └── 抽到第 N 次了吗？→ 是 → 直接发保底奖品，跳过后续
  │
  ② 正常选档位（high/mid/low）
  │
  ③ 体验平滑检查
  │   ├── 防连空：连续空奖 ≥ 8？→ 强制出非空奖品
  │   └── Pity：连续空奖 ≥ 5？→ 逐步提高非空概率
  │
  ④ 档位降级保底（最后）
      └── 选中的档位没奖品了？→ high→mid→low→fallback 逐级降级
```

---

## 三、体验平滑策略（有开关，可关闭）

这 4 个保护用户体验，防止运气太差或太好。每个都有真正的 `enabled` 环境变量开关。

### 6. 保底系统（Pity）——有开关

**连续抽不到好东西时，逐渐提高概率。**

| 参数 | 环境变量 | 默认值 | 含义 |
|------|---------|--------|------|
| 开关 | `PITY_ENABLED` | true | 是否启用 |
| 软保底阈值 | `PITY_SOFT_THRESHOLD` | 5 次 | 连续空奖 5 次后，开始逐步提高非空概率 |
| 硬保底阈值 | `PITY_HARD_THRESHOLD` | 10 次 | 连续空奖 10 次，**强制**出非空奖品 |

类似原神的保底机制：抽了很多次没出金，概率会越来越高。

关键代码：`services/UnifiedLotteryEngine/compute/calculators/PityCalculator.js`

---

### 7. 运气债务（Luck Debt）——有开关

**长期运气差的用户，系统会慢慢补偿回来。**

| 参数 | 环境变量 | 默认值 | 含义 |
|------|---------|--------|------|
| 开关 | `LUCK_DEBT_ENABLED` | true | 是否启用 |
| 期望空奖率 | `LUCK_DEBT_EXPECTED_RATE` | 50%（代码默认值） | 系统认为合理的空奖比例 |
| 最小样本量 | `LUCK_DEBT_MIN_SAMPLE` | 20 次（代码默认值） | 抽满 N 次后才开始计算运气债 |

> ⚠️ 数据库实际值：活动 1 的 `luck_debt.expected_empty_rate` = **30%**，`luck_debt.min_draw_count` = **10 次**

如果一个用户抽了 100 次，空奖率 70%（高于期望的 50%），系统会在后续抽奖中提高非空概率来补偿。

和 Pity 的区别：Pity 看**连续**空奖次数，Luck Debt 看**历史总**空奖率。

关键代码：`services/UnifiedLotteryEngine/compute/calculators/LuckDebtCalculator.js`

---

### 8. 防连续空奖（Anti-Empty）——有开关

**连续空奖达到阈值时，强制发一个奖品。**

| 参数 | 环境变量 | 默认值 | 含义 |
|------|---------|--------|------|
| 开关 | `ANTI_EMPTY_ENABLED` | true | 是否启用 |
| 触发阈值 | `ANTI_EMPTY_THRESHOLD` | 8 次（代码默认值） | 连续空奖后强制干预 |

> ⚠️ 数据库实际值：活动 1 的 `anti_empty.empty_streak_threshold` = **3 次**（覆盖了代码默认的 8 次）

和 Pity 的区别：
- Pity 是"逐渐提高概率"（温和，从第 5 次开始慢慢加）
- Anti-Empty 是"直接强制出奖"（暴力，到第 8 次直接干预）

关键代码：`services/UnifiedLotteryEngine/compute/calculators/AntiEmptyStreakHandler.js`

---

### 9. 防连续高价值（Anti-High）——有开关

**短期内抽到太多好东西时，限制继续出好东西。**

| 参数 | 环境变量 | 默认值 | 含义 |
|------|---------|--------|------|
| 开关 | `ANTI_HIGH_ENABLED` | true | 是否启用 |
| 统计窗口 | `ANTI_HIGH_WINDOW` | 10 次（代码默认值） | 看最近 N 次抽奖 |
| 触发阈值 | `ANTI_HIGH_THRESHOLD` | 3 次（代码默认值） | N 次里有 M 次 high 档就限制 |
| 限制方式 | — | 封顶到 mid | 触发后只能抽 mid 或 low |

> ⚠️ 数据库实际值：活动 1 的 `anti_high.recent_draw_window` = **5 次**，`anti_high.high_streak_threshold` = **2 次**

保护预算，防止一个用户短期内薅走太多好奖品。

关键代码：`services/UnifiedLotteryEngine/compute/calculators/AntiHighStreakHandler.js`

---

## 四、管理策略（默认没开）

### 10. 管理干预（Management Strategy）——默认没开

管理员可以对**指定用户**设置特殊抽奖规则：

| 干预类型 | 说明 | 场景 |
|----------|------|------|
| 强制中奖 | 下一次必定抽到指定奖品 | 客服补偿 |
| 强制不中奖 | 下一次必定空奖 | 防刷保护 |
| 概率调整 | 临时调高/调低某用户概率 | VIP特权 |
| 用户专属队列 | 为某用户安排固定的奖品序列 | 精准运营 |

- 支持设置过期时间，到期自动失效
- 数据库配置：`lottery_management_settings` 表
- 关键代码：`services/UnifiedLotteryEngine/strategies/ManagementStrategy.js`

---

## 五、基础设施策略

### 11. 灰度发布（Grayscale）——默认 100% 透明，不用关

控制体验平滑策略（Pity/LuckDebt/AntiEmpty/AntiHigh）的**生效范围**。

| 参数 | 环境变量 | 默认值 | 说明 |
|------|---------|--------|------|
| Pity 灰度 | `PITY_GRAYSCALE_PERCENTAGE` | 100 | 100% = 全量生效 |
| LuckDebt 灰度 | `LUCK_DEBT_GRAYSCALE_PERCENTAGE` | 100 | 可设为 10 表示只对 10% 用户生效 |
| AntiEmpty 灰度 | `ANTI_EMPTY_GRAYSCALE_PERCENTAGE` | 100 | — |
| AntiHigh 灰度 | `ANTI_HIGH_GRAYSCALE_PERCENTAGE` | 100 | — |
| 用户白名单 | `PITY_USER_WHITELIST` | 空 | 指定用户强制开启（逗号分隔） |

灰度判定方式：对用户 ID 取哈希后取模，落在百分比范围内则生效。

关键代码：`services/UnifiedLotteryEngine/compute/config/StrategyConfig.js`（GRAYSCALE_CONFIG）

---

### 12. 动态配置（Dynamic Config）——不可剥离

所有策略参数支持**不重启服务就修改**。

> **拍板决定**：它就是配置加载系统本身（`DynamicConfigLoader`），去掉它其他策略参数都没法从数据库读取，只能用代码硬编码的默认值。

| 配置来源 | 优先级 | 说明 |
|----------|--------|------|
| 数据库 `lottery_strategy_config` 表 | 最高 | 运营可通过后台实时修改 |
| 环境变量 `.env` | 中 | 需要重启服务生效 |
| 代码默认值 | 最低 | 兜底值 |

- 缓存 TTL：5 分钟（环境变量 `STRATEGY_CONFIG_CACHE_TTL`，默认 300000ms）
- 关键代码：`services/UnifiedLotteryEngine/compute/config/StrategyConfig.js`（DynamicConfigLoader）
- 数据库模型：`models/LotteryStrategyConfig.js`

---

## 六、完整的策略执行顺序（代码实际验证：NormalDrawPipeline 11 个 Stage）

```
用户点"抽奖" → POST /api/v4/lottery/draw
  │
  ① LoadCampaignStage     → 加载活动配置、奖品列表、档位规则
  │
  ② EligibilityStage      → 验证用户资格（积分、次数、活动有效性）
  │
  ③ LoadDecisionSourceStage → 判断决策来源
  │      ├── preset  → 管理员预设的中奖记录（最高优先级）
  │      ├── override → 管理员临时干预（次高）
  │      └── normal  → 正常抽奖流程
  │
  ④ BudgetContextStage    → 初始化预算上下文（BudgetProvider）
  │
  ⑤ PricingStage          → 计算费用、验证积分余额
  │
  ⑥ BuildPrizePoolStage   → 构建可用奖品池（过滤库存/状态）
  │
  ⑦ GuaranteeStage        → 固定间隔保底检查
  │      └── guarantee_enabled=true 且到第 N 次 → 直接发保底奖品
  │
  ⑧ TierPickStage（核心） → 分群→预算→压力→矩阵→体验平滑→选档位
  │      ├── normalize 模式 → 直接跳过（skip_reason='normalize_mode'）
  │      ├── preset/override → 直接跳过
  │      └── tier_first 模式 →
  │            ├── 用户分群 → segment_key
  │            ├── 预算分层 → B0~B3
  │            ├── 活动压力 → P0~P2
  │            ├── BxPx 矩阵 → 权重调整
  │            ├── 体验平滑（Anti-Empty/Anti-High/Pity/LuckDebt）
  │            └── 按最终权重随机选 high/mid/low
  │
  ⑨ PrizePickStage        → 从档位内按 win_weight 选具体奖品
  │
  ⑩ DecisionSnapshotStage → 记录决策快照（审计追溯）
  │
  ⑪ SettleStage（唯一写入点）
      ├── 扣减积分
      ├── 扣减库存
      ├── 扣减预算
      ├── coupon/physical → 铸造物品（items 表 + item_ledger 双录）
      ├── 带 material_asset_code → 余额加减（account_asset_balances）
      └── virtual（空奖） → 仅记录抽奖记录（lottery_draws）
```

---

## 七、当前各活动的策略配置（数据库实时查询）

数据来源：`lottery_campaigns` 表

| 活动ID | 活动名称 | 分群版本 | 算法 | 预算模式 | 固定间隔保底 | 展示模式 | 状态 |
|--------|---------|---------|------|---------|-------------|---------|------|
| 1 | 餐厅积分抽奖 | `v1` | tier_first | user | 关闭（threshold=10） | card_flip | active |
| 25 | 走走走 | `v1` | tier_first | user | 关闭 | grid_3x3 | ended |
| 26 | 再找找 | `v1` | tier_first | user | 关闭 | grid_3x3 | paused |
| 27 | 12312 | `v1` | tier_first | user | 关闭 | scratch_card | ended |

**活动 1 的策略配置详情**（`lottery_strategy_config` 表 17 条记录）：
- budget_tier: B1=100, B2=500, B3=1000
- pressure_tier: P1=0.5, P2=0.8
- pity: enabled=true, hard_guarantee_threshold=10
- luck_debt: enabled=true, expected_empty_rate=0.3, min_draw_count=10
- anti_empty: enabled=true, empty_streak_threshold=3
- anti_high: enabled=true, recent_draw_window=5, high_streak_threshold=2
- pity.multiplier_table: {0:1, 1:1, 2:1.2, 3:1.5, 4:1.8, 5:2.2, 6:2.8, 7:3.5, 8:5, 9:10}

**活动 1 的 BxPx 矩阵配置**（`lottery_tier_matrix_config` 表 12 条记录）：
| BxPx | high_mul | mid_mul | low_mul | fallback_mul | 策略 |
|------|----------|---------|---------|-------------|------|
| B0×P0/P1/P2 | 0.00 | 0.00 | 0.00 | 1.00 | 强制空奖 |
| B1×P0 | 0.00 | 0.00 | 1.20 | 0.90 | 只抽 low，略增 |
| B1×P1 | 0.00 | 0.00 | 1.00 | 1.00 | 只抽 low，正常 |
| B1×P2 | 0.00 | 0.00 | 0.80 | 1.20 | 只抽 low，收紧 |
| B2×P0 | 0.00 | 1.30 | 1.10 | 0.80 | mid+low，大方 |
| B2×P1 | 0.00 | 1.00 | 1.00 | 1.00 | mid+low，正常 |
| B2×P2 | 0.00 | 0.70 | 1.10 | 1.30 | mid+low，收紧 |
| B3×P0 | 1.50 | 1.20 | 0.90 | 0.70 | 全档位，大方 |
| B3×P1 | 1.00 | 1.00 | 1.00 | 1.00 | 全档位，正常 |
| B3×P2 | 0.80 | 0.80 | 1.20 | 1.20 | 全档位，收紧 |

---

## 八、策略引擎技术架构（代码实际验证）

```
创建活动时配置
  ├── segment_resolver_version（选哪套分群策略：default/v1/v2/v3/v4）
  ├── pick_method（选哪种算法：tier_first 推荐，normalize 已实现但无人用）
  ├── budget_mode（预算模式：user / pool / none）
  ├── display_mode（前端展示：15 种玩法枚举，Web 后台下拉选择 + grid_cols 联动）
  ├── effect_theme（特效主题：6 套）
  ├── guarantee_enabled/threshold/lottery_prize_id（固定间隔保底）
  └── 档位规则（lottery_tier_rules 表）

用户抽奖请求 → POST /api/v4/lottery/draw { lottery_campaign_id, draw_count }
  │
  ▼
UnifiedLotteryEngine.executeLottery()
  │
  ▼
DrawOrchestrator.execute()
  │
  ▼
NormalDrawPipeline.run()  ← V4.6 架构：1 条统一管线（整合原 3 条管线）
  │
  ├── LoadCampaignStage        → 加载活动配置 + 奖品 + 档位规则
  ├── EligibilityStage         → 验证用户资格
  ├── LoadDecisionSourceStage  → preset > override > normal
  ├── BudgetContextStage       → 初始化 BudgetProvider
  ├── PricingStage             → 计算费用、验证积分
  ├── BuildPrizePoolStage      → 构建可用奖品池
  ├── GuaranteeStage           → 固定间隔保底
  ├── TierPickStage            → 核心选档位（整合所有策略计算）
  ├── PrizePickStage           → 档位内选奖品
  ├── DecisionSnapshotStage    → 决策快照（审计追溯）
  └── SettleStage              → 唯一写入点（扣分/扣库存/发奖/写记录）
```

### 计算引擎组件清单

| 文件 | 类名 | 职责 |
|------|------|------|
| `compute/LotteryComputeEngine.js` | LotteryComputeEngine | 计算引擎入口 |
| `compute/calculators/BudgetTierCalculator.js` | BudgetTierCalculator | 预算分层计算（B0~B3） |
| `compute/calculators/PressureTierCalculator.js` | PressureTierCalculator | 活动压力计算（P0~P2） |
| `compute/calculators/TierMatrixCalculator.js` | TierMatrixCalculator | BxPx 矩阵权重调整 |
| `compute/calculators/PityCalculator.js` | PityCalculator | 保底系统（软/硬保底） |
| `compute/calculators/LuckDebtCalculator.js` | LuckDebtCalculator | 运气债务 |
| `compute/calculators/AntiEmptyStreakHandler.js` | AntiEmptyStreakHandler | 防连续空奖 |
| `compute/calculators/AntiHighStreakHandler.js` | AntiHighStreakHandler | 防连续高价值 |
| `compute/config/StrategyConfig.js` | DynamicConfigLoader + GRAYSCALE_CONFIG | 策略参数加载 + 灰度控制 |

### 关键代码文件汇总

**管线架构**：
| 文件 | 职责 |
|------|------|
| `services/UnifiedLotteryEngine/UnifiedLotteryEngine.js` | 引擎入口（`executeLottery()`） |
| `services/UnifiedLotteryEngine/pipeline/DrawOrchestrator.js` | 管线编排器 |
| `services/UnifiedLotteryEngine/pipeline/NormalDrawPipeline.js` | 统一管线（11 个 Stage） |
| `services/UnifiedLotteryEngine/pipeline/stages/BaseStage.js` | Stage 基类 |

**管线 Stage**：
| 文件 | 职责 |
|------|------|
| `pipeline/stages/LoadCampaignStage.js` | 加载活动配置 |
| `pipeline/stages/EligibilityStage.js` | 用户资格验证 |
| `pipeline/stages/LoadDecisionSourceStage.js` | 决策来源判断（preset/override/normal） |
| `pipeline/stages/BudgetContextStage.js` | 预算上下文初始化 |
| `pipeline/stages/PricingStage.js` | 定价计算 |
| `pipeline/stages/BuildPrizePoolStage.js` | 构建奖品池 |
| `pipeline/stages/GuaranteeStage.js` | 固定间隔保底 |
| `pipeline/stages/TierPickStage.js` | 核心选档位（整合分群/预算/压力/矩阵/体验平滑） |
| `pipeline/stages/PrizePickStage.js` | 档位内选奖品 |
| `pipeline/stages/DecisionSnapshotStage.js` | 决策快照 |
| `pipeline/stages/SettleStage.js` | 结算发放（唯一写入点） |

**计算引擎**：
| 文件 | 职责 |
|------|------|
| `compute/LotteryComputeEngine.js` | 计算引擎入口 |
| `compute/calculators/BudgetTierCalculator.js` | 预算分层 |
| `compute/calculators/PressureTierCalculator.js` | 活动压力 |
| `compute/calculators/TierMatrixCalculator.js` | BxPx 矩阵 |
| `compute/calculators/PityCalculator.js` | 保底系统 |
| `compute/calculators/LuckDebtCalculator.js` | 运气债务 |
| `compute/calculators/AntiEmptyStreakHandler.js` | 防连空 |
| `compute/calculators/AntiHighStreakHandler.js` | 防连高 |
| `compute/config/StrategyConfig.js` | 策略配置加载 + 灰度控制 |

**策略与配置**：
| 文件 | 职责 |
|------|------|
| `strategies/ManagementStrategy.js` | 管理干预（仅用于管理 API） |
| `config/segment_rules.js` | 分群规则 + SegmentResolver |
| `config/segment_field_registry.js` | 条件构建器字段白名单 |
| `services/PrizePoolService.js` | 奖品池 CRUD 服务 |
| `services/lottery/LotteryPricingService.js` | 定价配置服务 |

**关键路由**：
| 路由文件 | API 路径前缀 | 用途 |
|---------|-------------|------|
| `routes/v4/console/prize_pool.js` | `/api/v4/console/prize-pool` | 奖品池管理 |
| `routes/v4/console/lottery-user-analysis.js` | `/api/v4/console/lottery-user-analysis` | 用户分析 |
| `routes/v4/console/lottery-campaigns.js` | `/api/v4/console/lottery-campaigns` | 活动管理 |
| `routes/v4/console/lottery-configs.js` | `/api/v4/console/lottery-configs` | 策略配置 |
| `routes/v4/console/segment-rules.js` | `/api/v4/console/segment-rules` | 分群规则 |

**数据模型**：
| 模型文件 | 表名 | 主键 |
|---------|------|------|
| `models/LotteryCampaign.js` | lottery_campaigns | lottery_campaign_id (int) |
| `models/LotteryPrize.js` | lottery_prizes | lottery_prize_id (int) |
| `models/LotteryDraw.js` | lottery_draws | — |
| `models/LotteryTierRule.js` | lottery_tier_rules | lottery_tier_rule_id (int) |
| `models/LotteryStrategyConfig.js` | lottery_strategy_config | lottery_strategy_config_id (int) |
| `models/SegmentRuleConfig.js` | segment_rule_configs | segment_rule_config_id (int) |

---

## 九、数据库实时求证：文档 vs 真实数据的偏差修正

> 以下所有数据通过 Node.js 连接真实数据库 `restaurant_points_dev` 查询获得，不引用任何历史报告或备份文件。

### 1. 策略参数：文档默认值 vs 数据库实际值

文档中写的是代码默认值或 `.env` 注释中的参考值，但数据库 `lottery_strategy_config` 表中已有活动级配置，运行时以数据库为准。

| 策略 | 参数 | 文档写的默认值 | 数据库实际值（活动1） | 差异级别 |
|------|------|--------------|---------------------|---------|
| 防连空（Anti-Empty） | 触发阈值 | 8 次 | **3 次** | 🔴 重大偏差 |
| 防连高（Anti-High） | 统计窗口 | 10 次 | **5 次** | 🔴 重大偏差 |
| 防连高（Anti-High） | 触发阈值 | 3 次 | **2 次** | 🟡 偏差 |
| 运气债务（Luck Debt） | 期望空奖率 | 50% | **30%** | 🔴 重大偏差 |
| 运气债务（Luck Debt） | 最小样本量 | 20 次 | **10 次** | 🟡 偏差 |
| Pity 硬保底 | 阈值 | 10 次 | 10 次 | ✅ 一致 |
| Pity | 开关 | true | true | ✅ 一致 |
| 预算 B3 阈值 | — | 1000 | 1000 | ✅ 一致 |
| 预算 B2 阈值 | — | 500 | 500 | ✅ 一致 |
| 预算 B1 阈值 | — | 100 | 100 | ✅ 一致 |
| 压力 P2 阈值 | — | 0.8 | 0.8 | ✅ 一致 |
| 压力 P1 阈值 | — | 0.5 | 0.5 | ✅ 一致 |

**数据加载优先级实际验证**：`DynamicConfigLoader` 加载顺序为 数据库 > 环境变量 > 代码默认值。活动 1 在数据库有 17 条 `lottery_strategy_config` 记录，运行时使用的是数据库值而非文档写的默认值。

**Pity 倍数表（数据库实际值）**：
```
连续空奖次数: 0→1.0  1→1.0  2→1.2  3→1.5  4→1.8  5→2.2  6→2.8  7→3.5  8→5.0  9→10.0
```

### 2. 奖品权重配置：数据库实际问题

文档规则写的是"同档位内所有激活奖品的 `win_weight` 之和必须严格等于 1,000,000"，但数据库实际不合规：

| 档位 | 奖品数 | 权重总和 | 期望值 | 偏差 | 状态 |
|------|--------|---------|--------|------|------|
| high | 5 | **1,090,000** | 1,000,000 | +90,000 | 🔴 超出 |
| mid | 3 | **600,000** | 1,000,000 | -400,000 | 🔴 不足 |
| low | 7 | 1,000,000 | 1,000,000 | 0 | ✅ 正确 |

**high 档位奖品权重明细**：
| 奖品 | win_weight | 计算概率 |
|------|-----------|---------|
| 500积分券 | 700,000 | 64.2% |
| 九八折券 | 200,000 | 18.3% |
| 2000积分券 | 90,000 | 8.3% |
| 100积分 | 90,000 | 8.3% |
| 八八折 | 10,000 | 0.9% |

**mid 档位奖品权重明细**：
| 奖品 | win_weight | 计算概率 |
|------|-----------|---------|
| 甜品1份 | 350,000 | 58.3% |
| 精品首饰 | 150,000 | 25.0% |
| 生腌拼盘158 | 100,000 | 16.7% |

**注意**：代码中 `TierPickStage` 实际按奖品权重占比计算概率（`win_weight / 同档位权重总和`），所以即使总和不等于 1,000,000，选奖逻辑也能正常工作。但 `validatePrizeWeights()` 校验方法会报错，影响活动上线前校验。

### 3. 管理干预记录数

| 指标 | 文档写的 | 数据库实际 |
|------|---------|----------|
| 记录总数 | 6 条 | **≥10 条** |
| 状态 | 全部 cancelled | 全部 cancelled ✅ |
| 类型 | — | 全部 force_win |
| 操作人 | — | 全部 user_id=31, created_by=31 |

### 4. 定价配置：当前生效版本

活动 1 当前生效的定价配置是 **version 13**（status=active），base_cost=100：

| 按钮 | 抽奖次数 | 折扣 | 实际消耗积分 |
|------|---------|------|-------------|
| 单抽 | 1 | 1.0 | 100 |
| 3连抽 | 3 | 0.95 | 285 |
| 5连抽 | 5 | 0.93 | 465 |
| 10连抽 | 10 | 0.90 | 900 |

活动 27 有独立的定价配置（version 1: base_cost=500, version 2: base_cost=100 草稿状态）。

---

## 十、问题分类：后端 vs Web 管理后台前端

### 后端数据库项目的问题

| # | 问题 | 严重度 | 状态 | 说明 |
|---|------|--------|------|------|
| B1 | 活动 1 的 high/mid 档位奖品权重 | ✅ 已修复 | 2026-02-22 | high=1,000,000 mid=1,000,000 low=1,000,000 |
| B2 | `tier_fallback_lottery_prize_id` | ✅ 已修复 | 2026-02-22 | 设为 119（参与有礼） |
| B3 | 活动压力策略开关 | ✅ 已修复 | 2026-02-22 | `pressure_tier.enabled` 已插入 `lottery_strategy_config` 表 |
| B4 | BxPx 矩阵策略开关 | ✅ 已修复 | 2026-02-22 | `matrix.enabled` 已插入 `lottery_strategy_config` 表 |
| B5 | `max_draws_per_user_daily` | ✅ 已修复 | 2026-02-22 | 从 99 改为 3 |
| B6 | `lottery_management_settings` 表主键风格 | 🟢 低 | 待定 | 非阻塞，使用 varchar(50) 格式的业务ID |

### Web 管理后台前端项目的问题

| # | 问题 | 严重度 | 说明 |
|---|------|--------|------|
| W1 | 展示后端所有 12 套策略的当前状态和实际参数 | ✅ 已完成 | 从 `GET /api/v4/console/lottery-configs/strategies` 获取数据库实际值 |
| W2 | 奖品权重校验 `validateTierWeights()` | ✅ 已完成 | 加载分组数据后自动校验各档位权重总和 |
| W3 | 定价配置版本管理 UI | ✅ 已完成 | 13个版本迭代证明可用 |
| W4 | `display_mode` 下拉选择器 + grid_cols 联动 | ✅ 已完成 | 15 种展示模式下拉 + grid 模式联动显示列数 |

---

## 十一、后端技术架构可复用性分析

### 后端已有的、前端可直接复用的能力

| 能力 | 后端实现位置 | 对应 API | Web 管理后台使用 |
|------|------------|---------|----------------|
| 抽奖执行 | `UnifiedLotteryEngine.executeLottery()` | `POST /api/v4/lottery/draw` | ✅ 预设/干预通过管理 API |
| 活动列表/详情 | `LotteryCampaign` 模型 | `GET /api/v4/console/lottery-campaigns` | ✅ 已在用 |
| 奖品列表（按档位分组） | `PrizePoolService.getPrizesByCampaignGrouped()` | `GET /api/v4/console/prize-pool/:code/grouped` | ✅ 已在用 |
| 定价配置 | `LotteryPricingService` | `GET /api/v4/console/lottery-management/pricing-configs` | ✅ 已在用 |
| 用户分群规则 | `SegmentResolver` + `segment_rule_configs` 表 | `GET /api/v4/console/segment-rules` | ✅ 运营配置用 |
| 策略配置管理 | `DynamicConfigLoader` + `lottery_strategy_config` 表 | `GET /api/v4/console/lottery-configs/strategies` | ✅ 运营调参用 |
| BxPx 矩阵配置 | `TierMatrixCalculator` + `lottery_tier_matrix_config` 表 | 含在策略配置 API 中 | ✅ 运营配置用 |
| 抽奖统计/监控 | `StatsService` + 多个 metrics 表 | `GET /api/v4/console/lottery-statistics/*` | ✅ 运营监控用 |
| 用户抽奖分析 | 多表联查 | `GET /api/v4/console/lottery-user-analysis/*` | ✅ 运营分析用 |

### 后端可扩展的方向

| 扩展方向 | 现有支撑 | 需要做什么 | 工作量 |
|---------|---------|----------|--------|
| 新增抽奖玩法（前端展示） | `display_mode` 枚举已包含 15 种 | Web 后台已有下拉选择器，后端无需改动 | 0 |
| 新增分群版本（v5/v6…） | `segment_rule_configs` 表 + `SegmentResolver` | 运营后台添加新版本即可，代码无需改动 | 零代码 |
| 新增策略（如频率限制） | Pipeline + Stage 架构支持插入新 Stage | 新建 Stage 文件 + 注册到 Pipeline | 1-2 天 |
| 新增奖品类型 | `prize_type` 枚举 + `SettleStage` 发放逻辑 | 加枚举值 + 发放分支 | 1 天 |
| 多活动并行（已支持） | 活动级隔离（`lottery_campaign_id` 贯穿所有表） | 已完全支持，无需改动 | 0 |

---

## 十二、后端技术栈与 Web 管理后台前端技术栈的匹配度

### 后端技术栈总结

| 维度 | 技术选型 | 说明 |
|------|---------|------|
| 运行时 | Node.js 20+ | LTS 版本 |
| Web 框架 | Express 4.x | RESTful API |
| ORM | Sequelize 6.x | 模型定义、迁移管理、事务支持 |
| 数据库 | MySQL（mysql2 驱动） | Sealos 云托管 |
| 缓存 | Redis（ioredis） | 分布式锁、缓存 |
| API 版本 | `/api/v4/` | 扁平化 RESTful 资源导向 |
| 认证 | JWT Bearer Token | RBAC 权限控制 |
| 架构模式 | Pipeline + Stage（抽奖引擎）、Service 分层 | 可插拔、可扩展 |
| 配置管理 | 三层分离（数据库 > 环境变量 > 代码默认值） | 运行时可调 |

### Web 管理后台前端技术栈总结

| 维度 | 技术选型 | 说明 |
|------|---------|------|
| UI 框架 | Alpine.js 3.x | 轻量响应式 |
| 构建工具 | Vite 6.x | 开发热更新、生产构建 |
| CSS 框架 | Tailwind CSS 3.x | 原子化 CSS |
| 图表 | ECharts 6.x | 数据可视化 |
| 实时通信 | Socket.io-client | WebSocket |
| 应用模式 | 多页应用（MPA） | 每个 HTML 是独立入口 |
| 状态管理 | Alpine.js data + composables 模式 | 无额外状态管理库 |
| API 调用 | 统一 `request()` 封装（`src/api/base.js`） | `/api/v4` 前缀，Bearer Token 认证 |

### 匹配度评估

| 评估项 | 匹配度 | 说明 |
|--------|--------|------|
| API 规范对齐 | ✅ 完全匹配 | 前端已使用 `/api/v4/console/*` 路径体系 |
| 字段名直用 | ✅ 完全匹配 | 前端直接使用 `lottery_campaign_id`、`prize_name` 等后端字段名 |
| 认证体系 | ✅ 完全匹配 | 前端 `admin_token` → 后端 JWT Bearer → RBAC 权限验证 |
| 分页/排序 | ✅ 完全匹配 | 前端传 `page/limit/sort_by/sort_order` → 后端 Sequelize 处理 |
| 实时推送 | ✅ 完全匹配 | Socket.io-client ↔ Socket.io 服务端 |
| 构建部署 | ✅ 完全匹配 | Vite 构建输出到 `admin/dist/`，Express 静态托管 |

**结论**：Web 管理后台前端与后端技术栈已完全对齐，无需额外适配层。

---

## 十三、Pipeline 管线完整执行顺序（代码实际验证）

后端 `NormalDrawPipeline` 的 11 个 Stage 执行顺序（从 `NormalDrawPipeline.js` 代码确认）：

```
用户点"抽奖" → POST /api/v4/lottery/draw
  │
  ① LoadCampaignStage        → 加载活动配置、奖品列表、档位规则
  ② EligibilityStage         → 验证用户资格（积分、次数限制、活动有效性）
  ③ LoadDecisionSourceStage  → 判断决策来源（preset > override > normal）
  ④ BudgetContextStage       → 初始化预算上下文（BudgetProvider）
  ⑤ PricingStage             → 计算费用、验证积分余额、验证连抽白名单
  ⑥ BuildPrizePoolStage      → 构建可用奖品池（过滤库存/状态）
  ⑦ GuaranteeStage           → 固定间隔保底检查（guarantee_enabled）
  ⑧ TierPickStage            → 核心：分群→预算→压力→矩阵→体验平滑→选档位
  ⑨ PrizePickStage           → 从档位内按 win_weight 选具体奖品
  ⑩ DecisionSnapshotStage    → 记录决策快照（审计追溯用）
  ⑪ SettleStage              → 唯一写入点：扣积分、扣库存、扣预算、发奖品、写记录
```

Stage 设计原则：
- 只有 `SettleStage` 是 `is_writer: true`（执行数据库写操作）
- 其余 Stage 都是 `is_writer: false`（只读取和计算）
- 支持外部事务传入，确保原子性
- preset/override 模式在 ③ 判断后会跳过 ⑧⑨ 的正常选奖逻辑

### Pipeline 内 TierPickStage 的详细流程

```
TierPickStage.execute()
  │
  ├── 1. 检查 decision_source（preset/override → 跳过）
  ├── 2. 检查 pick_method（normalize → 跳过，return skip_reason='normalize_mode'）
  ├── 3. 解析用户分群（SegmentResolver.resolveSegmentAsync）
  │       优先读 segment_rule_configs 表 → 回退到 config/segment_rules.js 内置规则
  ├── 4. 获取分群对应的基础档位权重（lottery_tier_rules 表）
  ├── 5. 调用 LotteryComputeEngine.computeWeightAdjustment()
  │       └── BxPx 矩阵权重调整（lottery_tier_matrix_config 表）
  ├── 6. 体验平滑检查（PityCalculator / LuckDebtCalculator / AntiEmpty / AntiHigh）
  ├── 7. 按最终权重随机选 high/mid/low 档位
  └── 8. 降级路径：选中档位无可用奖品 → high→mid→low→fallback
```

---

## 十四、决策记录（全部已拍板）

> 以下决策于 2026-02-22 全部确认。

### 决策 1：`prize_id` vs `lottery_prize_id` 字段名统一 ✅ 已决定

**结论**：全系统统一使用 `lottery_prize_id`。

涉及的表/字段：`lottery_prizes.lottery_prize_id`、`lottery_draws.lottery_prize_id`、`guarantee_prize_id`、`tier_fallback_lottery_prize_id` 等所有引用奖品主键的地方，一律使用 `lottery_prize_id`，不使用缩写 `prize_id`。前端 props、API 参数、文档描述全部对齐。

### 决策 2：活动 1 的奖品权重不合规处理 ✅ 已决定

**结论**：选 A — **修正数据库**。运营后台调整权重使每个档位总和 = 1,000,000。

| 档位 | 当前权重总和 | 目标 | 操作 |
|------|------------|------|------|
| high | 1,090,000（超出） | 1,000,000 | 运营后台下调 |
| mid | 600,000（不足） | 1,000,000 | 运营后台上调 |
| low | 1,000,000 | 1,000,000 | 无需改动 |

代码中 `validatePrizeWeights()` 校验逻辑保持不变（总和必须 = 1,000,000），保证配置规范性。

### 决策 3：`display_mode` 实现范围 ✅ 已决定

**结论**：后端已支持 15 种 `display_mode`（VARCHAR 字段，可随时扩展）。Web 管理后台已在创建/编辑活动时提供下拉选择器 + grid_cols 联动。

Web 管理后台 `display_mode` 下拉选项：

| 类型 | display_mode 值 | 数据库当前使用 |
|------|----------------|--------------|
| 九宫格 | `grid_3x3` | ✅ 活动 25/26 |
| 十六宫格 | `grid_4x4` | ❌ |
| 大转盘 | `wheel` | ❌ |
| 翻牌 | `card_flip` | ✅ 活动 1 |
| 砸金蛋 | `golden_egg` | ❌ |
| 刮刮卡 | `scratch_card` | ✅ 活动 27 |
| 盲盒 | `blind_box` | ❌ |
| 扭蛋机 | `gashapon` | ❌ |
| 福袋 | `lucky_bag` | ❌ |
| 红包雨 | `red_packet` | ❌ |
| 老虎机 | `slot_machine` | ❌ |
| 打地鼠 | `whack_mole` | ❌ |
| 弹珠 | `pinball` | ❌ |
| 集卡 | `card_collect` | ❌ |
| 限时秒杀 | `flash_sale` | ❌ |

### 决策 4：策略参数展示 — 文档以代码默认值还是数据库值为准 ✅ 已决定

**结论**：文档保留当前的"代码默认值"列（作为设计基准），同时保留"活动 1 实际值"列（已在第九节完成）。运行时以数据库值为准。

### 决策 5：活动压力策略和 BxPx 矩阵策略是否加开关 ✅ 已决定

**结论**：选 B — **活动级配置**，通过 `DynamicConfigLoader` 加活动级开关。

实施方式：在 `lottery_strategy_config` 表增加 `pressure.enabled` + `matrix.enabled` 配置项，运营可按活动单独开关。`TierPickStage` 中读取这两个配置项，关闭时跳过对应计算（压力固定返回 P0，矩阵直接返回原始权重）。

工作量约 1 天，比环境变量开关更灵活（不同活动可独立控制）。

### 决策 6：前端字段命名统一 ✅ 已决定

**结论**：所有前端（Web 管理后台已在用、其他前端同理）统一使用后端字段名，接受全部 `snake_case`。

- 前端直接使用 `lottery_campaign_id`、`lottery_prize_id`、`display_mode`、`effect_theme`、`rarity_code`、`reward_tier` 等后端字段名，不做 camelCase 转换
- API 响应中的 `created_at`、`updated_at` 等时间字段，前端接收后直接使用（北京时间）
- 前端不引入任何字段映射层

### 决策 7：活动 1 的 `max_draws_per_user_daily` 修正 ✅ 已决定

**结论**：将活动 1 的 `max_draws_per_user_daily` 从 **99** 改为 **3**。

99 是测试遗留值，不符合实际运营需求。

### 决策 8：normalize 算法下的权重不合规处理方式 ✅ 已决定

**结论**：保留 normalize 算法代码，标记为 legacy。对于 normalize 模式下权重不合规的情况，采用**修正数据**的方式——由运营在后台修正实际权重数据，而非修改校验逻辑放宽限制。

### 决策 9：normalize 算法是否保留 ✅ 已决定

**结论**：选 A — **保留但标记为 legacy**。不删代码，文档标注"不推荐使用"。零成本，保留灵活性。

### 决策 10：测试数据清理方式 ✅ 已决定

**结论**：**不清理**。当前数据库中的测试数据（包括已结束的活动 25/26/27、管理干预的 cancelled 记录等）保持现状，不做清理。这些数据可作为前端开发和联调的参考样本。

---

## 十五、执行步骤总览（全部已完成 ✅ 2026-02-22，代码验证 ✅ 2026-02-23）

### Phase 1：后端数据修正 ✅ 已完成

| 步骤 | 内容 | 实施详情 | 状态 |
|------|------|---------|------|
| 1.1 | 修正活动 1 的 high 档位奖品权重 | 500积分券 win_weight: 700,000→610,000，总和 1,090,000→1,000,000 | ✅ |
| 1.2 | 修正活动 1 的 mid 档位奖品权重 | 按原始比例等比放大：甜品583,000/精品250,000/生腌167,000，总和 600,000→1,000,000 | ✅ |
| 1.3 | 指定 `tier_fallback_lottery_prize_id` | 设为 119（参与有礼，is_fallback=true 的空奖） | ✅ |
| 1.4 | 修正 `max_draws_per_user_daily` | 从测试值 99 改为运营值 3 | ✅ |
| 1.5 | 删除测试遗留奖品 | 删除 lottery_prize_id=151「测试奖品_验证后删除」，low 档恢复 1,000,000 | ✅ |

迁移文件：`migrations/20260222220000-add-pressure-matrix-switches-fix-campaign1-data.js`

### Phase 2：后端代码补强 ✅ 已完成

| 步骤 | 内容 | 实施详情 | 状态 |
|------|------|---------|------|
| 2.1 | `pressure_tier.enabled` 配置项 | 插入 lottery_strategy_config 表（活动1，默认 true） | ✅ |
| 2.2 | `matrix.enabled` 配置项 | 插入 lottery_strategy_config 表（活动1，默认 true） | ✅ |
| 2.3 | TierPickStage 开关逻辑 | 关闭 pressure → 固定 P0；关闭 matrix → 使用原始权重 | ✅ |

修改文件：`services/UnifiedLotteryEngine/pipeline/stages/TierPickStage.js`

### Phase 3：Web 管理后台前端补强 ✅ 已完成

| 步骤 | 内容 | 实施详情 | 状态 |
|------|------|---------|------|
| 3.1 | 奖品权重校验 | 前端 `validateTierWeights()` 在加载分组数据后自动校验各档位权重总和 | ✅ |
| 3.2 | 策略配置展示 | 已实现从 `GET /api/v4/console/lottery-configs/strategies` 获取数据库实际值 | ✅ |
| 3.3 | `display_mode` 选择器 | 已实现 14 种展示模式下拉 + grid_cols 联动 | ✅ |

修改文件：`admin/src/modules/lottery/composables/prizes.js`

---

## 十六、微信小程序前端对接指南

> 以下内容供微信小程序前端开发人员使用，所有字段名、API 路径以后端数据库为准，前端直接使用 snake_case，不做映射。

### 1. 核心 API 端点

#### 1.1 抽奖执行

```
POST /api/v4/lottery/draw
Headers:
  Authorization: Bearer <jwt_token>
  Idempotency-Key: <唯一请求ID，如 UUID>
Body:
  {
    "campaign_code": "string",  // 活动编码（非活动ID）
    "draw_count": 1             // 抽奖次数（1/3/5/10）
  }
Response:
  {
    "success": true,
    "data": {
      "draws": [
        {
          "lottery_draw_id": 12345,
          "lottery_prize_id": 6,
          "prize_name": "500积分券",
          "prize_type": "coupon",       // physical/virtual/coupon/points/empty
          "rarity_code": "rare",        // common/uncommon/rare/epic/legendary
          "reward_tier": "high",        // high/mid/low
          "is_empty": false,            // 是否空奖
          "decision_source": "normal",  // normal/preset/override
          "points_deducted": 100        // 本次扣减积分
        }
      ],
      "total_cost": 100,               // 总消耗积分
      "remaining_balance": 4900,        // 剩余积分
      "remaining_daily_draws": 2        // 今日剩余抽奖次数
    }
  }
```

#### 1.2 获取活动列表（用户端）

```
GET /api/v4/lottery/campaigns
Response:
  {
    "success": true,
    "data": {
      "campaigns": [
        {
          "lottery_campaign_id": 1,
          "campaign_code": "restaurant_points_lottery",
          "campaign_name": "餐厅积分抽奖",
          "display_mode": "card_flip",        // 前端展示模式（14种）
          "effect_theme": "gold_luxury",      // 特效主题（6套）
          "status": "active",
          "max_draws_per_user_daily": 3,      // 每日限制次数
          "start_time": "2025-12-01T00:00:00+08:00",
          "end_time": "2027-12-31T23:59:59+08:00"
        }
      ]
    }
  }
```

#### 1.3 获取活动配置（含定价）

```
GET /api/v4/lottery/campaigns/:code/config
示例: GET /api/v4/lottery/campaigns/restaurant_points_lottery/config
Headers:
  Authorization: Bearer <jwt_token>
Response:
  {
    "success": true,
    "data": {
      "base_cost": 100,           // 单抽消耗积分
      "draw_buttons": [
        { "draw_count": 1,  "discount": 1.0,  "total_cost": 100 },
        { "draw_count": 3,  "discount": 0.95, "total_cost": 285 },
        { "draw_count": 5,  "discount": 0.93, "total_cost": 465 },
        { "draw_count": 10, "discount": 0.90, "total_cost": 900 }
      ]
    }
  }
```

#### 1.4 获取抽奖历史

```
GET /api/v4/lottery/history?page=1&page_size=20
Headers:
  Authorization: Bearer <jwt_token>
Response:
  {
    "success": true,
    "data": {
      "draws": [
        {
          "lottery_draw_id": 12345,
          "prize_name": "500积分券",
          "prize_type": "coupon",
          "rarity_code": "rare",
          "reward_tier": "high",
          "is_empty": false,
          "points_deducted": 100,
          "created_at": "2026-02-22T15:30:00+08:00"
        }
      ],
      "pagination": { "page": 1, "page_size": 20, "total": 150 }
    }
  }
```

#### 1.5 获取奖品展示列表（用户端）

```
GET /api/v4/lottery/campaigns/:code/prizes
示例: GET /api/v4/lottery/campaigns/restaurant_points_lottery/prizes
Headers:
  Authorization: Bearer <jwt_token>
Response:
  {
    "success": true,
    "data": {
      "prizes": [
        {
          "lottery_prize_id": 1,
          "prize_name": "八八折",
          "prize_type": "coupon",
          "rarity_code": "legendary",
          "reward_tier": "high",
          "image_url": "https://...",     // 奖品图片URL
          "prize_description": "全场消费打八八折"
        }
      ]
    }
  }
```

### 2. 前端展示模式（display_mode）对应关系

微信小程序需要根据后端返回的 `display_mode` 字段选择对应的前端展示组件：

| display_mode 值 | 中文名称 | 前端展示建议 |
|----------------|---------|-------------|
| `grid_3x3` | 九宫格 3×3 | 9 个格子转动停止 |
| `grid_4x4` | 十六宫格 4×4 | 16 个格子转动停止 |
| `wheel` | 大转盘 | Canvas 绘制转盘旋转 |
| `card_flip` | 翻牌 | 卡片翻转动画 |
| `golden_egg` | 砸金蛋 | 3 个金蛋点击砸开 |
| `scratch_card` | 刮刮卡 | Canvas 擦除覆盖层 |
| `blind_box` | 盲盒 | 盒子打开动画 |
| `gashapon` | 扭蛋机 | 扭蛋机动画 |
| `lucky_bag` | 福袋 | 福袋打开动画 |
| `red_packet` | 红包雨 | 红包下落点击 |
| `slot_machine` | 老虎机 | 3 列滚动停止 |
| `whack_mole` | 打地鼠 | 地鼠出现点击 |
| `pinball` | 弹珠 | 弹珠下落停在奖品上 |
| `card_collect` | 集卡 | 集齐卡片兑换 |
| `flash_sale` | 限时秒杀 | 倒计时抢购 |

MVP 阶段建议先实现 `card_flip`（当前活动 1 使用）和 `grid_3x3`（活动 25/26 使用），其余可用兜底展示。

### 3. 特效主题（effect_theme）

| effect_theme 值 | 中文名称 | 视觉特征 |
|-----------------|---------|---------|
| `default` | 默认主题 | 标准配色 |
| `gold_luxury` | 金色奢华 | 金色主调 + 闪光粒子 |
| `cherry_blossom` | 樱花浪漫 | 粉色主调 + 花瓣飘落 |
| `ocean_blue` | 海洋蔚蓝 | 蓝色主调 + 波纹效果 |
| `neon_night` | 霓虹之夜 | 紫色主调 + 霓虹光效 |
| `festival_red` | 节日红 | 红色主调 + 鞭炮烟花 |

### 4. 稀有度展示（rarity_code）

前端需要根据 `rarity_code` 展示不同视觉效果（边框颜色、动画等级）：

| rarity_code | 中文名称 | 推荐颜色 | 动画等级 |
|------------|---------|---------|---------|
| `common` | 普通 | #9E9E9E（灰色） | 无特效 |
| `uncommon` | 稀有 | #4CAF50（绿色） | 轻微发光 |
| `rare` | 精良 | #2196F3（蓝色） | 闪烁光环 |
| `epic` | 史诗 | #9C27B0（紫色） | 旋转光效 |
| `legendary` | 传说 | #FF9800（橙色） | 全屏特效 |

### 5. 关键业务字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `lottery_campaign_id` | int | 活动主键（事务实体，路由参数用 :id） |
| `campaign_code` | string | 活动编码（配置实体，抽奖 API 用此字段） |
| `lottery_prize_id` | int | 奖品主键 |
| `display_mode` | string | 前端展示模式（15 种枚举） |
| `effect_theme` | string | 特效主题（6 套） |
| `rarity_code` | string | 稀有度代码（5 级） |
| `reward_tier` | string | 所属档位（high/mid/low） |
| `prize_type` | string | 奖品类型（physical/virtual/coupon/points/empty） |
| `is_empty` | boolean | 是否空奖（prize_type='empty' 或标记为空奖） |
| `win_weight` | int | 选奖权重（百万分制，前端不需要关心，仅后端算法使用） |
| `points_deducted` | int | 本次抽奖扣减积分 |

### 6. 前端不需要关心的后端内部字段

以下字段是后端算法/运营内部使用，不会出现在用户端 API 响应中：

- `win_probability` — 百分比概率（normalize 算法用，当前无活动使用）
- `budget_tier` / `pressure_tier` — 预算/压力分层（后端策略引擎内部）
- `segment_key` — 用户分群标识（后端决策日志内部）
- `decision_source` — 仅在抽奖结果中出现（用于前端判断是否触发特殊逻辑）
- `is_fallback` — 是否兜底奖品（运营配置用）

### 7. 认证方式

```
所有用户端 API 需要 JWT Bearer Token：
  Authorization: Bearer eyJhbGciOiJIUzI1NiIs...

登录接口：
  POST /api/v4/auth/login
  Body: { "mobile": "13612227930", "verification_code": "123456" }
  Response: { "data": { "access_token": "eyJ...", "user": { ... } } }
```

### 8. 错误码约定

| HTTP 状态码 | 业务 code | 含义 |
|------------|----------|------|
| 400 | MISSING_PARAMETER | 缺少必需参数 |
| 400 | INVALID_DRAW_COUNT | 抽奖次数无效（需为 1/3/5/10） |
| 400 | DRAW_COUNT_OUT_OF_RANGE | 抽奖次数超出范围 |
| 400 | MISSING_IDEMPOTENCY_KEY | 缺少幂等键 |
| 400 | INSUFFICIENT_POINTS | 积分不足 |
| 400 | DAILY_DRAW_LIMIT_REACHED | 今日抽奖次数已达上限 |
| 401 | UNAUTHORIZED | 未登录或 Token 过期 |
| 404 | CAMPAIGN_NOT_FOUND | 活动不存在 |
| 409 | IDEMPOTENCY_CONFLICT | 幂等键冲突（重复请求） |
| 500 | INTERNAL_ERROR | 服务端错误 |

---

## 十七、修正后的数据库实际状态（2026-02-22 实施后）

### 活动 1 奖品权重（修正后）

| 档位 | 奖品数 | 权重总和 | 状态 |
|------|--------|---------|------|
| high | 5 | 1,000,000 | ✅ 已修正 |
| mid | 3 | 1,000,000 | ✅ 已修正 |
| low | 7 | 1,000,000 | ✅ 已修正（删除测试奖品后） |

### high 档位权重明细（修正后）

| 奖品 | win_weight | 计算概率 |
|------|-----------|---------|
| 500积分券 | **610,000** | 61.0% |
| 九八折券 | 200,000 | 20.0% |
| 2000积分券 | 90,000 | 9.0% |
| 100积分 | 90,000 | 9.0% |
| 八八折 | 10,000 | 1.0% |

### mid 档位权重明细（修正后）

| 奖品 | win_weight | 计算概率 |
|------|-----------|---------|
| 甜品1份 | **583,000** | 58.3% |
| 精品首饰 | **250,000** | 25.0% |
| 生腌拼盘158 | **167,000** | 16.7% |

### 活动 1 配置字段（修正后）

| 字段 | 修正前 | 修正后 |
|------|--------|--------|
| `tier_fallback_lottery_prize_id` | NULL | **119**（参与有礼） |
| `max_draws_per_user_daily` | 99 | **3** |

### 策略开关状态

| 开关 | config_group | config_key | 值 | 说明 |
|------|-------------|------------|-----|------|
| 保底系统 | pity | enabled | true | 连续空奖逐步提高非空概率 |
| 运气债务 | luck_debt | enabled | true | 长期运气差补偿 |
| 防连空 | anti_empty | enabled | true | 连续空奖 3 次强制出奖 |
| 防连高 | anti_high | enabled | true | 最近 5 次内超 2 次 high 则限制 |
| **活动压力** | pressure_tier | enabled | **true** | **新增：TierPickStage 通过 `DynamicConfigLoader.getValue('pressure_tier', 'enabled')` 读取，关闭后固定 P0** |
| **BxPx 矩阵** | matrix | enabled | **true** | **新增：TierPickStage 通过 `DynamicConfigLoader.getValue('matrix', 'enabled')` 读取，关闭后使用原始权重** |

---

**true** | **新增：关闭后使用原始权重** |

---

