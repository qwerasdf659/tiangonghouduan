# ğŸ¢ å±‚çº§åŒ–è§’è‰²æƒé™ç®¡ç†æ–¹æ¡ˆï¼ˆå®ç”¨ä¸»ä¹‰ç‰ˆæœ¬ï¼‰

**åˆ›å»ºæ—¶é—´**ï¼š2025å¹´11æœˆ06æ—¥  
**æœ€åæ›´æ–°**ï¼š2025å¹´11æœˆ07æ—¥ 21:43 åŒ—äº¬æ—¶é—´  
**é€‚ç”¨åœºæ™¯**ï¼šåŒºåŸŸè´Ÿè´£äººâ†’ä¸šåŠ¡ç»ç†â†’ä¸šåŠ¡å‘˜ä¸‰çº§ç®¡ç†ç»“æ„  
**æ ¸å¿ƒéœ€æ±‚**ï¼šå¿«é€Ÿæ‰¹é‡è°ƒæ•´å’Œå…³é—­ä¸‹çº§äººå‘˜æƒé™  
**é¡¹ç›®**ï¼šé¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ V4.0 ç»Ÿä¸€å¼•æ“æ¶æ„  
**æ•°æ®è§„æ¨¡**ï¼šå°å‹é¡¹ç›®ï¼ˆé¢„æœŸç”¨æˆ·<1000ï¼Œå¯èƒ½æš‚åœä¸šåŠ¡ï¼‰  
**æŠ€æœ¯æ ˆ**ï¼šNode.js + Express + Sequelize + MySQL + UUIDè§’è‰²ç³»ç»Ÿ  
**æ ¸å¿ƒä¾èµ–**ï¼šåŸºäºé¡¹ç›®ç°æœ‰çš„UUIDè§’è‰²ç³»ç»Ÿï¼ˆUserã€Roleã€UserRoleæ¨¡å‹ï¼‰

---

## âš ï¸ é‡è¦ï¼šå®ç”¨ä¸»ä¹‰è®¾è®¡ç†å¿µ

### **æ ¸å¿ƒåŸåˆ™**

> **"ä¸è¦ä¸ºäº†é‡æ„è€Œé‡æ„ï¼Œè¦ä¸ºäº†é™ä½ç»´æŠ¤æˆæœ¬è€Œé‡æ„"**

æœ¬æ–¹æ¡ˆéµå¾ªä»¥ä¸‹å®ç”¨ä¸»ä¹‰åŸåˆ™ï¼š

1. **ğŸ¯ ç®€å•ä¼˜å…ˆ**
   - é¿å…è¿‡åº¦è®¾è®¡ï¼Œåªå®ç°æ ¸å¿ƒå¿…éœ€åŠŸèƒ½
   - ä»£ç ç®€å•æ˜“æ‡‚ï¼Œæ–°äººå¯ä»¥å¿«é€Ÿä¸Šæ‰‹
   - ä¸è¿½æ±‚å®Œç¾ï¼Œè¿½æ±‚å¤Ÿç”¨å’Œç¨³å®š

2. **ğŸ“Š å°æ•°æ®é‡ä¼˜åŒ–**
   - å½“å‰é¡¹ç›®é¢„æœŸç”¨æˆ·é‡<1000ï¼Œå±‚çº§å…³ç³»<200æ¡
   - ä¸éœ€è¦å¤æ‚çš„ç¼“å­˜ç­–ç•¥ï¼ˆæ•°æ®åº“æŸ¥è¯¢å·²ç»å¾ˆå¿«ï¼‰
   - ä¸éœ€è¦åˆ†é¡µåŠŸèƒ½ï¼ˆä¸€æ¬¡æ€§æŸ¥è¯¢å³å¯ï¼‰
   - ç®€å•çš„ç´¢å¼•ç­–ç•¥å³å¯ï¼ˆè¿‡å¤šç´¢å¼•åè€Œé™ä½å†™å…¥æ€§èƒ½ï¼‰

3. **ğŸ’° ä½ç»´æŠ¤æˆæœ¬**
   - ä»£ç å¤æ‚åº¦ä½ï¼Œå‡å°‘æ½œåœ¨bug
   - ä¸ä¾èµ–é¢å¤–çš„ç¬¬ä¸‰æ–¹æœåŠ¡
   - ä¸å¼•å…¥è¿‡åº¦æŠ½è±¡å’Œè®¾è®¡æ¨¡å¼
   - æ˜“äºç†è§£å’Œä¿®æ”¹

4. **ğŸ”„ å¯æ‰©å±•æ€§è€ƒè™‘**
   - å¦‚æœæœªæ¥ä¸šåŠ¡æ‰©å¤§ï¼Œå¯ä»¥é€æ­¥ä¼˜åŒ–
   - å½“å‰è®¾è®¡ä¸é˜»ç¢æœªæ¥æ‰©å±•
   - ä½†ä¸ä¸ºæœªæ¥å¯èƒ½æ€§è¿‡åº¦è®¾è®¡

### **ç®€åŒ–è¯´æ˜**

ç›¸æ¯”å®Œæ•´çš„å±‚çº§æƒé™ç³»ç»Ÿï¼Œæœ¬æ–¹æ¡ˆ**ç®€åŒ–æˆ–ç§»é™¤**äº†ä»¥ä¸‹å†…å®¹ï¼š

- âŒ **ä¸éœ€è¦** `hierarchy_path` å­—æ®µï¼ˆå°æ•°æ®é‡ä¸‹é€’å½’æŸ¥è¯¢æ€§èƒ½è¶³å¤Ÿï¼‰
- âŒ **ä¸éœ€è¦** Redisç¼“å­˜ï¼ˆé¡¹ç›®å·²æœ‰authç¼“å­˜ï¼Œæ— éœ€é‡å¤ï¼‰
- âŒ **ä¸éœ€è¦** åˆ†é¡µæŸ¥è¯¢ï¼ˆä¸‹çº§æ•°é‡å°‘ï¼Œä¸€æ¬¡æ€§æŸ¥è¯¢å³å¯ï¼‰
- âŒ **ä¸éœ€è¦** å¤æ‚çš„ç´¢å¼•ç­–ç•¥ï¼ˆåŸºæœ¬ç´¢å¼•å³å¯ï¼‰
- âœ… **ä¿ç•™** æ ¸å¿ƒå±‚çº§å…³ç³»ç®¡ç†ï¼ˆå¿…éœ€åŠŸèƒ½ï¼‰
- âœ… **ä¿ç•™** æ‰¹é‡åœç”¨/æ¿€æ´»ï¼ˆæ ¸å¿ƒéœ€æ±‚ï¼‰
- âœ… **ä¿ç•™** æƒé™éªŒè¯ï¼ˆå®‰å…¨åŸºç¡€ï¼‰
- âœ… **ä¿ç•™** æ“ä½œæ—¥å¿—ï¼ˆå®¡è®¡éœ€æ±‚ï¼‰

### **ä¸ç°æœ‰ç³»ç»Ÿå¯¹æ¥**

æœ¬æ–¹æ¡ˆ**å¤ç”¨é¡¹ç›®ç°æœ‰åŸºç¡€è®¾æ–½**ï¼Œä¸å¢åŠ æŠ€æœ¯å€ºåŠ¡ï¼š

- âœ… **ä½¿ç”¨ç°æœ‰UUIDè§’è‰²ç³»ç»Ÿ**ï¼šå¤ç”¨Roleã€Userã€UserRoleæ¨¡å‹
- âœ… **ä½¿ç”¨ç°æœ‰è®¤è¯ä¸­é—´ä»¶**ï¼šå¤ç”¨authenticateTokenã€requireAdmin
- âœ… **ä½¿ç”¨ç°æœ‰æ—¶é—´å·¥å…·**ï¼šå¤ç”¨BeijingTimeHelperå·¥å…·ç±»
- âœ… **éµå¾ªV4.0æ¶æ„è§„èŒƒ**ï¼šè·¯ç”±ã€é”™è¯¯å¤„ç†ã€æ—¥å¿—è®°å½•ç»Ÿä¸€æ ‡å‡†

---

## ğŸ“‹ ç›®å½•

1. [ä¸šåŠ¡åœºæ™¯è¯´æ˜](#ä¸šåŠ¡åœºæ™¯è¯´æ˜)
2. [éœ€æ±‚åˆ†æ](#éœ€æ±‚åˆ†æ)
3. [æ•°æ®åº“è®¾è®¡ï¼ˆç®€åŒ–ç‰ˆï¼‰](#æ•°æ®åº“è®¾è®¡ç®€åŒ–ç‰ˆ)
4. [æ ¸å¿ƒåŠŸèƒ½å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰](#æ ¸å¿ƒåŠŸèƒ½å®ç°ç®€åŒ–ç‰ˆ)
5. [APIæ¥å£è®¾è®¡](#apiæ¥å£è®¾è®¡)
6. [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
7. [æ‰©å±•ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰](#æ‰©å±•ä¼˜åŒ–å¯é€‰)

---

## ğŸ¬ ä¸šåŠ¡åœºæ™¯è¯´æ˜

### **å®é™…ä¸šåŠ¡æ¨¡å‹**

è¿™æ˜¯ä¸€ä¸ª**åŒºåŸŸåŒ–ä¸šåŠ¡æ¨å¹¿ç®¡ç†ç³»ç»Ÿ**ï¼Œç”¨äºç®¡ç†é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿçš„çº¿ä¸‹æ¨å¹¿å›¢é˜Ÿã€‚

#### **ä¸šåŠ¡è§’è‰²å®šä¹‰**

1. **åŒºåŸŸè´Ÿè´£äºº (Regional Manager)**
   - è´Ÿè´£æ•´ä¸ªåŒºåŸŸçš„ä¸šåŠ¡æ‹“å±•
   - ç®¡ç†å¤šä¸ªä¸šåŠ¡ç»ç†
   - å¯ä»¥æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰ä¸‹çº§çš„ä¸šåŠ¡æ•°æ®
   - æƒé™çº§åˆ«ï¼š`role_level: 80`

2. **ä¸šåŠ¡ç»ç† (Business Manager)**
   - è´Ÿè´£å…·ä½“åŒºåŸŸå†…çš„ä¸šåŠ¡æ¨å¹¿
   - ç®¡ç†å¤šä¸ªä¸šåŠ¡å‘˜
   - åˆ†é…ä¸šåŠ¡å‘˜åˆ°ä¸åŒé—¨åº—
   - æƒé™çº§åˆ«ï¼š`role_level: 60`

3. **ä¸šåŠ¡å‘˜ (Sales Staff)**
   - å®é™…é©»åº—æˆ–æµåŠ¨ä¸šåŠ¡äººå‘˜
   - è´Ÿè´£å…·ä½“é—¨åº—çš„æ¶ˆè´¹è®°å½•å½•å…¥å’Œç§¯åˆ†æ¨å¹¿
   - å…³è”åˆ°å…·ä½“é—¨åº—ï¼ˆ`store_id`ï¼‰
   - æƒé™çº§åˆ«ï¼š`role_level: 40`

#### **å…¸å‹ä¸šåŠ¡æµç¨‹**

```mermaid
graph TD
    A[åŒºåŸŸè´Ÿè´£äºº] -->|åˆ†é…ç®¡è¾–åŒºåŸŸ| B[ä¸šåŠ¡ç»ç†1]
    A -->|åˆ†é…ç®¡è¾–åŒºåŸŸ| C[ä¸šåŠ¡ç»ç†2]
    B -->|åˆ†æ´¾åˆ°é—¨åº—A| D[ä¸šåŠ¡å‘˜1]
    B -->|åˆ†æ´¾åˆ°é—¨åº—B| E[ä¸šåŠ¡å‘˜2]
    C -->|åˆ†æ´¾åˆ°é—¨åº—C| F[ä¸šåŠ¡å‘˜3]
    D -->|å½•å…¥æ¶ˆè´¹è®°å½•| G[é—¨åº—Açš„æ¶ˆè´¹æ•°æ®]
    E -->|å½•å…¥æ¶ˆè´¹è®°å½•| H[é—¨åº—Bçš„æ¶ˆè´¹æ•°æ®]
    F -->|å½•å…¥æ¶ˆè´¹è®°å½•| I[é—¨åº—Cçš„æ¶ˆè´¹æ•°æ®]
```

#### **æ ¸å¿ƒä¸šåŠ¡åœºæ™¯**

1. **æ–°ä¸šåŠ¡å‘˜å…¥èŒ**
   - åŒºåŸŸè´Ÿè´£äººåˆ›å»ºä¸šåŠ¡ç»ç†è´¦å·
   - ä¸šåŠ¡ç»ç†åˆ›å»ºä¸šåŠ¡å‘˜è´¦å·
   - ä¸šåŠ¡å‘˜åˆ†æ´¾åˆ°å…·ä½“é—¨åº—
   - å»ºç«‹å±‚çº§å…³ç³»

2. **ä¸šåŠ¡å‘˜ç¦»èŒ/è°ƒåŠ¨**
   - ä¸šåŠ¡ç»ç†éœ€è¦å¿«é€Ÿåœç”¨ä¸šåŠ¡å‘˜æƒé™
   - ä¿ç•™ä¸šåŠ¡å‘˜çš„å†å²æ•°æ®ï¼ˆè½¯åˆ é™¤ï¼‰
   - è®°å½•æ“ä½œæ—¥å¿—ç”¨äºå®¡è®¡

3. **ä¸šåŠ¡ç»ç†ç¦»èŒ**
   - åŒºåŸŸè´Ÿè´£äººéœ€è¦æ‰¹é‡åœç”¨ä¸šåŠ¡ç»ç†åŠå…¶æ‰€æœ‰ä¸‹å±çš„æƒé™
   - ä¸€é”®æ“ä½œï¼Œé¿å…é—æ¼
   - å®Œæ•´çš„æ“ä½œå®¡è®¡è¿½è¸ª

4. **æƒé™éš”ç¦»**
   - ä¸šåŠ¡ç»ç†åªèƒ½ç®¡ç†è‡ªå·±çš„ä¸‹å±
   - ä¸èƒ½è·¨åŒºåŸŸç®¡ç†
   - ä¸èƒ½æŸ¥çœ‹å…¶ä»–ä¸šåŠ¡ç»ç†çš„æ•°æ®

---

## ğŸ¯ éœ€æ±‚åˆ†æ

### **ç»„ç»‡æ¶æ„å±‚çº§**

```
è¶…çº§ç®¡ç†å‘˜ (role_level: 100) - ç³»ç»Ÿç®¡ç†å‘˜
    â†“
åŒºåŸŸè´Ÿè´£äºº (role_level: 80) - ç®¡ç†æ•´ä¸ªåŒºåŸŸ
    â†“
ä¸šåŠ¡ç»ç† (role_level: 60) Ã— Näºº - ç®¡ç†å…·ä½“åŒºåŸŸ
    â†“
ä¸šåŠ¡å‘˜ (role_level: 40) Ã— Mäºº/ä¸šåŠ¡ç»ç† - é©»åº—ä¸šåŠ¡äººå‘˜
```

### **æ ¸å¿ƒéœ€æ±‚**

1. **å±‚çº§ç®¡ç†**ï¼šä¸Šçº§å¯ä»¥ç®¡ç†æ‰€æœ‰ä¸‹çº§çš„æƒé™å’Œæ•°æ®è®¿é—®èŒƒå›´
2. **æ‰¹é‡æ“ä½œ**ï¼šæ”¯æŒä¸€é”®å…³é—­æŸä¸ªä¸šåŠ¡ç»ç†åŠå…¶æ‰€æœ‰ä¸‹å±çš„æƒé™
3. **æƒé™éš”ç¦»**ï¼šä¸šåŠ¡ç»ç†åªèƒ½ç®¡ç†è‡ªå·±çš„ä¸‹å±ï¼Œä¸èƒ½è·¨åŒºåŸŸç®¡ç†
4. **å¿«é€Ÿå“åº”**ï¼šæƒé™å˜æ›´ç«‹å³ç”Ÿæ•ˆï¼ˆç¼“å­˜å¤±æ•ˆæœºåˆ¶ï¼‰
5. **å®¡è®¡è¿½è¸ª**ï¼šè®°å½•æ‰€æœ‰æƒé™å˜æ›´æ“ä½œï¼ŒåŒ…æ‹¬æ“ä½œäººã€æ“ä½œæ—¶é—´ã€æ“ä½œåŸå› 
6. **é—¨åº—å…³è”**ï¼šä¸šåŠ¡å‘˜å¿…é¡»å…³è”åˆ°å…·ä½“é—¨åº—ï¼Œç”¨äºæ¶ˆè´¹è®°å½•çš„æ•°æ®éš”ç¦»

### **âš ï¸ é‡è¦å®‰å…¨è®¾è®¡åŸåˆ™**

**æ‰¹é‡åœç”¨æƒé™çš„å®‰å…¨æœºåˆ¶**ï¼š

- **é»˜è®¤è¡Œä¸º**ï¼šåœç”¨æƒé™æ—¶ï¼Œé»˜è®¤ä»…åœç”¨ç›®æ ‡ç”¨æˆ·æœ¬äººï¼Œä¸è‡ªåŠ¨æ‰¹é‡åœç”¨å…¶æ‰€æœ‰ä¸‹çº§
- **ä¸»åŠ¨é€‰æ‹©**ï¼šéœ€è¦æ‰¹é‡åœç”¨æ‰€æœ‰ä¸‹çº§æ—¶ï¼Œå¿…é¡»æ˜ç¡®ä¼ å…¥`include_subordinates: true`å‚æ•°
- **é˜²æ­¢è¯¯æ“ä½œ**ï¼šé¿å…æ“ä½œäººå‘˜è¯¯æ“ä½œå¯¼è‡´å¤§é‡ä¸‹çº§ç”¨æˆ·æƒé™è¢«æ„å¤–åœç”¨
- **ä¸šåŠ¡åœºæ™¯é€‚é…**ï¼š
  - âœ… ä¸šåŠ¡å‘˜ç¦»èŒ/è¿è§„ â†’ é»˜è®¤ä»…åœç”¨ä¸šåŠ¡å‘˜æœ¬äººï¼ˆä¸å½±å“å…¶ä»–äººï¼‰
  - âœ… ä¸šåŠ¡ç»ç†ç¦»èŒ â†’ æ˜ç¡®é€‰æ‹©æ‰¹é‡åœç”¨ï¼ˆéœ€è¦ä¸»åŠ¨ç¡®è®¤ï¼‰
  
**è®¾è®¡ç†å¿µ**ï¼š**æ˜¾å¼ä¼˜äºéšå¼**ï¼ˆExplicit is better than implicitï¼‰ï¼Œé‡è¦æ“ä½œéœ€è¦æ˜ç¡®çš„ç”¨æˆ·æ„å›¾ç¡®è®¤

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡ï¼ˆç®€åŒ–ç‰ˆï¼‰

### **è®¾è®¡ç†å¿µ**

> **ä¸ºå°æ•°æ®é‡ä¼˜åŒ–ï¼Œä¿æŒç®€å•ï¼Œé¿å…è¿‡åº¦è®¾è®¡**

- ç”¨æˆ·é‡é¢„æœŸ<1000ï¼Œå±‚çº§å…³ç³»é¢„æœŸ<200æ¡
- ä¸ä½¿ç”¨å¤æ‚çš„ `hierarchy_path` å­—æ®µï¼ˆé€’å½’æŸ¥è¯¢æ€§èƒ½è¶³å¤Ÿï¼‰
- æœ€å°åŒ–ç´¢å¼•æ•°é‡ï¼ˆå‡å°‘å†™å…¥å¼€é”€ï¼‰
- ä¿ç•™æ ¸å¿ƒåŠŸèƒ½å­—æ®µï¼Œåˆ é™¤å†—ä½™å­—æ®µ

### **æ•°æ®åº“è¡¨å…³ç³»å›¾**

```
users (ç”¨æˆ·è¡¨ - å·²å­˜åœ¨)
  â†“
user_roles (ç”¨æˆ·è§’è‰²å…³è”è¡¨ - å·²å­˜åœ¨) â† roles (è§’è‰²è¡¨ - å·²å­˜åœ¨)
  â†“
user_hierarchy (ç”¨æˆ·å±‚çº§å…³ç³»è¡¨ - æ–°å¢ï¼Œç®€åŒ–ç‰ˆ)
  â†“
role_change_logs (è§’è‰²å˜æ›´æ—¥å¿—è¡¨ - æ–°å¢)

stores (é—¨åº—è¡¨ - å¯é€‰ï¼Œå¦‚æœéœ€è¦é—¨åº—ç®¡ç†åŠŸèƒ½)
```

### **1. åˆ›å»º `stores` è¡¨ï¼ˆé—¨åº—ä¿¡æ¯è¡¨ï¼‰**

> **è¯´æ˜**ï¼šé—¨åº—è¡¨ç”¨äºè®°å½•åˆä½œå•†å®¶çš„é—¨åº—ä¿¡æ¯ï¼Œä¸šåŠ¡å‘˜ä¼šè¢«åˆ†æ´¾åˆ°å…·ä½“é—¨åº—å·¥ä½œ

```sql
-- åˆ›å»ºé—¨åº—ä¿¡æ¯è¡¨
CREATE TABLE IF NOT EXISTS `stores` (
  `store_id` INT(11) NOT NULL AUTO_INCREMENT COMMENT 'é—¨åº—IDï¼ˆä¸»é”®ï¼‰',
  `store_name` VARCHAR(100) NOT NULL COMMENT 'é—¨åº—åç§°ï¼ˆå¦‚ï¼šæŸæŸé¤å…XXåº—ï¼‰',
  `store_code` VARCHAR(50) NULL COMMENT 'é—¨åº—ç¼–å·ï¼ˆå”¯ä¸€æ ‡è¯†ï¼Œå¦‚ï¼šST20250101001ï¼‰',
  `store_address` VARCHAR(200) NULL COMMENT 'é—¨åº—åœ°å€ï¼ˆè¯¦ç»†åœ°å€ï¼‰',
  `contact_name` VARCHAR(50) NULL COMMENT 'é—¨åº—è”ç³»äººå§“å',
  `contact_mobile` VARCHAR(20) NULL COMMENT 'é—¨åº—è”ç³»ç”µè¯',
  `region` VARCHAR(50) NULL COMMENT 'æ‰€å±åŒºåŸŸï¼ˆå¦‚ï¼šä¸œåŸåŒºã€è¥¿åŸåŒºï¼‰',
  `status` ENUM('active', 'inactive', 'pending') DEFAULT 'active' COMMENT 'é—¨åº—çŠ¶æ€ï¼šactive-æ­£å¸¸è¥ä¸šï¼Œinactive-å·²å…³é—­ï¼Œpending-å¾…å®¡æ ¸',
  `assigned_to` INT(11) NULL COMMENT 'åˆ†é…ç»™å“ªä¸ªä¸šåŠ¡å‘˜ï¼ˆå¤–é”®å…³è”users.user_idï¼‰',
  `merchant_id` INT(11) NULL COMMENT 'å•†æˆ·IDï¼ˆå…³è”å•†å®¶ç”¨æˆ·ï¼Œå¤–é”®å…³è”users.user_idï¼‰',
  `notes` TEXT NULL COMMENT 'å¤‡æ³¨ä¿¡æ¯',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´ï¼ˆé—¨åº—ä¿¡æ¯å½•å…¥æ—¶é—´ï¼‰ï¼Œæ—¶åŒºï¼šåŒ—äº¬æ—¶é—´ï¼ˆGMT+8ï¼‰',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´ï¼ˆæœ€åä¿®æ”¹æ—¶é—´ï¼‰ï¼Œæ—¶åŒºï¼šåŒ—äº¬æ—¶é—´ï¼ˆGMT+8ï¼‰',
  PRIMARY KEY (`store_id`),
  UNIQUE KEY `uk_store_code` (`store_code`),
  KEY `idx_status` (`status`),
  KEY `idx_region` (`region`),
  KEY `idx_assigned_to` (`assigned_to`),
  KEY `idx_merchant_id` (`merchant_id`),
  CONSTRAINT `fk_store_assigned_to` FOREIGN KEY (`assigned_to`) REFERENCES `users` (`user_id`) ON DELETE SET NULL,
  CONSTRAINT `fk_store_merchant` FOREIGN KEY (`merchant_id`) REFERENCES `users` (`user_id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='é—¨åº—ä¿¡æ¯è¡¨ï¼ˆç”¨äºè®°å½•åˆä½œå•†å®¶é—¨åº—ï¼Œä¸šåŠ¡å‘˜åˆ†æ´¾ä¾æ®ï¼‰';
```

### **2. æ‰©å±• `roles` è¡¨ï¼ˆå¯é€‰ï¼šå¦‚æœéœ€è¦åœ¨Roleè¡¨ä¸­è®°å½•å±‚çº§å…³ç³»ï¼‰**

> **è¯´æ˜**ï¼šåœ¨ç°æœ‰çš„UUIDè§’è‰²ç³»ç»ŸåŸºç¡€ä¸Šï¼Œå¢åŠ å±‚çº§ç®¡ç†ç›¸å…³å­—æ®µ
> 
> **âš ï¸ å®ç”¨ä¸»ä¹‰å»ºè®®**ï¼šå¯¹äºå°æ•°æ®é‡é¡¹ç›®ï¼Œå¯ä»¥**ä¸æ‰©å±•rolesè¡¨**ï¼Œç›´æ¥åœ¨user_hierarchyè¡¨ä¸­é€šè¿‡role_idå…³è”å³å¯ã€‚ä»¥ä¸‹æ‰©å±•å­—æ®µä»…åœ¨éœ€è¦åœ¨è§’è‰²æ¨¡å‹å±‚é¢å®šä¹‰å±‚çº§å…³ç³»æ—¶æ‰æ·»åŠ ã€‚

```sql
-- âš ï¸ å¯é€‰ï¼šå¦‚æœéœ€è¦åœ¨è§’è‰²æ¨¡å‹ä¸­å®šä¹‰å±‚çº§å…³ç³»æ‰æ·»åŠ ï¼ˆå°é¡¹ç›®å¯è·³è¿‡ï¼‰
-- ä¸ºrolesè¡¨æ·»åŠ å±‚çº§ç®¡ç†å­—æ®µï¼ˆå¯é€‰ï¼‰
ALTER TABLE `roles` 
ADD COLUMN `parent_role_id` INT(11) NULL COMMENT 'çˆ¶è§’è‰²IDï¼ˆç”¨äºå®šä¹‰è§’è‰²å±‚çº§ï¼Œå¦‚ä¸šåŠ¡ç»ç†çš„çˆ¶è§’è‰²æ˜¯åŒºåŸŸè´Ÿè´£äººï¼‰' AFTER `role_level`,
ADD COLUMN `max_subordinates` INT(11) DEFAULT 0 COMMENT 'æœ€å¤§ä¸‹å±æ•°é‡é™åˆ¶ï¼ˆ0è¡¨ç¤ºæ— é™åˆ¶ï¼Œä»…åšè½¯é™åˆ¶æç¤ºï¼‰' AFTER `parent_role_id`,
ADD COLUMN `can_manage_subordinates` TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦å¯ä»¥ç®¡ç†ä¸‹å±ï¼ˆ1=å¯ä»¥ï¼Œ0=ä¸å¯ä»¥ï¼ŒåŸºäºrole_levelä¹Ÿèƒ½åˆ¤æ–­ï¼‰' AFTER `max_subordinates`,
ADD INDEX `idx_parent_role` (`parent_role_id`);

-- ğŸ“ è¯´æ˜ï¼šå°æ•°æ®é‡é¡¹ç›®å»ºè®®ç›´æ¥åœ¨ä»£ç é€»è¾‘ä¸­åˆ¤æ–­ï¼ˆåŸºäºrole_levelï¼‰ï¼Œä¸éœ€è¦è¿™äº›å†—ä½™å­—æ®µ
-- ç†ç”±ï¼š
-- 1. å¢åŠ æ•°æ®åº“å¤æ‚åº¦ï¼Œé™ä½ç»´æŠ¤æ•ˆç‡
-- 2. role_levelæœ¬èº«å·²ç»èƒ½åŒºåˆ†å±‚çº§å…³ç³»ï¼ˆ80 > 60 > 40ï¼‰
-- 3. can_manage_subordinateså¯é€šè¿‡ä»£ç é€»è¾‘åˆ¤æ–­ï¼šrole_level >= 60å³å¯ç®¡ç†
-- 4. max_subordinatesåœ¨å°æ•°æ®é‡ä¸‹æ²¡æœ‰å®é™…ä»·å€¼
```

### **3. åˆ›å»º `user_hierarchy` è¡¨ï¼ˆç”¨æˆ·å±‚çº§å…³ç³»è¡¨ - ç®€åŒ–ç‰ˆï¼‰**

> **è¯´æ˜**ï¼šæ ¸å¿ƒè¡¨ï¼Œè®°å½•ç”¨æˆ·ä¹‹é—´çš„ä¸Šä¸‹çº§å…³ç³»
> 
> **ç®€åŒ–ç†å¿µ**ï¼š
> - âŒ ç§»é™¤ `hierarchy_path` å­—æ®µï¼ˆå°æ•°æ®é‡ä¸‹é€’å½’æŸ¥è¯¢æ€§èƒ½è¶³å¤Ÿï¼Œæ— éœ€ä¼˜åŒ–ï¼‰
> - âŒ ç§»é™¤ `hierarchy_level` å­—æ®µï¼ˆå¯ä»¥é€šè¿‡é€’å½’è®¡ç®—ï¼Œé¿å…æ•°æ®å†—ä½™ï¼‰
> - âœ… ä¿ç•™æ ¸å¿ƒå­—æ®µï¼šä¸Šä¸‹çº§å…³ç³»ã€æ¿€æ´»çŠ¶æ€ã€åœç”¨ä¿¡æ¯

```sql
CREATE TABLE IF NOT EXISTS `user_hierarchy` (
  `hierarchy_id` INT(11) NOT NULL AUTO_INCREMENT COMMENT 'å±‚çº§å…³ç³»IDï¼ˆä¸»é”®ï¼‰',
  `user_id` INT(11) NOT NULL COMMENT 'ç”¨æˆ·IDï¼ˆå½“å‰ç”¨æˆ·ï¼‰',
  `superior_user_id` INT(11) NULL COMMENT 'ä¸Šçº§ç”¨æˆ·IDï¼ˆNULLè¡¨ç¤ºé¡¶çº§åŒºåŸŸè´Ÿè´£äººï¼‰',
  `role_id` INT(11) NOT NULL COMMENT 'å½“å‰è§’è‰²IDï¼ˆå…³è”rolesè¡¨ï¼Œå¦‚ï¼š1=ä¸šåŠ¡å‘˜ï¼Œ2=ä¸šåŠ¡ç»ç†ï¼Œ3=åŒºåŸŸè´Ÿè´£äººï¼‰',
  `store_id` INT(11) NULL COMMENT 'æ‰€å±é—¨åº—IDï¼ˆä»…ä¸šåŠ¡å‘˜æœ‰å€¼ï¼Œä¸šåŠ¡ç»ç†å’ŒåŒºåŸŸè´Ÿè´£äººä¸ºNULLï¼‰',
  `is_active` TINYINT(1) DEFAULT 1 COMMENT 'å±‚çº§å…³ç³»æ˜¯å¦æœ‰æ•ˆï¼ˆ1=æ¿€æ´»ï¼Œ0=å·²åœç”¨ï¼‰',
  `activated_at` DATETIME NULL COMMENT 'æ¿€æ´»æ—¶é—´ï¼ˆé¦–æ¬¡æ¿€æ´»æˆ–é‡æ–°æ¿€æ´»æ—¶è®°å½•ï¼‰ï¼Œæ—¶åŒºï¼šåŒ—äº¬æ—¶é—´ï¼ˆGMT+8ï¼‰',
  `deactivated_at` DATETIME NULL COMMENT 'åœç”¨æ—¶é—´ï¼ˆåœç”¨æ—¶è®°å½•ï¼‰ï¼Œæ—¶åŒºï¼šåŒ—äº¬æ—¶é—´ï¼ˆGMT+8ï¼‰',
  `deactivated_by` INT(11) NULL COMMENT 'åœç”¨æ“ä½œäººIDï¼ˆè°åœç”¨çš„ï¼Ÿå¤–é”®å…³è”users.user_idï¼‰',
  `deactivation_reason` TEXT NULL COMMENT 'åœç”¨åŸå› ï¼ˆå¦‚ï¼šç¦»èŒã€è°ƒåŠ¨ã€è¿è§„ç­‰ï¼‰',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´ï¼Œæ—¶åŒºï¼šåŒ—äº¬æ—¶é—´ï¼ˆGMT+8ï¼‰',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´ï¼Œæ—¶åŒºï¼šåŒ—äº¬æ—¶é—´ï¼ˆGMT+8ï¼‰',
  PRIMARY KEY (`hierarchy_id`),
  UNIQUE KEY `uk_user_role` (`user_id`, `role_id`) COMMENT 'ä¸€ä¸ªç”¨æˆ·åœ¨åŒä¸€è§’è‰²ä¸‹åªèƒ½æœ‰ä¸€æ¡å±‚çº§è®°å½•',
  KEY `idx_superior_user` (`superior_user_id`) COMMENT 'æŸ¥è¯¢æŸä¸ªä¸Šçº§çš„æ‰€æœ‰ç›´æ¥ä¸‹å±',
  KEY `idx_is_active` (`is_active`) COMMENT 'ç­›é€‰æ¿€æ´»/åœç”¨çŠ¶æ€',
  CONSTRAINT `fk_user_hierarchy_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`user_id`) ON DELETE CASCADE,
  CONSTRAINT `fk_user_hierarchy_superior` FOREIGN KEY (`superior_user_id`) REFERENCES `users` (`user_id`) ON DELETE SET NULL,
  CONSTRAINT `fk_user_hierarchy_role` FOREIGN KEY (`role_id`) REFERENCES `roles` (`role_id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç”¨æˆ·å±‚çº§å…³ç³»è¡¨ï¼ˆç®€åŒ–ç‰ˆï¼šä»…ä¿ç•™æ ¸å¿ƒå­—æ®µå’Œå¿…è¦ç´¢å¼•ï¼‰';
```

**ç®€åŒ–è¯´æ˜**ï¼š
- **ç§»é™¤å­—æ®µ**ï¼š`hierarchy_path`ï¼ˆå°æ•°æ®é‡ä¸‹é€’å½’æŸ¥è¯¢è¶³å¤Ÿå¿«ï¼‰ã€`hierarchy_level`ï¼ˆå¯åŠ¨æ€è®¡ç®—ï¼‰
- **ç®€åŒ–ç´¢å¼•**ï¼šä»…ä¿ç•™3ä¸ªæ ¸å¿ƒç´¢å¼•ï¼ˆ`superior_user_id`ã€`is_active`ã€`user_id+role_id`ï¼‰
- **æ€§èƒ½è€ƒé‡**ï¼šå¯¹äº<200æ¡è®°å½•ï¼Œç®€å•çš„ç´¢å¼•ç­–ç•¥å·²ç»è¶³å¤Ÿï¼Œè¿‡å¤šç´¢å¼•åè€Œé™ä½INSERT/UPDATEæ€§èƒ½

### **3. åˆ›å»º `role_change_logs` è¡¨ï¼ˆæƒé™å˜æ›´æ—¥å¿—è¡¨ï¼‰**

```sql
CREATE TABLE IF NOT EXISTS `role_change_logs` (
  `log_id` INT(11) NOT NULL AUTO_INCREMENT COMMENT 'æ—¥å¿—ID',
  `target_user_id` INT(11) NOT NULL COMMENT 'ç›®æ ‡ç”¨æˆ·ID',
  `operator_user_id` INT(11) NOT NULL COMMENT 'æ“ä½œäººID',
  `operation_type` ENUM('activate', 'deactivate', 'role_change', 'batch_deactivate') NOT NULL COMMENT 'æ“ä½œç±»å‹',
  `old_role_id` INT(11) NULL COMMENT 'åŸè§’è‰²ID',
  `new_role_id` INT(11) NULL COMMENT 'æ–°è§’è‰²ID',
  `affected_count` INT(11) DEFAULT 1 COMMENT 'å½±å“çš„ç”¨æˆ·æ•°é‡ï¼ˆæ‰¹é‡æ“ä½œæ—¶ï¼‰',
  `reason` TEXT NULL COMMENT 'æ“ä½œåŸå› ',
  `ip_address` VARCHAR(50) NULL COMMENT 'æ“ä½œIPåœ°å€',
  `user_agent` TEXT NULL COMMENT 'ç”¨æˆ·ä»£ç†ä¿¡æ¯',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`log_id`),
  KEY `idx_target_user` (`target_user_id`),
  KEY `idx_operator_user` (`operator_user_id`),
  KEY `idx_operation_type` (`operation_type`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_role_log_target` FOREIGN KEY (`target_user_id`) REFERENCES `users` (`user_id`) ON DELETE CASCADE,
  CONSTRAINT `fk_role_log_operator` FOREIGN KEY (`operator_user_id`) REFERENCES `users` (`user_id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è§’è‰²æƒé™å˜æ›´æ—¥å¿—è¡¨';
```

### **5. åˆå§‹åŒ–å±‚çº§è§’è‰²æ•°æ®ï¼ˆå®ç”¨ä¸»ä¹‰ç®€åŒ–ç‰ˆï¼‰**

> **è¯´æ˜**ï¼šåˆå§‹åŒ–ä¸‰ä¸ªä¸šåŠ¡è§’è‰²ï¼Œå»ºç«‹å±‚çº§å…³ç³»
> 
> **âš ï¸ å®ç”¨ä¸»ä¹‰å»ºè®®**ï¼šä»…æ·»åŠ æ ¸å¿ƒå­—æ®µï¼Œä¸æ·»åŠ å†—ä½™çš„parent_role_idç­‰å­—æ®µï¼ˆå› ä¸ºrole_levelå·²ç»èƒ½è¡¨ç¤ºå±‚çº§ï¼‰

```sql
-- æ’å…¥å±‚çº§è§’è‰²é…ç½®ï¼ˆç®€åŒ–ç‰ˆï¼šä»…æ ¸å¿ƒå­—æ®µï¼‰
-- ä½¿ç”¨é¡¹ç›®ç°æœ‰çš„rolesè¡¨ç»“æ„ï¼ˆrole_id, role_uuid, role_name, role_level, permissions, description, is_activeï¼‰
INSERT INTO `roles` (`role_name`, `role_level`, `permissions`, `description`, `is_active`) VALUES
-- åŒºåŸŸè´Ÿè´£äººï¼ˆRegional Managerï¼‰- æœ€é«˜ä¸šåŠ¡æƒé™level=80
('regional_manager', 80, 
 JSON_OBJECT(
   'users', JSON_ARRAY('read', 'create', 'update', 'delete'),
   'stores', JSON_ARRAY('read', 'create', 'update', 'delete'),
   'hierarchy', JSON_ARRAY('read', 'create', 'update', 'delete'),
   'staff', JSON_ARRAY('read', 'create', 'update', 'delete'),
   'consumption', JSON_ARRAY('read', 'create', 'update', 'delete'),
   'reports', JSON_ARRAY('read')
 ), 
 'åŒºåŸŸè´Ÿè´£äººï¼ˆå¯ç®¡ç†ä¸šåŠ¡ç»ç†å’Œä¸šåŠ¡å‘˜ï¼ŒæŸ¥çœ‹æ‰€æœ‰ä¸šåŠ¡æ•°æ®ï¼Œæƒé™çº§åˆ«80ï¼‰', 
 1),

-- ä¸šåŠ¡ç»ç†ï¼ˆBusiness Managerï¼‰- ä¸­çº§æƒé™level=60
('business_manager', 60, 
 JSON_OBJECT(
   'stores', JSON_ARRAY('read', 'update'),
   'staff', JSON_ARRAY('read', 'create', 'update'),
   'consumption', JSON_ARRAY('read', 'create', 'update', 'delete'),
   'reports', JSON_ARRAY('read'),
   'hierarchy', JSON_ARRAY('read')
 ), 
 'ä¸šåŠ¡ç»ç†ï¼ˆå¯ç®¡ç†ä¸šåŠ¡å‘˜ï¼Œå½•å…¥å’Œç®¡ç†æ¶ˆè´¹è®°å½•ï¼ŒæŸ¥çœ‹ä¸šåŠ¡æŠ¥è¡¨ï¼Œæƒé™çº§åˆ«60ï¼‰', 
 1),

-- ä¸šåŠ¡å‘˜ï¼ˆSales Staffï¼‰- åŸºç¡€æƒé™level=40
('sales_staff', 40, 
 JSON_OBJECT(
   'stores', JSON_ARRAY('read'),
   'consumption', JSON_ARRAY('read', 'create'),
   'profile', JSON_ARRAY('read', 'update')
 ), 
 'ä¸šåŠ¡å‘˜ï¼ˆå¯å½•å…¥æ¶ˆè´¹è®°å½•ï¼ŒæŸ¥çœ‹åˆ†é…é—¨åº—ä¿¡æ¯ï¼Œç®¡ç†ä¸ªäººä¿¡æ¯ï¼Œæƒé™çº§åˆ«40ï¼‰', 
 1)
ON DUPLICATE KEY UPDATE 
  `role_level` = VALUES(`role_level`),
  `permissions` = VALUES(`permissions`),
  `description` = VALUES(`description`),
  `is_active` = VALUES(`is_active`);

-- ğŸ“ è¯´æ˜ï¼š
-- 1. ä¸ä½¿ç”¨parent_role_idå­—æ®µï¼Œç›´æ¥é€šè¿‡role_levelæ•°å€¼åˆ¤æ–­å±‚çº§å…³ç³»ï¼ˆ80 > 60 > 40ï¼‰
-- 2. ä¸ä½¿ç”¨max_subordinateså­—æ®µï¼Œé€šè¿‡ä»£ç é€»è¾‘é™åˆ¶ï¼ˆå°æ•°æ®é‡æ— éœ€æ•°æ®åº“å±‚é¢é™åˆ¶ï¼‰
-- 3. ä¸ä½¿ç”¨can_manage_subordinateså­—æ®µï¼Œé€šè¿‡role_level >= 60åˆ¤æ–­æ˜¯å¦å¯ç®¡ç†
-- 4. å±‚çº§å…³ç³»é€šè¿‡user_hierarchyè¡¨ç»´æŠ¤ï¼Œrolesè¡¨ä»…å®šä¹‰æƒé™æ¨¡æ¿
```

**æƒé™è¯´æ˜**ï¼š

| è§’è‰² | role_level | æƒé™èŒƒå›´ | å¯ç®¡ç†ä¸‹å± |
|------|------------|---------|-----------|
| regional_manager | 80 | å…¨éƒ¨æƒé™ï¼ˆ*ï¼‰ | âœ… æ˜¯ |
| business_manager | 60 | é—¨åº—ç®¡ç†ã€äººå‘˜ç®¡ç†ã€æ¶ˆè´¹è®°å½• | âœ… æ˜¯ |
| sales_staff | 40 | æ¶ˆè´¹è®°å½•å½•å…¥ã€ä¸ªäººä¿¡æ¯ | âŒ å¦ |

---

## ğŸ’» æ ¸å¿ƒåŠŸèƒ½å®ç°

### **å®ç°æ¦‚è§ˆ**

æœ¬æ–¹æ¡ˆéœ€è¦åˆ›å»ºä»¥ä¸‹4ä¸ªæ–‡ä»¶ï¼š

1. `/home/devbox/project/models/Store.js` - é—¨åº—æ¨¡å‹
2. `/home/devbox/project/models/UserHierarchy.js` - ç”¨æˆ·å±‚çº§å…³ç³»æ¨¡å‹
3. `/home/devbox/project/models/RoleChangeLog.js` - è§’è‰²å˜æ›´æ—¥å¿—æ¨¡å‹
4. `/home/devbox/project/services/HierarchyManagementService.js` - å±‚çº§ç®¡ç†æœåŠ¡
5. `/home/devbox/project/routes/v4/hierarchy/index.js` - APIè·¯ç”±

---

### **1. åˆ›å»º Store æ¨¡å‹ï¼ˆé—¨åº—ä¿¡æ¯ï¼‰**

**æ–‡ä»¶è·¯å¾„**ï¼š`/home/devbox/project/models/Store.js`

```javascript
/**
 * é—¨åº—ä¿¡æ¯æ¨¡å‹ - é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ V4.0 ç»Ÿä¸€å¼•æ“æ¶æ„
 * ä¸šåŠ¡åœºæ™¯ï¼šè®°å½•åˆä½œå•†å®¶é—¨åº—ä¿¡æ¯ï¼Œç”¨äºä¸šåŠ¡å‘˜åˆ†æ´¾å’Œæ¶ˆè´¹è®°å½•å…³è”
 * åˆ›å»ºæ—¶é—´ï¼š2025å¹´11æœˆ07æ—¥
 */

/**
 * ğŸ’¡ è¯´æ˜ï¼šæœ¬ä»£ç ä¸é¡¹ç›®ç°æœ‰æŠ€æœ¯æ ˆå®Œå…¨ä¸€è‡´
 * - ä½¿ç”¨é¡¹ç›®ç°æœ‰çš„ BeijingTimeHelper æ—¶é—´å·¥å…·ï¼ˆä½äº /home/devbox/project/utils/timeHelper.jsï¼‰
 * - éµå¾ªé¡¹ç›®ç°æœ‰çš„ Sequelize æ¨¡å‹å®šä¹‰è§„èŒƒ
 * - æ—¶é—´å­—æ®µç»Ÿä¸€ä½¿ç”¨åŒ—äº¬æ—¶é—´ï¼ˆGMT+8ï¼‰ï¼Œä¸é¡¹ç›®å…¶ä»–æ¨¡å‹ä¿æŒä¸€è‡´
 * - å…³è”å…³ç³»å®šä¹‰éµå¾ªé¡¹ç›®ç°æœ‰æ¨¡å‹çš„ associate æ–¹æ³•è§„èŒƒ
 */

const { DataTypes } = require('sequelize')
const BeijingTimeHelper = require('../utils/timeHelper') // å¤ç”¨é¡¹ç›®ç°æœ‰æ—¶é—´å·¥å…·

module.exports = sequelize => {
  const Store = sequelize.define(
    'Store',
    {
      // é—¨åº—IDï¼ˆä¸»é”®ï¼‰
      store_id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        autoIncrement: true,
        comment: 'é—¨åº—IDï¼ˆä¸»é”®ï¼‰'
      },

      // é—¨åº—åç§°
      store_name: {
        type: DataTypes.STRING(100),
        allowNull: false,
        comment: 'é—¨åº—åç§°ï¼ˆå¦‚ï¼šæŸæŸé¤å…XXåº—ï¼‰'
      },

      // é—¨åº—ç¼–å·ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
      store_code: {
        type: DataTypes.STRING(50),
        allowNull: true,
        unique: true,
        comment: 'é—¨åº—ç¼–å·ï¼ˆå”¯ä¸€æ ‡è¯†ï¼Œå¦‚ï¼šST20250101001ï¼‰'
      },

      // é—¨åº—åœ°å€
      store_address: {
        type: DataTypes.STRING(200),
        allowNull: true,
        comment: 'é—¨åº—åœ°å€ï¼ˆè¯¦ç»†åœ°å€ï¼‰'
      },

      // é—¨åº—è”ç³»äºº
      contact_name: {
        type: DataTypes.STRING(50),
        allowNull: true,
        comment: 'é—¨åº—è”ç³»äººå§“å'
      },

      // è”ç³»ç”µè¯
      contact_mobile: {
        type: DataTypes.STRING(20),
        allowNull: true,
        comment: 'é—¨åº—è”ç³»ç”µè¯'
      },

      // æ‰€å±åŒºåŸŸ
      region: {
        type: DataTypes.STRING(50),
        allowNull: true,
        comment: 'æ‰€å±åŒºåŸŸï¼ˆå¦‚ï¼šä¸œåŸåŒºã€è¥¿åŸåŒºï¼‰'
      },

      // é—¨åº—çŠ¶æ€
      status: {
        type: DataTypes.ENUM('active', 'inactive', 'pending'),
        defaultValue: 'active',
        comment: 'é—¨åº—çŠ¶æ€ï¼šactive-æ­£å¸¸è¥ä¸šï¼Œinactive-å·²å…³é—­ï¼Œpending-å¾…å®¡æ ¸'
      },

      // åˆ†é…ç»™å“ªä¸ªä¸šåŠ¡å‘˜
      assigned_to: {
        type: DataTypes.INTEGER,
        allowNull: true,
        comment: 'åˆ†é…ç»™å“ªä¸ªä¸šåŠ¡å‘˜ï¼ˆå¤–é”®å…³è”users.user_idï¼‰'
      },

      // å•†æˆ·ID
      merchant_id: {
        type: DataTypes.INTEGER,
        allowNull: true,
        comment: 'å•†æˆ·IDï¼ˆå…³è”å•†å®¶ç”¨æˆ·ï¼Œå¤–é”®å…³è”users.user_idï¼‰'
      },

      // å¤‡æ³¨ä¿¡æ¯
      notes: {
        type: DataTypes.TEXT,
        allowNull: true,
        comment: 'å¤‡æ³¨ä¿¡æ¯'
      }
    },
    {
      tableName: 'stores',
      timestamps: true,
      createdAt: 'created_at',
      updatedAt: 'updated_at',
      underscored: true,
      indexes: [
        { unique: true, fields: ['store_code'] },
        { fields: ['status'] },
        { fields: ['region'] },
        { fields: ['assigned_to'] },
        { fields: ['merchant_id'] }
      ],
      comment: 'é—¨åº—ä¿¡æ¯è¡¨ï¼ˆç”¨äºè®°å½•åˆä½œå•†å®¶é—¨åº—ï¼Œä¸šåŠ¡å‘˜åˆ†æ´¾ä¾æ®ï¼‰',

      // é’©å­å‡½æ•°ï¼šç¡®ä¿ä½¿ç”¨åŒ—äº¬æ—¶é—´
      hooks: {
        beforeSave: (store, _options) => {
          if (!store.created_at) {
            store.created_at = BeijingTimeHelper.createDatabaseTime()
          }
          store.updated_at = BeijingTimeHelper.createDatabaseTime()
        }
      }
    }
  )

  // å®šä¹‰å…³è”å…³ç³»
  Store.associate = function (models) {
    // å¤šå¯¹ä¸€ï¼šå¤šä¸ªé—¨åº—åˆ†é…ç»™ä¸€ä¸ªä¸šåŠ¡å‘˜
    Store.belongsTo(models.User, {
      foreignKey: 'assigned_to',
      as: 'assignedStaff',
      comment: 'åˆ†é…çš„ä¸šåŠ¡å‘˜'
    })

    // å¤šå¯¹ä¸€ï¼šå¤šä¸ªé—¨åº—å±äºä¸€ä¸ªå•†æˆ·
    Store.belongsTo(models.User, {
      foreignKey: 'merchant_id',
      as: 'merchant',
      comment: 'å•†æˆ·ä¿¡æ¯'
    })

    // ä¸€å¯¹å¤šï¼šä¸€ä¸ªé—¨åº—æœ‰å¤šä¸ªæ¶ˆè´¹è®°å½•
    if (models.ConsumptionRecord) {
      Store.hasMany(models.ConsumptionRecord, {
        foreignKey: 'store_id',
        as: 'consumption_records',
        comment: 'é—¨åº—çš„æ¶ˆè´¹è®°å½•'
      })
    }

    // ä¸€å¯¹å¤šï¼šä¸€ä¸ªé—¨åº—æœ‰å¤šä¸ªå±‚çº§å…³ç³»è®°å½•ï¼ˆä¸šåŠ¡å‘˜åˆ†æ´¾å†å²ï¼‰
    if (models.UserHierarchy) {
      Store.hasMany(models.UserHierarchy, {
        foreignKey: 'store_id',
        as: 'hierarchy_records',
        comment: 'ä¸šåŠ¡å‘˜åˆ†æ´¾å†å²è®°å½•'
      })
    }
  }

  return Store
}
```

---

### **2. åˆ›å»º UserHierarchy æ¨¡å‹ï¼ˆç”¨æˆ·å±‚çº§å…³ç³» - ç®€åŒ–ç‰ˆï¼‰**

**æ–‡ä»¶è·¯å¾„**ï¼š`/home/devbox/project/models/UserHierarchy.js`

> **ç®€åŒ–è¯´æ˜**ï¼šç§»é™¤äº† `hierarchy_path` å’Œ `hierarchy_level` å­—æ®µï¼Œä¿æŒæ¨¡å‹ç®€å•

```javascript
/**
 * ç”¨æˆ·å±‚çº§å…³ç³»æ¨¡å‹ï¼ˆç®€åŒ–ç‰ˆï¼‰ - é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ V4.0 ç»Ÿä¸€å¼•æ“æ¶æ„
 * ä¸šåŠ¡åœºæ™¯ï¼šç®¡ç†ç”¨æˆ·çš„ä¸Šä¸‹çº§å…³ç³»å’Œæƒé™å±‚çº§
 * åˆ›å»ºæ—¶é—´ï¼š2025å¹´11æœˆ07æ—¥
 * è®¾è®¡ç†å¿µï¼šç®€å•å®ç”¨ï¼Œé¿å…è¿‡åº¦è®¾è®¡
 *
 * æ ¸å¿ƒåŠŸèƒ½ï¼š
 * 1. è®°å½•ç”¨æˆ·ä¹‹é—´çš„ä¸Šä¸‹çº§å…³ç³»ï¼ˆåŒºåŸŸè´Ÿè´£äººâ†’ä¸šåŠ¡ç»ç†â†’ä¸šåŠ¡å‘˜ï¼‰
 * 2. æ”¯æŒæƒé™æ¿€æ´»/åœç”¨ç®¡ç†
 * 3. è®°å½•å®Œæ•´çš„æ“ä½œå®¡è®¡ä¿¡æ¯
 * 
 * ç®€åŒ–å†…å®¹ï¼š
 * - ç§»é™¤ hierarchy_path å­—æ®µï¼ˆå°æ•°æ®é‡ä¸‹é€’å½’æŸ¥è¯¢è¶³å¤Ÿå¿«ï¼‰
 * - ç§»é™¤ hierarchy_level å­—æ®µï¼ˆå¯åŠ¨æ€è®¡ç®—ï¼Œé¿å…æ•°æ®å†—ä½™ï¼‰
 * 
 * ğŸ’¡ ä¸é¡¹ç›®ç°æœ‰æŠ€æœ¯æ ˆçš„å¯¹æ¥ï¼š
 * - å¤ç”¨é¡¹ç›®ç°æœ‰çš„ BeijingTimeHelperï¼ˆä½äº /home/devbox/project/utils/timeHelper.jsï¼‰
 * - å…³è”ç°æœ‰çš„ Userã€Role æ¨¡å‹ï¼ˆå·²å­˜åœ¨äº models/User.js å’Œ models/Role.jsï¼‰
 * - éµå¾ªé¡¹ç›®ç°æœ‰çš„ Sequelize æ¨¡å‹å®šä¹‰å’Œå…³è”è§„èŒƒ
 * - æ—¶é—´å­—æ®µä½¿ç”¨åŒ—äº¬æ—¶é—´ï¼ˆGMT+8ï¼‰ï¼Œä¸é¡¹ç›®å…¶ä»–æ¨¡å‹ä¿æŒä¸€è‡´
 */

const { DataTypes } = require('sequelize')
const BeijingTimeHelper = require('../utils/timeHelper') // å¤ç”¨é¡¹ç›®ç°æœ‰æ—¶é—´å·¥å…·

module.exports = sequelize => {
  const UserHierarchy = sequelize.define(
    'UserHierarchy',
    {
      // å±‚çº§å…³ç³»IDï¼ˆä¸»é”®ï¼‰
      hierarchy_id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        autoIncrement: true,
        comment: 'å±‚çº§å…³ç³»IDï¼ˆä¸»é”®ï¼‰'
      },

      // ç”¨æˆ·ID
      user_id: {
        type: DataTypes.INTEGER,
        allowNull: false,
        comment: 'ç”¨æˆ·IDï¼ˆå½“å‰ç”¨æˆ·ï¼‰'
      },

      // ä¸Šçº§ç”¨æˆ·ID
      superior_user_id: {
        type: DataTypes.INTEGER,
        allowNull: true,
        comment: 'ä¸Šçº§ç”¨æˆ·IDï¼ˆNULLè¡¨ç¤ºé¡¶çº§åŒºåŸŸè´Ÿè´£äººï¼‰'
      },

      // è§’è‰²ID
      role_id: {
        type: DataTypes.INTEGER,
        allowNull: false,
        comment: 'å½“å‰è§’è‰²IDï¼ˆå…³è”rolesè¡¨ï¼Œå¦‚ï¼š1=ä¸šåŠ¡å‘˜ï¼Œ2=ä¸šåŠ¡ç»ç†ï¼Œ3=åŒºåŸŸè´Ÿè´£äººï¼‰'
      },

      // æ‰€å±é—¨åº—IDï¼ˆä»…ä¸šåŠ¡å‘˜æœ‰å€¼ï¼‰
      store_id: {
        type: DataTypes.INTEGER,
        allowNull: true,
        comment: 'æ‰€å±é—¨åº—IDï¼ˆä»…ä¸šåŠ¡å‘˜æœ‰å€¼ï¼Œä¸šåŠ¡ç»ç†å’ŒåŒºåŸŸè´Ÿè´£äººä¸ºNULLï¼‰'
      },

      // æ˜¯å¦æ¿€æ´»
      is_active: {
        type: DataTypes.BOOLEAN,
        defaultValue: true,
        comment: 'å±‚çº§å…³ç³»æ˜¯å¦æœ‰æ•ˆï¼ˆ1=æ¿€æ´»ï¼Œ0=å·²åœç”¨ï¼‰'
      },

      // æ¿€æ´»æ—¶é—´
      activated_at: {
        type: DataTypes.DATE,
        allowNull: true,
        comment: 'æ¿€æ´»æ—¶é—´ï¼ˆé¦–æ¬¡æ¿€æ´»æˆ–é‡æ–°æ¿€æ´»æ—¶è®°å½•ï¼‰ï¼Œæ—¶åŒºï¼šåŒ—äº¬æ—¶é—´ï¼ˆGMT+8ï¼‰'
      },

      // åœç”¨æ—¶é—´
      deactivated_at: {
        type: DataTypes.DATE,
        allowNull: true,
        comment: 'åœç”¨æ—¶é—´ï¼ˆåœç”¨æ—¶è®°å½•ï¼‰ï¼Œæ—¶åŒºï¼šåŒ—äº¬æ—¶é—´ï¼ˆGMT+8ï¼‰'
      },

      // åœç”¨æ“ä½œäºº
      deactivated_by: {
        type: DataTypes.INTEGER,
        allowNull: true,
        comment: 'åœç”¨æ“ä½œäººIDï¼ˆè°åœç”¨çš„ï¼Ÿå¤–é”®å…³è”users.user_idï¼‰'
      },

      // åœç”¨åŸå› 
      deactivation_reason: {
        type: DataTypes.TEXT,
        allowNull: true,
        comment: 'åœç”¨åŸå› ï¼ˆå¦‚ï¼šç¦»èŒã€è°ƒåŠ¨ã€è¿è§„ç­‰ï¼‰'
      }
    },
    {
      tableName: 'user_hierarchy',
      timestamps: true,
      createdAt: 'created_at',
      updatedAt: 'updated_at',
      underscored: true,
      indexes: [
        { unique: true, fields: ['user_id', 'role_id'], comment: 'ä¸€ä¸ªç”¨æˆ·åœ¨åŒä¸€è§’è‰²ä¸‹åªèƒ½æœ‰ä¸€æ¡å±‚çº§è®°å½•' },
        { fields: ['superior_user_id'], comment: 'æŸ¥è¯¢æŸä¸ªä¸Šçº§çš„æ‰€æœ‰ç›´æ¥ä¸‹å±' },
        { fields: ['is_active'], comment: 'ç­›é€‰æ¿€æ´»/åœç”¨çŠ¶æ€' }
      ],
      comment: 'ç”¨æˆ·å±‚çº§å…³ç³»è¡¨ï¼ˆç®€åŒ–ç‰ˆï¼šä»…ä¿ç•™æ ¸å¿ƒå­—æ®µï¼‰',

      // é’©å­å‡½æ•°ï¼šç¡®ä¿ä½¿ç”¨åŒ—äº¬æ—¶é—´
      hooks: {
        beforeSave: (record, _options) => {
          if (!record.created_at) {
            record.created_at = BeijingTimeHelper.createDatabaseTime()
          }
          record.updated_at = BeijingTimeHelper.createDatabaseTime()
        }
      }
    }
  )

  // å®šä¹‰å…³è”å…³ç³»
  UserHierarchy.associate = function (models) {
    // å¤šå¯¹ä¸€ï¼šå½“å‰ç”¨æˆ·
    UserHierarchy.belongsTo(models.User, {
      foreignKey: 'user_id',
      as: 'user',
      comment: 'å½“å‰ç”¨æˆ·ä¿¡æ¯'
    })

    // å¤šå¯¹ä¸€ï¼šä¸Šçº§ç”¨æˆ·
    UserHierarchy.belongsTo(models.User, {
      foreignKey: 'superior_user_id',
      as: 'superior',
      comment: 'ä¸Šçº§ç”¨æˆ·ä¿¡æ¯'
    })

    // å¤šå¯¹ä¸€ï¼šè§’è‰²ä¿¡æ¯
    UserHierarchy.belongsTo(models.Role, {
      foreignKey: 'role_id',
      as: 'role',
      comment: 'è§’è‰²ä¿¡æ¯'
    })

    // å¤šå¯¹ä¸€ï¼šé—¨åº—ä¿¡æ¯ï¼ˆå¦‚æœæœ‰Storeæ¨¡å‹ï¼‰
    if (models.Store) {
      UserHierarchy.belongsTo(models.Store, {
        foreignKey: 'store_id',
        as: 'store',
        comment: 'æ‰€å±é—¨åº—ä¿¡æ¯ï¼ˆä»…ä¸šåŠ¡å‘˜ï¼‰'
      })
    }

    // å¤šå¯¹ä¸€ï¼šåœç”¨æ“ä½œäºº
    UserHierarchy.belongsTo(models.User, {
      foreignKey: 'deactivated_by',
      as: 'deactivator',
      comment: 'åœç”¨æ“ä½œäººä¿¡æ¯'
    })
  }

  return UserHierarchy
}
```

### **3. åˆ›å»º RoleChangeLog æ¨¡å‹ï¼ˆè§’è‰²å˜æ›´æ—¥å¿—ï¼‰**

**æ–‡ä»¶è·¯å¾„**ï¼š`/home/devbox/project/models/RoleChangeLog.js`

```javascript
/**
 * è§’è‰²æƒé™å˜æ›´æ—¥å¿—æ¨¡å‹ - é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ V4.0 ç»Ÿä¸€å¼•æ“æ¶æ„
 * ä¸šåŠ¡åœºæ™¯ï¼šè®°å½•æ‰€æœ‰æƒé™å˜æ›´æ“ä½œï¼Œç”¨äºå®¡è®¡å’Œè¿½è¸ªï¼ˆç¦»èŒã€è°ƒåŠ¨ã€æƒé™å˜æ›´ç­‰ï¼‰
 * åˆ›å»ºæ—¶é—´ï¼š2025å¹´11æœˆ07æ—¥
 *
 * æ ¸å¿ƒåŠŸèƒ½ï¼š
 * 1. è®°å½•æ‰€æœ‰æƒé™å˜æ›´æ“ä½œï¼ˆæ¿€æ´»ã€åœç”¨ã€è§’è‰²å˜æ›´ã€æ‰¹é‡åœç”¨ï¼‰
 * 2. è®°å½•æ“ä½œäººã€æ“ä½œæ—¶é—´ã€æ“ä½œåŸå› 
 * 3. è®°å½•æ“ä½œIPåœ°å€ï¼Œç”¨äºå®‰å…¨å®¡è®¡ï¼ˆV4.0æ¶æ„ç§»é™¤äº†user_agentå­—æ®µï¼‰
 * 4. æ”¯æŒæ‰¹é‡æ“ä½œçš„å½±å“ç”¨æˆ·æ•°é‡ç»Ÿè®¡
 * 
 * ğŸ’¡ ä¸é¡¹ç›®ç°æœ‰æŠ€æœ¯æ ˆçš„å¯¹æ¥ï¼š
 * - å¤ç”¨é¡¹ç›®ç°æœ‰çš„ BeijingTimeHelperï¼ˆä½äº /home/devbox/project/utils/timeHelper.jsï¼‰
 * - æ—¥å¿—è®°å½•éµå¾ªé¡¹ç›®ç°æœ‰çš„ AdminOperationLog æ¨¡å‹è§„èŒƒ
 * - æ—¶é—´å­—æ®µä½¿ç”¨åŒ—äº¬æ—¶é—´ï¼ˆGMT+8ï¼‰ï¼Œä¸é¡¹ç›®å…¶ä»–æ¨¡å‹ä¿æŒä¸€è‡´
 * - created_atä½¿ç”¨beforeCreateé’©å­ï¼ŒupdatedAtè®¾ä¸ºfalseï¼ˆæ—¥å¿—è¡¨ä¸éœ€è¦æ›´æ–°ï¼‰
 */

const { DataTypes } = require('sequelize')
const BeijingTimeHelper = require('../utils/timeHelper') // å¤ç”¨é¡¹ç›®ç°æœ‰æ—¶é—´å·¥å…·

module.exports = sequelize => {
  const RoleChangeLog = sequelize.define(
    'RoleChangeLog',
    {
      // æ—¥å¿—IDï¼ˆä¸»é”®ï¼‰
      log_id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        autoIncrement: true,
        comment: 'æ—¥å¿—IDï¼ˆä¸»é”®ï¼‰'
      },

      // ç›®æ ‡ç”¨æˆ·IDï¼ˆè¢«æ“ä½œçš„ç”¨æˆ·ï¼‰
      target_user_id: {
        type: DataTypes.INTEGER,
        allowNull: false,
        comment: 'ç›®æ ‡ç”¨æˆ·IDï¼ˆè¢«æ“ä½œçš„ç”¨æˆ·ï¼Œå¦‚è¢«åœç”¨æƒé™çš„ä¸šåŠ¡å‘˜ï¼‰'
      },

      // æ“ä½œäººIDï¼ˆæ‰§è¡Œæ“ä½œçš„ç”¨æˆ·ï¼‰
      operator_user_id: {
        type: DataTypes.INTEGER,
        allowNull: false,
        comment: 'æ“ä½œäººIDï¼ˆæ‰§è¡Œæ“ä½œçš„ç”¨æˆ·ï¼Œå¦‚åŒºåŸŸè´Ÿè´£äººæˆ–ä¸šåŠ¡ç»ç†ï¼‰'
      },

      // æ“ä½œç±»å‹
      operation_type: {
        type: DataTypes.ENUM('activate', 'deactivate', 'role_change', 'batch_deactivate'),
        allowNull: false,
        comment: 'æ“ä½œç±»å‹ï¼šactivate-æ¿€æ´»æƒé™ï¼Œdeactivate-åœç”¨æƒé™ï¼Œrole_change-è§’è‰²å˜æ›´ï¼Œbatch_deactivate-æ‰¹é‡åœç”¨'
      },

      // åŸè§’è‰²ID
      old_role_id: {
        type: DataTypes.INTEGER,
        allowNull: true,
        comment: 'åŸè§’è‰²IDï¼ˆè§’è‰²å˜æ›´æ—¶è®°å½•ï¼Œå¦‚ä»ä¸šåŠ¡å‘˜å˜ä¸ºä¸šåŠ¡ç»ç†ï¼‰'
      },

      // æ–°è§’è‰²ID
      new_role_id: {
        type: DataTypes.INTEGER,
        allowNull: true,
        comment: 'æ–°è§’è‰²IDï¼ˆè§’è‰²å˜æ›´æ—¶è®°å½•ï¼Œå¦‚ä»ä¸šåŠ¡å‘˜å˜ä¸ºä¸šåŠ¡ç»ç†ï¼‰'
      },

      // å½±å“çš„ç”¨æˆ·æ•°é‡
      affected_count: {
        type: DataTypes.INTEGER,
        defaultValue: 1,
        comment: 'å½±å“çš„ç”¨æˆ·æ•°é‡ï¼ˆæ‰¹é‡æ“ä½œæ—¶è®°å½•ï¼Œå¦‚åœç”¨1ä¸ªä¸šåŠ¡ç»ç†åŠå…¶10ä¸ªä¸šåŠ¡å‘˜ï¼Œåˆ™ä¸º11ï¼‰'
      },

      // æ“ä½œåŸå› 
      reason: {
        type: DataTypes.TEXT,
        allowNull: true,
        comment: 'æ“ä½œåŸå› ï¼ˆå¦‚ï¼šç¦»èŒã€è°ƒåŠ¨ã€è¿è§„ã€æƒé™è°ƒæ•´ç­‰ï¼‰'
      },

      // æ“ä½œIPåœ°å€
      ip_address: {
        type: DataTypes.STRING(50),
        allowNull: true,
        comment: 'æ“ä½œIPåœ°å€ï¼ˆç”¨äºå®‰å…¨å®¡è®¡ï¼‰'
      },

      // âš ï¸ å·²ç§»é™¤user_agentå­—æ®µï¼šV4.0æ¶æ„ä¸å†è®°å½•ç”¨æˆ·ä»£ç†ä¿¡æ¯ï¼ˆç®€åŒ–è®¾è®¡ï¼‰
      // ç†ç”±ï¼š
      // 1. å°æ•°æ®é‡é¡¹ç›®ä¸éœ€è¦è¯¦ç»†çš„æµè§ˆå™¨ä¿¡æ¯
      // 2. IPåœ°å€å·²è¶³å¤Ÿç”¨äºå®‰å…¨å®¡è®¡
      // 3. å‡å°‘æ•°æ®åº“å­—æ®µå¤æ‚åº¦å’Œå­˜å‚¨å¼€é”€
    },
    {
      tableName: 'role_change_logs',
      timestamps: true,
      createdAt: 'created_at',
      updatedAt: false, // æ—¥å¿—è¡¨ä¸éœ€è¦updated_atå­—æ®µ
      underscored: true,
      indexes: [
        { fields: ['target_user_id'], comment: 'æŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„æƒé™å˜æ›´å†å²' },
        { fields: ['operator_user_id'], comment: 'æŸ¥è¯¢æŸä¸ªæ“ä½œäººçš„æ“ä½œè®°å½•' },
        { fields: ['operation_type'], comment: 'æŒ‰æ“ä½œç±»å‹ç­›é€‰' },
        { fields: ['created_at'], comment: 'æŒ‰æ—¶é—´æ’åºæŸ¥è¯¢' }
      ],
      comment: 'è§’è‰²æƒé™å˜æ›´æ—¥å¿—è¡¨ï¼ˆç”¨äºå®¡è®¡å’Œè¿½è¸ªæ‰€æœ‰æƒé™å˜æ›´æ“ä½œï¼‰',

      // é’©å­å‡½æ•°ï¼šç¡®ä¿ä½¿ç”¨åŒ—äº¬æ—¶é—´
      hooks: {
        beforeCreate: (log, _options) => {
          if (!log.created_at) {
            log.created_at = BeijingTimeHelper.createDatabaseTime()
          }
        }
      }
    }
  )

  // å®šä¹‰å…³è”å…³ç³»
  RoleChangeLog.associate = function (models) {
    // å¤šå¯¹ä¸€ï¼šç›®æ ‡ç”¨æˆ·
    RoleChangeLog.belongsTo(models.User, {
      foreignKey: 'target_user_id',
      as: 'targetUser',
      comment: 'ç›®æ ‡ç”¨æˆ·ä¿¡æ¯ï¼ˆè¢«æ“ä½œçš„ç”¨æˆ·ï¼‰'
    })

    // å¤šå¯¹ä¸€ï¼šæ“ä½œäºº
    RoleChangeLog.belongsTo(models.User, {
      foreignKey: 'operator_user_id',
      as: 'operator',
      comment: 'æ“ä½œäººä¿¡æ¯ï¼ˆæ‰§è¡Œæ“ä½œçš„ç”¨æˆ·ï¼‰'
    })

    // å¤šå¯¹ä¸€ï¼šåŸè§’è‰²
    RoleChangeLog.belongsTo(models.Role, {
      foreignKey: 'old_role_id',
      as: 'oldRole',
      comment: 'åŸè§’è‰²ä¿¡æ¯'
    })

    // å¤šå¯¹ä¸€ï¼šæ–°è§’è‰²
    RoleChangeLog.belongsTo(models.Role, {
      foreignKey: 'new_role_id',
      as: 'newRole',
      comment: 'æ–°è§’è‰²ä¿¡æ¯'
    })
  }

  return RoleChangeLog
}
```

---

### **4. åˆ›å»º HierarchyManagementService æœåŠ¡ï¼ˆå±‚çº§æƒé™ç®¡ç†æ ¸å¿ƒæœåŠ¡ - ç®€åŒ–ç‰ˆï¼‰**

**æ–‡ä»¶è·¯å¾„**ï¼š`/home/devbox/project/services/HierarchyManagementService.js`

> **ç®€åŒ–è¯´æ˜**ï¼š
> - ç§»é™¤ hierarchy_path å’Œ hierarchy_level çš„è®¡ç®—é€»è¾‘ï¼ˆä¿æŒç®€å•ï¼‰
> - ç§»é™¤ Redis ç¼“å­˜é€»è¾‘ï¼ˆå°æ•°æ®é‡ä¸‹ä¸éœ€è¦ï¼‰
> - ä½¿ç”¨ç®€å•çš„é€’å½’æŸ¥è¯¢æ›¿ä»£å¤æ‚çš„ LIKE æŸ¥è¯¢

```javascript
/**
 * å±‚çº§æƒé™ç®¡ç†æœåŠ¡ï¼ˆç®€åŒ–ç‰ˆï¼‰ - é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ V4.0 ç»Ÿä¸€å¼•æ“æ¶æ„
 * ä¸šåŠ¡åœºæ™¯ï¼šç®¡ç†åŒºåŸŸè´Ÿè´£äººâ†’ä¸šåŠ¡ç»ç†â†’ä¸šåŠ¡å‘˜ä¸‰çº§å±‚çº§å…³ç³»å’Œæƒé™æ“ä½œ
 * åˆ›å»ºæ—¶é—´ï¼š2025å¹´11æœˆ07æ—¥
 * è®¾è®¡ç†å¿µï¼šç®€å•å®ç”¨ï¼Œé¿å…è¿‡åº¦è®¾è®¡
 * 
 * æ ¸å¿ƒåŠŸèƒ½ï¼š
 * 1. å»ºç«‹ä¸Šä¸‹çº§å…³ç³»ï¼ˆå¦‚ï¼šä¸šåŠ¡ç»ç†æ·»åŠ ä¸šåŠ¡å‘˜ï¼‰
 * 2. æ‰¹é‡åœç”¨ä¸‹çº§æƒé™ï¼ˆå¦‚ï¼šä¸šåŠ¡ç»ç†ç¦»èŒæ—¶åœç”¨å…¶æ‰€æœ‰ä¸‹çº§ä¸šåŠ¡å‘˜ï¼‰
 * 3. æŸ¥è¯¢æ‰€æœ‰ä¸‹çº§ç”¨æˆ·ï¼ˆå¦‚ï¼šåŒºåŸŸè´Ÿè´£äººæŸ¥çœ‹æ‰€æœ‰ä¸šåŠ¡ç»ç†å’Œä¸šåŠ¡å‘˜ï¼‰
 * 4. æƒé™å˜æ›´æ—¥å¿—è®°å½•ï¼ˆå®¡è®¡è¿½è¸ªï¼‰
 * 5. é—¨åº—åˆ†é…ç®¡ç†ï¼ˆä¸šåŠ¡å‘˜åˆ†é…åˆ°é—¨åº—ï¼‰
 * 
 * ç®€åŒ–å†…å®¹ï¼š
 * - ç§»é™¤ hierarchy_path å’Œ hierarchy_level è®¡ç®—ï¼ˆç›´æ¥ä½¿ç”¨é€’å½’æŸ¥è¯¢ï¼‰
 * - ç§»é™¤ Redis ç¼“å­˜ï¼ˆé¡¹ç›®å·²æœ‰authç¼“å­˜ï¼Œæ— éœ€é‡å¤ï¼‰
 * - ç§»é™¤åˆ†é¡µæŸ¥è¯¢ï¼ˆå°æ•°æ®é‡ä¸€æ¬¡æ€§æŸ¥è¯¢å³å¯ï¼‰
 * 
 * ä¸šåŠ¡è§„åˆ™ï¼š
 * - åŒºåŸŸè´Ÿè´£äººï¼ˆrole_level=80ï¼‰å¯ä»¥ç®¡ç†ä¸šåŠ¡ç»ç†å’Œä¸šåŠ¡å‘˜
 * - ä¸šåŠ¡ç»ç†ï¼ˆrole_level=60ï¼‰å¯ä»¥ç®¡ç†ä¸šåŠ¡å‘˜
 * - ä¸šåŠ¡å‘˜ï¼ˆrole_level=40ï¼‰æ— ä¸‹çº§ç®¡ç†æƒé™
 * - æƒé™åœç”¨ä¼šçº§è”å½±å“æ‰€æœ‰ä¸‹çº§
 * - æ‰€æœ‰æ“ä½œè®°å½•åˆ°role_change_logsè¡¨
 * 
 * ğŸ’¡ ä¸é¡¹ç›®ç°æœ‰æŠ€æœ¯æ ˆçš„å¯¹æ¥ï¼š
 * - å¤ç”¨é¡¹ç›®ç°æœ‰çš„ models/index.js ç»Ÿä¸€å¯¼å…¥æ¨¡å‹
 * - å¤ç”¨é¡¹ç›®ç°æœ‰çš„ BeijingTimeHelper æ—¶é—´å·¥å…·
 * - å¤ç”¨é¡¹ç›®ç°æœ‰çš„ auth.js ä¸­çš„ PermissionManager.invalidateUser æ¸…é™¤ç¼“å­˜
 * - éµå¾ªé¡¹ç›®ç°æœ‰çš„äº‹åŠ¡å¤„ç†å’Œé”™è¯¯å¤„ç†è§„èŒƒ
 */

// ğŸ“ è¯´æ˜ï¼šä½¿ç”¨é¡¹ç›®ç°æœ‰çš„models/index.jsç»Ÿä¸€å¯¼å…¥æ‰€æœ‰æ¨¡å‹
// é¡¹ç›®ç°æœ‰æ¨¡å‹å¯¼å…¥æ–¹å¼ï¼šconst { User, Role, ... } = require('../models')
const { User, Role, UserRole, UserHierarchy, RoleChangeLog } = require('../models')
const { Op } = require('sequelize')
const BeijingTimeHelper = require('../utils/timeHelper') // å¤ç”¨é¡¹ç›®ç°æœ‰æ—¶é—´å·¥å…·
const { PermissionManager } = require('../middleware/auth') // å¤ç”¨ç°æœ‰çš„ç¼“å­˜å¤±æ•ˆæœºåˆ¶

class HierarchyManagementService {
  /**
   * ğŸ—ï¸ å»ºç«‹ç”¨æˆ·å±‚çº§å…³ç³»ï¼ˆç®€åŒ–ç‰ˆï¼‰
   * ä¸šåŠ¡åœºæ™¯ï¼š
   * - ä¸šåŠ¡ç»ç†æ·»åŠ ä¸šåŠ¡å‘˜ï¼ŒæŒ‡å®šå…¶è´Ÿè´£çš„é—¨åº—
   * - åŒºåŸŸè´Ÿè´£äººæ·»åŠ ä¸šåŠ¡ç»ç†
   * 
   * @param {number} userId - ç”¨æˆ·IDï¼ˆè¦å»ºç«‹å±‚çº§å…³ç³»çš„ç”¨æˆ·ï¼‰
   * @param {number} superiorUserId - ä¸Šçº§ç”¨æˆ·IDï¼ˆNULLè¡¨ç¤ºé¡¶çº§åŒºåŸŸè´Ÿè´£äººï¼‰
   * @param {number} roleId - è§’è‰²IDï¼ˆ3=åŒºåŸŸè´Ÿè´£äººï¼Œ2=ä¸šåŠ¡ç»ç†ï¼Œ1=ä¸šåŠ¡å‘˜ï¼‰
   * @param {number} storeId - é—¨åº—IDï¼ˆå¯é€‰ï¼Œä»…ä¸šåŠ¡å‘˜éœ€è¦ï¼‰
   * @returns {Promise<Object>} { success, hierarchy, message }
   * 
   * ç¤ºä¾‹ï¼šä¸šåŠ¡ç»ç†ï¼ˆuser_id=10ï¼‰æ·»åŠ ä¸šåŠ¡å‘˜ï¼ˆuser_id=20ï¼‰åˆ°é—¨åº—ï¼ˆstore_id=5ï¼‰
   * await createHierarchy(20, 10, 1, 5)
   */
  static async createHierarchy(userId, superiorUserId, roleId, storeId = null) {
    try {
      // 1. éªŒè¯ç”¨æˆ·å’Œè§’è‰²å­˜åœ¨
      const user = await User.findByPk(userId)
      if (!user) {
        throw new Error(`ç”¨æˆ·ä¸å­˜åœ¨: user_id=${userId}`)
      }

      const role = await Role.findByPk(roleId)
      if (!role) {
        throw new Error(`è§’è‰²ä¸å­˜åœ¨: role_id=${roleId}`)
      }

      // 2. éªŒè¯ä¸Šçº§ç”¨æˆ·å­˜åœ¨ï¼ˆå¦‚æœæœ‰ä¸Šçº§ï¼‰
      if (superiorUserId) {
        const superior = await User.findByPk(superiorUserId)
        if (!superior) {
          throw new Error(`ä¸Šçº§ç”¨æˆ·ä¸å­˜åœ¨: superior_user_id=${superiorUserId}`)
        }
      }

      // 3. åˆ›å»ºå±‚çº§å…³ç³»è®°å½•ï¼ˆç®€åŒ–ç‰ˆï¼šä¸è®¡ç®— hierarchy_path å’Œ hierarchy_levelï¼‰
      const hierarchy = await UserHierarchy.create({
        user_id: userId,
        superior_user_id: superiorUserId,
        role_id: roleId,
        store_id: storeId,
        is_active: true,
        activated_at: BeijingTimeHelper.createDatabaseTime()
      })

      console.log(`âœ… åˆ›å»ºå±‚çº§å…³ç³»æˆåŠŸ: ç”¨æˆ·${userId} â†’ ä¸Šçº§${superiorUserId}, è§’è‰²çº§åˆ«${role.role_level}`)

      return {
        success: true,
        hierarchy,
        message: 'å±‚çº§å…³ç³»åˆ›å»ºæˆåŠŸ'
      }
    } catch (error) {
      console.error('âŒ åˆ›å»ºå±‚çº§å…³ç³»å¤±è´¥:', error.message)
      throw error
    }
  }

  /**
   * ğŸ” æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰ä¸‹çº§ï¼ˆç®€å•é€’å½’æŸ¥è¯¢ï¼‰
   * ä¸šåŠ¡åœºæ™¯ï¼š
   * - åŒºåŸŸè´Ÿè´£äººæŸ¥çœ‹æ‰€æœ‰ä¸šåŠ¡ç»ç†å’Œä¸šåŠ¡å‘˜
   * - ä¸šåŠ¡ç»ç†æŸ¥çœ‹æ‰€æœ‰ä¸šåŠ¡å‘˜
   * - ä¸šåŠ¡ç»ç†ç¦»èŒæ—¶ï¼Œéœ€è¦æŸ¥è¯¢å…¶æ‰€æœ‰ä¸‹çº§ç”¨æˆ·è¿›è¡Œæ‰¹é‡åœç”¨
   * 
   * @param {number} userId - ç”¨æˆ·ID
   * @param {boolean} includeInactive - æ˜¯å¦åŒ…å«å·²åœç”¨çš„ä¸‹çº§ï¼ˆé»˜è®¤falseï¼Œä»…è¿”å›æ¿€æ´»çš„ï¼‰
   * @returns {Promise<Array>} æ‰€æœ‰ä¸‹çº§ç”¨æˆ·åˆ—è¡¨
   * 
   * ç¤ºä¾‹ï¼šæŸ¥è¯¢ä¸šåŠ¡ç»ç†ï¼ˆuser_id=10ï¼‰çš„æ‰€æœ‰ä¸‹çº§ä¸šåŠ¡å‘˜
   * const subordinates = await getAllSubordinates(10, false)
   * // è¿”å›ï¼š[{ user_id: 20, user: {...}, role: {...} }, ...]
   * 
   * ç®€åŒ–è¯´æ˜ï¼šä½¿ç”¨ç®€å•çš„é€’å½’æŸ¥è¯¢ï¼Œä¸ä¾èµ– hierarchy_path å­—æ®µ
   */
  static async getAllSubordinates(userId, includeInactive = false) {
    try {
      const allSubordinates = []
      
      // é€’å½’è¾…åŠ©å‡½æ•°ï¼šæŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„æ‰€æœ‰ä¸‹çº§
      const findSubordinates = async (currentUserId) => {
        // 1. æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„ç›´æ¥ä¸‹çº§
        const whereCondition = {
          superior_user_id: currentUserId
        }
        
        // æ˜¯å¦åŒ…å«å·²åœç”¨çš„ä¸‹çº§
        if (!includeInactive) {
          whereCondition.is_active = true
        }
        
        const directSubordinates = await UserHierarchy.findAll({
          where: whereCondition,
          include: [
            {
              model: User,
              as: 'user',
              attributes: ['user_id', 'mobile', 'nickname', 'status'],
              comment: 'ç”¨æˆ·åŸºæœ¬ä¿¡æ¯'
            },
            {
              model: Role,
              as: 'role',
              attributes: ['role_id', 'role_name', 'role_level'],
              comment: 'è§’è‰²ä¿¡æ¯'
            }
          ]
        })
        
        // 2. å°†ç›´æ¥ä¸‹çº§æ·»åŠ åˆ°ç»“æœæ•°ç»„
        allSubordinates.push(...directSubordinates)
        
        // 3. é€’å½’æŸ¥è¯¢æ¯ä¸ªç›´æ¥ä¸‹çº§çš„ä¸‹çº§ï¼ˆæ·±åº¦ä¼˜å…ˆéå†ï¼‰
        for (const subordinate of directSubordinates) {
          await findSubordinates(subordinate.user_id)
        }
      }
      
      // ä»æŒ‡å®šç”¨æˆ·å¼€å§‹é€’å½’æŸ¥è¯¢
      await findSubordinates(userId)
      
      console.log(`âœ… æŸ¥è¯¢åˆ°ç”¨æˆ·${userId}çš„${allSubordinates.length}ä¸ªä¸‹çº§ï¼ˆåŒ…å«å·²åœç”¨: ${includeInactive}ï¼‰`)
      
      return allSubordinates
    } catch (error) {
      console.error('âŒ æŸ¥è¯¢ä¸‹çº§å¤±è´¥:', error.message)
      throw error
    }
  }

  /**
   * ğŸš« æ‰¹é‡åœç”¨ç”¨æˆ·æƒé™ï¼ˆå¯é€‰æ‹©æ˜¯å¦åŒ…æ‹¬æ‰€æœ‰ä¸‹çº§ï¼‰
   * ä¸šåŠ¡åœºæ™¯ï¼š
   * - ä¸šåŠ¡ç»ç†ç¦»èŒï¼šå¯é€‰æ‹©åœç”¨å…¶æœ¬äººåŠæ‰€æœ‰ä¸‹çº§ä¸šåŠ¡å‘˜çš„æƒé™
   * - ä¸šåŠ¡å‘˜ç¦»èŒï¼šä»…åœç”¨å…¶æœ¬äººæƒé™
   * - ä¸´æ—¶ç¦ç”¨ï¼šå¦‚ä¸šåŠ¡å‘˜è¿è§„ï¼Œä¸šåŠ¡ç»ç†å¯ä¸´æ—¶åœç”¨å…¶æƒé™
   * 
   * @param {number} targetUserId - ç›®æ ‡ç”¨æˆ·IDï¼ˆè¢«åœç”¨çš„ç”¨æˆ·ï¼‰
   * @param {number} operatorUserId - æ“ä½œäººIDï¼ˆæ‰§è¡Œåœç”¨çš„ç”¨æˆ·ï¼‰
   * @param {string} reason - åœç”¨åŸå› ï¼ˆå¦‚ï¼šç¦»èŒã€è¿è§„ã€è°ƒåŠ¨ç­‰ï¼‰
   * @param {boolean} includeSubordinates - æ˜¯å¦åŒæ—¶åœç”¨æ‰€æœ‰ä¸‹çº§ï¼ˆé»˜è®¤falseï¼Œéœ€è¦ä¸»åŠ¨é€‰æ‹©ï¼‰
   * @returns {Promise<Object>} { success, deactivatedCount, deactivatedUsers, message }
   * 
   * ç¤ºä¾‹1ï¼šä»…åœç”¨ä¸šåŠ¡å‘˜æƒé™ï¼ˆé»˜è®¤è¡Œä¸ºï¼‰
   * await batchDeactivatePermissions(20, 10, 'ä¸šåŠ¡å‘˜è¿è§„')
   * 
   * ç¤ºä¾‹2ï¼šä¸šåŠ¡ç»ç†ç¦»èŒï¼Œåœç”¨å…¶æœ¬äººåŠæ‰€æœ‰ä¸‹çº§ä¸šåŠ¡å‘˜ï¼ˆéœ€è¦æ˜ç¡®ä¼ å…¥trueï¼‰
   * await batchDeactivatePermissions(10, 1, 'ä¸šåŠ¡ç»ç†ç¦»èŒ', true)
   */
  static async batchDeactivatePermissions(targetUserId, operatorUserId, reason, includeSubordinates = false) {
    const transaction = await UserHierarchy.sequelize.transaction()

    try {
      // 1. éªŒè¯æ“ä½œæƒé™ï¼ˆæ“ä½œäººå¿…é¡»æ˜¯ç›®æ ‡ç”¨æˆ·çš„ä¸Šçº§ï¼Œä¸”è§’è‰²çº§åˆ«æ›´é«˜ï¼‰
      const canOperate = await this.canManageUser(operatorUserId, targetUserId)
      if (!canOperate) {
        throw new Error(`æ— æƒé™æ“ä½œè¯¥ç”¨æˆ·: operator=${operatorUserId}, target=${targetUserId}`)
      }

      // 2. è·å–è¦åœç”¨çš„ç”¨æˆ·åˆ—è¡¨
      let usersToDeactivate = [targetUserId]

      if (includeSubordinates) {
        const subordinates = await this.getAllSubordinates(targetUserId, false)
        usersToDeactivate = [
          targetUserId,
          ...subordinates.map(sub => sub.user_id)
        ]
      }

      console.log(`ğŸš« å‡†å¤‡åœç”¨${usersToDeactivate.length}ä¸ªç”¨æˆ·çš„æƒé™ï¼ˆç›®æ ‡ç”¨æˆ·: ${targetUserId}ï¼ŒåŒ…å«ä¸‹çº§: ${includeSubordinates}ï¼‰`)

      // 3. æ‰¹é‡åœç”¨å±‚çº§å…³ç³»ï¼ˆè®¾ç½®is_active=falseï¼Œè®°å½•åœç”¨æ—¶é—´ã€æ“ä½œäººã€åŸå› ï¼‰
      const deactivatedCount = await UserHierarchy.update(
        {
          is_active: false,
          deactivated_at: BeijingTimeHelper.createDatabaseTime(),
          deactivated_by: operatorUserId,
          deactivation_reason: reason
        },
        {
          where: {
            user_id: { [Op.in]: usersToDeactivate },
            is_active: true
          },
          transaction
        }
      )

      // 4. æ‰¹é‡åœç”¨ç”¨æˆ·è§’è‰²å…³è”ï¼ˆåŒæ­¥æ›´æ–°user_rolesè¡¨ï¼‰
      await UserRole.update(
        {
          is_active: false
        },
        {
          where: {
            user_id: { [Op.in]: usersToDeactivate },
            is_active: true
          },
          transaction
        }
      )

      // 5. è®°å½•æ“ä½œæ—¥å¿—ï¼ˆç”¨äºå®¡è®¡è¿½è¸ªï¼‰
      await RoleChangeLog.create({
        target_user_id: targetUserId,
        operator_user_id: operatorUserId,
        operation_type: 'batch_deactivate',
        affected_count: usersToDeactivate.length,
        reason: reason
      }, { transaction })

      await transaction.commit()

      // 6. ğŸ”„ æ¸…é™¤å—å½±å“ç”¨æˆ·çš„æƒé™ç¼“å­˜ï¼ˆä¸é¡¹ç›®ç°æœ‰authç¼“å­˜é›†æˆï¼‰
      // å¤ç”¨é¡¹ç›®ç°æœ‰çš„ middleware/auth.js ä¸­çš„ PermissionManager.invalidateMultipleUsers
      await PermissionManager.invalidateMultipleUsers(usersToDeactivate, 'hierarchy_deactivate')

      console.log(`âœ… æˆåŠŸåœç”¨${usersToDeactivate.length}ä¸ªç”¨æˆ·çš„æƒé™ï¼Œå¹¶æ¸…é™¤ç¼“å­˜`)

      return {
        success: true,
        deactivatedCount: usersToDeactivate.length,
        deactivatedUsers: usersToDeactivate,
        message: `æˆåŠŸåœç”¨${usersToDeactivate.length}ä¸ªç”¨æˆ·çš„æƒé™`
      }
    } catch (error) {
      await transaction.rollback()
      console.error('âŒ æ‰¹é‡åœç”¨æƒé™å¤±è´¥:', error.message)
      throw error
    }
  }

  /**
   * âœ… æ‰¹é‡æ¿€æ´»ç”¨æˆ·æƒé™
   * ä¸šåŠ¡åœºæ™¯ï¼š
   * - ä¸šåŠ¡å‘˜è°ƒåŠ¨å›å½’ï¼šé‡æ–°æ¿€æ´»å…¶æƒé™
   * - ä¸´æ—¶ç¦ç”¨è§£é™¤ï¼šæ¢å¤ä¸šåŠ¡å‘˜æƒé™
   * 
   * @param {number} targetUserId - ç›®æ ‡ç”¨æˆ·ID
   * @param {number} operatorUserId - æ“ä½œäººID
   * @param {boolean} includeSubordinates - æ˜¯å¦åŒæ—¶æ¿€æ´»æ‰€æœ‰ä¸‹çº§ï¼ˆé»˜è®¤falseï¼‰
   * @returns {Promise<Object>} { success, activatedCount, activatedUsers, message }
   * 
   * ç¤ºä¾‹ï¼šæ¿€æ´»ä¸šåŠ¡å‘˜æƒé™
   * await batchActivatePermissions(20, 10, false)
   */
  static async batchActivatePermissions(targetUserId, operatorUserId, includeSubordinates = false) {
    const transaction = await UserHierarchy.sequelize.transaction()

    try {
      // 1. éªŒè¯æ“ä½œæƒé™
      const canOperate = await this.canManageUser(operatorUserId, targetUserId)
      if (!canOperate) {
        throw new Error('æ— æƒé™æ“ä½œè¯¥ç”¨æˆ·')
      }

      // 2. è·å–è¦æ¿€æ´»çš„ç”¨æˆ·åˆ—è¡¨
      let usersToActivate = [targetUserId]

      if (includeSubordinates) {
        const subordinates = await this.getAllSubordinates(targetUserId, true)
        usersToActivate = [
          targetUserId,
          ...subordinates.map(sub => sub.user_id)
        ]
      }

      console.log(`âœ… å‡†å¤‡æ¿€æ´»${usersToActivate.length}ä¸ªç”¨æˆ·çš„æƒé™`)

      // 3. æ‰¹é‡æ¿€æ´»å±‚çº§å…³ç³»ï¼ˆæ¢å¤is_active=trueï¼Œæ¸…é™¤åœç”¨è®°å½•ï¼‰
      await UserHierarchy.update(
        {
          is_active: true,
          activated_at: BeijingTimeHelper.createDatabaseTime(),
          deactivated_at: null,
          deactivated_by: null,
          deactivation_reason: null
        },
        {
          where: {
            user_id: { [Op.in]: usersToActivate }
          },
          transaction
        }
      )

      // 4. æ‰¹é‡æ¿€æ´»ç”¨æˆ·è§’è‰²å…³è”
      await UserRole.update(
        {
          is_active: true
        },
        {
          where: {
            user_id: { [Op.in]: usersToActivate }
          },
          transaction
        }
      )

      // 5. è®°å½•æ“ä½œæ—¥å¿—
      await RoleChangeLog.create({
        target_user_id: targetUserId,
        operator_user_id: operatorUserId,
        operation_type: 'activate',
        affected_count: usersToActivate.length,
        reason: 'æ‰¹é‡æ¿€æ´»æƒé™'
      }, { transaction })

      await transaction.commit()

      // 6. ğŸ”„ æ¸…é™¤å—å½±å“ç”¨æˆ·çš„æƒé™ç¼“å­˜ï¼ˆä¸é¡¹ç›®ç°æœ‰authç¼“å­˜é›†æˆï¼‰
      // å¤ç”¨é¡¹ç›®ç°æœ‰çš„ middleware/auth.js ä¸­çš„ PermissionManager.invalidateMultipleUsers
      await PermissionManager.invalidateMultipleUsers(usersToActivate, 'hierarchy_activate')

      console.log(`âœ… æˆåŠŸæ¿€æ´»${usersToActivate.length}ä¸ªç”¨æˆ·çš„æƒé™ï¼Œå¹¶æ¸…é™¤ç¼“å­˜`)

      return {
        success: true,
        activatedCount: usersToActivate.length,
        activatedUsers: usersToActivate,
        message: `æˆåŠŸæ¿€æ´»${usersToActivate.length}ä¸ªç”¨æˆ·çš„æƒé™`
      }
    } catch (error) {
      await transaction.rollback()
      console.error('âŒ æ‰¹é‡æ¿€æ´»æƒé™å¤±è´¥:', error.message)
      throw error
    }
  }

  /**
   * ğŸ” æ£€æŸ¥æ“ä½œäººæ˜¯å¦å¯ä»¥ç®¡ç†ç›®æ ‡ç”¨æˆ·ï¼ˆç®€åŒ–ç‰ˆï¼‰
   * ä¸šåŠ¡è§„åˆ™ï¼š
   * - æ“ä½œäººçš„è§’è‰²çº§åˆ«å¿…é¡»é«˜äºç›®æ ‡ç”¨æˆ·ï¼ˆå¦‚ä¸šåŠ¡ç»ç†role_level=60 > ä¸šåŠ¡å‘˜role_level=40ï¼‰
   * - ç›®æ ‡ç”¨æˆ·å¿…é¡»æ˜¯æ“ä½œäººçš„ä¸‹çº§ï¼ˆé€šè¿‡é€’å½’æŸ¥è¯¢éªŒè¯ï¼‰
   * 
   * @param {number} operatorUserId - æ“ä½œäººID
   * @param {number} targetUserId - ç›®æ ‡ç”¨æˆ·ID
   * @returns {Promise<boolean>} trueè¡¨ç¤ºæœ‰æƒé™ï¼Œfalseè¡¨ç¤ºæ— æƒé™
   * 
   * ç¤ºä¾‹ï¼šæ£€æŸ¥ä¸šåŠ¡ç»ç†ï¼ˆuser_id=10ï¼‰æ˜¯å¦å¯ä»¥ç®¡ç†ä¸šåŠ¡å‘˜ï¼ˆuser_id=20ï¼‰
   * const canManage = await canManageUser(10, 20)
   * 
   * ç®€åŒ–è¯´æ˜ï¼šä½¿ç”¨ç®€å•çš„é€’å½’æŸ¥è¯¢åˆ¤æ–­ä¸Šä¸‹çº§å…³ç³»ï¼Œä¸ä¾èµ– hierarchy_path
   */
  static async canManageUser(operatorUserId, targetUserId) {
    try {
      // 1. è·å–æ“ä½œäººçš„è§’è‰²çº§åˆ«
      const operatorHierarchy = await UserHierarchy.findOne({
        where: { user_id: operatorUserId, is_active: true },
        include: [{
          model: Role,
          as: 'role',
          attributes: ['role_level']
        }]
      })

      if (!operatorHierarchy) {
        return false
      }

      // 2. è·å–ç›®æ ‡ç”¨æˆ·çš„å±‚çº§ä¿¡æ¯
      const targetHierarchy = await UserHierarchy.findOne({
        where: { user_id: targetUserId },
        include: [{
          model: Role,
          as: 'role',
          attributes: ['role_level']
        }]
      })

      if (!targetHierarchy) {
        return false
      }

      // 3. åˆ¤æ–­æƒé™ï¼šæ“ä½œäººè§’è‰²çº§åˆ«å¿…é¡»é«˜äºç›®æ ‡ç”¨æˆ·
      const isHigherLevel = operatorHierarchy.role.role_level > targetHierarchy.role.role_level
      if (!isHigherLevel) {
        return false
      }

      // 4. åˆ¤æ–­ç›®æ ‡ç”¨æˆ·æ˜¯å¦æ˜¯æ“ä½œäººçš„ä¸‹çº§ï¼ˆç®€å•é€’å½’æŸ¥è¯¢ï¼‰
      const allSubordinates = await this.getAllSubordinates(operatorUserId, false)
      const isSubordinate = allSubordinates.some(sub => sub.user_id === targetUserId)

      return isSubordinate
    } catch (error) {
      console.error('âŒ æƒé™æ£€æŸ¥å¤±è´¥:', error.message)
      return false
    }
  }

  /**
   * ğŸ“Š è·å–ç”¨æˆ·çš„å±‚çº§ç»Ÿè®¡ä¿¡æ¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
   * ä¸šåŠ¡åœºæ™¯ï¼š
   * - åŒºåŸŸè´Ÿè´£äººæŸ¥çœ‹å…¶ç®¡ç†çš„ä¸šåŠ¡ç»ç†å’Œä¸šåŠ¡å‘˜æ•°é‡
   * - ä¸šåŠ¡ç»ç†æŸ¥çœ‹å…¶ç®¡ç†çš„ä¸šåŠ¡å‘˜æ•°é‡
   * 
   * @param {number} userId - ç”¨æˆ·ID
   * @returns {Promise<Object>} { total_subordinates, direct_subordinates, stats_by_role }
   * 
   * ç¤ºä¾‹ï¼šæŸ¥è¯¢åŒºåŸŸè´Ÿè´£äººï¼ˆuser_id=1ï¼‰çš„ç»Ÿè®¡ä¿¡æ¯
   * const stats = await getHierarchyStats(1)
   * // è¿”å›ï¼š{ total_subordinates: 15, direct_subordinates: 5, stats_by_role: {...} }
   * 
   * ç®€åŒ–è¯´æ˜ï¼šæŒ‰è§’è‰²ç±»å‹ç»Ÿè®¡ï¼Œè€Œä¸æ˜¯æŒ‰å±‚çº§æ·±åº¦ç»Ÿè®¡ï¼ˆæ›´ç›´è§‚ï¼‰
   */
  static async getHierarchyStats(userId) {
    try {
      // 1. è·å–æ‰€æœ‰ä¸‹çº§
      const allSubordinates = await this.getAllSubordinates(userId, false)
      
      // 2. è·å–ç›´æ¥ä¸‹çº§ï¼ˆä¸€çº§ä¸‹å±ï¼‰
      const directSubordinates = await UserHierarchy.findAll({
        where: {
          superior_user_id: userId,
          is_active: true
        },
        include: [
          {
            model: User,
            as: 'user',
            attributes: ['user_id', 'mobile', 'nickname']
          },
          {
            model: Role,
            as: 'role',
            attributes: ['role_id', 'role_name', 'role_level']
          }
        ]
      })

      // 3. æŒ‰è§’è‰²ç±»å‹åˆ†ç»„ç»Ÿè®¡ï¼ˆæ›´ç›´è§‚ï¼‰
      const statsByRole = {}
      allSubordinates.forEach(sub => {
        const roleName = sub.role.role_name
        if (!statsByRole[roleName]) {
          statsByRole[roleName] = {
            count: 0,
            users: []
          }
        }
        statsByRole[roleName].count++
        statsByRole[roleName].users.push({
          user_id: sub.user_id,
          mobile: sub.user.mobile,
          nickname: sub.user.nickname,
          role_name: sub.role.role_name
        })
      })

      return {
        total_subordinates: allSubordinates.length,
        direct_subordinates: directSubordinates.length,
        stats_by_role: statsByRole
      }
    } catch (error) {
      console.error('âŒ è·å–å±‚çº§ç»Ÿè®¡å¤±è´¥:', error.message)
      throw error
    }
  }
}

module.exports = HierarchyManagementService
```

---

## ğŸ”Œ APIæ¥å£è®¾è®¡ï¼ˆå±‚çº§æƒé™ç®¡ç†è·¯ç”±ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`/home/devbox/project/routes/v4/hierarchy/index.js`

**æŒ‚è½½è·¯å¾„**ï¼šåœ¨ `/home/devbox/project/app.js` ä¸­æ·»åŠ ï¼š
```javascript
app.use('/api/v4/hierarchy', require('./routes/v4/hierarchy'))
```

**å®Œæ•´è·¯ç”±ä»£ç **ï¼š

```javascript
/**
 * å±‚çº§æƒé™ç®¡ç†è·¯ç”± - é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ V4.0 ç»Ÿä¸€å¼•æ“æ¶æ„
 * ä¸šåŠ¡åœºæ™¯ï¼šç®¡ç†åŒºåŸŸè´Ÿè´£äººâ†’ä¸šåŠ¡ç»ç†â†’ä¸šåŠ¡å‘˜ä¸‰çº§å±‚çº§å…³ç³»å’Œæƒé™æ“ä½œ
 * åˆ›å»ºæ—¶é—´ï¼š2025å¹´11æœˆ07æ—¥
 * 
 * APIè·¯å¾„å‰ç¼€ï¼š/api/v4/hierarchy
 * 
 * æ ¸å¿ƒæ¥å£ï¼š
 * - POST /api/v4/hierarchy/create - åˆ›å»ºå±‚çº§å…³ç³»
 * - GET /api/v4/hierarchy/subordinates/:userId - æŸ¥è¯¢æ‰€æœ‰ä¸‹çº§
 * - POST /api/v4/hierarchy/deactivate - æ‰¹é‡åœç”¨æƒé™
 * - POST /api/v4/hierarchy/activate - æ‰¹é‡æ¿€æ´»æƒé™
 * - GET /api/v4/hierarchy/stats/:userId - è·å–å±‚çº§ç»Ÿè®¡
 * 
 * ğŸ’¡ ä¸é¡¹ç›®ç°æœ‰æŠ€æœ¯æ ˆçš„å¯¹æ¥ï¼š
 * - å¤ç”¨é¡¹ç›®ç°æœ‰çš„ middleware/auth.js ä¸­çš„ authenticateToken ä¸­é—´ä»¶
 * - éµå¾ªé¡¹ç›®ç°æœ‰çš„é”™è¯¯å¤„ç†è§„èŒƒï¼ˆtry-catch + res.status().json()ï¼‰
 * - éµå¾ªé¡¹ç›®ç°æœ‰çš„APIå“åº”æ ¼å¼ï¼ˆ{ success, data/message }ï¼‰
 * - ä½¿ç”¨é¡¹ç›®ç°æœ‰çš„ req.user å¯¹è±¡è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
 */

const express = require('express')
const router = express.Router()
const { authenticateToken } = require('../../../middleware/auth') // å¤ç”¨é¡¹ç›®ç°æœ‰è®¤è¯ä¸­é—´ä»¶
const HierarchyManagementService = require('../../../services/HierarchyManagementService')

/**
 * ğŸ—ï¸ åˆ›å»ºç”¨æˆ·å±‚çº§å…³ç³»
 * 
 * **å®Œæ•´è·¯å¾„**ï¼šPOST /api/v4/hierarchy/create
 * 
 * **ä¸šåŠ¡åœºæ™¯**ï¼š
 * - åŒºåŸŸè´Ÿè´£äººæ·»åŠ ä¸šåŠ¡ç»ç†
 * - ä¸šåŠ¡ç»ç†æ·»åŠ ä¸šåŠ¡å‘˜å¹¶åˆ†é…åˆ°é—¨åº—
 * 
 * **æƒé™è¦æ±‚**ï¼šéœ€è¦ç®¡ç†å‘˜æƒé™ï¼ˆåŒºåŸŸè´Ÿè´£äººæˆ–ä¸šåŠ¡ç»ç†ï¼‰
 * 
 * **è¯·æ±‚ä½“**ï¼š
 * ```json
 * {
 *   "user_id": 20,              // è¦æ·»åŠ çš„ç”¨æˆ·IDï¼ˆå¿…éœ€ï¼‰
 *   "superior_user_id": 10,     // ä¸Šçº§ç”¨æˆ·IDï¼ˆå¿…éœ€ï¼Œé¡¶çº§åŒºåŸŸè´Ÿè´£äººå¯ä¸ºnullï¼‰
 *   "role_id": 1,               // è§’è‰²IDï¼ˆå¿…éœ€ï¼Œ1=ä¸šåŠ¡å‘˜ï¼Œ2=ä¸šåŠ¡ç»ç†ï¼Œ3=åŒºåŸŸè´Ÿè´£äººï¼‰
 *   "store_id": 5               // é—¨åº—IDï¼ˆå¯é€‰ï¼Œä»…ä¸šåŠ¡å‘˜éœ€è¦ï¼‰
 * }
 * ```
 * 
 * **å“åº”ç¤ºä¾‹**ï¼š
 * ```json
 * {
 *   "success": true,
 *   "hierarchy": {
 *     "hierarchy_id": 1,
 *     "user_id": 20,
 *     "superior_user_id": 10,
 *     "role_id": 1,
 *     "hierarchy_level": 1,
 *     "hierarchy_path": "10/20",
 *     "store_id": 5,
 *     "is_active": true
 *   },
 *   "message": "å±‚çº§å…³ç³»åˆ›å»ºæˆåŠŸ"
 * }
 * ```
 */
router.post('/create', authenticateToken, async (req, res) => {
  try {
    const { user_id, superior_user_id, role_id, store_id } = req.body

    // å‚æ•°éªŒè¯
    if (!user_id || !role_id) {
      return res.status(400).json({
        success: false,
        message: 'ç¼ºå°‘å¿…éœ€å‚æ•°ï¼šuser_id å’Œ role_id'
      })
    }

    const result = await HierarchyManagementService.createHierarchy(
      user_id,
      superior_user_id,
      role_id,
      store_id
    )

    res.json(result)
  } catch (error) {
    console.error('âŒ åˆ›å»ºå±‚çº§å…³ç³»å¤±è´¥:', error.message)
    res.status(500).json({
      success: false,
      message: error.message
    })
  }
})

/**
 * ğŸ” æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰ä¸‹çº§
 * 
 * **å®Œæ•´è·¯å¾„**ï¼šGET /api/v4/hierarchy/subordinates/:userId
 * 
 * **ä¸šåŠ¡åœºæ™¯**ï¼š
 * - åŒºåŸŸè´Ÿè´£äººæŸ¥çœ‹æ‰€æœ‰ä¸šåŠ¡ç»ç†å’Œä¸šåŠ¡å‘˜
 * - ä¸šåŠ¡ç»ç†æŸ¥çœ‹æ‰€æœ‰ä¸šåŠ¡å‘˜
 * 
 * **æƒé™è¦æ±‚**ï¼šåªèƒ½æŸ¥è¯¢è‡ªå·±æˆ–è‡ªå·±ä¸‹çº§çš„ä¿¡æ¯
 * 
 * **è·¯å¾„å‚æ•°**ï¼š
 * - userId: ç”¨æˆ·IDï¼ˆæ•°å­—ï¼‰
 * 
 * **æŸ¥è¯¢å‚æ•°**ï¼š
 * - include_inactive: æ˜¯å¦åŒ…å«å·²åœç”¨çš„ä¸‹çº§ï¼ˆtrue/falseï¼Œé»˜è®¤falseï¼‰
 * 
 * **å“åº”ç¤ºä¾‹**ï¼š
 * ```json
 * {
 *   "success": true,
 *   "count": 10,
 *   "subordinates": [
 *     {
 *       "user_id": 20,
 *       "hierarchy_level": 1,
 *       "user": { "user_id": 20, "mobile": "13800138001", "nickname": "å¼ ä¸‰" },
 *       "role": { "role_id": 1, "role_name": "sales_staff", "role_level": 1 }
 *     }
 *   ]
 * }
 * ```
 */
router.get('/subordinates/:userId', authenticateToken, async (req, res) => {
  try {
    const { userId } = req.params
    const { include_inactive } = req.query

    // æƒé™éªŒè¯ï¼šåªèƒ½æŸ¥è¯¢è‡ªå·±æˆ–è‡ªå·±ä¸‹çº§çš„ä¿¡æ¯
    const canView = await HierarchyManagementService.canManageUser(
      req.user.user_id,
      parseInt(userId)
    )

    if (!canView && req.user.user_id !== parseInt(userId)) {
      return res.status(403).json({
        success: false,
        message: 'æ— æƒé™æŸ¥çœ‹è¯¥ç”¨æˆ·çš„ä¸‹çº§ä¿¡æ¯'
      })
    }

    const subordinates = await HierarchyManagementService.getAllSubordinates(
      parseInt(userId),
      include_inactive === 'true'
    )

    res.json({
      success: true,
      count: subordinates.length,
      subordinates
    })
  } catch (error) {
    console.error('âŒ æŸ¥è¯¢ä¸‹çº§å¤±è´¥:', error.message)
    res.status(500).json({
      success: false,
      message: error.message
    })
  }
})

/**
 * ğŸš« æ‰¹é‡åœç”¨ç”¨æˆ·æƒé™
 * 
 * **å®Œæ•´è·¯å¾„**ï¼šPOST /api/v4/hierarchy/deactivate
 * 
 * **ä¸šåŠ¡åœºæ™¯**ï¼š
 * - ä¸šåŠ¡ç»ç†ç¦»èŒï¼šå¯é€‰æ‹©åœç”¨å…¶æœ¬äººåŠæ‰€æœ‰ä¸‹çº§ä¸šåŠ¡å‘˜
 * - ä¸šåŠ¡å‘˜è¿è§„ï¼šä¸´æ—¶åœç”¨å…¶æƒé™
 * 
 * **æƒé™è¦æ±‚**ï¼šéœ€è¦ç®¡ç†æƒé™ï¼ˆåªèƒ½åœç”¨è‡ªå·±çš„ä¸‹çº§ï¼‰
 * 
 * **å®‰å…¨è®¾è®¡**ï¼šé»˜è®¤ä»…åœç”¨ç›®æ ‡ç”¨æˆ·æœ¬äººï¼Œä¸è‡ªåŠ¨æ‰¹é‡åœç”¨ä¸‹çº§ï¼ˆé˜²æ­¢è¯¯æ“ä½œï¼‰
 * 
 * **è¯·æ±‚ä½“**ï¼š
 * ```json
 * {
 *   "target_user_id": 20,           // ç›®æ ‡ç”¨æˆ·IDï¼ˆå¿…éœ€ï¼‰
 *   "reason": "ä¸šåŠ¡å‘˜ç¦»èŒ",          // åœç”¨åŸå› ï¼ˆå¿…éœ€ï¼‰
 *   "include_subordinates": false   // æ˜¯å¦åŒæ—¶åœç”¨æ‰€æœ‰ä¸‹çº§ï¼ˆå¯é€‰ï¼Œé»˜è®¤falseï¼Œéœ€è¦ä¸»åŠ¨é€‰æ‹©ï¼‰
 * }
 * ```
 * 
 * **å“åº”ç¤ºä¾‹1ï¼ˆä»…åœç”¨ç›®æ ‡ç”¨æˆ·ï¼‰**ï¼š
 * ```json
 * {
 *   "success": true,
 *   "deactivatedCount": 1,
 *   "deactivatedUsers": [20],
 *   "message": "æˆåŠŸåœç”¨1ä¸ªç”¨æˆ·çš„æƒé™"
 * }
 * ```
 * 
 * **å“åº”ç¤ºä¾‹2ï¼ˆåœç”¨ç›®æ ‡ç”¨æˆ·åŠæ‰€æœ‰ä¸‹çº§ï¼‰**ï¼š
 * ```json
 * {
 *   "success": true,
 *   "deactivatedCount": 11,
 *   "deactivatedUsers": [10, 20, 21, ...],
 *   "message": "æˆåŠŸåœç”¨11ä¸ªç”¨æˆ·çš„æƒé™"
 * }
 * ```
 */
router.post('/deactivate', authenticateToken, async (req, res) => {
  try {
    const { target_user_id, reason, include_subordinates = false } = req.body

    // å‚æ•°éªŒè¯
    if (!target_user_id) {
      return res.status(400).json({
        success: false,
        message: 'ç¼ºå°‘å¿…éœ€å‚æ•°ï¼štarget_user_id'
      })
    }

    if (!reason) {
      return res.status(400).json({
        success: false,
        message: 'è¯·æä¾›åœç”¨åŸå› '
      })
    }

    const result = await HierarchyManagementService.batchDeactivatePermissions(
      target_user_id,
      req.user.user_id,
      reason,
      include_subordinates
    )

    res.json(result)
  } catch (error) {
    console.error('âŒ æ‰¹é‡åœç”¨æƒé™å¤±è´¥:', error.message)
    res.status(500).json({
      success: false,
      message: error.message
    })
  }
})

/**
 * âœ… æ‰¹é‡æ¿€æ´»ç”¨æˆ·æƒé™
 * 
 * **å®Œæ•´è·¯å¾„**ï¼šPOST /api/v4/hierarchy/activate
 * 
 * **ä¸šåŠ¡åœºæ™¯**ï¼š
 * - ä¸šåŠ¡å‘˜è°ƒåŠ¨å›å½’ï¼šé‡æ–°æ¿€æ´»å…¶æƒé™
 * - ä¸´æ—¶ç¦ç”¨è§£é™¤ï¼šæ¢å¤ä¸šåŠ¡å‘˜æƒé™
 * 
 * **æƒé™è¦æ±‚**ï¼šéœ€è¦ç®¡ç†æƒé™ï¼ˆåªèƒ½æ¿€æ´»è‡ªå·±çš„ä¸‹çº§ï¼‰
 * 
 * **è¯·æ±‚ä½“**ï¼š
 * ```json
 * {
 *   "target_user_id": 20,           // ç›®æ ‡ç”¨æˆ·IDï¼ˆå¿…éœ€ï¼‰
 *   "include_subordinates": false   // æ˜¯å¦åŒæ—¶æ¿€æ´»æ‰€æœ‰ä¸‹çº§ï¼ˆå¯é€‰ï¼Œé»˜è®¤falseï¼‰
 * }
 * ```
 * 
 * **å“åº”ç¤ºä¾‹**ï¼š
 * ```json
 * {
 *   "success": true,
 *   "activatedCount": 1,
 *   "activatedUsers": [20],
 *   "message": "æˆåŠŸæ¿€æ´»1ä¸ªç”¨æˆ·çš„æƒé™"
 * }
 * ```
 */
router.post('/activate', authenticateToken, async (req, res) => {
  try {
    const { target_user_id, include_subordinates = false } = req.body

    // å‚æ•°éªŒè¯
    if (!target_user_id) {
      return res.status(400).json({
        success: false,
        message: 'ç¼ºå°‘å¿…éœ€å‚æ•°ï¼štarget_user_id'
      })
    }

    const result = await HierarchyManagementService.batchActivatePermissions(
      target_user_id,
      req.user.user_id,
      include_subordinates
    )

    res.json(result)
  } catch (error) {
    console.error('âŒ æ‰¹é‡æ¿€æ´»æƒé™å¤±è´¥:', error.message)
    res.status(500).json({
      success: false,
      message: error.message
    })
  }
})

/**
 * ğŸ“Š è·å–ç”¨æˆ·å±‚çº§ç»Ÿè®¡ä¿¡æ¯
 * 
 * **å®Œæ•´è·¯å¾„**ï¼šGET /api/v4/hierarchy/stats/:userId
 * 
 * **ä¸šåŠ¡åœºæ™¯**ï¼š
 * - åŒºåŸŸè´Ÿè´£äººæŸ¥çœ‹å…¶ç®¡ç†çš„ä¸šåŠ¡ç»ç†å’Œä¸šåŠ¡å‘˜æ•°é‡
 * - ä¸šåŠ¡ç»ç†æŸ¥çœ‹å…¶ç®¡ç†çš„ä¸šåŠ¡å‘˜æ•°é‡
 * 
 * **æƒé™è¦æ±‚**ï¼šåªèƒ½æŸ¥è¯¢è‡ªå·±æˆ–è‡ªå·±ä¸‹çº§çš„ç»Ÿè®¡ä¿¡æ¯
 * 
 * **è·¯å¾„å‚æ•°**ï¼š
 * - userId: ç”¨æˆ·IDï¼ˆæ•°å­—ï¼‰
 * 
 * **å“åº”ç¤ºä¾‹ï¼ˆç®€åŒ–ç‰ˆï¼‰**ï¼š
 * ```json
 * {
 *   "success": true,
 *   "stats": {
 *     "total_subordinates": 15,
 *     "direct_subordinates": 5,
 *     "stats_by_role": {
 *       "business_manager": { "count": 5, "users": [...] },
 *       "sales_staff": { "count": 10, "users": [...] }
 *     }
 *   }
 * }
 * ```
 */
router.get('/stats/:userId', authenticateToken, async (req, res) => {
  try {
    const { userId } = req.params

    // æƒé™éªŒè¯
    const canView = await HierarchyManagementService.canManageUser(
      req.user.user_id,
      parseInt(userId)
    )

    if (!canView && req.user.user_id !== parseInt(userId)) {
      return res.status(403).json({
        success: false,
        message: 'æ— æƒé™æŸ¥çœ‹è¯¥ç”¨æˆ·çš„ç»Ÿè®¡ä¿¡æ¯'
      })
    }

    const stats = await HierarchyManagementService.getHierarchyStats(parseInt(userId))

    res.json({
      success: true,
      stats
    })
  } catch (error) {
    console.error('âŒ è·å–å±‚çº§ç»Ÿè®¡å¤±è´¥:', error.message)
    res.status(500).json({
      success: false,
      message: error.message
    })
  }
})

module.exports = router
```

---

## ğŸ”Œ é¡¹ç›®å®é™…é›†æˆæ­¥éª¤

> **ğŸ’¡ è¯´æ˜**ï¼šä»¥ä¸‹æ˜¯å°†æœ¬æ–¹æ¡ˆé›†æˆåˆ°ç°æœ‰é¡¹ç›®çš„å…·ä½“æ­¥éª¤ï¼Œæ‰€æœ‰ä»£ç éƒ½åŸºäºé¡¹ç›®ç°æœ‰æŠ€æœ¯æ ˆï¼Œç¡®ä¿æ— ç¼å¯¹æ¥ã€‚

### **æ­¥éª¤1ï¼šåˆ›å»ºæ•°æ®åº“è¡¨å’Œåˆå§‹åŒ–æ•°æ®ï¼ˆ5åˆ†é’Ÿï¼‰**

```bash
# 1. è¿æ¥åˆ°é¡¹ç›®æ•°æ®åº“
mysql -u root -p restaurant_lottery

# 2. æ‰§è¡ŒSQLè„šæœ¬åˆ›å»ºè¡¨ç»“æ„
# å¯ä»¥å°†ä¸Šè¿°æ•°æ®åº“è®¾è®¡éƒ¨åˆ†çš„SQLè¯­å¥ä¿å­˜ä¸º hierarchy_schema.sqlï¼Œç„¶åæ‰§è¡Œï¼š
source /path/to/hierarchy_schema.sql

# æˆ–è€…ç›´æ¥åœ¨MySQLå‘½ä»¤è¡Œä¸­ä¾æ¬¡æ‰§è¡Œï¼š
# - CREATE TABLE stores ...
# - CREATE TABLE user_hierarchy ...
# - CREATE TABLE role_change_logs ...
# - INSERT INTO roles ... (åˆå§‹åŒ–è§’è‰²æ•°æ®)
```

### **æ­¥éª¤2ï¼šåˆ›å»ºæ¨¡å‹æ–‡ä»¶ï¼ˆ10åˆ†é’Ÿï¼‰**

```bash
# åœ¨é¡¹ç›®modelsç›®å½•ä¸‹åˆ›å»º3ä¸ªæ–°æ¨¡å‹æ–‡ä»¶
cd /home/devbox/project/models

# åˆ›å»ºStoreæ¨¡å‹ï¼ˆå¦‚æœéœ€è¦é—¨åº—ç®¡ç†åŠŸèƒ½ï¼‰
touch Store.js

# åˆ›å»ºUserHierarchyæ¨¡å‹ï¼ˆæ ¸å¿ƒï¼‰
touch UserHierarchy.js

# åˆ›å»ºRoleChangeLogæ¨¡å‹ï¼ˆæ—¥å¿—å®¡è®¡ï¼‰
touch RoleChangeLog.js
```

å°†ä¸Šè¿°"æ ¸å¿ƒåŠŸèƒ½å®ç°"ç« èŠ‚ä¸­çš„æ¨¡å‹ä»£ç å¤åˆ¶åˆ°å¯¹åº”æ–‡ä»¶ä¸­ã€‚

### **æ­¥éª¤3ï¼šæ³¨å†Œæ¨¡å‹åˆ°models/index.jsï¼ˆ2åˆ†é’Ÿï¼‰**

```javascript
// ç¼–è¾‘ /home/devbox/project/models/index.js
// åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ æ–°æ¨¡å‹çš„æ³¨å†Œä»£ç 

// å±‚çº§æƒé™ç®¡ç†ç›¸å…³æ¨¡å‹ï¼ˆ2025å¹´11æœˆ07æ—¥æ–°å¢ï¼‰
db.Store = require('./Store')(sequelize)              // é—¨åº—ä¿¡æ¯æ¨¡å‹
db.UserHierarchy = require('./UserHierarchy')(sequelize) // ç”¨æˆ·å±‚çº§å…³ç³»æ¨¡å‹
db.RoleChangeLog = require('./RoleChangeLog')(sequelize) // æƒé™å˜æ›´æ—¥å¿—æ¨¡å‹

console.log('âœ… å±‚çº§æƒé™ç®¡ç†æ¨¡å‹å·²åŠ è½½')
```

### **æ­¥éª¤4ï¼šåˆ›å»ºæœåŠ¡æ–‡ä»¶ï¼ˆ5åˆ†é’Ÿï¼‰**

```bash
# åœ¨é¡¹ç›®servicesç›®å½•ä¸‹åˆ›å»ºæœåŠ¡æ–‡ä»¶
cd /home/devbox/project/services
touch HierarchyManagementService.js
```

å°†ä¸Šè¿°"æ ¸å¿ƒåŠŸèƒ½å®ç°"ç« èŠ‚ä¸­çš„æœåŠ¡ä»£ç å¤åˆ¶åˆ°æ­¤æ–‡ä»¶ä¸­ã€‚

### **æ­¥éª¤5ï¼šåˆ›å»ºAPIè·¯ç”±ï¼ˆ5åˆ†é’Ÿï¼‰**

```bash
# åœ¨é¡¹ç›®routesç›®å½•ä¸‹åˆ›å»ºæ–°è·¯ç”±
cd /home/devbox/project/routes/v4
mkdir -p hierarchy
touch hierarchy/index.js
```

å°†ä¸Šè¿°"APIæ¥å£è®¾è®¡"ç« èŠ‚ä¸­çš„è·¯ç”±ä»£ç å¤åˆ¶åˆ°æ­¤æ–‡ä»¶ä¸­ã€‚

### **æ­¥éª¤6ï¼šæŒ‚è½½è·¯ç”±åˆ°app.jsï¼ˆ2åˆ†é’Ÿï¼‰**

```javascript
// ç¼–è¾‘ /home/devbox/project/app.js
// åœ¨V4è·¯ç”±æ³¨å†Œéƒ¨åˆ†æ·»åŠ ï¼š

// å±‚çº§æƒé™ç®¡ç†è·¯ç”±ï¼ˆ2025å¹´11æœˆ07æ—¥æ–°å¢ï¼‰
app.use('/api/v4/hierarchy', require('./routes/v4/hierarchy'))
console.log('âœ… å±‚çº§æƒé™ç®¡ç†è·¯ç”±å·²æŒ‚è½½: /api/v4/hierarchy')
```

### **æ­¥éª¤7ï¼šé‡å¯æœåŠ¡å¹¶æµ‹è¯•ï¼ˆ3åˆ†é’Ÿï¼‰**

```bash
# é‡å¯Node.jsæœåŠ¡
npm run dev

# æˆ–è€…ä½¿ç”¨PM2
pm2 restart restaurant-backend

# éªŒè¯æœåŠ¡å¯åŠ¨æˆåŠŸ
curl http://localhost:3000/health

# æ£€æŸ¥è·¯ç”±æ˜¯å¦æ­£ç¡®æŒ‚è½½
# å¯ä»¥é€šè¿‡è®¿é—®ä»»æ„hierarchyæ¥å£ï¼ˆéœ€è¦å…ˆç™»å½•è·å–tokenï¼‰
```

### **æ­¥éª¤8ï¼šåˆ›å»ºæµ‹è¯•æ•°æ®ï¼ˆå¯é€‰ï¼Œ5åˆ†é’Ÿï¼‰**

```sql
-- åˆ›å»ºæµ‹è¯•ç”¨æˆ·å’Œè§’è‰²å…³è”
-- 1. åˆ›å»ºåŒºåŸŸè´Ÿè´£äºº
INSERT INTO users (mobile, nickname, status) VALUES ('13800000001', 'å¼ åŒºåŸŸ', 'active');
SET @regional_manager_user_id = LAST_INSERT_ID();

-- 2. åˆ›å»ºä¸šåŠ¡ç»ç†
INSERT INTO users (mobile, nickname, status) VALUES ('13800000002', 'æç»ç†', 'active');
SET @business_manager_user_id = LAST_INSERT_ID();

-- 3. åˆ›å»ºä¸šåŠ¡å‘˜
INSERT INTO users (mobile, nickname, status) VALUES ('13800000003', 'ç‹ä¸šåŠ¡', 'active');
SET @sales_staff_user_id = LAST_INSERT_ID();

-- 4. åˆ†é…è§’è‰²ï¼ˆä»rolesè¡¨æŸ¥è¯¢role_idï¼‰
-- æ³¨æ„ï¼šéœ€è¦å…ˆæ‰§è¡Œæ­¥éª¤1çš„è§’è‰²åˆå§‹åŒ–SQL
INSERT INTO user_roles (user_id, role_id, is_active)
SELECT @regional_manager_user_id, role_id, 1 FROM roles WHERE role_name = 'regional_manager';

INSERT INTO user_roles (user_id, role_id, is_active)
SELECT @business_manager_user_id, role_id, 1 FROM roles WHERE role_name = 'business_manager';

INSERT INTO user_roles (user_id, role_id, is_active)
SELECT @sales_staff_user_id, role_id, 1 FROM roles WHERE role_name = 'sales_staff';

-- 5. å»ºç«‹å±‚çº§å…³ç³»ï¼ˆä½¿ç”¨UserHierarchyè¡¨ï¼‰
-- åŒºåŸŸè´Ÿè´£äººï¼ˆé¡¶çº§ï¼Œæ— ä¸Šçº§ï¼‰
INSERT INTO user_hierarchy (user_id, superior_user_id, role_id, is_active, activated_at)
SELECT @regional_manager_user_id, NULL, role_id, 1, NOW() FROM roles WHERE role_name = 'regional_manager';

-- ä¸šåŠ¡ç»ç†ï¼ˆå½’å±äºåŒºåŸŸè´Ÿè´£äººï¼‰
INSERT INTO user_hierarchy (user_id, superior_user_id, role_id, is_active, activated_at)
SELECT @business_manager_user_id, @regional_manager_user_id, role_id, 1, NOW() FROM roles WHERE role_name = 'business_manager';

-- ä¸šåŠ¡å‘˜ï¼ˆå½’å±äºä¸šåŠ¡ç»ç†ï¼‰
INSERT INTO user_hierarchy (user_id, superior_user_id, role_id, is_active, activated_at)
SELECT @sales_staff_user_id, @business_manager_user_id, role_id, 1, NOW() FROM roles WHERE role_name = 'sales_staff';

-- æŸ¥è¯¢éªŒè¯å±‚çº§å…³ç³»
SELECT 
  uh.hierarchy_id,
  u.mobile,
  u.nickname,
  r.role_name,
  r.role_level,
  IFNULL(su.nickname, 'é¡¶çº§') AS superior_name,
  uh.is_active
FROM user_hierarchy uh
JOIN users u ON uh.user_id = u.user_id
JOIN roles r ON uh.role_id = r.role_id
LEFT JOIN users su ON uh.superior_user_id = su.user_id
ORDER BY r.role_level DESC;
```

### **é›†æˆå®ŒæˆéªŒè¯æ¸…å•**

- [ ] æ•°æ®åº“è¡¨å·²åˆ›å»ºï¼ˆstores, user_hierarchy, role_change_logsï¼‰
- [ ] è§’è‰²æ•°æ®å·²åˆå§‹åŒ–ï¼ˆregional_manager, business_manager, sales_staffï¼‰
- [ ] æ¨¡å‹æ–‡ä»¶å·²åˆ›å»ºå¹¶åœ¨models/index.jsä¸­æ³¨å†Œ
- [ ] æœåŠ¡æ–‡ä»¶å·²åˆ›å»ºï¼ˆHierarchyManagementService.jsï¼‰
- [ ] APIè·¯ç”±å·²åˆ›å»ºå¹¶åœ¨app.jsä¸­æŒ‚è½½
- [ ] æœåŠ¡å·²é‡å¯å¹¶èƒ½æ­£å¸¸è®¿é—®
- [ ] ï¼ˆå¯é€‰ï¼‰æµ‹è¯•æ•°æ®å·²åˆ›å»ºå¹¶éªŒè¯

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹ï¼ˆåŸºäºå®é™…ä¸šåŠ¡åœºæ™¯ï¼‰

### **åœºæ™¯1ï¼šå»ºç«‹å±‚çº§å…³ç³»ï¼ˆåŒºåŸŸè´Ÿè´£äººâ†’ä¸šåŠ¡ç»ç†â†’ä¸šåŠ¡å‘˜ï¼‰**

```javascript
// 1. åˆ›å»ºåŒºåŸŸè´Ÿè´£äººï¼ˆuser_id: 1ï¼Œrole_id: 3ï¼‰
await HierarchyManagementService.createHierarchy(
  1,    // ç”¨æˆ·ID
  null, // æ— ä¸Šçº§ï¼ˆé¡¶çº§ï¼‰
  3,    // role_id=3 (åŒºåŸŸè´Ÿè´£äººï¼Œrole_level=3)
  null  // æ— é—¨åº—ID
)

// 2. åˆ›å»ºä¸šåŠ¡ç»ç†ï¼ˆuser_id: 10ï¼Œrole_id: 2ï¼‰å½’å±äºåŒºåŸŸè´Ÿè´£äºº
await HierarchyManagementService.createHierarchy(
  10,   // ç”¨æˆ·ID
  1,    // ä¸Šçº§ï¼šåŒºåŸŸè´Ÿè´£äºº
  2,    // role_id=2 (ä¸šåŠ¡ç»ç†ï¼Œrole_level=2)
  null  // æ— é—¨åº—ID
)

// 3. åˆ›å»ºä¸šåŠ¡å‘˜ï¼ˆuser_id: 20ï¼Œrole_id: 1ï¼‰å½’å±äºä¸šåŠ¡ç»ç†ï¼Œå¹¶åˆ†é…åˆ°é—¨åº—
await HierarchyManagementService.createHierarchy(
  20,   // ç”¨æˆ·ID
  10,   // ä¸Šçº§ï¼šä¸šåŠ¡ç»ç†
  1,    // role_id=1 (ä¸šåŠ¡å‘˜ï¼Œrole_level=1)
  5     // é—¨åº—ID: 5ï¼ˆä¸šåŠ¡å‘˜åˆ†é…åˆ°é—¨åº—5ï¼‰
)
```

### **åœºæ™¯2ï¼šæ‰¹é‡åœç”¨ä¸šåŠ¡ç»ç†åŠå…¶æ‰€æœ‰ä¸‹å±**

```javascript
// âš ï¸ å®‰å…¨è®¾è®¡ï¼šé»˜è®¤ä»…åœç”¨ç›®æ ‡ç”¨æˆ·æœ¬äººï¼Œéœ€è¦ä¸»åŠ¨é€‰æ‹©æ‰¹é‡åœç”¨ä¸‹çº§

// åœºæ™¯2.1ï¼šä»…åœç”¨ä¸šåŠ¡å‘˜æœ¬äººï¼ˆé»˜è®¤è¡Œä¸ºï¼‰
const result1 = await HierarchyManagementService.batchDeactivatePermissions(
  20,   // ç›®æ ‡ç”¨æˆ·ï¼šä¸šåŠ¡å‘˜
  10,   // æ“ä½œäººï¼šä¸šåŠ¡ç»ç†
  'ä¸šåŠ¡å‘˜è¿è§„'
  // ä¸ä¼ å…¥ç¬¬4ä¸ªå‚æ•°ï¼Œé»˜è®¤ä¸ºfalseï¼Œä»…åœç”¨ä¸šåŠ¡å‘˜æœ¬äºº
)

// è¿”å›ç»“æœï¼š
// {
//   success: true,
//   deactivatedCount: 1,  // ä»…åœç”¨1ä¸ªä¸šåŠ¡å‘˜
//   deactivatedUsers: [20],
//   message: 'æˆåŠŸåœç”¨1ä¸ªç”¨æˆ·çš„æƒé™'
// }

// åœºæ™¯2.2ï¼šä¸šåŠ¡ç»ç†ç¦»èŒï¼Œæ˜ç¡®é€‰æ‹©åœç”¨å…¶æœ¬äººåŠæ‰€æœ‰ä¸‹çº§ä¸šåŠ¡å‘˜
const result2 = await HierarchyManagementService.batchDeactivatePermissions(
  10,   // ç›®æ ‡ç”¨æˆ·ï¼šä¸šåŠ¡ç»ç†
  1,    // æ“ä½œäººï¼šåŒºåŸŸè´Ÿè´£äºº
  'ä¸šåŠ¡ç»ç†ç¦»èŒï¼Œåœç”¨å…¶åŠæ‰€æœ‰ä¸‹å±ä¸šåŠ¡å‘˜æƒé™',
  true  // âš ï¸ æ˜ç¡®ä¼ å…¥trueï¼Œæ‰¹é‡åœç”¨æ‰€æœ‰ä¸‹çº§
)

// è¿”å›ç»“æœï¼š
// {
//   success: true,
//   deactivatedCount: 11,  // 1ä¸ªä¸šåŠ¡ç»ç† + 10ä¸ªä¸šåŠ¡å‘˜
//   deactivatedUsers: [10, 20, 21, 22, ..., 29],
//   message: 'æˆåŠŸåœç”¨11ä¸ªç”¨æˆ·çš„æƒé™'
// }
```

### **åœºæ™¯3ï¼šæŸ¥è¯¢åŒºåŸŸè´Ÿè´£äººçš„æ‰€æœ‰ä¸‹çº§**

```javascript
// æŸ¥è¯¢åŒºåŸŸè´Ÿè´£äººçš„æ‰€æœ‰ä¸‹çº§ï¼ˆä¸šåŠ¡ç»ç†å’Œä¸šåŠ¡å‘˜ï¼‰
const subordinates = await HierarchyManagementService.getAllSubordinates(1)

// è¿”å›ç»“æœï¼ˆç®€åŒ–ç‰ˆï¼šç›´æ¥è¿”å›æ‰€æœ‰ä¸‹çº§ï¼Œä¸åŒ…å«å±‚çº§æ·±åº¦ï¼‰ï¼š
// [
//   {
//     user_id: 10,
//     user: { mobile: '13800138001', nickname: 'æç»ç†' },
//     role: { role_name: 'business_manager', role_level: 60 }
//   },
//   {
//     user_id: 20,
//     user: { mobile: '13800138002', nickname: 'å¼ ä¸šåŠ¡' },
//     role: { role_name: 'sales_staff', role_level: 40 }
//   },
//   // ... æ›´å¤šä¸‹çº§
// ]
```

### **åœºæ™¯4ï¼šè·å–å±‚çº§ç»Ÿè®¡ä¿¡æ¯**

```javascript
// è·å–åŒºåŸŸè´Ÿè´£äººçš„å±‚çº§ç»Ÿè®¡ï¼ˆç®€åŒ–ç‰ˆï¼šæŒ‰è§’è‰²ç±»å‹ç»Ÿè®¡ï¼‰
const stats = await HierarchyManagementService.getHierarchyStats(1)

// è¿”å›ç»“æœï¼ˆç®€åŒ–ç‰ˆï¼šæŒ‰è§’è‰²ç±»å‹ç»Ÿè®¡ï¼Œæ›´ç›´è§‚ï¼‰ï¼š
// {
//   total_subordinates: 55,   // æ€»è®¡ï¼š5ä¸ªä¸šåŠ¡ç»ç† + 50ä¸ªä¸šåŠ¡å‘˜
//   direct_subordinates: 5,   // ç›´æ¥ä¸‹å±ï¼š5ä¸ªä¸šåŠ¡ç»ç†
//   stats_by_role: {
//     'business_manager': {  // ä¸šåŠ¡ç»ç†
//       count: 5,
//       users: [
//         { user_id: 10, mobile: '13800138001', nickname: 'æç»ç†', role_name: 'business_manager' },
//         // ... æ›´å¤šä¸šåŠ¡ç»ç†
//       ]
//     },
//     'sales_staff': {  // ä¸šåŠ¡å‘˜
//       count: 50,
//       users: [
//         { user_id: 20, mobile: '13800138002', nickname: 'å¼ ä¸šåŠ¡', role_name: 'sales_staff' },
//         // ... æ›´å¤šä¸šåŠ¡å‘˜
//       ]
//     }
//   }
// }
```

---

## ğŸ”„ æ‰©å±•ä¼˜åŒ–ï¼ˆå¯é€‰ - ä»…åœ¨æ•°æ®é‡å¢é•¿åéœ€è¦ï¼‰

> **é‡è¦æç¤º**ï¼šä»¥ä¸‹ä¼˜åŒ–**ä»…åœ¨æ•°æ®é‡å¢é•¿åˆ°1000+ç”¨æˆ·åæ‰éœ€è¦è€ƒè™‘**ï¼Œå½“å‰å°æ•°æ®é‡ä¸‹è¿™äº›ä¼˜åŒ–æ˜¯è¿‡åº¦è®¾è®¡ï¼

### **å½“å‰é˜¶æ®µï¼ˆ<1000ç”¨æˆ·ï¼‰ï¼šä¸éœ€è¦è¿™äº›ä¼˜åŒ–**

å½“å‰çš„ç®€åŒ–æ–¹æ¡ˆå·²ç»è¶³å¤Ÿï¼š
- âœ… ç®€å•çš„é€’å½’æŸ¥è¯¢æ€§èƒ½å·²ç»å¾ˆå¥½ï¼ˆ<200æ¡è®°å½•ï¼‰
- âœ… æ•°æ®åº“æŸ¥è¯¢æœ¬èº«å¾ˆå¿«ï¼Œä¸éœ€è¦ç¼“å­˜
- âœ… ä¸€æ¬¡æ€§æŸ¥è¯¢æ‰€æœ‰ä¸‹çº§å³å¯ï¼Œä¸éœ€è¦åˆ†é¡µ

### **æœªæ¥ä¼˜åŒ–é€‰é¡¹ï¼ˆæ•°æ®é‡>1000åè€ƒè™‘ï¼‰**

#### **1. æ·»åŠ  hierarchy_path å­—æ®µä¼˜åŒ–æŸ¥è¯¢**

å¦‚æœä¸‹çº§æ•°é‡è¶…è¿‡100ï¼Œå¯ä»¥è€ƒè™‘æ·»åŠ  `hierarchy_path` å­—æ®µæ¥é¿å…é€’å½’æŸ¥è¯¢ï¼š

```sql
-- ä»…åœ¨éœ€è¦æ—¶æ‰æ·»åŠ æ­¤å­—æ®µ
ALTER TABLE `user_hierarchy` 
ADD COLUMN `hierarchy_path` VARCHAR(500) NULL COMMENT 'å±‚çº§è·¯å¾„ï¼ˆå¦‚ï¼š1/5/23ï¼‰' AFTER `role_id`,
ADD INDEX `idx_hierarchy_path` (`hierarchy_path`);
```

#### **2. ä½¿ç”¨Redisç¼“å­˜ï¼ˆæ•°æ®é‡>5000åè€ƒè™‘ï¼‰**

```javascript
// ä»…åœ¨æ•°æ®é‡å¾ˆå¤§æ—¶æ‰éœ€è¦ç¼“å­˜
const cachedPermissions = await redisClient.get(`permissions:${userId}`)
if (cachedPermissions) {
  return JSON.parse(cachedPermissions)
}
```

#### **3. åˆ†é¡µæŸ¥è¯¢ï¼ˆä¸‹çº§æ•°é‡>100åè€ƒè™‘ï¼‰**

```javascript
// ä»…åœ¨å•ä¸ªç”¨æˆ·çš„ä¸‹çº§è¶…è¿‡100ä¸ªæ—¶æ‰éœ€è¦åˆ†é¡µ
static async getAllSubordinatesPaginated(userId, page = 1, pageSize = 100) {
  // ... åˆ†é¡µé€»è¾‘
}
```

### **æ€§èƒ½ç›‘æ§å»ºè®®**

å®šæœŸæ£€æŸ¥ä»¥ä¸‹æŒ‡æ ‡ï¼Œå†³å®šæ˜¯å¦éœ€è¦ä¼˜åŒ–ï¼š

```javascript
// ç›‘æ§å…³é”®æŒ‡æ ‡
const stats = {
  totalUsers: await User.count(),
  totalHierarchyRecords: await UserHierarchy.count(),
  avgQueryTime: 0, // æŸ¥è¯¢å¹³å‡è€—æ—¶
  maxSubordinatesPerUser: 0 // å•ä¸ªç”¨æˆ·çš„æœ€å¤§ä¸‹çº§æ•°é‡
}

// ä¼˜åŒ–å»ºè®®ï¼š
// - totalUsers < 1000: ä½¿ç”¨å½“å‰ç®€åŒ–æ–¹æ¡ˆï¼ˆæ— éœ€ä¼˜åŒ–ï¼‰
// - totalUsers < 5000: è€ƒè™‘æ·»åŠ  hierarchy_path å­—æ®µ
// - totalUsers > 5000: è€ƒè™‘æ·»åŠ  Redis ç¼“å­˜
```

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

### **1. æƒé™éªŒè¯**

```javascript
// æ¯æ¬¡æ“ä½œå‰éªŒè¯æƒé™
const canOperate = await HierarchyManagementService.canManageUser(
  operatorUserId,
  targetUserId
)

if (!canOperate) {
  throw new Error('æ— æƒé™æ“ä½œè¯¥ç”¨æˆ·')
}
```

### **2. æ“ä½œå®¡è®¡**

```javascript
// æ‰€æœ‰æƒé™å˜æ›´æ“ä½œéƒ½è®°å½•æ—¥å¿—
await RoleChangeLog.create({
  target_user_id: targetUserId,
  operator_user_id: operatorUserId,
  operation_type: 'batch_deactivate',
  affected_count: usersToDeactivate.length,
  reason: reason,
  ip_address: req.ip,
  user_agent: req.headers['user-agent']
})
```

### **3. é˜²æ­¢è¶Šæƒæ“ä½œ**

```javascript
// æ£€æŸ¥æ“ä½œäººçš„è§’è‰²çº§åˆ«å¿…é¡»é«˜äºç›®æ ‡ç”¨æˆ·
const isHigherLevel = operatorRoleLevel > targetRoleLevel

// æ£€æŸ¥ç›®æ ‡ç”¨æˆ·å¿…é¡»åœ¨æ“ä½œäººçš„ä¸‹çº§è·¯å¾„ä¸­
const isInSubordinatePath = targetHierarchyPath.startsWith(operatorHierarchyPath)

return isHigherLevel && isInSubordinatePath
```

---

## ğŸ“Š ç›‘æ§å’Œç»Ÿè®¡

### **1. å®æ—¶ç›‘æ§ä»ªè¡¨æ¿**

```javascript
// è·å–å®æ—¶å±‚çº§ç»Ÿè®¡
router.get('/dashboard', requireAdmin, async (req, res) => {
  const stats = {
    total_users: await UserHierarchy.count({ where: { is_active: true } }),
    total_managers: await UserHierarchy.count({
      where: { is_active: true, hierarchy_level: 1 }
    }),
    total_staff: await UserHierarchy.count({
      where: { is_active: true, hierarchy_level: 2 }
    }),
    recent_deactivations: await RoleChangeLog.count({
      where: {
        operation_type: 'batch_deactivate',
        created_at: { [Op.gte]: new Date(Date.now() - 24 * 60 * 60 * 1000) }
      }
    })
  }

  res.json({ success: true, stats })
})
```

---

## âœ… æ€»ç»“

è¿™ä¸ªå±‚çº§åŒ–è§’è‰²æƒé™ç®¡ç†æ–¹æ¡ˆï¼ˆ**å®ç”¨ä¸»ä¹‰ç®€åŒ–ç‰ˆ - é¡¹ç›®ç°æœ‰æŠ€æœ¯æ ˆé›†æˆç‰ˆ**ï¼‰æä¾›äº†ï¼š

### **æ ¸å¿ƒç‰¹æ€§**

1. **âœ… ç®€å•æ˜“æ‡‚**ï¼šä»£ç ç®€æ´ï¼Œæ–°äººå¯ä»¥å¿«é€Ÿç†è§£å’Œç»´æŠ¤ï¼ˆå¹³å‡<300è¡Œ/æ–‡ä»¶ï¼‰
2. **âœ… å®‰å…¨çš„æ‰¹é‡æƒé™ç®¡ç†**ï¼šæ”¯æŒä¸€é”®åœç”¨/æ¿€æ´»æ‰€æœ‰ä¸‹çº§ï¼Œä½†é»˜è®¤ä¸è‡ªåŠ¨æ‰¹é‡æ“ä½œï¼ˆé˜²æ­¢è¯¯æ“ä½œï¼‰
3. **âœ… æƒé™éš”ç¦»**ï¼šä¸šåŠ¡ç»ç†åªèƒ½ç®¡ç†è‡ªå·±çš„ä¸‹å±ï¼Œä¸èƒ½è·¨åŒºåŸŸç®¡ç†
4. **âœ… å®Œæ•´å®¡è®¡**ï¼šæ‰€æœ‰æ“ä½œéƒ½æœ‰æ—¥å¿—è®°å½•ï¼ˆrole_change_logsè¡¨ï¼‰
5. **âœ… ä½ç»´æŠ¤æˆæœ¬**ï¼šä¸ä¾èµ–é¢å¤–æœåŠ¡ï¼Œæ²¡æœ‰è¿‡åº¦è®¾è®¡ï¼Œå®Œå…¨å¤ç”¨ç°æœ‰åŸºç¡€è®¾æ–½
6. **âœ… å®‰å…¨å¯é **ï¼šå¤šé‡æƒé™éªŒè¯ï¼Œé˜²æ­¢è¶Šæƒæ“ä½œï¼›é‡è¦æ“ä½œéœ€è¦æ˜ç¡®çš„ç”¨æˆ·æ„å›¾ç¡®è®¤
7. **âœ… æ— ç¼é›†æˆ**ï¼šå®Œå…¨åŸºäºé¡¹ç›®ç°æœ‰æŠ€æœ¯æ ˆï¼ˆUUIDè§’è‰²ç³»ç»Ÿã€BeijingTimeHelperã€authenticateTokenï¼‰

### **ğŸ”’ å®‰å…¨è®¾è®¡äº®ç‚¹**

- **æ˜¾å¼ç¡®è®¤æœºåˆ¶**ï¼šæ‰¹é‡åœç”¨ä¸‹çº§éœ€è¦æ˜ç¡®ä¼ å…¥`include_subordinates: true`ï¼Œé˜²æ­¢è¯¯æ“ä½œ
- **é»˜è®¤æœ€å°å½±å“**ï¼šæœªæ˜ç¡®æŒ‡å®šæ—¶ï¼Œé»˜è®¤ä»…å½±å“ç›®æ ‡ç”¨æˆ·æœ¬äºº
- **åˆ†çº§ä¿æŠ¤**ï¼šä¸åŒçº§åˆ«çš„æ“ä½œæœ‰ä¸åŒçš„å®‰å…¨ä¿æŠ¤æªæ–½

### **ğŸ’¡ ç®€åŒ–è®¾è®¡åŸåˆ™**

æœ¬æ–¹æ¡ˆéµå¾ª"**ä¸è¦ä¸ºäº†é‡æ„è€Œé‡æ„ï¼Œè¦ä¸ºäº†é™ä½ç»´æŠ¤æˆæœ¬è€Œé‡æ„**"çš„åŸåˆ™ï¼š

- âŒ **ç§»é™¤äº†** `hierarchy_path` å­—æ®µï¼ˆå°æ•°æ®é‡ä¸‹é€’å½’æŸ¥è¯¢è¶³å¤Ÿå¿«ï¼‰
- âŒ **ç§»é™¤äº†** `hierarchy_level` å­—æ®µï¼ˆé¿å…æ•°æ®å†—ä½™ï¼Œå¯åŠ¨æ€è®¡ç®—ï¼‰
- âŒ **ç§»é™¤äº†** Redis ç¼“å­˜é€»è¾‘ï¼ˆå¤ç”¨é¡¹ç›®ç°æœ‰authç¼“å­˜ï¼Œæ— éœ€é‡å¤ï¼‰
- âŒ **ç§»é™¤äº†** åˆ†é¡µæŸ¥è¯¢åŠŸèƒ½ï¼ˆå°æ•°æ®é‡ä¸€æ¬¡æ€§æŸ¥è¯¢å³å¯ï¼‰
- âŒ **ç§»é™¤äº†** å¤æ‚çš„ç´¢å¼•ç­–ç•¥ï¼ˆä»…ä¿ç•™3ä¸ªæ ¸å¿ƒç´¢å¼•ï¼‰
- âŒ **ç§»é™¤äº†** user_agentå­—æ®µï¼ˆV4.0æ¶æ„ç®€åŒ–ï¼ŒIPåœ°å€å·²è¶³å¤Ÿï¼‰

### **ğŸ”Œ ä¸ç°æœ‰ç³»ç»Ÿæ·±åº¦é›†æˆ**

æœ¬æ–¹æ¡ˆ**å®Œå…¨å¤ç”¨é¡¹ç›®ç°æœ‰åŸºç¡€è®¾æ–½**ï¼Œä¸å¢åŠ æŠ€æœ¯å€ºåŠ¡ï¼š

- âœ… **å¤ç”¨UUIDè§’è‰²ç³»ç»Ÿ**ï¼šåŸºäºç°æœ‰Roleã€Userã€UserRoleæ¨¡å‹
- âœ… **å¤ç”¨è®¤è¯ä¸­é—´ä»¶**ï¼šä½¿ç”¨authenticateTokenã€requireAdmin
- âœ… **å¤ç”¨æ—¶é—´å·¥å…·**ï¼šä½¿ç”¨BeijingTimeHelperï¼ˆåŒ—äº¬æ—¶é—´GMT+8ï¼‰
- âœ… **å¤ç”¨ç¼“å­˜å¤±æ•ˆ**ï¼šä½¿ç”¨PermissionManager.invalidateMultipleUsers
- âœ… **éµå¾ªV4.0æ¶æ„è§„èŒƒ**ï¼šè·¯ç”±ã€é”™è¯¯å¤„ç†ã€æ—¥å¿—è®°å½•ç»Ÿä¸€æ ‡å‡†
- âœ… **éµå¾ªé¡¹ç›®å‘½åè§„èŒƒ**ï¼šä¸‹åˆ’çº¿å‘½åã€tableNameã€timestampsç­‰

### **ğŸ“Š é€‚ç”¨åœºæ™¯**

- âœ… å°å‹é¡¹ç›®ï¼ˆ<1000ç”¨æˆ·ï¼‰
- âœ… å¯èƒ½æš‚åœä¸šåŠ¡çš„é¡¹ç›®
- âœ… éœ€è¦å¿«é€Ÿå¼€å‘ä¸Šçº¿çš„é¡¹ç›®
- âœ… ç»´æŠ¤å›¢é˜Ÿè§„æ¨¡è¾ƒå°çš„é¡¹ç›®
- âš ï¸ å¦‚æœæ•°æ®é‡å¢é•¿ï¼Œå¯ä»¥é€æ­¥æ·»åŠ ä¼˜åŒ–ï¼ˆå‚è§"æ‰©å±•ä¼˜åŒ–"ç« èŠ‚ï¼‰

### **ğŸš€ å®æ–½å»ºè®®**

1. **å½“å‰é˜¶æ®µ**ï¼šä½¿ç”¨æœ¬ç®€åŒ–æ–¹æ¡ˆï¼Œæ»¡è¶³æ ¸å¿ƒéœ€æ±‚ï¼Œé¢„è®¡é›†æˆæ—¶é—´<1å°æ—¶
2. **ç›‘æ§æŒ‡æ ‡**ï¼šå®šæœŸæ£€æŸ¥ç”¨æˆ·é‡ã€å±‚çº§å…³ç³»æ•°é‡ã€æŸ¥è¯¢æ€§èƒ½ï¼ˆå½“å‰<200æ¡è®°å½•ï¼‰
3. **é€æ­¥ä¼˜åŒ–**ï¼šä»…åœ¨æ•°æ®é‡å¢é•¿åˆ°1000+ç”¨æˆ·åï¼Œæ‰è€ƒè™‘æ·»åŠ å¤æ‚ä¼˜åŒ–
4. **ä¿æŒç®€å•**ï¼šé™¤éé‡åˆ°æ˜ç¡®çš„æ€§èƒ½ç“¶é¢ˆï¼Œå¦åˆ™ä¸è¦å¢åŠ å¤æ‚åº¦
5. **æŒç»­é›†æˆ**ï¼šéµå¾ªé¡¹ç›®ç°æœ‰å¼€å‘æµç¨‹ï¼Œç¡®ä¿ä»£ç é£æ ¼å’Œè´¨é‡æ ‡å‡†ä¸€è‡´

### **ğŸ“Š æŠ€æœ¯å€ºåŠ¡è¯„ä¼°**

| æŒ‡æ ‡ | è¯„åˆ† | è¯´æ˜ |
|-----|------|-----|
| **ä»£ç å¤æ‚åº¦** | â­â­â­â­â­ ä½ | å¹³å‡<300è¡Œ/æ–‡ä»¶ï¼Œé€»è¾‘æ¸…æ™° |
| **ç»´æŠ¤æˆæœ¬** | â­â­â­â­â­ ä½ | å®Œå…¨å¤ç”¨ç°æœ‰åŸºç¡€è®¾æ–½ |
| **æ–°äººå­¦ä¹ æˆæœ¬** | â­â­â­â­â­ ä½ | éµå¾ªé¡¹ç›®ç°æœ‰è§„èŒƒå’Œæ¨¡å¼ |
| **é‡æ„éš¾åº¦** | â­â­â­â­â­ ä½ | æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºè°ƒæ•´ |
| **é•¿æœŸå€ºåŠ¡ç´¯ç§¯** | â­â­â­â­â­ ä½ | æ— é¢å¤–ä¾èµ–ï¼Œæ— è¿‡åº¦è®¾è®¡ |
| **æ•°æ®åº“æ€§èƒ½** | â­â­â­â­â­ ä¼˜ | ä»…3ä¸ªæ ¸å¿ƒç´¢å¼•ï¼ŒæŸ¥è¯¢ç®€å• |
| **ä¸šåŠ¡è¯­ä¹‰** | â­â­â­â­â­ æ¸…æ™° | å­—æ®µå‘½åæ¸…æ™°ï¼Œæ³¨é‡Šè¯¦ç»† |
| **æ–‡æ¡£ä¾èµ–åº¦** | â­â­â­â­â­ ä½ | ä»£ç è‡ªæ–‡æ¡£åŒ–ï¼Œæ³¨é‡Šå……åˆ† |

### **ğŸ’° å®æ–½æˆæœ¬é¢„ä¼°**

åŸºäºé¡¹ç›®å®é™…æƒ…å†µçš„æˆæœ¬è¯„ä¼°ï¼š

| é˜¶æ®µ | é¢„ä¼°æ—¶é—´ | è¯´æ˜ |
|-----|---------|-----|
| æ•°æ®åº“è¡¨åˆ›å»º | 5åˆ†é’Ÿ | æ‰§è¡ŒSQLè„šæœ¬ |
| æ¨¡å‹æ–‡ä»¶åˆ›å»º | 10åˆ†é’Ÿ | å¤åˆ¶ç²˜è´´3ä¸ªæ¨¡å‹ä»£ç  |
| æœåŠ¡æ–‡ä»¶åˆ›å»º | 5åˆ†é’Ÿ | å¤åˆ¶ç²˜è´´1ä¸ªæœåŠ¡ä»£ç  |
| è·¯ç”±æ–‡ä»¶åˆ›å»º | 5åˆ†é’Ÿ | å¤åˆ¶ç²˜è´´1ä¸ªè·¯ç”±ä»£ç  |
| æ³¨å†Œå’ŒæŒ‚è½½ | 5åˆ†é’Ÿ | ä¿®æ”¹index.jså’Œapp.js |
| æµ‹è¯•éªŒè¯ | 10åˆ†é’Ÿ | åˆ›å»ºæµ‹è¯•æ•°æ®å¹¶éªŒè¯ |
| **æ€»è®¡** | **40åˆ†é’Ÿ** | 1äººå³å¯å®Œæˆå…¨éƒ¨é›†æˆ |

