# å¤šè¿æŠ½æ—¶é—´ç®¡ç†æŠ€æœ¯è§£å†³æ–¹æ¡ˆæ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **é¡¹ç›®åç§°**: é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿv4.0
- **éœ€æ±‚æè¿°**: å‰ç«¯éœ€è¦å‡†ç¡®æ˜¾ç¤º3è¿æŠ½/5è¿æŠ½/10è¿æŠ½çš„ç»Ÿä¸€æŠ½å¥–æ—¶é—´
- **é—®é¢˜ç°çŠ¶**: å½“å‰å¤šè¿æŠ½è¿”å›3æ¬¡ç‹¬ç«‹çš„å•æŠ½æ—¶é—´æˆ³ï¼Œå‰ç«¯æ— æ³•è¯†åˆ«æ‰¹æ¬¡
- **è§£å†³ç›®æ ‡**: è®©å‰ç«¯èƒ½å¤Ÿå‡†ç¡®è·å–å¤šè¿æŠ½çš„æ•´ä½“æ‰§è¡Œæ—¶é—´
- **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
- **åˆ›å»ºæ—¶é—´**: 2025-09-13
- **æŠ€æœ¯æ ˆ**: Node.js + Express + MySQL + Sequelize

## ğŸ” é—®é¢˜åˆ†æ

### å½“å‰å®ç°é—®é¢˜

```ascii
ç°çŠ¶æµç¨‹å›¾ï¼š
ç”¨æˆ·ç‚¹å‡»"3è¿æŠ½"
    â†“
åç«¯æ‰§è¡Œforå¾ªç¯3æ¬¡
    â†“
ç”Ÿæˆ3æ¡ç‹¬ç«‹è®°å½•ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®°å½•1: draw_type='single', 12:00:01 â”‚
â”‚ è®°å½•2: draw_type='single', 12:00:02 â”‚
â”‚ è®°å½•3: draw_type='single', 12:00:03 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
å‰ç«¯æ”¶åˆ°æ•°æ®æ˜¾ç¤ºï¼š
"ç”¨æˆ·åœ¨12:00:01ã€12:00:02ã€12:00:03åˆ†åˆ«è¿›è¡Œäº†3æ¬¡å•æŠ½"
âŒ å®é™…åº”è¯¥æ˜¾ç¤ºï¼š"ç”¨æˆ·åœ¨12:00:00è¿›è¡Œäº†1æ¬¡3è¿æŠ½"
```

### æ ¸å¿ƒæŠ€æœ¯éš¾ç‚¹

1. **æ—¶é—´æˆ³åˆ†ç¦»**: æ¯æ¬¡æŠ½å¥–éƒ½æœ‰ç‹¬ç«‹çš„`created_at`æ—¶é—´
2. **æ‰¹æ¬¡è¯†åˆ«ç¼ºå¤±**: `batch_id`å­—æ®µæœªä½¿ç”¨ï¼Œæ— æ³•å…³è”åŒæ‰¹æ¬¡è®°å½•
3. **ç±»å‹æ ‡è¯†é”™è¯¯**: `draw_type`å®é™…å­˜å‚¨ä¸º'single'è€Œé'triple'
4. **å‰ç«¯è§£æå›°éš¾**: æ— æ³•åŒºåˆ†"è¿ç»­3æ¬¡å•æŠ½"vs"1æ¬¡3è¿æŠ½"

## ğŸ¯ ä¸‰ç§æŠ€æœ¯è§£å†³æ–¹æ¡ˆ

## æ–¹æ¡ˆA: batch_idå…³è”æ³•ï¼ˆæ¨èâ­â­â­â­â­ï¼‰

### è®¾è®¡åŸç†

åˆ©ç”¨ç°æœ‰æ•°æ®åº“ç»“æ„ï¼Œé€šè¿‡`batch_id`å­—æ®µå…³è”åŒæ‰¹æ¬¡æŠ½å¥–è®°å½•ï¼Œä½¿ç”¨ç»Ÿä¸€æ—¶é—´æˆ³æ ‡è¯†æ‰¹æ¬¡æ‰§è¡Œæ—¶é—´ã€‚

### æ•°æ®åº“è®¾è®¡

```sql
-- ç°æœ‰è¡¨ç»“æ„ï¼Œæ— éœ€ä¿®æ”¹
CREATE TABLE lottery_records (
  draw_id VARCHAR(50) PRIMARY KEY,
  user_id INT NOT NULL,
  batch_id VARCHAR(50),          -- ğŸ¯ æ‰¹æ¬¡å…³è”å­—æ®µ
  draw_sequence INT,             -- ğŸ¯ æ‰¹æ¬¡å†…åºå·
  draw_count INT,                -- ğŸ¯ æ‰¹æ¬¡æ€»æ•°
  draw_type ENUM('single','triple','five','ten'), -- ğŸ¯ æ­£ç¡®çš„ç±»å‹
  created_at DATETIME,           -- ğŸ¯ ç»Ÿä¸€çš„æ‰¹æ¬¡æ—¶é—´
  prize_id INT,
  prize_name VARCHAR(100),
  is_winner BOOLEAN,
  INDEX idx_batch_id (batch_id),
  INDEX idx_user_batch (user_id, batch_id)
);

-- æ•°æ®ç¤ºä¾‹
INSERT INTO lottery_records VALUES
('batch_123_1', 31, 'batch_123', 1, 3, 'triple', '2025-09-13 12:00:00', 15, 'è‹¹æœ', 1),
('batch_123_2', 31, 'batch_123', 2, 3, 'triple', '2025-09-13 12:00:00', NULL, 'è°¢è°¢å‚ä¸', 0),
('batch_123_3', 31, 'batch_123', 3, 3, 'triple', '2025-09-13 12:00:00', 23, 'æ©™å­', 1);
```

### åç«¯APIå®ç°

```javascript
// routes/v4/unified-engine/lottery.js
router.post('/batch-lottery', async (req, res) => {
  try {
    const { user_id, draw_count, campaign_id } = req.body

    // ğŸ¯ ç”Ÿæˆæ‰¹æ¬¡ä¸Šä¸‹æ–‡
    const batchId = `batch_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`
    const batchTime = moment().tz('Asia/Shanghai').toDate()
    const drawType =
      draw_count === 3 ? 'triple' : draw_count === 5 ? 'five' : draw_count === 10 ? 'ten' : 'single'

    console.log(`ğŸ° å¼€å§‹${drawType}ï¼Œæ‰¹æ¬¡ID: ${batchId}`)

    const results = []
    const transaction = await models.sequelize.transaction()

    try {
      // æ‰§è¡ŒæŠ½å¥–å¾ªç¯
      for (let i = 0; i < draw_count; i++) {
        const lotteryResult = await lotteryEngine.executeLottery({
          userId: user_id,
          activityId: campaign_id,
          strategyType: 'basic_lottery'
        })

        // ğŸ¯ å…³é”®ï¼šç»Ÿä¸€æ‰¹æ¬¡ä¿¡æ¯å†™å…¥
        const recordData = {
          draw_id: `${batchId}_${i + 1}`,
          user_id: user_id,
          campaign_id: campaign_id,
          batch_id: batchId, // ğŸ”‘ æ‰¹æ¬¡ID
          draw_sequence: i + 1, // ğŸ”‘ åºå·
          draw_count: draw_count, // ğŸ”‘ æ€»æ•°
          draw_type: drawType, // ğŸ”‘ æ­£ç¡®ç±»å‹
          created_at: batchTime, // ğŸ”‘ ç»Ÿä¸€æ—¶é—´
          prize_id: lotteryResult.data?.prize_id || null,
          prize_name: lotteryResult.data?.prize_name || 'è°¢è°¢å‚ä¸',
          is_winner: lotteryResult.data?.is_winner || false
        }

        await models.LotteryRecord.create(recordData, { transaction })
        results.push(recordData)
      }

      await transaction.commit()

      // ğŸ¯ è¿”å›æ‰¹æ¬¡åŒ–æ•°æ®
      res.apiSuccess(
        {
          batch_info: {
            batch_id: batchId,
            batch_type: drawType,
            batch_time: moment(batchTime).tz('Asia/Shanghai').format('YYYY-MM-DD HH:mm:ss'),
            total_count: draw_count,
            success_count: results.filter(r => r.is_winner).length
          },
          results: results
        },
        `${drawType}å®Œæˆ`
      )
    } catch (error) {
      await transaction.rollback()
      throw error
    }
  } catch (error) {
    console.error('æ‰¹é‡æŠ½å¥–å¤±è´¥:', error)
    res.apiError('æŠ½å¥–å¤±è´¥', 'LOTTERY_FAILED', { error: error.message })
  }
})

// ğŸ” å‰ç«¯æŸ¥è¯¢æ¥å£
router.get('/user/:userId/lottery-history', async (req, res) => {
  try {
    // æŸ¥è¯¢æ‰¹æ¬¡åˆ—è¡¨
    const batchQuery = `
      SELECT 
        batch_id,
        draw_type,
        created_at as batch_time,
        COUNT(*) as total_count,
        SUM(CASE WHEN is_winner = 1 THEN 1 ELSE 0 END) as success_count,
        GROUP_CONCAT(prize_name ORDER BY draw_sequence) as prize_list
      FROM lottery_records 
      WHERE user_id = :userId AND batch_id IS NOT NULL
      GROUP BY batch_id, draw_type, created_at
      ORDER BY created_at DESC
      LIMIT 20
    `

    const batches = await models.sequelize.query(batchQuery, {
      replacements: { userId: req.params.userId },
      type: models.sequelize.QueryTypes.SELECT
    })

    res.apiSuccess(batches, 'æŸ¥è¯¢æˆåŠŸ')
  } catch (error) {
    res.apiError('æŸ¥è¯¢å¤±è´¥', 'QUERY_FAILED')
  }
})

// ğŸ” æ‰¹æ¬¡è¯¦æƒ…æŸ¥è¯¢
router.get('/batch/:batchId/details', async (req, res) => {
  try {
    const details = await models.LotteryRecord.findAll({
      where: { batch_id: req.params.batchId },
      order: [['draw_sequence', 'ASC']],
      include: [
        {
          model: models.LotteryPrize,
          as: 'prize',
          required: false
        }
      ]
    })

    res.apiSuccess(details, 'è¯¦æƒ…æŸ¥è¯¢æˆåŠŸ')
  } catch (error) {
    res.apiError('è¯¦æƒ…æŸ¥è¯¢å¤±è´¥', 'DETAIL_QUERY_FAILED')
  }
})
```

### å‰ç«¯è°ƒç”¨ç¤ºä¾‹

```javascript
// å‰ç«¯æŸ¥è¯¢ç”¨æˆ·æŠ½å¥–å†å²
async function getUserLotteryHistory(userId) {
  try {
    const response = await fetch(`/api/v4/unified-engine/lottery/user/${userId}/lottery-history`)
    const data = await response.json()

    if (data.success) {
      // ğŸ¯ å‰ç«¯ç›´æ¥è·å¾—æ‰¹æ¬¡åŒ–æ•°æ®ï¼
      data.data.forEach(batch => {
        console.log(`${batch.draw_type}ï¼Œæ—¶é—´ï¼š${batch.batch_time}`)
        console.log(`ä¸­å¥–${batch.success_count}/${batch.total_count}æ¬¡`)
        console.log(`å¥–å“ï¼š${batch.prize_list}`)
        console.log('---')
      })
    }
  } catch (error) {
    console.error('æŸ¥è¯¢å†å²å¤±è´¥:', error)
  }
}

// å‰ç«¯æ˜¾ç¤ºé€»è¾‘
function displayLotteryHistory(batches) {
  const historyList = document.getElementById('lottery-history')

  batches.forEach(batch => {
    const item = document.createElement('div')
    item.className = 'history-item'

    // ğŸ¯ æ˜¾ç¤ºç»Ÿä¸€çš„æŠ½å¥–æ—¶é—´
    item.innerHTML = `
      <div class="batch-header">
        <span class="batch-type">${getDisplayName(batch.draw_type)}</span>
        <span class="batch-time">${formatTime(batch.batch_time)}</span>
      </div>
      <div class="batch-result">
        ä¸­å¥– ${batch.success_count}/${batch.total_count} æ¬¡
      </div>
      <button onclick="showDetails('${batch.batch_id}')">æŸ¥çœ‹è¯¦æƒ…</button>
    `

    historyList.appendChild(item)
  })
}

function getDisplayName(drawType) {
  const names = {
    single: 'å•æŠ½',
    triple: '3è¿æŠ½', // ğŸ¯ æ­£ç¡®æ˜¾ç¤º3è¿æŠ½
    five: '5è¿æŠ½',
    ten: '10è¿æŠ½'
  }
  return names[drawType] || drawType
}
```

### ä¼˜ç¼ºç‚¹åˆ†æ

**ä¼˜ç‚¹**:

- âœ… åˆ©ç”¨ç°æœ‰è¡¨ç»“æ„ï¼Œæ”¹åŠ¨æœ€å°
- âœ… æ•°æ®å…³ç³»æ¸…æ™°ï¼Œä¾¿äºå¤æ‚æŸ¥è¯¢
- âœ… æ”¯æŒSQLèšåˆç»Ÿè®¡åˆ†æ
- âœ… å‘åå…¼å®¹ï¼Œä¸å½±å“å•æŠ½è®°å½•

**ç¼ºç‚¹**:

- âŒ éœ€è¦ä¸¤æ­¥æŸ¥è¯¢ï¼ˆæ‰¹æ¬¡åˆ—è¡¨ + è¯¦æƒ…ï¼‰
- âŒ æ•°æ®é‡ç›¸å¯¹è¾ƒå¤§ï¼ˆæ¯æ¬¡æŠ½å¥–ä¸€æ¡è®°å½•ï¼‰

---

## æ–¹æ¡ˆB: JSONæ‰“åŒ…å­˜å‚¨æ³•

### è®¾è®¡åŸç†

åˆ›å»ºæ–°çš„æ‰¹æ¬¡è®°å½•è¡¨ï¼Œå°†å¤šæ¬¡æŠ½å¥–ç»“æœæ‰“åŒ…å­˜å‚¨åœ¨JSONå­—æ®µä¸­ï¼Œå®ç°çœŸæ­£çš„"ä¸€æ¬¡æŠ½å¥–ä¸€æ¡è®°å½•"ã€‚

### æ•°æ®åº“è®¾è®¡

```sql
-- æ–°å»ºæ‰¹æ¬¡æŠ½å¥–è¡¨
CREATE TABLE batch_lottery_records (
  batch_id VARCHAR(50) PRIMARY KEY,
  user_id INT NOT NULL,
  campaign_id INT NOT NULL,
  batch_type ENUM('single', 'triple', 'five', 'ten'),
  batch_results JSON,              -- ğŸ¯ JSONå­˜å‚¨æ‰€æœ‰ç»“æœ
  total_cost INT,                  -- æ€»æ¶ˆè€—ç§¯åˆ†
  success_count INT,               -- ä¸­å¥–æ¬¡æ•°
  total_value INT,                 -- æ€»å¥–å“ä»·å€¼
  created_at DATETIME,             -- ğŸ¯ ç»Ÿä¸€æ‰¹æ¬¡æ—¶é—´

  INDEX idx_user_time (user_id, created_at),
  INDEX idx_batch_type (batch_type),
  INDEX idx_success_count (success_count)
);

-- JSONæ•°æ®ç»“æ„ç¤ºä¾‹
{
  "metadata": {
    "batch_id": "batch_1726207200_abc123",
    "execution_time_ms": 1250,
    "strategy_used": ["basic_lottery", "basic_lottery", "guarantee"],
    "total_cost": 270,
    "discount_applied": 30
  },
  "results": [
    {
      "sequence": 1,
      "prize_id": 15,
      "prize_name": "è‹¹æœ",
      "prize_type": "physical",
      "prize_value": 10,
      "is_winner": true,
      "probability_used": 0.15,
      "strategy": "basic_lottery",
      "execution_time": 450
    },
    {
      "sequence": 2,
      "prize_id": null,
      "prize_name": "è°¢è°¢å‚ä¸",
      "prize_type": "none",
      "prize_value": 0,
      "is_winner": false,
      "probability_used": 0.85,
      "strategy": "basic_lottery",
      "execution_time": 380
    },
    {
      "sequence": 3,
      "prize_id": 23,
      "prize_name": "æ©™å­",
      "prize_type": "physical",
      "prize_value": 15,
      "is_winner": true,
      "probability_used": 0.12,
      "strategy": "guarantee",
      "execution_time": 420
    }
  ]
}
```

### åç«¯APIå®ç°

```javascript
// æ‰¹é‡æŠ½å¥–æ¥å£
router.post('/json-batch-lottery', async (req, res) => {
  try {
    const { user_id, draw_count, campaign_id } = req.body

    const batchId = `batch_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`
    const batchStartTime = moment().tz('Asia/Shanghai').toDate()
    const drawType =
      draw_count === 3 ? 'triple' : draw_count === 5 ? 'five' : draw_count === 10 ? 'ten' : 'single'

    // æ‰§è¡ŒæŠ½å¥–é€»è¾‘ï¼ˆå¤ç”¨ç°æœ‰ä»£ç ï¼‰
    const lotteryResults = []
    let totalCost = 0
    let successCount = 0

    for (let i = 0; i < draw_count; i++) {
      const result = await lotteryEngine.executeLottery({
        userId: user_id,
        activityId: campaign_id,
        strategyType: 'basic_lottery'
      })

      const formattedResult = {
        sequence: i + 1,
        prize_id: result.data?.prize_id || null,
        prize_name: result.data?.prize_name || 'è°¢è°¢å‚ä¸',
        prize_type: result.data?.prize_type || 'none',
        prize_value: result.data?.prize_value || 0,
        is_winner: result.data?.is_winner || false,
        probability_used: result.metadata?.probability || 0,
        strategy: result.metadata?.strategy || 'basic_lottery',
        execution_time: result.executionTime || 0
      }

      lotteryResults.push(formattedResult)
      totalCost += 100 // å‡è®¾æ¯æ¬¡100ç§¯åˆ†
      if (formattedResult.is_winner) successCount++
    }

    // ğŸ¯ æ„å»ºJSONæ•°æ®åŒ…
    const batchResults = {
      metadata: {
        batch_id: batchId,
        execution_time_ms: Date.now() - batchStartTime.getTime(),
        total_cost: totalCost,
        discount_applied: draw_count > 1 ? totalCost * 0.1 : 0
      },
      results: lotteryResults
    }

    // ğŸ¯ ä¸€æ¡è®°å½•å­˜å‚¨æ•´ä¸ªæ‰¹æ¬¡
    const batchRecord = await models.BatchLotteryRecord.create({
      batch_id: batchId,
      user_id: user_id,
      campaign_id: campaign_id,
      batch_type: drawType,
      batch_results: JSON.stringify(batchResults),
      total_cost: totalCost,
      success_count: successCount,
      total_value: lotteryResults.reduce((sum, r) => sum + r.prize_value, 0),
      created_at: batchStartTime
    })

    res.apiSuccess(
      {
        batch_id: batchId,
        batch_type: drawType,
        batch_time: moment(batchStartTime).tz('Asia/Shanghai').format('YYYY-MM-DD HH:mm:ss'),
        total_count: draw_count,
        success_count: successCount,
        results: lotteryResults
      },
      `${drawType}å®Œæˆ`
    )
  } catch (error) {
    console.error('JSONæ‰¹é‡æŠ½å¥–å¤±è´¥:', error)
    res.apiError('æŠ½å¥–å¤±è´¥', 'JSON_LOTTERY_FAILED')
  }
})

// ğŸ” æŸ¥è¯¢æ¥å£
router.get('/user/:userId/json-lottery-history', async (req, res) => {
  try {
    const records = await models.BatchLotteryRecord.findAll({
      where: { user_id: req.params.userId },
      attributes: [
        'batch_id',
        'batch_type',
        'created_at',
        'total_cost',
        'success_count',
        'total_value',
        'batch_results'
      ],
      order: [['created_at', 'DESC']],
      limit: 20
    })

    // ğŸ¯ è§£æJSONå¹¶è¿”å›æ ¼å¼åŒ–æ•°æ®
    const formattedRecords = records.map(record => ({
      batch_id: record.batch_id,
      batch_type: record.batch_type,
      batch_time: moment(record.created_at).tz('Asia/Shanghai').format('YYYY-MM-DD HH:mm:ss'),
      total_cost: record.total_cost,
      success_count: record.success_count,
      total_value: record.total_value,
      results: JSON.parse(record.batch_results).results
    }))

    res.apiSuccess(formattedRecords, 'æŸ¥è¯¢æˆåŠŸ')
  } catch (error) {
    res.apiError('JSONæŸ¥è¯¢å¤±è´¥', 'JSON_QUERY_FAILED')
  }
})
```

### å‰ç«¯è°ƒç”¨ç¤ºä¾‹

```javascript
// å‰ç«¯æŸ¥è¯¢å˜å¾—è¶…çº§ç®€å•
async function getJSONLotteryHistory(userId) {
  try {
    const response = await fetch(
      `/api/v4/unified-engine/lottery/user/${userId}/json-lottery-history`
    )
    const data = await response.json()

    if (data.success) {
      // ğŸ¯ ä¸€æ­¥åˆ°ä½ï¼Œè·å¾—å®Œæ•´æ•°æ®ï¼
      data.data.forEach(batch => {
        console.log(`${batch.batch_type}ï¼Œæ—¶é—´ï¼š${batch.batch_time}`)
        console.log(`æˆæœ¬ï¼š${batch.total_cost}ï¼Œä»·å€¼ï¼š${batch.total_value}`)
        console.log(`è¯¦ç»†ç»“æœï¼š`, batch.results)

        // ğŸ¯ å¯ä»¥ç›´æ¥éå†æ¯æ¬¡æŠ½å¥–ç»“æœ
        batch.results.forEach(result => {
          console.log(`  ç¬¬${result.sequence}æ¬¡: ${result.prize_name}`)
        })
      })
    }
  } catch (error) {
    console.error('æŸ¥è¯¢å¤±è´¥:', error)
  }
}

// å‰ç«¯ç»Ÿè®¡åˆ†æ
function analyzeWinRate(histories) {
  const stats = {
    triple: { total: 0, wins: 0 },
    five: { total: 0, wins: 0 },
    ten: { total: 0, wins: 0 }
  }

  histories.forEach(batch => {
    if (stats[batch.batch_type]) {
      stats[batch.batch_type].total += batch.results.length
      stats[batch.batch_type].wins += batch.success_count
    }
  })

  // ğŸ¯ å‰ç«¯å¯ä»¥ç›´æ¥è®¡ç®—å„ç§ç»Ÿè®¡æ•°æ®
  Object.keys(stats).forEach(type => {
    const winRate = ((stats[type].wins / stats[type].total) * 100).toFixed(1)
    console.log(`${type}ä¸­å¥–ç‡: ${winRate}%`)
  })
}
```

### ä¼˜ç¼ºç‚¹åˆ†æ

**ä¼˜ç‚¹**:

- âœ… æŸ¥è¯¢æœ€ç®€å•ï¼Œä¸€æ­¥è·å¾—æ‰€æœ‰æ•°æ®
- âœ… å­˜å‚¨æ•ˆç‡é«˜ï¼Œä¸€æ¬¡æŠ½å¥–ä¸€æ¡è®°å½•
- âœ… JSONçµæ´»ï¼Œå¯å­˜å‚¨å¤æ‚çš„æŠ½å¥–å…ƒæ•°æ®
- âœ… å‰ç«¯å¤„ç†ç®€å•ï¼Œæ— éœ€å…³è”æŸ¥è¯¢

**ç¼ºç‚¹**:

- âŒ SQLèšåˆç»Ÿè®¡å›°éš¾ï¼ˆéœ€è¦JSONå‡½æ•°ï¼‰
- âŒ å•ä¸ªè®°å½•æŸ¥è¯¢éº»çƒ¦ï¼ˆä¸èƒ½æŒ‰prize_idç´¢å¼•ï¼‰
- âŒ éœ€è¦æ–°å»ºè¡¨ï¼Œæ•°æ®è¿ç§»å¤æ‚
- âŒ JSONå­—æ®µè°ƒè¯•å’Œç»´æŠ¤ç›¸å¯¹å›°éš¾

---

## æ–¹æ¡ˆC: ä¸€é”…ç«¯æ‰¹é‡è®¡ç®—æ³•

### è®¾è®¡åŸç†

é‡æ„æŠ½å¥–å¼•æ“ï¼Œæ”¯æŒçœŸæ­£çš„æ‰¹é‡è®¡ç®—ï¼Œåœ¨åŒä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡ä¸­è®¡ç®—å¤šæ¬¡ç»“æœï¼Œå®ç°æ›´æ™ºèƒ½çš„ä¿åº•æœºåˆ¶ã€‚

### æ ¸å¿ƒå¼•æ“é‡æ„

```javascript
// services/UnifiedLotteryEngine/BatchLotteryEngine.js
class BatchLotteryEngine extends UnifiedLotteryEngine {
  /**
   * æ‰¹é‡æŠ½å¥–æ ¸å¿ƒæ–¹æ³•
   * åœ¨å•ä¸€æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­è®¡ç®—å¤šæ¬¡æŠ½å¥–ç»“æœ
   */
  async executeBatchLottery(request) {
    const { userId, activityId, batchCount, strategyType = 'basic_lottery' } = request
    const batchStartTime = Date.now()

    try {
      // ğŸ¯ ä¸€æ¬¡æ€§è·å–æ‰€æœ‰å¿…è¦æ•°æ®ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
      const [userInfo, campaignInfo, prizePool] = await Promise.all([
        this.getUserInfo(userId),
        this.getCampaignInfo(activityId),
        this.getPrizePool(activityId)
      ])

      // ğŸ¯ æ„å»ºæ‰¹æ¬¡æ‰§è¡Œä¸Šä¸‹æ–‡
      const batchContext = {
        batchId: this.generateBatchId(),
        batchTime: moment().tz('Asia/Shanghai').toDate(),
        batchType: this.getBatchType(batchCount),
        userId,
        activityId,
        batchCount,

        // ğŸ¯ æ‰¹æ¬¡çº§ä¿åº•æœºåˆ¶çŠ¶æ€
        userConsecutiveLosses: userInfo.consecutive_losses || 0,
        batchGuaranteePool: this.calculateBatchGuarantee(batchCount),

        // æ€§èƒ½ç›‘æ§
        startTime: batchStartTime,
        metrics: {
          strategyUsage: {},
          probabilityAdjustments: []
        }
      }

      const results = []
      let currentContext = { ...batchContext }

      // ğŸ¯ æ ¸å¿ƒï¼šæ‰¹é‡è®¡ç®—å¾ªç¯
      for (let i = 0; i < batchCount; i++) {
        // æ›´æ–°å½“å‰æŠ½å¥–ä¸Šä¸‹æ–‡
        currentContext.drawSequence = i + 1
        currentContext.remainingDraws = batchCount - i
        currentContext.currentBatchLosses = this.countBatchLosses(results)

        // ğŸ¯ æ™ºèƒ½ç­–ç•¥é€‰æ‹©ï¼šæ ¹æ®æ‰¹æ¬¡å†…æƒ…å†µåŠ¨æ€è°ƒæ•´
        const selectedStrategy = this.selectBatchStrategy(currentContext, results)
        currentContext.selectedStrategy = selectedStrategy

        // ğŸ¯ åŠ¨æ€æ¦‚ç‡è°ƒæ•´ï¼šæ‰¹æ¬¡å†…ä¿åº•æœºåˆ¶
        const adjustedProbability = this.calculateBatchProbability(currentContext, results)

        // æ‰§è¡Œå•æ¬¡æŠ½å¥–è®¡ç®—
        const drawResult = await this.executeBatchDrawOnce(
          currentContext,
          prizePool,
          adjustedProbability
        )

        // ğŸ¯ æ‰¹æ¬¡å†…çŠ¶æ€æ›´æ–°
        if (drawResult.isWinner) {
          currentContext.userConsecutiveLosses = 0
          this.recordBatchWin(currentContext, drawResult)
        } else {
          currentContext.userConsecutiveLosses++
        }

        results.push({
          ...drawResult,
          sequence: i + 1,
          batchContext: {
            strategy: selectedStrategy,
            probability: adjustedProbability,
            consecutiveLosses: currentContext.userConsecutiveLosses
          }
        })

        // ğŸ¯ æ‰¹æ¬¡å†…æ™ºèƒ½è°ƒæ•´ï¼šä¸ºä¸‹æ¬¡æŠ½å¥–åšå‡†å¤‡
        await this.prepareBatchNextDraw(currentContext, drawResult)
      }

      // ğŸ¯ æ‰¹æ¬¡åå¤„ç†ï¼šåº”ç”¨æ‰¹æ¬¡çº§ä¿åº•
      const finalResults = await this.applyBatchGuarantee(results, batchContext)

      // ğŸ¯ æ‰¹é‡å†™å…¥æ•°æ®åº“ï¼ˆäº‹åŠ¡ä¿è¯ï¼‰
      const savedRecords = await this.saveBatchResults(finalResults, batchContext)

      // ğŸ¯ æ›´æ–°ç”¨æˆ·çŠ¶æ€
      await this.updateUserBatchStats(userId, batchContext, finalResults)

      return this.formatBatchResponse(batchContext, finalResults, savedRecords)
    } catch (error) {
      console.error('æ‰¹é‡æŠ½å¥–å¼•æ“æ‰§è¡Œå¤±è´¥:', error)
      throw new Error(`BatchLotteryEngineæ‰§è¡Œå¤±è´¥: ${error.message}`)
    }
  }

  /**
   * ğŸ¯ æ‰¹æ¬¡å†…æ™ºèƒ½ç­–ç•¥é€‰æ‹©
   */
  selectBatchStrategy(context, currentResults) {
    const { drawSequence, remainingDraws, batchCount } = context

    // ç®¡ç†ç­–ç•¥ä¼˜å…ˆ
    if (context.hasManagementPreset) {
      return 'management'
    }

    // æ‰¹æ¬¡ä¿åº•ç­–ç•¥ï¼šæœ€åä¸€æ¬¡å¿…é¡»ä¿åº•
    if (remainingDraws === 1 && this.countBatchWins(currentResults) === 0) {
      console.log(`ğŸ¯ æ‰¹æ¬¡ä¿åº•è§¦å‘ï¼šç¬¬${drawSequence}æ¬¡ï¼ˆæœ€åä¸€æ¬¡ï¼‰å¼ºåˆ¶ä¿åº•`)
      return 'guarantee'
    }

    // æ‰¹æ¬¡ä¸­æœŸä¿åº•ï¼šè¶…è¿‡ä¸€åŠè¿˜æ²¡ä¸­å¥–
    if (drawSequence > batchCount / 2 && this.countBatchWins(currentResults) === 0) {
      const guaranteeProbability = Math.min(0.3, 0.1 * drawSequence)
      if (Math.random() < guaranteeProbability) {
        console.log(`ğŸ¯ æ‰¹æ¬¡ä¸­æœŸä¿åº•è§¦å‘ï¼šç¬¬${drawSequence}æ¬¡ï¼Œæ¦‚ç‡${guaranteeProbability}`)
        return 'guarantee'
      }
    }

    return 'basic_lottery'
  }

  /**
   * ğŸ¯ æ‰¹æ¬¡å†…åŠ¨æ€æ¦‚ç‡è®¡ç®—
   */
  calculateBatchProbability(context, currentResults) {
    const { drawSequence, batchCount } = context
    const baseProbability = 0.15 // åŸºç¡€15%æ¦‚ç‡

    const batchLosses = this.countBatchLosses(currentResults)

    // æ‰¹æ¬¡å†…é€’å¢æ¦‚ç‡ï¼šè¶Šå¾€åæ¦‚ç‡è¶Šé«˜
    let adjustedProbability = baseProbability

    // è¿ç»­ä¸ä¸­å¥–æå‡æ¦‚ç‡
    if (batchLosses > 0) {
      adjustedProbability += batchLosses * 0.05 // æ¯æ¬¡å¤±è´¥å¢åŠ 5%
    }

    // æœ€åä¸€æ¬¡å¤§å¹…æå‡ï¼ˆä¿åº•æœºåˆ¶ï¼‰
    if (drawSequence === batchCount && batchLosses === batchCount - 1) {
      adjustedProbability = Math.max(0.8, adjustedProbability) // æœ€åä¸€æ¬¡è‡³å°‘80%
    }

    // é™åˆ¶æ¦‚ç‡èŒƒå›´
    adjustedProbability = Math.min(Math.max(adjustedProbability, 0.01), 0.95)

    console.log(
      `ğŸ¯ ç¬¬${drawSequence}æ¬¡æ¦‚ç‡è®¡ç®—ï¼šåŸºç¡€${baseProbability} â†’ è°ƒæ•´${adjustedProbability}`
    )

    return adjustedProbability
  }

  /**
   * ğŸ¯ æ‰¹é‡æ•°æ®åº“å†™å…¥ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰
   */
  async saveBatchResults(results, batchContext) {
    const transaction = await models.sequelize.transaction()

    try {
      const records = []

      // æ‰¹é‡æ„å»ºè®°å½•æ•°æ®
      for (let i = 0; i < results.length; i++) {
        const result = results[i]
        const recordData = {
          draw_id: `${batchContext.batchId}_${i + 1}`,
          user_id: batchContext.userId,
          campaign_id: batchContext.activityId,
          batch_id: batchContext.batchId,
          draw_sequence: i + 1,
          draw_count: batchContext.batchCount,
          draw_type: batchContext.batchType,
          created_at: batchContext.batchTime, // ğŸ¯ ç»Ÿä¸€æ—¶é—´
          prize_id: result.prize?.id || null,
          prize_name: result.prize?.name || 'è°¢è°¢å‚ä¸',
          is_winner: result.isWinner,
          strategy_used: result.batchContext.strategy,
          probability_used: result.batchContext.probability
        }
        records.push(recordData)
      }

      // ğŸ¯ æ‰¹é‡æ’å…¥ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
      await models.LotteryRecord.bulkCreate(records, { transaction })

      await transaction.commit()

      console.log(`ğŸ¯ æ‰¹é‡ä¿å­˜å®Œæˆï¼š${records.length}æ¡è®°å½•`)
      return records
    } catch (error) {
      await transaction.rollback()
      throw error
    }
  }

  // è¾…åŠ©æ–¹æ³•
  getBatchType(count) {
    return count === 3 ? 'triple' : count === 5 ? 'five' : count === 10 ? 'ten' : 'single'
  }

  countBatchWins(results) {
    return results.filter(r => r.isWinner).length
  }

  countBatchLosses(results) {
    return results.filter(r => !r.isWinner).length
  }
}
```

### APIæ¥å£å®ç°

```javascript
// routes/v4/unified-engine/lottery.js
const BatchLotteryEngine = require('../../../services/UnifiedLotteryEngine/BatchLotteryEngine')
const batchEngine = new BatchLotteryEngine()

router.post('/smart-batch-lottery', async (req, res) => {
  try {
    const { user_id, draw_count, campaign_id, strategy_type = 'basic_lottery' } = req.body

    console.log(`ğŸ¯ æ™ºèƒ½æ‰¹é‡æŠ½å¥–å¼€å§‹: ç”¨æˆ·${user_id}, ${draw_count}è¿æŠ½`)

    // ğŸ¯ è°ƒç”¨æ‰¹é‡æŠ½å¥–å¼•æ“
    const batchResult = await batchEngine.executeBatchLottery({
      userId: user_id,
      activityId: campaign_id,
      batchCount: draw_count,
      strategyType: strategy_type
    })

    res.apiSuccess(
      {
        batch_info: {
          batch_id: batchResult.batchId,
          batch_type: batchResult.batchType,
          batch_time: moment(batchResult.batchTime)
            .tz('Asia/Shanghai')
            .format('YYYY-MM-DD HH:mm:ss'),
          total_count: draw_count,
          success_count: batchResult.successCount,
          execution_time_ms: batchResult.executionTime
        },
        results: batchResult.results,
        strategy_info: {
          strategies_used: batchResult.strategiesUsed,
          probability_adjustments: batchResult.probabilityAdjustments,
          guarantee_triggered: batchResult.guaranteeTriggered
        }
      },
      `æ™ºèƒ½${batchResult.batchType}å®Œæˆ`
    )
  } catch (error) {
    console.error('æ™ºèƒ½æ‰¹é‡æŠ½å¥–å¤±è´¥:', error)
    res.apiError('æ™ºèƒ½æŠ½å¥–å¤±è´¥', 'SMART_LOTTERY_FAILED', { error: error.message })
  }
})
```

### ä¼˜ç¼ºç‚¹åˆ†æ

**ä¼˜ç‚¹**:

- âœ… æœ€æ™ºèƒ½çš„ä¿åº•æœºåˆ¶ï¼ˆæ‰¹æ¬¡å†…åŠ¨æ€è°ƒæ•´ï¼‰
- âœ… æ€§èƒ½æœ€ä¼˜ï¼ˆæ‰¹é‡è®¡ç®—ï¼Œå‡å°‘æ•°æ®åº“æ“ä½œï¼‰
- âœ… ç”¨æˆ·ä½“éªŒæœ€ä½³ï¼ˆæ™ºèƒ½æ¦‚ç‡è°ƒæ•´ï¼‰
- âœ… ç­–ç•¥æœ€çµæ´»ï¼ˆå¯å®ç°å¤æ‚çš„æ‰¹æ¬¡è§„åˆ™ï¼‰

**ç¼ºç‚¹**:

- âŒ å¼€å‘å¤æ‚åº¦æœ€é«˜ï¼ˆéœ€è¦é‡æ„å¼•æ“ï¼‰
- âŒ æµ‹è¯•éš¾åº¦å¤§ï¼ˆé€»è¾‘å¤æ‚ï¼Œè¾¹ç•Œæƒ…å†µå¤šï¼‰
- âŒ ç»´æŠ¤æˆæœ¬é«˜ï¼ˆéœ€è¦æ·±åº¦ç†è§£æ‰¹é‡é€»è¾‘ï¼‰
- âŒ è¿ç§»é£é™©å¤§ï¼ˆå¤§å¹…æ”¹åŠ¨ç°æœ‰æ¶æ„ï¼‰

## ğŸ“Š ä¸‰æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“

| å¯¹æ¯”ç»´åº¦       | æ–¹æ¡ˆA (batch_id) | æ–¹æ¡ˆB (JSONå­˜å‚¨) | æ–¹æ¡ˆC (ä¸€é”…ç«¯)   |
| -------------- | ---------------- | ---------------- | ---------------- |
| **å¼€å‘å¤æ‚åº¦** | â­â­ ç®€å•        | â­â­â­ ä¸­ç­‰      | â­â­â­â­â­ å¤æ‚  |
| **æ•°æ®åº“æ”¹åŠ¨** | æ— éœ€æ”¹åŠ¨         | éœ€è¦æ–°å»ºè¡¨       | æ— éœ€æ”¹åŠ¨         |
| **æŸ¥è¯¢å¤æ‚åº¦** | éœ€è¦å…³è”æŸ¥è¯¢     | å•è¡¨ç›´æ¥æŸ¥è¯¢     | æ ‡å‡†æŸ¥è¯¢         |
| **å­˜å‚¨æ•ˆç‡**   | ä¸€èˆ¬ï¼ˆæ¯æ¬¡ä¸€æ¡ï¼‰ | æœ€ä¼˜ï¼ˆæ‰¹æ¬¡ä¸€æ¡ï¼‰ | ä¸€èˆ¬ï¼ˆæ¯æ¬¡ä¸€æ¡ï¼‰ |
| **åŠŸèƒ½æ‰©å±•æ€§** | å¼ºï¼ˆSQLçµæ´»ï¼‰    | å¼±ï¼ˆJSONé™åˆ¶ï¼‰   | æœ€å¼ºï¼ˆé€»è¾‘çµæ´»ï¼‰ |
| **å‰ç«¯å¯¹æ¥**   | éœ€ä¸¤æ­¥æŸ¥è¯¢       | ä¸€æ­¥è·å¾—å…¨éƒ¨     | ä¸€æ­¥è·å¾—å…¨éƒ¨     |
| **ä¿åº•æœºåˆ¶**   | æ ‡å‡†ä¿åº•         | æ ‡å‡†ä¿åº•         | æ™ºèƒ½ä¿åº•         |
| **æ€§èƒ½è¡¨ç°**   | ä¸­ç­‰             | è‰¯å¥½             | æœ€ä¼˜             |
| **ç»´æŠ¤éš¾åº¦**   | å®¹æ˜“             | ä¸­ç­‰             | å›°éš¾             |
| **å®æ–½é£é™©**   | ä½               | ä¸­ç­‰             | é«˜               |

## ğŸ¯ æ¨èæ–¹æ¡ˆå’Œå®æ–½è®¡åˆ’

### é˜¶æ®µåŒ–å®æ–½å»ºè®®

#### ç¬¬ä¸€é˜¶æ®µï¼ˆç«‹å³å®æ–½ï¼‰ï¼šæ–¹æ¡ˆA - batch_idå…³è”æ³•

**ç†ç”±**ï¼š

- ğŸš€ å¯ä»¥ç«‹å³è§£å†³å‰ç«¯æ—¶é—´æ˜¾ç¤ºé—®é¢˜
- ğŸ’¡ åˆ©ç”¨ç°æœ‰å­—æ®µï¼Œæ”¹åŠ¨æœ€å°ï¼Œé£é™©æœ€ä½
- ğŸ“ˆ ç¬¦åˆå…³ç³»å‹æ•°æ®åº“è®¾è®¡æœ€ä½³å®è·µ
- ğŸ”§ ä¾¿äºåç»­æ‰©å±•å’Œç»´æŠ¤

**å®æ–½æ­¥éª¤**ï¼š

```javascript
// 1. ä¿®æ”¹æ‰¹é‡æŠ½å¥–æ¥å£ï¼ˆ1-2å¤©ï¼‰
//    - ç”Ÿæˆbatch_idå’Œç»Ÿä¸€æ—¶é—´æˆ³
//    - æ­£ç¡®è®¾ç½®draw_typeå­—æ®µ
//    - æ·»åŠ draw_sequenceå’Œdraw_count

// 2. æ–°å¢æŸ¥è¯¢æ¥å£ï¼ˆ1å¤©ï¼‰
//    - æ‰¹æ¬¡åˆ—è¡¨æŸ¥è¯¢
//    - æ‰¹æ¬¡è¯¦æƒ…æŸ¥è¯¢

// 3. å‰ç«¯é€‚é…ï¼ˆ1å¤©ï¼‰
//    - ä¿®æ”¹å†å²è®°å½•æ˜¾ç¤ºé€»è¾‘
//    - é€‚é…æ–°çš„APIæ¥å£

// 4. æµ‹è¯•éªŒè¯ï¼ˆ1å¤©ï¼‰
//    - åŠŸèƒ½æµ‹è¯•
//    - æ•°æ®ä¸€è‡´æ€§æµ‹è¯•
```

#### ç¬¬äºŒé˜¶æ®µï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰ï¼šæ–¹æ¡ˆB - JSONå­˜å‚¨

**æ¡ä»¶**ï¼šå¦‚æœç¬¬ä¸€é˜¶æ®µè¿è¡Œç¨³å®šï¼Œä¸”æœ‰æ›´é«˜æ€§èƒ½éœ€æ±‚

#### ç¬¬ä¸‰é˜¶æ®µï¼ˆé•¿æœŸè§„åˆ’ï¼‰ï¼šæ–¹æ¡ˆC - æ™ºèƒ½æ‰¹é‡

**æ¡ä»¶**ï¼šç”¨æˆ·é‡è¾¾åˆ°ä¸€å®šè§„æ¨¡ï¼Œéœ€è¦æ›´å¤æ‚çš„æŠ½å¥–è§„åˆ™

### æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–å»ºè®®

```sql
-- ä¸ºbatch_idç›¸å…³æŸ¥è¯¢æ·»åŠ ç´¢å¼•
CREATE INDEX idx_lottery_batch_id ON lottery_records (batch_id);
CREATE INDEX idx_lottery_user_batch ON lottery_records (user_id, batch_id);
CREATE INDEX idx_lottery_user_time ON lottery_records (user_id, created_at DESC);
CREATE INDEX idx_lottery_batch_type ON lottery_records (draw_type, created_at DESC);
```

### å‰ç«¯APIæ ‡å‡†åŒ–

```javascript
// ç»Ÿä¸€çš„å‰ç«¯APIè°ƒç”¨æ–¹å¼
const LotteryAPI = {
  // æ‰§è¡Œå¤šè¿æŠ½
  async executeBatchLottery(userId, drawCount, campaignId) {
    const response = await fetch('/api/v4/unified-engine/lottery/batch-lottery', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: userId,
        draw_count: drawCount,
        campaign_id: campaignId
      })
    })
    return response.json()
  },

  // æŸ¥è¯¢æŠ½å¥–å†å²
  async getLotteryHistory(userId) {
    const response = await fetch(`/api/v4/unified-engine/lottery/user/${userId}/lottery-history`)
    return response.json()
  },

  // æŸ¥è¯¢æ‰¹æ¬¡è¯¦æƒ…
  async getBatchDetails(batchId) {
    const response = await fetch(`/api/v4/unified-engine/lottery/batch/${batchId}/details`)
    return response.json()
  }
}
```

## ğŸ“ æ€»ç»“

æœ¬æ–‡æ¡£æä¾›äº†ä¸‰ç§æŠ€æœ¯æ–¹æ¡ˆè§£å†³"å‰ç«¯å¤šè¿æŠ½æ—¶é—´æ˜¾ç¤º"é—®é¢˜ï¼š

1. **æ–¹æ¡ˆAï¼ˆbatch_idå…³è”æ³•ï¼‰**ï¼šåˆ©ç”¨ç°æœ‰è¡¨ç»“æ„ï¼Œé€šè¿‡æ‰¹æ¬¡IDå…³è”è®°å½•ï¼Œæœ€å®ç”¨
2. **æ–¹æ¡ˆBï¼ˆJSONæ‰“åŒ…å­˜å‚¨ï¼‰**ï¼šæ–°å»ºè¡¨å­˜å‚¨JSONæ•°æ®ï¼ŒæŸ¥è¯¢æœ€ç®€å•
3. **æ–¹æ¡ˆCï¼ˆæ™ºèƒ½æ‰¹é‡è®¡ç®—ï¼‰**ï¼šé‡æ„æŠ½å¥–å¼•æ“ï¼ŒåŠŸèƒ½æœ€å¼ºå¤§

**æ ¸å¿ƒè§£å†³çš„é—®é¢˜**ï¼š

- âœ… å‰ç«¯èƒ½å‡†ç¡®æ˜¾ç¤º"3è¿æŠ½äº12:00:00æ‰§è¡Œ"
- âœ… åŒºåˆ†"1æ¬¡3è¿æŠ½" vs "3æ¬¡å•æŠ½"
- âœ… æä¾›å®Œæ•´çš„æ‰¹æ¬¡æŠ½å¥–è®°å½•æŸ¥è¯¢
- âœ… æ”¯æŒçµæ´»çš„å†å²è®°å½•ç»Ÿè®¡åˆ†æ

**å»ºè®®é‡‡ç”¨æ–¹æ¡ˆA**ï¼Œå› ä¸ºå®ƒåœ¨åŠŸèƒ½å®Œæ•´æ€§ã€å®æ–½é£é™©ã€ç»´æŠ¤æˆæœ¬ä¹‹é—´è¾¾åˆ°äº†æœ€ä½³å¹³è¡¡ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-09-13  
**æŠ€æœ¯è´Ÿè´£äºº**: åç«¯å¼€å‘å›¢é˜Ÿ
