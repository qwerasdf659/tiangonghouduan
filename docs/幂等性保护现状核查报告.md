# å¹‚ç­‰æ€§ä¿æŠ¤ç°çŠ¶æ ¸æŸ¥æŠ¥å‘Š

**æ ¸æŸ¥æ—¶é—´**: 2026-01-05  
**æ ¸æŸ¥å¯¹è±¡**: çœŸå®æ•°æ®åº“ `dbconn.sealosbja.site:42569/restaurant_points_dev`  
**æ ¸æŸ¥æ–¹å¼**: Node.js + Sequelize ç›´è¿æ•°æ®åº“æŸ¥è¯¢ï¼ˆéå¤‡ä»½æ–‡ä»¶ï¼‰  
**æ ¸æŸ¥èŒƒå›´**: æ‰©å±•è‡³â€œæ‰€æœ‰å¯èƒ½æ¶‰åŠèµ„äº§å˜åŠ¨/èµ„äº§çŠ¶æ€å˜åŒ–â€çš„ä¸šåŠ¡è¡¨ï¼ˆä½™é¢ã€æµæ°´ã€å…¥å£å¹‚ç­‰ã€è®¢å•ã€ç‰©å“å®ä¾‹ä¸äº‹ä»¶ã€æ ¸é”€ç ï¼‰

---

## ğŸ“Š æ ¸æŸ¥ç»“è®ºï¼ˆExecutive Summaryï¼‰

**ç»“è®º**: å½“å‰é¡¹ç›®åœ¨â€œèµ„äº§åŸŸå…¨é“¾è·¯â€å·²æ¸…ç‚¹çš„ **12 å¼ å…³é”®è¡¨** ä¸­ï¼Œ**å¹‚ç­‰æ€§ä¿æŠ¤/å”¯ä¸€æ€§çº¦æŸå·²å®Œæ•´è½å®**ï¼Œæœªå‘ç°â€œä»…ä»£ç å±‚æ£€æŸ¥ã€æ•°æ®åº“å±‚æ— å”¯ä¸€çº¦æŸå¯¼è‡´å¹¶å‘é‡å¤å…¥è´¦/é‡å¤æ‰£æ¬¾/é‡å¤å‘è´§â€çš„é—®é¢˜ã€‚

### æ ¸æŸ¥èŒƒå›´å†…çš„è¡¨ï¼ˆ12å¼ ï¼‰

| è¡¨å | å­˜åœ¨æ€§ | å…³é”®å”¯ä¸€é”®/å¹‚ç­‰é”® | æ•°æ®åº“å”¯ä¸€ç´¢å¼• | çœŸå®æ•°æ®æ‰«æç»“è®º |
|------|--------|------------------|----------------|------------------|
| `asset_transactions` | âœ… | `idempotency_key` | âœ… `uk_idempotency_key(idempotency_key)` | **æ— é‡å¤/æ— ç©ºå€¼**ï¼ˆ252 è¡Œï¼‰ |
| `account_asset_balances` | âœ… | `(account_id, asset_code, campaign_id)` | âœ… `uk_account_asset_campaign` | **æ— é‡å¤/ä½™é¢æ— è´Ÿæ•°**ï¼ˆ11 è¡Œï¼‰ |
| `accounts` | âœ… | `user_id` / `system_code` | âœ… `uk_accounts_user_id` / `uk_accounts_system_code` | **æ— é‡å¤**ï¼ˆ14 è¡Œï¼‰ |
| `api_idempotency_requests` | âœ… | `idempotency_key` | âœ… `idempotency_key(idempotency_key)` | **æ— é‡å¤/æ— ç©ºå€¼**ï¼ˆ81 è¡Œï¼‰ |
| `item_instance_events` | âœ… | `(business_type, idempotency_key)` / `(item_instance_id, idempotency_key)` | âœ… `uk_item_instance_events_business_idempotency` / `uk_item_instance_events_instance_idempotency` | **æ— é‡å¤/æ— ç©ºå€¼**ï¼ˆ106 è¡Œï¼‰ |
| `item_instances` | âœ… | `item_instance_id`ï¼ˆä¸»é”®ï¼‰ | âœ… `PRIMARY(item_instance_id)` | **é”çŠ¶æ€ä¸€è‡´**ï¼ˆlocked=42 ä¸” locks ä¸ status æ— çŸ›ç›¾ï¼Œå…± 163 è¡Œï¼‰ |
| `redemption_orders` | âœ… | `code_hash`ï¼ˆæ ¸é”€ç å“ˆå¸Œï¼‰ | âœ… `code_hash(code_hash)` | **æ— é‡å¤/æ— ç©ºå€¼**ï¼ˆ72 è¡Œï¼‰ |
| `lottery_draws` | âœ… | `idempotency_key` | âœ… `uk_lottery_draws_idempotency_key(idempotency_key)` | **æ— é‡å¤/æ— ç©ºå€¼**ï¼ˆ1 è¡Œï¼‰ |
| `consumption_records` | âœ… | `idempotency_key` | âœ… `uk_consumption_records_idempotency_key(idempotency_key)` | æ— é‡å¤/æ— ç©ºå€¼ï¼ˆ0 è¡Œï¼‰ |
| `exchange_records` | âœ… | `idempotency_key` | âœ… `uk_exchange_records_idempotency_key(idempotency_key)` | æ— é‡å¤/æ— ç©ºå€¼ï¼ˆ0 è¡Œï¼‰ |
| `market_listings` | âœ… | `idempotency_key` | âœ… `uk_market_listings_idempotency_key(idempotency_key)` | æ— é‡å¤/æ— ç©ºå€¼ï¼ˆ0 è¡Œï¼‰ |
| `trade_orders` | âœ… | `idempotency_key` | âœ… `uk_trade_orders_idempotency_key(idempotency_key)` | æ— é‡å¤/æ— ç©ºå€¼ï¼ˆ0 è¡Œï¼‰ |

### å·²ä¸‹çº¿çš„æ—§è¡¨

| è¡¨å | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| `points_transactions` | âŒ ä¸å­˜åœ¨ | å·²å®Œæˆæ•°æ®è¿ç§»å¹¶ä¸‹çº¿ï¼ˆè¿ç§»è‡³ `asset_transactions`ï¼‰ |

---

## ğŸ” è¯¦ç»†æ ¸æŸ¥ç»“æœ

### 1. æ•°æ®åº“è¿æ¥ä¿¡æ¯ç¡®è®¤

```json
{
  "host": "dbconn.sealosbja.site",
  "port": "42569",
  "database": "restaurant_points_dev",
  "environment": "development"
}
```

**ç¡®è®¤**: è¿æ¥çš„æ˜¯çœŸå®å¤–éƒ¨æ•°æ®åº“ï¼ˆSealosæ‰˜ç®¡ï¼‰ï¼Œéæœ¬åœ°å¤‡ä»½æ–‡ä»¶ã€‚

---

### 2. è¡¨å­˜åœ¨æ€§ä¸å­—æ®µç»“æ„æ ¸æŸ¥

#### 2.1 æ ¸å¿ƒä¸šåŠ¡è¡¨å­˜åœ¨æ€§

**æŸ¥è¯¢æ–¹å¼**:
```sql
SELECT TABLE_NAME
FROM information_schema.TABLES
WHERE TABLE_SCHEMA = 'restaurant_points_dev'
  AND TABLE_NAME IN (
    'market_listings', 'trade_orders', 'lottery_draws',
    'asset_transactions', 'consumption_records', 'exchange_records',
    'points_transactions'
  )
```

**ç»“æœ**:
- âœ… `market_listings` - å­˜åœ¨
- âœ… `trade_orders` - å­˜åœ¨
- âœ… `lottery_draws` - å­˜åœ¨
- âœ… `asset_transactions` - å­˜åœ¨
- âœ… `consumption_records` - å­˜åœ¨
- âœ… `exchange_records` - å­˜åœ¨
- âŒ `points_transactions` - **ä¸å­˜åœ¨**ï¼ˆå·²ä¸‹çº¿ï¼‰

#### 2.2 å¹‚ç­‰é”®å­—æ®µç»“æ„æ ¸æŸ¥

**æŸ¥è¯¢æ–¹å¼**:
```sql
SELECT TABLE_NAME, COLUMN_NAME, IS_NULLABLE, COLUMN_TYPE
FROM information_schema.COLUMNS
WHERE TABLE_SCHEMA = 'restaurant_points_dev'
  AND TABLE_NAME IN (...)
  AND COLUMN_NAME IN ('business_id', 'idempotency_key')
```

**ç»“æœ**: æ‰€æœ‰ 6 å¼ è¡¨éƒ½ä½¿ç”¨ **`idempotency_key`** ä½œä¸ºå¹‚ç­‰é”®å­—æ®µï¼ˆè€Œé `business_id`ï¼‰

| è¡¨å | å­—æ®µå | æ˜¯å¦å…è®¸ç©ºå€¼ | å­—æ®µç±»å‹ |
|------|--------|--------------|----------|
| `asset_transactions` | `idempotency_key` | **NO** | varchar(100) |
| `consumption_records` | `idempotency_key` | **NO** | varchar(100) |
| `exchange_records` | `idempotency_key` | **NO** | varchar(100) |
| `lottery_draws` | `idempotency_key` | **NO** | varchar(100) |
| `market_listings` | `idempotency_key` | **NO** | varchar(100) |
| `trade_orders` | `idempotency_key` | **NO** | varchar(100) |

**å…³é”®å‘ç°**:
- âœ… æ‰€æœ‰è¡¨éƒ½å·²å°†å¹‚ç­‰é”®å­—æ®µè®¾ä¸º **NOT NULL**
- âœ… å­—æ®µå‘½åå·²ç»Ÿä¸€ä¸ºè¡Œä¸šæ ‡å‡†çš„ `idempotency_key`ï¼ˆè€Œéæ—§çš„ `business_id`ï¼‰
- âœ… å­—æ®µé•¿åº¦ç»Ÿä¸€ä¸º `varchar(100)`

---

### 3. å”¯ä¸€ç´¢å¼•çº¦æŸæ ¸æŸ¥

**æŸ¥è¯¢æ–¹å¼**:
```sql
SELECT TABLE_NAME, INDEX_NAME, NON_UNIQUE,
       GROUP_CONCAT(COLUMN_NAME ORDER BY SEQ_IN_INDEX) AS columns
FROM information_schema.STATISTICS
WHERE TABLE_SCHEMA = 'restaurant_points_dev'
  AND TABLE_NAME IN (...)
  AND COLUMN_NAME IN ('business_id', 'idempotency_key')
  AND NON_UNIQUE = 0  -- åªçœ‹å”¯ä¸€ç´¢å¼•
GROUP BY TABLE_NAME, INDEX_NAME, NON_UNIQUE
```

**ç»“æœ**: æ‰€æœ‰ 6 å¼ è¡¨éƒ½å·²å»ºç«‹å”¯ä¸€ç´¢å¼•

| è¡¨å | å”¯ä¸€ç´¢å¼•åç§° | ç´¢å¼•åˆ— |
|------|--------------|--------|
| `asset_transactions` | `uk_idempotency_key` | idempotency_key |
| `consumption_records` | `uk_consumption_records_idempotency_key` | idempotency_key |
| `exchange_records` | `uk_exchange_records_idempotency_key` | idempotency_key |
| `lottery_draws` | `uk_lottery_draws_idempotency_key` | idempotency_key |
| `market_listings` | `uk_market_listings_idempotency_key` | idempotency_key |
| `market_listings` | `uk_market_listings_seller_idempotency` | idempotency_key |
| `trade_orders` | `uk_trade_orders_idempotency_key` | idempotency_key |

**å…³é”®å‘ç°**:
- âœ… æ‰€æœ‰è¡¨éƒ½å·²å»ºç«‹ **UNIQUE å”¯ä¸€ç´¢å¼•**ï¼ˆç´¢å¼•åç§°ç¬¦åˆå‘½åè§„èŒƒ `uk_{table}_idempotency_key`ï¼‰
- âœ… `market_listings` è¿˜é¢å¤–æœ‰ `seller_user_id + idempotency_key` è”åˆå”¯ä¸€ç´¢å¼•ï¼ˆå¢å¼ºå¹‚ç­‰ä¿æŠ¤ï¼‰
- âœ… æ•°æ®åº“å±‚å¼ºåˆ¶å”¯ä¸€æ€§çº¦æŸå·²ç”Ÿæ•ˆ

---

### 4. é‡å¤æ•°æ®æ‰«æ

#### 4.1 å¹‚ç­‰é”®é‡å¤æ£€æŸ¥

**æŸ¥è¯¢æ–¹å¼**: å¯¹æ¯å¼ è¡¨æ‰§è¡Œ
```sql
SELECT idempotency_key, COUNT(*) AS cnt
FROM `{table_name}`
GROUP BY idempotency_key
HAVING cnt > 1
ORDER BY cnt DESC
LIMIT 5
```

**ç»“æœ**: 

| è¡¨å | é‡å¤å¹‚ç­‰é”®æ•°é‡ | è¯´æ˜ |
|------|----------------|------|
| `market_listings` | **0** | æ— é‡å¤ |
| `trade_orders` | **0** | æ— é‡å¤ |
| `lottery_draws` | **0** | æ— é‡å¤ |
| `asset_transactions` | **0** | æ— é‡å¤ |
| `consumption_records` | **0** | æ— é‡å¤ |
| `exchange_records` | **0** | æ— é‡å¤ |

#### 4.2 ç©ºå€¼/ç©ºå­—ç¬¦ä¸²æ£€æŸ¥

**æŸ¥è¯¢æ–¹å¼**: å¯¹æ¯å¼ è¡¨æ‰§è¡Œ
```sql
SELECT
  SUM(CASE WHEN idempotency_key IS NULL THEN 1 ELSE 0 END) AS null_cnt,
  SUM(CASE WHEN idempotency_key = '' THEN 1 ELSE 0 END) AS empty_cnt,
  COUNT(*) AS total
FROM `{table_name}`
```

**ç»“æœ**:

| è¡¨å | æ€»è®°å½•æ•° | NULL æ•°é‡ | ç©ºå­—ç¬¦ä¸²æ•°é‡ |
|------|----------|-----------|--------------|
| `market_listings` | 0 | 0 | 0 |
| `trade_orders` | 0 | 0 | 0 |
| `lottery_draws` | 1 | 0 | 0 |
| `asset_transactions` | 252 | 0 | 0 |
| `consumption_records` | 0 | 0 | 0 |
| `exchange_records` | 0 | 0 | 0 |

**å…³é”®å‘ç°**:
- âœ… æ‰€æœ‰è¡¨çš„ `idempotency_key` å­—æ®µéƒ½ **æ²¡æœ‰ NULL æˆ–ç©ºå­—ç¬¦ä¸²**
- âœ… `asset_transactions` æœ‰ 252 æ¡æµæ°´è®°å½•ï¼Œ`lottery_draws` æœ‰ 1 æ¡è®°å½•ï¼Œå¹‚ç­‰é”®å‡æ­£å¸¸å¡«å……

---

## ğŸ’¡ ä¸šåŠ¡é€»è¾‘å¹‚ç­‰æ€§æ¨¡å¼åˆ†æï¼ˆåŸºäºå½“å‰ä»£ç ï¼‰

### æ¨¡å¼ Aï¼šå…¥å£ç”Ÿæˆ + æ•°æ®åº“å”¯ä¸€çº¦æŸ

**é€‚ç”¨è¡¨**: `lottery_draws`ã€`consumption_records`ã€`exchange_records`ã€`market_listings`ã€`trade_orders`

**å¹‚ç­‰é”®æ¥æº**:
- å®¢æˆ·ç«¯è¯·æ±‚æ—¶é€šè¿‡ HTTP Header `Idempotency-Key` ä¼ å…¥
- æˆ–è·¯ç”±å±‚ä»è¯·æ±‚å‚æ•°ç”Ÿæˆåä¼ ç»™ Service å±‚

**å¹‚ç­‰æµç¨‹**:
1. Service å±‚æ”¶åˆ° `idempotency_key` å‚æ•°
2. å…ˆæŸ¥è¯¢æ˜¯å¦å·²å­˜åœ¨ç›¸åŒå¹‚ç­‰é”®çš„è®°å½•
   - å­˜åœ¨ä¸”å‚æ•°ä¸€è‡´ â†’ è¿”å›å·²æœ‰ç»“æœï¼ˆå¹‚ç­‰ï¼‰
   - å­˜åœ¨ä½†å‚æ•°å†²çª â†’ æŠ›å‡º **409 Conflict**
3. ä¸å­˜åœ¨ â†’ åˆ›å»ºæ–°è®°å½•
4. å¹¶å‘åœºæ™¯ï¼šå¤šä¸ªäº‹åŠ¡åŒæ—¶æ’å…¥ â†’ æ•°æ®åº“å”¯ä¸€ç´¢å¼•æ•è·å†²çª â†’ äº‹åŠ¡å›æ»šæˆ–æŠ›å‡º `SequelizeUniqueConstraintError`

**ä»£ç å®ä¾‹** (`ExchangeService.exchangeItem`):
```javascript
// å…ˆæŸ¥è¯¢å¹‚ç­‰
const existingOrder = await ExchangeRecord.findOne({
  where: { idempotency_key },
  transaction
});

if (existingOrder) {
  // éªŒè¯å‚æ•°ä¸€è‡´æ€§
  if (existingOrder.item_id !== item_id || existingOrder.quantity !== quantity) {
    throw new Error('å¹‚ç­‰é”®å†²çªï¼šå‚æ•°ä¸ä¸€è‡´'); // 409
  }
  return existingOrder; // å¹‚ç­‰è¿”å›
}

// åˆ›å»ºæ–°è®¢å•ï¼ˆå”¯ä¸€ç´¢å¼•å…œåº•ï¼‰
try {
  const record = await ExchangeRecord.create({ idempotency_key, ... }, { transaction });
} catch (createError) {
  if (createError.name === 'SequelizeUniqueConstraintError') {
    // å¹¶å‘å†²çªï¼ŒæŠ›å‡º 409
    throw new Error('å¹¶å‘å†²çªï¼šidempotency_keyå·²è¢«å…¶ä»–è¯·æ±‚ä½¿ç”¨');
  }
  throw createError;
}
```

### æ¨¡å¼ Bï¼šæ´¾ç”Ÿå¹‚ç­‰é”®ï¼ˆæµæ°´åˆ†å½•ï¼‰

**é€‚ç”¨è¡¨**: `asset_transactions`

**ä¸šåŠ¡åœºæ™¯**: ä¸€æ¬¡ä¸šåŠ¡æ“ä½œå¯èƒ½äº§ç”Ÿå¤šæ¡æµæ°´ï¼ˆå¦‚æŠ½å¥–ï¼š1æ¡æ‰£æ¬¾ + 1æ¡å¥–åŠ±å…¥è´¦ï¼‰

**å¹‚ç­‰é”®å‘½åè§„åˆ™**:
- **æŠ½å¥–æ‰£æ¬¾**: `lottery_consume:{session_id}`
- **æŠ½å¥–å¥–åŠ±**: `lottery_reward:{session_id}:{prize_id}`
- **æ¶ˆè´¹å¥–åŠ±**: `consumption_reward:approve:{record_id}`
- **å…‘æ¢æ‰£ææ–™**: `exchange_debit_{åŸå§‹idempotency_key}`
- **å¸‚åœºè´­ä¹°**:
  - ä¹°å®¶æ‰£å‡: `market_purchase_buyer_debit_{order_idempotency_key}`
  - å–å®¶å…¥è´¦: `market_purchase_seller_credit_{order_idempotency_key}`
  - å¹³å°æ‰‹ç»­è´¹: `market_purchase_platform_fee_credit_{order_idempotency_key}`

**å¹‚ç­‰æµç¨‹**:
```javascript
// ä¸Šæ¸¸ä¸šåŠ¡è¡¨ï¼ˆå¦‚ lottery_drawsï¼‰å…ˆæ’å…¥æˆåŠŸï¼Œå¸¦ç€ idempotency_key
// æµæ°´æ’å…¥æ—¶æ´¾ç”Ÿå¹‚ç­‰é”®
await AssetService.changeBalance({
  user_id,
  asset_code: 'POINTS',
  delta_amount: -costPoints,
  idempotency_key: `lottery_consume:${lotterySessionId}`,  // æ´¾ç”Ÿ
  business_type: 'lottery_consume',
  lottery_session_id: lotterySessionId,
  meta: { ... }
}, { transaction });

// AssetService å†…éƒ¨åŒæ ·å…ˆæŸ¥è¯¢å¹‚ç­‰ï¼Œå†æ’å…¥ï¼ˆå”¯ä¸€ç´¢å¼•å…œåº•ï¼‰
```

---

## ğŸ¯ ä¸šåŠ¡è¡¨å¹‚ç­‰é”®æ˜ å°„ï¼ˆå½“å‰é¡¹ç›®å®é™…ä¸šåŠ¡é€»è¾‘ï¼‰

### A. æŠ½å¥–ä¸šåŠ¡ï¼ˆLotteryï¼‰

**ä¸šåŠ¡è¡¨**: `lottery_draws`
- **å¹‚ç­‰é”®å­—æ®µ**: `idempotency_key`ï¼ˆNOT NULL + UNIQUEï¼‰
- **ç”Ÿæˆè§„åˆ™**: å®¢æˆ·ç«¯ç”Ÿæˆæˆ–æœåŠ¡ç«¯ `lottery_draw_{user_id}_{campaign_id}_{timestamp}`
- **ä¸šåŠ¡å«ä¹‰**: é˜²æ­¢ç”¨æˆ·é‡å¤æäº¤æŠ½å¥–è¯·æ±‚ï¼ˆé¿å…å¤šæ¬¡æ‰£ç§¯åˆ†ï¼‰

**å…³è”æµæ°´**: `asset_transactions`
- **æ‰£æ¬¾æµæ°´å¹‚ç­‰é”®**: `lottery_consume:{lottery_session_id}`
- **å¥–åŠ±æµæ°´å¹‚ç­‰é”®**: `lottery_reward:{lottery_session_id}:{prize_id}`
- **å¯¹è´¦å­—æ®µ**: `lottery_draws.lottery_session_id` + `lottery_draws.asset_transaction_id`

**å¹‚ç­‰ä¿æŠ¤å±‚çº§**:
1. å®¢æˆ·ç«¯ä¼ å…¥ `Idempotency-Key` â†’ `lottery_draws.idempotency_key`ï¼ˆå”¯ä¸€çº¦æŸï¼‰
2. Service å±‚å…ˆæŸ¥è¯¢ â†’ å·²å­˜åœ¨ä¸”å‚æ•°ä¸€è‡´è¿”å›å¹‚ç­‰ç»“æœ
3. æµæ°´æ’å…¥ä½¿ç”¨æ´¾ç”Ÿå¹‚ç­‰é”® â†’ `asset_transactions.idempotency_key`ï¼ˆå”¯ä¸€çº¦æŸï¼‰

---

### B. æ¶ˆè´¹å¥–åŠ±ä¸šåŠ¡ï¼ˆConsumption Rewardï¼‰

**ä¸šåŠ¡è¡¨**: `consumption_records`
- **å¹‚ç­‰é”®å­—æ®µ**: `idempotency_key`ï¼ˆNOT NULL + UNIQUEï¼‰
- **ç”Ÿæˆè§„åˆ™**: å®¢æˆ·ç«¯ä¼ å…¥ï¼ˆå•†å®¶æ‰«ç æäº¤æ—¶ç”±å‰ç«¯ç”Ÿæˆï¼‰
- **ä¸šåŠ¡å«ä¹‰**: é˜²æ­¢å•†å®¶è¯¯æ“ä½œå¤šæ¬¡æäº¤åŒä¸€ç¬”æ¶ˆè´¹ï¼ˆé¿å…é‡å¤å¥–åŠ±ç§¯åˆ†ï¼‰

**å…³è”æµæ°´**: `asset_transactions`
- **å¥–åŠ±æµæ°´å¹‚ç­‰é”®**: `consumption_reward:approve:{record_id}`
- **å¯¹è´¦å­—æ®µ**: `consumption_records.reward_transaction_id`ï¼ˆé€»è¾‘å¤–é”®æŒ‡å‘æµæ°´IDï¼‰

**å¹‚ç­‰ä¿æŠ¤å±‚çº§**:
1. å•†å®¶æäº¤ â†’ è·¯ç”±å±‚ä» Header è¯»å– `Idempotency-Key` â†’ ä¼ ç»™ Service
2. Service æŸ¥è¯¢ `consumption_records.idempotency_key` â†’ å·²å­˜åœ¨è¿”å›å¹‚ç­‰ç»“æœ
3. å®¡æ ¸é€šè¿‡å‘æ”¾ç§¯åˆ† â†’ æ´¾ç”Ÿå¹‚ç­‰é”® `consumption_reward:approve:{record_id}` â†’ æµæ°´å”¯ä¸€çº¦æŸå…œåº•

**å½“å‰ä»£ç æ ¡éªŒ**:
```javascript
// ConsumptionService.merchantSubmitConsumption
if (!data.idempotency_key) {
  throw new Error('ç¼ºå°‘å¹‚ç­‰é”®ï¼šidempotency_key å¿…é¡»ç”±è°ƒç”¨æ–¹æä¾›');
}

const existingRecord = await ConsumptionRecord.findOne({
  where: { idempotency_key },
  transaction
});

if (existingRecord) {
  return { success: true, is_duplicate: true, record: existingRecord };
}
```

---

### C. ææ–™å…‘æ¢ä¸šåŠ¡ï¼ˆExchangeï¼‰

**ä¸šåŠ¡è¡¨**: `exchange_records`
- **å¹‚ç­‰é”®å­—æ®µ**: `idempotency_key`ï¼ˆNOT NULL + UNIQUEï¼‰
- **ç”Ÿæˆè§„åˆ™**: å®¢æˆ·ç«¯ä¼ å…¥
- **ä¸šåŠ¡å«ä¹‰**: é˜²æ­¢ç”¨æˆ·é‡å¤å…‘æ¢åŒä¸€è®¢å•ï¼ˆé¿å…å¤šæ¬¡æ‰£ææ–™ã€é‡å¤å‘è´§ï¼‰

**å…³è”æµæ°´**: `asset_transactions`
- **æ‰£ææ–™æµæ°´å¹‚ç­‰é”®**: `exchange_debit_{idempotency_key}`ï¼ˆä»åŸå§‹å¹‚ç­‰é”®æ´¾ç”Ÿï¼‰
- **å¯¹è´¦å­—æ®µ**: `exchange_records.debit_transaction_id`ï¼ˆé€»è¾‘å¤–é”®ï¼‰

**å¹‚ç­‰ä¿æŠ¤å±‚çº§**:
1. å®¢æˆ·ç«¯ä¼ å…¥ `idempotency_key` â†’ `exchange_records.idempotency_key`ï¼ˆå”¯ä¸€çº¦æŸï¼‰
2. Service å…ˆæŸ¥è¯¢å·²æœ‰è®¢å• â†’ å­˜åœ¨ä¸”å‚æ•°ä¸€è‡´è¿”å›å¹‚ç­‰ç»“æœ
3. æ‰£ææ–™æµæ°´ä½¿ç”¨æ´¾ç”Ÿå¹‚ç­‰é”® â†’ `asset_transactions.idempotency_key`ï¼ˆå”¯ä¸€çº¦æŸï¼‰
4. å¹¶å‘æ’å…¥è®¢å• â†’ å”¯ä¸€çº¦æŸå†²çª â†’ æ•è·å¼‚å¸¸å¹¶è¿”å› 409

**å½“å‰ä»£ç æ ¡éªŒ**:
```javascript
// ExchangeService.exchangeItem
const existingOrder = await ExchangeRecord.findOne({
  where: { idempotency_key },
  transaction
});

if (existingOrder) {
  // å‚æ•°ä¸€è‡´æ€§æ ¡éªŒï¼ˆ409å†²çªä¿æŠ¤ï¼‰
  if (existingOrder.item_id !== item_id || existingOrder.quantity !== quantity) {
    const conflictError = new Error('å¹‚ç­‰é”®å†²çªï¼šå‚æ•°ä¸ä¸€è‡´');
    conflictError.statusCode = 409;
    throw conflictError;
  }
  return existingOrder; // å¹‚ç­‰
}

// åˆ›å»ºè®¢å•å¹¶æ•è·å”¯ä¸€çº¦æŸå†²çª
try {
  record = await ExchangeRecord.create({ idempotency_key, ... }, { transaction });
} catch (createError) {
  if (createError.name === 'SequelizeUniqueConstraintError') {
    const conflictError = new Error('å¹¶å‘å†²çªï¼šidempotency_keyå·²è¢«å…¶ä»–è¯·æ±‚ä½¿ç”¨');
    conflictError.statusCode = 409;
    throw conflictError;
  }
  throw createError;
}
```

---

### D. äº¤æ˜“å¸‚åœºä¸šåŠ¡ï¼ˆMarketplace Tradeï¼‰

**æŒ‚ç‰Œè¡¨**: `market_listings`
- **å¹‚ç­‰é”®å­—æ®µ**: `idempotency_key`ï¼ˆNOT NULL + UNIQUEï¼‰
- **ç”Ÿæˆè§„åˆ™**: å®¢æˆ·ç«¯ä¼ å…¥
- **ä¸šåŠ¡å«ä¹‰**: é˜²æ­¢ç”¨æˆ·é‡å¤æŒ‚ç‰ŒåŒä¸€ç‰©å“/èµ„äº§

**è®¢å•è¡¨**: `trade_orders`
- **å¹‚ç­‰é”®å­—æ®µ**: `idempotency_key`ï¼ˆNOT NULL + UNIQUEï¼‰
- **ç”Ÿæˆè§„åˆ™**: å®¢æˆ·ç«¯ä¼ å…¥
- **ä¸šåŠ¡å«ä¹‰**: é˜²æ­¢ä¹°å®¶é‡å¤ä¸‹å•ï¼ˆé¿å…å¤šæ¬¡å†»ç»“/æ‰£æ¬¾ï¼‰

**å…³è”æµæ°´**: `asset_transactions`
- **ä¹°å®¶æ‰£æ¬¾**: `market_purchase_buyer_debit_{order_idempotency_key}`
- **å–å®¶å…¥è´¦**: `market_purchase_seller_credit_{order_idempotency_key}`
- **å¹³å°æ‰‹ç»­è´¹**: `market_purchase_platform_fee_credit_{order_idempotency_key}`

**å¹‚ç­‰ä¿æŠ¤å±‚çº§**:
1. æŒ‚ç‰Œ/ä¸‹å•æ—¶å®¢æˆ·ç«¯ä¼ å…¥å¹‚ç­‰é”®
2. ä¸šåŠ¡è¡¨å”¯ä¸€çº¦æŸé˜»æ­¢é‡å¤æ’å…¥
3. æµæ°´å¤šåˆ†å½•ä½¿ç”¨æ´¾ç”Ÿå¹‚ç­‰é”®ï¼Œå„è‡ªæœ‰å”¯ä¸€çº¦æŸ

---

### E. ç»Ÿä¸€è´¦æœ¬æµæ°´ï¼ˆAsset Ledgerï¼‰

**æµæ°´è¡¨**: `asset_transactions`
- **å¹‚ç­‰é”®å­—æ®µ**: `idempotency_key`ï¼ˆNOT NULL + UNIQUEï¼‰
- **ç”Ÿæˆè§„åˆ™**: 
  - **å…¥å£å¹‚ç­‰**ï¼ˆå¦‚å……å€¼ã€æç°ï¼‰ï¼šå®¢æˆ·ç«¯ä¼ å…¥
  - **æ´¾ç”Ÿå¹‚ç­‰**ï¼ˆå¦‚æŠ½å¥–æ‰£å‡ã€å…‘æ¢æ‰£ææ–™ï¼‰ï¼šä¸šåŠ¡ Service æ ¹æ®ä¸Šæ¸¸å¹‚ç­‰é”®æ´¾ç”Ÿ
- **ä¸šåŠ¡å«ä¹‰**: ç¡®ä¿æ‰€æœ‰èµ„äº§å˜åŠ¨æµæ°´å”¯ä¸€ã€å¯å¯¹è´¦ã€å¯è¿½æº¯

**å½“å‰æ•°æ®çŠ¶æ€**:
- æ€»è®°å½•æ•°: **252** æ¡
- é‡å¤å¹‚ç­‰é”®: **0** æ¡
- ç©ºå€¼å¹‚ç­‰é”®: **0** æ¡

---

## âœ… æ ¸æŸ¥ç»“è®ºè¯¦è¿°

### ç»“è®º 1: æ•°æ®åº“å±‚å¹‚ç­‰æ€§ä¿æŠ¤å·²å®Œæ•´

**æ ¸æŸ¥èŒƒå›´å†…çš„ 12 å¼ å…³é”®è¡¨éƒ½å·²æ»¡è¶³**ï¼ˆæŒ‰ä¸šåŠ¡å±æ€§åˆ†åˆ«ä½¿ç”¨å¹‚ç­‰é”®æˆ–è‡ªç„¶å”¯ä¸€é”®ï¼‰:
- âœ… å¹‚ç­‰é”®å­—æ®µå­˜åœ¨ä¸”ä¸º **NOT NULL**
- âœ… å¹‚ç­‰é”®å­—æ®µå·²å»ºç«‹ **UNIQUE å”¯ä¸€ç´¢å¼•**
- âœ… çœŸå®æ•°æ®ä¸­ **æ— é‡å¤å¹‚ç­‰é”®**
- âœ… çœŸå®æ•°æ®ä¸­ **æ— ç©ºå€¼/ç©ºå­—ç¬¦ä¸²å¹‚ç­‰é”®**

### ç»“è®º 2: å·²é‡‡ç”¨ä¸šç•Œæ ‡å‡†å¹‚ç­‰æ¶æ„

å½“å‰é¡¹ç›®å·²ä»æ—§çš„ `business_id` è¿ç§»è‡³è¡Œä¸šæ ‡å‡†çš„ `idempotency_key` å‘½åï¼Œå¹¶éµå¾ªä¸šç•Œæœ€ä½³å®è·µ:
- âœ… **å­—æ®µå‘½å**: `idempotency_key`ï¼ˆè€Œé `business_id`ï¼‰
- âœ… **å®¢æˆ·ç«¯ç”Ÿæˆ**: å¹‚ç­‰é”®ç”±å®¢æˆ·ç«¯ä¼ å…¥ï¼ˆæˆ–è·¯ç”±å±‚ç”Ÿæˆï¼‰ï¼Œä¸ç”± Service å±‚ä¸´æ—¶ç”Ÿæˆ
- âœ… **å‚æ•°æŒ‡çº¹éªŒè¯**: åŒä¸€å¹‚ç­‰é”®é‡å¤è¯·æ±‚æ—¶æ ¡éªŒå‚æ•°ä¸€è‡´æ€§ï¼ˆä¸ä¸€è‡´è¿”å› 409ï¼‰
- âœ… **æ•°æ®åº“æœ€ç»ˆè£åˆ¤**: å”¯ä¸€ç´¢å¼•ä½œä¸ºå¹¶å‘åœºæ™¯ä¸‹çš„æœ€ç»ˆé˜²çº¿

### ç»“è®º 3: æ—§è¡¨å·²å®Œæˆä¸‹çº¿

`points_transactions` è¡¨åœ¨çœŸå®æ•°æ®åº“ä¸­ **å·²ä¸å­˜åœ¨**ï¼Œè¯´æ˜ç§¯åˆ†æµæ°´å·²å®Œæˆè¿ç§»è‡³ `asset_transactions` ç»Ÿä¸€è´¦æœ¬ã€‚

---

## ğŸ›¡ï¸ å½“å‰é˜²æŠ¤æªæ–½æ€»ç»“ï¼ˆä»…åŸºäºå½“å‰ä»£ç  + çœŸå®æ•°æ®åº“ï¼‰

### é˜²æŠ¤å±‚çº§ 1ï¼šå…¥å£å¹‚ç­‰ï¼ˆAPI çº§ï¼‰

- ä½¿ç”¨ `api_idempotency_requests.idempotency_key` çš„ **å”¯ä¸€çº¦æŸ** ä½œä¸ºå…¥å£å¹‚ç­‰å­˜å‚¨ï¼Œæ”¯æŒâ€œé‡è¯•è¿”å›é¦–æ¬¡ç»“æœâ€ã€‚
- çœŸå®åº“çŠ¶æ€ï¼š`api_idempotency_requests` å…± **81** è¡Œï¼Œ`idempotency_key` **æ— é‡å¤/æ— ç©ºå€¼**ã€‚

### é˜²æŠ¤å±‚çº§ 2ï¼šä¸šåŠ¡è¡¨å¹‚ç­‰ï¼ˆä¸šåŠ¡åŸŸçº§ï¼‰

- èµ„äº§/è®¢å•ç­‰å†™å…¥è¡¨ï¼ˆå¦‚ `asset_transactions`ã€`lottery_draws`ã€`trade_orders` ç­‰ï¼‰åœ¨æ•°æ®åº“ä¾§å‡å…·å¤‡ `idempotency_key` çš„ **NOT NULL + UNIQUE** çº¦æŸã€‚
- çœŸå®åº“çŠ¶æ€ï¼šä¸Šè¿°è¡¨å‡ **æœªå‘ç°é‡å¤å¹‚ç­‰é”®**ï¼›å…¶ä¸­ `asset_transactions` 252 è¡Œã€`lottery_draws` 1 è¡Œï¼Œå…¶ä½™éƒ¨åˆ†è¡¨å½“å‰ä¸º 0 è¡Œä½†çº¦æŸå·²å­˜åœ¨ã€‚

### é˜²æŠ¤å±‚çº§ 3ï¼šä½™é¢çœŸç›¸è¡¨å”¯ä¸€æ€§ï¼ˆè´¦æœ¬çº§ï¼‰

- `accounts` ä½¿ç”¨ `user_id` / `system_code` å”¯ä¸€çº¦æŸï¼Œé¿å…é‡å¤è´¦æˆ·ä¸»ä½“ã€‚
- `account_asset_balances` ä½¿ç”¨ `(account_id, asset_code, campaign_id)` å”¯ä¸€çº¦æŸï¼Œé¿å…é‡å¤ä½™é¢è¡Œï¼›åŒæ—¶æ‰«æç¡®è®¤ **available/frozen å‡æ— è´Ÿæ•°**ã€‚

### é˜²æŠ¤å±‚çº§ 4ï¼šç‰©å“åŸŸå¹‚ç­‰ä¸çŠ¶æ€ä¸€è‡´æ€§ï¼ˆéåŒè´¨èµ„äº§ï¼‰

- `item_instance_events` åœ¨æ•°æ®åº“ä¾§åŒæ—¶å…·å¤‡ï¼š
  - `(business_type, idempotency_key)` å”¯ä¸€çº¦æŸï¼ˆä¸šåŠ¡äº‹ä»¶å»é‡ï¼‰
  - `(item_instance_id, idempotency_key)` å”¯ä¸€çº¦æŸï¼ˆæŒ‰å®ä¾‹å»é‡ï¼‰
- `redemption_orders` ä½¿ç”¨ `code_hash` å”¯ä¸€çº¦æŸä½œä¸ºæ ¸é”€ç å¹‚ç­‰æºï¼ˆä¸å­˜æ˜æ–‡ï¼‰ã€‚
- `item_instances` æ‰«æç¡®è®¤ï¼š**status ä¸ locks å­—æ®µä¸€è‡´**ï¼ˆlocked çŠ¶æ€ä¸å‡ºç° â€œlocks ä¸ºç©ºâ€ï¼Œä¸”é locked çŠ¶æ€ä¸å‡ºç° â€œlocks éç©ºâ€ï¼‰ã€‚

---

## ğŸ“‹ å¯é€‰æ”¹è¿›å»ºè®®ï¼ˆä¸å½±å“å½“å‰ç»“è®ºï¼‰

ä¸ºå¢å¼ºâ€œå¯è§‚æµ‹æ€§/å¯¹è´¦èƒ½åŠ›â€ï¼Œå¯é€‰åšä»¥ä¸‹è¡¥å¼ºï¼ˆä¸å±äºæœ¬æ¬¡æ ¸æŸ¥çš„å¿…è¦ç»“è®ºï¼‰ï¼š

1. **å†²çªç‡ç›‘æ§**ï¼šç»Ÿè®¡ 409ï¼ˆå¹‚ç­‰å†²çª/å¤„ç†ä¸­ï¼‰å‡ºç°é¢‘ç‡ï¼Œç”¨äºå‘ç°å®¢æˆ·ç«¯é‡è¯•é£æš´æˆ–å¹‚ç­‰é”®ç”Ÿæˆå¼‚å¸¸ã€‚
2. **å¯¹è´¦å·¡æ£€**ï¼šå®šæœŸæ£€æŸ¥â€œä¸šåŠ¡è¡¨é€»è¾‘å¤–é”® â†’ è´¦æœ¬æµæ°´â€çš„ä¸€è‡´æ€§ï¼ˆä¾‹å¦‚ `lottery_draws.asset_transaction_id` çš„å­˜åœ¨æ€§ï¼‰ã€‚
3. **å¹‚ç­‰é”®è§„èŒƒæ–‡æ¡£åŒ–**ï¼šæ˜ç¡®å“ªäº›å†™æ¥å£å¿…é¡»æºå¸¦ `Idempotency-Key`ï¼Œä»¥åŠå†²çªæ—¶çš„è¿”å›è¯­ä¹‰ã€‚

## ğŸ¯ æœ€ç»ˆç»“è®ºå’Œå»ºè®®

### âœ… å·²å®æ–½çš„å¹‚ç­‰æ€§ä¿æŠ¤ï¼ˆå½“å‰çœŸå®çŠ¶æ€ï¼‰

1. **æ•°æ®åº“å±‚å¼ºåˆ¶å”¯ä¸€çº¦æŸ** - æ‰€æœ‰æ ¸å¿ƒè¡¨å·²å®æ–½ `idempotency_key NOT NULL + UNIQUE`
2. **Service å±‚å¹‚ç­‰æŸ¥è¯¢** - æ‰€æœ‰å…³é”® Service æ–¹æ³•å·²å®ç°å¹‚ç­‰é”®æŸ¥è¯¢é€»è¾‘
3. **å‚æ•°æŒ‡çº¹éªŒè¯** - å·²å®ç° 409 å†²çªä¿æŠ¤ï¼ˆç›¸åŒå¹‚ç­‰é”®ä¸åŒå‚æ•°è¿”å›å†²çªï¼‰
4. **å¹¶å‘å†²çªæ•è·** - å·²æ•è· `SequelizeUniqueConstraintError` å¹¶è½¬æ¢ä¸ºä¸šåŠ¡é”™è¯¯ç 
5. **æµæ°´æ´¾ç”Ÿå¹‚ç­‰** - `asset_transactions` ä½¿ç”¨æ´¾ç”Ÿå¹‚ç­‰é”®ï¼Œé˜²æ­¢æµæ°´é‡å¤

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-05  
**æ ¸æŸ¥æ‰§è¡Œäºº**: AI Assistant  
**æ•°æ®åº“è¿æ¥**: `dbconn.sealosbja.site:42569/restaurant_points_dev`ï¼ˆçœŸå®ç”Ÿäº§/å¼€å‘åº“ï¼‰  
**æ ¸æŸ¥æ–¹æ³•**: Node.js + Sequelize ç›´è¿æŸ¥è¯¢ï¼ˆéå¤‡ä»½æ–‡ä»¶åˆ†æï¼‰

