# 后端对接需求 - 弹窗横幅频率控制系统

> **前端状态**: 前端代码已实现完毕，等待后端接口变更后即可联调  
> **文档日期**: 2026-02-18  
> **关联设计**: `docs/弹窗横幅频率控制系统设计文档.md`

---

## 一、需要后端做什么

### 1. 数据库迁移: `popup_banners` 表新增 5 个字段

使用 `sequelize-cli` 创建迁移文件，给现有 `popup_banners` 表新增以下字段：

| 字段名 | 类型 | 必填 | 默认值 | 索引 | 说明 |
|---|---|---|---|---|---|
| `banner_type` | VARCHAR(20) | 是 | `'promo'` | 联合索引 `idx_popup_banners_type_active(banner_type, is_active)` | 类型分级: `notice`(系统公告) / `event`(活动推广) / `promo`(日常促销) |
| `frequency_rule` | VARCHAR(30) | 是 | `'once_per_day'` | - | 频率规则枚举（见下方枚举值表） |
| `frequency_value` | INT | 否 | `1` | - | 频率参数（配合 `once_per_n_days` 和 `n_times_total`） |
| `force_show` | TINYINT(1) | 否 | `0` | - | 是否强制弹出（1=不可点遮罩关闭） |
| `priority` | INT | 否 | `0` | 索引 `idx_popup_banners_priority` | 弹出优先级（数字越大越优先弹出） |

> **注意**: 字段命名为 `banner_type` 而非 `type`，避免 Sequelize STI 保留字冲突。

#### `frequency_rule` 枚举值

| frequency_rule | frequency_value | 含义 |
|---|---|---|
| `always` | - | 每次进入页面都弹 |
| `once` | - | 整个活动周期只弹一次 |
| `once_per_session` | - | 每次小程序冷启动弹一次 |
| `once_per_day` | - | 每天最多弹一次 |
| `once_per_n_days` | N（天数） | 每 N 天弹一次 |
| `n_times_total` | N（总次数） | 累计最多弹 N 次 |

---

### 2. 模型改造: `models/PopupBanner.js`

在现有模型定义中新增 5 个字段：

- `banner_type`: VARCHAR(20), ENUM 验证 `['notice', 'event', 'promo']`, 默认 `'promo'`
- `frequency_rule`: VARCHAR(30), ENUM 验证 `['always', 'once', 'once_per_session', 'once_per_day', 'once_per_n_days', 'n_times_total']`, 默认 `'once_per_day'`
- `frequency_value`: INT, 正整数验证, 默认 `1`
- `force_show`: TINYINT(1), 默认 `false`
- `priority`: INT, 默认 `0`

新增 Scope: `byType(banner_type)` 按类型筛选

---

### 3. 服务层改造: `services/PopupBannerService.js`

改造现有方法：

- `getActiveBanners()`: **返回字段追加** 5 个新字段（`banner_type`, `frequency_rule`, `frequency_value`, `force_show`, `priority`）
- `getAdminBannerList()`: 支持 `banner_type` 筛选参数
- `createBanner()`: `allowedFields` 追加 5 个新字段
- `updateBanner()`: `allowedFields` 追加 5 个新字段
- `getStatistics()`: 统计维度追加按 `banner_type` 分布

---

### 4. 路由层改造

#### 小程序端路由 `routes/v4/system/popup-banners.js`

`GET /api/v4/system/popup-banners` 返回数据调整排序：

```
先按 priority DESC（优先级高的排前面）
再按 display_order ASC（同优先级按管理员设置的顺序）
```

#### 管理后台路由 `routes/v4/console/popup-banners.js`

- `POST`（创建）/ `PUT`（更新）: 参数校验追加 5 个新字段的 Joi 验证规则
- `GET` 列表: 支持 `banner_type` query 参数筛选

---

### 5. 字典数据

追加以下字典项（用于管理后台枚举值的中文显示）：

| dict_type | dict_code | dict_name |
|---|---|---|
| `banner_type` | `notice` | 系统公告 |
| `banner_type` | `event` | 活动推广 |
| `banner_type` | `promo` | 日常促销 |
| `banner_frequency` | `always` | 每次弹出 |
| `banner_frequency` | `once` | 仅弹一次 |
| `banner_frequency` | `once_per_session` | 每次启动弹一次 |
| `banner_frequency` | `once_per_day` | 每天一次 |
| `banner_frequency` | `once_per_n_days` | 每N天一次 |
| `banner_frequency` | `n_times_total` | 累计N次 |

---

## 二、前端期望的 API 响应格式

### `GET /api/v4/system/popup-banners` 响应

前端期望**每个 banner 对象**包含以下字段（在现有字段基础上新增 5 个频率控制字段）：

```json
{
  "success": true,
  "data": {
    "banners": [
      {
        "popup_banner_id": 15,
        "title": "春节积分翻倍活动",
        "image_url": "https://objectstorageapi.bja.sealos.run/br0za7uc-tiangong/popup-banners/xxx.jpg",
        "display_mode": "square",
        "image_width": 750,
        "image_height": 750,
        "link_url": "/pages/lottery/lottery",
        "link_type": "page",
        "position": "home",
        "display_order": 0,
        "start_time": "2026-02-01T00:00:00+08:00",
        "end_time": "2026-02-28T23:59:59+08:00",

        "banner_type": "promo",
        "frequency_rule": "once_per_n_days",
        "frequency_value": 3,
        "force_show": false,
        "priority": 100
      }
    ]
  }
}
```

### 前端使用的字段清单

| 字段名 | 类型 | 前端用途 |
|---|---|---|
| `popup_banner_id` | INT | 主键，本地存储记录的key |
| `title` | STRING | 弹窗标题展示 |
| `image_url` | STRING | 弹窗图片展示 |
| `display_mode` | STRING | 图片显示模式（6种） |
| `image_width` | INT/NULL | 图片原始宽度（预加载判断用） |
| `image_height` | INT/NULL | 图片原始高度（预加载判断用） |
| `link_url` | STRING/NULL | 点击跳转目标 |
| `link_type` | STRING | 跳转类型（none/page/miniprogram/webview） |
| `display_order` | INT | 管理员设置的排列顺序 |
| `start_time` | STRING/NULL | 展示开始时间 |
| `end_time` | STRING/NULL | 展示结束时间 |
| **`banner_type`** | STRING | **[新增]** 类型分级，决定关闭行为和UI展示 |
| **`frequency_rule`** | STRING | **[新增]** 频率规则，客户端执行频率判断 |
| **`frequency_value`** | INT | **[新增]** 频率参数值 |
| **`force_show`** | BOOLEAN | **[新增]** 强制弹出标志 |
| **`priority`** | INT | **[新增]** 弹出优先级排序 |

---

## 三、前端已完成的工作

| 文件 | 完成内容 |
|---|---|
| `typings/api.d.ts` | PopupBanner 类型定义已更新（含5个新字段 + BannerRecord本地存储类型） |
| `utils/popup-frequency.ts` | **新文件** - 频率判断工具（shouldShowBanner / markBannerSeen / markBannerDismissed / cleanExpiredRecords / filterBannersByFrequency） |
| `app.ts` | globalData 新增 sessionSeenPopups（会话级去重集合）+ onLaunch 清理过期记录 |
| `pages/lottery/lottery.ts` | loadPopupBanners 已集成频率过滤 + onPopupBannerClose 写入dismissed状态 |
| `components/popup-banner/popup-banner.ts` | 支持 force_show（遮罩不可点击关闭）+ banner_type（notice类型确认按钮） |
| `components/popup-banner/popup-banner.wxml` | notice类型显示"我知道了"按钮 + force_show隐藏关闭图标 |
| `components/popup-banner/popup-banner.scss` | "我知道了"按钮样式（品牌橙色渐变） |
| `utils/index.ts` | 新增 PopupFrequency 模块导出 |

---

## 四、联调验证清单

后端完成改造后，请使用以下测试用例验证：

### 测试1: notice 类型（系统公告）
```json
{
  "banner_type": "notice",
  "frequency_rule": "once",
  "frequency_value": 1,
  "force_show": true,
  "priority": 999
}
```
**预期行为**: 强制弹出，不可点遮罩关闭，显示"我知道了"按钮，关闭后永不再弹

### 测试2: event 类型（活动推广）
```json
{
  "banner_type": "event",
  "frequency_rule": "once",
  "frequency_value": 1,
  "force_show": false,
  "priority": 100
}
```
**预期行为**: 活动期间弹一次，可点遮罩或关闭按钮关闭

### 测试3: promo 类型 - 每天一次
```json
{
  "banner_type": "promo",
  "frequency_rule": "once_per_day",
  "frequency_value": 1,
  "force_show": false,
  "priority": 50
}
```
**预期行为**: 每天第一次进入页面弹出，关闭后当天不再弹出，第二天再次弹出

### 测试4: promo 类型 - 每3天一次
```json
{
  "banner_type": "promo",
  "frequency_rule": "once_per_n_days",
  "frequency_value": 3,
  "force_show": false,
  "priority": 30
}
```
**预期行为**: 首次弹出后，3天内不再弹出，第4天再次弹出

### 测试5: 优先级竞争
同时存在多个满足展示条件的banner时，`priority`数字最大的先弹出

---

## 五、数据流图

```
┌─────────────────────────────────────────────────────────────────┐
│  运营人员（Web管理后台）                                          │
│  配置 banner_type / frequency_rule / frequency_value /          │
│  force_show / priority                                          │
└──────────────────────────┬──────────────────────────────────────┘
                           │ POST/PUT /api/v4/console/popup-banners
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  后端 (Express + Sequelize + MySQL)                              │
│  popup_banners 表存储配置                                        │
│  GET /api/v4/system/popup-banners 返回活跃banner列表             │
│  排序: priority DESC, display_order ASC                          │
│  过滤: is_active=true + 时间范围                                 │
└──────────────────────────┬──────────────────────────────────────┘
                           │ API Response (含5个频率控制字段)
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  前端 (微信小程序)                                                │
│                                                                   │
│  1. lottery.ts → API.getPopupBanners()                           │
│  2. popup-frequency.ts → filterBannersByFrequency()              │
│     ├─ 读取 wx.getStorageSync('popup_banner_records')            │
│     ├─ 逐个执行 shouldShowBanner(banner, record, sessionSet)     │
│     └─ 按 priority 降序排序                                      │
│  3. 展示最高优先级 banner                                         │
│  4. 展示后 → markBannerSeen() 更新本地存储                       │
│  5. 关闭后 → markBannerDismissed() 记录dismissed状态             │
│                                                                   │
│  本地存储结构:                                                    │
│  { "15": { lastSeen: 1740000000, seenCount: 3, dismissed: true }}│
└─────────────────────────────────────────────────────────────────┘
```

---

## 六、注意事项

1. **现有2条banner记录**: 迁移后会自动填入默认值 `banner_type='promo'`, `frequency_rule='once_per_day'`
2. **`priority` vs `display_order`**: priority 控制弹出竞争优先级（大的先弹），display_order 控制列表排列顺序（小的排前），两者职责不同，需要共存
3. **前端不需要知道业务逻辑**: 频率判断逻辑纯粹基于后端返回的规则配置 + 客户端本地记录，不涉及任何业务计算
4. **项目未上线**: 无需考虑存量数据兼容，一次性做到位
