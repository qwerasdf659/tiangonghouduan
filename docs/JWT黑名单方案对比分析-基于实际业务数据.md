# JWT Tokené»‘åå•æœºåˆ¶ - ä¸‰æ–¹æ¡ˆæ·±åº¦å¯¹æ¯”(åŸºäºå®é™…ä¸šåŠ¡æ•°æ®å’Œç°æœ‰æŠ€æœ¯æ ˆ)

> **æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2025-11-07 22:15:30(åŒ—äº¬æ—¶é—´)  
> **é¡¹ç›®**: å¤©å·¥é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿåç«¯(Backend Database Project)  
> **é—®é¢˜ç­‰çº§**: ğŸŸ  é«˜é£é™©(R4) - JWTé»‘åå•æœºåˆ¶ç¼ºå¤±  
> **æŠ€æœ¯è·¯çº¿**: å®ç”¨ä¸»ä¹‰(Pragmatism) - åŸºäºé¡¹ç›®ç°æœ‰æŠ€æœ¯æ ˆï¼Œé¿å…è¿‡åº¦è®¾è®¡  
> **æ ¸å¿ƒåŸåˆ™**: "ä¸è¦ä¸ºäº†é‡æ„è€Œé‡æ„ï¼Œè¦ä¸ºäº†é™ä½ç»´æŠ¤æˆæœ¬è€Œé‡æ„"  
> **ä½¿ç”¨æ¨¡å‹**: Claude Sonnet 4.5(Claude AI Assistant)

---

## ğŸ“Š é—®é¢˜èƒŒæ™¯å’Œå®é™…ä¸šåŠ¡æ•°æ®åˆ†æ

### ğŸ”´ æ ¸å¿ƒé—®é¢˜æè¿°

**é—®é¢˜**: ç”¨æˆ·çŠ¶æ€æ›´æ–°ä¸º`inactive/banned`åï¼Œç”¨æˆ·çš„JWT tokenåœ¨è¿‡æœŸå‰(é»˜è®¤24å°æ—¶)ä»ç„¶æœ‰æ•ˆ

**å®é™…ä¸šåŠ¡å½±å“**(åŸºäºå°æ•°æ®é‡çœŸå®åœºæ™¯):
- **ç”¨æˆ·è§„æ¨¡**: <500äºº(å°å‹é¤å…ç³»ç»Ÿ)
- **å°ç¦é¢‘æ¬¡**: æ¯å‘¨0-2æ¬¡(ä½é¢‘åœºæ™¯)
- **å±å®³ç¨‹åº¦**: é«˜(å°ç¦æ— æ•ˆï¼Œç”¨æˆ·ç»§ç»­ä½œå¼Š)
- **å½±å“æ—¶é—´**: 24å°æ—¶(tokenè¿‡æœŸå‰)

**å…¸å‹ä¸šåŠ¡åœºæ™¯**:
1. å‘ç°ç”¨æˆ·æ¶æ„åˆ·åˆ†(çŸ­æ—¶é—´å†…æŠ½å¥–50+æ¬¡)
2. ç®¡ç†å‘˜å°ç¦ç”¨æˆ·(è®¾ç½®status=banned)
3. ç”¨æˆ·åœ¨æ¥ä¸‹æ¥24å°æ—¶å†…ä»å¯ä½¿ç”¨åŸtokenç»§ç»­ä½œå¼Š
4. ç³»ç»ŸæŸå¤±: æ¶æ„ç”¨æˆ·ç»§ç»­æ¶ˆè€—å¥–å“åº“å­˜

---

## ğŸ› ï¸ é¡¹ç›®ç°æœ‰æŠ€æœ¯åŸºç¡€(å·²éªŒè¯çš„å®é™…ä»£ç )

### âœ… æŠ€æœ¯æ ˆç›˜ç‚¹

```javascript
// 1. âœ… UnifiedRedisClient(utils/UnifiedRedisClient.js ç¬¬1-450è¡Œ)
const { getRawClient } = require('../utils/UnifiedRedisClient')
const redisClient = getRawClient() // iorediså®¢æˆ·ç«¯ï¼Œè¿æ¥æ± å¤ç”¨

// Redisé…ç½®
{
  host: process.env.REDIS_HOST || 'localhost',
  port: process.env.REDIS_PORT || 6379,
  db: process.env.REDIS_DB || 0,
  maxRetriesPerRequest: 3,
  connectTimeout: 10000,
  commandTimeout: 5000,
  lazyConnect: true, // å»¶è¿Ÿè¿æ¥ï¼Œæé«˜æ€§èƒ½
  keepAlive: true
}

// 2. âœ… åŒå±‚ç¼“å­˜æœºåˆ¶(middleware/auth.js ç¬¬23-98è¡Œ)
const memoryCache = new Map() // å†…å­˜ç¼“å­˜ï¼ŒTTL=5åˆ†é’Ÿ
const MEMORY_TTL = 5 * 60 * 1000
const REDIS_TTL = 30 * 60 // Redisç¼“å­˜ï¼ŒTTL=30åˆ†é’Ÿ(ç§’)
const REDIS_PREFIX = 'auth:permissions:'

// 3. âœ… æ¸…é™¤ç¼“å­˜å‡½æ•°(middleware/auth.js ç¬¬103-119è¡Œ)
async function invalidateUserPermissions(user_id, reason = 'unknown') {
  const memoryKey = `permissions_${user_id}`
  memoryCache.delete(memoryKey) // æ¸…é™¤å†…å­˜ç¼“å­˜
  
  if (redisClient) {
    const redisKey = `${REDIS_PREFIX}${user_id}`
    await redisClient.del(redisKey) // æ¸…é™¤Redisç¼“å­˜
  }
  
  console.log(`ğŸ”„ [Auth] æ¸…é™¤ç”¨æˆ·æƒé™ç¼“å­˜: ${user_id} (åŸå› : ${reason})`)
}

// 4. âœ… statusæ£€æŸ¥æœºåˆ¶(middleware/auth.js ç¬¬139-149è¡Œ)
const user = await User.findOne({
  where: { user_id, status: 'active' }, // âš ï¸ æ£€æŸ¥status='active'
  include: [{
    model: Role,
    as: 'roles',
    through: { where: { is_active: true } },
    attributes: ['role_id', 'role_uuid', 'role_name', 'role_level', 'permissions']
  }]
})

// 5. âœ… Sequelize ORM(é¡¹ç›®æ ‡å‡†æŠ€æœ¯æ ˆ)
const { User, Role, UserRole } = require('../models')
// å·²æœ‰å®Œæ•´æ¨¡å‹å®šä¹‰ï¼šusersè¡¨(statuså­—æ®µ)ã€rolesè¡¨ã€user_rolesè¡¨

// 6. âœ… åŒ—äº¬æ—¶é—´å·¥å…·(utils/timeHelper.js)
const BeijingTimeHelper = require('../utils/timeHelper')
BeijingTimeHelper.timestamp() // è·å–å½“å‰åŒ—äº¬æ—¶é—´æˆ³
```

### ğŸ” å½“å‰ä»£ç é—®é¢˜ç‚¹åˆ†æ

```javascript
// middleware/auth.js ç¬¬127-197è¡Œ - getUserRoleså‡½æ•°
async function getUserRoles(user_id, forceRefresh = false) {
  // é—®é¢˜1: ç¼“å­˜ä¼˜å…ˆç­–ç•¥
  if (!forceRefresh) {
    const cached = await getUserPermissionsFromCache(user_id)
    if (cached) {
      return cached // âš ï¸ ç¼“å­˜æœ‰æ•ˆæœŸå†…(5åˆ†é’Ÿå†…å­˜+30åˆ†é’ŸRedis)è¿”å›æ—§æ•°æ®
    }
  }

  // é—®é¢˜2: statusæ£€æŸ¥åœ¨æ•°æ®åº“å±‚ï¼Œä½†ç¼“å­˜å¯èƒ½å·²è¿‡æœŸ
  const user = await User.findOne({
    where: { user_id, status: 'active' }, // âš ï¸ status='inactive/banned'æ—¶è¿”å›null
    include: [...]
  })

  if (!user || !user.roles) {
    const emptyResult = { isAdmin: false, roleLevel: 0, roles: [], permissions: [] }
    await setUserPermissionsCache(user_id, emptyResult) // âš ï¸ ç¼“å­˜ç©ºç»“æœ
    return emptyResult
  }

  // é—®é¢˜3: ç¼“å­˜ç»“æœ
  await setUserPermissionsCache(user_id, result) // âš ï¸ ç¼“å­˜5-30åˆ†é’Ÿ
  return result
}

// user_management.js ç¬¬232-262è¡Œ - çŠ¶æ€æ›´æ–°æ“ä½œ
router.put('/users/:user_id/status', async (req, res) => {
  const { status } = req.body // 'inactive' or 'banned'
  await user.update({ status }) // âš ï¸ æ›´æ–°status
  
  // âš ï¸ ç¼ºå¤±: æœªè°ƒç”¨ invalidateUserPermissions(user_id, `status changed to ${status}`)
  // å¯¼è‡´ç¼“å­˜ä¸­çš„æ—§æƒé™ä¿¡æ¯(status=active)åœ¨5-30åˆ†é’Ÿå†…ä»æœ‰æ•ˆ
})
```

---

## ğŸ¯ ä¸‰æ–¹æ¡ˆæ·±åº¦å¯¹æ¯”åˆ†æ

### æ–¹æ¡ˆ1: æ•°æ®åº“è¡¨é»‘åå•(æœ€ç¬¦åˆåç«¯æ•°æ®åº“é¡¹ç›®ç‰¹æ€§)

#### ğŸ“‹ æŠ€æœ¯æ–¹æ¡ˆè¯´æ˜

**æ ¸å¿ƒæ€è·¯**: åˆ›å»º`user_blacklist`è¡¨ï¼Œå­˜å‚¨å°ç¦ç”¨æˆ·IDï¼Œæ¯æ¬¡è¯·æ±‚æ—¶æŸ¥è¯¢æ•°æ®åº“éªŒè¯

```sql
-- åˆ›å»ºç”¨æˆ·é»‘åå•è¡¨(åŸºäºé¡¹ç›®å®é™…éœ€æ±‚è®¾è®¡)
CREATE TABLE user_blacklist (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'è‡ªå¢ä¸»é”®',
  user_id INT NOT NULL UNIQUE COMMENT 'ç”¨æˆ·ID(å…³è”usersè¡¨,å”¯ä¸€çº¦æŸ)',
  status VARCHAR(20) NOT NULL COMMENT 'å°ç¦çŠ¶æ€(inactive/banned)',
  reason VARCHAR(500) COMMENT 'å°ç¦åŸå› (è®°å½•æ“ä½œåŸå› )',
  operator_id INT COMMENT 'æ“ä½œè€…ç”¨æˆ·ID(å®¡è®¡è¿½æº¯)',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'å°ç¦æ—¶é—´(åŒ—äº¬æ—¶é—´)',
  expires_at DATETIME COMMENT 'è¿‡æœŸæ—¶é—´(NULL=æ°¸ä¹…å°ç¦)',
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_user_id (user_id),
  INDEX idx_status (status),
  INDEX idx_created_at (created_at),
  INDEX idx_expires_at (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·é»‘åå•è¡¨(JWT tokenå°ç¦æœºåˆ¶)';
```

**æ ¸å¿ƒä»£ç å®ç°**(middleware/auth.js):

```javascript
// åœ¨authenticateTokenå‡½æ•°ä¸­æ·»åŠ é»‘åå•æ£€æŸ¥(ç¬¬333è¡Œä¹‹å)
async function authenticateToken(req, res, next) {
  try {
    const authHeader = req.headers.authorization
    const token = authHeader && authHeader.split(' ')[1]
    if (!token) return res.status(401).json({ error: 'MISSING_TOKEN', message: 'ç¼ºå°‘è®¤è¯Token' })

    const decoded = jwt.verify(token, process.env.JWT_SECRET)
    const user_id = decoded.user_id

    // âœ… æ–¹æ¡ˆ1æ ¸å¿ƒé€»è¾‘: æ•°æ®åº“é»‘åå•æ£€æŸ¥(æ·»åŠ åˆ°ç¬¬347è¡Œä¹‹å‰)
    const { UserBlacklist } = require('../models')
    const blacklistEntry = await UserBlacklist.findOne({
      where: { 
        user_id,
        [Op.or]: [
          { expires_at: null }, // æ°¸ä¹…å°ç¦
          { expires_at: { [Op.gt]: new Date() } } // æœªè¿‡æœŸçš„ä¸´æ—¶å°ç¦
        ]
      }
    })

    if (blacklistEntry) {
      return res.status(401).json({
        success: false,
        error: 'ACCOUNT_DISABLED',
        message: blacklistEntry.status === 'banned' ? 'è´¦å·å·²è¢«æ°¸ä¹…å°ç¦' : 'è´¦å·å·²è¢«ä¸´æ—¶ç¦ç”¨',
        data: {
          status: blacklistEntry.status,
          reason: blacklistEntry.reason,
          blacklisted_at: blacklistEntry.created_at
        }
      })
    }

    // ç»§ç»­åç»­éªŒè¯é€»è¾‘...
    const user = await User.findOne({ where: { user_id, status: 'active' }, include: [...] })
    // ...
  } catch (error) {
    // ...
  }
}
```

**çŠ¶æ€æ›´æ–°æ—¶åŒæ­¥é»‘åå•**(routes/v4/unified-engine/admin/user_management.js):

```javascript
// PUT /users/:user_id/status è·¯ç”±(ç¬¬232-262è¡Œ)
router.put('/users/:user_id/status', async (req, res) => {
  const { user_id } = req.params
  const { status, reason } = req.body // 'inactive' or 'banned'
  
  const transaction = await sequelize.transaction()
  try {
    // 1. æ›´æ–°ç”¨æˆ·status
    await user.update({ status }, { transaction })
    
    // 2. åŒæ­¥é»‘åå•è¡¨(æ–¹æ¡ˆ1æ ¸å¿ƒé€»è¾‘)
    const { UserBlacklist } = require('../../../../models')
    
    if (status === 'inactive' || status === 'banned') {
      // åŠ å…¥é»‘åå•
      await UserBlacklist.upsert({
        user_id: parseInt(user_id),
        status: status,
        reason: reason || 'ç®¡ç†å‘˜æ“ä½œ',
        operator_id: req.user.user_id,
        expires_at: status === 'banned' ? null : new Date(Date.now() + 30 * 24 * 60 * 60 * 1000) // banned=æ°¸ä¹…,inactive=30å¤©
      }, { transaction })
      console.log(`ğŸš« ç”¨æˆ·å·²åŠ å…¥é»‘åå•: ${user_id} (${status})`)
    } else if (status === 'active') {
      // ç§»å‡ºé»‘åå•
      await UserBlacklist.destroy({ where: { user_id: parseInt(user_id) }, transaction })
      console.log(`âœ… ç”¨æˆ·å·²ç§»å‡ºé»‘åå•: ${user_id}`)
    }
    
    await transaction.commit()
    return res.apiSuccess('ç”¨æˆ·çŠ¶æ€æ›´æ–°æˆåŠŸ', { user_id, old_status: user.status, new_status: status })
  } catch (error) {
    await transaction.rollback()
    return res.apiError('ç”¨æˆ·çŠ¶æ€æ›´æ–°å¤±è´¥', 'UPDATE_USER_STATUS_FAILED', null, 500)
  }
})
```

#### ğŸ“Š æ–¹æ¡ˆ1ä¼˜åŠ¿åˆ†æ(â­â­â­â­â­ 5æ˜Ÿæ¨è)

| è¯„ä»·ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|---------|------|------|
| **å®ç”¨ä¸»ä¹‰** | â­â­â­â­â­ | ç¬¦åˆåç«¯æ•°æ®åº“é¡¹ç›®ç‰¹æ€§ï¼Œåˆ©ç”¨ç°æœ‰Sequelize ORMæŠ€æœ¯æ ˆ |
| **ä»£ç å¤æ‚åº¦** | â­â­â­â­â­ | æä½(çº¦50è¡Œä»£ç )ï¼Œåˆ›å»ºæ¨¡å‹+æŸ¥è¯¢+upserté€»è¾‘æ¸…æ™° |
| **ç»´æŠ¤æˆæœ¬** | â­â­â­â­â­ | æä½ï¼ŒSequelize ORMç»Ÿä¸€ç®¡ç†ï¼Œæ— é¢å¤–ä¾èµ– |
| **å­¦ä¹ æˆæœ¬** | â­â­â­â­â­ | æä½(1å°æ—¶å­¦ä¹ )ï¼Œæ ‡å‡†æ•°æ®åº“æ“ä½œï¼Œæ— æ–°æŠ€æœ¯ |
| **æ€§èƒ½è¡¨ç°** | â­â­â­â­ | è‰¯å¥½(æ•°æ®åº“æŸ¥è¯¢<20ms)ï¼Œç´¢å¼•å‘½ä¸­ç‡100%(idx_user_id) |
| **å¯é æ€§** | â­â­â­â­â­ | æé«˜ï¼Œæ•°æ®æŒä¹…åŒ–ï¼Œä¸ä¾èµ–Redisï¼Œå®•æœºä¸ä¸¢å¤±æ•°æ® |
| **æ‰©å±•æ€§** | â­â­â­â­â­ | ä¼˜ç§€ï¼Œæ”¯æŒä¸´æ—¶å°ç¦(expires_at)ã€å®¡è®¡è¿½æº¯(operator_id) |
| **ç«‹å³ç”Ÿæ•ˆ** | â­â­â­â­â­ | æ˜¯ï¼Œæ¯æ¬¡è¯·æ±‚æŸ¥è¯¢æ•°æ®åº“ï¼Œå°ç¦ç«‹å³ç”Ÿæ•ˆ |
| **æŠ€æœ¯å€ºåŠ¡** | â­â­â­â­â­ | æ— ï¼Œå®Œå…¨ç¬¦åˆé¡¹ç›®æŠ€æœ¯æ ˆï¼Œä¸å¼•å…¥æ–°ä¾èµ– |
| **ROI** | â­â­â­â­â­ | æé«˜(å¼€å‘2hï¼Œä½¿ç”¨é¢‘æ¬¡ä½ä½†ä¸šåŠ¡ä»·å€¼é«˜) |

**ç»¼åˆè¯„åˆ†**: â­â­â­â­â­ 5æ˜Ÿ(æ»¡åˆ†) - **æœ€ä½³æ–¹æ¡ˆ**

#### ğŸ’¡ æ–¹æ¡ˆ1æ ¸å¿ƒä¼˜åŠ¿

1. **æŠ€æœ¯æ ˆç»Ÿä¸€**: å®Œå…¨åŸºäºSequelize ORMï¼Œæ— éœ€å­¦ä¹ æ–°æŠ€æœ¯
2. **æ•°æ®æŒä¹…åŒ–**: é»‘åå•æ•°æ®å­˜å‚¨åœ¨MySQLï¼Œå®•æœºä¸ä¸¢å¤±
3. **æ— Redisä¾èµ–é£é™©**: ä¸ä¾èµ–Redisï¼ŒRediså®•æœºä¸å½±å“å°ç¦åŠŸèƒ½
4. **å®¡è®¡å®Œæ•´**: operator_idè®°å½•æ“ä½œè€…ï¼Œexpires_atæ”¯æŒä¸´æ—¶å°ç¦
5. **ç»´æŠ¤æˆæœ¬æä½**: æ ‡å‡†æ•°æ®åº“æ“ä½œï¼Œæ–°äºº1å°æ—¶å¯ç†è§£
6. **ç¬¦åˆé¡¹ç›®ç‰¹æ€§**: åç«¯æ•°æ®åº“é¡¹ç›®ï¼Œæ•°æ®åº“æ–¹æ¡ˆæœ€åˆç†

#### âš ï¸ æ–¹æ¡ˆ1åŠ£åŠ¿åˆ†æ

1. **æ€§èƒ½ç•¥ä½**: æ¯æ¬¡è¯·æ±‚å¢åŠ 1æ¬¡æ•°æ®åº“æŸ¥è¯¢(+10-20ms)
   - **å½±å“è¯„ä¼°**: å°æ•°æ®é‡(<500ç”¨æˆ·)ä¸‹ï¼Œç´¢å¼•å‘½ä¸­ç‡100%ï¼Œ<20mså¯æ¥å—
   - **ä¸šåŠ¡å®é™…**: å°ç¦é¢‘æ¬¡æä½(æ¯å‘¨0-2æ¬¡)ï¼Œæ€§èƒ½å½±å“å¯å¿½ç•¥
   
2. **å¹¶å‘å‹åŠ›**: é«˜å¹¶å‘ä¸‹æ•°æ®åº“æŸ¥è¯¢å¯èƒ½æˆä¸ºç“¶é¢ˆ
   - **å½±å“è¯„ä¼°**: é¡¹ç›®å¹¶å‘<50äºº/ç§’ï¼Œæ•°æ®åº“å®Œå…¨æ”¯æ’‘
   - **ä¼˜åŒ–æ–¹æ¡ˆ**: å¯é€‰æ·»åŠ RedisäºŒçº§ç¼“å­˜(blacklistç»“æœç¼“å­˜30ç§’)

#### ğŸ“ˆ æ–¹æ¡ˆ1å®é™…æ•°æ®é¢„ä¼°

**åŸºäºé¡¹ç›®çœŸå®ä¸šåŠ¡æ•°æ®**(ç”¨æˆ·<500äººï¼Œå°ç¦é¢‘æ¬¡æ¯å‘¨0-2æ¬¡):

| æ€§èƒ½æŒ‡æ ‡ | é¢„ä¼°å€¼ | å®æµ‹æ•°æ®(éœ€éªŒè¯) | è¯´æ˜ |
|---------|--------|-----------------|------|
| æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ | < 20ms | å¾…å®æµ‹ | idx_user_idç´¢å¼•å‘½ä¸­ç‡100% |
| å†…å­˜å ç”¨ | < 10MB | å¾…å®æµ‹ | user_blacklistè¡¨æ•°æ®é‡<100æ¡ |
| é»‘åå•è¡¨æ•°æ®é‡ | < 100æ¡ | å½“å‰0æ¡ | é¢„è®¡20ä¸ªå°ç¦ç”¨æˆ·+80ä¸ªä¸´æ—¶ç¦ç”¨ |
| ç´¢å¼•å¤§å° | < 5MB | å¾…å®æµ‹ | idx_user_idå”¯ä¸€ç´¢å¼• |
| å¹¶å‘æ”¯æŒ | 50+æŸ¥è¯¢/ç§’ | å¾…å®æµ‹ | å•æœºMySQLå¯æ”¯æ’‘ |

---

### æ–¹æ¡ˆ2: Redisé»‘åå•(æ€§èƒ½æœ€ä¼˜ï¼Œä½†å¢åŠ ä¾èµ–é£é™©)

#### ğŸ“‹ æŠ€æœ¯æ–¹æ¡ˆè¯´æ˜

**æ ¸å¿ƒæ€è·¯**: åˆ©ç”¨ç°æœ‰UnifiedRedisClientï¼Œå°ç¦æ—¶å°†user_idå­˜å…¥Redis(key=auth:blacklist:{user_id})ï¼Œæ¯æ¬¡è¯·æ±‚æ—¶æ£€æŸ¥Redis

**æ ¸å¿ƒä»£ç å®ç°**(middleware/auth.js):

```javascript
// åœ¨authenticateTokenå‡½æ•°ä¸­æ·»åŠ Redisé»‘åå•æ£€æŸ¥(ç¬¬333è¡Œä¹‹å)
async function authenticateToken(req, res, next) {
  try {
    const authHeader = req.headers.authorization
    const token = authHeader && authHeader.split(' ')[1]
    if (!token) return res.status(401).json({ error: 'MISSING_TOKEN', message: 'ç¼ºå°‘è®¤è¯Token' })

    const decoded = jwt.verify(token, process.env.JWT_SECRET)
    const user_id = decoded.user_id

    // âœ… æ–¹æ¡ˆ2æ ¸å¿ƒé€»è¾‘: Redisé»‘åå•æ£€æŸ¥(æ·»åŠ åˆ°ç¬¬347è¡Œä¹‹å‰)
    if (redisClient) {
      try {
        const blacklistKey = `auth:blacklist:${user_id}`
        const blacklisted = await redisClient.get(blacklistKey) // RedisæŸ¥è¯¢<5ms
        
        if (blacklisted) {
          const blacklistData = JSON.parse(blacklisted)
          return res.status(401).json({
            success: false,
            error: 'ACCOUNT_DISABLED',
            message: blacklistData.status === 'banned' ? 'è´¦å·å·²è¢«æ°¸ä¹…å°ç¦' : 'è´¦å·å·²è¢«ä¸´æ—¶ç¦ç”¨',
            data: {
              status: blacklistData.status,
              reason: blacklistData.reason,
              blacklisted_at: blacklistData.blacklisted_at
            }
          })
        }
      } catch (error) {
        console.warn('âš ï¸ Redisé»‘åå•æ£€æŸ¥å¤±è´¥ï¼Œé™çº§ä¸ºæ•°æ®åº“éªŒè¯:', error.message)
        // Rediså¤±è´¥æ—¶ï¼Œç»§ç»­æ‰§è¡Œåç»­çš„æ•°æ®åº“statuséªŒè¯(é™çº§ä¿æŠ¤)
      }
    }

    // ç»§ç»­åç»­éªŒè¯é€»è¾‘...
    const user = await User.findOne({ where: { user_id, status: 'active' }, include: [...] })
    // ...
  } catch (error) {
    // ...
  }
}
```

**çŠ¶æ€æ›´æ–°æ—¶åŒæ­¥Redisé»‘åå•**(routes/v4/unified-engine/admin/user_management.js):

```javascript
// PUT /users/:user_id/status è·¯ç”±(ç¬¬232-262è¡Œ)
router.put('/users/:user_id/status', async (req, res) => {
  const { user_id } = req.params
  const { status, reason } = req.body // 'inactive' or 'banned'
  
  try {
    // 1. æ›´æ–°ç”¨æˆ·status
    await user.update({ status })
    
    // 2. åŒæ­¥Redisé»‘åå•(æ–¹æ¡ˆ2æ ¸å¿ƒé€»è¾‘)
    const { getRawClient } = require('../../../../utils/UnifiedRedisClient')
    const redisClient = getRawClient()
    
    if (status === 'inactive' || status === 'banned') {
      // åŠ å…¥Redisé»‘åå•
      const blacklistKey = `auth:blacklist:${user_id}`
      const blacklistData = {
        user_id: parseInt(user_id),
        status: status,
        reason: reason || 'ç®¡ç†å‘˜æ“ä½œ',
        operator_id: req.user.user_id,
        blacklisted_at: new Date().toISOString()
      }
      
      const ttl = status === 'banned' ? 365 * 24 * 60 * 60 : 30 * 24 * 60 * 60 // banned=1å¹´,inactive=30å¤©
      await redisClient.setex(blacklistKey, ttl, JSON.stringify(blacklistData))
      console.log(`ğŸš« ç”¨æˆ·å·²åŠ å…¥Redisé»‘åå•: ${user_id} (${status}, TTL=${ttl}ç§’)`)
    } else if (status === 'active') {
      // ç§»å‡ºRedisé»‘åå•
      await redisClient.del(`auth:blacklist:${user_id}`)
      console.log(`âœ… ç”¨æˆ·å·²ç§»å‡ºRedisé»‘åå•: ${user_id}`)
    }
    
    // 3. æ¸…é™¤æƒé™ç¼“å­˜(å¿…é¡»æ‰§è¡Œ)
    await invalidateUserPermissions(user_id, `status changed to ${status}`)
    
    return res.apiSuccess('ç”¨æˆ·çŠ¶æ€æ›´æ–°æˆåŠŸ', { user_id, old_status: user.status, new_status: status })
  } catch (error) {
    return res.apiError('ç”¨æˆ·çŠ¶æ€æ›´æ–°å¤±è´¥', 'UPDATE_USER_STATUS_FAILED', null, 500)
  }
})
```

#### ğŸ“Š æ–¹æ¡ˆ2ä¼˜åŠ¿åˆ†æ(â­â­â­â­ 4æ˜Ÿæ¨è)

| è¯„ä»·ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|---------|------|------|
| **å®ç”¨ä¸»ä¹‰** | â­â­â­â­ | åˆ©ç”¨ç°æœ‰UnifiedRedisClientï¼ŒæŠ€æœ¯æ ˆå·²æœ‰ |
| **ä»£ç å¤æ‚åº¦** | â­â­â­â­ | ä½(çº¦40è¡Œä»£ç )ï¼ŒRedisæ“ä½œç®€å• |
| **ç»´æŠ¤æˆæœ¬** | â­â­â­ | ä¸­ç­‰ï¼Œéœ€è¦ç»´æŠ¤Redisæ•°æ®ä¸€è‡´æ€§ |
| **å­¦ä¹ æˆæœ¬** | â­â­â­â­ | ä½(1å°æ—¶å­¦ä¹ )ï¼ŒRedisåŸºç¡€æ“ä½œ |
| **æ€§èƒ½è¡¨ç°** | â­â­â­â­â­ | ä¼˜ç§€(RedisæŸ¥è¯¢<5ms)ï¼Œæ€§èƒ½æœ€ä½³ |
| **å¯é æ€§** | â­â­â­ | ä¸­ç­‰ï¼Œä¾èµ–Rediså¯ç”¨æ€§ï¼Œå®•æœºåé»‘åå•å¤±æ•ˆ |
| **æ‰©å±•æ€§** | â­â­â­â­ | è‰¯å¥½ï¼ŒTTLæ”¯æŒä¸´æ—¶å°ç¦ï¼ŒJSONå­˜å‚¨æ”¯æŒæ‰©å±•å­—æ®µ |
| **ç«‹å³ç”Ÿæ•ˆ** | â­â­â­â­â­ | æ˜¯ï¼ŒRedisæŸ¥è¯¢æå¿«ï¼Œå°ç¦ç«‹å³ç”Ÿæ•ˆ |
| **æŠ€æœ¯å€ºåŠ¡** | â­â­â­ | ä½ï¼Œåˆ©ç”¨ç°æœ‰Redisï¼Œä½†å¢åŠ Redisä¾èµ–é£é™© |
| **ROI** | â­â­â­â­ | é«˜(å¼€å‘2hï¼Œæ€§èƒ½æœ€ä½³) |

**ç»¼åˆè¯„åˆ†**: â­â­â­â­ 4æ˜Ÿ(é«˜åˆ†) - **æ€§èƒ½æœ€ä¼˜æ–¹æ¡ˆ**

#### ğŸ’¡ æ–¹æ¡ˆ2æ ¸å¿ƒä¼˜åŠ¿

1. **æ€§èƒ½æœ€ä¼˜**: RedisæŸ¥è¯¢<5msï¼Œè¿œå¿«äºæ•°æ®åº“æŸ¥è¯¢(10-20ms)
2. **ç«‹å³ç”Ÿæ•ˆ**: å°ç¦åç«‹å³ç”Ÿæ•ˆï¼Œæ— å»¶è¿Ÿ
3. **åˆ©ç”¨ç°æœ‰æŠ€æœ¯**: é¡¹ç›®å·²æœ‰UnifiedRedisClientï¼Œæ— éœ€é¢å¤–ä¾èµ–
4. **TTLæ”¯æŒ**: RedisåŸç”Ÿæ”¯æŒè¿‡æœŸæ—¶é—´ï¼Œå®ç°ä¸´æ—¶å°ç¦ç®€å•
5. **é™çº§ä¿æŠ¤**: Rediså¤±è´¥æ—¶è‡ªåŠ¨é™çº§ä¸ºæ•°æ®åº“statuséªŒè¯

#### âš ï¸ æ–¹æ¡ˆ2åŠ£åŠ¿åˆ†æ

1. **Redisä¾èµ–é£é™©**: Rediså®•æœºåé»‘åå•å¤±æ•ˆ(ä½†æœ‰é™çº§ä¿æŠ¤)
   - **å½±å“è¯„ä¼°**: é¡¹ç›®Rediså·²ç”¨äºæƒé™ç¼“å­˜ï¼Œç¨³å®šæ€§é«˜
   - **é™çº§æ–¹æ¡ˆ**: Rediså¤±è´¥æ—¶è‡ªåŠ¨é™çº§ä¸ºæ•°æ®åº“statuséªŒè¯
   
2. **æ•°æ®æŒä¹…åŒ–é—®é¢˜**: Redisæ•°æ®å¯èƒ½ä¸¢å¤±(éœ€é…ç½®RDB/AOF)
   - **å½±å“è¯„ä¼°**: å°ç¦æ•°æ®ä¸¢å¤±åï¼Œç”¨æˆ·å¯èƒ½çŸ­æš‚ç»•è¿‡å°ç¦
   - **è§£å†³æ–¹æ¡ˆ**: åŒæ­¥å†™å…¥æ•°æ®åº“(æ–¹æ¡ˆ1+æ–¹æ¡ˆ2ç»„åˆ)

3. **ç»´æŠ¤æˆæœ¬ç•¥é«˜**: éœ€è¦ç»´æŠ¤Redisæ•°æ®ä¸€è‡´æ€§
   - **å½±å“è¯„ä¼°**: å°ç¦/æ¢å¤æ“ä½œéœ€è¦åŒæ—¶æ›´æ–°Redis+æ•°æ®åº“
   - **è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨äº‹åŠ¡æˆ–å®šæ—¶åŒæ­¥æœºåˆ¶

#### ğŸ“ˆ æ–¹æ¡ˆ2å®é™…æ•°æ®é¢„ä¼°

**åŸºäºé¡¹ç›®çœŸå®ä¸šåŠ¡æ•°æ®**(ç”¨æˆ·<500äººï¼Œå°ç¦é¢‘æ¬¡æ¯å‘¨0-2æ¬¡):

| æ€§èƒ½æŒ‡æ ‡ | é¢„ä¼°å€¼ | å®æµ‹æ•°æ®(éœ€éªŒè¯) | è¯´æ˜ |
|---------|--------|-----------------|------|
| RedisæŸ¥è¯¢æ—¶é—´ | < 5ms | å¾…å®æµ‹ | auth:blacklist:{user_id}é”®æŸ¥è¯¢ |
| å†…å­˜å ç”¨ | < 1MB | å¾…å®æµ‹ | é»‘åå•æ•°æ®<100æ¡ï¼Œæ¯æ¡<1KB |
| Redisé”®æ•°é‡ | < 100ä¸ª | å½“å‰0ä¸ª | é¢„è®¡20ä¸ªå°ç¦ç”¨æˆ·+80ä¸ªä¸´æ—¶ç¦ç”¨ |
| å¹¶å‘æ”¯æŒ | 1000+æŸ¥è¯¢/ç§’ | å¾…å®æµ‹ | Rediså•æœºå¯æ”¯æ’‘ |
| æ•°æ®ä¸¢å¤±é£é™© | ä½ | - | Redisé…ç½®RDBæŒä¹…åŒ–ï¼Œä¸¢å¤±é£é™©<1% |

---

### æ–¹æ¡ˆ3: æ¸…é™¤ç¼“å­˜+å¼ºåˆ¶æ•°æ®åº“éªŒè¯(æ”¹åŠ¨æœ€å°ï¼Œä½†æœ‰å»¶è¿Ÿé£é™©)

#### ğŸ“‹ æŠ€æœ¯æ–¹æ¡ˆè¯´æ˜

**æ ¸å¿ƒæ€è·¯**: åˆ©ç”¨ç°æœ‰`invalidateUserPermissions`å‡½æ•°æ¸…é™¤æƒé™ç¼“å­˜ï¼Œå°ç¦æ—¶è°ƒç”¨æ­¤å‡½æ•°ï¼Œä¸‹æ¬¡è¯·æ±‚ä¼šé‡æ–°æŸ¥è¯¢æ•°æ®åº“(status='active'æ£€æŸ¥ä¼šæ‹¦æˆª)

**æ ¸å¿ƒä»£ç å®ç°**(routes/v4/unified-engine/admin/user_management.js):

```javascript
// PUT /users/:user_id/status è·¯ç”±(ç¬¬232-262è¡Œ) - ä»…éœ€æ·»åŠ 1è¡Œä»£ç 
router.put('/users/:user_id/status', async (req, res) => {
  const { user_id } = req.params
  const { status, reason } = req.body // 'inactive' or 'banned'
  
  try {
    // 1. æ›´æ–°ç”¨æˆ·status
    await user.update({ status })
    
    // 2. æ¸…é™¤æƒé™ç¼“å­˜(æ–¹æ¡ˆ3æ ¸å¿ƒé€»è¾‘ - ä»…éœ€æ·»åŠ æ­¤è¡Œ)
    const { invalidateUserPermissions } = require('../../../../middleware/auth')
    await invalidateUserPermissions(user_id, `status changed to ${status}`)
    console.log(`ğŸ”„ å·²æ¸…é™¤ç”¨æˆ·æƒé™ç¼“å­˜: ${user_id}`)
    
    return res.apiSuccess('ç”¨æˆ·çŠ¶æ€æ›´æ–°æˆåŠŸ', { user_id, old_status: user.status, new_status: status })
  } catch (error) {
    return res.apiError('ç”¨æˆ·çŠ¶æ€æ›´æ–°å¤±è´¥', 'UPDATE_USER_STATUS_FAILED', null, 500)
  }
})
```

**è¯´æ˜**: 
- æ¸…é™¤ç¼“å­˜åï¼Œä¸‹æ¬¡è¯·æ±‚`getUserRoles(user_id)`ä¼šé‡æ–°æŸ¥è¯¢æ•°æ®åº“
- æ•°æ®åº“æŸ¥è¯¢æ—¶`where: { user_id, status: 'active' }`ä¼šæ‹¦æˆªinactive/bannedç”¨æˆ·
- è¿”å›ç©ºæƒé™ç»“æœ`{ isAdmin: false, roleLevel: 0, roles: [] }`
- `requireAdmin`ä¸­é—´ä»¶éªŒè¯`role_level < 100`ä¼šæ‹¦æˆªè¯·æ±‚

#### ğŸ“Š æ–¹æ¡ˆ3ä¼˜åŠ¿åˆ†æ(â­â­â­ 3æ˜Ÿæ¨è)

| è¯„ä»·ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|---------|------|------|
| **å®ç”¨ä¸»ä¹‰** | â­â­â­â­â­ | å®Œå…¨åˆ©ç”¨ç°æœ‰æœºåˆ¶ï¼Œæ— éœ€æ–°å¢ä»£ç  |
| **ä»£ç å¤æ‚åº¦** | â­â­â­â­â­ | æä½(ä»…1è¡Œä»£ç )ï¼Œè°ƒç”¨å·²æœ‰å‡½æ•° |
| **ç»´æŠ¤æˆæœ¬** | â­â­â­â­â­ | æä½ï¼Œæ— éœ€é¢å¤–ç»´æŠ¤ |
| **å­¦ä¹ æˆæœ¬** | â­â­â­â­â­ | æä½(10åˆ†é’Ÿå­¦ä¹ )ï¼Œè°ƒç”¨ç°æœ‰å‡½æ•° |
| **æ€§èƒ½è¡¨ç°** | â­â­â­â­ | è‰¯å¥½(æ— é¢å¤–æ€§èƒ½å¼€é”€) |
| **å¯é æ€§** | â­â­â­â­â­ | æé«˜ï¼Œåˆ©ç”¨ç°æœ‰æ•°æ®åº“statuséªŒè¯ |
| **æ‰©å±•æ€§** | â­â­â­ | ä¸€èˆ¬ï¼Œæ— æ³•æ”¯æŒä¸´æ—¶å°ç¦ç­‰é«˜çº§åŠŸèƒ½ |
| **ç«‹å³ç”Ÿæ•ˆ** | â­ | **å¦**ï¼Œæœ‰5-30åˆ†é’Ÿå»¶è¿Ÿ(ç¼“å­˜TTL) |
| **æŠ€æœ¯å€ºåŠ¡** | â­â­â­â­â­ | æ— ï¼Œå®Œå…¨åˆ©ç”¨ç°æœ‰æœºåˆ¶ |
| **ROI** | â­â­â­ | ä¸­ç­‰(å¼€å‘0.5hï¼Œä½†å°ç¦å»¶è¿Ÿé£é™©é«˜) |

**ç»¼åˆè¯„åˆ†**: â­â­â­ 3æ˜Ÿ(åŠæ ¼) - **åº”æ€¥æ–¹æ¡ˆ**

#### ğŸ’¡ æ–¹æ¡ˆ3æ ¸å¿ƒä¼˜åŠ¿

1. **å®æ–½æœ€ç®€å•**: ä»…éœ€1è¡Œä»£ç ï¼Œè°ƒç”¨å·²æœ‰å‡½æ•°
2. **æ”¹åŠ¨æœ€å°**: æ— éœ€æ–°å¢è¡¨ã€æ— éœ€æ–°å¢ä¾èµ–ã€æ— éœ€æ–°å¢æ¨¡å‹
3. **æŠ€æœ¯å€ºåŠ¡é›¶**: å®Œå…¨åˆ©ç”¨ç°æœ‰æœºåˆ¶
4. **ç»´æŠ¤æˆæœ¬æœ€ä½**: æ— éœ€é¢å¤–ç»´æŠ¤

#### âš ï¸ æ–¹æ¡ˆ3åŠ£åŠ¿åˆ†æ(æœ€ä¸¥é‡é—®é¢˜)

1. **å°ç¦å»¶è¿Ÿé£é™©**: æ¸…é™¤ç¼“å­˜åï¼Œç”¨æˆ·å¯èƒ½åœ¨5åˆ†é’Ÿå†…ä»å¯ä½¿ç”¨ç³»ç»Ÿ
   - **å»¶è¿Ÿæ¥æº**: 
     - å†…å­˜ç¼“å­˜TTL=5åˆ†é’Ÿ(memoryCache)
     - Redisç¼“å­˜TTL=30åˆ†é’Ÿ(ä½†æ¸…é™¤åä¼šé‡æŸ¥æ•°æ®åº“)
   - **å®é™…å»¶è¿Ÿ**: **æœ€é•¿5åˆ†é’Ÿ**(å†…å­˜ç¼“å­˜æœªè¿‡æœŸ)
   - **ä¸šåŠ¡å½±å“**: æ¶æ„ç”¨æˆ·åœ¨5åˆ†é’Ÿå†…ä»å¯ç»§ç»­ä½œå¼Š
   
2. **æ— æ³•æ”¯æŒä¸´æ—¶å°ç¦**: åªæœ‰æ°¸ä¹…å°ç¦(status='banned')å’Œä¸´æ—¶ç¦ç”¨(status='inactive')
   - **é™åˆ¶**: æ— æ³•è®¾ç½®30å¤©ä¸´æ—¶å°ç¦
   - **workaround**: æ‰‹åŠ¨åœ¨30å¤©åæ¢å¤status='active'

3. **æ— æ³•è¿½æº¯å°ç¦å†å²**: æ²¡æœ‰é»‘åå•è¡¨ï¼Œæ— æ³•æŸ¥è¯¢å†å²å°ç¦è®°å½•
   - **é™åˆ¶**: æ— æ³•å®¡è®¡"è°åœ¨ä»€ä¹ˆæ—¶é—´å°ç¦äº†è°"
   - **workaround**: ä¾èµ–æ“ä½œæ—¥å¿—(console.log)

#### ğŸ“ˆ æ–¹æ¡ˆ3å®é™…æ•°æ®é¢„ä¼°

**åŸºäºé¡¹ç›®çœŸå®ä¸šåŠ¡æ•°æ®**(ç”¨æˆ·<500äººï¼Œå°ç¦é¢‘æ¬¡æ¯å‘¨0-2æ¬¡):

| æ€§èƒ½æŒ‡æ ‡ | é¢„ä¼°å€¼ | é£é™©è¯„ä¼° | è¯´æ˜ |
|---------|--------|---------|------|
| å°ç¦å»¶è¿Ÿ | æœ€é•¿5åˆ†é’Ÿ | ğŸŸ  ä¸­é«˜é£é™© | æ¶æ„ç”¨æˆ·å¯èƒ½ç»§ç»­ä½œå¼Š5åˆ†é’Ÿ |
| ç¼“å­˜å¤±æ•ˆæ—¶é—´ | 5åˆ†é’Ÿ | ğŸŸ  ä¸­é«˜é£é™© | memoryCache TTL=5åˆ†é’Ÿ |
| æ€§èƒ½å¼€é”€ | 0ms | âœ… æ— å½±å“ | æ— é¢å¤–æ•°æ®åº“/RedisæŸ¥è¯¢ |
| ä»£ç æ”¹åŠ¨ | 1è¡Œ | âœ… æä½é£é™© | è°ƒç”¨å·²æœ‰å‡½æ•° |
| æŠ€æœ¯å€ºåŠ¡ | 0 | âœ… æ— å€ºåŠ¡ | å®Œå…¨åˆ©ç”¨ç°æœ‰æœºåˆ¶ |

---

## ğŸ¯ ä¸‰æ–¹æ¡ˆç»¼åˆå¯¹æ¯”æ€»ç»“

### ğŸ“Š æ ¸å¿ƒæŒ‡æ ‡å¯¹æ¯”è¡¨

| å¯¹æ¯”ç»´åº¦ | æ–¹æ¡ˆ1: æ•°æ®åº“é»‘åå• | æ–¹æ¡ˆ2: Redisé»‘åå• | æ–¹æ¡ˆ3: æ¸…é™¤ç¼“å­˜ |
|---------|-------------------|-------------------|----------------|
| **ç»¼åˆè¯„åˆ†** | â­â­â­â­â­ (5æ˜Ÿ) | â­â­â­â­ (4æ˜Ÿ) | â­â­â­ (3æ˜Ÿ) |
| **ä»£ç å¤æ‚åº¦** | ä½(50è¡Œ) | ä½(40è¡Œ) | æä½(1è¡Œ) |
| **ç»´æŠ¤æˆæœ¬** | æä½ | ä¸­ç­‰ | æä½ |
| **å­¦ä¹ æˆæœ¬** | æä½(1å°æ—¶) | ä½(1å°æ—¶) | æä½(10åˆ†é’Ÿ) |
| **æ€§èƒ½è¡¨ç°** | è‰¯å¥½(<20ms) | ä¼˜ç§€(<5ms) | è‰¯å¥½(0msé¢å¤–å¼€é”€) |
| **ç«‹å³ç”Ÿæ•ˆ** | âœ… æ˜¯ | âœ… æ˜¯ | âŒ å¦(5åˆ†é’Ÿå»¶è¿Ÿ) |
| **æ•°æ®æŒä¹…åŒ–** | âœ… æ˜¯(MySQL) | âš ï¸ å¦(Redis) | âœ… æ˜¯(ä¾èµ–status) |
| **Redisä¾èµ–** | âŒ æ— ä¾èµ– | âœ… ä¾èµ–Redis | âŒ æ— ä¾èµ– |
| **ä¸´æ—¶å°ç¦æ”¯æŒ** | âœ… æ˜¯(expires_at) | âœ… æ˜¯(TTL) | âš ï¸ æœ‰é™(æ‰‹åŠ¨æ¢å¤) |
| **å®¡è®¡è¿½æº¯** | âœ… å®Œæ•´(operator_id) | âš ï¸ æœ‰é™(éœ€é¢å¤–è®°å½•) | âŒ æ— (ä¾èµ–æ—¥å¿—) |
| **æŠ€æœ¯å€ºåŠ¡** | æä½ | ä½ | æ—  |
| **é€‚ç”¨åœºæ™¯** | **åç«¯æ•°æ®åº“é¡¹ç›®** | é«˜å¹¶å‘åœºæ™¯ | **åº”æ€¥ä¿®å¤** |
| **å¼€å‘å·¥æ—¶** | 2å°æ—¶ | 2å°æ—¶ | 0.5å°æ—¶ |
| **ROI** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |

### ğŸ¯ æ¨èå†³ç­–(åŸºäºå®ç”¨ä¸»ä¹‰åŸåˆ™)

#### ğŸ† æœ€ä½³æ–¹æ¡ˆ: **æ–¹æ¡ˆ1(æ•°æ®åº“é»‘åå•)** - â­â­â­â­â­

**ç†ç”±**:
1. **å®Œå…¨ç¬¦åˆé¡¹ç›®ç‰¹æ€§**: åç«¯æ•°æ®åº“é¡¹ç›®ï¼Œæ•°æ®åº“æ–¹æ¡ˆæœ€åˆç†
2. **æŠ€æœ¯æ ˆç»Ÿä¸€**: å®Œå…¨åŸºäºSequelize ORMï¼Œæ— éœ€å­¦ä¹ æ–°æŠ€æœ¯
3. **æ— Redisä¾èµ–é£é™©**: Rediså®•æœºä¸å½±å“å°ç¦åŠŸèƒ½
4. **æ•°æ®æŒä¹…åŒ–**: é»‘åå•æ•°æ®å­˜å‚¨åœ¨MySQLï¼Œå®•æœºä¸ä¸¢å¤±
5. **å®¡è®¡å®Œæ•´**: operator_idè®°å½•æ“ä½œè€…ï¼Œexpires_atæ”¯æŒä¸´æ—¶å°ç¦
6. **ç»´æŠ¤æˆæœ¬æä½**: æ ‡å‡†æ•°æ®åº“æ“ä½œï¼Œæ–°äºº1å°æ—¶å¯ç†è§£

**é€‚ç”¨é¡¹ç›®**:
- âœ… åç«¯æ•°æ®åº“é¡¹ç›®(å¦‚æœ¬é¡¹ç›®)
- âœ… ç”¨æˆ·è§„æ¨¡<5000äºº
- âœ… å°ç¦é¢‘æ¬¡ä½(æ¯å¤©<10æ¬¡)
- âœ… é‡è§†æ•°æ®æŒä¹…åŒ–å’Œå®¡è®¡

#### ğŸ¥ˆ å¤‡é€‰æ–¹æ¡ˆ: **æ–¹æ¡ˆ2(Redisé»‘åå•)** - â­â­â­â­

**ç†ç”±**:
1. **æ€§èƒ½æœ€ä¼˜**: RedisæŸ¥è¯¢<5msï¼Œæ€§èƒ½æœ€ä½³
2. **åˆ©ç”¨ç°æœ‰æŠ€æœ¯**: é¡¹ç›®å·²æœ‰UnifiedRedisClient
3. **é™çº§ä¿æŠ¤**: Rediså¤±è´¥æ—¶è‡ªåŠ¨é™çº§ä¸ºæ•°æ®åº“éªŒè¯

**é€‚ç”¨é¡¹ç›®**:
- âœ… é«˜å¹¶å‘åœºæ™¯(>100å¹¶å‘/ç§’)
- âœ… å¯¹æ€§èƒ½è¦æ±‚æé«˜(å“åº”æ—¶é—´<10ms)
- âœ… Redisç¨³å®šæ€§é«˜(é…ç½®RDB/AOFæŒä¹…åŒ–)

#### âš ï¸ åº”æ€¥æ–¹æ¡ˆ: **æ–¹æ¡ˆ3(æ¸…é™¤ç¼“å­˜)** - â­â­â­

**ç†ç”±**:
1. **å®æ–½æœ€å¿«**: ä»…éœ€1è¡Œä»£ç ï¼Œ0.5å°æ—¶å®Œæˆ
2. **æ”¹åŠ¨æœ€å°**: æ— éœ€æ–°å¢è¡¨ã€æ— éœ€æ–°å¢ä¾èµ–

**é€‚ç”¨é¡¹ç›®**:
- âš ï¸ ç´§æ€¥ä¿®å¤(æš‚æ—¶ç¼“è§£é—®é¢˜)
- âš ï¸ å°ç¦é¢‘æ¬¡æä½(æ¯æœˆ<1æ¬¡)
- âš ï¸ å¯æ¥å—5åˆ†é’Ÿå»¶è¿Ÿ

---

## ğŸ’¼ å®æ–½å»ºè®®(åŸºäºå®ç”¨ä¸»ä¹‰åŸåˆ™)

### ğŸš€ ç«‹å³å®æ–½æ–¹æ¡ˆ(ä¼˜å…ˆçº§P0 - 24å°æ—¶å†…å®Œæˆ)

**æ¨è**: **æ–¹æ¡ˆ1(æ•°æ®åº“é»‘åå•)** + **æ–¹æ¡ˆ3(æ¸…é™¤ç¼“å­˜)** ç»„åˆ

**å®æ–½æ­¥éª¤**:

#### Step 1: ç«‹å³ä¿®å¤(0.5å°æ—¶) - æ–¹æ¡ˆ3
```javascript
// routes/v4/unified-engine/admin/user_management.js ç¬¬247è¡Œæ·»åŠ 
await invalidateUserPermissions(user_id, `status changed to ${status}`)
```
- **ç›®çš„**: ç«‹å³ç¼“è§£é—®é¢˜ï¼Œå°ç¦åæ¸…é™¤ç¼“å­˜
- **æ•ˆæœ**: å°ç¦å5åˆ†é’Ÿå†…ç”Ÿæ•ˆ(ç¼“å­˜å¤±æ•ˆå)
- **å·¥æ—¶**: 0.5å°æ—¶

#### Step 2: å®Œæ•´ä¿®å¤(2å°æ—¶) - æ–¹æ¡ˆ1
```bash
# 1. åˆ›å»ºuser_blacklistæ¨¡å‹(0.5å°æ—¶)
touch models/UserBlacklist.js

# 2. åˆ›å»ºmigrationæ–‡ä»¶(0.5å°æ—¶)
npx sequelize-cli migration:generate --name create-user-blacklist-table

# 3. ä¿®æ”¹middleware/auth.jsæ·»åŠ é»‘åå•æ£€æŸ¥(0.5å°æ—¶)
# authenticateTokenå‡½æ•°ç¬¬347è¡Œä¹‹å‰æ·»åŠ é»‘åå•æŸ¥è¯¢

# 4. ä¿®æ”¹user_management.jsåŒæ­¥é»‘åå•(0.5å°æ—¶)
# PUT /users/:user_id/statusè·¯ç”±æ·»åŠ UserBlacklist.upserté€»è¾‘

# 5. æµ‹è¯•éªŒè¯(1å°æ—¶)
# - æµ‹è¯•å°ç¦ç”¨æˆ·åç«‹å³æ‹¦æˆª
# - æµ‹è¯•æ¢å¤ç”¨æˆ·åæ­£å¸¸è®¿é—®
# - æµ‹è¯•ä¸´æ—¶å°ç¦è¿‡æœŸè‡ªåŠ¨æ¢å¤
```
- **ç›®çš„**: å®Œæ•´è§£å†³é—®é¢˜ï¼Œå°ç¦ç«‹å³ç”Ÿæ•ˆ
- **æ•ˆæœ**: å°ç¦åç«‹å³ç”Ÿæ•ˆï¼Œæ— å»¶è¿Ÿ
- **å·¥æ—¶**: 2å°æ—¶

**æ€»å·¥æ—¶**: 2.5å°æ—¶(åŠå¤©å†…å®Œæˆ)

### ğŸ”„ é•¿æœŸä¼˜åŒ–æ–¹æ¡ˆ(ä¼˜å…ˆçº§P1 - 1å‘¨å†…å®Œæˆ)

**å¯é€‰**: æ–¹æ¡ˆ1 + æ–¹æ¡ˆ2ç»„åˆ(åŒé‡ä¿æŠ¤)

```javascript
// åŒæ—¶ä½¿ç”¨æ•°æ®åº“é»‘åå•å’ŒRedisé»‘åå•
// 1. Redisé»‘åå•(æ€§èƒ½ä¼˜åŒ–ï¼Œä¼˜å…ˆæ£€æŸ¥)
// 2. æ•°æ®åº“é»‘åå•(å¯é æ€§ä¿è¯ï¼Œé™çº§ä¿æŠ¤)

async function authenticateToken(req, res, next) {
  // ...
  const user_id = decoded.user_id

  // ç¬¬1å±‚: Redisé»‘åå•æ£€æŸ¥(æ€§èƒ½ä¼˜åŒ–ï¼Œ<5ms)
  if (redisClient) {
    const blacklisted = await redisClient.get(`auth:blacklist:${user_id}`)
    if (blacklisted) return res.status(401).json({ error: 'ACCOUNT_DISABLED' })
  }

  // ç¬¬2å±‚: æ•°æ®åº“é»‘åå•æ£€æŸ¥(å¯é æ€§ä¿è¯ï¼Œ<20ms)
  const blacklistEntry = await UserBlacklist.findOne({ where: { user_id } })
  if (blacklistEntry) return res.status(401).json({ error: 'ACCOUNT_DISABLED' })

  // ç»§ç»­åç»­éªŒè¯...
}
```

**ä¼˜ç‚¹**: 
- æ€§èƒ½æœ€ä¼˜(Redisä¼˜å…ˆ)
- å¯é æ€§æœ€é«˜(æ•°æ®åº“é™çº§)
- åŒé‡ä¿æŠ¤(Rediså®•æœºä¸å½±å“å°ç¦)

**ç¼ºç‚¹**:
- ä»£ç å¤æ‚åº¦ç•¥é«˜(ä¸¤å¤„é€»è¾‘)
- ç»´æŠ¤æˆæœ¬ç•¥é«˜(éœ€ç»´æŠ¤Rediså’Œæ•°æ®åº“ä¸€è‡´æ€§)

---

## ğŸ“‹ éªŒæ”¶æ ‡å‡†

### âœ… åŠŸèƒ½å®Œæ•´æ€§æµ‹è¯•

- [ ] **å°ç¦ç«‹å³ç”Ÿæ•ˆ**: å°ç¦ç”¨æˆ·åï¼Œç”¨æˆ·ç«‹å³æ— æ³•è®¿é—®å—ä¿æŠ¤æ¥å£(è¿”å›401 ACCOUNT_DISABLED)
- [ ] **æ¢å¤æ­£å¸¸è®¿é—®**: æ¢å¤ç”¨æˆ·åï¼Œç”¨æˆ·å¯æ­£å¸¸è®¿é—®ç³»ç»Ÿ
- [ ] **ä¸´æ—¶å°ç¦æ”¯æŒ**: ä¸´æ—¶å°ç¦ç”¨æˆ·ï¼Œè¿‡æœŸåè‡ªåŠ¨æ¢å¤
- [ ] **å®¡è®¡è¿½æº¯**: å¯æŸ¥è¯¢å†å²å°ç¦è®°å½•(operator_idã€created_at)
- [ ] **æ€§èƒ½è¾¾æ ‡**: å°ç¦æ£€æŸ¥å“åº”æ—¶é—´<50ms

### âš¡ æ€§èƒ½æ ‡å‡†éªŒè¯

- [ ] **æ•°æ®åº“æŸ¥è¯¢æ—¶é—´**: < 20ms(æ–¹æ¡ˆ1)
- [ ] **RedisæŸ¥è¯¢æ—¶é—´**: < 5ms(æ–¹æ¡ˆ2)
- [ ] **å¹¶å‘æ”¯æŒ**: 50+å¹¶å‘è¯·æ±‚å“åº”æ—¶é—´æ— æ˜æ˜¾å¢åŠ 
- [ ] **å†…å­˜å ç”¨**: < 20MB

### ğŸ›¡ï¸ å®‰å…¨æ€§éªŒè¯

- [ ] **å°ç¦æ— å»¶è¿Ÿ**: å°ç¦åç«‹å³æ‹¦æˆª(æ–¹æ¡ˆ1/2)æˆ–5åˆ†é’Ÿå†…æ‹¦æˆª(æ–¹æ¡ˆ3)
- [ ] **æ•°æ®æŒä¹…åŒ–**: Rediså®•æœºåé»‘åå•ä»ç”Ÿæ•ˆ(æ–¹æ¡ˆ1)
- [ ] **å®¡è®¡å®Œæ•´**: å¯è¿½æº¯æ“ä½œè€…å’Œæ“ä½œæ—¶é—´

---

## ğŸ“ æ–‡æ¡£ä¿¡æ¯

**æ–‡æ¡£ç‰ˆæœ¬**: V1.0(æ·±åº¦å¯¹æ¯”ç‰ˆ)  
**åˆ›å»ºæ—¶é—´**: 2025-11-07 22:15:30(åŒ—äº¬æ—¶é—´)  
**æœ€åæ›´æ–°**: 2025-11-07 22:15:30(åŒ—äº¬æ—¶é—´)  
**æ–‡æ¡£è¡Œæ•°**: 800+è¡Œ  
**ä½¿ç”¨æ¨¡å‹**: Claude Sonnet 4.5(Claude AI Assistant)  

**æ ¸å¿ƒä»·å€¼ä¸»å¼ **:
> "åç«¯æ•°æ®åº“é¡¹ç›®ï¼Œæ•°æ®åº“æ–¹æ¡ˆæœ€åˆç†"  
> "æ–¹æ¡ˆ1(æ•°æ®åº“é»‘åå•)å®Œå…¨ç¬¦åˆé¡¹ç›®ç‰¹æ€§ï¼ŒæŠ€æœ¯æ ˆç»Ÿä¸€ï¼Œç»´æŠ¤æˆæœ¬æä½"  
> "æ–¹æ¡ˆ2(Redisé»‘åå•)æ€§èƒ½æœ€ä¼˜ï¼Œä½†å¢åŠ Redisä¾èµ–é£é™©"  
> "æ–¹æ¡ˆ3(æ¸…é™¤ç¼“å­˜)ä»…é€‚åˆåº”æ€¥ä¿®å¤ï¼Œä¸å»ºè®®é•¿æœŸä½¿ç”¨"

**æ ¸å¿ƒåŸåˆ™**: å®ç”¨ä¸»ä¹‰ + æŠ€æœ¯æ ˆç»Ÿä¸€ + ç»´æŠ¤æˆæœ¬ä½ + æ•°æ®æŒä¹…åŒ– + å®¡è®¡å®Œæ•´

---

## ğŸ¯ å¿«é€Ÿå†³ç­–å‚è€ƒ

**å¦‚æœä½ æ˜¯åç«¯å¼€å‘è€…ï¼Œé¡¹ç›®ç”¨æˆ·<5000äººï¼Œå°ç¦é¢‘æ¬¡ä½**:
- âœ… é€‰æ‹© **æ–¹æ¡ˆ1(æ•°æ®åº“é»‘åå•)** - å®Œå…¨ç¬¦åˆé¡¹ç›®ç‰¹æ€§

**å¦‚æœä½ æ˜¯é«˜å¹¶å‘é¡¹ç›®ï¼Œç”¨æˆ·>10ä¸‡äººï¼Œå¯¹æ€§èƒ½è¦æ±‚æé«˜**:
- âœ… é€‰æ‹© **æ–¹æ¡ˆ2(Redisé»‘åå•)** - æ€§èƒ½æœ€ä¼˜

**å¦‚æœä½ éœ€è¦ç´§æ€¥ä¿®å¤ï¼Œæš‚æ—¶ç¼“è§£é—®é¢˜**:
- âš ï¸ é€‰æ‹© **æ–¹æ¡ˆ3(æ¸…é™¤ç¼“å­˜)** - å®æ–½æœ€å¿«ï¼Œä½†æœ‰å»¶è¿Ÿé£é™©

**æœ€ä½³å®è·µ**: **æ–¹æ¡ˆ1 + æ–¹æ¡ˆ3ç»„åˆ** (ç«‹å³ä¿®å¤ + å®Œæ•´è§£å†³)

