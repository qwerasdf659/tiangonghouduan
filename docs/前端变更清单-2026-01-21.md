# 前端变更清单 - 2026-01-21

## 概述

本文档记录了后端数据库项目重构过程中需要前端同步调整的API字段变更。这些变更旨在统一API契约、消除兼容性代码、提升代码质量。

---

## 1. 活动管理模块 (Campaign Module)

### 变更内容
- **移除字段**: `name`
- **保留字段**: `campaign_name`

### 详细说明
原有API返回同时包含 `name` 和 `campaign_name` 两个字段用于兼容，现统一为 `campaign_name`。

### 影响的API
```
GET  /api/v4/campaigns
GET  /api/v4/campaigns/:id
GET  /api/v4/console/campaigns
POST /api/v4/console/campaigns
PUT  /api/v4/console/campaigns/:id
```

### 前端调整
```javascript
// ❌ 旧代码（已废弃）
const campaignName = campaign.name || campaign.campaign_name

// ✅ 新代码（统一使用）
const campaignName = campaign.campaign_name
```

---

## 2. 市场挂单模块 (Market Listing Module)

### 变更内容
- **移除字段**: `offer_item_meta` 的 rarity 回退逻辑
- **保留字段**: `offer_item_rarity`, `rarity`, `rarity_code`

### 详细说明
原有代码存在 `listing.offerItem?.meta?.rarity` 的回退逻辑，现已移除。稀有度统一从 `offer_item_rarity` 字段获取。

### 影响的API
```
GET  /api/v4/market/listings
GET  /api/v4/market/listings/:id
GET  /api/v4/console/market/listings
```

### 前端调整
```javascript
// ❌ 旧代码（已废弃）
const rarity = listing.rarity || listing.offer_item_rarity || listing.offerItem?.meta?.rarity

// ✅ 新代码（统一使用）
const rarity = listing.rarity        // 直接使用 rarity 字段
const rarityCode = listing.rarity_code  // 或使用 rarity_code 字段
```

---

## 3. 抽奖监控模块 (Lottery Monitoring Module)

### 变更内容
- **新增字段**: `empty_count`（真正空奖统计）
- **字段语义变更**: `fallback_tier_count`（仅统计保底档位，不再包含空奖）

### 详细说明
原有 `fallback_tier_count` 同时包含空奖和保底档位，现拆分为两个独立字段：
- `empty_count`: 真正空奖（无任何奖品）
- `fallback_tier_count`: 保底档位（有奖品但价值较低）

### 影响的API
```
GET /api/v4/console/lottery-monitoring/dashboard
GET /api/v4/console/lottery-monitoring/statistics
```

### 前端调整
```javascript
// ❌ 旧代码（需更新）
const noWinCount = stats.fallback_tier_count

// ✅ 新代码（分开统计）
const emptyCount = stats.empty_count        // 真正空奖
const fallbackCount = stats.fallback_tier_count  // 保底档位
const totalNoHighWin = emptyCount + fallbackCount  // 如需汇总
```

---

## 4. 审计日志模块 (Audit Log Module)

### 变更内容
- **移除兼容映射**: `TARGET_TYPE_LEGACY_MAPPING` 已删除
- **统一格式**: `target_type` 字段全部使用 `snake_case`

### 详细说明
原有代码包含 PascalCase 到 snake_case 的兼容映射（如 `UserInventory` → `user_inventory`），现已移除。数据库中所有 `target_type` 值已统一为 `snake_case` 格式。

### 影响的API
```
GET /api/v4/console/audit-logs
GET /api/v4/console/audit-logs/:id
```

### 前端调整
```javascript
// 前端代码无需变更
// target_type 返回值保持一致（snake_case）
// 示例值：'user_inventory', 'lottery_draw', 'market_listing'
```

---

## 5. 命名规范统一

### 全局变更
- **数据库字段**: 全部使用 `snake_case`
- **API响应字段**: 全部使用 `snake_case`
- **主键字段格式**: `{table_name}_id`（如 `user_id`, `prize_id`, `campaign_id`）

### 注意事项
- 前端展示时可自行转换为 camelCase，但API交互必须使用 snake_case
- `DataSanitizer` 模块为安全考虑，对外暴露字段使用通用 `id` 而非具体表名前缀

---

## 迁移时间线

| 阶段 | 时间 | 内容 |
|------|------|------|
| 后端部署 | 2026-01-21 | 本次变更已部署完成 |
| 前端适配 | 建议尽快 | 更新字段引用 |
| 兼容期截止 | 无 | 已无兼容代码，请尽快更新 |

---

## 联系方式

如有问题，请联系后端开发团队。

---

*文档生成时间: 2026-01-21*
*项目版本: V4.0.0*

