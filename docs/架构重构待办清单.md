
### 说明
- **来源**：本清单仅基于当前仓库代码状态（`app.js` / `routes/*` / `services/*` / `models/*` / `migrations/*`）检查结果整理。
- **目标**：按《`docs/路由层、模型层、服务层、数据一致性文档.md`》的 P0/P1 规范收敛后端分层、资产一致性与可追溯性。

---

### P0（必须立刻处理：会导致业务错误/一致性风险/线上事故）

- [ ] **兑换市场虚拟价值扣减逻辑：总额足够仍可能兑换失败**
  - **问题**：`ExchangeMarketService._getUserTotalVirtualValue()` 通过 `SUM(UserInventory.value)` 判断足够，但 `_deductVirtualValue()` 不支持“部分消耗”，当存在单个大额虚拟奖品时会错误失败（“余额足够但扣不动”）。
  - **涉及**：`services/ExchangeMarketService.js`（`_getUserTotalVirtualValue`、`_deductVirtualValue`、`exchangeItem`）。
  - **验收**：当用户只有 1 条 `UserInventory.value=10` 且需扣 5 时，兑换成功；扣减后库存/价值一致且可追溯（支持“拆分找零”或“value 递减”）。

- [ ] **兑换市场字段命名/attributes 与模型不一致，可能直接导致 API 500**
  - **问题**：`ExchangeItem` 模型字段为 `name/description`，但 `ExchangeMarketService` 视图常量与管理创建/更新逻辑使用 `item_name/item_description`，会触发查询 attributes 或写入字段时报错。
  - **涉及**：`models/ExchangeItem.js`、`services/ExchangeMarketService.js`、`services/DataSanitizer.js`、`routes/v4/unified-engine/exchange_market.js`。
  - **验收**：以下接口可稳定返回 200（含分页/脱敏）：
    - `GET /api/v4/exchange_market/items`
    - `GET /api/v4/exchange_market/items/:item_id`
    - 管理端商品创建/更新接口（`routes/v4/unified-engine/admin/marketplace.js` 对应）。

- [ ] **鉴权/权限中间件未使用统一 ApiResponse，响应格式不一致**
  - **问题**：路由层普遍使用 `res.apiSuccess/res.apiError`，但 `middleware/auth.js` 中 `authenticateToken/requireAdmin/requirePermission` 仍使用 `res.status().json(...)`，违反统一响应规范。
  - **涉及**：`middleware/auth.js`（及所有依赖其错误格式的调用方）。
  - **验收**：鉴权失败/权限不足/Token过期等错误均通过 `res.apiError(...)` 输出统一结构；前端无需兼容两套错误格式。

- [ ] **兑换市场“禁止积分支付”的语义仍在入口/模型总注释中残留，容易诱发未来逻辑走偏**
  - **问题**：虽然 migrations 已将 `price_type/payment_type` 收敛为 `virtual`，但：
    - `app.js` 仍记录“积分/混合支付兑换系统”的 note；
    - `models/index.js` 对 `ExchangeItem/ExchangeMarketRecord` 的注释仍描述“支持积分/混合支付”。
  - **涉及**：`app.js`、`models/index.js`。
  - **验收**：代码语义与规范一致：兑换市场明确“只支持 virtual，禁止 points/mixed”，避免后续开发误引入 points 参数或逻辑。

---

### P1（高优先级：短期可运行但会积累事故/技术债）

- [ ] **兑换市场敏感操作补齐审计日志（可追溯性）**
  - **问题**：兑换市场订单创建/状态变更等敏感路径未看到 `AuditLogService` 记录（至少在 `exchangeItem`/`updateOrderStatus` 等路径）。
  - **涉及**：`services/ExchangeMarketService.js`、`services/AuditLogService.js`。
  - **验收**：订单创建、订单状态更新、关键失败（幂等冲突/库存不足/虚拟价值不足）均具备可定位的审计记录（包含 `business_id`、`order_no`、`user_id`、操作人等关键字段）。

- [ ] **兑换市场 `business_id` 数据库层防呆加强**
  - **问题**：模型允许 `business_id` 为 NULL 且 unique（MySQL 允许多条 NULL），旁路写入/异常迁移可能破坏幂等基线。
  - **涉及**：`models/ExchangeMarketRecord.js`、相关 migrations（如 `migrations/20251212000000-add-exchange-market-records-business-id.js`）。
  - **验收**：`business_id` 在创建订单路径上**强制非空**；数据库层能阻断 NULL/重复等破坏幂等的写入。

- [ ] **北京时间规范：避免使用 `toISOString().split('T')[0]` 进行业务日期计算**
  - **问题**：仓库内存在多处 `toISOString()` 用于日期字符串切割/统计边界，存在北京时区跨日偏移风险。
  - **涉及**：`services/ReportingService.js`、`services/PointsService.js`、`routes/v4/statistics.js` 等（按 grep 命中点逐一整改）。
  - **验收**：所有“业务日期/统计区间”计算统一走 `utils/timeHelper` 或明确 `Asia/Shanghai` 的格式化输出；UTC 字符串仅用于日志/传输且不参与“按天统计”的边界判断。

- [ ] **迁移脚本来源收敛：避免混用手工 SQL 与 Sequelize migrations 导致库结构漂移**
  - **问题**：存在 `migrations/20251206_dual_account_system.sql`（包含 points/mixed、额外字段），与当前 JS migrations/模型“只支持 virtual”的最终形态不一致，容易被误执行导致环境分裂。
  - **涉及**：`migrations/20251206_dual_account_system.sql`、`migrations/README.md`（如需增加约束说明）。
  - **验收**：明确“生产/正式环境只允许通过 sequelize migrations 执行”的唯一入口；手工 SQL 脚本被标注为 deprecated/仅历史用途，避免误用。

---

### P2（可排期优化：提升一致性与可维护性）

- [ ] **兑换市场返回结构与字段命名统一（service ↔ sanitizer ↔ route）**
  - **目标**：统一 `ExchangeItem` 的输出字段（name/description vs item_name/item_description）、订单快照字段命名一致，减少兼容分支与隐性 bug。
  - **涉及**：`services/ExchangeMarketService.js`、`services/DataSanitizer.js`、`routes/v4/unified-engine/exchange_market.js`。


