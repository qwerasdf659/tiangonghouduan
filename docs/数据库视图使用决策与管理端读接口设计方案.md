# 数据库视图使用决策与管理端读接口设计方案

> **文档版本**: 1.0.0  
> **创建时间**: 2025-12-27  
> **文档性质**: 架构决策记录 (ADR) + 技术方案  
> **适用范围**: 全项目数据库设计与管理端API设计  
> **基准**: 当前代码状态 + 真实数据库状态（2025-12-27）

---

## 一、当前项目数据库状态（真实现状）

### 1.1 数据库视图现状

**结论：当前项目不使用数据库视图**

```sql
-- 实际查询结果（2025-12-27）
SELECT TABLE_NAME FROM information_schema.VIEWS
WHERE TABLE_SCHEMA = 'restaurant_points_dev';
-- 结果：0 行（无任何视图）
```

**历史视图清理记录**：

- `v_legacy_material_balances`：已删除（迁移文件：`archived/20251215180000-phase4-drop-old-material-diamond-tables.js`）
- `v_legacy_diamond_accounts`：已删除（同上）
- 清理原因：暴力重构，去除迁移双轨兼容代码

### 1.2 核心业务表现状

| 表名                          | 行数   | 用途             | 是否核心链路    |
| ----------------------------- | ------ | ---------------- | --------------- |
| `lottery_campaigns`           | 未统计 | 抽奖活动配置     | ✅ 是           |
| `lottery_prizes`              | 9      | 奖品池配置       | ✅ 是           |
| `lottery_draws`               | 3,350  | 抽奖记录         | ✅ 是           |
| `lottery_draw_quota_rules`    | 未统计 | 配额规则         | ✅ 是           |
| `lottery_management_settings` | 未统计 | 管理干预配置     | ✅ 是           |
| `item_instances`              | 817    | 物品实例（背包） | ✅ 是           |
| `redemption_orders`           | 293    | 核销订单         | ✅ 是           |
| `accounts`                    | 12     | 账户主体         | ✅ 是           |
| `account_asset_balances`      | 15     | 资产余额         | ✅ 是           |
| `asset_transactions`          | 0      | 资产流水         | ✅ 是（未启用） |
| `market_listings`             | 1      | 市场挂牌         | ✅ 是           |
| `trade_orders`                | 0      | 交易订单         | ✅ 是（未启用） |
| `points_transactions`         | 70     | 积分流水         | ✅ 是           |

### 1.3 迁移管理现状

- **迁移元数据表**：`sequelizemeta`（全小写，179 条迁移记录）
- **迁移工具**：Sequelize CLI + 自定义脚本（`scripts/run_pending_migrations.js`）
- **已知问题**：存在"迁移已记录但表不存在"的漂移（如 `user_asset_accounts` 已记录创建但实际不存在）

---

## 二、数据库视图使用决策（基于行业实践）

### 2.1 大公司实践（美团/腾讯/阿里/字节）

#### 核心业务链路（OLTP）

**不使用视图**，原因：

- **强一致性要求**：交易、扣减、结算需要事务保证，视图无法参与写链路
- **灰度发布需求**：口径变更需要代码灰度，视图变更是全量生效
- **审计追责要求**：口径逻辑在代码里，可追溯、可回滚、可 Code Review
- **性能可控性**：索引、查询计划优化在应用层控制，视图可能引入不可预期的执行计划

#### 数据分析/报表层

**大量使用视图或物化视图**，但在独立的分析库/数仓：

- **数仓层**：Hive/ClickHouse/Doris 等，用视图做口径统一
- **OLTP 报表库**：主从分离，从库上建只读视图给 BI/运营看板
- **物化视图**：定时刷新的汇总表（本质是表，不是实时视图）

#### 典型架构

```
OLTP 主库（核心业务）
  ↓ Binlog/CDC
数仓/分析库（报表/BI）
  ↓ 在这里建视图/物化视图
管理后台/运营看板
```

### 2.2 小公司/创业团队实践

#### 初期（业务简单、数据量小）

**可能直接在 OLTP 用视图**：

- 省开发成本（不用写复杂 join 代码）
- 团队小，口径变更频率低
- 数据量小，性能压力不大

#### 成长期（业务复杂化）

**逐步去视图，改为服务层聚合**：

- 口径变更频繁，视图成为负担
- 需要灰度、回滚，视图无法支持
- 性能优化需要精细控制查询计划
- **最终演化成大公司架构**

### 2.3 游戏公司实践（虚拟物品交易/背包/拍卖行）

#### 核心交易链路

**绝对不用视图**：

- **背包所有权**（`item_instances`）：单表真相，状态机管理
- **交易订单**（`trade_orders`）：幂等、事务、对账，必须是表
- **资产余额**（`account_asset_balances`）：冻结/解冻/扣减，必须是表
- **流水审计**（`asset_transactions`）：不可变记录，必须是表

#### 运营/数据分析

**可能用视图或汇总表**：

- 活动效果统计（参与率/消耗率/ROI）
- 经济系统监控（通货膨胀/资产分布）
- 玩家行为分析（付费/活跃/流失）

#### 典型设计

```sql
-- ❌ 不会这样做（核心链路用视图）
CREATE VIEW v_user_backpack AS
SELECT ... FROM item_instances JOIN ...;

-- ✅ 会这样做（报表层用视图）
CREATE VIEW v_daily_economy_report AS
SELECT DATE(created_at), asset_code, SUM(delta_amount), ...
FROM asset_transactions
GROUP BY DATE(created_at), asset_code;
```

### 2.4 活动策划公司/小众二手平台

#### 活动平台特点

- **活动周期短**：口径可能每次活动都变，视图反而增加维护成本
- **更倾向**：缓存聚合结果（Redis）+ 定时任务汇总 + 简化统计表

#### 二手平台特点

- **交易链路**：同游戏交易，不用视图
- **搜索/筛选**：可能用 Elasticsearch 等搜索引擎，而不是视图
- **对账/报表**：可能用视图或离线汇总

---

## 三、本项目视图使用决策

### 3.1 决策结论

**主策略：不使用视图作为核心业务读接口方案**

**理由**（基于当前项目真实状态）：

1. **迁移管理尚不稳定**：存在"迁移记录与真实表不一致"的漂移，引入视图会放大问题
2. **暴力重构目标**：正在清理双轨/兼容代码，视图容易成为新的"隐藏双轨"
3. **业务迭代频繁**：活动配置、交易规则、资产类型仍在演进，视图口径难以版本化
4. **团队规模/工具链**：Sequelize ORM + Service 层已足够，视图增加认知负担
5. **数据量级**：当前最大表 3,350 行，join/聚合性能压力不大

### 3.2 可选场景（未来考虑）

当满足以下**全部条件**时，可引入少量只读视图：

- [ ] 迁移管理已规范化（`sequelizemeta` 大小写统一、迁移与表完全一致）
- [ ] 口径已稳定 3 个月以上（不再频繁变更统计维度）
- [ ] 数据量达到百万级（join 性能成为瓶颈）
- [ ] 有专人负责视图版本管理（迁移文件里 CREATE/ALTER/DROP VIEW）
- [ ] 仅用于只读报表（不参与任何写链路判断）

**推荐场景示例**：

```sql
-- ✅ 可以考虑的视图（固定报表口径）
CREATE VIEW v_daily_lottery_stats AS
SELECT
  DATE(ld.created_at) AS stat_date,
  lc.campaign_code,
  lc.campaign_name,
  COUNT(DISTINCT ld.user_id) AS participants,
  COUNT(ld.draw_id) AS total_draws,
  SUM(CASE WHEN ld.is_win = 1 THEN 1 ELSE 0 END) AS win_count,
  SUM(CASE WHEN ld.is_win = 1 THEN lp.prize_value ELSE 0 END) AS total_prize_value
FROM lottery_draws ld
JOIN lottery_campaigns lc ON ld.campaign_id = lc.campaign_id
LEFT JOIN lottery_prizes lp ON ld.prize_id = lp.prize_id
GROUP BY DATE(ld.created_at), lc.campaign_code, lc.campaign_name;
```

---

## 四、管理端读接口设计方案（不用视图）

### 4.1 核心设计原则

- **路由层 → Service 层 → Sequelize 查表 → 组装返回**
- **聚合在服务层完成**（不依赖视图）
- **必要时用 Redis 缓存结果**（TTL 30~300 秒）
- **分页/筛选/排序白名单**（防注入/慢查询）

### 4.2 管理端"抽奖活动配置"读接口设计

#### A. 活动列表接口（列表页）

```javascript
/**
 * GET /api/v4/admin/lottery/campaigns
 *
 * 查询参数：
 * - status: 'active' | 'draft' | 'paused' | 'completed' | 'all'
 * - campaign_type: 'daily' | 'weekly' | 'event' | 'permanent'
 * - page: 页码（默认 1）
 * - page_size: 每页条数（默认 20，最大 100）
 * - include_stats: 是否包含统计信息（0/1，默认 1）
 *
 * 返回数据结构：
 */
{
  "success": true,
  "code": "SUCCESS",
  "message": "活动列表获取成功",
  "data": {
    "campaigns": [
      {
        "campaign_id": 1,
        "campaign_code": "daily_2025",
        "campaign_name": "每日签到抽奖",
        "campaign_type": "daily",
        "status": "active",
        "start_time": "2025-01-01T00:00:00.000+08:00",
        "end_time": "2025-12-31T23:59:59.000+08:00",
        "cost_per_draw": 10,
        "max_draws_per_user_daily": 3,
        "banner_image_url": "https://...",

        // 统计信息（include_stats=1 时返回）
        "stats": {
          "total_participants": 150,
          "total_draws": 450,
          "total_prizes_awarded": 45,
          "win_rate": 10.0,
          "remaining_prize_pool": 5000.00
        },

        // 活动状态（实时计算）
        "runtime_status": {
          "is_active": true,
          "is_upcoming": false,
          "is_ended": false,
          "remaining_minutes": 43200,
          "progress_percent": 75.5
        }
      }
    ],
    "pagination": {
      "page": 1,
      "page_size": 20,
      "total": 5,
      "total_pages": 1
    }
  },
  "timestamp": "2025-12-27T10:30:00.000+08:00"
}
```

**后端实现（不用视图）**：

```javascript
// routes/v4/admin/lottery-campaigns.js
router.get(
  '/campaigns',
  adminAuthMiddleware,
  asyncHandler(async (req, res) => {
    const { status, campaign_type, page = 1, page_size = 20, include_stats = '1' } = req.query

    // 通过 Service 层查询（不用视图）
    const AdminLotteryService = req.app.locals.services.getService('adminLottery')
    const result = await AdminLotteryService.getCampaignList({
      status,
      campaign_type,
      page: parseInt(page),
      page_size: Math.min(parseInt(page_size), 100),
      include_stats: include_stats === '1'
    })

    return res.apiSuccess(result, '活动列表获取成功')
  })
)
```

**Service 层实现（Sequelize 聚合查询）**：

```javascript
// services/AdminLotteryService.js
static async getCampaignList(options = {}) {
  const { status, campaign_type, page, page_size, include_stats } = options;
  const { LotteryCampaign } = models;
  const { Op } = models.sequelize.Sequelize;

  // 构建查询条件
  const where = {};
  if (status && status !== 'all') where.status = status;
  if (campaign_type) where.campaign_type = campaign_type;

  // 分页查询
  const offset = (page - 1) * page_size;
  const { count, rows: campaigns } = await LotteryCampaign.findAndCountAll({
    where,
    order: [['start_time', 'DESC']],
    limit: page_size,
    offset,
    // 可选：包含奖品信息（用 Sequelize include，不用视图）
    include: include_stats ? [{
      model: models.LotteryPrize,
      as: 'prizes',
      attributes: ['prize_id', 'prize_name', 'status', 'remaining_quantity']
    }] : []
  });

  // 组装返回数据（在代码里聚合，不在视图里）
  const campaignsWithStats = campaigns.map(campaign => {
    const summary = campaign.toSummary(); // Model 层方法
    return {
      ...summary,
      // 如果需要更多统计，在这里补充查询或计算
    };
  });

  return {
    campaigns: campaignsWithStats,
    pagination: {
      page,
      page_size,
      total: count,
      total_pages: Math.ceil(count / page_size)
    }
  };
}
```

---

#### B. 活动配置详情接口（详情页/编辑页）

```javascript
/**
 * GET /api/v4/admin/lottery/campaigns/:campaign_code/config
 *
 * 查询参数：
 * - include: 'prizes,quota_rules,management,draw_stats'（逗号分隔，按需加载）
 *
 * 返回数据结构：
 */
{
  "success": true,
  "code": "SUCCESS",
  "message": "活动配置获取成功",
  "data": {
    // A. 活动基本配置（来自 lottery_campaigns 表）
    "campaign": {
      "campaign_id": 1,
      "campaign_code": "daily_2025",
      "campaign_name": "每日签到抽奖",
      "campaign_type": "daily",
      "status": "active",
      "cost_per_draw": 10,
      "max_draws_per_user_daily": 3,
      "max_draws_per_user_total": null,
      "start_time": "2025-01-01T00:00:00.000+08:00",
      "end_time": "2025-12-31T23:59:59.000+08:00",
      "daily_reset_time": "00:00:00",
      "banner_image_url": "https://...",
      "description": "每日签到即可参与抽奖...",
      "rules_text": "1. 每日最多抽3次...",
      "participation_conditions": {
        "user_points": { "operator": ">=", "value": 100 }
      },
      "condition_error_messages": {
        "user_points": "您的积分不足100分，快去消费获取积分吧！"
      },
      "total_prize_pool": 10000.00,
      "remaining_prize_pool": 5000.00,
      "total_participants": 150,
      "total_draws": 450,
      "total_prizes_awarded": 45,
      "created_at": "2025-01-01T00:00:00.000+08:00",
      "updated_at": "2025-12-27T10:00:00.000+08:00"
    },

    // B. 奖品池配置（来自 lottery_prizes 表，include=prizes 时返回）
    "prizes": [
      {
        "prize_id": 1,
        "prize_name": "100积分",
        "prize_type": "points",
        "prize_value": 100.00,
        "win_probability": 0.50,
        "stock_quantity": 1000,
        "remaining_quantity": 850,
        "sort_order": 1,
        "status": "active",
        "image_url": "https://...",
        "description": "直接发放到积分账户"
      },
      {
        "prize_id": 2,
        "prize_name": "红水晶碎片",
        "prize_type": "virtual",
        "prize_value": 50.00,
        "win_probability": 0.30,
        "material_asset_code": "red_shard",
        "material_asset_amount": 10,
        "stock_quantity": 500,
        "remaining_quantity": 400,
        "sort_order": 2,
        "status": "active"
      }
    ],

    // C. 配额规则（来自 lottery_draw_quota_rules 表，include=quota_rules 时返回）
    "quota_rules": [
      {
        "rule_id": 1,
        "scope_type": "global",
        "scope_id": null,
        "daily_limit": 3,
        "effective_from": "2025-01-01T00:00:00.000+08:00",
        "effective_until": null,
        "status": "active",
        "priority": 1000
      },
      {
        "rule_id": 5,
        "scope_type": "user",
        "scope_id": 10001,
        "daily_limit": 10,
        "effective_from": "2025-12-01T00:00:00.000+08:00",
        "effective_until": "2025-12-31T23:59:59.000+08:00",
        "status": "active",
        "priority": 4000,
        "reason": "VIP用户补偿"
      }
    ],

    // D. 管理干预配置（来自 lottery_management_settings 表，include=management 时返回）
    "management_settings": [
      {
        "setting_id": 1,
        "setting_type": "force_win",
        "user_id": 10001,
        "campaign_id": 1,
        "prize_id": 2,
        "status": "active",
        "expires_at": "2025-12-31T23:59:59.000+08:00",
        "created_by": 1,
        "reason": "客服补偿"
      }
    ],

    // E. 抽奖统计（来自 lottery_draws 表聚合，include=draw_stats 时返回）
    "draw_stats": {
      "today": {
        "draws": 50,
        "wins": 5,
        "win_rate": 10.0,
        "participants": 30
      },
      "last_7_days": {
        "draws": 350,
        "wins": 35,
        "win_rate": 10.0,
        "participants": 120
      }
    }
  },
  "timestamp": "2025-12-27T10:30:00.000+08:00"
}
```

**后端实现（Service 层聚合，不用视图）**：

```javascript
// services/AdminLotteryService.js
static async getCampaignConfig(campaign_code, options = {}) {
  const { include = '' } = options;
  const includeSet = new Set(include.split(',').map(s => s.trim()).filter(Boolean));

  const { LotteryCampaign, LotteryPrize, LotteryDrawQuotaRule,
          LotteryManagementSetting, LotteryDraw } = models;
  const { Op } = models.sequelize.Sequelize;

  // 1. 查询活动基本信息
  const campaign = await LotteryCampaign.findOne({
    where: { campaign_code }
  });

  if (!campaign) {
    throw new Error('活动不存在');
  }

  const result = {
    campaign: campaign.toJSON()
  };

  // 2. 按需加载奖品池（不用视图，用 Sequelize include）
  if (includeSet.has('prizes')) {
    const prizes = await LotteryPrize.findAll({
      where: { campaign_id: campaign.campaign_id },
      order: [['sort_order', 'ASC']],
      include: [{
        model: models.ImageResources,
        as: 'image',
        attributes: ['image_url']
      }]
    });
    result.prizes = prizes.map(p => p.toJSON());
  }

  // 3. 按需加载配额规则
  if (includeSet.has('quota_rules')) {
    const quotaRules = await LotteryDrawQuotaRule.findAll({
      where: {
        [Op.or]: [
          { scope_type: 'global' },
          { scope_type: 'campaign', scope_id: campaign.campaign_id }
        ],
        status: 'active'
      },
      order: [['priority', 'DESC']]
    });
    result.quota_rules = quotaRules.map(r => r.toJSON());
  }

  // 4. 按需加载管理干预配置
  if (includeSet.has('management')) {
    const managementSettings = await LotteryManagementSetting.findAll({
      where: {
        campaign_id: campaign.campaign_id,
        status: 'active',
        [Op.or]: [
          { expires_at: null },
          { expires_at: { [Op.gt]: new Date() } }
        ]
      }
    });
    result.management_settings = managementSettings.map(s => s.toJSON());
  }

  // 5. 按需加载抽奖统计（聚合查询，不用视图）
  if (includeSet.has('draw_stats')) {
    const now = BeijingTimeHelper.createBeijingTime();
    const todayStart = new Date(now);
    todayStart.setHours(0, 0, 0, 0);

    const sevenDaysAgo = new Date(now);
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

    // 今日统计
    const todayStats = await LotteryDraw.findAll({
      where: {
        campaign_id: campaign.campaign_id,
        created_at: { [Op.gte]: todayStart }
      },
      attributes: [
        [models.sequelize.fn('COUNT', models.sequelize.col('draw_id')), 'draws'],
        [models.sequelize.fn('COUNT', models.sequelize.fn('DISTINCT', models.sequelize.col('user_id'))), 'participants'],
        [models.sequelize.fn('SUM', models.sequelize.literal('CASE WHEN is_win = 1 THEN 1 ELSE 0 END')), 'wins']
      ],
      raw: true
    });

    // 近7天统计
    const weekStats = await LotteryDraw.findAll({
      where: {
        campaign_id: campaign.campaign_id,
        created_at: { [Op.gte]: sevenDaysAgo }
      },
      attributes: [
        [models.sequelize.fn('COUNT', models.sequelize.col('draw_id')), 'draws'],
        [models.sequelize.fn('COUNT', models.sequelize.fn('DISTINCT', models.sequelize.col('user_id'))), 'participants'],
        [models.sequelize.fn('SUM', models.sequelize.literal('CASE WHEN is_win = 1 THEN 1 ELSE 0 END')), 'wins']
      ],
      raw: true
    });

    result.draw_stats = {
      today: {
        draws: parseInt(todayStats[0].draws) || 0,
        wins: parseInt(todayStats[0].wins) || 0,
        win_rate: todayStats[0].draws > 0 ? (todayStats[0].wins / todayStats[0].draws * 100).toFixed(2) : 0,
        participants: parseInt(todayStats[0].participants) || 0
      },
      last_7_days: {
        draws: parseInt(weekStats[0].draws) || 0,
        wins: parseInt(weekStats[0].wins) || 0,
        win_rate: weekStats[0].draws > 0 ? (weekStats[0].wins / weekStats[0].draws * 100).toFixed(2) : 0,
        participants: parseInt(weekStats[0].participants) || 0
      }
    };
  }

  return result;
}
```

---

#### C. 奖品池详情接口（已有）

```javascript
/**
 * GET /api/v4/admin/prize-pool/:campaign_code
 *
 * 现有实现：routes/v4/admin/prize_pool.js
 * Service：PrizePoolService.getPrizesByCampaign(campaign_code)
 *
 * 查询逻辑：
 * 1. 查询 lottery_campaigns（验证活动存在）
 * 2. 查询 lottery_prizes（WHERE campaign_id = ?）
 * 3. 可选 include ImageResources（奖品图片）
 * 4. 组装返回（不用视图）
 */
```

---

### 4.3 其他管理端常见读接口（不用视图）

#### 用户管理

```javascript
// GET /api/v4/admin/user_management/users?page=1&page_size=20&role=admin
// 查询：users + user_roles + roles（Sequelize include）
// 不用视图
```

#### 库存/背包管理

```javascript
// GET /api/v4/admin/inventory/items?user_id=10001&status=available
// 查询：item_instances（WHERE owner_user_id = ? AND status = ?）
// 可选 include：products / exchange_items（奖品信息）
// 不用视图
```

#### 交易市场管理

```javascript
// GET /api/v4/admin/marketplace/listings?status=on_sale&page=1
// 查询：market_listings + item_instances（Sequelize include）
// 不用视图
```

#### 订单/核销管理

```javascript
// GET /api/v4/admin/redemption/orders?status=active&page=1
// 查询：redemption_orders + item_instances
// 不用视图
```

#### 资产/流水管理

```javascript
// GET /api/v4/admin/assets/accounts?user_id=10001
// 查询：accounts + account_asset_balances（Sequelize include）
// 不用视图

// GET /api/v4/admin/assets/transactions?account_id=...&page=1
// 查询：asset_transactions（WHERE account_id = ?）
// 不用视图
```

---

### 4.4 性能优化方案（不依赖视图）

#### 方案 1：Redis 缓存聚合结果

```javascript
// 缓存活动列表（TTL 300 秒）
const cacheKey = `admin:lottery:campaigns:${status}:${page}`
let result = await redisClient.get(cacheKey)

if (!result) {
  result = await AdminLotteryService.getCampaignList(options)
  await redisClient.setex(cacheKey, 300, JSON.stringify(result))
}

return res.apiSuccess(JSON.parse(result), '活动列表获取成功（缓存）')
```

#### 方案 2：定时任务预汇总（替代物化视图）

```javascript
// 定时任务：每小时汇总一次统计数据到 daily_lottery_stats 表
// cron: '0 * * * *'
async function aggregateLotteryStats() {
  const stats = await LotteryDraw.findAll({
    where: { created_at: { [Op.gte]: todayStart } },
    attributes: [
      'campaign_id',
      [sequelize.fn('COUNT', sequelize.col('draw_id')), 'draws'],
      [sequelize.fn('SUM', sequelize.literal('CASE WHEN is_win = 1 THEN 1 ELSE 0 END')), 'wins']
    ],
    group: ['campaign_id'],
    raw: true
  })

  // 写入汇总表（不用视图）
  await DailyLotteryStats.bulkCreate(stats, { updateOnDuplicate: ['draws', 'wins'] })
}
```

#### 方案 3：数据库索引优化（优先于视图）

```sql
-- 为常见管理查询添加索引（比视图更有效）
CREATE INDEX idx_lottery_draws_campaign_date
  ON lottery_draws(campaign_id, created_at DESC);

CREATE INDEX idx_lottery_prizes_campaign_status
  ON lottery_prizes(campaign_id, status);

CREATE INDEX idx_quota_rules_scope
  ON lottery_draw_quota_rules(scope_type, scope_id, status);
```

---

## 五、视图使用场景对比表

| 场景类型            | 是否用视图 | 推荐方案                           | 适用条件            |
| ------------------- | ---------- | ---------------------------------- | ------------------- |
| **核心业务读接口**  | ❌ 不用    | Service 层聚合 + Sequelize include | 所有 OLTP 场景      |
| **管理端列表/详情** | ❌ 不用    | Service 层聚合 + Redis 缓存        | 本项目当前需求      |
| **实时统计/看板**   | ❌ 不用    | Redis 缓存 + 定时任务汇总表        | 数据量 < 100 万     |
| **固定口径报表**    | ✅ 可用    | 只读视图（从库）+ 迁移管理         | 口径稳定 3 个月+    |
| **复杂对账/导出**   | ✅ 可用    | 视图或离线汇总表                   | 数据量大 + 口径固定 |
| **数据分析/BI**     | ✅ 推荐    | 数仓视图/物化视图                  | 独立分析库          |

---

## 六、行业实践对比总结

### 6.1 大公司（美团/腾讯/阿里/字节）

```
核心业务（OLTP）
  ├─ 表 + 索引 + 事务 + 服务层聚合 ✅
  ├─ 视图 ❌（几乎不用）
  └─ 灰度/回滚/审计友好

报表/分析（OLAP）
  ├─ 数仓（Hive/ClickHouse/Doris）✅
  ├─ 视图/物化视图 ✅（在数仓里）
  └─ ETL/流式计算
```

### 6.2 小公司/创业团队

```
初期（业务简单）
  ├─ OLTP 直接用视图 ✅（省事）
  └─ 性能/灰度压力小

成长期（业务复杂化）
  ├─ 逐步去视图 ✅
  ├─ 改为服务层聚合 ✅
  └─ 最终演化成大公司架构
```

### 6.3 游戏公司（虚拟物品交易）

```
核心交易链路
  ├─ 背包/订单/资产/流水 → 表 ✅
  ├─ 视图 ❌（绝对不用）
  └─ 幂等/审计/状态机

运营/数据分析
  ├─ 汇总表/缓存 ✅
  ├─ 视图（报表） ✅（少量）
  └─ 独立分析库
```

### 6.4 活动策划/二手平台

```
活动平台
  ├─ 缓存聚合（Redis）✅
  ├─ 定时汇总表 ✅
  └─ 视图（少用，口径变化快）

二手平台
  ├─ 交易链路 → 表 ✅
  ├─ 搜索 → Elasticsearch ✅
  └─ 对账 → 视图或离线汇总 ✅
```

---

## 七、本项目推荐方案（最终决策）

### 7.1 当前阶段（2025-12-27 ~ 2026-Q1）

**不使用视图**

**实施方案**：

1. **管理端读接口**：Service 层聚合查询（如上文 `getCampaignConfig`）
2. **性能优化**：Redis 缓存（TTL 300 秒）+ 索引优化
3. **统计报表**：定时任务汇总到统计表（如 `daily_lottery_stats`）
4. **导出功能**：Service 层查询 + 流式导出（不用视图）

**优先级任务**：

- [ ] 修复迁移漂移（`sequelizemeta` 大小写、`user_asset_accounts` 缺失）
- [ ] 实现管理端聚合读接口（活动配置详情、奖品池、配额、干预）
- [ ] 添加关键索引（`lottery_draws` 的 `campaign_id + created_at`）
- [ ] Redis 缓存管理端列表查询

### 7.2 未来阶段（2026-Q2+，满足条件后）

**可引入少量只读视图**（仅用于报表/对账）

**前置条件**（必须全部满足）：

- [x] 迁移管理规范化（元数据表统一、迁移与表一致）
- [x] 口径稳定 3 个月以上
- [x] 数据量达到百万级（join 性能瓶颈）
- [x] 有专人负责视图版本管理

**可用场景示例**：

```sql
-- 每日活动统计视图（固定口径报表）
CREATE VIEW v_daily_lottery_report AS
SELECT
  DATE(ld.created_at) AS stat_date,
  lc.campaign_code,
  lc.campaign_name,
  COUNT(DISTINCT ld.user_id) AS participants,
  COUNT(ld.draw_id) AS total_draws,
  SUM(CASE WHEN ld.is_win = 1 THEN 1 ELSE 0 END) AS win_count,
  SUM(CASE WHEN ld.is_win = 1 THEN lp.prize_value ELSE 0 END) AS total_prize_value
FROM lottery_draws ld
JOIN lottery_campaigns lc ON ld.campaign_id = lc.campaign_id
LEFT JOIN lottery_prizes lp ON ld.prize_id = lp.prize_id
GROUP BY DATE(ld.created_at), lc.campaign_code, lc.campaign_name;
```

**迁移管理规范**：

```javascript
// migrations/20260301000000-create-view-daily-lottery-report.js
module.exports = {
  async up(queryInterface, Sequelize) {
    await queryInterface.sequelize.query(`
      CREATE VIEW v_daily_lottery_report AS
      SELECT ...
    `)
  },

  async down(queryInterface, Sequelize) {
    await queryInterface.sequelize.query('DROP VIEW IF EXISTS v_daily_lottery_report')
  }
}
```

---

## 八、实施检查清单

### 当前阶段（不用视图）

- [x] 数据库无视图（已验证：0 个 VIEW）
- [x] 代码无视图依赖（已验证：services/ 无 `v_legacy_` 查询）
- [ ] 实现管理端聚合读接口（活动配置详情）
- [ ] 添加 Redis 缓存层（列表查询）
- [ ] 优化数据库索引（常见管理查询）
- [ ] 修复迁移漂移问题

### 未来阶段（引入视图前）

- [ ] 迁移元数据表规范化（`sequelizemeta` → `SequelizeMeta`）
- [ ] 所有迁移记录与真实表一致
- [ ] 报表口径稳定 3 个月
- [ ] 数据量达到百万级
- [ ] 建立视图迁移管理规范
- [ ] 视图仅用于只读报表（不参与写链路）

---

## 九、常见问题 FAQ

### Q1: 为什么大公司核心业务不用视图？

**A**: 灰度发布、回滚、审计、性能优化需要精细控制。视图把口径藏在 DB，变更是全量生效，无法灰度；并且视图的执行计划不透明，优化困难。

### Q2: 视图不是可以简化查询吗？

**A**: 是的，但代价是：

- 口径变更需要 ALTER VIEW（迁移管理复杂）
- 权限/缓存/性能不透明
- ORM（Sequelize）对视图支持有限
- 团队认知负担增加（口径分散在代码和 DB）

### Q3: 我的管理端查询很复杂，join 很多表，不用视图怎么办？

**A**: 三种方案（按优先级）：

1. **Service 层聚合**：2~4 次查询或 Sequelize include，组装返回（推荐）
2. **Redis 缓存**：列表查询缓存 300 秒，详情缓存 60 秒
3. **定时汇总表**：定时任务预计算，写入统计表（替代物化视图）

### Q4: 什么时候必须用视图？

**A**: 当满足以下**全部条件**：

- 口径已稳定 3 个月以上
- 数据量达到百万级（join 性能瓶颈）
- 仅用于只读报表/对账（不参与写链路）
- 有专人负责视图迁移管理
- 迁移管理已规范化

### Q5: 我看到其他项目用了视图，我也该用吗？

**A**: 不一定。要看：

- 他们的视图用在哪里（核心链路 vs 报表层）
- 他们的数据量和团队规模
- 他们的迁移管理是否规范
- **你的项目当前处于"暴力重构、去双轨"阶段，引入视图会增加新的复杂度**

---

## 十、附录

### 10.1 当前项目核心表关系图（不用视图）

```
lottery_campaigns (活动配置)
  ├─ 1:N → lottery_prizes (奖品池)
  ├─ 1:N → lottery_draws (抽奖记录)
  ├─ 1:N → lottery_draw_quota_rules (配额规则, scope_type=campaign)
  └─ 1:N → lottery_management_settings (管理干预)

users (用户)
  ├─ 1:N → user_roles → roles (角色权限)
  ├─ 1:1 → user_points_accounts (积分账户)
  ├─ 1:N → points_transactions (积分流水)
  ├─ 1:1 → accounts → account_asset_balances (资产余额)
  ├─ 1:N → item_instances (背包物品)
  └─ 1:N → redemption_orders (核销订单)

item_instances (物品实例)
  ├─ 1:1 → market_listings (市场挂牌)
  └─ 1:1 → redemption_orders (核销订单)

accounts (账户主体)
  ├─ 1:N → account_asset_balances (资产余额)
  └─ 1:N → asset_transactions (资产流水)
```

### 10.2 推荐的管理端接口清单（不用视图）

| 功能模块 | 接口路径                                           | 查询表                                                  | 是否用视图 |
| -------- | -------------------------------------------------- | ------------------------------------------------------- | ---------- |
| 活动列表 | `GET /api/v4/admin/lottery/campaigns`              | `lottery_campaigns`                                     | ❌         |
| 活动详情 | `GET /api/v4/admin/lottery/campaigns/:code/config` | `lottery_campaigns + prizes + quota_rules + management` | ❌         |
| 奖品池   | `GET /api/v4/admin/prize-pool/:campaign_code`      | `lottery_prizes + image_resources`                      | ❌         |
| 配额规则 | `GET /api/v4/admin/lottery-quota/rules`            | `lottery_draw_quota_rules`                              | ❌         |
| 用户列表 | `GET /api/v4/admin/user_management/users`          | `users + user_roles + roles`                            | ❌         |
| 库存管理 | `GET /api/v4/admin/inventory/items`                | `item_instances + products`                             | ❌         |
| 订单管理 | `GET /api/v4/admin/redemption/orders`              | `redemption_orders + item_instances`                    | ❌         |
| 市场管理 | `GET /api/v4/admin/marketplace/listings`           | `market_listings + item_instances`                      | ❌         |
| 资产管理 | `GET /api/v4/admin/assets/accounts`                | `accounts + account_asset_balances`                     | ❌         |
| 流水查询 | `GET /api/v4/admin/assets/transactions`            | `asset_transactions`                                    | ❌         |
| 每日统计 | `GET /api/v4/admin/analytics/daily`                | `daily_lottery_stats`（汇总表）                         | ❌         |
| 财务对账 | `GET /api/v4/admin/finance/reconciliation`         | 多表 join 或汇总表                                      | ⚠️ 可选    |

### 10.3 视图迁移管理模板（未来使用）

```javascript
// migrations/YYYYMMDDHHMMSS-create-view-{view_name}.js
/**
 * 创建视图：{view_name}
 *
 * 用途：{用途说明}
 * 口径：{口径说明}
 * 依赖表：{依赖的表列表}
 *
 * ⚠️ 注意：
 * - 视图仅用于只读报表
 * - 不参与任何写链路
 * - 口径变更需要 ALTER VIEW 迁移
 */

'use strict'

module.exports = {
  async up(queryInterface, Sequelize) {
    await queryInterface.sequelize.query(`
      CREATE VIEW v_{view_name} AS
      SELECT 
        -- 字段定义
      FROM {table1}
      JOIN {table2} ON ...
      WHERE ...
      GROUP BY ...
    `)

    console.log('✅ 创建视图: v_{view_name}')
  },

  async down(queryInterface, Sequelize) {
    await queryInterface.sequelize.query('DROP VIEW IF EXISTS v_{view_name}')
    console.log('✅ 删除视图: v_{view_name}')
  }
}
```

### 10.4 Service 层聚合查询示例（替代视图）

```javascript
// services/AdminLotteryService.js

/**
 * 获取活动配置详情（聚合查询，不用视图）
 *
 * @param {string} campaign_code - 活动代码
 * @param {Object} options - 查询选项
 * @param {string} options.include - 包含的关联数据（逗号分隔）
 * @returns {Promise<Object>} 活动配置详情
 */
static async getCampaignConfig(campaign_code, options = {}) {
  const { include = 'prizes,quota_rules' } = options;
  const includeSet = new Set(include.split(',').map(s => s.trim()));

  // 1. 查询活动基本信息（主表）
  const campaign = await models.LotteryCampaign.findOne({
    where: { campaign_code },
    // Sequelize include 替代视图 join
    include: includeSet.has('prizes') ? [{
      model: models.LotteryPrize,
      as: 'prizes',
      where: { status: { [Op.ne]: 'deleted' } },
      required: false,
      include: [{
        model: models.ImageResources,
        as: 'image',
        attributes: ['image_url'],
        required: false
      }]
    }] : []
  });

  if (!campaign) {
    throw new Error('活动不存在');
  }

  const result = {
    campaign: campaign.toJSON()
  };

  // 2. 按需查询配额规则（独立查询，不用视图）
  if (includeSet.has('quota_rules')) {
    result.quota_rules = await models.LotteryDrawQuotaRule.findAll({
      where: {
        [Op.or]: [
          { scope_type: 'global' },
          { scope_type: 'campaign', scope_id: campaign.campaign_id }
        ],
        status: 'active'
      },
      order: [['priority', 'DESC']]
    });
  }

  // 3. 按需查询管理干预配置（独立查询）
  if (includeSet.has('management')) {
    result.management_settings = await models.LotteryManagementSetting.findAll({
      where: {
        campaign_id: campaign.campaign_id,
        status: 'active'
      }
    });
  }

  // 4. 按需统计抽奖数据（聚合查询，不用视图）
  if (includeSet.has('draw_stats')) {
    const todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);

    const [todayStats] = await models.sequelize.query(`
      SELECT
        COUNT(DISTINCT user_id) AS participants,
        COUNT(draw_id) AS total_draws,
        SUM(CASE WHEN is_win = 1 THEN 1 ELSE 0 END) AS win_count
      FROM lottery_draws
      WHERE campaign_id = :campaign_id
        AND created_at >= :today_start
    `, {
      replacements: {
        campaign_id: campaign.campaign_id,
        today_start: todayStart
      },
      type: models.sequelize.QueryTypes.SELECT
    });

    result.draw_stats = {
      today: {
        participants: parseInt(todayStats.participants) || 0,
        draws: parseInt(todayStats.total_draws) || 0,
        wins: parseInt(todayStats.win_count) || 0,
        win_rate: todayStats.total_draws > 0
          ? (todayStats.win_count / todayStats.total_draws * 100).toFixed(2)
          : 0
      }
    };
  }

  return result;
}
```

---

## 十一、决策依据总结

### 11.1 为什么本项目当前不用视图？

1. **迁移管理尚不稳定**：存在 schema 漂移（迁移记录 vs 真实表不一致）
2. **暴力重构进行中**：正在清理双轨/兼容代码，视图会成为新的隐藏双轨
3. **业务迭代频繁**：活动配置、交易规则、资产类型仍在演进
4. **数据量级不大**：最大表 3,350 行，join/聚合性能压力不大
5. **团队工具链**：Sequelize ORM + Service 层已足够

### 11.2 行业共识

- **大公司**：核心 OLTP 不用视图，报表/数仓用视图
- **小公司**：初期可能用视图省事，成长后逐步去视图
- **游戏交易**：核心链路绝对不用视图，报表可选用
- **活动平台**：更倾向缓存/汇总表，视图少用

### 11.3 本项目最优方案

**主方案**：Service 层聚合查询 + Redis 缓存 + 索引优化  
**可选方案**（未来）：少量只读视图（仅报表/对账，满足前置条件后）

---

**文档维护者**: AI Assistant  
**最后更新**: 2025-12-27  
**下次评审**: 2026-Q1（迁移规范化完成后）
