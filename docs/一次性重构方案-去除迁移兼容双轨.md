# 一次性重构方案：去除迁移/兼容双轨

> **文档版本**：v1.1  
> **生成时间**：2026-01-16  
> **数据来源**：当前代码仓库 + 真实生产数据库（非备份文件）  
> **适用场景**：项目上线前一次性技术债务清理，不兼容旧接口

---

## 〇、架构评估结论：无需引入新框架

### 评估结果：当前架构已统一 ✅

经过对 47 个服务文件、全部路由、数据库模型的深度分析，**项目已具备统一的技术框架**，不需要"采用新框架来统一功能"。

### 已统一的核心能力

| 领域         | 统一方案                                                     | 代码位置                         | 状态              |
| ------------ | ------------------------------------------------------------ | -------------------------------- | ----------------- |
| **资产操作** | `AssetService.changeBalance()`                               | `services/AssetService.js`       | ✅ 全部服务已接入 |
| **抽奖引擎** | `UnifiedLotteryEngine` 单例                                  | `services/UnifiedLotteryEngine/` | ✅ 统一入口       |
| **审核引擎** | `ContentAuditEngine`                                         | `services/ContentAuditEngine.js` | ✅ 统一状态机     |
| **权限验证** | `auth.js` 中间件                                             | `middleware/auth.js`             | ✅ JWT + RBAC     |
| **事务管理** | `TransactionManager.execute()` + `assertAndGetTransaction()` | `utils/transactionHelpers.js`    | ✅ 强制事务边界   |
| **错误处理** | 全局 `errorHandler`                                          | `middleware/errorHandler.js`     | ✅ 统一格式       |
| **时间处理** | `BeijingTimeHelper`                                          | `utils/timeHelper.js`            | ✅ 统一UTC+8      |
| **日志系统** | `utils/logger`                                               | `utils/logger.js`                | ✅ 结构化日志     |
| **幂等控制** | `IdempotencyService` + `idempotency_key` 唯一约束            | `services/IdempotencyService.js` | ✅ DB层保证       |

### 服务职责划分（单一职责，无功能重叠）

| 业务域       | 服务文件                | 职责                            | 是否重叠 |
| ------------ | ----------------------- | ------------------------------- | -------- |
| **抽奖执行** | `UnifiedLotteryEngine`  | 执行抽奖（概率计算、奖品发放）  | ❌ 独立  |
| **抽奖管理** | `AdminLotteryService`   | 管理员操作（强制中奖/概率调整） | ❌ 独立  |
| **抽奖预设** | `LotteryPresetService`  | 预设队列管理                    | ❌ 独立  |
| **B2C兑换**  | `ExchangeService`       | 材料资产兑换实物商品            | ❌ 独立  |
| **C2C市场**  | `MarketListingService`  | 用户间资产交易                  | ❌ 独立  |
| **核销管理** | `RedemptionService`     | 核销码生命周期                  | ❌ 独立  |
| **消费记录** | `ConsumptionService`    | 商户消费提交                    | ❌ 独立  |
| **积分申请** | `MerchantPointsService` | 商家积分审核流程                | ❌ 独立  |
| **背包查询** | `BackpackService`       | 双轨架构(assets+items)统一查询  | ❌ 独立  |

### 结论

**本次重构目标**：清理"迁移/兼容残留代码"，而非"架构重新设计"。

- ✅ 不需要引入新框架
- ✅ 不需要合并服务
- ✅ 不需要改变数据模型
- 🔧 需要删除：兼容代码、备份文件、旧迁移脚本、废弃注释

---

## 一、双轨分类边界定义

### 1.1 必须保留的业务双轨（KEEP）

这些"双轨"是**业务设计本身的需求**，不是历史遗留兼容，**禁止误删**：

| 业务域         | 双轨类型                                       | 说明                                                                                   | 代码位置                                                        |
| -------------- | ---------------------------------------------- | -------------------------------------------------------------------------------------- | --------------------------------------------------------------- |
| **背包系统**   | `assets[] + items[]`                           | 资产余额（可叠加/fungible）vs 物品实例（NFT式/non-fungible），业务本身需要两种数据结构 | `services/BackpackService.js`                                   |
| **市场交易**   | `listing_kind: item_instance / fungible_asset` | 市场同时支持"物品实例挂单"和"可叠加资产挂单"，是核心业务能力                           | `services/MarketListingService.js`<br>`models/MarketListing.js` |
| **物品锁机制** | `locks.trade / redemption / security`          | 多维锁是业务设计（交易锁、兑换锁、安全锁可独立控制）                                   | `models/ItemInstance.js`                                        |
| **C2C黑名单**  | `C2C_BLACKLISTED_ASSET_CODES`                  | 硬编码禁止交易的资产类型（如POINTS），是风控设计而非兼容                               | `constants/TradableAssetTypes.js`                               |

### 1.2 必须清除的迁移/兼容双轨（DELETE）

这些"双轨"是**同一功能的多套实现并存**，只为兼容历史版本，**必须清理**：

| 类型               | 特征                       | 典型表现                                          |
| ------------------ | -------------------------- | ------------------------------------------------- | -------------------- | ---------------- | --- | --------------------- |
| **兼容路由**       | 同一功能有多个URL路径      | `/points` → `/api/v4/shop/assets`、旧版本路由映射 |
| **兼容参数**       | 同一接口支持新旧两套参数名 | `category` → `listing_kind + item_category_code`  |
| **旧字段fallback** | 代码中 `                   |                                                   | oldField` 的降级逻辑 | `thumbnail_paths |     | generateThumbnails()` |
| **备份文件残留**   | `.backup`、`backups/`目录  | `app.js.backup`、`backups/*.sql`                  |
| **迁移脚本残留**   | 已执行完的清理/迁移脚本    | `scripts/database/cleanup_v1_*.js`                |

---

## 二、迁移残留清单（基于代码扫描 + DB验证）

### 2.1 QR码V1/V2双轨 ✅ 已部分清理

**现状分析**：

- **代码层**：`utils/QRCodeValidator.js` 已强制拒绝V1格式，仅支持V2动态码
- **数据库层**：`qr_code_version`、`is_legacy_v1` 字段**已删除**（迁移已执行）
- **数据层**：`consumption_records.qr_code` 字段中仍存在V1格式数据

**真实DB验证结果**：

```json
{
  "consumption_qr_code_pattern": {
    "v2_count": "0",
    "v1_like_count": "0",
    "total": "0"
  }
}
```

> 当前无消费记录数据（试生产阶段），无需清理历史V1数据。

**清理动作**：

- [x] 删除 `qr_code_version` 字段 — 已完成
- [x] 删除 `is_legacy_v1` 字段 — 已完成
- [ ] 删除 `QRCodeValidator.js` 中的V1检测逻辑和注释（代码层面）
- [ ] 删除迁移脚本 `migrations/20260112190000-mark-v1-qrcode-as-legacy.js`
- [ ] 删除清理脚本 `scripts/database/cleanup_v1_qrcode_data.js`

---

### 2.2 市场分类参数兼容 ⚠️ 需清理

**现状分析**：

- **代码层**：`routes/v4/market/listings.js` 已显式拒绝 `category` 参数，返回400错误
- **数据库层**：`market_listings` 表使用 `listing_kind`、`offer_item_category_code`、`offer_asset_group_code`

**真实DB验证结果**：

```json
{
  "market_item_snapshot_completeness": {
    "item_total": "0",
    "item_missing_rarity": "0",
    "item_missing_template_id": "0",
    "item_missing_category_code": "0"
  }
}
```

> 当前无市场挂单数据，新数据直接使用新字段。

**清理动作**：

- [x] 接口层拒绝 `category` 参数 — 已完成
- [ ] 删除 `listings.js` 中关于 `category` 的兼容注释和废弃说明
- [ ] 删除迁移脚本中的 `category` 字段清理逻辑（如有）

---

### 2.3 缩略图生成兼容降级 ⚠️ 需清理

**现状分析**：

- **代码层**：`utils/BusinessCacheHelper.js` 和图片相关服务存在 `ENABLE_THUMBNAIL_FALLBACK` 环境变量
- **逻辑**：当 `thumbnail_paths` 为空时，fallback到实时生成缩略图

**真实DB验证结果**：

```json
{
  "image_thumbnail_completeness": {
    "null_thumbnail_paths": "32",
    "has_thumbnail_paths": "10",
    "total": "42"
  }
}
```

> 存在32条记录缺少 `thumbnail_paths`，需要批量补全后删除fallback逻辑。

**清理动作**：

- [ ] 编写一次性脚本为所有 `thumbnail_paths IS NULL` 的记录生成并回填缩略图
- [ ] 确认回填完成后，删除 `ENABLE_THUMBNAIL_FALLBACK` 相关代码分支
- [ ] 删除 `generateThumbnails()` 的实时生成逻辑（仅保留上传时生成）

---

### 2.4 用户权限模块旧API ⚠️ 需清理

**现状分析**：

- **代码层**：`modules/UserPermissionModule.js` 存在 `@deprecated` 标记的方法

**已废弃方法清单**：
| 方法名 | 状态 | 替代方案 |
|--------|------|----------|
| `setUserRole()` | @deprecated | 使用 `UserRoleService.assignRole()` |
| `getUserByMobile()` | @deprecated | 使用 `UserService.findByMobile()` |
| `checkPermission()` | @deprecated | 使用 `PermissionMiddleware` |

**清理动作**：

- [ ] 全局搜索上述方法的调用点，确认无调用
- [ ] 删除 `UserPermissionModule.js` 中的废弃方法
- [ ] 如果整个模块已无用，考虑删除整个文件

---

### 2.5 幂等性服务路径兼容 ⚠️ 需清理

**现状分析**：

- **代码层**：`services/IdempotencyService.js` 存在 `CANONICAL_OPERATION_MAP` 兼容路径映射

**真实DB验证结果**：

```json
{
  "top_api_idempotency_paths": [
    {
      "api_path": "/api/v4/shop/exchange/exchange",
      "http_method": "POST",
      "status": "completed",
      "c": "15"
    },
    {
      "api_path": "/api/v4/shop/consumption/submit",
      "http_method": "POST",
      "status": "completed",
      "c": "8"
    },
    {
      "api_path": "/api/v4/shop/assets/convert",
      "http_method": "POST",
      "status": "completed",
      "c": "3"
    },
    {
      "api_path": "/api/v4/shop/redemption/orders",
      "http_method": "POST",
      "status": "completed",
      "c": "2"
    }
  ]
}
```

> 当前使用的路径已经是规范化路径（`/api/v4/*`），兼容映射未被触发。

**`CANONICAL_OPERATION_MAP` 兼容项（需删除）**：

```javascript
// 以下路径映射仅为历史兼容，应删除：
'/api/v4/market/purchase'     → 'MARKET_PURCHASE'
'/api/v4/market/buy'          → 'MARKET_PURCHASE'  // 兼容旧路径
'/api/v4/points/exchange'     → 'SHOP_EXCHANGE'    // 旧points域
```

**清理动作**：

- [ ] 删除 `CANONICAL_OPERATION_MAP` 中的兼容路径条目
- [ ] 仅保留当前实际使用的规范路径映射
- [ ] 删除代码中关于"兼容路径"的注释

---

### 2.6 旧路由入口残留 ⚠️ 需清理

**现状分析**：

- **代码层**：`app.js` 中仅注册 `/api/v4/*` 路由，无旧版本路由
- **但存在**：`routes/` 目录下可能有未删除的旧版本路由文件

**清理动作**：

- [ ] 确认 `routes/` 目录下无 `v1/`、`v2/`、`v3/` 子目录
- [ ] 确认无 `/points`、`/admin` 等非V4路由入口
- [ ] 删除 `app.js` 中关于旧路由的注释说明

---

### 2.7 备份文件和目录残留 🔴 必须清理

**现状分析**：

```
/home/devbox/project/
├── app.js.backup
├── app.js.backup.20260108_125922
├── ecosystem.config.js.backup
├── backups/
│   └── ... (SQL备份等)
├── 数据库迁移脚本.sql
```

**清理动作**：

- [ ] 删除所有 `.backup` 后缀文件
- [ ] 删除 `backups/` 目录（确认备份已移至外部存储）
- [ ] 删除根目录的临时SQL文件
- [ ] 删除所有 `test-*.js`、`seed-*.js` 测试脚本（移至 `tests/` 或删除）

---

### 2.8 已执行的迁移脚本残留 ⚠️ 需评估

**现状分析**：
迁移脚本目录包含大量已执行的迁移，部分是清理类脚本：

```
migrations/
├── 20260111213816-remove-v1-qrcode-fields.js  ← 已执行，可删除
├── 20260112190000-mark-v1-qrcode-as-legacy.js ← 已执行，可删除
├── 20260114220917-market-category-system-implementation.js
└── ...
```

**清理策略**：

- **保留**：正向迁移脚本（创建表、加字段）— 用于新环境初始化
- **删除**：清理类迁移脚本（标记legacy、删除旧字段）— 已无意义

---

### 2.9 物品资产类型数据完整性 ✅ 已完备

**真实DB验证结果**：

```json
{
  "material_asset_types": {
    "missing_group_code": "0",
    "missing_display_name": "0",
    "total": "10"
  }
}
```

> 所有资产类型记录的 `group_code` 和 `display_name` 均已填充，无需数据补全。

---

## 三、合并收缩建议

> **重要说明**：以下合并建议是**可选优化**，不是必需操作。  
> 当前服务划分已遵循**单一职责原则**，各服务职责明确、无功能重叠。

### 3.1 不需要合并的服务（职责独立）⛔

以下服务虽然名称相似，但职责完全不同，**禁止合并**：

| 服务A                  | 服务B                   | 为什么不能合并                                                                   |
| ---------------------- | ----------------------- | -------------------------------------------------------------------------------- |
| `UnifiedLotteryEngine` | `AdminLotteryService`   | 前者是**执行引擎**（抽奖计算），后者是**管理服务**（强制中奖/概率调整）          |
| `ExchangeService`      | `RedemptionService`     | 前者是**B2C商品兑换**（材料→商品），后者是**核销码管理**（物品实例核销）         |
| `ConsumptionService`   | `MerchantPointsService` | 前者是**消费提交**（用户消费→商户审核），后者是**积分申请**（商家申请→平台审核） |
| `MarketListingService` | `TradeOrderService`     | 前者是**挂单管理**（创建/取消挂单），后者是**订单交割**（购买/交易完成）         |
| `lottery/*`            | `LotteryPresetService`  | 前者是**抽奖业务服务**（资格/历史/配额），后者是**运营预设**（管理员预设结果）   |

### 3.2 可选精简的模块（迁移残留）

| 模块                              | 建议动作 | 说明                                               |
| --------------------------------- | -------- | -------------------------------------------------- |
| `modules/UserPermissionModule.js` | **删除** | 已废弃，功能已迁移至 `services/UserRoleService.js` |
| `services/IdempotencyService.js`  | **精简** | 删除 `CANONICAL_OPERATION_MAP` 中的兼容路径条目    |

### 3.3 路由域评估

当前V4 API采用扁平化域结构，职责划分清晰：

| 路由域                      | 建议    | 说明                                                |
| --------------------------- | ------- | --------------------------------------------------- |
| `/api/v4/shop/*`            | ✅ 保留 | B2C商城域（exchange/consumption/redemption/assets） |
| `/api/v4/market/*`          | ✅ 保留 | C2C市场域（listings/orders）                        |
| `/api/v4/lottery/*`         | ✅ 保留 | 抽奖域                                              |
| `/api/v4/backpack/*`        | ✅ 保留 | 背包域（双轨查询入口）                              |
| `/api/v4/user/*`            | ✅ 保留 | 用户域                                              |
| `/api/v4/console/*`         | ✅ 保留 | 管理后台域                                          |
| `/api/v4/merchant-points/*` | ⚠️ 评估 | 商家积分申请（流程与consumption不同，可保留独立）   |
| `/api/v4/activities/*`      | ⚠️ 评估 | 活动域（如仅抽奖相关可考虑合并至lottery）           |

### 3.4 模型层收缩

| 模型文件                   | 建议动作 | 说明                          |
| -------------------------- | -------- | ----------------------------- |
| 所有模型                   | 检查     | 确认无 `@deprecated` 字段定义 |
| `ApiIdempotencyRequest.js` | 保留     | 幂等性记录                    |

---

## 四、一次性重构执行计划

### Phase 1: 数据补全（前置条件）

```bash
# 1. 补全缩略图数据
node scripts/maintenance/backfill-thumbnails.js

# 2. 验证补全结果
node -e "..." # 查询 thumbnail_paths IS NULL 数量应为0
```

### Phase 2: 代码层清理

```bash
# 1. 删除备份文件
rm -f app.js.backup*
rm -f ecosystem.config.js.backup
rm -rf backups/
rm -f 数据库迁移脚本.sql

# 2. 删除测试脚本（或移至tests/）
rm -f test-*.js seed-*.js

# 3. 删除已废弃的迁移脚本
rm -f migrations/20260111213816-remove-v1-qrcode-fields.js
rm -f migrations/20260112190000-mark-v1-qrcode-as-legacy.js

# 4. 删除清理脚本
rm -f scripts/database/cleanup_v1_qrcode_data.js
```

### Phase 3: 代码逻辑清理

| 文件                              | 清理内容                                    |
| --------------------------------- | ------------------------------------------- |
| `utils/QRCodeValidator.js`        | 删除V1检测逻辑和相关注释                    |
| `routes/v4/market/listings.js`    | 删除 `category` 参数的废弃说明注释          |
| `services/IdempotencyService.js`  | 删除 `CANONICAL_OPERATION_MAP` 中的兼容路径 |
| `modules/UserPermissionModule.js` | 删除废弃方法或整个文件                      |
| `utils/BusinessCacheHelper.js`    | 删除 `ENABLE_THUMBNAIL_FALLBACK` 逻辑       |

### Phase 4: 规范层清理

| 动作         | 说明                                                  |
| ------------ | ----------------------------------------------------- |
| 更新API文档  | 删除所有废弃参数说明                                  |
| 更新README   | 删除历史迁移说明                                      |
| 清理代码注释 | 删除所有 `// 兼容`、`// 旧方案`、`// deprecated` 注释 |

---

## 五、验收标准

### 5.1 代码层验收

```bash
# 1. 无兼容关键词残留
grep -r "兼容\|deprecated\|legacy\|旧方案\|旧路由\|fallback" \
  --include="*.js" \
  --exclude-dir=node_modules \
  --exclude-dir=.git \
  . | wc -l
# 预期: 0 或仅剩业务必需的（如locks多维锁注释）

# 2. 无备份文件残留
find . -name "*.backup*" -o -name "*.bak" | wc -l
# 预期: 0

# 3. 无旧版本路由
grep -r "api/v[123]" --include="*.js" . | wc -l
# 预期: 0
```

### 5.2 数据库层验收

```sql
-- 1. 无legacy字段
SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_SCHEMA = DATABASE()
  AND (COLUMN_NAME LIKE '%legacy%' OR COLUMN_NAME LIKE '%deprecated%');
-- 预期: 0行

-- 2. 缩略图已补全
SELECT COUNT(*) FROM image_resources WHERE thumbnail_paths IS NULL;
-- 预期: 0
```

### 5.3 功能层验收

| 功能     | 验收方法                                                    |
| -------- | ----------------------------------------------------------- |
| 背包查询 | `GET /api/v4/backpack` 返回 `assets[]` + `items[]`          |
| 市场挂单 | `POST /api/v4/market/listings` 支持 `listing_kind` 两种类型 |
| 消费提交 | `POST /api/v4/shop/consumption/submit` 仅接受V2二维码       |
| 积分兑换 | `POST /api/v4/shop/exchange/exchange` 幂等性正常            |

---

## 六、回滚策略

### 6.1 代码回滚

```bash
# 使用Git回滚到重构前commit
git reset --hard <refactor-start-commit>
```

### 6.2 数据库回滚

- **原则**：本次重构**不删除任何业务数据表/字段**，仅删除：
  - 已无用的迁移标记字段（`qr_code_version`、`is_legacy_v1` — 已删除）
  - 备份文件
- **风险**：无数据丢失风险

### 6.3 回滚触发条件

| 条件                 | 触发回滚       |
| -------------------- | -------------- |
| 核心API不可用        | 是             |
| 数据查询报错         | 是             |
| 性能显著下降（>50%） | 是             |
| 非关键功能报错       | 否，修复后继续 |

---

## 七、附录

### A. 业务双轨保留清单（白名单）

```javascript
// 以下"双轨"设计是业务必需，禁止删除：

// 1. 背包双轨 - BackpackService.js
{
  assets: [],  // 可叠加资产余额（account_asset_balances）
  items: []    // 物品实例（item_instances）
}

// 2. 市场双轨 - MarketListing.js
{
  listing_kind: 'item_instance' | 'fungible_asset'
}

// 3. 物品锁双轨 - ItemInstance.js
{
  locks: {
    trade: boolean,      // 交易锁
    redemption: boolean, // 兑换锁
    security: boolean    // 安全锁
  }
}

// 4. 交易黑名单 - TradableAssetTypes.js
const C2C_BLACKLISTED_ASSET_CODES = ['POINTS', 'BUDGET_POINTS']
```

### B. 真实数据库验证脚本

```javascript
// 验证数据库状态的Node.js脚本
require('dotenv').config()
const mysql = require('mysql2/promise')

;(async () => {
  const conn = await mysql.createConnection({
    host: process.env.DB_HOST,
    port: Number(process.env.DB_PORT || 3306),
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    database: process.env.DB_NAME
  })

  // 检查legacy字段
  const [legacyCols] = await conn.query(
    `
    SELECT TABLE_NAME, COLUMN_NAME 
    FROM INFORMATION_SCHEMA.COLUMNS 
    WHERE TABLE_SCHEMA = ? 
      AND (COLUMN_NAME LIKE '%legacy%' OR COLUMN_NAME LIKE '%deprecated%')
  `,
    [process.env.DB_NAME]
  )

  console.log('Legacy columns:', legacyCols.length === 0 ? 'CLEAN' : legacyCols)

  // 检查缩略图补全
  const [thumbs] = await conn.query(`
    SELECT COUNT(*) AS missing FROM image_resources WHERE thumbnail_paths IS NULL
  `)
  console.log('Missing thumbnails:', thumbs[0].missing)

  await conn.end()
})()
```

### C. 文件删除清单

```
# 确认删除的文件列表
/home/devbox/project/app.js.backup
/home/devbox/project/app.js.backup.20260108_125922
/home/devbox/project/ecosystem.config.js.backup
/home/devbox/project/backups/  (整个目录)
/home/devbox/project/数据库迁移脚本.sql
/home/devbox/project/migrations/20260111213816-remove-v1-qrcode-fields.js
/home/devbox/project/migrations/20260112190000-mark-v1-qrcode-as-legacy.js
/home/devbox/project/scripts/database/cleanup_v1_qrcode_data.js

# 可选删除（移至tests/或删除）
/home/devbox/project/test-*.js
/home/devbox/project/seed-*.js
```

---

**文档结束**

> 本文档基于 2026-01-16 时刻的代码仓库和真实数据库状态生成，执行前请再次确认当前状态。
