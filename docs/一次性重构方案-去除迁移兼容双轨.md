# ä¸€æ¬¡æ€§é‡æ„æ–¹æ¡ˆï¼šå»é™¤è¿ç§»/å…¼å®¹åŒè½¨

> **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.1  
> **ç”Ÿæˆæ—¶é—´**ï¼š2026-01-16  
> **æ•°æ®æ¥æº**ï¼šå½“å‰ä»£ç ä»“åº“ + çœŸå®ç”Ÿäº§æ•°æ®åº“ï¼ˆéå¤‡ä»½æ–‡ä»¶ï¼‰  
> **é€‚ç”¨åœºæ™¯**ï¼šé¡¹ç›®ä¸Šçº¿å‰ä¸€æ¬¡æ€§æŠ€æœ¯å€ºåŠ¡æ¸…ç†ï¼Œä¸å…¼å®¹æ—§æ¥å£

---

## ã€‡ã€æ¶æ„è¯„ä¼°ç»“è®ºï¼šæ— éœ€å¼•å…¥æ–°æ¡†æ¶

### è¯„ä¼°ç»“æœï¼šå½“å‰æ¶æ„å·²ç»Ÿä¸€ âœ…

ç»è¿‡å¯¹ 47 ä¸ªæœåŠ¡æ–‡ä»¶ã€å…¨éƒ¨è·¯ç”±ã€æ•°æ®åº“æ¨¡å‹çš„æ·±åº¦åˆ†æï¼Œ**é¡¹ç›®å·²å…·å¤‡ç»Ÿä¸€çš„æŠ€æœ¯æ¡†æ¶**ï¼Œä¸éœ€è¦"é‡‡ç”¨æ–°æ¡†æ¶æ¥ç»Ÿä¸€åŠŸèƒ½"ã€‚

### å·²ç»Ÿä¸€çš„æ ¸å¿ƒèƒ½åŠ›

| é¢†åŸŸ         | ç»Ÿä¸€æ–¹æ¡ˆ                                                     | ä»£ç ä½ç½®                         | çŠ¶æ€              |
| ------------ | ------------------------------------------------------------ | -------------------------------- | ----------------- |
| **èµ„äº§æ“ä½œ** | `AssetService.changeBalance()`                               | `services/AssetService.js`       | âœ… å…¨éƒ¨æœåŠ¡å·²æ¥å…¥ |
| **æŠ½å¥–å¼•æ“** | `UnifiedLotteryEngine` å•ä¾‹                                  | `services/UnifiedLotteryEngine/` | âœ… ç»Ÿä¸€å…¥å£       |
| **å®¡æ ¸å¼•æ“** | `ContentAuditEngine`                                         | `services/ContentAuditEngine.js` | âœ… ç»Ÿä¸€çŠ¶æ€æœº     |
| **æƒé™éªŒè¯** | `auth.js` ä¸­é—´ä»¶                                             | `middleware/auth.js`             | âœ… JWT + RBAC     |
| **äº‹åŠ¡ç®¡ç†** | `TransactionManager.execute()` + `assertAndGetTransaction()` | `utils/transactionHelpers.js`    | âœ… å¼ºåˆ¶äº‹åŠ¡è¾¹ç•Œ   |
| **é”™è¯¯å¤„ç†** | å…¨å±€ `errorHandler`                                          | `middleware/errorHandler.js`     | âœ… ç»Ÿä¸€æ ¼å¼       |
| **æ—¶é—´å¤„ç†** | `BeijingTimeHelper`                                          | `utils/timeHelper.js`            | âœ… ç»Ÿä¸€UTC+8      |
| **æ—¥å¿—ç³»ç»Ÿ** | `utils/logger`                                               | `utils/logger.js`                | âœ… ç»“æ„åŒ–æ—¥å¿—     |
| **å¹‚ç­‰æ§åˆ¶** | `IdempotencyService` + `idempotency_key` å”¯ä¸€çº¦æŸ            | `services/IdempotencyService.js` | âœ… DBå±‚ä¿è¯       |

### æœåŠ¡èŒè´£åˆ’åˆ†ï¼ˆå•ä¸€èŒè´£ï¼Œæ— åŠŸèƒ½é‡å ï¼‰

| ä¸šåŠ¡åŸŸ       | æœåŠ¡æ–‡ä»¶                | èŒè´£                            | æ˜¯å¦é‡å  |
| ------------ | ----------------------- | ------------------------------- | -------- |
| **æŠ½å¥–æ‰§è¡Œ** | `UnifiedLotteryEngine`  | æ‰§è¡ŒæŠ½å¥–ï¼ˆæ¦‚ç‡è®¡ç®—ã€å¥–å“å‘æ”¾ï¼‰  | âŒ ç‹¬ç«‹  |
| **æŠ½å¥–ç®¡ç†** | `AdminLotteryService`   | ç®¡ç†å‘˜æ“ä½œï¼ˆå¼ºåˆ¶ä¸­å¥–/æ¦‚ç‡è°ƒæ•´ï¼‰ | âŒ ç‹¬ç«‹  |
| **æŠ½å¥–é¢„è®¾** | `LotteryPresetService`  | é¢„è®¾é˜Ÿåˆ—ç®¡ç†                    | âŒ ç‹¬ç«‹  |
| **B2Cå…‘æ¢**  | `ExchangeService`       | ææ–™èµ„äº§å…‘æ¢å®ç‰©å•†å“            | âŒ ç‹¬ç«‹  |
| **C2Cå¸‚åœº**  | `MarketListingService`  | ç”¨æˆ·é—´èµ„äº§äº¤æ˜“                  | âŒ ç‹¬ç«‹  |
| **æ ¸é”€ç®¡ç†** | `RedemptionService`     | æ ¸é”€ç ç”Ÿå‘½å‘¨æœŸ                  | âŒ ç‹¬ç«‹  |
| **æ¶ˆè´¹è®°å½•** | `ConsumptionService`    | å•†æˆ·æ¶ˆè´¹æäº¤                    | âŒ ç‹¬ç«‹  |
| **ç§¯åˆ†ç”³è¯·** | `MerchantPointsService` | å•†å®¶ç§¯åˆ†å®¡æ ¸æµç¨‹                | âŒ ç‹¬ç«‹  |
| **èƒŒåŒ…æŸ¥è¯¢** | `BackpackService`       | åŒè½¨æ¶æ„(assets+items)ç»Ÿä¸€æŸ¥è¯¢  | âŒ ç‹¬ç«‹  |

### ç»“è®º

**æœ¬æ¬¡é‡æ„ç›®æ ‡**ï¼šæ¸…ç†"è¿ç§»/å…¼å®¹æ®‹ç•™ä»£ç "ï¼Œè€Œé"æ¶æ„é‡æ–°è®¾è®¡"ã€‚

- âœ… ä¸éœ€è¦å¼•å…¥æ–°æ¡†æ¶
- âœ… ä¸éœ€è¦åˆå¹¶æœåŠ¡
- âœ… ä¸éœ€è¦æ”¹å˜æ•°æ®æ¨¡å‹
- ğŸ”§ éœ€è¦åˆ é™¤ï¼šå…¼å®¹ä»£ç ã€å¤‡ä»½æ–‡ä»¶ã€æ—§è¿ç§»è„šæœ¬ã€åºŸå¼ƒæ³¨é‡Š

---

## ä¸€ã€åŒè½¨åˆ†ç±»è¾¹ç•Œå®šä¹‰

### 1.1 å¿…é¡»ä¿ç•™çš„ä¸šåŠ¡åŒè½¨ï¼ˆKEEPï¼‰

è¿™äº›"åŒè½¨"æ˜¯**ä¸šåŠ¡è®¾è®¡æœ¬èº«çš„éœ€æ±‚**ï¼Œä¸æ˜¯å†å²é—ç•™å…¼å®¹ï¼Œ**ç¦æ­¢è¯¯åˆ **ï¼š

| ä¸šåŠ¡åŸŸ         | åŒè½¨ç±»å‹                                       | è¯´æ˜                                                                                   | ä»£ç ä½ç½®                                                        |
| -------------- | ---------------------------------------------- | -------------------------------------------------------------------------------------- | --------------------------------------------------------------- |
| **èƒŒåŒ…ç³»ç»Ÿ**   | `assets[] + items[]`                           | èµ„äº§ä½™é¢ï¼ˆå¯å åŠ /fungibleï¼‰vs ç‰©å“å®ä¾‹ï¼ˆNFTå¼/non-fungibleï¼‰ï¼Œä¸šåŠ¡æœ¬èº«éœ€è¦ä¸¤ç§æ•°æ®ç»“æ„ | `services/BackpackService.js`                                   |
| **å¸‚åœºäº¤æ˜“**   | `listing_kind: item_instance / fungible_asset` | å¸‚åœºåŒæ—¶æ”¯æŒ"ç‰©å“å®ä¾‹æŒ‚å•"å’Œ"å¯å åŠ èµ„äº§æŒ‚å•"ï¼Œæ˜¯æ ¸å¿ƒä¸šåŠ¡èƒ½åŠ›                           | `services/MarketListingService.js`<br>`models/MarketListing.js` |
| **ç‰©å“é”æœºåˆ¶** | `locks.trade / redemption / security`          | å¤šç»´é”æ˜¯ä¸šåŠ¡è®¾è®¡ï¼ˆäº¤æ˜“é”ã€å…‘æ¢é”ã€å®‰å…¨é”å¯ç‹¬ç«‹æ§åˆ¶ï¼‰                                   | `models/ItemInstance.js`                                        |
| **C2Cé»‘åå•**  | `C2C_BLACKLISTED_ASSET_CODES`                  | ç¡¬ç¼–ç ç¦æ­¢äº¤æ˜“çš„èµ„äº§ç±»å‹ï¼ˆå¦‚POINTSï¼‰ï¼Œæ˜¯é£æ§è®¾è®¡è€Œéå…¼å®¹                               | `constants/TradableAssetTypes.js`                               |

### 1.2 å¿…é¡»æ¸…é™¤çš„è¿ç§»/å…¼å®¹åŒè½¨ï¼ˆDELETEï¼‰

è¿™äº›"åŒè½¨"æ˜¯**åŒä¸€åŠŸèƒ½çš„å¤šå¥—å®ç°å¹¶å­˜**ï¼Œåªä¸ºå…¼å®¹å†å²ç‰ˆæœ¬ï¼Œ**å¿…é¡»æ¸…ç†**ï¼š

| ç±»å‹               | ç‰¹å¾                       | å…¸å‹è¡¨ç°                                          |
| ------------------ | -------------------------- | ------------------------------------------------- | -------------------- | ---------------- | --- | --------------------- |
| **å…¼å®¹è·¯ç”±**       | åŒä¸€åŠŸèƒ½æœ‰å¤šä¸ªURLè·¯å¾„      | `/points` â†’ `/api/v4/shop/assets`ã€æ—§ç‰ˆæœ¬è·¯ç”±æ˜ å°„ |
| **å…¼å®¹å‚æ•°**       | åŒä¸€æ¥å£æ”¯æŒæ–°æ—§ä¸¤å¥—å‚æ•°å | `category` â†’ `listing_kind + item_category_code`  |
| **æ—§å­—æ®µfallback** | ä»£ç ä¸­ `                   |                                                   | oldField` çš„é™çº§é€»è¾‘ | `thumbnail_paths |     | generateThumbnails()` |
| **å¤‡ä»½æ–‡ä»¶æ®‹ç•™**   | `.backup`ã€`backups/`ç›®å½•  | `app.js.backup`ã€`backups/*.sql`                  |
| **è¿ç§»è„šæœ¬æ®‹ç•™**   | å·²æ‰§è¡Œå®Œçš„æ¸…ç†/è¿ç§»è„šæœ¬    | `scripts/database/cleanup_v1_*.js`                |

---

## äºŒã€è¿ç§»æ®‹ç•™æ¸…å•ï¼ˆåŸºäºä»£ç æ‰«æ + DBéªŒè¯ï¼‰

### 2.1 QRç V1/V2åŒè½¨ âœ… å·²éƒ¨åˆ†æ¸…ç†

**ç°çŠ¶åˆ†æ**ï¼š

- **ä»£ç å±‚**ï¼š`utils/QRCodeValidator.js` å·²å¼ºåˆ¶æ‹’ç»V1æ ¼å¼ï¼Œä»…æ”¯æŒV2åŠ¨æ€ç 
- **æ•°æ®åº“å±‚**ï¼š`qr_code_version`ã€`is_legacy_v1` å­—æ®µ**å·²åˆ é™¤**ï¼ˆè¿ç§»å·²æ‰§è¡Œï¼‰
- **æ•°æ®å±‚**ï¼š`consumption_records.qr_code` å­—æ®µä¸­ä»å­˜åœ¨V1æ ¼å¼æ•°æ®

**çœŸå®DBéªŒè¯ç»“æœ**ï¼š

```json
{
  "consumption_qr_code_pattern": {
    "v2_count": "0",
    "v1_like_count": "0",
    "total": "0"
  }
}
```

> å½“å‰æ— æ¶ˆè´¹è®°å½•æ•°æ®ï¼ˆè¯•ç”Ÿäº§é˜¶æ®µï¼‰ï¼Œæ— éœ€æ¸…ç†å†å²V1æ•°æ®ã€‚

**æ¸…ç†åŠ¨ä½œ**ï¼š

- [x] åˆ é™¤ `qr_code_version` å­—æ®µ â€” å·²å®Œæˆ
- [x] åˆ é™¤ `is_legacy_v1` å­—æ®µ â€” å·²å®Œæˆ
- [ ] åˆ é™¤ `QRCodeValidator.js` ä¸­çš„V1æ£€æµ‹é€»è¾‘å’Œæ³¨é‡Šï¼ˆä»£ç å±‚é¢ï¼‰
- [ ] åˆ é™¤è¿ç§»è„šæœ¬ `migrations/20260112190000-mark-v1-qrcode-as-legacy.js`
- [ ] åˆ é™¤æ¸…ç†è„šæœ¬ `scripts/database/cleanup_v1_qrcode_data.js`

---

### 2.2 å¸‚åœºåˆ†ç±»å‚æ•°å…¼å®¹ âš ï¸ éœ€æ¸…ç†

**ç°çŠ¶åˆ†æ**ï¼š

- **ä»£ç å±‚**ï¼š`routes/v4/market/listings.js` å·²æ˜¾å¼æ‹’ç» `category` å‚æ•°ï¼Œè¿”å›400é”™è¯¯
- **æ•°æ®åº“å±‚**ï¼š`market_listings` è¡¨ä½¿ç”¨ `listing_kind`ã€`offer_item_category_code`ã€`offer_asset_group_code`

**çœŸå®DBéªŒè¯ç»“æœ**ï¼š

```json
{
  "market_item_snapshot_completeness": {
    "item_total": "0",
    "item_missing_rarity": "0",
    "item_missing_template_id": "0",
    "item_missing_category_code": "0"
  }
}
```

> å½“å‰æ— å¸‚åœºæŒ‚å•æ•°æ®ï¼Œæ–°æ•°æ®ç›´æ¥ä½¿ç”¨æ–°å­—æ®µã€‚

**æ¸…ç†åŠ¨ä½œ**ï¼š

- [x] æ¥å£å±‚æ‹’ç» `category` å‚æ•° â€” å·²å®Œæˆ
- [ ] åˆ é™¤ `listings.js` ä¸­å…³äº `category` çš„å…¼å®¹æ³¨é‡Šå’ŒåºŸå¼ƒè¯´æ˜
- [ ] åˆ é™¤è¿ç§»è„šæœ¬ä¸­çš„ `category` å­—æ®µæ¸…ç†é€»è¾‘ï¼ˆå¦‚æœ‰ï¼‰

---

### 2.3 ç¼©ç•¥å›¾ç”Ÿæˆå…¼å®¹é™çº§ âš ï¸ éœ€æ¸…ç†

**ç°çŠ¶åˆ†æ**ï¼š

- **ä»£ç å±‚**ï¼š`utils/BusinessCacheHelper.js` å’Œå›¾ç‰‡ç›¸å…³æœåŠ¡å­˜åœ¨ `ENABLE_THUMBNAIL_FALLBACK` ç¯å¢ƒå˜é‡
- **é€»è¾‘**ï¼šå½“ `thumbnail_paths` ä¸ºç©ºæ—¶ï¼Œfallbackåˆ°å®æ—¶ç”Ÿæˆç¼©ç•¥å›¾

**çœŸå®DBéªŒè¯ç»“æœ**ï¼š

```json
{
  "image_thumbnail_completeness": {
    "null_thumbnail_paths": "32",
    "has_thumbnail_paths": "10",
    "total": "42"
  }
}
```

> å­˜åœ¨32æ¡è®°å½•ç¼ºå°‘ `thumbnail_paths`ï¼Œéœ€è¦æ‰¹é‡è¡¥å…¨ååˆ é™¤fallbacké€»è¾‘ã€‚

**æ¸…ç†åŠ¨ä½œ**ï¼š

- [ ] ç¼–å†™ä¸€æ¬¡æ€§è„šæœ¬ä¸ºæ‰€æœ‰ `thumbnail_paths IS NULL` çš„è®°å½•ç”Ÿæˆå¹¶å›å¡«ç¼©ç•¥å›¾
- [ ] ç¡®è®¤å›å¡«å®Œæˆåï¼Œåˆ é™¤ `ENABLE_THUMBNAIL_FALLBACK` ç›¸å…³ä»£ç åˆ†æ”¯
- [ ] åˆ é™¤ `generateThumbnails()` çš„å®æ—¶ç”Ÿæˆé€»è¾‘ï¼ˆä»…ä¿ç•™ä¸Šä¼ æ—¶ç”Ÿæˆï¼‰

---

### 2.4 ç”¨æˆ·æƒé™æ¨¡å—æ—§API âš ï¸ éœ€æ¸…ç†

**ç°çŠ¶åˆ†æ**ï¼š

- **ä»£ç å±‚**ï¼š`modules/UserPermissionModule.js` å­˜åœ¨ `@deprecated` æ ‡è®°çš„æ–¹æ³•

**å·²åºŸå¼ƒæ–¹æ³•æ¸…å•**ï¼š
| æ–¹æ³•å | çŠ¶æ€ | æ›¿ä»£æ–¹æ¡ˆ |
|--------|------|----------|
| `setUserRole()` | @deprecated | ä½¿ç”¨ `UserRoleService.assignRole()` |
| `getUserByMobile()` | @deprecated | ä½¿ç”¨ `UserService.findByMobile()` |
| `checkPermission()` | @deprecated | ä½¿ç”¨ `PermissionMiddleware` |

**æ¸…ç†åŠ¨ä½œ**ï¼š

- [ ] å…¨å±€æœç´¢ä¸Šè¿°æ–¹æ³•çš„è°ƒç”¨ç‚¹ï¼Œç¡®è®¤æ— è°ƒç”¨
- [ ] åˆ é™¤ `UserPermissionModule.js` ä¸­çš„åºŸå¼ƒæ–¹æ³•
- [ ] å¦‚æœæ•´ä¸ªæ¨¡å—å·²æ— ç”¨ï¼Œè€ƒè™‘åˆ é™¤æ•´ä¸ªæ–‡ä»¶

---

### 2.5 å¹‚ç­‰æ€§æœåŠ¡è·¯å¾„å…¼å®¹ âš ï¸ éœ€æ¸…ç†

**ç°çŠ¶åˆ†æ**ï¼š

- **ä»£ç å±‚**ï¼š`services/IdempotencyService.js` å­˜åœ¨ `CANONICAL_OPERATION_MAP` å…¼å®¹è·¯å¾„æ˜ å°„

**çœŸå®DBéªŒè¯ç»“æœ**ï¼š

```json
{
  "top_api_idempotency_paths": [
    {
      "api_path": "/api/v4/shop/exchange/exchange",
      "http_method": "POST",
      "status": "completed",
      "c": "15"
    },
    {
      "api_path": "/api/v4/shop/consumption/submit",
      "http_method": "POST",
      "status": "completed",
      "c": "8"
    },
    {
      "api_path": "/api/v4/shop/assets/convert",
      "http_method": "POST",
      "status": "completed",
      "c": "3"
    },
    {
      "api_path": "/api/v4/shop/redemption/orders",
      "http_method": "POST",
      "status": "completed",
      "c": "2"
    }
  ]
}
```

> å½“å‰ä½¿ç”¨çš„è·¯å¾„å·²ç»æ˜¯è§„èŒƒåŒ–è·¯å¾„ï¼ˆ`/api/v4/*`ï¼‰ï¼Œå…¼å®¹æ˜ å°„æœªè¢«è§¦å‘ã€‚

**`CANONICAL_OPERATION_MAP` å…¼å®¹é¡¹ï¼ˆéœ€åˆ é™¤ï¼‰**ï¼š

```javascript
// ä»¥ä¸‹è·¯å¾„æ˜ å°„ä»…ä¸ºå†å²å…¼å®¹ï¼Œåº”åˆ é™¤ï¼š
'/api/v4/market/purchase'     â†’ 'MARKET_PURCHASE'
'/api/v4/market/buy'          â†’ 'MARKET_PURCHASE'  // å…¼å®¹æ—§è·¯å¾„
'/api/v4/points/exchange'     â†’ 'SHOP_EXCHANGE'    // æ—§pointsåŸŸ
```

**æ¸…ç†åŠ¨ä½œ**ï¼š

- [ ] åˆ é™¤ `CANONICAL_OPERATION_MAP` ä¸­çš„å…¼å®¹è·¯å¾„æ¡ç›®
- [ ] ä»…ä¿ç•™å½“å‰å®é™…ä½¿ç”¨çš„è§„èŒƒè·¯å¾„æ˜ å°„
- [ ] åˆ é™¤ä»£ç ä¸­å…³äº"å…¼å®¹è·¯å¾„"çš„æ³¨é‡Š

---

### 2.6 æ—§è·¯ç”±å…¥å£æ®‹ç•™ âš ï¸ éœ€æ¸…ç†

**ç°çŠ¶åˆ†æ**ï¼š

- **ä»£ç å±‚**ï¼š`app.js` ä¸­ä»…æ³¨å†Œ `/api/v4/*` è·¯ç”±ï¼Œæ— æ—§ç‰ˆæœ¬è·¯ç”±
- **ä½†å­˜åœ¨**ï¼š`routes/` ç›®å½•ä¸‹å¯èƒ½æœ‰æœªåˆ é™¤çš„æ—§ç‰ˆæœ¬è·¯ç”±æ–‡ä»¶

**æ¸…ç†åŠ¨ä½œ**ï¼š

- [ ] ç¡®è®¤ `routes/` ç›®å½•ä¸‹æ—  `v1/`ã€`v2/`ã€`v3/` å­ç›®å½•
- [ ] ç¡®è®¤æ—  `/points`ã€`/admin` ç­‰éV4è·¯ç”±å…¥å£
- [ ] åˆ é™¤ `app.js` ä¸­å…³äºæ—§è·¯ç”±çš„æ³¨é‡Šè¯´æ˜

---

### 2.7 å¤‡ä»½æ–‡ä»¶å’Œç›®å½•æ®‹ç•™ ğŸ”´ å¿…é¡»æ¸…ç†

**ç°çŠ¶åˆ†æ**ï¼š

```
/home/devbox/project/
â”œâ”€â”€ app.js.backup
â”œâ”€â”€ app.js.backup.20260108_125922
â”œâ”€â”€ ecosystem.config.js.backup
â”œâ”€â”€ backups/
â”‚   â””â”€â”€ ... (SQLå¤‡ä»½ç­‰)
â”œâ”€â”€ æ•°æ®åº“è¿ç§»è„šæœ¬.sql
```

**æ¸…ç†åŠ¨ä½œ**ï¼š

- [ ] åˆ é™¤æ‰€æœ‰ `.backup` åç¼€æ–‡ä»¶
- [ ] åˆ é™¤ `backups/` ç›®å½•ï¼ˆç¡®è®¤å¤‡ä»½å·²ç§»è‡³å¤–éƒ¨å­˜å‚¨ï¼‰
- [ ] åˆ é™¤æ ¹ç›®å½•çš„ä¸´æ—¶SQLæ–‡ä»¶
- [ ] åˆ é™¤æ‰€æœ‰ `test-*.js`ã€`seed-*.js` æµ‹è¯•è„šæœ¬ï¼ˆç§»è‡³ `tests/` æˆ–åˆ é™¤ï¼‰

---

### 2.8 å·²æ‰§è¡Œçš„è¿ç§»è„šæœ¬æ®‹ç•™ âš ï¸ éœ€è¯„ä¼°

**ç°çŠ¶åˆ†æ**ï¼š
è¿ç§»è„šæœ¬ç›®å½•åŒ…å«å¤§é‡å·²æ‰§è¡Œçš„è¿ç§»ï¼Œéƒ¨åˆ†æ˜¯æ¸…ç†ç±»è„šæœ¬ï¼š

```
migrations/
â”œâ”€â”€ 20260111213816-remove-v1-qrcode-fields.js  â† å·²æ‰§è¡Œï¼Œå¯åˆ é™¤
â”œâ”€â”€ 20260112190000-mark-v1-qrcode-as-legacy.js â† å·²æ‰§è¡Œï¼Œå¯åˆ é™¤
â”œâ”€â”€ 20260114220917-market-category-system-implementation.js
â””â”€â”€ ...
```

**æ¸…ç†ç­–ç•¥**ï¼š

- **ä¿ç•™**ï¼šæ­£å‘è¿ç§»è„šæœ¬ï¼ˆåˆ›å»ºè¡¨ã€åŠ å­—æ®µï¼‰â€” ç”¨äºæ–°ç¯å¢ƒåˆå§‹åŒ–
- **åˆ é™¤**ï¼šæ¸…ç†ç±»è¿ç§»è„šæœ¬ï¼ˆæ ‡è®°legacyã€åˆ é™¤æ—§å­—æ®µï¼‰â€” å·²æ— æ„ä¹‰

---

### 2.9 ç‰©å“èµ„äº§ç±»å‹æ•°æ®å®Œæ•´æ€§ âœ… å·²å®Œå¤‡

**çœŸå®DBéªŒè¯ç»“æœ**ï¼š

```json
{
  "material_asset_types": {
    "missing_group_code": "0",
    "missing_display_name": "0",
    "total": "10"
  }
}
```

> æ‰€æœ‰èµ„äº§ç±»å‹è®°å½•çš„ `group_code` å’Œ `display_name` å‡å·²å¡«å……ï¼Œæ— éœ€æ•°æ®è¡¥å…¨ã€‚

---

## ä¸‰ã€åˆå¹¶æ”¶ç¼©å»ºè®®

### 3.1 è·¯ç”±åŸŸæ”¶ç¼©

å½“å‰V4 APIå­˜åœ¨å¤šä¸ªç»†åˆ†åŸŸï¼Œéƒ¨åˆ†å¯åˆå¹¶ç®€åŒ–ï¼š

| å½“å‰è·¯ç”±                   | å»ºè®®åŠ¨ä½œ | è¯´æ˜                               |
| -------------------------- | -------- | ---------------------------------- |
| `/api/v4/shop/exchange`    | ä¿ç•™     | B2Cç§¯åˆ†å…‘æ¢æ ¸å¿ƒ                    |
| `/api/v4/shop/consumption` | ä¿ç•™     | æ¶ˆè´¹æäº¤æ ¸å¿ƒ                       |
| `/api/v4/shop/redemption`  | ä¿ç•™     | å…‘æ¢è®¢å•æ ¸å¿ƒ                       |
| `/api/v4/shop/assets`      | ä¿ç•™     | èµ„äº§ä½™é¢/æµæ°´æŸ¥è¯¢                  |
| `/api/v4/market/listings`  | ä¿ç•™     | C2Cå¸‚åœºæ ¸å¿ƒ                        |
| `/api/v4/backpack`         | ä¿ç•™     | èƒŒåŒ…æŸ¥è¯¢æ ¸å¿ƒ                       |
| `/api/v4/merchant-points`  | **è¯„ä¼°** | å¦‚ä¸ `shop/consumption` é‡å å¯åˆå¹¶ |
| `/api/v4/activities`       | **è¯„ä¼°** | å¦‚ä»…åŒ…å«æŠ½å¥–å¯åˆå¹¶è‡³ `lottery`     |

### 3.2 æœåŠ¡å±‚æ”¶ç¼©

| æœåŠ¡æ–‡ä»¶                  | å»ºè®®åŠ¨ä½œ | è¯´æ˜                                   |
| ------------------------- | -------- | -------------------------------------- |
| `UserPermissionModule.js` | **åˆ é™¤** | å·²åºŸå¼ƒï¼ŒåŠŸèƒ½å·²è¿ç§»è‡³ `UserRoleService` |
| `DataSanitizer.js`        | ä¿ç•™     | æ•°æ®è„±æ•å·¥å…·                           |
| `IdempotencyService.js`   | **ç²¾ç®€** | åˆ é™¤å…¼å®¹è·¯å¾„æ˜ å°„                       |

### 3.3 æ¨¡å‹å±‚æ”¶ç¼©

| æ¨¡å‹æ–‡ä»¶                   | å»ºè®®åŠ¨ä½œ | è¯´æ˜                          |
| -------------------------- | -------- | ----------------------------- |
| æ‰€æœ‰æ¨¡å‹                   | æ£€æŸ¥     | ç¡®è®¤æ—  `@deprecated` å­—æ®µå®šä¹‰ |
| `ApiIdempotencyRequest.js` | ä¿ç•™     | å¹‚ç­‰æ€§è®°å½•                    |

---

## å››ã€ä¸€æ¬¡æ€§é‡æ„æ‰§è¡Œè®¡åˆ’

### Phase 1: æ•°æ®è¡¥å…¨ï¼ˆå‰ç½®æ¡ä»¶ï¼‰

```bash
# 1. è¡¥å…¨ç¼©ç•¥å›¾æ•°æ®
node scripts/maintenance/backfill-thumbnails.js

# 2. éªŒè¯è¡¥å…¨ç»“æœ
node -e "..." # æŸ¥è¯¢ thumbnail_paths IS NULL æ•°é‡åº”ä¸º0
```

### Phase 2: ä»£ç å±‚æ¸…ç†

```bash
# 1. åˆ é™¤å¤‡ä»½æ–‡ä»¶
rm -f app.js.backup*
rm -f ecosystem.config.js.backup
rm -rf backups/
rm -f æ•°æ®åº“è¿ç§»è„šæœ¬.sql

# 2. åˆ é™¤æµ‹è¯•è„šæœ¬ï¼ˆæˆ–ç§»è‡³tests/ï¼‰
rm -f test-*.js seed-*.js

# 3. åˆ é™¤å·²åºŸå¼ƒçš„è¿ç§»è„šæœ¬
rm -f migrations/20260111213816-remove-v1-qrcode-fields.js
rm -f migrations/20260112190000-mark-v1-qrcode-as-legacy.js

# 4. åˆ é™¤æ¸…ç†è„šæœ¬
rm -f scripts/database/cleanup_v1_qrcode_data.js
```

### Phase 3: ä»£ç é€»è¾‘æ¸…ç†

| æ–‡ä»¶                              | æ¸…ç†å†…å®¹                                    |
| --------------------------------- | ------------------------------------------- |
| `utils/QRCodeValidator.js`        | åˆ é™¤V1æ£€æµ‹é€»è¾‘å’Œç›¸å…³æ³¨é‡Š                    |
| `routes/v4/market/listings.js`    | åˆ é™¤ `category` å‚æ•°çš„åºŸå¼ƒè¯´æ˜æ³¨é‡Š          |
| `services/IdempotencyService.js`  | åˆ é™¤ `CANONICAL_OPERATION_MAP` ä¸­çš„å…¼å®¹è·¯å¾„ |
| `modules/UserPermissionModule.js` | åˆ é™¤åºŸå¼ƒæ–¹æ³•æˆ–æ•´ä¸ªæ–‡ä»¶                      |
| `utils/BusinessCacheHelper.js`    | åˆ é™¤ `ENABLE_THUMBNAIL_FALLBACK` é€»è¾‘       |

### Phase 4: è§„èŒƒå±‚æ¸…ç†

| åŠ¨ä½œ         | è¯´æ˜                                                  |
| ------------ | ----------------------------------------------------- |
| æ›´æ–°APIæ–‡æ¡£  | åˆ é™¤æ‰€æœ‰åºŸå¼ƒå‚æ•°è¯´æ˜                                  |
| æ›´æ–°README   | åˆ é™¤å†å²è¿ç§»è¯´æ˜                                      |
| æ¸…ç†ä»£ç æ³¨é‡Š | åˆ é™¤æ‰€æœ‰ `// å…¼å®¹`ã€`// æ—§æ–¹æ¡ˆ`ã€`// deprecated` æ³¨é‡Š |

---

## äº”ã€éªŒæ”¶æ ‡å‡†

### 5.1 ä»£ç å±‚éªŒæ”¶

```bash
# 1. æ— å…¼å®¹å…³é”®è¯æ®‹ç•™
grep -r "å…¼å®¹\|deprecated\|legacy\|æ—§æ–¹æ¡ˆ\|æ—§è·¯ç”±\|fallback" \
  --include="*.js" \
  --exclude-dir=node_modules \
  --exclude-dir=.git \
  . | wc -l
# é¢„æœŸ: 0 æˆ–ä»…å‰©ä¸šåŠ¡å¿…éœ€çš„ï¼ˆå¦‚lockså¤šç»´é”æ³¨é‡Šï¼‰

# 2. æ— å¤‡ä»½æ–‡ä»¶æ®‹ç•™
find . -name "*.backup*" -o -name "*.bak" | wc -l
# é¢„æœŸ: 0

# 3. æ— æ—§ç‰ˆæœ¬è·¯ç”±
grep -r "api/v[123]" --include="*.js" . | wc -l
# é¢„æœŸ: 0
```

### 5.2 æ•°æ®åº“å±‚éªŒæ”¶

```sql
-- 1. æ— legacyå­—æ®µ
SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_SCHEMA = DATABASE()
  AND (COLUMN_NAME LIKE '%legacy%' OR COLUMN_NAME LIKE '%deprecated%');
-- é¢„æœŸ: 0è¡Œ

-- 2. ç¼©ç•¥å›¾å·²è¡¥å…¨
SELECT COUNT(*) FROM image_resources WHERE thumbnail_paths IS NULL;
-- é¢„æœŸ: 0
```

### 5.3 åŠŸèƒ½å±‚éªŒæ”¶

| åŠŸèƒ½     | éªŒæ”¶æ–¹æ³•                                                    |
| -------- | ----------------------------------------------------------- |
| èƒŒåŒ…æŸ¥è¯¢ | `GET /api/v4/backpack` è¿”å› `assets[]` + `items[]`          |
| å¸‚åœºæŒ‚å• | `POST /api/v4/market/listings` æ”¯æŒ `listing_kind` ä¸¤ç§ç±»å‹ |
| æ¶ˆè´¹æäº¤ | `POST /api/v4/shop/consumption/submit` ä»…æ¥å—V2äºŒç»´ç        |
| ç§¯åˆ†å…‘æ¢ | `POST /api/v4/shop/exchange/exchange` å¹‚ç­‰æ€§æ­£å¸¸            |

---

## å…­ã€å›æ»šç­–ç•¥

### 6.1 ä»£ç å›æ»š

```bash
# ä½¿ç”¨Gitå›æ»šåˆ°é‡æ„å‰commit
git reset --hard <refactor-start-commit>
```

### 6.2 æ•°æ®åº“å›æ»š

- **åŸåˆ™**ï¼šæœ¬æ¬¡é‡æ„**ä¸åˆ é™¤ä»»ä½•ä¸šåŠ¡æ•°æ®è¡¨/å­—æ®µ**ï¼Œä»…åˆ é™¤ï¼š
  - å·²æ— ç”¨çš„è¿ç§»æ ‡è®°å­—æ®µï¼ˆ`qr_code_version`ã€`is_legacy_v1` â€” å·²åˆ é™¤ï¼‰
  - å¤‡ä»½æ–‡ä»¶
- **é£é™©**ï¼šæ— æ•°æ®ä¸¢å¤±é£é™©

### 6.3 å›æ»šè§¦å‘æ¡ä»¶

| æ¡ä»¶                 | è§¦å‘å›æ»š       |
| -------------------- | -------------- |
| æ ¸å¿ƒAPIä¸å¯ç”¨        | æ˜¯             |
| æ•°æ®æŸ¥è¯¢æŠ¥é”™         | æ˜¯             |
| æ€§èƒ½æ˜¾è‘—ä¸‹é™ï¼ˆ>50%ï¼‰ | æ˜¯             |
| éå…³é”®åŠŸèƒ½æŠ¥é”™       | å¦ï¼Œä¿®å¤åç»§ç»­ |

---

## ä¸ƒã€é™„å½•

### A. ä¸šåŠ¡åŒè½¨ä¿ç•™æ¸…å•ï¼ˆç™½åå•ï¼‰

```javascript
// ä»¥ä¸‹"åŒè½¨"è®¾è®¡æ˜¯ä¸šåŠ¡å¿…éœ€ï¼Œç¦æ­¢åˆ é™¤ï¼š

// 1. èƒŒåŒ…åŒè½¨ - BackpackService.js
{
  assets: [],  // å¯å åŠ èµ„äº§ä½™é¢ï¼ˆaccount_asset_balancesï¼‰
  items: []    // ç‰©å“å®ä¾‹ï¼ˆitem_instancesï¼‰
}

// 2. å¸‚åœºåŒè½¨ - MarketListing.js
{
  listing_kind: 'item_instance' | 'fungible_asset'
}

// 3. ç‰©å“é”åŒè½¨ - ItemInstance.js
{
  locks: {
    trade: boolean,      // äº¤æ˜“é”
    redemption: boolean, // å…‘æ¢é”
    security: boolean    // å®‰å…¨é”
  }
}

// 4. äº¤æ˜“é»‘åå• - TradableAssetTypes.js
const C2C_BLACKLISTED_ASSET_CODES = ['POINTS', 'BUDGET_POINTS']
```

### B. çœŸå®æ•°æ®åº“éªŒè¯è„šæœ¬

```javascript
// éªŒè¯æ•°æ®åº“çŠ¶æ€çš„Node.jsè„šæœ¬
require('dotenv').config()
const mysql = require('mysql2/promise')

;(async () => {
  const conn = await mysql.createConnection({
    host: process.env.DB_HOST,
    port: Number(process.env.DB_PORT || 3306),
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    database: process.env.DB_NAME
  })

  // æ£€æŸ¥legacyå­—æ®µ
  const [legacyCols] = await conn.query(
    `
    SELECT TABLE_NAME, COLUMN_NAME 
    FROM INFORMATION_SCHEMA.COLUMNS 
    WHERE TABLE_SCHEMA = ? 
      AND (COLUMN_NAME LIKE '%legacy%' OR COLUMN_NAME LIKE '%deprecated%')
  `,
    [process.env.DB_NAME]
  )

  console.log('Legacy columns:', legacyCols.length === 0 ? 'CLEAN' : legacyCols)

  // æ£€æŸ¥ç¼©ç•¥å›¾è¡¥å…¨
  const [thumbs] = await conn.query(`
    SELECT COUNT(*) AS missing FROM image_resources WHERE thumbnail_paths IS NULL
  `)
  console.log('Missing thumbnails:', thumbs[0].missing)

  await conn.end()
})()
```

### C. æ–‡ä»¶åˆ é™¤æ¸…å•

```
# ç¡®è®¤åˆ é™¤çš„æ–‡ä»¶åˆ—è¡¨
/home/devbox/project/app.js.backup
/home/devbox/project/app.js.backup.20260108_125922
/home/devbox/project/ecosystem.config.js.backup
/home/devbox/project/backups/  (æ•´ä¸ªç›®å½•)
/home/devbox/project/æ•°æ®åº“è¿ç§»è„šæœ¬.sql
/home/devbox/project/migrations/20260111213816-remove-v1-qrcode-fields.js
/home/devbox/project/migrations/20260112190000-mark-v1-qrcode-as-legacy.js
/home/devbox/project/scripts/database/cleanup_v1_qrcode_data.js

# å¯é€‰åˆ é™¤ï¼ˆç§»è‡³tests/æˆ–åˆ é™¤ï¼‰
/home/devbox/project/test-*.js
/home/devbox/project/seed-*.js
```

---

**æ–‡æ¡£ç»“æŸ**

> æœ¬æ–‡æ¡£åŸºäº 2026-01-16 æ—¶åˆ»çš„ä»£ç ä»“åº“å’ŒçœŸå®æ•°æ®åº“çŠ¶æ€ç”Ÿæˆï¼Œæ‰§è¡Œå‰è¯·å†æ¬¡ç¡®è®¤å½“å‰çŠ¶æ€ã€‚
