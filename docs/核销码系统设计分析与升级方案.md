# æ ¸é”€ç ç³»ç»Ÿè®¾è®¡åˆ†æä¸å¤šæ¨¡å‹å‡çº§æ–¹æ¡ˆ

> **é¡¹ç›®**: å¤©å·¥å°ç¨‹åºï¼ˆé¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ V4.2ï¼‰  
> **åˆ›å»ºæ—¶é—´**: 2026-02-20  
> **äºŒæ¬¡æ ¸æŸ¥æ—¶é—´**: 2026-02-20ï¼ˆè¿æ¥çœŸå®æ•°æ®åº“ restaurant_points_dev å®æ—¶æŸ¥è¯¢ + åç«¯æºç é€æ–‡ä»¶æ¯”å¯¹ï¼‰  
> **æ•°æ®æ¥æº**: Node.js mysql2 è¿æ¥çœŸå®æ•°æ®åº“æŸ¥è¯¢ + åç«¯æºç  grep/read æ ¸æŸ¥  
> **çŠ¶æ€**: âœ… å…¨éƒ¨ 20 é¡¹å†³ç­–å·²æ‹æ¿ï¼ˆ11 é¡¹æ ¸å¿ƒ + 5 é¡¹å®æ–½ + 4 é¡¹æ ¸æŸ¥æ–°å¢ï¼‰ï¼Œå¾…å®æ–½

---

## å†³ç­–é€ŸæŸ¥è¡¨ï¼ˆ20 é¡¹å…¨éƒ¨å·²æ‹æ¿ï¼‰

| ç¼–å· | å†³ç­–é¡¹ | æœ€ç»ˆå†³å®š |
|------|--------|---------|
| 1 | å¤šæ¨¡å‹ vs ç»Ÿä¸€æ¨¡å‹ | **Aï¼šé‡‡ç”¨å¤šæ¨¡å‹**ï¼ˆä¸åŒä¸šåŠ¡ç”¨ä¸åŒæ ¸é”€æ–¹å¼ï¼‰ |
| 2 | å®ç‰©æ ¸é”€åŒæ–¹ç¡®è®¤ | **ä¸éœ€è¦ç”¨æˆ·ç¡®è®¤**ï¼ˆå•†å®¶æ‰«ç å³æ ¸é”€ï¼Œäº‹åé€šçŸ¥ï¼‰ |
| 3 | è™šæ‹Ÿ/ç§¯åˆ†æ˜¯å¦è¿›èƒŒåŒ… | **Aï¼šä¸è¿›èƒŒåŒ…**ï¼Œä¸­å¥–ç›´æ¥åˆ°è´¦ |
| 4 | ç§¯åˆ†å•†åŸç¡®è®¤æ”¶è´§ | **Aï¼šåŠ ç¡®è®¤æ”¶è´§**ï¼Œ7å¤©æœªæ“ä½œè‡ªåŠ¨ç¡®è®¤ |
| 5 | C2Cäº¤æ˜“æ‹…ä¿ç  | **Aï¼šä»…å®ç‰©äº¤æ˜“ç”¨** |
| 6 | CDKeyæ‰¹é‡åˆ†å‘ | **Bï¼šä»…è®¾è®¡ä¸å®æ–½**ï¼Œç­‰ä¸šåŠ¡éœ€è¦æ—¶å¯åŠ¨ |
| 7 | QR ç æ ¸é”€ | **B + B-2ï¼šQRç  + æ–‡æœ¬ç å¹¶å­˜ + åŠ¨æ€HMACç­¾å** |
| 8 | æ ¸é”€é—¨åº—å…³è” | **Aï¼šå¼ºåˆ¶å…³è”**ï¼ˆé€šè¿‡ store_staff è‡ªåŠ¨ç¡®å®šï¼‰ |
| 9 | æ ¸é”€ç æœ‰æ•ˆæœŸ | **Cï¼šè¿è¥å¯é…ç½®**ï¼ˆsystem_configs å…¨å±€é»˜è®¤ + å¥–å“çº§åˆ«è¦†ç›–ï¼‰ |
| 10 | SHA-256 ä¸å¯é€† | **Aï¼šç»´æŒä¸å¯é€†**ï¼ˆä¸¢å¤±ç å°±å–æ¶ˆé‡ç”Ÿæˆï¼‰ |
| 11 | ç”¨æˆ·ç¡®è®¤ç¯èŠ‚ | **ä¸éœ€è¦**ï¼ˆæ‰€æœ‰åˆ°åº—æ ¸é”€å‡ä¸ºå•†å®¶å•æ–¹æ‰«ç å³å®Œæˆï¼‰ |
| P1 | exchange_records çŠ¶æ€æ‰©å±• | **Aï¼šä¸€æ¬¡æ€§åŠ å…¨éƒ¨**ï¼ˆapproved/received/rated/rejected/refundedï¼‰ |
| P2 | è™šæ‹Ÿå¥–å“åˆ›å»º item_instance | **Aï¼šä¸åˆ›å»º**ï¼ˆçº¯æ•ˆæœç±» prize_value=0ï¼›æœªæ¥æ–°ç±»å‹ç”¨æ–° prize_type æ‰©å±•ï¼‰ |
| P3 | æ‹…ä¿ç è¶…æ—¶å¤„ç† | **Cï¼šé˜¶æ¢¯å¼**ï¼ˆ4hæé†’â†’24hè‡ªåŠ¨å–æ¶ˆâ†’å¼‚è®®èµ°adminåå°ï¼‰ |
| P4 | store_staff æµ‹è¯•æ•°æ® | **Aï¼šå…ˆè¡¥æ•°æ®**ï¼ˆseeders è¡¥å……æ´»è·ƒè®°å½•ï¼‰ |
| P5 | æ ¸é”€è¿‡æœŸæ¸…ç†é¢‘ç‡ | **B+æ‡’è¿‡æœŸï¼šæ¯å¤©å‡Œæ™¨æ‰¹é‡ + æŸ¥è¯¢æ—¶ isExpired() å®æ—¶åˆ¤æ–­** |
| **P6** | **å•†å®¶æ ¸é”€æƒé™é˜ˆå€¼** | **âœ… Aï¼š`>= 20`** + store_staff ç»‘å®šæ ¡éªŒï¼ˆç¾å›¢/å£ç¢‘æ¨¡å¼ï¼šç»‘å®šå…³ç³»=æƒé™ï¼‰ |
| **P7** | **æ ¸é”€QRç å®ç°æ–¹å¼** | **âœ… Aï¼šæ–°å»ºç‹¬ç«‹ `RedemptionQRSigner.js`** + ç‹¬ç«‹å¯†é’¥ï¼ˆæ”¯ä»˜å®/å¾®ä¿¡/ç¾å›¢æ¨¡å¼ï¼šä¸åŒQRç‹¬ç«‹ç³»ç»Ÿï¼‰ |
| **P8** | **æ ¸é”€æœ‰æ•ˆæœŸé…ç½®å­˜å‚¨** | **âœ… Aï¼šSystemSettings æ–°å¢ `redemption` category**ï¼ˆé˜¿é‡Œ/ç¾å›¢æ¨¡å¼ï¼šç»Ÿä¸€é…ç½®å…¥å£ï¼‰ |
| **P9** | **Adminå‰ç«¯æ ¸é”€ç®¡ç†åŒè·¯å¾„åˆå¹¶** | **âœ… Aï¼šä¿ç•™ operations è·¯å¾„ï¼ŒåºŸå¼ƒ lottery é‡å¤ä»£ç **ï¼ˆå¤§å‚åŸåˆ™ï¼šä¸€ä¸ªåŠŸèƒ½ä¸€ä¸ªå½’å±æ¨¡å—ï¼‰ |

---

## ä¸€ã€é¡¹ç›®æŠ€æœ¯æ¡†æ¶å…¨æ™¯ï¼ˆçœŸå®ä»£ç ç¡®è®¤ï¼‰

### 1.1 åç«¯æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯é€‰å‹ | ç‰ˆæœ¬ |
|------|---------|------|
| è¿è¡Œæ—¶ | Node.js | â‰¥20.18.0 |
| Webæ¡†æ¶ | Express | ^4.18.2 |
| ORM | Sequelize | ^6.35.2 |
| æ•°æ®åº“ | MySQLï¼ˆmysql2é©±åŠ¨ï¼‰ | ^3.6.5 |
| ç¼“å­˜ | Redisï¼ˆioredisï¼‰ | ^5.7.0 |
| è®¤è¯ | JWTï¼ˆjsonwebtokenï¼‰ | ^9.0.2 |
| å®æ—¶é€šä¿¡ | Socket.IO | ^4.8.1 |
| æ—¥å¿— | Winston | ^3.11.0 |
| å®šæ—¶ä»»åŠ¡ | node-cron | ^3.0.3 |
| å‚æ•°æ ¡éªŒ | Joi | ^17.11.0 |
| å¯¹è±¡å­˜å‚¨ | Sealos + AWS SDK | ^2.1691.0 |
| æ—¶åŒº | å…¨é“¾è·¯åŒ—äº¬æ—¶é—´ | TZ=Asia/Shanghai |

**API æ¶æ„**ï¼šRESTfulï¼Œè·¯å¾„è§„èŒƒ `/api/v4/{resource}`ï¼Œæ‰å¹³åŒ–èµ„æºå¯¼å‘è®¾è®¡ã€‚

### 1.2 Webç®¡ç†åå°å‰ç«¯æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯é€‰å‹ |
|------|---------|
| UIæ¡†æ¶ | **Alpine.js**ï¼ˆè½»é‡çº§å“åº”å¼ï¼‰ |
| æ¨¡æ¿å¼•æ“ | **EJS**ï¼ˆæœåŠ¡ç«¯æ¸²æŸ“ HTMLï¼‰ |
| CSS | **Tailwind CSS** |
| JSæ¨¡å— | ES Moduleï¼ˆimport/exportï¼‰ï¼Œvanilla JS composable æ¨¡å¼ |
| å›¾è¡¨ | EChartsï¼ˆæ‡’åŠ è½½ï¼‰ |
| é¡µé¢ç»„ç»‡ | æ¯ä¸ªåŠŸèƒ½ä¸€ä¸ª HTML é¡µé¢ + å¯¹åº” composable JS |

**å…³é”®ç‚¹**ï¼šadmin å‰ç«¯ä¸æ˜¯ SPAï¼ˆVue/Reactï¼‰ï¼Œæ˜¯ MPAï¼ˆMulti-Page Applicationï¼‰ï¼Œæ¯ä¸ªé¡µé¢ç‹¬ç«‹åŠ è½½ Alpine.js ç»„ä»¶ã€‚API è°ƒç”¨å°è£…åœ¨ `admin/src/api/` ä¸‹ï¼Œä½¿ç”¨ `admin/src/api/base.js` ç»Ÿä¸€å°è£…çš„ `request()` å‡½æ•°ã€‚

### 1.3 å¾®ä¿¡å°ç¨‹åºå‰ç«¯

ï¼ˆä¸åœ¨æœ¬ä»“åº“å†…ï¼Œå±äºç‹¬ç«‹é¡¹ç›®ï¼Œé€šè¿‡ `/api/v4/` æ¥å£ä¸åç«¯é€šä¿¡ï¼‰

### 1.4 æ•°æ®åº“æ¦‚è§ˆï¼ˆçœŸå®æ•°æ® 96 å¼ è¡¨ï¼Œ2026-02-20 å®æ—¶æŸ¥è¯¢ï¼‰

| ä¸šåŠ¡åŸŸ | æ ¸å¿ƒè¡¨ | çœŸå®æ•°æ®é‡ | å…³é”®å­—æ®µçº æ­£ |
|--------|-------|-----------|-------------|
| æ ¸é”€ç  | `redemption_orders` | 1,211 æ¡ | PK=`redemption_order_id`(UUID) |
| ç‰©å“å®ä¾‹ | `item_instances` | 6,559 æ¡ | **æ—  `item_name` åˆ—**ï¼Œåç§°åœ¨ `meta` JSON çš„ `meta.name` |
| æŠ½å¥–å¥–å“ | `lottery_prizes` | 15 æ¡ | PK=`lottery_prize_id`(é prize_id)ï¼›`stock_quantity`(é stock)ï¼›`prize_type` æœ‰ **7 ä¸ªå€¼** |
| ç§¯åˆ†å•†åŸ | `exchange_records` / `exchange_items` | 5ï¼ˆ4 pending + 1 shippedï¼‰/ å¤šæ¡ | `exchange_records` å·²æœ‰ `rating` + `rated_at` å­—æ®µ |
| äº¤æ˜“å¸‚åœº | `market_listings` / `trade_orders` | 294 / 133ï¼ˆcompleted=19ï¼‰ | `listing_kind`: item_instance / fungible_asset |
| é—¨åº— | `stores` / `store_staff` | 5 / 3 | `store_staff` å­—æ®µæ˜¯ `role_in_store`ï¼ˆé roleï¼‰ï¼ŒENUM: staff/manager |
| è§’è‰²æƒé™ | `roles` / `user_roles` | 11ï¼ˆå« test_role_apiï¼‰/ 57 | `role_level` èŒƒå›´ -1 ~ 100 |
| èµ„äº§è´¦æœ¬ | `account_asset_balances` | å¤šæ¡ï¼ˆ7ç§èµ„äº§ï¼‰ | â€” |
| ç³»ç»Ÿé…ç½® | `system_configs` | 11 æ¡ | ç®¡ç†åå°é€šè¿‡ `SystemSettings` æ¨¡å‹ï¼ˆ`/api/v4/console/settings`ï¼‰ç®¡ç†ï¼Œéç›´æ¥æ“ä½œæ­¤è¡¨ |

**âš ï¸ æœ¬æ¬¡æ ¸æŸ¥å‘ç°çš„é‡è¦å­—æ®µåå·®å¼‚**ï¼ˆä¸Šç‰ˆæ–‡æ¡£ä½¿ç”¨äº†ä¸å‡†ç¡®çš„å­—æ®µåï¼‰ï¼š

| æ–‡æ¡£åŸæè¿° | æ•°æ®åº“çœŸå®å­—æ®µ | å½±å“èŒƒå›´ |
|-----------|-------------|---------|
| `prize_id` | `lottery_prize_id` | lottery_prizes ä¸»é”® |
| `stock` | `stock_quantity` | lottery_prizes åº“å­˜å­—æ®µ |
| `role`ï¼ˆstore_staffï¼‰ | `role_in_store` | store_staff è§’è‰²å­—æ®µï¼ŒENUM('staff','manager') |
| `item_name`ï¼ˆitem_instancesï¼‰ | ä¸å­˜åœ¨ï¼Œåœ¨ `meta` JSON çš„ `.name` å±æ€§ | item_instances ç‰©å“åç§°è·å–æ–¹å¼ |
| `prize_type` ä»… 4 å€¼ | å®é™… 7 å€¼: points/coupon/physical/virtual/**service/product/special** | lottery_prizes å¥–å“ç±»å‹ |

---

## äºŒã€é¡¹ç›®å•†ä¸šæ¨¡å¼æ¦‚è¿°

é¤å…ç§¯åˆ†æŠ½å¥–è¥é”€ç³»ç»Ÿçš„å•†ä¸šé—­ç¯ï¼š

```
ç”¨æˆ·åˆ°åº—æ¶ˆè´¹ â†’ è·å¾—ç§¯åˆ† â†’ èŠ±ç§¯åˆ†æŠ½å¥– â†’ ä¸­å¥–å¾—åˆ°ç‰©å“ï¼ˆä¼˜æƒ åˆ¸/å®ç‰©ï¼‰ â†’ ç”Ÿæˆæ ¸é”€ç  â†’ åˆ°åº—å‡ºç¤ºæ ¸é”€ç  â†’ å•†å®¶æ ¸é”€ â†’ ç‰©å“æ¶ˆè€—
```

æ ¸é”€ç çš„å®šä½ï¼š**çº¿ä¸Šå¥–å“ â†’ çº¿ä¸‹å…‘æ¢çš„æ¡¥æ¢å‡­è¯**ã€‚

---

## ä¸‰ã€å½“å‰æ ¸é”€ç è®¾è®¡è¯¦è§£ï¼ˆåŸºäºä»£ç å’ŒçœŸå®æ•°æ®åº“ï¼‰

### 3.1 æ ¸å¿ƒæ–‡ä»¶æ¸…å•

| å±‚çº§ | æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|------|----------|------|
| ç”Ÿæˆå™¨ | `utils/RedemptionCodeGenerator.js` | æ ¸é”€ç ç”Ÿæˆã€å“ˆå¸Œè®¡ç®—ã€æ ¼å¼éªŒè¯ |
| æœåŠ¡å±‚ | `services/RedemptionService.js` | è®¢å•å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆåˆ›å»º/æ ¸é”€/å–æ¶ˆ/è¿‡æœŸï¼‰ |
| æ•°æ®æ¨¡å‹ | `models/RedemptionOrder.js` | æ•°æ®åº“è¡¨å®šä¹‰å’Œå…³è”å…³ç³» |
| ç”¨æˆ·è·¯ç”± | `routes/v4/backpack/index.js` | ç”¨æˆ·ç”Ÿæˆæ ¸é”€ç  `/items/:item_instance_id/redeem` |
| å•†å®¶è·¯ç”± | `routes/v4/shop/redemption/fulfill.js` | å•†å®¶æ‰«ç /è¾“ç æ ¸é”€ `POST /fulfill` |
| ç®¡ç†è·¯ç”± | `routes/v4/console/business-records.js` | ç®¡ç†å‘˜åå°æ ¸é”€ç®¡ç†ï¼ˆåˆ—è¡¨/æ‰¹é‡/ç»Ÿè®¡/å¯¼å‡ºï¼‰ |
| å‰ç«¯API | `admin/src/api/redemption.js` | ç®¡ç†åå°æ ¸é”€æ¥å£å°è£…ï¼ˆAlpine.js è°ƒç”¨ï¼‰ |
| å‰ç«¯é¡µé¢ | `admin/redemption-management.html` + `admin/src/modules/operations/pages/redemption-management.js` | æ ¸é”€ç ç®¡ç†é¡µé¢ |

### 3.2 æ ¸é”€ç çš„"èº«ä»½è¯"ä½“ç³»

æ¯ä¸ªæ ¸é”€ç æœ‰ä¸‰å±‚å”¯ä¸€æ ‡è¯†ï¼š

| èº«ä»½å±‚ | å­—æ®µ | æ ¼å¼ | ç”¨é€” |
|--------|------|------|------|
| ç”¨æˆ·çœ‹åˆ°çš„å‡­è¯ | æ˜æ–‡ç  | `EWB3-WE4G-F625`ï¼ˆ12ä½Base32ï¼‰ | ç»™å•†å®¶å‡ºç¤º |
| æ•°æ®åº“å­˜å‚¨æ ‡è¯† | `code_hash` | SHA-256ï¼ˆ64ä½hexï¼‰ï¼Œå”¯ä¸€çº¦æŸ | æŸ¥æ‰¾å’ŒéªŒè¯ |
| ç³»ç»Ÿå†…éƒ¨æ ‡è¯† | `redemption_order_id` | UUID v4 | åå°ç®¡ç†æ“ä½œ |

å…³é”®å®‰å…¨è®¾è®¡ï¼š**ç³»ç»Ÿåªå­˜å“ˆå¸Œå€¼ï¼Œä¸å­˜æ˜æ–‡ç **ï¼ˆå†³ç­–10ï¼šç»´æŒ SHA-256 ä¸å¯é€†ï¼‰ã€‚æ˜æ–‡ç åœ¨ç”Ÿæˆæ—¶è¿”å›ç»™ç”¨æˆ·ä¸€æ¬¡ï¼Œä¹‹åç³»ç»Ÿæ— æ³•è¿˜åŸã€‚ç”¨æˆ·ä¸¢å¤±ç æ—¶ï¼Œå–æ¶ˆæ—§è®¢å•é‡æ–°ç”Ÿæˆã€‚

### 3.3 æ ¸é”€ç æ ¼å¼è§„èŒƒ

```
å­—ç¬¦é›†: 23456789ABCDEFGHJKMNPQRSTUVWXYZï¼ˆ30ä¸ªå­—ç¬¦ï¼‰
å»é™¤äº†: 0(é›¶)/O(å­—æ¯)/I(å­—æ¯)/L(å­—æ¯)/1(æ•°å­—) â€”â€” é˜²æ­¢ç”¨æˆ·çœ‹æ··
é•¿åº¦:   12ä½ï¼Œåˆ†3ç»„
æ ¼å¼:   XXXX-YYYY-ZZZZ
ç¤ºä¾‹:   3K7J-2MQP-WXYZ
```

ç”Ÿæˆç®—æ³•ï¼š`crypto.randomInt()` é€å­—ç¬¦ä»å­—ç¬¦é›†ä¸­éšæœºé€‰å–ï¼Œç”Ÿæˆåç®— SHA-256 æŸ¥åº“ç¡®è®¤å”¯ä¸€æ€§ï¼Œæœ€å¤šé‡è¯• 3 æ¬¡ã€‚

### 3.4 æ•°æ®åº“è¡¨ç»“æ„ï¼ˆredemption_ordersï¼‰â€” çœŸå® DESCRIBE æŸ¥è¯¢

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| `redemption_order_id` | CHAR(36) | PRI | è®¢å•IDï¼ˆUUIDï¼‰ |
| `code_hash` | VARCHAR(64) | UNI | æ ¸é”€ç SHA-256å“ˆå¸Œ |
| `item_instance_id` | BIGINT | FK â†’ item_instances | å…³è”ç‰©å“å®ä¾‹ |
| `redeemer_user_id` | INT | FK â†’ users, å¯NULL | æ ¸é”€äººï¼ˆæ ¸é”€å‰ä¸ºNULLï¼‰ |
| `status` | ENUM | ç´¢å¼• | pending/fulfilled/cancelled/expired |
| `expires_at` | DATETIME | NOT NULL | è¿‡æœŸæ—¶é—´ï¼ˆåˆ›å»ºå30å¤©ï¼‰ |
| `fulfilled_at` | DATETIME | å¯NULL | å®é™…æ ¸é”€æ—¶é—´ |
| `created_at` | DATETIME | DEFAULT NOW | åˆ›å»ºæ—¶é—´ |
| `updated_at` | DATETIME | ON UPDATE NOW | æ›´æ–°æ—¶é—´ |

**âš ï¸ å½“å‰ç¼ºå¤±å­—æ®µï¼ˆå‡çº§éœ€æ–°å¢ï¼‰**ï¼šæ—  `fulfilled_store_id`ã€æ—  `fulfilled_by_staff_id`ï¼Œæ— æ³•è¿½è¸ªæ ¸é”€é—¨åº—å’Œæ“ä½œå‘˜å·¥ã€‚

### 3.5 çœŸå®æ•°æ®ç»Ÿè®¡ï¼ˆ2026-02-20 æŸ¥è¯¢ï¼‰

| çŠ¶æ€ | æ•°é‡ | å æ¯” |
|------|------|------|
| pendingï¼ˆå¾…æ ¸é”€ï¼‰ | 641 | 52.9% |
| expiredï¼ˆå·²è¿‡æœŸï¼‰ | 564 | 46.6% |
| fulfilledï¼ˆå·²æ ¸é”€ï¼‰ | 5 | 0.4% |
| cancelledï¼ˆå·²å–æ¶ˆï¼‰ | 1 | 0.1% |
| **æ€»è®¡** | **1,211** | 100% |

æ ¸é”€ç‰©å“ç±»å‹åˆ†å¸ƒï¼ˆé€šè¿‡ JOIN item_instances æŸ¥è¯¢ç¡®è®¤ï¼‰ï¼š

| ç‰©å“ç±»å‹(item_type) | å·²æ ¸é”€æ•° |
|----------|----------|
| voucher | 4 |
| product | 1 |

ç‰©å“å®ä¾‹æ€»è§„æ¨¡ï¼ˆçœŸå®ç»Ÿè®¡ï¼‰ï¼š

| item_type | available | locked | transferred | used | expired | åˆè®¡ |
|-----------|-----------|--------|-------------|------|---------|------|
| voucher | 1,868 | 949 | 266 | 1,419 | 3 | 4,505 |
| product | 1,665 | 6 | 0 | 2 | 0 | 1,673 |
| tradable_item | 34 | 0 | 102 | 0 | 0 | 136 |
| prize | 1 | 47 | 0 | 0 | 0 | 48 |
| nullï¼ˆå†å²æ•°æ®ï¼‰ | 2 | 126 | 69 | 0 | 0 | 197 |

### 3.6 è®¢å•çŠ¶æ€æµè½¬

```
ç‰©å“çŠ¶æ€: available â”€â”€â†’ locked(redemptioné”,30å¤©) â”€â”€â†’ usedï¼ˆæ ¸é”€æˆåŠŸï¼‰
                                                    â†—
è®¢å•çŠ¶æ€: pending â”€â”€â†’ fulfilledï¼ˆå•†å®¶/ç®¡ç†å‘˜æ ¸é”€æˆåŠŸï¼‰
                   â”œâ†’ expiredï¼ˆè¶…30å¤©è‡ªåŠ¨è¿‡æœŸ â†’ ç‰©å“è§£é”æ¢å¤availableï¼‰
                   â””â†’ cancelledï¼ˆå–æ¶ˆ â†’ ç‰©å“è§£é”æ¢å¤availableï¼‰
```

### 3.7 æƒé™ä½“ç³»ï¼ˆçœŸå® roles è¡¨æ•°æ® + æ ¸é”€æƒé™å®é™…ä»£ç æ ¸æŸ¥ï¼‰

| è§’è‰² | role_name | role_level | ç”¨æˆ·æ•° | æ ¸é”€ç ç›¸å…³æƒé™ | **å®é™…èƒ½å¦æ ¸é”€ï¼Ÿ** |
|------|-----------|-----------|--------|---------------|-----------------|
| ç³»ç»Ÿä»»åŠ¡ | system_job | -1 | 1 | åå°å®šæ—¶ä»»åŠ¡æ‰§è¡Œ | â€” |
| æ™®é€šç”¨æˆ· | user | 0 | 46 | ä¸ºè‡ªå·±çš„ç‰©å“ç”Ÿæˆæ ¸é”€ç  | âŒ ä¸èƒ½æ ¸é”€ |
| æ´»åŠ¨è§’è‰² | campaign_2 | 10 | 2 | æ´»åŠ¨å‚ä¸ | âŒ ä¸èƒ½æ ¸é”€ |
| æµ‹è¯•è§’è‰² | test_role_api | 15 | 0 | æµ‹è¯•ç”¨ | âŒ ä¸èƒ½æ ¸é”€ |
| å•†å®¶å‘˜å·¥ | merchant_staff | 20 | 0 | **âš ï¸ è®¾è®¡ä¸Šåº”èƒ½æ ¸é”€** | âŒ **å®é™…ä¸èƒ½**ï¼ˆrole_level < 50ï¼‰ |
| è¿è¥ | ops | 30 | 1 | åå°æŸ¥çœ‹æ ¸é”€è®¢å•ï¼ˆåªè¯»ï¼‰ | âŒ **å®é™…ä¸èƒ½**ï¼ˆrole_level < 50ï¼‰ |
| ä¸šåŠ¡å‘˜ | sales_staff | 40 | 0 | æ¶ˆè´¹å½•å…¥ | âŒ **å®é™…ä¸èƒ½**ï¼ˆrole_level < 50ï¼‰ |
| å•†å®¶åº—é•¿ | merchant_manager | 40 | 1 | **âš ï¸ è®¾è®¡ä¸Šåº”èƒ½æ ¸é”€** | âŒ **å®é™…ä¸èƒ½**ï¼ˆrole_level < 50ï¼‰ |
| ä¸šåŠ¡ç»ç† | business_manager | 60 | 2 | ç®¡ç†ä¸šåŠ¡å‘˜ | âœ… å¯ä»¥æ ¸é”€ï¼ˆâ‰¥50ï¼‰ |
| åŒºåŸŸè´Ÿè´£äºº | regional_manager | 80 | 0 | æŸ¥çœ‹æ‰€æœ‰æ ¸é”€æ•°æ® | âœ… å¯ä»¥æ ¸é”€ï¼ˆâ‰¥50ï¼‰ |
| ç®¡ç†å‘˜ | admin | 100 | 4 | æ‰€æœ‰æƒé™ | âœ… å¯ä»¥æ ¸é”€ï¼ˆâ‰¥50ï¼‰ |

**ğŸ”´ å…³é”®å‘ç°**ï¼š`routes/v4/shop/redemption/fulfill.js` ç¬¬ 70 è¡Œç¡¬ç¼–ç  `role_level >= 50`ï¼Œå¯¼è‡´ **merchant_staff(20) å’Œ merchant_manager(40) å®é™…ä¸Šæ— æ³•æ‰§è¡Œæ ¸é”€æ“ä½œ**ã€‚è¿™ä¸ä¸šåŠ¡è®¾è®¡æ„å›¾ï¼ˆå•†å®¶å‘˜å·¥åº”è¯¥èƒ½æ ¸é”€ï¼‰ä¸¥é‡çŸ›ç›¾ã€‚**â†’ æ–°å¢å†³ç­– P6 å¾…æ‹æ¿**ã€‚

### 3.8 å®‰å…¨ç‰¹æ€§

| å®‰å…¨æœºåˆ¶ | å®ç°æ–¹å¼ |
|----------|---------|
| ç ä¸å¯é€† | åªå­˜ SHA-256 å“ˆå¸Œï¼Œä¸å­˜æ˜æ–‡ï¼ˆå†³ç­–10 ç¡®è®¤ç»´æŒï¼‰ |
| é˜²å¹¶å‘æ ¸é”€ | SELECT ... FOR UPDATE è¡Œé” |
| é˜²é‡å¤ç”Ÿæˆ | åŒä¸€ç‰©å“åªèƒ½æœ‰ä¸€ä¸ª pending è®¢å• |
| é˜²è¶Šæƒ | æœåŠ¡å±‚å…œåº•ï¼šæ‰€æœ‰æƒ + role_level åŒæ ¡éªŒ |
| ç‰©å“é˜²åŒèŠ± | ç”Ÿæˆç åç«‹å³é”å®šç‰©å“ï¼ˆredemption é”ï¼Œ30å¤©TTLï¼‰ |
| äº‹åŠ¡å®Œæ•´æ€§ | å¼ºåˆ¶å¤–éƒ¨äº‹åŠ¡ä¼ å…¥ï¼ˆ`assertAndGetTransaction`ï¼‰ï¼Œæ‰€æœ‰å†™æ“ä½œåœ¨äº‹åŠ¡è¾¹ç•Œå†… |
| æ•°æ®è„±æ• | æ™®é€šç”¨æˆ·çœ‹ä¸åˆ°æ ¸é”€ç å­—æ®µï¼Œç®¡ç†å‘˜å¯è§ |

---

## å››ã€æ–‡æ¡£ä¸å®é™…ä»£ç /æ•°æ®åº“å·®å¼‚æ ¸æŸ¥ï¼ˆå…³é”®å‘ç°ï¼‰

> ä»¥ä¸‹æ˜¯æœ¬æ¬¡å¯¹çœŸå®ä»£ç  + çœŸå®æ•°æ®åº“æŸ¥è¯¢åå‘ç°çš„é—®é¢˜ï¼ŒæŒ‰å½’å±æ–¹åˆ†ç±»ã€‚

### 4.1 åç«¯æ•°æ®åº“é¡¹ç›®çš„é—®é¢˜ï¼ˆ2026-02-20 æºç +æ•°æ®åº“æ ¸æŸ¥ä¿®æ­£ï¼‰

| # | é—®é¢˜ | ç°çŠ¶ï¼ˆçœŸå®ä»£ç /æ•°æ®åº“ç¡®è®¤ï¼‰ | å½±å“ | æ‰€éœ€æ“ä½œ |
|---|------|--------------------------|------|---------|
| B1 | `redemption_orders` ç¼ºå°‘é—¨åº—å…³è”å­—æ®µ | è¡¨ä¸­ç¡®å®æ—  `fulfilled_store_id`ã€`fulfilled_by_staff_id`ï¼ˆDESCRIBE ç¡®è®¤ï¼‰ | æ— æ³•è¿½è¸ªæ ¸é”€å‘ç”Ÿåœ¨å“ªä¸ªé—¨åº—ã€å“ªä¸ªå‘˜å·¥æ“ä½œ | æ–°å¢è¿ç§»æ–‡ä»¶æ·»åŠ å­—æ®µ |
| B2 | `lottery_prizes.prize_type` æœ‰ 7 ä¸ªå€¼ | ENUM å®é™…ä¸º `points/coupon/physical/virtual/service/product/special`ï¼ˆéæ–‡æ¡£åŸå†™çš„ 4 ä¸ªï¼‰ | è°ƒåº¦å±‚éœ€è¦†ç›–å…¨éƒ¨ 7 ç§ç±»å‹çš„è·¯ç”±è§„åˆ™ï¼Œ`service`/`product`/`special` ç±»å‹éœ€æ˜ç¡®æ ¸é”€æ¨¡å‹å½’å± | ç»Ÿä¸€è°ƒåº¦å±‚è¡¥å…… service/product/special çš„è·¯ç”±è§„åˆ™ |
| B3 | `exchange_records` ç¼ºå°‘ `received` çŠ¶æ€ä½†**å·²æœ‰** `rating`/`rated_at` å­—æ®µ | ENUM ä»… `pending/completed/shipped/cancelled`ï¼›ä½†è¡¨ä¸­**å·²å­˜åœ¨** `rating`(tinyint) å’Œ `rated_at`(datetime) åˆ— | æ¨¡å‹C"ç¡®è®¤æ”¶è´§"éœ€æ‰©å±• ENUMï¼›è¯„ä»·åŠŸèƒ½ DB å±‚å·²éƒ¨åˆ†å°±ç»ª | è¿ç§»æ‰©å±• ENUM + å¤ç”¨å·²æœ‰ rating/rated_at å­—æ®µ |
| B4 | `system_configs` æ— æ ¸é”€æœ‰æ•ˆæœŸé…ç½®é¡¹ | 11 ä¸ªé…ç½®é¡¹ä¸­ä»…æœ‰ `batch_rate_limit_redemption`ï¼ˆé™æµé…ç½®ï¼‰ï¼Œæ— é»˜è®¤æœ‰æ•ˆæœŸ | å†³ç­–9"è¿è¥å¯é…ç½®æœ‰æ•ˆæœŸ"æ— æ³•å®ç° | **â†’ æ–°å¢å†³ç­– P8**ï¼šé€‰æ‹© system_configs è¿˜æ˜¯ SystemSettings å­˜å‚¨ |
| B5 | `store_staff` å…¨éƒ¨ inactiveï¼Œä¸”å­—æ®µåä¸ä¸Šç‰ˆæ–‡æ¡£ä¸ç¬¦ | 3 æ¡è®°å½•å‡ `status=inactive`ï¼›**å­—æ®µæ˜¯ `role_in_store`ï¼ˆé roleï¼‰**ï¼ŒENUM: `staff/manager`ï¼›**status ENUM æœ‰ 4 å€¼**: `active/inactive/pending/deleted` | é—¨åº—å…³è”æ ¸é”€ç¼ºæµ‹è¯•æ•°æ®ï¼›ä¸Šç‰ˆæ–‡æ¡£å­—æ®µåé”™è¯¯éœ€å…¨å±€æ›´æ­£ | seeders è¡¥å…… active è®°å½• |
| B6 | `CONSUMPTION_QR_SECRET` å·²é…ç½®ä¸”**å·²è¢«æ¶ˆè´¹å½•å…¥QRç³»ç»Ÿä½¿ç”¨** | `.env` å·²æœ‰å¯†é’¥ï¼Œ**`utils/QRCodeValidator.js` å·²ç”¨äºæ¶ˆè´¹å½•å…¥äºŒç»´ç **ï¼ˆV2æ ¼å¼ï¼šç”¨æˆ·èº«ä»½æ‰«ç ï¼‰ï¼Œä¸æ ¸é”€ç æ˜¯**å®Œå…¨ç‹¬ç«‹çš„ä¸¤å¥—ç³»ç»Ÿ** | **æ ¸é”€QRç ä¸èƒ½å¤ç”¨ QRCodeValidator.js**ï¼Œéœ€ç‹¬ç«‹å®ç° | **â†’ æ–°å¢å†³ç­– P7**ï¼šæ–°å»º `RedemptionQRSigner.js` vs æ‰©å±•ç°æœ‰ |
| B7 | CDKey è¡¨ä¸å­˜åœ¨ | æ•°æ®åº“ä¸­æ—  `cdkey_batches`ã€`cdkey_codes` è¡¨ | æ¨¡å‹E æš‚ä¸å½±å“ï¼ˆå†³ç­–6ï¼šä»…è®¾è®¡ä¸å®æ–½ï¼‰ | æœªæ¥éœ€è¦æ—¶åˆ›å»º |
| ~~B8~~ | ~~æ ¸é”€ç è¿‡æœŸæ¸…ç†æ—  cron è°ƒåº¦~~ | **âŒ ä¸Šç‰ˆæ–‡æ¡£é”™è¯¯**ï¼šcron è°ƒåº¦**å·²å­˜åœ¨**äº `scripts/maintenance/scheduled_tasks.js` ä»»åŠ¡11ï¼Œæ¯å¤©å‡Œæ™¨ 2:00 æ‰§è¡Œï¼Œé€šè¿‡ `jobs/daily-redemption-order-expiration.js` ç»Ÿä¸€å…¥å£ + Redis åˆ†å¸ƒå¼é” | ~~æ— å½±å“~~ **æ­¤é—®é¢˜ä¸å­˜åœ¨** | **æ— éœ€æ“ä½œ** |
| **B9** | **å•†å®¶æ ¸é”€æƒé™é˜ˆå€¼é”™è¯¯** | `routes/v4/shop/redemption/fulfill.js:70` ç¡¬ç¼–ç  `role_level >= 50`ï¼Œmerchant_staff(20) å’Œ merchant_manager(40) **å®é™…æ— æ³•æ ¸é”€** | å•†å®¶å‘˜å·¥/åº—é•¿ä¸èƒ½æ‰§è¡Œæ ¸é”€ï¼Œä¸ä¸šåŠ¡è®¾è®¡ä¸¥é‡çŸ›ç›¾ | **â†’ æ–°å¢å†³ç­– P6**ï¼šè°ƒæ•´é˜ˆå€¼ |
| **B10** | **item_instances æ—  item_name åˆ—** | ç‰©å“åç§°å­˜å‚¨åœ¨ `meta` JSON å­—æ®µçš„ `.name` å±æ€§ä¸­ï¼ˆå¦‚ `meta.name = "æµ‹è¯•ä¼˜æƒ åˆ¸3"`ï¼‰ | å‰ç«¯å’Œæ–‡æ¡£ä¸­å¼•ç”¨ `item_name` çš„åœ°æ–¹éƒ½éœ€æ”¹ä¸º `meta.name` | å‰ç«¯ç›´æ¥ä½¿ç”¨ `item_instance.meta.name` |
| **B11** | **QRCodeValidator.js æ˜¯æ¶ˆè´¹å½•å…¥ç³»ç»Ÿ** | è¯¥å·¥å…·ç±»ç”¨äºç”¨æˆ·åˆ°åº—æ¶ˆè´¹æ—¶çš„èº«ä»½äºŒç»´ç ï¼ˆV2 æ ¼å¼ï¼š`QRV2_{payload}_{signature}`ï¼‰ï¼ŒåŒ…å« `user_uuid`/nonce/Redis ä¸€æ¬¡æ€§éªŒè¯ï¼Œä¸æ ¸é”€ç æ— å…³ | æ ¸é”€QRç éœ€è¦æ–°çš„ç­¾åæœºåˆ¶ï¼ˆåŒ…å« `order_id`/`code_hash`/`timestamp`ï¼‰ | æ–°å»ºç‹¬ç«‹çš„æ ¸é”€QRç­¾åå·¥å…· |
| **B12** | **lottery_prizes PK å’Œ stock å­—æ®µåä¸æ–‡æ¡£ä¸ç¬¦** | ä¸»é”®æ˜¯ `lottery_prize_id`ï¼ˆé `prize_id`ï¼‰ï¼›åº“å­˜æ˜¯ `stock_quantity`ï¼ˆé `stock`ï¼‰ | ä¸Šç‰ˆæ–‡æ¡£ã€å‰ç«¯ä»£ç ä¸­å¼•ç”¨è¿™äº›å­—æ®µåéœ€å…¨å±€æ›´æ­£ | å‰ç«¯ç›´æ¥ä½¿ç”¨åç«¯å­—æ®µå |

### 4.2 Webç®¡ç†åå°å‰ç«¯é¡¹ç›®çš„é—®é¢˜ï¼ˆ2026-02-20 æºç æ ¸æŸ¥ä¿®æ­£ï¼‰

| # | é—®é¢˜ | ç°çŠ¶ï¼ˆçœŸå®ä»£ç ç¡®è®¤ï¼‰ | å½±å“ | æ‰€éœ€æ“ä½œ |
|---|------|-------------------|------|---------|
| W1 | æ ¸é”€ç®¡ç†é¡µé¢å·²å­˜åœ¨ | `admin/redemption-management.html` + `admin/src/modules/operations/pages/redemption-management.js` å·²æœ‰å®Œæ•´åˆ—è¡¨/ç»Ÿè®¡/æ‰¹é‡æ“ä½œ/å¯¼å‡º | âœ… å¯å¤ç”¨ï¼Œåç«¯æ–°å¢å­—æ®µåæ‰©å±•åˆ—å±•ç¤º | é€‚é…æ–°å­—æ®µ |
| W2 | æ ¸é”€ API å°è£…å®Œæ•´ | `admin/src/api/redemption.js` è¦†ç›– LIST/STATISTICS/EXPORT/BATCH æ“ä½œï¼Œendpoint è·¯å¾„ `/api/v4/console/business-records/redemption-orders` | âœ… å¯å¤ç”¨ | æ–°å¢ endpoint æŒ‰åŒæ¨¡å¼æ‰©å±• |
| W3 | ç¼ºå°‘æœ‰æ•ˆæœŸé…ç½®é¢æ¿ | `admin/src/modules/system/composables/config.js` ç®¡ç† SystemSettingsï¼ˆé€šè¿‡ `/api/v4/console/settings/:category`ï¼‰ï¼Œ**éç›´æ¥æ“ä½œ system_configs è¡¨** | Phase 1 éœ€æ–°å¢é…ç½®é¢æ¿ | å–å†³äºå†³ç­– P8 |
| W4 | ç¼ºå°‘é—¨åº—å…³è”æ ¸é”€æ•°æ®å±•ç¤º | å½“å‰æ ¸é”€è®¢å•åˆ—è¡¨ä¸å±•ç¤ºé—¨åº—ä¿¡æ¯ | åç«¯åŠ å­—æ®µåå‰ç«¯éœ€é€‚é…å±•ç¤º | è¡¨æ ¼æ–°å¢"æ ¸é”€é—¨åº—"åˆ— |
| **W5** | **æ ¸é”€ç®¡ç†å­˜åœ¨ä¸¤å¥—é‡å¤ä»£ç è·¯å¾„** | **è·¯å¾„1**ï¼š`admin/src/api/redemption.js` + `operations/pages/redemption-management.js`ï¼ˆoperations æ¨¡å—ï¼Œç›´æ¥ç”¨ `RedemptionAPI`ï¼‰ï¼›**è·¯å¾„2**ï¼š`admin/src/modules/lottery/composables/redemption.js`ï¼ˆlottery æ¨¡å—ï¼Œç”¨ `LOTTERY_ADVANCED_ENDPOINTS`ï¼‰ã€‚ä¸¤å¥—ä»£ç è°ƒç”¨**åŒä¸€åç«¯æ¥å£**ï¼Œä½†æ•°æ®æå–é€»è¾‘ä¸åŒï¼ˆ`result.data.orders` vs `data.orders \|\| data.records \|\| data.codes`ï¼‰ | ç»´æŠ¤æˆæœ¬ç¿»å€ï¼Œä¿®æ”¹ä¸€å¤„å¦ä¸€å¤„é—æ¼é€ æˆ Bug | **â†’ æ–°å¢å†³ç­– P9**ï¼šåˆå¹¶æ–¹å‘ |
| **W6** | **Order ID å­—æ®µå–å€¼ä¸ä¸€è‡´** | `operations/pages/` ä½¿ç”¨ `order.redemption_order_id \|\| order.order_id`ï¼ˆåŒé‡å–å€¼ï¼‰ï¼›`lottery/composables/` ç›´æ¥ä½¿ç”¨ `c.redemption_order_id` | å¦‚æœåç«¯ç»Ÿä¸€è¿”å› `redemption_order_id`ï¼Œå‰ç«¯åº”ç»Ÿä¸€ä½¿ç”¨è¯¥å­—æ®µåï¼Œå»æ‰ fallback é€»è¾‘ | å‰ç«¯ç»Ÿä¸€ä½¿ç”¨ `redemption_order_id` |

### 4.3 å¾®ä¿¡å°ç¨‹åºå‰ç«¯é¡¹ç›®çš„é—®é¢˜

| # | é—®é¢˜ | ç°çŠ¶ | å½±å“ |
|---|------|------|------|
| M1 | ç¼ºå°‘ QR ç å±•ç¤ºé¡µ | å½“å‰ä»…å±•ç¤ºæ–‡æœ¬æ ¸é”€ç  | Phase 1 æ ¸å¿ƒäº¤ä»˜é¡¹ |
| M2 | ç¼ºå°‘åŠ¨æ€ QR ç åˆ·æ–°é€»è¾‘ | æ—  5 åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°æœºåˆ¶ | éœ€æ–°å¢ HMAC ç­¾å + å®šæ—¶åˆ·æ–° |
| M3 | èƒŒåŒ…é¡µé¢ç¼ºå°‘ç‰©å“ç±»å‹åŒºåˆ†æŒ‰é’® | "åˆ°åº—é¢†å–"å’Œ"åˆ°åº—ä½¿ç”¨"æŒ‰é’®æ–‡æ¡ˆæœªæŒ‰ item_type åŒºåˆ† | å‰ç«¯é€‚é…åç«¯ `item_type` å­—æ®µ |
| M4 | ç§¯åˆ†/è™šæ‹Ÿå¥–å“ä»è¿›å…¥èƒŒåŒ… | å¦‚æœå½“å‰å®ç°å°†è™šæ‹Ÿ/ç§¯åˆ†å¥–å“æ”¾å…¥èƒŒåŒ… | éœ€æ”¹ä¸ºä¸­å¥–ç›´æ¥åˆ°è´¦ï¼ˆå†³ç­–3ï¼‰ |
| M5 | å•†å®¶ç«¯ç¼ºå°‘æ‰«ç æ ¸é”€é¡µé¢ | å•†å®¶åªèƒ½æ‰‹åŠ¨è¾“å…¥ç  | Phase 1 æ ¸å¿ƒäº¤ä»˜é¡¹ |
| M6 | ç§¯åˆ†å•†åŸæ— "ç¡®è®¤æ”¶è´§"åŠŸèƒ½ | å½“å‰æ— æ­¤äº¤äº’ | Phase 3 äº¤ä»˜é¡¹ |
| M7 | C2C äº¤æ˜“æ— æ‹…ä¿ç åŠŸèƒ½ | å½“å‰å®ç‰©äº¤æ˜“æ— æ‹…ä¿ç ç¯èŠ‚ | Phase 4 äº¤ä»˜é¡¹ |

---

## äº”ã€å½“å‰è®¾è®¡ä¼˜ç¼ºç‚¹åˆ†æ

### 5.1 åšå¾—å¥½çš„åœ°æ–¹

| ä¼˜ç‚¹ | è¯´æ˜ |
|------|------|
| SHA-256 å“ˆå¸Œå­˜å‚¨ | æ˜æ–‡ç ä¸è½åº“ï¼Œå³ä½¿æ•°æ®åº“æ³„éœ²ä¹Ÿæ— æ³•è¿˜åŸæ ¸é”€ç  |
| äº‹åŠ¡è¾¹ç•Œæ²»ç† | å¼ºåˆ¶å¤–éƒ¨äº‹åŠ¡ä¼ å…¥ + SELECT FOR UPDATE è¡Œé” + `assertAndGetTransaction` |
| å¹‚ç­‰æ€§ä¿è¯ | åŒä¸€ç‰©å“åªèƒ½æœ‰ä¸€ä¸ª pending è®¢å• + code_hash å”¯ä¸€çº¦æŸ |
| ç‰©å“å¤šçº§é”å®š | `item_instances.locks` JSON å­—æ®µæ”¯æŒ trade/redemption/security ä¸‰çº§é”ï¼Œä¼˜å…ˆçº§æ¸…æ™° |
| Base32 å»æ··æ·†å­—ç¬¦ | å»æ‰ 0/O/I/L/1ï¼Œé™ä½ç”¨æˆ·è¯»é”™ç‡ |
| æœåŠ¡å±‚å…œåº•æ ¡éªŒ | æ‰€æœ‰æƒ + role_level åŒé‡æ ¡éªŒï¼Œä¸ä¿¡ä»»è·¯ç”±å±‚ |

### 5.2 å½“å‰ä¸è¶³

| ä¸è¶³ | å½±å“ |
|------|------|
| æ²¡æœ‰ QR ç  | ç”¨æˆ·åªèƒ½å£å¤´æŠ¥è¯» 12 ä½ç ï¼Œæ•ˆç‡ä½æ˜“å‡ºé”™ |
| æ²¡æœ‰åŠ¨æ€ç  | é™æ€ç  30 å¤©ä¸å˜ï¼Œæˆªå›¾å¯è¢«ä»–äººç›—ç”¨ |
| é—¨åº—å…³è”å¼± | æ ¸é”€æ—¶ä¸å¼ºåˆ¶å…³è”é—¨åº—ï¼Œæ— æ³•è¿½è¸ªæ ¸é”€å‘ç”Ÿåœ¨å“ªä¸ªåº—ï¼ˆDB å±‚é¢ç¼ºå­—æ®µï¼‰ |
| æ‰€æœ‰ä¸šåŠ¡å…±ç”¨ä¸€å¥— | å®ç‰©/ä¼˜æƒ åˆ¸/è™šæ‹Ÿå¥–å“/ç§¯åˆ†å…¨ç”¨åŒä¸€ç§æ ¸é”€ç  |
| æœ‰æ•ˆæœŸç¡¬ç¼–ç  | RedemptionService ä¸­å†™æ­» 30 å¤©ï¼Œè¿è¥æ— æ³•é…ç½® |

---

## å…­ã€å‡çº§æ–¹æ¡ˆï¼šå¤šæ¨¡å‹æ ¸é”€æ¶æ„ï¼ˆå†³ç­–1 âœ… å·²æ‹æ¿ï¼‰

### 6.1 é¡¹ç›®çœŸå®ä¸šåŠ¡åœºæ™¯å…¨ç›˜æ¢³ç†

é¡¹ç›®å­˜åœ¨ **7 æ¡ä¸åŒçš„ä¸šåŠ¡é“¾è·¯**ï¼Œæ¯æ¡é“¾è·¯çš„æ ¸é”€/äº¤ä»˜æ€§è´¨å®Œå…¨ä¸åŒï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¤©å·¥ç³»ç»Ÿå…¨ä¸šåŠ¡åœ°å›¾                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â‘  æŠ½å¥– â†’ å®ç‰©å¥–å“ â†’ åˆ°åº—å…‘æ¢     ï¼ˆç”œå“1ä»½ã€é’èœã€é¦–é¥°â€¦ï¼‰         â”‚
â”‚  â‘¡ æŠ½å¥– â†’ ä¼˜æƒ åˆ¸   â†’ åˆ°åº—ä½¿ç”¨     ï¼ˆå…«å…«æŠ˜ã€ä¹å…«æŠ˜åˆ¸â€¦ï¼‰            â”‚
â”‚  â‘¢ æŠ½å¥– â†’ è™šæ‹Ÿå¥–å“ â†’ è‡ªåŠ¨åˆ°è´¦     ï¼ˆå¥½è¿åŠ æŒã€å¨å¸ˆç¥ç¦â€¦ï¼‰          â”‚
â”‚  â‘£ æŠ½å¥– â†’ ç§¯åˆ†å¥–å“ â†’ è‡ªåŠ¨åˆ°è´¦     ï¼ˆ100ç§¯åˆ†ã€500ç§¯åˆ†åˆ¸â€¦ï¼‰          â”‚
â”‚  â‘¤ ç§¯åˆ†å•†åŸ â†’ ææ–™å…‘æ¢å•†å“ â†’ å‘è´§  ï¼ˆçº¢æ°´æ™¶ç¢ç‰‡æ¢å•†å“â€¦ï¼‰           â”‚
â”‚  â‘¥ äº¤æ˜“å¸‚åœº â†’ C2Cä¹°å– â†’ èµ„äº§è½¬ç§»  ï¼ˆç”¨æˆ·ä¹‹é—´ä¹°å–ç‰©å“/ææ–™â€¦ï¼‰       â”‚
â”‚  â‘¦ è¿è¥æ´»åŠ¨ â†’ æ‰¹é‡å‘ç  â†’ æ¸ é“åˆ†å‘  ï¼ˆæœªæ¥åœºæ™¯ï¼šæ¨å¹¿åˆä½œâ€¦ï¼‰         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 å„åœºæ™¯çœŸå®æ•°æ®è§„æ¨¡ï¼ˆ2026-02-20 æŸ¥è¯¢ç¡®è®¤ï¼‰

| ç¼–å· | ä¸šåŠ¡åœºæ™¯ | æ•°æ®åº“è¡¨ | çœŸå®æ•°æ®é‡ | å½“å‰æ ¸é”€æ–¹å¼ |
|------|---------|---------|-----------|-------------|
| â‘  | å®ç‰©å¥–å“åˆ°åº—å…‘æ¢ | redemption_orders + item_instances(product) | 1 fulfilled / 1,673 product å®ä¾‹ | 12ä½Base32æ ¸é”€ç  |
| â‘¡ | ä¼˜æƒ åˆ¸åˆ°åº—ä½¿ç”¨ | redemption_orders + item_instances(voucher) | 4 fulfilled / 4,505 voucher å®ä¾‹ | 12ä½Base32æ ¸é”€ç ï¼ˆä¸â‘ å…±ç”¨ï¼‰ |
| â‘¢ | è™šæ‹Ÿå¥–å“è‡ªåŠ¨åˆ°è´¦ | lottery_prizes(virtual) | 6 ç§è™šæ‹Ÿå¥–å“ | æ— éœ€æ ¸é”€ï¼Œè‡ªåŠ¨åˆ°è´¦ |
| â‘£ | ç§¯åˆ†å¥–å“è‡ªåŠ¨åˆ°è´¦ | lottery_prizes(points) | 3 ç§ç§¯åˆ†å¥–å“ | æ— éœ€æ ¸é”€ï¼Œè‡ªåŠ¨åˆ°è´¦ |
| â‘¤ | ç§¯åˆ†å•†åŸå…‘æ¢å‘è´§ | exchange_records | 4 æ¡è®°å½•ï¼ˆ3 pending + 1 shippedï¼‰ | è®¢å•å·è¿½è¸ªï¼ˆpendingâ†’shippedï¼‰ |
| â‘¥ | C2Cäº¤æ˜“å¸‚åœº | market_listings + trade_orders | 294 æŒ‚å• / 133 äº¤æ˜“ | å†»ç»“â†’è½¬ç§»ï¼ˆè‡ªåŠ¨ï¼‰ |
| â‘¦ | è¿è¥æ‰¹é‡å‘ç  | æš‚æ— ç‹¬ç«‹è¡¨ | 0ï¼ˆæœªæ¥åœºæ™¯ï¼‰ | ä¸å­˜åœ¨ |

### 6.3 ç»Ÿä¸€è°ƒåº¦å±‚è·¯ç”±è§„åˆ™ï¼ˆåŸºäºåç«¯çœŸå®å­—æ®µï¼‰

**å…³é”®çº æ­£**ï¼š`lottery_prizes` è¡¨ä¸­æ²¡æœ‰ `item_type` åˆ—ï¼Œåªæœ‰ `prize_type`ã€‚è€Œ `item_instances` æœ‰ `item_type`ã€‚è°ƒåº¦å±‚åº”åŸºäºä»¥ä¸‹çœŸå®å­—æ®µï¼š

| åˆ¤æ–­æ¡ä»¶ï¼ˆåŸºäºåç«¯çœŸå®å­—æ®µï¼‰ | é€‰æ‹©æ¨¡å‹ | ç”¨æˆ·çœ‹åˆ°çš„æŒ‰é’® |
|------|---------|------|
| `item_instances.item_type = 'product'` | æ¨¡å‹A | "åˆ°åº—é¢†å–" |
| `item_instances.item_type = 'voucher'` | æ¨¡å‹A | "åˆ°åº—ä½¿ç”¨" |
| `lottery_prizes.prize_type = 'virtual'` | æ¨¡å‹B | ï¼ˆæ— æŒ‰é’®ï¼Œä¸­å¥–è‡ªåŠ¨åˆ°è´¦ï¼‰ |
| `lottery_prizes.prize_type = 'points'` | æ¨¡å‹B | ï¼ˆæ— æŒ‰é’®ï¼Œä¸­å¥–è‡ªåŠ¨åˆ°è´¦ï¼‰ |
| æ¥æº=`exchange_records` | æ¨¡å‹C | "æŸ¥çœ‹ç‰©æµ" |
| æ¥æº=`trade_orders` ä¸” `listing_kind = 'item_instance'` | æ¨¡å‹D | "ç¡®è®¤æ”¶è´§" |
| æ¥æº=`trade_orders` ä¸” `listing_kind = 'fungible_asset'` | æ— éœ€æ ¸é”€ | è‡ªåŠ¨å®Œæˆ |
| æ¥æº=cdkey_batchï¼ˆæœªæ¥ï¼‰ | æ¨¡å‹E | "è¾“å…¥å…‘æ¢ç " |

**`prize_type` â†’ `item_type` æ˜ å°„å…³ç³»ï¼ˆåç«¯æƒå¨ï¼Œè¦†ç›–å…¨éƒ¨ 7 ç§ prize_typeï¼‰**ï¼š

| lottery_prizes.prize_type | ä¸­å¥–ååˆ›å»ºçš„ item_instances.item_type | æ ¸é”€æ¨¡å‹ | çœŸå®æ•°æ®ï¼ˆlottery_prizes è¡¨ï¼‰ |
|---|---|---|---|
| `physical` | `product` | æ¨¡å‹Aï¼ˆåˆ°åº—å…‘æ¢ï¼‰ | ç”œå“1ä»½ã€é’èœ1ä»½ã€ç²¾å“é¦–é¥°ã€ç”Ÿè…Œæ‹¼ç›˜158 |
| `coupon` | `voucher` | æ¨¡å‹Aï¼ˆåˆ°åº—ä½¿ç”¨ï¼‰ | å…«å…«æŠ˜ã€ä¹å…«æŠ˜åˆ¸ |
| `points` | ä¸åˆ›å»º item_instanceï¼ˆç›´æ¥åˆ°è´¦ï¼‰ | æ¨¡å‹Bï¼ˆè‡ªåŠ¨åˆ°è´¦ï¼‰ | 100ç§¯åˆ†ã€500ç§¯åˆ†åˆ¸ã€2000ç§¯åˆ†åˆ¸ |
| `virtual` | ä¸åˆ›å»º item_instanceï¼ˆç›´æ¥åˆ°è´¦ï¼‰ | æ¨¡å‹Bï¼ˆè‡ªåŠ¨åˆ°è´¦ï¼‰ | ç¥ç§˜å½©è›‹ã€å¥½è¿åŠ æŒã€ç¾é£Ÿæ¨èã€å¨å¸ˆç¥ç¦ã€ä¸‹æ¬¡å¥½è¿ã€å‚ä¸æœ‰ç¤¼ï¼ˆå…¨éƒ¨ is_fallback=1, prize_value=0ï¼‰ |
| `service` | **å¾…ç¡®è®¤** | **å¾…ç¡®è®¤** | å½“å‰æ— æ­¤ç±»å¥–å“æ•°æ® |
| `product` | **å¾…ç¡®è®¤**ï¼ˆæ³¨æ„ï¼šä¸ physical æœ‰è¯­ä¹‰é‡å ï¼‰ | **å¾…ç¡®è®¤** | å½“å‰æ— æ­¤ç±»å¥–å“æ•°æ® |
| `special` | **å¾…ç¡®è®¤** | **å¾…ç¡®è®¤** | å½“å‰æ— æ­¤ç±»å¥–å“æ•°æ® |

**âš ï¸ æ³¨æ„**ï¼š`service`ã€`product`ï¼ˆå¥–å“ç±»å‹ä¸­çš„ productï¼Œé item_type çš„ productï¼‰ã€`special` ä¸‰ç§ prize_type å½“å‰æ— çœŸå®æ•°æ®ï¼Œä½† ENUM å·²å®šä¹‰ã€‚å»ºè®®å®æ–½æ—¶åœ¨ç»Ÿä¸€è°ƒåº¦å±‚é¢„ç•™è¿™ä¸‰ç§ç±»å‹çš„è·¯ç”±å ä½ï¼Œé¿å…æœªæ¥æ‰©å±•æ—¶é—æ¼ã€‚

### 6.4 ç»Ÿä¸€è°ƒåº¦å±‚æ¶æ„

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   ç»Ÿä¸€æ ¸é”€è°ƒåº¦å±‚     â”‚
                    â”‚  RedemptionRouter   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ æ ¹æ® item_type / æ¥æºè¡¨ è‡ªåŠ¨åˆ†å‘
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚               â”‚               â”‚
              â–¼               â–¼               â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ æ¨¡å‹A: O2Oç  â”‚ â”‚æ¨¡å‹B: è‡ªåŠ¨â”‚ â”‚ æ¨¡å‹C: å‘è´§å•â”‚
      â”‚  åˆ°åº—æ ¸é”€     â”‚ â”‚ æ ¸é”€      â”‚ â”‚  ç‰©æµè¿½è¸ª    â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                              â”‚
              â–¼                              â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ æ¨¡å‹D: æ‹…ä¿ç  â”‚              â”‚ æ¨¡å‹E: CDKey  â”‚
      â”‚  C2Cäº¤æ˜“     â”‚              â”‚  æ‰¹é‡åˆ†å‘     â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.5 ä¸šåŠ¡åœºæ™¯ â†’ æ ¸é”€æ¨¡å‹æ˜ å°„

| ä¸šåŠ¡åœºæ™¯ | æ ¸é”€æ¨¡å‹ | çµæ„Ÿæ¥æº | ç”¨æˆ·çœ‹åˆ°çš„æŒ‰é’® |
|----------|---------|---------|--------------|
| â‘  å®ç‰©å¥–å“åˆ°åº—å…‘æ¢ | **æ¨¡å‹Aï¼šO2OåŠ¨æ€ç ** | ç¾å›¢åˆ°åº—æ ¸é”€ | "åˆ°åº—é¢†å–" |
| â‘¡ ä¼˜æƒ åˆ¸åˆ°åº—ä½¿ç”¨ | **æ¨¡å‹Aï¼šO2OåŠ¨æ€ç ** | ç¾å›¢ä¼˜æƒ åˆ¸ | "åˆ°åº—ä½¿ç”¨" |
| â‘¢ è™šæ‹Ÿå¥–å“è‡ªåŠ¨åˆ°è´¦ | **æ¨¡å‹Bï¼šè‡ªåŠ¨æ ¸é”€** | æ¸¸æˆé“å…·å‘æ”¾ | ï¼ˆæ— æŒ‰é’®ï¼Œè‡ªåŠ¨åˆ°è´¦ï¼‰ |
| â‘£ ç§¯åˆ†å¥–å“è‡ªåŠ¨åˆ°è´¦ | **æ¨¡å‹Bï¼šè‡ªåŠ¨æ ¸é”€** | åŒä¸Š | ï¼ˆæ— æŒ‰é’®ï¼Œè‡ªåŠ¨åˆ°è´¦ï¼‰ |
| â‘¤ ç§¯åˆ†å•†åŸå…‘æ¢ | **æ¨¡å‹Cï¼šå‘è´§å•è¿½è¸ª** | æ·˜å®/ç”µå•† | "æŸ¥çœ‹ç‰©æµ" |
| â‘¥ C2Cäº¤æ˜“å¸‚åœºï¼ˆå®ç‰©ï¼‰ | **æ¨¡å‹Dï¼šæ‹…ä¿äº¤æ˜“ç ** | é—²é±¼/5173 | "ç¡®è®¤æ”¶è´§" |
| â‘¦ è¿è¥æ‰¹é‡å‘ç  | **æ¨¡å‹Eï¼šCDKeyæ‰¹é‡** | è…¾è®¯CDKey | "è¾“å…¥å…‘æ¢ç " |

---

## ä¸ƒã€å„æ¨¡å‹è¯¦ç»†è®¾è®¡

### æ¨¡å‹Aï¼šO2O åŠ¨æ€ç  â€” åˆ°åº—æ ¸é”€ï¼ˆå†³ç­–2/7/8/9/10/11 âœ…ï¼‰

**é€‚ç”¨å¯¹è±¡**ï¼š`item_instances.item_type = 'product'`ï¼ˆå®ç‰©ï¼‰å’Œ `item_instances.item_type = 'voucher'`ï¼ˆä¼˜æƒ åˆ¸ï¼‰

**åŸºäºå†³ç­–ç»“æœçš„æœ€ç»ˆè®¾è®¡**ï¼š

| ç»´åº¦ | å½“å‰è®¾è®¡ | å‡çº§åï¼ˆå·²æ‹æ¿ï¼‰ | å†³ç­–ä¾æ® |
|------|---------|-----------------|---------|
| ç æ ¼å¼ | 12ä½Base32æ–‡æœ¬ | 12ä½Base32 + **åŠ¨æ€QRç ** + æ–‡æœ¬ç å¤‡ç”¨ | å†³ç­–7ï¼šB+B-2 |
| åŠ¨æ€é˜²æŠ¤ | æ—  | QRç  **5åˆ†é’Ÿæœ‰æ•ˆ**ï¼ŒHMACç­¾åï¼ˆ`CONSUMPTION_QR_SECRET`ï¼‰ï¼Œè¿‡æœŸè‡ªåŠ¨åˆ·æ–° | å†³ç­–7ï¼šB-2 |
| æ ¸é”€æ–¹å¼ | å•†å®¶æ‰‹åŠ¨è¾“å…¥ç  | å•†å®¶**æ‰«QRç **ï¼ˆä¸»ï¼‰+ æ‰‹åŠ¨è¾“å…¥æ–‡æœ¬ç ï¼ˆå¤‡ï¼‰ | å†³ç­–7ï¼šB |
| ç¡®è®¤æœºåˆ¶ | å•†å®¶å•æ–¹ | **å•†å®¶å•æ–¹æ‰«ç å³å®Œæˆ**ï¼Œä¸éœ€è¦ç”¨æˆ·ç¡®è®¤ | å†³ç­–11 |
| é—¨åº—å…³è” | å¼±ï¼ˆDBæ— å­—æ®µï¼‰ | **å¼ºåˆ¶å…³è”**ï¼šé€šè¿‡ store_staff è‡ªåŠ¨ç¡®å®šé—¨åº— | å†³ç­–8ï¼šA |
| æœ‰æ•ˆæœŸ | å›ºå®š30å¤© | **è¿è¥å¯é…ç½®**ï¼šsystem_configs å…¨å±€é»˜è®¤ + å¥–å“çº§åˆ«è¦†ç›– | å†³ç­–9ï¼šC |
| ç å­˜å‚¨ | SHA-256å“ˆå¸Œ | **ç»´æŒ SHA-256 ä¸å¯é€†**ï¼Œä¸¢ç å–æ¶ˆé‡ç”Ÿæˆ | å†³ç­–10ï¼šA |

**æœ€ç»ˆäº¤äº’æµç¨‹**ï¼ˆå®ç‰©å’Œä¼˜æƒ åˆ¸ç»Ÿä¸€ï¼‰ï¼š

```
ç”¨æˆ·                              å•†å®¶
 â”‚                                 â”‚
 â”‚ 1. èƒŒåŒ… â†’ ç‚¹å‡»ç‰©å“               â”‚
 â”‚    â†’ "åˆ°åº—é¢†å–"/"åˆ°åº—ä½¿ç”¨"æŒ‰é’®   â”‚
 â”‚                                 â”‚
 â”‚ 2. ç”Ÿæˆæ ¸é”€ç                     â”‚
 â”‚    æ˜¾ç¤ºåŠ¨æ€QRç ï¼ˆ5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°ï¼‰   â”‚
 â”‚    + åº•éƒ¨æ˜¾ç¤ºæ–‡æœ¬ç ï¼ˆå¤‡ç”¨ï¼‰        â”‚
 â”‚    + æœ‰æ•ˆæœŸå€’è®¡æ—¶                â”‚
 â”‚                                 â”‚
 â”‚ 3. åˆ°åº—ï¼Œå‡ºç¤ºQRç å±å¹•   â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ 4. å•†å®¶æ‰«ç 
 â”‚                                 â”‚    æ˜¾ç¤ºï¼šç‰©å“åç§° / ç”¨æˆ·æ˜µç§°
 â”‚                                 â”‚    é—¨åº—ï¼šè‡ªåŠ¨åŒ¹é…ï¼ˆstore_staffï¼‰
 â”‚                                 â”‚    â†’ æ‰«ç å³æ ¸é”€å®Œæˆï¼ˆæ— ç”¨æˆ·ç¡®è®¤ï¼‰
 â”‚                                 â”‚
 â”‚ 5. æ”¶åˆ°å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯é€šçŸ¥  â†â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚    "æ‚¨çš„XXå·²åœ¨XXé—¨åº—æ ¸é”€"         â”‚
```

---

### æ¨¡å‹Bï¼šè‡ªåŠ¨æ ¸é”€ â€” è™šæ‹Ÿå¥–å“ / ç§¯åˆ†åˆ°è´¦ï¼ˆå†³ç­–3 âœ…ï¼‰

**é€‚ç”¨å¯¹è±¡**ï¼š`lottery_prizes.prize_type = 'virtual'`ï¼ˆå¥½è¿åŠ æŒç­‰ï¼‰å’Œ `lottery_prizes.prize_type = 'points'`ï¼ˆ100ç§¯åˆ†ç­‰ï¼‰

**åŸºäºå†³ç­–ç»“æœ**ï¼šä¸­å¥–ç›´æ¥åˆ°è´¦ï¼Œ**ä¸è¿›å…¥èƒŒåŒ…**ï¼Œä¸éœ€è¦æ ¸é”€ç ã€‚

| ç»´åº¦ | è®¾è®¡ |
|------|------|
| æ ¸é”€ç  | **ä¸éœ€è¦** |
| è§¦å‘æ–¹å¼ | æŠ½å¥–å‘½ä¸­ â†’ ç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œ |
| ç§¯åˆ†ç±» | ç›´æ¥ credit åˆ°ç”¨æˆ· `account_asset_balances`ï¼ˆasset_code=POINTSï¼‰ |
| è™šæ‹Ÿç±» | ç›´æ¥æ ‡è®°æ•ˆæœæˆ–ä¸åˆ›å»º item_instance |
| ç”¨æˆ·æ„ŸçŸ¥ | æŠ½å¥–ç»“æœé¡µç›´æ¥æ˜¾ç¤º"XXXå·²åˆ°è´¦"ï¼Œ**ä¸è¿›å…¥èƒŒåŒ…** |
| å¤±è´¥å¤„ç† | è‡ªåŠ¨é‡è¯• 3 æ¬¡ï¼Œå¤±è´¥è½¬äººå·¥è¡¥å‘é˜Ÿåˆ— |

---

### æ¨¡å‹Cï¼šå‘è´§å•è¿½è¸ª â€” ç§¯åˆ†å•†åŸå…‘æ¢ï¼ˆå†³ç­–4 âœ…ï¼‰

**é€‚ç”¨å¯¹è±¡**ï¼š`exchange_records` è¡¨çš„å•†å“å…‘æ¢è®¢å•

**åŸºäºå†³ç­–ç»“æœ**ï¼šåŠ ç¡®è®¤æ”¶è´§ï¼Œå‘è´§å 7 å¤©æœªæ“ä½œè‡ªåŠ¨ç¡®è®¤ã€‚

**çŠ¶æ€æµè½¬ï¼ˆå‡çº§ exchange_records ENUMï¼‰**ï¼š

```
pendingï¼ˆå¾…å®¡æ ¸ï¼‰
  â”œâ†’ approvedï¼ˆå®¡æ ¸é€šè¿‡ï¼‰â†’ shippedï¼ˆå·²å‘è´§ï¼‰â†’ receivedï¼ˆå·²æ”¶è´§/7å¤©è‡ªåŠ¨ï¼‰â†’ ratedï¼ˆå·²è¯„ä»·ï¼‰
  â”œâ†’ rejectedï¼ˆå®¡æ ¸æ‹’ç»ï¼‰â†’ refundedï¼ˆå·²é€€æ¬¾ï¼‰
  â””â†’ cancelledï¼ˆç”¨æˆ·å–æ¶ˆï¼‰
```

**âš ï¸ å½“å‰ ENUM ä»…æœ‰** `pending/completed/shipped/cancelled`ï¼Œéœ€è¿ç§»æ‰©å±•ä¸º `pending/approved/shipped/received/rated/rejected/refunded/cancelled`ã€‚

---

### æ¨¡å‹Dï¼šæ‹…ä¿äº¤æ˜“ç  â€” C2C äº¤æ˜“å¸‚åœºï¼ˆå†³ç­–5 âœ…ï¼‰

**é€‚ç”¨å¯¹è±¡**ï¼š`market_listings` + `trade_orders` ä¸­ `listing_kind = 'item_instance'` çš„å®ç‰©äº¤æ˜“

| ç»´åº¦ | è®¾è®¡ |
|------|------|
| ç æ ¼å¼ | **6ä½çº¯æ•°å­—çŸ­ç **ï¼ˆå¦‚ï¼š582917ï¼‰ï¼Œç”¨å®Œå³ç„š |
| å­˜å‚¨æ–¹å¼ | Redis çŸ­æœŸå­˜å‚¨ï¼Œ**30åˆ†é’Ÿæœ‰æ•ˆ** |
| è§¦å‘æ—¶æœº | ä¹°æ–¹ä»˜æ¬¾ï¼ˆèµ„äº§å†»ç»“ï¼‰â†’ ç³»ç»Ÿç”Ÿæˆæ‹…ä¿ç å‘ç»™**å–æ–¹** |
| æ ¸é”€æ–¹å¼ | å–æ–¹äº¤ä»˜ç‰©å“åï¼Œå°†æ‹…ä¿ç å‘ŠçŸ¥ä¹°æ–¹ â†’ ä¹°æ–¹è¾“å…¥ç ç¡®è®¤æ”¶è´§ |
| èµ„é‡‘é‡Šæ”¾ | ä¹°æ–¹ç¡®è®¤ â†’ å†»ç»“èµ„äº§è½¬ç»™å–æ–¹ â†’ äº¤æ˜“å®Œæˆ |

`fungible_asset` äº¤æ˜“ï¼ˆææ–™/è´§å¸ï¼‰ï¼šä¸éœ€è¦æ‹…ä¿ç ï¼Œç³»ç»Ÿè‡ªåŠ¨å†»ç»“â†’è½¬ç§»â†’å®Œæˆã€‚

---

### æ¨¡å‹Eï¼šCDKey æ‰¹é‡åˆ†å‘ â€” è¿è¥æ¨å¹¿ï¼ˆå†³ç­–6 âœ… ä»…è®¾è®¡ï¼‰

æœ¬æœŸä»…è®¾è®¡æ–¹æ¡ˆå’Œè¡¨ç»“æ„ï¼Œä¸å®æ–½å¼€å‘ã€‚ç­‰ä¸šåŠ¡éœ€è¦æ—¶å¯åŠ¨ã€‚

---

## å…«ã€åç«¯å¯å¤ç”¨èµ„äº§å’Œæ‰©å±•ç‚¹åˆ†æ

### 8.1 å¯ç›´æ¥å¤ç”¨çš„åç«¯ä»£ç ï¼ˆæºç æ ¸æŸ¥ç¡®è®¤ï¼‰

| èµ„äº§ | æ–‡ä»¶ | å¤ç”¨åœºæ™¯ | æ”¹åŠ¨é‡ | æ ¸æŸ¥çŠ¶æ€ |
|------|------|---------|--------|---------|
| æ ¸é”€ç ç”Ÿæˆå™¨ | `utils/RedemptionCodeGenerator.js` | æ¨¡å‹A ç›´æ¥å¤ç”¨ï¼ˆgenerate/hash/validate/generateUniqueï¼‰ | 0ï¼ˆæ— éœ€æ”¹åŠ¨ï¼‰ | âœ… ç¡®è®¤ |
| æ ¸é”€æœåŠ¡å±‚ | `services/RedemptionService.js` | æ¨¡å‹A çš„ createOrder/fulfillOrder/cancelOrder/expireOrders + adminFulfillOrderById/adminBatchFulfillOrders ç›´æ¥å¤ç”¨ | å°ï¼ˆæ‰©å±• store_id/staff_id å†™å…¥ï¼‰ | âœ… ç¡®è®¤ï¼Œäº‹åŠ¡å¼ºåˆ¶å¤–éƒ¨ä¼ å…¥ |
| æ ¸é”€æ•°æ®æ¨¡å‹ | `models/RedemptionOrder.js` | æ¨¡å‹A ç›´æ¥å¤ç”¨ï¼Œå« isExpired()/canFulfill() å®ä¾‹æ–¹æ³• | å°ï¼ˆåŠ å­—æ®µè¿ç§»ï¼‰ | âœ… ç¡®è®¤ |
| ç‰©å“é”å®šæœºåˆ¶ | `models/ItemInstance.js` çš„ lock/unlock/clearAllLocks/getLockById | æ¨¡å‹A/D å¤ç”¨ï¼Œæ”¯æŒ trade/redemption/security ä¸‰çº§é” | 0 | âœ… ç¡®è®¤ |
| äº‹åŠ¡ç®¡ç† | `utils/TransactionManager.js` + `utils/transactionHelpers.js` | æ‰€æœ‰æ¨¡å‹å¤ç”¨ï¼ŒTransactionManager.execute() åŒ…è£…æ‰€æœ‰å†™æ“ä½œ | 0 | âœ… ç¡®è®¤ |
| ç”¨æˆ·èƒŒåŒ…è·¯ç”± | `routes/v4/backpack/index.js` | æ¨¡å‹A çš„ `POST /items/:item_instance_id/redeem` å·²æœ‰ | å°ï¼ˆè¿”å›å€¼åŠ  qr_payloadï¼‰ | âœ… ç¡®è®¤ |
| å•†å®¶æ ¸é”€è·¯ç”± | `routes/v4/shop/redemption/fulfill.js` | `POST /fulfill`ï¼Œå‚æ•°å `redeem_code`ï¼ˆé codeï¼‰ | ä¸­ï¼ˆ**ä¿®å¤ role_level é˜ˆå€¼** + åŠ é—¨åº—å…³è”ï¼‰ | âš ï¸ éœ€ä¿®å¤ P6 |
| èµ„äº§è´¦æœ¬æœåŠ¡ | `services/asset/BalanceService.js` | æ¨¡å‹B ç§¯åˆ†åˆ°è´¦ / æ¨¡å‹D å†»ç»“é‡Šæ”¾ | 0 | âœ… ç¡®è®¤ |
| äº¤æ˜“å¸‚åœºæœåŠ¡ | `services/market-listing/CoreService.js` | æ¨¡å‹D æ‹…ä¿ç é›†æˆç‚¹ | ä¸­ï¼ˆåŠ æ‹…ä¿ç é€»è¾‘ï¼‰ | âœ… ç¡®è®¤ |
| ç®¡ç†åå°è·¯ç”± | `routes/v4/console/business-records.js` | æ¨¡å‹A ç®¡ç†ç«¯å·²æœ‰å®Œæ•´ CRUDï¼ˆlist/detail/redeem/cancel/batch-redeem/batch-cancel/batch-expire/exportï¼‰ï¼ŒrequireRoleLevel(30) | å°ï¼ˆé€‚é…æ–°å­—æ®µï¼‰ | âœ… ç¡®è®¤ |
| **å®šæ—¶ä»»åŠ¡æ¡†æ¶** | `scripts/maintenance/scheduled_tasks.js` ä»»åŠ¡11 | **å·²æœ‰æ ¸é”€è¿‡æœŸæ¸…ç† cron**ï¼ˆæ¯å¤© 2:00 AM + Redis åˆ†å¸ƒå¼é” + `jobs/daily-redemption-order-expiration.js` ç»Ÿä¸€å…¥å£ï¼‰ï¼Œæ¨¡å‹C 7å¤©è‡ªåŠ¨ç¡®è®¤å¯æŒ‰åŒæ ·æ¨¡å¼æ–°å¢ | å°ï¼ˆæ–°å¢ä»»åŠ¡å³å¯ï¼‰ | âœ… **å·²å­˜åœ¨** |
| HMAC å¯†é’¥ | `.env` çš„ `CONSUMPTION_QR_SECRET` | **âš ï¸ ä¸èƒ½ç›´æ¥å¤ç”¨**ï¼šæ­¤å¯†é’¥å·²è¢«æ¶ˆè´¹å½•å…¥QRç³»ç»Ÿ (`QRCodeValidator.js`) ä½¿ç”¨ã€‚æ ¸é”€QRç åº”ä½¿ç”¨**æ–°çš„ç‹¬ç«‹å¯†é’¥** | â€” | âŒ éœ€æ–°å¢å¯†é’¥ |

### 8.2 å¯æ‰©å±•çš„ç°æœ‰æœºåˆ¶

| æœºåˆ¶ | ç°æœ‰å®ç° | æ‰©å±•æ–¹å¼ |
|------|---------|---------|
| `system_configs` è¡¨ | å·²æœ‰ 11 ä¸ªé…ç½®é¡¹ï¼Œç®¡ç†åå°æœ‰é…ç½®é¡µé¢ | æ’å…¥æ ¸é”€æœ‰æ•ˆæœŸé…ç½®é¡¹ |
| `item_instances.locks` JSON å¤šçº§é” | å·²æ”¯æŒ trade/redemption/security | æ— éœ€æ‰©å±• |
| `store_staff` è¡¨ | å·²æœ‰é—¨åº—-å‘˜å·¥ç»‘å®šå…³ç³» | æ ¸é”€æ—¶æŸ¥è¯¢å‘˜å·¥æ‰€å±é—¨åº— |
| Admin API å°è£…æ¨¡å¼ | `admin/src/api/redemption.js` æ¨¡å¼æ¸…æ™° | æ–°å¢ endpoint æŒ‰åŒæ ·æ¨¡å¼æ‰©å±• |
| Composable æ¨¡å¼ | `admin/src/modules/*/composables/*.js` | æ–°åŠŸèƒ½æŒ‰åŒæ ·æ¨¡å¼ç»„ç»‡ |

### 8.3 Webç®¡ç†åå°å‰ç«¯å¤ç”¨è¯„ä¼°

| å·²æœ‰èµ„äº§ | è·¯å¾„ | å¤ç”¨æ€§ |
|---------|------|--------|
| æ ¸é”€ç®¡ç†é¡µé¢ | `admin/redemption-management.html` | âœ… é«˜å¤ç”¨ï¼Œæ‰©å±•åˆ—å±•ç¤ºé—¨åº—ä¿¡æ¯ |
| æ ¸é”€ composable | `admin/src/modules/lottery/composables/redemption.js` | âœ… é«˜å¤ç”¨ |
| æ ¸é”€ API å°è£… | `admin/src/api/redemption.js` | âœ… é«˜å¤ç”¨ï¼Œæ–°å¢ endpoint |
| ç³»ç»Ÿé…ç½®ç®¡ç† | `admin/src/modules/system/composables/config.js` | âœ… é«˜å¤ç”¨ï¼ŒåŠ æ ¸é”€é…ç½® tab |
| æ•°æ®è¡¨ç»„ä»¶æ¨¡å¼ | `admin/src/templates/components/data-table.ejs` | âœ… é«˜å¤ç”¨ |
| Alpine.js x-data ç»„ä»¶æ¨¡å¼ | å…¨ç«™ç»Ÿä¸€ | âœ… æ‰€æœ‰æ–°é¡µé¢éµå¾ªæ­¤æ¨¡å¼ |

---

## ä¹ã€åˆ†é˜¶æ®µå®æ–½æ–¹æ¡ˆï¼ˆåŸºäºåç«¯æŠ€æœ¯æ ˆçš„æ‰§è¡Œæ­¥éª¤ï¼‰

### Phase 1ï¼šå‡çº§åˆ°åº—æ ¸é”€ï¼ˆæ¨¡å‹Aï¼‰

#### åç«¯æ‰§è¡Œæ­¥éª¤

**æ­¥éª¤ 1.0**ï¼ˆå‰ç½®ï¼‰ï¼šä¿®å¤å•†å®¶æ ¸é”€æƒé™é˜ˆå€¼ï¼ˆ**å–å†³äºå†³ç­– P6**ï¼‰

- ä¿®æ”¹ `routes/v4/shop/redemption/fulfill.js:70` çš„ `role_level >= 50` é˜ˆå€¼
- å»ºè®®æ–¹æ¡ˆï¼šæ”¹ä¸º `role_level >= 20`ï¼ˆå…è®¸ merchant_staff å’Œ merchant_manager æ ¸é”€ï¼‰
- åŒæ—¶åœ¨ `RedemptionService.fulfillOrder()` çš„æœåŠ¡å±‚å…œåº•æ ¡éªŒä¸­å¯¹é½æ­¤è§„åˆ™
- **å¯å¤ç”¨**ï¼šç°æœ‰ `middleware/auth.js` çš„ `getUserRoles()` å’Œ `requireRoleLevel()` æœºåˆ¶

**æ­¥éª¤ 1.1**ï¼šæ•°æ®åº“è¿ç§» â€” `redemption_orders` æ·»åŠ é—¨åº—å­—æ®µ

- æ–°å»ºè¿ç§»æ–‡ä»¶ `migrations/YYYYMMDDHHMMSS-add-store-fields-to-redemption-orders.js`
- æ·»åŠ å­—æ®µï¼š`fulfilled_store_id`ï¼ˆINT, FK â†’ stores.store_id, å¯ NULLï¼‰ã€`fulfilled_by_staff_id`ï¼ˆBIGINT, FK â†’ store_staff.store_staff_id, å¯ NULLï¼‰
- `models/RedemptionOrder.js` æ–°å¢å­—æ®µå®šä¹‰å’Œå…³è”ï¼ˆ`belongsTo(Store)`, `belongsTo(StoreStaff)`ï¼‰
- **å¯å¤ç”¨**ï¼šç°æœ‰è¿ç§»å·¥å…·é“¾ `sequelize-cli`ï¼Œå‚è€ƒ `migrations/` ç›®å½•å·²æœ‰è¿ç§»æ–‡ä»¶æ ¼å¼

**æ­¥éª¤ 1.2**ï¼šæ•°æ®åº“è¿ç§» â€” æ’å…¥æœ‰æ•ˆæœŸé…ç½®ï¼ˆ**å–å†³äºå†³ç­– P8**ï¼‰

- **æ–¹æ¡ˆA**ï¼ˆsystem_configs è¡¨ï¼‰ï¼šç›´æ¥ INSERT é…ç½®é¡¹ `redemption_default_expiry_days`ï¼Œå€¼ä¸º `{"product": 7, "voucher": 30}`
- **æ–¹æ¡ˆB**ï¼ˆSystemSettings æ¨¡å‹ï¼‰ï¼šé€šè¿‡ admin åå° `/api/v4/console/settings/:category` PUT æ¥å£å†™å…¥ï¼Œå¤ç”¨ç°æœ‰ `admin/src/modules/system/composables/config.js` çš„ 5 ä¸ª category æ¨¡å¼ï¼Œæ–°å¢ `redemption` category
- `RedemptionService.createOrder()` æ”¹ä¸ºè¯»å–é…ç½®ç¡®å®šæœ‰æ•ˆæœŸï¼ˆå½“å‰ç¡¬ç¼–ç  30 å¤©åœ¨ `expires_at` è®¡ç®—å¤„ï¼‰

**æ­¥éª¤ 1.3**ï¼šQR ç åŠ¨æ€ç­¾åæœåŠ¡ï¼ˆ**å–å†³äºå†³ç­– P7**ï¼‰

- **æ¨èæ–¹æ¡ˆ**ï¼šæ–°å»ºç‹¬ç«‹çš„ `utils/RedemptionQRSigner.js`
  - **åŸå› **ï¼šç°æœ‰ `utils/QRCodeValidator.js` æ˜¯æ¶ˆè´¹å½•å…¥ç³»ç»Ÿçš„ç”¨æˆ·èº«ä»½äºŒç»´ç ï¼Œpayload ç»“æ„å®Œå…¨ä¸åŒï¼ˆ`user_uuid/exp/nonce` vs `order_id/code_hash/timestamp`ï¼‰ï¼Œæ··ç”¨ä¼šå¢åŠ è€¦åˆå’Œç»´æŠ¤æˆæœ¬
  - `.env` æ–°å¢ `REDEMPTION_QR_SECRET`ï¼ˆç‹¬ç«‹äº `CONSUMPTION_QR_SECRET`ï¼‰
  - QR ç å†…å®¹ï¼š`RQRV1_{base64(JSON.stringify({ oid, ch, ts }))}_${hmac_sha256_signature}`
  - æœ‰æ•ˆæœŸ 5 åˆ†é’Ÿï¼Œè¿‡æœŸéœ€å®¢æˆ·ç«¯é‡æ–°è¯·æ±‚
  - **å¯å¤ç”¨**ï¼š`QRCodeValidator.js` çš„ V2 ç­¾åéªŒè¯æ¨¡å¼ï¼ˆHMAC-SHA256 + base64 payload + signature æ‹¼æ¥æ ¼å¼ï¼‰ï¼Œä½† payload ç»“æ„ç‹¬ç«‹
- **å¤‡é€‰æ–¹æ¡ˆ**ï¼šåœ¨ `QRCodeValidator.js` ä¸­æ–°å¢ V3 æ ¼å¼ï¼ˆå‰ç¼€ `RQR_`ï¼‰ï¼Œå…±äº« HMAC ç­¾åé€»è¾‘

**æ­¥éª¤ 1.4**ï¼šæ”¹é€ æ ¸é”€æµç¨‹åŠ é—¨åº—å…³è”

- `RedemptionService.fulfillOrder()` å¢åŠ  `store_id` å’Œ `staff_id` å‚æ•°
- æ ¸é”€æ—¶è‡ªåŠ¨æŸ¥ `store_staff` ç¡®å®šé—¨åº—ï¼ˆé€šè¿‡ `redeemer_user_id` â†’ `store_staff.user_id` â†’ `store_staff.store_id`ï¼ŒWHERE `status = 'active'`ï¼‰
- æ³¨æ„å­—æ®µæ˜¯ `role_in_store`ï¼ˆé roleï¼‰ï¼ŒæŸ¥è¯¢æ¡ä»¶éœ€ä½¿ç”¨æ­£ç¡®å­—æ®µå
- å¦‚æŸ¥ä¸åˆ°æ´»è·ƒ store_staff è®°å½•ï¼Œç®¡ç†å‘˜å¯æ‰‹åŠ¨æŒ‡å®š store_id
- **å¯å¤ç”¨**ï¼š`services/StoreService.js` å’Œ `services/StaffManagementService.js` å·²æœ‰é—¨åº—/å‘˜å·¥æŸ¥è¯¢é€»è¾‘

**æ­¥éª¤ 1.5**ï¼šæ–°å¢ QR ç æ ¸é”€æ¥å£

- `routes/v4/shop/redemption/` æ–°å¢ `POST /scan`ï¼ˆæ‰«æ QR ç å†…å®¹éªŒè¯ç­¾å + æ ¸é”€ï¼‰
- ä¿ç•™åŸæœ‰ `POST /fulfill`ï¼ˆæ‰‹åŠ¨è¾“å…¥æ–‡æœ¬ç æ ¸é”€ï¼Œå‚æ•°å `redeem_code`ï¼‰ä½œä¸ºå¤‡ç”¨
- ä¸¤ä¸ªæ¥å£å…±ç”¨ `RedemptionService.fulfillOrder()`ï¼ŒåŒºåˆ«åœ¨äºå…¥å‚æ¥æºä¸åŒ

**æ­¥éª¤ 1.6**ï¼šèƒŒåŒ…è·¯ç”±è¿”å› QR ç æ•°æ®

- `routes/v4/backpack/index.js` çš„ `POST /items/:item_instance_id/redeem` è¿”å›ä¸­å¢åŠ  `qr_payload` å’Œ `qr_expires_at`
- æ–°å¢ `POST /items/:item_instance_id/redeem/refresh-qr` åˆ·æ–° QR ç 
- ç‰©å“åç§°ä» `item_instance.meta.name` è·å–ï¼ˆ**é item_name å­—æ®µ**ï¼‰

#### Webç®¡ç†åå°æ‰§è¡Œæ­¥éª¤

**æ­¥éª¤ 1.7**ï¼šæ ¸é”€ç®¡ç†ä»£ç è·¯å¾„åˆå¹¶ï¼ˆ**å–å†³äºå†³ç­– P9**ï¼‰

- å½“å‰æœ‰ä¸¤å¥—é‡å¤ä»£ç ï¼š
  - `admin/src/api/redemption.js` + `admin/src/modules/operations/pages/redemption-management.js`
  - `admin/src/modules/lottery/composables/redemption.js`
- **å»ºè®®**ï¼šä¿ç•™ `operations/pages/` è·¯å¾„ä½œä¸ºä¸»è·¯å¾„ï¼ˆæ›´å®Œæ•´ï¼‰ï¼ŒåºŸå¼ƒ `lottery/composables/redemption.js` ä¸­çš„é‡å¤é€»è¾‘
- ç»Ÿä¸€ä½¿ç”¨ `redemption_order_id` å­—æ®µåï¼ˆå»æ‰ `order.order_id` fallbackï¼‰
- `admin/redemption-management.html` è¡¨æ ¼å¢åŠ "æ ¸é”€é—¨åº—"åˆ—ï¼ˆä½¿ç”¨ `order.fulfilled_store.store_name`ï¼‰

**æ­¥éª¤ 1.8**ï¼šæœ‰æ•ˆæœŸé…ç½®é¢æ¿

- **æ–¹æ¡ˆA**ï¼ˆå¦‚æœ P8 é€‰ system_configsï¼‰ï¼šæ–°å»ºç‹¬ç«‹é…ç½®é¢æ¿
- **æ–¹æ¡ˆB**ï¼ˆå¦‚æœ P8 é€‰ SystemSettingsï¼‰ï¼šåœ¨ `admin/src/modules/system/composables/config.js` ä¸­æ–°å¢ `redemption` categoryï¼Œå¤ç”¨ç°æœ‰çš„ `CATEGORY_DISPLAY` + `loadCategoryConfig()` + `saveCategoryConfig()` æ¨¡å¼
- **å¯å¤ç”¨**ï¼šç°æœ‰ SystemSettings ç®¡ç†æ¨¡å¼ï¼ˆbasic/points/notification/security/marketplace 5 ä¸ª categoryï¼‰

#### å¾®ä¿¡å°ç¨‹åºæ‰§è¡Œæ­¥éª¤

**æ­¥éª¤ 1.9**ï¼šQR ç å±•ç¤ºé¡µ

- è°ƒç”¨ `POST /api/v4/backpack/items/:item_instance_id/redeem` è·å–æ ¸é”€ç å’Œ QR payload
- ä½¿ç”¨å°ç¨‹åº canvas æ¸²æŸ“ QR ç 
- 5 åˆ†é’Ÿå€’è®¡æ—¶ + è‡ªåŠ¨è°ƒç”¨ `POST /items/:item_instance_id/redeem/refresh-qr` åˆ·æ–°
- åº•éƒ¨æ˜¾ç¤ºæ–‡æœ¬ç ï¼ˆæ ¼å¼ XXXX-YYYY-ZZZZï¼‰ä½œä¸ºå¤‡ç”¨

**æ­¥éª¤ 1.10**ï¼šå•†å®¶æ‰«ç æ ¸é”€é¡µ

- è°ƒç”¨å°ç¨‹åº `wx.scanCode` API æ‰«æ QR ç 
- è§£æ QR ç å†…å®¹ï¼ˆ`RQRV1_` å‰ç¼€æ ¼å¼ï¼‰â†’ è°ƒç”¨ `POST /api/v4/shop/redemption/scan` æ ¸é”€
- å±•ç¤ºæ ¸é”€ç»“æœï¼šç‰©å“åï¼ˆ`meta.name`ï¼‰ã€ç”¨æˆ·æ˜µç§°ã€é—¨åº—å
- **å¤‡ç”¨å…¥å£**ï¼šæ‰‹åŠ¨è¾“å…¥æ–‡æœ¬ç  â†’ è°ƒç”¨ `POST /api/v4/shop/redemption/fulfill`ï¼ˆå‚æ•°å `redeem_code`ï¼‰

---

### Phase 2ï¼šè™šæ‹Ÿ/ç§¯åˆ†è‡ªåŠ¨åˆ°è´¦ï¼ˆæ¨¡å‹Bï¼‰

#### åç«¯æ‰§è¡Œæ­¥éª¤

**æ­¥éª¤ 2.1**ï¼šæŠ½å¥–å¼•æ“ SettleStage æ”¹é€ 

- `services/UnifiedLotteryEngine/pipeline/stages/SettleStage.js` æ˜¯æŠ½å¥–ç»“ç®—å…¥å£
- `prize_type = 'points'` æ—¶ï¼šç›´æ¥è°ƒç”¨ `BalanceService.changeBalance()` å°† `prize_value` åŠ åˆ°ç”¨æˆ· POINTS
- `prize_type = 'virtual'` æ—¶ï¼šä¸åˆ›å»º item_instanceï¼Œç›´æ¥è¿”å›æ•ˆæœæè¿°

**æ­¥éª¤ 2.2**ï¼šç¡®è®¤ item_instance ä¸åˆ›å»º

- ç¡®ä¿ points/virtual ä¸­å¥–ä¸èµ° item_instance åˆ›å»ºæµç¨‹

#### å¾®ä¿¡å°ç¨‹åºæ‰§è¡Œæ­¥éª¤

**æ­¥éª¤ 2.3**ï¼šæŠ½å¥–ç»“æœé¡µé€‚é…

- points ç±»å‹æ˜¾ç¤º"æ­å–œè·å¾— XXX ç§¯åˆ†ï¼å·²è‡ªåŠ¨åˆ°è´¦"
- virtual ç±»å‹æ˜¾ç¤ºæ•ˆæœæè¿°ï¼ˆå¥½è¿åŠ æŒç­‰ï¼‰
- ä¸æ˜¾ç¤º"å»èƒŒåŒ…æŸ¥çœ‹"æŒ‰é’®

---

### Phase 3ï¼šç§¯åˆ†å•†åŸç¡®è®¤æ”¶è´§ï¼ˆæ¨¡å‹Cï¼‰

#### åç«¯æ‰§è¡Œæ­¥éª¤

**æ­¥éª¤ 3.1**ï¼šæ•°æ®åº“è¿ç§» â€” exchange_records ENUM æ‰©å±•

- è¿ç§»æ–‡ä»¶å°† status ENUM ä» `pending/completed/shipped/cancelled` æ‰©å±•ä¸º `pending/approved/shipped/received/rated/rejected/refunded/cancelled`
- æ–°å¢å­—æ®µï¼š`received_at`ï¼ˆDATETIMEï¼‰ã€`auto_confirmed`ï¼ˆBOOLEAN, æ ‡è®°æ˜¯å¦è‡ªåŠ¨ç¡®è®¤ï¼‰
- **âœ… å·²æœ‰å­—æ®µå¯å¤ç”¨**ï¼š`rating`(tinyint) å’Œ `rated_at`(datetime) **å·²å­˜åœ¨äºæ•°æ®åº“è¡¨ä¸­**ï¼Œè¯„ä»·åŠŸèƒ½ DB å±‚å·²å°±ç»ª
- **âœ… å·²æœ‰å­—æ®µå¯å¤ç”¨**ï¼š`shipped_at`(datetime) å·²å­˜åœ¨ï¼Œ7å¤©è‡ªåŠ¨ç¡®è®¤å¯ç›´æ¥åŸºäºæ­¤å­—æ®µè®¡ç®—
- **å¯å¤ç”¨**ï¼š`services/exchange/CoreService.js` å·²æœ‰ `rateOrder(user_id, order_no, rating)` æ–¹æ³•ï¼ˆä»…å¯¹ completed/shipped çŠ¶æ€æœ‰æ•ˆï¼‰

**æ­¥éª¤ 3.2**ï¼šç¡®è®¤æ”¶è´§æ¥å£

- åœ¨ `routes/v4/shop/exchange/` æ–°å¢ `POST /orders/:order_no/confirm-receipt`
- `services/exchange/CoreService.js` æ·»åŠ ç¡®è®¤æ”¶è´§é€»è¾‘ï¼ˆ`shipped` â†’ `received`ï¼‰
- **æ³¨æ„**ï¼šç°æœ‰ `updateOrderStatus()` æ–¹æ³•çš„ valid statuses ä»…ä¸º `completed/shipped/cancelled`ï¼Œéœ€æ‰©å±•æ”¯æŒ `received`
- **å¯å¤ç”¨**ï¼šç°æœ‰è·¯ç”±æ¨¡å¼ `routes/v4/shop/exchange/`ï¼Œå‚è€ƒ `admin/src/api/market/exchange.js` çš„ `EXCHANGE_ORDER_STATUS` endpoint

**æ­¥éª¤ 3.3**ï¼š7 å¤©è‡ªåŠ¨ç¡®è®¤å®šæ—¶ä»»åŠ¡

- åœ¨ `scripts/maintenance/scheduled_tasks.js` æ–°å¢ä»»åŠ¡ï¼ˆå‚è€ƒä»»åŠ¡11æ ¸é”€è¿‡æœŸæ¸…ç†çš„æ¨¡å¼ï¼‰
- æ¯å¤©å‡Œæ™¨æ‰«æ `status = 'shipped'` ä¸” `shipped_at + 7å¤© < NOW()` çš„è®°å½•
- è‡ªåŠ¨æ›´æ–°ä¸º `received` + `auto_confirmed = true`
- **å¯å¤ç”¨**ï¼šç°æœ‰å®šæ—¶ä»»åŠ¡æ¡†æ¶ï¼ˆnode-cron + Redis åˆ†å¸ƒå¼é” + Job ç±»ç»Ÿä¸€å…¥å£æ¨¡å¼ï¼‰

#### å¾®ä¿¡å°ç¨‹åºæ‰§è¡Œæ­¥éª¤

**æ­¥éª¤ 3.4**ï¼šè®¢å•è¯¦æƒ… + ç¡®è®¤æ”¶è´§æŒ‰é’®

---

### Phase 4ï¼šC2Cæ‹…ä¿ç ï¼ˆæ¨¡å‹Dï¼‰

#### åç«¯æ‰§è¡Œæ­¥éª¤

**æ­¥éª¤ 4.1**ï¼šæ‹…ä¿ç  Redis æœåŠ¡

- æ–°å»º `services/EscrowCodeService.js`
- 6 ä½çº¯æ•°å­—ç ç”Ÿæˆï¼ŒRedis å­˜å‚¨ 30 åˆ†é’Ÿï¼ˆkey: `escrow:${trade_order_id}`ï¼‰

**æ­¥éª¤ 4.2**ï¼šäº¤æ˜“æµç¨‹é›†æˆ

- `services/market-listing/CoreService.js` åœ¨ `listing_kind = 'item_instance'` çš„äº¤æ˜“ä¸­ï¼š
  - ä¹°æ–¹ä»˜æ¬¾åç”Ÿæˆæ‹…ä¿ç  â†’ é€šçŸ¥å–æ–¹
  - ä¹°æ–¹è¾“å…¥æ‹…ä¿ç  â†’ éªŒè¯é€šè¿‡ â†’ å®Œæˆäº¤æ˜“

#### å¾®ä¿¡å°ç¨‹åºæ‰§è¡Œæ­¥éª¤

**æ­¥éª¤ 4.3**ï¼šæ‹…ä¿ç å±•ç¤º + è¾“å…¥ç¡®è®¤é¡µé¢

---

### Phase 5ï¼šCDKeyï¼ˆä»…è®¾è®¡ä¸å®æ–½ï¼‰

è®¾è®¡è¡¨ç»“æ„ `cdkey_batches` + `cdkey_codes`ï¼Œä¸å»ºè¡¨ä¸å¼€å‘ã€‚

---

## åã€å…¨éƒ¨å†³ç­–è®°å½•ï¼ˆ11 é¡¹å·²æ‹æ¿ï¼‰

### å†³ç­–1ï¼šå¤šæ¨¡å‹æ¶æ„ â†’ âœ… Aï¼šé‡‡ç”¨å¤šæ¨¡å‹

ä¸åŒä¸šåŠ¡ç”¨ä¸åŒæ ¸é”€æ–¹å¼ï¼Œç»Ÿä¸€è°ƒåº¦å±‚è‡ªåŠ¨åˆ†å‘ã€‚

### å†³ç­–2ï¼šå®ç‰©æ ¸é”€åŒæ–¹ç¡®è®¤ â†’ âœ… ä¸éœ€è¦ç”¨æˆ·ç¡®è®¤

å•†å®¶æ‰«ç å³æ ¸é”€å®Œæˆï¼Œæ ¸é”€åå‘å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯é€šçŸ¥ç”¨æˆ·ã€‚

### å†³ç­–3ï¼šè™šæ‹Ÿ/ç§¯åˆ†è¿›èƒŒåŒ… â†’ âœ… Aï¼šä¸è¿›èƒŒåŒ…ï¼Œç›´æ¥åˆ°è´¦

ä¸­å¥–å³åˆ°è´¦ï¼ŒæŠ½å¥–ç»“æœé¡µæ˜¾ç¤º"å·²åˆ°è´¦"ï¼Œä¸ç”Ÿæˆæ ¸é”€ç ã€‚

### å†³ç­–4ï¼šç§¯åˆ†å•†åŸç¡®è®¤æ”¶è´§ â†’ âœ… Aï¼šåŠ ç¡®è®¤æ”¶è´§

å‘è´§åç”¨æˆ·å¯ç¡®è®¤æ”¶è´§ï¼Œ7å¤©æœªæ“ä½œè‡ªåŠ¨ç¡®è®¤ã€‚

### å†³ç­–5ï¼šC2Cäº¤æ˜“æ‹…ä¿ç  â†’ âœ… Aï¼šä»…å®ç‰©äº¤æ˜“ç”¨

`listing_kind=item_instance` ç”¨ 6 ä½æ‹…ä¿ç ï¼›`fungible_asset` è‡ªåŠ¨è½¬ç§»ã€‚

### å†³ç­–6ï¼šCDKeyæ‰¹é‡åˆ†å‘ â†’ âœ… Bï¼šä»…è®¾è®¡ä¸å®æ–½

### å†³ç­–7ï¼šQRç æ ¸é”€ â†’ âœ… B + B-2

QRç  + æ–‡æœ¬ç å¹¶å­˜ï¼›QRç å†…å®¹ä¸ºåŠ¨æ€HMACç­¾åJSONï¼Œ5åˆ†é’Ÿæœ‰æ•ˆï¼ŒåŸºäº `CONSUMPTION_QR_SECRET`ã€‚

### å†³ç­–8ï¼šé—¨åº—å¼ºåˆ¶å…³è” â†’ âœ… Aï¼šå¼ºåˆ¶å…³è”

æ ¸é”€æ—¶è‡ªåŠ¨æ ¹æ®å•†å®¶å‘˜å·¥çš„ `store_staff` ç»‘å®šå…³ç³»ç¡®å®šé—¨åº—ã€‚

### å†³ç­–9ï¼šæœ‰æ•ˆæœŸç­–ç•¥ â†’ âœ… Cï¼šè¿è¥å¯é…ç½®

åœ¨ `system_configs` ä¸­é…ç½®å…¨å±€é»˜è®¤æœ‰æ•ˆæœŸ + å¥–å“çº§åˆ«è¦†ç›–ã€‚

### å†³ç­–10ï¼šSHA-256 ä¸å¯é€† â†’ âœ… Aï¼šç»´æŒä¸å¯é€†

### å†³ç­–11ï¼šç”¨æˆ·ç¡®è®¤ç¯èŠ‚ â†’ âœ… ä¸éœ€è¦

---

## åä¸€ã€æ€»æŠ•å…¥æ±‡æ€»

| é˜¶æ®µ | åç«¯ | Webç®¡ç†åå° | å¾®ä¿¡å°ç¨‹åº | åˆè®¡ |
|------|------|------------|-----------|------|
| Phase 1ï¼ˆåˆ°åº—æ ¸é”€å‡çº§ï¼‰ | 3.5 å¤© | 1 å¤© | 2 å¤© | 6.5 å¤© |
| Phase 2ï¼ˆè‡ªåŠ¨åˆ°è´¦ï¼‰ | 1 å¤© | 0 å¤© | 0.5 å¤© | 1.5 å¤© |
| Phase 3ï¼ˆç¡®è®¤æ”¶è´§ï¼‰ | 1.5 å¤© | 0.5 å¤© | 0.5 å¤© | 2.5 å¤© |
| Phase 4ï¼ˆæ‹…ä¿ç ï¼‰ | 1.5 å¤© | 0 å¤© | 1 å¤© | 2.5 å¤© |
| Phase 5ï¼ˆCDKeyè®¾è®¡ï¼‰ | 0.5 å¤© | 0 å¤© | 0 å¤© | 0.5 å¤© |
| **æ€»è®¡** | **8 å¤©** | **1.5 å¤©** | **4 å¤©** | **13.5 å¤©** |

---

## åäºŒã€å®æ–½å†³ç­–è®°å½•ï¼ˆP1-P5 å·²æ‹æ¿ï¼‰

> ä»¥ä¸‹ 5 é¡¹å†³ç­–å‡å·²æ‹æ¿ç¡®è®¤ï¼Œå«ä¸šç•Œæ–¹æ¡ˆå¯¹æ¯”åˆ†æã€‚

### P1ï¼šexchange_records çŠ¶æ€æ‰©å±• â†’ âœ… Aï¼šä¸€æ¬¡æ€§åŠ å…¨éƒ¨

**æ‹æ¿ç»“æœ**ï¼šä¸€æ¬¡æ€§å°† ENUM ä» `pending/completed/shipped/cancelled` æ‰©å±•ä¸º `pending/approved/shipped/received/rated/rejected/refunded/cancelled`ã€‚

**ä¸šç•Œå¯¹æ¯”**ï¼š

| å‚è€ƒæ–¹ | åšæ³• |
|--------|------|
| æ·˜å®/äº¬ä¸œ | ä¸€æ¬¡æ€§å®šä¹‰å®Œæ•´çŠ¶æ€æœºï¼ˆå¾…ä»˜æ¬¾â†’å¾…å‘è´§â†’å¾…æ”¶è´§â†’å·²å®Œæˆâ†’å·²è¯„ä»·ï¼ŒåŠ é€€æ¬¾åˆ†æ”¯ï¼‰ |
| ç¾å›¢ | å®Œæ•´çŠ¶æ€æœº + å­çŠ¶æ€ï¼ˆä¸»çŠ¶æ€å›ºå®šï¼Œå­çŠ¶æ€å¯æ‰©å±•ï¼‰ |
| å°å…¬å¸/åˆåˆ› | åˆ†æ­¥åŠ çŠ¶æ€ï¼Œä½†æ¯æ¬¡è¿ç§»éƒ½æœ‰å†å²æ•°æ®å¤„ç†é£é™© |

**å†³ç­–ç†ç”±**ï¼šé¡¹ç›®æœªä¸Šçº¿ï¼Œæ— å†å²æ•°æ®è¿ç§»é£é™©ã€‚ä¸€æ­¥åˆ°ä½æ˜¯æ‰€æœ‰æˆç†Ÿç”µå•†å¹³å°çš„åšæ³•ï¼Œé¿å…å¤šæ¬¡è¿ç§»ã€‚

---

### P2ï¼šè™šæ‹Ÿå¥–å“åˆ›å»º item_instance â†’ âœ… Aï¼šä¸åˆ›å»ºï¼ˆæŒ‰ prize_type åˆ†ç±»å¤„ç†ï¼‰

**æ‹æ¿ç»“æœ**ï¼šå½“å‰ `prize_type='virtual'` ä¸” `prize_value=0` çš„çº¯æ•ˆæœç±»å¥–å“ï¼ˆå¥½è¿åŠ æŒã€å¨å¸ˆç¥ç¦ç­‰ï¼‰ï¼Œä¸­å¥–åä¸åˆ›å»º item_instanceï¼Œç›´æ¥å±•ç¤ºæ•ˆæœæ–‡æ¡ˆã€‚

**æ‰©å±•æ€§è®¾è®¡**ï¼šæœªæ¥è‹¥æ–°å¢æœ‰å®é™…ä»·å€¼çš„è™šæ‹Ÿå¥–å“ï¼ˆVIPä½“éªŒå¡ã€è§£é”ç‰¹æ®ŠåŠŸèƒ½ç­‰ï¼‰ï¼Œä¸ä¿®æ”¹ virtual çš„é€»è¾‘ï¼Œè€Œæ˜¯æ–°å¢ `prize_type`ï¼ˆå¦‚ `membership`ã€`privilege`ï¼‰ï¼Œèµ°ä¸åŒçš„æ ¸é”€æ¨¡å‹ã€‚`lottery_prizes.prize_type` å­—æ®µé ENUM å¯è‡ªç”±æ‰©å±•ã€‚

**ä¸šç•Œå¯¹æ¯”**ï¼š

| å‚è€ƒæ–¹ | åšæ³• | é€‚ç”¨åœºæ™¯ |
|--------|------|---------|
| ç‹è€…è£è€€/åŸç¥ | æ°¸ä¹…é“å…·å†™ inventoryï¼Œæ¶ˆè€—å“/buff ç±»ä¸å†™ inventoryï¼Œç›´æ¥åŠ æ•ˆæœ | å½“å‰é¡¹ç›® virtual å±äº buff ç±» |
| æ‹¼å¤šå¤šçº¢åŒ… | ä¸åˆ›å»ºå•†å“è®°å½•ï¼Œç›´æ¥åŠ ä½™é¢ | æ•°å­—ç±»å¥–åŠ± |
| ç¾å›¢ä¼˜æƒ åˆ¸ | åˆ›å»ºåˆ¸è®°å½•ï¼ˆæœ‰ä½¿ç”¨æ¡ä»¶ã€æœ‰æ•ˆæœŸã€å¯è½¬èµ ï¼‰ | æœ‰ç”Ÿå‘½å‘¨æœŸç®¡ç†éœ€æ±‚çš„åˆ¸ç±» |
| æŠ–éŸ³ç›´æ’­ç¤¼ç‰©ç‰¹æ•ˆ | ä¸åˆ›å»º inventoryï¼Œæ‰£è´¹åç›´æ¥è§¦å‘åŠ¨ç”»æ•ˆæœ | çº¯è¡¨ç°å±‚å±•ç¤º |

**å†³ç­–ç†ç”±**ï¼šå½“å‰ 6 ç§ virtual å¥–å“ `prize_value` å…¨ä¸º 0ï¼Œçº¯æ–‡å­—/åŠ¨ç”»æ•ˆæœï¼Œæ— æ‰€æœ‰æƒ/ä½¿ç”¨/è½¬èµ ç­‰ç”Ÿå‘½å‘¨æœŸæ¦‚å¿µã€‚é€šè¿‡ `prize_type` åˆ†ç±»è·¯ç”±ï¼Œæœªæ¥æ‰©å±•ä¸å½±å“å·²æœ‰é€»è¾‘ã€‚

---

### P3ï¼šæ‹…ä¿ç è¶…æ—¶å¤„ç† â†’ âœ… Cï¼šé˜¶æ¢¯å¼è‡ªåŠ¨å¤„ç†

**æ‹æ¿ç»“æœ**ï¼š

```
ä¹°æ–¹ä»˜æ¬¾å 30 åˆ†é’Ÿå†…ï¼šæ‹…ä¿ç æœ‰æ•ˆï¼Œå¯é‡æ–°ç”Ÿæˆ
         â†“ 4 å°æ—¶æœªç¡®è®¤
ç³»ç»Ÿæ¨é€æé†’ï¼ˆé€šçŸ¥ä¹°å–åŒæ–¹ï¼‰
         â†“ 24 å°æ—¶æœªç¡®è®¤
è‡ªåŠ¨å–æ¶ˆäº¤æ˜“ï¼Œé€€æ¬¾ç»™ä¹°æ–¹
         â†“ ä»»ä¸€æ–¹æœ‰å¼‚è®®
èµ°ç®¡ç†å‘˜(admin)åå°äººå·¥å¤„ç†ï¼ˆå¤ç”¨ç°æœ‰ admin åå°ï¼‰
```

**ä¸šç•Œå¯¹æ¯”**ï¼š

| å‚è€ƒæ–¹ | åšæ³• | è¶…æ—¶æ—¶é•¿ |
|--------|------|---------|
| é—²é±¼ | ä¸è‡ªåŠ¨å–æ¶ˆï¼Œèµ°å®¢æœä»²è£ | æ— å›ºå®šè¶…æ—¶ |
| 5173ï¼ˆæ¸¸æˆäº¤æ˜“ï¼‰ | è¶…æ—¶è‡ªåŠ¨å–æ¶ˆé€€æ¬¾ï¼ŒåŒæ–¹å¯ç”³è¯‰ | 24h |
| è½¬è½¬ï¼ˆäºŒæ‰‹ï¼‰ | é˜¶æ¢¯å¼ï¼šå…ˆæé†’â†’å†å»¶æ—¶â†’æœ€ç»ˆè‡ªåŠ¨ç¡®è®¤ | 7å¤©+3å¤© |
| æ·˜å® | å‘è´§åä¹°å®¶ä¸æ“ä½œâ†’è‡ªåŠ¨ç¡®è®¤æ”¶è´§ | 10-15å¤© |
| å°å¹³å°/åˆåˆ› | è‡ªåŠ¨å–æ¶ˆé€€æ¬¾ | å‡ å°æ—¶~1å¤© |

**å†³ç­–ç†ç”±**ï¼š
- å½“å‰äº¤æ˜“è§„æ¨¡å°ï¼ˆ19 ç¬”å®Œæˆäº¤æ˜“ï¼‰ï¼Œä¸éœ€è¦ä¸“é—¨å®¢æœç³»ç»Ÿ
- å¼‚è®®èµ°ç°æœ‰ admin ç®¡ç†åå°å¤„ç†ï¼Œé›¶é¢å¤–åŸºå»ºæˆæœ¬
- 24 å°æ—¶è‡ªåŠ¨å–æ¶ˆè¦†ç›–å½“é¢äº¤æ˜“åœºæ™¯
- åæœŸè§„æ¨¡å¤§äº†å¯å‡çº§ä¸ºæ­£å¼å®¢æœä»²è£ç³»ç»Ÿ

---

### P4ï¼šstore_staff æµ‹è¯•æ•°æ® â†’ âœ… Aï¼šå…ˆè¡¥æ•°æ®

**æ‹æ¿ç»“æœ**ï¼šåœ¨ seeders ä¸­è¡¥å……æ´»è·ƒçš„ store_staff æµ‹è¯•æ•°æ®ï¼Œå¼€å‘è”è°ƒå‰ç¡®ä¿æœ‰å¯ç”¨çš„é—¨åº—-å‘˜å·¥ç»‘å®šå…³ç³»ã€‚

---

### P5ï¼šæ ¸é”€è¿‡æœŸæ¸…ç†é¢‘ç‡ â†’ âœ… B + æ‡’è¿‡æœŸï¼šæ¯å¤©å‡Œæ™¨æ‰¹é‡ + æŸ¥è¯¢æ—¶å®æ—¶åˆ¤æ–­

**æ‹æ¿ç»“æœ**ï¼šåŒé‡æœºåˆ¶ â€”
1. **å®æ—¶åˆ¤æ–­ï¼ˆæ‡’è¿‡æœŸï¼‰**ï¼š`RedemptionOrder.isExpired()` æ–¹æ³•å·²å­˜åœ¨ï¼ŒæŸ¥è¯¢æ—¶è‡ªåŠ¨åˆ¤æ–­è¿‡æœŸçŠ¶æ€
2. **å®šæ—¶ä»»åŠ¡ï¼ˆå…œåº•ï¼‰**ï¼šæ¯å¤©å‡Œæ™¨æ‰¹é‡æ‰«æ `status='pending' AND expires_at < NOW()` çš„è®°å½•ï¼Œæ›´æ–°ä¸º `expired`

**ä¸šç•Œå¯¹æ¯”**ï¼š

| å‚è€ƒæ–¹ | åšæ³• |
|--------|------|
| ç¾å›¢ä¼˜æƒ åˆ¸ | æ¯å¤©å‡Œæ™¨æ‰¹é‡è¿‡æœŸï¼ˆåˆ¸æœ‰æ•ˆæœŸæŒ‰å¤©ç®—ï¼‰ |
| æ¸¸æˆé“å…·è¿‡æœŸ | å®æ—¶æ£€æŸ¥ï¼ˆæŸ¥è¯¢æ—¶åˆ¤æ–­ï¼‰ |
| æ·˜å®è®¢å•è¶…æ—¶ | å®šæ—¶ä»»åŠ¡æ¯ 5-15 åˆ†é’Ÿ |

**å†³ç­–ç†ç”±**ï¼šæ ¸é”€ç æœ‰æ•ˆæœŸ 7-30 å¤©çº§åˆ«ï¼Œæ¯å¤©æ¸…ç†ä¸€æ¬¡è¶³å¤Ÿã€‚æ‡’è¿‡æœŸä¿è¯æŸ¥è¯¢ç»“æœå‡†ç¡®æ€§ï¼Œå®šæ—¶ä»»åŠ¡ä¿è¯ status å­—æ®µæœ€ç»ˆä¸€è‡´æ€§ã€‚

---

## åä¸‰ã€æ ¸æŸ¥æ–°å¢å†³ç­–è®°å½•ï¼ˆP6-P9 å·²æ‹æ¿ï¼‰

> ä»¥ä¸‹ 4 é¡¹å†³ç­–åŸºäºæœ¬æ¬¡çœŸå®ä»£ç +æ•°æ®åº“æ ¸æŸ¥å‘ç°çš„é—®é¢˜ï¼Œå‡å·²æ‹æ¿ç¡®è®¤ï¼Œå«ä¸šç•Œæ–¹æ¡ˆå¯¹æ¯”åˆ†æã€‚

### P6ï¼šå•†å®¶æ ¸é”€æƒé™é˜ˆå€¼ â†’ âœ… Aï¼š`>= 20` + store_staff ç»‘å®šæ ¡éªŒ

**æ‹æ¿ç»“æœ**ï¼š`role_level >= 20`ï¼ˆå…è®¸ merchant_staff + merchant_manager + business_manager + adminï¼‰ï¼ŒåŒæ—¶åœ¨æœåŠ¡å±‚å åŠ  `store_staff WHERE status='active'` ç»‘å®šæ ¡éªŒã€‚

**ä¸šç•Œå¯¹æ¯”**ï¼š

| å‚è€ƒæ–¹ | æ ¸é”€æƒé™è®¾è®¡ | æ ¸å¿ƒé€»è¾‘ |
|--------|------------|---------|
| ç¾å›¢åˆ°åº— | ä»»ä½•ç»‘å®šäº†é—¨åº—çš„å‘˜å·¥éƒ½èƒ½æ ¸é”€ï¼Œç³»ç»Ÿè‡ªåŠ¨æŸ¥é—¨åº—ç»‘å®šå…³ç³» | **ç»‘å®šå…³ç³» = æƒé™** |
| æ˜Ÿå·´å…‹/éº¦å½“åŠ³ | ä»»ä½•ç™»å½•äº†é—¨åº—POSçš„å‘˜å·¥éƒ½èƒ½å¤„ç†æ ¸é”€ | ç™»å½•é—¨åº—ç³»ç»Ÿ = æˆæƒ |
| é˜¿é‡Œå£ç¢‘/é¥¿äº†ä¹ˆ | å•†å®¶ç«¯ç‹¬ç«‹Appï¼Œç™»å½•å³å¯æ ¸é”€ï¼Œæƒé™åœ¨"æ˜¯å¦ä¸ºè¯¥åº—å‘˜å·¥"å±‚é¢ | å•†å®¶ç«¯å’Œç®¡ç†ç«¯åˆ†ç¦» |
| è…¾è®¯å¾®ä¿¡å¡åˆ¸ | æœ‰æ ¸é”€æƒé™çš„æ“ä½œå‘˜å³å¯ï¼ŒæŒ‰åŠŸèƒ½æˆæƒä¸æ˜¯æŒ‰ç­‰çº§ | åŠŸèƒ½çº§æˆæƒ |
| å°å…¬å¸å¸¸è§é”™è¯¯ | ç”¨å…¨å±€ role_level æ§åˆ¶ | å®¹æ˜“å‡ºç°"è®¾äº†é˜ˆå€¼ç»“æœå•†å®¶æ ¸é”€ä¸äº†"çš„é—®é¢˜ |

**å†³ç­–ç†ç”±**ï¼š
- `role_level >= 20` æ’é™¤æ™®é€šç”¨æˆ·ï¼ˆ0ï¼‰å’Œæ´»åŠ¨è§’è‰²ï¼ˆ10ï¼‰ï¼Œç¡®ä¿åªæœ‰å•†å®¶ä½“ç³»çš„äººèƒ½è§¦è¾¾æ ¸é”€æ¥å£
- `store_staff` WHERE `status = 'active'` ç¡®ä¿æ ¸é”€äººæ˜¯æŸé—¨åº—çš„åœ¨èŒå‘˜å·¥ â€” ä¸¤å±‚æ ¡éªŒè·Ÿç¾å›¢/å£ç¢‘åŒä¸€æ€è·¯
- å†³ç­–8"é€šè¿‡ store_staff è‡ªåŠ¨ç¡®å®šé—¨åº—"çš„å‰æå°±æ˜¯æ ¸é”€äººåœ¨ store_staff æœ‰ç»‘å®šï¼Œæœ¬èº«å°±æ˜¯æƒé™å‡­è¯

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `routes/v4/shop/redemption/fulfill.js:70`ï¼ˆæ”¹ `role_level` é˜ˆå€¼ä¸º `>= 20`ï¼‰
- `RedemptionService.fulfillOrder()`ï¼ˆæœåŠ¡å±‚å…œåº•å åŠ  store_staff æ´»è·ƒæ ¡éªŒï¼‰

---

### P7ï¼šæ ¸é”€QRç å®ç°æ–¹å¼ â†’ âœ… Aï¼šæ–°å»ºç‹¬ç«‹ `RedemptionQRSigner.js` + ç‹¬ç«‹å¯†é’¥

**æ‹æ¿ç»“æœ**ï¼šæ–°å»º `utils/RedemptionQRSigner.js`ï¼Œ`.env` æ–°å¢ `REDEMPTION_QR_SECRET`ï¼Œä¸æ¶ˆè´¹å½•å…¥QRç³»ç»Ÿå®Œå…¨éš”ç¦»ã€‚

**ä¸¤å¥—ç³»ç»Ÿå¯¹æ¯”ï¼ˆä¸å¯åˆå¹¶çš„åŸå› ï¼‰**ï¼š

| ç»´åº¦ | æ¶ˆè´¹å½•å…¥QRï¼ˆå·²æœ‰ `QRCodeValidator.js`ï¼‰ | æ ¸é”€QRï¼ˆæ–°å»º `RedemptionQRSigner.js`ï¼‰ |
|------|-------------------|----------------|
| ç”¨é€” | ç”¨æˆ·åˆ°åº—æ¶ˆè´¹æ—¶å‡ºç¤ºèº«ä»½ | ç”¨æˆ·åˆ°åº—å…‘æ¢å¥–å“æ—¶å‡ºç¤º |
| Payload | `{ user_uuid, exp, nonce }` | `{ order_id, code_hash, timestamp }` |
| éªŒè¯ç›®æ ‡ | ç¡®è®¤ç”¨æˆ·èº«ä»½ | ç¡®è®¤æ ¸é”€ç æœ‰æ•ˆæ€§ |
| å¯†é’¥ | `CONSUMPTION_QR_SECRET` | `REDEMPTION_QR_SECRET`ï¼ˆæ–°å¢ï¼‰ |
| é˜²é‡æ”¾ | Redis nonce ä¸€æ¬¡æ€§æ¶ˆè´¹ | æ— éœ€ï¼ˆæ ¸é”€ç æœ¬èº«æ˜¯ä¸€æ¬¡æ€§çš„ï¼‰ |
| å‰ç¼€ | `QRV2_` | `RQRV1_` |

**ä¸šç•Œå¯¹æ¯”**ï¼š

| å‚è€ƒæ–¹ | ä¸åŒä¸šåŠ¡çš„QRç  | æ˜¯å¦å…±ç”¨ä¸€å¥—ç³»ç»Ÿ |
|--------|-------------|---------------|
| æ”¯ä»˜å® | ä»˜æ¬¾ç ã€æ”¶æ¬¾ç ã€è½¬è´¦ç ã€å°ç¨‹åºç ã€å‡ºè¡Œç  | âŒ å…¨éƒ¨ç‹¬ç«‹ç³»ç»Ÿ |
| å¾®ä¿¡ | ä»˜æ¬¾ç ã€æ”¶æ¬¾ç ã€å°ç¨‹åºç ã€ç¾¤äºŒç»´ç  | âŒ ç”šè‡³ä¸åŒå›¢é˜Ÿç»´æŠ¤ |
| ç¾å›¢ | åˆ°åº—åˆ¸æ ¸é”€ç ã€å¤–å–å–é¤ç ã€æ”¯ä»˜ç  | âŒ payload ç»“æ„å®Œå…¨ä¸åŒ |
| Steam | ç¤¼å“å¡ã€æ¸¸æˆå…‘æ¢ç ã€å¥½å‹é‚€è¯·ç  | âŒ å®Œå…¨ç‹¬ç«‹ |
| å°å…¬å¸å¸¸è§é”™è¯¯ | æ‰€æœ‰ QR ç å…±ç”¨ä¸€ä¸ªå·¥å…·ç±» | ä¸€ä¸ªä¸šåŠ¡æ”¹åŠ¨å½±å“æ‰€æœ‰ä¸šåŠ¡ï¼Œç»´æŠ¤å™©æ¢¦ |

**å†³ç­–ç†ç”±**ï¼špayload ç»“æ„ä¸åŒã€å®‰å…¨åŸŸä¸åŒï¼ˆå¯†é’¥åº”éš”ç¦»ï¼‰ã€ç”Ÿå‘½å‘¨æœŸä¸åŒã€ä¸€ä¸ªæ”¹åŠ¨ä¸åº”å½±å“å¦ä¸€ä¸ªä¸šåŠ¡ã€‚æ–°æ–‡ä»¶çº¦ 100 è¡Œä»£ç ï¼Œç»´æŠ¤æˆæœ¬å‡ ä¹ä¸ºé›¶ï¼›å¡è¿›è€æ–‡ä»¶çš„è€¦åˆæˆæœ¬è¿œé«˜äºæ­¤ã€‚

---

### P8ï¼šæ ¸é”€æœ‰æ•ˆæœŸé…ç½®å­˜å‚¨ä½ç½® â†’ âœ… Aï¼šSystemSettings æ–°å¢ `redemption` category

**æ‹æ¿ç»“æœ**ï¼šä½¿ç”¨ SystemSettings æ¨¡å‹ï¼Œæ–°å¢ `redemption` categoryï¼Œå¤ç”¨ç°æœ‰ `/api/v4/console/settings/:category` CRUD æ¥å£å’Œ admin å‰ç«¯ç®¡ç†é¡µé¢ã€‚

**ä¸¤å¥—é…ç½®ä½“ç³»å¯¹æ¯”**ï¼š

| ç»´åº¦ | `system_configs` è¡¨ | `SystemSettings` æ¨¡å‹ï¼ˆâœ… é€‰ç”¨ï¼‰ |
|------|--------------------|--------------------|
| å­˜å‚¨ | ç‹¬ç«‹è¡¨ `system_configs`ï¼Œ11 æ¡è®°å½• | é€šè¿‡ ORM å’Œ `/api/v4/console/settings/:category` ç®¡ç† |
| ç®¡ç†æ¥å£ | æ— ç‹¬ç«‹ç®¡ç†API | `/api/v4/console/settings` GET/PUT |
| å‰ç«¯ç®¡ç† | æ— ç°æˆUI | `admin/src/modules/system/composables/config.js` å·²æœ‰å®Œæ•´ç®¡ç†é¡µé¢ï¼ˆ5 ä¸ª categoryï¼‰ |
| å½“å‰ç”¨é€” | æ‰¹é‡æ“ä½œé™æµã€æ´»åŠ¨é…ç½®ã€UIé…ç½®ç­‰ | ç³»ç»Ÿåç§°ã€ç§¯åˆ†å‚æ•°ã€é€šçŸ¥å¼€å…³ã€å®‰å…¨ç­–ç•¥ã€å¸‚åœºé…ç½® |
| æ•°æ®æ ¼å¼ | JSON value | `setting_key`/`setting_value`/`value_type` ç»“æ„åŒ– |

**ä¸šç•Œå¯¹æ¯”**ï¼š

| å‚è€ƒæ–¹ | é…ç½®ç®¡ç†æ–¹å¼ | æ ¸å¿ƒåŸåˆ™ |
|--------|------------|---------|
| é˜¿é‡Œï¼ˆNacos/Apolloï¼‰ | ç»Ÿä¸€é…ç½®ä¸­å¿ƒï¼Œæ‰€æœ‰ä¸šåŠ¡é…ç½®ä»ä¸€ä¸ªåœ°æ–¹ç®¡ç†ï¼Œæœ‰ç‰ˆæœ¬å†å² | **ä¸€ä¸ªå…¥å£ç®¡æ‰€æœ‰é…ç½®** |
| ç¾å›¢ | ç»Ÿä¸€é…ç½®æœåŠ¡ + ç®¡ç† UIï¼ŒæŒ‰ä¸šåŠ¡åŸŸåˆ† namespace | åŒä¸Š |
| è…¾è®¯ | ç»Ÿä¸€è¿è¥é…ç½®åå°ï¼Œä¸åŒä¸šåŠ¡æ˜¯ä¸åŒ tab/æ¨¡å— | åŒä¸Š |
| å°å…¬å¸å¸¸è§é”™è¯¯ | å¤šå¼ è¡¨æ•£å­˜é…ç½®ï¼Œæ”¹é…ç½®æ—¶ä¸çŸ¥é“å»å“ªæ‰¾ | æ’æŸ¥é—®é¢˜æ—¶æŸ¥åŠå¤© |

**å†³ç­–ç†ç”±**ï¼šä¸€ä¸ªé¡¹ç›®æœ‰ä¸”åªæœ‰ä¸€ä¸ªé…ç½®ç®¡ç†å…¥å£ã€‚SystemSettings å·²æœ‰å®Œæ•´çš„ CRUD + UI + ç±»å‹æ ¡éªŒ + åªè¯»ä¿æŠ¤ï¼Œæ–°å¢ `redemption` category åªéœ€åœ¨ `CATEGORY_DISPLAY` åŠ ä¸€é¡¹ï¼Œå‰ç«¯ç®¡ç†é›¶æˆæœ¬ã€‚`system_configs` ä¿ç•™ç»™ç³»ç»Ÿçº§é™æµå‚æ•°ç­‰ä¸éœ€è¿è¥é¢‘ç¹æ”¹åŠ¨çš„åœºæ™¯ã€‚

---

### P9ï¼šAdminå‰ç«¯æ ¸é”€ç®¡ç†åŒè·¯å¾„åˆå¹¶æ–¹å‘ â†’ âœ… Aï¼šä¿ç•™ operations è·¯å¾„ï¼ŒåºŸå¼ƒ lottery é‡å¤ä»£ç 

**æ‹æ¿ç»“æœ**ï¼šä¿ç•™ operations æ¨¡å—ï¼ˆ`api/redemption.js` + `operations/pages/redemption-management.js`ï¼‰ä½œä¸ºæ ¸é”€ç®¡ç†å”¯ä¸€å®ç°ï¼ŒåºŸå¼ƒ `lottery/composables/redemption.js` ä¸­çš„é‡å¤æ ¸é”€ç®¡ç†ä»£ç ã€‚lottery æ¨¡å—å¦‚éœ€å±•ç¤ºæ ¸é”€çŠ¶æ€ï¼Œimport operations çš„å®ç°ã€‚

**ä¸¤å¥—é‡å¤ä»£ç å¯¹æ¯”**ï¼š

| ç»´åº¦ | è·¯å¾„1ï¼šoperations æ¨¡å—ï¼ˆâœ… ä¿ç•™ï¼‰ | è·¯å¾„2ï¼šlottery æ¨¡å—ï¼ˆâŒ åºŸå¼ƒé‡å¤ä»£ç ï¼‰ |
|------|----------------------|-------------------|
| APIå°è£… | `admin/src/api/redemption.js`ï¼ˆ`RedemptionAPI`ï¼‰ | `admin/src/api/lottery/advanced.js`ï¼ˆ`LOTTERY_ADVANCED_ENDPOINTS`ï¼‰ |
| é¡µé¢ç»„ä»¶ | `admin/src/modules/operations/pages/redemption-management.js` | `admin/src/modules/lottery/composables/redemption.js` |
| æ•°æ®æå– | `result.data.orders \|\| result.data.items \|\| result.data.list` | `data.orders \|\| data.records \|\| data.codes` |
| IDå­—æ®µ | `order.redemption_order_id \|\| order.order_id` | `c.redemption_order_id` |
| åŠŸèƒ½å®Œæ•´åº¦ | æ›´å®Œæ•´ï¼ˆå«é—¨åº—åŠ è½½ã€æ‰¹é‡æ“ä½œUIï¼‰ | åŸºç¡€åŠŸèƒ½ |

**ä¸šç•Œå¯¹æ¯”**ï¼š

| å‚è€ƒæ–¹ | åšæ³• | åŸåˆ™ |
|--------|------|------|
| é˜¿é‡Œ | ä¸¥æ ¼æ¨¡å—è¾¹ç•Œï¼Œä¸€ä¸ªåŠŸèƒ½ä¸€ä¸ªå®ç°ä½ç½®ï¼Œè·¨æ¨¡å—è°ƒç”¨é€šè¿‡ import | **å•ä¸€èŒè´£ + DRY** |
| ç¾å›¢ | æ¯ä¸ªç®¡ç†åŠŸèƒ½æœ‰ä¸”åªæœ‰ä¸€ä¸ª"ä¸šåŠ¡Owner"æ¨¡å— | **åŠŸèƒ½å½’å±å”¯ä¸€** |
| å­—èŠ‚ | å‰ç«¯ monorepo é‡Œæ¯ä¸ªåŠŸèƒ½åŒ…æœ‰æ˜ç¡® ownership | åŒä¸Š |
| å°å…¬å¸å¸¸è§é”™è¯¯ | åŒä¸€åŠŸèƒ½åœ¨ä¸¤ä¸ªæ¨¡å—å„å†™ä¸€éï¼Œæ”¹ä¸€å¤„å¿˜æ”¹å¦ä¸€å¤„ | æ•°æ®å±•ç¤ºä¸ä¸€è‡´ï¼Œé€æ¸åˆ†å‰ |

**å†³ç­–ç†ç”±**ï¼šæ ¸é”€æ˜¯è¿è¥åŠ¨ä½œä¸æ˜¯æŠ½å¥–åŠ¨ä½œï¼Œå½’å± operations æ¨¡å—æ›´åˆç†ã€‚lottery æ¨¡å—ä¸“æ³¨æŠ½å¥–é…ç½®/ç»Ÿè®¡/æ´»åŠ¨ç®¡ç†ã€‚ç»Ÿä¸€ä½¿ç”¨ `redemption_order_id` å­—æ®µåï¼Œå»æ‰ `order.order_id` fallbackã€‚

---

## åå››ã€æœ¬æ¬¡æ ¸æŸ¥ä¿®æ­£æ±‡æ€»

### ä¸Šç‰ˆæ–‡æ¡£é”™è¯¯ä¿®æ­£ï¼ˆ6 å¤„ï¼‰

| # | é”™è¯¯é¡¹ | ä¸Šç‰ˆæ–‡æ¡£æè¿° | çœŸå®æƒ…å†µ | å½±å“ |
|---|--------|-----------|---------|------|
| ä¿®1 | lottery_prizes ä¸»é”® | `prize_id` | **`lottery_prize_id`** | æ‰€æœ‰å¼•ç”¨æ­¤å­—æ®µçš„å‰ç«¯ä»£ç éœ€æ›´æ­£ |
| ä¿®2 | lottery_prizes åº“å­˜ | `stock` | **`stock_quantity`** | åŒä¸Š |
| ä¿®3 | store_staff è§’è‰²å­—æ®µ | `role` | **`role_in_store`**ï¼ˆENUM: staff/managerï¼‰ | æ ¸é”€é—¨åº—å…³è”æŸ¥è¯¢éœ€ä½¿ç”¨æ­£ç¡®å­—æ®µå |
| ä¿®4 | item_instances ç‰©å“å | `item_name` | **ä¸å­˜åœ¨**ï¼Œåç§°åœ¨ `meta` JSON çš„ `.name` å±æ€§ | å‰ç«¯å±•ç¤ºç‰©å“åéœ€ä½¿ç”¨ `item_instance.meta.name` |
| ä¿®5 | B8"cronä¸å­˜åœ¨" | è®¤ä¸ºæ ¸é”€è¿‡æœŸæ¸…ç†æ—  cron | **å·²å­˜åœ¨**ï¼š`scheduled_tasks.js` ä»»åŠ¡11ï¼Œæ¯å¤© 2:00 AM | B8 ä¸æ˜¯é—®é¢˜ï¼Œå·²è§£å†³ |
| ä¿®6 | CONSUMPTION_QR_SECRET å¤ç”¨ | è®¤ä¸ºå¯ç›´æ¥ç”¨äºæ ¸é”€QR | **å·²è¢«æ¶ˆè´¹å½•å…¥QRç³»ç»Ÿä½¿ç”¨**ï¼Œæ ¸é”€QRéœ€ç‹¬ç«‹å¯†é’¥ | éœ€æ–°å¢ `REDEMPTION_QR_SECRET` |

### æ–°å‘ç°çš„çœŸå®é—®é¢˜ï¼ˆ4 å¤„ï¼Œå†³ç­–å‡å·²æ‹æ¿ï¼‰

| # | æ–°å‘ç° | å½±å“ | å†³ç­– |
|---|--------|------|------|
| B9 | å•†å®¶æ ¸é”€æƒé™ role_level >= 50ï¼Œmerchant_staff/merchant_manager æ— æ³•æ ¸é”€ | å•†å®¶ç«¯æ ¸é”€åŠŸèƒ½å®Œå…¨ä¸å¯ç”¨ | âœ… P6ï¼šæ”¹ä¸º `>= 20` + store_staff æ ¡éªŒ |
| B10 | item_instances æ—  item_name åˆ— | å‰ç«¯å¼•ç”¨éœ€æ”¹ä¸º meta.name | å‰ç«¯ç›´æ¥æ”¹ |
| W5 | Admin å‰ç«¯æ ¸é”€ç®¡ç†åŒè·¯å¾„é‡å¤ä»£ç  | ç»´æŠ¤æˆæœ¬ç¿»å€ | âœ… P9ï¼šä¿ç•™ operationsï¼ŒåºŸå¼ƒ lottery é‡å¤ |
| B11 | QRCodeValidator.js æ˜¯æ¶ˆè´¹å½•å…¥ç³»ç»Ÿï¼Œä¸æ ¸é”€ç æ— å…³ | æ ¸é”€QRéœ€ç‹¬ç«‹å®ç° | âœ… P7ï¼šæ–°å»ºç‹¬ç«‹ `RedemptionQRSigner.js` |

### ç¬¦åˆåç«¯æŠ€æœ¯æ ˆçš„ç¡®è®¤é¡¹

| ç¡®è®¤é¡¹ | åç«¯æŠ€æœ¯æ ˆ | æ˜¯å¦ç¬¦åˆ | Webå‰ç«¯æŠ€æœ¯æ ˆ | æ˜¯å¦ç¬¦åˆ |
|--------|----------|---------|-------------|---------|
| APIè·¯å¾„è§„èŒƒ | `/api/v4/{resource}` RESTful | âœ… æ‰€æœ‰æ–°æ¥å£éµå¾ªæ­¤è§„èŒƒ | `API_PREFIX = '/api/v4'` + `request()` å°è£… | âœ… ç›´æ¥è°ƒç”¨ |
| äº‹åŠ¡ç®¡ç† | `TransactionManager.execute()` + `assertAndGetTransaction()` | âœ… æ‰€æœ‰å†™æ“ä½œå¤ç”¨ | â€” | â€” |
| å‚æ•°æ ¡éªŒ | Joiï¼ˆ`joi: ^17.11.0`ï¼‰ | âœ… æ–°æ¥å£å¯å¤ç”¨ | â€” | â€” |
| å“åº”æ ¼å¼ | `res.apiSuccess()` / `res.apiError()` ç»Ÿä¸€å°è£… | âœ… å·²æœ‰ `ApiResponse` | `request()` è§£æ `{ success, code, message, data }` | âœ… å·²é€‚é… |
| æœåŠ¡ç®¡ç† | `ServiceManager.getService('redemption_order')` | âœ… å·²æ³¨å†Œ | â€” | â€” |
| å®šæ—¶ä»»åŠ¡ | `node-cron` + Redisåˆ†å¸ƒå¼é” + Jobç±»ç»Ÿä¸€å…¥å£ | âœ… æ–°å¢ä»»åŠ¡æŒ‰ç°æœ‰æ¨¡å¼ | â€” | â€” |
| å‰ç«¯ç»„ä»¶ | â€” | â€” | Alpine.js x-data + composable + EJS template | âœ… æ–°å¢é¡µé¢æŒ‰ç°æœ‰æ¨¡å¼ |
| APIå°è£… | â€” | â€” | `admin/src/api/base.js` çš„ `request()` + `buildURL()` | âœ… æ–°å¢APIæŒ‰ç°æœ‰æ¨¡å¼ |
