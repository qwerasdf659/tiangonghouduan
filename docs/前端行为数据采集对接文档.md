# ğŸ“Š å‰ç«¯è¡Œä¸ºæ•°æ®é‡‡é›†å¯¹æ¥æ–‡æ¡£

**ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2025å¹´08æœˆ20æ—¥  
**åç«¯APIç‰ˆæœ¬**: v3.0  
**æŠ€æœ¯æ ˆ**: å¾®ä¿¡å°ç¨‹åºå‰ç«¯ + Node.jsåç«¯

---

## ğŸ¯ **æ¦‚è¿°**

ç”¨æˆ·è¡Œä¸ºæ£€æµ‹ç³»ç»Ÿåç«¯å·²å®Œå…¨å®ç°ï¼Œç°éœ€è¦å‰ç«¯é…åˆå®Œæˆè¡Œä¸ºæ•°æ®é‡‡é›†å’Œå±•ç¤ºåŠŸèƒ½ã€‚æœ¬æ–‡æ¡£æä¾›å®Œæ•´çš„å‰ç«¯å¯¹æ¥æŒ‡å—ã€‚

## ğŸ”§ **åç«¯å·²å®ç°åŠŸèƒ½**

### âœ… **æ•°æ®åº“è¡¨ç»“æ„** (4/4å®Œæˆ)

- `analytics_behaviors` - ç”¨æˆ·è¡Œä¸ºæ•°æ®
- `analytics_user_profiles` - ç”¨æˆ·ç”»åƒåˆ†æ
- `analytics_recommendations` - æ™ºèƒ½æ¨èç»“æœ
- `analytics_realtime_stats` - å®æ—¶ç»Ÿè®¡æ•°æ®

### âœ… **APIæ¥å£** (å®Œå…¨å®ç°)

- **å¥åº·æ£€æŸ¥**: `GET /api/v3/analytics/health`
- **è¡Œä¸ºä¸ŠæŠ¥**: `POST /api/v3/analytics/behaviors/batch`
- **ç”¨æˆ·ç”»åƒ**: `GET /api/v3/analytics/users/:userId/profile`
- **æ™ºèƒ½æ¨è**: `GET /api/v3/analytics/users/:userId/recommendations`
- **æ¨èåé¦ˆ**: `POST /api/v3/analytics/recommendations/:id/shown|clicked`
- **ç®¡ç†å‘˜ç»Ÿè®¡**: `GET /api/v3/analytics/admin/overview`

### âœ… **æœåŠ¡é›†æˆ** (å®Œå…¨å®ç°)

- JWTè®¤è¯é›†æˆ
- æƒé™æ§åˆ¶é›†æˆ
- äº‹ä»¶æ€»çº¿é›†æˆ
- Redisç¼“å­˜é›†æˆ

---

## ğŸ“¡ **å‰ç«¯éœ€è¦å®ç°çš„åŠŸèƒ½**

### 1. **è¡Œä¸ºæ•°æ®é‡‡é›†SDK**

#### **1.1 åŸºç¡€é‡‡é›†é…ç½®**

```javascript
// utils/analytics.js - è¡Œä¸ºé‡‡é›†å·¥å…·ç±»
class BehaviorTracker {
  constructor() {
    this.sessionId = this.generateSessionId()
    this.behaviorBuffer = []
    this.maxBufferSize = 50
    this.uploadInterval = 30000 // 30ç§’ä¸Šä¼ ä¸€æ¬¡

    this.startAutoUpload()
  }

  // ç”Ÿæˆä¼šè¯ID
  generateSessionId() {
    return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
  }

  // è®°å½•è¡Œä¸ºäº‹ä»¶
  track(eventType, eventData) {
    const behavior = {
      eventType,
      eventData: {
        ...eventData,
        page: getCurrentPages()[getCurrentPages().length - 1]?.route,
        timestamp: Date.now()
      },
      sessionId: this.sessionId,
      timestamp: Date.now()
    }

    this.behaviorBuffer.push(behavior)

    // ç¼“å†²åŒºæ»¡æ—¶ç«‹å³ä¸Šä¼ 
    if (this.behaviorBuffer.length >= this.maxBufferSize) {
      this.uploadBehaviors()
    }
  }

  // æ‰¹é‡ä¸Šä¼ è¡Œä¸ºæ•°æ®
  async uploadBehaviors() {
    if (this.behaviorBuffer.length === 0) return

    const behaviors = [...this.behaviorBuffer]
    this.behaviorBuffer = []

    try {
      const token = wx.getStorageSync('userToken')

      const response = await wx.request({
        url: 'https://your-domain.com/api/v3/analytics/behaviors/batch',
        method: 'POST',
        header: {
          Authorization: `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        data: {
          behaviors,
          sessionId: this.sessionId
        }
      })

      console.log('è¡Œä¸ºæ•°æ®ä¸Šä¼ æˆåŠŸ:', response.data)
    } catch (error) {
      console.error('è¡Œä¸ºæ•°æ®ä¸Šä¼ å¤±è´¥:', error)
      // å¤±è´¥æ—¶é‡æ–°åŠ å…¥ç¼“å†²åŒº
      this.behaviorBuffer.unshift(...behaviors)
    }
  }

  // è‡ªåŠ¨ä¸Šä¼ å®šæ—¶å™¨
  startAutoUpload() {
    setInterval(() => {
      this.uploadBehaviors()
    }, this.uploadInterval)
  }
}

// å…¨å±€å®ä¾‹
const behaviorTracker = new BehaviorTracker()
export default behaviorTracker
```

#### **1.2 å…·ä½“è¡Œä¸ºé‡‡é›†å®ç°**

```javascript
// é¡µé¢è®¿é—®è·Ÿè¸ª
Page({
  onShow() {
    behaviorTracker.track('page_view', {
      page: this.route,
      params: this.options
    })
  },

  onHide() {
    behaviorTracker.track('page_leave', {
      page: this.route,
      duration: Date.now() - this.enterTime
    })
  }
})

// æŠ½å¥–è¡Œä¸ºè·Ÿè¸ª
function onLotteryDraw(campaignId) {
  behaviorTracker.track('lottery_draw', {
    campaignId,
    action: 'draw_attempt'
  })
}

// ç§¯åˆ†è¡Œä¸ºè·Ÿè¸ª
function onPointsEarn(points, source) {
  behaviorTracker.track('points_earned', {
    points,
    source,
    action: 'earn_points'
  })
}

// ç‚¹å‡»è¡Œä¸ºè·Ÿè¸ª
function trackClick(element, data = {}) {
  behaviorTracker.track('click', {
    element,
    ...data
  })
}
```

### 2. **ç”¨æˆ·ç”»åƒå±•ç¤ºç»„ä»¶**

#### **2.1 ç”¨æˆ·ç”»åƒé¡µé¢**

```javascript
// pages/user-profile/user-profile.js
Page({
  data: {
    userProfile: null,
    loading: true
  },

  async onLoad() {
    await this.loadUserProfile()
  },

  async loadUserProfile() {
    try {
      const userId = wx.getStorageSync('userId')
      const token = wx.getStorageSync('userToken')

      const response = await wx.request({
        url: `https://your-domain.com/api/v3/analytics/users/${userId}/profile`,
        method: 'GET',
        header: {
          Authorization: `Bearer ${token}`
        }
      })

      if (response.data.code === 0) {
        this.setData({
          userProfile: response.data.data,
          loading: false
        })
      }
    } catch (error) {
      console.error('ç”¨æˆ·ç”»åƒåŠ è½½å¤±è´¥:', error)
      this.setData({ loading: false })
    }
  }
})
```

#### **2.2 ç”¨æˆ·ç”»åƒæ˜¾ç¤ºæ¨¡æ¿**

```xml
<!-- pages/user-profile/user-profile.wxml -->
<view class="profile-container">
  <view wx:if="{{loading}}" class="loading">
    <text>æ­£åœ¨åˆ†ææ‚¨çš„è¡Œä¸ºç”»åƒ...</text>
  </view>

  <view wx:else class="profile-content">
    <!-- å‚ä¸åº¦è¯„åˆ† -->
    <view class="engagement-section">
      <text class="section-title">æ´»è·ƒåº¦è¯„åˆ†</text>
      <view class="score-display">
        <text class="score">{{userProfile.engagement_score}}</text>
        <text class="score-unit">åˆ†</text>
      </view>
    </view>

    <!-- è¡Œä¸ºåå¥½ -->
    <view class="preferences-section">
      <text class="section-title">æ‚¨çš„åå¥½</text>
      <view class="preference-tags">
        <text wx:for="{{userProfile.user_segments}}"
              wx:key="*this"
              class="tag">{{item}}</text>
      </view>
    </view>

    <!-- æ´»è·ƒæ¨¡å¼ -->
    <view class="activity-section">
      <text class="section-title">æ´»è·ƒæ—¶é—´</text>
      <text class="activity-info">
        æœ€å¸¸æ´»è·ƒæ—¶é—´ï¼š{{userProfile.activity_pattern.peak_hours}}
      </text>
    </view>
  </view>
</view>
```

### 3. **æ™ºèƒ½æ¨èå±•ç¤ºç»„ä»¶**

#### **3.1 æ¨èè·å–å’Œå±•ç¤º**

```javascript
// components/recommendations/recommendations.js
Component({
  data: {
    recommendations: [],
    loading: true
  },

  lifetimes: {
    attached() {
      this.loadRecommendations()
    }
  },

  methods: {
    async loadRecommendations() {
      try {
        const userId = wx.getStorageSync('userId')
        const token = wx.getStorageSync('userToken')

        const response = await wx.request({
          url: `https://your-domain.com/api/v3/analytics/users/${userId}/recommendations`,
          method: 'GET',
          header: {
            Authorization: `Bearer ${token}`
          },
          data: {
            type: 'all',
            limit: 10
          }
        })

        if (response.data.code === 0) {
          this.setData({
            recommendations: response.data.data,
            loading: false
          })

          // è®°å½•æ¨èå±•ç¤º
          this.recordRecommendationShown(response.data.data)
        }
      } catch (error) {
        console.error('æ¨èåŠ è½½å¤±è´¥:', error)
        this.setData({ loading: false })
      }
    },

    // è®°å½•æ¨èå±•ç¤º
    async recordRecommendationShown(recommendations) {
      const token = wx.getStorageSync('userToken')

      for (const rec of recommendations) {
        try {
          await wx.request({
            url: `https://your-domain.com/api/v3/analytics/recommendations/${rec.id}/shown`,
            method: 'POST',
            header: {
              Authorization: `Bearer ${token}`
            }
          })
        } catch (error) {
          console.error('æ¨èå±•ç¤ºè®°å½•å¤±è´¥:', error)
        }
      }
    },

    // å¤„ç†æ¨èç‚¹å‡»
    async onRecommendationClick(e) {
      const recId = e.currentTarget.dataset.recId
      const recType = e.currentTarget.dataset.recType

      // è®°å½•æ¨èç‚¹å‡»
      try {
        const token = wx.getStorageSync('userToken')
        await wx.request({
          url: `https://your-domain.com/api/v3/analytics/recommendations/${recId}/clicked`,
          method: 'POST',
          header: {
            Authorization: `Bearer ${token}`
          }
        })
      } catch (error) {
        console.error('æ¨èç‚¹å‡»è®°å½•å¤±è´¥:', error)
      }

      // æ‰§è¡Œæ¨èåŠ¨ä½œ
      this.executeRecommendation(recType, e.currentTarget.dataset)
    },

    executeRecommendation(type, data) {
      switch (type) {
        case 'lottery_campaign':
          // è·³è½¬åˆ°æŠ½å¥–é¡µé¢
          wx.navigateTo({
            url: `/pages/lottery/lottery?campaignId=${data.campaignId}`
          })
          break
        case 'points_task':
          // è·³è½¬åˆ°ç§¯åˆ†ä»»åŠ¡
          wx.navigateTo({
            url: `/pages/points/task?taskId=${data.taskId}`
          })
          break
        // å…¶ä»–æ¨èç±»å‹...
      }
    }
  }
})
```

### 4. **ç®¡ç†å‘˜æ•°æ®åˆ†æé¡µé¢**

#### **4.1 ç®¡ç†å‘˜ç»Ÿè®¡æ¦‚è§ˆ**

```javascript
// pages/admin/analytics/analytics.js
Page({
  data: {
    overview: null,
    timeRange: '7d',
    loading: true
  },

  async onLoad() {
    await this.loadAnalyticsOverview()
  },

  async loadAnalyticsOverview() {
    try {
      const token = wx.getStorageSync('adminToken')

      const response = await wx.request({
        url: 'https://your-domain.com/api/v3/analytics/admin/overview',
        method: 'GET',
        header: {
          Authorization: `Bearer ${token}`
        },
        data: {
          timeRange: this.data.timeRange
        }
      })

      if (response.data.code === 0) {
        this.setData({
          overview: response.data.data,
          loading: false
        })
      }
    } catch (error) {
      console.error('ç®¡ç†å‘˜ç»Ÿè®¡åŠ è½½å¤±è´¥:', error)
      this.setData({ loading: false })
    }
  },

  onTimeRangeChange(e) {
    this.setData({
      timeRange: e.detail.value,
      loading: true
    })
    this.loadAnalyticsOverview()
  }
})
```

---

## ğŸ”§ **æŠ€æœ¯é…ç½®è¦æ±‚**

### 1. **å¾®ä¿¡å°ç¨‹åºé…ç½®**

```javascript
// app.js - å…¨å±€é…ç½®
App({
  onLaunch() {
    // åˆå§‹åŒ–è¡Œä¸ºè·Ÿè¸ª
    const behaviorTracker = require('./utils/analytics.js')
    this.globalData.behaviorTracker = behaviorTracker
  },

  globalData: {
    apiBaseUrl: 'https://your-domain.com/api/v3',
    behaviorTracker: null
  }
})
```

### 2. **ç½‘ç»œè¯·æ±‚åŸŸåé…ç½®**

åœ¨å¾®ä¿¡å°ç¨‹åºåå°é…ç½®åˆæ³•åŸŸåï¼š

```
requeståˆæ³•åŸŸå: https://your-domain.com
```

### 3. **æƒé™å’Œè®¤è¯**

```javascript
// utils/auth.js - è®¤è¯å·¥å…·
const checkAuth = () => {
  const token = wx.getStorageSync('userToken')
  if (!token) {
    wx.redirectTo({
      url: '/pages/login/login'
    })
    return false
  }
  return true
}

const getAuthHeaders = () => {
  return {
    Authorization: `Bearer ${wx.getStorageSync('userToken')}`,
    'Content-Type': 'application/json'
  }
}

module.exports = {
  checkAuth,
  getAuthHeaders
}
```

---

## ğŸ“š **APIæ¥å£è¯¦ç»†è¯´æ˜**

### 1. **è¡Œä¸ºæ•°æ®ä¸ŠæŠ¥**

```http
POST /api/v3/analytics/behaviors/batch
Authorization: Bearer <token>
Content-Type: application/json

{
  "behaviors": [
    {
      "eventType": "page_view",
      "eventData": {
        "page": "/pages/lottery/lottery",
        "action": "view",
        "timestamp": 1692581234567
      },
      "sessionId": "session_1692581234567_abc123",
      "timestamp": 1692581234567
    }
  ],
  "sessionId": "session_1692581234567_abc123"
}
```

**æ”¯æŒçš„äº‹ä»¶ç±»å‹**:

- `page_view` - é¡µé¢è®¿é—®
- `click` - ç‚¹å‡»äº‹ä»¶
- `draw` - æŠ½å¥–è¡Œä¸º
- `earn_points` - ç§¯åˆ†è·å¾—
- `consume_points` - ç§¯åˆ†æ¶ˆè´¹
- `login` - ç”¨æˆ·ç™»å½•
- `logout` - ç”¨æˆ·é€€å‡º

### 2. **ç”¨æˆ·ç”»åƒæŸ¥è¯¢**

```http
GET /api/v3/analytics/users/{userId}/profile
Authorization: Bearer <token>

Response:
{
  "code": 0,
  "msg": "æŸ¥è¯¢æˆåŠŸ",
  "data": {
    "user_id": 123,
    "behavior_summary": {
      "total_sessions": 25,
      "avg_session_duration": 180,
      "total_page_views": 120
    },
    "preferences": {
      "lottery_preference": "high_value",
      "points_earning_style": "active"
    },
    "engagement_score": 85.5,
    "user_segments": ["high_value", "lottery_lover"]
  }
}
```

### 3. **æ™ºèƒ½æ¨èè·å–**

```http
GET /api/v3/analytics/users/{userId}/recommendations?type=all&limit=10
Authorization: Bearer <token>

Response:
{
  "code": 0,
  "msg": "æ¨èè·å–æˆåŠŸ",
  "data": [
    {
      "id": 1001,
      "rec_type": "lottery_campaign",
      "rec_items": [
        {
          "id": 123,
          "type": "lottery",
          "score": 0.95,
          "title": "é«˜ä»·å€¼æŠ½å¥–æ´»åŠ¨"
        }
      ],
      "rec_reason": "åŸºäºæ‚¨çš„æŠ½å¥–åå¥½æ¨è"
    }
  ]
}
```

---

## ğŸ”’ **å®‰å…¨æ³¨æ„äº‹é¡¹**

### 1. **æ•°æ®è„±æ•**

- å‰ç«¯ä¸ä¼ è¾“æ•æ„Ÿç”¨æˆ·ä¿¡æ¯
- æ‰€æœ‰ä¸ªäººæ•°æ®åŠ å¯†ä¼ è¾“
- è®¾å¤‡ä¿¡æ¯è„±æ•å¤„ç†

### 2. **æƒé™æ§åˆ¶**

- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ç”»åƒæ•°æ®
- ç®¡ç†å‘˜æƒé™éªŒè¯
- APIè®¿é—®é¢‘ç‡é™åˆ¶

### 3. **æ•°æ®ä¿æŠ¤**

- è¡Œä¸ºæ•°æ®æœ¬åœ°ç¼“å­˜åŠ å¯†
- ç½‘ç»œä¼ è¾“HTTPS
- ç”¨æˆ·å¯åˆ é™¤è¡Œä¸ºæ•°æ®

---

## ğŸ§ª **æµ‹è¯•éªŒè¯**

### 1. **åŠŸèƒ½æµ‹è¯•æ¸…å•**

- [ ] è¡Œä¸ºæ•°æ®é‡‡é›†å’Œä¸ŠæŠ¥
- [ ] ç”¨æˆ·ç”»åƒå±•ç¤º
- [ ] æ™ºèƒ½æ¨èæ˜¾ç¤ºå’Œäº¤äº’
- [ ] ç®¡ç†å‘˜ç»Ÿè®¡æŸ¥çœ‹
- [ ] è®¤è¯å’Œæƒé™éªŒè¯

### 2. **æµ‹è¯•ç¯å¢ƒé…ç½®**

```javascript
// æµ‹è¯•é…ç½®
const config = {
  development: {
    apiBaseUrl: 'http://localhost:3000/api/v3',
    enableDebug: true
  },
  production: {
    apiBaseUrl: 'https://your-domain.com/api/v3',
    enableDebug: false
  }
}
```

---

## ğŸ“ **æŠ€æœ¯æ”¯æŒ**

### **åç«¯APIçŠ¶æ€**

- å¥åº·æ£€æŸ¥: `GET /api/v3/analytics/health`
- ç³»ç»ŸçŠ¶æ€: `GET /health`

### **å¸¸è§é—®é¢˜**

1. **Q: è¡Œä¸ºæ•°æ®ä¸ŠæŠ¥å¤±è´¥ï¼Ÿ**  
   A: æ£€æŸ¥tokenæœ‰æ•ˆæ€§å’Œç½‘ç»œè¿æ¥
2. **Q: ç”¨æˆ·ç”»åƒæ˜¾ç¤ºç©ºç™½ï¼Ÿ**  
   A: éœ€è¦ä¸€å®šçš„è¡Œä¸ºæ•°æ®ç§¯ç´¯ï¼Œé€šå¸¸éœ€è¦3-5å¤©
3. **Q: æ¨èå†…å®¹ä¸å‡†ç¡®ï¼Ÿ**  
   A: éšç€è¡Œä¸ºæ•°æ®å¢åŠ ä¼šé€æ­¥ä¼˜åŒ–

### **è”ç³»æ–¹å¼**

- åç«¯APIé—®é¢˜: æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
- æ•°æ®åº“é—®é¢˜: æ£€æŸ¥æ•°æ®è¡¨çŠ¶æ€
- æ€§èƒ½é—®é¢˜: ç›‘æ§ç³»ç»Ÿè´Ÿè½½

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025å¹´08æœˆ20æ—¥ 00:25:00 UTC  
**åç«¯å®ç°çŠ¶æ€**: âœ… å®Œå…¨å®ç°ï¼Œå¯ç«‹å³å¯¹æ¥  
**å‰ç«¯å¼€å‘ä¼°æ—¶**: 3-5ä¸ªå·¥ä½œæ—¥
