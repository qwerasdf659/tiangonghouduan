# 📊 前端行为数据采集对接文档

**版本**: v1.0  
**创建时间**: 2025年08月20日  
**后端API版本**: v3.0  
**技术栈**: 微信小程序前端 + Node.js后端

---

## 🎯 **概述**

用户行为检测系统后端已完全实现，现需要前端配合完成行为数据采集和展示功能。本文档提供完整的前端对接指南。

## 🔧 **后端已实现功能**

### ✅ **数据库表结构** (4/4完成)

- `analytics_behaviors` - 用户行为数据
- `analytics_user_profiles` - 用户画像分析
- `analytics_recommendations` - 智能推荐结果
- `analytics_realtime_stats` - 实时统计数据

### ✅ **API接口** (完全实现)

- **健康检查**: `GET /api/v3/analytics/health`
- **行为上报**: `POST /api/v3/analytics/behaviors/batch`
- **用户画像**: `GET /api/v3/analytics/users/:userId/profile`
- **智能推荐**: `GET /api/v3/analytics/users/:userId/recommendations`
- **推荐反馈**: `POST /api/v3/analytics/recommendations/:id/shown|clicked`
- **管理员统计**: `GET /api/v3/analytics/admin/overview`

### ✅ **服务集成** (完全实现)

- JWT认证集成
- 权限控制集成
- 事件总线集成
- Redis缓存集成

---

## 📡 **前端需要实现的功能**

### 1. **行为数据采集SDK**

#### **1.1 基础采集配置**

```javascript
// utils/analytics.js - 行为采集工具类
class BehaviorTracker {
  constructor() {
    this.sessionId = this.generateSessionId()
    this.behaviorBuffer = []
    this.maxBufferSize = 50
    this.uploadInterval = 30000 // 30秒上传一次

    this.startAutoUpload()
  }

  // 生成会话ID
  generateSessionId() {
    return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
  }

  // 记录行为事件
  track(eventType, eventData) {
    const behavior = {
      eventType,
      eventData: {
        ...eventData,
        page: getCurrentPages()[getCurrentPages().length - 1]?.route,
        timestamp: Date.now()
      },
      sessionId: this.sessionId,
      timestamp: Date.now()
    }

    this.behaviorBuffer.push(behavior)

    // 缓冲区满时立即上传
    if (this.behaviorBuffer.length >= this.maxBufferSize) {
      this.uploadBehaviors()
    }
  }

  // 批量上传行为数据
  async uploadBehaviors() {
    if (this.behaviorBuffer.length === 0) return

    const behaviors = [...this.behaviorBuffer]
    this.behaviorBuffer = []

    try {
      const token = wx.getStorageSync('userToken')

      const response = await wx.request({
        url: 'https://your-domain.com/api/v3/analytics/behaviors/batch',
        method: 'POST',
        header: {
          Authorization: `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        data: {
          behaviors,
          sessionId: this.sessionId
        }
      })

      console.log('行为数据上传成功:', response.data)
    } catch (error) {
      console.error('行为数据上传失败:', error)
      // 失败时重新加入缓冲区
      this.behaviorBuffer.unshift(...behaviors)
    }
  }

  // 自动上传定时器
  startAutoUpload() {
    setInterval(() => {
      this.uploadBehaviors()
    }, this.uploadInterval)
  }
}

// 全局实例
const behaviorTracker = new BehaviorTracker()
export default behaviorTracker
```

#### **1.2 具体行为采集实现**

```javascript
// 页面访问跟踪
Page({
  onShow() {
    behaviorTracker.track('page_view', {
      page: this.route,
      params: this.options
    })
  },

  onHide() {
    behaviorTracker.track('page_leave', {
      page: this.route,
      duration: Date.now() - this.enterTime
    })
  }
})

// 抽奖行为跟踪
function onLotteryDraw(campaignId) {
  behaviorTracker.track('lottery_draw', {
    campaignId,
    action: 'draw_attempt'
  })
}

// 积分行为跟踪
function onPointsEarn(points, source) {
  behaviorTracker.track('points_earned', {
    points,
    source,
    action: 'earn_points'
  })
}

// 点击行为跟踪
function trackClick(element, data = {}) {
  behaviorTracker.track('click', {
    element,
    ...data
  })
}
```

### 2. **用户画像展示组件**

#### **2.1 用户画像页面**

```javascript
// pages/user-profile/user-profile.js
Page({
  data: {
    userProfile: null,
    loading: true
  },

  async onLoad() {
    await this.loadUserProfile()
  },

  async loadUserProfile() {
    try {
      const userId = wx.getStorageSync('userId')
      const token = wx.getStorageSync('userToken')

      const response = await wx.request({
        url: `https://your-domain.com/api/v3/analytics/users/${userId}/profile`,
        method: 'GET',
        header: {
          Authorization: `Bearer ${token}`
        }
      })

      if (response.data.code === 0) {
        this.setData({
          userProfile: response.data.data,
          loading: false
        })
      }
    } catch (error) {
      console.error('用户画像加载失败:', error)
      this.setData({ loading: false })
    }
  }
})
```

#### **2.2 用户画像显示模板**

```xml
<!-- pages/user-profile/user-profile.wxml -->
<view class="profile-container">
  <view wx:if="{{loading}}" class="loading">
    <text>正在分析您的行为画像...</text>
  </view>

  <view wx:else class="profile-content">
    <!-- 参与度评分 -->
    <view class="engagement-section">
      <text class="section-title">活跃度评分</text>
      <view class="score-display">
        <text class="score">{{userProfile.engagement_score}}</text>
        <text class="score-unit">分</text>
      </view>
    </view>

    <!-- 行为偏好 -->
    <view class="preferences-section">
      <text class="section-title">您的偏好</text>
      <view class="preference-tags">
        <text wx:for="{{userProfile.user_segments}}"
              wx:key="*this"
              class="tag">{{item}}</text>
      </view>
    </view>

    <!-- 活跃模式 -->
    <view class="activity-section">
      <text class="section-title">活跃时间</text>
      <text class="activity-info">
        最常活跃时间：{{userProfile.activity_pattern.peak_hours}}
      </text>
    </view>
  </view>
</view>
```

### 3. **智能推荐展示组件**

#### **3.1 推荐获取和展示**

```javascript
// components/recommendations/recommendations.js
Component({
  data: {
    recommendations: [],
    loading: true
  },

  lifetimes: {
    attached() {
      this.loadRecommendations()
    }
  },

  methods: {
    async loadRecommendations() {
      try {
        const userId = wx.getStorageSync('userId')
        const token = wx.getStorageSync('userToken')

        const response = await wx.request({
          url: `https://your-domain.com/api/v3/analytics/users/${userId}/recommendations`,
          method: 'GET',
          header: {
            Authorization: `Bearer ${token}`
          },
          data: {
            type: 'all',
            limit: 10
          }
        })

        if (response.data.code === 0) {
          this.setData({
            recommendations: response.data.data,
            loading: false
          })

          // 记录推荐展示
          this.recordRecommendationShown(response.data.data)
        }
      } catch (error) {
        console.error('推荐加载失败:', error)
        this.setData({ loading: false })
      }
    },

    // 记录推荐展示
    async recordRecommendationShown(recommendations) {
      const token = wx.getStorageSync('userToken')

      for (const rec of recommendations) {
        try {
          await wx.request({
            url: `https://your-domain.com/api/v3/analytics/recommendations/${rec.id}/shown`,
            method: 'POST',
            header: {
              Authorization: `Bearer ${token}`
            }
          })
        } catch (error) {
          console.error('推荐展示记录失败:', error)
        }
      }
    },

    // 处理推荐点击
    async onRecommendationClick(e) {
      const recId = e.currentTarget.dataset.recId
      const recType = e.currentTarget.dataset.recType

      // 记录推荐点击
      try {
        const token = wx.getStorageSync('userToken')
        await wx.request({
          url: `https://your-domain.com/api/v3/analytics/recommendations/${recId}/clicked`,
          method: 'POST',
          header: {
            Authorization: `Bearer ${token}`
          }
        })
      } catch (error) {
        console.error('推荐点击记录失败:', error)
      }

      // 执行推荐动作
      this.executeRecommendation(recType, e.currentTarget.dataset)
    },

    executeRecommendation(type, data) {
      switch (type) {
        case 'lottery_campaign':
          // 跳转到抽奖页面
          wx.navigateTo({
            url: `/pages/lottery/lottery?campaignId=${data.campaignId}`
          })
          break
        case 'points_task':
          // 跳转到积分任务
          wx.navigateTo({
            url: `/pages/points/task?taskId=${data.taskId}`
          })
          break
        // 其他推荐类型...
      }
    }
  }
})
```

### 4. **管理员数据分析页面**

#### **4.1 管理员统计概览**

```javascript
// pages/admin/analytics/analytics.js
Page({
  data: {
    overview: null,
    timeRange: '7d',
    loading: true
  },

  async onLoad() {
    await this.loadAnalyticsOverview()
  },

  async loadAnalyticsOverview() {
    try {
      const token = wx.getStorageSync('adminToken')

      const response = await wx.request({
        url: 'https://your-domain.com/api/v3/analytics/admin/overview',
        method: 'GET',
        header: {
          Authorization: `Bearer ${token}`
        },
        data: {
          timeRange: this.data.timeRange
        }
      })

      if (response.data.code === 0) {
        this.setData({
          overview: response.data.data,
          loading: false
        })
      }
    } catch (error) {
      console.error('管理员统计加载失败:', error)
      this.setData({ loading: false })
    }
  },

  onTimeRangeChange(e) {
    this.setData({
      timeRange: e.detail.value,
      loading: true
    })
    this.loadAnalyticsOverview()
  }
})
```

---

## 🔧 **技术配置要求**

### 1. **微信小程序配置**

```javascript
// app.js - 全局配置
App({
  onLaunch() {
    // 初始化行为跟踪
    const behaviorTracker = require('./utils/analytics.js')
    this.globalData.behaviorTracker = behaviorTracker
  },

  globalData: {
    apiBaseUrl: 'https://your-domain.com/api/v3',
    behaviorTracker: null
  }
})
```

### 2. **网络请求域名配置**

在微信小程序后台配置合法域名：

```
request合法域名: https://your-domain.com
```

### 3. **权限和认证**

```javascript
// utils/auth.js - 认证工具
const checkAuth = () => {
  const token = wx.getStorageSync('userToken')
  if (!token) {
    wx.redirectTo({
      url: '/pages/login/login'
    })
    return false
  }
  return true
}

const getAuthHeaders = () => {
  return {
    Authorization: `Bearer ${wx.getStorageSync('userToken')}`,
    'Content-Type': 'application/json'
  }
}

module.exports = {
  checkAuth,
  getAuthHeaders
}
```

---

## 📚 **API接口详细说明**

### 1. **行为数据上报**

```http
POST /api/v3/analytics/behaviors/batch
Authorization: Bearer <token>
Content-Type: application/json

{
  "behaviors": [
    {
      "eventType": "page_view",
      "eventData": {
        "page": "/pages/lottery/lottery",
        "action": "view",
        "timestamp": 1692581234567
      },
      "sessionId": "session_1692581234567_abc123",
      "timestamp": 1692581234567
    }
  ],
  "sessionId": "session_1692581234567_abc123"
}
```

**支持的事件类型**:

- `page_view` - 页面访问
- `click` - 点击事件
- `draw` - 抽奖行为
- `earn_points` - 积分获得
- `consume_points` - 积分消费
- `login` - 用户登录
- `logout` - 用户退出

### 2. **用户画像查询**

```http
GET /api/v3/analytics/users/{userId}/profile
Authorization: Bearer <token>

Response:
{
  "code": 0,
  "msg": "查询成功",
  "data": {
    "user_id": 123,
    "behavior_summary": {
      "total_sessions": 25,
      "avg_session_duration": 180,
      "total_page_views": 120
    },
    "preferences": {
      "lottery_preference": "high_value",
      "points_earning_style": "active"
    },
    "engagement_score": 85.5,
    "user_segments": ["high_value", "lottery_lover"]
  }
}
```

### 3. **智能推荐获取**

```http
GET /api/v3/analytics/users/{userId}/recommendations?type=all&limit=10
Authorization: Bearer <token>

Response:
{
  "code": 0,
  "msg": "推荐获取成功",
  "data": [
    {
      "id": 1001,
      "rec_type": "lottery_campaign",
      "rec_items": [
        {
          "id": 123,
          "type": "lottery",
          "score": 0.95,
          "title": "高价值抽奖活动"
        }
      ],
      "rec_reason": "基于您的抽奖偏好推荐"
    }
  ]
}
```

---

## 🔒 **安全注意事项**

### 1. **数据脱敏**

- 前端不传输敏感用户信息
- 所有个人数据加密传输
- 设备信息脱敏处理

### 2. **权限控制**

- 用户只能查看自己的画像数据
- 管理员权限验证
- API访问频率限制

### 3. **数据保护**

- 行为数据本地缓存加密
- 网络传输HTTPS
- 用户可删除行为数据

---

## 🧪 **测试验证**

### 1. **功能测试清单**

- [ ] 行为数据采集和上报
- [ ] 用户画像展示
- [ ] 智能推荐显示和交互
- [ ] 管理员统计查看
- [ ] 认证和权限验证

### 2. **测试环境配置**

```javascript
// 测试配置
const config = {
  development: {
    apiBaseUrl: 'http://localhost:3000/api/v3',
    enableDebug: true
  },
  production: {
    apiBaseUrl: 'https://your-domain.com/api/v3',
    enableDebug: false
  }
}
```

---

## 📞 **技术支持**

### **后端API状态**

- 健康检查: `GET /api/v3/analytics/health`
- 系统状态: `GET /health`

### **常见问题**

1. **Q: 行为数据上报失败？**  
   A: 检查token有效性和网络连接
2. **Q: 用户画像显示空白？**  
   A: 需要一定的行为数据积累，通常需要3-5天
3. **Q: 推荐内容不准确？**  
   A: 随着行为数据增加会逐步优化

### **联系方式**

- 后端API问题: 查看服务器日志
- 数据库问题: 检查数据表状态
- 性能问题: 监控系统负载

---

**文档版本**: v1.0  
**最后更新**: 2025年08月20日 00:25:00 UTC  
**后端实现状态**: ✅ 完全实现，可立即对接  
**前端开发估时**: 3-5个工作日
