# 后端数据库项目开发规则文档

## ⚠️ **开发前置要求**

### **规则理解强制要求**
- **必须先了解规则**: 开始完成任何要求前，必须先了解好所有设置的规则
- **规则层级覆盖**: 包括全局规则和项目规则的完整理解
- **严格遵守约束**: 不准违反设定的规则浪费Claude 4 Sonnet请求次数
- **规则优先级**: 所有开发工作必须在规则框架内进行

### **工作启动检查**
- [ ] 已完整阅读并理解全局规则
- [ ] 已完整阅读并理解项目规则  
- [ ] 已确认所有约束条件
- [ ] 准备在规则框架内开展工作

## 📋 项目基础配置

### **项目类型与职责**
- **项目性质**: 后端数据库项目，专注服务端开发
- **命名规范**: 数据库、API、后端、测试代码统一采用 `snake_case` 蛇形命名格式
- **职责边界**: 只负责后端和数据库相关工作，前端工作交由前端程序员处理
- **深度分析要求**: 必须对项目整体代码进行深入分析，基于现有技术路线完成要求

### **环境与平台**
- **操作系统**: Linux环境，使用Linux命令（非Windows PowerShell）
- **开发启动**: 使用 `npm run dev` (Nodemon) 启动开发环境
- **数据库操作**: 涉及数据库操作时使用 Sequelize-CLI
- **统一启动方式**: `npm run pm:start:pm2`，启动前检查状态
- **进程管理**: 项目有 `scripts/process-manager.sh` 统一管理工具

### **数据库配置**
- **统一数据库**: 所有环境(开发/测试/生产)连接唯一真实数据库 `restaurant_points_dev`
- **MySQL客户端**: 未安装MySQL客户端，需使用Node.js脚本检查数据库表结构
- **模型配置**: 模型索引文件直接读取环境变量(process.env)，验证脚本不使用config.json
- **Redis服务**: 需检查Redis是否正常启动运行
- **对象存储**: 项目集成sealos对象存储，需了解相关技术路线和配置

## 🔧 开发技术规范

### **版本与兼容性**
- **版本统一**: 所有测试方法采用V4版本
- **清除兼容**: 不采用兼容性方案，清除兼容性代码，只保留V4最新代码
- **索引管理**: 创建索引前检查现有索引，避免重复索引问题

### **环境变量管理**
- **安全保护**: `.env`文件有特殊安全保护机制，不使用Claude文件操作工具
- **修改方式**: 使用以下方式修改环境变量：
  1. 命令行工具修改
  2. 环境变量导出
  3. 配置管理脚本
- **加载检查**: 检查环境变量前先加载.env文件

### **代码质量标准**
- **完整质量检查**: 修改后运行完整项目质量检查
  - ESLint + ESLint插件生态(eslint-config-standard、eslint-plugin-import、eslint-plugin-node、eslint-plugin-promise)
  - Prettier代码格式化
  - Jest + SuperTest功能测试
  - Health Check健康状态检查
  - 确保项目正常运行

## 📊 数据与测试规范

### **数据使用要求**
- **禁止模拟数据**: 不准使用模拟数据、mock数据
- **真实数据**: 需要真实数据的地方进行标注，由用户填写
- **数据验证**: 基于真实数据验证，绝对禁止数据造假
- **测试账号**: 13612227930（既是用户也是管理员，可用于测试）
- **开发登录**: 开发阶段用户和管理员都可用123456验证码登录

### **测试编写规范**
- **业务导向**: 测试代码要与实际业务代码符合，不可硬编码测试数据
- **先查后写**: 生成测试代码前先查看实际具体业务代码
- **统一管理**: 使用统一测试管理模块进行测试
- **业务需求体现**: 测试是业务需求的体现，不应该为技术实现妥协
  - 测试通过后要思考：用户的问题真的解决了吗？
  - 当测试失败时：要能发现真正影响用户的问题
  - 谨慎执行"测试适配代码"，不要让测试适配错误的业务代码
- **数据驱动**: 采用"先验证，后假设"原则
  1. 查看数据库schema数据模型
  2. 了解字段映射关系
  3. 理解字段语义
  4. 再进行假设和开发

### **业务逻辑约束**
- **抽奖策略限制**: 只使用以下三种抽奖策略，删除其他策略代码：
  - 基础抽奖策略
  - 保底策略  
  - 管理策略

## 🏗️ 开发流程规范

### **文件创建前检查**
- **现有功能检查**: 创建新文件前必须检查现有功能和特定目录
- **优先扩展**: 优先扩展现有功能，避免增加技术债务
- **创建条件**: 新文件创建条件：
  - 现有文件确实不包含相关功能
  - 新功能与现有功能职责明确分离
  - 新文件有独特且不可合并的业务价值

### **脚本生成规范**
- **先查后写**: 创建生成脚本前先查看现有脚本功能
- **功能扩展**: 首先在已有脚本上增加功能
- **避免复杂**: 不增加技术债务和系统复杂度
- **jq限制**: jq命令不可用，需要替代方案

### **问题解决思路**
- **测试失败处理**: 先思考是模型错了还是测试期望错了
- **业务优先**: 让技术服务业务服务客户，真正符合业务需求
- **数据库迁移**: 需要时不要觉得麻烦，认真完成迁移
- **系统性思维**: 修复要覆盖整个调用链，不能局部修复
  - 不可习惯性地用"技术修复"思维解决问题
  - 要先问"什么是正确的业务标准"
  - 修复要覆盖整个调用链，确保端到端的完整性
  - 发现问题时要追根溯源，解决根本问题而非症状

## 📝 代码规范与标准

### **命名与术语统一**
- **用词一致**: 代码、测试、文档用词统一
- **业务语义**: 测试代码和业务语义一致
- **场景明确**: 状态字段、业务语义要弄清场景
- **术语分离**: 避免技术术语和业务术语混合

### **API接口标准**
- **RESTful规范**: API接口符合RESTful标准
- **团队约定**: 符合团队约定的API标准  
- **统一模式**: API设计模式统一采用ApiResponse
  - 所有API响应必须使用统一的ApiResponse格式
  - 统一业务状态模式和错误处理格式
  - 保证前后端接口一致性
- **业务契约**: API是业务契约，保持一致性和标准性
  - API是业务契约，应该保持一致性和标准性
  - 当发现不一致时，应该统一到正确标准，而不是适配错误实现
  - 基于实际业务需求而非工具建议做决策

### **测试验证重点**
- **业务价值**: 不只测试技术细节，要验证业务价值
- **用户关心**: 真正验证用户关心的功能
- **问题发现**: 测试失败时能发现真正影响用户的问题
- **多层验证策略**: 采用多种方式交叉验证，确保全面覆盖
  - **直接调用**: 直接调用业务逻辑方法进行单元测试
  - **API调用**: 通过HTTP接口进行集成测试
  - **完整集成**: 端到端的完整业务流程测试
  - **交叉验证**: 多种方式验证同一业务功能（字符串、数字、mobile字段等）

## 🔍 质量保证要求

### **深度理解要求**
- **全面分析**: 深度思考理解项目所有代码、文档和注释
- **破坏检查**: 注意修改过程中是否破坏项目原有功能
- **主体功能**: 检查主体功能文档要求的功能是否实现
- **隐藏问题**: 告知实现功能可能存在的隐藏问题

### **工作汇报要求**
- **文件汇报**: 工作结束后汇报修改、创建、删除的文件
- **清理要求**: 完成任务后删除临时文件、测试文件、无用md文件
- **引用移除**: 相关引用也要自行移除
- **根本原因分析**: 遇到任何问题都必须告知根本原因，不能只描述现象
  - 使用Linux命令时要说明选择理由
  - 问题排查要追根溯源，给出深层分析
  - 解决方案要基于根本原因制定

### **环境检查要求**
- **服务重启**: 代码修改后确认是否需要重启对应服务
- **配置加载**: 验证对应环境变量是否正确加载配置
- **项目运行**: 完成任务后检查项目是否正常运行，有问题及时修复

## 🎯 业务理解与实现

### **用户期望导向**
- **用户思维**: 思考用户期望什么，希望得到什么
- **团队统一**: 团队成员、产品经理、设计师、其他开发者要使用同一套业务术语
  - 状态字段、业务语义要弄清场景
  - 避免技术术语和业务术语混在一起
  - 代码、测试、文档用词统一
- **问题解决**: 思考修改测试还是修改实现哪个解决根本问题
  - 一定要思考修改测试、修改实现，哪个解决根本问题
  - 修改的业务问题是否可以解决，达到真正符合业务需求
- **业务符合**: 确保真正符合业务需求

### **数据模型理解**
- **字段语义**: 理解数据模型字段是业务标识符、自增主键还是其他
- **映射关系**: 确认字段映射关系
- **标识符**: 不要混淆业务标识和技术标识
- **数据驱动验证流程**: "先验证，后假设"的完整流程
  1. **查看数据库schema数据模型**: 理解表结构和字段定义
  2. **了解字段映射关系**: 确认字段间的关联和约束
  3. **理解字段语义**: 区分业务标识符vs自增主键vs其他类型
  4. **使用正确标识符**: 基于模型理解选择正确的查询字段
- **标准验证示例**: `13612227930` → 查看User数据模型 → 确认mobile字段映射 → 使用mobile字段查询
- **验证策略**: 基于真实数据而非假设进行验证

### **工具与展示**
- **流程图支持**: 已安装Markdown Preview Mermaid Support，可用精美流程图
- **ASCII艺术**: 可使用纯文本版环境架构图-ASCII艺术绘制
- **形象描述**: 使用流程图或ASCII艺术形象描述系统架构

## ⚠️ 重要约束与限制

### **严格遵守事项**
- **规则优先**: 严格遵守所有设定规则，不违反浪费Claude 4 Sonnet请求次数
- **数据真实**: 各种脚本输出的数据必须是工具生成的真实数据
  - 各种脚本得出来的数据不可以是预设的数据而是要工具生成的真实覆盖率
  - 要真实的数据，绝对禁止数据造假
  - 不准使用模拟数据，mock数据来敷衍
- **覆盖率真实**: 要真实的测试覆盖率数据，绝对禁止数据造假
- **基于现有**: 基于现有技术栈完成，不增加技术债务和维护负担

### **工作原则**
- **专注后端**: 专注解决后端数据库实际业务问题
- **系统性解决**: 创建对应管理模块系统性解决问题
- **技术服务业务**: 技术服务于业务，业务服务于客户
- **实际需求**: 基于实际业务需求而非工具建议做决策

---

## 📋 执行检查清单

### 开发前检查
- [ ] 理解项目整体技术路线和代码架构
- [ ] 检查现有功能和相似模块
- [ ] 确认环境配置和数据库连接
- [ ] 验证Redis服务运行状态

### 开发过程检查  
- [ ] 遵循snake_case命名规范
- [ ] 使用真实数据，不用模拟数据
- [ ] 基于现有代码扩展，避免重复功能
- [ ] 保持代码、测试、文档术语统一

### 完成后检查
- [ ] 运行完整质量检查(ESLint+Prettier+Jest+SuperTest+Health)
- [ ] 验证项目正常运行
- [ ] 清理临时文件和无用代码
- [ ] 汇报修改的文件清单

---

**核心原则**: 深度理解项目 → 基于现有扩展 → 使用真实数据 → 服务业务需求 → 保证代码质量 