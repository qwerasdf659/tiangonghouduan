# ç”Ÿäº§è´¨é‡ä¿è¯è§„èŒƒï¼ˆProduction Quality Standardsï¼‰

> **ç‰ˆæœ¬**: v3.0ï¼ˆå®Œæ•´åˆå¹¶ç‰ˆï¼‰  
> **æœ€åæ›´æ–°**: 2025-12-18  
> **æ–‡æ¡£æ€§è´¨**: å¼ºåˆ¶å¼€å‘è§„èŒƒ + PRå®¡æŸ¥æ ‡å‡†  
> **å¯¹é½åŸåˆ™**: ä»…ä»¥**å½“å‰ä»“åº“ä»£ç çŠ¶æ€**ä¸ºå‡†ï¼ˆä¸å¼•ç”¨ä»»ä½•å†å²æŠ¥å‘Š/å…¶å®ƒæŠ¥å‘Š/å¤–éƒ¨æ–‡æ¡£ï¼‰  
> **é€‚ç”¨èŒƒå›´**: é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ V4.x æ‰€æœ‰æ–°å¢/é‡æ„ä»£ç   
> **æ‰§è¡Œè¦æ±‚**: æ‰€æœ‰ PR å¿…é¡»é€šè¿‡å¯¹åº”ç« èŠ‚çš„å®¡æŸ¥æ¸…å•

---

## ğŸ¯ æ–‡æ¡£å®šä½

æœ¬æ–‡æ¡£åŸºäº**å½“å‰ä»“åº“ä»£ç ç°çŠ¶**æ•´ç†å‡º**å¼ºåˆ¶å¼€å‘è§„èŒƒ**ï¼Œç”¨äºï¼š

- **é¢„é˜²**å·²çŸ¥é—®é¢˜æ¨¡å¼é‡å¤å‡ºç°
- **ç»Ÿä¸€**å›¢é˜Ÿå¼€å‘æ ‡å‡†å’Œæœ€ä½³å®è·µ
- **è§„èŒƒ** Code Review å®¡æŸ¥ä¾æ®
- **ç»Ÿä¸€**å›¢é˜Ÿå¼€å‘æ ‡å‡†å’Œæœ€ä½³å®è·µï¼ˆä¸å¼•ç”¨ä»»ä½•å¤–éƒ¨å¯¹æ ‡ææ–™ï¼‰

### æœ¯è¯­ç»Ÿä¸€ï¼šä»€ä¹ˆæ˜¯â€œåŒè½¨â€

æœ¬ä»“åº“ä¸­ï¼Œâ€œåŒè½¨â€æœ‰ä¸‰ç§å«ä¹‰ï¼Œå¿…é¡»ä¸¥æ ¼åŒºåˆ†ï¼š

- **å…è®¸ä¿ç•™ï¼šä¸šåŠ¡åŒè½¨ï¼ˆæ–°æ–¹æ¡ˆçš„ä¸€éƒ¨åˆ†ï¼‰**
  - ç¤ºä¾‹ï¼šèƒŒåŒ…æ¥å£ç»Ÿä¸€è¿”å› `assets[] + items[]`
  - è¿™æ˜¯äº§å“èƒ½åŠ›è®¾è®¡ï¼Œä¸å±äºâ€œå†å²å…¼å®¹â€
- **å…è®¸ä¿ç•™ï¼šå®¹ç¾åŒè½¨ï¼ˆæ–°æ–¹æ¡ˆçš„ä¸€éƒ¨åˆ†ï¼‰**
  - ç¤ºä¾‹ï¼šé™æµâ€œRedisæ»‘çª—ä¸»å®ç° + åå¤‡é™æµå®ç°â€å¹¶å­˜ï¼Œé€šè¿‡å¥åº·/skip å†³å®šå¯ç”¨å“ªæ¡é“¾è·¯
  - è¿™æ˜¯é«˜å¯ç”¨è®¾è®¡ï¼Œä¸å±äºâ€œå†å²å…¼å®¹â€
- **å¿…é¡»æ¸…é™¤ï¼šè¿ç§»/å…¼å®¹åŒè½¨ï¼ˆæ—§æ–¹æ¡ˆæ®‹ç•™ï¼‰**
  - ç¤ºä¾‹ï¼šåŒä¸€ä¸šåŠ¡åŒæ—¶è¯»å†™â€œæ—§è¡¨ + æ–°è¡¨â€ã€ä¿ç•™æ—§æ¥å£/æ—§Service åšå…¼å®¹
  - è¿™ä¸â€œåªä¿ç•™æ–°æ–¹æ¡ˆã€ä¸å…¼å®¹æ—§æ–¹æ¡ˆâ€çš„é‡æ„ç­–ç•¥å†²çªï¼Œå¿…é¡»ç§»é™¤

### ä¸å…¶ä»–æ–‡æ¡£/æŠ¥å‘Šçš„å…³ç³»ï¼ˆå¼ºåˆ¶ï¼‰

- **ç¦æ­¢å¼•ç”¨**ï¼šå†å²æŠ¥å‘Šã€å…¶å®ƒæŠ¥å‘Šã€å¤–éƒ¨æ–‡æ¡£ã€å¤–é“¾å¯¹æ ‡ææ–™
- **å”¯ä¸€å‡†ç»³**ï¼šæœ¬æ–‡æ¡£å®šä¹‰çš„å¥‘çº¦ + å½“å‰ä»£ç å®ç°ï¼ˆä»¥ä»“åº“ä¸ºçœŸç›¸æºï¼‰

---

## ğŸ“– ç›®å½•

1. [APIå“åº”å¥‘çº¦å¼ºåˆ¶æ ‡å‡†](#ä¸€apiå“åº”å¥‘çº¦å¼ºåˆ¶æ ‡å‡†)
2. [å¥åº·æ£€æŸ¥ä¸å¯è§‚æµ‹æ€§æ ‡å‡†](#äºŒå¥åº·æ£€æŸ¥ä¸å¯è§‚æµ‹æ€§æ ‡å‡†)
3. [é…ç½®ä¸ç¯å¢ƒå˜é‡å¼ºåˆ¶æ ‡å‡†](#ä¸‰é…ç½®ä¸ç¯å¢ƒå˜é‡å¼ºåˆ¶æ ‡å‡†)
4. [WebSocketå®‰å…¨å¼ºåˆ¶æ ‡å‡†](#å››websocketå®‰å…¨å¼ºåˆ¶æ ‡å‡†)
5. [æ•°æ®åº“è¿ç§»ä¸çœŸç›¸è¡¨ç®¡ç†](#äº”æ•°æ®åº“è¿ç§»ä¸çœŸç›¸è¡¨ç®¡ç†)
6. [äº‹åŠ¡å¹¶å‘ä¸å¹‚ç­‰æ€§æ ‡å‡†](#å…­äº‹åŠ¡å¹¶å‘ä¸å¹‚ç­‰æ€§æ ‡å‡†)
7. [æ€§èƒ½ä¼˜åŒ–å¼ºåˆ¶è¦æ±‚](#ä¸ƒæ€§èƒ½ä¼˜åŒ–å¼ºåˆ¶è¦æ±‚)
8. [æƒé™æ¨¡å‹ä¸ç¼“å­˜ä¸€è‡´æ€§](#å…«æƒé™æ¨¡å‹ä¸ç¼“å­˜ä¸€è‡´æ€§)
9. [è§„èŒƒæ‰§è¡Œä¼˜å…ˆçº§è¯´æ˜](#ä¹è§„èŒƒæ‰§è¡Œä¼˜å…ˆçº§è¯´æ˜)
10. [æ¼”è¿›è·¯çº¿å›¾ï¼ˆéå¼ºåˆ¶ï¼‰](#åæ¼”è¿›è·¯çº¿å›¾éå¼ºåˆ¶)
11. [é™„å½•](#é™„å½•)

---

## ä¸€ã€APIå“åº”å¥‘çº¦å¼ºåˆ¶æ ‡å‡†

### 1.1 ç»Ÿä¸€å“åº”æ ¼å¼è§„èŒƒï¼ˆå¼ºåˆ¶ - P0ï¼‰

#### å¼ºåˆ¶çº¦æŸ

æ‰€æœ‰ HTTP API å“åº”**å¿…é¡»**ä½¿ç”¨ä»¥ä¸‹æ ‡å‡†æ ¼å¼ï¼š

```javascript
{
  success: boolean,           // æˆåŠŸæ ‡è¯†ï¼ˆå¿…éœ€ï¼‰
  code: string,              // ä¸šåŠ¡ç ï¼ˆå¿…éœ€ï¼Œå­—ç¬¦ä¸²æ ¼å¼å¦‚ 'SUCCESS', 'NOT_FOUND'ï¼‰
  message: string,           // äººç±»å¯è¯»æ¶ˆæ¯ï¼ˆå¿…éœ€ï¼‰
  data: object | array | null, // ä¸šåŠ¡æ•°æ®ï¼ˆå¿…éœ€ï¼Œå¯ä¸º nullï¼‰
  timestamp: string,         // ISO8601 åŒ—äº¬æ—¶é—´æˆ³ï¼ˆå¿…éœ€ï¼‰
  version: string,           // APIç‰ˆæœ¬å·ï¼ˆå¿…éœ€ï¼‰
  request_id: string         // è¯·æ±‚è¿½è¸ªIDï¼ˆå¿…éœ€ï¼‰
}
```

#### ç¦æ­¢æ¨¡å¼

```javascript
// âŒ ç¦æ­¢ï¼šå¤šå¥—æ ¼å¼æ··ç”¨
{ code: 404, msg: '...' }           // é”™è¯¯ï¼šæ•°å­—code + msgå­—æ®µ
{ status: 'ok', result: {...} }     // é”™è¯¯ï¼šéæ ‡å‡†å­—æ®µ
{ error: '...' }                     // é”™è¯¯ï¼šä»…é”™è¯¯ä¿¡æ¯
{ success: false, code: 'NOT_FOUND', message: '...' }  // é”™è¯¯ï¼šç¼º version/request_id
```

#### æ ‡å‡†å®ç°

```javascript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ ApiResponse æ ‡å‡†æ–¹æ³•
class ApiResponse {
  static success(data, message = 'Success', code = 'SUCCESS') {
    return {
      success: true,
      code: code,
      message: message,
      data: data,
      timestamp: BeijingTimeHelper.apiTimestamp(),
      version: process.env.API_VERSION || 'v4'
    }
  }

  static error(message, errorCode = 'ERROR', details = null, httpStatus = 500) {
    return {
      success: false,
      code: errorCode,
      message: message,
      data: details,
      timestamp: BeijingTimeHelper.apiTimestamp(),
      version: process.env.API_VERSION || 'v4',
      httpStatus: httpStatus
    }
  }
}

// âœ… æ­£ç¡®ï¼š404 å¤„ç†å™¨ä½¿ç”¨æ ‡å‡†æ ¼å¼ï¼ˆåŒ…å«å®Œæ•´7å­—æ®µï¼‰
app.use('*', (req, res) => {
  return res.status(404).json({
    success: false,
    code: 'NOT_FOUND',
    message: `æ¥å£ä¸å­˜åœ¨: ${req.method} ${req.originalUrl}`,
    data: {
      availableEndpoints: ['/api/v4/lottery', '/api/v4/points', '/api/v4/health']
    },
    timestamp: BeijingTimeHelper.apiTimestamp(),
    version: 'v4.0', // âœ… å¿…éœ€å­—æ®µ
    request_id: req.id || generateRequestId() // âœ… å¿…éœ€å­—æ®µ
  })
})

// âœ… æ­£ç¡®ï¼šå…¨å±€é”™è¯¯å¤„ç†å™¨ä½¿ç”¨ ApiResponse æ ‡å‡†æ ¼å¼
app.use((err, req, res, next) => {
  logger.error('å…¨å±€é”™è¯¯', {
    error: err.message,
    stack: err.stack,
    request_id: req.id
  })

  const statusCode = err.statusCode || err.status || 500
  const errorCode = err.code || 'INTERNAL_ERROR'

  // âœ… ä½¿ç”¨ ApiResponse.error() ç”Ÿæˆæ ‡å‡†æ ¼å¼
  const errorResponse = ApiResponse.error(
    err.message || 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
    errorCode,
    process.env.NODE_ENV === 'development' ? { stack: err.stack } : null,
    statusCode
  )

  // âœ… æ·»åŠ  request_idï¼ˆå¦‚æœ ApiResponse æ²¡æœ‰è‡ªåŠ¨æ·»åŠ ï¼‰
  errorResponse.request_id = req.id || generateRequestId()

  return res.status(statusCode).json(errorResponse)
})
```

#### æ˜ç¡®å…è®¸çš„ä¾‹å¤–åœºæ™¯

**ä¾‹å¤–1ï¼šäºŒè¿›åˆ¶æµå¯¼å‡ºæ¥å£**

```javascript
// âœ… å…è®¸ï¼šExcel/CSV/å›¾ç‰‡ç­‰äºŒè¿›åˆ¶æµ
router.get('/export/users', authenticateToken, async (req, res) => {
  // å¯¼å‡ºæ¥å£ï¼šè¿”å›äºŒè¿›åˆ¶æ–‡ä»¶æµï¼Œä¸ä½¿ç”¨ ApiResponse åŒ…è£…ï¼ˆè§„èŒƒå…è®¸çš„ç‰¹ä¾‹ï¼‰
  const buffer = await ExportService.generateUserExcel()
  res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
  res.setHeader('Content-Disposition', 'attachment; filename=users.xlsx')
  return res.send(buffer)
})
```

**ä¾‹å¤–2ï¼šåºŸå¼ƒæ¥å£ï¼ˆå·²ç¦ç”¨ï¼‰**

ä½ å½“å‰çš„é‡æ„ç­–ç•¥æ˜¯â€œ**ä¸å…¼å®¹æ—§æ–¹æ¡ˆ**â€ï¼Œå› æ­¤ï¼š

- âœ… å…è®¸ï¼šç›´æ¥åˆ é™¤æ—§æ¥å£ï¼ˆä¸å†æä¾› 410 å…¼å®¹å±‚ï¼‰
- âœ… å…è®¸ï¼šåœ¨ä»£ç ä»“åº“å†…æ–°å¢ `BREAKING_CHANGE.md` è¯´æ˜ï¼ˆä»…ä»“åº“å†…ï¼Œä¸å¼•ç”¨å¤–éƒ¨é“¾æ¥ï¼‰
- âŒ ç¦æ­¢ï¼šä¿ç•™æ—§æ¥å£å¹¶è¿”å› 410 ä½œä¸ºè¿‡æ¸¡æ–¹æ¡ˆ

#### å®¡æŸ¥æ¸…å•

åœ¨ Code Review æ—¶å¿…é¡»æ£€æŸ¥ï¼š

- [ ] æ‰€æœ‰ API å“åº”æ˜¯å¦åŒ…å«å…¨éƒ¨ 7 ä¸ªå¿…éœ€å­—æ®µï¼Ÿ
- [ ] 404 handler æ˜¯å¦ä½¿ç”¨æ ‡å‡†æ ¼å¼ï¼Ÿ
- [ ] å…¨å±€é”™è¯¯å¤„ç†å™¨æ˜¯å¦ä½¿ç”¨æ ‡å‡†æ ¼å¼ï¼Ÿ
- [ ] äºŒè¿›åˆ¶æµæ¥å£æ˜¯å¦åœ¨æ³¨é‡Šä¸­æ ‡æ³¨"è§„èŒƒå…è®¸çš„ç‰¹ä¾‹"ï¼Ÿ
- [ ] åºŸå¼ƒæ¥å£æ˜¯å¦æä¾›è¿ç§»å¼•å¯¼ä¿¡æ¯ï¼Ÿ

---

### 1.2 HTTPçŠ¶æ€ç ä¸ä¸šåŠ¡ç åˆ†ç¦»åŸåˆ™ï¼ˆå¼ºåˆ¶ - P0ï¼‰

#### è®¾è®¡åŸåˆ™

**å¼ºåˆ¶è§„åˆ™**ï¼š

- âœ… HTTP çŠ¶æ€ç ï¼šä»…ç”¨äºä¼ è¾“å±‚ï¼ˆ200/400/401/403/404/409/429/5xxï¼‰
- âœ… ä¸šåŠ¡ç ï¼ˆcode å­—æ®µï¼‰ï¼šç”¨äºä¸šåŠ¡é€»è¾‘åˆ†ç±»ï¼ˆå­—ç¬¦ä¸²æ ¼å¼ï¼‰
- âŒ ç¦æ­¢æŠŠ HTTP çŠ¶æ€ç æ•°å­—å¡è¿› `code` å­—æ®µï¼ˆå¦‚ `code: 404`ï¼‰

#### è¯´æ˜

æœ¬èŠ‚ä¸åšä»»ä½•å¤–éƒ¨å¯¹æ ‡ï¼›åªå®šä¹‰**æœ¬ä»“åº“å½“å‰ä»£ç å¿…é¡»éµå®ˆ**çš„ HTTP çŠ¶æ€ç ä¸ä¸šåŠ¡ç åˆ†ç¦»è§„åˆ™ã€‚

#### ç¦æ­¢æ¨¡å¼

```javascript
// âŒ ç¦æ­¢ï¼šä¸šåŠ¡ç ä½¿ç”¨æ•°å­—
ApiResponse.error('å‚æ•°é”™è¯¯', 40001, null, 400)  // é”™è¯¯ï¼šä¸šåŠ¡ç ç”¨æ•°å­—

// âŒ ç¦æ­¢ï¼šæŠŠHTTPçŠ¶æ€ç å¡è¿›codeå­—æ®µ
return res.json({
  code: 404,  // é”™è¯¯ï¼šcode åº”ä¸ºä¸šåŠ¡ç å­—ç¬¦ä¸²
  message: 'ç”¨æˆ·ä¸å­˜åœ¨'
})

// âŒ ç¦æ­¢ï¼šä½¿ç”¨æ— æ•ˆçš„HTTPçŠ¶æ€ç 
return res.status(4005).json({ ... })  // é”™è¯¯ï¼š4005 ä¸æ˜¯æœ‰æ•ˆHTTPçŠ¶æ€ç ï¼ˆåº”ä¸º405ï¼‰

// âŒ ç¦æ­¢ï¼šä¸šåŠ¡é”™è¯¯ä½¿ç”¨HTTP 200
return res.status(200).json({
  success: false,  // çŸ›ç›¾ï¼šä¸šåŠ¡å¤±è´¥å´ç”¨HTTP 200
  code: 'USER_NOT_FOUND',
  message: 'ç”¨æˆ·ä¸å­˜åœ¨'
})
```

#### æ ‡å‡†å®ç°

```javascript
// âœ… æ­£ç¡®ï¼šHTTPçŠ¶æ€ç ä¸ä¸šåŠ¡ç æ˜ç¡®åˆ†ç¦»
class ApiResponse {
  static badRequest(message = 'Bad Request', errorCode = 'BAD_REQUEST', details = null) {
    return this.error(message, errorCode, details, 400) // âœ… HTTP 400
  }

  static unauthorized(message = 'Unauthorized', errorCode = 'UNAUTHORIZED') {
    return this.error(message, errorCode, null, 401) // âœ… HTTP 401
  }

  static forbidden(message = 'Forbidden', errorCode = 'FORBIDDEN') {
    return this.error(message, errorCode, null, 403) // âœ… HTTP 403
  }

  static notFound(message = 'Not Found', errorCode = 'NOT_FOUND') {
    return this.error(message, errorCode, null, 404) // âœ… HTTP 404
  }

  static conflict(message = 'Conflict', errorCode = 'CONFLICT', details = null) {
    return this.error(message, errorCode, details, 409) // âœ… HTTP 409
  }
}

// âœ… æ­£ç¡®ï¼šè·¯ç”±ä¸­ä½¿ç”¨
router.post('/items/:id/use', authenticateToken, async (req, res) => {
  try {
    const result = await InventoryService.useItem(req.user.user_id, req.params.id)
    return res.apiSuccess(result, 'ç‰©å“ä½¿ç”¨æˆåŠŸ')
  } catch (error) {
    if (error.message.includes('æ— æƒé™')) {
      return res.apiError(error.message, 'FORBIDDEN', null, 403)
      // âœ… HTTP 403 + ä¸šåŠ¡ç  'FORBIDDEN'
    } else if (error.message.includes('çŠ¶æ€')) {
      return res.apiError(error.message, 'INVALID_STATE', null, 400)
      // âœ… HTTP 400 + ä¸šåŠ¡ç  'INVALID_STATE'
    }
    return res.apiInternalError(error)
  }
})
```

#### æ ‡å‡†HTTPçŠ¶æ€ç å¯¹ç…§è¡¨

| åœºæ™¯       | HTTPçŠ¶æ€ç  | ä¸šåŠ¡ç ç¤ºä¾‹                 | ä½¿ç”¨åœºæ™¯                   |
| ---------- | ---------- | -------------------------- | -------------------------- |
| å‚æ•°é”™è¯¯   | 400        | `INVALID_PARAMS`           | å¿…å¡«å‚æ•°ç¼ºå¤±ã€æ ¼å¼é”™è¯¯     |
| æœªç™»å½•     | 401        | `UNAUTHORIZED`             | JWTè¿‡æœŸã€æœªæºå¸¦token       |
| æ— æƒé™     | 403        | `FORBIDDEN`                | éç®¡ç†å‘˜è®¿é—®ç®¡ç†æ¥å£       |
| èµ„æºä¸å­˜åœ¨ | 404        | `USER_NOT_FOUND`           | æŸ¥è¯¢çš„ç”¨æˆ·/è®¢å•ä¸å­˜åœ¨      |
| æ–¹æ³•ä¸å…è®¸ | 405        | `METHOD_NOT_ALLOWED`       | GETè¯·æ±‚ä»…æ”¯æŒPOST          |
| å†²çª       | 409        | `IDEMPOTENCY_KEY_CONFLICT` | å¹‚ç­‰é”®å†²çªã€é‡å¤æäº¤       |
| é™æµ       | 429        | `RATE_LIMIT_EXCEEDED`      | è¶…è¿‡æ¥å£è°ƒç”¨é¢‘ç‡é™åˆ¶       |
| æœåŠ¡å™¨é”™è¯¯ | 500        | `INTERNAL_ERROR`           | æ•°æ®åº“æŸ¥è¯¢å¤±è´¥ã€æœªé¢„æœŸå¼‚å¸¸ |
| æœåŠ¡ä¸å¯ç”¨ | 503        | `SERVICE_UNAVAILABLE`      | ä¾èµ–æœåŠ¡é™çº§ã€ç»´æŠ¤ä¸­       |

#### å®¡æŸ¥æ¸…å•

- [ ] æ˜¯å¦æ‰€æœ‰é”™è¯¯å“åº”éƒ½ä½¿ç”¨æ ‡å‡† HTTP çŠ¶æ€ç ï¼ˆ200/400/401/403/404/409/429/500/503ï¼‰ï¼Ÿ
- [ ] ä¸šåŠ¡ç æ˜¯å¦å…¨éƒ¨ä½¿ç”¨å­—ç¬¦ä¸²æ ¼å¼ï¼ˆè€Œéæ•°å­—ï¼‰ï¼Ÿ
- [ ] æ˜¯å¦æœ‰è‡ªå®šä¹‰ HTTP çŠ¶æ€ç ï¼ˆå¦‚ 40001ï¼‰ï¼Ÿ
- [ ] é”™è¯¯å¤„ç†æ˜¯å¦æ­£ç¡®ä¼ é€’ 4 ä¸ªå‚æ•°ï¼ˆmessage, errorCode, details, httpStatusï¼‰ï¼Ÿ

---

### 1.3 è·¯ç”±å±‚ ApiResponse è°ƒç”¨è§„èŒƒï¼ˆå¼ºåˆ¶ - P1ï¼‰

#### res.apiError() æ ‡å‡†è°ƒç”¨æ–¹å¼

**å¼ºåˆ¶è§„åˆ™**ï¼ˆåŸºäºExpressä¼ ç»Ÿåšæ³•å’Œè¡Œä¸šå®è·µï¼‰ï¼š

- âœ… ä½¿ç”¨ä½ç½®å‚æ•°ï¼š`res.apiError(message, errorCode, details, httpStatus)`
- âœ… `httpStatus` å¿…é¡»æ˜¯ 100-599 çš„æœ‰æ•ˆHTTPçŠ¶æ€ç ï¼ˆæ•°å­—ç±»å‹ï¼‰
- âŒ ç¦æ­¢ä¼ å…¥ `Error` å¯¹è±¡ä½œä¸º `httpStatus` å‚æ•°ï¼ˆä¼šå¯¼è‡´æ¥å£å´©æºƒï¼‰

**è®¾è®¡ä¾æ®**ï¼š

- æœ¬é¡¹ç›®çº¦å®šï¼šå‚æ•°é¡ºåºå›ºå®šä¸º `res.apiError(message, errorCode, details, httpStatus)`ï¼ˆç¦æ­¢å˜ä½“ï¼‰
- å‚æ•°é¡ºåºç¬¦åˆç›´è§‰ï¼šæ¶ˆæ¯ â†’ é”™è¯¯ç  â†’ è¯¦æƒ… â†’ HTTPçŠ¶æ€
- é¿å…ç ´åæ€§é‡æ„ï¼ˆé¡¹ç›®å·²æœ‰å¤§é‡è°ƒç”¨ï¼‰

#### æ­£ç¡®ç¤ºä¾‹

```javascript
// âœ… æ­£ç¡®ï¼šä½ç½®å‚æ•°ï¼ŒæŒ‰é¡ºåºä¼ é€’
try {
  const user = await UserService.getUser(userId)
  return res.apiSuccess(user, 'è·å–ç”¨æˆ·æˆåŠŸ')
} catch (error) {
  logger.error('è·å–ç”¨æˆ·å¤±è´¥', {
    error: error.message,
    user_id: userId,
    request_id: req.id
  })

  // âœ… æ­£ç¡®ï¼šä½ç½®å‚æ•°ï¼ˆmessage, errorCode, details, httpStatusï¼‰
  return res.apiError('è·å–ç”¨æˆ·å¤±è´¥', 'FETCH_USER_FAILED', { error: error.message }, 500)
}
```

#### ç¦æ­¢æ¨¡å¼

```javascript
// âŒ ç¦æ­¢ï¼šæŠŠ Error å¯¹è±¡ä¼ ç»™ httpStatusï¼ˆä¼šå¯¼è‡´ TypeErrorï¼‰
catch (error) {
  return res.apiError('æ“ä½œå¤±è´¥', 'OPERATION_FAILED', null, error)
  //                                                          ^^^^^ é”™è¯¯ï¼šä¼ å…¥äº† Error å¯¹è±¡
}

// âŒ ç¦æ­¢ï¼šå‚æ•°é¡ºåºé”™è¯¯
return res.apiError(500, 'OPERATION_FAILED', 'æ“ä½œå¤±è´¥', null)
//                  ^^^  ^^^^^^^^^^^^^^^^^^  ^^^^^^^^  ^^^^
//                  é”™è¯¯ï¼šhttpStatus ä¸åº”è¯¥åœ¨ç¬¬1ä½

// âŒ ç¦æ­¢ï¼šä½¿ç”¨æ— æ•ˆçš„HTTPçŠ¶æ€ç 
return res.apiError('æ“ä½œå¤±è´¥', 'OPERATION_FAILED', null, 999)
//                                                        ^^^ é”™è¯¯ï¼š999 ä¸æ˜¯æœ‰æ•ˆHTTPçŠ¶æ€ç 
```

#### æ ‡å‡†è°ƒç”¨æ¨¡å¼

```javascript
// âœ… æ¨¡å¼1ï¼šç®€å•é”™è¯¯ï¼ˆä½¿ç”¨é»˜è®¤ httpStatusï¼‰
return res.apiError('å‚æ•°é”™è¯¯', 'INVALID_PARAMS')
// ç­‰ä»·äºï¼šres.apiError('å‚æ•°é”™è¯¯', 'INVALID_PARAMS', null, 400)

// âœ… æ¨¡å¼2ï¼šå¸¦è¯¦æƒ…çš„é”™è¯¯
return res.apiError('ç”¨æˆ·ä¸å­˜åœ¨', 'USER_NOT_FOUND', { user_id: userId }, 404)

// âœ… æ¨¡å¼3ï¼šå†…éƒ¨é”™è¯¯ï¼ˆå¸¦å †æ ˆï¼‰
return res.apiError(
  'æ•°æ®åº“æŸ¥è¯¢å¤±è´¥',
  'DATABASE_ERROR',
  process.env.NODE_ENV === 'development' ? { stack: error.stack } : null,
  500
)

// âœ… æ¨¡å¼4ï¼šä½¿ç”¨å¿«æ·æ–¹æ³•ï¼ˆæ¨èï¼‰
return res.apiBadRequest('å‚æ•°é”™è¯¯') // è‡ªåŠ¨è®¾ç½® 400
return res.apiUnauthorized('æœªç™»å½•') // è‡ªåŠ¨è®¾ç½® 401
return res.apiForbidden('æƒé™ä¸è¶³') // è‡ªåŠ¨è®¾ç½® 403
return res.apiNotFound('èµ„æºä¸å­˜åœ¨') // è‡ªåŠ¨è®¾ç½® 404
return res.apiInternalError('æœåŠ¡å™¨é”™è¯¯') // è‡ªåŠ¨è®¾ç½® 500
```

#### å®¡æŸ¥æ¸…å•

- [ ] æ˜¯å¦æ‰€æœ‰ API å“åº”éƒ½ä½¿ç”¨ `res.apiSuccess/apiError/apiInternalError`ï¼Ÿ
- [ ] å‚æ•°é¡ºåºæ˜¯å¦æ­£ç¡®ï¼ˆmessage, errorCode, details, httpStatusï¼‰ï¼Ÿ
- [ ] æ˜¯å¦æœ‰ç›´æ¥ä½¿ç”¨ `res.json()` çš„æƒ…å†µï¼ˆé™¤ç‰¹ä¾‹å¤–ï¼‰ï¼Ÿ
- [ ] `httpStatus` æ˜¯å¦ä¸ºæœ‰æ•ˆçš„HTTPçŠ¶æ€ç ï¼ˆ100-599ï¼‰ï¼Ÿ
- [ ] æ˜¯å¦é¿å…ä¼ å…¥ `Error` å¯¹è±¡ä½œä¸º `httpStatus`ï¼Ÿ
- [ ] æ˜¯å¦ä¼˜å…ˆä½¿ç”¨å¿«æ·æ–¹æ³•ï¼ˆ`apiBadRequest/apiUnauthorized` ç­‰ï¼‰ï¼Ÿ

---

## äºŒã€å¥åº·æ£€æŸ¥ä¸å¯è§‚æµ‹æ€§æ ‡å‡†

### 2.1 /health ç«¯ç‚¹çœŸå®æ£€æŸ¥ï¼ˆå¼ºåˆ¶ - P0ï¼‰

#### å¥åº·æ£€æŸ¥å®ç°è¦æ±‚

**å¼ºåˆ¶è§„åˆ™**ï¼š

- âœ… å¿…é¡»çœŸå®æ£€æŸ¥æ‰€æœ‰ä¾èµ–æœåŠ¡ï¼ˆDatabaseã€Redisã€å¤–éƒ¨APIç­‰ï¼‰
- âœ… é‡‡ç”¨ degraded æ¨¡å¼ï¼šä¾èµ–é™çº§æ—¶è¿”å› HTTP 200 ä½† `status: 'degraded'`
- âœ… å“åº”å¿…é¡»åŒ…å«å®Œæ•´7å­—æ®µï¼ˆsuccessã€codeã€messageã€dataã€timestampã€versionã€request_idï¼‰
- âŒ ç¦æ­¢å ä½å®ç°ï¼ˆå†™æ­» `redis: 'connected'`ï¼‰
- âŒ ç¦æ­¢ä¾èµ–é™çº§æ—¶è¿”å› HTTP 503ï¼ˆé¿å…æœåŠ¡è¢«è¯¯åˆ¤ä¸ºå®Œå…¨ä¸å¯ç”¨ï¼‰

#### è®¾è®¡ç†å¿µï¼ˆåˆ†å±‚åˆ¤å®šï¼‰

- **HTTP 200**ï¼šè¡¨ç¤º"æœåŠ¡æœ¬èº«å¯å“åº”"ï¼ˆæœåŠ¡å¯ç”¨æ€§å±‚ï¼‰
- **data.status='degraded'**ï¼šè¡¨ç¤º"ä¾èµ–æœ‰é—®é¢˜"ï¼ˆä¾èµ–å¥åº·å±‚ï¼‰
- **å¥½å¤„**ï¼šä¸ä¼šå› ä¸º Redis æŠ–åŠ¨æŠŠæ•´ä¸ª API åˆ¤æ­»ï¼ŒåŒæ—¶ç›‘æ§èƒ½ç²¾ç¡®è¯†åˆ«ä¾èµ–æ•…éšœ

#### ç¦æ­¢æ¨¡å¼

```javascript
// âŒ ç¦æ­¢ï¼šå ä½å®ç°ï¼ˆç¡¬ç¼–ç è¿”å›ï¼‰
app.get('/health', (req, res) => {
  res.json({ status: 'ok' }) // âŒ æœªçœŸå®æ£€æŸ¥ä¾èµ–
})

// âŒ ç¦æ­¢ï¼šå‡æ£€æŸ¥ï¼ˆä»…åˆ¤æ–­å˜é‡å­˜åœ¨ï¼‰
app.get('/health', (req, res) => {
  const dbHealthy = !!sequelize // âŒ ä»…åˆ¤æ–­å¯¹è±¡å­˜åœ¨ï¼ŒæœªçœŸå®è¿æ¥
  const redisHealthy = !!redisClient // âŒ æœªè°ƒç”¨ ping æˆ–å®é™…æ“ä½œ
  res.json({ status: 'ok' })
})

// âŒ ç¦æ­¢ï¼šä¾èµ–é™çº§è¿”å› 503
app.get('/health', async (req, res) => {
  const redisHealthy = await checkRedis()

  if (!redisHealthy) {
    return res.status(503).json({
      // é”™è¯¯ï¼šRedisé™çº§ä¸åº”è¿”å›503
      status: 'unhealthy',
      message: 'Redisä¸å¯ç”¨'
    })
  }
  // ...
})
```

#### æ ‡å‡†å®ç°

```javascript
// âœ… æ­£ç¡®ï¼šçœŸå®æ£€æŸ¥æ‰€æœ‰ä¾èµ–æœåŠ¡
app.get('/health', async (req, res) => {
  const checks = {}

  // 1. çœŸå®æ£€æŸ¥æ•°æ®åº“è¿æ¥
  try {
    const startTime = Date.now()
    await sequelize.authenticate()
    const latency = Date.now() - startTime
    checks.database = { status: 'connected', latency: `${latency}ms` }
  } catch (error) {
    checks.database = { status: 'disconnected', error: error.message }
  }

  // 2. çœŸå®æ£€æŸ¥ Redis è¿æ¥
  try {
    const { isRedisHealthy } = require('./utils/UnifiedRedisClient')
    const redisHealthy = await isRedisHealthy()
    checks.redis = { status: redisHealthy ? 'connected' : 'disconnected' }
  } catch (error) {
    checks.redis = { status: 'disconnected', error: error.message }
  }

  // 3. è®¡ç®—æ•´ä½“çŠ¶æ€ï¼ˆdegraded æ¨¡å¼ï¼Œä¸è¿”å› 503ï¼‰
  const allHealthy = Object.values(checks).every(c => c.status === 'connected')
  const overallStatus = allHealthy ? 'healthy' : 'degraded'
  const healthCode = overallStatus === 'healthy' ? 'SYSTEM_HEALTHY' : 'SYSTEM_DEGRADED'

  // 4. å§‹ç»ˆè¿”å› HTTP 200ï¼ˆæœåŠ¡æœ¬èº«å¯å“åº”ï¼‰+ å®Œæ•´7å­—æ®µ
  return res.status(200).json({
    success: true,
    code: healthCode,
    message:
      overallStatus === 'healthy'
        ? 'V4 Unified Lottery Engine ç³»ç»Ÿè¿è¡Œæ­£å¸¸'
        : 'V4 Unified Lottery Engine ç³»ç»Ÿé™çº§è¿è¡Œï¼ˆéƒ¨åˆ†ä¾èµ–ä¸å¯ç”¨ï¼‰',
    data: {
      status: overallStatus, // healthy / degraded
      systems: {
        database: checks.database, // çœŸå®åæ˜ DBçŠ¶æ€
        redis: checks.redis, // çœŸå®åæ˜ RedisçŠ¶æ€
        nodejs: process.version
      },
      memory: {
        used: Math.round(process.memoryUsage().heapUsed / 1024 / 1024) + 'MB',
        total: Math.round(process.memoryUsage().heapTotal / 1024 / 1024) + 'MB'
      },
      uptime: Math.floor(process.uptime()) + 's'
    },
    timestamp: BeijingTimeHelper.apiTimestamp(), // âœ… é¡¶å±‚ timestampï¼ˆç›‘æ§æ ‡å‡†ï¼‰
    version: 'v4.0', // âœ… APIç‰ˆæœ¬
    request_id: req.id || generateRequestId() // âœ… è¯·æ±‚è¿½è¸ªID
  })
})
```

#### ç›‘æ§å‘Šè­¦é…ç½®å»ºè®®

```javascript
// ç›‘æ§ç³»ç»Ÿé…ç½®å‘Šè­¦è§„åˆ™ç¤ºä¾‹ï¼ˆPrometheus/Grafanaï¼‰
// è§„åˆ™1ï¼šä¾èµ–é™çº§å‘Šè­¦
alert: HealthDegraded
expr: health_status == "degraded"
for: 5m
labels:
  severity: warning
annotations:
  summary: "ç³»ç»Ÿè¿è¡Œåœ¨é™çº§æ¨¡å¼"
  description: "æ£€æŸ¥ data.systems.* å­—æ®µè¯†åˆ«å…·ä½“æ•…éšœä¾èµ–"

// è§„åˆ™2ï¼šRedisæ–­å¼€å‘Šè­¦
alert: RedisDisconnected
expr: health_redis_status == "disconnected"
for: 2m
labels:
  severity: critical
annotations:
  summary: "Redisè¿æ¥æ–­å¼€"
  description: "é™æµã€ä¼šè¯ç¼“å­˜ç­‰åŠŸèƒ½é™çº§"
```

#### è¯´æ˜

æœ¬èŠ‚ä¸åšä»»ä½•å¤–éƒ¨å¯¹æ ‡ï¼›åªå®šä¹‰**æœ¬ä»“åº“å½“å‰ä»£ç å¿…é¡»éµå®ˆ**çš„å¥åº·æ£€æŸ¥ä¸ degraded æ¨¡å¼è§„åˆ™ã€‚

#### å®¡æŸ¥æ¸…å•

- [ ] `/health` æ˜¯å¦è°ƒç”¨ `sequelize.authenticate()` çœŸå®æ£€æŸ¥æ•°æ®åº“ï¼Ÿ
- [ ] `/health` æ˜¯å¦è°ƒç”¨ `isRedisHealthy()` çœŸå®æ£€æŸ¥ Redisï¼Ÿ
- [ ] `degraded` çŠ¶æ€æ˜¯å¦è¿”å› HTTP 200ï¼ˆè€Œé 503ï¼‰ï¼Ÿ
- [ ] æ˜¯å¦è¿”å›å„ä¾èµ–çš„è¯¦ç»†çŠ¶æ€ï¼ˆè€Œéä»… "ok"ï¼‰ï¼Ÿ

---

### 2.2 ç»“æ„åŒ–æ—¥å¿—å¼ºåˆ¶æ ‡å‡†ï¼ˆå¼ºåˆ¶ - P1ï¼‰

#### æ—¥å¿—ç³»ç»Ÿè§„èŒƒ

**å¼ºåˆ¶è§„åˆ™**ï¼š

- âœ… ç¦æ­¢åœ¨æœåŠ¡ä»£ç ä¸­ä½¿ç”¨ `console.log/console.warn/console.error`
- âœ… å¿…é¡»ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—ï¼ˆåŒ…å« `request_id`ã€`user_id`ã€`operation` ç­‰å­—æ®µï¼‰
- âœ… æ‰€æœ‰æ—¥å¿—å¿…é¡»åŒ…å« `request_id` ç”¨äºé“¾è·¯è¿½è¸ª
- âœ… æ•æ„Ÿæ“ä½œå¿…é¡»è®°å½•å®¡è®¡æ—¥å¿—ï¼ˆé€šè¿‡ `AuditLogService`ï¼‰

#### ç¦æ­¢æ¨¡å¼

```javascript
// âŒ ç¦æ­¢ï¼šçº¯æ–‡æœ¬æ—¥å¿—ï¼ˆæ— ç»“æ„ã€æ—  request_idã€æ— æ³•æœç´¢ï¼‰
console.log('ç”¨æˆ·ç™»å½•æˆåŠŸ:', userId)
console.error('é”™è¯¯:', error)
console.warn('è­¦å‘Šï¼šåº“å­˜ä¸è¶³')

// âŒ ç¦æ­¢ï¼šæ—¥å¿—ç¼ºå°‘å…³é”®ä¸Šä¸‹æ–‡
logger.info('å¤„ç†è¯·æ±‚', { path: req.path }) // âŒ ç¼ºå°‘ request_id
```

#### æ ‡å‡†å®ç°

```javascript
// âœ… æ­£ç¡®ï¼šç»“æ„åŒ–æ—¥å¿— + request_id
const logger = require('./utils/logger')

// ä¸šåŠ¡æ—¥å¿—
logger.info('ç”¨æˆ·ç™»å½•æˆåŠŸ', {
  user_id: userId,
  ip: req.ip,
  request_id: req.id, // âœ… åŒ…å« request_id
  user_agent: req.headers['user-agent']
})

// é”™è¯¯æ—¥å¿—
logger.error('æ•°æ®åº“æŸ¥è¯¢å¤±è´¥', {
  error: error.message,
  stack: error.stack,
  query: query,
  request_id: req.id, // âœ… åŒ…å« request_id
  user_id: req.user?.user_id
})

// å®¡è®¡æ—¥å¿—ï¼ˆæ•æ„Ÿæ“ä½œï¼‰
await AuditLogService.log({
  operator_id: req.user.user_id,
  operation_type: 'update_user_role',
  target_type: 'user',
  target_id: targetUserId,
  operation_detail: {
    old_role: oldRole,
    new_role: newRole,
    reason: req.body.reason
  },
  ip: req.ip,
  request_id: req.id
})

// âœ… æ­£ç¡®ï¼šService å±‚æ–¹æ³•æ¥æ”¶ request_id
class UserService {
  static async createUser(userData, options = {}) {
    const { request_id } = options
    logger.info('åˆ›å»ºç”¨æˆ·', {
      request_id,
      user_data: userData
    })
    // ...
  }
}
```

#### æ˜ç¡®å…è®¸çš„ä¾‹å¤–åœºæ™¯

**ä¾‹å¤–ï¼šåº”ç”¨å¯åŠ¨é˜¶æ®µ**

```javascript
// âœ… å…è®¸ï¼šåº”ç”¨å¯åŠ¨é˜¶æ®µï¼ˆlogger åˆå§‹åŒ–å‰ï¼‰
if (process.env.NODE_ENV === 'development') {
  require('dotenv').config({ override: true })
  console.log('âš ï¸ [Development] ä½¿ç”¨ dotenv override æ¨¡å¼') // âœ… å¯åŠ¨é˜¶æ®µå…è®¸
} else {
  require('dotenv').config()
  console.log('âœ… [Production/Staging] ä½¿ç”¨å¹³å°æ³¨å…¥é…ç½®') // âœ… å¯åŠ¨é˜¶æ®µå…è®¸
}

// å¯åŠ¨å®Œæˆåï¼Œå¿…é¡»ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—
logger.info('åº”ç”¨å¯åŠ¨æˆåŠŸ', { port: PORT, env: NODE_ENV })
```

**ä¾‹å¤–åœºæ™¯æ€»ç»“**ï¼ˆä»…é™ä»¥ä¸‹æƒ…å†µå¯ä½¿ç”¨ console.\*ï¼‰ï¼š

1. åº”ç”¨å¯åŠ¨é˜¶æ®µï¼ˆlogger åˆå§‹åŒ–å‰ï¼‰
2. ç´§æ€¥é™çº§åœºæ™¯ï¼ˆlogger ä¸å¯ç”¨ï¼‰
3. å¼€å‘è°ƒè¯•ï¼ˆå¿…é¡»å¸¦æ˜ç¡®çš„ `[DEBUG]` å‰ç¼€ï¼Œä¸”æäº¤å‰åˆ é™¤ï¼‰

#### å®¡æŸ¥æ¸…å•

- [ ] æœåŠ¡ä»£ç æ˜¯å¦å­˜åœ¨ `console.log/warn/error`ï¼ˆå¯åŠ¨é˜¶æ®µé™¤å¤–ï¼‰ï¼Ÿ
- [ ] æ‰€æœ‰æ—¥å¿—æ˜¯å¦åŒ…å« `request_id` æˆ– `connection_id`ï¼Ÿ
- [ ] æ˜¯å¦ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—æ ¼å¼ï¼ˆJSON å¯¹è±¡ï¼Œè€Œéçº¯å­—ç¬¦ä¸²ï¼‰ï¼Ÿ
- [ ] Service å±‚æ–¹æ³•æ˜¯å¦æ¥æ”¶ `request_id` å‚æ•°ï¼Ÿ
- [ ] æ•æ„Ÿæ“ä½œæ˜¯å¦è®°å½•å®¡è®¡æ—¥å¿—ï¼Ÿ

---

### 2.3 request_id å…¨é“¾è·¯è¿½è¸ªï¼ˆå¼ºåˆ¶ - P1ï¼‰

#### å¼ºåˆ¶çº¦æŸ

æ‰€æœ‰æ—¥å¿—å’Œé”™è¯¯å“åº”**å¿…é¡»**åŒ…å« `request_id`ï¼Œå®ç°å…¨é“¾è·¯è¿½è¸ªã€‚

#### æ ‡å‡†å®ç°

```javascript
// âœ… æ­£ç¡®ï¼šåœ¨ä¸­é—´ä»¶ä¸­ç”Ÿæˆ request_id
app.use((req, res, next) => {
  req.id = req.headers['x-request-id'] || generateRequestId()
  res.setHeader('X-Request-ID', req.id)
  next()
})

// âœ… æ­£ç¡®ï¼šApiResponse è‡ªåŠ¨æ³¨å…¥ request_id
class ApiResponse {
  static middleware(req, res, next) {
    const requestId = req.id

    res.apiSuccess = (data, message, code) => {
      const response = this.success(data, message, code)
      response.request_id = requestId // âœ… è‡ªåŠ¨æ³¨å…¥
      return res.status(200).json(response)
    }

    res.apiError = (message, errorCode, details, httpStatus) => {
      const response = this.error(message, errorCode, details, httpStatus)
      response.request_id = requestId // âœ… è‡ªåŠ¨æ³¨å…¥
      return res.status(httpStatus || 500).json(response)
    }

    next()
  }
}

// âœ… æ­£ç¡®ï¼šService å±‚ä¼ é€’ request_id
router.post('/items/:id/use', authenticateToken, async (req, res) => {
  try {
    const result = await InventoryService.useItem(
      req.user.user_id,
      req.params.id,
      { request_id: req.id } // âœ… ä¼ é€’ request_id
    )
    return res.apiSuccess(result)
  } catch (error) {
    logger.error('ä½¿ç”¨ç‰©å“å¤±è´¥', {
      error: error.message,
      request_id: req.id // âœ… æ—¥å¿—åŒ…å« request_id
    })
    return res.apiInternalError(error)
  }
})
```

#### å®¡æŸ¥æ¸…å•

- [ ] æ˜¯å¦åœ¨ä¸­é—´ä»¶ä¸­ç”Ÿæˆå¹¶ä¼ é€’ `request_id`ï¼Ÿ
- [ ] æ‰€æœ‰ API å“åº”æ˜¯å¦åŒ…å« `request_id` å­—æ®µï¼Ÿ
- [ ] Service å±‚æ—¥å¿—æ˜¯å¦åŒ…å« `request_id`ï¼Ÿ
- [ ] é”™è¯¯æ—¥å¿—æ˜¯å¦åŒ…å« `request_id` ç”¨äºæ’éšœï¼Ÿ

---

## ä¸‰ã€é…ç½®ä¸ç¯å¢ƒå˜é‡å¼ºåˆ¶æ ‡å‡†

### 3.1 ç¯å¢ƒå˜é‡åŠ è½½ä¸¥æ ¼æ¨¡å¼ï¼ˆå¼ºåˆ¶ - P0ï¼‰

#### å¼ºåˆ¶çº¦æŸ

ç”Ÿäº§ç¯å¢ƒ**ç¦æ­¢**ä½¿ç”¨ `dotenv` çš„ `override` æ¨¡å¼ï¼Œ**ç¦æ­¢**ç»™ `NODE_ENV` è®¾ç½®ç¼ºçœå€¼ã€‚

#### ç¦æ­¢æ¨¡å¼

```javascript
// âŒ ç¦æ­¢ï¼šå…¨å±€ overrideï¼ˆä¼šè¦†ç›–ç”Ÿäº§é…ç½®ï¼‰
require('dotenv').config({ override: true })

// âŒ ç¦æ­¢ï¼šç»™ NODE_ENV ç¼ºçœå€¼ï¼ˆç”Ÿäº§æ¼é…ä¼šå½“å¼€å‘ç¯å¢ƒï¼‰
const env = process.env.NODE_ENV || 'development'
if (env === 'development') {
  require('dotenv').config({ override: true })
}
```

#### æ ‡å‡†å®ç°

```javascript
// âœ… æ­£ç¡®ï¼šä¸¥æ ¼æ¨¡å¼ï¼ˆä¸ç»™ç¼ºçœå€¼ï¼‰
if (process.env.NODE_ENV === 'development') {
  require('dotenv').config({ override: true })
  console.log('âš ï¸ [Development] ä½¿ç”¨ dotenv override æ¨¡å¼')
} else {
  require('dotenv').config()
  console.log('âœ… [Production/Staging] ä½¿ç”¨å¹³å°æ³¨å…¥é…ç½®ï¼Œç¦æ­¢ override')
}

// âœ… æ•ˆæœï¼šç”Ÿäº§ç¯å¢ƒæ¼é… NODE_ENV ä¼šèµ° else åˆ†æ”¯ï¼ˆå®‰å…¨ï¼‰
```

#### è¯´æ˜

æœ¬èŠ‚ä¸åšä»»ä½•å¤–éƒ¨å¯¹æ ‡ï¼›åªå®šä¹‰**æœ¬ä»“åº“å½“å‰ä»£ç å¿…é¡»éµå®ˆ**çš„é…ç½®åŠ è½½ä¸¥æ ¼æ¨¡å¼ã€‚

#### å®¡æŸ¥æ¸…å•

- [ ] æ˜¯å¦ä½¿ç”¨ `process.env.NODE_ENV === 'development'`ï¼ˆä¸ç»™ç¼ºçœå€¼ï¼‰ï¼Ÿ
- [ ] ç”Ÿäº§åˆ†æ”¯æ˜¯å¦ç¦ç”¨ `override: true`ï¼Ÿ
- [ ] æ˜¯å¦æœ‰æ˜ç¡®çš„ç¯å¢ƒåŒºåˆ†æ—¥å¿—ï¼Ÿ

---

### 3.2 é…ç½®æ ¡éªŒå¼ºåˆ¶æ‰§è¡Œï¼ˆå¼ºåˆ¶ - P1ï¼‰

#### å¼ºåˆ¶çº¦æŸ

åº”ç”¨å¯åŠ¨æ—¶**å¿…é¡»**æ ¡éªŒå¿…éœ€çš„ç¯å¢ƒå˜é‡ï¼Œç”Ÿäº§ç¯å¢ƒç¼ºå¤±é…ç½®**å¿…é¡»** fail-fastã€‚

#### ç¦æ­¢æ¨¡å¼

```javascript
// âŒ ç¦æ­¢ï¼šæ ¡éªŒå‡½æ•°å®šä¹‰ä½†ä¸æ‰§è¡Œ
function validateConfig() {
  const required = ['DB_HOST', 'DB_PORT', 'JWT_SECRET']
  const missing = required.filter(key => !process.env[key])
  if (missing.length > 0) {
    console.error('âŒ ç¼ºå°‘ç¯å¢ƒå˜é‡:', missing)
    process.exit(1)
  }
}
// âŒ å‡½æ•°å®šä¹‰äº†ï¼Œä½†æ²¡æœ‰è°ƒç”¨

// âŒ ç¦æ­¢ï¼šè·³è¿‡æ ¡éªŒ
// validateConfig()  // æ³¨é‡Šæ‰äº†
```

#### æ ‡å‡†å®ç°

```javascript
// âœ… æ­£ç¡®ï¼šå®šä¹‰æ ¡éªŒå‡½æ•°
function validateConfig() {
  const required = [
    'NODE_ENV',
    'PORT',
    'DB_HOST',
    'DB_PORT',
    'DB_NAME',
    'DB_USER',
    'DB_PASSWORD',
    'JWT_SECRET'
  ]

  const missing = required.filter(key => !process.env[key])

  if (missing.length > 0) {
    console.error('âŒ ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡:', missing)
    process.exit(1) // âœ… ç«‹å³é€€å‡º
  }

  // Redis é…ç½®å¯é€‰ï¼ˆé™çº§è¿è¡Œï¼‰
  const hasRedisConfig = process.env.REDIS_URL || process.env.REDIS_HOST
  if (!hasRedisConfig) {
    console.warn('âš ï¸ ç¼ºå°‘Redisé…ç½®: RedisåŠŸèƒ½å°†é™çº§è¿è¡Œ')
    console.warn('   å»ºè®®é…ç½®: REDIS_URL æˆ– REDIS_HOST')
  }

  // ç±»å‹æ ¡éªŒ
  if (isNaN(parseInt(process.env.PORT))) {
    console.error('âŒ PORT å¿…é¡»æ˜¯æœ‰æ•ˆçš„æ•°å­—')
    process.exit(1)
  }

  console.log(`âœ… ç¯å¢ƒé…ç½®éªŒè¯é€šè¿‡: ${getCurrentConfig().displayName}`)
}

// âœ… æ­£ç¡®ï¼šå¯åŠ¨æ—¶å¼ºåˆ¶è°ƒç”¨
const { validateConfig, isDevelopment } = require('./config/environment')

if (!isDevelopment()) {
  validateConfig() // âœ… staging/production å¼ºåˆ¶é€€å‡º
} else {
  try {
    validateConfig()
  } catch (error) {
    console.warn('âš ï¸ [Development] é…ç½®æ ¡éªŒå¤±è´¥ï¼ˆå·²å¿½ç•¥ï¼‰:', error.message)
  }
}
```

#### å®¡æŸ¥æ¸…å•

- [ ] æ˜¯å¦å®šä¹‰äº† `validateConfig()` å‡½æ•°ï¼Ÿ
- [ ] å¯åŠ¨æ—¶æ˜¯å¦å¼ºåˆ¶è°ƒç”¨ `validateConfig()`ï¼Ÿ
- [ ] ç”Ÿäº§ç¯å¢ƒæ˜¯å¦ fail-fastï¼ˆ`process.exit(1)`ï¼‰ï¼Ÿ
- [ ] æ˜¯å¦æ ¡éªŒäº†æ‰€æœ‰å¿…éœ€çš„ç¯å¢ƒå˜é‡ï¼Ÿ
- [ ] Redis ç­‰å¯é€‰é…ç½®æ˜¯å¦æ”¯æŒé™çº§è¿è¡Œï¼Ÿ

---

### 3.3 æ•°æ®åº“é…ç½®å»¶è¿Ÿæ ¡éªŒï¼ˆæ¨è - P1ï¼‰

#### é—®é¢˜è¯´æ˜

å¦‚æœæ•°æ®åº“é…ç½®åœ¨ `require` æ—¶ç«‹å³æ ¡éªŒï¼Œä¼šå¯¼è‡´å·¥å…·è„šæœ¬ï¼ˆå¦‚æ–‡æ¡£ç”Ÿæˆè„šæœ¬ï¼‰æ— æ³•è¿è¡Œã€‚

#### æ¨èæ–¹æ¡ˆ

**æ–¹æ¡ˆ1ï¼šå»¶è¿Ÿåˆ°å®é™…è¿æ¥æ—¶æ ¡éªŒ**

```javascript
// âœ… æ¨èï¼šå»¶è¿Ÿåˆ°è¿æ¥æ—¶æ ¡éªŒ
function validateDatabaseConfig() {
  const required = ['DB_HOST', 'DB_PORT', 'DB_USER', 'DB_PASSWORD', 'DB_NAME']
  const missing = required.filter(v => !process.env[v])
  if (missing.length > 0) {
    throw new Error(`ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡: ${missing.join(', ')}`)
  }
}

async function testConnection() {
  validateDatabaseConfig() // âœ… è¿æ¥æ—¶æ‰æ ¡éªŒ
  await sequelize.authenticate()
}

module.exports = { sequelize, testConnection }
```

**æ–¹æ¡ˆ2ï¼šæ·»åŠ è·³è¿‡æ ‡å¿—**

```javascript
// âœ… æ–¹æ¡ˆ2ï¼šå…è®¸è·³è¿‡æ ¡éªŒ
if (!process.env.SKIP_DB_VALIDATION) {
  validateDatabaseConfig()
}

// å·¥å…·è„šæœ¬ä¸­ä½¿ç”¨ï¼š
// SKIP_DB_VALIDATION=1 node scripts/generate-docs.js
```

#### ç¦æ­¢æ¨¡å¼

```javascript
// âŒ ç¦æ­¢ï¼šrequire æ—¶ç«‹å³æ ¡éªŒ
// config/database.js
validateDatabaseConfig() // é”™è¯¯ï¼šæ”¾åœ¨æ–‡ä»¶é¡¶å±‚ï¼Œrequire å³è§¦å‘
module.exports = { sequelize }

// å¯¼è‡´å·¥å…·è„šæœ¬å¤±è´¥
// node scripts/generate-docs.js
// Error: ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡: DB_HOST, DB_PORT...
```

#### å®¡æŸ¥æ¸…å•

- [ ] æ•°æ®åº“é…ç½®æ˜¯å¦åœ¨ `require` æ—¶ç«‹å³æ ¡éªŒï¼Ÿ
- [ ] æ˜¯å¦æä¾›è·³è¿‡æ ¡éªŒçš„æœºåˆ¶ï¼ˆç¯å¢ƒå˜é‡æˆ–å»¶è¿Ÿæ ¡éªŒï¼‰ï¼Ÿ
- [ ] å·¥å…·è„šæœ¬æ˜¯å¦å¯ä»¥æ­£å¸¸è¿è¡Œï¼Ÿ

---

## å››ã€WebSocketå®‰å…¨å¼ºåˆ¶æ ‡å‡†

### 4.1 æ¡æ‰‹é˜¶æ®µå¼ºåˆ¶JWTé‰´æƒï¼ˆå¼ºåˆ¶ - P0ï¼‰

#### å¼ºåˆ¶çº¦æŸ

WebSocket è¿æ¥**å¿…é¡»**åœ¨æ¡æ‰‹é˜¶æ®µéªŒè¯ JWTï¼Œ**ç¦æ­¢**æ— é‰´æƒè¿æ¥ã€‚

#### ç¦æ­¢æ¨¡å¼

```javascript
// âŒ ç¦æ­¢ï¼šæ— é‰´æƒç›´æ¥è¿æ¥
this.io.on('connection', socket => {
  // âŒ ç›´æ¥è¿æ¥ï¼Œæ— èº«ä»½éªŒè¯
  console.log('å®¢æˆ·ç«¯å·²è¿æ¥')
})

// âŒ ç¦æ­¢ï¼šåœ¨äº‹ä»¶ä¸­ä¼ é€’ tokenï¼ˆæ¡æ‰‹é˜¶æ®µå·²é”™è¿‡éªŒè¯æ—¶æœºï¼‰
socket.on('authenticate', (token) => {
  // é”™è¯¯ï¼šåº”è¯¥åœ¨æ¡æ‰‹é˜¶æ®µéªŒè¯ï¼Œè€Œéäº‹ä»¶ä¸­
  jwt.verify(token, ...)
})
```

#### æ ‡å‡†å®ç°

```javascript
// âœ… æ­£ç¡®ï¼šæ¡æ‰‹å¼ºåˆ¶ JWT éªŒè¯
const jwt = require('jsonwebtoken')

this.io.use((socket, next) => {
  const token = socket.handshake.auth?.token

  if (!token) {
    wsLogger.warn('WebSocketæ¡æ‰‹å¤±è´¥ï¼šç¼ºå°‘token', {
      socket_id: socket.id,
      ip: socket.handshake.address
    })
    return next(new Error('Authentication required: missing token'))
  }

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET)
    socket.user = decoded // âœ… æŒ‚è½½ç”¨æˆ·ä¿¡æ¯åˆ° socket

    wsLogger.info('WebSocketæ¡æ‰‹æˆåŠŸ', {
      user_id: decoded.user_id,
      role: decoded.role || decoded.is_admin,
      socket_id: socket.id
    })

    next()
  } catch (error) {
    wsLogger.warn('WebSocketæ¡æ‰‹å¤±è´¥ï¼štokenæ— æ•ˆ', {
      error: error.message,
      socket_id: socket.id
    })
    return next(new Error('Authentication failed: invalid token'))
  }
})
```

#### å®¢æˆ·ç«¯ç¤ºä¾‹

```javascript
// âœ… å®¢æˆ·ç«¯ï¼šæ¡æ‰‹æ—¶ä¼  JWT
import io from 'socket.io-client'

const token = localStorage.getItem('jwt_token')

const socket = io('<API_BASE_URL>', {
  auth: {
    token: token // âœ… åœ¨æ¡æ‰‹æ—¶ä¼ é€’ JWT
  }
})

socket.on('connect', () => {
  console.log('WebSocketè¿æ¥æˆåŠŸ')
})

socket.on('connect_error', error => {
  console.error('WebSocketè¿æ¥å¤±è´¥:', error.message)
  // å¯èƒ½åŸå› ï¼štoken è¿‡æœŸã€æ— æ•ˆã€æˆ–ç¼ºå¤±
})
```

#### å®¡æŸ¥æ¸…å•

- [ ] æ˜¯å¦åœ¨æ¡æ‰‹é˜¶æ®µï¼ˆ`io.use`ï¼‰éªŒè¯ JWTï¼Ÿ
- [ ] token ç¼ºå¤±æ˜¯å¦æ‹’ç»è¿æ¥ï¼Ÿ
- [ ] token æ— æ•ˆæ˜¯å¦æ‹’ç»è¿æ¥ï¼Ÿ
- [ ] æ˜¯å¦å°†ç”¨æˆ·ä¿¡æ¯æŒ‚è½½åˆ° `socket.user`ï¼Ÿ

---

### 4.2 æœåŠ¡ç«¯åˆ¤å®šèº«ä»½åŸåˆ™ï¼ˆå¼ºåˆ¶ - P0ï¼‰

#### å¼ºåˆ¶çº¦æŸ

ç”¨æˆ·èº«ä»½å’Œæƒé™**å¿…é¡»**ç”±æœåŠ¡ç«¯ä» JWT åˆ¤å®šï¼Œ**ç¦æ­¢**ä¿¡ä»»å®¢æˆ·ç«¯å£°æ˜ã€‚

#### ç¦æ­¢æ¨¡å¼

```javascript
// âŒ ç¦æ­¢ï¼šä¿¡ä»»å®¢æˆ·ç«¯å£°æ˜
socket.on('register_user', data => {
  const { user_id, user_type } = data // âŒ å®¢æˆ·ç«¯å¯ä¼ªé€ 

  if (user_type === 'admin') {
    this.connectedAdmins.set(user_id, socket.id) // âŒ å¯å†’å……ç®¡ç†å‘˜
  } else {
    this.connectedUsers.set(user_id, socket.id)
  }
})

// âŒ ç¦æ­¢ï¼šä»äº‹ä»¶å‚æ•°åˆ¤å®šèº«ä»½
socket.on('send_message', ({ from_user_id, is_admin, message }) => {
  // é”™è¯¯ï¼šä¸åº”ä¿¡ä»»å®¢æˆ·ç«¯ä¼ å…¥çš„ is_admin
  if (is_admin) {
    // æ‰§è¡Œç®¡ç†å‘˜æ“ä½œ...
  }
})
```

#### æ ‡å‡†å®ç°

```javascript
// âœ… æ­£ç¡®ï¼šæœåŠ¡ç«¯ä» JWT åˆ¤å®šèº«ä»½
this.io.on('connection', socket => {
  // ä» JWT è·å–èº«ä»½ï¼ˆæœåŠ¡ç«¯åˆ¤å®šï¼‰
  const userId = socket.user.user_id
  const isAdmin = socket.user.role === 'admin' || socket.user.is_admin === true

  // æ ¹æ®èº«ä»½æ³¨å†Œè¿æ¥
  if (isAdmin) {
    this.connectedAdmins.set(userId, socket.id)
    wsLogger.info('ç®¡ç†å‘˜å·²è¿æ¥', { user_id: userId, socket_id: socket.id })
  } else {
    this.connectedUsers.set(userId, socket.id)
    wsLogger.info('ç”¨æˆ·å·²è¿æ¥', { user_id: userId, socket_id: socket.id })
  }

  wsLogger.info('ç”¨æˆ·èº«ä»½å·²ç¡®å®š', {
    user_id: userId,
    is_admin: isAdmin,
    source: 'JWT' // âœ… æ ‡æ³¨èº«ä»½æ¥æº
  })

  // register_user é™çº§ä¸ºåå¥½å£°æ˜ï¼ˆå¯é€‰ï¼‰
  socket.on('register_user', data => {
    // âŒ ç¦æ­¢ï¼šå†³å®šèº«ä»½ã€å†™å…¥ connectedAdmins/connectedUsers
    // âœ… å…è®¸ï¼šå£°æ˜è®¢é˜…åå¥½ã€åŠ å…¥æˆ¿é—´ç­‰
    const { preferences, rooms } = data

    if (preferences) {
      socket.preferences = preferences
    }

    if (rooms) {
      rooms.forEach(room => socket.join(room))
    }

    // âŒ ç¦æ­¢ï¼šä¿®æ”¹èº«ä»½
    if (data.user_type) {
      wsLogger.warn('å°è¯•ä¿®æ”¹èº«ä»½è¢«æ‹’ç»', {
        user_id: socket.user.user_id,
        claimed_type: data.user_type
      })
    }
  })
})
```

#### å®¡æŸ¥æ¸…å•

- [ ] èº«ä»½æ˜¯å¦ä» `socket.user`ï¼ˆJWTï¼‰åˆ¤å®šï¼Ÿ
- [ ] æ˜¯å¦æœ‰ä»å®¢æˆ·ç«¯è¯»å– `user_type/is_admin` çš„é€»è¾‘ï¼Ÿ
- [ ] `register_user` äº‹ä»¶æ˜¯å¦åªå¤„ç†åå¥½ï¼ˆä¸ä¿®æ”¹èº«ä»½ï¼‰ï¼Ÿ

---

### 4.3 WebSocket CORS ç™½åå•ï¼ˆå¼ºåˆ¶ - P0ï¼‰

#### å¼ºåˆ¶çº¦æŸ

WebSocket **å¿…é¡»**ä½¿ç”¨ CORS ç™½åå•ï¼Œ**ç¦æ­¢** `origin: '*'`ã€‚

#### ç¦æ­¢æ¨¡å¼

```javascript
// âŒ ç¦æ­¢ï¼šå®Œå…¨å¼€æ”¾
this.io = socketIO(server, {
  cors: { origin: '*' } // âŒ ä»»æ„åŸŸåå¯è¿æ¥
})

// âŒ ç¦æ­¢ï¼šå†™æ­»åŸŸåï¼ˆä¸çµæ´»ï¼Œæ— æ³•é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ï¼‰
this.io = socketIO(server, {
  cors: {
    origin: ['<ADMIN_ORIGIN>', '<H5_ORIGIN>']
  }
})
```

#### æ ‡å‡†å®ç°

```javascript
// âœ… æ­£ç¡®ï¼šCORS ç™½åå•é…ç½®
const socketIO = require('socket.io')

const allowedOrigins = process.env.ALLOWED_ORIGINS
  ? process.env.ALLOWED_ORIGINS.split(',')
  : ['<LOCAL_DEV_ORIGIN_1>', '<LOCAL_DEV_ORIGIN_2>']

this.io = socketIO(server, {
  cors: {
    origin: (origin, callback) => {
      // å¾®ä¿¡å°ç¨‹åºåœºæ™¯ï¼šæ—  origin æˆ– servicewechat.com
      if (!origin || origin.includes('servicewechat.com') || origin.includes('weixin.qq.com')) {
        return callback(null, true)
      }

      // ç™½åå•æ£€æŸ¥
      if (allowedOrigins.includes(origin)) {
        return callback(null, true)
      }

      wsLogger.warn('WebSocketè¿æ¥è¢«CORSæ‹’ç»', { origin })
      callback(new Error('Not allowed by CORS'))
    },
    methods: ['GET', 'POST'],
    credentials: true
  },
  path: '/socket.io',
  transports: ['websocket', 'polling']
})
```

#### å®¡æŸ¥æ¸…å•

- [ ] æ˜¯å¦ä½¿ç”¨ç™½åå•ï¼ˆè€Œé `origin: '*'`ï¼‰ï¼Ÿ
- [ ] æ˜¯å¦æ”¯æŒå¾®ä¿¡å°ç¨‹åºåŸŸåï¼Ÿ
- [ ] æœªæˆæƒåŸŸåæ˜¯å¦è®°å½•æ—¥å¿—ï¼Ÿ
- [ ] æ˜¯å¦é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ç™½åå•ï¼Ÿ

---

## äº”ã€æ•°æ®åº“è¿ç§»ä¸çœŸç›¸è¡¨ç®¡ç†

### 5.1 åŒè½¨æ¶æ„ç¦æ­¢é•¿æœŸå­˜åœ¨ï¼ˆå¼ºåˆ¶ - P0ï¼‰

#### å¼ºåˆ¶çº¦æŸ

æ–°æ—§è¡¨å¹¶å­˜çš„åŒè½¨æ¶æ„**å¿…é¡»**è®¾ç½®æ˜ç¡®çš„è¿ç§»æˆªæ­¢æ—¥æœŸï¼Œ**ç¦æ­¢**æ— æœŸé™å¹¶å­˜ã€‚

> æ³¨æ„ï¼šæœ¬èŠ‚â€œç¦æ­¢â€çš„åŒè½¨ä»…æŒ‡ **è¿ç§»/å…¼å®¹åŒè½¨ï¼ˆæ—§è¡¨ + æ–°è¡¨å¹¶å­˜ï¼‰**ã€‚  
> ä¸åŒ…æ‹¬â€œä¸šåŠ¡åŒè½¨ï¼ˆassets + itemsï¼‰â€ä¸â€œå®¹ç¾åŒè½¨ï¼ˆä¸»é™æµ + åå¤‡é™æµï¼‰â€ï¼Œè¿™ä¸¤ç±»æ˜¯æ˜ç¡®è¦ä¿ç•™çš„æ–°æ–¹æ¡ˆèƒ½åŠ›ã€‚

#### ç¦æ­¢æ¨¡å¼

```javascript
// âŒ ç¦æ­¢ï¼šæ— æœŸé™çš„åŒè½¨é€»è¾‘
const [newItems, oldItems] = await Promise.all([
  ItemInstance.findAll({ where: { owner_user_id: userId } }),
  UserInventory.findAll({ where: { user_id: userId } }) // âŒ æ°¸ä¹…åŒè½¨
])
// åˆå¹¶æ•°æ®...
```

#### æ ‡å‡†å®ç°

```javascript
// âœ… æ­£ç¡®ï¼šè®¾ç½®è¿ç§»æˆªæ­¢æ—¥æœŸ
const MIGRATION_CUTOFF_DATE = new Date('2025-12-17')
const now = new Date()

if (now > MIGRATION_CUTOFF_DATE) {
  // æˆªæ­¢æ—¥æœŸåï¼šä»…ä½¿ç”¨æ–°è¡¨
  const items = await ItemInstance.findAll({
    where: { owner_user_id: userId }
  })
} else {
  // æˆªæ­¢æ—¥æœŸå‰ï¼šåŒè½¨è¯»å–ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
  const [newItems, oldItems] = await Promise.all([
    ItemInstance.findAll({ where: { owner_user_id: userId } }),
    UserInventory.findAll({ where: { user_id: userId } })
  ])
  // åˆå¹¶æ•°æ®...
}
```

#### å®¡æŸ¥æ¸…å•

- [ ] åŒè½¨æ¶æ„æ˜¯å¦è®¾ç½®äº† `MIGRATION_CUTOFF_DATE`ï¼Ÿ
- [ ] æˆªæ­¢æ—¥æœŸåæ˜¯å¦åˆ é™¤æ—§è¡¨æŸ¥è¯¢ä»£ç ï¼Ÿ
- [ ] æ˜¯å¦æœ‰è¿ç§»è¿›åº¦ç›‘æ§ï¼Ÿ

---

### 5.2 è¿ç§»åŒè½¨å¼ºåˆ¶æ¸…ç†ç­–ç•¥ï¼ˆå¼ºåˆ¶ - P0ï¼‰

#### æ‰§è¡Œå†³ç­–ï¼ˆ2025-12-19 ç¡®è®¤ï¼‰

**å†³ç­–1ï¼šæ—§åº“å­˜è·¯ç”±æ•´ä½“ä¸‹çº¿**

- âœ… **ä¸‹çº¿è·¯ç”±**ï¼š`/api/v4/inventory/*` æ•´ä½“ä¸å†æŒ‚è½½ï¼ˆä» `app.js` ä¸­ç§»é™¤ `app.use('/api/v4/inventory', ...)`ï¼‰
- âœ… **åŠŸèƒ½è¿ç§»**ï¼š
  - èƒŒåŒ…æŸ¥è¯¢ â†’ `/api/v4/backpack/user/:user_id`ï¼ˆå·²æœ‰ï¼Œ`BackpackService` è¿”å› `assets[] + items[]`ï¼‰
  - æ ¸é”€ç ç”Ÿæˆ/éªŒè¯ â†’ `/api/v4/redemption/*`ï¼ˆå·²æœ‰ï¼Œ`RedemptionOrderService`ï¼‰
  - å¸‚åœºæŒ‚ç‰Œ/è´­ä¹° â†’ `/api/v4/exchange_market/*`ï¼ˆå·²æœ‰ç‹¬ç«‹è·¯ç”±ï¼Œæˆ–éœ€é‡å»ºï¼‰
- âœ… **å‰ç«¯å¯¹é½**ï¼šé€šè¿‡ä»“åº“å†… `BREAKING_CHANGE.md` è¯´æ˜è·¯ç”±è¿ç§»æ˜ å°„è¡¨ï¼ˆä¸å¼•ç”¨å¤–éƒ¨æ–‡æ¡£ï¼‰
- âŒ **ç¦æ­¢ä¿ç•™**ï¼šä¸æä¾› 410 è¿‡æ¸¡å±‚ï¼Œä¸ä¿ç•™ä»»ä½•æ—§å‚æ•°å…¼å®¹é€»è¾‘

**å†³ç­–2ï¼šæ—§è¡¨å¼ºåˆ¶ DROP**

- âœ… **å½’æ¡£**ï¼šæ‰§è¡Œå‰å…ˆå¯¼å‡ºæ—§è¡¨æ•°æ®ï¼ˆ`mysqldump user_inventory user_asset_accounts > archive_old_tables_$(date +%Y%m%d).sql`ï¼‰
- âœ… **åˆ é™¤**ï¼š
  - `DROP TABLE user_inventory;`ï¼ˆåº“å­˜æ—§çœŸç›¸è¡¨ï¼‰
  - `DROP TABLE user_asset_accounts;`ï¼ˆèµ„äº§è´¦æˆ·æ—§è¡¨ï¼Œå·²è¿ç§»åˆ° `account_asset_balances`ï¼‰
  - æ¸…ç†å…³è”å¤–é”®ã€ç´¢å¼•ã€è§¦å‘å™¨ï¼ˆå¦‚æœ‰ï¼‰
- âœ… **éªŒè¯**ï¼šDROP å‰ç¡®è®¤æ— ä¸šåŠ¡ä»£ç å†å¼•ç”¨ï¼ˆé€šè¿‡ `grep` å’Œæµ‹è¯•éªŒè¯ï¼‰
- âŒ **ç¦æ­¢ä¿ç•™**ï¼šä¸è®¾ç½®"åªè¯»å†å²åº“"ã€ä¸ä¿ç•™æ—§è¡¨ç»“æ„

#### åŒè½¨æ®‹ç•™è¯†åˆ«æ¸…å•ï¼ˆå½“å‰ä»£ç å®é™…å­˜åœ¨ï¼‰

**ç±»å‹Aï¼šä»£ç å±‚åŒè¯»/åŒå†™/å…¼å®¹å›é€€**ï¼ˆå¿…é¡»åˆ é™¤ï¼‰

| ä½ç½®                                           | æ®‹ç•™ç‰¹å¾                                                                                 | åˆ é™¤æ“ä½œ                                                                                        |
| ---------------------------------------------- | ---------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------- |
| `services/InventoryService.js` ç¬¬ 97 è¡Œ        | `require('../models').UserInventory`                                                     | åˆ é™¤æ•´ä¸ª `InventoryService.js`ï¼Œæˆ–é‡å†™ä¸º"ä»…ä¾èµ– ItemInstance + MarketListing + AssetService"    |
| `services/InventoryService.js` ç¬¬ 2426-2464 è¡Œ | `withdrawMarketProduct()` å…ˆæŸ¥ `MarketListing`ï¼Œå¤±è´¥åå›é€€ `UserInventory.market_status` | åˆ é™¤ else åˆ†æ”¯ï¼ˆ2426-2464è¡Œå…¨éƒ¨åˆ é™¤ï¼‰                                                           |
| `services/InventoryService.js` ç¬¬ 2626-2647 è¡Œ | `getUserListingStats()` å¹¶è¡Œç»Ÿè®¡ `MarketListing + UserInventory.market_status`           | åˆ é™¤ `UserInventory` ç»Ÿè®¡åˆ†æ”¯ï¼ˆ2636-2647è¡Œï¼‰                                                    |
| `services/InventoryService.js` ç¬¬ 1878-1885 è¡Œ | `purchaseMarketProduct()` ä¸­ `MarketListing include UserInventory as offerItem`          | ä¿®æ­£ä¸º `include ItemInstance as offerItem`                                                      |
| `models/index.js` ç¬¬ 105-113 è¡Œ                | å¯¼å‡º `UserInventory` æ¨¡å‹å¹¶æ ‡æ³¨"å†å²å…¼å®¹ä¿ç•™"                                            | åˆ é™¤ `models.UserInventory = require(...)` åŠç›¸å…³æ³¨é‡Š                                           |
| `models/index.js` ç¬¬ 198-205 è¡Œ                | å¯¼å‡º `UserAssetAccount` æ¨¡å‹                                                             | åˆ é™¤ `models.UserAssetAccount = require(...)`                                                   |
| `services/index.js` æ— æ˜æ˜¾æ®‹ç•™                 | ServiceManager æœªæ³¨å†Œ `inventory` æœåŠ¡                                                   | ç¡®è®¤ä¸å†æ³¨å†Œï¼›è‹¥å‰ç«¯ä»éœ€"åº“å­˜"èƒ½åŠ›ï¼Œç”± `backpack` + `redemptionOrder` + æ–° marketplace æœåŠ¡æ‰¿æ¥ |

**ç±»å‹Bï¼šæ•°æ®åº“å±‚æ—§è¡¨/æ—§å­—æ®µ**ï¼ˆå¿…é¡» DROPï¼‰

| æ—§è¡¨/æ—§å­—æ®µ                             | æ–°çœŸç›¸è¡¨                                                     | åˆ é™¤æ“ä½œ                          |
| --------------------------------------- | ------------------------------------------------------------ | --------------------------------- |
| `user_inventory` è¡¨                     | `item_instances`ï¼ˆç‰©å“å®ä¾‹ï¼‰ + `redemption_orders`ï¼ˆæ ¸é”€ç ï¼‰ | `DROP TABLE user_inventory;`      |
| `user_asset_accounts` è¡¨                | `account_asset_balances`                                     | `DROP TABLE user_asset_accounts;` |
| `user_inventory.market_status` å­—æ®µ     | `market_listings.status`                                     | å½’æ¡£å DROP æ•´è¡¨æ—¶è‡ªåŠ¨åˆ é™¤        |
| `user_inventory.selling_points` å­—æ®µ    | `market_listings.price_amount`                               | å½’æ¡£å DROP æ•´è¡¨æ—¶è‡ªåŠ¨åˆ é™¤        |
| `user_inventory.verification_code` å­—æ®µ | `redemption_orders.code_hash`                                | å½’æ¡£å DROP æ•´è¡¨æ—¶è‡ªåŠ¨åˆ é™¤        |

**ç±»å‹Cï¼šè·¯ç”±å±‚æ—§å…¥å£**ï¼ˆå¿…é¡»ä¸‹çº¿ï¼‰

| æ—§è·¯ç”±å‰ç¼€                                 | æ–°è·¯ç”±æ›¿ä»£                                                         | åˆ é™¤æ“ä½œ                                                     |
| ------------------------------------------ | ------------------------------------------------------------------ | ------------------------------------------------------------ |
| `/api/v4/inventory/user/:user_id`          | `/api/v4/backpack/user/:user_id`                                   | `app.js` ä¸­åˆ é™¤ `app.use('/api/v4/inventory', ...)` æŒ‚è½½è¯­å¥ |
| `/api/v4/inventory/generate-code/:item_id` | `/api/v4/redemption/create`                                        | åŒä¸Šï¼ˆæ•´ä½“ä¸‹çº¿ï¼‰                                             |
| `/api/v4/inventory/verification/verify`    | `/api/v4/redemption/fulfill`                                       | åŒä¸Š                                                         |
| `/api/v4/inventory/market/list`            | é‡å»ºä¸º `/api/v4/marketplace/listings`ï¼ˆæˆ–ç”± exchange_market æ‰¿æ¥ï¼‰ | åŒä¸Š                                                         |
| `/api/v4/inventory/products`               | `/api/v4/exchange_market/items`                                    | å·²åºŸå¼ƒï¼ˆæ³¨é‡Šå·²è¯´æ˜ï¼‰                                         |

**ç±»å‹Dï¼šè¿ç§»è„šæœ¬/æµ‹è¯•å…¼å®¹ä»£ç **ï¼ˆå»ºè®®åˆ é™¤æˆ–å½’æ¡£ï¼‰

| æ–‡ä»¶                                                                    | æ€§è´¨         | å¤„ç†å»ºè®®                                          |
| ----------------------------------------------------------------------- | ------------ | ------------------------------------------------- |
| `scripts/reconcile-inventory-migration.js`                              | è¿ç§»æ ¡éªŒè„šæœ¬ | å½’æ¡£åˆ° `scripts/archived/`ï¼Œä¸å†æ‰§è¡Œ              |
| `scripts/migration/invalidate-old-codes.js`                             | æ—§ç å¤±æ•ˆè„šæœ¬ | å½’æ¡£åˆ° `scripts/archived/`                        |
| `scripts/migration/execute-midnight-migration.sh`                       | è¿ç§»æ‰§è¡Œè„šæœ¬ | å½’æ¡£åˆ° `scripts/archived/`                        |
| `migrations/20251215220102-migrate-user-inventory-to-item-instances.js` | æ•°æ®è¿ç§»æ–‡ä»¶ | ä¿ç•™ï¼ˆå†å²è®°å½•ï¼‰ï¼Œä½†æ³¨é‡Šè¯´æ˜"å·²å®Œæˆï¼Œæ—§è¡¨å·² DROP" |
| `tests/business/inventory/verification.test.js`                         | æ—§æ ¸é”€ç æµ‹è¯• | åˆ é™¤æˆ–é‡å†™ä¸ºæµ‹è¯•æ–°æ ¸é”€æµç¨‹                        |

#### æ‰§è¡Œé¡ºåºï¼ˆå››é˜¶æ®µï¼Œæ¯é˜¶æ®µå®ŒæˆåéªŒè¯ï¼‰

**é˜¶æ®µ1ï¼šä»£ç å±‚æ¸…ç†ï¼ˆé£é™©æœ€ä½ï¼Œå¯å¿«é€Ÿè¿­ä»£ï¼‰**

1. åˆ é™¤ `models/index.js` ä¸­çš„ `UserInventory`ã€`UserAssetAccount` å¯¼å‡º
2. åˆ é™¤ `services/InventoryService.js` æˆ–é‡å†™ä¸º"ä»…ä¾èµ–æ–°çœŸç›¸è¡¨"
3. åˆ é™¤ `app.js` ä¸­çš„ `/api/v4/inventory` è·¯ç”±æŒ‚è½½
4. åˆ é™¤ `routes/v4/unified-engine/inventory*.js`ï¼ˆæˆ–å½’æ¡£ï¼‰
5. è¿è¡Œæµ‹è¯•å¥—ä»¶ï¼Œä¿®å¤æ‰€æœ‰å› åˆ é™¤è€Œå¤±è´¥çš„æµ‹è¯•
6. æ¸…ç†æ‰€æœ‰ `require('./models/UserInventory')` å¼•ç”¨

**é˜¶æ®µ2ï¼šå‰ç«¯å¯¹é½ï¼ˆéœ€è¦å‰ç«¯é…åˆï¼‰**

1. åœ¨ä»“åº“æ ¹ç›®å½•åˆ›å»º `BREAKING_CHANGE.md`ï¼Œåˆ—å‡ºè·¯ç”±è¿ç§»æ˜ å°„è¡¨
2. å‰ç«¯ä¿®æ”¹æ‰€æœ‰è°ƒç”¨ç‚¹ï¼š
   - `GET /api/v4/inventory/user/:id` â†’ `GET /api/v4/backpack/user/:id`
   - `POST /api/v4/inventory/generate-code/:id` â†’ `POST /api/v4/redemption/create`ï¼ˆBody: `{item_instance_id}`ï¼‰
   - å…¶ä»–è·¯ç”±æŒ‰æ˜ å°„è¡¨é€ä¸€å¯¹é½
3. è”è°ƒéªŒè¯åŠŸèƒ½å®Œæ•´æ€§

**é˜¶æ®µ3ï¼šæ•°æ®åº“æ¸…ç†ï¼ˆéœ€è¦åœæœºçª—å£æˆ–ä¸»ä»åˆ‡æ¢ï¼‰**

1. **å‰ç½®éªŒè¯**ï¼ˆåªè¯»æ£€æŸ¥ï¼Œ0 é£é™©ï¼‰ï¼š
   ```sql
   -- ç¡®è®¤æ—§è¡¨æ— å†™å…¥ï¼ˆç›‘æ§æœ€è¿‘1å°æ—¶ï¼‰
   SELECT MAX(updated_at), COUNT(*) FROM user_inventory WHERE updated_at > NOW() - INTERVAL 1 HOUR;
   SELECT MAX(updated_at), COUNT(*) FROM user_asset_accounts WHERE updated_at > NOW() - INTERVAL 1 HOUR;
   ```
2. **å½’æ¡£å¤‡ä»½**ï¼ˆå¿…é¡»ï¼Œä¸å¯è·³è¿‡ï¼‰ï¼š
   ```bash
   mysqldump -u root -p restaurant_lottery \
     user_inventory user_asset_accounts \
     > backup/archive_old_tables_$(date +%Y%m%d_%H%M%S).sql
   ```
3. **åˆ é™¤å¤–é”®ä¾èµ–**ï¼ˆå¦‚æœ‰ï¼‰ï¼š

   ```sql
   -- æŸ¥æ‰¾å¼•ç”¨æ—§è¡¨çš„å¤–é”®
   SELECT TABLE_NAME, CONSTRAINT_NAME
   FROM information_schema.KEY_COLUMN_USAGE
   WHERE REFERENCED_TABLE_NAME IN ('user_inventory', 'user_asset_accounts');

   -- é€ä¸ªåˆ é™¤å¤–é”®ï¼ˆå¦‚æœ‰ï¼‰
   ALTER TABLE <table_name> DROP FOREIGN KEY <constraint_name>;
   ```

4. **DROP æ—§è¡¨**ï¼š
   ```sql
   DROP TABLE IF EXISTS user_inventory;
   DROP TABLE IF EXISTS user_asset_accounts;
   ```
5. **éªŒè¯æ–°è¡¨çº¦æŸå®Œæ•´æ€§**ï¼š
   ```sql
   -- éªŒè¯æ–°è¡¨çš„å¹‚ç­‰é”®çº¦æŸ
   SHOW INDEX FROM market_listings WHERE Key_name LIKE '%business_id%';
   SHOW INDEX FROM asset_transactions WHERE Key_name LIKE '%business%';
   SHOW INDEX FROM item_instances WHERE Key_name LIKE '%owner%';
   ```

**é˜¶æ®µ4ï¼šé˜²å›å½’æœºåˆ¶ï¼ˆCI/ä»£ç é—¨ç¦ï¼‰**

1. åˆ›å»º `scripts/validation/check-legacy-code.sh`ï¼š

   ```bash
   #!/bin/bash
   # æ£€æŸ¥æ—§ä»£ç æ®‹ç•™ï¼ˆCI é—¨ç¦ï¼‰

   echo "ğŸ” æ£€æŸ¥æ—§æ¨¡å‹å¼•ç”¨..."
   if grep -r "UserInventory\|user_inventory" --include="*.js" \
      --exclude-dir=node_modules \
      --exclude-dir=migrations \
      --exclude-dir=scripts/archived \
      --exclude="*.test.js" \
      services/ routes/ models/; then
     echo "âŒ å‘ç°æ—§æ¨¡å‹å¼•ç”¨ï¼Œè¯·ä½¿ç”¨æ–°çœŸç›¸è¡¨"
     exit 1
   fi

   echo "ğŸ” æ£€æŸ¥æ—§å­—æ®µå¼•ç”¨..."
   if grep -r "market_status\|selling_points\|verification_code" \
      --include="*.js" \
      --exclude-dir=node_modules \
      services/ routes/; then
     echo "âŒ å‘ç°æ—§å­—æ®µå¼•ç”¨ï¼Œè¯·ä½¿ç”¨æ–°æ¶æ„"
     exit 1
   fi

   echo "âœ… æ— æ—§ä»£ç æ®‹ç•™"
   ```

2. åŠ å…¥ CI pipelineï¼ˆ`.github/workflows/ci.yml` æˆ–ç±»ä¼¼ï¼‰

#### å®¡æŸ¥æ¸…å•

- [ ] ä»£ç å±‚æ˜¯å¦å·²åˆ é™¤æ‰€æœ‰æ—§æ¨¡å‹å¯¼å‡ºï¼Ÿ
- [ ] æ˜¯å¦å·²åˆ é™¤æ‰€æœ‰åŒè¯»/åŒå†™/å…¼å®¹å›é€€é€»è¾‘ï¼Ÿ
- [ ] æ—§è·¯ç”±æ˜¯å¦å·²ä» `app.js` ç§»é™¤æŒ‚è½½ï¼Ÿ
- [ ] æ•°æ®åº“æ˜¯å¦å·²å½’æ¡£å¹¶ DROP æ—§è¡¨ï¼Ÿ
- [ ] æ˜¯å¦å»ºç«‹äº†é˜²å›å½’æ£€æŸ¥è„šæœ¬ï¼Ÿ
- [ ] å‰ç«¯æ˜¯å¦å·²å®Œæˆè·¯ç”±è¿ç§»ï¼Ÿ

---

### 5.3 çœŸç›¸è¡¨å”¯ä¸€æ¥æºåŸåˆ™ï¼ˆå¼ºåˆ¶ - P0ï¼‰

#### å¼ºåˆ¶çº¦æŸ

æ¯ä¸ªä¸šåŠ¡é¢†åŸŸ**å¿…é¡»**åªæœ‰ä¸€ä¸ªçœŸç›¸è¡¨ï¼Œ**ç¦æ­¢**å¤šè¡¨è®°å½•ç›¸åŒä¸šåŠ¡çŠ¶æ€ã€‚

#### å½“å‰ä»“åº“çœŸç›¸è¡¨å®šä¹‰ï¼ˆä»¥ä»£ç ä¸ºå‡†ï¼‰

| ä¸šåŠ¡é¢†åŸŸ       | çœŸç›¸è¡¨                   | ä¸»é”®               | å”¯ä¸€çº¦æŸ                            | å¤‡æ³¨           |
| -------------- | ------------------------ | ------------------ | ----------------------------------- | -------------- |
| ç‰©å“å®ä¾‹æ‰€æœ‰æƒ | `item_instances`         | `item_instance_id` | `(owner_user_id, item_instance_id)` | ä¸å¯å åŠ ç‰©å“   |
| å¸‚åœºæŒ‚ç‰Œ       | `market_listings`        | `listing_id`       | `(seller_user_id, business_id)`     | ç‰©å“+èµ„äº§æŒ‚ç‰Œ  |
| æ ¸é”€ç          | `redemption_orders`      | `order_id` (UUID)  | `code_hash` (SHA-256)               | 12ä½Base32ç    |
| èµ„äº§ä½™é¢       | `account_asset_balances` | `balance_id`       | `(account_id, asset_code)`          | å¯å åŠ èµ„äº§ä½™é¢ |
| èµ„äº§æµæ°´       | `asset_transactions`     | `transaction_id`   | `(business_id, business_type)`      | æ‰€æœ‰èµ„äº§å˜åŠ¨   |
| äº¤æ˜“è®¢å•       | `trade_orders`           | `order_id`         | `business_id`                       | å†»ç»“é“¾è·¯è®¢å•   |

#### ç¦æ­¢æ¨¡å¼

```javascript
// âŒ ç¦æ­¢ï¼šå¤šè¡¨è®°å½•ç›¸åŒçŠ¶æ€ï¼ˆè¯­ä¹‰å†²çªï¼‰
await UserInventory.update({ market_status: 'on_sale' }, { where: { inventory_id: itemId } })
await MarketListing.create({ offer_item_instance_id: itemId, status: 'on_sale' })
// é”™è¯¯ï¼šmarket_status å’Œ MarketListing.status è®°å½•åŒä¸€ä¸šåŠ¡çŠ¶æ€
```

#### æ ‡å‡†å®ç°

```javascript
// âœ… æ­£ç¡®ï¼šå•ä¸€çœŸç›¸æ¥æº
// æŒ‚ç‰Œæ“ä½œåªå†™å…¥ market_listings è¡¨
await MarketListing.create({
  seller_user_id: userId,
  offer_item_instance_id: itemId,
  status: 'on_sale',
  business_id: businessId
})

// åŒæ—¶æ›´æ–°ç‰©å“å®ä¾‹çŠ¶æ€ä¸º lockedï¼ˆé˜²æ­¢å–å®¶é‡å¤æ“ä½œï¼‰
await ItemInstance.update(
  { status: 'locked', locked_at: new Date() },
  { where: { item_instance_id: itemId }, transaction }
)
```

#### å®¡æŸ¥æ¸…å•

- [ ] æ¯ä¸ªä¸šåŠ¡çŠ¶æ€æ˜¯å¦åªæœ‰ä¸€ä¸ªçœŸç›¸è¡¨ï¼Ÿ
- [ ] æ˜¯å¦å­˜åœ¨å¤šè¡¨è®°å½•ç›¸åŒçŠ¶æ€çš„æƒ…å†µï¼Ÿ
- [ ] å…³è”çŠ¶æ€æ˜¯å¦é€šè¿‡å¤–é”®å¼•ç”¨ï¼ˆè€Œéå†—ä½™å­—æ®µï¼‰ï¼Ÿ

---

### 5.4 å¤–é”®çº¦æŸå’Œç´¢å¼•å¼ºåˆ¶è¦æ±‚ï¼ˆæ¨è - P1ï¼‰

---

### 5.4 å¤–é”®çº¦æŸå’Œç´¢å¼•å¼ºåˆ¶è¦æ±‚ï¼ˆæ¨è - P1ï¼‰

#### å¼ºåˆ¶çº¦æŸ

æ‰€æœ‰å…³è”è¡¨**æ¨è**æ·»åŠ å¤–é”®çº¦æŸå’Œå…³é”®ç´¢å¼•ã€‚

#### æ ‡å‡†å®ç°

```javascript
// âœ… æ¨¡å‹å®šä¹‰åŒ…å«å¤–é”®å’Œç´¢å¼•
MarketListing.init(
  {
    seller_user_id: {
      type: DataTypes.INTEGER,
      allowNull: false,
      references: {
        model: 'users', // âœ… å¤–é”®çº¦æŸ
        key: 'user_id'
      },
      onDelete: 'RESTRICT',
      onUpdate: 'CASCADE'
    }
  },
  {
    indexes: [
      {
        fields: ['seller_user_id', 'status'], // âœ… è”åˆç´¢å¼•
        name: 'idx_seller_status'
      },
      {
        unique: true,
        fields: ['seller_user_id', 'business_id'], // âœ… æŒ‰å–å®¶éš”ç¦»çš„å¹‚ç­‰é”®
        name: 'uk_market_listings_seller_business_id'
      }
    ]
  }
)
```

#### å¿…éœ€çš„ç´¢å¼•ç¤ºä¾‹

```sql
-- item_instancesï¼ˆç‰©å“å®ä¾‹çœŸç›¸è¡¨ï¼‰
CREATE INDEX idx_item_instances_owner_status
  ON item_instances(owner_user_id, status);

-- market_listingsï¼ˆå¸‚åœºæŒ‚ç‰ŒçœŸç›¸è¡¨ï¼‰
CREATE UNIQUE INDEX uk_market_listings_seller_business_id
  ON market_listings(seller_user_id, business_id);
CREATE INDEX idx_market_listings_status_created
  ON market_listings(status, created_at DESC);

-- account_asset_balancesï¼ˆèµ„äº§ä½™é¢çœŸç›¸è¡¨ï¼‰
CREATE UNIQUE INDEX uk_account_asset_balances_account_asset
  ON account_asset_balances(account_id, asset_code);
CREATE INDEX idx_account_asset_balances_user_asset
  ON account_asset_balances(user_id, asset_code);

-- asset_transactionsï¼ˆèµ„äº§æµæ°´çœŸç›¸è¡¨ï¼‰
CREATE UNIQUE INDEX uk_asset_transactions_business_id_type
  ON asset_transactions(business_id, business_type);
CREATE INDEX idx_asset_transactions_user_created
  ON asset_transactions(user_id, created_at DESC);

-- redemption_ordersï¼ˆæ ¸é”€ç çœŸç›¸è¡¨ï¼‰
CREATE UNIQUE INDEX uk_redemption_orders_code_hash
  ON redemption_orders(code_hash);
CREATE INDEX idx_redemption_orders_item_status
  ON redemption_orders(item_instance_id, status);
```

#### å®¡æŸ¥æ¸…å•

- [ ] å…³è”è¡¨æ˜¯å¦æ·»åŠ å¤–é”®çº¦æŸï¼Ÿ
- [ ] æ˜¯å¦æ·»åŠ äº†å¸¸ç”¨æŸ¥è¯¢çš„ç´¢å¼•ï¼Ÿ
- [ ] å¹‚ç­‰é”®æ˜¯å¦æœ‰å”¯ä¸€ç´¢å¼•ï¼Ÿ
- [ ] å¹‚ç­‰é”®çº¦æŸæ˜¯å¦æŒ‰ç”¨æˆ·/å–å®¶éš”ç¦»ï¼ˆé¿å…è·¨ç”¨æˆ·ç¢°æ’ï¼‰ï¼Ÿ

---

## å…­ã€äº‹åŠ¡å¹¶å‘ä¸å¹‚ç­‰æ€§æ ‡å‡†

### 6.1 å¹‚ç­‰é”®æ•°æ®åº“å±‚å”¯ä¸€çº¦æŸï¼ˆå¼ºåˆ¶ - P0ï¼‰

#### å¼ºåˆ¶çº¦æŸ

æ‰€æœ‰å¹‚ç­‰é”®ï¼ˆbusiness_idï¼‰**å¿…é¡»**æœ‰æ•°æ®åº“å±‚å”¯ä¸€çº¦æŸã€‚

#### è®¾è®¡ç†å¿µ

- **å‘½åç©ºé—´éš”ç¦»**ï¼šä¸åŒç”¨æˆ·å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ `business_id`ï¼ˆé¿å…è·¨ç”¨æˆ·ç¢°æ’ï¼‰
- **ä¸šåŠ¡è¾¹ç•Œä¸€è‡´**ï¼šå¹‚ç­‰æ€§è¾¹ç•Œ = ä¸šåŠ¡è¾¹ç•Œï¼ˆå•ä¸ªç”¨æˆ·/å–å®¶çš„æ“ä½œï¼‰
- **è°ƒè¯•å‹å¥½**ï¼šé—®é¢˜å®šä½æ¸…æ™°ï¼ˆæŸä¸ªç”¨æˆ·çš„æŸæ¬¡è¯·æ±‚ï¼‰

#### è¯´æ˜

æœ¬èŠ‚ä¸åšä»»ä½•å¤–éƒ¨å¯¹æ ‡ï¼›åªå®šä¹‰**æœ¬ä»“åº“å½“å‰ä»£ç å¿…é¡»éµå®ˆ**çš„å¹‚ç­‰é”®ä¸å”¯ä¸€çº¦æŸè§„åˆ™ã€‚

#### ç¦æ­¢æ¨¡å¼

```javascript
// âŒ ç¦æ­¢ï¼šä»…åœ¨ä»£ç å±‚åˆ¤æ–­é‡å¤ï¼ˆå¹¶å‘ä¸å¯é ï¼‰
const existing = await MarketListing.findOne({
  where: { business_id }
})
if (existing) {
  throw new Error('é‡å¤')  // âŒ å¹¶å‘åœºæ™¯ä¸‹ä¸å¯é 
}
await MarketListing.create({ business_id, ... })
```

```sql
-- âŒ ç¦æ­¢ï¼šå…¨å±€å”¯ä¸€çº¦æŸï¼ˆä¼šå¯¼è‡´è·¨ç”¨æˆ·ç¢°æ’ï¼‰
CREATE UNIQUE INDEX uniq_listing_business_id
ON market_listings (business_id);
-- é”™è¯¯ï¼šä¸åŒå–å®¶å¯èƒ½"ç¢°å·§"ç”Ÿæˆç›¸åŒçš„ business_id
```

#### æ ‡å‡†å®ç°

```sql
-- âœ… æ­£ç¡®ï¼šæŒ‰å–å®¶éš”ç¦»çš„å”¯ä¸€çº¦æŸ
CREATE UNIQUE INDEX uk_market_listings_seller_business_id
ON market_listings (seller_user_id, business_id);

-- è¯´æ˜ï¼š
-- - seller_user_id ä¸èƒ½ä¸º NULLï¼ˆå¤–é”®çº¦æŸï¼‰
-- - business_id å…è®¸ NULLï¼ˆå…¼å®¹å†å²æ•°æ®ï¼‰
-- - MySQL å¯¹ UNIQUE ç´¢å¼•è‡ªåŠ¨å…è®¸å¤šä¸ª NULL å€¼ï¼ˆæ— éœ€ where æ¡ä»¶ï¼‰
-- - åªæœ‰ (seller_user_id, business_id) éƒ½é NULL æ—¶æ‰æ£€æŸ¥å”¯ä¸€æ€§
```

**Sequelize Model å±‚å®šä¹‰**ï¼š

```javascript
// âœ… æ­£ç¡®ï¼šModel å±‚å®šä¹‰å”¯ä¸€çº¦æŸ
{
  indexes: [
    {
      unique: true,
      fields: ['seller_user_id', 'business_id'],
      name: 'uk_market_listings_seller_business_id',
      comment: 'å–å®¶+ä¸šåŠ¡IDå”¯ä¸€ç´¢å¼•ï¼ˆå¹‚ç­‰ä¿è¯ï¼‰'
    }
    // ... å…¶ä»–ç´¢å¼•
  ]
}
```

**åº”ç”¨å±‚å¹‚ç­‰å¤„ç†é€»è¾‘**ï¼š

```javascript
// âœ… æ­£ç¡®ï¼šService å±‚å¹‚ç­‰å¤„ç†
async createListing(params) {
  const { seller_user_id, business_id, ...rest } = params

  // 1. business_id å¿…å¡«æ ¡éªŒ
  if (!business_id) {
    throw new Error('business_id æ˜¯å¿…å¡«å­—æ®µï¼ˆå¹‚ç­‰é”®ï¼‰')
  }

  try {
    // 2. å°è¯•åˆ›å»ºæŒ‚ç‰Œ
    const listing = await MarketListing.create({
      seller_user_id,
      business_id,
      ...rest
    })
    return { success: true, listing }

  } catch (error) {
    // 3. æ•è·å”¯ä¸€çº¦æŸå†²çª
    if (error.name === 'SequelizeUniqueConstraintError') {
      // å¹‚ç­‰å¤„ç†ï¼šæŸ¥è¯¢å·²å­˜åœ¨çš„æŒ‚ç‰Œ
      const existing = await MarketListing.findOne({
        where: { seller_user_id, business_id }
      })

      // å‚æ•°ä¸€è‡´ â†’ å¹‚ç­‰è¿”å›ï¼ˆé¿å…é‡å¤åˆ›å»ºï¼‰
      if (this._paramsMatch(existing, params)) {
        return { success: true, listing: existing, idempotent: true }
      }

      // å‚æ•°ä¸ä¸€è‡´ â†’ è¿”å› 409 å†²çª
      throw new ConflictError(
        `ä¸šåŠ¡IDå†²çªï¼šè¯¥å–å®¶å·²ä½¿ç”¨æ­¤ business_id åˆ›å»ºäº†ä¸åŒçš„æŒ‚ç‰Œ`,
        'IDEMPOTENCY_KEY_CONFLICT',
        { business_id, seller_user_id }
      )
    }
    throw error
  }
}
```

#### å®¡æŸ¥æ¸…å•

- [ ] æ‰€æœ‰å¹‚ç­‰é”®æ˜¯å¦æœ‰æ•°æ®åº“å±‚å”¯ä¸€çº¦æŸï¼Ÿ
- [ ] å”¯ä¸€çº¦æŸæ˜¯å¦æŒ‰ç”¨æˆ·/å–å®¶éš”ç¦»ï¼ˆ`UNIQUE(user_id/seller_id, business_id)`ï¼‰ï¼Ÿ
- [ ] æ¨¡å‹å®šä¹‰æ˜¯å¦åŒ…å«å”¯ä¸€ç´¢å¼•ï¼Ÿ
- [ ] è¿ç§»æ–‡ä»¶æ˜¯å¦æ·»åŠ äº†çº¦æŸï¼Ÿ

---

### 6.2 å¹‚ç­‰é”®æœåŠ¡ç«¯æ´¾ç”Ÿè§„èŒƒï¼ˆå¼ºåˆ¶ - P1ï¼‰

#### å†…éƒ¨å¹‚ç­‰é”®æ´¾ç”Ÿè§„èŒƒ

**å¼ºåˆ¶è§„åˆ™**ï¼š

- âœ… æ‰€æœ‰å†™å…¥åº•å±‚æµæ°´è¡¨çš„å¹‚ç­‰é”®ï¼Œå¿…é¡»ç”±æœåŠ¡ç«¯æ´¾ç”Ÿï¼ˆå‘½åç©ºé—´éš”ç¦»ï¼‰
- âŒ ç¦æ­¢ç›´æ¥å¤ç”¨å®¢æˆ·ç«¯ä¼ å…¥çš„ `business_id` ä½œä¸ºåº•å±‚æµæ°´å¹‚ç­‰é”®
- âœ… æ´¾ç”Ÿè§„åˆ™ï¼š`internal_business_id = "{business_type}:{user_id}:{client_business_id}"`

#### è®¾è®¡ç†å¿µ

- **è·¨ç”¨æˆ·ç¢°æ’é£é™©**ï¼šç›®å‰ `AssetTransaction` çš„ `UNIQUE(business_id, business_type)` çº¦æŸæ²¡æœ‰ `user_id` éš”ç¦»
- **åº•å±‚å…ˆæ’åº“é£é™©**ï¼šå®¢æˆ·ç«¯ä¼ å…¥ç›¸åŒ `order_id` ä¼šå¯¼è‡´å…¶ä»–ç”¨æˆ·æ‰£æ¬¾å¤±è´¥
- **å‘½åç©ºé—´éš”ç¦»**ï¼šåŒä¸€ä¸ªå®¢æˆ·ç«¯å¹‚ç­‰é”®åœ¨ä¸åŒç”¨æˆ·ä¸‹å˜æˆä¸åŒçš„å†…éƒ¨ business_id

#### æ­£ç¡®ç¤ºä¾‹

```javascript
// âœ… æ­£ç¡®ï¼šæœåŠ¡ç«¯æ´¾ç”Ÿå†…éƒ¨å¹‚ç­‰é”®
class ExchangeMarketService {
  static async createExchangeOrder(userId, itemId, paymentInfo, options = {}) {
    const { transaction } = options
    const client_business_id = options.business_id || `order_${Date.now()}_${randomString()}`

    // âœ… æœåŠ¡ç«¯æ´¾ç”Ÿå†…éƒ¨å¹‚ç­‰é”®ï¼ˆå‘½åç©ºé—´éš”ç¦»ï¼‰
    const internal_business_id = `EXCHANGE:${userId}:${client_business_id}`

    try {
      // æ‰£å‡èµ„äº§ï¼ˆä½¿ç”¨å†…éƒ¨å¹‚ç­‰é”®ï¼‰
      await AssetService.changeBalance({
        user_id: userId,
        business_id: internal_business_id, // âœ… å†…éƒ¨æ´¾ç”Ÿkey
        business_type: 'EXCHANGE',
        amount: -paymentInfo.amount,
        meta: {
          client_business_id: client_business_id, // åŸå§‹å®¢æˆ·ç«¯ ID æ”¾ meta
          item_id: itemId
        },
        transaction
      })

      // åˆ›å»ºè®¢å•è®°å½•ï¼ˆä½¿ç”¨å®¢æˆ·ç«¯å¹‚ç­‰é”®ï¼‰
      const order = await ExchangeMarketRecord.create(
        {
          user_id: userId,
          item_id: itemId,
          business_id: client_business_id // âœ… å¯¹å¤–ç”¨å®¢æˆ·ç«¯key
          // ...
        },
        { transaction }
      )

      return { success: true, order_id: order.order_id }
    } catch (error) {
      throw error
    }
  }
}
```

#### ç¦æ­¢æ¨¡å¼

```javascript
// âŒ ç¦æ­¢ï¼šç›´æ¥å¤ç”¨å®¢æˆ·ç«¯ business_idï¼ˆè·¨ç”¨æˆ·ç¢°æ’é£é™©ï¼‰
await AssetService.changeBalance({
  user_id: userId,
  business_id: req.body.order_id, // é”™è¯¯ï¼šå®¢æˆ·ç«¯å¯æ§ï¼Œå¯èƒ½è·¨ç”¨æˆ·ç¢°æ’
  business_type: 'EXCHANGE'
  // ...
})

// é£é™©åœºæ™¯ï¼š
// ç”¨æˆ·Aä¼ å…¥ order_id='ORDER_20251218_123'ï¼Œæ‰£æ¬¾æˆåŠŸ
// ç”¨æˆ·Bä¹Ÿä¼ å…¥ order_id='ORDER_20251218_123'ï¼ˆç¢°å·§ç›¸åŒï¼‰
// â†’ AssetTransaction çš„ UNIQUE(business_id, business_type) çº¦æŸè§¦å‘
// â†’ ç”¨æˆ·Bæ‰£æ¬¾å¤±è´¥ï¼ˆæ’åº“ï¼‰ï¼Œä½†ä¸šåŠ¡å±‚è®¤ä¸ºæ˜¯"å¹‚ç­‰é‡è¯•"
```

#### å½±å“èŒƒå›´

- `services/ExchangeMarketService.js`ï¼ˆå¸‚åœºäº¤æ˜“è°ƒç”¨ `AssetService.changeBalance`ï¼‰
- `services/AssetConversionService.js`ï¼ˆèµ„äº§å…‘æ¢è°ƒç”¨ `AssetService.changeBalance`ï¼‰
- `services/TradeOrderService.js`ï¼ˆäº¤æ˜“è®¢å•è°ƒç”¨ `AssetService.changeBalance`ï¼‰
- `services/UnifiedLotteryEngine/strategies/BasicGuaranteeStrategy.js`ï¼ˆæŠ½å¥–å‘å¥–è°ƒç”¨ï¼‰

#### å®¡æŸ¥æ¸…å•

- [ ] åº•å±‚æµæ°´è¡¨çš„ business_id æ˜¯å¦ç”±æœåŠ¡ç«¯æ´¾ç”Ÿï¼Ÿ
- [ ] æ´¾ç”Ÿè§„åˆ™æ˜¯å¦åŒ…å« user_id éš”ç¦»ï¼Ÿ
- [ ] å®¢æˆ·ç«¯åŸå§‹ business_id æ˜¯å¦ä¿å­˜åœ¨ meta å­—æ®µï¼Ÿ
- [ ] æ˜¯å¦é¿å…ç›´æ¥å¤ç”¨å®¢æˆ·ç«¯ä¼ å…¥çš„ business_idï¼Ÿ

---

### 6.3 äº‹åŠ¡è¾¹ç•Œæ¸…æ™°æ€§åŸåˆ™ï¼ˆå¼ºåˆ¶ - P1ï¼‰

#### å¼ºåˆ¶çº¦æŸ

ä¸šåŠ¡æ“ä½œå’Œå®¡è®¡æ—¥å¿—**å¿…é¡»**åœ¨åŒä¸€äº‹åŠ¡å†…ï¼Œæˆ–ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦ã€‚

#### ç¦æ­¢æ¨¡å¼

```javascript
// âŒ ç¦æ­¢ï¼šäº‹åŠ¡å¤–å¼‚æ­¥å†™å…¥å®¡è®¡æ—¥å¿—
await transaction.commit()  // å·²æäº¤

try {
  await AuditLogService.log({ ... })  // âŒ äº‹åŠ¡å¤–ï¼Œå¯èƒ½ä¸¢å¤±
} catch (error) {
  logger.error('å®¡è®¡æ—¥å¿—å¤±è´¥')  // âŒ ä¸šåŠ¡æˆåŠŸä½†æ—¥å¿—å¤±è´¥
}
```

#### æ ‡å‡†å®ç°

**æ–¹æ¡ˆ1ï¼šå®¡è®¡æ—¥å¿—åœ¨äº‹åŠ¡å†…ï¼ˆæ¨èç”¨äºå…³é”®æ“ä½œï¼‰**

```javascript
// âœ… å®¡è®¡æ—¥å¿—åœ¨äº‹åŠ¡å†…
const transaction = await sequelize.transaction()
try {
  // ä¸šåŠ¡æ“ä½œ
  await item.update({ status: 'used' }, { transaction })

  // å®¡è®¡æ—¥å¿—ï¼ˆåŒä¸€äº‹åŠ¡ï¼‰
  await AuditLogService.logInventoryUse(
    {
      operator_id: userId,
      item_id: itemId,
      action: 'use'
    },
    { transaction }
  )

  // ç»Ÿä¸€æäº¤
  await transaction.commit()
} catch (error) {
  await transaction.rollback()
  throw error
}
```

**æ–¹æ¡ˆ2ï¼šæ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥ï¼ˆè§£è€¦ï¼‰**

```javascript
// âœ… ä¸šåŠ¡å…ˆæäº¤ï¼Œå®¡è®¡æ—¥å¿—å¼‚æ­¥
await transaction.commit()

// å¼‚æ­¥å®¡è®¡ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰
await auditQueue.publish('inventory.used', {
  operator_id: userId,
  item_id: itemId,
  timestamp: Date.now()
})
```

#### å®¡æŸ¥æ¸…å•

- [ ] å®¡è®¡æ—¥å¿—æ˜¯å¦åœ¨äº‹åŠ¡å†…å†™å…¥ï¼Ÿ
- [ ] æˆ–è€…æ˜¯å¦ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥è§£è€¦ï¼Ÿ
- [ ] ä¸šåŠ¡æˆåŠŸä½†æ—¥å¿—å¤±è´¥æ—¶å¦‚ä½•å¤„ç†ï¼Ÿ

---

### 6.4 æ‚²è§‚é”ç´¢å¼•æ”¯æŒï¼ˆå¼ºåˆ¶ - P1ï¼‰

#### å¼ºåˆ¶çº¦æŸ

ä½¿ç”¨æ‚²è§‚é”çš„æŸ¥è¯¢æ¡ä»¶**å¿…é¡»**æœ‰ç´¢å¼•æ”¯æŒï¼Œé¿å…è¡¨é”ã€‚

#### ç¦æ­¢æ¨¡å¼

```javascript
// âŒ å±é™©ï¼šæ— ç´¢å¼•æ”¯æŒçš„æ‚²è§‚é”ï¼ˆé€€åŒ–ä¸ºè¡¨é”ï¼‰
const item = await ItemInstance.findOne({
  where: {
    name: itemName // âŒ æ— ç´¢å¼•ï¼Œé€€åŒ–ä¸ºè¡¨é”
  },
  lock: transaction.LOCK.UPDATE,
  transaction
})
```

#### æ ‡å‡†å®ç°

```javascript
// âœ… ç´¢å¼•æ”¯æŒçš„æ‚²è§‚é”
const item = await ItemInstance.findOne({
  where: {
    item_instance_id: itemId, // âœ… ä¸»é”®
    owner_user_id: userId // âœ… æœ‰è”åˆç´¢å¼•
  },
  lock: transaction.LOCK.UPDATE,
  transaction
})

// ç¡®ä¿ç´¢å¼•å­˜åœ¨
// CREATE INDEX idx_item_owner ON item_instances(item_instance_id, owner_user_id)
```

#### æ£€æŸ¥æ–¹æ³•

```sql
-- æ£€æŸ¥å…³é”®æŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT * FROM item_instances
WHERE item_instance_id = 123 AND owner_user_id = 456
FOR UPDATE;

-- å¦‚æœ type=ALLï¼ˆå…¨è¡¨æ‰«æï¼‰ï¼Œéœ€è¦æ·»åŠ ç´¢å¼•
CREATE INDEX idx_item_owner ON item_instances(item_instance_id, owner_user_id);
```

#### å®¡æŸ¥æ¸…å•

- [ ] æ‚²è§‚é”æŸ¥è¯¢çš„ where æ¡ä»¶æ˜¯å¦æœ‰ç´¢å¼•ï¼Ÿ
- [ ] æ˜¯å¦ä½¿ç”¨ `EXPLAIN` éªŒè¯æ‰§è¡Œè®¡åˆ’ï¼Ÿ
- [ ] æ˜¯å¦é¿å…äº†å…¨è¡¨æ‰«æï¼ˆtype=ALLï¼‰ï¼Ÿ

---

## ä¸ƒã€æ€§èƒ½ä¼˜åŒ–å¼ºåˆ¶è¦æ±‚

### 7.1 ç¦æ­¢N+1æŸ¥è¯¢ï¼ˆå¼ºåˆ¶ - P1ï¼‰

#### å¼ºåˆ¶çº¦æŸ

æ‰¹é‡æ•°æ®**å¿…é¡»**ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢ï¼Œ**ç¦æ­¢**å¾ªç¯æŸ¥è¯¢ã€‚

#### ç¦æ­¢æ¨¡å¼

```javascript
// âŒ ç¦æ­¢ï¼šN+1æŸ¥è¯¢
async function getUserAssets(userId) {
  const accounts = await AssetAccount.findAll({
    where: { user_id: userId }
  })

  // âŒ å¾ªç¯æŸ¥è¯¢ï¼ˆN+1ï¼‰
  for (const account of accounts) {
    const type = await MaterialAssetType.findOne({
      where: { asset_code: account.asset_code }
    })
    account.type = type
  }

  return accounts
}

// é£é™©ï¼š
// - Nä¸ªèµ„äº§ â†’ N+1æ¬¡æ•°æ®åº“æŸ¥è¯¢
// - æ•°æ®åº“è¿æ¥æ± è€—å°½
// - æ¥å£å“åº”æ—¶é—´çº¿æ€§å¢é•¿
```

#### æ ‡å‡†å®ç°

```javascript
// âœ… æ‰¹é‡æŸ¥è¯¢ + Map æ˜ å°„
async function getUserAssets(userId, transaction) {
  // 1. æŸ¥è¯¢æ‰€æœ‰èµ„äº§è´¦æˆ·ï¼ˆ1æ¬¡æŸ¥è¯¢ï¼‰
  const accounts = await AccountAssetBalance.findAll({
    where: {
      user_id: userId,
      balance: { [Op.gt]: 0 }
    },
    transaction
  })

  if (accounts.length === 0) {
    return []
  }

  // 2. æ‰¹é‡æŸ¥è¯¢èµ„äº§ç±»å‹ï¼ˆ1æ¬¡æŸ¥è¯¢ï¼‰
  const assetCodes = [...new Set(accounts.map(a => a.asset_code))]

  const assetTypes = await MaterialAssetType.findAll({
    where: {
      asset_code: { [Op.in]: assetCodes } // âœ… ä½¿ç”¨ IN æ‰¹é‡æŸ¥è¯¢
    },
    transaction
  })

  // 3. å»ºç«‹ Map æ˜ å°„ï¼ˆé¿å…é‡å¤æŸ¥è¯¢ï¼‰
  const assetTypeMap = new Map()
  assetTypes.forEach(assetType => {
    assetTypeMap.set(assetType.asset_code, assetType)
  })

  // 4. ç»„è£…æ•°æ®ï¼ˆä» Map ä¸­è¯»å–ï¼‰
  return accounts.map(account => ({
    asset_code: account.asset_code,
    display_name: assetTypeMap.get(account.asset_code)?.display_name || account.asset_code,
    balance: account.balance,
    frozen_balance: account.frozen_balance,
    category: assetTypeMap.get(account.asset_code)?.category || 'unknown',
    rarity: assetTypeMap.get(account.asset_code)?.rarity || 'common'
  }))
}
```

#### å®¡æŸ¥æ¸…å•

- [ ] æ˜¯å¦å­˜åœ¨å¾ªç¯å†…æŸ¥è¯¢æ•°æ®åº“ï¼Ÿ
- [ ] æ‰¹é‡æ•°æ®æ˜¯å¦ä½¿ç”¨ `Op.in` æ‰¹é‡æŸ¥è¯¢ï¼Ÿ
- [ ] æ˜¯å¦å»ºç«‹äº† Map æ˜ å°„é¿å…é‡å¤æŸ¥è¯¢ï¼Ÿ
- [ ] åˆ—è¡¨æŸ¥è¯¢æ˜¯å¦æ§åˆ¶åœ¨ 3 æ¬¡ä»¥å†…æ•°æ®åº“æ“ä½œï¼Ÿ

---

### 7.2 Redis SCAN æ›¿ä»£ KEYSï¼ˆå¼ºåˆ¶ - P1ï¼‰

#### å¼ºåˆ¶çº¦æŸ

Redis ç”Ÿäº§ç¯å¢ƒ**ç¦æ­¢**ä½¿ç”¨ `KEYS` å‘½ä»¤ï¼Œ**å¿…é¡»**ä½¿ç”¨ `SCAN`ã€‚

#### è®¾è®¡ç†å¿µ

- **KEYS å‘½ä»¤é—®é¢˜**ï¼šä¼šé˜»å¡ Redis ä¸»çº¿ç¨‹ï¼Œå½±å“æ‰€æœ‰è¯·æ±‚ï¼ˆO(N)å¤æ‚åº¦ï¼‰
- **SCAN å‘½ä»¤ä¼˜åŠ¿**ï¼šæ¸¸æ ‡è¿­ä»£ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹ï¼Œåˆ†æ‰¹è¿”å›ï¼ˆå¢é‡å¼ï¼‰

#### ç¦æ­¢æ¨¡å¼

```javascript
// âŒ ç¦æ­¢ï¼šç”Ÿäº§ç¯å¢ƒä½¿ç”¨ KEYSï¼ˆé˜»å¡Redisä¸»çº¿ç¨‹ï¼‰
async function getStats(keyPattern) {
  const keys = await client.keys(keyPattern) // âŒ é˜»å¡
  // ...
}

// é£é™©ï¼š
// - Redis ä¸»çº¿ç¨‹é˜»å¡ï¼ˆå•çº¿ç¨‹æ¨¡å‹ï¼‰
// - æ‰€æœ‰è¯·æ±‚å»¶è¿Ÿé£™å‡
// - å¯èƒ½å¯¼è‡´æœåŠ¡é›ªå´©
```

#### æ ‡å‡†å®ç°

```javascript
// âœ… ä½¿ç”¨ SCAN æ¸¸æ ‡è¿­ä»£
async _scanKeys(client, pattern) {
  const keys = new Set()  // ä½¿ç”¨ Set è‡ªåŠ¨å»é‡
  let cursor = '0'

  try {
    do {
      // SCAN å‘½ä»¤å‚æ•°ï¼šcursor MATCH pattern COUNT count
      // è¿”å›æ ¼å¼ï¼š[newCursor, [keys]]
      const result = await client.scan(cursor, 'MATCH', pattern, 'COUNT', 100)

      cursor = result[0]  // ä¸‹ä¸€æ¬¡æ¸¸æ ‡ä½ç½®
      const matchedKeys = result[1]  // æœ¬æ‰¹æ¬¡åŒ¹é…çš„ keys

      // å°†åŒ¹é…çš„ keys æ·»åŠ åˆ° Set ä¸­
      matchedKeys.forEach(key => keys.add(key))

      // cursor ä¸º '0' è¡¨ç¤ºéå†å®Œæˆ
    } while (cursor !== '0')

    return Array.from(keys)
  } catch (error) {
    logger.error('SCANå‘½ä»¤æ‰§è¡Œå¤±è´¥', { error: error.message })
    throw error
  }
}

// âœ… ä½¿ç”¨ç¤ºä¾‹ï¼šè·å–é™æµç»Ÿè®¡ä¿¡æ¯
async getStats(keyPattern = 'rate_limit:*') {
  try {
    const client = await this.redisClient.ensureConnection()

    // âœ… ä½¿ç”¨ SCAN æ›¿ä»£ KEYS å‘½ä»¤ï¼ˆé¿å…ç”Ÿäº§ç¯å¢ƒé˜»å¡ï¼‰
    const keys = await this._scanKeys(client, keyPattern)

    const stats = {
      total_keys: keys.length,
      keys: [],
      timestamp: BeijingTimeHelper.formatForAPI(new Date()).iso
    }

    // æœ€å¤šè¿”å›100ä¸ªkeyçš„ç»Ÿè®¡
    for (const key of keys.slice(0, 100)) {
      const count = await this.redisClient.zcard(key)
      const ttl = await client.ttl(key)

      stats.keys.push({
        key,
        request_count: count,
        ttl_seconds: ttl
      })
    }

    return stats
  } catch (error) {
    logger.error('è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥', { error: error.message })
    return {
      error: error.message,
      timestamp: BeijingTimeHelper.formatForAPI(new Date()).iso
    }
  }
}
```

#### å®¡æŸ¥æ¸…å•

- [ ] æ˜¯å¦å­˜åœ¨ `client.keys()` è°ƒç”¨ï¼Ÿ
- [ ] æ˜¯å¦å®ç°äº† `_scanKeys()` è¾…åŠ©æ–¹æ³•ï¼Ÿ
- [ ] SCAN æ˜¯å¦ä½¿ç”¨äº†åˆç†çš„ COUNT å€¼ï¼ˆå¦‚ 100ï¼‰ï¼Ÿ

---

### 7.3 æ…¢æŸ¥è¯¢ç›‘æ§å’Œç´¢å¼•ä¼˜åŒ–ï¼ˆæ¨è - P2ï¼‰

#### æ¨èå®è·µ

å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—å¹¶å®šæœŸåˆ†æã€‚

#### é…ç½®æ–¹æ³•

```sql
-- å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;  -- 1ç§’ä»¥ä¸Šç®—æ…¢æŸ¥è¯¢
SET GLOBAL log_queries_not_using_indexes = 'ON';

-- åˆ†ææ…¢æŸ¥è¯¢
-- mysqldumpslow -s t -t 10 /var/log/mysql/slow.log
```

#### å¸¸è§å¿…éœ€ç´¢å¼•

```sql
-- èƒŒåŒ…æŸ¥è¯¢
CREATE INDEX idx_item_instances_owner_status
  ON item_instances(owner_user_id, status);

-- å¸‚åœºæŸ¥è¯¢
CREATE INDEX idx_market_listings_status_created
  ON market_listings(status, created_at DESC);

-- èµ„äº§æŸ¥è¯¢
CREATE INDEX idx_account_asset_balances_user_asset
  ON account_asset_balances(user_id, asset_code);

-- å®¡è®¡æ—¥å¿—æŸ¥è¯¢
CREATE INDEX idx_admin_operation_logs_operator_time
  ON admin_operation_logs(operator_id, created_at DESC);
```

#### å®¡æŸ¥æ¸…å•

- [ ] æ˜¯å¦å¼€å¯äº†æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Ÿ
- [ ] æ˜¯å¦å®šæœŸåˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—ï¼Ÿ
- [ ] é«˜é¢‘æŸ¥è¯¢æ˜¯å¦æœ‰ç´¢å¼•æ”¯æŒï¼Ÿ

---

## å…«ã€æƒé™æ¨¡å‹ä¸ç¼“å­˜ä¸€è‡´æ€§

### 8.1 æƒé™å˜æ›´è‡ªåŠ¨å¤±æ•ˆç¼“å­˜ï¼ˆå¼ºåˆ¶ - P1ï¼‰

#### å¼ºåˆ¶çº¦æŸ

æ‰€æœ‰æƒé™å˜æ›´æ“ä½œ**å¿…é¡»**è‡ªåŠ¨å¤±æ•ˆç›¸å…³ç¼“å­˜ã€‚

#### ç¦æ­¢æ¨¡å¼

```javascript
// âŒ ç¦æ­¢ï¼šæƒé™å˜æ›´ä½†ä¸å¤±æ•ˆç¼“å­˜
static async updateUserRole(userId, roleName) {
  await UserRole.update({ role_name: roleName }, { where: { user_id: userId } })
  // âŒ ç¼ºå°‘ invalidateUserPermissions()
  // ç»“æœï¼šç”¨æˆ·ä»ä»¥æ—§æƒé™è®¿é—®
}

// âŒ ç¦æ­¢ï¼šè·¯ç”±å±‚ç›´æ¥ä¿®æ”¹æƒé™
router.put('/user/:id/role', async (req, res) => {
  await UserRole.update(
    { role_name: req.body.role },
    { where: { user_id: req.params.id } }
  )
  // âŒ ç»•è¿‡ Service å…¥å£ï¼Œç¼ºå°‘ç¼“å­˜å¤±æ•ˆ
  res.apiSuccess('è§’è‰²æ›´æ–°æˆåŠŸ')
})
```

#### æ ‡å‡†å®ç°

```javascript
// âœ… æƒé™å˜æ›´ç»Ÿä¸€å…¥å£ï¼ˆè‡ªåŠ¨å¤±æ•ˆç¼“å­˜ï¼‰
class UserRoleService {
  static async updateUserRole(userId, roleName, options = {}) {
    const { transaction } = options

    // 1. æƒé™åˆæ³•æ€§æ ¡éªŒ
    const targetRole = await Role.findOne({ where: { role_name: roleName } })
    if (!targetRole) {
      throw new Error(`è§’è‰²ä¸å­˜åœ¨: ${roleName}`)
    }

    // 2. äº‹åŠ¡å†…è½åº“
    await UserRole.update({ role_name: roleName }, { where: { user_id: userId }, transaction })

    // 3. è‡ªåŠ¨æ¸…é™¤æƒé™ç¼“å­˜ï¼ˆå¿…éœ€ï¼‰
    await invalidateUserPermissions(userId, `role_change_${roleName}`)
    logger.info('æƒé™ç¼“å­˜å·²æ¸…é™¤', {
      user_id: userId,
      reason: `è§’è‰²å˜æ›´ ${roleName}`
    })

    // 4. æƒé™é™çº§æ—¶å¼ºåˆ¶æ–­å¼€ WebSocket
    if (targetRole.role_level < 100) {
      try {
        const ChatWebSocketService = require('./ChatWebSocketService')
        ChatWebSocketService.disconnectUser(userId, 'admin')
        logger.info('ç”¨æˆ·æƒé™é™çº§ï¼Œå·²æ–­å¼€WebSocket', { user_id: userId })
      } catch (wsError) {
        logger.warn('æ–­å¼€WebSocketå¤±è´¥ï¼ˆéè‡´å‘½ï¼‰', { error: wsError.message })
      }
    }

    // 5. å®¡è®¡æ—¥å¿—ï¼ˆå¿…éœ€ï¼‰
    await AuditLogService.log({
      operator_id: options.operator_id,
      operation_type: 'update_user_role',
      target_type: 'user',
      target_id: userId,
      operation_detail: {
        new_role: roleName,
        reason: options.reason
      },
      transaction
    })
  }
}
```

#### ç¼“å­˜å¤±æ•ˆå‡½æ•°æ ‡å‡†å®ç°

```javascript
// âœ… ç»Ÿä¸€ç¼“å­˜å¤±æ•ˆå‡½æ•°ï¼ˆå¢å¼ºç‰ˆï¼‰
const memoryCache = new Map()
const { getRedisClient } = require('./utils/UnifiedRedisClient')
const AuditLogService = require('../services/AuditLogService')

/**
 * æ¸…é™¤ç”¨æˆ·æƒé™ç¼“å­˜
 * @param {number} user_id - ç”¨æˆ·ID
 * @param {string} reason - å¤±æ•ˆåŸå› ï¼ˆç”¨äºå®¡è®¡ï¼‰
 * @param {number} operator_id - æ“ä½œäººIDï¼ˆå¯é€‰ï¼‰
 */
async function invalidateUserPermissions(user_id, reason = 'unknown', operator_id = null) {
  // 1. æ¸…é™¤å†…å­˜ç¼“å­˜
  memoryCache.delete(`permissions_${user_id}`)

  // 2. æ¸…é™¤ Redis ç¼“å­˜
  try {
    const redisClient = await getRedisClient()
    await redisClient.del(`permissions:${user_id}`)
  } catch (error) {
    logger.error('æ¸…é™¤Redisç¼“å­˜å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰', {
      user_id,
      error: error.message
    })
  }

  // 3. è®°å½•ç»“æ„åŒ–æ—¥å¿—ï¼ˆå®æ—¶ç›‘æ§ç”¨ï¼‰
  logger.info('æ¸…é™¤ç”¨æˆ·æƒé™ç¼“å­˜', {
    user_id,
    reason,
    operator_id,
    timestamp: new Date().toISOString()
  })

  // 4. è®°å½•å®¡è®¡æ—¥å¿—ï¼ˆåˆè§„æ€§è¿½æº¯ç”¨ï¼‰- P1è¿½åŠ 
  try {
    await AuditLogService.log({
      action: 'INVALIDATE_PERMISSIONS',
      target_type: 'user',
      target_id: user_id,
      operator_id: operator_id,
      metadata: { reason }
    })
  } catch (error) {
    logger.error('è®°å½•å®¡è®¡æ—¥å¿—å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰', {
      user_id,
      error: error.message
    })
  }
}

module.exports = { invalidateUserPermissions }
```

**è®¾è®¡ä¾æ®**ï¼š

- **ç»“æ„åŒ–æ—¥å¿—**ï¼šç”¨äºå®æ—¶ç›‘æ§å’Œè°ƒè¯•ï¼ˆå¯è§‚æµ‹æ€§ï¼‰
- **å®¡è®¡æ—¥å¿—**ï¼šç”¨äºåˆè§„ä¸è¿½æº¯ï¼ˆå®‰å…¨å®¡è®¡ï¼‰

#### å®¡æŸ¥æ¸…å•

- [ ] æƒé™å˜æ›´æ–¹æ³•æ˜¯å¦è°ƒç”¨ `invalidateUserPermissions()`ï¼Ÿ
- [ ] æ˜¯å¦åŒæ—¶æ¸…é™¤å†…å­˜ç¼“å­˜å’ŒRedisç¼“å­˜ï¼Ÿ
- [ ] æ˜¯å¦è®°å½•ç»“æ„åŒ–æ—¥å¿—ï¼ˆ`logger.info`ï¼‰ï¼Ÿ
- [ ] æ˜¯å¦è®°å½•å®¡è®¡æ—¥å¿—ï¼ˆ`AuditLogService.log`ï¼‰ï¼Ÿ
- [ ] æƒé™é™çº§æ˜¯å¦æ–­å¼€WebSocketè¿æ¥ï¼Ÿ
- [ ] æ˜¯å¦ç¦æ­¢åœ¨è·¯ç”±/Model å±‚ç›´æ¥ä¿®æ”¹æƒé™ï¼Ÿ

---

### 8.2 è´¦å·ç¦ç”¨å¼ºåˆ¶æ–­å¼€è¿æ¥ï¼ˆå¼ºåˆ¶ - P1ï¼‰

#### å¼ºåˆ¶çº¦æŸ

è´¦å·ç¦ç”¨/åœç”¨æ—¶**å¿…é¡»**æ–­å¼€æ‰€æœ‰WebSocketè¿æ¥ã€‚

#### æ ‡å‡†å®ç°

```javascript
// âœ… è´¦å·ç¦ç”¨è‡ªåŠ¨æ–­å¼€è¿æ¥
class UserRoleService {
  static async updateUserStatus(userId, status, options = {}) {
    const { transaction } = options

    // 1. æ›´æ–°çŠ¶æ€
    await User.update({ status: status }, { where: { user_id: userId }, transaction })

    // 2. è‡ªåŠ¨æ¸…é™¤æƒé™ç¼“å­˜
    await invalidateUserPermissions(userId, `status_change_${status}`)

    // 3. ç¦ç”¨/åœç”¨æ—¶æ–­å¼€æ‰€æœ‰è¿æ¥ï¼ˆå¿…éœ€ï¼‰
    if (status === 'inactive' || status === 'banned') {
      try {
        const ChatWebSocketService = require('./ChatWebSocketService')
        // æ–­å¼€æ™®é€šç”¨æˆ·è¿æ¥
        ChatWebSocketService.disconnectUser(userId, 'user')
        // æ–­å¼€ç®¡ç†å‘˜è¿æ¥ï¼ˆå¦‚æœæœ‰ï¼‰
        ChatWebSocketService.disconnectUser(userId, 'admin')

        logger.info('ç”¨æˆ·è¢«ç¦ç”¨ï¼Œå·²æ–­å¼€æ‰€æœ‰WebSocket', {
          user_id: userId,
          new_status: status
        })
      } catch (wsError) {
        logger.warn('æ–­å¼€WebSocketå¤±è´¥ï¼ˆéè‡´å‘½ï¼‰', { error: wsError.message })
      }
    }

    // 4. å®¡è®¡æ—¥å¿—
    await AuditLogService.log({
      operator_id: options.operator_id,
      operation_type: 'update_user_status',
      target_type: 'user',
      target_id: userId,
      operation_detail: {
        new_status: status,
        reason: options.reason
      },
      transaction
    })
  }
}
```

#### ç¦æ­¢æ¨¡å¼

```javascript
// âŒ ç¦æ­¢ï¼šè´¦å·ç¦ç”¨ä½†ä¸æ–­å¼€è¿æ¥
static async updateUserStatus(userId, status) {
  await User.update({ status }, { where: { user_id: userId } })
  // âŒ ç¼ºå°‘æ–­å¼€è¿æ¥é€»è¾‘
  // ç»“æœï¼šè¢«ç¦ç”¨ç”¨æˆ·ä»å¯æ”¶å‘ WebSocket æ¶ˆæ¯
}
```

#### å®¡æŸ¥æ¸…å•

- [ ] è´¦å·ç¦ç”¨æ˜¯å¦è°ƒç”¨ `disconnectUser()`ï¼Ÿ
- [ ] æ˜¯å¦æ–­å¼€æ‰€æœ‰ç±»å‹çš„è¿æ¥ï¼ˆuser + adminï¼‰ï¼Ÿ
- [ ] æ–­è¿å¤±è´¥æ˜¯å¦è®°å½•æ—¥å¿—ï¼ˆä¸å½±å“ä¸»æµç¨‹ï¼‰ï¼Ÿ
- [ ] ç”¨æˆ·æ˜¯å¦éœ€è¦é‡æ–°è¿æ¥å¹¶é€šè¿‡JWTé‰´æƒï¼Ÿ

---

## å…«ã€ä»£ç åˆè§„å·®å¼‚æ¸…å•ï¼ˆä»¥å½“å‰ä»£ç ä¸ºå‡†ï¼‰

### 8.1 è¯´æ˜

- æœ¬èŠ‚**ä¸ä½¿ç”¨è¡Œå·**ï¼ˆè¡Œå·ä¼šéšä»£ç å˜åŠ¨è€Œå¤±çœŸï¼‰
- â€œä½ç½®â€åªç”¨**æ–‡ä»¶ + å…³é”®æ ‡è¯†**ï¼ˆå‡½æ•°å/ä¸­é—´ä»¶/è·¯ç”±åï¼‰ç¡®ä¿ç¨³å®šå®šä½

### 8.2 æœ€è¿‘ä¸€æ¬¡å¯¹é½ç»“æœï¼ˆ2025-12-18ï¼‰

ä»¥ä¸‹é—®é¢˜å·²åœ¨å½“å‰ä»£ç ä¸­å®Œæˆå¯¹é½ï¼š

- âœ… **404 å“åº”è¡¥é½å¿…éœ€å­—æ®µ**ï¼š`app.js` â†’ `app.use('*', ...)` å·²åŒ…å« `version` ä¸ `request_id`
- âœ… **å…¨å±€é”™è¯¯å¤„ç†ç»Ÿä¸€æ ¼å¼**ï¼š`app.js` â†’ `app.use((error, req, res, _next) => ...)` å·²ä½¿ç”¨ `ApiResponse.error()` å¹¶è¡¥é½ `request_id`
- âœ… **/health é¡¶å±‚ timestamp**ï¼š`app.js` â†’ `app.get('/health', ...)` å·²å°† `timestamp` æ”¾åœ¨é¡¶å±‚ï¼ˆç›‘æ§æ ‡å‡†ï¼‰
- âœ… **request_id å…¨é“¾è·¯**ï¼š`utils/ApiResponse.js` â†’ `middleware()` å·²å†™å…¥ `req.id` å¹¶å›ä¼  `X-Request-ID`
- âœ… **é™æµ httpStatus åˆæ³•åŒ–**ï¼š`middleware/RateLimiterMiddleware.js` å·²ä¿®æ­£ `httpStatus` ä¸ºåˆæ³•å€¼ï¼ˆ429ï¼‰
- âœ… **æƒé™ç¼“å­˜å¤±æ•ˆå®¡è®¡**ï¼š`middleware/auth.js` â†’ `invalidateUserPermissions(...)` åœ¨æä¾› `operator_id` æ—¶ä¼šè®°å½•å®¡è®¡ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰

---

## ä¹ã€è§„èŒƒæ‰§è¡Œä¼˜å…ˆçº§è¯´æ˜

### 9.1 è§„èŒƒåˆ†çº§ä½“ç³»ï¼ˆP0/P1/P2ï¼‰

#### ğŸ”´ P0 - æ ¸å¿ƒå¼ºåˆ¶è§„èŒƒï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰

**å®šä¹‰**ï¼šæ¶‰åŠå®‰å…¨ã€æ•°æ®ä¸€è‡´æ€§ã€èµ„äº§å˜æ›´çš„å¼ºåˆ¶çº¦æŸã€‚

**é€‚ç”¨åœºæ™¯**ï¼š

- ç§¯åˆ†/åº“å­˜/è®¢å•çŠ¶æ€å˜æ›´
- ç”¨æˆ·æƒé™/æ•æ„Ÿé…ç½®ä¿®æ”¹
- WebSocketèº«ä»½éªŒè¯
- å¹‚ç­‰æ€§æ§åˆ¶

**å¼ºåˆ¶è¦æ±‚**ï¼š

- âœ… æ‰€æœ‰æ–°ä»£ç å¿…é¡»éµå®ˆ
- âœ… å­˜é‡ä»£ç é«˜é£é™©è·¯å¾„å¿…é¡»ç«‹å³ä¿®å¤
- âœ… PR å®¡æŸ¥å¿…é¡»æ£€æŸ¥ P0 æ¸…å•
- âŒ ä¸å¾—ä»¥"å…¼å®¹æ€§"ä¸ºç”±è·³è¿‡

**P0 è§„èŒƒåˆ—è¡¨**ï¼š

1. APIå“åº”æ ¼å¼ç»Ÿä¸€ï¼ˆ1.1ï¼‰
2. HTTPçŠ¶æ€ç ä¸ä¸šåŠ¡ç åˆ†ç¦»ï¼ˆ1.2ï¼‰
3. å¥åº·æ£€æŸ¥çœŸå®æ€§ï¼ˆ2.1ï¼‰
4. ç¯å¢ƒå˜é‡ä¸¥æ ¼æ¨¡å¼ï¼ˆ3.1ï¼‰
5. WebSocketæ¡æ‰‹JWTé‰´æƒï¼ˆ4.1ï¼‰
6. æœåŠ¡ç«¯åˆ¤å®šèº«ä»½ï¼ˆ4.2ï¼‰
7. WebSocket CORSç™½åå•ï¼ˆ4.3ï¼‰
8. åŒè½¨æ¶æ„ç¦æ­¢å­˜åœ¨ï¼ˆ5.1ï¼‰
9. **è¿ç§»åŒè½¨å¼ºåˆ¶æ¸…ç†ï¼ˆ5.2ï¼‰**
10. **çœŸç›¸è¡¨å”¯ä¸€æ¥æºï¼ˆ5.3ï¼‰**
11. å¹‚ç­‰é”®æ•°æ®åº“å”¯ä¸€çº¦æŸï¼ˆ6.1ï¼‰

---

#### ğŸŸ¡ P1 - é‡è¦å»ºè®®è§„èŒƒï¼ˆæ–°ä»£ç æ¨èï¼‰

**å®šä¹‰**ï¼šå½±å“æ€§èƒ½ã€è¿ç»´ã€æ’éšœæ•ˆç‡çš„å»ºè®®è§„èŒƒã€‚

**é€‚ç”¨åœºæ™¯**ï¼š

- æ—¥å¿—ç³»ç»Ÿ
- é…ç½®ç®¡ç†
- æ€§èƒ½ä¼˜åŒ–
- ç¼“å­˜ä¸€è‡´æ€§

**æ‰§è¡Œè¦æ±‚**ï¼š

- âœ… æ–°ä»£ç æ¨èéµå®ˆ
- âœ… å­˜é‡ä»£ç æ¸è¿›ä¼˜åŒ–
- âš ï¸ ä¸éµå®ˆéœ€è¯´æ˜ç†ç”±

**P1 è§„èŒƒåˆ—è¡¨**ï¼š

1. è°ƒç”¨æ–¹å¼æ ‡å‡†åŒ–ï¼ˆ1.3ï¼‰
2. ç»“æ„åŒ–æ—¥å¿—ï¼ˆ2.2ï¼‰
3. request_idå…¨é“¾è·¯è¿½è¸ªï¼ˆ2.3ï¼‰
4. é…ç½®æ ¡éªŒå¼ºåˆ¶æ‰§è¡Œï¼ˆ3.2ï¼‰
5. æ•°æ®åº“é…ç½®å»¶è¿Ÿæ ¡éªŒï¼ˆ3.3ï¼‰
6. æ—§æ¥å£åºŸå¼ƒæµç¨‹ï¼ˆ5.2ï¼‰
7. å¤–é”®çº¦æŸå’Œç´¢å¼•ï¼ˆ5.3ï¼‰
8. å¹‚ç­‰é”®æœåŠ¡ç«¯æ´¾ç”Ÿï¼ˆ6.2ï¼‰
9. äº‹åŠ¡è¾¹ç•Œæ¸…æ™°ï¼ˆ6.3ï¼‰
10. æ‚²è§‚é”ç´¢å¼•æ”¯æŒï¼ˆ6.4ï¼‰
11. ç¦æ­¢N+1æŸ¥è¯¢ï¼ˆ7.1ï¼‰
12. Redis SCANæ›¿ä»£KEYSï¼ˆ7.2ï¼‰
13. æƒé™ç¼“å­˜å¤±æ•ˆï¼ˆ8.1ï¼‰
14. è´¦å·ç¦ç”¨æ–­è¿ï¼ˆ8.2ï¼‰

---

#### ğŸŸ¢ P2 - å¯é€‰æ•´ç†è§„èŒƒï¼ˆéå¼ºåˆ¶ï¼‰

**å®šä¹‰**ï¼šä»£ç æ•´ç†ã€æŠ€æœ¯å€ºåŠ¡æ¸…ç†ç­‰éåŠŸèƒ½æ€§æ”¹è¿›ã€‚

**é€‚ç”¨åœºæ™¯**ï¼š

- æ…¢æŸ¥è¯¢ä¼˜åŒ–
- ç´¢å¼•æŒç»­ä¼˜åŒ–
- æ–‡æ¡£å®Œå–„

**æ‰§è¡Œè¦æ±‚**ï¼š

- âš ï¸ ä¸å¾—å‰Šå¼±P0/P1è§„èŒƒ
- âš ï¸ ä¸å¾—å¼•å…¥æ–°çš„å¤æ‚åº¦

**P2 è§„èŒƒåˆ—è¡¨**ï¼š

1. æ…¢æŸ¥è¯¢ç›‘æ§ï¼ˆ7.3ï¼‰

---

#
