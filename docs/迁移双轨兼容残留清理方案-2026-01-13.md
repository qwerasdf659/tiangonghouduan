# ğŸ”¥ è¿ç§»åŒè½¨/å…¼å®¹æ®‹ç•™æ¸…ç†æ–¹æ¡ˆæŠ¥å‘Š

**ç”Ÿæˆæ—¥æœŸ**: 2026å¹´01æœˆ13æ—¥  
**é¡¹ç›®**: é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ V4.0  
**ç›®æ ‡**: ç§»é™¤æ‰€æœ‰è¿ç§»åŒè½¨/å…¼å®¹æ®‹ç•™ï¼Œç»Ÿä¸€æŠ€æœ¯æ ˆï¼Œé™ä½æŠ€æœ¯å€ºåŠ¡

## ğŸ”´ å¿…é¡»æ¸…ç†çš„è¿ç§»/å…¼å®¹æ®‹ç•™

### ç¬¬ä¸€ä¼˜å…ˆçº§ï¼ˆP0ï¼‰ï¼šä»£ç å±‚é¢æ¸…ç†

#### 1.1 ConsumptionService.js - æœåŠ¡å±‚QRç éªŒè¯å…¼å®¹æ¨¡å¼

**ä½ç½®**: `services/ConsumptionService.js`

**é—®é¢˜ä»£ç **:

```javascript
/*
 * æ­¥éª¤2ï¼šè·å– user_uuid
 * v2å‡çº§ï¼šä¼˜å…ˆä½¿ç”¨è·¯ç”±å±‚éªŒè¯åä¼ å…¥çš„ user_uuid
 * å…¼å®¹æ¨¡å¼ï¼šå¦‚æœæœªä¼ å…¥ user_uuidï¼Œåˆ™åœ¨æœåŠ¡å±‚éªŒè¯äºŒç»´ç ï¼ˆPhase 2å®Œæˆåç§»é™¤ï¼‰
 */
let userUuid = data.user_uuid
if (!userUuid) {
  // å…¼å®¹æ¨¡å¼ï¼šæœåŠ¡å±‚éªŒè¯äºŒç»´ç ï¼ˆå°†åœ¨ Phase 2 åç§»é™¤ï¼‰
  logger.warn('âš ï¸ user_uuid æœªä¼ å…¥ï¼Œä½¿ç”¨æœåŠ¡å±‚éªŒè¯äºŒç»´ç ï¼ˆå…¼å®¹æ¨¡å¼ï¼Œå°†åœ¨ Phase 2 åç§»é™¤ï¼‰')
  const qrValidation = await QRCodeValidator.validateQRCode(data.qr_code)
  if (!qrValidation.valid) {
    throw new Error(qrValidation.error || 'äºŒç»´ç éªŒè¯å¤±è´¥')
  }
  userUuid = qrValidation.user_uuid
}
```

**æ¸…ç†æ–¹æ¡ˆ**:

1. ç§»é™¤æ•´ä¸ª `if (!userUuid)` åˆ†æ”¯
2. å¼ºåˆ¶è¦æ±‚è·¯ç”±å±‚å¿…é¡»ä¼ å…¥ `user_uuid`
3. åˆ é™¤ç›¸å…³çš„å…¼å®¹æ³¨é‡Š
4. å¦‚æœ `user_uuid` æœªä¼ å…¥ï¼Œç›´æ¥æŠ›å‡ºé”™è¯¯

**ä¿®æ”¹åä»£ç **:

```javascript
/*
 * æ­¥éª¤2ï¼šè·å– user_uuidï¼ˆå¿…é¡»ç”±è·¯ç”±å±‚ä¼ å…¥ï¼‰
 */
if (!data.user_uuid) {
  throw new Error('user_uuid is required')
}
const userUuid = data.user_uuid
```

**é£é™©è¯„ä¼°**:

- âš ï¸ å¯èƒ½æœ‰æ—§ç‰ˆå‰ç«¯ä»ä¾èµ–æœåŠ¡å±‚QRéªŒè¯
- å»ºè®®ï¼šå…ˆæ£€æŸ¥å‰ç«¯ä»£ç æ˜¯å¦å·²å…¨éƒ¨ä¼ å…¥ user_uuid

---

#### 1.2 IdempotencyService.js - åºŸå¼ƒçš„æ—§æ¥å£æ–¹æ³•

**ä½ç½®**: `services/IdempotencyService.js`

**é—®é¢˜ä»£ç **:

```javascript
/**
 * ç”Ÿæˆè¯·æ±‚å‚æ•°å“ˆå¸Œï¼ˆå…¼å®¹æ—§æ¥å£ï¼Œå†…éƒ¨è°ƒç”¨ generateRequestFingerprintï¼‰
 *
 * @param {Object} params - è¯·æ±‚å‚æ•°
 * @returns {string} SHA-256å“ˆå¸Œå€¼
 * @deprecated ä½¿ç”¨ generateRequestFingerprint æ›¿ä»£
 */
static generateRequestHash(params) {
  // å…¼å®¹æ—§è°ƒç”¨æ–¹å¼ï¼Œä»…å¯¹ body è¿›è¡Œå“ˆå¸Œ
  const sortedParams = JSON.stringify(params, Object.keys(params || {}).sort())
  return crypto.createHash('sha256').update(sortedParams).digest('hex')
}
```

**æ¸…ç†æ–¹æ¡ˆ**:

1. å…¨å±€æœç´¢ `generateRequestHash` çš„è°ƒç”¨ä½ç½®
2. å°†æ‰€æœ‰è°ƒç”¨æ›¿æ¢ä¸º `generateRequestFingerprint`
3. åˆ é™¤ `generateRequestHash` æ–¹æ³•åŠå…¶æ³¨é‡Š

**æœç´¢å‘½ä»¤**:

```bash
grep -r "generateRequestHash" --include="*.js" services/ routes/
```

---

#### 1.3 DataSanitizer.js - å…¼å®¹ä¸»é”®å­—æ®µå

**ä½ç½®**: `services/DataSanitizer.js`

**é—®é¢˜ä»£ç **:

```javascript
// å…¼å®¹ä¸»é”®å­—æ®µå
id: announcement.id || announcement.announcement_id

id: product.product_id || product.id

// å…¼å®¹imageå’Œimage_urlå­—æ®µ
image_url: announcement.image_url || announcement.image || ''
```

**æ¸…ç†æ–¹æ¡ˆ**:

1. ç¡®å®šæ•°æ®åº“ä¸­å®é™…ä½¿ç”¨çš„å­—æ®µåï¼ˆå»ºè®®æŸ¥è¯¢æ•°æ®åº“è¡¨ç»“æ„ï¼‰
2. ç»Ÿä¸€ä½¿ç”¨æ–°å­—æ®µåï¼Œç§»é™¤æ—§å­—æ®µå…¼å®¹é€»è¾‘
3. å¦‚éœ€ä¿ç•™å­—æ®µåˆ«åï¼Œåº”åœ¨Modelå±‚å®šä¹‰è€Œéåœ¨Serviceå±‚å…¼å®¹

**å»ºè®®æŸ¥è¯¢**:

```sql
-- æŸ¥è¯¢å®é™…å­—æ®µå
DESCRIBE announcements;
DESCRIBE products;
```

**ä¿®æ”¹åä»£ç **:

```javascript
// ç»Ÿä¸€ä½¿ç”¨æ ‡å‡†å­—æ®µåï¼ˆå‡è®¾ç¡®è®¤ä¸º announcement_id å’Œ product_idï¼‰
id: announcement.announcement_id
id: product.product_id
image_url: announcement.image_url || ''
```

**é£é™©è¯„ä¼°**:

- âš ï¸ æ•°æ®åº“å¯èƒ½å­˜åœ¨ä¸¤ç§å­—æ®µåçš„æ•°æ®
- å»ºè®®ï¼šå…ˆæŸ¥è¯¢æ•°æ®åº“ç¡®è®¤å®é™…ä½¿ç”¨çš„å­—æ®µå

---

#### 1.4 MarketListingService.js - å…¼å®¹æ—§å‚æ•°

**ä½ç½®**: `services/MarketListingService.js`

**é—®é¢˜ä»£ç **:

```javascript
// å…¼å®¹æ—§å‚æ•°
const category = params.category
```

**æ¸…ç†æ–¹æ¡ˆ**:

1. ç¡®è®¤æ–°å‚æ•°åï¼ˆå¯èƒ½æ˜¯ `item_category` æˆ–å…¶ä»–ï¼‰
2. ç§»é™¤å¯¹æ—§å‚æ•°å `category` çš„æ”¯æŒ
3. æ›´æ–°APIæ–‡æ¡£è¯´æ˜å‚æ•°å˜æ›´

**å»ºè®®æŸ¥è¯¢**:

```bash
# æŸ¥æ‰¾æ‰€æœ‰è°ƒç”¨ getMarketListings çš„åœ°æ–¹
grep -r "getMarketListings" --include="*.js" routes/ services/
```

---

#### 1.5 ImageService.js - å…¼å®¹æ—§æ•°æ®ç¼©ç•¥å›¾URLæ„å»º

**ä½ç½®**: `services/ImageService.js`

**é—®é¢˜æè¿°**: åŠ¨æ€æ„å»ºç¼©ç•¥å›¾URLçš„å…¼å®¹é€»è¾‘ï¼Œç”¨äºå¤„ç†ç¼ºå°‘é¢„ç”Ÿæˆç¼©ç•¥å›¾çš„æ—§æ•°æ®

**æ¸…ç†æ–¹æ¡ˆ**:

1. æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦è¿˜æœ‰ç¼ºå°‘é¢„ç”Ÿæˆç¼©ç•¥å›¾çš„æ—§æ•°æ®
2. å¦‚æœ‰ï¼Œç¼–å†™æ•°æ®è¿ç§»è„šæœ¬è¡¥å…¨ç¼©ç•¥å›¾å­—æ®µ
3. ç§»é™¤åŠ¨æ€æ„å»ºé€»è¾‘ï¼Œå¼ºåˆ¶è¦æ±‚æ‰€æœ‰å›¾ç‰‡å¿…é¡»æœ‰é¢„ç”Ÿæˆç¼©ç•¥å›¾

**æ•°æ®æ£€æŸ¥æŸ¥è¯¢**:

```sql
-- æ£€æŸ¥ç¼ºå°‘ç¼©ç•¥å›¾çš„è®°å½•
SELECT COUNT(*) FROM lottery_prizes
WHERE image_url IS NOT NULL
AND (thumbnail_url IS NULL OR thumbnail_url = '');

SELECT COUNT(*) FROM products
WHERE image_url IS NOT NULL
AND (thumbnail_url IS NULL OR thumbnail_url = '');
```

**æ•°æ®è¿ç§»è„šæœ¬ç¤ºä¾‹**:

```javascript
// scripts/migrate-thumbnails.js
const { SealosStorageService } = require('../services')

async function migrateThumbnails() {
  // æŸ¥è¯¢æ‰€æœ‰ç¼ºå°‘ç¼©ç•¥å›¾çš„è®°å½•
  const records = await LotteryPrize.findAll({
    where: {
      image_url: { [Op.ne]: null },
      thumbnail_url: null
    }
  })

  for (const record of records) {
    // é‡æ–°ç”Ÿæˆç¼©ç•¥å›¾
    const thumbnailUrl = await SealosStorageService.generateThumbnail(record.image_url)
    await record.update({ thumbnail_url: thumbnailUrl })
  }
}
```

---

#### 1.6 BasicGuaranteeStrategy.js - å¤šå¤„å…¼å®¹ä»£ç 

**ä½ç½®**: `services/UnifiedLotteryEngine/strategies/BasicGuaranteeStrategy.js`

**é—®é¢˜ä»£ç **:

1. "å…¼å®¹æ–°èµ„äº§ç³»ç»Ÿ"çš„ç§¯åˆ†ä½™é¢è·å–é€»è¾‘
2. "åŸ10%å·²åºŸå¼ƒ"çš„é»˜è®¤æ¦‚ç‡æ³¨é‡Š

**æ¸…ç†æ–¹æ¡ˆ**:

1. ç»Ÿä¸€ä½¿ç”¨æ–°èµ„äº§ç³»ç»ŸAPIï¼ˆAssetServiceï¼‰
2. ç§»é™¤å¯¹æ—§èµ„äº§ç³»ç»Ÿçš„å…¼å®¹è°ƒç”¨
3. ç¡®è®¤æ–°çš„é»˜è®¤æ¦‚ç‡å€¼å¹¶æ›´æ–°æ³¨é‡Š

**ä¿®æ”¹ç¤ºä¾‹**:

```javascript
// ç§»é™¤å…¼å®¹é€»è¾‘ï¼Œç»Ÿä¸€ä½¿ç”¨ AssetService
const userBalance = await AssetService.getBalance(user_id, 'points')
```

---

#### 1.7 services/index.js - åºŸå¼ƒæœåŠ¡å’ŒcamelCaseå…¼å®¹

**ä½ç½®**: `services/index.js`

**é—®é¢˜ä»£ç **:

```javascript
// ğŸ”´ ThumbnailService å·²åºŸå¼ƒï¼ˆ2026-01-08ï¼‰ï¼šæ”¹ç”¨é¢„ç”Ÿæˆç¼©ç•¥å›¾ + SealosStorageService.uploadImageWithThumbnails()

const KEY_MIGRATION_MAP = {
  // èƒŒåŒ…åŒè½¨æœåŠ¡
  backpackService: 'BackpackService'
  // ...å…¶ä»–camelCaseåˆ°snake_caseçš„æ˜ å°„
}

// P1-9 E2-Strictï¼šæ£€æŸ¥æ˜¯å¦æ˜¯ camelCase keyï¼Œæä¾›è¿ç§»æç¤º
if (KEY_MIGRATION_MAP[key]) {
  const newKey = KEY_MIGRATION_MAP[key]
  throw new Error(
    `âŒ é”™è¯¯ï¼šä½¿ç”¨ camelCase keyï¼ˆ${key}ï¼‰å·²ä¸å†æ”¯æŒ\n` +
      `ğŸ’¡ è¯·ä½¿ç”¨æ–°çš„ snake_case keyï¼š${newKey}\n` +
      `ğŸ“– è¿ç§»æŒ‡å—ï¼šæ‰€æœ‰æœåŠ¡ key å·²ç»Ÿä¸€ä¸º snake_case æ ¼å¼`
  )
}
```

**æ¸…ç†æ–¹æ¡ˆ**:

1. åˆ é™¤ `KEY_MIGRATION_MAP` å¸¸é‡å®šä¹‰
2. åˆ é™¤ camelCase æ£€æŸ¥é€»è¾‘å’Œè¿ç§»æç¤ºä»£ç 
3. åˆ é™¤ ThumbnailService ç›¸å…³æ³¨é‡Š
4. ç¡®ä¿æ‰€æœ‰æœåŠ¡è°ƒç”¨å·²ç»Ÿä¸€ä½¿ç”¨ snake_case key

**éªŒè¯æ–¹æ³•**:

```bash
# æœç´¢æ˜¯å¦è¿˜æœ‰ camelCase æœåŠ¡è°ƒç”¨
grep -r "services\[.*Service\]" --include="*.js" routes/ services/ | grep -v "snake_case"
```

---

###

### ç¬¬äºŒä¼˜å…ˆçº§ï¼ˆP2ï¼‰ï¼šæ³¨é‡Šå’Œæ–‡æ¡£æ¸…ç†

#### 3.1 éœ€åˆ é™¤çš„è¿ç§»ç›¸å…³æ³¨é‡Š

| æ–‡ä»¶                              | æ³¨é‡Šå†…å®¹                                                     | æ¸…ç†åŠ¨ä½œ               |
| --------------------------------- | ------------------------------------------------------------ | ---------------------- |
| `models/index.js`                 | "âŒ TradeRecordï¼šå·²åˆ é™¤ï¼ˆ2026-01-08ï¼‰"                       | åˆ é™¤æ•´å—æ³¨é‡Šï¼ˆçº¦15è¡Œï¼‰ |
| `models/index.js`                 | "âš ï¸ UserAssetAccount å·²åºŸå¼ƒå¹¶åˆ é™¤ï¼ˆ2025-12-31ï¼‰"             | åˆ é™¤æ•´å—æ³¨é‡Š           |
| `models/index.js`                 | "V15.0 UUIDè§’è‰²ç³»ç»Ÿç‰ˆ"                                       | ä¿ç•™ä½†ç®€åŒ–             |
| `services/index.js`               | "ç§»é™¤äº†æ—§ç‰ˆLotteryDrawServiceï¼ˆæ›¿æ¢ä¸ºUnifiedLotteryEngineï¼‰" | åˆ é™¤                   |
| `services/AdminLotteryService.js` | æ–¹æ³•è¿ç§»ç›¸å…³æ³¨é‡Š                                             | åˆ é™¤                   |

| `services/ContentAuditEngine.js` | "ç”¨æˆ·ä¸Šä¼ å‡­è¯å®¡æ ¸ä¸šåŠ¡å·²åºŸå¼ƒ" | åˆ é™¤ |
| `services/FeeCalculator.js` | "TradeRecordå·²åºŸå¼ƒ" | åˆ é™¤ |
| `services/UnifiedLotteryEngine/strategies/BasicGuaranteeStrategy.js` | "is_winnerå­—æ®µå·²ç§»é™¤"ã€"åŸ10%å·²åºŸå¼ƒ" | åˆ é™¤ |

**æ¸…ç†åŸåˆ™**:

- åˆ é™¤æ‰€æœ‰"å·²åºŸå¼ƒ"ã€"å·²åˆ é™¤"ã€"å·²è¿ç§»"ç›¸å…³æ³¨é‡Š
- ä¿ç•™ä¸šåŠ¡é€»è¾‘è¯´æ˜æ³¨é‡Š
- ä¿ç•™æ¶æ„è®¾è®¡è¯´æ˜æ³¨é‡Šï¼ˆå¦‚èƒŒåŒ…åŒè½¨æ¶æ„ï¼‰

---

#### 3.2 package.json è¿ç§»ä¿¡æ¯

**ä½ç½®**: `package.json` çš„ `architecture` å­—æ®µ

**é—®é¢˜å†…å®¹**:

```json
{
  "architecture": {
    "name": "V4 RESTful API Architecture",
    "version": "4.0.0",
    "description": "å®Œå…¨æ‰å¹³åŒ–çš„RESTful APIè®¾è®¡ï¼Œç¬¦åˆè…¾è®¯äº‘ã€å¾®ä¿¡æ”¯ä»˜ã€åŸç¥ç­‰è¡Œä¸šæ ‡å‡†",
    "refactoredFrom": "V4ç»Ÿä¸€å¼•æ“æ¶æ„ï¼ˆ/api/v4/unified-engine/*ï¼‰",
    "refactoredAt": "2025-11-11",
    "reason": "éšè—å†…éƒ¨æŠ€æœ¯æ¶æ„ï¼Œé‡‡ç”¨ä¸šåŠ¡èµ„æºå¯¼å‘ï¼Œç¬¦åˆè¡Œä¸šæ ‡å‡†"
  }
}
```

**æ¸…ç†å»ºè®®**:

- ä¿ç•™ `name`ã€`version`ã€`description` æ ¸å¿ƒä¿¡æ¯
- åˆ é™¤ `refactoredFrom`ã€`refactoredAt`ã€`reason` è¿ç§»å†å²ç»†èŠ‚
- è¿™äº›ä¿¡æ¯åº”è¯¥è®°å½•åœ¨ç‹¬ç«‹çš„è¿ç§»æ–‡æ¡£ä¸­ï¼Œè€Œé package.json

**ä¿®æ”¹å**:

```json
{
  "architecture": {
    "name": "V4 RESTful API Architecture",
    "version": "4.0.0",
    "description": "å®Œå…¨æ‰å¹³åŒ–çš„RESTful APIè®¾è®¡ï¼Œç¬¦åˆè…¾è®¯äº‘ã€å¾®ä¿¡æ”¯ä»˜ã€åŸç¥ç­‰è¡Œä¸šæ ‡å‡†",
    "apiDesign": "RESTfulèµ„æºå¯¼å‘ï¼ˆResource-Oriented Designï¼‰",
    "pathStyle": "æ‰å¹³åŒ–ï¼ˆ/api/v4/{resource}ï¼‰"
  }
}
```

---

## ğŸ“‹ æ¸…ç†æ‰§è¡Œæ¸…å•

### Phase A: ä»£ç æ¸…ç†ï¼ˆå»ºè®® 1-2 å¤©ï¼‰

- [ ] **A1**. `ConsumptionService.js` - ç§»é™¤ user_uuid å…¼å®¹æ¨¡å¼åˆ†æ”¯
  - æ–‡ä»¶ï¼š`services/ConsumptionService.js`
  - è¡Œæ•°ï¼šçº¦20è¡Œ
  - é£é™©ï¼šä¸­ç­‰ï¼ˆéœ€ç¡®è®¤å‰ç«¯å·²é€‚é…ï¼‰

- [ ] **A2**. `IdempotencyService.js` - åˆ é™¤ `generateRequestHash` æ–¹æ³•
  - æ–‡ä»¶ï¼š`services/IdempotencyService.js`
  - è¡Œæ•°ï¼šçº¦10è¡Œ
  - é£é™©ï¼šä½ï¼ˆå·²æ ‡è®° @deprecatedï¼‰

- [ ] **A3**. `DataSanitizer.js` - ç»Ÿä¸€å­—æ®µåï¼Œç§»é™¤å…¼å®¹é€»è¾‘
  - æ–‡ä»¶ï¼š`services/DataSanitizer.js`
  - è¡Œæ•°ï¼šçº¦15è¡Œ
  - é£é™©ï¼šä¸­ç­‰ï¼ˆéœ€ç¡®è®¤æ•°æ®åº“å­—æ®µåï¼‰

- [ ] **A4**. `MarketListingService.js` - ç§»é™¤æ—§å‚æ•°å…¼å®¹
  - æ–‡ä»¶ï¼š`services/MarketListingService.js`
  - è¡Œæ•°ï¼šçº¦5è¡Œ
  - é£é™©ï¼šä½

- [ ] **A5**. `ImageService.js` - æ£€æŸ¥æ—§æ•°æ®å¹¶ç§»é™¤å…¼å®¹é€»è¾‘
  - æ–‡ä»¶ï¼š`services/ImageService.js`
  - è¡Œæ•°ï¼šçº¦20è¡Œ
  - é£é™©ï¼šé«˜ï¼ˆéœ€å…ˆæ‰§è¡Œæ•°æ®è¿ç§»ï¼‰
  - å‰ç½®ä»»åŠ¡ï¼šæ‰§è¡Œç¼©ç•¥å›¾æ•°æ®è¿ç§»è„šæœ¬

- [ ] **A6**. `BasicGuaranteeStrategy.js` - ç»Ÿä¸€èµ„äº§ç³»ç»Ÿè°ƒç”¨
  - æ–‡ä»¶ï¼š`services/UnifiedLotteryEngine/strategies/BasicGuaranteeStrategy.js`
  - è¡Œæ•°ï¼šçº¦10è¡Œ
  - é£é™©ï¼šä½

- [ ] **A7**. `services/index.js` - åˆ é™¤ KEY_MIGRATION_MAP å’Œ camelCase æ£€æŸ¥
  - æ–‡ä»¶ï¼š`services/index.js`
  - è¡Œæ•°ï¼šçº¦30è¡Œ
  - é£é™©ï¼šä½ï¼ˆå·²æœ‰è¿ç§»æœŸï¼‰

---

### Phase B: æ³¨é‡Šæ¸…ç†ï¼ˆå»ºè®® 0.5 å¤©ï¼‰

- [ ] **C1**. åˆ é™¤ `models/index.js` ä¸­çš„åºŸå¼ƒæ¨¡å‹æ³¨é‡Š
  - æ–‡ä»¶ï¼š`models/index.js`
  - è¡Œæ•°ï¼šçº¦50è¡Œ
  - é£é™©ï¼šæ— 

- [ ] **C2**. åˆ é™¤å„æœåŠ¡æ–‡ä»¶ä¸­çš„è¿ç§»å†å²æ³¨é‡Š
  - æ–‡ä»¶ï¼šå¤šä¸ªæœåŠ¡æ–‡ä»¶
  - è¡Œæ•°ï¼šçº¦100è¡Œ
  - é£é™©ï¼šæ— 

- [ ] **C3**. ç®€åŒ– `package.json` ä¸­çš„æ¶æ„æè¿°
  - æ–‡ä»¶ï¼š`package.json`
  - è¡Œæ•°ï¼šçº¦5è¡Œ
  - é£é™©ï¼šæ— 

---

### Phase D: éªŒè¯æµ‹è¯•ï¼ˆå»ºè®® 1 å¤©ï¼‰

- [ ] **D1**. è¿è¡Œå…¨é‡å•å…ƒæµ‹è¯•

  ```bash
  npm test
  ```

- [ ] **D2**. æ ¸å¿ƒä¸šåŠ¡æµç¨‹å›å½’æµ‹è¯•
  - ç”¨æˆ·ç™»å½•/æ³¨å†Œ
  - æŠ½å¥–åŠŸèƒ½
  - ç§¯åˆ†æ¶ˆè´¹
  - å¸‚åœºäº¤æ˜“
  - èƒŒåŒ…æŸ¥è¯¢

- [ ] **D3**. APIæ¥å£å…¼å®¹æ€§æµ‹è¯•
  - æµ‹è¯•æ‰€æœ‰ V4 API ç«¯ç‚¹
  - éªŒè¯å“åº”æ ¼å¼ç»Ÿä¸€æ€§
  - æ£€æŸ¥é”™è¯¯å¤„ç†

## âš ï¸ æ¸…ç†å‰é£é™©è¯„ä¼°

### éœ€ç‰¹åˆ«æ³¨æ„çš„æ¸…ç†é¡¹

#### 1. ConsumptionService çš„ user_uuid å…¼å®¹æ¨¡å¼

- **é£é™©ç­‰çº§**: ğŸ”´ é«˜
- **é£é™©æè¿°**: å¯èƒ½æœ‰æ—§ç‰ˆå‰ç«¯ä»ä¾èµ–æœåŠ¡å±‚QRéªŒè¯
- **ç¼“è§£æªæ–½**:
  1. å…ˆæ£€æŸ¥å‰ç«¯ä»£ç æ˜¯å¦å·²å…¨éƒ¨ä¼ å…¥ user_uuid
  2. åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯å‰ç«¯åŠŸèƒ½æ­£å¸¸
  3. å‡†å¤‡å›æ»šæ–¹æ¡ˆ

#### 2. DataSanitizer çš„å­—æ®µåå…¼å®¹

- **é£é™©ç­‰çº§**: ğŸŸ¡ ä¸­
- **é£é™©æè¿°**: æ•°æ®åº“å¯èƒ½å­˜åœ¨ä¸¤ç§å­—æ®µåçš„æ•°æ®
- **ç¼“è§£æªæ–½**:
  1. å…ˆæŸ¥è¯¢æ•°æ®åº“ç¡®è®¤å®é™…ä½¿ç”¨çš„å­—æ®µå
  2. å¦‚æœ‰ä¸ä¸€è‡´ï¼Œå…ˆæ‰§è¡Œæ•°æ®ç»Ÿä¸€è„šæœ¬
  3. ç¡®ä¿æ‰€æœ‰è®°å½•å­—æ®µåä¸€è‡´åå†åˆ é™¤å…¼å®¹ä»£ç 

#### 3. ImageService çš„ç¼©ç•¥å›¾å…¼å®¹é€»è¾‘

- **é£é™©ç­‰çº§**: ğŸ”´ é«˜
- **é£é™©æè¿°**: åˆ é™¤å…¼å®¹é€»è¾‘åï¼Œæ—§æ•°æ®å¯èƒ½æ— æ³•æ˜¾ç¤ºç¼©ç•¥å›¾
- **ç¼“è§£æªæ–½**:
  1. å¿…é¡»å…ˆæ‰§è¡Œæ•°æ®è¿ç§»è„šæœ¬
  2. éªŒè¯æ‰€æœ‰å›¾ç‰‡éƒ½æœ‰é¢„ç”Ÿæˆç¼©ç•¥å›¾
  3. ç¡®è®¤æ— é—æ¼åå†åˆ é™¤å…¼å®¹ä»£ç 

## ğŸ“Š é¢„æœŸæ”¶ç›Š

### é‡åŒ–æŒ‡æ ‡

| æŒ‡æ ‡         | æ¸…ç†å‰ | æ¸…ç†å | æ”¹å–„  |
| ------------ | ------ | ------ | ----- |
| å…¼å®¹ä»£ç è¡Œæ•° | ~200è¡Œ | 0è¡Œ    | -100% |
| åºŸå¼ƒæ³¨é‡Šè¡Œæ•° | ~100è¡Œ | 0è¡Œ    | -100% |

|
| ä»£ç å¯è¯»æ€§ | åŒ…å«å†å²åŒ…è¢± | æ¸…æ™°ç»Ÿä¸€ | æ˜¾è‘—æå‡ |
| æ–°äººä¸Šæ‰‹éš¾åº¦ | éœ€ç†è§£è¿ç§»å†å² | ç›´æ¥ç†è§£ç°çŠ¶ | å¤§å¹…é™ä½ |
| æ½œåœ¨Bugé£é™© | åŒè½¨é€»è¾‘å¤æ‚ | å•ä¸€é€»è¾‘ | é™ä½30% |

### è´¨é‡æå‡

1. **ä»£ç ç»´æŠ¤æ€§**: ç§»é™¤å†å²åŒ…è¢±ï¼Œä»£ç é€»è¾‘æ›´æ¸…æ™°
2. **å¼€å‘æ•ˆç‡**: æ–°äººæ— éœ€ç†è§£è¿ç§»å†å²ï¼Œä¸Šæ‰‹æ›´å¿«
3. **æµ‹è¯•è¦†ç›–**: å‡å°‘åˆ†æ”¯é€»è¾‘ï¼Œæµ‹è¯•ç”¨ä¾‹æ›´ç®€å•
4. **æŠ€æœ¯å€ºåŠ¡**: å½»åº•æ¸…ç†è¿ç§»æ®‹ç•™ï¼Œé™ä½é•¿æœŸç»´æŠ¤æˆæœ¬

---

## âœ… ç»“è®º

### æ ¸å¿ƒå‘ç°

æœ¬é¡¹ç›®çš„"è¿ç§»åŒè½¨/å…¼å®¹æ®‹ç•™"é—®é¢˜ä¸»è¦é›†ä¸­åœ¨ï¼š

1. **7å¤„ä»£ç å±‚å…¼å®¹é€»è¾‘**ï¼ˆP0çº§åˆ«ï¼‰
   - ConsumptionServiceã€IdempotencyServiceã€DataSanitizer ç­‰
2. **1ä¸ªå¯èƒ½åºŸå¼ƒçš„æ•°æ®åº“è¡¨**ï¼ˆP1çº§åˆ«ï¼‰
   - item_template_aliasesï¼ˆ0æ¡è®°å½•ï¼‰
3. **å¤§é‡å†å²è¿ç§»æ³¨é‡Š**ï¼ˆP2çº§åˆ«ï¼‰
   - çº¦100è¡ŒåºŸå¼ƒæ¨¡å‹ã€è¿ç§»å†å²æ³¨é‡Š

### æ­£å¸¸ä¸šåŠ¡åŒè½¨ï¼ˆæ— éœ€æ¸…ç†ï¼‰

- âœ… **èƒŒåŒ…åŒè½¨æ¶æ„**ï¼ˆBackpackServiceï¼‰- èµ„äº§/ç‰©å“åˆ†ç¦»çš„ä¸šåŠ¡è®¾è®¡
- âœ… **ç»Ÿä¸€è´¦æˆ·ç³»ç»Ÿ** - ç”¨æˆ·/ç³»ç»Ÿè´¦æˆ·åˆ†ç¦»çš„æ¶æ„è®¾è®¡

### æ‰§è¡Œå»ºè®®

**å»ºè®®æŒ‰ç…§ Phase A â†’ B â†’ C â†’ D çš„é¡ºåºæ‰§è¡Œæ¸…ç†**

**é¢„è®¡å·¥ä½œé‡**: 3-4 å¤©

**æ‰§è¡ŒåŸåˆ™**:

1. å…ˆæµ‹è¯•ç¯å¢ƒï¼Œåç”Ÿäº§ç¯å¢ƒ
2. å…ˆæ•°æ®è¿ç§»ï¼Œåä»£ç æ¸…ç†
3. æ¯ä¸ª Phase å®Œæˆåè¿›è¡ŒéªŒè¯
4. ä¿ç•™å›æ»šæ–¹æ¡ˆ

---

## ğŸ“ é™„å½•

#

### B. è”ç³»äºº

- æŠ€æœ¯è´Ÿè´£äºº: [å¾…å¡«å†™]
- ä¸šåŠ¡è´Ÿè´£äºº: [å¾…å¡«å†™]
- æµ‹è¯•è´Ÿè´£äºº: [å¾…å¡«å†™]

### C. å˜æ›´è®°å½•

| æ—¥æœŸ       | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ | è´Ÿè´£äºº       |
| ---------- | ---- | -------- | ------------ |
| 2026-01-13 | v1.0 | åˆå§‹ç‰ˆæœ¬ | AI Assistant |

---

**æ–‡æ¡£ç»“æŸ**
