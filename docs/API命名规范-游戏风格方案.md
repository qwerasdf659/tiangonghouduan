# APIå‘½åè§„èŒƒ - æ¸¸æˆé£æ ¼æ–¹æ¡ˆ

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.3  
> **åˆ›å»ºæ—¶é—´**: 2025-12-22  
> **æœ€åéªŒè¯**: 2025-12-22 22:00ï¼ˆClaudeæ ¸å®ä»£ç ä¸æ•°æ®åº“çœŸå®çŠ¶æ€ï¼‰  
> **é€‚ç”¨é¡¹ç›®**: é¤å…æŠ½å¥–ç³»ç»Ÿï¼ˆrestaurant-lotteryï¼‰  
> **è®¾è®¡ç†å¿µ**: å‚è€ƒ Steamã€BUFFã€ç½‘æ˜“è—å®é˜ç­‰æ¸¸æˆå¹³å°çš„å‘½åè§„èŒƒ

---

## ğŸš¦ é‡æ„è¿›åº¦æ€»è§ˆï¼ˆå®æ—¶çŠ¶æ€ï¼‰

| åˆ†ç±»                      | æ€»ä»»åŠ¡ | âœ… å·²å®Œæˆ | ğŸ”„ è¿›è¡Œä¸­ | âŒ å¾…æ‰§è¡Œ | å®Œæˆç‡ |
| ------------------------- | ------ | --------- | --------- | --------- | ------ |
| **P0-ç´§æ€¥ï¼ˆåˆ é™¤å†—ä½™ï¼‰**   | 1      | 0         | 0         | 1         | 0%     |
| **P0-æ ¸å¿ƒï¼ˆè·¯ç”±é‡æ„ï¼‰**   | 6      | 0         | 0         | 6         | 0%     |
| **P1-ä¼˜åŒ–ï¼ˆå‘½åç»Ÿä¸€ï¼‰**   | 3      | 0         | 0         | 3         | 0%     |
| **P2-æ¸…ç†ï¼ˆæ•°æ®åº“è¿ç§»ï¼‰** | 1      | 0         | 0         | 1         | 0%     |
| **æ€»è®¡**                  | **11** | **0**     | **0**     | **11**    | **0%** |

### ğŸ“ å½“å‰ä»£ç çœŸå®çŠ¶æ€ï¼ˆ2025-12-22 æ ¸å®ï¼‰

| æ£€æŸ¥é¡¹                            | çŠ¶æ€        | è¯¦æƒ…                                   |
| --------------------------------- | ----------- | -------------------------------------- |
| å†—ä½™ç›®å½• `routes/v4/exchange/`    | ğŸ”´ ä»å­˜åœ¨   | 5ä¸ªæ–‡ä»¶ï¼ŒæœªæŒ‚è½½ï¼Œéœ€åˆ é™¤                |
| `/api/v4/market/*` è·¯ç”±           | ğŸ”´ æœªä¿®æ”¹   | ä»æŒ‡å‘B2Cå…‘æ¢ï¼ˆåº”è¿ç§»åˆ°shop/exchangeï¼‰ |
| `/api/v4/inventory/market/*` è·¯ç”± | ğŸ”´ æœªä¿®æ”¹   | ä»æ˜¯C2Cäº¤æ˜“ï¼ˆåº”ç‹¬ç«‹ä¸º/marketï¼‰         |
| `ExchangeMarketService` å‘½å      | ğŸ”´ æœªé‡å‘½å | åº”ç®€åŒ–ä¸º `ExchangeService`             |
| `RedemptionOrderService` å‘½å     | ğŸ”´ æœªé‡å‘½å | åº”ç®€åŒ–ä¸º `RedemptionService`           |
| `ExchangeMarketRecord` Model      | ğŸ”´ æœªé‡å‘½å | åº”ç®€åŒ–ä¸º `ExchangeRecord`              |
| `exchange_market_records` è¡¨å    | ğŸ”´ æœªè¿ç§»   | åº”è¿ç§»ä¸º `exchange_records`            |

### âœ… å·²å®Œæˆä»»åŠ¡

_æš‚æ— å·²å®Œæˆä»»åŠ¡_

### â³ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³æ‰§è¡Œ**ï¼šåˆ é™¤å†—ä½™ç›®å½• `routes/v4/exchange/`ï¼ˆä»»åŠ¡0-1ï¼‰ï¼Œé£é™©ä½ã€æ”¶ç›Šé«˜
2. **è§„åˆ’æ‰§è¡Œ**ï¼šåˆ¶å®šè·¯ç”±é‡æ„çš„è¯¦ç»†è¿ç§»æ­¥éª¤
3. **åè°ƒå‰ç«¯**ï¼šç¡®è®¤APIè·¯å¾„å˜æ›´åçš„å‰ç«¯é€‚é…æ–¹æ¡ˆ

---

## ğŸ“‹ ç›®å½•

0. [å½“å‰çŠ¶æ€åˆ†æ](#0-å½“å‰çŠ¶æ€åˆ†æ)
   - 0.1 é—®é¢˜ä¸¥é‡æ€§
   - 0.2 å½“å‰ä»£ç ç°çŠ¶ï¼ˆå®é™…çŠ¶æ€ï¼‰
   - 0.3 æ ¸å¿ƒé—®é¢˜æ¸…å•
   - 0.4 å†—ä½™ç›®å½•é—®é¢˜
   - 0.5 ä¸šåŠ¡è¯­ä¹‰å¯¹ç…§
   - 0.6 é‡æ„ç›®æ ‡
1. [å‘½åè§„èŒƒæ¦‚è¿°](#1-å‘½åè§„èŒƒæ¦‚è¿°)
2. [ä¸šåŠ¡åŸŸåˆ’åˆ†](#2-ä¸šåŠ¡åŸŸåˆ’åˆ†)
3. [APIè·¯ç”±è®¾è®¡](#3-apiè·¯ç”±è®¾è®¡)
4. [ç›®å½•ç»“æ„è§„èŒƒ](#4-ç›®å½•ç»“æ„è§„èŒƒ)
5. [Serviceå‘½åè§„èŒƒ](#5-serviceå‘½åè§„èŒƒ)
6. [Modelå‘½åè§„èŒƒ](#6-modelå‘½åè§„èŒƒ)
7. [è¿ç§»æ˜ å°„è¡¨](#7-è¿ç§»æ˜ å°„è¡¨)
8. [å‘½åå¯¹ç…§é€ŸæŸ¥è¡¨](#8-å‘½åå¯¹ç…§é€ŸæŸ¥è¡¨)
9. [é‡æ„æ‰§è¡Œè®¡åˆ’](#9-é‡æ„æ‰§è¡Œè®¡åˆ’)
   - 9.1 é‡æ„ä»»åŠ¡æ¸…å•ï¼ˆå«æ–°å¢ç´§æ€¥ä»»åŠ¡ï¼‰
   - 9.2 å½±å“èŒƒå›´è¯„ä¼°ï¼ˆå«å®é™…ä»£ç çŠ¶æ€ï¼‰
   - 9.3 æ‰§è¡Œç­–ç•¥
   - 9.4 è¿›åº¦è·Ÿè¸ª
   - **æ€»ä½“è¿›åº¦æ¦‚è§ˆ**

---

## 0. å½“å‰çŠ¶æ€åˆ†æ

### 0.1 é—®é¢˜ä¸¥é‡æ€§

**ä¼˜å…ˆçº§**: P0 - æ¶æ„çº§é—®é¢˜ï¼Œå½±å“ä»£ç å¯ç»´æŠ¤æ€§å’Œå›¢é˜Ÿåä½œ

### 0.2 å½“å‰ä»£ç ç°çŠ¶ï¼ˆ2025-12-22 å®é™…éªŒè¯ï¼‰

#### è·¯ç”±ç›®å½•ç»“æ„

```
routes/v4/
â”œâ”€â”€ admin/                    # ç®¡ç†åå°
â”œâ”€â”€ auth/                     # è®¤è¯
â”œâ”€â”€ exchange/                 # âš ï¸ å†—ä½™ç›®å½•ï¼ˆæœªæŒ‚è½½ï¼‰
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ admin-exchange.js
â”‚   â”œâ”€â”€ exchange.js
â”‚   â”œâ”€â”€ orders.js
â”‚   â””â”€â”€ products.js
â”œâ”€â”€ inventory/                # åº“å­˜åŸŸ
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ backpack.js
â”‚   â”œâ”€â”€ inventory-core.js
â”‚   â”œâ”€â”€ inventory.js
â”‚   â””â”€â”€ market/               # C2Cäº¤æ˜“å­è·¯ç”±
â”‚       â”œâ”€â”€ index.js
â”‚       â”œâ”€â”€ buy.js
â”‚       â”œâ”€â”€ listings.js
â”‚       â”œâ”€â”€ manage.js
â”‚       â””â”€â”€ sell.js
â”œâ”€â”€ lottery/                  # æŠ½å¥–åŸŸ
â”œâ”€â”€ market/                   # B2Cå…‘æ¢å¸‚åœº
â”‚   â”œâ”€â”€ index.js
â”‚   â””â”€â”€ exchange/             # B2Cå…‘æ¢å­è·¯ç”±
â”‚       â”œâ”€â”€ index.js
â”‚       â”œâ”€â”€ exchange.js
â”‚       â”œâ”€â”€ items.js
â”‚       â”œâ”€â”€ orders.js
â”‚       â””â”€â”€ statistics.js
â”œâ”€â”€ shop/                     # å•†åŸåŸŸ
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ premium.js
â”‚   â”œâ”€â”€ assets/
â”‚   â”œâ”€â”€ consumption/
â”‚   â”œâ”€â”€ points/
â”‚   â””â”€â”€ redemption/           # æ ¸é”€å­è·¯ç”±
â”œâ”€â”€ system/                   # ç³»ç»Ÿ
â””â”€â”€ user/                     # ç”¨æˆ·
```

#### ä¸‰å¥—"å¸‚åœº"åŠŸèƒ½ç°çŠ¶

| ä¸šåŠ¡åŠŸèƒ½    | APIè·¯ç”±                      | è·¯ç”±æ–‡ä»¶                     | Service                  | Model                                    | è¡¨å                                          |
| ----------- | ---------------------------- | ---------------------------- | ------------------------ | ---------------------------------------- | --------------------------------------------- |
| B2Cå…‘æ¢å¸‚åœº | `/api/v4/market/*`           | `market/exchange/` (å¤šæ–‡ä»¶)  | `ExchangeMarketService`  | `ExchangeItem`<br>`ExchangeMarketRecord` | `exchange_items`<br>`exchange_market_records` |
| C2Cäº¤æ˜“å¸‚åœº | `/api/v4/inventory/market/*` | `inventory/market/` (å¤šæ–‡ä»¶) | `TradeOrderService`      | `MarketListing`<br>`TradeOrder`          | `market_listings`<br>`trade_orders`           |
| æ ¸é”€ç³»ç»Ÿ    | `/api/v4/shop/redemption/*`  | `shop/redemption/` (å¤šæ–‡ä»¶)  | `RedemptionOrderService` | `RedemptionOrder`                        | `redemption_orders`                           |

#### app.js è·¯ç”±æŒ‚è½½ç°çŠ¶

```javascript
app.use('/api/v4/auth', require('./routes/v4/auth'))
app.use('/api/v4/admin', require('./routes/v4/admin'))
app.use('/api/v4/lottery', require('./routes/v4/lottery'))
app.use('/api/v4/inventory', require('./routes/v4/inventory')) // åŒ…å«C2Cäº¤æ˜“åŠŸèƒ½
app.use('/api/v4/market', require('./routes/v4/market')) // å®é™…æ˜¯B2Cå…‘æ¢åŠŸèƒ½
app.use('/api/v4/shop', require('./routes/v4/shop')) // åŒ…å«æ ¸é”€åŠŸèƒ½
app.use('/api/v4/system', require('./routes/v4/system'))
app.use('/api/v4/user', require('./routes/v4/user'))
app.use('/api/v4/debug-control', require('./routes/v4/debug-control'))
```

### 0.3 æ ¸å¿ƒé—®é¢˜æ¸…å•

| é—®é¢˜                        | è¯´æ˜                                                                                  | å½±å“          | éªŒè¯çŠ¶æ€  |
| --------------------------- | ------------------------------------------------------------------------------------- | ------------- | --------- |
| **è·¯ç”± vs ä¸šåŠ¡ä¸åŒ¹é…**      | è·¯ç”±å«`/market/*`ï¼Œå®é™…æ˜¯B2Cå…‘æ¢é€»è¾‘ï¼Œè€ŒéC2Cäº¤æ˜“å¸‚åœº                                 | APIè°ƒç”¨è€…å›°æƒ‘ | âœ… å·²ç¡®è®¤ |
| **ä¸¤ä¸ª"market"å«ä¹‰ä¸åŒ**    | `/api/v4/market/*`æ˜¯B2Cå…‘æ¢ï¼Œ`/api/v4/inventory/market/*`æ˜¯C2Cäº¤æ˜“                    | APIè°ƒç”¨è€…å›°æƒ‘ | âœ… å·²ç¡®è®¤ |
| **Modelå‘½å vs è·¯ç”±ä¸ä¸€è‡´** | `ExchangeMarketRecord`ç”¨äº`/market/`è·¯ç”±ï¼Œ`MarketListing`ç”¨äº`/inventory/market/`è·¯ç”± | ä»£ç ç»´æŠ¤å›°éš¾  | âœ… å·²ç¡®è®¤ |
| **Serviceå‘½åæ··ä¹±**         | `TradeOrderService`æœåŠ¡C2Cäº¤æ˜“ï¼Œä½†è·¯ç”±å«`market`ä¸å«`trade`                           | ä¸šåŠ¡è¯­ä¹‰ä¸æ¸…  | âœ… å·²ç¡®è®¤ |

### 0.4 å†—ä½™ç›®å½•é—®é¢˜

| ç›®å½•                  | çŠ¶æ€          | é—®é¢˜è¯´æ˜                                                              |
| --------------------- | ------------- | --------------------------------------------------------------------- |
| `routes/v4/exchange/` | ğŸ”´ å†—ä½™æœªæŒ‚è½½ | å­˜åœ¨5ä¸ªæ–‡ä»¶ï¼Œä½†æœªåœ¨app.jsæŒ‚è½½ï¼Œä¸`routes/v4/market/exchange/`åŠŸèƒ½é‡å¤ |

**è¯´æ˜**: `routes/v4/trade/` ç›®å½•å·²ä¸å­˜åœ¨ï¼ˆä¹‹å‰å¯èƒ½å·²æ¸…ç†ï¼‰ã€‚

### 0.5 ä¸šåŠ¡è¯­ä¹‰å¯¹ç…§

| ä¸­æ–‡æ¦‚å¿µ        | æ­£ç¡®è‹±æ–‡           | å½“å‰ä»£ç ä½¿ç”¨                                  | é—®é¢˜                 |
| --------------- | ------------------ | --------------------------------------------- | -------------------- |
| å…‘æ¢å¸‚åœºï¼ˆB2Cï¼‰ | `exchange`         | `ExchangeMarketService`ã€`exchange_items`     | âš ï¸ è·¯ç”±ç”¨äº†`market`  |
| äº¤æ˜“å¸‚åœºï¼ˆC2Cï¼‰ | `trade` / `market` | `TradeOrderService`ã€`market_listings`        | âš ï¸ æ··ç”¨tradeå’Œmarket |
| æ ¸é”€            | `redemption`       | `RedemptionOrderService`ã€`redemption_orders` | âœ… ä¸€è‡´              |

### 0.6 é‡æ„ç›®æ ‡

```
å½“å‰çŠ¶æ€                           â†’  ç›®æ ‡çŠ¶æ€
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/api/v4/market/*                   â†’  /api/v4/shop/exchange/*    (B2Cå…‘æ¢)
market/exchange/                   â†’  shop/exchange/
ExchangeMarketService              â†’  ExchangeService

/api/v4/inventory/market/*         â†’  /api/v4/market/*           (C2Cäº¤æ˜“)
inventory/market/                  â†’  market/
TradeOrderService                  â†’  ä¿ç•™ï¼ˆå‘½åæ­£ç¡®ï¼‰

/api/v4/shop/redemption/*          â†’  ä¿æŒä¸å˜                   (æ ¸é”€)

å†—ä½™ç›®å½•                           â†’  åˆ é™¤
routes/v4/exchange/                â†’  åˆ é™¤ï¼ˆæœªæŒ‚è½½ä¸”å†…å®¹ä¸market/exchangeé‡å¤ï¼‰
```

---

## 1. å‘½åè§„èŒƒæ¦‚è¿°

### 1.1 è®¾è®¡åŸåˆ™

| åŸåˆ™         | è¯´æ˜                                    |
| ------------ | --------------------------------------- |
| **è¯­ä¹‰æ¸…æ™°** | å‘½åç›´æ¥åæ˜ ä¸šåŠ¡å«ä¹‰ï¼Œæ— æ­§ä¹‰            |
| **è¡Œä¸šæ ‡å‡†** | å‚è€ƒæ¸¸æˆè¡Œä¸šé€šç”¨å‘½åï¼Œé™ä½å­¦ä¹ æˆæœ¬      |
| **ä¸€è‡´æ€§**   | è·¯ç”±ã€æ–‡ä»¶ã€Serviceã€Model ä½¿ç”¨ç»Ÿä¸€è¯æ±‡ |
| **å¯æ‰©å±•**   | å‘½åç©ºé—´å……è¶³ï¼Œæ”¯æŒæœªæ¥åŠŸèƒ½æ‰©å±•          |

### 1.2 æ ¸å¿ƒå‘½åè¯æ±‡è¡¨

| è‹±æ–‡         | ä¸­æ–‡ | ä¸šåŠ¡å«ä¹‰      | ä½¿ç”¨åœºæ™¯              |
| ------------ | ---- | ------------- | --------------------- |
| `shop`       | å•†åŸ | å®˜æ–¹å”®å–/å…‘æ¢ | B2Cåœºæ™¯ï¼ˆç³»ç»Ÿâ†’ç”¨æˆ·ï¼‰  |
| `market`     | å¸‚åœº | ç”¨æˆ·é—´äº¤æ˜“    | C2Cåœºæ™¯ï¼ˆç”¨æˆ·â†”ç”¨æˆ·ï¼‰ |
| `inventory`  | åº“å­˜ | ç”¨æˆ·æŒæœ‰ç‰©å“  | ç‰©å“å®ä¾‹ç®¡ç†          |
| `lottery`    | æŠ½å¥– | æŠ½å¥–æ´»åŠ¨      | æ¶ˆè€—ç§¯åˆ†æŠ½å¥–          |
| `points`     | ç§¯åˆ† | ç§¯åˆ†èµ„äº§      | ç§¯åˆ†è·å–/æ¶ˆè€—         |
| `assets`     | èµ„äº§ | ææ–™èµ„äº§      | éç‰©å“ç±»èµ„äº§          |
| `exchange`   | å…‘æ¢ | ææ–™æ¢å•†å“    | èµ„äº§å…‘æ¢ç‰©å“          |
| `redemption` | æ ¸é”€ | çº¿ä¸‹å±¥çº¦      | ç‰©å“å®ä¾‹æ ¸é”€          |
| `listing`    | æŒ‚å• | å‡ºå”®æŒ‚å•      | C2Cå–å®¶æŒ‚å•           |
| `order`      | è®¢å• | äº¤æ˜“è®¢å•      | ä¹°å–åŒæ–¹è®¢å•          |

---

## 2. ä¸šåŠ¡åŸŸåˆ’åˆ†

### 2.1 åŸŸåˆ’åˆ†æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        API v4 åŸŸåˆ’åˆ†                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    shop     â”‚   market    â”‚  inventory  â”‚      lottery       â”‚
â”‚   (å•†åŸ)    â”‚   (å¸‚åœº)    â”‚   (åº“å­˜)    â”‚      (æŠ½å¥–)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ B2Cå®˜æ–¹å”®å– â”‚ C2Cç”¨æˆ·äº¤æ˜“ â”‚ ç”¨æˆ·ç‰©å“    â”‚ æŠ½å¥–æ´»åŠ¨           â”‚
â”‚ ææ–™å…‘æ¢    â”‚ æŒ‚å•/è´­ä¹°   â”‚ ç‰©å“è½¬ç§»    â”‚ å¥–æ± ç®¡ç†           â”‚
â”‚ æ ¸é”€ç³»ç»Ÿ    â”‚ äº¤æ˜“è®¢å•    â”‚             â”‚                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 åŸŸèŒè´£å®šä¹‰

| åŸŸåç§°        | èŒè´£                     | å‚ä¸æ–¹            | æ ¸å¿ƒå®ä½“                      |
| ------------- | ------------------------ | ----------------- | ----------------------------- |
| **shop**      | å®˜æ–¹å•†åŸã€ææ–™å…‘æ¢ã€æ ¸é”€ | B2Cï¼ˆç³»ç»Ÿâ†”ç”¨æˆ·ï¼‰ | ExchangeItem, RedemptionOrder |
| **market**    | ç”¨æˆ·é—´äº¤æ˜“å¸‚åœº           | C2Cï¼ˆç”¨æˆ·â†”ç”¨æˆ·ï¼‰ | MarketListing, TradeOrder     |
| **inventory** | ç”¨æˆ·ç‰©å“åº“å­˜ç®¡ç†         | ç”¨æˆ·è‡ªå·±          | ItemInstance                  |
| **lottery**   | æŠ½å¥–æ´»åŠ¨ç®¡ç†             | B2Cï¼ˆç³»ç»Ÿâ†”ç”¨æˆ·ï¼‰ | LotteryPool, LotteryDraw      |
| **points**    | ç§¯åˆ†èµ„äº§ç®¡ç†             | ç”¨æˆ·è‡ªå·±          | UserAssetAccount              |
| **assets**    | ææ–™èµ„äº§ç®¡ç†             | ç”¨æˆ·è‡ªå·±          | UserAssetAccount              |

### 2.3 åŸŸè¾¹ç•Œè§„åˆ™

```
ã€shopåŸŸã€‘å®˜æ–¹å•†åŸ
  â”œâ”€â”€ ç”¨æˆ·ç”¨ææ–™èµ„äº§å…‘æ¢ç³»ç»Ÿå•†å“ â†’ è·å¾—ç‰©å“å®ä¾‹ â†’ è¿›å…¥inventory
  â”œâ”€â”€ ç”¨æˆ·ç”Ÿæˆæ ¸é”€ç  â†’ çº¿ä¸‹æ ¸é”€ â†’ ç‰©å“å®ä¾‹çŠ¶æ€å˜æ›´
  â””â”€â”€ ä¸æ¶‰åŠç”¨æˆ·é—´äº¤æ˜“

ã€marketåŸŸã€‘ç”¨æˆ·å¸‚åœº
  â”œâ”€â”€ ç”¨æˆ·å°†inventoryä¸­çš„ç‰©å“æŒ‚å•å‡ºå”®
  â”œâ”€â”€ å…¶ä»–ç”¨æˆ·è´­ä¹°æŒ‚å• â†’ ç‰©å“å®ä¾‹è½¬ç§»æ‰€æœ‰æƒ
  â””â”€â”€ æ¶‰åŠèµ„äº§å†»ç»“ã€äº¤æ˜“è®¢å•ã€èµ„äº§ç»“ç®—

ã€inventoryåŸŸã€‘ç”¨æˆ·åº“å­˜
  â”œâ”€â”€ æŸ¥çœ‹ç”¨æˆ·æŒæœ‰çš„ç‰©å“å®ä¾‹
  â”œâ”€â”€ ç‰©å“èµ é€/è½¬ç§»
  â””â”€â”€ ä¸æ¶‰åŠäº¤æ˜“é€»è¾‘

ã€lotteryåŸŸã€‘æŠ½å¥–ç³»ç»Ÿ
  â”œâ”€â”€ ç”¨æˆ·æ¶ˆè€—ç§¯åˆ†æŠ½å¥–
  â”œâ”€â”€ ä¸­å¥–åç”Ÿæˆç‰©å“å®ä¾‹ â†’ è¿›å…¥inventory
  â””â”€â”€ å¥–æ± é…ç½®å’ŒæŠ½å¥–è®°å½•
```

---

## 3. APIè·¯ç”±è®¾è®¡

### 3.1 è·¯ç”±æ€»è§ˆ

```
/api/v4/
â”‚
â”œâ”€â”€ shop/                          # ğŸª å•†åŸåŸŸï¼ˆB2Cï¼‰
â”‚   â”œâ”€â”€ exchange/                  # ææ–™å…‘æ¢
â”‚   â”‚   â”œâ”€â”€ GET    /items          # å…‘æ¢å•†å“åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ GET    /items/:id      # å•†å“è¯¦æƒ…
â”‚   â”‚   â””â”€â”€ POST   /execute        # æ‰§è¡Œå…‘æ¢
â”‚   â”‚
â”‚   â””â”€â”€ redemption/                # æ ¸é”€ç³»ç»Ÿ
â”‚       â”œâ”€â”€ POST   /create         # ç”Ÿæˆæ ¸é”€ç 
â”‚       â”œâ”€â”€ POST   /fulfill        # æ‰§è¡Œæ ¸é”€
â”‚       â”œâ”€â”€ GET    /orders         # æ ¸é”€è®¢å•åˆ—è¡¨
â”‚       â””â”€â”€ GET    /orders/:id     # è®¢å•è¯¦æƒ…
â”‚
â”œâ”€â”€ market/                        # ğŸ¬ å¸‚åœºåŸŸï¼ˆC2Cï¼‰
â”‚   â”œâ”€â”€ listings/                  # æŒ‚å•ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ GET    /               # å¸‚åœºæŒ‚å•åˆ—è¡¨ï¼ˆæµè§ˆå¸‚åœºï¼‰
â”‚   â”‚   â”œâ”€â”€ GET    /:id            # æŒ‚å•è¯¦æƒ…
â”‚   â”‚   â”œâ”€â”€ POST   /               # åˆ›å»ºæŒ‚å•ï¼ˆä¸Šæ¶å‡ºå”®ï¼‰
â”‚   â”‚   â”œâ”€â”€ PUT    /:id            # ä¿®æ”¹æŒ‚å•ï¼ˆæ”¹ä»·æ ¼ï¼‰
â”‚   â”‚   â””â”€â”€ DELETE /:id            # å–æ¶ˆæŒ‚å•ï¼ˆä¸‹æ¶ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ orders/                    # äº¤æ˜“è®¢å•
â”‚   â”‚   â”œâ”€â”€ GET    /               # æˆ‘çš„äº¤æ˜“è®¢å•
â”‚   â”‚   â”œâ”€â”€ GET    /:id            # è®¢å•è¯¦æƒ…
â”‚   â”‚   â”œâ”€â”€ POST   /               # è´­ä¹°ä¸‹å•
â”‚   â”‚   â””â”€â”€ POST   /:id/cancel     # å–æ¶ˆè®¢å•
â”‚   â”‚
â”‚   â””â”€â”€ GET /my-listings           # æˆ‘çš„æŒ‚å•åˆ—è¡¨
â”‚
â”œâ”€â”€ inventory/                     # ğŸ’ åº“å­˜åŸŸ
â”‚   â”œâ”€â”€ GET    /items              # æˆ‘çš„ç‰©å“åˆ—è¡¨
â”‚   â”œâ”€â”€ GET    /items/:id          # ç‰©å“è¯¦æƒ…
â”‚   â”œâ”€â”€ POST   /transfer           # ç‰©å“è½¬ç§»/èµ é€
â”‚   â””â”€â”€ GET    /history            # ç‰©å“å˜åŠ¨å†å²
â”‚
â”œâ”€â”€ lottery/                       # ğŸ° æŠ½å¥–åŸŸ
â”‚   â”œâ”€â”€ pools/                     # å¥–æ± ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ GET    /               # å¯ç”¨å¥–æ± åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ GET    /:id            # å¥–æ± è¯¦æƒ…
â”‚   â”‚   â””â”€â”€ GET    /:id/prizes     # å¥–æ± å¥–å“åˆ—è¡¨
â”‚   â”‚
â”‚   â”œâ”€â”€ POST   /draw               # æ‰§è¡ŒæŠ½å¥–
â”‚   â””â”€â”€ GET    /history            # æŠ½å¥–è®°å½•
â”‚
â”œâ”€â”€ points/                        # ğŸ’° ç§¯åˆ†åŸŸ
â”‚   â”œâ”€â”€ GET    /balance            # ç§¯åˆ†ä½™é¢
â”‚   â”œâ”€â”€ GET    /history            # ç§¯åˆ†è®°å½•
â”‚   â””â”€â”€ POST   /consume            # æ¶ˆè€—ç§¯åˆ†ï¼ˆå†…éƒ¨è°ƒç”¨ï¼‰
â”‚
â””â”€â”€ assets/                        # ğŸ“¦ èµ„äº§åŸŸ
    â”œâ”€â”€ GET    /balance            # èµ„äº§ä½™é¢ï¼ˆå¤šç§ææ–™ï¼‰
    â”œâ”€â”€ GET    /history            # èµ„äº§å˜åŠ¨è®°å½•
    â””â”€â”€ GET    /:asset_code        # æŒ‡å®šèµ„äº§è¯¦æƒ…
```

### 3.2 è·¯ç”±å‘½åè§„åˆ™

| è§„åˆ™         | è¯´æ˜            | æ­£ç¡®ç¤ºä¾‹               | é”™è¯¯ç¤ºä¾‹                             |
| ------------ | --------------- | ---------------------- | ------------------------------------ |
| ä½¿ç”¨å¤æ•°åè¯ | èµ„æºç”¨å¤æ•°      | `/items`, `/orders`    | `/item`, `/order`                    |
| å°å†™+è¿å­—ç¬¦  | å¤šè¯ç”¨è¿å­—ç¬¦    | `/my-listings`         | `/myListings`, `/my_listings`        |
| åŠ¨è¯ç”¨POST   | æ“ä½œç”¨POST+åŠ¨è¯ | `POST /draw`           | `GET /draw`                          |
| å±‚çº§ä¸è¶…è¿‡3  | æœ€å¤š3å±‚åµŒå¥—     | `/market/listings/:id` | `/market/listings/:id/comments/:cid` |

### 3.3 Adminè·¯ç”±è®¾è®¡

```
/api/v4/admin/
â”‚
â”œâ”€â”€ shop/
â”‚   â”œâ”€â”€ exchange/
â”‚   â”‚   â”œâ”€â”€ GET    /items          # å•†å“åˆ—è¡¨ï¼ˆç®¡ç†ï¼‰
â”‚   â”‚   â”œâ”€â”€ POST   /items          # åˆ›å»ºå•†å“
â”‚   â”‚   â”œâ”€â”€ PUT    /items/:id      # ç¼–è¾‘å•†å“
â”‚   â”‚   â””â”€â”€ DELETE /items/:id      # åˆ é™¤å•†å“
â”‚   â”‚
â”‚   â””â”€â”€ redemption/
â”‚       â”œâ”€â”€ GET    /orders         # æ ¸é”€è®¢å•ï¼ˆç®¡ç†ï¼‰
â”‚       â””â”€â”€ POST   /fulfill        # ç®¡ç†å‘˜æ ¸é”€
â”‚
â”œâ”€â”€ market/
â”‚   â”œâ”€â”€ GET    /listings           # å…¨éƒ¨æŒ‚å•ï¼ˆç®¡ç†ï¼‰
â”‚   â”œâ”€â”€ DELETE /listings/:id       # å¼ºåˆ¶ä¸‹æ¶
â”‚   â””â”€â”€ GET    /orders             # å…¨éƒ¨è®¢å•ï¼ˆç®¡ç†ï¼‰
â”‚
â”œâ”€â”€ lottery/
â”‚   â”œâ”€â”€ pools/
â”‚   â”‚   â”œâ”€â”€ GET    /               # å¥–æ± åˆ—è¡¨ï¼ˆç®¡ç†ï¼‰
â”‚   â”‚   â”œâ”€â”€ POST   /               # åˆ›å»ºå¥–æ± 
â”‚   â”‚   â”œâ”€â”€ PUT    /:id            # ç¼–è¾‘å¥–æ± 
â”‚   â”‚   â””â”€â”€ DELETE /:id            # åˆ é™¤å¥–æ± 
â”‚   â”‚
â”‚   â””â”€â”€ GET /draws                 # æŠ½å¥–è®°å½•ï¼ˆç®¡ç†ï¼‰
â”‚
â””â”€â”€ assets/
    â”œâ”€â”€ GET    /accounts           # ç”¨æˆ·èµ„äº§è´¦æˆ·ï¼ˆç®¡ç†ï¼‰
    â””â”€â”€ POST   /adjust             # èµ„äº§è°ƒæ•´
```

---

## 4. ç›®å½•ç»“æ„è§„èŒƒ

### 4.1 å½“å‰è·¯ç”±æ–‡ä»¶ç»“æ„ï¼ˆå®é™…çŠ¶æ€ï¼‰

```
routes/v4/
â”‚
â”œâ”€â”€ shop/                          # å•†åŸåŸŸ
â”‚   â”œâ”€â”€ index.js                   # åŸŸå…¥å£
â”‚   â”œâ”€â”€ premium.js                 # ä¼šå‘˜åŠŸèƒ½
â”‚   â”œâ”€â”€ assets/                    # èµ„äº§å­è·¯ç”±
â”‚   â”œâ”€â”€ consumption/               # æ¶ˆè´¹å­è·¯ç”±
â”‚   â”œâ”€â”€ points/                    # ç§¯åˆ†å­è·¯ç”±
â”‚   â””â”€â”€ redemption/                # æ ¸é”€å­è·¯ç”±ï¼ˆå·²æ‹†åˆ†ä¸ºå¤šæ–‡ä»¶ï¼‰
â”‚
â”œâ”€â”€ market/                        # âš ï¸ å½“å‰æ˜¯B2Cå…‘æ¢ï¼ˆç›®æ ‡ï¼šC2Cå¸‚åœºï¼‰
â”‚   â”œâ”€â”€ index.js                   # åŸŸå…¥å£
â”‚   â””â”€â”€ exchange/                  # å…‘æ¢å­è·¯ç”±ï¼ˆå·²æ‹†åˆ†ä¸ºå¤šæ–‡ä»¶ï¼‰
â”‚       â”œâ”€â”€ index.js
â”‚       â”œâ”€â”€ exchange.js
â”‚       â”œâ”€â”€ items.js
â”‚       â”œâ”€â”€ orders.js
â”‚       â””â”€â”€ statistics.js
â”‚
â”œâ”€â”€ inventory/                     # åº“å­˜åŸŸ
â”‚   â”œâ”€â”€ index.js                   # åŸŸå…¥å£
â”‚   â”œâ”€â”€ backpack.js                # èƒŒåŒ…åŠŸèƒ½
â”‚   â”œâ”€â”€ inventory-core.js          # æ ¸å¿ƒæ“ä½œ
â”‚   â”œâ”€â”€ inventory.js               # å…¼å®¹æ¥å£
â”‚   â””â”€â”€ market/                    # C2Cäº¤æ˜“å­è·¯ç”±ï¼ˆå·²æ‹†åˆ†ä¸ºå¤šæ–‡ä»¶ï¼‰
â”‚       â”œâ”€â”€ index.js
â”‚       â”œâ”€â”€ buy.js
â”‚       â”œâ”€â”€ listings.js
â”‚       â”œâ”€â”€ manage.js
â”‚       â””â”€â”€ sell.js
â”‚
â”œâ”€â”€ lottery/                       # æŠ½å¥–åŸŸ
â”‚   â””â”€â”€ index.js
â”‚
â”œâ”€â”€ exchange/                      # âš ï¸ å†—ä½™ç›®å½•ï¼ˆæœªæŒ‚è½½ï¼Œåº”åˆ é™¤ï¼‰
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ admin-exchange.js
â”‚   â”œâ”€â”€ exchange.js
â”‚   â”œâ”€â”€ orders.js
â”‚   â””â”€â”€ products.js
â”‚
â”œâ”€â”€ auth/                          # è®¤è¯åŸŸ
â”œâ”€â”€ system/                        # ç³»ç»ŸåŸŸ
â”œâ”€â”€ user/                          # ç”¨æˆ·åŸŸ
â””â”€â”€ admin/                         # ç®¡ç†åå°
```

### 4.1.1 ç›®æ ‡è·¯ç”±æ–‡ä»¶ç»“æ„

```
routes/v4/
â”‚
â”œâ”€â”€ shop/                          # å•†åŸåŸŸï¼ˆB2Cï¼‰
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ exchange/                  # â¬…ï¸ ä»market/exchangeè¿ç§»
â”‚   â””â”€â”€ redemption/
â”‚
â”œâ”€â”€ market/                        # å¸‚åœºåŸŸï¼ˆC2Cï¼‰
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ listings/                  # â¬…ï¸ ä»inventory/marketè¿ç§»
â”‚   â””â”€â”€ orders/
â”‚
â”œâ”€â”€ inventory/                     # åº“å­˜åŸŸï¼ˆçº¯åº“å­˜ç®¡ç†ï¼‰
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ backpack.js
â”‚   â””â”€â”€ inventory-core.js
â”‚
â”œâ”€â”€ lottery/                       # æŠ½å¥–åŸŸ
â”œâ”€â”€ auth/                          # è®¤è¯åŸŸ
â”œâ”€â”€ system/                        # ç³»ç»ŸåŸŸ
â”œâ”€â”€ user/                          # ç”¨æˆ·åŸŸ
â””â”€â”€ admin/                         # ç®¡ç†åå°
```

### 4.2 åŸŸå…¥å£æ–‡ä»¶æ¨¡æ¿

```javascript
// routes/v4/market/index.js
const express = require('express')
const router = express.Router()

const listingsRoutes = require('./listings')
const ordersRoutes = require('./orders')

// æŒ‚è½½å­è·¯ç”±
router.use('/listings', listingsRoutes)
router.use('/orders', ordersRoutes)

// ä¾¿æ·è·¯ç”±
router.get('/my-listings', listingsRoutes.getMyListings)

module.exports = router
```

### 4.3 Controlleræ–‡ä»¶å¤§å°è§„èŒƒ

| æ–‡ä»¶è¡Œæ•°   | çŠ¶æ€    | å¤„ç†æ–¹å¼ |
| ---------- | ------- | -------- |
| < 150 è¡Œ   | âœ… ä¼˜ç§€ | ä¿æŒ     |
| 150-250 è¡Œ | âœ… æ­£å¸¸ | ä¿æŒ     |
| 250-300 è¡Œ | âš ï¸ è­¦å‘Š | è€ƒè™‘æ‹†åˆ† |
| > 300 è¡Œ   | âŒ è¿è§„ | å¿…é¡»æ‹†åˆ† |

---

## 5. Serviceå‘½åè§„èŒƒ

### 5.1 Serviceå‘½åæ˜ å°„

| ä¸šåŠ¡åŸŸ          | Serviceåç§°         | èŒè´£             |
| --------------- | ------------------- | ---------------- |
| shop/exchange   | `ExchangeService`   | ææ–™å…‘æ¢é€»è¾‘     |
| shop/redemption | `RedemptionService` | æ ¸é”€é€»è¾‘         |
| market          | `MarketService`     | C2Cå¸‚åœºé€»è¾‘      |
| market/listings | `ListingService`    | æŒ‚å•ç®¡ç†         |
| market/orders   | `TradeOrderService` | äº¤æ˜“è®¢å•         |
| inventory       | `InventoryService`  | åº“å­˜ç®¡ç†         |
| lottery         | `LotteryService`    | æŠ½å¥–é€»è¾‘         |
| points          | `PointsService`     | ç§¯åˆ†ç®¡ç†         |
| assets          | `AssetService`      | èµ„äº§ç®¡ç†ï¼ˆé€šç”¨ï¼‰ |

### 5.2 Serviceæ–‡ä»¶ç»“æ„

#### å½“å‰çŠ¶æ€

```
services/
â”œâ”€â”€ ExchangeMarketService.js       # å…‘æ¢æœåŠ¡ï¼ˆâš ï¸ å¾…é‡å‘½åä¸ºExchangeServiceï¼‰
â”œâ”€â”€ RedemptionOrderService.js      # æ ¸é”€æœåŠ¡ï¼ˆâš ï¸ å¾…é‡å‘½åä¸ºRedemptionServiceï¼‰
â”œâ”€â”€ TradeOrderService.js           # äº¤æ˜“è®¢å•æœåŠ¡ï¼ˆâœ… å‘½åæ­£ç¡®ï¼‰
â””â”€â”€ ...
```

#### ç›®æ ‡çŠ¶æ€

```
services/
â”œâ”€â”€ ExchangeService.js             # å…‘æ¢æœåŠ¡
â”œâ”€â”€ RedemptionService.js           # æ ¸é”€æœåŠ¡
â”œâ”€â”€ MarketService.js               # å¸‚åœºæœåŠ¡ï¼ˆèšåˆï¼‰
â”œâ”€â”€ ListingService.js              # æŒ‚å•æœåŠ¡
â”œâ”€â”€ TradeOrderService.js           # äº¤æ˜“è®¢å•æœåŠ¡
â”œâ”€â”€ InventoryService.js            # åº“å­˜æœåŠ¡
â”œâ”€â”€ LotteryService.js              # æŠ½å¥–æœåŠ¡
â”œâ”€â”€ PointsService.js               # ç§¯åˆ†æœåŠ¡
â””â”€â”€ AssetService.js                # èµ„äº§æœåŠ¡ï¼ˆé€šç”¨ï¼‰
```

### 5.3 Serviceå‘½åè§„åˆ™

| è§„åˆ™         | è¯´æ˜           | æ­£ç¡®ç¤ºä¾‹            | é”™è¯¯ç¤ºä¾‹                |
| ------------ | -------------- | ------------------- | ----------------------- |
| å•æ•°+Service | åè¯å•æ•°       | `ListingService`    | `ListingsService`       |
| ä¸šåŠ¡è¯æ±‡     | ä½¿ç”¨ä¸šåŠ¡åŸŸè¯æ±‡ | `ExchangeService`   | `ShopExchangeService`   |
| ä¸åŠ å‰ç¼€     | ä¸åŠ åŸŸå‰ç¼€     | `RedemptionService` | `ShopRedemptionService` |

---

## 6. Modelå‘½åè§„èŒƒ

### 6.1 Modelä¸è¡¨åæ˜ å°„

#### å½“å‰çŠ¶æ€

| Modelåç§°              | è¡¨å                      | æ‰€å±åŸŸ    | è¯´æ˜                   |
| ---------------------- | ------------------------- | --------- | ---------------------- |
| `ExchangeItem`         | `exchange_items`          | shop      | å…‘æ¢å•†å“å®šä¹‰           |
| `ExchangeMarketRecord` | `exchange_market_records` | shop      | å…‘æ¢è®°å½•ï¼ˆâš ï¸å¾…é‡å‘½åï¼‰ |
| `RedemptionOrder`      | `redemption_orders`       | shop      | æ ¸é”€è®¢å•               |
| `MarketListing`        | `market_listings`         | market    | å¸‚åœºæŒ‚å•               |
| `TradeOrder`           | `trade_orders`            | market    | äº¤æ˜“è®¢å•               |
| `TradeRecord`          | `trade_records`           | market    | äº¤æ˜“è®°å½•ï¼ˆæ–°å¢ï¼‰       |
| `ItemInstance`         | `item_instances`          | inventory | ç‰©å“å®ä¾‹               |

#### ç›®æ ‡çŠ¶æ€

| Modelåç§°          | è¡¨å                  | æ‰€å±åŸŸ    | è¯´æ˜         |
| ------------------ | --------------------- | --------- | ------------ |
| `ExchangeItem`     | `exchange_items`      | shop      | å…‘æ¢å•†å“å®šä¹‰ |
| `ExchangeRecord`   | `exchange_records`    | shop      | å…‘æ¢è®°å½•     |
| `RedemptionOrder`  | `redemption_orders`   | shop      | æ ¸é”€è®¢å•     |
| `MarketListing`    | `market_listings`     | market    | å¸‚åœºæŒ‚å•     |
| `TradeOrder`       | `trade_orders`        | market    | äº¤æ˜“è®¢å•     |
| `TradeRecord`      | `trade_records`       | market    | äº¤æ˜“è®°å½•     |
| `ItemInstance`     | `item_instances`      | inventory | ç‰©å“å®ä¾‹     |
| `LotteryPool`      | `lottery_pools`       | lottery   | å¥–æ± å®šä¹‰     |
| `LotteryDraw`      | `lottery_draws`       | lottery   | æŠ½å¥–è®°å½•     |
| `UserAssetAccount` | `user_asset_accounts` | assets    | ç”¨æˆ·èµ„äº§è´¦æˆ· |

### 6.2 Modelæ–‡ä»¶ç»“æ„

#### å½“å‰çŠ¶æ€

```
models/
â”œâ”€â”€ ExchangeItem.js                # å…‘æ¢å•†å“
â”œâ”€â”€ ExchangeMarketRecord.js        # å…‘æ¢è®°å½•ï¼ˆâš ï¸ å¾…é‡å‘½åä¸ºExchangeRecordï¼‰
â”œâ”€â”€ RedemptionOrder.js             # æ ¸é”€è®¢å•
â”œâ”€â”€ MarketListing.js               # å¸‚åœºæŒ‚å•
â”œâ”€â”€ TradeOrder.js                  # äº¤æ˜“è®¢å•
â”œâ”€â”€ TradeRecord.js                 # äº¤æ˜“è®°å½•
â”œâ”€â”€ ItemInstance.js                # ç‰©å“å®ä¾‹
â””â”€â”€ ...
```

#### ç›®æ ‡çŠ¶æ€

```
models/
â”œâ”€â”€ ExchangeItem.js                # å…‘æ¢å•†å“
â”œâ”€â”€ ExchangeRecord.js              # å…‘æ¢è®°å½•
â”œâ”€â”€ RedemptionOrder.js             # æ ¸é”€è®¢å•
â”œâ”€â”€ MarketListing.js               # å¸‚åœºæŒ‚å•
â”œâ”€â”€ TradeOrder.js                  # äº¤æ˜“è®¢å•
â”œâ”€â”€ TradeRecord.js                 # äº¤æ˜“è®°å½•
â”œâ”€â”€ ItemInstance.js                # ç‰©å“å®ä¾‹
â”œâ”€â”€ LotteryPool.js                 # å¥–æ± 
â”œâ”€â”€ LotteryDraw.js                 # æŠ½å¥–è®°å½•
â”œâ”€â”€ UserAssetAccount.js            # ç”¨æˆ·èµ„äº§è´¦æˆ·
â””â”€â”€ ...
```

---

## 7. è¿ç§»æ˜ å°„è¡¨

### 7.1 è·¯ç”±è¿ç§»

| æ—§è·¯ç”±                              | æ–°è·¯ç”±                          | å˜æ›´è¯´æ˜              |
| ----------------------------------- | ------------------------------- | --------------------- |
| `/api/v4/market/items`              | `/api/v4/shop/exchange/items`   | B2Cå…‘æ¢ç§»å…¥shopåŸŸ     |
| `/api/v4/market/exchange`           | `/api/v4/shop/exchange/execute` | å…‘æ¢æ“ä½œ              |
| `/api/v4/inventory/market/listings` | `/api/v4/market/listings`       | C2Cäº¤æ˜“ç‹¬ç«‹ä¸ºmarketåŸŸ |
| `/api/v4/inventory/market/buy`      | `/api/v4/market/orders`         | è´­ä¹°æ”¹ä¸ºåˆ›å»ºè®¢å•      |
| `/api/v4/shop/redemption/*`         | ä¿ç•™                            | æ— å˜æ›´                |
| `/api/v4/inventory/items`           | `/api/v4/inventory/items`       | ä¿ç•™                  |
| `/api/v4/lottery/*`                 | ä¿ç•™                            | æ— å˜æ›´                |

### 7.2 æ–‡ä»¶è¿ç§»

| å½“å‰æ–‡ä»¶/ç›®å½•                 | ç›®æ ‡æ–‡ä»¶/ç›®å½•              | å˜æ›´è¯´æ˜              |
| ----------------------------- | -------------------------- | --------------------- |
| `routes/v4/market/exchange/`  | `routes/v4/shop/exchange/` | B2Cå…‘æ¢ç§»å…¥shopåŸŸ     |
| `routes/v4/market/index.js`   | åˆ é™¤ï¼Œé‡å»º                 | æ–°marketåŸŸç”¨äºC2C     |
| `routes/v4/inventory/market/` | `routes/v4/market/`        | C2Cäº¤æ˜“ç‹¬ç«‹ä¸ºmarketåŸŸ |
| `routes/v4/exchange/`         | åˆ é™¤                       | å†—ä½™ç›®å½•ï¼ˆæœªæŒ‚è½½ï¼‰    |
| `routes/v4/shop/points/`      | ä¿æŒ                       | å·²æ‹†åˆ†ä¸ºå¤šæ–‡ä»¶        |
| `routes/v4/shop/consumption/` | ä¿æŒ                       | å·²æ‹†åˆ†ä¸ºå¤šæ–‡ä»¶        |

### 7.3 Serviceè¿ç§»

| æ—§Service                | æ–°Service           | å˜æ›´è¯´æ˜ |
| ------------------------ | ------------------- | -------- |
| `ExchangeMarketService`  | `ExchangeService`   | ç®€åŒ–å‘½å |
| `TradeOrderService`      | ä¿ç•™                | æ— å˜æ›´   |
| `RedemptionOrderService` | `RedemptionService` | ç®€åŒ–å‘½å |

### 7.4 Modelè¿ç§»

| æ—§Model                | æ–°Model          | è¡¨å               | å˜æ›´è¯´æ˜           |
| ---------------------- | ---------------- | ------------------ | ------------------ |
| `ExchangeMarketRecord` | `ExchangeRecord` | `exchange_records` | ç®€åŒ–å‘½åï¼Œéœ€æ”¹è¡¨å |
| å…¶ä»–Model              | ä¿ç•™             | -                  | æ— å˜æ›´             |

---

## 8. å‘½åå¯¹ç…§é€ŸæŸ¥è¡¨

### 8.1 ä¸šåŠ¡åœºæ™¯â†’å‘½åé€ŸæŸ¥

| ä¸šåŠ¡åœºæ™¯         | è·¯ç”±åŸŸ    | è·¯ç”±è·¯å¾„                   | Service           | Model                        |
| ---------------- | --------- | -------------------------- | ----------------- | ---------------------------- |
| ç”¨æˆ·ç”¨ææ–™æ¢å•†å“ | shop      | `/shop/exchange/execute`   | ExchangeService   | ExchangeItem, ExchangeRecord |
| ç”¨æˆ·ç”Ÿæˆæ ¸é”€ç    | shop      | `/shop/redemption/create`  | RedemptionService | RedemptionOrder              |
| å•†æˆ·æ ¸é”€ç‰©å“     | shop      | `/shop/redemption/fulfill` | RedemptionService | RedemptionOrder              |
| ç”¨æˆ·æŒ‚å•å‡ºå”®ç‰©å“ | market    | `/market/listings`         | ListingService    | MarketListing                |
| ç”¨æˆ·è´­ä¹°ä»–äººç‰©å“ | market    | `/market/orders`           | TradeOrderService | TradeOrder                   |
| ç”¨æˆ·æŸ¥çœ‹è‡ªå·±ç‰©å“ | inventory | `/inventory/items`         | InventoryService  | ItemInstance                 |
| ç”¨æˆ·æŠ½å¥–         | lottery   | `/lottery/draw`            | LotteryService    | LotteryDraw                  |
| ç”¨æˆ·æŸ¥çœ‹ç§¯åˆ†     | points    | `/points/balance`          | PointsService     | UserAssetAccount             |

### 8.2 å¸¸è§é—®é¢˜FAQ

**Q: ä¸ºä»€ä¹ˆä¸æŠŠå…‘æ¢æ”¾åœ¨marketåŸŸï¼Ÿ**

> A: `market`åœ¨æ¸¸æˆè¡Œä¸šç‰¹æŒ‡C2Cç”¨æˆ·é—´äº¤æ˜“ï¼ˆå¦‚Steamå¸‚åœºï¼‰ï¼ŒB2Cå®˜æ–¹å”®å–åº”ä½¿ç”¨`shop`ã€‚

**Q: ä¸ºä»€ä¹ˆinventoryåŸŸä¸åŒ…å«äº¤æ˜“åŠŸèƒ½ï¼Ÿ**

> A: `inventory`ä»…ç®¡ç†"æŒæœ‰"ï¼Œäº¤æ˜“é€»è¾‘åº”åœ¨`market`åŸŸï¼Œéµå¾ªå•ä¸€èŒè´£åŸåˆ™ã€‚

**Q: redemptionä¸ºä»€ä¹ˆåœ¨shopä¸‹è€Œä¸æ˜¯ç‹¬ç«‹åŸŸï¼Ÿ**

> A: æ ¸é”€æ˜¯å•†åŸå•†å“çš„å±¥çº¦ç¯èŠ‚ï¼Œé€»è¾‘ä¸Šå±äºshopåŸŸçš„ä¸€éƒ¨åˆ†ã€‚å¦‚æœæœªæ¥æ ¸é”€é€»è¾‘å¤æ‚ï¼Œå¯ç‹¬ç«‹ä¸º`/fulfillment`åŸŸã€‚

**Q: ç§¯åˆ†å’Œèµ„äº§ä¸ºä»€ä¹ˆåˆ†å¼€ï¼Ÿ**

> A: `points`æ˜¯ç‰¹æ®Šèµ„äº§ï¼ˆç§¯åˆ†ï¼‰ï¼Œ`assets`æ˜¯é€šç”¨èµ„äº§ï¼ˆææ–™ã€ä»£å¸ç­‰ï¼‰ã€‚å¦‚æœé¡¹ç›®åªæœ‰ç§¯åˆ†ï¼Œå¯åˆå¹¶ã€‚

---

## ğŸ“ é™„å½•ï¼šapp.js è·¯ç”±æŒ‚è½½ç¤ºä¾‹

```javascript
// app.js è·¯ç”±æŒ‚è½½

// ç”¨æˆ·ç«¯è·¯ç”±
app.use('/api/v4/shop', require('./routes/v4/shop'))
app.use('/api/v4/market', require('./routes/v4/market'))
app.use('/api/v4/inventory', require('./routes/v4/inventory'))
app.use('/api/v4/lottery', require('./routes/v4/lottery'))
app.use('/api/v4/points', require('./routes/v4/points'))
app.use('/api/v4/assets', require('./routes/v4/assets'))

// ç®¡ç†ç«¯è·¯ç”±
app.use('/api/v4/admin/shop', require('./routes/v4/admin/shop'))
app.use('/api/v4/admin/market', require('./routes/v4/admin/market'))
app.use('/api/v4/admin/lottery', require('./routes/v4/admin/lottery'))
app.use('/api/v4/admin/assets', require('./routes/v4/admin/assets'))
```

---

## 9. é‡æ„æ‰§è¡Œè®¡åˆ’

### 9.1 é‡æ„ä»»åŠ¡æ¸…å•

#### ğŸ”´ P0-ç´§æ€¥ï¼šåˆ é™¤å†—ä½™ç›®å½•

| åºå· | ä»»åŠ¡                           | ä¼˜å…ˆçº§ | çŠ¶æ€      | è¯´æ˜                                       |
| ---- | ------------------------------ | ------ | --------- | ------------------------------------------ |
| 0-1  | åˆ é™¤ç›®å½• `routes/v4/exchange/` | P0     | âŒ å¾…æ‰§è¡Œ | æœªæŒ‚è½½çš„å†—ä½™ç›®å½•ï¼Œä¸`market/exchange/`é‡å¤ |

#### ğŸŸ¡ P0-æ ¸å¿ƒï¼šè·¯ç”±é‡æ„

| åºå· | ä»»åŠ¡                                | ä¼˜å…ˆçº§ | çŠ¶æ€      | è¯´æ˜                              |
| ---- | ----------------------------------- | ------ | --------- | --------------------------------- |
| 1    | è¿ç§» `routes/v4/market/exchange/`   | P0     | âŒ å¾…æ‰§è¡Œ | ç§»åŠ¨åˆ° `routes/v4/shop/exchange/` |
| 2    | è¿ç§» `routes/v4/inventory/market/`  | P0     | âŒ å¾…æ‰§è¡Œ | ç§»åŠ¨åˆ° `routes/v4/market/`        |
| 3    | æ›´æ–° `routes/v4/shop/index.js`      | P0     | âŒ å¾…æ‰§è¡Œ | æŒ‚è½½exchangeå­è·¯ç”±                |
| 4    | æ›´æ–° `routes/v4/market/index.js`    | P0     | âŒ å¾…æ‰§è¡Œ | æ”¹ä¸ºæŒ‚è½½C2Cå¸‚åœºè·¯ç”±               |
| 5    | æ›´æ–° `routes/v4/inventory/index.js` | P0     | âŒ å¾…æ‰§è¡Œ | ç§»é™¤marketå­è·¯ç”±                  |
| 6    | æ›´æ–°å‰ç«¯APIè°ƒç”¨è·¯å¾„                 | P0     | âŒ å¾…æ‰§è¡Œ | é…åˆåç«¯è·¯ç”±å˜æ›´                  |

#### ğŸŸ¢ P1-ä¼˜åŒ–ï¼šå‘½åç»Ÿä¸€

| åºå· | ä»»åŠ¡                                                  | ä¼˜å…ˆçº§ | çŠ¶æ€      | è¯´æ˜     |
| ---- | ----------------------------------------------------- | ------ | --------- | -------- |
| 7    | é‡å‘½å `ExchangeMarketService` â†’ `ExchangeService`    | P1     | âŒ å¾…æ‰§è¡Œ | ç®€åŒ–å‘½å |
| 8    | é‡å‘½å `RedemptionOrderService` â†’ `RedemptionService` | P1     | âŒ å¾…æ‰§è¡Œ | ç®€åŒ–å‘½å |
| 9    | é‡å‘½å `ExchangeMarketRecord` â†’ `ExchangeRecord`      | P1     | âŒ å¾…æ‰§è¡Œ | ç®€åŒ–å‘½å |

#### ğŸ”µ P2-æ¸…ç†ï¼šæ•°æ®åº“è¿ç§»

| åºå· | ä»»åŠ¡                                                      | ä¼˜å…ˆçº§ | çŠ¶æ€      | è¯´æ˜           |
| ---- | --------------------------------------------------------- | ------ | --------- | -------------- |
| 10   | æ•°æ®åº“è¡¨å `exchange_market_records` â†’ `exchange_records` | P2     | âŒ å¾…æ‰§è¡Œ | éœ€æ•°æ®è¿ç§»è„šæœ¬ |

### 9.2 å½±å“èŒƒå›´è¯„ä¼°

| å±‚çº§             | éœ€ä¿®æ”¹æ–‡ä»¶æ•°   | é£é™©ç­‰çº§ | è¯´æ˜                                           |
| ---------------- | -------------- | -------- | ---------------------------------------------- |
| **å†—ä½™ç›®å½•åˆ é™¤** | 1ä¸ªç›®å½•(5æ–‡ä»¶) | ğŸŸ¢ ä½    | æœªæŒ‚è½½ç›®å½•ï¼Œåˆ é™¤æ— åŠŸèƒ½å½±å“                     |
| è·¯ç”±å±‚           | 5-8ä¸ªæ–‡ä»¶      | ğŸ”´ é«˜    | APIè·¯å¾„å˜åŒ–å½±å“å‰ç«¯                            |
| æœåŠ¡å±‚           | 2-3ä¸ªæœåŠ¡      | ğŸŸ¡ ä¸­    | å†…éƒ¨é‡å‘½å                                     |
| æ¨¡å‹å±‚           | 1ä¸ªæ¨¡å‹        | ğŸŸ¡ ä¸­    | `ExchangeMarketRecord` â†’ `ExchangeRecord`      |
| æ•°æ®åº“           | 1å¼ è¡¨          | ğŸ”´ é«˜    | `exchange_market_records` â†’ `exchange_records` |

#### 9.2.1 å½“å‰ä»£ç å®é™…çŠ¶æ€ï¼ˆ2025-12-22 éªŒè¯ï¼‰

**app.jsè·¯ç”±æŒ‚è½½ç°çŠ¶**ï¼š

```javascript
app.use('/api/v4/auth', require('./routes/v4/auth'))
app.use('/api/v4/admin', require('./routes/v4/admin'))
app.use('/api/v4/lottery', require('./routes/v4/lottery'))
app.use('/api/v4/inventory', require('./routes/v4/inventory')) // åŒ…å«C2Cäº¤æ˜“
app.use('/api/v4/market', require('./routes/v4/market')) // å®é™…æ˜¯B2Cå…‘æ¢
app.use('/api/v4/shop', require('./routes/v4/shop')) // åŒ…å«æ ¸é”€åŠŸèƒ½
app.use('/api/v4/system', require('./routes/v4/system'))
app.use('/api/v4/user', require('./routes/v4/user'))
app.use('/api/v4/debug-control', require('./routes/v4/debug-control'))
```

**å®é™…APIè·¯å¾„å¯¹ç…§**ï¼š

| å®é™…è·¯å¾„                            | ä¸šåŠ¡åŠŸèƒ½        | è·¯ç”±æ–‡ä»¶                       | Service                  |
| ----------------------------------- | --------------- | ------------------------------ | ------------------------ |
| `/api/v4/market/items`              | B2Cå…‘æ¢å•†å“åˆ—è¡¨ | `market/exchange/items.js`     | `ExchangeMarketService`  |
| `/api/v4/market/exchange`           | æ‰§è¡Œå…‘æ¢        | `market/exchange/exchange.js`  | `ExchangeMarketService`  |
| `/api/v4/market/orders`             | å…‘æ¢è®¢å•åˆ—è¡¨    | `market/exchange/orders.js`    | `ExchangeMarketService`  |
| `/api/v4/inventory/market/listings` | C2CæŒ‚å•åˆ—è¡¨     | `inventory/market/listings.js` | `TradeOrderService`      |
| `/api/v4/inventory/market/sell`     | ä¸Šæ¶å•†å“        | `inventory/market/sell.js`     | `MarketListing`          |
| `/api/v4/inventory/market/buy`      | è´­ä¹°å•†å“        | `inventory/market/buy.js`      | `TradeOrderService`      |
| `/api/v4/shop/redemption/*`         | æ ¸é”€ç³»ç»Ÿ        | `shop/redemption/`             | `RedemptionOrderService` |

### 9.3 æ‰§è¡Œç­–ç•¥

**é‡‡ç”¨æš´åŠ›é‡æ„ç­–ç•¥**ï¼ˆä¸ä¿ç•™æ—§ä»£ç å…¼å®¹ï¼‰ï¼š

1. **Step 1**: åˆ›å»ºæ–°è·¯ç”±æ–‡ä»¶ï¼Œå¤åˆ¶ä¸šåŠ¡é€»è¾‘
2. **Step 2**: æ›´æ–° `app.js`ï¼ŒæŒ‚è½½æ–°è·¯ç”±
3. **Step 3**: åˆ é™¤æ—§è·¯ç”±æ–‡ä»¶
4. **Step 4**: é‡å‘½åServiceï¼ˆå…¨å±€æœç´¢æ›¿æ¢ï¼‰
5. **Step 5**: å‰ç«¯åŒæ­¥æ›´æ–°APIè·¯å¾„
6. **Step 6**: éªŒè¯æµ‹è¯•é€šè¿‡

### 9.4 è¿›åº¦è·Ÿè¸ª

| æ—¥æœŸ       | æ“ä½œ             | æ“ä½œäºº | è¯¦æƒ…                                             |
| ---------- | ---------------- | ------ | ------------------------------------------------ |
| 2025-12-22 | åˆ›å»ºå‘½åè§„èŒƒæ–‡æ¡£ | ç³»ç»Ÿ   | v1.0 åˆç‰ˆ                                        |
| 2025-12-22 | ä»£ç çŠ¶æ€éªŒè¯     | Claude | éªŒè¯æ–‡æ¡£æè¿°é—®é¢˜æ˜¯å¦ä¸å®é™…ä»£ç ä¸€è‡´               |
| 2025-12-22 | æ–‡æ¡£æ›´æ–°v1.2     | Claude | æ›´æ–°ç°çŠ¶æè¿°ä¸å®é™…ä»£ç å¯¹é½ï¼Œé‡æ–°è¯„ä¼°ä»»åŠ¡æ¸…å•     |
| 2025-12-22 | æ–‡æ¡£æ›´æ–°v1.3     | Claude | æ ¸å®ä»£ç ä¸æ•°æ®åº“çœŸå®çŠ¶æ€ï¼Œæ›´æ–°è¿›åº¦æ€»è§ˆåˆ°æ–‡æ¡£å¼€å¤´ |

#### æ ¸å®è¯¦æƒ…ï¼ˆv1.3ï¼‰

| éªŒè¯é¡¹ç›®    | éªŒè¯æ–¹æ³•              | ç»“æœ                                |
| ----------- | --------------------- | ----------------------------------- |
| ç›®å½•ç»“æ„    | `list_dir routes/v4/` | âœ… ä¸æ–‡æ¡£æè¿°ä¸€è‡´                   |
| å†—ä½™ç›®å½•    | æ£€æŸ¥app.jsè·¯ç”±æŒ‚è½½    | âœ… `routes/v4/exchange/` ç¡®å®æœªæŒ‚è½½ |
| è·¯ç”±æ–‡ä»¶    | è¯»å–å„ç›®å½•index.js    | âœ… è·¯ç”±æŒ‚è½½é€»è¾‘ä¸æ–‡æ¡£ä¸€è‡´           |
| Serviceæ–‡ä»¶ | `list_dir services/`  | âœ… 3ä¸ªServiceå­˜åœ¨ä¸”å‘½åä¸æ–‡æ¡£ä¸€è‡´   |
| Modelæ–‡ä»¶   | `list_dir models/`    | âœ… 6ä¸ªModelå­˜åœ¨ä¸”å‘½åä¸æ–‡æ¡£ä¸€è‡´     |
| æ•°æ®åº“è¡¨    | `SHOW TABLES` æŸ¥è¯¢    | âœ… 39å¼ è¡¨ï¼Œæ‰€æœ‰ç›¸å…³è¡¨å­˜åœ¨           |
| ä¸šåŠ¡é€»è¾‘    | è¯»å–è·¯ç”±å’ŒServiceæºç  | âœ… B2C/C2Cä¸šåŠ¡è¯­ä¹‰æ··ä¹±é—®é¢˜ç¡®è®¤å­˜åœ¨  |

---

## ğŸ“Š æ€»ä½“è¿›åº¦æ¦‚è§ˆ

| ç±»åˆ«                  | æ€»ä»»åŠ¡æ•° | å·²å®Œæˆ | è¿›è¡Œä¸­ | å¾…æ‰§è¡Œ | å®Œæˆç‡ |
| --------------------- | -------- | ------ | ------ | ------ | ------ |
| P0-ç´§æ€¥ï¼ˆåˆ é™¤å†—ä½™ï¼‰   | 1        | 0      | 0      | 1      | 0%     |
| P0-æ ¸å¿ƒï¼ˆè·¯ç”±é‡æ„ï¼‰   | 6        | 0      | 0      | 6      | 0%     |
| P1-ä¼˜åŒ–ï¼ˆå‘½åç»Ÿä¸€ï¼‰   | 3        | 0      | 0      | 3      | 0%     |
| P2-æ¸…ç†ï¼ˆæ•°æ®åº“è¿ç§»ï¼‰ | 1        | 0      | 0      | 1      | 0%     |
| **æ€»è®¡**              | **11**   | **0**  | **0**  | **11** | **0%** |

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³æ‰§è¡Œ**ï¼šåˆ é™¤å†—ä½™ç›®å½• `routes/v4/exchange/`ï¼ˆä»»åŠ¡0-1ï¼‰ï¼Œé£é™©ä½ã€æ”¶ç›Šé«˜
2. **è§„åˆ’æ‰§è¡Œ**ï¼šåˆ¶å®šè·¯ç”±é‡æ„çš„è¯¦ç»†è¿ç§»æ­¥éª¤
3. **åè°ƒå‰ç«¯**ï¼šç¡®è®¤APIè·¯å¾„å˜æ›´åçš„å‰ç«¯é€‚é…æ–¹æ¡ˆ

---

**æ–‡æ¡£ç»“æŸ**
