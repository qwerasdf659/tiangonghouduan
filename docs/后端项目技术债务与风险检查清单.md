# åç«¯é¡¹ç›®æŠ€æœ¯å€ºåŠ¡ä¸é£é™©æ£€æŸ¥æ¸…å•

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2025å¹´12æœˆ  
**é€‚ç”¨èŒƒå›´**: é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ V4.0ï¼ˆåç«¯ + æ•°æ®åº“é¡¹ç›®ï¼‰  
**æ£€æŸ¥ç›®æ ‡**: é™¤ä¸šåŠ¡é€»è¾‘å¤–çš„å·¥ç¨‹è´¨é‡ã€å®‰å…¨ã€ä¸€è‡´æ€§é—®é¢˜

> **è¯´æ˜**: æœ¬æ–‡æ¡£åŸºäºå½“å‰ä»£ç çŠ¶æ€ï¼ˆ2025å¹´12æœˆï¼‰ç”Ÿæˆï¼Œæ‰€æœ‰é—®é¢˜éƒ½æœ‰å…·ä½“æ–‡ä»¶ä½ç½®å’Œä»£ç ç¤ºä¾‹ï¼Œå¯ç›´æ¥è¿½æº¯å’Œä¿®å¤ã€‚

---

## ç›®å½•

1. [æ¥å£å¥‘çº¦ä¸€è‡´æ€§](#1-æ¥å£å¥‘çº¦ä¸€è‡´æ€§)
2. [å¥åº·æ£€æŸ¥ä¸å¯è§‚æµ‹æ€§](#2-å¥åº·æ£€æŸ¥ä¸å¯è§‚æµ‹æ€§)
3. [é…ç½®ä¸ç¯å¢ƒå˜é‡](#3-é…ç½®ä¸ç¯å¢ƒå˜é‡)
4. [WebSocketå®‰å…¨](#4-websocketå®‰å…¨)
5. [æ•°æ®åº“è¿ç§»ä¸çœŸç›¸è¡¨åˆ‡æ¢](#5-æ•°æ®åº“è¿ç§»ä¸çœŸç›¸è¡¨åˆ‡æ¢)
6. [äº‹åŠ¡/å¹¶å‘/å¹‚ç­‰](#6-äº‹åŠ¡å¹¶å‘å¹‚ç­‰)
7. [æ€§èƒ½é£é™©](#7-æ€§èƒ½é£é™©)
8. [æƒé™æ¨¡å‹ä¸ç¼“å­˜å¤±æ•ˆ](#8-æƒé™æ¨¡å‹ä¸ç¼“å­˜å¤±æ•ˆ)
9. [ä¿®å¤ä¼˜å…ˆçº§ä¸å»ºè®®](#9-ä¿®å¤ä¼˜å…ˆçº§ä¸å»ºè®®)

---

## 1. æ¥å£å¥‘çº¦ä¸€è‡´æ€§

### é—®é¢˜æè¿°

ç³»ç»Ÿä¸­åŒæ—¶å­˜åœ¨å¤šå¥—APIå“åº”æ ¼å¼ï¼Œå¯¼è‡´å‰ç«¯/è°ƒç”¨æ–¹åœ¨ä¸åŒåœºæ™¯ï¼ˆæ­£å¸¸å“åº”ã€é”™è¯¯ã€404ã€é‰´æƒå¤±è´¥ï¼‰éœ€è¦å¤„ç†ä¸åŒçš„æ•°æ®ç»“æ„ï¼Œå¢åŠ äº†é›†æˆæˆæœ¬å’Œé”™è¯¯å¤„ç†å¤æ‚åº¦ã€‚

### å…·ä½“é—®é¢˜

#### 1.1 å¤šå¥—å“åº”æ ¼å¼æ··ç”¨

**å½±å“èŒƒå›´**: å…¨å±€  
**é£é™©ç­‰çº§**: ğŸ”´ P0ï¼ˆå½±å“æ‰€æœ‰APIè°ƒç”¨æ–¹ï¼‰

**é—®é¢˜æ–‡ä»¶**:

- `app.js` - 404å¤„ç†å™¨è¿”å› `{code, msg, data}`
- `utils/ApiResponse.js` - æ ‡å‡†æ ¼å¼ `{success, code, message, data}`
- `middleware/errorHandler.js` - é”™è¯¯æ ¼å¼ `{code, msg, data}`

**ä»£ç ç¤ºä¾‹**:

```javascript
// app.js ç¬¬ 617-642 è¡Œ - 404å“åº”æ ¼å¼
app.use('*', (req, res) => {
  res.status(404).json({
    code: 404,                    // âŒ ä½¿ç”¨ HTTP çŠ¶æ€ç ä½œä¸º code
    msg: `æ¥å£ä¸å­˜åœ¨`,             // âŒ ä½¿ç”¨ msg è€Œé message
    data: { /* ... */ },
    timestamp: BeijingTimeHelper.apiTimestamp()
  })
})

// ApiResponse.middleware() - æ ‡å‡†æ ¼å¼
res.apiSuccess = (data, message, code) => {
  return {
    success: true,              // âœ… æ ‡å‡†æ ¼å¼
    code: 'SUCCESS',            // âœ… ä¸šåŠ¡ç 
    message: 'æ“ä½œæˆåŠŸ',
    data,
    timestamp: /* ... */
  }
}
```

**é—®é¢˜å½±å“**:

- å‰ç«¯éœ€è¦å†™å¤šå¥—è§£æé€»è¾‘ï¼š`response.msg || response.message`
- ç±»å‹å®šä¹‰å†²çªï¼š`code` æœ‰æ—¶æ˜¯æ•°å­—ï¼ˆ404ï¼‰ï¼Œæœ‰æ—¶æ˜¯å­—ç¬¦ä¸²ï¼ˆ'SUCCESS'ï¼‰
- é”™è¯¯å¤„ç†ä¸ä¸€è‡´ï¼šéƒ¨åˆ†è¿”å› `success: false`ï¼Œéƒ¨åˆ†æ²¡æœ‰ `success` å­—æ®µ

#### 1.2 HTTPçŠ¶æ€ç ä¸ä¸šåŠ¡ç æ··æ·†

**å½±å“èŒƒå›´**: `utils/ApiResponse.js`  
**é£é™©ç­‰çº§**: ğŸ”´ P0ï¼ˆä¼šå¯¼è‡´æ— æ•ˆçš„HTTPçŠ¶æ€ç ï¼‰

**é—®é¢˜æ–‡ä»¶**: `utils/ApiResponse.js` ç¬¬ 202-235 è¡Œ

```javascript
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šå°†ä¸šåŠ¡ç å½“ä½œHTTPçŠ¶æ€ç ä¼ å…¥
static badRequest (message = 'Bad Request', errorCode = 'BAD_REQUEST', details = null) {
  return this.error(message, errorCode, details, 2001)  // âŒ 2001 ä¸æ˜¯æœ‰æ•ˆçš„ HTTP çŠ¶æ€ç 
}

static unauthorized (message = 'Unauthorized', errorCode = 'UNAUTHORIZED') {
  return this.error(message, errorCode, null, 4001)     // âŒ 4001 ä¸æ˜¯æœ‰æ•ˆçš„ HTTP çŠ¶æ€ç 
}

static send (res, apiResponse) {
  const statusCode = apiResponse.httpStatus || 200      // âš ï¸ ä¼šå°è¯•è®¾ç½® res.status(2001)
  return res.status(statusCode).json(apiResponse)
}
```

**é—®é¢˜å½±å“**:

- å¼€å‘/æµ‹è¯•ç¯å¢ƒå¯èƒ½æŠ›å‡º "Invalid status code: 2001"
- ç”Ÿäº§ç¯å¢ƒå¯èƒ½å¯¼è‡´æµè§ˆå™¨/ç½‘å…³è§£æå¤±è´¥
- HTTPçŠ¶æ€ç å’Œä¸šåŠ¡é”™è¯¯ç æ¦‚å¿µæ··æ·†

#### 1.3 è°ƒç”¨æ–¹å¼é”™è¯¯

**å½±å“èŒƒå›´**: `routes/v4/unified-engine/backpack.js`  
**é£é™©ç­‰çº§**: ğŸŸ¡ P1ï¼ˆå½±å“é”™è¯¯ç å‡†ç¡®æ€§ï¼‰

**é—®é¢˜æ–‡ä»¶**: `routes/v4/unified-engine/backpack.js` ç¬¬ 77-92 è¡Œ

```javascript
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šç¬¬äºŒä¸ªå‚æ•°åº”è¯¥æ˜¯ errorCodeï¼Œä½†ä¼ äº† HTTP çŠ¶æ€ç 
if (!userRoles.isAdmin) {
  return res.apiError('æ— æƒæŸ¥çœ‹å…¶ä»–ç”¨æˆ·çš„èƒŒåŒ…', 403)
  // å®é™…æ•ˆæœï¼šcode=403, httpStatus=400ï¼ˆä½¿ç”¨äº†é»˜è®¤å€¼ï¼‰
}

// âœ… æ­£ç¡®ç¤ºä¾‹ï¼š
if (!userRoles.isAdmin) {
  return res.apiError('æ— æƒæŸ¥çœ‹å…¶ä»–ç”¨æˆ·çš„èƒŒåŒ…', 'FORBIDDEN', null, 403)
  // æ•ˆæœï¼šcode='FORBIDDEN', httpStatus=403
}
```

### ä¿®å¤å»ºè®®

#### æ–¹æ¡ˆAï¼šç»Ÿä¸€ä¸º ApiResponse æ ‡å‡†æ ¼å¼ï¼ˆæ¨èï¼‰

```javascript
// 1. ä¿®æ”¹ app.js çš„ 404 å¤„ç†å™¨
app.use('*', (req, res) => {
  return res.status(404).json(
    ApiResponse.notFound(`æ¥å£ä¸å­˜åœ¨: ${req.method} ${req.originalUrl}`)
  )
})

// 2. ä¿®æ”¹ ApiResponse çš„å¿«æ·æ–¹æ³•
static badRequest (message = 'Bad Request', errorCode = 'BAD_REQUEST', details = null) {
  return this.error(message, errorCode, details, 400)  // âœ… ä½¿ç”¨æ­£ç¡®çš„ HTTP çŠ¶æ€ç 
}

static unauthorized (message = 'Unauthorized', errorCode = 'UNAUTHORIZED') {
  return this.error(message, errorCode, null, 401)     // âœ… ä½¿ç”¨æ­£ç¡®çš„ HTTP çŠ¶æ€ç 
}

// 3. ç»Ÿä¸€ errorHandler.js çš„é”™è¯¯æ ¼å¼
const errorHandler = (err, req, res, next) => {
  // ... å¤„ç†é€»è¾‘ ...
  return res.status(statusCode).json(
    ApiResponse.error(errorMessage, errorCode, additionalData, statusCode)
  )
}
```

#### æ–¹æ¡ˆBï¼šåˆ¶å®šæ˜ç¡®çš„è§„èŒƒæ–‡æ¡£

åˆ›å»º `docs/APIå“åº”æ ¼å¼è§„èŒƒ.md`ï¼Œæ˜ç¡®å®šä¹‰ï¼š

- HTTPçŠ¶æ€ç ä½¿ç”¨åœºæ™¯ï¼ˆä»…ç”¨äºä¼ è¾“å±‚ï¼‰
- ä¸šåŠ¡ç å®šä¹‰ï¼ˆå­—ç¬¦ä¸²ï¼Œç”¨äºä¸šåŠ¡é”™è¯¯åˆ†ç±»ï¼‰
- å“åº”å­—æ®µå¼ºåˆ¶è¦æ±‚ï¼ˆsuccess, code, message, data, timestampï¼‰

---

## 2. å¥åº·æ£€æŸ¥ä¸å¯è§‚æµ‹æ€§

### é—®é¢˜æè¿°

å¥åº·æ£€æŸ¥æ¥å£å’Œæ—¥å¿—ç³»ç»Ÿå­˜åœ¨ç›²åŒºï¼Œå¯¼è‡´è¿ç»´ç›‘æ§æ— æ³•å‡†ç¡®åˆ¤æ–­ç³»ç»ŸçŠ¶æ€ï¼Œæ’éšœæ—¶ç¼ºå°‘å…³é”®ä¸Šä¸‹æ–‡ã€‚

### å…·ä½“é—®é¢˜

#### 2.1 Rediså¥åº·æ£€æŸ¥æ˜¯å ä½å®ç°

**å½±å“èŒƒå›´**: `/health` ç«¯ç‚¹  
**é£é™©ç­‰çº§**: ğŸ”´ P0ï¼ˆå½±å“ç›‘æ§å‘Šè­¦å‡†ç¡®æ€§ï¼‰

**é—®é¢˜æ–‡ä»¶**: `app.js` ç¬¬ 229-237 è¡Œ

```javascript
// âŒ å½“å‰å®ç°ï¼šæ°¸è¿œè¿”å› connected
let redisStatus = 'disconnected'
try {
  // è¿™é‡Œå¯ä»¥æ·»åŠ Redisè¿æ¥æ£€æŸ¥
  redisStatus = 'connected' // âŒ æ²¡æœ‰å®é™…æ£€æŸ¥ï¼Œç›´æ¥å†™æ­»
} catch (error) {
  appLogger.error('Redisè¿æ¥æ£€æŸ¥å¤±è´¥', { error: error.message })
  redisStatus = 'disconnected'
}
```

**é—®é¢˜å½±å“**:

- Rediså®é™…æ–­å¼€æ—¶ï¼Œå¥åº·æ£€æŸ¥ä»æ˜¾ç¤ºæ­£å¸¸
- ç›‘æ§ç³»ç»Ÿæ— æ³•åŠæ—¶å‘ç°Redisæ•…éšœ
- ä¾èµ–Redisçš„åŠŸèƒ½ï¼ˆé™æµã€ç¼“å­˜ã€WebSocketï¼‰é™é»˜å¤±è´¥

**ä¿®å¤æ–¹æ¡ˆ**:

```javascript
// âœ… æ­£ç¡®å®ç°
let redisStatus = 'disconnected'
try {
  const { isRedisHealthy } = require('./utils/UnifiedRedisClient')
  const healthy = await isRedisHealthy()
  redisStatus = healthy ? 'connected' : 'disconnected'
} catch (error) {
  appLogger.error('Redisè¿æ¥æ£€æŸ¥å¤±è´¥', { error: error.message })
  redisStatus = 'disconnected'
}

// å¦‚æœRedisä¸å¥åº·ï¼Œè¿”å› 503 è€Œé 200
if (databaseStatus === 'disconnected' || redisStatus === 'disconnected') {
  return res.status(503).json({
    success: false,
    code: 'SYSTEM_UNHEALTHY',
    message: 'ç³»ç»Ÿç»„ä»¶ä¸å¥åº·',
    data: {
      database: databaseStatus,
      redis: redisStatus
    }
  })
}
```

#### 2.2 æ—¥å¿—ç³»ç»Ÿæ··ç”¨å¯¼è‡´ä¸Šä¸‹æ–‡ç¼ºå¤±

**å½±å“èŒƒå›´**: å…¨å±€  
**é£é™©ç­‰çº§**: ğŸŸ¡ P1ï¼ˆå½±å“æ’éšœæ•ˆç‡ï¼‰

**é—®é¢˜æ–‡ä»¶**:

- `app.js` - æ··ç”¨ `appLogger` å’Œ `console.log`
- `services/ChatWebSocketService.js` - å¤§é‡ä½¿ç”¨ `console.log`

```javascript
// app.js ä¸­æ··ç”¨ç¤ºä¾‹
appLogger.info('V4è®¤è¯ç³»ç»ŸåŠ è½½æˆåŠŸ', {
  /* ... */
}) // âœ… ç»“æ„åŒ–æ—¥å¿—
console.log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ') // âŒ çº¯æ–‡æœ¬è¾“å‡º

// ChatWebSocketService.js æ··ç”¨ç¤ºä¾‹
console.log(`ğŸ”Œ å®¢æˆ·ç«¯è¿æ¥æˆåŠŸ: ${socket.id}`) // âŒ ç¼ºå°‘ request_id
wsLogger.info('WebSocketæœåŠ¡å·²å¯åŠ¨', {
  /* ... */
}) // âœ… ç»“æ„åŒ–æ—¥å¿—
```

**é—®é¢˜å½±å“**:

- åŒä¸€è¯·æ±‚çš„æ—¥å¿—åˆ†æ•£åœ¨ä¸åŒæ ¼å¼é‡Œï¼Œéš¾ä»¥ä¸²è”
- æ— æ³•é€šè¿‡ request_id/trace_id è¿½è¸ªå®Œæ•´è°ƒç”¨é“¾
- æ—¥å¿—æ”¶é›†ç³»ç»Ÿï¼ˆå¦‚ ELKï¼‰è§£æå›°éš¾

**ä¿®å¤å»ºè®®**:

1. ç»Ÿä¸€ä½¿ç”¨ `Logger.create(module)` æˆ– `winston`
2. ä¸ºæ¯ä¸ªè¯·æ±‚ç”Ÿæˆ `request_id`ï¼Œå¹¶åœ¨æ•´ä¸ªè°ƒç”¨é“¾ä¼ é€’
3. WebSocketè¿æ¥ä¹Ÿåº”åˆ†é… `connection_id` å¹¶è®°å½•å…³è”å…³ç³»

---

## 3. é…ç½®ä¸ç¯å¢ƒå˜é‡

### é—®é¢˜æè¿°

ç¯å¢ƒå˜é‡ç®¡ç†å­˜åœ¨"è¦†ç›–é£é™©"å’Œ"ç¼ºå¤±æ ¡éªŒ"ï¼Œå¯èƒ½å¯¼è‡´ç”Ÿäº§ç¯å¢ƒé…ç½®è¢«æœ¬åœ°æ–‡ä»¶è¦†ç›–ï¼Œæˆ–å¯åŠ¨åæ‰å‘ç°å…³é”®é…ç½®ç¼ºå¤±ã€‚

### å…·ä½“é—®é¢˜

#### 3.1 dotenv override å¯¼è‡´ç”Ÿäº§é…ç½®è¢«è¦†ç›–

**å½±å“èŒƒå›´**: å…¨å±€  
**é£é™©ç­‰çº§**: ğŸ”´ P0ï¼ˆç”Ÿäº§äº‹æ•…çº§é£é™©ï¼‰

**é—®é¢˜æ–‡ä»¶**: `app.js` ç¬¬ 11-20 è¡Œ

```javascript
// âŒ å¼ºåˆ¶è¦†ç›–ç³»ç»Ÿç¯å¢ƒå˜é‡
require('dotenv').config({ override: true })
```

**é—®é¢˜åœºæ™¯**:

```bash
# å®¹å™¨/K8sæ³¨å…¥çš„ç¯å¢ƒå˜é‡
export DB_HOST=production-db.internal
export REDIS_HOST=redis-cluster.internal
export JWT_SECRET=prod_secret_xxx

# ä½†æ˜¯ .env æ–‡ä»¶ä¸­å†™ç€
DB_HOST=localhost
REDIS_HOST=localhost
JWT_SECRET=dev_secret_123

# å¯åŠ¨åä¼šä½¿ç”¨ .env çš„å€¼ï¼Œå¯¼è‡´ç”Ÿäº§ç¯å¢ƒè¿æ¥åˆ°å¼€å‘æ•°æ®åº“ï¼
```

**é£é™©å½±å“**:

- ç”Ÿäº§ç¯å¢ƒå¯èƒ½è¿æ¥åˆ°å¼€å‘/æµ‹è¯•æ•°æ®åº“
- JWT_SECRET è¢«è¦†ç›–å¯¼è‡´æ‰€æœ‰ç”¨æˆ· Token å¤±æ•ˆ
- Redisé…ç½®é”™è¯¯å¯¼è‡´é™æµ/ç¼“å­˜å¤±æ•ˆ

**ä¿®å¤æ–¹æ¡ˆ**:

```javascript
// âœ… æ–¹æ¡ˆ1ï¼šç§»é™¤ overrideï¼ˆæ¨èï¼‰
require('dotenv').config() // åªåœ¨ç¼ºå°‘æ—¶è¡¥å……ï¼Œä¸è¦†ç›–å·²æœ‰å€¼

// âœ… æ–¹æ¡ˆ2ï¼šä»…åœ¨å¼€å‘ç¯å¢ƒå…è®¸è¦†ç›–
if (process.env.NODE_ENV === 'development') {
  require('dotenv').config({ override: true })
} else {
  require('dotenv').config()
}

// âœ… æ–¹æ¡ˆ3ï¼šåœ¨éƒ¨ç½²æ–‡æ¡£ä¸­æ˜ç¡®è¦æ±‚åˆ é™¤ .env æ–‡ä»¶
// docs/éƒ¨ç½²æ‰‹å†Œ.md ä¸­æ·»åŠ ï¼š
// "ç”Ÿäº§ç¯å¢ƒç¦æ­¢åŒ…å« .env æ–‡ä»¶ï¼Œæ‰€æœ‰é…ç½®å¿…é¡»é€šè¿‡ç¯å¢ƒå˜é‡æ³¨å…¥"
```

#### 3.2 é…ç½®æ ¡éªŒæœªè‡ªåŠ¨æ‰§è¡Œ

**å½±å“èŒƒå›´**: `config/environment.js`  
**é£é™©ç­‰çº§**: ğŸŸ¡ P1ï¼ˆå¯åŠ¨åæ‰å‘ç°é…ç½®é”™è¯¯ï¼‰

**é—®é¢˜æ–‡ä»¶**: `config/environment.js` ç¬¬ 99-125 è¡Œ

```javascript
// å®šä¹‰äº† validateConfig() å‡½æ•°
function validateConfig() {
  const required = ['NODE_ENV', 'PORT', 'DB_HOST', 'DB_PORT', 'DB_NAME']
  const missing = required.filter(key => !process.env[key])
  if (missing.length > 0) {
    console.error('âŒ ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡:', missing)
    process.exit(1)
  }
}

// âŒ ä½†æ˜¯æ²¡æœ‰è‡ªåŠ¨æ‰§è¡Œï¼
// éœ€è¦æ‰‹åŠ¨è°ƒç”¨ require('./config/environment').validateConfig()
```

**é—®é¢˜å½±å“**:

- æœåŠ¡å¯åŠ¨åè¿è¡Œä¸€æ®µæ—¶é—´æ‰å› ä¸ºç¼ºå°‘é…ç½®è€Œå´©æºƒ
- é…ç½®é”™è¯¯éš¾ä»¥åœ¨å¯åŠ¨é˜¶æ®µå‘ç°

**ä¿®å¤æ–¹æ¡ˆ**:

```javascript
// åœ¨ config/environment.js åº•éƒ¨è‡ªåŠ¨æ‰§è¡Œ
if (require.main === module || process.env.NODE_ENV !== 'test') {
  validateConfig() // âœ… è‡ªåŠ¨æ ¡éªŒ
}

// æˆ–åœ¨ app.js å¯åŠ¨æ—¶å¼ºåˆ¶æ ¡éªŒ
const { validateConfig } = require('./config/environment')
validateConfig() // âœ… å¯åŠ¨æ—¶ç«‹å³æ£€æŸ¥
```

#### 3.3 æ•°æ®åº“é…ç½®åœ¨éæœåŠ¡åœºæ™¯ä¸‹ä¼šå¤±è´¥

**å½±å“èŒƒå›´**: å·¥å…·è„šæœ¬ã€æµ‹è¯•ç¯å¢ƒ  
**é£é™©ç­‰çº§**: ğŸŸ¡ P1ï¼ˆå½±å“å·¥å…·è„šæœ¬å¯ç”¨æ€§ï¼‰

**é—®é¢˜æ–‡ä»¶**: `config/database.js` ç¬¬ 127-142 è¡Œ

```javascript
// âœ… é…ç½®éªŒè¯å¾ˆå¥½
function validateDatabaseConfig() {
  const requiredVars = ['DB_HOST', 'DB_PORT', 'DB_USER', 'DB_PASSWORD', 'DB_NAME']
  const missingVars = requiredVars.filter(varName => !process.env[varName])
  if (missingVars.length > 0) {
    throw new Error(`ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡: ${missingVars.join(', ')}`)
  }
}

// âŒ ç«‹å³æ‰§è¡Œï¼Œå¯¼è‡´ä»»ä½• require('./config/database') çš„è„šæœ¬éƒ½å¿…é¡»æœ‰å®Œæ•´é…ç½®
validateDatabaseConfig()
```

**é—®é¢˜åœºæ™¯**:

```javascript
// scripts/utils/some-tool.js
const { User } = require('../models') // å†…éƒ¨ä¼š require('./config/database')
// âŒ å¦‚æœåªæ˜¯æƒ³è¯»å–æ¨¡å‹å®šä¹‰ï¼Œä½†æ²¡æœ‰é…ç½®æ•°æ®åº“ï¼Œä¼šç›´æ¥æŠ¥é”™
```

**ä¿®å¤å»ºè®®**:

```javascript
// æ–¹æ¡ˆ1ï¼šå»¶è¿Ÿæ ¡éªŒ
if (process.env.SKIP_DB_VALIDATION !== 'true') {
  validateDatabaseConfig()
}

// æ–¹æ¡ˆ2ï¼šåœ¨éœ€è¦å®é™…è¿æ¥æ—¶æ‰æ ¡éªŒ
// ç§»é™¤ç«‹å³æ‰§è¡Œï¼Œæ”¹ä¸ºåœ¨ testConnection() ä¸­æ‰§è¡Œ
```

---

## 4. WebSocketå®‰å…¨

### é—®é¢˜æè¿°

WebSocketè¿æ¥ç¼ºå°‘èº«ä»½éªŒè¯å’Œæƒé™æ ¡éªŒï¼Œå®¢æˆ·ç«¯å¯ä»¥è‡ªè¡Œå£°æ˜èº«ä»½ï¼ˆuser_id/user_typeï¼‰ï¼Œå­˜åœ¨è¶Šæƒå’Œèº«ä»½å†’å……é£é™©ã€‚

### å…·ä½“é—®é¢˜

#### 4.1 WebSocket CORS å®Œå…¨å¼€æ”¾

**å½±å“èŒƒå›´**: `services/ChatWebSocketService.js`  
**é£é™©ç­‰çº§**: ğŸ”´ P0ï¼ˆå®‰å…¨æ¼æ´ï¼‰

**é—®é¢˜æ–‡ä»¶**: `services/ChatWebSocketService.js` ç¬¬ 64-76 è¡Œ

```javascript
// âŒ å…è®¸ä»»ä½•åŸŸåè¿æ¥
this.io = socketIO(server, {
  cors: {
    origin: '*', // âŒ ç”Ÿäº§ç¯å¢ƒå¿…é¡»é™åˆ¶
    methods: ['GET', 'POST'],
    credentials: true
  },
  path: '/socket.io',
  transports: ['websocket', 'polling'],
  pingTimeout: 60000,
  pingInterval: 25000
})
```

**é£é™©å½±å“**:

- ä»»ä½•ç½‘ç«™éƒ½å¯ä»¥å»ºç«‹WebSocketè¿æ¥
- é’“é±¼ç½‘ç«™å¯ä»¥å†’å……å®˜æ–¹å®¢æœç•Œé¢
- æ— æ³•é˜²èŒƒCSRFç±»æ”»å‡»

**ä¿®å¤æ–¹æ¡ˆ**:

```javascript
// âœ… é™åˆ¶ä¸ºç™½åå•åŸŸå
const allowedOrigins = process.env.ALLOWED_ORIGINS
  ? process.env.ALLOWED_ORIGINS.split(',')
  : ['https://yourdomain.com']

this.io = socketIO(server, {
  cors: {
    origin: (origin, callback) => {
      if (!origin || allowedOrigins.includes(origin)) {
        callback(null, true)
      } else {
        callback(new Error('Not allowed by CORS'))
      }
    },
    methods: ['GET', 'POST'],
    credentials: true
  }
  // ... å…¶ä»–é…ç½®
})
```

#### 4.2 register_user äº‹ä»¶æ²¡æœ‰èº«ä»½éªŒè¯

**å½±å“èŒƒå›´**: `services/ChatWebSocketService.js`  
**é£é™©ç­‰çº§**: ğŸ”´ P0ï¼ˆå¯ç›´æ¥å†’å……ç®¡ç†å‘˜ï¼‰

**é—®é¢˜æ–‡ä»¶**: `services/ChatWebSocketService.js` ç¬¬ 145-236 è¡Œ

```javascript
// âŒ å®Œå…¨ä¿¡ä»»å®¢æˆ·ç«¯ä¼ å…¥çš„ user_id å’Œ user_type
socket.on('register_user', data => {
  const { user_id, user_type } = data // âŒ æ²¡æœ‰éªŒè¯ï¼

  if (user_type === 'user') {
    this.connectedUsers.set(user_id, socket.id) // âŒ ç›´æ¥æ³¨å†Œ
  } else if (user_type === 'admin') {
    this.connectedAdmins.set(user_id, socket.id) // âŒ å¯å†’å……ç®¡ç†å‘˜
  }
})
```

**æ”»å‡»åœºæ™¯**:

```javascript
// æ¶æ„å®¢æˆ·ç«¯ä»£ç 
socket.emit('register_user', {
  user_id: 1, // å†’å……è¶…çº§ç®¡ç†å‘˜
  user_type: 'admin' // å£°ç§°è‡ªå·±æ˜¯ç®¡ç†å‘˜
})
// âœ… æˆåŠŸæ³¨å†Œä¸ºç®¡ç†å‘˜ï¼Œå¯ä»¥æ¥æ”¶æ‰€æœ‰å®¢æœæ¶ˆæ¯å’Œç³»ç»Ÿé€šçŸ¥
```

**ä¿®å¤æ–¹æ¡ˆ**:

```javascript
// âœ… æ–¹æ¡ˆ1ï¼šæ¡æ‰‹æ—¶éªŒè¯JWTï¼ˆæ¨èï¼‰
this.io.use(async (socket, next) => {
  try {
    const token = socket.handshake.auth.token // ä»æ¡æ‰‹å‚æ•°è·å–token
    const decoded = jwt.verify(token, process.env.JWT_SECRET)

    // ä»æ•°æ®åº“è·å–çœŸå®ç”¨æˆ·ä¿¡æ¯
    const { getUserRoles } = require('../middleware/auth')
    const userRoles = await getUserRoles(decoded.user_id)

    socket.user = {
      user_id: decoded.user_id,
      user_type: userRoles.isAdmin ? 'admin' : 'user', // æœåŠ¡ç«¯åˆ¤å®š
      role_level: userRoles.role_level
    }
    next()
  } catch (error) {
    next(new Error('Authentication failed'))
  }
})

// âœ… register_user æ”¹ä¸ºä» socket.user è¯»å–
socket.on('register_user', () => {
  const { user_id, user_type } = socket.user // ä»æœåŠ¡ç«¯éªŒè¯åçš„æ•°æ®è¯»å–

  if (user_type === 'user') {
    this.connectedUsers.set(user_id, socket.id)
  } else if (user_type === 'admin') {
    this.connectedAdmins.set(user_id, socket.id)
  }

  socket.emit('register_success', { user_id, user_type })
})
```

---

## 5. æ•°æ®åº“è¿ç§»ä¸çœŸç›¸è¡¨åˆ‡æ¢

### é—®é¢˜æè¿°

é¡¹ç›®å¤„äº"æ–°æ—§è¡¨å¹¶å­˜"é˜¶æ®µï¼ˆUserInventory â†’ ItemInstance + market_listingsï¼‰ï¼Œå­˜åœ¨è¯»å†™è·¯å¾„ä¸ä¸€è‡´ã€çœŸç›¸è¡¨æ··ä¹±ã€å›è½é€»è¾‘é•¿æœŸå­˜åœ¨çš„é£é™©ã€‚

### å…·ä½“é—®é¢˜

#### 5.1 åŒè½¨æ¶æ„è¯»å†™è·¯å¾„ä¸ä¸€è‡´

**å½±å“èŒƒå›´**: åº“å­˜/å¸‚åœº/æ ¸é”€ç›¸å…³åŠŸèƒ½  
**é£é™©ç­‰çº§**: ğŸ”´ P0ï¼ˆæ•°æ®ä¸€è‡´æ€§é£é™©ï¼‰

**é—®é¢˜æ–‡ä»¶**:

- `services/BackpackService.js` - æ–°æ¥å£ï¼Œè¯»å– `item_instances`
- `services/InventoryService.js` - æ—§æ¥å£ï¼Œæ“ä½œ `user_inventory`
- éƒ¨åˆ†è·¯ç”±ä»è°ƒç”¨ `InventoryService.getUserInventory()`

**é£é™©åœºæ™¯**:

```javascript
// ç”¨æˆ·é€šè¿‡æ–°æ¥å£æŸ¥çœ‹èƒŒåŒ…
const backpack = await BackpackService.getUserBackpack(user_id)
// è¿”å›ï¼šitems: [] ï¼ˆç©ºï¼‰

// ä½†æ—§æ•°æ®ä»åœ¨ user_inventory è¡¨
const inventory = await InventoryService.getUserInventory(user_id)
// è¿”å›ï¼šinventory: [{ name: '100å…ƒä¼˜æƒ åˆ¸', status: 'available' }]

// ç”¨æˆ·çœ‹åˆ°èƒŒåŒ…ä¸ºç©ºï¼Œä½†å®é™…æœ‰å¯ç”¨ç‰©å“ï¼
```

**æ£€æŸ¥æ¸…å•**:

- [ ] ç¡®è®¤æ‰€æœ‰"èƒŒåŒ…æŸ¥è¯¢"è·¯ç”±ç»Ÿä¸€ä½¿ç”¨ `BackpackService.getUserBackpack()`
- [ ] ç¡®è®¤æ‰€æœ‰"ç‰©å“åˆ†å‘"é€»è¾‘å†™å…¥ `item_instances`ï¼ˆè€Œé `user_inventory`ï¼‰
- [ ] ç¡®è®¤æ‰€æœ‰"æ ¸é”€ç ç”Ÿæˆ"ä½¿ç”¨ `RedemptionOrderService.createOrder()`
- [ ] ç¡®è®¤æ‰€æœ‰"æ ¸é”€éªŒè¯"ä½¿ç”¨ `RedemptionOrderService.fulfillOrder()`

**è¿ç§»æ£€æŸ¥è„šæœ¬**:

```bash
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰è·¯ç”±ç›´æ¥è°ƒç”¨æ—§æ¥å£
grep -r "InventoryService.getUserInventory" routes/
grep -r "InventoryService.generateVerificationCode" routes/
grep -r "InventoryService.verifyCode" routes/

# æ£€æŸ¥æ˜¯å¦æœ‰ä»£ç ä»åœ¨å†™å…¥ user_inventory
grep -r "UserInventory.create" services/
grep -r "user_inventory" --include="*.js" services/ | grep -v "deprecated"
```

#### 5.2 å¸‚åœºç»Ÿè®¡çš„åŒè¡¨ç›¸åŠ é€»è¾‘

**å½±å“èŒƒå›´**: å¸‚åœºä¸Šæ¶ç»Ÿè®¡  
**é£é™©ç­‰çº§**: ğŸŸ¡ P1ï¼ˆæ•°æ®ä¸å‡†ç¡®ï¼‰

**é—®é¢˜æ–‡ä»¶**: `services/InventoryService.js` ç¬¬ 2488-2538 è¡Œ

```javascript
// âŒ åŒæ—¶ç»Ÿè®¡æ–°è¡¨å’Œæ—§è¡¨ï¼Œé•¿æœŸå­˜åœ¨ä¼šå¯¼è‡´æ•°æ®æ··ä¹±
const [marketListingsCount, legacyCount] = await Promise.all([
  MarketListing.count({ where: { seller_user_id: userId, status: 'on_sale' } }),
  UserInventory.count({ where: { user_id: userId, market_status: 'on_sale' } })
])

const onSaleCount = Number(marketListingsCount || 0) + Number(legacyCount || 0)
```

**é—®é¢˜å½±å“**:

- æ— æ³•åˆ¤æ–­ç”¨æˆ·å®é™…ä¸Šæ¶äº†å¤šå°‘ä»¶å•†å“
- è¿ç§»å®Œæˆåä»ä¿ç•™å›è½é€»è¾‘ï¼Œä»£ç æ°¸è¿œæ— æ³•åˆ é™¤
- ä¸¤å¥—ç»Ÿè®¡å£å¾„å¯¼è‡´æŠ¥è¡¨æ•°æ®ä¸ä¸€è‡´

**ä¿®å¤å»ºè®®**:

```javascript
// âœ… æ–¹æ¡ˆ1ï¼šè®¾å®šè¿ç§»æˆªæ­¢æ—¥æœŸ
const MIGRATION_CUTOFF_DATE = new Date('2025-12-31')

if (new Date() < MIGRATION_CUTOFF_DATE) {
  // è¿‡æ¸¡æœŸï¼šåŒè¡¨ç»Ÿè®¡
  const [newCount, legacyCount] = await Promise.all([
    /* ... */
  ])
  return { total: newCount + legacyCount, migration_active: true }
} else {
  // è¿ç§»å®Œæˆï¼šåªç»Ÿè®¡æ–°è¡¨
  const count = await MarketListing.count({
    /* ... */
  })
  return { total: count, migration_active: false }
}

// âœ… æ–¹æ¡ˆ2ï¼šæ·»åŠ è¿ç§»å®Œæˆæ ‡è®°
// åœ¨ç³»ç»Ÿè®¾ç½®è¡¨æ·»åŠ  `inventory_migration_completed` å­—æ®µ
const migrationCompleted = await SystemSettings.getValue('inventory_migration_completed')
if (migrationCompleted) {
  // åªç»Ÿè®¡æ–°è¡¨
} else {
  // åŒè¡¨ç»Ÿè®¡ + è®°å½•è­¦å‘Šæ—¥å¿—
  logger.warn('åº“å­˜è¿ç§»å°šæœªå®Œæˆï¼Œä»åœ¨ä½¿ç”¨åŒè¡¨ç»Ÿè®¡')
}
```

#### 5.3 å¤–é”®çº¦æŸä¸ç´¢å¼•ç¼ºå¤±

**å½±å“èŒƒå›´**: å…¨è¡¨  
**é£é™©ç­‰çº§**: ğŸŸ¡ P1ï¼ˆå½±å“äº‹åŠ¡æ€§èƒ½å’Œæ•°æ®å®Œæ•´æ€§ï¼‰

**æ£€æŸ¥é¡¹**:

```sql
-- æ£€æŸ¥å…³é”®è¡¨çš„å¤–é”®çº¦æŸ
SHOW CREATE TABLE item_instances;
SHOW CREATE TABLE market_listings;
SHOW CREATE TABLE redemption_orders;
SHOW CREATE TABLE asset_transactions;

-- æ£€æŸ¥å…³é”®ç´¢å¼•
SHOW INDEX FROM item_instances WHERE Key_name != 'PRIMARY';
SHOW INDEX FROM market_listings WHERE Key_name != 'PRIMARY';

-- æ£€æŸ¥å”¯ä¸€çº¦æŸï¼ˆå¹‚ç­‰é”®ï¼‰
SELECT TABLE_NAME, COLUMN_NAME, CONSTRAINT_NAME
FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE
WHERE TABLE_SCHEMA = 'your_db_name'
  AND CONSTRAINT_NAME LIKE '%business_id%';
```

**å¿…éœ€çš„ç´¢å¼•**:

```sql
-- item_instances
CREATE INDEX idx_item_instances_owner_status ON item_instances(owner_user_id, status);
CREATE INDEX idx_item_instances_status ON item_instances(status);

-- market_listings
CREATE UNIQUE INDEX idx_market_listings_business_id ON market_listings(business_id);
CREATE INDEX idx_market_listings_seller_status ON market_listings(seller_user_id, status);

-- asset_transactions
CREATE UNIQUE INDEX idx_asset_transactions_business_id_type ON asset_transactions(business_id, business_type);
CREATE INDEX idx_asset_transactions_user_asset ON asset_transactions(user_id, asset_code);
```

---

## 6. äº‹åŠ¡/å¹¶å‘/å¹‚ç­‰

### é—®é¢˜æè¿°

æ¶‰åŠèµ„é‡‘/èµ„äº§/åº“å­˜çš„æ“ä½œå¿…é¡»ä¿è¯åŸå­æ€§ã€å¹‚ç­‰æ€§å’Œå¹¶å‘å®‰å…¨æ€§ï¼Œå½“å‰ä»£ç ä¸­å­˜åœ¨éƒ¨åˆ†é«˜é£é™©è·¯å¾„ç¼ºå°‘å¹‚ç­‰é”®çº¦æŸæˆ–äº‹åŠ¡è¾¹ç•Œä¸æ¸…æ™°ã€‚

### å…·ä½“é—®é¢˜

#### 6.1 å¹‚ç­‰é”®æœªè¿›å…¥æ•°æ®åº“å”¯ä¸€çº¦æŸ

**å½±å“èŒƒå›´**: æ‰€æœ‰æ¶‰åŠæ‰£æ¬¾/æ‰£å‡/è½¬ç§»çš„æ¥å£  
**é£é™©ç­‰çº§**: ğŸ”´ P0ï¼ˆå¯èƒ½é‡å¤æ‰£æ¬¾ï¼‰

**é—®é¢˜ç¤ºä¾‹**: `services/InventoryService.js` ç¬¬ 1632-1728 è¡Œ

```javascript
// âœ… ä»£ç å±‚æœ‰å¹‚ç­‰æ£€æŸ¥
if (business_id) {
  const existingListing = await MarketListing.findOne({
    where: { business_id },
    transaction
  })
  if (existingListing) {
    return {
      /* å¹‚ç­‰è¿”å› */
    }
  }
}

// âš ï¸ ä½†æ•°æ®åº“å±‚æ²¡æœ‰å”¯ä¸€çº¦æŸï¼
// å¦‚æœå¹¶å‘è¯·æ±‚åŒæ—¶é€šè¿‡äº†ä¸Šé¢çš„æ£€æŸ¥ï¼Œä»ä¼šé‡å¤æ’å…¥
```

**å¹¶å‘æ”»å‡»åœºæ™¯**:

```javascript
// æ¶æ„å®¢æˆ·ç«¯åŒæ—¶å‘é€100ä¸ªç›¸åŒçš„è¯·æ±‚
for (let i = 0; i < 100; i++) {
  fetch('/api/v4/inventory/list', {
    body: JSON.stringify({
      business_id: 'same_id_12345', // ç›¸åŒçš„å¹‚ç­‰é”®
      item_id: 123,
      price_amount: 1000
    })
  })
}
// å¯èƒ½ç»•è¿‡ä»£ç æ£€æŸ¥ï¼Œç”Ÿæˆå¤šä¸ªæŒ‚ç‰Œè®°å½•
```

**ä¿®å¤æ–¹æ¡ˆ**:

```sql
-- âœ… åœ¨æ•°æ®åº“å±‚æ·»åŠ å”¯ä¸€çº¦æŸ
ALTER TABLE market_listings
ADD UNIQUE KEY uk_business_id (business_id);

ALTER TABLE asset_transactions
ADD UNIQUE KEY uk_business_id_type (business_id, business_type);

ALTER TABLE trade_orders
ADD UNIQUE KEY uk_business_id (business_id);

ALTER TABLE redemption_orders
ADD UNIQUE KEY uk_code_hash (code_hash);
```

**éªŒè¯æ–¹æ³•**:

```bash
# æ£€æŸ¥å“ªäº›è¡¨æœ‰ business_id å­—æ®µä½†ç¼ºå°‘å”¯ä¸€çº¦æŸ
mysql -e "
SELECT TABLE_NAME
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_SCHEMA = 'your_db'
  AND COLUMN_NAME = 'business_id'
  AND TABLE_NAME NOT IN (
    SELECT TABLE_NAME
    FROM INFORMATION_SCHEMA.STATISTICS
    WHERE TABLE_SCHEMA = 'your_db'
      AND COLUMN_NAME = 'business_id'
      AND NON_UNIQUE = 0
  )
"
```

#### 6.2 äº‹åŠ¡è¾¹ç•Œä¸æ¸…æ™°

**å½±å“èŒƒå›´**: å®¡è®¡æ—¥å¿—å†™å…¥  
**é£é™©ç­‰çº§**: ğŸŸ¡ P1ï¼ˆæ—¥å¿—å¯èƒ½ä¸¢å¤±æˆ–ä¸ä¸€è‡´ï¼‰

**é—®é¢˜æ–‡ä»¶**: `services/InventoryService.js` ç¬¬ 554-565 è¡Œ

```javascript
// ä¸šåŠ¡äº‹åŠ¡å·²æäº¤
if (shouldCommit) {
  await transaction.commit()
}

// âŒ å®¡è®¡æ—¥å¿—åœ¨äº‹åŠ¡å¤–å¼‚æ­¥å†™å…¥
try {
  await AuditLogService.logInventoryUse({
    operator_id: actorId,
    // ...
    transaction: shouldCommit ? null : transaction // âš ï¸ å·²æäº¤çš„äº‹åŠ¡ä¼  null
  })
} catch (auditError) {
  logger.error('å®¡è®¡æ—¥å¿—è®°å½•å¤±è´¥', { error: auditError.message })
}
```

**é—®é¢˜å½±å“**:

- ä¸šåŠ¡æ“ä½œæˆåŠŸä½†å®¡è®¡æ—¥å¿—å¤±è´¥ï¼ˆæ•°æ®ä¸ä¸€è‡´ï¼‰
- å¦‚æœå®¡è®¡æ—¥å¿—å¿…é¡»è®°å½•ï¼Œè¿™ç§å†™æ³•æ— æ³•ä¿è¯
- å›æ»šæ—¶å®¡è®¡æ—¥å¿—å¯èƒ½ä»ç„¶å†™å…¥

**ä¿®å¤å»ºè®®**:

```javascript
// âœ… æ–¹æ¡ˆ1ï¼šå®¡è®¡æ—¥å¿—åœ¨äº‹åŠ¡å†…å†™å…¥ï¼ˆæ¨èï¼‰
try {
  // ä¸šåŠ¡æ“ä½œ
  await item.update({ status: 'used' }, { transaction })

  // å®¡è®¡æ—¥å¿—ï¼ˆåŒä¸€äº‹åŠ¡ï¼‰
  await AuditLogService.logInventoryUse(
    {
      operator_id: actorId
      // ...
    },
    { transaction }
  ) // ä¼ å…¥åŒä¸€äº‹åŠ¡

  // ç»Ÿä¸€æäº¤
  if (shouldCommit) {
    await transaction.commit()
  }
} catch (error) {
  if (shouldCommit) {
    await transaction.rollback()
  }
  throw error
}

// âœ… æ–¹æ¡ˆ2ï¼šå®¡è®¡æ—¥å¿—æ”¹ä¸ºæ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥ï¼ˆè§£è€¦ï¼‰
// ä¸šåŠ¡æäº¤åå‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ï¼Œç”±ç‹¬ç«‹æœåŠ¡æ¶ˆè´¹
if (shouldCommit) {
  await transaction.commit()
}
await auditQueue.publish('inventory.used', {
  operator_id: actorId,
  item_id: itemId,
  timestamp: Date.now()
})
```

#### 6.3 é”ç²’åº¦ä¸è¶³

**å½±å“èŒƒå›´**: é«˜å¹¶å‘æ“ä½œ  
**é£é™©ç­‰çº§**: ğŸŸ¡ P1ï¼ˆå¯èƒ½å¯¼è‡´æ­»é”æˆ–è¶…å–ï¼‰

**é—®é¢˜ç¤ºä¾‹**:

```javascript
// âœ… ä»£ç ä½¿ç”¨äº†æ‚²è§‚é”
const item = await ItemInstance.findOne({
  where: { item_instance_id: itemId, owner_user_id: userId },
  lock: transaction.LOCK.UPDATE,
  transaction
})

// âš ï¸ ä½†éœ€è¦ç¡®è®¤ç´¢å¼•æ˜¯å¦æ”¯æŒè¡Œçº§é”
// å¦‚æœ where æ¡ä»¶æ— æ³•å‘½ä¸­ç´¢å¼•ï¼Œä¼šé€€åŒ–ä¸ºè¡¨é”
```

**æ£€æŸ¥æ–¹æ³•**:

```sql
-- æ£€æŸ¥å…³é”®æŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT * FROM item_instances
WHERE item_instance_id = 123 AND owner_user_id = 456
FOR UPDATE;

-- å¦‚æœ type=ALLï¼ˆå…¨è¡¨æ‰«æï¼‰ï¼Œéœ€è¦æ·»åŠ ç´¢å¼•
CREATE INDEX idx_item_owner ON item_instances(item_instance_id, owner_user_id);
```

---

## 7. æ€§èƒ½é£é™©

### é—®é¢˜æè¿°

å­˜åœ¨å…¸å‹çš„N+1æŸ¥è¯¢ã€Redis keysæ‰«æã€ç¼ºå°‘ç´¢å¼•ç­‰æ€§èƒ½é—®é¢˜ï¼Œåœ¨æ•°æ®é‡å¢é•¿åä¼šå¯¼è‡´å“åº”å˜æ…¢ç”šè‡³è¶…æ—¶ã€‚

### å…·ä½“é—®é¢˜

#### 7.1 èƒŒåŒ…èµ„äº§æŸ¥è¯¢çš„N+1é—®é¢˜

**å½±å“èŒƒå›´**: `BackpackService.getUserBackpack()`  
**é£é™©ç­‰çº§**: ğŸŸ¡ P1ï¼ˆéšèµ„äº§ç§ç±»å¢åŠ çº¿æ€§å˜æ…¢ï¼‰

**é—®é¢˜æ–‡ä»¶**: `services/BackpackService.js` ç¬¬ 141-158 è¡Œ

```javascript
// âŒ æ¯ä¸ªèµ„äº§å•ç‹¬æŸ¥ä¸€æ¬¡ material_asset_types
const formattedAssets = await Promise.all(
  validAssets.map(async account => {
    // âŒ N+1 æŸ¥è¯¢ï¼šå¦‚æœæœ‰20ç§èµ„äº§ï¼Œå°±ä¼šæ‰§è¡Œ20æ¬¡æŸ¥è¯¢
    const assetType = await MaterialAssetType.findOne({
      where: { asset_code: account.asset_code },
      transaction
    })
    return {
      asset_code: account.asset_code,
      display_name: assetType?.display_name || account.asset_code
      // ...
    }
  })
)
```

**æ€§èƒ½å½±å“**:

- ç”¨æˆ·æœ‰10ç§ææ–™ â†’ 11æ¬¡æŸ¥è¯¢ï¼ˆ1æ¬¡æŸ¥ä½™é¢ + 10æ¬¡æŸ¥ç±»å‹ï¼‰
- å“åº”æ—¶é—´éšèµ„äº§ç§ç±»çº¿æ€§å¢é•¿
- é«˜å¹¶å‘æ—¶ä¼šå¯¼è‡´æ•°æ®åº“è¿æ¥æ± è€—å°½

**ä¿®å¤æ–¹æ¡ˆ**:

```javascript
// âœ… æ–¹æ¡ˆ1ï¼šæ‰¹é‡æŸ¥è¯¢ï¼ˆæ¨èï¼‰
const assetCodes = validAssets.map(a => a.asset_code)
const assetTypes = await MaterialAssetType.findAll({
  where: { asset_code: assetCodes },
  transaction
})

const assetTypeMap = new Map(assetTypes.map(type => [type.asset_code, type]))

const formattedAssets = validAssets.map(account => {
  const assetType = assetTypeMap.get(account.asset_code)
  return {
    asset_code: account.asset_code,
    display_name: assetType?.display_name || account.asset_code
    // ...
  }
})

// âœ… æ–¹æ¡ˆ2ï¼šåœ¨ account_asset_balances å†—ä½™ display_name
// è¿ç§»æ—¶ä» material_asset_types åŒæ­¥è¿‡æ¥ï¼Œé¿å…æ¯æ¬¡join
```

#### 7.2 Redis keys æ‰«æ

**å½±å“èŒƒå›´**: `RateLimiterMiddleware.getStats()`  
**é£é™©ç­‰çº§**: ğŸŸ¡ P1ï¼ˆç”Ÿäº§ç¯å¢ƒä¼šå¡Redisï¼‰

**é—®é¢˜æ–‡ä»¶**: `middleware/RateLimiterMiddleware.js` ç¬¬ 293-324 è¡Œ

```javascript
async getStats (keyPattern = 'rate_limit:*') {
  // âŒ ä½¿ç”¨ keys å‘½ä»¤ï¼Œä¼šé˜»å¡Redis
  const client = await this.redisClient.ensureConnection()
  const keys = await client.keys(keyPattern)  // âš ï¸ O(N) å¤æ‚åº¦ï¼Œé˜»å¡å¼

  const stats = {
    total_keys: keys.length,
    keys: []
  }

  for (const key of keys.slice(0, 100)) {  // âš ï¸ å³ä½¿é™åˆ¶äº†100ä¸ªï¼Œkeysæœ¬èº«å·²ç»æ‰«æå…¨éƒ¨
    const count = await this.redisClient.zcard(key)
    // ...
  }
}
```

**é£é™©å½±å“**:

- `keys *` ä¼šæ‰«æRedisæ‰€æœ‰keyï¼Œé˜»å¡å…¶ä»–å‘½ä»¤
- ç”Ÿäº§ç¯å¢ƒæœ‰ç™¾ä¸‡çº§keyæ—¶ä¼šå¯¼è‡´Rediså‡æ­»
- å½±å“é™æµã€ç¼“å­˜ç­‰ä¾èµ–Redisçš„åŠŸèƒ½

**ä¿®å¤æ–¹æ¡ˆ**:

```javascript
// âœ… æ–¹æ¡ˆ1ï¼šæ”¹ç”¨ scanï¼ˆæ¨èï¼‰
async getStats (keyPattern = 'rate_limit:*') {
  const client = await this.redisClient.ensureConnection()
  const keys = []
  let cursor = '0'

  do {
    const [nextCursor, foundKeys] = await client.scan(
      cursor,
      'MATCH', keyPattern,
      'COUNT', 100
    )
    cursor = nextCursor
    keys.push(...foundKeys)

    if (keys.length >= 100) break  // é™åˆ¶æœ€å¤š100ä¸ª
  } while (cursor !== '0')

  // ... åç»­å¤„ç†
}

// âœ… æ–¹æ¡ˆ2ï¼šé™åˆ¶ä¸ºä»…ç®¡ç†å‘˜è°ƒç”¨ï¼Œä¸”å¢åŠ é¢‘ç‡é™åˆ¶
router.get('/api/v4/admin/rate-limiter/stats',
  authenticateToken,
  requireAdmin,
  createRateLimiter({ windowMs: 60000, max: 1 }),  // 1æ¬¡/åˆ†é’Ÿ
  async (req, res) => {
    const stats = await rateLimiter.getStats()
    return res.apiSuccess(stats)
  }
)
```

#### 7.3 ç¼ºå°‘å…³é”®ç´¢å¼•

**å½±å“èŒƒå›´**: å…¨è¡¨  
**é£é™©ç­‰çº§**: ğŸŸ¡ P1ï¼ˆæ…¢æŸ¥è¯¢ä¼šéšæ•°æ®å¢é•¿å˜æ…¢ï¼‰

**æ£€æŸ¥è„šæœ¬**:

```bash
# 1. å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
mysql -e "SET GLOBAL slow_query_log = 'ON';"
mysql -e "SET GLOBAL long_query_time = 1;"  # 1ç§’ä»¥ä¸Šç®—æ…¢æŸ¥è¯¢

# 2. è¿è¡Œä¸€æ®µæ—¶é—´ååˆ†ææ…¢æŸ¥è¯¢
mysqldumpslow -s t -t 10 /var/log/mysql/slow.log

# 3. å¯¹é«˜é¢‘æ…¢æŸ¥è¯¢æ·»åŠ ç´¢å¼•
# ä¾‹å¦‚ï¼š
# Query: SELECT * FROM item_instances WHERE status = 'available' ORDER BY created_at DESC
# æ·»åŠ ï¼šCREATE INDEX idx_status_created ON item_instances(status, created_at DESC);
```

**å¸¸è§ç¼ºå¤±ç´¢å¼•**:

```sql
-- èƒŒåŒ…æŸ¥è¯¢
CREATE INDEX idx_item_instances_owner_status ON item_instances(owner_user_id, status);

-- å¸‚åœºæŸ¥è¯¢
CREATE INDEX idx_market_listings_status_created ON market_listings(status, created_at DESC);

-- èµ„äº§æŸ¥è¯¢
CREATE INDEX idx_account_asset_balances_user_asset ON account_asset_balances(user_id, asset_code);

-- å®¡è®¡æ—¥å¿—æŸ¥è¯¢
CREATE INDEX idx_admin_operation_logs_operator_time ON admin_operation_logs(operator_id, created_at DESC);
```

---

## 8. æƒé™æ¨¡å‹ä¸ç¼“å­˜å¤±æ•ˆ

### é—®é¢˜æè¿°

æƒé™ç³»ç»Ÿä½¿ç”¨äº†"å†…å­˜ + Redis"åŒå±‚ç¼“å­˜ï¼Œä½†åœ¨è§’è‰²å˜æ›´æ—¶å¯èƒ½å‡ºç°ç¼“å­˜æœªåŠæ—¶å¤±æ•ˆï¼Œå¯¼è‡´æƒé™åˆ¤æ–­é”™è¯¯ã€‚

### å…·ä½“é—®é¢˜

#### 8.1 æƒé™å˜æ›´åç¼“å­˜æœªå¤±æ•ˆ

**å½±å“èŒƒå›´**: æ‰€æœ‰éœ€è¦æƒé™æ ¡éªŒçš„æ¥å£  
**é£é™©ç­‰çº§**: ğŸ”´ P0ï¼ˆå®‰å…¨æ¼æ´ï¼‰

**é—®é¢˜æ–‡ä»¶**: `middleware/auth.js` ç¼“å­˜æœºåˆ¶

```javascript
// ç¼“å­˜ç­–ç•¥
const MEMORY_TTL = 5 * 60 * 1000 // 5åˆ†é’Ÿ
const REDIS_TTL = 30 * 60 // 30åˆ†é’Ÿ

// âš ï¸ é—®é¢˜åœºæ™¯
// 1. ç”¨æˆ·è¢«åˆ†é…ç®¡ç†å‘˜è§’è‰²
await UserRole.create({ user_id: 123, role_id: 1 })

// 2. ç¼“å­˜æœªä¸»åŠ¨å¤±æ•ˆï¼Œç”¨æˆ·éœ€è¦ç­‰å¾…5-30åˆ†é’Ÿæ‰èƒ½ä½¿ç”¨ç®¡ç†å‘˜æƒé™
// 3. æˆ–è€…ï¼Œç”¨æˆ·ç®¡ç†å‘˜æƒé™è¢«æ’¤é”€ï¼Œä½†ä»å¯ä»¥åœ¨5-30åˆ†é’Ÿå†…ç»§ç»­ä½¿ç”¨
```

**æ£€æŸ¥æ¸…å•**:

```bash
# æ£€æŸ¥å“ªäº›åœ°æ–¹ä¿®æ”¹äº†è§’è‰²/æƒé™ï¼Œä½†æ²¡æœ‰è°ƒç”¨ invalidateUserPermissions()
grep -r "UserRole.create" services/
grep -r "UserRole.update" services/
grep -r "UserRole.destroy" services/
grep -r "Role.update" services/

# ç„¶åæ£€æŸ¥è¿™äº›ä½ç½®æ˜¯å¦æœ‰è°ƒç”¨
grep -B 5 -A 5 "UserRole.create" services/ | grep "invalidateUserPermissions"
```

**ä¿®å¤æ–¹æ¡ˆ**:

```javascript
// âœ… åœ¨æ‰€æœ‰æƒé™å˜æ›´å¤„ä¸»åŠ¨æ¸…é™¤ç¼“å­˜

// 1. åˆ†é…è§’è‰²æ—¶
async function assignRole(userId, roleId) {
  await UserRole.create({ user_id: userId, role_id: roleId })
  await invalidateUserPermissions(userId, 'role_assigned') // âœ… æ¸…é™¤ç¼“å­˜
}

// 2. æ’¤é”€è§’è‰²æ—¶
async function revokeRole(userId, roleId) {
  await UserRole.destroy({ where: { user_id: userId, role_id: roleId } })
  await invalidateUserPermissions(userId, 'role_revoked') // âœ… æ¸…é™¤ç¼“å­˜
}

// 3. ä¿®æ”¹è§’è‰²æƒé™æ—¶ï¼ˆå½±å“æ‰€æœ‰æ‹¥æœ‰è¯¥è§’è‰²çš„ç”¨æˆ·ï¼‰
async function updateRolePermissions(roleId, newPermissions) {
  await Role.update({ permissions: newPermissions }, { where: { role_id: roleId } })

  // âœ… æ‰¹é‡æ¸…é™¤æ‰€æœ‰æ‹¥æœ‰è¯¥è§’è‰²çš„ç”¨æˆ·ç¼“å­˜
  const userRoles = await UserRole.findAll({ where: { role_id: roleId } })
  const userIds = userRoles.map(ur => ur.user_id)
  await PermissionManager.invalidateMultipleUsers(userIds, 'role_permissions_updated')
}

// 4. åœç”¨ç”¨æˆ·æ—¶
async function disableUser(userId) {
  await User.update({ status: 'inactive' }, { where: { user_id: userId } })
  await invalidateUserPermissions(userId, 'user_disabled') // âœ… æ¸…é™¤ç¼“å­˜
}
```

#### 8.2 WebSocketè¿æ¥æœªç›‘å¬æƒé™å˜æ›´

**å½±å“èŒƒå›´**: WebSocketå®æ—¶é€šçŸ¥  
**é£é™©ç­‰çº§**: ğŸŸ¡ P1ï¼ˆæƒé™å˜æ›´åä»èƒ½æ”¶åˆ°æ•æ„Ÿæ¶ˆæ¯ï¼‰

**é—®é¢˜ç¤ºä¾‹**:

```javascript
// 1. ç”¨æˆ·Aè¢«åˆ†é…ä¸ºç®¡ç†å‘˜ï¼Œå»ºç«‹WebSocketè¿æ¥
socket.emit('register_user', { user_id: 'A', user_type: 'admin' })

// 2. ç®¡ç†å‘˜æƒé™è¢«æ’¤é”€
await UserRole.destroy({ where: { user_id: 'A', role_id: 1 } })

// 3. ä½†WebSocketè¿æ¥ä»ä¿æŒï¼Œç»§ç»­æ¥æ”¶ç®¡ç†å‘˜é€šçŸ¥
// âŒ ç”¨æˆ·Aä»ç„¶èƒ½æ”¶åˆ°æ‰€æœ‰å®¢æœæ¶ˆæ¯å’Œç³»ç»Ÿé€šçŸ¥
```

**ä¿®å¤æ–¹æ¡ˆ**:

```javascript
// âœ… åœ¨æƒé™å˜æ›´æ—¶ä¸»åŠ¨æ–­å¼€WebSocketè¿æ¥
async function revokeRole(userId, roleId) {
  await UserRole.destroy({ where: { user_id: userId, role_id: roleId } })
  await invalidateUserPermissions(userId, 'role_revoked')

  // âœ… å¼ºåˆ¶æ–­å¼€WebSocketè¿æ¥ï¼Œç”¨æˆ·éœ€è¦é‡æ–°è¿æ¥ï¼ˆä¼šé‡æ–°é‰´æƒï¼‰
  const ChatWebSocketService = require('../services/ChatWebSocketService')
  ChatWebSocketService.disconnectUser(userId, 'admin')

  logger.info('ç”¨æˆ·æƒé™å˜æ›´ï¼Œå·²æ–­å¼€WebSocketè¿æ¥', {
    user_id: userId,
    role_id: roleId
  })
}
```

---

## 9. ä¿®å¤ä¼˜å…ˆçº§ä¸å»ºè®®

### P0 çº§åˆ«ï¼ˆå¿…é¡»ç«‹å³ä¿®å¤ï¼Œå½±å“å®‰å…¨/æ•°æ®ä¸€è‡´æ€§ï¼‰

| åºå· | é—®é¢˜                        | å½±å“              | ä¿®å¤å·¥ä½œé‡     |
| ---- | --------------------------- | ----------------- | -------------- |
| 1    | WebSocketæ— èº«ä»½éªŒè¯         | å¯å†’å……ç®¡ç†å‘˜      | ä¸­ï¼ˆ1-2å¤©ï¼‰    |
| 2    | å¹‚ç­‰é”®ç¼ºå°‘å”¯ä¸€çº¦æŸ          | å¯èƒ½é‡å¤æ‰£æ¬¾      | å°ï¼ˆ1å¤©ï¼‰      |
| 3    | dotenv overrideè¦†ç›–ç”Ÿäº§é…ç½® | ç”Ÿäº§äº‹æ•…é£é™©      | æå°ï¼ˆ10åˆ†é’Ÿï¼‰ |
| 4    | APIå“åº”æ ¼å¼æ··ç”¨             | å‰ç«¯é›†æˆå›°éš¾      | å¤§ï¼ˆ3-5å¤©ï¼‰    |
| 5    | Rediså¥åº·æ£€æŸ¥å ä½           | ç›‘æ§å‘Šè­¦å¤±æ•ˆ      | æå°ï¼ˆ30åˆ†é’Ÿï¼‰ |
| 6    | æƒé™ç¼“å­˜å¤±æ•ˆé—æ¼            | æƒé™æå‡/æ’¤é”€å»¶è¿Ÿ | ä¸­ï¼ˆ1-2å¤©ï¼‰    |

### P1 çº§åˆ«ï¼ˆåº”å°½å¿«ä¿®å¤ï¼Œå½±å“æ€§èƒ½/è¿ç»´ï¼‰

| åºå· | é—®é¢˜               | å½±å“             | ä¿®å¤å·¥ä½œé‡           |
| ---- | ------------------ | ---------------- | -------------------- |
| 7    | N+1æŸ¥è¯¢é—®é¢˜        | å“åº”å˜æ…¢         | å°ï¼ˆ1å¤©ï¼‰            |
| 8    | Redis keysæ‰«æ     | Redisé˜»å¡        | å°ï¼ˆ1å¤©ï¼‰            |
| 9    | æ—¥å¿—ç³»ç»Ÿæ··ç”¨       | æ’éšœå›°éš¾         | ä¸­ï¼ˆ2-3å¤©ï¼‰          |
| 10   | é…ç½®æ ¡éªŒæœªè‡ªåŠ¨æ‰§è¡Œ | å¯åŠ¨å»¶è¿Ÿå‘ç°é”™è¯¯ | æå°ï¼ˆ30åˆ†é’Ÿï¼‰       |
| 11   | åŒè½¨æ¶æ„å›è½é€»è¾‘   | æ•°æ®æ··ä¹±         | å¤§ï¼ˆéœ€ç¡®è®¤è¿ç§»çŠ¶æ€ï¼‰ |

### P2 çº§åˆ«ï¼ˆæŠ€æœ¯å€ºåŠ¡ï¼Œå¯å»¶åå¤„ç†ï¼‰

| åºå· | é—®é¢˜               | å½±å“             | ä¿®å¤å·¥ä½œé‡     |
| ---- | ------------------ | ---------------- | -------------- |
| 12   | ç¼ºå°‘å…³é”®ç´¢å¼•       | æ…¢æŸ¥è¯¢           | å°ï¼ˆæŒç»­ä¼˜åŒ–ï¼‰ |
| 13   | äº‹åŠ¡è¾¹ç•Œä¸æ¸…æ™°     | å®¡è®¡æ—¥å¿—å¯èƒ½ä¸¢å¤± | ä¸­ï¼ˆ2å¤©ï¼‰      |
| 14   | WebSocket CORSå¼€æ”¾ | é’“é±¼é£é™©         | æå°ï¼ˆ10åˆ†é’Ÿï¼‰ |

### ä¿®å¤æµç¨‹å»ºè®®

#### ç¬¬ä¸€é˜¶æ®µï¼šå¿«é€Ÿä¿®å¤ï¼ˆ1-2å¤©ï¼‰

```bash
# 1. ä¿®æ”¹ dotenv é…ç½®ï¼ˆ10åˆ†é’Ÿï¼‰
# app.js: require('dotenv').config({ override: true })
#      â†’ require('dotenv').config()

# 2. ä¿®å¤ Redis å¥åº·æ£€æŸ¥ï¼ˆ30åˆ†é’Ÿï¼‰
# app.js: æ·»åŠ çœŸå®çš„ isRedisHealthy() è°ƒç”¨

# 3. æ·»åŠ å¹‚ç­‰é”®å”¯ä¸€çº¦æŸï¼ˆ1å°æ—¶ï¼‰
mysql -e "
ALTER TABLE market_listings ADD UNIQUE KEY uk_business_id (business_id);
ALTER TABLE asset_transactions ADD UNIQUE KEY uk_business_id_type (business_id, business_type);
ALTER TABLE trade_orders ADD UNIQUE KEY uk_business_id (business_id);
"

# 4. WebSocket CORS é™åˆ¶ï¼ˆ10åˆ†é’Ÿï¼‰
# ChatWebSocketService.js: origin: '*' â†’ ç™½åå•

# 5. é…ç½®è‡ªåŠ¨æ ¡éªŒï¼ˆ30åˆ†é’Ÿï¼‰
# environment.js: æ–‡ä»¶åº•éƒ¨æ·»åŠ  validateConfig()
```

#### ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒä¿®å¤ï¼ˆ3-5å¤©ï¼‰

```bash
# 1. WebSocketèº«ä»½éªŒè¯ï¼ˆ1-2å¤©ï¼‰
# - å®ç°æ¡æ‰‹é‰´æƒ
# - ä¿®æ”¹ register_user é€»è¾‘
# - æ·»åŠ æƒé™å˜æ›´ç›‘å¬

# 2. ç»Ÿä¸€APIå“åº”æ ¼å¼ï¼ˆ3-5å¤©ï¼‰
# - ä¿®æ”¹ errorHandler.js
# - ä¿®æ”¹ app.js çš„ 404 å¤„ç†
# - ä¿®æ­£ ApiResponse.badRequest() ç­‰æ–¹æ³•
# - æ‰¹é‡ä¿®æ”¹è·¯ç”±è°ƒç”¨æ–¹å¼

# 3. æƒé™ç¼“å­˜å¤±æ•ˆè¡¥å…¨ï¼ˆ1-2å¤©ï¼‰
# - æŸ¥æ‰¾æ‰€æœ‰æƒé™å˜æ›´ç‚¹
# - æ·»åŠ  invalidateUserPermissions() è°ƒç”¨
# - æ·»åŠ  WebSocket æ–­å¼€é€»è¾‘
```

#### ç¬¬ä¸‰é˜¶æ®µï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆ2-3å¤©ï¼‰

```bash
# 1. ä¿®å¤ N+1 æŸ¥è¯¢ï¼ˆ1å¤©ï¼‰
# BackpackService: æ”¹ä¸ºæ‰¹é‡æŸ¥è¯¢

# 2. Redis keys æ”¹ä¸º scanï¼ˆ1å¤©ï¼‰
# RateLimiterMiddleware: é‡å†™ getStats()

# 3. æ·»åŠ ç¼ºå¤±ç´¢å¼•ï¼ˆæŒç»­ï¼‰
# åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œé€æ­¥æ·»åŠ 
```

#### ç¬¬å››é˜¶æ®µï¼šæ¶æ„æ¸…ç†ï¼ˆéœ€ç¡®è®¤è¿ç§»çŠ¶æ€ï¼‰

```bash
# 1. ç¡®è®¤åº“å­˜è¿ç§»å®Œæˆåº¦
node scripts/check-inventory-migration-status.js

# 2. å¦‚æœè¿ç§»å®Œæˆï¼Œåˆ é™¤å›è½é€»è¾‘
# - ç§»é™¤åŒè¡¨ç»Ÿè®¡
# - åˆ é™¤æ—§æ¥å£å…¼å®¹å±‚
# - æ›´æ–°æ–‡æ¡£

# 3. å¦‚æœè¿ç§»æœªå®Œæˆï¼Œæ·»åŠ æˆªæ­¢æ—¥æœŸ
# - åœ¨ä»£ç ä¸­æ·»åŠ  MIGRATION_CUTOFF_DATE
# - åˆ¶å®šè¿ç§»å®Œæˆè®¡åˆ’
```

### éªŒè¯æ£€æŸ¥è¡¨

å®Œæˆä¿®å¤åï¼Œä½¿ç”¨ä»¥ä¸‹æ£€æŸ¥è¡¨éªŒè¯ï¼š

```bash
# âœ… P0 é—®é¢˜éªŒè¯
[ ] WebSocket æ¡æ‰‹éœ€è¦æœ‰æ•ˆ JWT
[ ] æ¶æ„è¯·æ±‚æ— æ³•å†’å……ç®¡ç†å‘˜
[ ] ç›¸åŒ business_id æ— æ³•é‡å¤æ’å…¥ï¼ˆæ•°æ®åº“å±‚é˜»æ­¢ï¼‰
[ ] ç”Ÿäº§ç¯å¢ƒä¸ä¼šè¯»å– .env æ–‡ä»¶
[ ] /health çœŸå®æ£€æŸ¥ Redis è¿æ¥
[ ] æƒé™æ’¤é”€åç«‹å³ç”Ÿæ•ˆï¼ˆç¼“å­˜å¤±æ•ˆï¼‰

# âœ… P1 é—®é¢˜éªŒè¯
[ ] èƒŒåŒ…æŸ¥è¯¢åªæ‰§è¡Œ2æ¬¡æ•°æ®åº“æŸ¥è¯¢ï¼ˆèµ„äº§ + ç‰©å“ï¼‰
[ ] getStats() ä½¿ç”¨ scan è€Œé keys
[ ] æ‰€æœ‰æ—¥å¿—åŒ…å« request_id æˆ– connection_id
[ ] å¯åŠ¨æ—¶è‡ªåŠ¨æ ¡éªŒé…ç½®ï¼Œç¼ºå°‘é…ç½®ç«‹å³æŠ¥é”™

# âœ… P2 é—®é¢˜éªŒè¯
[ ] æ…¢æŸ¥è¯¢æ—¥å¿—æ— 1ç§’ä»¥ä¸ŠæŸ¥è¯¢
[ ] å®¡è®¡æ—¥å¿—åœ¨äº‹åŠ¡å†…æˆ–æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥
[ ] WebSocket CORS é™åˆ¶ä¸ºç™½åå•
```

---

## é™„å½•Aï¼šå¿«é€Ÿè‡ªæ£€è„šæœ¬

å°†ä»¥ä¸‹è„šæœ¬ä¿å­˜ä¸º `scripts/health-check.sh`ï¼š

```bash
#!/bin/bash
# åç«¯é¡¹ç›®å¥åº·æ£€æŸ¥è„šæœ¬

echo "=== å¼€å§‹å¥åº·æ£€æŸ¥ ==="

# 1. æ£€æŸ¥ç¯å¢ƒå˜é‡
echo "1. æ£€æŸ¥å…³é”®ç¯å¢ƒå˜é‡..."
required_vars=("DB_HOST" "DB_PORT" "REDIS_HOST" "JWT_SECRET")
for var in "${required_vars[@]}"; do
  if [ -z "${!var}" ]; then
    echo "âŒ ç¼ºå°‘ç¯å¢ƒå˜é‡: $var"
  else
    echo "âœ… $var å·²è®¾ç½®"
  fi
done

# 2. æ£€æŸ¥æ•°æ®åº“è¿æ¥
echo "2. æ£€æŸ¥æ•°æ®åº“è¿æ¥..."
node -e "
const { testConnection } = require('./config/database');
testConnection().then(ok => {
  if (ok) {
    console.log('âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸');
    process.exit(0);
  } else {
    console.log('âŒ æ•°æ®åº“è¿æ¥å¤±è´¥');
    process.exit(1);
  }
});
"

# 3. æ£€æŸ¥ Redis è¿æ¥
echo "3. æ£€æŸ¥ Redis è¿æ¥..."
node -e "
const { isRedisHealthy } = require('./utils/UnifiedRedisClient');
isRedisHealthy().then(ok => {
  if (ok) {
    console.log('âœ… Redis è¿æ¥æ­£å¸¸');
    process.exit(0);
  } else {
    console.log('âŒ Redis è¿æ¥å¤±è´¥');
    process.exit(1);
  }
});
"

# 4. æ£€æŸ¥å¹‚ç­‰é”®å”¯ä¸€çº¦æŸ
echo "4. æ£€æŸ¥å¹‚ç­‰é”®å”¯ä¸€çº¦æŸ..."
mysql -u$DB_USER -p$DB_PASSWORD -h$DB_HOST -e "
SELECT TABLE_NAME, COLUMN_NAME
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_SCHEMA = '$DB_NAME'
  AND COLUMN_NAME = 'business_id'
  AND TABLE_NAME NOT IN (
    SELECT TABLE_NAME
    FROM INFORMATION_SCHEMA.STATISTICS
    WHERE TABLE_SCHEMA = '$DB_NAME'
      AND COLUMN_NAME = 'business_id'
      AND NON_UNIQUE = 0
  );
" | while read table column; do
  echo "âš ï¸ è¡¨ $table çš„ business_id å­—æ®µç¼ºå°‘å”¯ä¸€çº¦æŸ"
done

# 5. æ£€æŸ¥å…³é”®ç´¢å¼•
echo "5. æ£€æŸ¥å…³é”®ç´¢å¼•..."
critical_indexes=(
  "item_instances:idx_item_instances_owner_status"
  "market_listings:idx_market_listings_seller_status"
  "account_asset_balances:idx_account_balances_user_asset"
)

for index_pair in "${critical_indexes[@]}"; do
  IFS=':' read -r table index <<< "$index_pair"
  count=$(mysql -u$DB_USER -p$DB_PASSWORD -h$DB_HOST -se "
    SELECT COUNT(*)
    FROM INFORMATION_SCHEMA.STATISTICS
    WHERE TABLE_SCHEMA = '$DB_NAME'
      AND TABLE_NAME = '$table'
      AND INDEX_NAME = '$index';
  ")

  if [ "$count" -eq 0 ]; then
    echo "âš ï¸ ç¼ºå°‘ç´¢å¼•: $table.$index"
  else
    echo "âœ… ç´¢å¼•å­˜åœ¨: $table.$index"
  fi
done

echo "=== å¥åº·æ£€æŸ¥å®Œæˆ ==="
```

---

## é™„å½•Bï¼šæ•°æ®ä¸€è‡´æ€§éªŒè¯è„šæœ¬

å°†ä»¥ä¸‹è„šæœ¬ä¿å­˜ä¸º `scripts/check-data-consistency.js`ï¼š

```javascript
/**
 * æ•°æ®ä¸€è‡´æ€§éªŒè¯è„šæœ¬
 * ç”¨äºæ£€æŸ¥æ–°æ—§è¡¨æ•°æ®æ˜¯å¦ä¸€è‡´
 */

const { sequelize } = require('../config/database')
const { UserInventory, ItemInstance, MarketListing } = require('../models')

async function checkInventoryMigration() {
  console.log('æ£€æŸ¥åº“å­˜è¿ç§»çŠ¶æ€...')

  // 1. ç»Ÿè®¡æ—§è¡¨æ•°æ®
  const oldInventoryCount = await UserInventory.count()
  console.log(`æ—§è¡¨ user_inventory: ${oldInventoryCount} æ¡è®°å½•`)

  // 2. ç»Ÿè®¡æ–°è¡¨æ•°æ®
  const newInventoryCount = await ItemInstance.count()
  console.log(`æ–°è¡¨ item_instances: ${newInventoryCount} æ¡è®°å½•`)

  // 3. æ£€æŸ¥æ˜¯å¦æœ‰è®°å½•ä»…åœ¨æ—§è¡¨
  const unmigrated = await sequelize.query(
    `
    SELECT ui.inventory_id, ui.name, ui.user_id
    FROM user_inventory ui
    LEFT JOIN item_instances ii ON ui.inventory_id = ii.legacy_inventory_id
    WHERE ii.item_instance_id IS NULL
    LIMIT 10
  `,
    { type: sequelize.QueryTypes.SELECT }
  )

  if (unmigrated.length > 0) {
    console.log(`âš ï¸ å‘ç° ${unmigrated.length} æ¡æœªè¿ç§»çš„è®°å½•ï¼ˆä»…æ˜¾ç¤ºå‰10æ¡ï¼‰:`)
    console.table(unmigrated)
  } else {
    console.log('âœ… æ‰€æœ‰è®°å½•å·²è¿ç§»')
  }
}

async function checkMarketListings() {
  console.log('\næ£€æŸ¥å¸‚åœºæŒ‚ç‰Œä¸€è‡´æ€§...')

  // æ£€æŸ¥æ˜¯å¦æœ‰ç‰©å“åœ¨ market_listings ä½†ä¸åœ¨ item_instances
  const orphanListings = await sequelize.query(
    `
    SELECT ml.listing_id, ml.offer_item_instance_id
    FROM market_listings ml
    LEFT JOIN item_instances ii ON ml.offer_item_instance_id = ii.item_instance_id
    WHERE ml.listing_kind = 'item_instance'
      AND ii.item_instance_id IS NULL
  `,
    { type: sequelize.QueryTypes.SELECT }
  )

  if (orphanListings.length > 0) {
    console.log(`âŒ å‘ç° ${orphanListings.length} æ¡å­¤å„¿æŒ‚ç‰Œè®°å½•:`)
    console.table(orphanListings)
  } else {
    console.log('âœ… å¸‚åœºæŒ‚ç‰Œæ•°æ®ä¸€è‡´')
  }
}

async function checkBusinessIdUniqueness() {
  console.log('\næ£€æŸ¥å¹‚ç­‰é”®å”¯ä¸€æ€§...')

  const tables = ['market_listings', 'asset_transactions', 'trade_orders']

  for (const table of tables) {
    const duplicates = await sequelize.query(
      `
      SELECT business_id, COUNT(*) as count
      FROM ${table}
      WHERE business_id IS NOT NULL
      GROUP BY business_id
      HAVING COUNT(*) > 1
      LIMIT 10
    `,
      { type: sequelize.QueryTypes.SELECT }
    )

    if (duplicates.length > 0) {
      console.log(`âŒ è¡¨ ${table} å­˜åœ¨é‡å¤çš„ business_id:`)
      console.table(duplicates)
    } else {
      console.log(`âœ… è¡¨ ${table} çš„ business_id å”¯ä¸€`)
    }
  }
}

async function main() {
  try {
    await checkInventoryMigration()
    await checkMarketListings()
    await checkBusinessIdUniqueness()

    console.log('\n=== æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å®Œæˆ ===')
    process.exit(0)
  } catch (error) {
    console.error('æ£€æŸ¥å¤±è´¥:', error)
    process.exit(1)
  }
}

main()
```

---

## é™„å½•Cï¼šå‚è€ƒæ–‡æ¡£

- [æ¥å£è§„èŒƒæ–‡æ¡£](./è·¯ç”±å±‚ã€æ¨¡å‹å±‚ã€æœåŠ¡å±‚ã€æ•°æ®ä¸€è‡´æ€§æ–‡æ¡£.md)
- [æ ¸é”€ç ä¸šåŠ¡è§„åˆ™](./æ ¸é”€ç ä¸šåŠ¡è§„åˆ™è¯´æ˜-è¿è¥æ‰‹å†Œ.md)
- [è¿è¥äººå‘˜æ‰‹å†Œ](./è¿è¥äººå‘˜å®Œæ•´ä½¿ç”¨æ‰‹å†Œ.md)
- [æ•°æ®åº“è¿ç§»è®°å½•](../migrations/)

---

**æ–‡æ¡£ç»´æŠ¤**: è¯·åœ¨ä¿®å¤æ¯ä¸ªé—®é¢˜åï¼Œåœ¨æœ¬æ–‡æ¡£å¯¹åº”çš„æ£€æŸ¥é¡¹æ‰“å‹¾ âœ…ï¼Œå¹¶æ³¨æ˜ä¿®å¤æ—¶é—´å’Œè´Ÿè´£äººã€‚

**æœ€åæ›´æ–°**: 2025å¹´12æœˆ  
**è´Ÿè´£äºº**: åç«¯å¼€å‘å›¢é˜Ÿ  
**å®¡æ ¸äºº**: æŠ€æœ¯è´Ÿè´£äºº
