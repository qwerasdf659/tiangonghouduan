# å…¬å‘Šå¼¹çª—ç³»ç»Ÿç°çŠ¶åˆ†æ â€” åç«¯æ•°æ®åº“å®é™…æ±‚è¯

> **é¡¹ç›®**: å¤©å·¥å°ç¨‹åºï¼ˆé¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ V4.0ï¼‰  
> **åˆ›å»ºæ—¶é—´**: 2026-02-20  
> **äºŒæ¬¡æ±‚è¯æ—¶é—´**: 2026-02-20ï¼ˆNode.js ç›´è¿ç”Ÿäº§æ•°æ®åº“ + åç«¯/å‰ç«¯ä»£ç è¿½è¸ªï¼‰  
> **çŠ¶æ€**: 4 é¡¹å†³ç­–å·²æ‹æ¿ + ğŸ”´ 2 é¡¹ä»£ç ç¼ºé™·å·²å‘ç° + â“ 3 é¡¹æ–°å†³ç­–å¾…æ‹æ¿

---

## é›¶ã€é¡¹ç›®å®é™…æŠ€æœ¯æ ˆå’Œæ¶æ„

> ä»¥ä¸‹ä¿¡æ¯å‡æ¥è‡ªåç«¯é¡¹ç›®å®é™…ä»£ç å’Œæ•°æ®åº“çœŸå®æ•°æ®ï¼Œä¸å¼•ç”¨ä»»ä½•å†å²æŠ¥å‘Šã€‚

### ä¸‰ç«¯åˆ†ç¦»æ¶æ„

| ç«¯ | æŠ€æœ¯æ ˆ | ä»£ç ä½ç½® |
|----|--------|----------|
| åç«¯ API æœåŠ¡ | Node.js + Express + Sequelize + MySQL | æœ¬ä»“åº“æ ¹ç›®å½• (`/home/devbox/project/`) |
| Web ç®¡ç†åå° | Vite + Alpine.js + Tailwind CSS | æœ¬ä»“åº“ `/admin/` ç›®å½• |
| å¾®ä¿¡å°ç¨‹åºå‰ç«¯ | å¾®ä¿¡åŸç”Ÿå°ç¨‹åºï¼ˆå¤©å·¥å°ç¨‹åºï¼‰ | **ä¸åœ¨æœ¬ä»“åº“ï¼Œç‹¬ç«‹é¡¹ç›®** |

### å•†ä¸šæ¨¡å¼

é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ â€” ç”¨æˆ·é€šè¿‡æ¶ˆè´¹è·å–ç§¯åˆ†ï¼Œç§¯åˆ†å¯æŠ½å¥–/å…‘æ¢å•†å“ï¼Œç³»ç»ŸåŒ…å«å¹¿å‘ŠæŠ•æ”¾ã€äº¤æ˜“å¸‚åœºã€è‡»é€‰ç©ºé—´ç­‰å˜ç°æ¨¡å—ã€‚å…¬å‘Šå’Œå¼¹çª—å±äºå†…å®¹è¿è¥å·¥å…·ï¼Œç”±ç®¡ç†å‘˜é€šè¿‡ Web ç®¡ç†åå°å‘å¸ƒï¼Œå¾®ä¿¡å°ç¨‹åºç«¯å±•ç¤ºç»™ C ç«¯ç”¨æˆ·ã€‚

### åç«¯æ¶æ„æ¨¡å¼

- **ServiceManager æ¨¡å¼**: è·¯ç”±é€šè¿‡ `req.app.locals.services.getService('xxx')` è·å–æœåŠ¡
- **API ç‰ˆæœ¬**: V4ï¼Œè·¯å¾„å‰ç¼€ `/api/v4`
- **å›¾ç‰‡å­˜å‚¨**: Sealos å¯¹è±¡å­˜å‚¨ï¼Œæ¨¡å‹å±‚åªå­˜ object keyï¼Œå‰ç«¯é€šè¿‡ `ImageUrlHelper.getImageUrl()` ç”Ÿæˆå®Œæ•´ CDN URL
- **æ•°æ®åº“**: MySQLï¼ˆSealos äº‘æ‰˜ç®¡ï¼Œå¤–ç½‘åœ°å€ `dbconn.sealosbja.site:42569`ï¼‰

---

## ä¸€ã€å…¬å‘Šå¼¹çª—ç³»ç»Ÿçš„ä¸¤å¥—ç‹¬ç«‹æœºåˆ¶

ç®¡ç†åå°"å†…å®¹ç®¡ç†ä¸­å¿ƒ"åŒ…å« 4 ä¸ª Tabï¼Œå…¶ä¸­ä¸å…¬å‘Š/æ¶ˆæ¯ç›¸å…³çš„æ˜¯ä¸¤å¥—**å®Œå…¨ç‹¬ç«‹**çš„æœºåˆ¶ï¼š

### æœºåˆ¶ 1ï¼šç³»ç»Ÿå…¬å‘Šï¼ˆæ–‡å­—å…¬å‘Šï¼‰

| å±æ€§ | å®é™…å€¼ |
|------|--------|
| æ•°æ®åº“è¡¨ | `system_announcements` |
| æ¨¡å‹æ–‡ä»¶ | `models/SystemAnnouncement.js` |
| æœåŠ¡å±‚ | `services/AnnouncementService.js` |
| å…¬å¼€ API | `GET /api/v4/system/announcements` â€” å…¬å‘Šåˆ—è¡¨ï¼ˆå¸¦åˆ†é¡µï¼‰ |
| å…¬å¼€ API | `GET /api/v4/system/announcements/home` â€” é¦–é¡µå…¬å‘Šï¼ˆTop 5ï¼‰ |
| ç®¡ç† API | `POST/GET/PUT/DELETE /api/v4/console/system/announcements` |
| æ•°æ®ç»“æ„ | çº¯æ–‡æœ¬å†…å®¹ï¼štitle + content + type + priority |
| å°ç¨‹åºå±•ç¤ºä½ç½® | **å°ç¨‹åºé¦–é¡µ** â€” æ–‡å­—å…¬å‘ŠåŒºåŸŸï¼ˆæ»šåŠ¨å…¬å‘Šæ¡/å…¬å‘Šåˆ—è¡¨ï¼‰ |

### æœºåˆ¶ 2ï¼šå¼¹çª— Bannerï¼ˆå›¾ç‰‡å¼¹çª—ï¼‰

| å±æ€§ | å®é™…å€¼ |
|------|--------|
| æ•°æ®åº“è¡¨ | `popup_banners` + `popup_show_logs`ï¼ˆå±•ç¤ºæ—¥å¿—ï¼‰ |
| æ¨¡å‹æ–‡ä»¶ | `models/PopupBanner.js` + `models/PopupShowLog.js` |
| æœåŠ¡å±‚ | `services/PopupBannerService.js` + `services/PopupShowLogService.js` |
| å…¬å¼€ API | `GET /api/v4/system/popup-banners?status=active&position=home` |
| ç®¡ç† API | `POST/GET/PUT/DELETE/PATCH /api/v4/console/popup-banners` |
| æ•°æ®ç»“æ„ | å›¾ç‰‡å¼¹çª—ï¼šimage_url + display_mode + link_url + frequency_rule + priority |
| å°ç¨‹åºå±•ç¤ºä½ç½® | **å°ç¨‹åºé¦–é¡µå¼¹çª—é®ç½©å±‚**ï¼ˆposition=homeï¼‰/ **ä¸ªäººä¸­å¿ƒå¼¹çª—**ï¼ˆposition=profileï¼‰ |

### ä¸¤å¥—æœºåˆ¶çš„æ ¸å¿ƒåŒºåˆ«

| ç»´åº¦ | ç³»ç»Ÿå…¬å‘Š | å¼¹çª— Banner |
|------|---------|------------|
| å†…å®¹å½¢æ€ | çº¯æ–‡å­—ï¼ˆtitle + contentï¼‰ | å›¾ç‰‡ï¼ˆSealos å¯¹è±¡å­˜å‚¨ï¼‰ |
| å±•ç¤ºå½¢å¼ | é¡µé¢å†…åµŒå±•ç¤ºï¼ˆå¦‚æ»šåŠ¨æ¡ã€åˆ—è¡¨ï¼‰ | é®ç½©å±‚å¼¹çª—ï¼ˆè¦†ç›–é¡µé¢ä¸Šå±‚ï¼‰ |
| é¢‘ç‡æ§åˆ¶ | æ— ï¼ˆæ¯æ¬¡è¯·æ±‚éƒ½è¿”å›ï¼‰ | æœ‰ï¼ˆalways/once/once_per_day/once_per_n_days ç­‰ 6 ç§è§„åˆ™ï¼‰ |
| ç‚¹å‡»è·³è½¬ | æ—  | æ”¯æŒ 4 ç§è·³è½¬ï¼šnone/page/miniprogram/webview |
| å±•ç¤ºæ—¥å¿— | ä»… `view_count` è®¡æ•° | ç‹¬ç«‹ `popup_show_logs` è¡¨ï¼Œè®°å½•å±•ç¤ºæ—¶é•¿ã€å…³é—­æ–¹å¼ã€é˜Ÿåˆ—ä½ç½® |
| ä½ç½®æ§åˆ¶ | ä»…é¦–é¡µ | æ”¯æŒå¤šä½ç½®ï¼ˆhome/profileï¼‰ |
| å¹¿å‘Šé›†æˆ | æ—  | å·²é›†æˆå¹¿å‘Šç«ä»·ç³»ç»Ÿï¼ˆåˆå¹¶è¿è¥å¼¹çª—ä¸å¹¿å‘Šç«ä»·ç»“æœï¼‰ |

---

## äºŒã€æ•°æ®åº“çœŸå®æ•°æ®ç°çŠ¶

### 2.1 system_announcements è¡¨ï¼ˆç³»ç»Ÿå…¬å‘Šï¼‰

**æ€»é‡**: 1 æ¡ï¼ˆ2026-02-20 å·²æ¸…ç† 102 æ¡æµ‹è¯•æ•°æ®ï¼‰

| å­—æ®µ | å€¼ |
|------|-----|
| ID | 1 |
| æ ‡é¢˜ | ç³»ç»Ÿç»´æŠ¤é€šçŸ¥ |
| å†…å®¹ | ä¸ºæå‡ç³»ç»Ÿæ€§èƒ½ï¼Œå°†äºä»Šæ™šè¿›è¡Œç³»ç»Ÿç»´æŠ¤ |
| ç±»å‹ | system |
| ä¼˜å…ˆçº§ | high |
| çŠ¶æ€ | **å·²åœç”¨**ï¼ˆis_active=0ï¼‰ |
| æµè§ˆæ¬¡æ•° | 12 |
| åˆ›å»ºæ—¶é—´ | 2025-09-29 23:51 |

**ç»“è®º**: è¯¥è¡¨ç›®å‰æ²¡æœ‰ä»»ä½•æ´»è·ƒå…¬å‘Šåœ¨å‰ç«¯å±•ç¤ºã€‚å¦‚éœ€å‘å¸ƒå…¬å‘Šï¼Œç®¡ç†å‘˜é€šè¿‡ç®¡ç†åå°"å†…å®¹ç®¡ç†ä¸­å¿ƒ â†’ å…¬å‘Šç®¡ç†"åˆ›å»ºã€‚

**ğŸ”´ å‘ç°ä»£ç ç¼ºé™·**ï¼š`services/DataSanitizer.js` çš„ `sanitizeAnnouncements()` æ–¹æ³•å¼•ç”¨ `announcement.announcement_id`ï¼Œä½†æ¨¡å‹ä¸»é”®å­—æ®µåä¸º `system_announcement_id`ï¼Œå¯¼è‡´å…¬å¼€ API å“åº”ä¸­ `id: undefined`ã€‚åŒæ—¶ `routes/v4/system/announcements.js` çš„ `/home` è·¯ç”±è°ƒç”¨ `incrementViewCount(announcement.announcement_id)` ä¹Ÿä¼ å…¥ undefinedï¼Œå¯¼è‡´æµè§ˆæ¬¡æ•°æ°¸è¿œä¸ä¼šè‡ªåŠ¨é€’å¢ï¼ˆå½“å‰ view_count=12 åº”ä¸ºæ‰‹åŠ¨æˆ–å†å²æ“ä½œå†™å…¥ï¼‰ã€‚

### 2.2 popup_banners è¡¨ï¼ˆå¼¹çª— Bannerï¼‰

**æ€»é‡**: 2 æ¡ï¼ˆ`is_active=1`ï¼‰ï¼Œä½†å®é™…ä»… 1 æ¡åœ¨å±•ç¤ºæ—¶é—´èŒƒå›´å†…

| popup_banner_id | title | banner_type | position | is_active | display_mode | frequency_rule | start_time (UTC) | end_time (UTC) | **å®é™…çŠ¶æ€** |
|-----------------|-------|-------------|----------|-----------|-------------|----------------|------------------|----------------|-------------|
| 15 | 2.3 | promo | home | 1 | tall | once_per_day | 2026-02-08 00:50 | **2026-02-20 00:50** | **ğŸ”´ å·²è¿‡æœŸ**ï¼ˆend_time å·²è¿‡ï¼‰ |
| 16 | 555 | promo | home | 1 | tall | once_per_day | 2026-02-10 16:22 | 2026-02-28 16:22 | âœ… å±•ç¤ºä¸­ |

**ğŸ”´ å…³é”®å‘ç°**: Banner ID=15 è™½ç„¶ `is_active=1`ï¼Œä½† `end_time=2026-02-20T00:50:00Z`ï¼ˆåŒ—äº¬æ—¶é—´ 08:50ï¼‰å·²è¿‡æœŸã€‚åç«¯ `PopupBannerService.getActiveBanners()` çš„æŸ¥è¯¢æ¡ä»¶æ­£ç¡®è¿‡æ»¤äº†æ—¶é—´èŒƒå›´ï¼ˆ`end_time > NOW()`ï¼‰ï¼Œæ‰€ä»¥**å°ç¨‹åºç«¯å®é™…åªèƒ½çœ‹åˆ° 1 æ¡å¼¹çª—ï¼ˆID=16ï¼‰**ã€‚`is_active` å­—æ®µä»…è¡¨ç¤ºç®¡ç†å‘˜æœªæ‰‹åŠ¨ç¦ç”¨ï¼Œä¸ä»£è¡¨å®é™…åœ¨å±•ç¤ºã€‚

**ç‰¹å¾**:
- 2 æ¡å‡ä¸º `promo`ï¼ˆæ—¥å¸¸ä¿ƒé”€ï¼‰ç±»å‹
- å‡é…ç½®ä¸ºé¦–é¡µå±•ç¤ºï¼ˆ`position=home`ï¼‰
- å‡ä¸è·³è½¬ï¼ˆ`link_type=none`ï¼‰
- é¢‘ç‡è§„åˆ™å‡ä¸ºæ¯å¤©å¼¹ä¸€æ¬¡ï¼ˆ`once_per_day`ï¼‰
- æ˜¾ç¤ºæ¨¡å¼å‡ä¸ºç«–å›¾ï¼ˆ`tall`ï¼Œ3:4 æ¯”ä¾‹ï¼‰
- `force_show=0`ï¼ˆå¯ç‚¹é®ç½©å…³é—­ï¼‰ã€`priority=0`ï¼ˆæ— ä¼˜å…ˆçº§ç«äº‰ï¼‰

### 2.3 popup_show_logs è¡¨ï¼ˆå¼¹çª—å±•ç¤ºæ—¥å¿—ï¼‰

**æ€»é‡**: 31 æ¡

| ç»´åº¦ | åˆ†å¸ƒ |
|------|------|
| ç”¨æˆ·åˆ†å¸ƒ | user_id=31ï¼ˆ29æ¬¡ï¼‰ã€user_id=32ï¼ˆ2æ¬¡ï¼‰ï¼Œä»… 2 ä¸ªç”¨æˆ·çœ‹åˆ°è¿‡å¼¹çª— |
| Banner åˆ†å¸ƒ | ID 15ï¼ˆ7æ¬¡ï¼Œå¹³å‡å±•ç¤º 31.6ç§’ï¼‰ã€ID 16ï¼ˆ24æ¬¡ï¼Œå¹³å‡å±•ç¤º 18.3ç§’ï¼‰ |
| å…³é—­æ–¹å¼ | close_btnï¼ˆ29æ¬¡ï¼Œ93.5%ï¼‰ã€overlayï¼ˆ2æ¬¡ï¼Œ6.5%ï¼‰ |
| æœ€è¿‘å±•ç¤º | 2026-02-21 00:22ï¼ˆID 16ï¼Œuser_id=31ï¼‰ |

### 2.4 carousel_items è¡¨ï¼ˆè½®æ’­å›¾ï¼Œè¡¥å……å‚è€ƒï¼‰

**æ€»é‡**: 1 æ¡

| å­—æ®µ | å€¼ |
|------|-----|
| carousel_item_id | 26 |
| title | 11111 |
| image_url | carousel/1771580462026_8c68f71655115546.png |
| display_mode | wideï¼ˆ16:9ï¼‰ |
| image_width Ã— image_height | 345 Ã— 569ï¼ˆå®é™…æ¯”ä¾‹ä¸ wide æ¨¡æ¿ä¸åŒ¹é…ï¼‰ |
| position | home |
| is_active | 1 |
| link_type | none |
| slide_interval_ms | 3000ï¼ˆ3ç§’è½®æ’­é—´éš”ï¼‰ |
| start_time | 2026-02-14 17:42 (UTC) |
| end_time | 2026-02-26 17:42 (UTC) |
| created_by | 31 |

**ğŸ”´ æ•°æ®è´¨é‡é—®é¢˜**: å›¾ç‰‡å®é™…å°ºå¯¸ 345Ã—569ï¼ˆæ¯”ä¾‹çº¦ 0.61:1 = ç«–å›¾ï¼‰ï¼Œä½† `display_mode` é€‰æ‹©äº† `wide`ï¼ˆ16:9 æ¨ªå±ï¼‰ï¼Œæ¯”ä¾‹ä¸¥é‡ä¸åŒ¹é…ã€‚åç«¯ sharp æ ¡éªŒä¸ºã€Œè­¦å‘Šä½†ä¸é˜»æ­¢ã€ç­–ç•¥ï¼Œå‰ç«¯å±•ç¤ºæ—¶ä¼šè¢«è£åˆ‡æˆ–æ‹‰ä¼¸ã€‚

### 2.5 system_configs å¼¹çª—ç›¸å…³é…ç½®

| config_key | config_value | è¯´æ˜ |
|-----------|-------------|------|
| `popup_queue_max_count` | `5` | å¼¹çª—é˜Ÿåˆ—æœ€å¤§æ•°é‡ã€‚`PopupBannerService.getActiveBanners()` è¯»å–æ­¤é…ç½®æˆªæ–­è¿”å›ç»“æœï¼Œçƒ­æ›´æ–°æ— éœ€é‡å¯ |

---

## ä¸‰ã€æ•°æ®æµå‘ï¼šä»ç®¡ç†åå°åˆ°å°ç¨‹åº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Web ç®¡ç†åå°ï¼ˆå†…å®¹ç®¡ç†ä¸­å¿ƒï¼‰                    â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  å…¬å‘Šç®¡ç†   â”‚  â”‚  å¼¹çª—ç®¡ç†   â”‚  â”‚  è½®æ’­å›¾ç®¡ç†  â”‚         â”‚
â”‚  â”‚  1 æ¡(åœç”¨) â”‚  â”‚  2 æ¡(æ´»è·ƒ) â”‚  â”‚  1 æ¡(æ´»è·ƒ) â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚               â”‚               â”‚
         â–¼               â–¼               â–¼
   system_           popup_          carousel_
   announcements     banners         items
         â”‚               â”‚               â”‚
         â”‚               â”‚               â”‚
         â–¼               â–¼               â–¼
   GET /api/v4/      GET /api/v4/    GET /api/v4/
   system/           system/         system/
   announcements/    popup-banners   carousel-items
   home              ?status=active
   (è¿”å›Top5æ´»è·ƒ)    (è¿”å›æ´»è·ƒå¼¹çª—)   (è¿”å›æ´»è·ƒè½®æ’­)
         â”‚               â”‚               â”‚
         â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¾®ä¿¡å°ç¨‹åºï¼ˆå¤©å·¥å°ç¨‹åºï¼‰                        â”‚
â”‚                                                          â”‚
â”‚  é¦–é¡µï¼ˆæ¨æ–­è·¯å¾„ /pages/index/index æˆ– /pages/home/indexï¼‰ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  â‘  è½®æ’­å›¾åŒºåŸŸ â† carousel_items                â”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚  â‘¡ æ–‡å­—å…¬å‘Šæ¡ â† system_announcements          â”‚       â”‚
â”‚  â”‚     æ»šåŠ¨æ˜¾ç¤º Top 5 æ¡æ´»è·ƒå…¬å‘Š                   â”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚  â‘¢ å¼¹çª—é®ç½©å±‚ â† popup_banners                 â”‚       â”‚
â”‚  â”‚     è¿›å…¥é¦–é¡µæ—¶å¼¹å‡ºå›¾ç‰‡ï¼Œé¢‘ç‡å—æ§                  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                          â”‚
â”‚  ä¸ªäººä¸­å¿ƒï¼ˆæ¨æ–­è·¯å¾„ /pages/profile/indexï¼‰                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  å¼¹çª—é®ç½©å±‚ â† popup_banners (position=profile)â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¼¹çª— link_url æ”¯æŒçš„è·³è½¬ç›®æ ‡

æ ¹æ® seeder æµ‹è¯•æ•°æ®å’Œåç«¯æ¨¡å‹å®šä¹‰ï¼Œå¼¹çª— `link_url` æ”¯æŒä»¥ä¸‹å°ç¨‹åºé¡µé¢è·¯å¾„ï¼š

| link_type | å«ä¹‰ | link_url ç¤ºä¾‹ |
|-----------|------|--------------|
| `none` | ä¸è·³è½¬ | ç©º |
| `page` | è·³è½¬å°ç¨‹åºå†…é¡µ | `/pages/lottery/index`ï¼ˆæŠ½å¥–é¡µï¼‰ã€`/pages/exchange/index`ï¼ˆå…‘æ¢é¡µï¼‰ |
| `miniprogram` | è·³è½¬å…¶ä»–å°ç¨‹åº | å…¶ä»–å°ç¨‹åº appId |
| `webview` | æ‰“å¼€ H5 é¡µé¢ | ä»»æ„ HTTPS URL |

---

## å››ã€åç«¯æ¥å£è¯¦ç»†è¯´æ˜

### 4.1 GET /api/v4/system/announcements/home â€” é¦–é¡µå…¬å‘Š

**æ–‡ä»¶**: `routes/v4/system/announcements.js`

**æŸ¥è¯¢é€»è¾‘**:
- `is_active = true` ä¸”æœªè¿‡æœŸï¼ˆ`expires_at` ä¸ºç©ºæˆ–å¤§äºå½“å‰æ—¶é—´ï¼‰
- ç±»å‹ä¸é™ï¼ˆsystem/activity/maintenance/notice å‡è¿”å›ï¼‰
- æŒ‰ä¼˜å…ˆçº§ DESC + åˆ›å»ºæ—¶é—´ DESC æ’åº
- æœ€å¤šè¿”å› 5 æ¡
- æ¯æ¬¡è¯·æ±‚è‡ªåŠ¨ increment `view_count`

**å“åº”æ ¼å¼**ï¼ˆç» `DataSanitizer.sanitizeAnnouncements()` è„±æ•åï¼‰:
```json
{
  "success": true,
  "data": {
    "announcements": [
      {
        "id": 1,
        "title": "ç³»ç»Ÿç»´æŠ¤é€šçŸ¥",
        "content": "ä¸ºæå‡ç³»ç»Ÿæ€§èƒ½...",
        "type": "system",
        "type_display": "ç³»ç»Ÿå…¬å‘Š",
        "priority": "high",
        "priority_display": "é«˜",
        "view_count": 12,
        "created_at": "2025å¹´09æœˆ29æ—¥ 23:51:00",
        "expires_at": null
      }
    ]
  }
}
```

**ğŸ”´ å­—æ®µå‘½åç¼ºé™·**: DataSanitizer å°†ä¸»é”®æ˜ å°„ä¸º `id`ï¼ˆé `announcement_id`ï¼‰ï¼Œä½†å¼•ç”¨äº†ä¸å­˜åœ¨çš„ `announcement.announcement_id`ï¼ˆæ¨¡å‹å®é™…å­—æ®µä¸º `system_announcement_id`ï¼‰ï¼Œå¯¼è‡´å…¬å¼€ API è¿”å› `id: undefined`ã€‚ç®¡ç†åå° APIï¼ˆ`/api/v4/console/system/announcements`ï¼‰ä¸ç»è¿‡ DataSanitizerï¼Œè¿”å›åŸå§‹å­—æ®µ `system_announcement_id`ã€‚

### 4.2 GET /api/v4/system/popup-banners â€” å¼¹çª—åˆ—è¡¨

**æ–‡ä»¶**: `routes/v4/system/popup-banners.js`

**æŸ¥è¯¢é€»è¾‘**ï¼ˆstatus=active æ—¶ï¼‰:
- `is_active = true`
- åœ¨æ—¶é—´èŒƒå›´å†…ï¼ˆ`start_time` å·²åˆ°ä¸” `end_time` æœªè¿‡ï¼‰
- æŒ‰ `priority` DESC + `display_order` ASC + `created_at` DESC æ’åº
- æœ€å¤šè¿”å› 10 æ¡
- å·²é›†æˆå¹¿å‘Šç«ä»·ç³»ç»Ÿï¼ˆåˆå¹¶è¿è¥å¼¹çª—ä¸å¹¿å‘Šå®šå‘åŒ¹é…ç»“æœï¼‰

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "data": {
    "banners": [
      {
        "popup_banner_id": 16,
        "title": "555",
        "image_url": "popup-banners/xxx.jpg",
        "display_mode": "tall",
        "image_width": 750,
        "image_height": 1000,
        "link_url": "",
        "link_type": "none",
        "banner_type": "promo",
        "frequency_rule": "once_per_day",
        "frequency_value": 1,
        "force_show": false,
        "priority": 0
      }
    ]
  }
}
```

### 4.3 POST /api/v4/system/ad-events/popup-banners/show-log â€” å¼¹çª—å±•ç¤ºä¸ŠæŠ¥

**å°ç¨‹åºç«¯èŒè´£**: å¼¹çª—å±•ç¤ºåï¼Œä¸ŠæŠ¥å±•ç¤ºæ—¶é•¿ã€å…³é—­æ–¹å¼ã€é˜Ÿåˆ—ä½ç½®ç­‰æ•°æ®åˆ° `popup_show_logs` è¡¨ã€‚

---

## äº”ã€å¼¹çª— Banner çš„å®Œæ•´èƒ½åŠ›çŸ©é˜µ

åç«¯å’Œç®¡ç†åå°å·²å®ç°çš„å¼¹çª—èƒ½åŠ›ï¼š

| èƒ½åŠ› | å®ç°çŠ¶æ€ | è¯´æ˜ |
|------|---------|------|
| å¤šæ˜¾ç¤ºæ¨¡å¼ | âœ… å·²å®ç° | 6 ç§æ¨¡å¼ï¼šwide(16:9)/horizontal(3:2)/square(1:1)/tall(3:4)/slim(9:16)/full_image(çº¯å›¾) |
| å¤šå¼¹çª—ç±»å‹ | âœ… å·²å®ç° | notice(ç³»ç»Ÿå…¬å‘Š)/event(æ´»åŠ¨æ¨å¹¿)/promo(æ—¥å¸¸ä¿ƒé”€)ï¼Œå¯¹åº”ä¸åŒ priority èŒƒå›´ |
| é¢‘ç‡æ§åˆ¶ | âœ… å·²å®ç° | 6 ç§è§„åˆ™ï¼šalways/once/once_per_session/once_per_day/once_per_n_days/n_times_total |
| å¼ºåˆ¶å¼¹å‡º | âœ… å·²å®ç° | `force_show=true` æ—¶ä¸å¯ç‚¹é®ç½©å…³é—­ï¼Œéœ€ç‚¹"æˆ‘çŸ¥é“äº†"æŒ‰é’® |
| ä¼˜å…ˆçº§ç«äº‰ | âœ… å·²å®ç° | `priority` æ•°å­—è¶Šå¤§è¶Šä¼˜å…ˆå¼¹å‡ºï¼ˆåŒºåˆ«äº `display_order` çš„ç®¡ç†åˆ—è¡¨æ’åºï¼‰ |
| æ—¶é—´èŒƒå›´æ§åˆ¶ | âœ… å·²å®ç° | `start_time` / `end_time` æ§åˆ¶å±•ç¤ºçª—å£ |
| ä½ç½®æ§åˆ¶ | âœ… å·²å®ç° | `position` å­—æ®µï¼ˆhome/profileï¼‰ |
| ç‚¹å‡»è·³è½¬ | âœ… å·²å®ç° | 4 ç§è·³è½¬ç±»å‹ |
| å±•ç¤ºæ—¥å¿— | âœ… å·²å®ç° | `popup_show_logs` è®°å½•æ—¶é•¿ã€å…³é—­æ–¹å¼ã€é˜Ÿåˆ—ä½ç½® |
| å›¾ç‰‡æ¯”ä¾‹æ ¡éªŒ | âœ… å·²å®ç° | ä¸Šä¼ æ—¶åç«¯ sharp æ£€æµ‹ + å‰ç«¯æ¯”ä¾‹åŒ¹é…è­¦å‘Š |
| æ‹–æ‹½æ’åº | âœ… å·²å®ç° | ç®¡ç†åå°æ”¯æŒæ‹–æ‹½è°ƒæ•´ `display_order` |
| å¹¿å‘Šç«ä»·é›†æˆ | âœ… å·²å®ç° | è¿è¥å¼¹çª—ä¸å¹¿å‘Šç«ä»·ç»“æœåˆå¹¶å±•ç¤º |

---

## å…­ã€æ•°æ®è´¨é‡ç°çŠ¶ï¼ˆ2026-02-20 äºŒæ¬¡æ±‚è¯ï¼‰

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| system_announcements æµ‹è¯•æ•°æ® | âœ… å·²æ¸…ç† | 2026-02-20 åˆ é™¤ 102 æ¡æµ‹è¯•æ•°æ®ï¼Œä¿ç•™ 1 æ¡çœŸå®å…¬å‘Šï¼ˆå·²åœç”¨ï¼‰ |
| popup_banners | âš ï¸ éœ€å…³æ³¨ | 2 æ¡è®°å½•ä¸­ ID=15 å·²è¿‡æœŸï¼ˆend_time å·²è¿‡ï¼‰ï¼Œä»… ID=16 å®é™…åœ¨å±•ç¤º |
| popup_show_logs | âœ… æ­£å¸¸ | 31 æ¡å±•ç¤ºæ—¥å¿—ï¼Œè¦†ç›– user_id=31 å’Œ 32 |
| carousel_items | âš ï¸ å›¾ç‰‡æ¯”ä¾‹ä¸åŒ¹é… | ID=26 é€‰æ‹© wide(16:9) æ¨¡å¼ä½†å®é™…å›¾ç‰‡ä¸ºç«–å›¾(345Ã—569)ï¼Œå±•ç¤ºä¼šè¢«è£åˆ‡ |
| admin_notifications | ä¿¡æ¯ | 0 æ¡æ•°æ®ï¼ŒåŠŸèƒ½å°šæœªå¯ç”¨ |
| **å…¬å‘Šå…¬å¼€ API ä¸»é”®å­—æ®µ** | **ğŸ”´ ä»£ç ç¼ºé™·** | **DataSanitizer å¼•ç”¨ `announcement_id` ä½†æ¨¡å‹å­—æ®µä¸º `system_announcement_id`ï¼Œå¯¼è‡´ `id: undefined`** |
| **å…¬å‘Š view_count è‡ªå¢** | **ğŸ”´ ä»£ç ç¼ºé™·** | **`/home` è·¯ç”±çš„ `incrementViewCount()` ä¼ å…¥ undefinedï¼Œæµè§ˆæ¬¡æ•°æ°¸ä¸è‡ªå¢** |

---

## ä¸ƒã€æ‹æ¿å†³ç­–è®°å½•ï¼ˆ2026-02-20ï¼‰

### å†³ç­– 1ï¼šsystem_announcements æµ‹è¯•æ•°æ®æ¸…ç† â€” âœ… å·²æ‰§è¡Œ

**å†³ç­–**: é€‰é¡¹ A â€” å…¨éƒ¨æ¸…ç†

**æ‰§è¡Œç»“æœ**: 2026-02-20 å·²æ‰§è¡Œï¼Œåˆ é™¤ 102 æ¡æµ‹è¯•æ•°æ®ï¼Œä¿ç•™ ID=1ï¼ˆ"ç³»ç»Ÿç»´æŠ¤é€šçŸ¥"ï¼Œis_active=0ï¼‰ã€‚æ¸…ç†åè¯¥è¡¨ä»… 1 æ¡è®°å½•ã€‚

### å†³ç­– 2ï¼šå½“å‰ 2 æ¡å¼¹çª— Banner â€” âœ… ç¡®è®¤ä¸ºæ­£å¼ä¸šåŠ¡å†…å®¹

**å†³ç­–**: å½“å‰ popup_banners è¡¨ä¸­ 2 æ¡è®°å½•ï¼ˆID 15 "2.3"ã€ID 16 "555"ï¼‰ä¸ºæ­£ç¡®çš„ä¸šåŠ¡è®¾è®¡ï¼Œä¿æŒç°çŠ¶ä¸åŠ¨ã€‚

### å†³ç­– 3ï¼šå¾®ä¿¡å°ç¨‹åºå‰ç«¯ä»£ç  â€” âœ… åç»­æ’æŸ¥é¡¹å·²åˆ—å‡º

**å†³ç­–**: å°ç¨‹åºå‰ç«¯ä»£ç ä¸åœ¨æœ¬ä»“åº“ä¸­ï¼Œåœ¨æ–‡æ¡£ç¬¬å…«èŠ‚åˆ—å‡ºéœ€è¦å°ç¨‹åºå‰ç«¯é…åˆæ’æŸ¥çš„å·¥ä½œæ¸…å•ã€‚

**éœ€è¦å¾®ä¿¡å°ç¨‹åºå‰ç«¯é…åˆæ’æŸ¥çš„å·¥ä½œå†…å®¹**:

| ç¼–å· | æ’æŸ¥é¡¹ | ç›®çš„ | ä¼˜å…ˆçº§ |
|------|--------|------|--------|
| MP-1 | ç¡®è®¤å°ç¨‹åºé¦–é¡µæ˜¯å¦å·²è°ƒç”¨ `GET /api/v4/system/announcements/home` | ç¡®å®šæ–‡å­—å…¬å‘ŠåŠŸèƒ½æ˜¯å¦å·²åœ¨å°ç¨‹åºç«¯å®ç° | P1 |
| MP-2 | ç¡®è®¤å°ç¨‹åºé¦–é¡µæ˜¯å¦å·²è°ƒç”¨ `GET /api/v4/system/popup-banners?status=active` | ç¡®å®šå¼¹çª—åŠŸèƒ½æ˜¯å¦å·²åœ¨å°ç¨‹åºç«¯å®ç° | P1 |
| MP-3 | ç¡®è®¤å°ç¨‹åºé¦–é¡µæ˜¯å¦å·²è°ƒç”¨è½®æ’­å›¾æ¥å£ | ç¡®å®šè½®æ’­å›¾åŠŸèƒ½æ˜¯å¦å·²åœ¨å°ç¨‹åºç«¯å®ç° | P2 |
| MP-4 | ç¡®è®¤å¼¹çª—å±•ç¤ºåæ˜¯å¦ä¸ŠæŠ¥ `POST /api/v4/system/ad-events/popup-banners/show-log` | ç¡®å®šå¼¹çª—å±•ç¤ºæ—¥å¿—æ˜¯å¦å®Œæ•´ | P2 |
| MP-5 | ç¡®è®¤å¼¹çª—çš„ `frequency_rule`ï¼ˆé¢‘ç‡æ§åˆ¶ï¼‰æ˜¯å¦å·²åœ¨å®¢æˆ·ç«¯å®ç° | åç«¯åªä¸‹å‘è§„åˆ™ï¼Œå®¢æˆ·ç«¯è´Ÿè´£æ‰§è¡Œ | P2 |
| MP-6 | ç¡®è®¤æ–‡å­—å…¬å‘Šåœ¨å°ç¨‹åºç«¯çš„å…·ä½“å±•ç¤ºå½¢æ€ï¼ˆæ»šåŠ¨æ¡/åˆ—è¡¨/å¼¹çª—ï¼‰ | ç”¨äºåç»­è¿è¥ç­–ç•¥çš„ç²¾å‡†åŒ¹é… | P3 |
| MP-7 | ç¡®è®¤å¼¹çª— `link_type=page` æ—¶è·³è½¬æ˜¯å¦æ­£å¸¸ï¼ˆå¦‚ `/pages/lottery/index`ï¼‰ | éªŒè¯å¼¹çª—è·³è½¬é“¾è·¯å¯ç”¨ | P3 |

### å†³ç­– 4ï¼šç³»ç»Ÿå…¬å‘Š vs å¼¹çª— Banner è¿è¥åˆ†å·¥ â€” âœ… å·²ç¡®è®¤

**å†³ç­–**: åŒæ„ä»¥ä¸‹è¿è¥ç­–ç•¥åˆ†å·¥

| åœºæ™¯ | ä½¿ç”¨æœºåˆ¶ | ç†ç”± |
|------|---------|------|
| ç³»ç»Ÿç»´æŠ¤é€šçŸ¥ | ç³»ç»Ÿå…¬å‘Šï¼ˆæ–‡å­—ï¼‰ | ç®€æ´ï¼Œä¸æ‰“æ–­ç”¨æˆ·æ“ä½œ |
| æ´»åŠ¨æ¨å¹¿ï¼ˆæœ‰è§†è§‰è®¾è®¡å›¾ï¼‰ | å¼¹çª— Bannerï¼ˆå›¾ç‰‡ï¼‰ | è§†è§‰å†²å‡»åŠ›å¼ºï¼Œæ”¯æŒè·³è½¬ |
| ç´§æ€¥å®‰å…¨é€šçŸ¥ | å¼¹çª— Bannerï¼ˆ`force_show=true`ï¼‰ | å¼ºåˆ¶ç”¨æˆ·ç¡®è®¤ï¼Œä¸å¯ç‚¹é®ç½©å…³é—­ |
| æ—¥å¸¸è¿è¥ä¿¡æ¯ | ç³»ç»Ÿå…¬å‘Šï¼ˆæ–‡å­—ï¼‰ | è½»é‡ï¼Œä¸å¹²æ‰°ç”¨æˆ·ä½“éªŒ |

---

## å…«ã€é—®é¢˜å½’å±åˆ†æï¼šå“ªäº›æ˜¯è°çš„é—®é¢˜

### 8.1 åç«¯æ•°æ®åº“é¡¹ç›®çš„é—®é¢˜

| ç¼–å· | é—®é¢˜ | ä¼˜å…ˆçº§ | å¤æ‚åº¦ | è¯´æ˜ |
|------|------|--------|--------|------|
| B1 | DataSanitizer å…¬å‘Šä¸»é”®å­—æ®µåé”™è¯¯ | **P0** | ä½ | `sanitizeAnnouncements()` å¼•ç”¨ `announcement.announcement_id`ï¼Œåº”æ”¹ä¸º `announcement.system_announcement_id`ã€‚ç›´æ¥å¯¼è‡´å…¬å¼€ API è¿”å› `id: undefined`ï¼Œå‰ç«¯æ— æ³•è·å–å…¬å‘Š ID |
| B2 | å…¬å‘Š `/home` è·¯ç”± view_count è‡ªå¢å¤±æ•ˆ | **P0** | ä½ | å›  B1 å¯¼è‡´ `incrementViewCount(undefined)` æ— æ•ˆï¼Œéœ€åŒæ­¥ä¿®å¤å¼•ç”¨å­—æ®µå |
| B3 | ç®¡ç†åå° console è·¯ç”±å…¬å‘Šä¸»é”®å­—æ®µä¸ä¸€è‡´ | P2 | ä½ | console è·¯ç”±è¿”å›åŸå§‹ `system_announcement_id`ï¼Œå…¬å¼€è·¯ç”±ç» DataSanitizer è¿”å› `id`ï¼Œå‰åç«¯éœ€è¦é€‚é…ä¸¤å¥—å­—æ®µå |

### 8.2 Web ç®¡ç†åå°å‰ç«¯é¡¹ç›®çš„é—®é¢˜

| ç¼–å· | é—®é¢˜ | ä¼˜å…ˆçº§ | å¤æ‚åº¦ | è¯´æ˜ |
|------|------|--------|--------|------|
| W1 | å…¬å‘Šç¼–è¾‘è¡¨å•ä½¿ç”¨ `announcement_id` å­—æ®µå | P2 | ä½ | `announcements.js` çš„ `editAnnouncement()` ä½¿ç”¨ `ann.announcement_id \|\| ann.id`ï¼Œä½† console API è¿”å› `system_announcement_id`ã€‚å½“å‰å¯èƒ½ä¾èµ– `ann.id`ï¼ˆSequelize åˆ«åï¼‰é—´æ¥å·¥ä½œï¼Œä½†å­—æ®µå¼•ç”¨ä¸ä¸¥è°¨ |
| W2 | carousel_items å›¾ç‰‡æ¯”ä¾‹ä¸åŒ¹é…æ— å‰ç«¯é˜»æ–­ | P3 | ä½ | ç®¡ç†åå°å…è®¸ `display_mode=wide` ä½†ä¸Šä¼ ç«–å›¾ï¼Œä»…åç«¯ sharp è­¦å‘Šä¸é˜»æ­¢ã€‚å¯åœ¨å‰ç«¯å¢åŠ æ¯”ä¾‹åŒ¹é…åº¦æ˜¾ç¤ºï¼ˆå¼¹çª—ç®¡ç†å·²æœ‰æ­¤åŠŸèƒ½ï¼Œè½®æ’­å›¾ç®¡ç†å¯å¤ç”¨ `checkImageRatio()` é€»è¾‘ï¼‰ |

### 8.3 å¾®ä¿¡å°ç¨‹åºå‰ç«¯é¡¹ç›®çš„é—®é¢˜

| ç¼–å· | é—®é¢˜ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|------|--------|------|
| MP-1 | ç¡®è®¤æ˜¯å¦è°ƒç”¨ `GET /api/v4/system/announcements/home` | P1 | å½“å‰å…¬å¼€ API å›  B1 ç¼ºé™·è¿”å› `id: undefined`ï¼Œå°ç¨‹åºç«¯å³ä½¿å·²å¯¹æ¥ä¹Ÿæ— æ³•æ­£ç¡®ä½¿ç”¨å…¬å‘Š ID |
| MP-2 | ç¡®è®¤æ˜¯å¦è°ƒç”¨ `GET /api/v4/system/popup-banners?status=active` | P1 | å¼¹çª— API æ—  DataSanitizer è„±æ•ï¼Œç›´æ¥è¿”å› `popup_banner_id`ï¼Œå­—æ®µæ­£ç¡® |
| MP-3 | ç¡®è®¤å¼¹çª— `frequency_rule` å®¢æˆ·ç«¯æ‰§è¡Œé€»è¾‘ | P2 | åç«¯åªä¸‹å‘è§„åˆ™ï¼ˆå¦‚ `once_per_day`ï¼‰ï¼Œå®¢æˆ·ç«¯éœ€æœ¬åœ°å­˜å‚¨å±•ç¤ºè®°å½•å¹¶åˆ¤æ–­æ˜¯å¦å¼¹å‡º |
| MP-4 | ç¡®è®¤å¼¹çª—å±•ç¤ºä¸ŠæŠ¥ `POST .../show-log` æ˜¯å¦å·²å®ç° | P2 | popup_show_logs è¡¨æœ‰ 31 æ¡æ•°æ®ï¼Œè¯´æ˜è‡³å°‘ user_id=31 å’Œ 32 çš„å°ç¨‹åºç‰ˆæœ¬å·²å®ç°ä¸ŠæŠ¥ |
| MP-5 | å¼¹çª— `link_type=page` è·³è½¬è·¯å¾„ç¡®è®¤ | P3 | éœ€ç¡®è®¤å°ç¨‹åºç«¯æ˜¯å¦å¤„ç†äº† `link_url` ä¸­çš„é¡µé¢è·¯å¾„è·³è½¬ |
| MP-6 | æ–‡å­—å…¬å‘Šåœ¨å°ç¨‹åºç«¯çš„å±•ç¤ºå½¢æ€ç¡®è®¤ | P3 | é¦–é¡µæ–‡å­—å…¬å‘Šæ¡æ˜¯æ»šåŠ¨æ¡ã€åˆ—è¡¨è¿˜æ˜¯å¼¹çª—ï¼Œå½±å“åç»­è¿è¥ç­–ç•¥ |

---

## ä¹ã€åç«¯å®æ–½æ–¹æ¡ˆï¼ˆåŸºäºç°æœ‰æŠ€æœ¯æ ˆï¼‰

> ä»¥ä¸‹æ–¹æ¡ˆå®Œå…¨åŸºäºåç«¯é¡¹ç›®ç°æœ‰çš„ ServiceManager + DataSanitizer + Sequelize æŠ€æœ¯ä½“ç³»ï¼Œä¸å¼•å…¥æ–°ä¾èµ–ã€ä¸æ–°å»ºè¡¨ã€ä¸æ–°å»ºæ¨¡å‹ã€‚

### 9.1 ä¿®å¤ B1+B2ï¼šDataSanitizer å…¬å‘Šä¸»é”®å­—æ®µåï¼ˆP0ï¼‰

**ä¿®æ”¹æ–‡ä»¶ 1**ï¼š`services/DataSanitizer.js`

ä¿®æ”¹ `sanitizeAnnouncements()` æ–¹æ³•ä¸­çš„ä¸»é”®å¼•ç”¨ï¼š

```
// ä¿®æ”¹å‰ï¼ˆé”™è¯¯ï¼‰
id: announcement.announcement_id,

// ä¿®æ”¹åï¼ˆæ­£ç¡®ï¼‰
id: announcement.system_announcement_id,
```

**ä¿®æ”¹æ–‡ä»¶ 2**ï¼š`routes/v4/system/announcements.js`

ä¿®æ”¹ `/announcements/home` è·¯ç”±ä¸­ `incrementViewCount` çš„å­—æ®µå¼•ç”¨ï¼š

```
// ä¿®æ”¹å‰ï¼ˆé”™è¯¯ï¼‰
AnnouncementService.incrementViewCount(announcement.announcement_id)

// ä¿®æ”¹åï¼ˆæ­£ç¡®ï¼‰
AnnouncementService.incrementViewCount(announcement.id)
```

æ³¨æ„ï¼šè¿™é‡Œç”¨ `announcement.id` è€Œé `announcement.system_announcement_id`ï¼Œå› ä¸º `announcements` å˜é‡å·²ç»è¿‡ `DataSanitizer.sanitizeAnnouncements()` å¤„ç†ï¼Œè¾“å‡ºå­—æ®µåä¸º `id`ã€‚

**å¯å¤ç”¨çš„ç°æœ‰èƒ½åŠ›**ï¼š
- DataSanitizer å·²æœ‰å®Œæ•´çš„è„±æ•æ¶æ„ï¼Œåªéœ€ä¿®æ­£å­—æ®µå¼•ç”¨
- `incrementViewCount()` æ–¹æ³•ä½¿ç”¨ `findByPk()` æ¥æ”¶æ•´æ•° IDï¼Œä¿®å¤åç›´æ¥ç”Ÿæ•ˆ

**å½±å“èŒƒå›´**ï¼š
- å…¬å¼€ API `GET /api/v4/system/announcements` å’Œ `/home` â€” ä¿®å¤å `id` å­—æ®µå°†æ­£ç¡®è¿”å›æ•´æ•°
- ç®¡ç†åå° console API ä¸å—å½±å“ï¼ˆä¸ç»è¿‡ DataSanitizerï¼‰

### 9.2 ç»Ÿä¸€å…¬å‘Šä¸»é”®å­—æ®µåæ–¹æ¡ˆï¼ˆP2ï¼Œéœ€æ‹æ¿ï¼‰

**é—®é¢˜æœ¬è´¨**ï¼šåç«¯ä¸¤å¥— API å¯¹å…¬å‘Šä¸»é”®ä½¿ç”¨ä¸åŒå­—æ®µå

| API | è¿”å›å­—æ®µå | åŸå›  |
|-----|-----------|------|
| å…¬å¼€ APIï¼ˆ`/api/v4/system/announcements`ï¼‰ | `id` | ç» DataSanitizer è„±æ•æ˜ å°„ |
| ç®¡ç†åå° APIï¼ˆ`/api/v4/console/system/announcements`ï¼‰ | `system_announcement_id` | ç›´æ¥è¿”å› Sequelize toJSON() |

**æ–¹æ¡ˆ Aï¼ˆæ¨èï¼‰ï¼šç»Ÿä¸€ä¸º `announcement_id`**

åœ¨ DataSanitizer ä¸­æ”¹ä¸º `announcement_id: announcement.system_announcement_id`ï¼Œç®¡ç†åå° console è·¯ç”±ä¹Ÿåœ¨ Service å±‚ç»Ÿä¸€è¿”å› `announcement_id`ã€‚å‰ç«¯ç»Ÿä¸€ä½¿ç”¨ `announcement_id` å­—æ®µã€‚

**æ–¹æ¡ˆ Bï¼šä¿æŒ DataSanitizer çš„ `id` + console çš„ `system_announcement_id`**

å‰ç«¯å„è‡ªé€‚é…ï¼Œå…¬å¼€ API ç”¨ `id`ï¼Œç®¡ç†åå°ç”¨ `system_announcement_id`ã€‚ç»´æŠ¤æˆæœ¬è¾ƒé«˜ã€‚

**æ¨èæ–¹æ¡ˆ A çš„ç†ç”±**ï¼š
- é¡¹ç›®æœªä¸Šçº¿ï¼Œä¸€æ¬¡æ€§ç»Ÿä¸€å­—æ®µåæˆæœ¬æœ€ä½
- å‚è€ƒ `popup_banners` çš„æ¨¡å¼ï¼šå…¬å¼€å’Œç®¡ç† API éƒ½ä½¿ç”¨ `popup_banner_id`ï¼Œä¸€è‡´æ€§å¥½
- Web ç®¡ç†åå°å‰ç«¯ `announcements.js` å·²ä½¿ç”¨ `announcement_id`ï¼Œä¸æ–¹æ¡ˆ A å¤©ç„¶å¯¹é½
- å¾®ä¿¡å°ç¨‹åºå‰ç«¯ç›´æ¥ä½¿ç”¨ `announcement_id`ï¼Œæ— éœ€æ˜ å°„

### 9.3 å¼¹çª—ç³»ç»Ÿæ— ä»£ç ç¼ºé™·ï¼Œç°çŠ¶ç¡®è®¤

å¼¹çª— Banner çš„å®Œæ•´é“¾è·¯ï¼ˆæ¨¡å‹ â†’ æœåŠ¡ â†’ è·¯ç”± â†’ å‰ç«¯ï¼‰ç»ä»£ç è¿½è¸ªå’Œæ•°æ®åº“éªŒè¯ï¼Œ**æ— åŠŸèƒ½ç¼ºé™·**ï¼š

- `PopupBanner` æ¨¡å‹å­—æ®µå®šä¹‰å®Œæ•´ï¼ˆå« 6 ç§ display_modeã€6 ç§ frequency_ruleã€3 ç§ banner_typeï¼‰
- `PopupBannerService.getActiveBanners()` æŸ¥è¯¢é€»è¾‘æ­£ç¡®ï¼ˆis_active + æ—¶é—´èŒƒå›´ + ä¼˜å…ˆçº§æ’åº + å¹¿å‘Šç«ä»·åˆå¹¶ + popup_queue_max_count æˆªæ–­ï¼‰
- `routes/v4/system/popup-banners.js` å‚æ•°éªŒè¯å®Œæ•´ï¼ˆstatus/position æšä¸¾æ ¡éªŒ + æƒé™æ§åˆ¶ï¼‰
- Web ç®¡ç†åå° `banners.js` composable å­—æ®µä¸åç«¯å®Œå…¨å¯¹é½ï¼ˆå«å›¾ç‰‡æ¯”ä¾‹æ ¡éªŒã€æ‹–æ‹½æ’åºã€å±•ç¤ºç»Ÿè®¡ï¼‰
- `popup_show_logs` å±•ç¤ºæ—¥å¿—è®°å½•æ­£å¸¸ï¼ˆ31 æ¡ï¼Œè¦†ç›– 2 ä¸ªç”¨æˆ·ï¼‰

---

## åã€å¯å¤ç”¨èƒ½åŠ›ä¸æ‰©å±•æ€§åˆ†æ

### 10.1 åç«¯ç°æœ‰å¯ç›´æ¥å¤ç”¨çš„èƒ½åŠ›

| èƒ½åŠ› | æ‰€åœ¨ä½ç½® | å¤ç”¨åœºæ™¯ |
|------|---------|---------|
| **ServiceManager æ¨¡å¼** | `services/index.js` | æ‰€æœ‰æœåŠ¡é€šè¿‡ `req.app.locals.services.getService('xxx')` è·å–ï¼Œæ–°å¢åŠŸèƒ½æ— éœ€æ”¹è·¯ç”±æ³¨å†Œæ–¹å¼ |
| **DataSanitizer è„±æ•** | `services/DataSanitizer.js` | å…¬å¼€ API è‡ªåŠ¨è„±æ•æ•æ„Ÿå­—æ®µï¼ˆadmin_id/internal_notes ç­‰ï¼‰ï¼Œå·²è¦†ç›–å…¬å‘Šå’Œå¼¹çª— |
| **attachDisplayNames()** | `utils/displayNameHelper.js` | è‡ªåŠ¨ä» `system_dictionaries` è¡¨é™„åŠ  `_display`ï¼ˆä¸­æ–‡åï¼‰å’Œ `_color`ï¼ˆé¢œè‰²æ ‡ç­¾ï¼‰åç¼€å­—æ®µ |
| **system_configs JSON é…ç½®** | `models/SystemConfig.js` | è¿è¡Œæ—¶å¯é…ç½®å‚æ•°ï¼ˆå¦‚ `popup_queue_max_count=5`ï¼‰ï¼Œç®¡ç†åå°å¯çƒ­æ›´æ–° |
| **system_dictionaries å­—å…¸** | `models/SystemDictionary.js` | æšä¸¾å€¼ä¸­æ–‡åŒ–ï¼Œå¼¹çª—å·²æ³¨å†Œ `banner_type/frequency_rule/display_mode/position/link_type` 5 ç»„å­—å…¸ |
| **ImageUrlHelper** | `utils/ImageUrlHelper.js` | å¯¹è±¡ key â†’ CDN URL è½¬æ¢ï¼Œå¼¹çª—å’Œè½®æ’­å›¾å·²ç»Ÿä¸€ä½¿ç”¨ |
| **Sealos å¯¹è±¡å­˜å‚¨** | `services/sealosStorage.js` | å›¾ç‰‡ä¸Šä¼ /åˆ é™¤ï¼Œå¼¹çª—å·²é›†æˆ sharp å°ºå¯¸æ ¡éªŒ + 400KB å¤§å°é™åˆ¶ |
| **BeijingTimeHelper** | `utils/timeHelper.js` | å…¨ç³»ç»ŸåŒ—äº¬æ—¶é—´æ ‡å‡†åŒ–ï¼Œæ‰€æœ‰æ¨¡å‹ hooks å·²ä½¿ç”¨ |
| **å¹¿å‘Šç«ä»·é›†æˆ** | `services/AdBiddingService.js` | å¼¹çª—å·²ä¸å¹¿å‘Šç«ä»·ç³»ç»Ÿåˆå¹¶ï¼ˆPhase 4ï¼‰ï¼Œè¿è¥å¼¹çª—å’Œå¹¿å‘Šå¼¹çª—åœ¨åŒä¸€é˜Ÿåˆ—ä¸­æŒ‰ priority æ’åº |

### 10.2 å¯æ‰©å±•çš„æ–¹å‘

| æ‰©å±•æ–¹å‘ | åŸºäºç°æœ‰èƒ½åŠ› | å·¥ä½œé‡ |
|---------|-------------|--------|
| æ–°å¢å¼¹çª—ä½ç½®ï¼ˆå¦‚ `lottery`/`exchange`ï¼‰ | ä¿®æ”¹ `position` å­—æ®µéªŒè¯ï¼ˆVARCHAR(50) æ—  ENUM çº¦æŸï¼‰+ ç®¡ç†åå°ç­›é€‰é€‰é¡¹ | ä½ |
| æ–°å¢é¢‘ç‡è§„åˆ™ | ä¿®æ”¹ `frequency_rule` å­—æ®µéªŒè¯ + ç®¡ç†åå°é€‰é¡¹ + å°ç¨‹åºç«¯æ‰§è¡Œé€»è¾‘ | ä¸­ |
| å¼¹çª— A/B æµ‹è¯• | åˆ©ç”¨ `FeatureFlag` æ¨¡å‹ + `UserAdTag`ï¼ˆDMP æ ‡ç­¾ï¼‰ï¼ŒæŒ‰ç”¨æˆ·åˆ†ç¾¤ä¸‹å‘ä¸åŒå¼¹çª— | é«˜ |
| å…¬å‘Šå¯Œæ–‡æœ¬ | `content` å­—æ®µä¸º TEXT ç±»å‹ï¼Œå¯ç›´æ¥å­˜å‚¨ Markdown/HTMLï¼Œå‰ç«¯æ¸²æŸ“å³å¯ | ä½ |
| å…¬å‘Šæ¨é€é€šçŸ¥ | åˆ©ç”¨ç°æœ‰ `NotificationService` + Socket.io å®æ—¶æ¨é€ + `AdminNotification` æ¨¡å‹ | ä¸­ |

---

## åä¸€ã€Web ç®¡ç†åå°å‰ç«¯æŠ€æœ¯æ ˆå…¼å®¹æ€§è¯„ä¼°

### 11.1 æŠ€æœ¯æ ˆåŒ¹é…åº¦

| åç«¯æ–¹æ¡ˆ | Web å‰ç«¯ç°æœ‰æœºåˆ¶ | å…¼å®¹æ€§ |
|---------|----------------|--------|
| B1 ä¿®å¤ DataSanitizer å­—æ®µå | `announcements.js` ä½¿ç”¨ `ann.announcement_id \|\| ann.id` | âœ… ä¿®å¤å console API è¿”å› `announcement_id`ï¼ˆæ–¹æ¡ˆ Aï¼‰ï¼Œå‰ç«¯å·²é€‚é… |
| popup_banners å®Œæ•´ CRUD | `banners.js` composable å« 15 ä¸ªå­—æ®µ + å›¾ç‰‡ä¸Šä¼  + æ‹–æ‹½æ’åº + å±•ç¤ºç»Ÿè®¡ | âœ… å®Œå…¨å¯¹é½ |
| system_configs çƒ­æ›´æ–° | ç®¡ç†åå°å·²æœ‰ `/api/v4/console/config` CRUD é¡µé¢ | âœ… è¿è¥å¯ç›´æ¥ç¼–è¾‘ `popup_queue_max_count` |
| system_dictionaries ä¸­æ–‡åŒ– | å¼¹çª—ç®¡ç†å·²ä½¿ç”¨ `_display` åç¼€æ˜¾ç¤ºä¸­æ–‡æ ‡ç­¾ | âœ… å®Œå…¨å¤ç”¨ |
| Sealos å›¾ç‰‡ä¸Šä¼  | `banners.js` ä½¿ç”¨ FormData + `getToken()` + Bearer Auth | âœ… å®Œå…¨å¯¹é½ |

### 11.2 å‰ç«¯éœ€è¦é…åˆçš„æ”¹åŠ¨

| æ”¹åŠ¨é¡¹ | æ–‡ä»¶ | å·¥ä½œé‡ | è¯´æ˜ |
|--------|------|--------|------|
| å…¬å‘Šç¼–è¾‘è¡¨å•å­—æ®µåç»Ÿä¸€ | `admin/src/modules/content/composables/announcements.js` | ä½ | B1 ä¿®å¤åï¼Œæ”¹ç”¨ `announcement_id`ï¼ˆå¦‚é‡‡ç”¨æ–¹æ¡ˆ Aï¼‰ |
| è½®æ’­å›¾å¤ç”¨å¼¹çª—çš„æ¯”ä¾‹æ ¡éªŒ | è½®æ’­å›¾ç®¡ç† composable | ä½ | å¯ç›´æ¥å¤ç”¨ `banners.js` çš„ `checkImageRatio()` æ–¹æ³• |

---

## åäºŒã€éœ€è¦æ‹æ¿çš„å†³ç­–é¡¹

### å†³ç­– 5ï¼šå…¬å‘Šä¸»é”®å­—æ®µåç»Ÿä¸€æ–¹æ¡ˆ â€” â“ å¾…æ‹æ¿

**èƒŒæ™¯**: DataSanitizer ä¿®å¤ B1 åï¼Œå…¬å¼€ API å°†æ­£ç¡®è¿”å›å…¬å‘Š IDï¼Œä½†ä»éœ€å†³å®šç»Ÿä¸€çš„å­—æ®µåã€‚

| é€‰é¡¹ | å­—æ®µå | å½±å“èŒƒå›´ | æ¨èåº¦ |
|------|--------|---------|--------|
| **æ–¹æ¡ˆ Aï¼ˆæ¨èï¼‰** | ç»Ÿä¸€ä¸º `announcement_id` | ä¿®æ”¹ DataSanitizer è¾“å‡º + console è·¯ç”± Service å±‚ç»Ÿä¸€ + Web å‰ç«¯å·²é€‚é… + å°ç¨‹åºç›´æ¥ä½¿ç”¨ | â­â­â­ |
| æ–¹æ¡ˆ B | ä¿æŒåŒè½¨ï¼šå…¬å¼€ API ç”¨ `id`ï¼Œconsole ç”¨ `system_announcement_id` | æ— æ”¹åŠ¨ï¼Œä½†å‰ç«¯éœ€ç»´æŠ¤ä¸¤å¥—æ˜ å°„ | â­ |

**æ¨èæ–¹æ¡ˆ A çš„ç†ç”±**:
1. å‚è€ƒå¼¹çª—æ¨¡å¼ï¼š`popup_banner_id` åœ¨å…¬å¼€å’Œç®¡ç† API ä¸­ä¸€è‡´
2. é¡¹ç›®æœªä¸Šçº¿ï¼Œç»Ÿä¸€å­—æ®µåé•¿æœŸç»´æŠ¤æˆæœ¬æœ€ä½
3. Web ç®¡ç†åå°å‰ç«¯ `announcements.js` å·²ä½¿ç”¨ `announcement_id`
4. éµå¾ª"ä»¥åç«¯æ•°æ®åº“ä¸ºå‡†ï¼Œå‰ç«¯é€‚é…åç«¯"åŸåˆ™

### å†³ç­– 6ï¼šBanner ID=15 è¿‡æœŸå¤„ç† â€” â“ å¾…æ‹æ¿

**èƒŒæ™¯**: Banner ID=15 çš„ `end_time` å·²è¿‡æœŸï¼Œä½† `is_active` ä»ä¸º 1ã€‚åç«¯æŸ¥è¯¢å·²æ­£ç¡®è¿‡æ»¤ï¼Œç”¨æˆ·ç«¯æ— å½±å“ï¼Œä½†ç®¡ç†åå°åˆ—è¡¨ä¸­ä»æ˜¾ç¤ºä¸º"å¯ç”¨"çŠ¶æ€ã€‚

| é€‰é¡¹ | æ“ä½œ | å½±å“ |
|------|------|------|
| **é€‰é¡¹ A** | æ‰‹åŠ¨å°† `is_active` æ”¹ä¸º 0ï¼ˆå·²åœç”¨ï¼‰ | ç®¡ç†åå°åˆ—è¡¨çŠ¶æ€å‡†ç¡® |
| **é€‰é¡¹ B** | ä¸å¤„ç†ï¼Œä¾èµ– `status_description` å­—æ®µæ˜¾ç¤º"å·²è¿‡æœŸ" | ç®¡ç†åå°å·²å®ç° `getStatusDescription()` è¿”å›"å·²è¿‡æœŸ" |
| **é€‰é¡¹ C** | å¢åŠ åç«¯å®šæ—¶ä»»åŠ¡ï¼Œè‡ªåŠ¨å°†è¿‡æœŸå¼¹çª—çš„ `is_active` ç½®ä¸º 0 | é•¿æœŸæ–¹æ¡ˆï¼Œåˆ©ç”¨ç°æœ‰ `node-cron` åŸºç¡€è®¾æ–½ |

### å†³ç­– 7ï¼šcarousel_items å›¾ç‰‡æ¯”ä¾‹ä¸åŒ¹é…å¤„ç† â€” â“ å¾…æ‹æ¿

**èƒŒæ™¯**: ID=26 è½®æ’­å›¾é€‰æ‹© `wide`(16:9) æ¨¡å¼ä½†ä¸Šä¼ äº†ç«–å›¾(345Ã—569)ï¼Œå±•ç¤ºæ—¶ä¼šè¢«è£åˆ‡ã€‚

| é€‰é¡¹ | æ“ä½œ |
|------|------|
| **é€‰é¡¹ A** | ç®¡ç†å‘˜é€šè¿‡ç®¡ç†åå°ä¿®æ”¹ `display_mode` ä¸ºæ­£ç¡®çš„æ¨¡å¼ï¼Œæˆ–æ›¿æ¢ä¸ºæ­£ç¡®æ¯”ä¾‹çš„å›¾ç‰‡ |
| **é€‰é¡¹ B** | è½®æ’­å›¾ç®¡ç†é¡µå¤ç”¨å¼¹çª—ç®¡ç†çš„ `checkImageRatio()` å‰ç«¯æ ¡éªŒï¼Œä¸Šä¼ æ—¶ç»™å‡ºåŒ¹é…åº¦è­¦å‘Šï¼ˆå¼¹çª—ç®¡ç†å·²æœ‰æ­¤åŠŸèƒ½ï¼‰ |

---

## åä¸‰ã€åç«¯æ‰§è¡Œæ­¥éª¤

### æ­¥éª¤ 1ï¼ˆP0ï¼‰ï¼šä¿®å¤ DataSanitizer å…¬å‘Šä¸»é”®å­—æ®µå¼•ç”¨

**ä¿®æ”¹æ–‡ä»¶**ï¼š`services/DataSanitizer.js`

å°† `sanitizeAnnouncements()` ä¸­ `announcement.announcement_id` æ”¹ä¸º `announcement.system_announcement_id`ï¼ˆæˆ–å†³ç­– 5 æ–¹æ¡ˆ A ç¡®å®šåç»Ÿä¸€ä¸º `announcement_id`ï¼‰ã€‚

**å½’å±**ï¼šåç«¯ä»£ç é—®é¢˜

### æ­¥éª¤ 2ï¼ˆP0ï¼‰ï¼šä¿®å¤å…¬å‘Š `/home` è·¯ç”± view_count è‡ªå¢

**ä¿®æ”¹æ–‡ä»¶**ï¼š`routes/v4/system/announcements.js`

ä¿®å¤ `incrementViewCount()` è°ƒç”¨çš„å­—æ®µå¼•ç”¨ï¼Œç¡®ä¿ä¼ å…¥æ­£ç¡®çš„æ•´æ•° IDã€‚

**å½’å±**ï¼šåç«¯ä»£ç é—®é¢˜

### æ­¥éª¤ 3ï¼ˆP2ï¼Œéœ€å†³ç­– 5 æ‹æ¿ï¼‰ï¼šç»Ÿä¸€å…¬å‘Šä¸»é”®å­—æ®µå

è‹¥é‡‡ç”¨æ–¹æ¡ˆ Aï¼Œéœ€åœ¨ä»¥ä¸‹ä½ç½®ç»Ÿä¸€ä½¿ç”¨ `announcement_id`ï¼š
1. `services/DataSanitizer.js` â€” è¾“å‡ºå­—æ®µæ”¹ä¸º `announcement_id`
2. `routes/v4/console/system/announcements.js` â€” console è·¯ç”± Service å±‚ç»Ÿä¸€è¾“å‡º `announcement_id`
3. `admin/src/modules/content/composables/announcements.js` â€” ç¡®è®¤ `announcement_id` å­—æ®µï¼ˆå·²é€‚é…ï¼‰
4. å¾®ä¿¡å°ç¨‹åºå‰ç«¯ â€” ä½¿ç”¨ `announcement_id` å­—æ®µ

**å½’å±**ï¼šåç«¯ä»£ç  + Web å‰ç«¯ + å¾®ä¿¡å°ç¨‹åºå‰ç«¯

### æ­¥éª¤ 4ï¼ˆP3ï¼Œå¯é€‰ï¼‰ï¼šè½®æ’­å›¾ç®¡ç†å¤ç”¨å¼¹çª—çš„å›¾ç‰‡æ¯”ä¾‹æ ¡éªŒ

**ä¿®æ”¹æ–‡ä»¶**ï¼šè½®æ’­å›¾ç®¡ç† composable

ä» `banners.js` æå– `checkImageRatio()` ä¸ºå…±äº«å·¥å…·å‡½æ•°ï¼ˆæˆ–åœ¨è½®æ’­å›¾ composable ä¸­ç›´æ¥è°ƒç”¨ï¼‰ï¼Œä¸Šä¼ æ—¶æ˜¾ç¤ºæ¯”ä¾‹åŒ¹é…åº¦è­¦å‘Šã€‚

**å½’å±**ï¼šWeb ç®¡ç†åå°å‰ç«¯é—®é¢˜

---

## åå››ã€é™„å½•

### é™„å½• Aï¼šsystem_announcements è¡¨å®Œæ•´ç»“æ„ï¼ˆä¸»é”®: `system_announcement_id`ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `system_announcement_id` | INT PK AUTO_INCREMENT | ä¸»é”® |
| `title` | VARCHAR(200) | å…¬å‘Šæ ‡é¢˜ |
| `content` | TEXT | å…¬å‘Šå†…å®¹ |
| `type` | ENUM('system','activity','maintenance','notice') | å…¬å‘Šç±»å‹ |
| `priority` | ENUM('high','medium','low') | ä¼˜å…ˆçº§ |
| `target_groups` | JSON | ç›®æ ‡ç”¨æˆ·ç»„ï¼ˆç®¡ç†å‘˜å¯è§ï¼‰ |
| `is_active` | TINYINT(1) | æ˜¯å¦æ¿€æ´» |
| `expires_at` | DATETIME | è¿‡æœŸæ—¶é—´ |
| `admin_id` | INT FKâ†’users | åˆ›å»ºç®¡ç†å‘˜ |
| `internal_notes` | TEXT | å†…éƒ¨å¤‡æ³¨ï¼ˆç®¡ç†å‘˜å¯è§ï¼‰ |
| `view_count` | INT | æŸ¥çœ‹æ¬¡æ•° |
| `created_at` / `updated_at` | DATETIME | æ—¶é—´æˆ³ |

### é™„å½• Bï¼špopup_banners è¡¨å®Œæ•´ç»“æ„

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `popup_banner_id` | INT PK AUTO_INCREMENT | ä¸»é”® |
| `title` | VARCHAR(100) | å¼¹çª—æ ‡é¢˜ï¼ˆç®¡ç†åå°æ ‡è¯†ç”¨ï¼‰ |
| `image_url` | VARCHAR(500) | å›¾ç‰‡ object keyï¼ˆSealos å¯¹è±¡å­˜å‚¨ï¼‰ |
| `display_mode` | ENUM(6ç§) | æ˜¾ç¤ºæ¨¡å¼ï¼ˆå¿…å¡«ï¼Œæ— é»˜è®¤å€¼ï¼‰ |
| `image_width` / `image_height` | INT UNSIGNED | åŸå›¾å°ºå¯¸ï¼ˆä¸Šä¼ æ—¶ sharp è‡ªåŠ¨æ£€æµ‹ï¼‰ |
| `link_url` | VARCHAR(500) | ç‚¹å‡»è·³è½¬é“¾æ¥ |
| `link_type` | ENUM('none','page','miniprogram','webview') | è·³è½¬ç±»å‹ |
| `position` | VARCHAR(50) | æ˜¾ç¤ºä½ç½®ï¼ˆhome/profileï¼‰ |
| `is_active` | TINYINT(1) | æ˜¯å¦å¯ç”¨ |
| `display_order` | INT | ç®¡ç†åå°åˆ—è¡¨æ’åºï¼ˆæ•°å­—å°æ’å‰ï¼‰ |
| `start_time` / `end_time` | DATETIME | å±•ç¤ºæ—¶é—´çª—å£ |
| `banner_type` | VARCHAR(20) | å¼¹çª—ç±»å‹ï¼ˆnotice/event/promoï¼‰ |
| `frequency_rule` | VARCHAR(30) | é¢‘ç‡è§„åˆ™ï¼ˆ6ç§ï¼‰ |
| `frequency_value` | INT | é¢‘ç‡å‚æ•°ï¼ˆé…åˆ N å¤© / N æ¬¡ä½¿ç”¨ï¼‰ |
| `force_show` | TINYINT(1) | æ˜¯å¦å¼ºåˆ¶å¼¹å‡º |
| `priority` | INT | å¼¹å‡ºç«äº‰ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå¤§è¶Šä¼˜å…ˆï¼‰ |
| `created_by` | INT FKâ†’users | åˆ›å»ºäºº |
| `created_at` / `updated_at` | DATETIME | æ—¶é—´æˆ³ |

### é™„å½• Cï¼šç›¸å…³ API è·¯ç”±æ±‡æ€»

| ç”¨é€” | æ–¹æ³• | è·¯å¾„ | æƒé™ |
|------|------|------|------|
| å°ç¨‹åºè·å–é¦–é¡µå…¬å‘Š | GET | `/api/v4/system/announcements/home` | Public |
| å°ç¨‹åºè·å–å…¬å‘Šåˆ—è¡¨ | GET | `/api/v4/system/announcements` | Public |
| å°ç¨‹åºè·å–å¼¹çª—åˆ—è¡¨ | GET | `/api/v4/system/popup-banners?status=active` | Public |
| å°ç¨‹åºä¸ŠæŠ¥å¼¹çª—å±•ç¤º | POST | `/api/v4/system/ad-events/popup-banners/show-log` | éœ€ç™»å½• |
| ç®¡ç†åå°åˆ›å»ºå…¬å‘Š | POST | `/api/v4/console/system/announcements` | Admin |
| ç®¡ç†åå°æ›´æ–°å…¬å‘Š | PUT | `/api/v4/console/system/announcements/:id` | Admin |
| ç®¡ç†åå°åˆ é™¤å…¬å‘Š | DELETE | `/api/v4/console/system/announcements/:id` | Admin |
| ç®¡ç†åå°åˆ›å»ºå¼¹çª— | POST | `/api/v4/console/popup-banners` | Admin |
| ç®¡ç†åå°æ›´æ–°å¼¹çª— | PUT | `/api/v4/console/popup-banners/:id` | Admin |
| ç®¡ç†åå°åˆ é™¤å¼¹çª— | DELETE | `/api/v4/console/popup-banners/:id` | Admin |
| ç®¡ç†åå°åˆ‡æ¢å¼¹çª—çŠ¶æ€ | PATCH | `/api/v4/console/popup-banners/:id/toggle` | Admin |
| ç®¡ç†åå°è°ƒæ•´å¼¹çª—æ’åº | PATCH | `/api/v4/console/popup-banners/order` | Admin |
| ç®¡ç†åå°æŸ¥çœ‹å¼¹çª—ç»Ÿè®¡ | GET | `/api/v4/console/ad-campaigns/popup-banners/:id/show-stats` | Admin |
