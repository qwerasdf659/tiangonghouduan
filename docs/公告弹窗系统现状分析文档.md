# 公告弹窗系统现状分析 — 后端数据库实际求证

> **项目**: 天工小程序（餐厅积分抽奖系统 V4.0）  
> **创建时间**: 2026-02-20  
> **二次求证时间**: 2026-02-20（Node.js 直连生产数据库 + 后端/前端代码追踪）  
> **三次求证时间**: 2026-02-20（全量代码追踪 + 数据库实时查询 + 系统性 `announcement_id` 幽灵字段排查）  
> **状态**: 7 项决策已拍板 + 🔴 1 项系统性缺陷（6 处代码表现）已定位 + 8 步执行计划已制定

---

## 零、项目实际技术栈和架构

> 以下信息均来自后端项目实际代码和数据库真实数据，不引用任何历史报告。

### 三端分离架构

| 端 | 技术栈 | 代码位置 |
|----|--------|----------|
| 后端 API 服务 | Node.js + Express + Sequelize + MySQL | 本仓库根目录 (`/home/devbox/project/`) |
| Web 管理后台 | Vite + Alpine.js + Tailwind CSS | 本仓库 `/admin/` 目录 |
| 微信小程序前端 | 微信原生小程序（天工小程序） | **不在本仓库，独立项目** |

### 商业模式

餐厅积分抽奖系统 — 用户通过消费获取积分，积分可抽奖/兑换商品，系统包含广告投放、交易市场、臻选空间等变现模块。公告和弹窗属于内容运营工具，由管理员通过 Web 管理后台发布，微信小程序端展示给 C 端用户。

### 后端架构模式

- **ServiceManager 模式**: 路由通过 `req.app.locals.services.getService('xxx')` 获取服务
- **API 版本**: V4，路径前缀 `/api/v4`
- **图片存储**: Sealos 对象存储，模型层只存 object key，前端通过 `ImageUrlHelper.getImageUrl()` 生成完整 CDN URL
- **数据库**: MySQL（Sealos 云托管，外网地址 `dbconn.sealosbja.site:42569`）

---

## 一、公告弹窗系统的两套独立机制

管理后台"内容管理中心"包含 4 个 Tab，其中与公告/消息相关的是两套**完全独立**的机制：

### 机制 1：系统公告（文字公告）

| 属性 | 实际值 |
|------|--------|
| 数据库表 | `system_announcements` |
| 模型文件 | `models/SystemAnnouncement.js` |
| 服务层 | `services/AnnouncementService.js` |
| 公开 API | `GET /api/v4/system/announcements` — 公告列表（带分页） |
| 公开 API | `GET /api/v4/system/announcements/home` — 首页公告（Top 5） |
| 管理 API | `POST/GET/PUT/DELETE /api/v4/console/system/announcements` |
| 数据结构 | 纯文本内容：title + content + type + priority |
| 小程序展示位置 | **小程序首页** — 文字公告区域（滚动公告条/公告列表） |

### 机制 2：弹窗 Banner（图片弹窗）

| 属性 | 实际值 |
|------|--------|
| 数据库表 | `popup_banners` + `popup_show_logs`（展示日志） |
| 模型文件 | `models/PopupBanner.js` + `models/PopupShowLog.js` |
| 服务层 | `services/PopupBannerService.js` + `services/PopupShowLogService.js` |
| 公开 API | `GET /api/v4/system/popup-banners?status=active&position=home` |
| 管理 API | `POST/GET/PUT/DELETE/PATCH /api/v4/console/popup-banners` |
| 数据结构 | 图片弹窗：image_url + display_mode + link_url + frequency_rule + priority |
| 小程序展示位置 | **小程序首页弹窗遮罩层**（position=home）/ **个人中心弹窗**（position=profile） |

### 两套机制的核心区别

| 维度 | 系统公告 | 弹窗 Banner |
|------|---------|------------|
| 内容形态 | 纯文字（title + content） | 图片（Sealos 对象存储） |
| 展示形式 | 页面内嵌展示（如滚动条、列表） | 遮罩层弹窗（覆盖页面上层） |
| 频率控制 | 无（每次请求都返回） | 有（always/once/once_per_day/once_per_n_days 等 6 种规则） |
| 点击跳转 | 无 | 支持 4 种跳转：none/page/miniprogram/webview |
| 展示日志 | 仅 `view_count` 计数 | 独立 `popup_show_logs` 表，记录展示时长、关闭方式、队列位置 |
| 位置控制 | 仅首页 | 支持多位置（home/profile） |
| 广告集成 | 无 | 已集成广告竞价系统（合并运营弹窗与广告竞价结果） |

---

## 二、数据库真实数据现状

### 2.1 system_announcements 表（系统公告）

**总量**: 1 条（2026-02-20 已清理 102 条测试数据）

| 字段 | 值 |
|------|-----|
| ID | 1 |
| 标题 | 系统维护通知 |
| 内容 | 为提升系统性能，将于今晚进行系统维护 |
| 类型 | system |
| 优先级 | high |
| 状态 | **已停用**（is_active=0） |
| 浏览次数 | 12 |
| 创建时间 | 2025-09-29 23:51 |

**结论**: 该表目前没有任何活跃公告在前端展示。如需发布公告，管理员通过管理后台"内容管理中心 → 公告管理"创建。

**🔴 系统性缺陷（三次求证定位 6 处）**：整个公告模块存在 `announcement_id` 幽灵字段问题——数据库主键实际为 `system_announcement_id`，但 DataSanitizer（B1）、`/home` 路由（B2）、AnnouncementService 的 `markAsReadBatch`（B3）和 `deactivateBatch`（B4）、console 路由日志（B5）、模型 JSDoc（B6）共 6 处引用了不存在的 `announcement_id`。导致公开 API `id: undefined`、view_count 自增失效、批量操作 SQL 报错。详见第八节系统性缺陷分析。

### 2.2 popup_banners 表（弹窗 Banner）

**总量**: 2 条（`is_active=1`），但实际仅 1 条在展示时间范围内

| popup_banner_id | title | banner_type | position | is_active | display_mode | frequency_rule | start_time (UTC) | end_time (UTC) | **实际状态** |
|-----------------|-------|-------------|----------|-----------|-------------|----------------|------------------|----------------|-------------|
| 15 | 2.3 | promo | home | 1 | tall | once_per_day | 2026-02-08 00:50 | **2026-02-20 00:50** | **🔴 已过期**（end_time 已过） |
| 16 | 555 | promo | home | 1 | tall | once_per_day | 2026-02-10 16:22 | 2026-02-28 16:22 | ✅ 展示中 |

**🔴 关键发现**: Banner ID=15 虽然 `is_active=1`，但 `end_time=2026-02-20T00:50:00Z`（北京时间 08:50）已过期。后端 `PopupBannerService.getActiveBanners()` 的查询条件正确过滤了时间范围（`end_time > NOW()`），所以**小程序端实际只能看到 1 条弹窗（ID=16）**。`is_active` 字段仅表示管理员未手动禁用，不代表实际在展示。

**特征**:
- 2 条均为 `promo`（日常促销）类型
- 均配置为首页展示（`position=home`）
- 均不跳转（`link_type=none`）
- 频率规则均为每天弹一次（`once_per_day`）
- 显示模式均为竖图（`tall`，3:4 比例）
- `force_show=0`（可点遮罩关闭）、`priority=0`（无优先级竞争）

### 2.3 popup_show_logs 表（弹窗展示日志）

**总量**: 33 条（三次求证实时查询）

| 维度 | 分布 |
|------|------|
| 用户分布 | user_id=31（31次）、user_id=32（2次），仅 2 个用户看到过弹窗 |
| Banner 分布 | ID 15（7次，平均展示 31.7秒）、ID 16（26次，平均展示 18.4秒） |
| 关闭方式 | close_btn 为主、overlay 少量 |
| 最近展示 | 2026-02-21 04:16（北京时间，ID 16，user_id=31） |

### 2.4 carousel_items 表（轮播图，补充参考）

**总量**: 1 条

| 字段 | 值 |
|------|-----|
| carousel_item_id | 26 |
| title | 11111 |
| image_url | carousel/1771580462026_8c68f71655115546.png |
| display_mode | wide（16:9） |
| image_width × image_height | 345 × 569（实际比例与 wide 模板不匹配） |
| position | home |
| is_active | 1 |
| link_type | none |
| slide_interval_ms | 3000（3秒轮播间隔） |
| start_time | 2026-02-14 17:42 (UTC) |
| end_time | 2026-02-26 17:42 (UTC) |
| created_by | 31 |

**🔴 数据质量问题**: 图片实际尺寸 345×569（比例约 0.61:1 = 竖图），但 `display_mode` 选择了 `wide`（16:9 横屏），比例严重不匹配。后端 sharp 校验为「警告但不阻止」策略，前端展示时会被裁切或拉伸。

### 2.5 system_configs 弹窗相关配置

| config_key | config_value | 说明 |
|-----------|-------------|------|
| `popup_queue_max_count` | `5` | 弹窗队列最大数量。`PopupBannerService.getActiveBanners()` 读取此配置截断返回结果，热更新无需重启 |

---

## 三、数据流向：从管理后台到小程序

```
┌──────────────────────────────────────────────────────────┐
│              Web 管理后台（内容管理中心）                    │
│                                                          │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐         │
│  │  公告管理   │  │  弹窗管理   │  │  轮播图管理  │         │
│  │  1 条(停用) │  │  2 条(活跃) │  │  1 条(活跃) │         │
│  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘         │
└────────┼───────────────┼───────────────┼────────────────┘
         │               │               │
         ▼               ▼               ▼
   system_           popup_          carousel_
   announcements     banners         items
         │               │               │
         │               │               │
         ▼               ▼               ▼
   GET /api/v4/      GET /api/v4/    GET /api/v4/
   system/           system/         system/
   announcements/    popup-banners   carousel-items
   home              ?status=active
   (返回Top5活跃)    (返回活跃弹窗)   (返回活跃轮播)
         │               │               │
         ▼               ▼               ▼
┌──────────────────────────────────────────────────────────┐
│              微信小程序（天工小程序）                        │
│                                                          │
│  首页（推断路径 /pages/index/index 或 /pages/home/index） │
│  ┌──────────────────────────────────────────────┐       │
│  │  ① 轮播图区域 ← carousel_items                │       │
│  ├──────────────────────────────────────────────┤       │
│  │  ② 文字公告条 ← system_announcements          │       │
│  │     滚动显示 Top 5 条活跃公告                   │       │
│  ├──────────────────────────────────────────────┤       │
│  │  ③ 弹窗遮罩层 ← popup_banners                 │       │
│  │     进入首页时弹出图片，频率受控                  │       │
│  └──────────────────────────────────────────────┘       │
│                                                          │
│  个人中心（推断路径 /pages/profile/index）                │
│  ┌──────────────────────────────────────────────┐       │
│  │  弹窗遮罩层 ← popup_banners (position=profile)│       │
│  └──────────────────────────────────────────────┘       │
└──────────────────────────────────────────────────────────┘
```

### 弹窗 link_url 支持的跳转目标

根据 seeder 测试数据和后端模型定义，弹窗 `link_url` 支持以下小程序页面路径：

| link_type | 含义 | link_url 示例 |
|-----------|------|--------------|
| `none` | 不跳转 | 空 |
| `page` | 跳转小程序内页 | `/pages/lottery/index`（抽奖页）、`/pages/exchange/index`（兑换页） |
| `miniprogram` | 跳转其他小程序 | 其他小程序 appId |
| `webview` | 打开 H5 页面 | 任意 HTTPS URL |

---

## 四、后端接口详细说明

### 4.1 GET /api/v4/system/announcements/home — 首页公告

**文件**: `routes/v4/system/announcements.js`

**查询逻辑**:
- `is_active = true` 且未过期（`expires_at` 为空或大于当前时间）
- 类型不限（system/activity/maintenance/notice 均返回）
- 按优先级 DESC + 创建时间 DESC 排序
- 最多返回 5 条
- 每次请求自动 increment `view_count`

**响应格式**（经 `DataSanitizer.sanitizeAnnouncements()` 脱敏后）:
```json
{
  "success": true,
  "data": {
    "announcements": [
      {
        "id": 1,
        "title": "系统维护通知",
        "content": "为提升系统性能...",
        "type": "system",
        "type_display": "系统公告",
        "priority": "high",
        "priority_display": "高",
        "view_count": 12,
        "created_at": "2025年09月29日 23:51:00",
        "expires_at": null
      }
    ]
  }
}
```

**🔴 字段命名缺陷（三次求证追踪到 6 处）**: DataSanitizer 将主键映射为 `id`，但引用了不存在的 `announcement.announcement_id`（模型实际字段为 `system_announcement_id`），导致公开 API 返回 `id: undefined`。管理后台 API（`/api/v4/console/system/announcements`）不经过 DataSanitizer，返回原始字段 `system_announcement_id`。修复方案：统一输出为 `announcement_id`，参见第九节步骤 1-6。

### 4.2 GET /api/v4/system/popup-banners — 弹窗列表

**文件**: `routes/v4/system/popup-banners.js`

**查询逻辑**（status=active 时）:
- `is_active = true`
- 在时间范围内（`start_time` 已到且 `end_time` 未过）
- 按 `priority` DESC + `display_order` ASC + `created_at` DESC 排序
- 最多返回 10 条
- 已集成广告竞价系统（合并运营弹窗与广告定向匹配结果）

**响应格式**:
```json
{
  "success": true,
  "data": {
    "banners": [
      {
        "popup_banner_id": 16,
        "title": "555",
        "image_url": "popup-banners/xxx.jpg",
        "display_mode": "tall",
        "image_width": 750,
        "image_height": 1000,
        "link_url": "",
        "link_type": "none",
        "banner_type": "promo",
        "frequency_rule": "once_per_day",
        "frequency_value": 1,
        "force_show": false,
        "priority": 0
      }
    ]
  }
}
```

### 4.3 POST /api/v4/system/ad-events/popup-banners/show-log — 弹窗展示上报

**小程序端职责**: 弹窗展示后，上报展示时长、关闭方式、队列位置等数据到 `popup_show_logs` 表。

---

## 五、弹窗 Banner 的完整能力矩阵

后端和管理后台已实现的弹窗能力：

| 能力 | 实现状态 | 说明 |
|------|---------|------|
| 多显示模式 | ✅ 已实现 | 6 种模式：wide(16:9)/horizontal(3:2)/square(1:1)/tall(3:4)/slim(9:16)/full_image(纯图) |
| 多弹窗类型 | ✅ 已实现 | notice(系统公告)/event(活动推广)/promo(日常促销)，对应不同 priority 范围 |
| 频率控制 | ✅ 已实现 | 6 种规则：always/once/once_per_session/once_per_day/once_per_n_days/n_times_total |
| 强制弹出 | ✅ 已实现 | `force_show=true` 时不可点遮罩关闭，需点"我知道了"按钮 |
| 优先级竞争 | ✅ 已实现 | `priority` 数字越大越优先弹出（区别于 `display_order` 的管理列表排序） |
| 时间范围控制 | ✅ 已实现 | `start_time` / `end_time` 控制展示窗口 |
| 位置控制 | ✅ 已实现 | `position` 字段（home/profile） |
| 点击跳转 | ✅ 已实现 | 4 种跳转类型 |
| 展示日志 | ✅ 已实现 | `popup_show_logs` 记录时长、关闭方式、队列位置 |
| 图片比例校验 | ✅ 已实现 | 上传时后端 sharp 检测 + 前端比例匹配警告 |
| 拖拽排序 | ✅ 已实现 | 管理后台支持拖拽调整 `display_order` |
| 广告竞价集成 | ✅ 已实现 | 运营弹窗与广告竞价结果合并展示 |

---

## 六、数据质量现状（2026-02-20 二次求证）

| 项目 | 状态 | 说明 |
|------|------|------|
| system_announcements 测试数据 | ✅ 已清理 | 2026-02-20 删除 102 条测试数据，保留 1 条真实公告（已停用） |
| popup_banners | ⚠️ 需关注 | 2 条记录中 ID=15 已过期（end_time 已过），仅 ID=16 实际在展示 |
| popup_show_logs | ✅ 正常 | 33 条展示日志，覆盖 user_id=31 和 32 |
| carousel_items | ⚠️ 图片比例不匹配 | ID=26 选择 wide(16:9) 模式但实际图片为竖图(345×569)，展示会被裁切 |
| admin_notifications | 信息 | 0 条数据，功能尚未启用 |
| **公告 `announcement_id` 幽灵字段** | **🔴 系统性缺陷（6处）** | **数据库主键为 `system_announcement_id`，但 DataSanitizer、路由、Service 层共 6 处引用不存在的 `announcement_id`，导致公开 API `id: undefined`、view_count 自增失效、批量操作 SQL 报错。详见第八节** |

---

## 七、拍板决策记录（2026-02-20）

### 决策 1：system_announcements 测试数据清理 — ✅ 已执行

**决策**: 选项 A — 全部清理

**执行结果**: 2026-02-20 已执行，删除 102 条测试数据，保留 ID=1（"系统维护通知"，is_active=0）。清理后该表仅 1 条记录。

### 决策 2：当前 2 条弹窗 Banner — ✅ 确认为正式业务内容

**决策**: 当前 popup_banners 表中 2 条记录（ID 15 "2.3"、ID 16 "555"）为正确的业务设计，保持现状不动。

### 决策 3：微信小程序前端代码 — ✅ 后续排查项已列出

**决策**: 小程序前端代码不在本仓库中，在文档第八节列出需要小程序前端配合排查的工作清单。

**需要微信小程序前端配合排查的工作内容**:

| 编号 | 排查项 | 目的 | 优先级 |
|------|--------|------|--------|
| MP-1 | 确认小程序首页是否已调用 `GET /api/v4/system/announcements/home` | 确定文字公告功能是否已在小程序端实现 | P1 |
| MP-2 | 确认小程序首页是否已调用 `GET /api/v4/system/popup-banners?status=active` | 确定弹窗功能是否已在小程序端实现 | P1 |
| MP-3 | 确认小程序首页是否已调用轮播图接口 | 确定轮播图功能是否已在小程序端实现 | P2 |
| MP-4 | 确认弹窗展示后是否上报 `POST /api/v4/system/ad-events/popup-banners/show-log` | 确定弹窗展示日志是否完整 | P2 |
| MP-5 | 确认弹窗的 `frequency_rule`（频率控制）是否已在客户端实现 | 后端只下发规则，客户端负责执行 | P2 |
| MP-6 | 确认文字公告在小程序端的具体展示形态（滚动条/列表/弹窗） | 用于后续运营策略的精准匹配 | P3 |
| MP-7 | 确认弹窗 `link_type=page` 时跳转是否正常（如 `/pages/lottery/index`） | 验证弹窗跳转链路可用 | P3 |

### 决策 4：系统公告 vs 弹窗 Banner 运营分工 — ✅ 已确认

**决策**: 同意以下运营策略分工

| 场景 | 使用机制 | 理由 |
|------|---------|------|
| 系统维护通知 | 系统公告（文字） | 简洁，不打断用户操作 |
| 活动推广（有视觉设计图） | 弹窗 Banner（图片） | 视觉冲击力强，支持跳转 |
| 紧急安全通知 | 弹窗 Banner（`force_show=true`） | 强制用户确认，不可点遮罩关闭 |
| 日常运营信息 | 系统公告（文字） | 轻量，不干扰用户体验 |

---

## 八、问题归属分析：哪些是谁的问题

### 8.1 后端数据库项目的问题

#### 🔴 系统性缺陷：`announcement_id` 幽灵字段（三次求证新发现）

**根因分析**：数据库主键列名为 `system_announcement_id`（Sequelize 模型定义 `models/SystemAnnouncement.js` 第 39 行），但代码中共有 **6 处**引用了不存在的 `announcement_id` 字段。推测原因是开发时误以为主键名为 `announcement_id`（模型文件 JSDoc 第 21 行注释错误写成 `主键：announcement_id`），导致后续所有引用都沿袭了这个错误。

| 编号 | 问题 | 优先级 | 复杂度 | 文件 | 行号 | 具体表现 |
|------|------|--------|--------|------|------|---------|
| B1 | DataSanitizer 公告主键映射 | **P0** | 低 | `services/DataSanitizer.js` | 580 | `id: announcement.announcement_id` → 输出 `id: undefined`，公开 API 返回的公告 ID 全部为 undefined |
| B2 | `/home` 路由 view_count 自增失效 | **P0** | 低 | `routes/v4/system/announcements.js` | 108 | `incrementViewCount(announcement.announcement_id)` → 传入 undefined，`findByPk(undefined)` 查不到记录，view_count 永不自增 |
| B3 | Service 层批量标记已读 SQL 报错 | **P0** | 低 | `services/AnnouncementService.js` | 247 | `where: { announcement_id: { [Op.in]: ... } }` → Sequelize 生成的 SQL 引用不存在的列 `announcement_id`，执行时将抛出 `Unknown column` 错误 |
| B4 | Service 层批量停用 SQL 报错 | **P1** | 低 | `services/AnnouncementService.js` | 340 | 同 B3，`deactivateBatch()` 的 WHERE 子句引用不存在的列 `announcement_id` |
| B5 | Console 路由创建日志记录 undefined | P2 | 低 | `routes/v4/console/system/announcements.js` | 68 | `announcement_id: announcement.announcement_id` → `createAnnouncement()` 返回 `toJSON()` 结果中字段名为 `system_announcement_id`，日志记录 `announcement_id: undefined` |
| B6 | 模型文件 JSDoc 注释错误 | P3 | 低 | `models/SystemAnnouncement.js` | 21 | 注释写 `主键：announcement_id` 但实际主键为 `system_announcement_id`，误导后续开发 |

**影响范围汇总**：

| 影响面 | 具体表现 | 严重程度 |
|--------|---------|---------|
| 小程序端公告功能 | 公开 API 返回 `id: undefined`，小程序无法获取公告 ID | 🔴 功能不可用 |
| 公告浏览统计 | view_count 自增失效，运营数据不准确（当前 view_count=12 为历史手动写入） | 🔴 数据不准确 |
| 管理后台批量操作 | 通知中心"全部已读"/"批量停用"功能会抛 SQL 错误 | 🔴 功能崩溃 |
| 运维日志 | 创建公告的操作日志中 `announcement_id` 字段为 undefined，无法追踪 | 🟡 可观测性缺失 |

### 8.2 Web 管理后台前端项目的问题

| 编号 | 问题 | 优先级 | 复杂度 | 说明 |
|------|------|--------|--------|------|
| W1 | 公告编辑表单字段名容错逻辑需清理 | P1 | 低 | `announcements.js` 的 `editAnnouncement()` 使用 `ann.announcement_id \|\| ann.id` 容错逻辑（第 75 行）。当后端统一输出 `announcement_id` 后，应去掉 `\|\| ann.id` 容错，直接使用 `ann.announcement_id`，符合"直接使用后端字段名，不做复杂映射"原则 |
| W2 | 公告表单初始化 `announcement_id` 字段 | P1 | 低 | `useAnnouncementsState()` 中表单初始值已使用 `announcement_id: null`（第 26 行），与后端统一后的 `announcement_id` 字段天然对齐，无需修改 |
| W3 | carousel_items 图片比例不匹配无前端阻断 | P3 | 低 | 管理后台允许 `display_mode=wide` 但上传竖图，仅后端 sharp 警告不阻止。可在前端增加比例匹配度显示（弹窗管理已有此功能，轮播图管理可复用 `checkImageRatio()` 逻辑） |

### 8.3 微信小程序前端项目的问题

| 编号 | 问题 | 优先级 | 说明 |
|------|------|--------|------|
| MP-1 | 确认是否调用 `GET /api/v4/system/announcements/home` | P1 | 当前公开 API 因 B1 缺陷返回 `id: undefined`，小程序端即使已对接也无法正确使用公告 ID |
| MP-2 | 确认是否调用 `GET /api/v4/system/popup-banners?status=active` | P1 | 弹窗 API 无 DataSanitizer 脱敏，直接返回 `popup_banner_id`，字段正确 |
| MP-3 | 确认弹窗 `frequency_rule` 客户端执行逻辑 | P2 | 后端只下发规则（如 `once_per_day`），客户端需本地存储展示记录并判断是否弹出 |
| MP-4 | 确认弹窗展示上报 `POST .../show-log` 是否已实现 | P2 | popup_show_logs 表有 33 条数据（三次求证实时查询），说明至少 user_id=31 和 32 的小程序版本已实现上报 |
| MP-5 | 弹窗 `link_type=page` 跳转路径确认 | P3 | 需确认小程序端是否处理了 `link_url` 中的页面路径跳转 |
| MP-6 | 文字公告在小程序端的展示形态确认 | P3 | 首页文字公告条是滚动条、列表还是弹窗，影响后续运营策略 |

---

## 九、后端实施方案（基于现有技术栈）

> 以下方案完全基于后端项目现有的 ServiceManager + DataSanitizer + Sequelize 技术体系，不引入新依赖、不新建表、不新建模型。

### 9.1 系统性修复：`announcement_id` 幽灵字段全量清理（P0，6 处统一修复）

**根因**：数据库主键为 `system_announcement_id`，但 6 处代码引用了不存在的 `announcement_id`。

**修复策略**：参照已有的 `popup_banner_id` 一致性模式（公开 API 和管理 API 都直接使用 `popup_banner_id`），公告系统也统一输出 `announcement_id`（从 `system_announcement_id` 映射）。前端直接使用 `announcement_id`，不做容错 fallback。

**修改文件 1**：`services/DataSanitizer.js`（修复 B1）

`sanitizeAnnouncements()` 方法中（第 580 行附近）：
- 将 `id: announcement.announcement_id` 改为 `announcement_id: announcement.system_announcement_id`
- 同时修正 JSDoc 注释（第 543 行）：`主键：announcement_id` → `主键：system_announcement_id`

**修改文件 2**：`routes/v4/system/announcements.js`（修复 B2）

`/announcements/home` 路由中（第 108 行）：
- `announcement.announcement_id` 改为 `announcement.announcement_id`（修复 DataSanitizer 后输出字段名变为 `announcement_id`，这行代码的引用将自动正确）

**修改文件 3**：`services/AnnouncementService.js`（修复 B3 + B4）

- `markAsReadBatch()` 第 247 行：`announcement_id: { [Op.in]: announcementIds }` → `system_announcement_id: { [Op.in]: announcementIds }`
- `deactivateBatch()` 第 340 行：`announcement_id: { [Op.in]: announcementIds }` → `system_announcement_id: { [Op.in]: announcementIds }`

**修改文件 4**：`routes/v4/console/system/announcements.js`（修复 B5）

POST 创建路由日志（第 68 行）：
- `announcement_id: announcement.announcement_id` → `announcement_id: announcement.system_announcement_id`

**修改文件 5**：`models/SystemAnnouncement.js`（修复 B6）

JSDoc 注释（第 21 行）：
- `主键：announcement_id` → `主键：system_announcement_id`

**可复用的现有能力**：
- DataSanitizer 已有完整的脱敏架构，只需修正字段引用和输出字段名
- `incrementViewCount()` 方法使用 `findByPk()` 接收整数 ID，修复后直接生效
- Sequelize 的 `Op.in` 查询语法已被广泛使用，修正列名即可

**影响范围**：
- 公开 API `GET /api/v4/system/announcements` 和 `/home`：`id` 字段变为 `announcement_id`，值从 undefined 变为正确整数
- 管理后台 console API `GET /api/v4/console/system/announcements`：`dataLevel='full'` 跳过 DataSanitizer，仍返回 `system_announcement_id`（Sequelize toJSON 原始输出）
- 管理后台前端 `announcements.js`：`editAnnouncement()` 中 `ann.announcement_id` 从 console API 获取时为 undefined（因 console 返回 `system_announcement_id`），需在步骤 3 中处理

### 9.2 管理后台 console 公告字段名统一（P1）

**问题本质**：步骤 1 修复后，公开 API 输出 `announcement_id`，但管理后台 console API 仍返回 `system_announcement_id`（因 `dataLevel='full'` 跳过 DataSanitizer）。

**方案（推荐）**：在 `AnnouncementService.getAnnouncements()` 的 `dataLevel='full'` 分支中，也做字段映射——将 `system_announcement_id` 映射为 `announcement_id`。具体方式：

在 `AnnouncementService.getAnnouncements()` 返回前（第 113 行附近），无论 `dataLevel` 是什么，都经过 DataSanitizer。当 `dataLevel='full'` 时，DataSanitizer 返回完整数据但也统一输出 `announcement_id`。

**影响范围**：
- console API 返回字段名从 `system_announcement_id` 变为 `announcement_id`
- Web 管理后台前端 `announcements.js` 的 `ann.announcement_id` 将直接获取到正确值，去掉 `|| ann.id` 容错

**与 popup_banners 的一致性对比**：

| 实体 | 数据库主键 | 公开 API 输出 | 管理 API 输出 | 统一后 |
|------|-----------|-------------|-------------|--------|
| 弹窗 | `popup_banner_id` | `popup_banner_id` | `popup_banner_id` | ✅ 已一致 |
| 轮播图 | `carousel_item_id` | `carousel_item_id` | `carousel_item_id` | ✅ 已一致 |
| **公告** | `system_announcement_id` | `id`（当前 undefined） | `system_announcement_id` | → `announcement_id`（统一） |

### 9.3 弹窗系统无代码缺陷，现状确认

弹窗 Banner 的完整链路（模型 → 服务 → 路由 → 前端）经代码追踪和数据库验证，**无功能缺陷**：

- `PopupBanner` 模型字段定义完整（含 6 种 display_mode、6 种 frequency_rule、3 种 banner_type）
- `PopupBannerService.getActiveBanners()` 查询逻辑正确（is_active + 时间范围 + 优先级排序 + 广告竞价合并 + popup_queue_max_count 截断）
- `routes/v4/system/popup-banners.js` 参数验证完整（status/position 枚举校验 + 权限控制）
- Web 管理后台 `banners.js` composable 字段与后端完全对齐（含图片比例校验、拖拽排序、展示统计）
- `popup_show_logs` 展示日志记录正常（31 条，覆盖 2 个用户）

---

## 十、可复用能力与扩展性分析

### 10.1 后端现有可直接复用的能力

| 能力 | 所在位置 | 复用场景 |
|------|---------|---------|
| **ServiceManager 模式** | `services/index.js` | 所有服务通过 `req.app.locals.services.getService('xxx')` 获取，新增功能无需改路由注册方式 |
| **DataSanitizer 脱敏** | `services/DataSanitizer.js` | 公开 API 自动脱敏敏感字段（admin_id/internal_notes 等），已覆盖公告和弹窗 |
| **attachDisplayNames()** | `utils/displayNameHelper.js` | 自动从 `system_dictionaries` 表附加 `_display`（中文名）和 `_color`（颜色标签）后缀字段 |
| **system_configs JSON 配置** | `models/SystemConfig.js` | 运行时可配置参数（如 `popup_queue_max_count=5`），管理后台可热更新 |
| **system_dictionaries 字典** | `models/SystemDictionary.js` | 枚举值中文化，弹窗已注册 `banner_type/frequency_rule/display_mode/position/link_type` 5 组字典 |
| **ImageUrlHelper** | `utils/ImageUrlHelper.js` | 对象 key → CDN URL 转换，弹窗和轮播图已统一使用 |
| **Sealos 对象存储** | `services/sealosStorage.js` | 图片上传/删除，弹窗已集成 sharp 尺寸校验 + 400KB 大小限制 |
| **BeijingTimeHelper** | `utils/timeHelper.js` | 全系统北京时间标准化，所有模型 hooks 已使用 |
| **广告竞价集成** | `services/AdBiddingService.js` | 弹窗已与广告竞价系统合并（Phase 4），运营弹窗和广告弹窗在同一队列中按 priority 排序 |

### 10.1.1 三次求证补充：cron 任务基础设施

| 能力 | 所在位置 | 复用场景 |
|------|---------|---------|
| **node-cron 定时任务模式** | `jobs/ad-cron-jobs.js` | 广告系统已使用完整的 cron 模式：环境变量开关（`ENABLE_AD_CRON_JOBS`）+ 类封装（`AdCronJobs.init()`）+ 结构化日志。步骤 7 的内容过期清理 cron 直接复用此模式 |
| **定时任务注册入口** | `app.js`（需确认） | `ad-cron-jobs.js` 通过 `require('./jobs/ad-cron-jobs')` 在应用启动时自动注册。新增 `content-cron-jobs.js` 采用相同方式 |

### 10.2 可扩展的方向

| 扩展方向 | 基于现有能力 | 工作量 |
|---------|-------------|--------|
| 新增弹窗位置（如 `lottery`/`exchange`） | 修改 `position` 字段验证（VARCHAR(50) 无 ENUM 约束）+ 管理后台筛选选项 | 低 |
| 新增频率规则 | 修改 `frequency_rule` 字段验证 + 管理后台选项 + 小程序端执行逻辑 | 中 |
| 弹窗 A/B 测试 | 利用 `FeatureFlag` 模型 + `UserAdTag`（DMP 标签），按用户分群下发不同弹窗 | 高 |
| 公告富文本 | `content` 字段为 TEXT 类型，可直接存储 Markdown/HTML，前端渲染即可 | 低 |
| 公告推送通知 | 利用现有 `NotificationService` + Socket.io 实时推送 + `AdminNotification` 模型 | 中 |

---

## 十一、Web 管理后台前端技术栈兼容性评估

### 11.1 技术栈匹配度

| 后端方案 | Web 前端现有机制 | 兼容性 |
|---------|----------------|--------|
| B1 修复 DataSanitizer 字段名 | `announcements.js` 使用 `ann.announcement_id \|\| ann.id` | ✅ 修复后 console API 返回 `announcement_id`（方案 A），前端已适配 |
| popup_banners 完整 CRUD | `banners.js` composable 含 15 个字段 + 图片上传 + 拖拽排序 + 展示统计 | ✅ 完全对齐 |
| system_configs 热更新 | 管理后台已有 `/api/v4/console/config` CRUD 页面 | ✅ 运营可直接编辑 `popup_queue_max_count` |
| system_dictionaries 中文化 | 弹窗管理已使用 `_display` 后缀显示中文标签 | ✅ 完全复用 |
| Sealos 图片上传 | `banners.js` 使用 FormData + `getToken()` + Bearer Auth | ✅ 完全对齐 |

### 11.2 前端需要配合的改动（三次求证更新）

| 改动项 | 文件 | 工作量 | 说明 | 依赖 |
|--------|------|--------|------|------|
| 公告编辑表单去掉容错 fallback | `admin/src/modules/content/composables/announcements.js` 第 75 行 | 极低（改 1 行） | `ann.announcement_id \|\| ann.id` → `ann.announcement_id`。步骤 4 完成后 console API 统一返回 `announcement_id`，容错逻辑不再需要 | 步骤 4 |
| 轮播图复用弹窗的比例校验 | 轮播图管理 composable | 低 | 可直接复用 `banners.js` 的 `checkImageRatio()` 方法，提取为共享工具函数 | 无 |

### 11.3 Web 前端技术栈兼容性确认（三次求证）

| 维度 | 前端现有能力 | 与本次修复的兼容性 |
|------|------------|-------------------|
| API 请求层 | `admin/src/api/base.js` 使用 `request()` + `buildURL()` + Bearer Auth | ✅ 无需修改，字段名变更在响应处理层 |
| API 端点定义 | `admin/src/api/system/admin.js` 定义 `SYSTEM_ADMIN_ENDPOINTS.ANNOUNCEMENT_*` | ✅ 路径不变，仅响应字段名变更 |
| 状态管理 | Alpine.js `x-data` + composable 模式 | ✅ `announcements.js` 表单初始值已使用 `announcement_id`（第 26 行） |
| Vite 代理 | `vite.config.js` 配置 `/api → localhost:3000` | ✅ 无影响 |
| 构建工具 | Vite 6.4.1 | ✅ 无影响 |

---

## 十二、行业方案对比分析与决策

### 12.1 决策 5：API 主键字段命名 — 行业对比

#### A. 大厂 API 命名规范（阿里 / 腾讯 / 美团 / 字节跳动）

**核心原则**: 所有大厂的公开 API 均使用 `{实体名}_id` 模式，不使用泛化的 `id`。

| 公司 | API 示例 | 主键字段名 | 来源 |
|------|---------|-----------|------|
| **阿里（支付宝）** | 交易查询 API | `trade_no`、`out_trade_no` | 支付宝开放平台文档 |
| **阿里（淘宝）** | 商品 API | `num_iid`（商品ID）、`order_id` | 淘宝开放平台 |
| **腾讯（微信支付）** | 订单查询 | `transaction_id`、`out_trade_no` | 微信支付 API v3 |
| **腾讯（QQ 音乐）** | 歌曲/专辑 | `song_id`、`album_id`、`singer_id` | QQ 音乐开放平台 |
| **美团** | 团购/门店 | `deal_id`、`poi_id`、`coupon_id` | 美团开放平台 |
| **字节跳动** | 抖音开放平台 | `item_id`、`user_id`、`comment_id` | 抖音开放平台文档 |

**为什么不用 `id`**: 当 API 响应包含嵌套对象时（如订单包含商品、商品包含店铺），泛化 `id` 无法区分归属。例如 `{ id: 1, shop: { id: 2 } }` 远不如 `{ order_id: 1, shop: { shop_id: 2 } }` 清晰。

#### B. 游戏公司 API 命名（Steam / Riot / 米哈游）

| 公司 | 实体 | 主键字段名 | 特点 |
|------|------|-----------|------|
| **Steam (Valve)** | 物品定义 | `itemdefid` / `assetid` / `classid` | 小写拼接，极具辨识度 |
| **Riot Games** | 英雄/召唤师 | `championId` / `summonerId` / `matchId` | camelCase |
| **米哈游** | 角色/武器 | `character_id` / `weapon_id` / `artifact_id` | snake_case |
| **Roblox** | 物品/用户 | `assetId` / `userId` / `universeId` | camelCase |

**游戏行业共识**: 无一例外使用描述性主键名。游戏系统实体众多（角色/武器/道具/副本/任务/成就...），泛化 `id` 在第一周就会引发混乱。

#### C. SaaS / 小众二手平台

| 平台 | 主键命名 | 说明 |
|------|---------|------|
| **Stripe（支付 SaaS）** | `payment_intent_id`、`customer_id` | 最长可达 30+ 字符，但自文档化 |
| **Voucherify（优惠券 SaaS）** | `voucher_id`、`campaign_id`、`redemption_id` | 遵循 `{entity}_id` 标准 |
| **闲鱼** | `item_id`、`order_id` | 继承阿里体系 |
| **转转** | `product_id`、`order_id` | 继承 58 体系 |

#### D. 小公司 / 初创项目的典型做法

| 做法 | 阶段表现 | 长期代价 |
|------|---------|---------|
| 所有实体用 `id` | 初期开发快 | 嵌套响应时无法区分、前端需要维护实体映射、新人入职看代码看不懂 |
| 后端用 `xxx_id`，DataSanitizer 统一转成 `id` | 看似"简洁" | 管理 API 和公开 API 字段名不同，前端维护两套逻辑 |
| 全程用 `{entity}_id` | 初期多写几个字符 | **零额外维护成本**，代码自文档化 |

#### E. 本项目现状与对比

| 实体 | 模型主键 | 公开 API | 管理 API | 一致性 |
|------|---------|---------|---------|--------|
| 弹窗 | `popup_banner_id` | `popup_banner_id` | `popup_banner_id` | ✅ 完全一致 |
| 轮播图 | `carousel_item_id` | `carousel_item_id` | `carousel_item_id` | ✅ 完全一致 |
| **公告** | `system_announcement_id` | `id`（且当前为 undefined） | `system_announcement_id` | **🔴 三重不一致** |

**结论: 方案 A — 统一为 `announcement_id`**

| 维度 | 理由 |
|------|------|
| 行业对标 | 阿里/腾讯/美团/Steam/Stripe 全部使用 `{entity}_id`，无一例外 |
| 项目内一致性 | 弹窗 `popup_banner_id`、轮播 `carousel_item_id` 已遵循此模式 |
| 前端适配零成本 | Web 管理后台 `announcements.js` 已使用 `announcement_id`，无需改 |
| 未上线优势 | 一次性统一，不产生任何兼容负担 |
| 长期维护 | 代码自文档化，新人一看就懂 `announcement_id` 是什么 |

为什么不保留 `system_announcement_id`：前缀 `system_` 是表名的命名空间隔离（避免 MySQL 中 `announcements` 与其他表冲突），不应泄漏到 API 层。数据库列名和 API 字段名职责不同 — 阿里巴巴内部规范明确区分"存储模型"和"传输模型"。

---

### 12.2 决策 6：内容过期生命周期管理 — 行业对比

#### A. 大厂方案（阿里 / 美团 / 腾讯）

**核心理念**: **双保险架构** — 查询时间过滤（实时准确）+ 后台定时任务（数据卫生）

| 公司 | 机制 | 具体做法 |
|------|------|---------|
| **阿里（淘宝）** | 商品自动下架 | 促销活动到期 → 定时任务（每分钟）扫描 → 自动将商品状态改为"已下架"。**不依赖查询时过滤**，状态字段必须准确反映当前状态 |
| **美团** | 团购/优惠券过期 | 券到期 → 后台 Worker 定时扫描 → 状态改为 `expired`。管理后台看到的状态与用户端一致 |
| **腾讯（微信广告）** | 广告投放计划 | 投放期结束 → 系统自动将计划状态改为"已结束"。广告主后台直接看到终态 |
| **京东** | 促销活动 | 活动到期 → 定时任务修改状态 + 查询时二次过滤（双保险） |

**大厂共识**: `is_active` / `status` 字段必须准确反映**当前业务状态**，不允许出现"数据库说是活跃的、但实际上已过期"的矛盾状态。原因：
1. 管理后台运营人员看到"启用"以为还在展示，实际用户已看不到 → 误判运营效果
2. 数据分析/报表统计时，`is_active=1` 的记录数与实际展示记录数不一致
3. 审计日志和合规要求状态字段必须真实

#### B. 游戏公司方案（Steam / Riot / 米哈游）

| 公司 | 机制 | 说明 |
|------|------|------|
| **Steam** | 事件自动上下线 | 季节性促销（夏促/冬促）完全自动化，到期秒级切换 |
| **Riot Games** | 活动生命周期 | 英雄联盟活动到期 → 自动关闭入口 → 状态改为 `ended`。不存在"活跃但已过期"状态 |
| **米哈游** | 横幅/公告自动过期 | 游戏内公告到期自动从列表消失，后台同步标记为"已过期" |

#### C. 活动策划 / 营销 SaaS 平台

| 平台 | 机制 | 说明 |
|------|------|------|
| **Voucherify** | 优惠券自动过期 | 到期 → 状态自动变为 `expired` → webhook 通知商家。**不需要手动操作** |
| **HubSpot** | 营销邮件定时 | 发送完成 → 状态自动切换为 `sent`。生命周期完全自动化 |
| **Mailchimp** | 活动生命周期 | scheduled → sending → sent。到达时间点自动推进 |

#### D. 小公司 / 小众平台

| 做法 | 适用场景 | 长期风险 |
|------|---------|---------|
| 仅查询时过滤（本项目当前做法） | 数据量小、运营人员少 | is_active 与实际状态不一致，运营误判 |
| 手动处理 | 极少量内容 | 运营忘记手动下线，用户看到过期内容 |
| 定时任务自动管理 | 所有规模 | **零运营负担，状态始终一致** |

#### E. 本项目最佳方案

**推荐: 选项 B+C 组合 — 查询时过滤（已有）+ 定时任务自动清理（新增）**

| 层 | 机制 | 职责 |
|-----|------|------|
| 第一层：查询时 | `PopupBannerService.getActiveBanners()` 已有 `end_time > NOW()` 过滤 | 保证用户端**实时准确** |
| 第二层：定时任务 | node-cron 每小时扫描一次，将 `end_time < NOW() AND is_active = 1` 的记录改为 `is_active = 0` | 保证管理后台**状态一致** |

**为什么不选"仅手动处理"（选项 A）**: 美团有数千个团购同时在线，不可能手动下线每一个过期团购。你的项目当前只有 2 条弹窗，手动可以应付。但项目上线后弹窗数量会增长，手动管理不可持续。

**为什么不选"仅查询时过滤"（选项 B alone）**: 大厂经验证明，仅靠查询时过滤会导致数据层面的不一致。当运营人员在管理后台看到 Banner ID=15 显示"启用"但实际用户已看不到时，会产生困惑和误操作。

**可复用的后端现有能力**:
- 项目已有 `node-cron ^3.0.3` 依赖
- 项目已有 `services/` 层的定时任务模式（如广告系统的 cron 任务）
- `PopupBanner.isExpired()` 实例方法已实现
- `BeijingTimeHelper` 已提供标准化时间比较

**同时处理 Banner ID=15**: 定时任务第一次运行即会自动将 ID=15 的 `is_active` 改为 0，无需手动 SQL。

---

### 12.3 决策 7：图片资源尺寸校验策略 — 行业对比

#### A. 大厂方案（微信 / 阿里 / 美团）

| 公司 | 场景 | 校验策略 | 严格度 |
|------|------|---------|--------|
| **微信公众平台** | 公众号封面图 | **严格拒绝**：必须 2.35:1 比例，不符直接报错无法上传 | 🔴 强制 |
| **微信小程序** | 小程序封面图 | **严格拒绝**：必须 5:4 比例，像素最低要求 | 🔴 强制 |
| **阿里（淘宝）** | 主图 / 详情图 | **按类目强制**：不同商品类目有不同的尺寸要求，不达标影响搜索排名 | 🔴 强制 |
| **美团** | 团购头图 | **推荐但不强制**：有推荐尺寸，不符也能上传，但展示效果差 | 🟡 警告 |
| **京东** | 商品主图 | **强制**：800×800 最低要求，低于直接拒绝 | 🔴 强制 |

#### B. 游戏平台

| 平台 | 场景 | 校验策略 |
|------|------|---------|
| **Steam** | 商店页胶囊图 | **严格像素**：616×353（主胶囊）、460×215（小胶囊），偏差 1px 都拒绝 |
| **Apple App Store** | 应用截图 | **严格像素**：按设备型号必须精确像素，否则审核不通过 |
| **Google Play** | 应用图标 | **严格**：512×512，必须 PNG |
| **Epic Games Store** | 游戏封面 | **严格比例 + 最低分辨率** |

#### C. CMS / 营销平台

| 平台 | 校验策略 | 理由 |
|------|---------|------|
| **WordPress** | **不限制**，但提供裁切工具 | CMS 灵活性优先，运营有最终决定权 |
| **Shopify** | **推荐 + 警告**，不阻止 | 商家自主决定视觉效果 |
| **Voucherify** | **推荐尺寸**，不强制 | B2B SaaS，客户各有各的设计规范 |

#### D. 各方案对比总结

| 策略 | 代表 | 适合场景 | 优点 | 缺点 |
|------|------|---------|------|------|
| **强制拒绝** | 微信/Steam/AppStore | 平台面向海量开发者/商家，质量标准必须统一 | 展示效果一致 | 运营灵活性低 |
| **警告不阻止** | 美团/Shopify/WordPress | 内部运营工具，运营人员有审美判断力 | 灵活 | 可能上传不合适的图 |
| **无校验** | 部分小公司 | 快速 MVP | 零开发成本 | 展示效果不可控 |

#### E. 本项目最佳方案

**推荐: 前后端联合"警告 + 视觉提示"（弹窗管理已有，轮播图复用）**

| 层 | 机制 | 现状 |
|-----|------|------|
| 后端 sharp 校验 | 上传时检测图片实际宽高，存入 `image_width` / `image_height` | ✅ 已有 |
| 后端比例校验 | `validateImageRatio(displayMode, width, height)` → 返回 match/warning | ✅ 弹窗已有 |
| 前端选图校验 | `checkImageRatio()` → 显示黄色警告条 | ✅ 弹窗已有，轮播图缺失 |
| 前端提交确认 | 纯图模式二次 confirm 确认 | ✅ 弹窗已有 |

**为什么不选"强制拒绝"**: 你的项目是内部运营工具（管理员上传弹窗/轮播图），不是面向海量开发者的开放平台。运营人员有时需要灵活处理（比如临时用一张比例不完美但设计效果好的图）。美团和 Shopify 的做法更适合：**警告但不阻止，让运营人员做最终决策**。

**立即执行**: 管理员通过管理后台修正 ID=26 的 `display_mode` 或替换图片（数据清洗）。

**长期机制**: 轮播图管理页复用弹窗管理的 `checkImageRatio()` 前端校验。代码已存在于 `admin/src/modules/content/composables/banners.js`，提取为共享工具函数即可。

---

## 十三、最终决策结果与执行步骤

### 已确认决策汇总

| 决策项 | 最终方案 | 行业依据 | 影响范围 |
|--------|---------|---------|---------|
| **决策 5**: API 主键字段名 | **统一为 `announcement_id`** | 阿里/腾讯/美团/Steam 全部使用 `{entity}_id` 模式 | 后端 DataSanitizer + Service 层 + console 路由 + Web 前端（已适配）+ 小程序 |
| **决策 6**: 内容过期生命周期 | **查询时过滤（已有）+ 定时任务自动清理（新增）** | 阿里/美团/Riot 均采用双保险架构，状态字段必须准确 | 后端新增 cron 任务，复用现有 node-cron + `jobs/ad-cron-jobs.js` 模式 |
| **决策 7**: 图片比例校验 | **前后端联合"警告不阻止" + 立即修正当前脏数据** | 美团/Shopify 模式，内部运营工具保留灵活性 | Web 前端轮播图 composable 复用弹窗 `checkImageRatio()` |

### 三次求证新增：无需拍板的事项

以下事项在三次求证中确认为纯技术修复，不涉及方案选择：

| 事项 | 说明 |
|------|------|
| B3+B4 Service 层 SQL 列名修复 | `announcement_id` → `system_announcement_id`，无方案选择空间，直接修正 |
| B5 日志字段修复 | 同上，直接修正 |
| B6 JSDoc 注释修正 | 文档级修复，无争议 |
| W1 前端容错清理 | 后端统一后去掉 `|| ann.id`，符合"直接使用后端字段名"原则 |

### 三次求证新增：需关注但本次不拍板的长期议题

| 议题 | 说明 | 建议时机 |
|------|------|---------|
| DataSanitizer 全局主键命名一致性 | 当前 prizes/inventory/users/chat 使用泛化 `id`（安全考虑），popup_banners/carousel_items/announcements（修复后）使用 `{entity}_id`。长期存在两套模式。是否全局统一为 `{entity}_id`？涉及小程序前端全面改造 | 下一版本规划时评估 |

### 执行步骤

#### 步骤 1（P0）：修复 DataSanitizer 公告主键映射（B1）

**修改文件**：`services/DataSanitizer.js`

`sanitizeAnnouncements()` 中（第 578-607 行）：
- 第 580 行：`id: announcement.announcement_id` → `announcement_id: announcement.system_announcement_id`
- 第 543 行 JSDoc：`主键：announcement_id` → `主键：system_announcement_id`

**归属**：后端代码

#### 步骤 2（P0）：修复公告 `/home` 路由 view_count 自增（B2）

**修改文件**：`routes/v4/system/announcements.js`

第 108 行：`announcement.announcement_id` → `announcement.announcement_id`（步骤 1 修复后 DataSanitizer 输出字段名变为 `announcement_id`，此处引用自动正确）

**验证方式**：修复后调用 `GET /api/v4/system/announcements/home`，检查 `announcement_id` 字段为整数且 `view_count` 递增。

**归属**：后端代码

#### 步骤 3（P0）：修复 AnnouncementService SQL 列名错误（B3 + B4）

**修改文件**：`services/AnnouncementService.js`

- 第 247 行 `markAsReadBatch()`：`announcement_id` → `system_announcement_id`
- 第 340 行 `deactivateBatch()`：`announcement_id` → `system_announcement_id`

**归属**：后端代码

#### 步骤 4（P1）：管理后台 console 公告字段名统一 + 日志修复（B5）

**修改文件 1**：`services/AnnouncementService.js`

在 `getAnnouncements()` 方法中，`dataLevel='full'` 分支也将 `system_announcement_id` 映射为 `announcement_id`。方式：在第 113 行 `DataSanitizer.sanitizeAnnouncements()` 调用后，对 `dataLevel='full'` 的结果也做字段映射（遍历添加 `announcement_id` 字段）。

**修改文件 2**：`routes/v4/console/system/announcements.js`

第 68 行日志：`announcement_id: announcement.announcement_id` → `announcement_id: announcement.system_announcement_id`（或步骤 4 映射完成后直接使用 `announcement.announcement_id`）

**归属**：后端代码

#### 步骤 5（P1）：Web 管理后台前端公告字段名清理（W1）

**修改文件**：`admin/src/modules/content/composables/announcements.js`

第 75 行 `editAnnouncement()`：`ann.announcement_id || ann.id` → `ann.announcement_id`（去掉容错 fallback，步骤 4 完成后 console API 统一返回 `announcement_id`）

**归属**：Web 管理后台前端

#### 步骤 6（P1）：修复模型文件 JSDoc 注释（B6）

**修改文件**：`models/SystemAnnouncement.js`

第 21 行：`主键：announcement_id` → `主键：system_announcement_id`

**归属**：后端代码

#### 步骤 7（P2）：新增弹窗/轮播图过期自动清理定时任务

**修改位置**：新建 `jobs/content-cron-jobs.js`，参照现有 `jobs/ad-cron-jobs.js` 的模式

已有可复用基础设施：
- `node-cron ^3.0.3` 已在 `package.json` 中
- `jobs/ad-cron-jobs.js` 已有完整的 cron 任务模式（环境变量开关 + 日志 + 错误处理）
- `PopupBanner.isExpired()` 实例方法已实现
- `BeijingTimeHelper` 已提供标准化时间比较

任务逻辑（每小时执行一次）：
- 扫描 `popup_banners` 表：`end_time < NOW() AND is_active = 1` → 将 `is_active` 改为 0
- 扫描 `carousel_items` 表：同理
- 扫描 `system_announcements` 表：`expires_at < NOW() AND is_active = 1` → 将 `is_active` 改为 0
- 记录操作日志（利用现有 `logger` 结构化日志）

环境变量控制：`ENABLE_CONTENT_CRON_JOBS=true`（与广告系统 cron 保持一致模式）

Banner ID=15 将在定时任务首次运行时自动清理。

**归属**：后端代码

#### 步骤 8（P2）：修正 carousel_items ID=26 数据 + 轮播图比例校验复用

**运营操作**：管理员通过管理后台将 ID=26 的 `display_mode` 改为与实际图片比例匹配的模式（345×569 → 比例 0.61:1 → 应选 `tall` 或 `slim`），或重新上传正确比例的图片。

**前端改动**：从 `banners.js` 的 `checkImageRatio()` 提取为 `admin/src/utils/` 下的共享工具函数，轮播图管理 composable 直接调用。上传图片时显示比例匹配度警告。

**归属**：运营操作 + Web 管理后台前端

### 实施优先级总览

| 优先级 | 步骤 | 归属 | 修改文件数 | 阻塞关系 |
|--------|------|------|-----------|---------|
| **P0** | 步骤 1: DataSanitizer 主键映射（B1） | 后端 | 1 | 阻塞小程序端公告功能 |
| **P0** | 步骤 2: `/home` 路由 view_count（B2） | 后端 | 1 | 阻塞公告浏览统计 |
| **P0** | 步骤 3: Service 层 SQL 列名（B3+B4） | 后端 | 1 | 阻塞管理后台批量操作 |
| **P1** | 步骤 4: console 字段名统一 + 日志（B5） | 后端 | 2 | 阻塞 Web 管理后台编辑准确性 |
| **P1** | 步骤 5: Web 前端字段名清理（W1） | Web 前端 | 1 | 依赖步骤 4 完成 |
| **P1** | 步骤 6: 模型 JSDoc 注释（B6） | 后端 | 1 | 不阻塞功能，防止未来误导 |
| **P2** | 步骤 7: 过期自动清理 cron | 后端 | 1（新建） | 不阻塞，但上线前必须完成 |
| **P2** | 步骤 8: 轮播图数据修正 + 比例校验 | 运营 + Web 前端 | 1-2 | 不阻塞 |

---

## 十四、附录

### 附录 A：system_announcements 表完整结构（主键: `system_announcement_id`）

| 字段 | 类型 | 说明 |
|------|------|------|
| `system_announcement_id` | INT PK AUTO_INCREMENT | 主键 |
| `title` | VARCHAR(200) | 公告标题 |
| `content` | TEXT | 公告内容 |
| `type` | ENUM('system','activity','maintenance','notice') | 公告类型 |
| `priority` | ENUM('high','medium','low') | 优先级 |
| `target_groups` | JSON | 目标用户组（管理员可见） |
| `is_active` | TINYINT(1) | 是否激活 |
| `expires_at` | DATETIME | 过期时间 |
| `admin_id` | INT FK→users | 创建管理员 |
| `internal_notes` | TEXT | 内部备注（管理员可见） |
| `view_count` | INT | 查看次数 |
| `created_at` / `updated_at` | DATETIME | 时间戳 |

### 附录 B：popup_banners 表完整结构

| 字段 | 类型 | 说明 |
|------|------|------|
| `popup_banner_id` | INT PK AUTO_INCREMENT | 主键 |
| `title` | VARCHAR(100) | 弹窗标题（管理后台标识用） |
| `image_url` | VARCHAR(500) | 图片 object key（Sealos 对象存储） |
| `display_mode` | ENUM(6种) | 显示模式（必填，无默认值） |
| `image_width` / `image_height` | INT UNSIGNED | 原图尺寸（上传时 sharp 自动检测） |
| `link_url` | VARCHAR(500) | 点击跳转链接 |
| `link_type` | ENUM('none','page','miniprogram','webview') | 跳转类型 |
| `position` | VARCHAR(50) | 显示位置（home/profile） |
| `is_active` | TINYINT(1) | 是否启用 |
| `display_order` | INT | 管理后台列表排序（数字小排前） |
| `start_time` / `end_time` | DATETIME | 展示时间窗口 |
| `banner_type` | VARCHAR(20) | 弹窗类型（notice/event/promo） |
| `frequency_rule` | VARCHAR(30) | 频率规则（6种） |
| `frequency_value` | INT | 频率参数（配合 N 天 / N 次使用） |
| `force_show` | TINYINT(1) | 是否强制弹出 |
| `priority` | INT | 弹出竞争优先级（数字越大越优先） |
| `created_by` | INT FK→users | 创建人 |
| `created_at` / `updated_at` | DATETIME | 时间戳 |

### 附录 C：相关 API 路由汇总

| 用途 | 方法 | 路径 | 权限 |
|------|------|------|------|
| 小程序获取首页公告 | GET | `/api/v4/system/announcements/home` | Public |
| 小程序获取公告列表 | GET | `/api/v4/system/announcements` | Public |
| 小程序获取弹窗列表 | GET | `/api/v4/system/popup-banners?status=active` | Public |
| 小程序上报弹窗展示 | POST | `/api/v4/system/ad-events/popup-banners/show-log` | 需登录 |
| 管理后台创建公告 | POST | `/api/v4/console/system/announcements` | Admin |
| 管理后台更新公告 | PUT | `/api/v4/console/system/announcements/:id` | Admin |
| 管理后台删除公告 | DELETE | `/api/v4/console/system/announcements/:id` | Admin |
| 管理后台创建弹窗 | POST | `/api/v4/console/popup-banners` | Admin |
| 管理后台更新弹窗 | PUT | `/api/v4/console/popup-banners/:id` | Admin |
| 管理后台删除弹窗 | DELETE | `/api/v4/console/popup-banners/:id` | Admin |
| 管理后台切换弹窗状态 | PATCH | `/api/v4/console/popup-banners/:id/toggle` | Admin |
| 管理后台调整弹窗排序 | PATCH | `/api/v4/console/popup-banners/order` | Admin |
| 管理后台查看弹窗统计 | GET | `/api/v4/console/ad-campaigns/popup-banners/:id/show-stats` | Admin |
