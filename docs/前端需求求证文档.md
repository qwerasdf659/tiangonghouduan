# 微信小程序前端需求求证文档

> **核查日期**: 2026-02-18
> **核查方式**: 连接真实数据库 `restaurant_points_dev`（93张表）+ 读取后端实际路由/模型/服务源码
> **核查原则**: 以后端数据库项目为唯一权威，前端适配后端，不做反向兼容

---

## 问题分类总览

| 分类 | 问题数 | 说明 |
|---|---|---|
| 后端数据库项目问题 | 0 | ~~1~~ → 已全部修复（B-1 已实现） |
| Web管理后台前端问题 | 0 | 本文档不涉及 |
| 微信小程序前端问题 | 6 | ~~7~~ → F-6 的后端依赖已解决，剩余 6 个前端修正项 |

---

## 一、反馈详情接口求证结果

### 结论：后端已实现，前端存在多处字段不对齐

后端路由 `routes/v4/system/feedback.js` 第176行已实现：

```
GET /api/v4/system/feedback/:id
```

认证方式：`authenticateToken`（JWT Bearer Token）
权限控制：普通用户只能查看自己的反馈，`role_level >= 100` 的管理员可查看所有反馈

### 后端实际返回字段（以后端代码第200-233行为准）

| 字段名 | 类型 | 说明 |
|---|---|---|
| `feedback_id` | integer | 反馈ID（自增主键） |
| `category` | enum | `technical / feature / bug / complaint / suggestion / other`（6种） |
| `content` | text | 反馈内容（1-5000字符） |
| `attachments` | json | 附件URL数组，无附件时为 `[]` |
| `status` | enum | `pending / processing / replied / closed`（4种） |
| `priority` | enum | `high / medium / low` |
| `user_info` | object | `{ user_id, mobile, nickname }`（mobile非管理员显示为 `****`） |
| `reply_content` | text | 管理员回复内容（未回复时为 `null`） |
| `admin_info` | object/null | `{ admin_id, admin_name }`（未回复时为 `null`） |
| `created_at` | string | 北京时间格式：`2026年02月18日 14:00:00` |
| `replied_at` | string/null | 北京时间格式，未回复时为 `null` |
| `estimated_response_time` | string/null | `4小时内 / 24小时内 / 72小时内` |

### 后端统一响应包装格式

后端使用 `res.apiSuccess(data, message)` 统一包装，实际HTTP响应体结构为：

```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "获取反馈详情成功",
  "data": { ... },
  "timestamp": "...",
  "version": "v4",
  "request_id": "..."
}
```

### 微信小程序前端需修正的问题（3处）

**问题1：status枚举值错误**
- 前端写的：`pending | processing | resolved | closed`
- 后端实际：`pending | processing | replied | closed`
- 修正：将 `resolved` 改为 `replied`

**问题2：字段名错误**
- 前端写的：`reply`（回复内容字段）
- 后端实际：`reply_content`
- 修正：直接使用 `reply_content`，不做映射

**问题3：URL路径参数名不影响功能但需知悉**
- 前端文档写的路径：`GET /api/v4/system/feedback/:feedback_id`
- 后端实际路径：`GET /api/v4/system/feedback/:id`
- 说明：Express路由参数名仅影响后端 `req.params` 取值，前端实际请求 `/api/v4/system/feedback/123` 可正常匹配，无需修改

### 后端无需修改

此接口后端已完整实现，包含：
- JWT认证 + 用户权限校验
- 数据脱敏（通过 DataSanitizer 服务）
- 关联查询用户信息和管理员信息
- 标准错误响应（404 NOT_FOUND / 403 FORBIDDEN）

### 数据库真实数据验证

`feedbacks` 表当前有 **155** 条记录。最新3条：
- feedback_id=182, user_id=31, status=pending, reply_content=null
- feedback_id=173, user_id=31, status=pending, reply_content=null
- feedback_id=172, user_id=31, status=pending, reply_content=null

---

## 二、广告系统接口求证结果

### 2.1 文档中已明确、后端已实现的接口

以下接口在后端路由中已实现，对照后端源码逐一验证：

| 后端路由文件 | 接口 | 功能 | 状态 |
|---|---|---|---|
| `routes/v4/user/ad-campaigns.js` | `GET /api/v4/user/ad-campaigns` | 我的广告活动列表 | 已实现 |
| 同上 | `POST /api/v4/user/ad-campaigns` | 创建广告活动 | 已实现 |
| 同上 | `GET /api/v4/user/ad-campaigns/:id` | 广告活动详情 | 已实现 |
| 同上 | `PUT /api/v4/user/ad-campaigns/:id` | 更新草稿状态活动 | 已实现 |
| 同上 | `POST /api/v4/user/ad-campaigns/:id/submit` | 提交审核 | 已实现 |
| 同上 | `POST /api/v4/user/ad-campaigns/:id/cancel` | 取消活动 | 已实现 |
| 同上 | `GET /api/v4/user/ad-campaigns/:id/report` | 活动报表 | 已实现 |
| `routes/v4/system/ad-events.js` | `POST /api/v4/system/ad-events/impression` | 广告曝光上报 | 已实现 |
| 同上 | `POST /api/v4/system/ad-events/click` | 广告点击上报 | 已实现 |
| 同上 | `POST /api/v4/system/ad-events/popup-banners/show-log` | 弹窗展示上报 | 已实现 |
| 同上 | `POST /api/v4/system/ad-events/carousel-items/show-log` | 轮播展示上报 | 已实现 |

### 2.2 用户端广告位查询接口 —— ✅ 已实现

#### `GET /api/v4/user/ad-slots`

**修复日期**：2026-02-18
**实现文件**：`routes/v4/user/ad-slots.js`（新建），挂载于 `routes/v4/user/index.js`

**认证方式**：`authenticateToken`（JWT Bearer Token，普通用户可调用）

**请求参数**（均为可选 query 参数）：

| 参数 | 类型 | 说明 |
|---|---|---|
| `slot_type` | string | 广告位类型筛选，仅允许 `popup` / `carousel` |
| `position` | string | 页面位置筛选（如 `home` / `lottery` / `profile`） |

**响应数据**：

```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "获取可用广告位列表成功",
  "data": {
    "slots": [
      {
        "ad_slot_id": 12,
        "slot_key": "home_carousel",
        "slot_name": "首页轮播位",
        "slot_type": "carousel",
        "position": "home",
        "max_display_count": 3,
        "daily_price_diamond": 60,
        "min_bid_diamond": 50,
        "min_budget_diamond": 500,
        "is_active": true,
        "description": null,
        "created_at": "...",
        "updated_at": "..."
      }
    ],
    "total": 5
  },
  "timestamp": "...",
  "version": "v4.0",
  "request_id": "..."
}
```

**业务规则**：
- 仅返回 `is_active=true` 的广告位（当前5条，`profile_carousel` 因 `is_active=0` 被过滤）
- `slot_type` 参数传无效值返回 HTTP 400

**数据库 `ad_slots` 表真实数据**（6条记录，活跃5条）：

| ad_slot_id | slot_key | slot_name | slot_type | position | daily_price_diamond | min_bid_diamond | min_budget_diamond | is_active |
|---|---|---|---|---|---|---|---|---|
| 3 | lottery_popup | 抽奖页弹窗位 | popup | lottery | 80 | 50 | 500 | 1 |
| 4 | profile_popup | 个人中心弹窗位 | popup | profile | 50 | 50 | 500 | 1 |
| 7 | lottery_popup_ad | 抽奖页弹窗 | popup | lottery | 200 | 50 | 300 | 1 |
| 8 | profile_carousel | 个人中心轮播 | carousel | profile | 100 | 20 | 200 | 0 |
| 11 | home_popup | 首页弹窗位 | popup | home | 100 | 50 | 500 | 1 |
| 12 | home_carousel | 首页轮播位 | carousel | home | 60 | 50 | 500 | 1 |

### 2.3 微信小程序前端字段不对齐问题（4处）

**问题4：ad_creatives 表字段名错误**

前端 `typings/api.d.ts` 中使用了 `creative_type` 字段，但 `ad_creatives` 表实际无此列。

`ad_creatives` 表实际字段：

| 字段名 | 类型 | 说明 |
|---|---|---|
| `ad_creative_id` | int | 素材ID |
| `ad_campaign_id` | int | 关联活动ID |
| `title` | varchar(100) | 素材标题 |
| `image_url` | varchar(500) | 图片URL |
| `image_width` | int unsigned | 图片宽度 |
| `image_height` | int unsigned | 图片高度 |
| `link_url` | varchar(500) | 跳转链接 |
| `link_type` | varchar(20) | 跳转类型（默认 `none`） |
| `review_status` | varchar(20) | 审核状态（默认 `pending`） |
| `review_note` | varchar(500) | 审核备注 |
| `reviewed_by` | int | 审核人 |
| `reviewed_at` | datetime | 审核时间 |

修正：删除 `creative_type`，使用 `link_type` 和 `review_status` 等后端实际字段。

**问题5：popup_banners 表字段不完整**

前端文档列出13个字段，但 `popup_banners` 表实际有 **21** 列。前端遗漏的关键字段：

| 前端遗漏的字段 | 类型 | 业务含义 |
|---|---|---|
| `display_mode` | enum | `wide/horizontal/square/tall/slim/full_image`（6种显示模式） |
| `image_width` | int | 图片宽度（像素） |
| `image_height` | int | 图片高度（像素） |
| `banner_type` | varchar(20) | 横幅类型（默认 `promo`） |
| `frequency_rule` | varchar(30) | 频率规则（默认 `once_per_day`） |
| `frequency_value` | int | 频率值（默认 1） |
| `force_show` | tinyint(1) | 是否强制展示 |
| `priority` | int | 展示优先级 |

修正：前端类型定义需补齐以上字段，使用后端字段名，不做映射。

**问题6：carousel_items 表字段不完整**

前端文档列出9个字段，但 `carousel_items` 表实际有 **17** 列。前端遗漏的关键字段：

| 前端遗漏的字段 | 类型 | 业务含义 |
|---|---|---|
| `display_mode` | enum | `wide/horizontal/square`（3种显示模式） |
| `image_width` | int | 图片宽度（像素） |
| `image_height` | int | 图片高度（像素） |
| `slide_interval_ms` | int | 轮播间隔毫秒（默认 3000） |

修正：前端类型定义需补齐以上字段。

**问题7：ad_campaigns 表创建参数字段白名单**

后端 `routes/v4/user/ad-campaigns.js` 第83-93行定义了创建活动的字段白名单，前端需严格按此传参：

```
campaign_name, ad_slot_id, billing_mode, daily_bid_diamond,
budget_total_diamond, fixed_days, start_date, end_date, targeting_rules
```

注意：
- `billing_mode` 仅允许 `fixed_daily` 或 `bidding`（后端第80行白名单）
- `ad_slot_id` 由后端 `parseInt` 转为整数（第146行）
- `advertiser_user_id` 由后端从 JWT token 中取 `req.user.user_id` 自动填充（第138行），前端不应传此字段

### 2.4 ad_campaigns 表实际结构（以数据库为准）

| 字段名 | 类型 | 默认值 | 说明 |
|---|---|---|---|
| `ad_campaign_id` | int | 自增 | 活动ID |
| `business_id` | varchar(100) | - | 业务幂等ID |
| `advertiser_user_id` | int | - | 广告主用户ID |
| `ad_slot_id` | int | - | 广告位ID |
| `campaign_name` | varchar(100) | - | 活动名称 |
| `billing_mode` | varchar(20) | - | 计费模式 |
| `status` | varchar(20) | `draft` | 8态状态机 |
| `daily_bid_diamond` | int | null | 竞价日出价 |
| `budget_total_diamond` | int | null | 总预算 |
| `budget_spent_diamond` | int | `0` | 已消耗预算 |
| `fixed_days` | int | null | 固定天数 |
| `fixed_total_diamond` | int | null | 固定模式总费用 |
| `targeting_rules` | json | null | 定向规则 |
| `priority` | int | `50` | 竞价优先级 |
| `start_date` | date | null | 开始日期 |
| `end_date` | date | null | 结束日期 |
| `review_note` | varchar(500) | null | 审核备注 |
| `reviewed_by` | int | null | 审核人 |
| `reviewed_at` | datetime | null | 审核时间 |

数据库当前有 **2** 条广告活动记录，均为 `draft` 状态。

### 2.5 ad_report_daily_snapshots 表实际结构

| 字段名 | 类型 | 说明 |
|---|---|---|
| `snapshot_id` | bigint | 快照ID |
| `snapshot_date` | date | 快照日期 |
| `ad_campaign_id` | int | 活动ID |
| `ad_slot_id` | int | 广告位ID |
| `impressions_total` | int | 总曝光数 |
| `impressions_valid` | int | 有效曝光数 |
| `clicks_total` | int | 总点击数 |
| `clicks_valid` | int | 有效点击数 |
| `conversions` | int | 转化数 |
| `spend_diamond` | int | 消耗钻石 |

### 2.6 ad_billing_records 表实际结构

| 字段名 | 类型 | 说明 |
|---|---|---|
| `ad_billing_record_id` | bigint | 计费记录ID |
| `business_id` | varchar(100) | 业务幂等ID |
| `ad_campaign_id` | int | 活动ID |
| `advertiser_user_id` | int | 广告主用户ID |
| `billing_date` | date | 计费日期 |
| `amount_diamond` | int | 计费金额（钻石） |
| `billing_type` | varchar(20) | 计费类型 |
| `asset_transaction_id` | bigint | 资产交易关联ID |
| `remark` | varchar(200) | 备注 |

---

## 三、问题分类汇总

### 后端数据库项目问题（0个，已全部修复）

| 编号 | 问题 | 状态 | 修复说明 |
|---|---|---|---|
| B-1 | ~~缺少用户端广告位查询接口~~ | ✅ 已修复 | 新增 `GET /api/v4/user/ad-slots`，文件 `routes/v4/user/ad-slots.js`，支持 `slot_type` / `position` 筛选 |

### Web管理后台前端问题（0个）

本文档范围仅覆盖微信小程序前端，Web管理后台不在本次求证范围内。

### 微信小程序前端问题（7个）

| 编号 | 问题 | 涉及文件 | 修正方式 |
|---|---|---|---|
| F-1 | feedback status 枚举使用了 `resolved`，后端实际是 `replied` | 反馈详情页 | 将 `resolved` 替换为 `replied` |
| F-2 | feedback 回复字段名用了 `reply`，后端实际是 `reply_content` | 反馈详情页 | 直接使用 `reply_content` |
| F-3 | ad_creatives 类型定义使用了不存在的 `creative_type` 字段 | `typings/api.d.ts` | 删除 `creative_type`，使用 `link_type` + `review_status` |
| F-4 | popup_banners 类型定义缺少 8 个字段 | `typings/api.d.ts` | 补齐 `display_mode, image_width, image_height, banner_type, frequency_rule, frequency_value, force_show, priority` |
| F-5 | carousel_items 类型定义缺少 4 个字段 | `typings/api.d.ts` | 补齐 `display_mode, image_width, image_height, slide_interval_ms` |
| F-6 | ~~调用了不存在的接口~~ 后端已实现 `GET /api/v4/user/ad-slots` | `packageAd/ad-create/ad-create.ts` | 后端 B-1 已修复，直接对接即可（支持 `slot_type` / `position` 筛选） |
| F-7 | feedback 详情页临时方案（列表筛选）在记录超50条时可能漏数据 | `packageUser/feedback/detail.ts` | 后端已提供 `GET /api/v4/system/feedback/:id`，改为直接调用此接口 |

---

## 四、前端对接优先级

### P0（立即修正）

1. **F-7**：反馈详情页改为直接调用 `GET /api/v4/system/feedback/:id`，后端已实现
2. **F-1 + F-2**：修正 feedback 的字段名和枚举值，与后端数据库对齐

### P1（本迭代修正）

3. **F-3**：修正 ad_creatives 类型定义
4. **F-4 + F-5**：补齐 popup_banners 和 carousel_items 的类型定义

### P1（本迭代修正 - 续）

5. **F-6**：后端 B-1 已完成，直接调用 `GET /api/v4/user/ad-slots` 获取可选广告位列表

---

## 五、后端技术框架摘要（供前端对接参考）

| 项目 | 说明 |
|---|---|
| 运行时 | Node.js + Express |
| ORM | Sequelize（MySQL方言） |
| 数据库 | MySQL 93张表，Sealos云托管 |
| 认证 | JWT Bearer Token（`authenticateToken` 中间件） |
| 统一响应 | `ApiResponse.middleware()` 包装所有 `/api/` 路由 |
| 响应格式 | `{ success, code, message, data, timestamp, version, request_id }` |
| 时间格式 | 北京时间 `Asia/Shanghai`，通过 `BeijingTimeHelper` 统一处理 |
| 路由前缀 | 全部 `/api/v4/` |
| 服务架构 | ServiceManager 集中管理，路由层不直连 models |
| 分页参数 | 反馈用 `limit/offset`，广告用 `page/limit` |
| 用户端广告位 | `GET /api/v4/user/ad-slots`（已实现，支持 `slot_type` / `position` 筛选） |
