# æ¶æ„è®¾è®¡ - è¯»å†™æ“ä½œåˆ†å±‚ç­–ç•¥

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2026-01-31  
> **é€‚ç”¨èŒƒå›´**: åç«¯æ•°æ®åº“é¡¹ç›®  
> **é¡¹ç›®è§„æ¨¡**: 122è·¯ç”± / 128æœåŠ¡ / 72æ¨¡å‹ / ~57ä¸‡è¡Œä»£ç 

---

## ä¸ºä»€ä¹ˆè¦æ‰§è¡Œè¿™ä»½æ–‡æ¡£ï¼Ÿ

### ğŸ”´ å½“å‰å­˜åœ¨çš„é—®é¢˜

| é—®é¢˜ç±»å‹ | ç°çŠ¶ | é£é™©ç­‰çº§ |
|----------|------|----------|
| **å†™æ“ä½œåˆ†æ•£** | è·¯ç”±å±‚ç›´æ¥æ“ä½œ Modelï¼Œäº‹åŠ¡è¾¹ç•Œä¸æ¸… | ğŸ”´ é«˜ï¼ˆæ•°æ®ä¸ä¸€è‡´ï¼‰ |
| **çƒ­ç‚¹æŸ¥è¯¢æ— ç¼“å­˜** | é«˜é¢‘è¯»æ“ä½œç›´è¿æ•°æ®åº“ | ğŸŸ¡ ä¸­ï¼ˆæ€§èƒ½ç“¶é¢ˆï¼‰ |
| **ä¸šåŠ¡é€»è¾‘æ•£è½** | å¤æ‚æŸ¥è¯¢é€»è¾‘å†™åœ¨è·¯ç”±ä¸­ï¼Œæ— æ³•å¤ç”¨ | ğŸŸ¡ ä¸­ï¼ˆç»´æŠ¤å›°éš¾ï¼‰ |
| **æµ‹è¯•å›°éš¾** | ä¸šåŠ¡é€»è¾‘è€¦åˆåœ¨è·¯ç”±ï¼Œæ— æ³•å•å…ƒæµ‹è¯• | ğŸŸ¡ ä¸­ï¼ˆè´¨é‡é£é™©ï¼‰ |

### âš ï¸ ä¸æ‰§è¡Œçš„åæœ

```
åœºæ™¯1ï¼šå†™æ“ä½œæœªæ”¶å£
â”œâ”€â”€ è·¯ç”± A æ›´æ–°è®¢å•çŠ¶æ€
â”œâ”€â”€ è·¯ç”± B ä¹Ÿæ›´æ–°è®¢å•çŠ¶æ€ï¼ˆé€»è¾‘ä¸åŒï¼‰
â”œâ”€â”€ å®šæ—¶ä»»åŠ¡ C ä¹Ÿæ›´æ–°è®¢å•çŠ¶æ€ï¼ˆåˆä¸€å¥—é€»è¾‘ï¼‰
â””â”€â”€ ç»“æœï¼šåŒä¸€ä¸šåŠ¡ 3 å¥—ä»£ç ï¼Œæ”¹ä¸€å¤„æ¼ä¸¤å¤„ï¼Œæ•°æ®ä¸ä¸€è‡´

åœºæ™¯2ï¼šçƒ­ç‚¹æŸ¥è¯¢æ— ç¼“å­˜
â”œâ”€â”€ æ´»åŠ¨åˆ—è¡¨æ¥å£ï¼š1000 QPS
â”œâ”€â”€ æ¯æ¬¡è¯·æ±‚éƒ½æŸ¥æ•°æ®åº“
â”œâ”€â”€ MySQL è¿æ¥æ± è€—å°½
â””â”€â”€ ç»“æœï¼šç³»ç»Ÿå“åº”å˜æ…¢ï¼Œç”šè‡³å®•æœº

åœºæ™¯3ï¼šå¤æ‚æŸ¥è¯¢æ•£è½
â”œâ”€â”€ è·¯ç”±å±‚å†™äº† 70 è¡Œ ROI è®¡ç®—
â”œâ”€â”€ æŠ¥è¡¨ä¹Ÿéœ€è¦ ROI â†’ å¤åˆ¶ç²˜è´´
â”œâ”€â”€ å®šæ—¶ä»»åŠ¡ä¹Ÿéœ€è¦ â†’ å†å¤åˆ¶ä¸€ä»½
â””â”€â”€ ç»“æœï¼š3 ä»½ä»£ç ï¼Œæ”¹å…¬å¼è¦æ”¹ 3 å¤„ï¼Œå®¹æ˜“æ¼æ”¹
```

### âœ… æ‰§è¡Œåçš„æ”¶ç›Š

| æ”¶ç›Šç±»å‹ | æ”¹è¿›æ•ˆæœ | é‡åŒ–æŒ‡æ ‡ |
|----------|----------|----------|
| **æ•°æ®ä¸€è‡´æ€§** | å†™æ“ä½œç»Ÿä¸€å…¥å£ï¼Œäº‹åŠ¡å®‰å…¨ | æ•°æ®å¼‚å¸¸ â†“ 90% |
| **ç³»ç»Ÿæ€§èƒ½** | çƒ­ç‚¹è¯»èµ°ç¼“å­˜ï¼Œå‡å°‘ DB å‹åŠ› | å“åº”æ—¶é—´ 50ms â†’ 5ms |
| **ä»£ç è´¨é‡** | ä¸šåŠ¡é€»è¾‘å¯å¤ç”¨ã€å¯æµ‹è¯• | ä»£ç é‡å¤ â†“ 60% |
| **ç»´æŠ¤æ•ˆç‡** | æ”¹ä¸€å¤„ç”Ÿæ•ˆå…¨å±€ | å˜æ›´è€—æ—¶ â†“ 50% |

### ğŸ“‹ æ‰§è¡Œä¼˜å…ˆçº§

```
P0ï¼ˆå¿…é¡»ç«‹å³æ‰§è¡Œï¼‰ï¼šå†™æ“ä½œ 100% æ”¶å£åˆ° Service + äº‹åŠ¡
P1ï¼ˆæ€§èƒ½ä¼˜åŒ–æ—¶æ‰§è¡Œï¼‰ï¼šçƒ­ç‚¹è¯»æ“ä½œæ”¶å£ + Redis ç¼“å­˜
P2ï¼ˆæœ‰ä½™åŠ›æ—¶æ‰§è¡Œï¼‰ï¼šå¤æ‚æŸ¥è¯¢æ”¶å£åˆ° QueryService
P3ï¼ˆä¸æ¨èï¼‰ï¼šç®€å•è¯»æ“ä½œæ”¶å£ï¼ˆè¿‡åº¦è®¾è®¡ï¼ŒROI ä½ï¼‰
```

---

## 1. æ¦‚è¿°

æœ¬æ–‡æ¡£å®šä¹‰äº†é¡¹ç›®ä¸­**è¯»æ“ä½œ**å’Œ**å†™æ“ä½œ**çš„åˆ†å±‚ç­–ç•¥ï¼Œæ˜ç¡®å“ªäº›æ“ä½œéœ€è¦æ”¶å£åˆ° Service å±‚ï¼Œå“ªäº›å¯ä»¥åœ¨è·¯ç”±å±‚ç›´æ¥è®¿é—® Modelã€‚

### 1.1 æ ¸å¿ƒåŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åˆ†å±‚ç­–ç•¥æ€»è§ˆ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  å†™æ“ä½œï¼ˆå¼ºåˆ¶ï¼‰ï¼š                                            â”‚
â”‚  â””â”€â”€ 100% æ”¶å£åˆ° Service + Transaction                      â”‚
â”‚                                                             â”‚
â”‚  è¯»æ“ä½œï¼ˆåˆ†çº§ï¼‰ï¼š                                            â”‚
â”‚  â”œâ”€â”€ ç®€å•æŸ¥è¯¢ â†’ è·¯ç”±ç›´è¿ Modelï¼ˆå…è®¸ï¼‰                       â”‚
â”‚  â”œâ”€â”€ çƒ­ç‚¹æŸ¥è¯¢ â†’ Service + Redis ç¼“å­˜ï¼ˆæ¨èï¼‰                 â”‚
â”‚  â””â”€â”€ å¤æ‚æŸ¥è¯¢ â†’ QueryService å°è£…ï¼ˆæ¨èï¼‰                    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 è®¾è®¡ç†å¿µ

**"æ”¶å£çš„ä»·å€¼ = å¤ç”¨ä»·å€¼ + ç¼“å­˜ä»·å€¼ + å¯ç»´æŠ¤æ€§"**

- ç®€å•æŸ¥è¯¢å°è£…ä»·å€¼ä¸º 0ï¼Œä¸å¼ºåˆ¶æ”¶å£
- çƒ­ç‚¹è¯»æ“ä½œæœ‰ç¼“å­˜ä»·å€¼ï¼Œå»ºè®®æ”¶å£
- å¤æ‚ç»Ÿè®¡æŸ¥è¯¢æœ‰å¤ç”¨å’Œç»´æŠ¤ä»·å€¼ï¼Œå»ºè®®æ”¶å£

---

## 2. è¡Œä¸šå®è·µå¯¹æ¯”

### 2.1 ä¸åŒå…¬å¸æ¶æ„è®¾è®¡æ–¹æ¡ˆ

| å…¬å¸ç±»å‹ | è¯»æ“ä½œè®¾è®¡ | å†™æ“ä½œè®¾è®¡ | æ ¸å¿ƒç†å¿µ | é€‚ç”¨è§„æ¨¡ |
|----------|-----------|-----------|---------|---------|
| **é˜¿é‡Œå·´å·´/èš‚èš** | Repository + Service åŒå±‚ | Service + Domain Event | DDDé¢†åŸŸé©±åŠ¨ | è¶…å¤§å‹ï¼ˆåƒä¸‡çº§ï¼‰ |
| **è…¾è®¯æ¸¸æˆ** | Service ç»Ÿä¸€å°è£… | Service + äº‹åŠ¡è„šæœ¬ | é«˜å¹¶å‘ä¼˜å…ˆ | å¤§å‹ï¼ˆç™¾ä¸‡çº§ï¼‰ |
| **ç¾å›¢** | Query Service + Command Service (CQRS) | Command Service + Saga | è¯»å†™åˆ†ç¦» | å¤§å‹ï¼ˆç™¾ä¸‡çº§ï¼‰ |
| **å­—èŠ‚è·³åŠ¨** | è½»é‡ Service è–„å°è£… | Service + å¹‚ç­‰æ§åˆ¶ | æ•æ·è¿­ä»£ | ä¸­å¤§å‹ |
| **ä¸­å°æ¸¸æˆå…¬å¸** | è·¯ç”±ç›´è¿ + çƒ­ç‚¹ Service | Service ç»Ÿä¸€å°è£… | å®ç”¨ä¸»ä¹‰ | ä¸­å‹ |
| **å°ä¼—äºŒæ‰‹å¹³å°** | è·¯ç”±ç›´è¿ models | Service å°è£…å…³é”®æ“ä½œ | å¿«é€Ÿä¸Šçº¿ | å°å‹ |

### 2.2 æ–¹æ¡ˆè¯¦ç»†è¯´æ˜

#### æ–¹æ¡ˆ Aï¼šé˜¿é‡Œå·´å·´æ¨¡å¼ï¼ˆDDD åˆ†å±‚ï¼‰

```
Controller â†’ ApplicationService â†’ DomainService â†’ Repository â†’ Model
```

- **ç‰¹ç‚¹**ï¼šè¯»/å†™éƒ½ç»è¿‡ Repositoryï¼Œå¼ºè¾¹ç•Œéš”ç¦»
- **ä¼˜ç‚¹**ï¼šè¾¹ç•Œæ¸…æ™°ã€å¯æµ‹è¯•æ€§å¼ºã€é€‚åˆå¤æ‚ä¸šåŠ¡
- **ç¼ºç‚¹**ï¼šå¼€å‘æˆæœ¬é«˜ã€è¿‡åº¦è®¾è®¡é£é™©ã€å°å›¢é˜Ÿéš¾é©¾é©­
- **é€‚ç”¨**ï¼šé‡‘èçº§ç³»ç»Ÿã€éœ€è¦ä¸¥æ ¼å®¡è®¡çš„åœºæ™¯

#### æ–¹æ¡ˆ Bï¼šè…¾è®¯æ¸¸æˆæ¨¡å¼ï¼ˆService ç»Ÿä¸€å°è£…ï¼‰

```
Route â†’ Service â†’ Modelï¼ˆè¯»å†™éƒ½ç»è¿‡ Serviceï¼‰
```

- **ç‰¹ç‚¹**ï¼šç»Ÿä¸€å…¥å£ï¼Œè–„å°è£…
- **ä¼˜ç‚¹**ï¼šä¾¿äºåŠ ç¼“å­˜/æ—¥å¿—ã€å›¢é˜Ÿåä½œæ¸…æ™°
- **ç¼ºç‚¹**ï¼šService å®¹æ˜“è†¨èƒ€ã€ç®€å•æŸ¥è¯¢ä¹Ÿè¦èµ° Service
- **é€‚ç”¨**ï¼šæ¸¸æˆåç«¯ã€é«˜å¹¶å‘åœºæ™¯ã€éœ€è¦ç»Ÿä¸€ç¼“å­˜ç­–ç•¥

#### æ–¹æ¡ˆ Cï¼šç¾å›¢æ¨¡å¼ï¼ˆCQRS è¯»å†™åˆ†ç¦»ï¼‰

```
è¯»è·¯å¾„ï¼šRoute â†’ QueryService â†’ ReadModelï¼ˆç¼“å­˜/ES/åªè¯»åº“ï¼‰
å†™è·¯å¾„ï¼šRoute â†’ CommandService â†’ Model â†’ Event
```

- **ç‰¹ç‚¹**ï¼šè¯»å†™å®Œå…¨åˆ†ç¦»ï¼Œç‹¬ç«‹ä¼˜åŒ–
- **ä¼˜ç‚¹**ï¼šè¯»å¯ä»¥ç”¨ ES/ç¼“å­˜ã€å†™å¯ä»¥å¤æ‚äº‹åŠ¡
- **ç¼ºç‚¹**ï¼šä¸€è‡´æ€§å¤æ‚ã€éœ€è¦äº‹ä»¶æ€»çº¿ã€è¿ç»´æˆæœ¬é«˜
- **é€‚ç”¨**ï¼šè¯»å¤šå†™å°‘ã€éœ€è¦æœç´¢/æŠ¥è¡¨ã€æ•°æ®æœ€ç»ˆä¸€è‡´å¯æ¥å—

#### æ–¹æ¡ˆ Dï¼šå­—èŠ‚è·³åŠ¨æ¨¡å¼ï¼ˆæ•æ·å®ç”¨ï¼‰â­ æ¨è

```
Route â†’ Serviceï¼ˆé€‰æ‹©æ€§å°è£…ï¼‰â†’ Model
```

- **ç‰¹ç‚¹**ï¼šçƒ­ç‚¹æ“ä½œå°è£…ï¼Œç®€å•æŸ¥è¯¢ç›´è¿
- **ä¼˜ç‚¹**ï¼šçµæ´»ã€è¿­ä»£å¿«ã€ä¸è¿‡åº¦è®¾è®¡
- **ç¼ºç‚¹**ï¼šè¾¹ç•Œæ¨¡ç³Šã€å›¢é˜Ÿéœ€è¦å…±è¯†
- **é€‚ç”¨**ï¼šå¿«é€Ÿè¿­ä»£äº§å“ã€ä¸­å‹å›¢é˜Ÿ

### 2.3 æœ¬é¡¹ç›®é€‰æ‹©

**é‡‡ç”¨æ–¹æ¡ˆ Dï¼ˆå­—èŠ‚è·³åŠ¨æ¨¡å¼ï¼‰+ æ¸è¿›å¼æ”¶å£**

ç†ç”±ï¼š
1. é¡¹ç›®è§„æ¨¡ä¸ºä¸­å‹å•ä½“ï¼Œä¸éœ€è¦ DDD å¤æ‚åˆ†å±‚
2. å›¢é˜Ÿè§„æ¨¡å°ï¼Œéœ€è¦æ•æ·è¿­ä»£
3. ä¸šåŠ¡å¤æ‚åº¦ä¸­ç­‰ï¼Œä¸éœ€è¦ CQRS
4. å·²æœ‰å®Œæ•´ä¸šåŠ¡ä»£ç ï¼Œå¢é‡æ”¹è¿›ä¼˜äºå…¨é‡é‡æ„

---

## 3. è¯»æ“ä½œåˆ†çº§ç­–ç•¥

### 3.1 æ”¶å£å†³ç­–çŸ©é˜µ

| æŸ¥è¯¢ç±»å‹ | æ˜¯å¦æ”¶å£ | åŸå›  | ç¤ºä¾‹ |
|----------|---------|------|------|
| `findByPk(id)` | âŒ ä¸éœ€è¦ | å¤ªç®€å•ï¼Œå°è£…æ— ä»·å€¼ | ç”¨æˆ·è¯¦æƒ… |
| `findAll({ where: { status } })` | âŒ ä¸éœ€è¦ | ç®€å•æ¡ä»¶ï¼Œå°è£…æ— ä»·å€¼ | çŠ¶æ€ç­›é€‰ |
| **é«˜é¢‘è®¿é—®åˆ—è¡¨** | âœ… éœ€è¦ | å¯åŠ ç¼“å­˜ï¼Œå‡å°‘ DB å‹åŠ› | æ´»åŠ¨åˆ—è¡¨ |
| **å¤æ‚èšåˆæŸ¥è¯¢** | âœ… éœ€è¦ | é€»è¾‘å¤ç”¨ã€å¯æµ‹è¯•ã€å¯ç¼“å­˜ | ROI æŠ¥è¡¨ |
| **å¤šè¡¨å…³è”æŸ¥è¯¢** | âœ… éœ€è¦ | é€»è¾‘å¤æ‚ã€éœ€è¦ç»Ÿä¸€ç»´æŠ¤ | è®¢å•è¯¦æƒ… |
| **å¸¦æƒé™è¿‡æ»¤çš„æŸ¥è¯¢** | âœ… éœ€è¦ | æƒé™é€»è¾‘ç»Ÿä¸€ã€å®‰å…¨æ€§ | å•†æˆ·æ•°æ® |

### 3.2 çƒ­ç‚¹è¯»æ“ä½œç¤ºä¾‹

**åœºæ™¯**ï¼šæŠ½å¥–æ´»åŠ¨åˆ—è¡¨ï¼ˆæ¯ç§’ 1000 æ¬¡è®¿é—®ï¼‰

#### è·¯ç”±ç›´è¿ Modelï¼ˆä¸æ¨èï¼‰

```javascript
// routes/v4/lottery/campaigns.js
router.get('/list', async (req, res) => {
  // æ¯æ¬¡è¯·æ±‚éƒ½æŸ¥æ•°æ®åº“ â†’ 1000 QPS = 1000 æ¬¡ DB æŸ¥è¯¢
  const campaigns = await LotteryCampaign.findAll({
    where: { status: 'active' }
  })
  return res.apiSuccess(campaigns)
})
```

**é—®é¢˜**ï¼š
- æ•°æ®åº“å‹åŠ›å¤§ï¼ˆ1000 QPS ç›´æ¥æ‰“åˆ° MySQLï¼‰
- å“åº”æ…¢ï¼ˆæ¯æ¬¡ 50-100msï¼‰
- æ— æ³•æ¨ªå‘æ‰©å±•

#### æ”¶å£åˆ° Service + Redis ç¼“å­˜ï¼ˆæ¨èï¼‰

```javascript
// services/LotteryCampaignQueryService.js
class LotteryCampaignQueryService {
  /**
   * è·å–æ´»è·ƒçš„æŠ½å¥–æ´»åŠ¨åˆ—è¡¨ï¼ˆå¸¦ç¼“å­˜ï¼‰
   * @returns {Promise<Array>} æ´»åŠ¨åˆ—è¡¨
   */
  static async getActiveCampaigns() {
    const cacheKey = 'lottery:campaigns:active'
    
    // 1. å…ˆæŸ¥ Redisï¼ˆ1msï¼‰
    const cached = await redis.get(cacheKey)
    if (cached) {
      return JSON.parse(cached)
    }
    
    // 2. ç¼“å­˜æœªå‘½ä¸­æ‰æŸ¥ DB
    const campaigns = await LotteryCampaign.findAll({
      where: { status: 'active' }
    })
    
    // 3. å†™å…¥ç¼“å­˜ï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰
    await redis.setex(cacheKey, 300, JSON.stringify(campaigns))
    
    return campaigns
  }
}

// routes/v4/lottery/campaigns.js
router.get('/list', async (req, res) => {
  // 1000 QPS â†’ 99% å‘½ä¸­ç¼“å­˜ â†’ åªæœ‰ 1 æ¬¡ DB æŸ¥è¯¢
  const campaigns = await LotteryCampaignQueryService.getActiveCampaigns()
  return res.apiSuccess(campaigns)
})
```

**æ”¶ç›Šå¯¹æ¯”**ï¼š

| æŒ‡æ ‡ | ç›´è¿ Model | Service + ç¼“å­˜ |
|------|-----------|---------------|
| DB å‹åŠ› | 1000 QPS | ~1 QPS |
| å“åº”æ—¶é—´ | 50-100ms | 1-5ms |
| æ‰©å±•æ€§ | å·® | å¥½ |

### 3.3 å¤æ‚ç»Ÿè®¡æŸ¥è¯¢ç¤ºä¾‹

**åœºæ™¯**ï¼šæ´»åŠ¨ ROI è®¡ç®—ã€æŠ¥è¡¨ç»Ÿè®¡

#### è·¯ç”±ç›´å†™å¤æ‚æŸ¥è¯¢ï¼ˆä¸æ¨èï¼‰

```javascript
// routes/v4/console/lottery-campaigns.js
router.get('/:id/stats', async (req, res) => {
  const { id } = req.params
  
  // 70 è¡Œå¤æ‚æŸ¥è¯¢é€»è¾‘æ•£è½åœ¨è·¯ç”±ä¸­
  const totalDraws = await LotteryRecord.count({ where: { campaign_id: id } })
  const totalWins = await LotteryRecord.count({ where: { campaign_id: id, is_win: true } })
  const totalCost = await LotteryRecord.sum('cost', { where: { campaign_id: id } })
  const prizeValue = await LotteryPrize.sum('value', { where: { campaign_id: id } })
  
  const roi = prizeValue / totalCost
  
  // æ›´å¤šå¤æ‚è®¡ç®—...
  return res.apiSuccess({ totalDraws, totalWins, roi })
})
```

**é—®é¢˜**ï¼š
1. **ä»£ç é‡å¤**ï¼šå…¶ä»–åœ°æ–¹éœ€è¦ ROI è®¡ç®—æ—¶ï¼Œè¦å¤åˆ¶ç²˜è´´
2. **éš¾ä»¥æµ‹è¯•**ï¼š70 è¡Œä¸šåŠ¡é€»è¾‘åµŒåœ¨è·¯ç”±é‡Œï¼Œæ— æ³•å•å…ƒæµ‹è¯•
3. **éš¾ä»¥ç»´æŠ¤**ï¼šROI è®¡ç®—å…¬å¼æ”¹äº†ï¼Œè¦æ‰¾æ‰€æœ‰è·¯ç”±ä¿®æ”¹
4. **æ— æ³•å¤ç”¨**ï¼šå®šæ—¶ä»»åŠ¡ã€æŠ¥è¡¨å¯¼å‡ºä¹Ÿéœ€è¦è¿™ä¸ªé€»è¾‘

#### æ”¶å£åˆ° QueryServiceï¼ˆæ¨èï¼‰

```javascript
// services/LotteryAnalyticsQueryService.js
class LotteryAnalyticsQueryService {
  /**
   * è®¡ç®—æ´»åŠ¨ ROIï¼ˆæŠ•å…¥äº§å‡ºæ¯”ï¼‰
   * @param {number} campaign_id - æ´»åŠ¨ID
   * @returns {Object} ROI æ•°æ®
   */
  static async calculateCampaignROI(campaign_id) {
    const totalCost = await LotteryRecord.sum('cost', { where: { campaign_id } })
    const prizeValue = await LotteryPrize.sum('value', { where: { campaign_id } })
    
    return {
      total_cost: totalCost,
      prize_value: prizeValue,
      roi: totalCost > 0 ? (prizeValue / totalCost).toFixed(4) : 0
    }
  }
  
  /**
   * è®¡ç®—å¤è´­ç‡
   * @param {number} campaign_id - æ´»åŠ¨ID
   * @returns {Object} å¤è´­ç‡æ•°æ®
   */
  static async calculateRepeatRate(campaign_id) {
    // å¤æ‚é€»è¾‘å°è£…åœ¨è¿™é‡Œ
  }
  
  /**
   * è·å–å®Œæ•´æ´»åŠ¨ç»Ÿè®¡ï¼ˆç»„åˆå¤šä¸ªå­æŸ¥è¯¢ï¼‰
   * @param {number} campaign_id - æ´»åŠ¨ID
   * @returns {Object} å®Œæ•´ç»Ÿè®¡æ•°æ®
   */
  static async getCampaignFullStats(campaign_id) {
    const [roi, repeatRate, drawStats] = await Promise.all([
      this.calculateCampaignROI(campaign_id),
      this.calculateRepeatRate(campaign_id),
      this.getDrawStats(campaign_id)
    ])
    return { roi, repeatRate, drawStats }
  }
}

// routes/v4/console/lottery-campaigns.js
router.get('/:id/stats', async (req, res) => {
  // è·¯ç”±åªåšå‚æ•°å¤„ç†å’Œå“åº”
  const stats = await LotteryAnalyticsQueryService.getCampaignFullStats(req.params.id)
  return res.apiSuccess(stats)
})

// å®šæ—¶ä»»åŠ¡ä¹Ÿå¯ä»¥å¤ç”¨
// cron/daily-report.js
const stats = await LotteryAnalyticsQueryService.getCampaignFullStats(campaignId)
```

**æ”¶ç›Šå¯¹æ¯”**ï¼š

| æŒ‡æ ‡ | è·¯ç”±ç›´å†™ | QueryService |
|------|---------|--------------|
| ä»£ç å¤ç”¨ | âŒ å¤åˆ¶ç²˜è´´ | âœ… ç»Ÿä¸€è°ƒç”¨ |
| å¯æµ‹è¯•æ€§ | âŒ æ— æ³•å•æµ‹ | âœ… å¯å•å…ƒæµ‹è¯• |
| å¯ç»´æŠ¤æ€§ | âŒ åˆ†æ•£å„å¤„ | âœ… é›†ä¸­ç®¡ç† |
| ç¼“å­˜ç­–ç•¥ | âŒ æ— æ³•åŠ  | âœ… ç»Ÿä¸€åŠ ç¼“å­˜ |

---

## 4. å†™æ“ä½œç­–ç•¥ï¼ˆå·²å®æ–½ï¼‰

### 4.1 å¼ºåˆ¶è§„åˆ™

**æ‰€æœ‰å†™æ“ä½œå¿…é¡»æ”¶å£åˆ° Service å±‚**ï¼Œé€šè¿‡ `options.transaction` ä¼ é€’äº‹åŠ¡ã€‚

```javascript
// âœ… æ­£ç¡®ï¼šè·¯ç”±ç®¡ç†äº‹åŠ¡è¾¹ç•Œï¼ŒService æ‰§è¡Œä¸šåŠ¡é€»è¾‘
router.post('/orders/:id/fulfill', async (req, res) => {
  const transaction = await sequelize.transaction()
  try {
    const result = await RedemptionService.adminFulfillOrderById(
      req.params.id,
      { transaction, admin_user_id: req.user.user_id }
    )
    await transaction.commit()
    return res.apiSuccess(result)
  } catch (error) {
    await transaction.rollback()
    throw error
  }
})

// âŒ é”™è¯¯ï¼šè·¯ç”±ç›´æ¥æ“ä½œ Model
router.post('/orders/:id/fulfill', async (req, res) => {
  const order = await RedemptionOrder.findByPk(req.params.id)
  await order.update({ status: 'fulfilled' })  // ç›´æ¥æ“ä½œ Model
  return res.apiSuccess(order)
})
```

### 4.2 å·²æ”¶å£çš„å†™æ“ä½œ

| æ–‡ä»¶ | æ“ä½œ | æ”¶å£åˆ°çš„ Service |
|------|------|-----------------|
| `business-records.js` | æ ¸é”€è®¢å• | `RedemptionService.adminFulfillOrderById` |
| `business-records.js` | å–æ¶ˆè®¢å• | `RedemptionService.adminCancelOrderById` |
| `business-records.js` | æ‰¹é‡è¿‡æœŸ | `RedemptionService.adminBatchExpireOrders` |
| `sessions.js` | å¤±æ•ˆä¼šè¯ | `SessionManagementService.deactivateSession` |
| `sessions.js` | å¤±æ•ˆç”¨æˆ·ä¼šè¯ | `SessionManagementService.deactivateUserSessions` |
| `sessions.js` | æ¸…ç†è¿‡æœŸä¼šè¯ | `SessionManagementService.cleanupExpiredSessions` |
| `system-data.js` | åˆ›å»ºæ´»åŠ¨ | `LotteryCampaignCRUDService.createCampaign` |
| `system-data.js` | æ›´æ–°æ´»åŠ¨ | `LotteryCampaignCRUDService.updateCampaign` |
| `system-data.js` | æ›´æ–°æ´»åŠ¨çŠ¶æ€ | `LotteryCampaignCRUDService.updateCampaignStatus` |
| `system-data.js` | åˆ é™¤æ´»åŠ¨ | `LotteryCampaignCRUDService.deleteCampaign` |

---

## 5. æ¸è¿›å¼æ”¶å£è·¯çº¿å›¾

| é˜¶æ®µ | ç›®æ ‡ | ä¼˜å…ˆçº§ | çŠ¶æ€ | æ”¶ç›Š |
|------|------|--------|------|------|
| **Phase 1** | å†™æ“ä½œ 100% æ”¶å£åˆ° Service | ğŸ”´ P0 | âœ… å·²å®Œæˆ | äº‹åŠ¡å®‰å…¨ã€å®¡è®¡æ—¥å¿— |
| **Phase 2** | çƒ­ç‚¹è¯»æ“ä½œæ”¶å£ï¼ˆå¸¦ç¼“å­˜ï¼‰ | ğŸŸ¡ P1 | â³ å¾…å®æ–½ | æ€§èƒ½æå‡ã€ç»Ÿä¸€ç¼“å­˜ |
| **Phase 3** | å¤æ‚æŸ¥è¯¢æ”¶å£ï¼ˆæŠ¥è¡¨/ç»Ÿè®¡ï¼‰ | ğŸŸ¢ P2 | â³ å¾…å®æ–½ | ä»£ç å¤ç”¨ã€å¯æµ‹è¯•æ€§ |
| **Phase 4** | å…¨éƒ¨è¯»æ“ä½œæ”¶å£ | âšª P3 | âŒ ä¸æ¨è | è¿‡åº¦è®¾è®¡ã€ROIä½ |

### 5.1 Phase 2 å€™é€‰çƒ­ç‚¹è¯»æ“ä½œ

| è·¯ç”± | è®¿é—®é¢‘ç‡ | ç¼“å­˜ç­–ç•¥ | ä¼˜å…ˆçº§ |
|------|---------|---------|--------|
| `GET /api/v4/lottery/campaigns/active` | é«˜é¢‘ | Redis 5åˆ†é’Ÿ | P1 |
| `GET /api/v4/marketplace/items` | é«˜é¢‘ | Redis 2åˆ†é’Ÿ | P1 |
| `GET /api/v4/stores/list` | ä¸­é¢‘ | Redis 10åˆ†é’Ÿ | P2 |

### 5.2 Phase 3 å€™é€‰å¤æ‚æŸ¥è¯¢

| è·¯ç”± | æŸ¥è¯¢å¤æ‚åº¦ | å¤ç”¨åœºæ™¯ | ä¼˜å…ˆçº§ |
|------|-----------|---------|--------|
| `GET /api/v4/console/lottery-campaigns/:id/stats` | é«˜ | æŠ¥è¡¨ã€å®šæ—¶ä»»åŠ¡ | P1 |
| `GET /api/v4/console/dashboard/overview` | é«˜ | ç®¡ç†åå°ã€æŠ¥è¡¨ | P1 |
| `GET /api/v4/console/analytics/roi` | é«˜ | è¿è¥æŠ¥è¡¨ | P2 |

---

## 6. é™„å½•

### 6.1 ç›¸å…³æœåŠ¡æ–‡ä»¶

```
services/
â”œâ”€â”€ RedemptionService.js          # æ ¸é”€è®¢å•æœåŠ¡ï¼ˆå·²æ‰©å±•ç®¡ç†å‘˜æ–¹æ³•ï¼‰
â”œâ”€â”€ SessionManagementService.js   # ä¼šè¯ç®¡ç†æœåŠ¡ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ admin-lottery/
â”‚   â”œâ”€â”€ index.js                  # å…¥å£
â”‚   â”œâ”€â”€ CoreService.js            # æ ¸å¿ƒå¹²é¢„
â”‚   â”œâ”€â”€ CampaignService.js        # æ´»åŠ¨ç®¡ç†
â”‚   â”œâ”€â”€ QueryService.js           # å¹²é¢„è§„åˆ™æŸ¥è¯¢
â”‚   â””â”€â”€ CRUDService.js            # æ´»åŠ¨ CRUDï¼ˆæ–°å¢ï¼‰
â””â”€â”€ index.js                      # ServiceManager æ³¨å†Œ
```

### 6.2 ServiceManager æœåŠ¡æ³¨å†Œ

```javascript
// services/index.js
this._services.set('session_management', SessionManagementService)
this._services.set('lottery_campaign_crud', LotteryCampaignCRUDService)
```

### 6.3 å‚è€ƒèµ„æ–™

- é˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œ
- è…¾è®¯æ¸¸æˆåç«¯æ¶æ„è®¾è®¡è§„èŒƒ
- ç¾å›¢æŠ€æœ¯åšå®¢ - CQRS å®è·µ
- Martin Fowler - Patterns of Enterprise Application Architecture

---

**æ–‡æ¡£ç»´æŠ¤è€…**: åç«¯å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2026-01-31


