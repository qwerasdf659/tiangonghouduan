# 内容投放系统 — 重复功能合并方案

> 创建时间：2026-02-22
> 最后更新：2026-02-22（二次校验：Node.js 直连 restaurant_points_dev 实查 + 后端代码逐文件核对）
> 状态：**全部 7 项决策已定论（D1-D7），可进入实施阶段** + 微信小程序前端求证完成
> 范围：PopupBanner + CarouselItem + SystemAnnouncement 合并入 Ad System
> 原则：只合并重复部分，广告主全部功能完整保留；**后端数据库为核心权威，前端适配后端**
> 数据来源：直连生产数据库 restaurant_points_dev 实查（非备份文件）
> 技术权威：以后端 Node.js + Express + Sequelize + MySQL 技术栈为准，前端直接使用后端字段名

---

## 零、为什么要合并 — 设计决策背景

### 0.1 三套系统的定位差异

从业务模型看，三套系统本来不是重复的：

| 系统 | 设计意图 | 内容形式 | 收费 |
|---|---|---|---|
| PopupBanner（公告弹窗） | 运营自用的免费弹窗工具 | 图片 | 免费 |
| SystemAnnouncement（系统公告） | 平台级文字通知 | 纯文字 | 免费 |
| Ad System（广告系统） | 面向广告主的付费投放平台 | 图片 | 收钻石 |

它们的业务模型不同，但最终产出物相同（都是"向用户展示内容"），导致大量重复实现。

### 0.2 合并的直接原因

1. **管理后台的使用者只有运营人员** — 广告主不直接操作 Web 管理后台。无论是系统公告、运营弹窗还是广告活动，都是运营人员在同一个后台操作。分成三个独立菜单，运营需要记住"这条内容该去哪个菜单建"。
2. **代码已经在做合并** — `PopupBannerService.getActiveBanners()` 已经把运营弹窗和广告竞价中标结果混在一起输出给前端。展示层已经是一体的，只是管理层分裂了。
3. **三套 CRUD 重复维护** — 图片/标题/跳转/位置/时间控制/启用状态这 6 组字段在 3 个模型里重复了 3 遍，对应 3 套 Service、6 个 Route 文件、各自的过期判断和状态描述逻辑。

### 0.3 合并原则

- **只合并重复实现** — 不删除任何独一份的功能
- **广告主功能完整保留** — 竞价/计费/审核/DMP/反作弊/归因全部不动
- **项目未上线，不需要兼容旧接口** — 可以一步到位
- **从长期维护成本出发** — 合并后只维护一套 CRUD、一套展示队列逻辑、一套数据报表

---

## 一、现状：哪些东西是重复的

### 1.1 字段级重复对照

以下字段在多个模型中重复定义，语义完全相同：

| 字段含义 | PopupBanner | CarouselItem | AdCreative | SystemAnnouncement |
|---|---|---|---|---|
| 标题 | `title` VARCHAR(100) | `title` VARCHAR(100) | `title` VARCHAR(100) | `title` VARCHAR(200) |
| 图片 | `image_url` VARCHAR(500) | `image_url` VARCHAR(500) | `image_url` VARCHAR(500) | 无 |
| 图片宽 | `image_width` INT | `image_width` INT | `image_width` INT | 无 |
| 图片高 | `image_height` INT | `image_height` INT | `image_height` INT | 无 |
| 跳转链接 | `link_url` VARCHAR(500) | `link_url` VARCHAR(500) | `link_url` VARCHAR(500) | 无 |
| 跳转类型 | `link_type` ENUM(4值) | `link_type` ENUM(4值) | `link_type` STRING(20) | 无 |
| 显示位置 | `position` VARCHAR(50) | `position` VARCHAR(50) | 无（在AdSlot上） | 无 |
| 启用状态 | `is_active` BOOLEAN | `is_active` BOOLEAN | 无（在AdCampaign上） | `is_active` BOOLEAN |
| 时间控制 | `start_time` / `end_time` | `start_time` / `end_time` | 无（在AdCampaign上） | `expires_at` |
| 创建人 | `created_by` INT | `created_by` INT | 无（在AdCampaign上） | `admin_id` INT |
| 优先级 | `priority` INT | 无 | 无（在AdCampaign上） | `priority` ENUM |

**重复率**：图片/标题/跳转/位置/时间控制/启用状态这 6 组字段在 3 个模型里重复了 3 遍。

### 1.2 逻辑层重复对照

| 逻辑 | PopupBannerService | CarouselItemService | AnnouncementService | Ad System 对应服务 |
|---|---|---|---|---|
| 获取活跃列表 | `getActiveBanners()` | `getActiveCarouselItems()` | `getAnnouncements()` | `AdBiddingService.selectWinners()` |
| 后台增删改查 | createBanner/update/delete | create/update/delete | create/update/delete | AdCampaignService CRUD |
| 过期判断 | `isExpired()` | `isExpired()` | `isExpired()` | status 生命周期 |
| 状态描述 | `getStatusDescription()` | `getStatusDescription()` | `getStatusDescription()` | status 字段 |
| 展示日志 | PopupShowLog 写入 | CarouselShowLog 写入 | view_count 累加 | AdImpressionLog 写入 |
| 定时过期清理 | 有（ENABLE_CONTENT_CRON_JOBS） | 有 | 有 | 有（广告完成状态） |

### 1.3 文件级清单

**将被合并废弃的文件（13 个）：**

| 类型 | 文件路径 | 数据库记录数 |
|---|---|---|
| Model | `models/PopupBanner.js` | 2 条 |
| Model | `models/PopupShowLog.js` | 36 条 |
| Model | `models/CarouselItem.js` | **1 条**（实查校正，原文误记为 0） |
| Model | `models/CarouselShowLog.js` | **11 条**（实查校正，原文误记为 0） |
| Model | `models/SystemAnnouncement.js` | 1 条 |
| Service | `services/PopupBannerService.js` | — |
| Service | `services/CarouselItemService.js` | — |
| Service | `services/AnnouncementService.js` | — |
| Route | `routes/v4/system/popup-banners.js` | — |
| Route | `routes/v4/console/popup-banners.js` | — |
| Route | `routes/v4/system/carousel-items.js` | — |
| Route | `routes/v4/console/carousel-items.js` | — |
| Route | `routes/v4/system/announcements.js` | — |

**对应的测试文件（2 个）：**

| 文件路径 |
|---|
| `tests/services/PopupBannerService.test.js` |
| `tests/services/AnnouncementService.test.js` |

**将被废弃的数据库表（5 张）：**

| 表名 | 当前记录数 | 处置 |
|---|---|---|
| `popup_banners` | 2 | 数据迁移后 DROP |
| `popup_show_logs` | 36 | 数据迁移后 DROP |
| `carousel_items` | **1** | 数据迁移后 DROP（实查校正，原文误记为 0） |
| `carousel_show_logs` | **11** | 数据迁移后 DROP（实查校正，原文误记为 0） |
| `system_announcements` | 1 | 数据迁移后 DROP |

### 1.4 完整保留不动的文件（Ad System 原有 14 张表全保留）

| 表/模型 | 记录数 | 说明 |
|---|---|---|
| `ad_slots` | 6 | 广告位定义 |
| `ad_campaigns` | 2 | 广告计划 |
| `ad_creatives` | 0 | 广告创意 |
| `ad_billing_records` | 0 | 计费记录 |
| `ad_bid_logs` | 15 | 竞价日志 |
| `ad_impression_logs` | 16 | 展示日志 |
| `ad_click_logs` | 10 | 点击日志 |
| `ad_antifraud_logs` | 10 | 反作弊日志 |
| `ad_attribution_logs` | **4**（实查校正，原文误记为 0） | 归因日志 |
| `ad_report_daily_snapshots` | 0 | 日报快照 |
| `user_ad_tags` | **5**（实查校正，原文误记为 0） | 用户标签 |

以及所有 Ad System 的 Service / Route 文件完整保留。

---

## 二、合并方案

### 2.1 ad_campaigns 表加 2 个字段

> **实查说明**：`ad_campaigns` 的 `billing_mode`、`status` 在数据库层均为 `VARCHAR(20)`，枚举约束在 Sequelize Model 层 `validate.isIn` 实现。下同。新增字段沿用同一模式。

```
campaign_category  VARCHAR(20)  NOT NULL  DEFAULT 'commercial'
-- Model 层 validate.isIn: ['commercial', 'operational', 'system']
```

- `commercial` — 商业广告（完整流程：计费/竞价/审核/定向）
- `operational` — 运营内容（原 PopupBanner + CarouselItem）
- `system` — 系统通知（原 SystemAnnouncement）

```
advertiser_user_id  ALTER 改为 allowNull: true
-- 当前数据库 NOT NULL，需要 ALTER TABLE
```

- `operational` 和 `system` 类型不需要广告主，`advertiser_user_id` 存运营人员自己的 user_id

### 2.2 ad_creatives 表加 3 个字段 + 1 个字段约束变更

> **实查说明**：当前 `ad_creatives.image_url` 为 `VARCHAR(500) NOT NULL`，Model 层有 `validate.notEmpty`。text-only 创意（system 类型）没有图片，必须将 `image_url` 改为 `allowNull: true` 并移除 `notEmpty` 校验。

```
content_type      VARCHAR(20)  NOT NULL  DEFAULT 'image'
-- Model 层 validate.isIn: ['image', 'text']
text_content      TEXT  NULL
display_mode      VARCHAR(30)  NULL
-- Model 层 validate.isIn: ['wide','horizontal','square','tall','slim','full_image']
```

```
image_url  ALTER 改为 allowNull: true
-- 当前 NOT NULL + validate.notEmpty，text-only 创意无图片
-- Model 层移除 validate.notEmpty，改为 conditionalNotEmpty（content_type='image' 时必填）
```

- `content_type = 'image'`：现有逻辑不变，用 `image_url` 字段
- `content_type = 'text'`：原 SystemAnnouncement 的文字内容，存入 `text_content`，`image_url` 为 NULL
- `display_mode`：原 PopupBanner 的 6 种显示模式，从 PopupBanner 迁移过来

### 2.3 ad_campaigns 表加 5 个字段（吸收 PopupBanner + CarouselItem + SystemAnnouncement 独有属性）

> **实查说明**：PopupBanner Model 中 `frequency_rule` 的 validate.isIn 为 `['always', 'once', 'once_per_session', 'once_per_day', 'once_per_n_days', 'n_times_total']`，共 6 种。合并时需在 AdCampaign Model 中复制此校验。

```
frequency_rule      VARCHAR(30)  NULL  DEFAULT 'once_per_day'
-- Model 层 validate.isIn: ['always', 'once', 'once_per_session', 'once_per_day', 'once_per_n_days', 'n_times_total']
frequency_value     INT  NULL  DEFAULT 1
force_show          BOOLEAN  NULL  DEFAULT false
internal_notes      TEXT  NULL
slide_interval_ms   INT  NULL  DEFAULT 3000
```

- `frequency_rule` / `frequency_value`：原 PopupBanner 的频次控制
- `force_show`：原 PopupBanner 的强制弹出
- `internal_notes`：原 SystemAnnouncement 的内部备注
- `slide_interval_ms`：原 CarouselItem 的轮播间隔毫秒（仅 slot_type=carousel 时使用）

### 2.4 ad_creatives 表替换 link_type 校验（D3 定论：统一为微信系命名）

> **实查说明**：`ad_creatives.link_type` 在数据库层为 `VARCHAR(20)`，枚举约束在 Model 层 `validate.isIn`。替换只需修改 Model 代码，无需 ALTER TABLE。
> **D3 定论**：统一为微信系命名，与微信官方 API 语义对齐。当前 ad_creatives 0 条数据，零迁移风险。

`link_type` Model 层 validate.isIn 从 `['none', 'external', 'internal', 'app_page']` **替换为** `['none', 'page', 'miniprogram', 'webview']`

- `page`：小程序内部页面跳转（对应 `wx.navigateTo`，原 Ad System 的 `internal`）
- `miniprogram`：跳转到其他小程序（对应 `wx.navigateToMiniProgram`，原 Ad System 的 `app_page`）
- `webview`：H5 页面跳转（对应 `web-view` 组件，原 Ad System 的 `external`）
- `none`：无跳转（保留不变）

### 2.5 ad_slots 表扩展 slot_type 校验

> **实查说明**：`ad_slots.slot_type` 在数据库层为 `VARCHAR(20)`，枚举约束在 Model 层 `validate.isIn`。扩展只需修改 Model 代码，无需 ALTER TABLE。

`slot_type` Model 层 validate.isIn 从 `['popup', 'carousel']` 扩展为 `['popup', 'carousel', 'announcement']`

- `announcement` 类型的广告位用于系统公告展示
- 需要 INSERT 一条新的 ad_slots 记录（如 `slot_key='home_announcement'`）

### 2.6 各类型 campaign 的字段使用规则

| 字段 | commercial | operational | system |
|---|---|---|---|
| `campaign_category` | commercial | operational | system |
| `advertiser_user_id` | 广告主 user_id | 运营人员 user_id | 管理员 user_id |
| `billing_mode` | fixed_daily / bidding | **固定 'free'**（新增枚举值） | **固定 'free'** |
| `status` 流程 | draft→pending_review→approved→active | **draft→active**（D1 定论：手动发布） | **draft→active**（D1 定论：手动发布） |
| `budget_total_diamond` | 必填 | NULL（不计费） | NULL |
| `daily_bid_diamond` | bidding 时必填 | NULL | NULL |
| `targeting_rules` | 可选 | 可选 | NULL |
| `frequency_rule` | 使用 AdSlot.max_display_count | 自定义频次 | NULL（或 always） |
| `force_show` | false | 可选 | true |
| `priority` 范围 | 1-99（竞价排序） | 100-899（固定排序） | 900-999（最高优先级） |
| Creative `content_type` | image | image | text 或 image |
| Creative `review_status` | pending→approved | **直接 approved** | **直接 approved** |

`billing_mode` Model 层 validate.isIn 新增 `'free'`，从 `['fixed_daily', 'bidding']` 变为 `['fixed_daily', 'bidding', 'free']`。数据库层为 VARCHAR(20)，无需 ALTER。

> **实查说明**：当前 `ad_campaigns.priority` 的 Model 层校验为 `validate: { min: 1, max: 99 }`。operational/system 类型需要使用 100-999 范围，必须将 `max: 99` 改为 `max: 999`。这是一个**破坏性变更**，需同步修改 AdCampaignService 中所有引用 priority 范围的逻辑。

### 2.7 展示队列出队逻辑（替代 PopupBannerService.getActiveBanners 的合并逻辑）

```
1. 查询指定 ad_slot 下所有 status=active 的 campaigns
2. 按 campaign_category 分组：
   - system → 按 priority DESC 直接取（最高优先级，不竞价）
   - operational → 按 priority DESC 取（固定排序，不竞价）
   - commercial → 走现有 AdBiddingService.selectWinners()（竞价排序）
3. 合并结果：[system, operational, commercial] 依次拼接
4. 返回给前端
```

---

## 三、数据迁移

### 3.1 popup_banners → ad_campaigns + ad_creatives（2 条数据）

每条 popup_banner 拆成：
- 1 条 `ad_campaigns` 记录（campaign_category='operational'）
- 1 条 `ad_creatives` 记录（content_type='image'）

字段映射：

| popup_banners 字段 | → ad_campaigns 字段 |
|---|---|
| title | campaign_name |
| position | 关联到对应 ad_slot（按 position + slot_type 匹配） |
| is_active | status = is_active ? 'active' : 'paused' |
| start_time | start_date（转 DATEONLY） |
| end_time | end_date（转 DATEONLY） |
| banner_type | 映射到 priority 范围（notice→900, event→500, promo→100） |
| frequency_rule | frequency_rule（直接复制） |
| frequency_value | frequency_value（直接复制） |
| force_show | force_show（直接复制） |
| priority | priority（直接复制） |
| display_order | priority（合并） |
| created_by | advertiser_user_id |

| popup_banners 字段 | → ad_creatives 字段 |
|---|---|
| title | title |
| image_url | image_url |
| image_width | image_width |
| image_height | image_height |
| link_url | link_url |
| link_type | link_type（直接复制，枚举已扩展支持 page/miniprogram/webview） |
| display_mode | display_mode（新字段） |

### 3.2 system_announcements → ad_campaigns + ad_creatives（1 条数据）

| system_announcements 字段 | → ad_campaigns 字段 |
|---|---|
| title | campaign_name |
| type | 映射到 priority（system→999, maintenance→950, activity→900, notice→900） |
| priority | 映射（high→999, medium→950, low→900） |
| is_active | status = is_active ? 'active' : 'paused' |
| expires_at | end_date |
| admin_id | advertiser_user_id |
| target_groups | targeting_rules |
| internal_notes | internal_notes |

| system_announcements 字段 | → ad_creatives 字段 |
|---|---|
| title | title |
| content | text_content |
| — | content_type = 'text' |
| — | review_status = 'approved'（跳过审核） |

### 3.3 popup_show_logs → ad_impression_logs（36 条数据）

读取 popup_show_logs 结构，将每条记录映射到 ad_impression_logs 对应字段。

### 3.4 carousel_items → ad_campaigns + ad_creatives（1 条数据，实查校正）

> **实查校正**：原文称"无数据，直接 DROP"，实查发现 carousel_items 有 1 条记录（id=26, title="11111", is_active=1），carousel_show_logs 有 11 条记录。

carousel_item 迁移方式与 popup_banner 相同：
- 1 条 `ad_campaigns` 记录（campaign_category='operational'，关联 home_carousel 广告位）
- 1 条 `ad_creatives` 记录（content_type='image'，display_mode='wide'）
- `slide_interval_ms=3000` 存入 ad_campaigns 新字段

### 3.5 carousel_show_logs → ad_interaction_logs（11 条数据，D2 定论：新建通用交互表）

carousel_show_logs 有 11 条记录。D2 定论：新建 `ad_interaction_logs` 表。
每条迁移为 1 条 `interaction_type='impression'` 记录，`extra_data` JSON 存入 `{ exposure_duration_ms, is_manual_swipe, is_clicked }`。

### 3.6 popup_show_logs → ad_interaction_logs（36 条数据，D2 定论：新建通用交互表）

popup_show_logs 有 36 条记录。D2 定论：新建 `ad_interaction_logs` 表。
每条迁移为 1 条 `interaction_type='impression'` 记录，`extra_data` JSON 存入 `{ show_duration_ms, close_method, queue_position }`。

---

## 四、服务层变更

### 4.1 新增逻辑（在现有 Ad System 服务上扩展）

**AdCampaignService** 扩展：
- 新增 `createOperationalCampaign()` 方法 — 简化创建流程，自动设置 billing_mode='free'、status='draft'（D1 定论：手动发布切 active）、review_status='approved'
- 新增 `createSystemCampaign()` 方法 — 同上，额外自动设置 force_show=true、priority≥900
- 现有 `createCampaign()` 不改动 — 继续处理 commercial 类型

**AdBiddingService** 扩展：
- `selectWinners()` 方法调整出队逻辑 — 在竞价之前先取 system + operational 类型（见 2.7 节）

**PopupBannerService 的合并逻辑移除**：
- 当前 `PopupBannerService.getActiveBanners()` 里有合并 Ad 中标结果的逻辑
- 合并后这个逻辑统一在 `AdBiddingService.selectWinners()` 里，不再需要两个入口

### 4.2 废弃的 Service（3 个）

| Service | 替代方案 |
|---|---|
| `PopupBannerService` | `AdCampaignService` + `createOperationalCampaign()` |
| `CarouselItemService` | `AdCampaignService` + slot_type='carousel' |
| `AnnouncementService` | `AdCampaignService` + `createSystemCampaign()` |

### 4.3 路由变更

**废弃的路由（6 个文件）：**
- `routes/v4/console/popup-banners.js` → 合并到 `routes/v4/console/ad-campaigns.js?category=operational`
- `routes/v4/system/popup-banners.js` → 合并到 `routes/v4/system/ad-delivery.js`（D5 定论：前端获取弹窗）
- `routes/v4/console/carousel-items.js` → 合并到 `routes/v4/console/ad-campaigns.js?category=operational&slot_type=carousel`
- `routes/v4/system/carousel-items.js` → 合并到 `routes/v4/system/ad-delivery.js`（D5 定论：前端获取轮播）
- `routes/v4/console/system/announcements.js` → 合并到 `routes/v4/console/ad-campaigns.js?category=system`
- `routes/v4/system/announcements.js` → 合并到 `routes/v4/system/ad-delivery.js`（D5 定论：前端获取公告）

**保留并扩展的路由：**
- `routes/v4/console/ad-campaigns.js` — 增加 `category` query 参数，支持按 commercial/operational/system 筛选
- `routes/v4/system/ad-events.js` — 保留现有事件上报（POST only），新增统一交互日志端点

**新建路由（D5 定论）：**
- `routes/v4/system/ad-delivery.js` — 统一前端内容获取接口（GET only，与 ad-events 职责分离）

---

## 五、前端管理后台菜单调整

### 合并前（3 个独立菜单）

```
├── 广告系统
│   ├── 广告概览
│   ├── 广告活动
│   ├── 广告位管理
│   └── 归因追踪
├── 公告弹窗管理
│   ├── 弹窗管理
│   └── 轮播图管理
└── 内容管理中心（部分）
    └── 公告管理
```

### 合并后（1 个统一菜单）

```
└── 内容投放管理
    ├── 系统通知    ← 筛选 category=system（简化表单）
    ├── 运营推广    ← 筛选 category=operational（弹窗+轮播，无计费字段）
    ├── 商业广告    ← 筛选 category=commercial（完整流程）
    ├── 广告位管理  ← 不变
    └── 数据报表    ← 不变，可按 category 筛选
```

后端实际只打一套 API：`GET /api/v4/console/ad-campaigns?category=operational&page=1&limit=20`

前端表单根据 category 动态显示/隐藏字段：
- 选 `system`：隐藏计费、竞价、预算字段，显示文字内容输入框
- 选 `operational`：隐藏计费、竞价、预算字段，显示图片上传+频次控制
- 选 `commercial`：显示全部字段

---

## 六、独有功能审计 — 确认无功能丢失

### 6.1 被合并系统的独有功能去向

逐项核对三个被合并系统中 Ad System 原本没有的功能，确认每个都有对应归宿：

| 独有功能 | 来源系统 | 合并去向 | 处理方式 |
|---|---|---|---|
| `display_mode`（6种显示模式） | PopupBanner | `ad_creatives` 新字段 | 2.2 节 |
| `frequency_rule`（6种频次规则） | PopupBanner | `ad_campaigns` 新字段 | 2.3 节 |
| `frequency_value`（频次参数） | PopupBanner | `ad_campaigns` 新字段 | 2.3 节 |
| `force_show`（强制弹出） | PopupBanner | `ad_campaigns` 新字段 | 2.3 节 |
| `banner_type`（notice/event/promo） | PopupBanner | 映射到 `priority` 数值范围 | 2.6 节 |
| `slide_interval_ms`（轮播间隔） | CarouselItem | `ad_campaigns` 新字段 | 2.3 节 |
| `text_content`（文字内容） | SystemAnnouncement | `ad_creatives` 新字段 | 2.2 节 |
| `internal_notes`（内部备注） | SystemAnnouncement | `ad_campaigns` 新字段 | 2.3 节 |
| `view_count`（浏览量计数） | SystemAnnouncement | `ad_impression_logs` 替代（按 campaign 聚合 COUNT） | 更强 |
| `target_groups`（目标用户组） | SystemAnnouncement | `ad_campaigns.targeting_rules` | 已有字段 |
| `link_type` 枚举差异 | PopupBanner 用 page/miniprogram/webview | `ad_creatives.link_type` 扩展枚举 | 2.4 节 |

**结论：0 个独有功能被丢弃。**

### 6.2 广告主功能完整保留确认

以下 Ad System 原有功能在合并后**完全不受影响**，commercial 类型的代码逻辑一行不改：

| 广告主功能 | 涉及的表/服务 | 合并后状态 |
|---|---|---|
| 竞价出价 | `ad_campaigns.daily_bid_diamond` / `AdBiddingService` | 不动 |
| 固定包天计费 | `ad_campaigns.fixed_days` / `fixed_total_diamond` | 不动 |
| 预算控制与消耗追踪 | `ad_campaigns.budget_total_diamond` / `budget_spent_diamond` | 不动 |
| 每日扣费流水 | `ad_billing_records` / `AdBillingService` | 不动 |
| 素材审核流程 | `ad_creatives.review_status` / `reviewed_by` / `reviewed_at` | 不动 |
| 计划审核流程 | `ad_campaigns.status` 8种状态生命周期 / `review_note` | 不动 |
| DMP 用户标签定向 | `user_ad_tags` / `ad_campaigns.targeting_rules` | 不动 |
| 反作弊检测 | `ad_antifraud_logs` / `AdAntifraudService` | 不动 |
| 归因追踪 | `ad_attribution_logs` / `AdAttributionService` | 不动 |
| 展示日志 | `ad_impression_logs` / `AdImpressionLogService` | 不动 |
| 点击日志 | `ad_click_logs` / `AdClickLogService` | 不动 |
| 竞价日志 | `ad_bid_logs` | 不动 |
| 日报快照 | `ad_report_daily_snapshots` / `AdReportService` | 不动 |
| 广告位管理 | `ad_slots` / `AdSlotService` | 仅扩展 1 个枚举值 |

**结论：14 张表全保留，0 个广告主功能被修改。**

---

## 七、不合并的部分（保持独立）

| 系统 | 原因 |
|---|---|
| `AdminNotification`（管理员通知） | 1 对 1 的事务通知（"你的订单已成交"），不是 1 对 N 的内容投放 |
| `ChatMessage`（客服消息） | 实时 WebSocket 通信系统，与内容投放无关 |
| `Feedback`（用户反馈） | 用户侧输入，不是运营侧投放 |

---

## 八、实施步骤

> **已由第十五节替代**。第十五节基于数据库实查结果重新编排了 7 个 Phase，包含具体 SQL 语句、责任方标注和文件清单。以下为原始草案，仅供对比参考。

~~原 Phase 1-4 已被第十五节 Phase 1-7 替代，主要差异：~~
- ~~数据迁移从 3 条改为 4 条（新增 1 条 carousel_item）~~
- ~~日志迁移从 36 条改为 47 条（新增 11 条 carousel_show_log）~~
- ~~新增 ad_creatives.image_url 改 NULL 的 ALTER~~
- ~~D2 改为方案 B：新建 ad_interaction_logs 表（替代原方案 A 的扩展 ad_impression_logs）~~
- ~~Web 前端和微信小程序前端拆分为独立 Phase~~

---

## 九、变更统计

| 指标 | 数值 |
|---|---|
| 废弃的数据库表 | 5 张 |
| 废弃的 Model 文件 | 5 个 |
| 废弃的 Service 文件 | 3 个 |
| 废弃的 Route 文件 | 6 个 |
| 废弃的 Test 文件 | 2 个 |
| **总计废弃文件** | **16 个** |
| 需要修改的 Model | 3 个（AdCampaign, AdCreative, AdSlot） |
| 需要修改的 Service | 2 个（AdCampaignService, AdBiddingService） |
| 需要修改的 Route | 1 个（console ad-campaigns 加 category 筛选）|
| 需要新建的 Route | 1 个（system ad-delivery，D5 定论）|
| 新增的数据库字段 | 10 个 |
| 需要迁移的数据 | **4 条** campaign（2 popup + 1 carousel + 1 announcement）+ **47 条** log（36 popup + 11 carousel） |
| 需要变更约束的字段 | 2 个（advertiser_user_id → allowNull, image_url → allowNull） |
| 需要扩展校验的字段 | 4 个（billing_mode, slot_type, link_type, priority.max） |
| Ad System 原有功能影响 | 无（commercial 类型逻辑不变） |

---

## 十、数据库实查勘误 — 文档 vs 真实数据差异表

> 以下差异均通过 Node.js 直连 `restaurant_points_dev` 数据库实查确认，非引用任何历史报告。

### 10.1 数据量差异

| 表名 | 原文档记录数 | 实查记录数 | 差异说明 |
|---|---|---|---|
| `carousel_items` | 0 | **1** | id=26, title="11111", is_active=1, 有真实轮播数据 |
| `carousel_show_logs` | 0 | **11** | 用户 user_id=31 的真实浏览记录 |
| `ad_attribution_logs` | 0 | **4** | 已有归因追踪数据 |
| `user_ad_tags` | 0 | **5** | 已有用户标签数据 |
| `popup_banners` | 2 | 2 | 一致 |
| `popup_show_logs` | 36 | 36 | 一致 |
| `system_announcements` | 1 | 1 | 一致 |
| `ad_slots` | 6 | 6 | 一致 |
| `ad_campaigns` | 2 | 2 | 一致 |

**影响**：carousel_items/carousel_show_logs 不能"直接 DROP"，需要先做数据迁移。

### 10.2 字段类型差异（DB 层 vs 文档描述）

| 字段 | 文档描述 | 数据库实际类型 | 枚举约束位置 |
|---|---|---|---|
| `ad_campaigns.billing_mode` | ENUM | **VARCHAR(20)** | Model 层 `validate.isIn` |
| `ad_campaigns.status` | ENUM | **VARCHAR(20)** | Model 层 `validate.isIn` |
| `ad_slots.slot_type` | ENUM | **VARCHAR(20)** | Model 层 `validate.isIn` |
| `ad_creatives.link_type` | ENUM | **VARCHAR(20)** | Model 层 `validate.isIn` |
| `ad_creatives.review_status` | ENUM | **VARCHAR(20)** | Model 层 `validate.isIn` |
| `popup_banners.display_mode` | — | **ENUM（真正的数据库 ENUM）** | DB 层 + Model 层双重约束 |
| `popup_banners.link_type` | — | **ENUM（真正的数据库 ENUM）** | DB 层 + Model 层双重约束 |
| `carousel_items.display_mode` | — | **ENUM（真正的数据库 ENUM）** | DB 层 + Model 层双重约束 |
| `carousel_items.link_type` | — | **ENUM（真正的数据库 ENUM）** | DB 层 + Model 层双重约束 |

**影响**：Ad System 新增字段/扩展校验只需改 Model 代码中的 `validate.isIn` 数组，不需要 ALTER TABLE 改 ENUM。大幅简化 Phase 1 数据库变更工作量。

### 10.3 约束差异

| 字段 | 当前约束 | 合并后需要 | 需要的变更 |
|---|---|---|---|
| `ad_campaigns.advertiser_user_id` | `INT NOT NULL` | `INT NULL` | ALTER TABLE + Model allowNull: true |
| `ad_campaigns.priority` | Model `max: 99` | 支持 100-999 | Model validate 改 `max: 999` |
| `ad_creatives.image_url` | `VARCHAR(500) NOT NULL` + `validate.notEmpty` | `NULL`（text-only） | ALTER TABLE + Model allowNull: true + 条件校验 |

### 10.4 日志表字段结构不兼容

| 字段 | popup_show_logs | carousel_show_logs | ad_impression_logs |
|---|---|---|---|
| 内容 ID | `popup_banner_id` INT | `carousel_item_id` INT | `ad_campaign_id` INT |
| 用户 | `user_id` INT | `user_id` INT | `user_id` INT |
| 广告位 | 无 | 无 | `ad_slot_id` INT |
| 展示时长 | `show_duration_ms` INT | `exposure_duration_ms` INT | **无** |
| 关闭方式 | `close_method` VARCHAR | 无 | **无** |
| 队列位置 | `queue_position` TINYINT | 无 | **无** |
| 手动滑动 | 无 | `is_manual_swipe` BOOLEAN | **无** |
| 是否点击 | 无 | `is_clicked` BOOLEAN | **无** |
| 有效性 | 无 | 无 | `is_valid` BOOLEAN |
| 无效原因 | 无 | 无 | `invalid_reason` VARCHAR |

**影响**：popup_show_logs 和 carousel_show_logs 不能直接映射到 ad_impression_logs，需要决策（见第十二节）。

---

## 十一、问题责任归属分析

### 11.1 后端数据库项目（本项目）需要做的事

| 编号 | 变更项 | 工作量 | 说明 |
|---|---|---|---|
| B1 | ALTER `ad_campaigns` 加 6 个字段 | 1 条 migration | campaign_category, frequency_rule, frequency_value, force_show, internal_notes, slide_interval_ms |
| B2 | ALTER `ad_campaigns.advertiser_user_id` 改 NULL | 1 条 migration | 同上 migration 合并 |
| B3 | ALTER `ad_creatives` 加 3 个字段 | 1 条 migration | content_type, text_content, display_mode |
| B4 | ALTER `ad_creatives.image_url` 改 NULL | 1 条 migration | 同上 migration 合并 |
| B5 | 修改 `AdCampaign` Model — 新增字段 + 扩展 validate.isIn | 改 1 个文件 | billing_mode 加 'free'，priority max 改 999 |
| B6 | 修改 `AdCreative` Model — 新增字段 + 替换 link_type validate.isIn + 条件校验 | 改 1 个文件 | link_type 替换为 `['none','page','miniprogram','webview']`（D3 定论），image_url 条件必填 |
| B7 | 修改 `AdSlot` Model — 扩展 validate.isIn | 改 1 个文件 | slot_type 加 'announcement' |
| B8 | 扩展 `AdCampaignService` — 新增 2 个方法 | 改 1 个文件 | createOperationalCampaign + createSystemCampaign |
| B9 | 修改 `AdBiddingService.selectWinners()` — 三层优先级出队 | 改 1 个文件 | system → operational → commercial 排序 |
| B10 | INSERT 1-2 条 `ad_slots` 种子数据 | 迁移脚本 | home_announcement 等 |
| B11 | 写数据迁移脚本（4 条 campaign + 47 条 log） | 1 个脚本 | Sequelize migration 或独立 Node.js 脚本 |
| B12 | 扩展 console ad-campaigns 路由 — 支持 category 筛选 | 改 1 个文件 | query param: ?category=operational |
| B13 | **新建** `system/ad-delivery.js` 路由 — 统一前端内容获取（D5 定论） | **新建 1 个文件** | 替代 popup-banners/carousel-items/announcements 3 个路由，与 ad-events 职责分离 |
| B14 | 删除 3 个 Service + 5 个 Model + 6 个 Route + 2 个 Test | 删 16 个文件 | 最后执行 |
| B15 | DROP 5 张废弃表 | 迁移脚本 | 确认数据迁移完成后 |
| B16 | 新建 `ad_interaction_logs` 表 | 1 条 migration | D2 定论：interaction_type + extra_data JSON，统一记录所有内容交互日志 |

### 11.2 Web 管理后台前端项目（admin/ 目录）需要做的事

> **实查技术栈**：Alpine.js 3.15.4 + Tailwind CSS 3.4.19 + Vite 6.4.1 MPA 架构，HTTP 客户端为原生 Fetch 封装，API 前缀 `/api/v4`。

| 编号 | 变更项 | 工作量 | 说明 |
|---|---|---|---|
| W1 | 合并 `content-management.html` 和 `ad-management.html` 为统一页面 | 改 1-2 个 HTML | 或保留 ad-management 扩展 |
| W2 | 删除 `banners.js` composable | 删 1 个文件 | admin/src/modules/content/composables/banners.js |
| W3 | 删除 `carousel-items.js` composable | 删 1 个文件 | admin/src/modules/content/composables/carousel-items.js |
| W4 | 删除 `announcements.js` composable | 删 1 个文件 | admin/src/modules/content/composables/announcements.js |
| W5 | 修改广告活动列表 — 支持 category 筛选 Tab | 改 1 个文件 | ad-management.js 或新 composable |
| W6 | 新增/修改创建表单 — 根据 category 动态显示字段 | 改 1 个文件 | system 隐藏计费，显示文字输入；operational 隐藏计费，显示图片+频次 |
| W7 | 修改 API 调用路径 — 统一使用 ad-campaigns 端点 | 改 1 个文件 | admin/src/api/system/admin.js 中的 SYSTEM_ENDPOINTS |
| W8 | 前端字段名直接使用后端字段名 | 全局替换 | 如 `popup_banner_id` → `ad_campaign_id`，不做映射 |

### 11.3 微信小程序前端项目（独立仓库）需要做的事

> 小程序前端是独立项目，与本后端通过 `/api/v4/system/*` 接口通信。

| 编号 | 变更项 | 工作量 | 说明 |
|---|---|---|---|
| M1 | 弹窗接口路径变更 | 改 1 个请求 | `/api/v4/system/popup-banners` → `/api/v4/system/ad-delivery?slot_type=popup&position=home`（D5 定论） |
| M2 | 轮播接口路径变更 | 改 1 个请求 | `/api/v4/system/carousel-items` → `/api/v4/system/ad-delivery?slot_type=carousel&position=home`（D5 定论） |
| M3 | 公告接口路径变更 | 改 1 个请求 | `/api/v4/system/announcements` → `/api/v4/system/ad-delivery?slot_type=announcement`（D5 定论） |
| M4 | 响应字段名变更 — 直接使用后端新字段名 | 改 3 个页面 | `popup_banner_id` → `ad_campaign_id`，`banner_type` → `campaign_category`，`display_mode` 从 creative 取 |
| M5 | 展示日志上报接口变更 | 改 1 个请求 | 原 popup_show_log / carousel_show_log → 统一 ad_interaction_log（D2 定论） |
| M6 | 弹窗频次控制逻辑 | 检查兼容性 | `frequency_rule` 字段名不变，只是来源从 popup_banners 改为 ad_campaigns |
| M7 | link_type 枚举兼容 | **无需改动** | D3 定论：统一为微信系命名 `page/miniprogram/webview`，与小程序完全一致 |

---

## 十二、决策项 — 行业横向对比与最终定论

> 以下决策基于美团、阿里、腾讯、字节跳动、京东、Google、游戏公司、银行 APP 等不同规模企业的内容投放/广告系统设计模式，结合本项目实际情况（餐厅积分抽奖系统、微信小程序为主、未上线、小团队）做出。

### 行业设计模式总览

| 公司/类型 | 内容投放架构模式 | 运营内容 vs 付费广告关系 | 审核流程 | 日志方案 |
|---|---|---|---|---|
| **美团** | 平台化统一架构，Action 最小业务单元复用 | 统一 campaign_type 区分，运营位 + 商业广告共用投放引擎 | 商业广告多级审核，运营内容运营人员直发 | 统一事件日志表 |
| **阿里（阿里妈妈）** | 统一投放平台，所有内容类型通过一个系统管理 | material_type 字段区分，竞价 vs 优先级两条通道 | 商业广告严审，内部运营位直发 | 统一曝光表 + JSON 扩展 |
| **腾讯（广点通/微信广告）** | 广告位统一管理，campaign_type 区分品牌/效果/运营 | slot 概念统一，billing_type 控制是否计费 | 外部广告审核，内部运营直发 | 分表（impression/click/event） |
| **字节跳动（巨量引擎）** | 品牌广告 + 效果广告 + 运营位三合一 | campaign_category 区分，优先级覆盖竞价 | 同上 | 统一 event 表 |
| **京东（京准通）** | 整洁架构，业务与数据模型分离 | 自营推广与第三方广告统一管理 | 分级审核 | 统一日志 |
| **Google Ad Manager** | House Ads（内部）+ 第三方广告统一投放 | Line Item Type 区分，House Ads 零成本 | House Ads 无审核，第三方审核 | 统一 impression 表 |
| **游戏公司（米哈游/网易）** | 公告系统 + 活动 Banner + 广告分开，但有统一趋势 | type 字段区分 system/activity/ad | 紧急公告直发，活动需审批 | 独立 event_log |
| **银行/金融 APP** | 营销位统一管理，合规审核严格 | slot_type 区分公告/营销/广告 | 全部审核（合规要求） | 分表 |
| **小公司/创业公司** | 从分离起步，业务复杂后合并 | 逐步统一 | 直发为主 | 单表 |
| **Kevel（海外 AdTech）** | Server-side 统一 ad serving，多格式 | unified Flight 概念，priority + rate 区分 | 内部直发 | 统一 event |

### 对本项目的匹配度分析

本项目特征：
- 餐厅积分抽奖系统，微信小程序为主要客户端
- 未上线，可一次性投入，不需要兼容旧接口
- 运营团队人数少（甚至可能 1-2 人操作后台）
- 后端已有完整的 Ad System（14 张表，竞价/计费/反作弊/归因全套）
- 数据量极小（总共 4 条内容 + 47 条日志）

**最匹配的模式：美团/字节跳动的 "campaign_category 统一模式"**

原因：
1. 美团的 Action 复用思路与本项目的 "只合并重复部分" 原则完全一致
2. 字节跳动的 campaign_category 区分方式与本方案的 commercial/operational/system 分类完全对应
3. Google Ad Manager 的 House Ads 零成本方案与 billing_mode='free' 的思路一致
4. 项目规模不需要腾讯/阿里级的分表分库，单表方案最优

**不匹配的模式：**
- 银行/金融模式（全审核）— 合规要求高，本项目不需要
- 游戏公司的分离模式 — 本项目已经走到合并阶段，不需要回退
- 小公司起步模式 — 本项目已有完整 Ad System，应趁未上线一步到位

---

### D1：operational/system 类型是否跳过审核直接上线？

**行业做法**：

| 公司类型 | 商业广告 | 运营内容 | 系统公告 |
|---|---|---|---|
| 美团/阿里/字节 | 多级审核 | 运营人员直发（有权限控制） | 直发 |
| Google Ad Manager | 第三方审核 | House Ads 直接投放 | — |
| 游戏公司 | 审核 | 活动需审批 | 紧急公告直发 |
| 银行 | 全审核 | 全审核 | 全审核 |
| 创业公司 | 简化/无审核 | 直发 | 直发 |

**定论：方案 B — 保留简化审核，`draft → active`（手动点"发布"）**

理由：
1. 虽然美团/阿里/字节对运营内容多采用直发，但多一层"发布"操作在团队协作场景更安全
2. `draft → active` 已跳过 `pending_review` 和 `approved` 两个中间状态，操作只多一步点击
3. 运营人员创建内容后可以先预览确认，再手动切换到 active，防止误操作
4. `review_status` 仍自动设为 `'approved'`（跳过素材审核），简化的是计划层审核而非素材审核
5. 未来团队扩大后无需改流程，已具备协作能力，只有管理员能操作

---

### D2：展示日志迁移策略 — 三选一

**行业做法**：

| 公司类型 | 日志表方案 | 扩展字段处理 |
|---|---|---|
| 美团 | 统一事件表 + 扩展字段 | nullable 列 + 按事件类型有值 |
| 阿里 | 统一曝光表 + `extra_data JSON` | JSON 存异构数据 |
| 腾讯 | 分表（impression/click/event 独立表） | 各表字段各异 |
| 字节跳动 | 统一 event 表 + type 字段 | nullable 列 |
| Google | 统一 impression 表 | nullable 列为主 |
| 游戏公司 | 单表 + JSON | 灵活但查询复杂 |

**定论：方案 B — 新建通用交互日志表 `ad_interaction_logs`**

理由：
1. ad_impression_logs 是广告系统的核心计费依据（is_valid 字段直接关联反作弊和扣费），不宜为非计费内容增加无关字段
2. 新表通过 `interaction_type` + `extra_data JSON` 实现灵活扩展，未来新增交互类型（如长按、分享、收藏）无需 ALTER TABLE
3. 阿里的"统一曝光表 + extra_data JSON"方案适合多类型异构数据，本项目的弹窗关闭、轮播滑动、点击等交互类型差异较大，JSON 比固定列更合理
4. 现有 ad_impression_logs / ad_click_logs 保持纯粹（仅服务 commercial 广告计费），职责清晰
5. 47 条历史数据迁移到新表，不影响现有广告系统的查询和计费逻辑

---

### D3：是否统一 link_type 命名？

**行业做法**：

| 公司/平台 | 跳转类型命名风格 | 值 |
|---|---|---|
| 微信小程序原生 | 微信系 | `navigate`（页面）、`navigateToMiniProgram`、`webview` |
| 微信广告 | 微信系 | `page`、`miniprogram`、`webview` |
| 抖音小程序 | 字节系 | `page`、`webview`、`app` |
| 支付宝小程序 | 阿里系 | `navigate`、`navigateToMiniProgram`、`webview` |
| Google Ads | 通用系 | `url`、`app`、`deeplink` |
| 通用广告行业 | 通用系 | `external`、`internal`、`deeplink` |

**定论：方案 B — 统一为微信系命名 `['none', 'page', 'miniprogram', 'webview']`**

理由：
1. 本项目主客户端是微信小程序，微信生态命名是第一优先级
2. `page/miniprogram/webview` 这套命名与微信官方 API 一致（`wx.navigateTo` 对应 `page`，`wx.navigateToMiniProgram` 对应 `miniprogram`，`web-view` 组件对应 `webview`），开发者零学习成本
3. 抖音小程序也用 `page/webview`，命名风格高度兼容
4. 当前 `ad_creatives` 表 0 条数据，零迁移风险
5. 如果未来需要支持原生 APP 深度链接，只需加一个 `deeplink` 值（VARCHAR + validate.isIn，改 1 行代码）
6. 7 个值（共存方案）vs 4 个值（统一方案），后者认知成本低 43%

**额外影响**：
- Web 管理后台创建 commercial 类型广告时，`link_type` 下拉选项也用 `page/miniprogram/webview`，前端无需感知两套命名
- 文档第 2.4 节的 link_type 扩展方案需相应调整为"替换"而非"扩展"

---

### D4：ad_slots 的 daily_price_diamond / min_bid_diamond 对 operational/system 类型如何处理？

**行业做法**：

| 公司/平台 | 内部广告位价格处理 |
|---|---|
| Google Ad Manager | House Line Items: Rate = $0 CPM |
| 美团 | 内部运营位：价格字段设 0，计费服务跳过 |
| 字节跳动 | 品牌保量：有价格；运营位：价格 = 0 |
| Kevel | Priority Flight: Rate = 0, Priority 覆盖 |

**定论：方案 A — 价格设为 0，Service 层 billing_mode='free' 跳过计费校验**

理由：
1. Google / 美团 / Kevel 均采用"价格 = 0 + 计费跳过"模式，这是行业标准做法
2. 不改表结构，NOT NULL 约束保留，数据完整性不受影响
3. AdCampaignService 中 `billing_mode='free'` 分支跳过 `min_bid_diamond`/`min_budget_diamond` 校验，改动集中在 1 个 Service 文件
4. 如果未来某天 operational 类型也需要计费（如付费置顶），价格字段已经在，直接填值即可

---

## 十三、可复用性和可扩展性分析

### 13.1 后端现有可直接复用的能力

| 能力 | 复用来源 | 说明 |
|---|---|---|
| 标准 API 响应格式 | `utils/ApiResponse.js` | `res.apiSuccess()` / `res.apiError()` 中间件，所有新接口直接使用 |
| 北京时间处理 | `utils/timeHelper.js` + `BeijingTimeHelper` | Model hooks 已自动处理，新字段无需额外配置 |
| 图片存储（Sealos 对象存储） | `utils/imageUtils.js` | `getImageUrl()` 已在 PopupBannerService 和 CarouselItemService 中使用，迁移后继续复用 |
| 分页查询模式 | 各 Service 的 `findAndCountAll` | console 路由的 `page/limit` 分页已标准化 |
| 认证中间件 | `middleware/auth.js` | `authenticate` + `requireAdmin` 已在所有 console 路由使用 |
| 服务注册管理 | `services/index.js` ServiceManager | snake_case 键注册，`req.app.locals.services.getService()` 访问 |
| 数据脱敏 | `DataSanitizer` | AnnouncementService 已在用，可继续复用 |
| Ad System 竞价 | `AdBiddingService.selectWinners()` | 已在 PopupBannerService/CarouselItemService 中被调用，合并后变为唯一入口 |
| Ad System 计费 | `AdBillingService` + `AdBillingRecord` | commercial 类型继续使用，free 类型跳过 |
| Ad System 反作弊 | `AdAntifraudService` + `AdAntifraudLog` | commercial 类型继续使用 |
| Model Scopes | `AdCampaign.scope('active')` 等 | 可新增 `byCategory` scope |
| Sequelize Migration | `config/database.js` + Sequelize CLI | 已有 migration 基础设施 |

### 13.2 可扩展的设计点

| 扩展方向 | 基于 | 成本 |
|---|---|---|
| 新增 campaign_category 值（如 `partner`） | VARCHAR(20) + validate.isIn | 改 1 行 Model 代码 |
| 新增 slot_type 值（如 `splash`、`interstitial`） | VARCHAR(20) + validate.isIn | 改 1 行 Model 代码 |
| 新增 content_type 值（如 `video`、`rich_text`） | VARCHAR(20) + validate.isIn | 改 1 行 + 加 1 个字段 |
| 新增 link_type 值（如 `deeplink`） | VARCHAR(20) + validate.isIn | 改 1 行 Model 代码 |
| 新增广告位 | INSERT ad_slots 记录 | 不需要改代码 |
| 新增计费模式（如 `cpc`、`cpm`） | VARCHAR(20) + validate.isIn + Service 逻辑 | 中等工作量 |
| 频次规则扩展 | VARCHAR(30) + validate.isIn | 改 1 行 + Service 逻辑 |

> **结论**：由于 Ad System 的枚举字段全部使用 VARCHAR + Model 层校验（而非数据库 ENUM），扩展性极好。新增枚举值只需改 Model 代码，不需要 ALTER TABLE。

---

## 十四、Web 管理后台前端技术栈兼容性分析

### 14.1 技术栈实查

| 维度 | 实际技术 |
|---|---|
| 前端框架 | **Alpine.js 3.15.4**（非 Vue/React） |
| UI 库 | **Tailwind CSS 3.4.19**（自定义组件类名如 themed-card, themed-btn-primary） |
| 构建工具 | **Vite 6.4.1**（MPA 多页面应用） |
| HTTP 客户端 | **原生 Fetch API** 封装在 `admin/src/api/base.js` |
| 状态管理 | **Alpine.js 响应式数据**（无 Vuex/Pinia） |
| 图表 | **ECharts 6.0.0** |
| 页面模式 | MPA（每个管理模块一个 HTML 页面） |

### 14.2 兼容性评估

| 合并方案要求 | 与 Web 前端兼容性 | 说明 |
|---|---|---|
| category 筛选 Tab | **完全兼容** | Alpine.js 的 `x-show` + `@click` 可实现 Tab 切换 |
| 动态表单字段显示/隐藏 | **完全兼容** | Alpine.js 的 `x-show="category === 'system'"` 原生支持 |
| API 路径变更 | **完全兼容** | 修改 `SYSTEM_ENDPOINTS` 对象即可 |
| 字段名直接使用后端名 | **完全兼容** | Fetch 返回 JSON 直接用，无中间层 |
| 菜单合并 | **完全兼容** | MPA 架构下合并 HTML 页面或修改导航组件 |
| 数据报表按 category 筛选 | **完全兼容** | 现有 ECharts 报表已支持筛选参数 |

### 14.3 Web 前端不需要的改动

- 不需要引入新的前端框架或 UI 库
- 不需要修改构建配置
- 不需要引入状态管理库
- 不需要修改 API 客户端封装

### 14.4 Web 前端受影响的文件清单

| 文件路径 | 变更类型 | 优先级 |
|---|---|---|
| `admin/src/api/system/admin.js` | 修改 SYSTEM_ENDPOINTS | Phase 3 |
| `admin/src/modules/content/composables/banners.js` | 删除 | Phase 4 |
| `admin/src/modules/content/composables/carousel-items.js` | 删除 | Phase 4 |
| `admin/src/modules/content/composables/announcements.js` | 删除 | Phase 4 |
| `admin/src/modules/content/pages/ad-management.js` | 扩展（加 category Tab + 动态表单） | Phase 3 |
| `admin/content-management.html` | 删除或重定向到 ad-management | Phase 4 |

---

## 十五、修订后的实施步骤

> 基于数据库实查结果和后端技术栈重新排列，每个 Phase 标注责任方。

### Phase 1：数据库结构变更（后端，1 条 Sequelize migration）

```
-- 1. ad_campaigns 加 6 个字段
ALTER TABLE ad_campaigns ADD COLUMN campaign_category VARCHAR(20) NOT NULL DEFAULT 'commercial';
ALTER TABLE ad_campaigns ADD COLUMN frequency_rule VARCHAR(30) NULL DEFAULT 'once_per_day';
ALTER TABLE ad_campaigns ADD COLUMN frequency_value INT NULL DEFAULT 1;
ALTER TABLE ad_campaigns ADD COLUMN force_show TINYINT(1) NULL DEFAULT 0;
ALTER TABLE ad_campaigns ADD COLUMN internal_notes TEXT NULL;
ALTER TABLE ad_campaigns ADD COLUMN slide_interval_ms INT NULL DEFAULT 3000;

-- 2. ad_campaigns.advertiser_user_id 改 NULL
ALTER TABLE ad_campaigns MODIFY COLUMN advertiser_user_id INT NULL;

-- 3. ad_creatives 加 3 个字段
ALTER TABLE ad_creatives ADD COLUMN content_type VARCHAR(20) NOT NULL DEFAULT 'image';
ALTER TABLE ad_creatives ADD COLUMN text_content TEXT NULL;
ALTER TABLE ad_creatives ADD COLUMN display_mode VARCHAR(30) NULL;

-- 4. ad_creatives.image_url 改 NULL
ALTER TABLE ad_creatives MODIFY COLUMN image_url VARCHAR(500) NULL;

-- 5. 新建 ad_interaction_logs 通用交互日志表（D2 定论：方案 B）
CREATE TABLE ad_interaction_logs (
  ad_interaction_log_id BIGINT AUTO_INCREMENT PRIMARY KEY,
  ad_campaign_id INT NOT NULL,
  user_id INT NOT NULL,
  ad_slot_id INT NULL,
  interaction_type VARCHAR(20) NOT NULL COMMENT 'impression / click / close / swipe',
  extra_data JSON NULL COMMENT '异构扩展数据，如 show_duration_ms / close_method / is_manual_swipe 等',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_ail_campaign (ad_campaign_id),
  INDEX idx_ail_user (user_id),
  INDEX idx_ail_type (interaction_type),
  INDEX idx_ail_created (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 6. INSERT announcement 类型广告位
INSERT INTO ad_slots (slot_key, slot_name, slot_type, position, max_display_count,
  daily_price_diamond, min_bid_diamond, min_budget_diamond, is_active, description)
VALUES ('home_announcement', '首页公告位', 'announcement', 'home', 5, 0, 0, 0, 1, '首页系统公告展示位');
```

### Phase 2：数据迁移（后端，Node.js 迁移脚本）

1. 读取 2 条 popup_banners → 生成 2 条 ad_campaigns (campaign_category='operational') + 2 条 ad_creatives (content_type='image')
2. 读取 1 条 carousel_items → 生成 1 条 ad_campaigns (campaign_category='operational', 关联 home_carousel slot) + 1 条 ad_creatives
3. 读取 1 条 system_announcements → 生成 1 条 ad_campaigns (campaign_category='system') + 1 条 ad_creatives (content_type='text')
4. 读取 36 条 popup_show_logs → 插入 ad_interaction_logs（interaction_type='impression'，extra_data 存 `{ show_duration_ms, close_method, queue_position }`）
5. 读取 11 条 carousel_show_logs → 插入 ad_interaction_logs（interaction_type='impression'，extra_data 存 `{ exposure_duration_ms, is_manual_swipe, is_clicked }`）
6. 验证迁移数据正确性（COUNT 校验）

### Phase 3：Model + Service + Route 层改造（后端）

1. **修改 AdCampaign Model**：新增 6 个字段定义 + 扩展 validate.isIn（billing_mode 加 'free'，priority max 改 999）+ 新增 byCategory scope
2. **修改 AdCreative Model**：新增 3 个字段定义 + 扩展 link_type validate.isIn + image_url 改 allowNull + 条件校验
3. **修改 AdSlot Model**：slot_type validate.isIn 加 'announcement'
4. **新建 AdInteractionLog Model**：对应 `ad_interaction_logs` 表（D2 定论：方案 B），字段 interaction_type + extra_data JSON
5. **扩展 AdCampaignService**：新增 `createOperationalCampaign()` + `createSystemCampaign()` 方法（D1 定论：创建后 status='draft'，手动发布切 active）
6. **修改 AdBiddingService.selectWinners()**：三层优先级出队逻辑
7. **扩展 console ad-campaigns 路由**：支持 `?category=` 筛选
8. **新建 `routes/v4/system/ad-delivery.js` 路由**：统一前端内容获取接口（D5 定论：与 ad-events 职责分离）

### Phase 4：废弃代码清理（后端）

1. 删除 3 个 Service 文件 + 5 个 Model 文件 + 6 个 Route 文件 + 2 个 Test 文件（共 16 个文件）
2. 更新 `services/index.js` 注销 popup_banner / carousel_item / announcement 服务
3. 更新 `app.js` 移除旧路由注册
4. 更新 `models/index.js` 移除旧 Model 引用

### Phase 5：Web 管理后台前端改造

1. 修改 `admin/src/api/system/admin.js` — SYSTEM_ENDPOINTS 指向新路由
2. 扩展 `ad-management.js` — 加 category Tab（系统通知 / 运营推广 / 商业广告）
3. 新增动态表单逻辑 — Alpine.js `x-show` 按 category 显示/隐藏字段
4. 删除 banners.js / carousel-items.js / announcements.js 三个 composable
5. 删除或重定向 content-management.html

### Phase 6：微信小程序前端改造（独立项目）

1. 修改弹窗/轮播/公告 3 个接口路径 → 统一调用 `/api/v4/system/ad-events`
2. 修改响应字段解析 — 直接使用后端 ad_campaign_id / campaign_name 等字段名
3. 展示日志上报改为 ad_interaction_log 接口（D2 定论：新建通用交互表）
4. 验证 frequency_rule / link_type 兼容性

### Phase 7：DROP 废弃表（后端，最终清理）

```
DROP TABLE IF EXISTS popup_show_logs;
DROP TABLE IF EXISTS carousel_show_logs;
DROP TABLE IF EXISTS popup_banners;
DROP TABLE IF EXISTS carousel_items;
DROP TABLE IF EXISTS system_announcements;
```

---

## 十六、2026-02-22 真实数据库 + 代码二次校验结果

> 校验方式：Node.js `require('sequelize')` 直连 `restaurant_points_dev`（host: dbconn.sealosbja.site:42569），逐表 `DESCRIBE` + `SELECT COUNT(*)` + `SELECT *` 全量对比。非引用任何历史报告。

### 16.1 数据量二次校验（全部一致）

| 表名 | 文档记录数 | 实查记录数 | 状态 |
|---|---|---|---|
| `popup_banners` | 2 | 2 | ✅ 一致 |
| `popup_show_logs` | 36 | 36 | ✅ 一致 |
| `carousel_items` | 1 | 1 | ✅ 一致 |
| `carousel_show_logs` | 11 | 11 | ✅ 一致 |
| `system_announcements` | 1 | 1 | ✅ 一致 |
| `ad_slots` | 6 | 6 | ✅ 一致 |
| `ad_campaigns` | 2 | 2 | ✅ 一致 |
| `ad_creatives` | 0 | 0 | ✅ 一致 |
| `ad_attribution_logs` | 4 | 4 | ✅ 一致 |
| `user_ad_tags` | 5 | 5 | ✅ 一致 |
| `ad_interaction_logs` | — | **表不存在** | ✅ 预期（Phase 1 才创建） |

### 16.2 字段类型二次校验

| 字段 | 文档描述 | 实查结果 | 状态 |
|---|---|---|---|
| `ad_campaigns.billing_mode` | VARCHAR(20) | VARCHAR(20) | ✅ |
| `ad_campaigns.status` | VARCHAR(20) | VARCHAR(20) | ✅ |
| `ad_campaigns.advertiser_user_id` | INT NOT NULL | INT NOT NULL | ✅ |
| `ad_campaigns.priority` | Model max:99 | Model `max: { args: [99] }` | ✅ |
| `ad_slots.slot_type` | VARCHAR(20) | VARCHAR(20) | ✅ |
| `ad_creatives.link_type` | VARCHAR(20) | VARCHAR(20) | ✅ |
| `ad_creatives.image_url` | VARCHAR(500) NOT NULL | VARCHAR(500) NOT NULL | ✅ |
| `popup_banners.link_type` | DB ENUM | `enum('none','page','miniprogram','webview')` | ✅ |
| `popup_banners.display_mode` | DB ENUM | `enum('wide','horizontal','square','tall','slim','full_image')` | ✅ |
| `carousel_items.link_type` | DB ENUM | `enum('none','page','miniprogram','webview')` | ✅ |
| `carousel_items.display_mode` | DB ENUM | `enum('wide','horizontal','square')` | ✅ |

### 16.3 Model 层校验值二次确认

| Model 文件 | 常量 | 实查值 | 合并后需要变更 |
|---|---|---|---|
| `AdCampaign.js` | `VALID_BILLING_MODES` | `['fixed_daily', 'bidding']` | 加 `'free'` |
| `AdCampaign.js` | `VALID_CAMPAIGN_STATUSES` | `['draft','pending_review','approved','active','paused','completed','rejected','cancelled']` | 不变 |
| `AdCreative.js` | `VALID_LINK_TYPES` | `['none', 'external', 'internal', 'app_page']` | **替换为** `['none', 'page', 'miniprogram', 'webview']`（D3 定论） |
| `AdCreative.js` | `VALID_REVIEW_STATUSES` | `['pending', 'approved', 'rejected']` | 不变 |
| `AdSlot.js` | `VALID_SLOT_TYPES` | `['popup', 'carousel']` | 加 `'announcement'` |

### 16.4 现有代码合并逻辑确认

`PopupBannerService.getActiveBanners()`（第 160-193 行）已经在做合并：先查 popup_banners 表取运营弹窗，再调用 `AdBiddingService.selectWinners(slotKey, user_id)` 取广告竞价中标结果，两者拼接返回给前端。这证实了文档第 0.2 节的判断——展示层已经是一体的，管理层分裂。

### 16.5 现有 ad-events 路由文件实查

`routes/v4/system/ad-events.js` 当前 **只有 4 个 POST 端点**（弹窗展示日志、轮播展示日志、广告曝光上报、广告点击上报），**没有 GET 端点**。D5 定论：新建 `ad-delivery.js` 负责内容获取（GET），ad-events 保持纯事件上报（POST），职责分离。

### 16.6 ad_slots 现有种子数据确认

| ad_slot_id | slot_key | slot_type | position | daily_price_diamond |
|---|---|---|---|---|
| 3 | lottery_popup | popup | lottery | 80 |
| 4 | profile_popup | popup | profile | 50 |
| 7 | lottery_popup_ad | popup | lottery | 200 |
| 8 | profile_carousel | carousel | profile | 100 |
| 11 | home_popup | popup | home | 100 |
| 12 | home_carousel | carousel | home | 60 |

Phase 1 需要 INSERT `home_announcement`（slot_type='announcement'）。目前无 announcement 类型广告位。

---

## 十七、微信小程序前端求证清单

> 本节基于后端数据库 + 代码实查结果，为微信小程序前端提供接口变更的明确规格。**后端为权威，前端直接使用后端字段名，不做任何映射。**

### 17.1 接口路径变更（Before → After）

| 功能 | 当前路径 | 合并后路径 | 方法 | 说明 |
|---|---|---|---|---|
| 获取首页弹窗 | `GET /api/v4/system/popup-banners/active?position=home` | `GET /api/v4/system/ad-delivery?slot_type=popup&position=home` | GET | 见 D5 |
| 获取首页轮播 | `GET /api/v4/system/carousel-items/active?position=home` | `GET /api/v4/system/ad-delivery?slot_type=carousel&position=home` | GET | 见 D5 |
| 获取系统公告 | `GET /api/v4/system/announcements/active` | `GET /api/v4/system/ad-delivery?slot_type=announcement` | GET | 见 D5 |
| 弹窗展示日志 | `POST /api/v4/system/ad-events/popup-banners/show-log` | `POST /api/v4/system/ad-events/interaction-log` | POST | 统一交互日志（D2） |
| 轮播展示日志 | `POST /api/v4/system/ad-events/carousel-items/show-log` | `POST /api/v4/system/ad-events/interaction-log` | POST | 统一交互日志（D2） |
| 广告曝光上报 | `POST /api/v4/system/ad-events/impressions` | **不变** | POST | commercial 逻辑不动 |
| 广告点击上报 | `POST /api/v4/system/ad-events/clicks` | **不变** | POST | commercial 逻辑不动 |

### 17.2 统一内容获取接口规格（后端提供，前端适配）

**请求**：

```
GET /api/v4/system/ad-delivery?slot_type=popup&position=home
Headers: Authorization: Bearer <JWT>
```

Query 参数（全部后端定义）：

| 参数 | 类型 | 必填 | 说明 |
|---|---|---|---|
| `slot_type` | string | 是 | 广告位类型：`popup` / `carousel` / `announcement` |
| `position` | string | 否 | 位置：`home` / `lottery` / `profile`（默认 home） |

**响应**（后端字段名，前端直接使用）：

```json
{
  "success": true,
  "code": "SUCCESS",
  "data": {
    "items": [
      {
        "ad_campaign_id": 15,
        "campaign_name": "春节活动弹窗",
        "campaign_category": "operational",
        "ad_creative_id": 3,
        "title": "春节大促",
        "content_type": "image",
        "image_url": "https://objectstorageapi.bja.sealos.run/br0za7uc-tiangong/popup-banners/xxx.jpg",
        "image_width": 819,
        "image_height": 1092,
        "text_content": null,
        "link_url": "/pages/activity/index",
        "link_type": "page",
        "display_mode": "tall",
        "frequency_rule": "once_per_day",
        "frequency_value": 1,
        "force_show": false,
        "priority": 500,
        "slide_interval_ms": null,
        "start_date": "2026-02-10",
        "end_date": "2026-02-28"
      }
    ],
    "slot_type": "popup",
    "position": "home",
    "total": 1
  },
  "timestamp": "2026-02-22T20:00:00.000+08:00"
}
```

**announcement 类型特殊字段**：

```json
{
  "content_type": "text",
  "image_url": null,
  "text_content": "为提升系统性能，将于今晚进行系统维护",
  "display_mode": null,
  "force_show": true,
  "priority": 999
}
```

### 17.3 统一交互日志上报接口规格

**请求**：

```
POST /api/v4/system/ad-events/interaction-log
Headers: Authorization: Bearer <JWT>
Content-Type: application/json
```

**请求体**（后端定义字段名）：

| 字段 | 类型 | 必填 | 说明 |
|---|---|---|---|
| `ad_campaign_id` | int | 是 | 来自内容获取接口返回的 `ad_campaign_id` |
| `interaction_type` | string | 是 | `impression` / `click` / `close` / `swipe` |
| `extra_data` | object | 否 | 扩展数据 JSON |

**弹窗场景 extra_data**：

```json
{
  "show_duration_ms": 5000,
  "close_method": "manual",
  "queue_position": 1
}
```

**轮播场景 extra_data**：

```json
{
  "exposure_duration_ms": 3000,
  "is_manual_swipe": true,
  "is_clicked": false
}
```

### 17.4 微信小程序字段名变更清单（直接使用后端名，不做映射）

| 当前前端使用 | 改为后端字段名 | 来源 |
|---|---|---|
| `popup_banner_id` | `ad_campaign_id` | 内容获取接口响应 |
| `banner_type` | `campaign_category` | 内容获取接口响应 |
| `display_mode`（从 popup_banners） | `display_mode`（从 ad_creatives） | 字段名不变，来源表变了 |
| `frequency_rule`（从 popup_banners） | `frequency_rule`（从 ad_campaigns） | 字段名不变，来源表变了 |
| `frequency_value`（从 popup_banners） | `frequency_value`（从 ad_campaigns） | 字段名不变，来源表变了 |
| `force_show`（从 popup_banners） | `force_show`（从 ad_campaigns） | 字段名不变，来源表变了 |
| `carousel_item_id` | `ad_campaign_id` | 内容获取接口响应 |
| `slide_interval_ms`（从 carousel_items） | `slide_interval_ms`（从 ad_campaigns） | 字段名不变，来源表变了 |
| `system_announcement_id` | `ad_campaign_id` | 内容获取接口响应 |
| `content`（公告内容） | `text_content` | ad_creatives 新字段 |
| `type`（system/activity/maintenance/notice） | 映射到 `priority` 数值范围 | 不再有 type 字段 |
| `expires_at` | `end_date` | ad_campaigns 字段 |
| `view_count` | 不返回（通过 ad_interaction_logs COUNT 聚合） | 后端按需查询 |

### 17.5 link_type 枚举值确认（D3 定论，与微信原生一致）

| 值 | 含义 | 微信 API 对应 | 小程序处理 |
|---|---|---|---|
| `none` | 无跳转 | — | 不做任何跳转 |
| `page` | 小程序内页面 | `wx.navigateTo` | `wx.navigateTo({ url: link_url })` |
| `miniprogram` | 跳转其他小程序 | `wx.navigateToMiniProgram` | `wx.navigateToMiniProgram({ appId: link_url })` |
| `webview` | H5 页面 | `web-view` 组件 | `wx.navigateTo({ url: '/pages/webview/index?url=' + link_url })` |

当前 PopupBanner / CarouselItem 表的 DB ENUM 已经是 `('none','page','miniprogram','webview')`，小程序端已经在用这套值。合并后 **小程序 link_type 处理逻辑零改动**。

### 17.6 frequency_rule 行为确认

| 值 | 含义 | 小程序端行为 | 合并后变化 |
|---|---|---|---|
| `always` | 每次都显示 | 不做本地缓存判断 | 无变化 |
| `once` | 只显示一次 | 永久缓存 banner ID | **ID 从 popup_banner_id 改为 ad_campaign_id** |
| `once_per_session` | 每次启动显示一次 | 会话级缓存 | ID 改为 ad_campaign_id |
| `once_per_day` | 每天显示一次 | 按日期+ID 缓存 | ID 改为 ad_campaign_id |
| `once_per_n_days` | 每 N 天一次 | 按日期+N+ID 缓存 | ID 改为 ad_campaign_id |
| `n_times_total` | 总共显示 N 次 | 按 ID 计数缓存 | ID 改为 ad_campaign_id |

**小程序唯一改动**：本地缓存 key 中的 `popup_banner_id` 替换为 `ad_campaign_id`。频次判断逻辑不变。

### 17.7 无需改动项确认

| 项目 | 原因 |
|---|---|
| link_type 处理逻辑 | D3 定论已与微信原生一致，PopupBanner 和 CarouselItem 已在用 `page/miniprogram/webview` |
| 图片 URL 处理 | 后端继续通过 `getImageUrl()` 返回完整 URL，前端直接 `<image src="">` |
| JWT 认证流程 | 不变 |
| 错误处理 | 后端继续用 `res.apiSuccess()` / `res.apiError()` 统一格式 |

---

## 十八、决策项 D5-D7 — 行业横向对比与定论（全部已确认）

> D1-D4 定论见第十二节。D5-D7 于 2026-02-22 经用户确认，全部 7 项决策已定论，无待决项。

### D5：统一内容获取端点路径命名（已确认：方案 B）

**背景**：文档第十五节 Phase 3 第 8 步提出在 `routes/v4/system/ad-events.js` 中新增 GET 端点。但二次校验发现该文件当前 **只有 4 个 POST 端点**（事件上报），语义是"上报事件"。往里面加"获取内容"的 GET 接口，职责混淆。

**行业做法 — 内容投放 vs 事件上报的端点分离**：

| 公司/平台 | 内容投放（Delivery）端点 | 事件上报（Tracking）端点 | 是否分离 |
|---|---|---|---|
| **Google Ad Manager** | `GET /ad-delivery` (Ad Serving Request) | `POST /ad-event` (Beacon/Pixel) | **分离**，两套独立服务 |
| **美团** | `GET /api/promotion/feed` (运营位内容下发) | `POST /api/event/track` (曝光/点击) | **分离**，不同域名 |
| **阿里（阿里妈妈）** | `GET /api/ad/render` (广告渲染数据) | `POST /api/ad/trace` (曝光点击上报) | **分离**，render 与 trace 职责清晰 |
| **腾讯广点通** | `GET /ad_pull` (拉取广告) | `POST /ad_action` (行为上报) | **分离**，pull 读 / action 写 |
| **字节跳动（巨量引擎）** | `GET /api/content/delivery` | `POST /api/content/event` | **分离**，delivery 只读 / event 只写 |
| **Kevel（海外 AdTech SaaS）** | `GET /api/v2/decisions` (Decision API) | `POST /api/v2/events` (Event API) | **分离**，decisions = 读，events = 写 |
| **游戏公司（米哈游/网易）** | `GET /api/notice/list` (公告列表) | `POST /api/event/report` (行为上报) | **分离**，notice 独立模块 |
| **活动策划平台** | `GET /api/campaign/serve` | `POST /api/campaign/track` | **分离**，serve 下发 / track 上报 |
| **二手/虚拟物品交易平台** | `GET /api/banner/active` (运营位) | `POST /api/analytics/event` | **分离**，banner 独立于 analytics |
| **小公司起步期** | `GET+POST /api/ad` (混合) | 同一文件 | **不分离**，后期必然重构拆分 |

**行业共识**：所有成熟平台都将"内容下发"（GET/读操作）与"事件上报"（POST/写操作）分离到不同端点。混合在一起是技术债务的典型来源。

**本项目适配分析**：

后端现有 route 文件的命名规范是 `{domain}-{resource}.js`：
- `ad-campaigns.js` — 管理广告计划
- `ad-slots.js` — 管理广告位
- `ad-events.js` — 事件上报（POST only）
- `ad-reports.js` — 报表查询

新建 `ad-delivery.js` 完全符合现有命名体系，一个文件一个职责。

**选项对比**：

| 方案 | 路径 | 行业对标 | 长期维护成本 | 与现有技术栈契合度 |
|---|---|---|---|---|
| A — 混入 ad-events | `GET /api/v4/system/ad-events` | 小公司起步期做法 | 高（读写混合，后期必拆） | 差（破坏 ad-events 的纯写职责） |
| **B — 新建 ad-delivery** | `GET /api/v4/system/ad-delivery` | **Google/美团/阿里/字节/Kevel** 做法 | **最低**（职责单一，永不拆分） | **最佳**（符合 `ad-*` 命名规范） |
| C — 新建 content-feeds | `GET /api/v4/system/content-feeds` | 游戏公司/活动平台做法 | 低 | 一般（打破 `ad-*` 命名一致性） |

**定论：方案 B — 新建 `routes/v4/system/ad-delivery.js`**

理由：
1. 行业 100% 共识——投放下发与事件上报必须分离，没有例外
2. 与现有 `ad-campaigns` / `ad-slots` / `ad-events` / `ad-reports` 命名体系完全一致
3. 项目未上线，一步到位建立正确的架构，避免上线后因混合职责被迫重构
4. 后端工作量仅 1 个新 route 文件（~100 行），在 `routes/v4/system/index.js` 中加一行 `router.use('/ad-delivery', adDeliveryRoutes)`

**影响**：
- 后端 B13 更新：新建 `routes/v4/system/ad-delivery.js`（替代原方案"扩展 ad-events"）
- Web 前端 W7 更新：SYSTEM_ADMIN_ENDPOINTS 新增 `AD_DELIVERY` 端点
- 小程序 M1/M2/M3 更新：统一调用 `/api/v4/system/ad-delivery`
- 第十七节接口规格已按方案 B 编写

---

### D6：priority 范围是否在 Service 层按 category 强制校验（已确认：方案 B）

**背景**：文档第 2.6 节定义了 priority 范围约定：commercial 1-99、operational 100-899、system 900-999。当前 AdCampaign Model 校验是 `min:1, max:99`，合并后需扩到 `max:999`。问题是：范围分段是仅靠文档约定还是代码强制？

**行业做法 — 内容优先级分段校验策略**：

| 公司/平台 | 优先级分段方式 | 校验位置 | 是否强制 | 默认值逻辑 |
|---|---|---|---|---|
| **Google Ad Manager** | Line Item Type 自带优先级层级（Sponsorship=4, Standard=6, House=16） | **系统内置强制** | 是，type 决定 priority tier | 用户只选 type，系统自动映射 priority |
| **美团** | 内部 Action 有 type 字段，priority 范围按 type 自动限定 | **Service 层强制** | 是 | operational 默认 500，system 默认 900 |
| **阿里** | material_type 决定 priority 分区，代码层面校验 | **Service 层强制** | 是 | 按 type 自动填充默认值 |
| **腾讯广点通** | 品牌保量 > 效果竞价 > 运营位，系统自动排序 | **竞价引擎层强制** | 是 | 用户不直接填 priority 数字 |
| **字节跳动** | campaign_type 映射到 priority_tier，用户在 tier 内微调 | **Service 层强制** + tier 内自由 | 是 | 系统分配 tier 默认值，tier 内可调 |
| **Kevel** | Flight 的 priority_type（Paid/House/Promo）决定 tier | **系统内置** | 是 | 按 type 自动映射 |
| **游戏公司** | system 公告强制置顶，activity 按权重排序，广告最低 | **代码层面强制** | 是 | 系统公告固定 999 |
| **活动策划平台** | 活动类型决定展示层级，不允许低级别覆盖高级别 | **Service 层** | 是 | 按类型自动分配 |
| **虚拟物品/二手平台** | 推荐位 > 运营位 > 普通列表，有强制分层 | **Service 层** | 是 | 付费推荐位强制置顶 |
| **小公司（无校验）** | 文档约定，不做代码校验 | 无 | 否 | 经常误操作导致 bug |

**行业共识**：所有成熟公司都在 Service 层或系统层强制校验优先级分段。仅靠文档约定的做法只出现在早期小公司，且必然在运营误操作后被迫加上校验——这就是技术债务。

**选项对比**：

| 方案 | 校验方式 | 行业对标 | 误操作风险 | 代码量 | 长期维护成本 |
|---|---|---|---|---|---|
| A — 仅文档约定 | 无代码校验 | 早期小公司 | 高（运营输错 priority 导致排序混乱） | 0 | 高（必然补救） |
| **B — Service 层强制** | `createOperationalCampaign()` 限 100-899 | **美团/阿里/字节/Kevel** | **零** | ~20 行 | **最低** |
| C — 自动填充+不限制 | 默认值 500/950，但允许手动覆盖任意值 | 部分游戏公司 | 低（多数场景用默认值） | ~10 行 | 中 |

**本项目适配分析**：

后端现有 `AdCampaignService.js` 已有 `createCampaign()` 方法处理 commercial 类型。合并方案新增 `createOperationalCampaign()` 和 `createSystemCampaign()` 两个方法（第四节 4.1）。在这两个新方法中加入 priority 范围校验，代码改动集中在 1 个 Service 文件的 2 个方法中，完全不影响 `createCampaign()` 的 commercial 逻辑。

实现方式（伪代码）：
- `createOperationalCampaign()`: 若传入 priority 不在 100-899 范围 → 抛出参数校验错误；若未传入 → 默认 500
- `createSystemCampaign()`: 若传入 priority 不在 900-999 范围 → 抛出参数校验错误；若未传入 → 默认 950
- `createCampaign()` (commercial): 保持现有 1-99 校验不变

**定论：方案 B — Service 层强制校验**

理由：
1. 行业 100% 共识——优先级分段必须代码强制，不能靠文档约定
2. 代码改动仅 ~20 行，集中在 2 个新方法中，不影响任何现有逻辑
3. 项目未上线，不存在"灵活调整"的需求（上线后如有特殊需求可以放宽单个 category 的范围）
4. 与 Google Ad Manager 的"type 决定 priority tier"思路完全一致，是最成熟的做法

---

### D7：旧路由是否保留 410 过渡期（已确认：方案 A）

**背景**：文档第十五节 Phase 4 直接删除 6 个旧路由文件。是否需要保留过渡期？

**行业做法 — 接口废弃策略**：

| 场景 | 公司做法 | 保留旧接口 | 理由 |
|---|---|---|---|
| **线上有用户，灰度发版** | 美团/阿里/腾讯 | 是，301 重定向 + 3-6 个月废弃 | 避免线上用户报错 |
| **线上有用户，全量发版** | 字节跳动/京东 | 是，410 Gone + 1-4 周废弃 | 客户端版本更新有滞后 |
| **线上有用户，App 强制更新** | 游戏公司（停服更新） | 否，直接删除 | 强制更新保证一致性 |
| **未上线项目** | **所有公司** | **否，直接删除** | 无线上用户，不存在兼容需求 |
| **小程序审核期间** | 微信生态项目 | 新旧并行 1 天 | 小程序审核通过前旧版仍在线 |

**本项目情况**：项目未上线，无线上用户。微信小程序未提交审核，不存在"旧版本仍在线"的问题。

**选项对比**：

| 方案 | 做法 | 行业对标 | 额外代码 | 额外维护 |
|---|---|---|---|---|
| **A — 直接删除** | Phase 4 直接删 16 个文件 | **所有未上线项目的标准做法** | 0 | 0 |
| B — 保留 410 一周 | 旧路由返回 410 + 迁移指引 | 线上项目的做法（对未上线项目过度工程） | ~60 行 | 一周后再删一次 |

**定论：方案 A — 直接删除，前后端同步部署**

理由：
1. 项目未上线，无线上用户——这一条就决定了不需要任何过渡
2. 保留 410 是线上项目的做法，对未上线项目是过度工程（over-engineering）
3. 所有公司对未上线项目都是直接删除，没有例外
4. 部署步骤：先部署后端（Phase 1-4），再部署 Web 前端（Phase 5），最后提交小程序审核（Phase 6）。三端按顺序而非并行，不存在接口不匹配窗口

---

## 十九、后端技术栈可复用能力清单（二次校验确认）

> 基于 `package.json`、`services/index.js`、`app.js`、`models/*.js` 逐文件确认。

### 19.1 技术栈全景

| 层级 | 技术 | 版本 | 复用程度 |
|---|---|---|---|
| 运行时 | Node.js | ≥20.18.0 | 全局 |
| Web 框架 | Express | 4.18.2 | 全局 |
| ORM | Sequelize | 6.35.2 | 全局，所有 Model 使用 |
| 数据库 | MySQL | 外部（Sealos） | 通过 mysql2 3.6.5 驱动 |
| 缓存 | Redis (ioredis) | 5.7.0 | 按需 |
| 认证 | JWT (jsonwebtoken) | 9.0.2 | 全局中间件 |
| 文件存储 | Sealos 对象存储 (aws-sdk) | 2.1691.0 | 图片上传 |
| 定时任务 | node-cron | 3.0.3 | 广告/内容过期清理 |
| 实时通信 | Socket.IO | 4.8.1 | WebSocket |
| 日志 | Winston | 3.11.0 | 全局 |
| 参数校验 | Joi | 17.11.0 | Route 层 |
| 数据库迁移 | Sequelize CLI | 6.6.2 | migration |

### 19.2 合并方案对现有技术栈的依赖（全部已有，零新依赖）

| 合并动作 | 依赖的现有能力 | 验证状态 |
|---|---|---|
| ALTER TABLE + 新字段 | Sequelize CLI migration | ✅ `npm run db:migrate` 已就绪 |
| 新 Model 字段定义 | Sequelize DataTypes + validate.isIn | ✅ AdCampaign/AdCreative/AdSlot 已使用 |
| 新 Service 方法 | ServiceManager 注册 + snake_case 键 | ✅ `services/index.js` 已有模式 |
| 新 Route 文件 | Express Router + asyncHandler + authenticateToken | ✅ 所有 route 已使用 |
| 统一响应格式 | `res.apiSuccess()` / `res.apiError()` 中间件 | ✅ 已全局挂载 |
| 图片 URL 处理 | `utils/imageUtils.js` `getImageUrl()` | ✅ PopupBannerService 已在用 |
| 北京时间 | `utils/timeHelper.js` BeijingTimeHelper | ✅ 所有 Model hooks 已在用 |
| 分页 | `findAndCountAll` + `page/limit` | ✅ 所有 console 路由已在用 |
| 幂等性 | `business_id` 唯一约束 | ✅ AdCampaign 已有 |

**结论**：合并方案不引入任何新的 npm 依赖，完全基于现有技术栈。

### 19.3 Web 管理后台前端技术栈兼容性二次确认

| 维度 | 实际技术 | 二次确认 |
|---|---|---|
| 框架 | Alpine.js 3.15.4 | ✅ `admin/package.json` 确认 |
| UI | Tailwind CSS 3.4.19 | ✅ 确认 |
| 构建 | Vite 6.4.1 MPA | ✅ 确认 |
| HTTP | 原生 Fetch 封装 `admin/src/api/base.js` | ✅ 确认 |
| 端点定义 | `SYSTEM_ADMIN_ENDPOINTS` 在 `admin/src/api/system/admin.js` | ✅ 确认 |

Web 前端合并改动清单（与第十四节一致，二次确认）：

| 文件 | 操作 | Alpine.js 兼容性 |
|---|---|---|
| `admin/src/api/system/admin.js` | 修改 SYSTEM_ADMIN_ENDPOINTS | ✅ 直接改端点字符串 |
| `admin/src/modules/content/pages/ad-management.js` | 加 category Tab | ✅ `x-show="category==='system'"` |
| `admin/src/modules/content/composables/banners.js` | 删除 | ✅ |
| `admin/src/modules/content/composables/carousel-items.js` | 删除 | ✅ |
| `admin/src/modules/content/composables/announcements.js` | 删除 | ✅ |
| `admin/content-management.html` | 删除或重定向 | ✅ |

**结论**：合并方案完全兼容 Web 前端 Alpine.js + Tailwind + Vite MPA 技术栈，不需要引入新框架或改构建配置。

---

## 二十、实施完成状态（2026-02-22）

> 全部 7 个 Phase 已实施完成。后端数据库项目 + Web 管理后台前端项目均已改造完毕。微信小程序前端项目待对接。

### 20.1 Phase 完成状态

| Phase | 内容 | 状态 | 完成时间 |
|---|---|---|---|
| Phase 1 | 数据库结构变更（6 字段 + 约束变更 + ad_interaction_logs 表 + 种子数据） | ✅ 已完成 | 2026-02-22 |
| Phase 2 | 数据迁移（3 条 operational + 1 条 system + 56 条交互日志） | ✅ 已完成 | 2026-02-22 |
| Phase 3 | Model + Service + Route 层改造 | ✅ 已完成 | 2026-02-22 |
| Phase 4 | 废弃代码清理（18 个旧文件已删除） | ✅ 已完成 | 2026-02-22 |
| Phase 5 | Web 管理后台前端改造（API 端点 / 导航 / composables） | ✅ 已完成 | 2026-02-22 |
| Phase 6 | 微信小程序前端改造 | ⏳ 待对接 | — |
| Phase 7 | DROP 5 张废弃表 | ✅ 已完成 | 2026-02-22 |

### 20.2 后端改造文件清单

**新建文件（3 个）：**

| 文件 | 说明 |
|---|---|
| `models/AdInteractionLog.js` | 统一交互日志模型（D2 定论方案 B） |
| `services/AdInteractionLogService.js` | 统一交互日志服务 |
| `routes/v4/system/ad-delivery.js` | 统一内容获取路由（D5 定论，GET only） |

**修改文件（10 个）：**

| 文件 | 变更内容 |
|---|---|
| `models/AdCampaign.js` | 新增 campaign_category + 6 个字段定义、扩展 validate.isIn、新增 byCategory scope |
| `models/AdCreative.js` | 新增 content_type/text_content/display_mode 字段、link_type 替换为微信系命名（D3 定论） |
| `models/AdSlot.js` | slot_type validate.isIn 新增 'announcement' |
| `models/index.js` | 移除 5 个旧模型注册、新增 AdInteractionLog 注册 |
| `services/AdCampaignService.js` | 新增 createOperationalCampaign + createSystemCampaign + publishCampaign、扩展 campaign_category 筛选 |
| `services/AdBiddingService.js` | 三层优先级出队逻辑（system → operational → commercial） |
| `services/index.js` | 移除 5 个旧服务注册、新增 ad_interaction_log 注册 |
| `routes/v4/system/ad-events.js` | 新增统一交互日志上报端点、移除旧独立上报端点 |
| `routes/v4/system/index.js` | 移除旧路由挂载、新增 ad-delivery 挂载 |
| `routes/v4/console/ad-campaigns.js` | 新增 category 筛选、operational/system 创建端点、publish 端点、interaction-stats 端点 |

**删除文件（18 个）：**

| 类型 | 文件 |
|---|---|
| Model（5） | PopupBanner.js、PopupShowLog.js、CarouselItem.js、CarouselShowLog.js、SystemAnnouncement.js |
| Service（5） | PopupBannerService.js、CarouselItemService.js、AnnouncementService.js、PopupShowLogService.js、CarouselShowLogService.js |
| Route（6） | system/popup-banners.js、system/carousel-items.js、system/announcements.js、console/popup-banners.js、console/carousel-items.js、console/system/announcements.js |
| Test（2） | PopupBannerService.test.js、AnnouncementService.test.js |

### 20.3 Web 管理后台前端改造文件清单

**修改文件（4 个）：**

| 文件 | 变更内容 |
|---|---|
| `admin/src/api/system/admin.js` | 移除旧端点（POPUP_BANNER_*、CAROUSEL_ITEM_*、ANNOUNCEMENT_*），新增合并端点（AD_CAMPAIGN_OPERATIONAL_CREATE、AD_CAMPAIGN_SYSTEM_CREATE、AD_CAMPAIGN_PUBLISH、AD_CAMPAIGN_INTERACTION_STATS） |
| `admin/src/alpine/components/sidebar-nav.js` | "公告弹窗管理"→移除，"广告系统"→"内容投放管理" |
| `admin/src/modules/content/composables/index.js` | 移除旧模块导出，保留图片/客服/反馈/座席模块 |
| `admin/src/modules/content/pages/content-management.js` | 精简为仅保留图片资源管理子模块 |

**删除文件（3 个）：**

| 文件 | 说明 |
|---|---|
| `admin/src/modules/content/composables/banners.js` | 弹窗管理已合并到 ad-campaigns |
| `admin/src/modules/content/composables/carousel-items.js` | 轮播图管理已合并到 ad-campaigns |
| `admin/src/modules/content/composables/announcements.js` | 公告管理已合并到 ad-campaigns |

### 20.4 API 验证结果

| 端点 | 方法 | 结果 | 说明 |
|---|---|---|---|
| `/api/v4/system/ad-delivery?slot_type=popup&position=home` | GET | ✅ 成功（1 条） | 统一内容获取 — 弹窗 |
| `/api/v4/system/ad-delivery?slot_type=carousel&position=home` | GET | ✅ 成功（1 条） | 统一内容获取 — 轮播 |
| `/api/v4/system/ad-delivery?slot_type=announcement` | GET | ✅ 成功（0 条，system 类型为 paused） | 统一内容获取 — 公告 |
| `/api/v4/console/ad-campaigns` | GET | ✅ 成功（6 条） | 全部计划列表 |
| `/api/v4/console/ad-campaigns?campaign_category=operational` | GET | ✅ 成功（3 条） | 按分类筛选 — 运营内容 |
| `/api/v4/system/ad-events/interaction-log` | POST | ✅ 成功（log_id=60） | 统一交互日志上报 |
| `/health` | GET | ✅ healthy | 健康检查通过 |

### 20.5 微信小程序前端对接指引

微信小程序前端团队请参照 **第十七节** 的接口规格进行对接，核心变更：

1. **接口路径变更**：3 个 GET 接口合并为 `/api/v4/system/ad-delivery`（见 17.1 节）
2. **响应字段变更**：直接使用后端 `ad_campaign_id`/`campaign_name` 等字段名（见 17.4 节）
3. **日志上报变更**：2 个 POST 接口合并为 `/api/v4/system/ad-events/interaction-log`（见 17.3 节）
4. **link_type 零改动**：已与微信原生一致 `page/miniprogram/webview`（见 17.5 节）
5. **频次控制字段名不变**：`frequency_rule`/`frequency_value` 来源表变化，字段名保持一致（见 17.6 节）
