# è¿è¥åå°ä¼˜åŒ– - åç«¯éœ€æ±‚æ–‡æ¡£

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.5ï¼ˆå¾…å®Œæˆå·¥ä½œæ¸…å•ç‰ˆï¼‰  
> **åˆ›å»ºæ—¥æœŸ**: 2026-02-03  
> **æœ€åæ›´æ–°**: 2026-02-03ï¼ˆæ–°å¢å¾…å®Œæˆå·¥ä½œæ¸…å•ã€ä¼˜å…ˆçº§æ’åºï¼‰  
> **åŸºäºæ¥æº**: è¿è¥åå°ä¼˜åŒ–æ–¹æ¡ˆ.md v1.8  
> **åŸä¼°æ€»å·¥æ—¶**: 25.5å¤©  
> **å¤ç”¨åå·¥æ—¶**: **6å¤©**ï¼ˆèŠ‚çœ 76.5%ï¼‰  

---

## ğŸš€ åç«¯å¾…å®Œæˆå·¥ä½œæ¸…å•ï¼ˆæ‰§è¡Œæ‘˜è¦ï¼‰

> **æ€»å‰©ä½™å·¥æ—¶**: 6å¤© | **å·²å®Œæˆç‡**: 76.5% | **å¯å¤ç”¨æœåŠ¡**: 12ä¸ª

### âš¡ Phase 1: æ•°æ®åº“å˜æ›´ï¼ˆ0.5å¤©ï¼‰

| åºå· | ä»»åŠ¡ | ç±»å‹ | å·¥æ—¶ | è¯¦ç»†ä½ç½® |
|-----|------|------|-----|---------|
| DB-1 | æ–°å¢ `first_response_at` å­—æ®µ | ALTER TABLE | 0.2å¤© | Â§13.1 æ­¥éª¤1.1 |
| DB-2 | æ–°å¢ `alert_silence_rules` è¡¨ | CREATE TABLE | 0.2å¤© | Â§13.1 æ­¥éª¤1.2 |
| DB-3 | æ–°å¢ç´¢å¼•ä¼˜åŒ– | CREATE INDEX | 0.1å¤© | Â§10.7 |

```sql
-- DB-1: å®¢æœé¦–æ¬¡å“åº”æ—¶é—´å­—æ®µï¼ˆå†³ç­– D-1 å·²ç¡®è®¤ï¼‰
ALTER TABLE customer_service_sessions 
ADD COLUMN first_response_at DATETIME NULL COMMENT 'å®¢æœé¦–æ¬¡å“åº”æ—¶é—´';

-- DB-2: å‘Šè­¦é™é»˜è§„åˆ™è¡¨ï¼ˆå†³ç­– D-5 å·²ç¡®è®¤ï¼‰
CREATE TABLE alert_silence_rules (...);
```

---

### âš¡ Phase 2: æœåŠ¡å±‚å¼€å‘ï¼ˆ3å¤©ï¼‰

| åºå· | æœåŠ¡å | ServiceManageré”® | å·¥æ—¶ | å¤ç”¨åŸºç¡€ | è¯¦ç»†ä½ç½® |
|-----|-------|-----------------|-----|---------|---------|
| SVC-1 | `PendingHealthScoreService` | `pending_health_score` | 0.5å¤© | `PendingSummaryService` | Â§13.2 æ­¥éª¤2.1 |
| SVC-2 | `BusinessHealthScoreService` | `business_health_score` | 0.5å¤© | `LotteryHealthService` | Â§13.2 æ­¥éª¤2.2 |
| SVC-3 | `CustomerServiceResponseStatsService` | `cs_response_stats` | 0.3å¤© | `CustomerServiceSessionService` | Â§4.4 |
| SVC-4 | `APIPerformanceService` | `api_performance` | 0.5å¤© | æ–°å»º | Â§10.4.4 |
| SVC-5 | `ItemLockRateService` | `item_lock_rate` | 0.5å¤© | æ–°å»º | Â§10.4.4 |
| SVC-6 | `StoreContributionService` | `store_contribution` | 1å¤© | æ–°å»º | Â§10.4.4 |

**æœåŠ¡æ³¨å†Œï¼ˆservices/index.jsï¼‰**:
```javascript
// åœ¨ initialize() æ–¹æ³•ä¸­æ³¨å†Œ
this._services.set('pending_health_score', PendingHealthScoreService)
this._services.set('business_health_score', BusinessHealthScoreService)
this._services.set('cs_response_stats', CustomerServiceResponseStatsService)
```

---

### âš¡ Phase 3: è·¯ç”±ç«¯ç‚¹å¼€å‘ï¼ˆ1.5å¤©ï¼‰

| åºå· | ç«¯ç‚¹ | æ–¹æ³• | è·¯ç”±æ–‡ä»¶ | ä¾èµ–æœåŠ¡ | å·¥æ—¶ |
|-----|------|-----|---------|---------|-----|
| API-1 | `/api/v4/console/pending/health-score` | GET | `pending.js` | SVC-1 | 0.2å¤© |
| API-2 | `/api/v4/console/dashboard/business-health` | GET | `dashboard.js` | SVC-2 | 0.2å¤© |
| API-3 | `/api/v4/console/dashboard/time-comparison` | GET | `dashboard.js` | `multi_dimension_stats` | 0.2å¤© |
| API-4 | `/api/v4/console/customer-service/sessions/response-stats` | GET | `customer-service/sessions.js` | SVC-3 | 0.2å¤© |
| API-5 | `/api/v4/console/users/:user_id/approval-rate` | GET | `user-segments.js` | `user_segment` | 0.2å¤© |
| API-6 | `/api/v4/console/system/api-performance` | GET | `system/` | SVC-4 | 0.2å¤© |
| API-7 | `/api/v4/console/items/lock-rate` | GET | `items.js`ï¼ˆæ–°å»ºï¼‰ | SVC-5 | 0.2å¤© |
| API-8 | `/api/v4/console/stores/contribution` | GET | `stores.js` | SVC-6 | 0.2å¤© |

---

### âš¡ Phase 4: æµ‹è¯•ä¸è”è°ƒï¼ˆ1å¤©ï¼‰

| åºå· | ä»»åŠ¡ | å·¥æ—¶ |
|-----|------|-----|
| TEST-1 | å•å…ƒæµ‹è¯•ï¼ˆ6ä¸ªæ–°æœåŠ¡ï¼‰ | 0.5å¤© |
| TEST-2 | é›†æˆæµ‹è¯•ï¼ˆ8ä¸ªæ–°ç«¯ç‚¹ï¼‰ | 0.3å¤© |
| TEST-3 | å‰åç«¯è”è°ƒ | 0.2å¤© |

---

### âœ… å·²å®Œæˆï¼ˆæ— éœ€å¼€å‘ï¼‰

| æœåŠ¡/ç«¯ç‚¹ | çŠ¶æ€ | è¯´æ˜ |
|----------|------|------|
| `LotteryHealthService` | âœ… å®Œæ•´å®ç° | 5ç»´åº¦é›·è¾¾å›¾+é—®é¢˜è¯Šæ–­+ä¼˜åŒ–å»ºè®®ï¼Œ897è¡Œä»£ç  |
| `GET /lottery-health/:id` | âœ… å®Œæ•´å®ç° | 4ä¸ªç«¯ç‚¹å…¨éƒ¨å¯ç”¨ |
| `PendingCenterService` | âœ… å¯å¤ç”¨ | `getSegmentStats()`, `getUnifiedList()` |
| `PendingSummaryService` | âœ… å¯å¤ç”¨ | `getPendingSummary()` |
| `MultiDimensionStatsService` | âœ… å¯å¤ç”¨ | æ”¯æŒæ—¶é—´å¯¹æ¯”æ‰€éœ€çš„æ‰€æœ‰ç»´åº¦ |
| `UserSegmentService` | âœ… å¯å¤ç”¨ | ç”¨æˆ·360è§†å›¾ã€åˆ†å±‚ã€æ¼æ–— |
| `AuditLogService` | âœ… å®Œæ•´å®ç° | 15ç§æ“ä½œç±»å‹+before/afteræ•°æ® |
| `ConsumptionBatchService` | âœ… å®Œæ•´å®ç° | æ‰¹é‡å®¡æ ¸ |
| `RiskControlService` | âœ… å®Œæ•´å®ç° | é£æ§å‘Šè­¦ |
| `DebtManagementService` | âœ… å¯å¤ç”¨ | é¢„ç®—è¶‹åŠ¿ã€æ¬ è´¦ç»Ÿè®¡ |

---

### ğŸ“‹ æ‰§è¡Œé¡ºåºå»ºè®®

```
Day 1: DB-1 â†’ DB-2 â†’ DB-3 â†’ SVC-1 â†’ SVC-2
Day 2: SVC-3 â†’ API-1 â†’ API-2 â†’ API-3 â†’ API-4
Day 3: SVC-4 â†’ API-5 â†’ API-6
Day 4: SVC-5 â†’ API-7
Day 5: SVC-6 â†’ API-8
Day 6: TEST-1 â†’ TEST-2 â†’ TEST-3
```

---

> **ğŸ“‹ å˜æ›´è®°å½• v1.5**:
> - æ–°å¢ **å¾…å®Œæˆå·¥ä½œæ¸…å•ï¼ˆæ‰§è¡Œæ‘˜è¦ï¼‰**ï¼šPhase 1-4 å®Œæ•´ä»»åŠ¡åˆ—è¡¨
> - æ–°å¢æ‰§è¡Œé¡ºåºå»ºè®®
> - æ–°å¢å·²å®ŒæˆæœåŠ¡/ç«¯ç‚¹æ¸…å•
>
> **ğŸ“‹ å˜æ›´è®°å½• v1.4**:
> - æ ¸å® **Â§3.1 å¥åº·åº¦è®¡ç®—æ¥å£**ï¼š`LotteryHealthService` å·²å®Œæ•´å®ç°ï¼ˆ5ç»´åº¦é›·è¾¾å›¾+é—®é¢˜è¯Šæ–­+ä¼˜åŒ–å»ºè®®ï¼‰
> - åŒºåˆ†ä¸‰ç±»å¥åº·åº¦æ¥å£ï¼šæŠ½å¥–æ´»åŠ¨å¥åº·åº¦ï¼ˆâœ…å·²å®ç°ï¼‰ã€å¾…åŠå¥åº·åº¦ï¼ˆâŒå¾…å®ç°ï¼‰ã€å…¨å±€ä¸šåŠ¡å¥åº·åº¦ï¼ˆâŒå¾…å®ç°ï¼‰
> - ä¿®æ­£ **Â§3.1 å·¥æ—¶è¯„ä¼°**ï¼š3å¤© â†’ 1å¤©ï¼ˆå¤ç”¨å·²å®ç°çš„ `LotteryHealthService`ï¼‰
> - æ–°å¢å¤ç”¨è¯´æ˜ï¼š`BusinessHealthScoreService` å¯èšåˆ `LotteryHealthService` çš„å¥åº·åº¦æ•°æ®
>
> **ğŸ“‹ å˜æ›´è®°å½• v1.3**:
> - å®Œå–„ **Â§2.5.4 æœåŠ¡å±‚è°ƒç”¨è§„èŒƒ**ï¼šæ–°å¢ TR-005 ServiceManager ä½¿ç”¨è§„èŒƒã€é”™è¯¯å¤„ç†è§„èŒƒã€æ–°æœåŠ¡æ³¨å†Œè§„èŒƒ
> - ä¿®æ­£ **Â§13.3 è·¯ç”±å±‚ä»£ç æ¨¡æ¿**ï¼šæ‰€æœ‰ä»£ç æ¨¡æ¿ç¬¦åˆ `handleServiceError` é”™è¯¯å¤„ç†è§„èŒƒ
> - æ–°å¢ **Â§12.4 æ–°æœåŠ¡å¼€å‘æ£€æŸ¥æ¸…å•**ï¼šå®Œæ•´çš„å¼€å‘æ­¥éª¤å’Œä»£ç æ¨¡æ¿
> - æ›´æ–° **Â§12.1-12.2 å¯å¤ç”¨æŠ€æœ¯èµ„äº§**ï¼šæ–°å¢ ServiceManager é”®åã€ä½¿ç”¨æ–¹å¼
> 
> **ğŸ“‹ å˜æ›´è®°å½• v1.2**:
> - æ–°å¢ **Â§2.5 åç«¯æŠ€æœ¯è§„èŒƒå¼ºåˆ¶è¦æ±‚**ï¼ˆAPIå“åº”æ ¼å¼ã€æ•°æ®åº“å­—æ®µæ˜ å°„ã€è·¯ç”±å‘½åè§„èŒƒï¼‰
> - ä¿®æ­£æ‰€æœ‰ `timestamp` æ ¼å¼ä¸º ISO 8601 åŒ—äº¬æ—¶é—´ï¼ˆ`2026-02-03T10:30:00.000+08:00`ï¼‰
> - ä¿®æ­£ SQL æŸ¥è¯¢ä¸­çš„å­—æ®µï¼š`change_type` â†’ `business_type`ï¼Œ`amount` â†’ `delta_amount`
> - ä¿®æ­£è·¯ç”±å‚æ•°ï¼š`:id` â†’ `:user_id`/`:store_id`/`:lottery_campaign_id`
> - æ–°å¢ç´¢å¼•å»ºè®®ä½¿ç”¨å®é™…è¡¨ç»“æ„  

---

## ä¸€ã€æ–‡æ¡£æ¦‚è¿°

### 1.1 ç›®çš„

æœ¬æ–‡æ¡£ä»ã€Šè¿è¥åå°ä¼˜åŒ–æ–¹æ¡ˆã€‹ä¸­æå–æ‰€æœ‰åç«¯ç›¸å…³å·¥ä½œå†…å®¹ï¼ŒåŒ…æ‹¬ï¼š
- APIæ¥å£å¼€å‘
- æ•°æ®åº“æŸ¥è¯¢ä¸èšåˆ
- æœåŠ¡å±‚é€»è¾‘
- WebSocketå®æ—¶æ¨é€
- ç¼“å­˜ç­–ç•¥
- æ•°æ®å¯¼å‡º
- æƒé™æ§åˆ¶

### 1.2 åç«¯å·¥ä½œèŒƒå›´ï¼ˆæ·±åº¦æ ¸æŸ¥ç‰ˆ 2026-02-03ï¼‰

| ç±»åˆ« | å·¥ä½œé¡¹æ•°é‡ | åŸä¼°å·¥æ—¶ | **å¤ç”¨åå·¥æ—¶** | å¤ç”¨è¯´æ˜ |
|------|-----------|---------|--------------|---------|
| P0 æ ¸å¿ƒåŠŸèƒ½ | 2é¡¹ | 2å¤© | **0.5å¤©** | âœ… `LotteryHealthService`/`PendingSummaryService` æ ¸å¿ƒå·²å®ç° |
| P1 é‡è¦åŠŸèƒ½ | 15é¡¹ | 9.5å¤© | **2.5å¤©** | âœ… `MultiDimensionStatsService`/`UserSegmentService` å¯å¤ç”¨ |
| P2 å¢å¼ºåŠŸèƒ½ | 10é¡¹ | 8å¤© | **2å¤©** | âœ… `AuditLogService` å·²å®Œæ•´å®ç° |
| P3 ä½ä¼˜å…ˆçº§ | 4é¡¹ | 6å¤© | **2å¤©** | âœ… `UserSegmentService.getBehaviorFunnel()` å·²å®ç° |
| **åˆè®¡** | **31é¡¹** | 25.5å¤© | **7å¤©** | **èŠ‚çœ 72.5%** |

> **æ·±åº¦æ ¸æŸ¥ç»“è®º**: é¡¹ç›®ä¸­å·²å­˜åœ¨å¤§é‡å¯å¤ç”¨æœåŠ¡ï¼Œè¯¦è§ç¬¬åèŠ‚"å®ç°çŠ¶æ€åˆ†æ"

---

## äºŒã€æ•°æ®åº“è¡¨ä¾èµ–

### 2.1 æ ¸å¿ƒæ•°æ®è¡¨

| è¡¨å | è®°å½•æ•° | ç”¨é€” | åç«¯ä½¿ç”¨åœºæ™¯ |
|------|--------|------|-------------|
| `users` | 55 | ç”¨æˆ·ä¿¡æ¯ | ç”¨æˆ·360Â°è§†å›¾ã€æƒé™æ§åˆ¶ |
| `lottery_draws` | 1,055 | æŠ½å¥–è®°å½• | æŠ½å¥–åˆ†æã€å¥åº·åº¦è®¡ç®— |
| `consumption_records` | 48 | æ¶ˆè´¹è®°å½• | å¾…åŠç»Ÿè®¡ã€æ¶ˆè´¹å®¡æ ¸ |
| `customer_service_sessions` | 12 | å®¢æœä¼šè¯ | å¾…åŠç»Ÿè®¡ã€å®¢æœå“åº”æ—¶é•¿ |
| `admin_operation_logs` | 5,273 | æ“ä½œå®¡è®¡ | å®¡è®¡æ—¥å¿—æ¥å£ |
| `lottery_management_settings` | 2,793 | æŠ½å¥–é¢„è®¾ | æŠ½å¥–é…ç½®æ¥å£ |
| `item_instances` | 5,484 | ç‰©å“å®ä¾‹ | èµ„äº§ç®¡ç†ã€é”å®šç‡ç›‘æ§ |
| `market_listings` | 249 | å¸‚åœºæŒ‚ç‰Œ | èµ„äº§æµåŠ¨åˆ†æ |
| `trade_orders` | 108 | äº¤æ˜“è®¢å• | äº¤æ˜“è¿½è¸ª |
| `asset_transactions` | 20,530 | èµ„äº§æµæ°´ | èµ„äº§æµåŠ¨é¡µæ ¸å¿ƒæ•°æ® |
| `account_asset_balances` | - | èµ„äº§ä½™é¢ | ä½™é¢é¢„è­¦ã€èµ„äº§åˆ†æ |
| `material_asset_types` | - | èµ„äº§ç±»å‹ | èµ„äº§åˆ†ç±»å±•ç¤º |
| `user_behavior_tracks` | - | ç”¨æˆ·è¡Œä¸º | ç”¨æˆ·360Â°è§†å›¾ |
| `user_risk_profiles` | - | é£æ§ç”»åƒ | ç”¨æˆ·360Â°è§†å›¾ |

### 2.2 å·²æœ‰åç«¯æœåŠ¡ï¼ˆæ·±åº¦æ ¸æŸ¥ç‰ˆ 2026-02-03ï¼‰

| æœåŠ¡ | è·¯å¾„ | å·²å®ç°åŠŸèƒ½ | å¤ç”¨ä»·å€¼ | æ‰©å±•å·¥ä½œ |
|------|------|-----------|---------|---------|
| **LotteryHealthService** ğŸ”¥ | `services/lottery/` | `calculateHealthScore()`, 5ç»´å¥åº·åº¦ç®—æ³• | **P0 æ ¸å¿ƒ** | å°è£…ç«¯ç‚¹ 0.2å¤© |
| **PendingSummaryService** ğŸ”¥ | `services/dashboard/` | `getPendingSummary()`, 4ç±»å¾…åŠæ±‡æ€» | **P0 æ ¸å¿ƒ** | åŠ è¯„åˆ†ç®—æ³• 0.3å¤© |
| **MultiDimensionStatsService** ğŸ”¥ | `services/reporting/` | å¤šç»´ç»Ÿè®¡ã€æ—¶é—´ç»´åº¦æ”¯æŒ | **P1 æ—¶é—´å¯¹æ¯”** | æ–°å¢ç«¯ç‚¹ 0.3å¤© |
| **UserSegmentService** ğŸ”¥ | `services/user/` | åˆ†å±‚ã€çƒ­å›¾ã€æ¼æ–—ã€åå¥½ | **P1/P2/P3 å¤šå¤ç”¨** | èšåˆ360è§†å›¾ 0.5å¤© |
| **AuditLogService** ğŸ”¥ | `services/` | å®Œæ•´CRUDã€15ç§æ“ä½œç±»å‹ | **P2 å·²å®Œæˆ** | æ— éœ€æ‰©å±• |
| PendingCenterService | `services/pending/` | å¾…åŠæ±‡æ€»ã€åˆ—è¡¨ã€ç»Ÿè®¡ | åŸºç¡€æ”¯æŒ | - |
| DashboardPanelService | `services/dashboard/` | ä»ªè¡¨ç›˜æ•°æ® | åŸºç¡€æ”¯æŒ | +å¥åº·åº¦ç«¯ç‚¹ |
| DebtManagementService | `services/` | é¢„ç®—è¶‹åŠ¿ã€æ¬ è´¦ç»Ÿè®¡ | P1 å«ä»˜çœ‹æ¿ | ç›´æ¥å¤ç”¨ |
| CustomerServiceSessionService | `services/` | å“åº”æ—¶é—´è®¡ç®— | P1 å®¢æœå“åº” | +DBå­—æ®µ |

> **ğŸ”¥æ ‡è®°**: å‘ç°çš„é«˜ä»·å€¼å¯å¤ç”¨æœåŠ¡ï¼Œè¯¦è§ç¬¬åèŠ‚10.8ç« èŠ‚

---

## äºŒ.5ã€åç«¯æŠ€æœ¯è§„èŒƒå¼ºåˆ¶è¦æ±‚ï¼ˆ2026-02-03ï¼‰

> âš ï¸ **é‡è¦**: æœ¬æ–‡æ¡£ä¸­çš„APIè®¾è®¡ã€æ•°æ®åº“æŸ¥è¯¢ã€å“åº”æ ¼å¼å¿…é¡»éµå¾ªåç«¯é¡¹ç›®çš„å®é™…æŠ€æœ¯è§„èŒƒï¼Œè€Œéå‰ç«¯æ–‡æ¡£ä¸­çš„è®¾è®¡ã€‚

### 2.5.1 APIå“åº”æ ¼å¼è§„èŒƒï¼ˆå¼ºåˆ¶ï¼‰

**ç»Ÿä¸€å“åº”ç»“æ„**ï¼ˆæ¥è‡ª `utils/ApiResponse.js`ï¼‰ï¼š
```javascript
{
  success: boolean,           // ä¸šåŠ¡æ“ä½œæ˜¯å¦æˆåŠŸ
  code: string,              // ä¸šåŠ¡ç ï¼ˆå­—ç¬¦ä¸²ï¼Œå¦‚ 'SUCCESS', 'ERROR'ï¼‰
  message: string,           // äººç±»å¯è¯»æ¶ˆæ¯
  data: object | array | null, // ä¸šåŠ¡æ•°æ®
  timestamp: string,         // åŒ—äº¬æ—¶é—´ï¼ˆISO 8601æ ¼å¼ï¼‰
  version: string,           // APIç‰ˆæœ¬ï¼ˆå›ºå®š "v4.0"ï¼‰
  request_id: string         // è¯·æ±‚è¿½è¸ªID
}
```

**æ—¶é—´æˆ³æ ¼å¼ï¼ˆå¼ºåˆ¶åŒ—äº¬æ—¶é—´ï¼‰**ï¼š
```javascript
// âœ… æ­£ç¡®æ ¼å¼ï¼ˆISO 8601 + åŒ—äº¬æ—¶åŒºï¼‰
"timestamp": "2026-02-03T10:30:00.000+08:00"

// âŒ é”™è¯¯æ ¼å¼ï¼ˆå‰ç«¯æ–‡æ¡£ä¸­çš„æ ¼å¼ï¼‰
"timestamp": "2026-02-03T10:30:00.000+08:00"
```

**å“åº”æ–¹æ³•ï¼ˆé€šè¿‡ä¸­é—´ä»¶æ³¨å…¥ï¼‰**ï¼š
```javascript
// æˆåŠŸå“åº”
res.apiSuccess(data, message)

// åˆ†é¡µå“åº”
res.apiPaginated(data, pagination, message)

// é”™è¯¯å“åº”
res.apiError(message, errorCode, details, httpStatus)
```

### 2.5.2 æ•°æ®åº“å­—æ®µæ˜ å°„è§„èŒƒï¼ˆå¼ºåˆ¶ï¼‰

| éœ€æ±‚æ–‡æ¡£å­—æ®µ | å®é™…æ•°æ®åº“å­—æ®µ | è¡¨å | è¯´æ˜ |
|-------------|---------------|------|------|
| `change_type` | `business_type` | `asset_transactions` | ä¸šåŠ¡ç±»å‹æšä¸¾ |
| `amount` | `delta_amount` | `asset_transactions` | å˜åŠ¨é‡‘é¢ï¼ˆå¯æ­£å¯è´Ÿï¼‰ |
| `is_winner` | `reward_tier` | `lottery_draws` | ä½¿ç”¨ `CASE WHEN reward_tier IN ('high','mid') THEN 1 ELSE 0 END` |
| `advance_amount` | `has_debt` + JOIN | `lottery_draws` + `debt_records` | éœ€å…³è”æŸ¥è¯¢ |

**ä¸šåŠ¡ç±»å‹æšä¸¾å€¼**ï¼ˆæ¥è‡ª `AssetTransaction.BUSINESS_TYPES`ï¼‰ï¼š
```javascript
const BUSINESS_TYPES = {
  LOTTERY_CONSUME: 'lottery_consume',     // æŠ½å¥–æ¶ˆè€—
  LOTTERY_REWARD: 'lottery_reward',       // æŠ½å¥–å¥–åŠ±
  CONSUMPTION_REWARD: 'consumption_reward', // æ¶ˆè´¹å¥–åŠ±
  ADMIN_ADJUST: 'admin_adjust',           // ç®¡ç†å‘˜è°ƒæ•´
  TRADE_SETTLE: 'trade_settle',           // äº¤æ˜“ç»“ç®—
  EXCHANGE_CONSUME: 'exchange_consume',   // å…‘æ¢æ¶ˆè€—
  // ... å…±15ç§
}
```

### 2.5.3 è·¯ç”±å‘½åè§„èŒƒï¼ˆå¼ºåˆ¶ï¼‰

**å‘½åè§„åˆ™**ï¼š
- ä½¿ç”¨ **kebab-case**ï¼ˆå¦‚ `lottery-health`, `pending-summary`ï¼‰
- è·¯å¾„å‰ç¼€ï¼š`/api/v4/console/`
- èµ„æºIDå‚æ•°ä½¿ç”¨å®Œæ•´åç§°ï¼ˆå¦‚ `:lottery_campaign_id` è€Œé `:id`ï¼‰

**ç¤ºä¾‹**ï¼š
```javascript
// âœ… æ­£ç¡®
router.get('/lottery-health/:lottery_campaign_id', ...)
router.get('/users/:user_id/approval-rate', ...)

// âŒ é”™è¯¯
router.get('/lotteryHealth/:id', ...)  // é©¼å³°å‘½å
router.get('/lottery_health/:id', ...) // ä¸‹åˆ’çº¿å‘½å
```

### 2.5.4 æœåŠ¡å±‚è°ƒç”¨è§„èŒƒï¼ˆå¼ºåˆ¶ï¼‰

**é€šè¿‡ ServiceManager è·å–æœåŠ¡ï¼ˆTR-005è§„èŒƒï¼‰**ï¼š
```javascript
// âœ… æ­£ç¡®ï¼šé€šè¿‡ ServiceManager è·å–ï¼ˆæ¨èæ–¹å¼ï¼‰
router.get('/health-score', authenticateToken, requireRoleLevel(100), async (req, res) => {
  try {
    // ğŸ”„ é€šè¿‡ ServiceManager è·å–æœåŠ¡ï¼ˆç¬¦åˆTR-005è§„èŒƒï¼‰
    const PendingHealthScoreService = req.app.locals.services.getService('pending_health_score')
    const result = await PendingHealthScoreService.getHealthScore()
    return res.apiSuccess(result, 'è·å–æˆåŠŸ')
  } catch (error) {
    logger.error('[å¾…åŠå¥åº·åº¦] è·å–å¤±è´¥', { error: error.message })
    return handleServiceError(error, res, 'è·å–å¾…åŠå¥åº·åº¦å¤±è´¥')
  }
})

// âŒ é”™è¯¯ï¼šç›´æ¥ requireï¼ˆè¿åTR-005è§„èŒƒï¼‰
const PendingHealthScoreService = require('../../../services/pending/PendingHealthScoreService')
const result = await PendingHealthScoreService.getHealthScore()
```

**é”™è¯¯å¤„ç†è§„èŒƒï¼ˆå¼ºåˆ¶ï¼‰**ï¼š
```javascript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ handleServiceError ä¸­é—´ä»¶
const { handleServiceError } = require('../../../middleware/validation')
return handleServiceError(error, res, 'è·å–å¤±è´¥')

// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨ res.apiError
return res.apiError(error.message, 'ERROR_CODE', null, 500)
```

**å·²æ³¨å†ŒæœåŠ¡åç§°**ï¼ˆsnake_caseï¼‰ï¼š
- `lottery_health` â†’ `LotteryHealthService`
- `pending_summary` â†’ `PendingSummaryService`
- `pending_center` â†’ `PendingCenterService`
- `multi_dimension_stats` â†’ `MultiDimensionStatsService`
- `user_segment` â†’ `UserSegmentService`
- `customer_service_session` â†’ `CustomerServiceSessionService`
- `console_dashboard_query` â†’ `DashboardQueryService`
- `audit_log` â†’ `AuditLogService`
- `debt_management` â†’ `DebtManagementService`

**æ–°æœåŠ¡æ³¨å†Œè§„èŒƒ**ï¼š
æ–°å¼€å‘çš„æœåŠ¡å¿…é¡»åœ¨ `services/index.js` ä¸­æ³¨å†Œï¼š
```javascript
// 1. å¯¼å…¥æœåŠ¡ï¼ˆæ–‡ä»¶é¡¶éƒ¨ï¼‰
const PendingHealthScoreService = require('./pending/PendingHealthScoreService')
const BusinessHealthScoreService = require('./dashboard/BusinessHealthScoreService')

// 2. åœ¨ ServiceManager.initialize() ä¸­æ³¨å†Œ
this._services.set('pending_health_score', PendingHealthScoreService)
this._services.set('business_health_score', BusinessHealthScoreService)
```

### 2.5.5 ç¼“å­˜å’Œæ—¶é—´å¤„ç†è§„èŒƒï¼ˆå¼ºåˆ¶ï¼‰

**ç¼“å­˜ä½¿ç”¨**ï¼š
```javascript
const { BusinessCacheHelper, KEY_PREFIX } = require('../../utils/BusinessCacheHelper')

// è¯»å–ç¼“å­˜
const cached = await BusinessCacheHelper.get(`${KEY_PREFIX}my_key`)

// å†™å…¥ç¼“å­˜ï¼ˆTTL ç§’ï¼‰
await BusinessCacheHelper.set(`${KEY_PREFIX}my_key`, data, 60)
```

**æ—¶é—´å¤„ç†**ï¼š
```javascript
const BeijingTimeHelper = require('../../utils/timeHelper')

// APIå“åº”æ—¶é—´æˆ³
const timestamp = BeijingTimeHelper.apiTimestamp()
// è¾“å‡º: "2026-02-03T10:30:00.000+08:00"

// å½“å‰åŒ—äº¬æ—¶é—´ Date å¯¹è±¡
const now = BeijingTimeHelper.nowDate()
```

### 2.5.6 SQLæŸ¥è¯¢ä¿®æ­£ï¼ˆå¿…é¡»æŒ‰å®é™…è¡¨ç»“æ„ï¼‰

**èµ„äº§æµåŠ¨æŸ¥è¯¢ï¼ˆä¿®æ­£ç‰ˆï¼‰**ï¼š
```sql
-- âŒ é”™è¯¯ï¼ˆéœ€æ±‚æ–‡æ¡£ä¸­çš„å†™æ³•ï¼‰
SELECT SUM(CASE WHEN change_type IN ('ADMIN_GRANT') THEN amount ELSE 0 END) ...

-- âœ… æ­£ç¡®ï¼ˆæŒ‰å®é™…è¡¨ç»“æ„ï¼‰
SELECT 
  SUM(CASE WHEN business_type IN ('lottery_reward', 'consumption_reward', 'admin_adjust') 
      AND delta_amount > 0 THEN delta_amount ELSE 0 END) as issuance,
  SUM(CASE WHEN delta_amount < 0 THEN ABS(delta_amount) ELSE 0 END) as consumption
FROM asset_transactions
WHERE created_at >= CURDATE();
```

**ä¸­å¥–åˆ¤å®šæŸ¥è¯¢ï¼ˆä¿®æ­£ç‰ˆï¼‰**ï¼š
```sql
-- âŒ é”™è¯¯ï¼ˆéœ€æ±‚æ–‡æ¡£ä¸­çš„å†™æ³•ï¼‰
SELECT COUNT(*) as winners WHERE is_winner = 1

-- âœ… æ­£ç¡®ï¼ˆæŒ‰å®é™…è¡¨ç»“æ„ï¼‰
SELECT COUNT(*) as winners 
FROM lottery_draws 
WHERE reward_tier IN ('high', 'mid')
AND created_at >= CURDATE();
```

---

## ä¸‰ã€P0 æ ¸å¿ƒåŠŸèƒ½ï¼ˆå¿…é¡»å®ç°ï¼‰

### 3.1 å¥åº·åº¦è®¡ç®—æ¥å£

**å·¥æ—¶**: 3å¤© â†’ **ä¿®æ­£åå·¥æ—¶: 1å¤©**ï¼ˆå¤ç”¨å·²å®ç°æœåŠ¡ï¼‰  
**ä¼˜å…ˆçº§**: P0  
**ä¾èµ–æœåŠ¡**: PendingCenterService, LotteryHealthServiceï¼ˆå·²å®ç°ï¼‰

#### ğŸ¯ å¥åº·åº¦æ¥å£å®ç°çŠ¶æ€æ€»è§ˆ

| æ¥å£ç±»å‹ | è·¯å¾„ | æœåŠ¡ | å®ç°çŠ¶æ€ | å‰©ä½™å·¥æ—¶ |
|---------|-----|------|---------|---------|
| **æŠ½å¥–æ´»åŠ¨å¥åº·åº¦** | `GET /lottery-health/:id` | `LotteryHealthService` | âœ… **å·²å®Œæ•´å®ç°** | 0å¤© |
| å¾…åŠå¥åº·åº¦ | `GET /pending/health-score` | `PendingHealthScoreService`ï¼ˆæ–°å»ºï¼‰ | âŒ å¾…å®ç° | 0.5å¤© |
| å…¨å±€ä¸šåŠ¡å¥åº·åº¦ | `GET /dashboard/business-health` | `BusinessHealthScoreService`ï¼ˆæ–°å»ºï¼‰ | âŒ å¾…å®ç° | 0.5å¤© |

---

#### 3.1.0 æŠ½å¥–æ´»åŠ¨å¥åº·åº¦ï¼ˆâœ… å·²å®Œæ•´å®ç°ï¼‰

> **é‡è¦**: æ­¤æ¥å£å·²ç”± `LotteryHealthService` å®Œæ•´å®ç°ï¼Œæ— éœ€é‡å¤å¼€å‘

**å·²å®ç°ç«¯ç‚¹**:
| ç«¯ç‚¹ | åŠŸèƒ½ | æœåŠ¡æ–¹æ³• |
|-----|------|---------|
| `GET /api/v4/admin/lottery/health/:id` | å®Œæ•´å¥åº·æŠ¥å‘Šï¼ˆ5ç»´åº¦é›·è¾¾å›¾ï¼‰ | `getHealthReport()` |
| `GET /api/v4/admin/lottery/health/:id/tier-distribution` | æ¡£ä½åˆ†å¸ƒ | å¤ç”¨ `getHealthReport()` |
| `GET /api/v4/admin/lottery/health/:id/diagnose` | é—®é¢˜è¯Šæ–­ + ä¼˜åŒ–å»ºè®® | å¤ç”¨ `getHealthReport()` |
| `GET /api/v4/admin/lottery/health/:id/budget-rate` | é¢„ç®—æ¶ˆè€—é€Ÿåº¦ | å¤ç”¨ `getHealthReport()` |

**5ç»´åº¦è¯„åˆ†ä½“ç³»ï¼ˆå·²å®ç°ï¼‰**:
| ç»´åº¦ | æƒé‡ | è¯„ä¼°æŒ‡æ ‡ |
|-----|-----|---------|
| é¢„ç®—å¥åº·åº¦ | 30åˆ† | å‰©ä½™é¢„ç®—æ¯”ä¾‹ã€æ—¥å‡æ¶ˆè€—ã€é¢„è®¡å‰©ä½™å¤©æ•° |
| ä¸­å¥–ç‡å¥åº·åº¦ | 25åˆ† | å®é™… vs é…ç½®ä¸­å¥–ç‡åå·®ã€æ¡£ä½åˆ†å¸ƒ |
| åº“å­˜å¥åº·åº¦ | 20åˆ† | å„æ¡£ä½å¥–å“åº“å­˜ã€ä½åº“å­˜å‘Šè­¦ |
| ç”¨æˆ·å‚ä¸åº¦ | 15åˆ† | æ—¥å‡å‚ä¸äººæ•°ã€äººå‡æŠ½å¥–æ¬¡æ•° |
| ä½“éªŒå¥åº·åº¦ | 10åˆ† | è¿ç»­ç©ºå¥–ç‡ã€Pityæœºåˆ¶è§¦å‘ç‡ |

**å¤ç”¨æ–¹å¼**ï¼ˆç”¨äºå…¨å±€ä¸šåŠ¡å¥åº·åº¦ï¼‰:
```javascript
// åœ¨ BusinessHealthScoreService ä¸­å¤ç”¨ LotteryHealthService
const LotteryHealthService = req.app.locals.services.getService('lottery_health')

// èšåˆæ‰€æœ‰æ´»è·ƒæ´»åŠ¨çš„å¥åº·åº¦
const activeCampaigns = await LotteryCampaign.findAll({ where: { status: 'active' } })
const healthScores = await Promise.all(
  activeCampaigns.map(c => LotteryHealthService.getHealthReport(c.lottery_campaign_id))
)
const avgScore = healthScores.reduce((sum, r) => sum + r.overall_score, 0) / healthScores.length
```

---

#### 3.1.1 å¾…åŠå¥åº·åº¦è¯„åˆ†ï¼ˆâŒ å¾…å®ç°ï¼‰

**æ¥å£è·¯å¾„**: `GET /api/v4/console/pending/health-score`

**è®¡ç®—è§„åˆ™**:
```javascript
// å¥åº·åº¦ = 100 - è¶…æ—¶æƒ©ç½šåˆ† - ç§¯å‹æƒ©ç½šåˆ†
const healthScore = {
  base: 100,
  penalties: {
    // è¶…æ—¶æƒ©ç½šï¼šæ¯è¶…æ—¶1é¡¹æ‰£5åˆ†
    timeout: overdueCount * 5,
    // ç§¯å‹æƒ©ç½šï¼šå¾…åŠæ€»æ•°è¶…è¿‡10é¡¹ï¼Œæ¯å¤š1é¡¹æ‰£2åˆ†
    backlog: Math.max(0, (totalPending - 10) * 2)
  },
  // æœ€ä½0åˆ†
  final: Math.max(0, 100 - timeout - backlog)
}
```

**çŠ¶æ€æ˜ å°„**:
| åˆ†æ•°èŒƒå›´ | çŠ¶æ€ | æ˜¾ç¤ºé¢œè‰² | å«ä¹‰ |
|---------|------|---------|------|
| 80-100 | healthy | ç»¿è‰² ğŸŸ¢ | å¾…åŠå¤„äºå¯æ§çŠ¶æ€ |
| 50-79 | warning | é»„è‰² ğŸŸ¡ | éœ€è¦å…³æ³¨ï¼Œå»ºè®®å°½å¿«å¤„ç† |
| 0-49 | critical | çº¢è‰² ğŸ”´ | å¾…åŠç§¯å‹ä¸¥é‡ï¼Œéœ€ç«‹å³å¤„ç† |

**å“åº”æ ¼å¼**ï¼ˆéµå¾ª2.5.1è§„èŒƒï¼‰:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "score": 75,
    "status": "warning",
    "components": {
      "overdue_count": 3,
      "total_pending": 15,
      "timeout_penalty": 15,
      "backlog_penalty": 10
    },
    "trend": "down",
    "updated_at": "2026-02-03T10:30:00.000+08:00"
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

#### 3.1.2 å…¨å±€ä¸šåŠ¡å¥åº·åº¦è¯„åˆ†ï¼ˆâŒ å¾…å®ç°ï¼Œå¯å¤ç”¨ LotteryHealthServiceï¼‰

**æ¥å£è·¯å¾„**: `GET /api/v4/console/dashboard/business-health`

> **å¤ç”¨è¯´æ˜**: å¯å¤ç”¨å·²å®ç°çš„ `LotteryHealthService`ï¼Œèšåˆæ‰€æœ‰æ´»è·ƒæ´»åŠ¨çš„å¥åº·åº¦ä½œä¸º"æŠ½å¥–æ´»è·ƒå¾—åˆ†"ç»´åº¦

**è®¡ç®—è§„åˆ™**:
```javascript
// ä¸šåŠ¡å¥åº·åº¦ = èµ„äº§æµåŠ¨å¾—åˆ†(40%) + æŠ½å¥–æ´»è·ƒå¾—åˆ†(30%) + ç”¨æˆ·å¢é•¿å¾—åˆ†(30%)
const businessHealth = {
  components: {
    // èµ„äº§æµåŠ¨ï¼šå‘æ”¾/æ¶ˆè€—æ¯”åœ¨0.8-1.2ä¹‹é—´å¾—æ»¡åˆ†
    assetFlow: calculateAssetFlowScore(issuance, consumption),
    // æŠ½å¥–æ´»è·ƒï¼šä»Šæ—¥æŠ½å¥–æ¬¡æ•° vs 7æ—¥å‡å€¼
    lotteryActive: calculateLotteryActiveScore(todayDraws, avgDraws),
    // ç”¨æˆ·å¢é•¿ï¼šæ–°ç”¨æˆ·æ•°ã€æ´»è·ƒç”¨æˆ·æ•°
    userGrowth: calculateUserGrowthScore(newUsers, activeUsers)
  },
  // åŠ æƒè®¡ç®—
  final: assetFlow * 0.4 + lotteryActive * 0.3 + userGrowth * 0.3
}
```

**æ•°æ®åº“æŸ¥è¯¢**ï¼ˆéµå¾ª2.5.2è§„èŒƒï¼ŒæŒ‰å®é™…è¡¨ç»“æ„ï¼‰:
```sql
-- èµ„äº§æµåŠ¨æ•°æ®ï¼ˆä½¿ç”¨å®é™…å­—æ®µ business_type / delta_amountï¼‰
SELECT 
  SUM(CASE WHEN business_type IN ('lottery_reward', 'consumption_reward', 'admin_adjust') 
      AND delta_amount > 0 THEN delta_amount ELSE 0 END) as issuance,
  SUM(CASE WHEN delta_amount < 0 THEN ABS(delta_amount) ELSE 0 END) as consumption
FROM asset_transactions
WHERE created_at >= CURDATE();

-- æŠ½å¥–æ´»è·ƒæ•°æ®ï¼ˆä½¿ç”¨å®é™…å­—æ®µ reward_tier åˆ¤æ–­ä¸­å¥–ï¼‰
SELECT 
  COUNT(*) as today_draws,
  (SELECT COUNT(*) / 7 FROM lottery_draws WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)) as avg_draws
FROM lottery_draws
WHERE DATE(created_at) = CURDATE();
```

**å“åº”æ ¼å¼**ï¼ˆéµå¾ª2.5.1è§„èŒƒï¼‰:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "score": 82,
    "status": "healthy",
    "components": {
      "asset_flow": { "score": 85, "weight": 0.4, "detail": "å‘æ”¾/æ¶ˆè€—æ¯”: 1.05" },
      "lottery_active": { "score": 78, "weight": 0.3, "detail": "ä»Šæ—¥156æ¬¡ï¼Œå‡å€¼180æ¬¡" },
      "user_growth": { "score": 83, "weight": 0.3, "detail": "æ–°å¢3äººï¼Œæ´»è·ƒ42äºº" }
    },
    "trend": "stable",
    "updated_at": "2026-02-03T10:30:00.000+08:00"
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

### 3.2 æ¶ˆè´¹å®¡æ ¸æ‰¹é‡æ“ä½œ

**å·¥æ—¶**: 1å¤©  
**ä¼˜å…ˆçº§**: P0  
**ä¾èµ–è¡¨**: consumption_records

#### 3.2.1 æ‰¹é‡å®¡æ ¸æ¥å£

**æ¥å£è·¯å¾„**: `POST /api/v4/console/consumption/batch-review`

**è¯·æ±‚ä½“**:
```json
{
  "record_ids": [1, 2, 3, 4, 5],
  "action": "approve",  // approve | reject
  "reason": "æ‰¹é‡å®¡æ ¸é€šè¿‡",
  "auto_filter": {
    "max_anomaly_score": 30,  // ä»…å®¡æ ¸å¼‚å¸¸åˆ†æ•°<=30çš„è®°å½•
    "status": "pending"
  }
}
```

**ä¸šåŠ¡é€»è¾‘**:
```javascript
async function batchReview(recordIds, action, operatorId, reason) {
  const transaction = await sequelize.transaction();
  
  try {
    const results = { success: [], failed: [] };
    
    for (const recordId of recordIds) {
      try {
        const record = await ConsumptionRecord.findByPk(recordId, { transaction });
        
        if (!record || record.status !== 'pending') {
          results.failed.push({ id: recordId, reason: 'è®°å½•ä¸å­˜åœ¨æˆ–çŠ¶æ€ä¸æ­£ç¡®' });
          continue;
        }
        
        await record.update({
          status: action === 'approve' ? 'approved' : 'rejected',
          reviewed_by: operatorId,
          reviewed_at: new Date(),
          review_reason: reason
        }, { transaction });
        
        results.success.push(recordId);
      } catch (error) {
        results.failed.push({ id: recordId, reason: error.message });
      }
    }
    
    await transaction.commit();
    
    // è®°å½•å®¡è®¡æ—¥å¿—
    await AuditLogService.log({
      operator_id: operatorId,
      action_type: 'BATCH_REVIEW',
      target_type: 'consumption_record',
      detail: { action, count: results.success.length, failed: results.failed.length }
    });
    
    return results;
  } catch (error) {
    await transaction.rollback();
    throw error;
  }
}
```

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "code": "BATCH_SUCCESS",
  "message": "æ‰¹é‡å®¡æ ¸å®Œæˆ",
  "data": {
    "total": 10,
    "success_count": 8,
    "failed_count": 2,
    "success_ids": [1, 2, 3, 4, 5, 6, 7, 8],
    "failed_details": [
      { "id": 9, "reason": "è®°å½•å·²è¢«å¤„ç†" },
      { "id": 10, "reason": "å¼‚å¸¸åˆ†æ•°è¿‡é«˜ï¼Œéœ€å•ç‹¬å®¡æ ¸" }
    ]
  },
  "summary": {
    "total": 10,
    "success": 8,
    "failed": 2,
    "success_rate": "80.0%"
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

### 3.3 å¾…åŠç»Ÿè®¡ä¼˜åŒ–

**å·¥æ—¶**: å·²åŒ…å«åœ¨å¥åº·åº¦è®¡ç®—ä¸­  
**ä¼˜å…ˆçº§**: P0  
**ä¾èµ–æœåŠ¡**: PendingCenterServiceï¼ˆå·²æœ‰åŸºç¡€æ¥å£ï¼‰

#### 3.2.1 ä¼˜åŒ–ç°æœ‰å¾…åŠç»Ÿè®¡æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v4/console/pending/stats`

**ä¼˜åŒ–å†…å®¹**:
1. å¢åŠ è¶…æ—¶å¾…åŠæ•°é‡ç»Ÿè®¡
2. å¢åŠ å„ç±»å‹å¾…åŠçš„è¶…æ—¶è¯¦æƒ…
3. å¢åŠ å¾…åŠè¶‹åŠ¿æ•°æ®ï¼ˆä»Šæ—¥vsæ˜¨æ—¥ï¼‰

**æ–°å¢å“åº”å­—æ®µ**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "total": 15,
    "by_type": {
      "consumption_review": { "count": 8, "overdue": 2, "urgent": 1 },
      "customer_service": { "count": 5, "overdue": 1, "urgent": 0 },
      "alert_handling": { "count": 2, "overdue": 0, "urgent": 2 }
    },
    "overdue_total": 3,
    "comparison": {
      "yesterday": 12,
      "change_percent": 25,
      "trend": "up"
    }
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

---

## å››ã€P1 é‡è¦åŠŸèƒ½

### 4.1 å¼‚å¸¸è¿½è¸ªé¢æ¿API

**å·¥æ—¶**: 2å¤©  
**ä¼˜å…ˆçº§**: P1  
**æ–°å»ºæœåŠ¡**: AnomalyTrackingService

#### 4.1.1 å¼‚å¸¸äº‹ä»¶åˆ—è¡¨

**æ¥å£è·¯å¾„**: `GET /api/v4/console/consumption-anomaly/events`

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| type | string | å¦ | å¼‚å¸¸ç±»å‹ï¼šasset/lottery/user/system |
| severity | string | å¦ | ä¸¥é‡ç¨‹åº¦ï¼šcritical/warning/info |
| status | string | å¦ | çŠ¶æ€ï¼šactive/resolved/ignored |
| start_date | date | å¦ | å¼€å§‹æ—¥æœŸ |
| end_date | date | å¦ | ç»“æŸæ—¥æœŸ |
| page | int | å¦ | é¡µç ï¼Œé»˜è®¤1 |
| page_size | int | å¦ | æ¯é¡µæ•°é‡ï¼Œé»˜è®¤20 |

**æ•°æ®èšåˆé€»è¾‘**:
```javascript
// å¼‚å¸¸äº‹ä»¶æ¥æºèšåˆ
const anomalyEvents = await Promise.all([
  // èµ„äº§å¼‚å¸¸ï¼šå¤§é¢å˜åŠ¨ã€å¼‚å¸¸é¢‘ç‡
  AssetService.detectAnomalies(filters),
  // æŠ½å¥–å¼‚å¸¸ï¼šä¸­å¥–ç‡å¼‚å¸¸ã€è¿ç»­ä¸­å¥–
  LotteryService.detectAnomalies(filters),
  // ç”¨æˆ·å¼‚å¸¸ï¼šå¼‚å¸¸ç™»å½•ã€é£é™©è¡Œä¸º
  UserBehaviorService.detectAnomalies(filters),
  // ç³»ç»Ÿå¼‚å¸¸ï¼šAPIé”™è¯¯ç‡ã€å“åº”è¶…æ—¶
  SystemMonitorService.getAnomalies(filters)
]);

// åˆå¹¶æ’åº
return mergeAndSort(anomalyEvents, 'severity', 'created_at');
```

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "items": [
      {
        "id": "ANO_20260203_001",
        "type": "asset",
        "severity": "critical",
        "title": "ç”¨æˆ·ID:123 å•æ—¥è·å–DIAMONDè¶…è¿‡10000",
        "detail": {
          "user_id": 123,
          "asset_type": "DIAMOND",
          "amount": 15000,
          "normal_range": "0-5000"
        },
        "status": "active",
        "created_at": "2026-02-03T09:15:00+08:00",
        "related_records": [
          { "type": "asset_transaction", "id": 45678 }
        ]
      }
    ],
    "summary": {
      "critical": 3,
      "warning": 12,
      "info": 30
    }
  },
  "pagination": {
    "total": 45,
    "page": 1,
    "limit": 20,
    "total_pages": 3,
    "has_next": true,
    "has_prev": false
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

#### 4.1.2 å¼‚å¸¸å¤„ç†æ¥å£

**æ¥å£è·¯å¾„**: `POST /api/v4/console/consumption-anomaly/events/:id/handle`

**è¯·æ±‚ä½“**:
```json
{
  "action": "resolve",  // resolve | ignore | escalate
  "comment": "å·²æ ¸å®ä¸ºæ­£å¸¸è¥é”€æ´»åŠ¨",
  "follow_up": false
}
```

### 4.2 ç”¨æˆ·360Â°è§†å›¾API

**å·¥æ—¶**: 3å¤©  
**ä¼˜å…ˆçº§**: P1  
**ä¾èµ–æœåŠ¡**: UserBehaviorService, AssetService

#### 4.2.1 ç”¨æˆ·å…¨æ™¯æ•°æ®

**æ¥å£è·¯å¾„**: `GET /api/v4/console/users/:user_id/360view`

**å“åº”æ•°æ®ç»“æ„**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "basic_info": {
      "user_id": 123,
      "nickname": "ç”¨æˆ·æ˜µç§°",
      "avatar": "https://...",
      "phone_masked": "138****1234",
      "role": "customer",
      "register_time": "2025-06-15T10:00:00+08:00",
      "last_active": "2026-02-03T09:30:00+08:00",
      "status": "active"
    },
    "asset_summary": {
      "total_value": 125000,
      "by_type": [
        { "asset_code": "DIAMOND", "balance": 50000, "value": 50000 },
        { "asset_code": "GOLD", "balance": 75000, "value": 75000 }
      ],
      "recent_changes": {
        "7d_income": 8000,
        "7d_expense": 3500,
        "trend": "positive"
      }
    },
    "behavior_stats": {
      "lottery_count": 156,
      "win_rate": 0.23,
      "consumption_count": 12,
      "consumption_total": 3500,
      "login_frequency": "daily"
    },
    "risk_profile": {
      "risk_level": "low",
      "risk_score": 15,
      "flags": [],
      "last_assessment": "2026-02-01T00:00:00+08:00"
    },
    "activity_timeline": [
      {
        "time": "2026-02-03T09:30:00+08:00",
        "type": "lottery",
        "detail": "å‚ä¸æŠ½å¥–ï¼Œè·å¾—DIAMOND x100"
      }
    ]
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

**æ•°æ®åº“æŸ¥è¯¢**:
```sql
-- èµ„äº§æ±‡æ€»
SELECT asset_code, balance, 
       balance * (SELECT base_value FROM material_asset_types WHERE asset_code = aab.asset_code) as value
FROM account_asset_balances aab
WHERE user_id = ?;

-- è¡Œä¸ºç»Ÿè®¡
SELECT 
  (SELECT COUNT(*) FROM lottery_draws WHERE user_id = ?) as lottery_count,
  (SELECT COUNT(*) FROM lottery_draws WHERE user_id = ? AND is_winner = 1) / 
  (SELECT COUNT(*) FROM lottery_draws WHERE user_id = ?) as win_rate,
  (SELECT COUNT(*) FROM consumption_records WHERE user_id = ?) as consumption_count,
  (SELECT SUM(amount) FROM consumption_records WHERE user_id = ?) as consumption_total;

-- æ´»åŠ¨æ—¶é—´çº¿ï¼ˆæœ€è¿‘20æ¡ï¼‰- éµå¾ª2.5.2è§„èŒƒ
(SELECT 'lottery' as type, created_at, CONCAT('å‚ä¸æŠ½å¥–') as detail FROM lottery_draws WHERE user_id = ?)
UNION ALL
(SELECT 'consumption' as type, created_at, CONCAT('æ¶ˆè´¹ ', amount, 'å…ƒ') as detail FROM consumption_records WHERE user_id = ?)
UNION ALL
(SELECT 'asset' as type, created_at, CONCAT(business_type, ' ', asset_code, ' x', ABS(delta_amount)) as detail 
 FROM asset_transactions at
 JOIN accounts a ON a.account_id = at.account_id
 WHERE a.user_id = ?)
ORDER BY created_at DESC LIMIT 20;
```

#### 4.2.2 ç”¨æˆ·èµ„äº§å˜åŠ¨å†å²

**æ¥å£è·¯å¾„**: `GET /api/v4/console/users/:user_id/asset-history`ï¼ˆéµå¾ª2.5.3è·¯ç”±å‘½åè§„èŒƒï¼‰

**æŸ¥è¯¢å‚æ•°**ï¼ˆéµå¾ª2.5.2å­—æ®µå‘½åè§„èŒƒï¼‰:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| asset_code | string | èµ„äº§ç±»å‹ |
| business_type | string | ä¸šåŠ¡ç±»å‹ï¼ˆæ›¿ä»£change_typeï¼‰ |
| start_date | date | å¼€å§‹æ—¥æœŸ |
| end_date | date | ç»“æŸæ—¥æœŸ |
| page | int | é¡µç  |
| page_size | int | æ¯é¡µæ•°é‡ |

#### 4.2.3 ç”¨æˆ·æŠ½å¥–å†å²

**æ¥å£è·¯å¾„**: `GET /api/v4/console/users/:user_id/lottery-history`

#### 4.2.4 ç”¨æˆ·è¡Œä¸ºè½¨è¿¹

**æ¥å£è·¯å¾„**: `GET /api/v4/console/users/:user_id/behavior-tracks`

#### 4.2.5 ç”¨æˆ·é£æ§è¯„ä¼°

**æ¥å£è·¯å¾„**: `GET /api/v4/console/users/:user_id/risk-assessment`

### 4.3 å‘Šè­¦ä¸­å¿ƒAPI

**å·¥æ—¶**: 2å¤©ï¼ˆç»Ÿè®¡1å¤© + åˆ—è¡¨1å¤©ï¼‰  
**ä¼˜å…ˆçº§**: P1  
**ä¾èµ–æœåŠ¡**: LotteryAlertService

#### 4.3.1 å‘Šè­¦åˆ—è¡¨æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v4/console/risk-alerts`

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| category | string | åˆ†ç±»ï¼šall/urgent/risk/lottery/system |
| level | string | çº§åˆ«ï¼šcritical/warning/info |
| status | string | çŠ¶æ€ï¼šactive/acknowledged/resolved |
| page | int | é¡µç  |
| page_size | int | æ¯é¡µæ•°é‡ |

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "items": [
      {
        "id": "ALT_20260203_001",
        "category": "risk",
        "level": "critical",
        "title": "æ£€æµ‹åˆ°å¼‚å¸¸ä¸­å¥–ç‡",
        "message": "ç”¨æˆ·ID:456 è¿‘1å°æ—¶ä¸­å¥–ç‡è¾¾åˆ°85%ï¼Œè¶…è¿‡é˜ˆå€¼50%",
        "status": "active",
        "created_at": "2026-02-03T10:15:00+08:00",
        "acknowledged_at": null,
        "acknowledged_by": null,
        "resolved_at": null,
        "related_data": {
          "user_id": 456,
          "win_rate": 0.85,
          "threshold": 0.5,
          "draw_count": 20
        }
      }
    ]
  },
  "pagination": {
    "total": 156,
    "page": 1,
    "limit": 20,
    "total_pages": 8,
    "has_next": true,
    "has_prev": false
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

#### 4.3.2 å‘Šè­¦ç»Ÿè®¡æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v4/console/risk-alerts/stats`

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "total_active": 23,
    "by_category": {
      "urgent": 5,
      "risk": 8,
      "lottery": 6,
      "system": 4
    },
    "by_level": {
      "critical": 3,
      "warning": 12,
      "info": 8
    },
    "trend_7d": [
      { "date": "2026-01-28", "count": 15 },
      { "date": "2026-01-29", "count": 18 }
    ]
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

#### 4.3.3 å‘Šè­¦å¤„ç†æ¥å£

**æ¥å£è·¯å¾„**: `POST /api/v4/console/risk-alerts/:id/handle`

**è¯·æ±‚ä½“**:
```json
{
  "action": "acknowledge",  // acknowledge | resolve | snooze
  "comment": "å·²è”ç³»ç”¨æˆ·æ ¸å®",
  "snooze_minutes": 30  // ä»…snoozeæ—¶éœ€è¦
}
```

### 4.4 ä»ªè¡¨ç›˜ç¼“å­˜å’Œå¢é‡æ¥å£

**å·¥æ—¶**: 1å¤©  
**ä¼˜å…ˆçº§**: P1  
**ä¾èµ–æœåŠ¡**: DashboardPanelService

#### 4.4.1 ä»ªè¡¨ç›˜æ•°æ®æ¥å£ï¼ˆå¸¦ç¼“å­˜ï¼‰

**æ¥å£è·¯å¾„**: `GET /api/v4/console/dashboard/data`

**ç¼“å­˜ç­–ç•¥**:
```javascript
// Redisç¼“å­˜é…ç½®
const cacheConfig = {
  key: 'dashboard:data:{date}',
  ttl: 300,  // 5åˆ†é’Ÿ
  staleWhileRevalidate: true  // è¿”å›æ—§æ•°æ®åŒæ—¶åå°åˆ·æ–°
};

// å¢é‡æ›´æ–°é€»è¾‘
async function getDashboardData(forceRefresh = false) {
  const cacheKey = `dashboard:data:${today}`;
  
  if (!forceRefresh) {
    const cached = await redis.get(cacheKey);
    if (cached) {
      // å¼‚æ­¥æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
      this.checkAndRefresh(cacheKey);
      return JSON.parse(cached);
    }
  }
  
  const data = await this.aggregateDashboardData();
  await redis.setex(cacheKey, 300, JSON.stringify(data));
  return data;
}
```

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "core_metrics": {
      "today_consumption": { "value": 12500, "change": 15.2, "trend": "up" },
      "today_draws": { "value": 856, "change": -5.3, "trend": "down" },
      "active_users": { "value": 42, "change": 0, "trend": "stable" },
      "pending_count": { "value": 15, "urgent": 3 }
    },
    "charts": {
      "consumption_trend": [],
      "lottery_distribution": [],
      "user_activity": []
    },
    "cache_info": {
      "cached_at": "2026-02-03T10:25:00+08:00",
      "expires_at": "2026-02-03T10:30:00+08:00",
      "is_stale": false
    }
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

### 4.5 å¾…åŠæ•°é‡WebSocketæ¨é€

**å·¥æ—¶**: 0.5å¤©  
**ä¼˜å…ˆçº§**: P1  
**ä¾èµ–æœåŠ¡**: WebSocketService

#### 4.5.1 WebSocketäº‹ä»¶å®šä¹‰

**äº‹ä»¶åˆ—è¡¨**:
| äº‹ä»¶å | è§¦å‘åœºæ™¯ | æ¨é€å†…å®¹ |
|--------|----------|----------|
| `pending.new` | æ–°å¢å¾…åŠé¡¹ | `{ type, count, urgent }` |
| `pending.resolved` | å¾…åŠå·²å¤„ç† | `{ type, count }` |
| `alert.triggered` | æ–°å‘Šè­¦è§¦å‘ | `{ level, message }` |
| `health.changed` | å¥åº·åº¦å˜åŒ– | `{ score, status }` |

**å®ç°é€»è¾‘**:
```javascript
// å¾…åŠå˜æ›´æ—¶æ¨é€
class PendingCenterService {
  async createPendingItem(data) {
    const item = await PendingItem.create(data);
    
    // è§¦å‘WebSocketæ¨é€
    const stats = await this.getStats();
    WebSocketService.broadcast('admin', 'pending.new', {
      type: data.type,
      count: stats.total,
      urgent: stats.urgent
    });
    
    return item;
  }
  
  async resolvePendingItem(id) {
    await PendingItem.update({ status: 'resolved' }, { where: { id } });
    
    const stats = await this.getStats();
    WebSocketService.broadcast('admin', 'pending.resolved', {
      type: 'consumption_review',
      count: stats.total
    });
  }
}
```

**é™çº§ç­–ç•¥**:
- WebSocketè¿æ¥å¤±è´¥æ—¶ï¼Œå‰ç«¯è‡ªåŠ¨é™çº§ä¸º30ç§’è½®è¯¢
- åç«¯æ£€æµ‹è¿æ¥çŠ¶æ€ï¼Œæ–­å¼€æ—¶ä¸æ¨é€

### 4.6 APIå“åº”æ—¶é—´ç»Ÿè®¡

**å·¥æ—¶**: 0.5å¤©  
**ä¼˜å…ˆçº§**: P1  
**æ–°å»ºæœåŠ¡**: APIMonitorService

#### 4.6.1 APIæ€§èƒ½ç›‘æ§æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v4/console/system/api-performance`

**å®ç°æ–¹å¼**:
```javascript
// Expressä¸­é—´ä»¶æ”¶é›†å“åº”æ—¶é—´
app.use((req, res, next) => {
  const start = Date.now();
  
  res.on('finish', () => {
    const duration = Date.now() - start;
    const endpoint = `${req.method} ${req.route?.path || req.path}`;
    
    // è®°å½•åˆ°Redisæ—¶åºæ•°æ®
    APIMonitorService.recordResponseTime(endpoint, duration, res.statusCode);
  });
  
  next();
});

// èšåˆç»Ÿè®¡
class APIMonitorService {
  static async getPerformanceStats(timeRange = '1h') {
    const endpoints = await this.getMonitoredEndpoints();
    
    return Promise.all(endpoints.map(async (endpoint) => {
      const times = await redis.lrange(`api:perf:${endpoint}`, 0, -1);
      return {
        endpoint,
        avg_ms: calculateAvg(times),
        p95_ms: calculateP95(times),
        p99_ms: calculateP99(times),
        error_rate: await this.getErrorRate(endpoint),
        request_count: times.length
      };
    }));
  }
}
```

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "summary": {
      "avg_response_time": 125,
      "p95_response_time": 450,
      "error_rate": 0.02,
      "total_requests": 15680
    },
    "slow_apis": [
      {
        "endpoint": "GET /api/v4/console/dashboard/data",
        "avg_ms": 850,
        "p95_ms": 1200,
        "request_count": 1200,
        "status": "warning"
      }
    ],
    "error_apis": [
      {
        "endpoint": "POST /api/v4/console/lottery-campaigns/draw",
        "error_rate": 0.05,
        "error_count": 23,
        "common_error": "INSUFFICIENT_BALANCE"
      }
    ]
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

### 4.7 é¢„ç®—é¢„æµ‹API

**å·¥æ—¶**: 1å¤©  
**ä¼˜å…ˆçº§**: P1  
**ä¾èµ–è¡¨**: lottery_draws, lottery_management_settings

#### 4.7.1 é¢„ç®—é¢„æµ‹æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v4/console/lottery-health/budget-forecast`

**æ•°æ®åº“æŸ¥è¯¢**:
```sql
-- è·å–å½“å‰é¢„ç®—é…ç½®
SELECT daily_budget, monthly_budget, current_month_spent
FROM lottery_management_settings
WHERE is_active = 1;

-- è®¡ç®—è¿‘7å¤©æ—¥å‡æ¶ˆè€—
SELECT AVG(daily_cost) as avg_daily_cost
FROM (
  SELECT DATE(created_at) as date, SUM(prize_value) as daily_cost
  FROM lottery_draws
  WHERE is_winner = 1 AND created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
  GROUP BY DATE(created_at)
) daily_stats;
```

**è®¡ç®—é€»è¾‘**:
```javascript
async function getBudgetForecast() {
  const config = await LotterySettings.findOne({ where: { is_active: true } });
  const avgDailyCost = await this.calculateAvgDailyCost(7);
  
  // é¢„ç®—æ¶ˆè€—è¿›åº¦
  const consumptionRate = config.current_month_spent / config.monthly_budget;
  
  // é¢„æµ‹å‰©ä½™å¤©æ•°
  const remainingBudget = config.monthly_budget - config.current_month_spent;
  const estimatedDaysRemaining = Math.floor(remainingBudget / avgDailyCost);
  
  // æœˆæœ«é¢„æµ‹æ¶ˆè€—
  const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
  const remainingDays = daysInMonth - new Date().getDate();
  const projectedMonthEnd = config.current_month_spent + (avgDailyCost * remainingDays);
  
  return {
    monthly_budget: config.monthly_budget,
    current_spent: config.current_month_spent,
    consumption_rate: consumptionRate,
    avg_daily_cost: avgDailyCost,
    estimated_days_remaining: estimatedDaysRemaining,
    projected_month_end: projectedMonthEnd,
    is_over_budget: projectedMonthEnd > config.monthly_budget
  };
}
```

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "monthly_budget": 100000,
    "current_spent": 65000,
    "consumption_rate": 0.65,
    "avg_daily_cost": 3500,
    "estimated_days_remaining": 10,
    "projected_month_end": 95000,
    "is_over_budget": false,
    "alerts": [
      { "level": "warning", "message": "é¢„ç®—æ¶ˆè€—è¿›åº¦è¶…è¿‡65%ï¼Œå»ºè®®å…³æ³¨" }
    ]
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

### 4.8 æ—¶é—´å¯¹æ¯”åŠŸèƒ½API

**å·¥æ—¶**: 1å¤©  
**ä¼˜å…ˆçº§**: P1  
**ä¾èµ–è¡¨**: lottery_draws, consumption_records, users

#### 4.8.1 æ ¸å¿ƒæŒ‡æ ‡æ—¶é—´å¯¹æ¯”æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v4/console/dashboard/time-comparison`

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| metrics | string[] | æŒ‡æ ‡åˆ—è¡¨ï¼šconsumption,lottery,users,revenue |
| compare_type | string | å¯¹æ¯”ç±»å‹ï¼šday/week/month |

**æ•°æ®åº“æŸ¥è¯¢**:
```sql
-- ä»Šæ—¥vsæ˜¨æ—¥æ¶ˆè´¹é‡‘é¢å¯¹æ¯”
SELECT 
  (SELECT SUM(amount) FROM consumption_records WHERE DATE(created_at) = CURDATE()) as today,
  (SELECT SUM(amount) FROM consumption_records WHERE DATE(created_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)) as yesterday;

-- æœ¬å‘¨vsä¸Šå‘¨æŠ½å¥–æ¬¡æ•°å¯¹æ¯”
SELECT 
  (SELECT COUNT(*) FROM lottery_draws WHERE YEARWEEK(created_at, 1) = YEARWEEK(CURDATE(), 1)) as this_week,
  (SELECT COUNT(*) FROM lottery_draws WHERE YEARWEEK(created_at, 1) = YEARWEEK(DATE_SUB(CURDATE(), INTERVAL 1 WEEK), 1)) as last_week;
```

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "day_comparison": {
      "consumption": { "today": 12500, "yesterday": 10800, "change": 15.7, "trend": "up" },
      "lottery_draws": { "today": 856, "yesterday": 902, "change": -5.1, "trend": "down" },
      "active_users": { "today": 42, "yesterday": 42, "change": 0, "trend": "stable" }
    },
    "week_comparison": {
      "consumption": { "this_week": 85000, "last_week": 72000, "change": 18.1, "trend": "up" },
      "lottery_draws": { "this_week": 5980, "last_week": 6200, "change": -3.5, "trend": "down" }
    },
    "highlights": [
      { "metric": "consumption", "message": "æ¶ˆè´¹é‡‘é¢ç¯æ¯”ä¸Šæ¶¨18.1%", "level": "positive" },
      { "metric": "lottery_draws", "message": "æŠ½å¥–æ¬¡æ•°ç¯æ¯”ä¸‹é™3.5%", "level": "warning" }
    ]
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

### 4.9 è§’è‰²æƒé™çŸ©é˜µåç«¯

**å·¥æ—¶**: 0.5å¤©  
**ä¼˜å…ˆçº§**: P1  
**ä¾èµ–è¡¨**: users, user_roles

#### 4.9.1 æƒé™éªŒè¯ä¸­é—´ä»¶

**å®ç°é€»è¾‘**:
```javascript
// æƒé™çŸ©é˜µå®šä¹‰
const PERMISSION_MATRIX = {
  admin: { level: 100, pages: ['*'], operations: ['*'] },
  regional_manager: { level: 80, pages: ['pending', 'dashboard', 'users', 'lottery'], operations: ['view', 'edit_region'] },
  business_manager: { level: 60, pages: ['pending', 'dashboard', 'users'], operations: ['view'] },
  merchant_manager: { level: 40, pages: ['pending', 'users'], operations: ['view_own'] },
  ops: { level: 30, pages: ['pending', 'customer_service'], operations: ['review', 'chat'] }
};

// æƒé™éªŒè¯ä¸­é—´ä»¶
function requirePermission(requiredLevel, operation = 'view') {
  return async (req, res, next) => {
    const userRole = req.user.role;
    const permission = PERMISSION_MATRIX[userRole];
    
    if (!permission || permission.level < requiredLevel) {
      return res.status(403).json({
        success: false,
        code: 'PERMISSION_DENIED',
        message: 'æƒé™ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œæ­¤æ“ä½œ',
        data: { required_level: requiredLevel, current_level: permission?.level || 0 }
      });
    }
    
    // æ£€æŸ¥æ“ä½œæƒé™
    if (operation !== 'view' && !permission.operations.includes('*') && !permission.operations.includes(operation)) {
      return res.status(403).json({
        success: false,
        code: 'OPERATION_DENIED',
        message: `æ— æƒæ‰§è¡Œæ“ä½œ: ${operation}`
      });
    }
    
    next();
  };
}
```

#### 4.9.2 ç”¨æˆ·æƒé™æŸ¥è¯¢æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v4/console/staff/permissions`

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "role": "regional_manager",
    "level": 80,
    "allowed_pages": ["pending", "dashboard", "users", "lottery"],
    "allowed_operations": ["view", "edit_region"],
    "data_scope": "region"
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

### 4.10 å†³ç­–è¾…åŠ©ä¿¡æ¯API

**å·¥æ—¶**: 0.5å¤©  
**ä¼˜å…ˆçº§**: P1  
**ä¾èµ–è¡¨**: consumption_records, users, customer_service_sessions

#### 4.10.1 å®¡æ ¸è¾…åŠ©ä¿¡æ¯æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v4/console/consumption/:id/assist-info`

**æ•°æ®åº“æŸ¥è¯¢**:
```sql
-- ç”¨æˆ·å†å²å®¡æ ¸é€šè¿‡ç‡
SELECT 
  COUNT(*) as total_records,
  SUM(CASE WHEN status = 'approved' THEN 1 ELSE 0 END) as approved_count,
  SUM(CASE WHEN status = 'approved' THEN 1 ELSE 0 END) / COUNT(*) as approval_rate
FROM consumption_records
WHERE user_id = ? AND created_at >= DATE_SUB(CURDATE(), INTERVAL 30 DAY);

-- ç”¨æˆ·é£é™©ç­‰çº§
SELECT risk_level, risk_score FROM user_risk_profiles WHERE user_id = ?;

-- ç›¸ä¼¼è®°å½•å¤„ç†æ–¹å¼
SELECT status, COUNT(*) as count
FROM consumption_records
WHERE merchant_id = ? AND amount BETWEEN ? * 0.8 AND ? * 1.2
GROUP BY status;
```

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "user_history": {
      "total_records": 15,
      "approval_rate": 0.93,
      "recent_rejected": 1
    },
    "risk_profile": {
      "level": "low",
      "score": 15
    },
    "similar_records": {
      "approved": 45,
      "rejected": 3,
      "pending": 2
    },
    "recommendation": {
      "action": "approve",
      "confidence": 0.85,
      "reason": "ç”¨æˆ·å†å²é€šè¿‡ç‡93%ï¼Œé£é™©ç­‰çº§ä½"
    }
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

### 4.11 å†å²å®¡æ ¸ç‡æ˜¾ç¤ºAPI

**å·¥æ—¶**: 0.5å¤©  
**ä¼˜å…ˆçº§**: P1  
**ä¾èµ–è¡¨**: consumption_records

#### 4.11.1 ç”¨æˆ·å®¡æ ¸ç‡æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v4/console/users/:user_id/approval-rate`

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "user_id": 123,
    "period": "30d",
    "total_records": 12,
    "approved": 11,
    "rejected": 1,
    "approval_rate": 0.917,
    "trend": "stable",
    "comparison": {
      "platform_avg": 0.89,
      "vs_avg": "+2.7%"
    }
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

### 4.12 ç³»ç»Ÿå‘Šè­¦Tab API

**å·¥æ—¶**: 0.5å¤©  
**ä¼˜å…ˆçº§**: P1  
**æ–°å»ºæœåŠ¡**: SystemHealthService

#### 4.12.1 ç³»ç»Ÿå¥åº·çŠ¶æ€æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v4/console/system/health-status`

**æ£€æŸ¥é¡¹ç›®**:
```javascript
async function getSystemHealthStatus() {
  const checks = await Promise.all([
    this.checkDatabaseHealth(),
    this.checkRedisHealth(),
    this.checkAPIHealth()
  ]);
  
  return {
    database: checks[0],
    redis: checks[1],
    api: checks[2],
    overall: this.calculateOverallStatus(checks)
  };
}

async function checkDatabaseHealth() {
  const start = Date.now();
  try {
    await sequelize.authenticate();
    const latency = Date.now() - start;
    return { status: 'healthy', latency, message: 'Database connection OK' };
  } catch (error) {
    return { status: 'unhealthy', error: error.message };
  }
}
```

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "overall": "healthy",
    "components": {
      "database": { "status": "healthy", "latency": 15, "connections": 10 },
      "redis": { "status": "healthy", "latency": 2, "memory_usage": "45MB" },
      "api": { "status": "healthy", "avg_response": 125, "error_rate": 0.02 }
    },
    "alerts": [],
    "last_check": "2026-02-03T10:30:00+08:00"
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

### 4.13 ç³»ç»Ÿå«ä»˜çœ‹æ¿API

**å·¥æ—¶**: 0.5å¤©  
**ä¼˜å…ˆçº§**: P1  
**ä¾èµ–è¡¨**: lottery_draws, lottery_management_settings

#### 4.13.1 ç³»ç»Ÿå«ä»˜ç»Ÿè®¡æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v4/console/debt-management/system-advance`

**æ•°æ®åº“æŸ¥è¯¢**:
```sql
-- ç³»ç»Ÿå«ä»˜ç»Ÿè®¡ï¼ˆé¢„è®¾è§„åˆ™äº§ç”Ÿçš„æ¬ è´¦ï¼‰
SELECT 
  preset_id,
  SUM(CASE WHEN advance_amount > 0 THEN advance_amount ELSE 0 END) as total_advance,
  COUNT(CASE WHEN advance_amount > 0 THEN 1 END) as advance_count
FROM lottery_draws
WHERE is_preset = 1 AND created_at >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
GROUP BY preset_id;
```

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "total_advance": 125000,
    "by_preset": [
      { "preset_id": 1, "name": "æ–°æ‰‹ä¿åº•", "advance": 50000, "count": 120 },
      { "preset_id": 2, "name": "å›æµæ¿€åŠ±", "advance": 75000, "count": 85 }
    ],
    "trend_7d": [],
    "recovery_rate": 0.65
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

### 4.14 ä¸­å¥–ç‡è¶‹åŠ¿API

**å·¥æ—¶**: 0.5å¤©  
**ä¼˜å…ˆçº§**: P1  
**ä¾èµ–è¡¨**: lottery_draws

#### 4.14.1 ä¸­å¥–ç‡è¶‹åŠ¿æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v4/console/lottery-strategy-stats/win-rate-trend`

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| granularity | string | hour/day |
| days | int | æŸ¥è¯¢å¤©æ•°ï¼Œé»˜è®¤7 |

**æ•°æ®åº“æŸ¥è¯¢**:
```sql
-- æŒ‰å°æ—¶ç»Ÿè®¡ä¸­å¥–ç‡
SELECT 
  DATE_FORMAT(created_at, '%Y-%m-%d %H:00') as time_slot,
  COUNT(*) as total_draws,
  SUM(CASE WHEN is_winner = 1 THEN 1 ELSE 0 END) as wins,
  SUM(CASE WHEN is_winner = 1 THEN 1 ELSE 0 END) / COUNT(*) as win_rate
FROM lottery_draws
WHERE created_at >= DATE_SUB(NOW(), INTERVAL ? DAY)
GROUP BY DATE_FORMAT(created_at, '%Y-%m-%d %H:00')
ORDER BY time_slot;
```

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "trend": [
      { "time": "2026-02-03 09:00", "total": 120, "wins": 28, "rate": 0.233 },
      { "time": "2026-02-03 10:00", "total": 145, "wins": 35, "rate": 0.241 }
    ],
    "summary": {
      "avg_rate": 0.235,
      "max_rate": { "time": "2026-02-02 20:00", "rate": 0.312 },
      "min_rate": { "time": "2026-02-03 06:00", "rate": 0.156 }
    },
    "anomalies": [
      { "time": "2026-02-02 20:00", "rate": 0.312, "message": "ä¸­å¥–ç‡å¼‚å¸¸åé«˜" }
    ]
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

### 4.15 å®¢æœå“åº”æ—¶é•¿æŒ‡æ ‡

**å·¥æ—¶**: 0.5å¤©  
**ä¼˜å…ˆçº§**: P1  
**ä¾èµ–è¡¨**: customer_service_sessions

#### 4.7.1 å®¢æœå“åº”ç»Ÿè®¡æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v4/console/customer-service/sessions/response-stats`

**æ•°æ®åº“æŸ¥è¯¢**:
```sql
SELECT 
  DATE(created_at) as date,
  COUNT(*) as session_count,
  AVG(TIMESTAMPDIFF(SECOND, created_at, first_response_at)) as avg_response_seconds,
  MAX(TIMESTAMPDIFF(SECOND, created_at, first_response_at)) as max_response_seconds,
  SUM(CASE WHEN TIMESTAMPDIFF(SECOND, created_at, first_response_at) <= 60 THEN 1 ELSE 0 END) / COUNT(*) as within_1min_rate
FROM customer_service_sessions
WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
  AND first_response_at IS NOT NULL
GROUP BY DATE(created_at)
ORDER BY date DESC;
```

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "today": {
      "avg_response_seconds": 45,
      "max_response_seconds": 180,
      "within_1min_rate": 0.85,
      "session_count": 12
    },
    "trend_7d": [
      { "date": "2026-02-03", "avg_seconds": 45, "within_1min_rate": 0.85 }
    ],
    "benchmark": {
      "target_seconds": 60,
      "target_rate": 0.9
    }
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

---

## äº”ã€P2 å¢å¼ºåŠŸèƒ½

### 5.1 èµ„äº§æµåŠ¨API

**å·¥æ—¶**: 2å¤©  
**ä¼˜å…ˆçº§**: P2  
**ä¾èµ–è¡¨**: asset_transactions, account_asset_balances, material_asset_types

#### 5.1.1 èµ„äº§æµåŠ¨æ¦‚è§ˆ

**æ¥å£è·¯å¾„**: `GET /api/v4/console/assets/flow-overview`

**æ•°æ®åº“æŸ¥è¯¢**:
```sql
-- èµ„äº§å‘æ”¾/æ¶ˆè€—ç»Ÿè®¡
SELECT 
  asset_code,
  SUM(CASE WHEN amount > 0 THEN amount ELSE 0 END) as total_issuance,
  SUM(CASE WHEN amount < 0 THEN ABS(amount) ELSE 0 END) as total_consumption,
  COUNT(DISTINCT user_id) as affected_users
FROM asset_transactions
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY asset_code;

-- ç³»ç»Ÿè´¦æˆ·ä½™é¢
SELECT asset_code, balance
FROM account_asset_balances
WHERE user_id = 0;  -- ç³»ç»Ÿè´¦æˆ·
```

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "overview": {
      "total_issuance": 500000,
      "total_consumption": 420000,
      "balance_ratio": 1.19,
      "health_status": "healthy"
    },
    "by_asset": [
      {
        "asset_code": "DIAMOND",
        "asset_name": "é’»çŸ³",
        "issuance": 300000,
        "consumption": 250000,
        "ratio": 1.2,
        "system_balance": 1500000
      }
    ],
    "trend_7d": [],
    "alerts": [
      {
        "type": "low_balance",
        "asset_code": "GOLD",
        "message": "ç³»ç»ŸGOLDä½™é¢ä½äº10ä¸‡ï¼Œå»ºè®®è¡¥å……"
      }
    ]
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

#### 5.1.2 èµ„äº§æµæ°´æ˜ç»†

**æ¥å£è·¯å¾„**: `GET /api/v4/console/assets/transactions`

**æŸ¥è¯¢å‚æ•°**ï¼ˆéµå¾ª2.5.2å­—æ®µå‘½åè§„èŒƒï¼‰:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| asset_code | string | èµ„äº§ç±»å‹ |
| business_type | string | ä¸šåŠ¡ç±»å‹ï¼ˆæ›¿ä»£change_typeï¼‰ |
| user_id | int | ç”¨æˆ·ID |
| min_delta_amount | int | æœ€å°å˜åŠ¨é‡‘é¢ï¼ˆæ›¿ä»£min_amountï¼‰ |
| start_date | date | å¼€å§‹æ—¥æœŸ |
| end_date | date | ç»“æŸæ—¥æœŸ |
| page | int | é¡µç  |
| page_size | int | æ¯é¡µæ•°é‡ |

#### 5.1.3 èµ„äº§å‘æ”¾æ¶ˆè€—æ¯”

**æ¥å£è·¯å¾„**: `GET /api/v4/console/assets/issuance-consumption-ratio`

### 5.2 æ•°æ®å¯¼å‡ºæ¥å£

**å·¥æ—¶**: 3å¤©  
**ä¼˜å…ˆçº§**: P2  
**æ–°å»ºæœåŠ¡**: DataExportService

#### 5.2.1 é€šç”¨å¯¼å‡ºæ¥å£

**æ¥å£è·¯å¾„**: `POST /api/v4/console/export`

**è¯·æ±‚ä½“**:
```json
{
  "export_type": "consumption_records",
  "format": "xlsx",
  "filters": {
    "start_date": "2026-02-01",
    "end_date": "2026-02-03",
    "status": "approved"
  },
  "scope": "filtered",  // all | filtered | current_page
  "include_sensitive": false
}
```

**æ”¯æŒçš„å¯¼å‡ºç±»å‹**:
| å¯¼å‡ºç±»å‹ | æ ¼å¼ | åŒ…å«å­—æ®µ | è„±æ•è§„åˆ™ |
|----------|------|----------|----------|
| consumption_records | xlsx | ç”¨æˆ·åã€é‡‘é¢ã€é—¨åº—ã€æ¶ˆè´¹æ—¶é—´ã€å®¡æ ¸çŠ¶æ€ | æ‰‹æœºå·ä¸­é—´4ä½**** |
| user_list | csv | ç”¨æˆ·IDã€æ˜µç§°ã€æ‰‹æœºå·ã€æ³¨å†Œæ—¶é—´ã€è§’è‰²ã€çŠ¶æ€ | æ‰‹æœºå·ä¸­é—´4ä½**** |
| alert_history | xlsx | å‘Šè­¦IDã€ç±»å‹ã€çº§åˆ«ã€è§¦å‘æ—¶é—´ã€å¤„ç†äºº | æ—  |
| lottery_records | xlsx | ç”¨æˆ·IDã€æŠ½å¥–æ—¶é—´ã€å¥–å“åç§°ã€æ˜¯å¦ä¸­å¥– | æ—  |
| asset_transactions | xlsx | æµæ°´IDã€ç”¨æˆ·IDã€èµ„äº§ç±»å‹ã€å˜åŠ¨é‡‘é¢ã€ä½™é¢ | æ—  |

**å¤§æ•°æ®é‡å¤„ç†**:
```javascript
class DataExportService {
  static async exportLargeData(type, filters, format) {
    const BATCH_SIZE = 1000;
    const tempFile = `/tmp/export_${Date.now()}.${format}`;
    
    let offset = 0;
    let hasMore = true;
    
    while (hasMore) {
      const batch = await this.fetchBatch(type, filters, offset, BATCH_SIZE);
      await this.appendToFile(tempFile, batch, format);
      
      offset += BATCH_SIZE;
      hasMore = batch.length === BATCH_SIZE;
      
      // æ›´æ–°è¿›åº¦
      await this.updateProgress(exportId, offset);
    }
    
    return tempFile;
  }
}
```

**å“åº”æ ¼å¼**ï¼ˆå¼‚æ­¥å¯¼å‡ºï¼‰:
```json
{
  "success": true,
  "code": "EXPORT_STARTED",
  "message": "å¯¼å‡ºä»»åŠ¡å·²åˆ›å»º",
  "data": {
    "export_id": "EXP_20260203_001",
    "status": "processing",
    "progress": 0,
    "estimated_time": 30
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

#### 5.2.2 å¯¼å‡ºè¿›åº¦æŸ¥è¯¢

**æ¥å£è·¯å¾„**: `GET /api/v4/console/export/:id/status`

#### 5.2.3 å¯¼å‡ºæ–‡ä»¶ä¸‹è½½

**æ¥å£è·¯å¾„**: `GET /api/v4/console/export/:id/download`

### 5.3 å®¡è®¡æ—¥å¿—å¢å¼º

**å·¥æ—¶**: 1å¤©  
**ä¼˜å…ˆçº§**: P2  
**ä¾èµ–è¡¨**: admin_operation_logs

#### 5.3.1 å®¡è®¡æ—¥å¿—æŸ¥è¯¢æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v4/console/audit-logs`

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| operator_id | int | æ“ä½œäººID |
| action_type | string | æ“ä½œç±»å‹ |
| target_type | string | ç›®æ ‡ç±»å‹ |
| target_id | string | ç›®æ ‡ID |
| start_time | datetime | å¼€å§‹æ—¶é—´ |
| end_time | datetime | ç»“æŸæ—¶é—´ |
| page | int | é¡µç  |
| page_size | int | æ¯é¡µæ•°é‡ |

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "items": [
      {
        "id": 5273,
        "operator": { "id": 1, "name": "ç®¡ç†å‘˜A", "role": "admin" },
        "action_type": "APPROVE",
        "target_type": "consumption_record",
        "target_id": "48",
        "detail": {
          "before": { "status": "pending" },
          "after": { "status": "approved" },
          "reason": "æ¶ˆè´¹å‡­è¯å®¡æ ¸é€šè¿‡"
        },
        "ip_address": "192.168.1.100",
        "user_agent": "Mozilla/5.0...",
        "created_at": "2026-02-03T10:30:00+08:00"
      }
    ]
  },
  "pagination": {
    "total": 5273,
    "page": 1,
    "limit": 20,
    "total_pages": 264,
    "has_next": true,
    "has_prev": false
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

### 5.4 ç‰©å“é”å®šç‡ç›‘æ§

**å·¥æ—¶**: 0.5å¤©  
**ä¼˜å…ˆçº§**: P2  
**ä¾èµ–è¡¨**: item_instances

#### 5.4.1 é”å®šç‡ç›‘æ§æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v4/console/item-templates/lock-rate`

**æ•°æ®åº“æŸ¥è¯¢**:
```sql
SELECT 
  COUNT(*) as total_items,
  SUM(CASE WHEN status = 'locked' THEN 1 ELSE 0 END) as locked_items,
  SUM(CASE WHEN status = 'locked' THEN 1 ELSE 0 END) / COUNT(*) as lock_rate
FROM item_instances;
```

**å‘Šè­¦è§„åˆ™**:
- é”å®šç‡ > 20%ï¼šè§¦å‘warningå‘Šè­¦
- é”å®šç‡ > 40%ï¼šè§¦å‘criticalå‘Šè­¦

### 5.5 ç³»ç»Ÿä½™é¢é¢„è­¦

**å·¥æ—¶**: 0.5å¤©  
**ä¼˜å…ˆçº§**: P2  
**ä¾èµ–è¡¨**: account_asset_balances

#### 5.5.1 ä½™é¢é¢„è­¦æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v4/console/system/balance-alerts`

**é¢„è­¦è§„åˆ™**:
```javascript
const BALANCE_THRESHOLDS = {
  DIAMOND: { warning: 100000, critical: 50000 },
  GOLD: { warning: 200000, critical: 100000 }
};

async function checkBalanceAlerts() {
  const systemBalances = await AccountAssetBalance.findAll({
    where: { user_id: 0 }  // ç³»ç»Ÿè´¦æˆ·
  });
  
  const alerts = [];
  for (const balance of systemBalances) {
    const threshold = BALANCE_THRESHOLDS[balance.asset_code];
    if (threshold) {
      if (balance.balance < threshold.critical) {
        alerts.push({ level: 'critical', asset_code: balance.asset_code, balance: balance.balance });
      } else if (balance.balance < threshold.warning) {
        alerts.push({ level: 'warning', asset_code: balance.asset_code, balance: balance.balance });
      }
    }
  }
  
  return alerts;
}
```

### 5.6 ç­–ç•¥æ•ˆæœå¯¹æ¯”API

**å·¥æ—¶**: 0.5å¤©  
**ä¼˜å…ˆçº§**: P2  
**ä¾èµ–è¡¨**: lottery_draws, lottery_management_settings

#### 5.6.1 ç­–ç•¥å¯¹æ¯”æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v4/console/lottery-strategy-stats/strategy-comparison`

**æ•°æ®åº“æŸ¥è¯¢**:
```sql
-- ä¸åŒç­–ç•¥çš„æ•ˆæœå¯¹æ¯”
SELECT 
  lms.strategy_name,
  COUNT(ld.id) as total_draws,
  SUM(CASE WHEN ld.is_winner = 1 THEN 1 ELSE 0 END) as wins,
  SUM(CASE WHEN ld.is_winner = 1 THEN 1 ELSE 0 END) / COUNT(*) as win_rate,
  SUM(ld.prize_value) as total_prize_value,
  AVG(ld.prize_value) as avg_prize_value
FROM lottery_draws ld
JOIN lottery_management_settings lms ON ld.setting_id = lms.id
WHERE ld.created_at >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
GROUP BY lms.strategy_name
ORDER BY total_draws DESC;
```

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "strategies": [
      {
        "name": "æ ‡å‡†ç­–ç•¥",
        "total_draws": 5000,
        "win_rate": 0.23,
        "avg_prize_value": 150,
        "roi": 1.2
      },
      {
        "name": "æ–°æ‰‹æ¿€åŠ±",
        "total_draws": 1200,
        "win_rate": 0.35,
        "avg_prize_value": 200,
        "roi": 0.8
      }
    ],
    "recommendation": "æ ‡å‡†ç­–ç•¥ROIæœ€é«˜ï¼Œå»ºè®®ç»§ç»­ä½¿ç”¨"
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

### 5.7 ç”¨æˆ·åˆ†å±‚åˆ†å¸ƒAPI

**å·¥æ—¶**: 0.5å¤©  
**ä¼˜å…ˆçº§**: P2  
**ä¾èµ–è¡¨**: users, lottery_draws, user_risk_profiles

#### 5.7.1 ç”¨æˆ·åˆ†å±‚ç»Ÿè®¡æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v4/console/lottery-health/user-tier-distribution`

**æ•°æ®åº“æŸ¥è¯¢**:
```sql
-- ç”¨æˆ·åˆ†å±‚æŠ½å¥–æƒ…å†µ
SELECT 
  CASE 
    WHEN lottery_count >= 100 THEN 'heavy'
    WHEN lottery_count >= 30 THEN 'medium'
    WHEN lottery_count >= 5 THEN 'light'
    ELSE 'new'
  END as user_tier,
  COUNT(DISTINCT user_id) as user_count,
  SUM(lottery_count) as total_draws,
  AVG(win_rate) as avg_win_rate
FROM (
  SELECT 
    user_id,
    COUNT(*) as lottery_count,
    SUM(CASE WHEN is_winner = 1 THEN 1 ELSE 0 END) / COUNT(*) as win_rate
  FROM lottery_draws
  WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
  GROUP BY user_id
) user_stats
GROUP BY user_tier;
```

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "tiers": [
      { "tier": "heavy", "label": "é‡åº¦ç”¨æˆ·", "user_count": 15, "draw_count": 3500, "avg_win_rate": 0.22 },
      { "tier": "medium", "label": "ä¸­åº¦ç”¨æˆ·", "user_count": 25, "draw_count": 1500, "avg_win_rate": 0.24 },
      { "tier": "light", "label": "è½»åº¦ç”¨æˆ·", "user_count": 10, "draw_count": 200, "avg_win_rate": 0.28 },
      { "tier": "new", "label": "æ–°ç”¨æˆ·", "user_count": 5, "draw_count": 50, "avg_win_rate": 0.35 }
    ],
    "insights": [
      { "type": "info", "message": "æ–°ç”¨æˆ·ä¸­å¥–ç‡æœ€é«˜(35%)ï¼Œæ¿€åŠ±ç­–ç•¥æœ‰æ•ˆ" }
    ]
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

### 5.8 ä¸€é”®åˆ†æåŠŸèƒ½API

**å·¥æ—¶**: 0.5å¤©  
**ä¼˜å…ˆçº§**: P2  
**ä¾èµ–æœåŠ¡**: UserBehaviorService, AssetService

#### 5.8.1 ç”¨æˆ·å¿«é€Ÿåˆ†ææ¥å£

**æ¥å£è·¯å¾„**: `POST /api/v4/console/users/:user_id/quick-analysis`

**å®ç°é€»è¾‘**:
```javascript
async function generateQuickAnalysis(userId) {
  const [
    basicInfo,
    assetSummary,
    behaviorStats,
    riskProfile,
    anomalies
  ] = await Promise.all([
    UserService.getBasicInfo(userId),
    AssetService.getUserAssetSummary(userId),
    UserBehaviorService.getStats(userId),
    RiskService.getProfile(userId),
    AnomalyService.getUserAnomalies(userId)
  ]);

  // ç”Ÿæˆåˆ†ææŠ¥å‘Š
  const analysis = {
    user_id: userId,
    generated_at: new Date().toISOString(),
    summary: this.generateSummary(basicInfo, assetSummary, behaviorStats),
    risk_assessment: this.assessRisk(riskProfile, anomalies),
    recommendations: this.generateRecommendations(behaviorStats, riskProfile),
    highlights: this.extractHighlights(assetSummary, behaviorStats)
  };

  return analysis;
}
```

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "åˆ†æå®Œæˆ",
  "data": {
    "user_id": 123,
    "generated_at": "2026-02-03T10:30:00+08:00",
    "summary": "æ´»è·ƒç”¨æˆ·ï¼Œç´¯è®¡æŠ½å¥–156æ¬¡ï¼Œæ¶ˆè´¹12ç¬”å…±3500å…ƒï¼Œèµ„äº§ä»·å€¼125000",
    "risk_assessment": {
      "level": "low",
      "score": 15,
      "factors": []
    },
    "recommendations": [
      "ç”¨æˆ·æ´»è·ƒåº¦é«˜ï¼Œå¯è€ƒè™‘VIPæ¿€åŠ±",
      "æ¶ˆè´¹é¢‘ç‡ç¨³å®šï¼Œæ— å¼‚å¸¸"
    ],
    "highlights": [
      { "type": "positive", "text": "è¿‘7å¤©æ´»è·ƒåº¦æå‡20%" },
      { "type": "neutral", "text": "ä¸­å¥–ç‡23%ï¼Œå¤„äºæ­£å¸¸èŒƒå›´" }
    ]
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

### 5.9 å‘Šè­¦ç–²åŠ³é¢„é˜²æœºåˆ¶

**å·¥æ—¶**: 1å¤©  
**ä¼˜å…ˆçº§**: P2  
**ä¾èµ–æœåŠ¡**: LotteryAlertService

#### 5.6.1 å‘Šè­¦åˆå¹¶è§„åˆ™

**åˆå¹¶ç­–ç•¥**:
```javascript
const ALERT_MERGE_CONFIG = {
  // åŒç±»å‘Šè­¦åˆå¹¶çª—å£
  mergeWindow: 300,  // 5åˆ†é’Ÿ
  // æœ€å¤§åˆå¹¶æ•°é‡
  maxMergeCount: 10,
  // åˆå¹¶åå‡çº§è§„åˆ™
  escalationRules: {
    5: 'warning',   // 5æ¡åŒç±»å‘Šè­¦å‡çº§ä¸ºwarning
    10: 'critical'  // 10æ¡åŒç±»å‘Šè­¦å‡çº§ä¸ºcritical
  }
};

async function processAlert(newAlert) {
  const recentSimilar = await Alert.findAll({
    where: {
      category: newAlert.category,
      created_at: { [Op.gte]: new Date(Date.now() - ALERT_MERGE_CONFIG.mergeWindow * 1000) },
      merged_into: null
    }
  });
  
  if (recentSimilar.length >= ALERT_MERGE_CONFIG.maxMergeCount) {
    // åˆå¹¶å‘Šè­¦
    return this.mergeAlerts(recentSimilar, newAlert);
  }
  
  return Alert.create(newAlert);
}
```

#### 5.6.2 å‘Šè­¦é™é»˜æ¥å£

**æ¥å£è·¯å¾„**: `POST /api/v4/console/risk-alerts/silence`

**è¯·æ±‚ä½“**:
```json
{
  "category": "lottery",
  "duration_minutes": 60,
  "reason": "æ­£åœ¨è¿›è¡Œè¥é”€æ´»åŠ¨"
}
```

---

## å…­ã€P3 ä½ä¼˜å…ˆçº§åŠŸèƒ½

### 6.1 è½¬åŒ–æ¼æ–—API

**å·¥æ—¶**: 2å¤©  
**ä¼˜å…ˆçº§**: P3  
**ä¾èµ–è¡¨**: users, lottery_draws, consumption_records, trade_orders

#### 6.1.1 è½¬åŒ–æ¼æ–—æ•°æ®æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v4/console/analytics/conversion-funnel`

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| start_date | date | å¼€å§‹æ—¥æœŸ |
| end_date | date | ç»“æŸæ—¥æœŸ |

**æ•°æ®åº“æŸ¥è¯¢**:
```sql
-- 5å±‚æ¼æ–—æ•°æ®
SELECT 
  (SELECT COUNT(DISTINCT user_id) FROM users WHERE created_at BETWEEN ? AND ?) as registered,
  (SELECT COUNT(DISTINCT user_id) FROM lottery_draws WHERE created_at BETWEEN ? AND ?) as lottery_participated,
  (SELECT COUNT(DISTINCT user_id) FROM lottery_draws WHERE is_winner = 1 AND created_at BETWEEN ? AND ?) as won_prize,
  (SELECT COUNT(DISTINCT user_id) FROM consumption_records WHERE created_at BETWEEN ? AND ?) as consumed,
  (SELECT COUNT(DISTINCT buyer_user_id) FROM trade_orders WHERE created_at BETWEEN ? AND ?) as traded;
```

**è®¡ç®—é€»è¾‘**:
```javascript
async function getConversionFunnel(startDate, endDate) {
  const stages = await this.queryFunnelData(startDate, endDate);
  
  return {
    stages: [
      { name: 'æ³¨å†Œç”¨æˆ·', count: stages.registered, rate: 1 },
      { name: 'å‚ä¸æŠ½å¥–', count: stages.lottery_participated, rate: stages.lottery_participated / stages.registered },
      { name: 'è·å¾—å¥–å“', count: stages.won_prize, rate: stages.won_prize / stages.lottery_participated },
      { name: 'äº§ç”Ÿæ¶ˆè´¹', count: stages.consumed, rate: stages.consumed / stages.won_prize },
      { name: 'å‚ä¸äº¤æ˜“', count: stages.traded, rate: stages.traded / stages.consumed }
    ],
    overall_conversion: stages.traded / stages.registered,
    bottleneck: this.identifyBottleneck(stages)
  };
}
```

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "stages": [
      { "name": "æ³¨å†Œç”¨æˆ·", "count": 55, "rate": 1, "drop_rate": 0 },
      { "name": "å‚ä¸æŠ½å¥–", "count": 48, "rate": 0.87, "drop_rate": 0.13 },
      { "name": "è·å¾—å¥–å“", "count": 35, "rate": 0.73, "drop_rate": 0.27 },
      { "name": "äº§ç”Ÿæ¶ˆè´¹", "count": 20, "rate": 0.57, "drop_rate": 0.43 },
      { "name": "å‚ä¸äº¤æ˜“", "count": 8, "rate": 0.40, "drop_rate": 0.60 }
    ],
    "overall_conversion": 0.145,
    "bottleneck": {
      "stage": "äº§ç”Ÿæ¶ˆè´¹â†’å‚ä¸äº¤æ˜“",
      "drop_rate": 0.60,
      "suggestion": "äº¤æ˜“è½¬åŒ–ç‡è¾ƒä½ï¼Œå»ºè®®ä¼˜åŒ–äº¤æ˜“æµç¨‹æˆ–å¢åŠ äº¤æ˜“æ¿€åŠ±"
    }
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

### 6.2 å•†æˆ·è´¡çŒ®åº¦APIï¼ˆæ‰©å±•ç‰ˆï¼‰

**å·¥æ—¶**: 2.5å¤©  
**ä¼˜å…ˆçº§**: P3  
**ä¾èµ–è¡¨**: consumption_records, usersï¼ˆå•†æˆ·è§’è‰²ï¼‰

> **ğŸ“‹ ä¸šåŠ¡æ¨¡å‹è¯´æ˜ï¼ˆ2026-02-03 ç¡®è®¤ï¼‰**ï¼š
> - æœ¬é¡¹ç›®**ä¸ä½¿ç”¨ç‹¬ç«‹çš„ `merchants` è¡¨**ï¼Œå•†æˆ·æ•°æ®å­˜å‚¨åœ¨ `users` è¡¨ä¸­
> - å•†æˆ·é€šè¿‡ `consumption_records.merchant_id` å…³è”åˆ° `users.user_id`
> - "å•†æˆ·"å®šä¹‰ï¼š**æ‰€æœ‰ä½œä¸ºå•†æˆ·è§’è‰²å½•å…¥è¿‡æ¶ˆè´¹è®°å½•çš„ç”¨æˆ·**
> - å•†æˆ·è´¡çŒ®åº¦æ¥å£è¿”å›çš„æ˜¯è¿™äº›ç”¨æˆ·çš„æ¶ˆè´¹è´¡çŒ®æ’è¡Œ
> - `merchant_name` å®é™…å–è‡ª `users.nickname` å­—æ®µ

#### 6.2.1 å•†æˆ·è´¡çŒ®åº¦æ’è¡Œæ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v4/console/stores/contribution`

**æ•°æ®åº“æŸ¥è¯¢**:
```sql
-- å•†æˆ·è´¡çŒ®åº¦æ’è¡Œ
SELECT 
  m.user_id as merchant_id,
  m.nickname as merchant_name,
  COUNT(cr.id) as order_count,
  SUM(cr.amount) as total_amount,
  AVG(cr.amount) as avg_amount,
  SUM(cr.amount) / (SELECT SUM(amount) FROM consumption_records WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)) as contribution_rate
FROM users m
JOIN consumption_records cr ON m.user_id = cr.merchant_id
WHERE m.role = 'merchant_manager'
  AND cr.created_at >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
GROUP BY m.user_id
ORDER BY total_amount DESC;
```

#### 6.2.2 å•†æˆ·æ¶ˆè´¹è¶‹åŠ¿æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v4/console/stores/:store_id/trend`

**æ•°æ®åº“æŸ¥è¯¢**:
```sql
-- å•†æˆ·è¿‘30å¤©æ¶ˆè´¹è¶‹åŠ¿
SELECT 
  DATE(created_at) as date,
  COUNT(*) as order_count,
  SUM(amount) as total_amount
FROM consumption_records
WHERE merchant_id = ?
  AND created_at >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
GROUP BY DATE(created_at)
ORDER BY date;
```

#### 6.2.3 é—¨åº—å¥åº·åº¦è¯„åˆ†æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v4/console/stores/:store_id/health-score`

**è®¡ç®—è§„åˆ™**:
```javascript
function calculateMerchantHealthScore(merchantStats) {
  // æ¶ˆè´¹é‡‘é¢å¾—åˆ†(40%)ï¼šä¸å¹³å°å‡å€¼å¯¹æ¯”
  const amountScore = Math.min(100, (merchantStats.total_amount / platformAvg) * 100) * 0.4;
  
  // æ¶ˆè´¹é¢‘æ¬¡å¾—åˆ†(30%)ï¼šè®¢å•æ•°é‡
  const frequencyScore = Math.min(100, (merchantStats.order_count / 30) * 100) * 0.3;
  
  // å®¢å•ä»·å¾—åˆ†(20%)ï¼šé«˜äºå‡å€¼å¾—é«˜åˆ†
  const avgAmountScore = Math.min(100, (merchantStats.avg_amount / platformAvgAmount) * 100) * 0.2;
  
  // å¢é•¿è¶‹åŠ¿å¾—åˆ†(10%)ï¼šç¯æ¯”å¢é•¿
  const growthScore = merchantStats.growth_rate > 0 ? 100 * 0.1 : 50 * 0.1;
  
  return amountScore + frequencyScore + avgAmountScore + growthScore;
}
```

#### 6.2.4 ç¯æ¯”åŒæ¯”å¯¹æ¯”æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v4/console/stores/:store_id/comparison`

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "this_week": { "amount": 15000, "orders": 25 },
    "last_week": { "amount": 12000, "orders": 20 },
    "week_change": { "amount_rate": 0.25, "orders_rate": 0.25 },
    "this_month": { "amount": 55000, "orders": 90 },
    "last_month": { "amount": 48000, "orders": 82 },
    "month_change": { "amount_rate": 0.146, "orders_rate": 0.098 }
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

### 6.3 èµ„äº§å‘æ”¾æ¶ˆè€—æ¯”API

**å·¥æ—¶**: 0.5å¤©  
**ä¼˜å…ˆçº§**: P3  

**æ¥å£è·¯å¾„**: `GET /api/v4/console/assets/balance-ratio`

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–æˆåŠŸ",
  "data": {
    "period": "30d",
    "by_asset": [
      { "asset_code": "DIAMOND", "issuance": 500000, "consumption": 420000, "ratio": 1.19 },
      { "asset_code": "GOLD", "issuance": 300000, "consumption": 280000, "ratio": 1.07 }
    ],
    "overall_ratio": 1.14,
    "health_status": "healthy",
    "alerts": []
  },
  "timestamp": "2026-02-03T10:30:00.000+08:00",
  "version": "v4.0",
  "request_id": "req_abc123def456"
}
```

### 6.4 PDFæŠ¥è¡¨ç”Ÿæˆ

**å·¥æ—¶**: 1å¤©  
**ä¼˜å…ˆçº§**: P3  

**æ¥å£è·¯å¾„**: `POST /api/v4/console/reports/generate-pdf`

**è¯·æ±‚ä½“**:
```json
{
  "report_type": "daily_summary",
  "date": "2026-02-03",
  "include_sections": ["core_metrics", "health_score", "trends", "alerts"]
}
```

**å®ç°é€»è¾‘**:
```javascript
const PDFDocument = require('pdfkit');

async function generateDailyReport(date, sections) {
  const doc = new PDFDocument();
  const data = await this.aggregateReportData(date, sections);
  
  // æ·»åŠ æ ‡é¢˜
  doc.fontSize(20).text(`è¿è¥æ—¥æŠ¥ - ${date}`, { align: 'center' });
  
  // æ ¸å¿ƒæŒ‡æ ‡
  if (sections.includes('core_metrics')) {
    doc.fontSize(14).text('æ ¸å¿ƒæŒ‡æ ‡');
    doc.fontSize(10).text(`æ¶ˆè´¹é‡‘é¢: ${data.metrics.consumption}`);
    doc.text(`æŠ½å¥–æ¬¡æ•°: ${data.metrics.lottery_draws}`);
  }
  
  // å¥åº·åº¦è¯„åˆ†
  if (sections.includes('health_score')) {
    doc.fontSize(14).text('ä¸šåŠ¡å¥åº·åº¦');
    doc.text(`è¯„åˆ†: ${data.health_score}/100`);
  }
  
  // ä¿å­˜æ–‡ä»¶
  const filename = `è¿è¥æ—¥æŠ¥_${date}.pdf`;
  const filepath = `/tmp/reports/${filename}`;
  doc.pipe(fs.createWriteStream(filepath));
  doc.end();
  
  return { filename, filepath };
}
```

---

## ä¸ƒã€é€šç”¨æŠ€æœ¯è§„èŒƒ

### 7.1 APIå“åº”æ ¼å¼

**æˆåŠŸå“åº”**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "æ“ä½œæˆåŠŸ",
  "data": { ... },
  "timestamp": "2026-02-03T10:30:00+08:00",
  "request_id": "req_abc123"
}
```

**é”™è¯¯å“åº”**:
```json
{
  "success": false,
  "code": "INVALID_PARAMS",
  "message": "å‚æ•°é”™è¯¯ï¼šstart_dateæ ¼å¼ä¸æ­£ç¡®",
  "data": null,
  "timestamp": "2026-02-03T10:30:00+08:00",
  "request_id": "req_abc123"
}
```

### 7.2 åˆ†é¡µè§„èŒƒ

**è¯·æ±‚å‚æ•°**:
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| page | int | 1 | é¡µç ï¼Œä»1å¼€å§‹ |
| page_size | int | 20 | æ¯é¡µæ•°é‡ï¼Œæœ€å¤§100 |

**å“åº”æ ¼å¼**:
```json
{
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 1234,
    "total_pages": 62
  }
}
```

### 7.3 æ—¶é—´æ ¼å¼

- **å­˜å‚¨**: æ•°æ®åº“ä½¿ç”¨ `DATETIME` ç±»å‹ï¼Œå­˜å‚¨åŒ—äº¬æ—¶é—´
- **ä¼ è¾“**: APIä½¿ç”¨ ISO 8601 æ ¼å¼ï¼Œå¸¦æ—¶åŒºï¼š`2026-02-03T10:30:00+08:00`
- **æŸ¥è¯¢å‚æ•°**: æ”¯æŒ `YYYY-MM-DD` æˆ– `YYYY-MM-DD HH:mm:ss` æ ¼å¼

### 7.4 æƒé™æ§åˆ¶

**åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰**:
| è§’è‰² | æƒé™çº§åˆ« | å¯è®¿é—®åŠŸèƒ½ |
|------|---------|-----------|
| admin | 100 | å…¨éƒ¨åŠŸèƒ½ |
| regional_manager | 80 | åŒºåŸŸå†…æ•°æ® |
| business_manager | 60 | ä¸šåŠ¡æ•°æ®ï¼ˆåªè¯»ä¸ºä¸»ï¼‰ |
| merchant_manager | 40 | ä»…æœ¬åº—æ•°æ® |
| ops | 30 | æ¶ˆè´¹å®¡æ ¸ã€å®¢æœ |

**æ¥å£æƒé™æ ‡æ³¨**:
```javascript
// éœ€è¦åœ¨æ¯ä¸ªæ¥å£å®šä¹‰ä¸­æ ‡æ³¨æ‰€éœ€æƒé™
router.get('/api/v4/console/users/:user_id/360view', 
  requireRole(['admin', 'regional_manager', 'business_manager']),
  UserController.get360View
);
```

### 7.5 ç¼“å­˜ç­–ç•¥

| æ•°æ®ç±»å‹ | ç¼“å­˜æ–¹å¼ | TTL | å¤±æ•ˆè§¦å‘ |
|----------|----------|-----|----------|
| ä»ªè¡¨ç›˜æ•°æ® | Redis | 5åˆ†é’Ÿ | æ‰‹åŠ¨åˆ·æ–° |
| å¥åº·åº¦è¯„åˆ† | Redis | 30ç§’ | å¾…åŠå˜æ›´ |
| ç”¨æˆ·360Â°è§†å›¾ | Redis | 10åˆ†é’Ÿ | ç”¨æˆ·æ•°æ®å˜æ›´ |
| å‘Šè­¦ç»Ÿè®¡ | Redis | 1åˆ†é’Ÿ | æ–°å‘Šè­¦è§¦å‘ |

### 7.6 æ•°æ®è„±æ•è§„åˆ™

| å­—æ®µç±»å‹ | è„±æ•è§„åˆ™ | ç¤ºä¾‹ |
|----------|----------|------|
| æ‰‹æœºå· | ä¸­é—´4ä½æ›¿æ¢ä¸º**** | 138****1234 |
| èº«ä»½è¯å· | ä»…æ˜¾ç¤ºå‰6å4ä½ | 310101****1234 |
| é“¶è¡Œå¡å· | ä»…æ˜¾ç¤ºå4ä½ | ************1234 |
| ç”¨æˆ·çœŸå®å§“å | ä»…adminå¯è§å®Œæ•´ï¼Œå…¶ä»–æ˜¾ç¤ºé¦–å­—+* | å¼ * |

---

## å…«ã€å®æ–½è®¡åˆ’

### 8.1 é˜¶æ®µåˆ’åˆ†ï¼ˆ2026-02-03 å¤ç”¨ä¼˜åŒ–ç‰ˆï¼‰

| é˜¶æ®µ | åŸä¼°å·¥æ—¶ | **ä¼˜åŒ–åå·¥æ—¶** | å†…å®¹ | äº¤ä»˜ç‰© | å¤ç”¨è¯´æ˜ |
|------|---------|--------------|------|--------|---------|
| ç¬¬ä¸€é˜¶æ®µ | 2å¤© | **0.5å¤©** | P0æ ¸å¿ƒåŠŸèƒ½ | å¥åº·åº¦APIã€æ‰¹é‡å®¡æ ¸ | âœ… `LotteryHealthService`/`PendingSummaryService` å·²å®ç°æ ¸å¿ƒç®—æ³• |
| ç¬¬äºŒé˜¶æ®µ | 9.5å¤© | **2.5å¤©** | P1é‡è¦åŠŸèƒ½ | ç”¨æˆ·360Â°è§†å›¾ã€é¢„ç®—é¢„æµ‹ã€æ—¶é—´å¯¹æ¯”ç­‰ | âœ… `MultiDimensionStatsService`/`UserSegmentService` å¯å¤ç”¨ |
| ç¬¬ä¸‰é˜¶æ®µ | 8å¤© | **2å¤©** | P2å¢å¼ºåŠŸèƒ½ | èµ„äº§æµåŠ¨ã€æ•°æ®å¯¼å‡ºã€å®¡è®¡æ—¥å¿—ç­‰ | âœ… `AuditLogService` å·²å®Œæ•´å®ç° |
| ç¬¬å››é˜¶æ®µ | 6å¤© | **2å¤©** | P3ä½ä¼˜å…ˆçº§ | è½¬åŒ–æ¼æ–—ã€å•†æˆ·è´¡çŒ®åº¦ã€PDFæŠ¥è¡¨ç­‰ | âœ… `UserSegmentService.getBehaviorFunnel()` å·²å®ç° |

> **æ€»å·¥æ—¶ä¼˜åŒ–**: 25.5å¤© â†’ **7å¤©**ï¼ˆèŠ‚çœ 72.5%ï¼‰

### 8.2 ä¾èµ–å…³ç³»

```
P0.å¥åº·åº¦è®¡ç®— â”€â”€â”¬â”€â”€ P1.å‘Šè­¦ä¸­å¿ƒ
               â”œâ”€â”€ P1.ç³»ç»Ÿå¥åº·çŠ¶æ€
               â””â”€â”€ P2.WebSocketæ¨é€

P0.æ‰¹é‡å®¡æ ¸ â”€â”€â”€â”€â”€ P1.å†³ç­–è¾…åŠ©ä¿¡æ¯
               â””â”€â”€ P1.å†å²å®¡æ ¸ç‡

P1.ç”¨æˆ·360Â°è§†å›¾ â”€â”€ P2.ä¸€é”®åˆ†æ
                â””â”€â”€ P2.æ•°æ®å¯¼å‡º

P1.é¢„ç®—é¢„æµ‹ â”€â”€â”€â”€â”€ P1.ä¸­å¥–ç‡è¶‹åŠ¿
             â””â”€â”€ P1.ç³»ç»Ÿå«ä»˜çœ‹æ¿

P1.å‘Šè­¦ä¸­å¿ƒ â”€â”€â”€â”€â”€ P2.å‘Šè­¦ç–²åŠ³é¢„é˜²

P2.èµ„äº§æµåŠ¨ â”€â”€â”€â”€â”€ P3.èµ„äº§å‘æ”¾æ¶ˆè€—æ¯”

P2.ç­–ç•¥å¯¹æ¯” â”€â”€â”€â”€â”€ P3.è½¬åŒ–æ¼æ–—
P2.ç”¨æˆ·åˆ†å±‚ â”€â”€â”€â”˜
```

### 8.3 æµ‹è¯•è¦ç‚¹

1. **å¥åº·åº¦è®¡ç®—å‡†ç¡®æ€§**ï¼šéªŒè¯å¾…åŠå¥åº·åº¦å’Œä¸šåŠ¡å¥åº·åº¦åœ¨å„åœºæ™¯ä¸‹è¯„åˆ†è®¡ç®—æ­£ç¡®
2. **æ‰¹é‡æ“ä½œåŸå­æ€§**ï¼šéªŒè¯æ‰¹é‡å®¡æ ¸çš„äº‹åŠ¡å¤„ç†å’Œéƒ¨åˆ†å¤±è´¥åœºæ™¯
3. **ç”¨æˆ·360Â°è§†å›¾å®Œæ•´æ€§**ï¼šéªŒè¯5ä¸ªTabæ•°æ®èšåˆæ­£ç¡®
4. **é¢„ç®—é¢„æµ‹å‡†ç¡®æ€§**ï¼šéªŒè¯é¢„ç®—æ¶ˆè€—è¿›åº¦å’Œå‰©ä½™å¤©æ•°é¢„æµ‹
5. **æ—¶é—´å¯¹æ¯”æ•°æ®**ï¼šéªŒè¯ä»Šæ—¥vsæ˜¨æ—¥ã€æœ¬å‘¨vsä¸Šå‘¨æ•°æ®å¯¹æ¯”å‡†ç¡®
6. **WebSocketç¨³å®šæ€§**ï¼šæµ‹è¯•æ¨é€å»¶è¿Ÿã€æ–­çº¿é‡è¿ã€é™çº§è½®è¯¢
7. **å¤§æ•°æ®é‡å¯¼å‡º**ï¼šæµ‹è¯•10ä¸‡+è®°å½•å¯¼å‡ºæ€§èƒ½å’Œåˆ†é¡µ
8. **æƒé™éš”ç¦»**ï¼šéªŒè¯ä¸åŒè§’è‰²æ•°æ®è®¿é—®è¾¹ç•Œå’Œæ“ä½œæƒé™
9. **ç¼“å­˜ä¸€è‡´æ€§**ï¼šéªŒè¯ç¼“å­˜å¤±æ•ˆæ—¶æœºæ­£ç¡®
10. **è½¬åŒ–æ¼æ–—æ•°æ®**ï¼šéªŒè¯5å±‚æ¼æ–—è½¬åŒ–ç‡è®¡ç®—æ­£ç¡®

---

## ä¹ã€é™„å½•

### é™„å½•Aï¼šæ¥å£æ¸…å•æ±‡æ€»ï¼ˆå®Œæ•´ç‰ˆï¼‰

#### P0 æ ¸å¿ƒåŠŸèƒ½ï¼ˆ2å¤©ï¼‰
| æ¥å£è·¯å¾„ | æ–¹æ³• | å·¥æ—¶ | è¯´æ˜ |
|----------|------|------|------|
| /api/v4/console/pending/health-score | GET | 0.5å¤© | å¾…åŠå¥åº·åº¦è¯„åˆ† |
| /api/v4/console/dashboard/business-health | GET | 0.5å¤© | ä¸šåŠ¡å¥åº·åº¦è¯„åˆ† |
| /api/v4/console/consumption/batch-review | POST | 1å¤© | æ‰¹é‡å®¡æ ¸æ¥å£ |

#### P1 é‡è¦åŠŸèƒ½ï¼ˆ9.5å¤©ï¼‰
| æ¥å£è·¯å¾„ | æ–¹æ³• | å·¥æ—¶ | è¯´æ˜ |
|----------|------|------|------|
| /api/v4/console/users/:user_id/360view | GET | 1å¤© | ç”¨æˆ·360Â°è§†å›¾ |
| /api/v4/console/users/:user_id/asset-history | GET | - | æ‰“åŒ…åœ¨360view |
| /api/v4/console/users/:user_id/lottery-history | GET | - | æ‰“åŒ…åœ¨360view |
| /api/v4/console/users/:user_id/behavior-tracks | GET | - | æ‰“åŒ…åœ¨360view |
| /api/v4/console/users/:user_id/risk-assessment | GET | - | æ‰“åŒ…åœ¨360view |
| /api/v4/console/lottery-health/budget-forecast | GET | 1å¤© | é¢„ç®—é¢„æµ‹ |
| /api/v4/console/dashboard/time-comparison | GET | 1å¤© | æ—¶é—´å¯¹æ¯”åŠŸèƒ½ |
| /api/v4/console/risk-alerts | GET | 0.5å¤© | å‘Šè­¦åˆ—è¡¨ |
| /api/v4/console/risk-alerts/stats | GET | 0.5å¤© | å‘Šè­¦ç»Ÿè®¡ |
| /api/v4/console/risk-alerts/:id/handle | POST | - | æ‰“åŒ…åœ¨å‘Šè­¦åˆ—è¡¨ |
| /api/v4/console/dashboard/data | GET | 0.5å¤© | ä»ªè¡¨ç›˜ç¼“å­˜æ•°æ® |
| /api/v4/console/system/api-performance | GET | 0.5å¤© | APIæ€§èƒ½ç›‘æ§ |
| /api/v4/console/customer-service/sessions/response-stats | GET | 0.5å¤© | å®¢æœå“åº”æ—¶é•¿ |
| /api/v4/console/staff/permissions | GET | 0.5å¤© | è§’è‰²æƒé™çŸ©é˜µ |
| /api/v4/console/consumption/:id/assist-info | GET | 0.5å¤© | å†³ç­–è¾…åŠ©ä¿¡æ¯ |
| /api/v4/console/users/:user_id/approval-rate | GET | 0.5å¤© | å†å²å®¡æ ¸ç‡ |
| /api/v4/console/system/health-status | GET | 0.5å¤© | ç³»ç»Ÿå¥åº·çŠ¶æ€ |
| /api/v4/console/debt-management/system-advance | GET | 0.5å¤© | ç³»ç»Ÿå«ä»˜çœ‹æ¿ |
| /api/v4/console/lottery-strategy-stats/win-rate-trend | GET | 0.5å¤© | ä¸­å¥–ç‡è¶‹åŠ¿ |

#### P2 å¢å¼ºåŠŸèƒ½ï¼ˆ8å¤©ï¼‰
| æ¥å£è·¯å¾„ | æ–¹æ³• | å·¥æ—¶ | è¯´æ˜ |
|----------|------|------|------|
| /api/v4/console/assets/flow-overview | GET | 1å¤© | èµ„äº§æµåŠ¨æ¦‚è§ˆ |
| /api/v4/console/assets/transactions | GET | 0.5å¤© | èµ„äº§æµæ°´æ˜ç»† |
| /api/v4/console/assets/issuance-consumption-ratio | GET | 0.5å¤© | å‘æ”¾æ¶ˆè€—æ¯” |
| /api/v4/console/audit-logs | GET | 2å¤© | å®¡è®¡æ—¥å¿—æŸ¥è¯¢ |
| /api/v4/console/export | POST | 1.5å¤© | æ•°æ®å¯¼å‡º |
| /api/v4/console/export/:id/status | GET | 0.5å¤© | å¯¼å‡ºè¿›åº¦ |
| /api/v4/console/export/:id/download | GET | 0.5å¤© | ä¸‹è½½æ–‡ä»¶ |
| /api/v4/console/lottery-strategy-stats/strategy-comparison | GET | 0.5å¤© | ç­–ç•¥æ•ˆæœå¯¹æ¯” |
| /api/v4/console/lottery-health/user-tier-distribution | GET | 0.5å¤© | ç”¨æˆ·åˆ†å±‚åˆ†å¸ƒ |
| /api/v4/console/users/:user_id/quick-analysis | POST | 0.5å¤© | ä¸€é”®åˆ†æ |
| /api/v4/console/item-templates/lock-rate | GET | 0.5å¤© | ç‰©å“é”å®šç‡ |
| /api/v4/console/system/balance-alerts | GET | 0.5å¤© | ä½™é¢é¢„è­¦ |
| /api/v4/console/risk-alerts/silence | POST | 0.5å¤© | å‘Šè­¦é™é»˜ |
| ws://pending.new | WebSocket | - | æ‰“åŒ…åœ¨å®æ—¶æ¨é€ |
| ws://health.changed | WebSocket | 0.5å¤© | WebSocketå®æ—¶æ¨é€ |

#### P3 ä½ä¼˜å…ˆçº§ï¼ˆ6å¤©ï¼‰
| æ¥å£è·¯å¾„ | æ–¹æ³• | å·¥æ—¶ | è¯´æ˜ |
|----------|------|------|------|
| /api/v4/console/analytics/conversion-funnel | GET | 2å¤© | è½¬åŒ–æ¼æ–— |
| /api/v4/console/stores/contribution | GET | 1å¤© | å•†æˆ·è´¡çŒ®åº¦æ’è¡Œ |
| /api/v4/console/stores/:store_id/trend | GET | 0.5å¤© | å•†æˆ·æ¶ˆè´¹è¶‹åŠ¿ |
| /api/v4/console/stores/:store_id/health-score | GET | 0.5å¤© | é—¨åº—å¥åº·åº¦ |
| /api/v4/console/stores/:store_id/comparison | GET | 0.5å¤© | ç¯æ¯”åŒæ¯”å¯¹æ¯” |
| /api/v4/console/assets/balance-ratio | GET | 0.5å¤© | èµ„äº§å‘æ”¾æ¶ˆè€—æ¯” |
| /api/v4/console/reports/generate-pdf | POST | 1å¤© | PDFæŠ¥è¡¨ç”Ÿæˆ |

### é™„å½•Bï¼šæ•°æ®åº“æ–°å¢ç´¢å¼•å»ºè®®ï¼ˆéµå¾ª2.5.2å­—æ®µå‘½åè§„èŒƒï¼‰

```sql
-- èµ„äº§æµæ°´æŸ¥è¯¢ä¼˜åŒ–ï¼ˆæ³¨æ„ï¼šasset_transactions é€šè¿‡ account_id å…³è” accounts è¡¨è·å– user_idï¼‰
-- ç°æœ‰ç´¢å¼•ï¼šidx_account_time, idx_business_type_time
-- å¦‚éœ€æŒ‰ç”¨æˆ·æŸ¥è¯¢ï¼Œéœ€å…ˆæŸ¥ accounts è¡¨è·å– account_id

-- æŠ½å¥–è®°å½•æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_lottery_user_date ON lottery_draws(user_id, created_at);
CREATE INDEX idx_lottery_hour ON lottery_draws(HOUR(created_at), created_at);

-- å¾…åŠæŸ¥è¯¢ä¼˜åŒ–ï¼ˆæ³¨æ„ï¼šä½¿ç”¨å®é™…çš„å¾…åŠè¡¨ï¼‰
-- consumption_records è¡¨ç´¢å¼•
CREATE INDEX idx_consumption_status_date ON consumption_records(status, created_at);

-- customer_service_sessions è¡¨ç´¢å¼•
CREATE INDEX idx_cs_status_date ON customer_service_sessions(status, created_at);

-- risk_alerts è¡¨ç´¢å¼•
CREATE INDEX idx_risk_status_date ON risk_alerts(status, created_at);
```

---

## åã€å®ç°çŠ¶æ€åˆ†æï¼ˆ2026-02-03 æ·±åº¦æ ¸æŸ¥æ›´æ–°ï¼‰

> **æ£€æŸ¥æ—¶é—´**: 2026-02-03 æ·±åº¦æ ¸æŸ¥ï¼ˆåŸºäºä»£ç +æ•°æ®åº“+æœåŠ¡å±‚ï¼‰  
> **æŠ€æœ¯ä½“ç³»**: åç«¯ Node.js + Express + Sequelize + MySQL + Redis  
> **è·¯ç”±å‰ç¼€**: `/api/v4/console/`ï¼ˆç»Ÿä¸€ç®¡ç†åå°è·¯ç”±ï¼‰  
> **å‘½åè§„èŒƒ**: kebab-caseï¼ˆå¦‚ `lottery-health`, `user-segments`ï¼‰  
> **å¤ç”¨ç­–ç•¥**: ä¼˜å…ˆå¤ç”¨ç°æœ‰æœåŠ¡ï¼Œé¿å…é‡å¤å¼€å‘

### 10.1 å®ç°çŠ¶æ€æ±‡æ€»ï¼ˆæ·±åº¦æ ¸æŸ¥ç‰ˆï¼‰

| çŠ¶æ€ | æ•°é‡ | å æ¯” | è¯´æ˜ |
|-----|-----|-----|-----|
| âœ… **å·²å®ç°** | 12 | 48% | åŠŸèƒ½å®Œæ•´æˆ–æ ¸å¿ƒé€»è¾‘å·²å­˜åœ¨ |
| âš ï¸ **éƒ¨åˆ†å®ç°** | 9 | 36% | æœåŠ¡å­˜åœ¨éœ€æ‰©å±•æˆ–æ–°å¢ç«¯ç‚¹ |
| âŒ **å¾…å¼€å‘** | 4 | 16% | éœ€æ–°å»ºæœåŠ¡å’Œè·¯ç”± |
| **åˆè®¡** | **25** | 100% | - |

> **æ ¸æŸ¥å‘ç°**: ç›¸æ¯”åˆæ­¥åˆ†æï¼Œå‘ç°æ›´å¤šå¯å¤ç”¨æœåŠ¡ï¼š
> - `LotteryHealthService` å·²å®ç°å¥åº·åº¦æ ¸å¿ƒç®—æ³•
> - `MultiDimensionStatsService` å·²æ”¯æŒæ—¶é—´å¯¹æ¯”ç»´åº¦
> - `UserSegmentService` å·²åŒ…å«è½¬åŒ–æ¼æ–—æ–¹æ³•
> - `AuditLogService` å·²å®ç°å®Œæ•´å®¡è®¡æ—¥å¿—

### 10.2 API æ¥å£æ¸…å•ï¼ˆæ·±åº¦æ ¸æŸ¥ç‰ˆ 2026-02-03ï¼‰

#### 10.2.1 âœ… å·²å®ç°æ¥å£ï¼ˆ12ä¸ªï¼‰

| æ¥å£è·¯å¾„ | æ–¹æ³• | è·¯ç”±æ–‡ä»¶ | æœåŠ¡ç±» | åŠŸèƒ½è¯´æ˜ | æ ¸æŸ¥çŠ¶æ€ |
|---------|------|---------|-------|---------|---------|
| `/api/v4/console/consumption/batch-review` | POST | `consumption.js` | `ConsumptionBatchService` | æ¶ˆè´¹æ‰¹é‡å®¡æ ¸ | âœ… P0 å®Œæˆ |
| `/api/v4/console/risk-alerts` | GET | `risk-alerts.js` | `RiskControlService` | é£æ§å‘Šè­¦åˆ—è¡¨ | âœ… å®Œæˆ |
| `/api/v4/console/dashboard/pending-summary` | GET | `dashboard.js` | `PendingSummaryService` | ä»ªè¡¨ç›˜å¾…åŠæ±‡æ€» | âœ… å®Œæˆ |
| `/api/v4/console/audit-logs` | GET | `audit-logs.js` | `AuditLogService` | å®¡è®¡æ—¥å¿—æŸ¥è¯¢ | âœ… P2 å®Œæˆ |
| `/api/v4/console/lottery-strategy-stats` | GET | `lottery-strategy-stats.js` | `LotteryStrategyStatsService` | ç­–ç•¥æ•ˆæœç»Ÿè®¡ | âœ… å®Œæˆ |
| `/api/v4/console/users/segments` | GET | `user-segments.js` | `UserSegmentService` | ç”¨æˆ·åˆ†å±‚åˆ†å¸ƒ | âœ… P2 å®Œæˆ |
| `/api/v4/console/lottery-health/:id/tier-distribution` | GET | `lottery-health.js` | `LotteryHealthService` | æ¡£ä½åˆ†å¸ƒç»Ÿè®¡ | âœ… å®Œæˆ |
| `/api/v4/console/users/funnel` | GET | `user-segments.js` | `UserSegmentService.getBehaviorFunnel()` | **è½¬åŒ–æ¼æ–—åˆ†æ** | âœ… **P3 å·²å®Œæˆ** |
| `/api/v4/console/batch-operations` | POST | `batch-operations.js` | `BatchOperationService` | æ‰¹é‡æ•°æ®å¯¼å‡º | âœ… P2 å®Œæˆ |
| `/api/v4/console/statistics` | GET | `multi-dimension-stats.js` | `MultiDimensionStatsService` | **å¤šç»´åº¦ç»Ÿè®¡ï¼ˆå«æ—¶é—´å¯¹æ¯”ï¼‰** | âœ… **P1 å¯å¤ç”¨** |
| `/api/v4/console/lottery-health/:id` | GET | `lottery-health.js` | `LotteryHealthService.getHealthReport()` | **å¥åº·åº¦æŠ¥å‘Š** | âœ… **P0 å¯å¤ç”¨** |
| `/api/v4/console/debt-management/trend` | GET | `debt-management.js` | `DebtManagementService` | **ç³»ç»Ÿå«ä»˜è¶‹åŠ¿** | âœ… **P1 å¯å¤ç”¨** |

#### 10.2.2 âš ï¸ éƒ¨åˆ†å®ç°æ¥å£ï¼ˆéœ€æ‰©å±•å°è£…ï¼Œ9ä¸ªï¼‰

| åŠŸèƒ½éœ€æ±‚ | ç°æœ‰æ¥å£/æœåŠ¡ | è·¯ç”±/æœåŠ¡æ–‡ä»¶ | å·®å¼‚è¯´æ˜ | æ‰©å±•å·¥ä½œé‡ |
|---------|-------------|-------------|---------|----------|
| **P0 å¾…åŠå¥åº·åº¦** | `PendingSummaryService.getPendingSummary()` | `PendingSummaryService.js` | å·²æœ‰æ±‡æ€»ï¼Œéœ€åŠ è¯„åˆ†ç®—æ³• | **0.3å¤©** |
| **P0 ä¸šåŠ¡å¥åº·åº¦** | `LotteryHealthService.calculateHealthScore()` | `LotteryHealthService.js` | å·²æœ‰5ç»´ç®—æ³•ï¼Œéœ€å°è£…ç«¯ç‚¹ | **0.2å¤©** |
| **P1 é¢„ç®—é¢„æµ‹** | `/lottery-health/:id/budget-rate` | `lottery-health.js` | æŒ‰æ´»åŠ¨ç»´åº¦ï¼Œéœ€å…¨å±€èšåˆ | 0.3å¤© |
| **P1 æ—¶é—´å¯¹æ¯”** | `MultiDimensionStatsService.getMultiDimensionStats()` | `MultiDimensionStatsService.js` | å·²æ”¯æŒtimeç»´åº¦ï¼Œéœ€æ–°ç«¯ç‚¹ | **0.3å¤©** |
| **P1 ç”¨æˆ·360Â°è§†å›¾** | `UserSegmentService.*` + å¤šæœåŠ¡ | `UserSegmentService.js` | éœ€èšåˆ5ä¸ªæ•°æ®æº | 0.5å¤© |
| **P1 å®¢æœå“åº”æ—¶é•¿** | `CustomerServiceSessionService.calculateAverageResponseTime()` | `CustomerServiceSessionService.js` | éœ€æ–°å¢DBå­—æ®µ+ç«¯ç‚¹ | 0.3å¤© |
| æ¶ˆè´¹è¾…åŠ© | `/consumption-anomaly/:id` | `consumption-anomaly.js` | å¼‚å¸¸åˆ†æ | 0.2å¤© |
| èµ„äº§æµåŠ¨ | `/assets/portfolio` | `assets/index.js` | ç»“æ„ä¸åŒ | 0.5å¤© |
| è¡Œä¸ºè½¨è¿¹ | `/user-behavior-tracks` | `user-behavior-tracks.js` | å·²å®ç° | æ•´åˆåˆ°360è§†å›¾ |

#### 10.2.3 âŒ å¾…å¼€å‘æ¥å£ï¼ˆçœŸæ­£éœ€æ–°å»ºï¼Œ4ä¸ªï¼‰

| ä¼˜å…ˆçº§ | æ¥å£è·¯å¾„ | æ–¹æ³• | æœåŠ¡ç±» | åŠŸèƒ½è¯´æ˜ | å·¥æ—¶ |
|-------|---------|------|-------|---------|------|
| P1 | `/api/v4/console/system/api-performance` | GET | `APIPerformanceService`ï¼ˆæ–°å»ºï¼‰ | APIæ€§èƒ½ç›‘æ§ | 0.5å¤© |
| P1 | `/api/v4/console/users/:user_id/approval-rate` | GET | `UserApprovalRateService`ï¼ˆæ–°å»ºï¼‰ | ç”¨æˆ·å†å²å®¡æ ¸ç‡ | 0.3å¤© |
| P2 | `/api/v4/console/item-templates/lock-rate` | GET | `ItemLockRateService`ï¼ˆæ–°å»ºï¼‰ | ç‰©å“é”å®šç‡ç›‘æ§ | 0.5å¤© |
| P3 | `/api/v4/console/stores/contribution` | GET | `StoreContributionService`ï¼ˆæ–°å»ºï¼‰ | é—¨åº—è´¡çŒ®åº¦æ’è¡Œ | 1å¤© |

> **æ·±åº¦æ ¸æŸ¥ç»“è®º**: åŸ8ä¸ª"å¾…å¼€å‘"æ¥å£ä¸­ï¼Œ4ä¸ªå¯é€šè¿‡å¤ç”¨ç°æœ‰æœåŠ¡å¿«é€Ÿå®ç°ï¼Œä»…4ä¸ªéœ€çœŸæ­£æ–°å»ºæœåŠ¡

### 10.3 æ•°æ®åº“å­—æ®µæ˜ å°„ï¼ˆå®é™…è¡¨ç»“æ„ï¼‰

#### 10.3.1 å­—æ®µå·®å¼‚ä¸æ›¿ä»£æ–¹æ¡ˆ

| è¡¨å | æœŸæœ›å­—æ®µ | å®é™…å­—æ®µ | SQL æ˜ å°„æ–¹æ¡ˆ |
|-----|---------|---------|-------------|
| `lottery_draws` | `is_winner` | `reward_tier` | `CASE WHEN reward_tier IN ('high', 'mid') THEN 1 ELSE 0 END AS is_winner` |
| `lottery_draws` | `advance_amount` | `has_debt` | `LEFT JOIN debt_records dr ON ld.draw_id = dr.draw_id` |
| `asset_transactions` | `amount` | `delta_amount` | ç›´æ¥ä½¿ç”¨ `delta_amount` |
| `asset_transactions` | `change_type` | `business_type` | ç›´æ¥ä½¿ç”¨ `business_type`ï¼ˆ15ç§ç±»å‹ï¼‰ |
| `customer_service_sessions` | `first_response_at` | **æ— ** | éœ€æ–°å¢å­—æ®µæˆ–ä» `chat_messages` è®¡ç®— |
| `user_roles` | `role_level` | éœ€ JOIN | `JOIN roles r ON ur.role_id = r.role_id` |

#### 10.3.2 æ ¸å¿ƒè¡¨å­—æ®µå®šä¹‰

```javascript
// lottery_draws è¡¨å¯ç”¨å­—æ®µ
const lotteryDrawsSchema = {
  draw_id: 'INT PRIMARY KEY AUTO_INCREMENT',
  user_id: 'INT NOT NULL',                    // FK â†’ users.user_id
  lottery_campaign_id: 'INT NOT NULL',        // FK â†’ lottery_campaigns
  reward_tier: "ENUM('high','mid','fallback')", // ä¸­å¥–æ¡£ä½ï¼ˆæ›¿ä»£ is_winnerï¼‰
  has_debt: 'TINYINT(1) DEFAULT 0',           // æ˜¯å¦äº§ç”Ÿæ¬ è´¦
  created_at: 'DATETIME DEFAULT CURRENT_TIMESTAMP'
}

// asset_transactions è¡¨å¯ç”¨å­—æ®µ
const assetTransactionsSchema = {
  transaction_id: 'INT PRIMARY KEY AUTO_INCREMENT',
  user_id: 'INT NOT NULL',
  asset_code: 'VARCHAR(50) NOT NULL',         // èµ„äº§ä»£ç 
  business_type: 'VARCHAR(50) NOT NULL',      // ä¸šåŠ¡ç±»å‹ï¼ˆæ›¿ä»£ change_typeï¼‰
  delta_amount: 'DECIMAL(18,4) NOT NULL',     // å˜åŠ¨é‡‘é¢ï¼ˆæ›¿ä»£ amountï¼‰
  frozen_amount_change: 'DECIMAL(18,4) DEFAULT 0',
  created_at: 'DATETIME DEFAULT CURRENT_TIMESTAMP'
}

// business_type æšä¸¾å€¼
const BUSINESS_TYPES = [
  'lottery_reward',      // æŠ½å¥–å¥–åŠ±
  'consumption_deduct',  // æ¶ˆè´¹æ‰£é™¤
  'admin_adjust',        // åå°è°ƒæ•´
  'transfer_in',         // è½¬å…¥
  'transfer_out',        // è½¬å‡º
  'debt_repay',          // æ¬ è´¦è¿˜æ¬¾
  'exchange_consume',    // å…‘æ¢æ¶ˆè€—
  'premium_unlock',      // é«˜çº§ç©ºé—´è§£é”
  // ... å…±15ç§
]
```

### 10.4 æœåŠ¡å±‚æ¶æ„ï¼ˆæ·±åº¦æ ¸æŸ¥ç‰ˆ - 2026-02-03 æ›´æ–°ï¼‰

#### 10.4.1 âœ… å·²å®Œæ•´å®ç°ï¼ˆæœåŠ¡å±‚ + è·¯ç”±å±‚ï¼‰

| æœåŠ¡ç±» | æ–‡ä»¶è·¯å¾„ | è·¯ç”±ç«¯ç‚¹ | å·²æœ‰æ–¹æ³• | è¯´æ˜ |
|-------|---------|---------|---------|-----|
| **`LotteryHealthService`** | `services/lottery/LotteryHealthService.js` | `routes/v4/console/lottery-health.js` | `getHealthReport()`, `_calculateBudgetHealth()`, `_calculateWinRateHealth()`, `_calculateInventoryHealth()`, `_calculateParticipationHealth()`, `_calculateExperienceHealth()`, `_diagnoseIssues()`, `_generateSuggestions()` | **ğŸ”¥ 5ç»´åº¦é›·è¾¾å›¾+é—®é¢˜è¯Šæ–­+ä¼˜åŒ–å»ºè®®ï¼Œå®Œæ•´897è¡Œ** |

**LotteryHealthService å·²å®ç°çš„ 4 ä¸ªç«¯ç‚¹**:
| ç«¯ç‚¹ | åŠŸèƒ½ |
|-----|------|
| `GET /api/v4/admin/lottery/health/:id` | å®Œæ•´å¥åº·æŠ¥å‘Š |
| `GET /api/v4/admin/lottery/health/:id/tier-distribution` | æ¡£ä½åˆ†å¸ƒ |
| `GET /api/v4/admin/lottery/health/:id/diagnose` | é—®é¢˜è¯Šæ–­ |
| `GET /api/v4/admin/lottery/health/:id/budget-rate` | é¢„ç®—æ¶ˆè€—é€Ÿåº¦ |

#### 10.4.2 âœ… å·²å®ç°æœåŠ¡å±‚ï¼ˆå¯æ‰©å±•ï¼‰

| æœåŠ¡ç±» | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | å·²æœ‰æ–¹æ³• | å¤ç”¨ä»·å€¼ |
|-------|---------|------|---------|---------|
| **`PendingSummaryService`** | `services/dashboard/PendingSummaryService.js` | âœ… | `getPendingSummary()` å«4ç±»å¾…åŠæ±‡æ€» | **ğŸ”¥ P0å¾…åŠå¥åº·åº¦åŸºç¡€å·²å®ç°** |
| **`MultiDimensionStatsService`** | `services/reporting/MultiDimensionStatsService.js` | âœ… | `getMultiDimensionStats()`, `getDrillDownDetails()` æ”¯æŒtimeç»´åº¦ | **ğŸ”¥ P1æ—¶é—´å¯¹æ¯”å¯ç›´æ¥å¤ç”¨** |
| **`UserSegmentService`** | `services/user/UserSegmentService.js` | âœ… | `getSegmentStats()`, `getActivityHeatmap()`, `getExchangePreferences()`, `getBehaviorFunnel()` | **ğŸ”¥ P1/P2/P3 å¤šåŠŸèƒ½å¤ç”¨** |
| **`AuditLogService`** | `services/AuditLogService.js` | âœ… | å®Œæ•´ CRUD + 15ç§æ“ä½œç±»å‹ + before/afteræ•°æ® | **ğŸ”¥ P2å®¡è®¡æ—¥å¿—å·²å®Œæˆ** |
| `PendingCenterService` | `services/pending/PendingCenterService.js` | âœ… | `getSegmentStats()`, `getUnifiedList()` | å¾…åŠåˆ—è¡¨åŸºç¡€ |
| `ConsumptionBatchService` | `services/consumption/ConsumptionBatchService.js` | âœ… | `batchReview()` | P0æ‰¹é‡å®¡æ ¸å·²å®Œæˆ |
| `RiskControlService` | `services/risk/RiskControlService.js` | âœ… | `getRiskAlerts()` | å‘Šè­¦åˆ—è¡¨å·²å®Œæˆ |
| `DebtManagementService` | `services/DebtManagementService.js` | âœ… | é¢„ç®—è¶‹åŠ¿ã€æ¬ è´¦ç»Ÿè®¡ | P1ç³»ç»Ÿå«ä»˜å¯å¤ç”¨ |

#### 10.4.3 âš ï¸ éœ€æ‰©å±•/æ–°å¢å­—æ®µ

| æœåŠ¡ç±» | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | å·²æœ‰æ–¹æ³• | éœ€æ‰©å±• |
|-------|---------|------|---------|--------|
| `CustomerServiceSessionService` | `services/CustomerServiceSessionService.js` | âš ï¸ | `calculateAverageResponseTime()` | éœ€æ–°å¢DBå­—æ®µ `first_response_at` |
| `DashboardPanelService` | `services/dashboard/DashboardPanelService.js` | âš ï¸ | åŸºç¡€çœ‹æ¿ | éœ€å°è£…å¥åº·åº¦ç«¯ç‚¹ |

#### 10.4.4 âŒ éœ€æ–°å»ºæœåŠ¡

| æœåŠ¡ç±» | çŠ¶æ€ | å·¥æ—¶ |
|-------|------|------|
| `PendingHealthScoreService` | âŒ | 0.5å¤©ï¼ˆå¤ç”¨ `PendingSummaryService`ï¼‰ |
| `BusinessHealthScoreService` | âŒ | 0.5å¤©ï¼ˆå¤ç”¨ `LotteryHealthService`ï¼‰ |
| `APIPerformanceService` | âŒ | 0.5å¤© |
| `ItemLockRateService` | âŒ | 0.5å¤© |
| `StoreContributionService` | âŒ | 1å¤© |

> **æ ¸æŸ¥å‘ç°**: `LotteryHealthService` å·²å®Œæ•´å®ç°5ç»´åº¦å¥åº·åº¦è®¡ç®— + 4ä¸ªè·¯ç”±ç«¯ç‚¹ï¼Œå¯ç›´æ¥ç”¨äºå…¨å±€ä¸šåŠ¡å¥åº·åº¦çš„"æŠ½å¥–æ´»è·ƒå¾—åˆ†"ç»´åº¦

### 10.5 è·¯ç”±æ¨¡å—å¯¹ç…§

| è·¯ç”±æ–‡ä»¶ | æŒ‚è½½è·¯å¾„ | å·²æœ‰ç«¯ç‚¹ | å¾…æ–°å¢ç«¯ç‚¹ |
|---------|---------|---------|----------|
| `routes/v4/console/pending.js` | `/pending` | `/summary`, `/list` | `/health-score` |
| `routes/v4/console/dashboard.js` | `/dashboard` | `/pending-summary` | `/business-health`, `/time-comparison` |
| `routes/v4/console/consumption.js` | `/consumption` | `/pending`, `/records`, `/batch-review` | - |
| `routes/v4/console/risk-alerts.js` | `/risk-alerts` | `/`, `/pending`, `/:alert_id` | - |
| `routes/v4/console/audit-logs.js` | `/audit-logs` | `/` | - |
| `routes/v4/console/lottery-health.js` | `/lottery-health` | `/:id`, `/:id/tier-distribution`, `/:id/budget-rate` | - |
| `routes/v4/console/user-segments.js` | `/users` | `/segments`, `/funnel` | `/:user_id/approval-rate` |
| `routes/v4/console/customer-service/` | `/customer-service` | `/sessions/*` | `/response-stats` |
| `routes/v4/console/system/` | `/system` | `/status`, `/dashboard` | `/api-performance` |
| `routes/v4/console/stores.js` | `/stores` | CRUD | `/contribution` |
| æ–°å¢ `routes/v4/console/items.js` | `/items` | - | `/lock-rate` |

### 10.6 ä¿®æ­£åçš„å·¥æ—¶è¯„ä¼°ï¼ˆæ·±åº¦æ ¸æŸ¥ç‰ˆ 2026-02-03 v2ï¼‰

| ä¼˜å…ˆçº§ | åŸè®¡åˆ’ | å·²å®ç°/å¯å¤ç”¨ | å‰©ä½™å·¥æ—¶ | ä¸»è¦å·¥ä½œ | å¤ç”¨è¯´æ˜ |
|-------|-------|-------------|---------|---------|---------|
| P0 | 3å¤© | 2å¤© | **1å¤©** | å¾…åŠå¥åº·åº¦+å…¨å±€ä¸šåŠ¡å¥åº·åº¦ç«¯ç‚¹ | âœ… **`LotteryHealthService` å·²å®Œæ•´å®ç°ï¼ˆæœåŠ¡å±‚+è·¯ç”±å±‚+5ç»´åº¦ï¼‰** |
| P1 | 9.5å¤© | 7å¤© | **2.5å¤©** | 360è§†å›¾èšåˆã€å“åº”æ—¶é•¿ | âœ… `MultiDimensionStatsService`/`UserSegmentService` å¯å¤ç”¨ |
| P2 | 8å¤© | 6å¤© | **2å¤©** | é”å®šç‡ç›‘æ§ã€å‘Šè­¦é™é»˜ | âœ… `AuditLogService` å®Œæ•´å®ç° |
| P3 | 6å¤© | 4å¤© | **2å¤©** | é—¨åº—è´¡çŒ®åº¦ã€PDFæŠ¥è¡¨ | âœ… `UserSegmentService.getBehaviorFunnel()` å·²å®ç° |
| **åˆè®¡** | 26.5å¤© | 19å¤© | **7.5å¤©** â†’ **6å¤©** | - | å¥åº·åº¦ä»3å¤©â†’1å¤©ï¼ŒèŠ‚çœ2å¤© |

**P0 å¥åº·åº¦æ¥å£è¯¦ç»†åˆ†æ**:
| æ¥å£ | åŸä¼°å·¥æ—¶ | å®é™…çŠ¶æ€ | å‰©ä½™å·¥æ—¶ |
|-----|---------|---------|---------|
| æŠ½å¥–æ´»åŠ¨å¥åº·åº¦ | 1.5å¤© | âœ… **å·²å®Œæ•´å®ç°**ï¼ˆ`LotteryHealthService` + 4ä¸ªè·¯ç”±ç«¯ç‚¹ï¼‰ | **0å¤©** |
| å¾…åŠå¥åº·åº¦ | 0.5å¤© | âŒ å¾…å®ç°ï¼ˆå¤ç”¨ `PendingSummaryService`ï¼‰ | 0.5å¤© |
| å…¨å±€ä¸šåŠ¡å¥åº·åº¦ | 1å¤© | âŒ å¾…å®ç°ï¼ˆå¤ç”¨ `LotteryHealthService` èšåˆï¼‰ | 0.5å¤© |

> **å¤ç”¨æ”¶ç›Š**: é€šè¿‡æœåŠ¡å±‚å¤ç”¨ï¼Œå®é™…å‰©ä½™å·¥ä½œé‡ä» 12.5å¤© é™è‡³ **6å¤©**ï¼ˆèŠ‚çœ 52%ï¼‰

### 10.7 æ•°æ®åº“å˜æ›´å»ºè®®

```sql
-- 1. å®¢æœä¼šè¯é¦–æ¬¡å“åº”æ—¶é—´ï¼ˆP1 å¿…éœ€ï¼‰
ALTER TABLE customer_service_sessions 
ADD COLUMN first_response_at DATETIME NULL COMMENT 'å®¢æœé¦–æ¬¡å“åº”æ—¶é—´';

-- ä» chat_messages è®¡ç®—é¦–æ¬¡å“åº”æ—¶é—´ï¼ˆè¿ç§»è„šæœ¬ï¼‰
UPDATE customer_service_sessions cs
SET first_response_at = (
  SELECT MIN(cm.created_at) 
  FROM chat_messages cm 
  WHERE cm.session_id = cs.session_id 
  AND cm.sender_type = 'admin'
)
WHERE first_response_at IS NULL;

-- 2. ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_lottery_draws_reward_tier_created 
  ON lottery_draws(reward_tier, created_at);

CREATE INDEX idx_asset_trans_business_type_created 
  ON asset_transactions(business_type, created_at);

CREATE INDEX idx_item_instances_status_locked 
  ON item_instances(status, locked_at);
```

### 10.8 å¯å¤ç”¨æœåŠ¡æ·±åº¦åˆ†æï¼ˆ2026-02-03 æ–°å¢ï¼‰

> **æ ¸æŸ¥æ–¹æ³•**: åŸºäºä»£ç æœç´¢ + æœåŠ¡å±‚æ–‡ä»¶è¯»å– + æ–¹æ³•ç­¾ååˆ†æ  
> **å‘ç°ä»·å€¼**: å¤šé¡¹"å¾…å¼€å‘"åŠŸèƒ½å®é™…å·²æœ‰åŸºç¡€å®ç°ï¼Œå¯å¤§å¹…å‡å°‘å¼€å‘å·¥ä½œé‡

#### 10.8.1 å¥åº·åº¦è®¡ç®—æœåŠ¡ï¼ˆP0 å¯å¤ç”¨ âœ…ï¼‰

| ç°æœ‰æœåŠ¡ | æ–‡ä»¶è·¯å¾„ | å·²æœ‰æ–¹æ³• | å¤ç”¨æ–¹æ¡ˆ |
|---------|---------|---------|---------|
| `LotteryHealthService` | `services/lottery/LotteryHealthService.js` | `calculateHealthScore()`, `diagnoseIssues()`, `generateSuggestions()`, `getHealthReport()` | ç›´æ¥å°è£…ä¸º `/dashboard/business-health` ç«¯ç‚¹ |
| `PendingSummaryService` | `services/dashboard/PendingSummaryService.js` | `getPendingSummary()` | æ‰©å±•è®¡ç®—å¾…åŠå¥åº·åº¦è¯„åˆ† |

**æ ¸å¿ƒå‘ç°**:
```javascript
// LotteryHealthService å·²å®ç°çš„å¥åº·åº¦ç»´åº¦ï¼ˆ5ç»´é›·è¾¾å›¾ï¼‰
const healthDimensions = {
  budget: 'é¢„ç®—å¥åº·åº¦',
  winRate: 'ä¸­å¥–ç‡å¥åº·åº¦', 
  inventory: 'åº“å­˜å¥åº·åº¦',
  userParticipation: 'ç”¨æˆ·å‚ä¸åº¦',
  experienceHealth: 'ä½“éªŒå¥åº·åº¦'
}

// PendingSummaryService å·²å®ç°çš„å¾…åŠæ±‡æ€»
const pendingCategories = ['consumption', 'customer_service', 'risk_alerts', 'lottery_alerts']
```

**å¤ç”¨å·¥ä½œé‡**: åŸä¼° 2å¤© â†’ **0.5å¤©**ï¼ˆä»…éœ€å°è£…ç«¯ç‚¹ï¼‰

---

#### 10.8.2 å¤šç»´åº¦ç»Ÿè®¡æœåŠ¡ï¼ˆP1 å¯å¤ç”¨ âœ…ï¼‰

| ç°æœ‰æœåŠ¡ | æ–‡ä»¶è·¯å¾„ | å·²æœ‰æ–¹æ³• | å¤ç”¨æ–¹æ¡ˆ |
|---------|---------|---------|---------|
| `MultiDimensionStatsService` | `services/reporting/MultiDimensionStatsService.js` | `getMultiDimensionStats()`, `getDrillDownDetails()` | æ”¯æŒæ—¶é—´å¯¹æ¯”æ‰€éœ€çš„æ‰€æœ‰ç»´åº¦ |

**æ ¸å¿ƒå‘ç°**:
```javascript
// å·²æ”¯æŒçš„ç»Ÿè®¡ç»´åº¦
const supportedDimensions = ['store', 'campaign', 'time', 'user_level']

// å·²æ”¯æŒçš„ç»Ÿè®¡æŒ‡æ ‡
const supportedMetrics = ['draws', 'consumption', 'users', 'win_rate']

// æ—¶é—´å¯¹æ¯”åŠŸèƒ½å¯ç›´æ¥ä½¿ç”¨ dimension='time' + metric='*'
```

**å¤ç”¨å·¥ä½œé‡**: åŸä¼° 1å¤© â†’ **0.3å¤©**ï¼ˆæ–°å¢ `time-comparison` ç«¯ç‚¹è°ƒç”¨ç°æœ‰æ–¹æ³•ï¼‰

---

#### 10.8.3 ç”¨æˆ·åˆ†å±‚ä¸æ¼æ–—æœåŠ¡ï¼ˆP1/P2/P3 å¯å¤ç”¨ âœ…ï¼‰

| ç°æœ‰æœåŠ¡ | æ–‡ä»¶è·¯å¾„ | å·²æœ‰æ–¹æ³• | å¤ç”¨æ–¹æ¡ˆ |
|---------|---------|---------|---------|
| `UserSegmentService` | `services/user/UserSegmentService.js` | `getSegmentStats()`, `getSegmentUsers()`, `getActivityHeatmap()`, `getExchangePreferences()`, `getBehaviorFunnel()` | ç”¨æˆ·360è§†å›¾ã€åˆ†å±‚åˆ†å¸ƒã€è½¬åŒ–æ¼æ–—å…¨è¦†ç›– |

**æ ¸å¿ƒå‘ç°**:
```javascript
// ç”¨æˆ·360Â°è§†å›¾æ•°æ®æºï¼ˆå·²å®ç°ï¼‰
// - getActivityHeatmap(): ç”¨æˆ·æ´»åŠ¨çƒ­å›¾
// - getExchangePreferences(): å…‘æ¢åå¥½
// - getSegmentStats(): åˆ†å±‚ç»Ÿè®¡

// è½¬åŒ–æ¼æ–—ï¼ˆP3 å·²å®ç°ï¼‰
// getBehaviorFunnel() è¿”å›5å±‚æ¼æ–—ï¼š
// è®¿é—® â†’ æ³¨å†Œ â†’ é¦–æŠ½ â†’ æ´»è·ƒ â†’ ä»˜è´¹
```

**å¤ç”¨å·¥ä½œé‡**: 
- ç”¨æˆ·360Â°è§†å›¾: åŸä¼° 1å¤© â†’ **0.5å¤©**
- è½¬åŒ–æ¼æ–—: åŸä¼° 2å¤© â†’ **0.3å¤©**ï¼ˆå·²å®ç°ï¼‰

---

#### 10.8.4 å®¡è®¡æ—¥å¿—æœåŠ¡ï¼ˆP2 å¯å¤ç”¨ âœ…ï¼‰

| ç°æœ‰æœåŠ¡ | æ–‡ä»¶è·¯å¾„ | å·²æœ‰æ–¹æ³• | å¤ç”¨æ–¹æ¡ˆ |
|---------|---------|---------|---------|
| `AuditLogService` | `services/AuditLogService.js` | å®Œæ•´ CRUD + æ“ä½œç±»å‹æšä¸¾ | ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€å¼€å‘ |

**æ ¸å¿ƒå‘ç°**:
```javascript
// å·²æ”¯æŒçš„æ“ä½œç±»å‹
const OPERATION_TYPES = {
  POINTS_ADD: 'ç§¯åˆ†å‘æ”¾',
  INVENTORY_TRANSFER: 'åº“å­˜è½¬ç§»',
  ASSET_ADJUSTMENT: 'èµ„äº§è°ƒæ•´',
  // ... å®Œæ•´è¦†ç›–
}

// å·²æ”¯æŒ before/after æ•°æ®è®°å½•
// å·²é›†æˆ request_id é“¾è·¯è¿½è¸ª
```

**å¤ç”¨å·¥ä½œé‡**: åŸä¼° 2å¤© â†’ **0å¤©**ï¼ˆå®Œå…¨å®ç°ï¼‰

---

#### 10.8.5 å®¢æœå“åº”æ—¶é•¿ï¼ˆP1 éƒ¨åˆ†å®ç° âš ï¸ï¼‰

| ç°æœ‰æœåŠ¡ | æ–‡ä»¶è·¯å¾„ | å·²æœ‰æ–¹æ³• | éœ€æ‰©å±• |
|---------|---------|---------|---------|
| `CustomerServiceSessionService` | `services/CustomerServiceSessionService.js` | `calculateAverageResponseTime()` | æ–°å¢å­—æ®µ `first_response_at` + ç»Ÿè®¡ç«¯ç‚¹ |

**æ ¸å¿ƒå‘ç°**:
- å“åº”æ—¶é•¿è®¡ç®—é€»è¾‘å·²å­˜åœ¨
- ç¼ºå°‘ `first_response_at` æ•°æ®åº“å­—æ®µï¼ˆå†³ç­– D-1 å·²ç¡®è®¤æ–°å¢ï¼‰
- éœ€æ–°å¢ `/customer-service/response-stats` ç«¯ç‚¹

**å¤ç”¨å·¥ä½œé‡**: åŸä¼° 0.5å¤© â†’ **0.3å¤©**

---

#### 10.8.6 å€ºåŠ¡ç®¡ç†æœåŠ¡ï¼ˆP1 å¯å¤ç”¨ âœ…ï¼‰

| ç°æœ‰æœåŠ¡ | æ–‡ä»¶è·¯å¾„ | å·²æœ‰æ–¹æ³• | å¤ç”¨æ–¹æ¡ˆ |
|---------|---------|---------|---------|
| `DebtManagementService` | `services/DebtManagementService.js` | é¢„ç®—è¶‹åŠ¿ã€æ¬ è´¦ç»Ÿè®¡ | ç³»ç»Ÿå«ä»˜çœ‹æ¿å¯ç›´æ¥å¤ç”¨ |

**å¤ç”¨å·¥ä½œé‡**: åŸä¼° 0.5å¤© â†’ **0.2å¤©**

---

#### 10.8.7 å¤ç”¨æ€»ç»“

| åŠŸèƒ½ç±»åˆ« | åŸä¼°å·¥æ—¶ | å¤ç”¨åå·¥æ—¶ | èŠ‚çœ | å¤ç”¨ç‡ |
|---------|---------|----------|------|-------|
| P0 å¥åº·åº¦è®¡ç®— | 2å¤© | 0.5å¤© | 1.5å¤© | 75% |
| P1 ç”¨æˆ·360Â°è§†å›¾ | 1å¤© | 0.5å¤© | 0.5å¤© | 50% |
| P1 æ—¶é—´å¯¹æ¯” | 1å¤© | 0.3å¤© | 0.7å¤© | 70% |
| P1 å®¢æœå“åº” | 0.5å¤© | 0.3å¤© | 0.2å¤© | 40% |
| P1 ç³»ç»Ÿå«ä»˜ | 0.5å¤© | 0.2å¤© | 0.3å¤© | 60% |
| P2 å®¡è®¡æ—¥å¿— | 2å¤© | 0å¤© | 2å¤© | 100% |
| P3 è½¬åŒ–æ¼æ–— | 2å¤© | 0.3å¤© | 1.7å¤© | 85% |
| **åˆè®¡** | 9å¤© | 2.1å¤© | **6.9å¤©** | **77%** |

---

## åä¸€ã€éœ€è¦æ‹æ¿å†³ç­–çš„å…³é”®é—®é¢˜ï¼ˆ2026-02-03ï¼‰

> **å†³ç­–åŸåˆ™**: é¡¹ç›®æœªä¸Šçº¿ï¼Œä¼˜å…ˆé•¿æœŸç»´æŠ¤æˆæœ¬ä½ã€é™ä½æŠ€æœ¯å€ºåŠ¡  
> **ä¸å…¼å®¹æ—§æ¥å£**: ä¸€æ¬¡æ€§æŠ•å…¥ï¼Œä¸è€ƒè™‘å‘åå…¼å®¹  
> **å†³ç­–çŠ¶æ€**: âœ… å·²å…¨éƒ¨æ‹æ¿ç¡®è®¤ï¼ˆ2026-02-03ï¼‰

### ğŸ“‹ å†³ç­–æ±‡æ€»è¡¨

| å†³ç­–ç‚¹ | æœ€ç»ˆå†³ç­– | é€‰æ‹©ç†ç”± |
|-------|---------|---------|
| **D-1** | A: æ–°å¢å­—æ®µ + åº”ç”¨å±‚å†™å…¥ | é•¿æœŸç»´æŠ¤æˆæœ¬æœ€ä½ï¼Œç¬¦åˆå¤§å‚å®è·µ |
| **D-2** | å›ºå®šæƒé‡ + system_config + 60åˆ†å‘Šè­¦ | å¹³è¡¡çµæ´»æ€§å’Œå¼€å‘æˆæœ¬ |
| **D-3** | A: èšåˆæŸ¥è¯¢ + 2åˆ†é’Ÿç¼“å­˜ | å®æ—¶æ€§å¥½ï¼Œå¼€å‘æˆæœ¬ä½ |
| **D-4** | æ—¥ç¯æ¯”é»˜è®¤ + 10ä¸ªæ ¸å¿ƒæŒ‡æ ‡ | è¦†ç›–æ ¸å¿ƒä¸šåŠ¡ï¼Œé¿å…è¿‡åº¦è®¾è®¡ |
| **D-5** | æ–°å»ºè¡¨ + 24hé»˜è®¤ + Rediså»é‡ | ç®€å•å®ç”¨ï¼Œæœ‰æ•ˆé˜²ç–²åŠ³ |

---

### 11.1 âœ… å†³ç­–ç‚¹ D-1: æ•°æ®åº“å­—æ®µç­–ç•¥ã€å·²ç¡®è®¤ã€‘

**é—®é¢˜**: `customer_service_sessions.first_response_at` å­—æ®µä¸å­˜åœ¨ï¼Œéœ€è¦ç”¨äºå®¢æœå“åº”æ—¶é•¿ç»Ÿè®¡

| æ–¹æ¡ˆ | è¯´æ˜ | å¼€å‘æˆæœ¬ | ç»´æŠ¤æˆæœ¬ | çŠ¶æ€ |
|-----|-----|---------|---------|-----|
| **A: æ–°å¢å­—æ®µ** | ALTER TABLE æ–°å¢ `first_response_at`ï¼Œåº”ç”¨å±‚å†™å…¥ | 0.5å¤© | ä½ | âœ… **å·²é€‰æ‹©** |
| B: å®æ—¶è®¡ç®— | æ¯æ¬¡æŸ¥è¯¢ JOIN `chat_messages` è®¡ç®— | 0å¤© | é«˜ï¼ˆæ…¢æŸ¥è¯¢ï¼‰ | âŒ |
| C: å®šæ—¶ä»»åŠ¡å›å¡« | å®šæ—¶ä»æ¶ˆæ¯è¡¨è®¡ç®—å†™å…¥ | 0.5å¤© | ä¸­ | âš ï¸ |

**âœ… æœ€ç»ˆå†³ç­–**: **æ–¹æ¡ˆ A - æ–°å¢å­—æ®µ + åº”ç”¨å±‚å†™å…¥**

**å†³ç­–ç†ç”±**:
- é•¿æœŸç»´æŠ¤æˆæœ¬æœ€ä½ï¼Œä¸€æ¬¡æ€§æŠ•å…¥
- ç¬¦åˆç¾å›¢/é˜¿é‡Œç­‰å¤§å‚å®¢æœç³»ç»Ÿè®¾è®¡å®è·µ
- æ•°æ®ä¸€è‡´æ€§å¥½ï¼ŒæŸ¥è¯¢æ€§èƒ½æœ‰ä¿éšœ

---

### 11.2 âœ… å†³ç­–ç‚¹ D-2: å¥åº·åº¦è¯„åˆ†ç®—æ³•ã€å·²ç¡®è®¤ã€‘

**é—®é¢˜**: å¾…åŠå¥åº·åº¦ã€ä¸šåŠ¡å¥åº·åº¦çš„è®¡ç®—è§„åˆ™

**âœ… æœ€ç»ˆå†³ç­–**: **å›ºå®šæƒé‡ + system_config åŠ¨æ€é…ç½® + 60åˆ†å‘Šè­¦é˜ˆå€¼**

#### D-2.1 å¾…åŠå¥åº·åº¦è¯„åˆ†ï¼ˆ100åˆ†åˆ¶ï¼‰

```javascript
// ç®—æ³•è®¾è®¡ã€å·²ç¡®è®¤ã€‘
const calculatePendingHealthScore = (pending) => {
  let score = 100
  
  // ç»´åº¦1: è¶…æ—¶æ¯”ä¾‹æ‰£åˆ†ï¼ˆæƒé‡40%ï¼‰ã€å·²ç¡®è®¤ã€‘
  const timeoutRatio = pending.urgent_count / pending.total_count
  score -= timeoutRatio * 40
  
  // ç»´åº¦2: ç§¯å‹æ•°é‡æ‰£åˆ†ï¼ˆæƒé‡30%ï¼‰ã€å·²ç¡®è®¤ã€‘
  const backlogPenalty = Math.min(30, pending.total_count * 0.5)
  score -= backlogPenalty
  
  // ç»´åº¦3: æœ€é•¿ç­‰å¾…æ—¶é—´æ‰£åˆ†ï¼ˆæƒé‡30%ï¼‰ã€å·²ç¡®è®¤ã€‘
  const waitPenalty = Math.min(30, pending.oldest_minutes / 60 * 10)
  score -= waitPenalty
  
  return Math.max(0, Math.round(score))
}
```

**âœ… å·²ç¡®è®¤é…ç½®**: 
- âœ… è¶…æ—¶é˜ˆå€¼: æ¶ˆè´¹å®¡æ ¸24hã€å®¢æœ30minã€é£æ§å‘Šè­¦1hã€æŠ½å¥–å‘Šè­¦2h
- âœ… è¯„åˆ†æƒé‡: è¶…æ—¶40%ã€ç§¯å‹30%ã€ç­‰å¾…30%
- âœ… å­˜å…¥ `system_config` è¡¨æ”¯æŒåŠ¨æ€è°ƒæ•´
- âœ… ä½äº60åˆ†è§¦å‘å‘Šè­¦

---

#### D-2.2 ä¸šåŠ¡å¥åº·åº¦è¯„åˆ†ï¼ˆ5ç»´åº¦é›·è¾¾å›¾ï¼‰ã€å·²ç¡®è®¤ã€‘

| ç»´åº¦ | æŒ‡æ ‡ | æ»¡åˆ†æ¡ä»¶ | æ‰£åˆ†è§„åˆ™ | æƒé‡ |
|-----|-----|---------|---------|-----|
| ç”¨æˆ·æ´»è·ƒ | DAU/MAUæ¯”å€¼ | â‰¥30% | æ¯ä¸‹é™5%æ‰£10åˆ† | 20% |
| æŠ½å¥–å¥åº· | ä¸­å¥–ç‡åœ¨ç›®æ ‡èŒƒå›´ | è¯¯å·®â‰¤5% | æ¯è¶…1%æ‰£5åˆ† | 20% |
| é¢„ç®—æ§åˆ¶ | å®é™…/é¢„ç®—æ¯”å€¼ | 80%-100% | è¶…å‡ºæ¯10%æ‰£10åˆ† | 20% |
| å®¢æœæ•ˆç‡ | å¹³å‡å“åº”â‰¤15min | â‰¤15min | æ¯è¶…5minæ‰£10åˆ† | 20% |
| ç³»ç»Ÿå«ä»˜ | å«ä»˜ç‡ | â‰¤5% | æ¯è¶…1%æ‰£10åˆ† | 20% |

**âœ… å·²ç¡®è®¤é…ç½®**: 
- âœ… 5ç»´åº¦æƒé‡ç›¸ç­‰ï¼ˆå„20%ï¼‰
- âœ… ä½äº60åˆ†è§¦å‘å‘Šè­¦
- âœ… é…ç½®å­˜å…¥ `system_config` è¡¨ï¼Œæ”¯æŒåŠ¨æ€è°ƒæ•´

---

### 11.3 âœ… å†³ç­–ç‚¹ D-3: ç”¨æˆ·360Â°è§†å›¾æ¶æ„ã€å·²ç¡®è®¤ã€‘

**é—®é¢˜**: ç”¨æˆ·360Â°è§†å›¾éœ€è¦èšåˆå¤šä¸ªæ•°æ®æºï¼Œæ¶æ„é€‰å‹

| æ–¹æ¡ˆ | è¯´æ˜ | ä¼˜ç‚¹ | ç¼ºç‚¹ | çŠ¶æ€ |
|-----|-----|------|------|-----|
| **A: èšåˆæŸ¥è¯¢** | å•ä¸ªæ¥å£å¹¶è¡ŒæŸ¥è¯¢å¤šä¸ªæœåŠ¡ | å®æ—¶æ€§å¥½ | å“åº”æ…¢ï¼ˆ5-8ä¸ªæŸ¥è¯¢ï¼‰ | âœ… **å·²é€‰æ‹©** |
| B: ç‰©åŒ–è§†å›¾ | å®šæ—¶é¢„è®¡ç®—å†™å…¥æ±‡æ€»è¡¨ | å“åº”å¿« | å®æ—¶æ€§å·®ã€å­˜å‚¨æˆæœ¬ | âŒ |
| C: æ··åˆæ¨¡å¼ | æ ¸å¿ƒæ•°æ®ç¼“å­˜+å®æ—¶è¡¥å…… | å¹³è¡¡ | å®ç°å¤æ‚ | âŒ |

**âœ… æœ€ç»ˆå†³ç­–**: **æ–¹æ¡ˆ A - èšåˆæŸ¥è¯¢ + 2åˆ†é’Ÿ Redis ç¼“å­˜**

**å†³ç­–ç†ç”±**:
- å®æ—¶æ€§å¥½ï¼Œç¬¦åˆè¿è¥åå°éœ€æ±‚
- å¼€å‘æˆæœ¬ä½ï¼Œå¤ç”¨ç°æœ‰æœåŠ¡
- 2åˆ†é’Ÿç¼“å­˜å¯æ¥å—ï¼Œé¿å…é¢‘ç¹æŸ¥è¯¢æ•°æ®åº“

**360Â° è§†å›¾æ•°æ®æº**:
```
1. åŸºç¡€ä¿¡æ¯ â† users è¡¨
2. èµ„äº§æ¦‚å†µ â† account_asset_balances è¡¨
3. æŠ½å¥–è¡Œä¸º â† lottery_draws è¡¨ï¼ˆè¿‘30å¤©ï¼‰
4. æ¶ˆè´¹è®°å½• â† consumption_records è¡¨ï¼ˆè¿‘30å¤©ï¼‰
5. å®¢æœä¼šè¯ â† customer_service_sessions è¡¨
6. é£æ§æ ‡ç­¾ â† user_risk_profiles è¡¨
7. å®¡æ ¸å†å² â† consumption_records.status ç»Ÿè®¡
```

**âœ… å·²ç¡®è®¤é…ç½®**: 
- âœ… æ¶æ„æ–¹æ¡ˆ: Aï¼ˆèšåˆæŸ¥è¯¢ï¼‰
- âœ… ç¼“å­˜ç­–ç•¥: Redis 2åˆ†é’ŸTTLï¼ˆä½¿ç”¨ BusinessCacheHelperï¼‰
- âœ… å“åº”æ—¶é—´ç›®æ ‡: â‰¤3ç§’

---

### 11.4 âœ… å†³ç­–ç‚¹ D-4: æ—¶é—´å¯¹æ¯”ç­–ç•¥ã€å·²ç¡®è®¤ã€‘

**é—®é¢˜**: ç¯æ¯”/åŒæ¯”è®¡ç®—çš„æ—¶é—´èŒƒå›´å’Œç²’åº¦

**âœ… æœ€ç»ˆå†³ç­–**: **æ—¥ç¯æ¯”é»˜è®¤ + 10ä¸ªæ ¸å¿ƒæŒ‡æ ‡**

| å¯¹æ¯”ç±»å‹ | è®¡ç®—è§„åˆ™ | ç¤ºä¾‹ | çŠ¶æ€ |
|---------|---------|------|-----|
| **æ—¥ç¯æ¯”** | (ä»Šæ—¥ - æ˜¨æ—¥) / æ˜¨æ—¥ | ä»Šæ—¥DAU vs æ˜¨æ—¥DAU | âœ… **é»˜è®¤** |
| å‘¨ç¯æ¯” | (æœ¬å‘¨ - ä¸Šå‘¨) / ä¸Šå‘¨ | æœ¬å‘¨æŠ½å¥–æ¬¡æ•° vs ä¸Šå‘¨ | âœ… æ”¯æŒ |
| æœˆåŒæ¯” | (æœ¬æœˆ - å»å¹´åŒæœˆ) / å»å¹´åŒæœˆ | æœ¬æœˆæ”¶å…¥ vs å»å¹´åŒæœˆ | âœ… æ”¯æŒ |

**âœ… å·²ç¡®è®¤çš„10ä¸ªæ ¸å¿ƒæŒ‡æ ‡**:

| æŒ‡æ ‡ä»£ç  | æŒ‡æ ‡åç§° | æ•°æ®æ¥æº |
|---------|---------|---------|
| `dau` | æ—¥æ´»è·ƒç”¨æˆ· | `users` ç™»å½•ç»Ÿè®¡ |
| `draw_count` | æŠ½å¥–æ¬¡æ•° | `lottery_draws` |
| `consumption_amount` | æ¶ˆè´¹é‡‘é¢ | `consumption_records` |
| `consumption_count` | æ¶ˆè´¹ç¬”æ•° | `consumption_records` |
| `win_rate` | ä¸­å¥–ç‡ | `lottery_draws` |
| `avg_response_time` | å¹³å‡å®¢æœå“åº”æ—¶é—´ | `customer_service_sessions` |
| `new_users` | æ–°æ³¨å†Œç”¨æˆ· | `users` |
| `active_lottery_count` | æ´»è·ƒæŠ½å¥–æ´»åŠ¨æ•° | `lottery_campaigns` |
| `system_advance_amount` | ç³»ç»Ÿå«ä»˜é‡‘é¢ | `lottery_draws` |
| `pending_count` | å¾…å¤„ç†äº‹é¡¹æ•° | èšåˆç»Ÿè®¡ |

**API è®¾è®¡æ–¹æ¡ˆã€å·²ç¡®è®¤ã€‘**:
```javascript
// GET /api/v4/console/dashboard/time-comparison
{
  params: {
    metrics: ['dau', 'draw_count', 'consumption_amount', ...], // 10ä¸ªæ ¸å¿ƒæŒ‡æ ‡
    compare_type: 'day_on_day' | 'week_on_week' | 'year_on_year',  // é»˜è®¤ day_on_day
    date: '2026-02-03'  // åŸºå‡†æ—¥æœŸ
  },
  response: {
    dau: { current: 1200, previous: 1100, change_ratio: 0.091, trend: 'up' },
    draw_count: { current: 5000, previous: 4800, change_ratio: 0.042, trend: 'up' }
  }
}
```

**âœ… å·²ç¡®è®¤é…ç½®**: 
- âœ… é»˜è®¤å¯¹æ¯”ç±»å‹: æ—¥ç¯æ¯”ï¼ˆday_on_dayï¼‰
- âœ… æ”¯æŒæŒ‡æ ‡æ•°é‡: 10ä¸ªæ ¸å¿ƒä¸šåŠ¡æŒ‡æ ‡

---

### 11.5 âœ… å†³ç­–ç‚¹ D-5: å‘Šè­¦é™é»˜ä¸ç–²åŠ³é¢„é˜²ã€å·²ç¡®è®¤ã€‘

**é—®é¢˜**: å‘Šè­¦é‡å¤å‘é€å¯¼è‡´ç–²åŠ³ï¼Œéœ€è¦é™é»˜æœºåˆ¶

**âœ… æœ€ç»ˆå†³ç­–**: **æ–°å»ºè¡¨ + 24å°æ—¶é»˜è®¤é™é»˜ + Rediså»é‡**

| åŠŸèƒ½ | è¯´æ˜ | å®ç°æ–¹æ¡ˆ | çŠ¶æ€ |
|-----|-----|---------|-----|
| å‘Šè­¦åˆå¹¶ | ç›¸åŒç±»å‹å‘Šè­¦30åˆ†é’Ÿå†…åªå‘1æ¬¡ | Redis å»é‡ key | âœ… **å·²ç¡®è®¤** |
| æ‰‹åŠ¨é™é»˜ | ç®¡ç†å‘˜æ‰‹åŠ¨é™é»˜æŸç±»å‘Šè­¦ | `alert_silence_rules` è¡¨ | âœ… **å·²ç¡®è®¤** |
| è‡ªåŠ¨æ¢å¤ | é™é»˜æ—¶é—´åˆ°æœŸè‡ªåŠ¨è§£é™¤ | å®šæ—¶ä»»åŠ¡æ‰«æ | âœ… **å·²ç¡®è®¤** |

**æ•°æ®è¡¨è®¾è®¡ã€å·²ç¡®è®¤ã€‘**:
```sql
CREATE TABLE alert_silence_rules (
  silence_id INT AUTO_INCREMENT PRIMARY KEY,
  alert_type VARCHAR(50) NOT NULL,      -- å‘Šè­¦ç±»å‹
  silence_reason VARCHAR(255),           -- é™é»˜åŸå› 
  created_by INT NOT NULL,               -- æ“ä½œäºº
  expires_at DATETIME NOT NULL,          -- è¿‡æœŸæ—¶é—´ï¼ˆé»˜è®¤24å°æ—¶ï¼‰
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_alert_type (alert_type),
  INDEX idx_expires_at (expires_at)
);
```

**Redis å»é‡ç­–ç•¥ã€å·²ç¡®è®¤ã€‘**:
```javascript
// Redis key è®¾è®¡
const alertDedupeKey = `alert:dedupe:${alert_type}:${entity_id}`
const DEDUPE_TTL = 30 * 60 // 30åˆ†é’Ÿå†…ç›¸åŒå‘Šè­¦åªå‘1æ¬¡

// å»é‡é€»è¾‘
const isDuplicate = await redis.set(alertDedupeKey, 1, 'EX', DEDUPE_TTL, 'NX')
if (!isDuplicate) {
  // é‡å¤å‘Šè­¦ï¼Œè·³è¿‡å‘é€
  return
}
```

**âœ… å·²ç¡®è®¤é…ç½®**: 
- âœ… æ–°å»º `alert_silence_rules` è¡¨
- âœ… é»˜è®¤é™é»˜æ—¶é•¿: 24å°æ—¶
- âœ… Rediså»é‡çª—å£: 30åˆ†é’Ÿ

---

## åäºŒã€å¯å¤ç”¨æŠ€æœ¯èµ„äº§åˆ†æ

> **é‡è¦**: æœ¬ç« èŠ‚åŸºäºåç«¯æ•°æ®åº“é¡¹ç›®å®é™…çš„æŠ€æœ¯æ¡†æ¶ã€æŠ€æœ¯è·¯çº¿å’ŒæŠ€æœ¯æ ˆè¿›è¡Œåˆ†æï¼Œæ‰€æœ‰å¤ç”¨å’Œæ‰©å±•å¿…é¡»éµå¾ª **Â§2.5 åç«¯æŠ€æœ¯è§„èŒƒå¼ºåˆ¶è¦æ±‚**ã€‚

### 12.1 âœ… å·²æœ‰å¯ç›´æ¥å¤ç”¨çš„åŸºç¡€è®¾æ–½

| æŠ€æœ¯ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | èƒ½åŠ› | å¤ç”¨åœºæ™¯ | ä½¿ç”¨æ–¹å¼ |
|---------|---------|------|---------|---------|
| **ServiceManager** | `services/index.js` | ç»Ÿä¸€æœåŠ¡ç®¡ç†ã€ä¾èµ–æ³¨å…¥ã€æœåŠ¡å‘ç° | æ‰€æœ‰æ–°æœåŠ¡å¿…é¡»æ³¨å†Œ | `req.app.locals.services.getService('service_name')` |
| **Redis L2 ç¼“å­˜** | `utils/BusinessCacheHelper.js` | ç»Ÿä¸€ç¼“å­˜è¯»å†™ã€TTLæŠ–åŠ¨ã€ç»Ÿè®¡ç›‘æ§ | æ‰€æœ‰æ–°æœåŠ¡çš„ç¼“å­˜éœ€æ±‚ | `BusinessCacheHelper.get/set/del` |
| **æ—¶é—´å¤„ç†** | `utils/timeHelper.js` | åŒ—äº¬æ—¶é—´è½¬æ¢ã€APIæ—¶é—´æˆ³ | æ‰€æœ‰æ—¶é—´ç›¸å…³è®¡ç®— | `BeijingTimeHelper.apiTimestamp()` |
| **APIå“åº”** | `utils/ApiResponse.js` | ç»Ÿä¸€å“åº”æ ¼å¼ã€é”™è¯¯ç  | æ‰€æœ‰æ–°è·¯ç”± | `res.apiSuccess/apiError/apiPaginated` |
| **æ—¥å¿—è®°å½•** | `utils/logger.js` | ç»“æ„åŒ–æ—¥å¿—ã€æ…¢æŸ¥è¯¢ç›‘æ§ | æ‰€æœ‰æœåŠ¡å±‚ | `logger.info/error/debug` |
| **é”™è¯¯å¤„ç†** | `middleware/validation.js` | ç»Ÿä¸€æœåŠ¡é”™è¯¯å¤„ç† | æ‰€æœ‰è·¯ç”±é”™è¯¯ | `handleServiceError(error, res, msg)` |
| **äº‹åŠ¡ç®¡ç†** | `utils/TransactionManager.js` | Sequelizeäº‹åŠ¡å°è£… | æ‰¹é‡æ“ä½œã€å…³è”å†™å…¥ | `TransactionManager.execute(callback)` |
| **åˆ†å¸ƒå¼é”** | `utils/UnifiedDistributedLock.js` | Redisåˆ†å¸ƒå¼é” | å¹¶å‘æ§åˆ¶ã€é˜²é‡å¤ | `UnifiedDistributedLock.acquire(key, ttl)` |
| **å¹‚ç­‰æ€§æ§åˆ¶** | `services/IdempotencyService.js` | æ¥å£å¹‚ç­‰æ€§ | å…³é”®å†™æ“ä½œ | é€šè¿‡ ServiceManager è·å– |

### 12.2 âœ… å·²æœ‰å¯æ‰©å±•çš„æœåŠ¡ç±»

| æœåŠ¡ç±» | ServiceManageré”® | ç°æœ‰æ–¹æ³• | æ‰©å±•æ–¹å‘ |
|-------|------------------|---------|---------|
| `PendingCenterService` | `pending_center` | `getSegmentStats()`, `getUnifiedList()` | + `calculateHealthScore()` |
| `PendingSummaryService` | `pending_summary` | `getPendingSummary()` | + `getDetailedCategoryStats()` |
| `DashboardQueryService` | `console_dashboard_query` | `getSystemOverview()`, `getUserGrowthTrend()` | + `getBusinessHealthScore()` |
| `MultiDimensionStatsService` | `multi_dimension_stats` | `getMultiDimensionStats()`, `getDrillDownDetails()` | + `getTimeComparison()` |
| `UserSegmentService` | `user_segment` | `getSegments()`, `getFunnel()` | + `getApprovalRate()`, `get360View()` |
| `CustomerServiceSessionService` | `customer_service_session` | åŸºç¡€ä¼šè¯CRUD | + `getResponseStats()` |
| `LotteryHealthService` | `lottery_health` | `getTierDistribution()`, `getBudgetRate()` | + `getGlobalBudgetForecast()` |
| `AuditLogService` | `audit_log` | å®Œæ•´CRUD + 15ç§æ“ä½œç±»å‹ | ç›´æ¥å¤ç”¨ |
| `DebtManagementService` | `debt_management` | é¢„ç®—è¶‹åŠ¿ã€æ¬ è´¦ç»Ÿè®¡ | ç›´æ¥å¤ç”¨ |

### 12.3 âœ… å·²æœ‰è·¯ç”±æ¨¡å—ï¼ˆå¯æ–°å¢ç«¯ç‚¹ï¼‰

| è·¯ç”±æ–‡ä»¶ | å½“å‰ç«¯ç‚¹æ•° | å¯æ–°å¢ç«¯ç‚¹ |
|---------|----------|----------|
| `routes/v4/console/pending.js` | 2 | `/health-score` |
| `routes/v4/console/dashboard.js` | 1 | `/business-health`, `/time-comparison` |
| `routes/v4/console/user-segments.js` | 2 | `/:user_id/approval-rate`, `/:user_id/360view` |
| `routes/v4/console/customer-service/index.js` | 5 | `/response-stats` |
| `routes/v4/console/system/index.js` | 2 | `/api-performance` |
| `routes/v4/console/stores.js` | 5 | `/contribution` |

### 12.4 ğŸ”§ æ–°æœåŠ¡å¼€å‘æ£€æŸ¥æ¸…å•

> **å¿…é¡»éµå¾ªçš„å¼€å‘è§„èŒƒ**ï¼ˆé™ä½æŠ€æœ¯å€ºåŠ¡ã€ä¿æŒä»£ç ä¸€è‡´æ€§ï¼‰

#### 12.4.1 æ–°å»ºæœåŠ¡å¿…é¡»å®Œæˆçš„æ­¥éª¤

| æ­¥éª¤ | æ“ä½œ | æ–‡ä»¶ä½ç½® | è§„èŒƒä¾æ® |
|-----|------|---------|---------|
| 1 | åˆ›å»ºæœåŠ¡æ–‡ä»¶ï¼ˆé™æ€ç±»/å®ä¾‹ç±»ï¼‰ | `services/{domain}/{ServiceName}.js` | æ–‡ä»¶å‘½å PascalCase |
| 2 | åœ¨ ServiceManager ä¸­å¯¼å…¥æœåŠ¡ | `services/index.js` é¡¶éƒ¨ | TR-005 è§„èŒƒ |
| 3 | åœ¨ ServiceManager.initialize() ä¸­æ³¨å†Œ | `services/index.js` ç¬¬337è¡Œå | snake_case é”®å |
| 4 | è·¯ç”±ä¸­é€šè¿‡ ServiceManager è·å–æœåŠ¡ | `req.app.locals.services.getService('key')` | TR-005 è§„èŒƒ |
| 5 | ä½¿ç”¨ handleServiceError å¤„ç†é”™è¯¯ | `middleware/validation.js` | é”™è¯¯å¤„ç†è§„èŒƒ |

#### 12.4.2 æ–°å»ºè·¯ç”±ç«¯ç‚¹å¿…é¡»å®Œæˆçš„æ­¥éª¤

```javascript
// æ–°è·¯ç”±æ¨¡æ¿ï¼ˆç¬¦åˆ TR-005 è§„èŒƒï¼‰
router.get('/new-endpoint', authenticateToken, requireRoleLevel(100), async (req, res) => {
  try {
    // 1. è®°å½•è¯·æ±‚æ—¥å¿—
    logger.info('[ä¸šåŠ¡æ¨¡å—] æ“ä½œæè¿°', { admin_id: req.user.user_id, ...params })

    // 2. é€šè¿‡ ServiceManager è·å–æœåŠ¡ï¼ˆå¿…é¡»ï¼‰
    const MyService = req.app.locals.services.getService('my_service')

    // 3. è°ƒç”¨æœåŠ¡æ–¹æ³•
    const result = await MyService.doSomething(params)

    // 4. è¿”å›æˆåŠŸå“åº”
    return res.apiSuccess(result, 'æ“ä½œæˆåŠŸ')
  } catch (error) {
    // 5. è®°å½•é”™è¯¯æ—¥å¿—
    logger.error('[ä¸šåŠ¡æ¨¡å—] æ“ä½œå¤±è´¥', { error: error.message })

    // 6. ä½¿ç”¨æ ‡å‡†é”™è¯¯å¤„ç†ï¼ˆå¿…é¡»ï¼‰
    return handleServiceError(error, res, 'æ“ä½œå¤±è´¥')
  }
})
```

#### 12.4.3 æœåŠ¡æ³¨å†Œä»£ç æ¨¡æ¿

```javascript
// åœ¨ services/index.js ä¸­æ·»åŠ 

// 1. æ–‡ä»¶é¡¶éƒ¨ï¼šå¯¼å…¥æ–°æœåŠ¡
const PendingHealthScoreService = require('./pending/PendingHealthScoreService')
const BusinessHealthScoreService = require('./dashboard/BusinessHealthScoreService')

// 2. åœ¨ initialize() æ–¹æ³•ä¸­æ³¨å†Œï¼ˆçº¦ç¬¬547è¡Œåï¼ŒP0 å¾…å¤„ç†ä¸­å¿ƒæœåŠ¡åŒºå—ï¼‰
this._services.set('pending_health_score', PendingHealthScoreService)  // å¾…åŠå¥åº·åº¦è¯„åˆ†æœåŠ¡
this._services.set('business_health_score', BusinessHealthScoreService) // ä¸šåŠ¡å¥åº·åº¦è¯„åˆ†æœåŠ¡
```

---

## åä¸‰ã€æ‰§è¡Œæ­¥éª¤ä¸ä»£ç æ¨¡æ¿

### 13.1 Phase 1: æ•°æ®åº“å˜æ›´ï¼ˆ0.5å¤©ï¼‰

**æ­¥éª¤ 1.1**: æ–°å¢å®¢æœé¦–æ¬¡å“åº”æ—¶é—´å­—æ®µ âœ…ã€å†³ç­– D-1 å·²ç¡®è®¤ï¼šæ–¹æ¡ˆAã€‘

```sql
-- migrations/20260203_add_first_response_at.sql
-- âœ… å†³ç­– D-1 å·²ç¡®è®¤ï¼šæ–°å¢å­—æ®µ + åº”ç”¨å±‚å†™å…¥

ALTER TABLE customer_service_sessions 
ADD COLUMN first_response_at DATETIME NULL 
COMMENT 'å®¢æœé¦–æ¬¡å“åº”æ—¶é—´' 
AFTER status;

-- æ•°æ®å›å¡«ï¼ˆä»æ¶ˆæ¯è¡¨è®¡ç®—ï¼‰
UPDATE customer_service_sessions cs
SET first_response_at = (
  SELECT MIN(cm.created_at) 
  FROM chat_messages cm 
  WHERE cm.session_id = cs.session_id 
  AND cm.sender_type = 'admin'
)
WHERE first_response_at IS NULL 
AND status IN ('active', 'closed');

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_css_first_response ON customer_service_sessions(first_response_at);
```

**æ­¥éª¤ 1.2**: æ–°å¢å‘Šè­¦é™é»˜è¡¨ âœ…ã€å†³ç­– D-5 å·²ç¡®è®¤ï¼šæ–°å»ºè¡¨+24h+Rediså»é‡ã€‘

```sql
-- migrations/20260203_create_alert_silence_rules.sql
-- âœ… å†³ç­– D-5 å·²ç¡®è®¤ï¼šæ–°å»ºè¡¨ + 24hé»˜è®¤é™é»˜ + Rediså»é‡
CREATE TABLE IF NOT EXISTS alert_silence_rules (
  silence_id INT AUTO_INCREMENT PRIMARY KEY,
  alert_type VARCHAR(50) NOT NULL COMMENT 'å‘Šè­¦ç±»å‹',
  lottery_campaign_id INT NULL COMMENT 'å…³è”æ´»åŠ¨IDï¼ˆå¯é€‰ï¼‰',
  silence_reason VARCHAR(255) NOT NULL COMMENT 'é™é»˜åŸå› ',
  created_by INT NOT NULL COMMENT 'æ“ä½œäººID',
  expires_at DATETIME NOT NULL COMMENT 'è¿‡æœŸæ—¶é—´',
  is_active TINYINT(1) DEFAULT 1 COMMENT 'æ˜¯å¦ç”Ÿæ•ˆ',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_alert_type_active (alert_type, is_active),
  INDEX idx_expires_at (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å‘Šè­¦é™é»˜è§„åˆ™è¡¨';
```

---

### 13.2 Phase 2: æœåŠ¡å±‚å¼€å‘ï¼ˆ3å¤©ï¼‰

**æ­¥éª¤ 2.1**: å¾…åŠå¥åº·åº¦è¯„åˆ†æœåŠ¡ âœ…ã€å†³ç­– D-2 å·²ç¡®è®¤ã€‘

```javascript
// services/pending/PendingHealthScoreService.js
'use strict'

const { BusinessCacheHelper, KEY_PREFIX } = require('../../utils/BusinessCacheHelper')
const BeijingTimeHelper = require('../../utils/timeHelper')
const logger = require('../../utils/logger').logger
const PendingCenterService = require('./PendingCenterService')

/**
 * è¶…æ—¶é˜ˆå€¼é…ç½®ï¼ˆåˆ†é’Ÿï¼‰âœ…ã€å†³ç­– D-2 å·²ç¡®è®¤ã€‘
 * @constant
 */
const TIMEOUT_THRESHOLDS = {
  consumption: 24 * 60,        // æ¶ˆè´¹å®¡æ ¸: 24å°æ—¶ âœ…
  customer_service: 30,        // å®¢æœä¼šè¯: 30åˆ†é’Ÿ âœ…
  risk_alert: 60,              // é£æ§å‘Šè­¦: 1å°æ—¶ âœ…
  lottery_alert: 120           // æŠ½å¥–å‘Šè­¦: 2å°æ—¶ âœ…
}

/**
 * è¯„åˆ†æƒé‡é…ç½® âœ…ã€å†³ç­– D-2 å·²ç¡®è®¤ã€‘
 * @constant
 */
const SCORE_WEIGHTS = {
  timeout_ratio: 40,    // è¶…æ—¶æ¯”ä¾‹æƒé‡ âœ…
  backlog_count: 30,    // ç§¯å‹æ•°é‡æƒé‡ âœ…
  wait_time: 30         // ç­‰å¾…æ—¶é—´æƒé‡ âœ…
}

// âœ… å‘Šè­¦é˜ˆå€¼ã€å†³ç­– D-2 å·²ç¡®è®¤ã€‘
const ALERT_THRESHOLD = 60  // ä½äº60åˆ†è§¦å‘å‘Šè­¦

class PendingHealthScoreService {
  static CACHE_KEY = `${KEY_PREFIX}pending:health_score`
  static CACHE_TTL = 60  // 60ç§’

  /**
   * è·å–å¾…åŠå¥åº·åº¦è¯„åˆ†
   * @returns {Promise<Object>} å¥åº·åº¦è¯„åˆ†ç»“æœ
   */
  static async getHealthScore() {
    // 1. ç¼“å­˜æ£€æŸ¥
    const cached = await BusinessCacheHelper.get(this.CACHE_KEY)
    if (cached) {
      logger.debug('[å¾…åŠå¥åº·åº¦] å‘½ä¸­ç¼“å­˜')
      return cached
    }

    // 2. è·å–å¾…åŠç»Ÿè®¡
    const stats = await PendingCenterService.getSegmentStats()

    // 3. è®¡ç®—å„åˆ†ç±»è¯„åˆ†
    const scores = {
      consumption: this._calculateCategoryScore(stats.consumption),
      customer_service: this._calculateCategoryScore(stats.customer_service),
      risk_alerts: this._calculateCategoryScore(stats.risk_alerts),
      lottery_alerts: this._calculateCategoryScore(stats.lottery_alerts)
    }

    // 4. è®¡ç®—æ€»ä½“è¯„åˆ†ï¼ˆåŠ æƒå¹³å‡ï¼‰
    const totalScore = Math.round(
      (scores.consumption + scores.customer_service + 
       scores.risk_alerts + scores.lottery_alerts) / 4
    )

    // 5. ç¡®å®šå¥åº·ç­‰çº§
    const healthLevel = this._getHealthLevel(totalScore)

    const result = {
      total_score: totalScore,
      health_level: healthLevel,
      category_scores: scores,
      thresholds: TIMEOUT_THRESHOLDS,
      weights: SCORE_WEIGHTS,
      calculated_at: BeijingTimeHelper.apiTimestamp()
    }

    // 6. å†™å…¥ç¼“å­˜
    await BusinessCacheHelper.set(this.CACHE_KEY, result, this.CACHE_TTL)
    logger.info('[å¾…åŠå¥åº·åº¦] è¯„åˆ†è®¡ç®—å®Œæˆ', { total_score: totalScore, health_level: healthLevel })

    return result
  }

  /**
   * è®¡ç®—å•åˆ†ç±»è¯„åˆ†
   * @private
   */
  static _calculateCategoryScore(categoryStats) {
    let score = 100

    // ç»´åº¦1: è¶…æ—¶æ¯”ä¾‹æ‰£åˆ†
    const timeoutRatio = categoryStats.count > 0 
      ? categoryStats.urgent_count / categoryStats.count 
      : 0
    score -= timeoutRatio * SCORE_WEIGHTS.timeout_ratio

    // ç»´åº¦2: ç§¯å‹æ•°é‡æ‰£åˆ†ï¼ˆæ¯10ä¸ªæ‰£3åˆ†ï¼Œæœ€å¤š30åˆ†ï¼‰
    const backlogPenalty = Math.min(SCORE_WEIGHTS.backlog_count, categoryStats.count * 0.3)
    score -= backlogPenalty

    // ç»´åº¦3: æœ€é•¿ç­‰å¾…æ—¶é—´æ‰£åˆ†ï¼ˆæ¯å°æ—¶æ‰£5åˆ†ï¼Œæœ€å¤š30åˆ†ï¼‰
    const waitPenalty = Math.min(SCORE_WEIGHTS.wait_time, (categoryStats.oldest_minutes / 60) * 5)
    score -= waitPenalty

    return Math.max(0, Math.round(score))
  }

  /**
   * è·å–å¥åº·ç­‰çº§
   * @private
   */
  static _getHealthLevel(score) {
    if (score >= 80) return { level: 'healthy', label: 'å¥åº·', color: 'green' }
    if (score >= 60) return { level: 'warning', label: 'æ³¨æ„', color: 'yellow' }
    if (score >= 40) return { level: 'danger', label: 'å±é™©', color: 'orange' }
    return { level: 'critical', label: 'ç´§æ€¥', color: 'red' }
  }

  /**
   * æ‰‹åŠ¨å¤±æ•ˆç¼“å­˜
   */
  static async invalidateCache(reason = 'manual') {
    return await BusinessCacheHelper.del(this.CACHE_KEY, reason)
  }
}

module.exports = PendingHealthScoreService
```

**æ­¥éª¤ 2.2**: ä¸šåŠ¡å¥åº·åº¦è¯„åˆ†æœåŠ¡

```javascript
// services/dashboard/BusinessHealthScoreService.js
'use strict'

const { Op, fn, col } = require('sequelize')
const { BusinessCacheHelper, KEY_PREFIX } = require('../../utils/BusinessCacheHelper')
const BeijingTimeHelper = require('../../utils/timeHelper')
const logger = require('../../utils/logger').logger

/**
 * å¥åº·åº¦5ç»´åº¦é…ç½®
 * @constant
 */
const HEALTH_DIMENSIONS = {
  user_activity: { weight: 20, name: 'ç”¨æˆ·æ´»è·ƒåº¦' },
  lottery_health: { weight: 20, name: 'æŠ½å¥–å¥åº·åº¦' },
  budget_control: { weight: 20, name: 'é¢„ç®—æ§åˆ¶' },
  service_efficiency: { weight: 20, name: 'å®¢æœæ•ˆç‡' },
  debt_control: { weight: 20, name: 'å«ä»˜æ§åˆ¶' }
}

class BusinessHealthScoreService {
  static CACHE_KEY = `${KEY_PREFIX}dashboard:business_health`
  static CACHE_TTL = 120  // 2åˆ†é’Ÿ âœ…ã€å†³ç­– D-3 å·²ç¡®è®¤ï¼š2åˆ†é’Ÿç¼“å­˜ã€‘

  /**
   * è·å–ä¸šåŠ¡å¥åº·åº¦è¯„åˆ†ï¼ˆ5ç»´åº¦é›·è¾¾å›¾ï¼‰
   * âœ…ã€å†³ç­– D-2 å·²ç¡®è®¤ï¼š5ç»´åº¦å„20%æƒé‡ + 60åˆ†å‘Šè­¦é˜ˆå€¼ã€‘
   * @returns {Promise<Object>} å¥åº·åº¦è¯„åˆ†
   */
  static async getBusinessHealthScore() {
    const cached = await BusinessCacheHelper.get(this.CACHE_KEY)
    if (cached) return cached

    // å¹¶è¡Œè®¡ç®—5ä¸ªç»´åº¦
    const [userActivity, lotteryHealth, budgetControl, serviceEfficiency, debtControl] = 
      await Promise.all([
        this._calculateUserActivity(),
        this._calculateLotteryHealth(),
        this._calculateBudgetControl(),
        this._calculateServiceEfficiency(),
        this._calculateDebtControl()
      ])

    const dimensions = {
      user_activity: userActivity,
      lottery_health: lotteryHealth,
      budget_control: budgetControl,
      service_efficiency: serviceEfficiency,
      debt_control: debtControl
    }

    // è®¡ç®—æ€»åˆ†ï¼ˆåŠ æƒå¹³å‡ï¼‰
    const totalScore = Object.entries(dimensions).reduce((sum, [key, dim]) => {
      return sum + (dim.score * HEALTH_DIMENSIONS[key].weight / 100)
    }, 0)

    const result = {
      total_score: Math.round(totalScore),
      dimensions,
      radar_data: Object.entries(dimensions).map(([key, dim]) => ({
        dimension: HEALTH_DIMENSIONS[key].name,
        score: dim.score,
        max: 100
      })),
      calculated_at: BeijingTimeHelper.apiTimestamp()
    }

    await BusinessCacheHelper.set(this.CACHE_KEY, result, this.CACHE_TTL)
    logger.info('[ä¸šåŠ¡å¥åº·åº¦] è®¡ç®—å®Œæˆ', { total_score: result.total_score })

    return result
  }

  /**
   * è®¡ç®—ç”¨æˆ·æ´»è·ƒåº¦ï¼ˆDAU/MAUï¼‰
   * @private
   */
  static async _calculateUserActivity() {
    const { User } = require('../../models')
    const now = new Date()
    const today = new Date(now.setHours(0, 0, 0, 0))
    const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000)

    const [dau, mau] = await Promise.all([
      User.count({ where: { last_login: { [Op.gte]: today } } }),
      User.count({ where: { last_login: { [Op.gte]: monthAgo } } })
    ])

    const ratio = mau > 0 ? (dau / mau * 100) : 0
    // 30%ä»¥ä¸Šæ»¡åˆ†ï¼Œæ¯ä¸‹é™5%æ‰£10åˆ†
    const score = Math.max(0, 100 - Math.max(0, 30 - ratio) * 2)

    return { score: Math.round(score), dau, mau, ratio: ratio.toFixed(1) }
  }

  /**
   * è®¡ç®—æŠ½å¥–å¥åº·åº¦
   * @private
   */
  static async _calculateLotteryHealth() {
    const { LotteryDraw } = require('../../models')
    const today = new Date()
    today.setHours(0, 0, 0, 0)

    const [total, wins] = await Promise.all([
      LotteryDraw.count({ where: { created_at: { [Op.gte]: today } } }),
      LotteryDraw.count({ 
        where: { 
          created_at: { [Op.gte]: today },
          reward_tier: { [Op.in]: ['high', 'mid'] }
        } 
      })
    ])

    const actualRate = total > 0 ? (wins / total * 100) : 0
    const targetRate = 15  // ç›®æ ‡ä¸­å¥–ç‡15%
    const deviation = Math.abs(actualRate - targetRate)
    // è¯¯å·®5%ä»¥å†…æ»¡åˆ†ï¼Œæ¯è¶…1%æ‰£5åˆ†
    const score = Math.max(0, 100 - Math.max(0, deviation - 5) * 5)

    return { 
      score: Math.round(score), 
      actual_rate: actualRate.toFixed(1), 
      target_rate: targetRate,
      deviation: deviation.toFixed(1)
    }
  }

  /**
   * è®¡ç®—é¢„ç®—æ§åˆ¶åº¦
   * @private
   */
  static async _calculateBudgetControl() {
    // ç®€åŒ–å®ç°ï¼šä»ç³»ç»Ÿé…ç½®è·å–é¢„ç®—æ•°æ®
    // å®é™…åº”ä» lottery_campaigns + lottery_draws èšåˆ
    const score = 85  // TODO: å®é™…è®¡ç®—
    return { score, budget_usage_ratio: '85%' }
  }

  /**
   * è®¡ç®—å®¢æœæ•ˆç‡
   * @private
   */
  static async _calculateServiceEfficiency() {
    const { CustomerServiceSession } = require('../../models')
    const today = new Date()
    today.setHours(0, 0, 0, 0)

    // è®¡ç®—å¹³å‡å“åº”æ—¶é•¿
    const sessions = await CustomerServiceSession.findAll({
      where: {
        created_at: { [Op.gte]: today },
        first_response_at: { [Op.ne]: null }
      },
      attributes: ['created_at', 'first_response_at']
    })

    if (sessions.length === 0) {
      return { score: 100, avg_response_minutes: 0, session_count: 0 }
    }

    const totalResponseMinutes = sessions.reduce((sum, s) => {
      return sum + (new Date(s.first_response_at) - new Date(s.created_at)) / 60000
    }, 0)
    const avgResponse = totalResponseMinutes / sessions.length

    // 15åˆ†é’Ÿå†…æ»¡åˆ†ï¼Œæ¯è¶…5åˆ†é’Ÿæ‰£10åˆ†
    const score = Math.max(0, 100 - Math.max(0, avgResponse - 15) * 2)

    return { 
      score: Math.round(score), 
      avg_response_minutes: avgResponse.toFixed(1),
      session_count: sessions.length
    }
  }

  /**
   * è®¡ç®—å«ä»˜æ§åˆ¶åº¦
   * @private
   */
  static async _calculateDebtControl() {
    const { LotteryDraw } = require('../../models')
    const today = new Date()
    today.setHours(0, 0, 0, 0)

    const [total, debtCount] = await Promise.all([
      LotteryDraw.count({ where: { created_at: { [Op.gte]: today } } }),
      LotteryDraw.count({ 
        where: { 
          created_at: { [Op.gte]: today },
          has_debt: true
        } 
      })
    ])

    const debtRatio = total > 0 ? (debtCount / total * 100) : 0
    // 5%ä»¥å†…æ»¡åˆ†ï¼Œæ¯è¶…1%æ‰£10åˆ†
    const score = Math.max(0, 100 - Math.max(0, debtRatio - 5) * 10)

    return { 
      score: Math.round(score), 
      debt_ratio: debtRatio.toFixed(1),
      debt_count: debtCount,
      total_draws: total
    }
  }
}

module.exports = BusinessHealthScoreService
```

---

### 13.3 Phase 3: è·¯ç”±å±‚å¼€å‘ï¼ˆ1å¤©ï¼‰

**æ­¥éª¤ 3.1**: æ‰©å±• pending.js è·¯ç”±ï¼ˆç¬¦åˆ TR-005 è§„èŒƒï¼‰

```javascript
// routes/v4/console/pending.js æ–°å¢ç«¯ç‚¹
// âš ï¸ æ³¨æ„ï¼šæœåŠ¡é€šè¿‡ ServiceManager è·å–ï¼Œä¸ç›´æ¥ require

'use strict'

const express = require('express')
const router = express.Router()
const { authenticateToken, requireRoleLevel } = require('../../../middleware/auth')
const { handleServiceError } = require('../../../middleware/validation')
const logger = require('../../../utils/logger').logger

/**
 * @route GET /api/v4/console/pending/health-score
 * @desc è·å–å¾…åŠå¥åº·åº¦è¯„åˆ†
 * @access Private (ç®¡ç†å‘˜ï¼Œrole_level >= 100)
 */
router.get('/health-score', authenticateToken, requireRoleLevel(100), async (req, res) => {
  try {
    logger.info('[å¾…åŠå¥åº·åº¦] è·å–è¯„åˆ†', { admin_id: req.user.user_id })

    // ğŸ”„ é€šè¿‡ ServiceManager è·å–æœåŠ¡ï¼ˆç¬¦åˆTR-005è§„èŒƒï¼‰
    const PendingHealthScoreService = req.app.locals.services.getService('pending_health_score')
    const result = await PendingHealthScoreService.getHealthScore()

    return res.apiSuccess(result, 'è·å–å¾…åŠå¥åº·åº¦æˆåŠŸ')
  } catch (error) {
    logger.error('[å¾…åŠå¥åº·åº¦] è·å–å¤±è´¥', { error: error.message })
    return handleServiceError(error, res, 'è·å–å¾…åŠå¥åº·åº¦å¤±è´¥')
  }
})
```

**æ­¥éª¤ 3.2**: æ‰©å±• dashboard.js è·¯ç”±ï¼ˆç¬¦åˆ TR-005 è§„èŒƒï¼‰

```javascript
// routes/v4/console/dashboard.js æ–°å¢ç«¯ç‚¹
// âš ï¸ æ³¨æ„ï¼šæœåŠ¡é€šè¿‡ ServiceManager è·å–ï¼Œä¸ç›´æ¥ require

/**
 * @route GET /api/v4/console/dashboard/business-health
 * @desc è·å–ä¸šåŠ¡å¥åº·åº¦è¯„åˆ†ï¼ˆ5ç»´åº¦é›·è¾¾å›¾ï¼‰
 * @access Private (ç®¡ç†å‘˜ï¼Œrole_level >= 100)
 */
router.get('/business-health', authenticateToken, requireRoleLevel(100), async (req, res) => {
  try {
    logger.info('[ä¸šåŠ¡å¥åº·åº¦] è·å–è¯„åˆ†', { admin_id: req.user.user_id })

    // ğŸ”„ é€šè¿‡ ServiceManager è·å–æœåŠ¡ï¼ˆç¬¦åˆTR-005è§„èŒƒï¼‰
    const BusinessHealthScoreService = req.app.locals.services.getService('business_health_score')
    const result = await BusinessHealthScoreService.getBusinessHealthScore()

    return res.apiSuccess(result, 'è·å–ä¸šåŠ¡å¥åº·åº¦æˆåŠŸ')
  } catch (error) {
    logger.error('[ä¸šåŠ¡å¥åº·åº¦] è·å–å¤±è´¥', { error: error.message })
    return handleServiceError(error, res, 'è·å–ä¸šåŠ¡å¥åº·åº¦å¤±è´¥')
  }
})

/**
 * @route GET /api/v4/console/dashboard/time-comparison
 * @desc è·å–æ—¶é—´å¯¹æ¯”æ•°æ®ï¼ˆç¯æ¯”/åŒæ¯”ï¼‰
 * @access Private (ç®¡ç†å‘˜ï¼Œrole_level >= 100)
 * âœ…ã€å†³ç­– D-4 å·²ç¡®è®¤ï¼šæ—¥ç¯æ¯”é»˜è®¤ + 10ä¸ªæ ¸å¿ƒæŒ‡æ ‡ã€‘
 */
router.get('/time-comparison', authenticateToken, requireRoleLevel(100), async (req, res) => {
  try {
    // âœ… é»˜è®¤æ—¥ç¯æ¯”ï¼ˆday_on_dayï¼‰ï¼Œæ”¯æŒ10ä¸ªæ ¸å¿ƒæŒ‡æ ‡
    const { metrics, compare_type = 'day_on_day', date } = req.query

    logger.info('[æ—¶é—´å¯¹æ¯”] è·å–æ•°æ®', { 
      admin_id: req.user.user_id,
      compare_type,
      metrics 
    })

    // ğŸ”„ å¤ç”¨ MultiDimensionStatsServiceï¼ˆç¬¦åˆå†³ç­–D-4ï¼Œé¿å…æ–°å»ºæœåŠ¡ï¼‰
    const MultiDimensionStatsService = req.app.locals.services.getService('multi_dimension_stats')
    const result = await MultiDimensionStatsService.getTimeComparison({
      metrics: metrics ? metrics.split(',') : ['dau', 'draw_count'],
      compare_type,
      date
    })

    return res.apiSuccess(result, 'è·å–æ—¶é—´å¯¹æ¯”æˆåŠŸ')
  } catch (error) {
    logger.error('[æ—¶é—´å¯¹æ¯”] è·å–å¤±è´¥', { error: error.message })
    return handleServiceError(error, res, 'è·å–æ—¶é—´å¯¹æ¯”å¤±è´¥')
  }
})
```

---

### 13.4 Phase 4: æµ‹è¯•ä¸è”è°ƒï¼ˆ1å¤©ï¼‰

```javascript
// tests/console/pending-health-score.test.js
const request = require('supertest')
const app = require('../../app')

describe('å¾…åŠå¥åº·åº¦è¯„åˆ† API', () => {
  it('GET /api/v4/console/pending/health-score è¿”å›å¥åº·åº¦', async () => {
    const res = await request(app)
      .get('/api/v4/console/pending/health-score')
      .set('Authorization', `Bearer ${adminToken}`)
    
    expect(res.status).toBe(200)
    expect(res.body.success).toBe(true)
    expect(res.body.data).toHaveProperty('total_score')
    expect(res.body.data).toHaveProperty('health_level')
    expect(res.body.data).toHaveProperty('category_scores')
  })
})
```

---

### 13.5 æŠ€æœ¯è§„èŒƒï¼ˆå¼ºåˆ¶éµå¾ªï¼‰

#### è·¯ç”±å±‚è§„èŒƒ
```javascript
// routes/v4/console/xxx.js
const express = require('express')
const router = express.Router()
const { authenticateToken, requireRoleLevel } = require('../../../middleware/auth')
const XxxService = require('../../../services/xxx/XxxService')
const logger = require('../../../utils/logger').logger

// æƒé™ï¼šä»…é™ adminï¼ˆrole_level >= 100ï¼‰
router.get('/', authenticateToken, requireRoleLevel(100), async (req, res) => {
  try {
    const result = await XxxService.getData(req.query)
    return res.apiSuccess(result, 'è·å–æˆåŠŸ')
  } catch (error) {
    logger.error('XxxService.getData å¤±è´¥', { error: error.message })
    return res.apiError(error.message, 'XXX_ERROR', null, 500)
  }
})

module.exports = router
```

#### æœåŠ¡å±‚è§„èŒƒ
```javascript
// services/xxx/XxxService.js
'use strict'

const { Op, fn, col } = require('sequelize')
const { BusinessCacheHelper, KEY_PREFIX, DEFAULT_TTL } = require('../../utils/BusinessCacheHelper')
const BeijingTimeHelper = require('../../utils/timeHelper')
const logger = require('../../utils/logger').logger

class XxxService {
  static CACHE_KEY = `${KEY_PREFIX}xxx:data`
  static CACHE_TTL = DEFAULT_TTL.STATS  // 180ç§’

  static async getData(options = {}) {
    // 1. ç¼“å­˜æ£€æŸ¥
    const cached = await BusinessCacheHelper.get(this.CACHE_KEY)
    if (cached) {
      logger.debug('[XxxService] å‘½ä¸­ç¼“å­˜')
      return cached
    }

    // 2. æ•°æ®åº“æŸ¥è¯¢ï¼ˆä½¿ç”¨ Sequelize ORMï¼‰
    const { Model } = require('../../models')
    const result = await Model.findAll({
      where: { status: 'active' },
      attributes: ['id', 'name', [fn('COUNT', col('id')), 'count']],
      group: ['status'],
      raw: true
    })

    // 3. æ•°æ®å¤„ç†
    const processed = {
      items: result,
      total: result.length,
      timestamp: BeijingTimeHelper.apiTimestamp()
    }

    // 4. å†™å…¥ç¼“å­˜
    await BusinessCacheHelper.set(this.CACHE_KEY, processed, this.CACHE_TTL)
    logger.info('[XxxService] æ•°æ®æŸ¥è¯¢å®Œæˆ', { count: result.length })

    return processed
  }

  static async invalidateCache(reason = 'manual') {
    return await BusinessCacheHelper.del(this.CACHE_KEY, reason)
  }
}

module.exports = XxxService
```

#### å“åº”æ ¼å¼è§„èŒƒ
```javascript
// æˆåŠŸå“åº”
res.apiSuccess(data, message)
// â†’ { success: true, code: 'SUCCESS', message, data, timestamp, version: 'v4.0' }

// é”™è¯¯å“åº”
res.apiError(message, code, details, httpStatus)
// â†’ { success: false, code, message, data: details, timestamp, version: 'v4.0' }
```

---

**æ–‡æ¡£ç»“æŸ**

