# è‡»é€‰ç©ºé—´ Â· å¹¸è¿ç©ºé—´ Â· ç«ä»·åŠŸèƒ½ â€” åç«¯å®æ–½æ–¹æ¡ˆ

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **æ–‡æ¡£æ€§è´¨** | åç«¯å®æ–½æ–¹æ¡ˆï¼ˆåŸºäºçœŸå®æ•°æ®åº“å’Œä»£ç åˆ†æï¼‰ |
| **åˆ›å»ºæ—¥æœŸ** | 2026-02-15 |
| **æŠ€æœ¯æ ˆ** | Node.js 20+ / Express 4.18 / Sequelize 6.35 / MySQL / Redis (ioredis) |
| **APIç‰ˆæœ¬** | V4 â€” `/api/v4/{domain}/{resource}` |
| **å“åº”æ ¼å¼** | `ApiResponse.middleware()` â†’ `res.apiSuccess()` / `res.apiError()` |
| **äº‹åŠ¡ç®¡ç†** | `TransactionManager.execute(async (t) => {...})` |
| **æœåŠ¡æ³¨å…¥** | `req.app.locals.services.getService('service_key')` |

---

## 0. å·²ç¡®è®¤çš„å…³é”®å†³ç­–ï¼ˆäº§å“æ‹æ¿ï¼‰

> ä»¥ä¸‹ 16 é¡¹å†³ç­–å·²ç”±äº§å“/è´Ÿè´£äººç¡®è®¤ï¼Œåç»­å®æ–½ä¸¥æ ¼éµç…§æ‰§è¡Œã€‚

### ğŸ”´ å†³ç­–1ï¼šç«ä»·å¯ç”¨èµ„äº§èŒƒå›´

**ç»“è®ºï¼šç¦æ­¢ `POINTS`ï¼ˆå¯ç”¨ç§¯åˆ†ï¼‰å’Œ `BUDGET_POINTS`ï¼ˆé¢„ç®—ç§¯åˆ†ï¼‰ç”¨äºç«ä»·å‡ºä»·ã€‚**

- å¯ç”¨äºç«ä»·çš„èµ„äº§ï¼šä» `material_asset_types` åŠ¨æ€æŸ¥è¯¢ï¼ˆ`is_tradable = 1 AND asset_code NOT IN ('POINTS', 'BUDGET_POINTS')`ï¼‰ï¼Œå½“å‰åŒ…æ‹¬ `DIAMOND`ï¼ˆé’»çŸ³ï¼‰ã€`red_shard`ï¼ˆçº¢è‰²ç¢ç‰‡ï¼‰ï¼Œæœªæ¥æ–°å¢èµ„äº§è‡ªåŠ¨çº³å…¥ï¼ˆè§å†³ç­–9ï¼‰ã€‚
- `BUDGET_POINTS` å±äºç³»ç»Ÿå†…éƒ¨èµ„äº§ï¼Œ**ç»å¯¹ç¦æ­¢**å°†å…¶å­—æ®µä¿¡æ¯å‘é€åˆ°å¾®ä¿¡å°ç¨‹åºå‰ç«¯ï¼ˆåŒ…æ‹¬ API å“åº”ã€WebSocket æ¨é€ç­‰ä»»ä½•å‡ºå£ï¼‰ã€‚
- å®æ–½è¦æ±‚ï¼š
  - `BidService.placeBid()` ä¸­å¢åŠ  `price_asset_code` åŠ¨æ€ç™½åå•æ ¡éªŒï¼ˆä» `material_asset_types` æŸ¥è¯¢ + ç¼“å­˜ 5 åˆ†é’Ÿï¼‰ï¼Œæ‹’ç» `POINTS` å’Œ `BUDGET_POINTS`ï¼ˆç¡¬ç¼–ç é»‘åå•ï¼‰ã€‚
  - `bid_products.price_asset_code` å»ºè¡¨æ—¶ DEFAULT æ”¹ä¸º `'DIAMOND'`ï¼ˆè€Œé `'POINTS'`ï¼‰ã€‚
  - `DataSanitizer` ä¸­å°† `BUDGET_POINTS` åŠ å…¥å…¨å±€æ•æ„Ÿå­—æ®µé»‘åå•ï¼Œæ‰€æœ‰é¢å‘å‰ç«¯çš„ API å“åº”è‡ªåŠ¨è¿‡æ»¤ã€‚
  - å‰ç«¯èµ„äº§é€‰æ‹©å™¨ä»…å±•ç¤ºç™½åå•å†…çš„èµ„äº§ç±»å‹ã€‚

### ğŸ”´ å†³ç­–2ï¼šé«˜çº§ç©ºé—´ï¼ˆè‡»é€‰ç©ºé—´ï¼‰è·¯ç”±è¿ç§»åˆ°å…‘æ¢åŸŸ

**ç»“è®ºï¼šé€‰é¡¹ A â€” è¿ç§»åˆ° `/api/v4/backpack/exchange/premium-status` å’Œ `/unlock-premium`ï¼Œä¸å…‘æ¢åŸŸç»Ÿä¸€ã€‚**

- åŸè·¯ç”± `/api/v4/shop/premium/unlock` å’Œ `/status` åºŸå¼ƒã€‚
- é¡¹ç›®æœªä¸Šçº¿ï¼Œä¸éœ€è¦æ—§è·¯ç”±å…¼å®¹ï¼Œç›´æ¥åˆ é™¤æ—§è·¯ç”±æ–‡ä»¶ã€‚
- æ–°è·¯ç”±ç»Ÿä¸€æŒ‚åœ¨ `routes/v4/backpack/exchange.js` ä¸­ï¼Œä¸å…‘æ¢åŸŸåœ¨åŒä¸€è·¯ç”±æ–‡ä»¶å†…ã€‚

### ğŸ”´ å†³ç­–3ï¼šé«˜çº§ç©ºé—´ä¸šåŠ¡å‚æ•°ä»¥åç«¯ç°æœ‰å€¼ä¸ºå‡†

**ç»“è®ºï¼šé€‰é¡¹ A â€” ä»¥åç«¯ç°æœ‰å€¼ä¸ºå‡†ï¼Œå‰ç«¯é€‚é…ã€‚**

| å‚æ•° | æœ€ç»ˆç¡®è®¤å€¼ | å‰ç«¯æ–‡æ¡£åŸå€¼ï¼ˆéœ€é€‚é…ï¼‰ |
|------|-----------|---------------------|
| è§£é”è´¹ç”¨ | **100 POINTS** | ~~1000ç§¯åˆ†~~ |
| æœ‰æ•ˆæ—¶é•¿ | **24 å°æ—¶** | ~~48å°æ—¶~~ |
| å†å²ç§¯åˆ†é—¨æ§› | **100,000** | ~~10,000~~ |

- `PremiumService` ä¸­çš„ `UNLOCK_COST`ã€`VALIDITY_HOURS`ã€`HISTORY_POINTS_THRESHOLD` å¸¸é‡ä¿æŒä¸å˜ã€‚
- å‰ç«¯éœ€æ ¹æ® `GET /premium-status` æ¥å£è¿”å›çš„å®é™…å€¼åŠ¨æ€æ¸²æŸ“ï¼Œä¸å¾—ç¡¬ç¼–ç ã€‚

### ğŸ”´ å†³ç­–4ï¼šç°æœ‰ 77 æ¡å•†å“å…¨éƒ¨é»˜è®¤å½’å…¥å¹¸è¿ç©ºé—´

**ç»“è®ºï¼šé€‰é¡¹ A â€” å…¨éƒ¨é»˜è®¤è®¾ä¸º `lucky`ï¼ˆå¹¸è¿ç©ºé—´ï¼‰ï¼Œè‡»é€‰ç©ºé—´çš„å•†å“åç»­ç”±è¿è¥æ‰‹åŠ¨é…ç½®ã€‚**

- è¿ç§»è„šæœ¬ä¸­ `space` å­—æ®µ DEFAULT `'lucky'`ï¼Œå­˜é‡ 77 æ¡å•†å“è‡ªåŠ¨å½’å…¥å¹¸è¿ç©ºé—´ã€‚
- è‡»é€‰ç©ºé—´åˆå§‹ä¸ºç©ºï¼Œè¿è¥é€šè¿‡ç®¡ç†åå°æ‰‹åŠ¨å°†å•†å“ `space` è®¾ä¸º `premium` æˆ– `both`ã€‚
- ä¸åšè‡ªåŠ¨åˆ†é…ç®—æ³•ï¼Œä¿æŒè¿è¥çµæ´»æ€§ã€‚

### ğŸ”´ å†³ç­–5ï¼šç«ä»·ç»“ç®—åå•†å“æ”¾å…¥ä¸­æ ‡ç”¨æˆ·èƒŒåŒ…

**ç»“è®ºï¼šä¸­æ ‡è€…ç«ä»·æˆåŠŸåï¼Œå•†å“æ”¾å…¥å¯¹åº”ç”¨æˆ·çš„èƒŒåŒ…ä»“åº“ä¸­ã€‚**

- ç»“ç®—æµç¨‹ï¼š
  1. ä¸­æ ‡è€…å†»ç»“èµ„äº§æ­£å¼æ‰£é™¤ï¼ˆ`BalanceService.settleFromFrozen()`ï¼‰ã€‚
  2. è½é€‰è€…å†»ç»“èµ„äº§å…¨éƒ¨è§£å†»è¿”è¿˜ï¼ˆ`BalanceService.unfreeze()`ï¼‰ã€‚
  3. ä¸ºä¸­æ ‡è€…åˆ›å»º `ExchangeRecord`ï¼ˆstatus = `completed`ï¼Œ`source = 'bid'`ï¼Œå†³ç­–10ï¼‰ã€‚
  4. ä¸ºä¸­æ ‡è€…åˆ›å»º `ItemInstance`ï¼ˆ`item_type = 'product'`ï¼Œ`meta` JSON å­˜å•†å“å¿«ç…§ï¼Œå†³ç­–7ï¼‰ï¼Œå•†å“è¿›å…¥ç”¨æˆ·èƒŒåŒ…ã€‚
  5. æ›´æ–° `bid_products.status = 'settled'`ã€‚
  6. é€šçŸ¥ä¸­æ ‡è€…å’Œè½é€‰è€…ï¼ˆå†³ç­–8ï¼‰ã€‚
- èƒŒåŒ…å…¥å£ï¼šç”¨æˆ·é€šè¿‡ç°æœ‰çš„èƒŒåŒ…æŸ¥è¯¢æ¥å£å¯æŸ¥çœ‹ç«æ‹è·å¾—çš„ç‰©å“ã€‚

### ğŸ”´ å†³ç­–6ï¼šç«ä»·å®šæ—¶ä»»åŠ¡æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡

**ç»“è®ºï¼šé€‰é¡¹ A â€” æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼ˆç»“æŸæ—¶é—´ç²¾åº¦ Â±1 åˆ†é’Ÿï¼Œç®€å•å¯é ï¼‰ã€‚**

- ä½¿ç”¨ `node-cron` çš„ `'* * * * *'` è¡¨è¾¾å¼ï¼Œæ¯åˆ†é’Ÿæ‰§è¡Œã€‚
- æŸ¥è¯¢æ¡ä»¶ï¼š`status = 'active' AND end_time <= NOW()`ã€‚
- æ¯æ¬¡æœ€å¤šå¤„ç† 10 æ¡åˆ°æœŸç«ä»·ï¼ˆé˜²æ­¢å•æ¬¡ä»»åŠ¡è¿‡é‡ï¼‰ã€‚
- ç»“ç®—å¤±è´¥çš„ç«ä»·æ ‡è®°ä¸º `settlement_failed`ï¼Œä¸é˜»å¡å…¶ä»–ç«ä»·ç»“ç®—ï¼Œåç»­äººå·¥å¤„ç†ã€‚

### ğŸ”´ å†³ç­–7ï¼šç«ä»·ä¸­æ ‡åå•†å“ä»¥ meta å¿«ç…§æ–¹å¼è¿›èƒŒåŒ…

**ç»“è®ºï¼šé€‰é¡¹ B â€” ç›´æ¥åœ¨ `item_instances` ä¸­åˆ›å»ºè®°å½•ï¼Œ`item_type = 'product'`ï¼Œç”¨ `meta` JSON å­—æ®µå­˜å•†å“å¿«ç…§ã€‚**

- å®é™…æ•°æ®æ”¯æ’‘ï¼šç°æœ‰ 1494 æ¡ `product` ç±»å‹çš„ `item_instances`ï¼Œ**å…¨éƒ¨** `item_template_id = NULL`ï¼Œå·²ç»æ˜¯ç”¨ `meta` JSON å­˜å¿«ç…§çš„æ¨¡å¼ã€‚
- `exchange_items` è¡¨æ²¡æœ‰ `item_template_id` å­—æ®µï¼Œä¸éœ€è¦æ–°å¢ã€‚
- ç»“ç®—æ—¶ `ItemInstance.create()` çš„ `meta` å­—æ®µå­˜å…¥å•†å“å¿«ç…§ï¼š
  ```json
  {
    "source": "bid_settlement",
    "bid_product_id": 123,
    "exchange_item_id": 42,
    "item_name": "Apple AirPods Pro 2",
    "description": "ä¸»åŠ¨é™å™ª",
    "primary_image_id": 56,
    "category": "å®ç‰©å•†å“",
    "original_cost_asset_code": "red_shard",
    "original_cost_amount": 800,
    "bid_winning_amount": 2400,
    "bid_asset_code": "DIAMOND",
    "settled_at": "2026-02-15 20:01:00"
  }
  ```
- ä¸ç°æœ‰èƒŒåŒ…ç³»ç»Ÿå®Œå…¨ä¸€è‡´ï¼Œæ— éœ€æ”¹é€ èƒŒåŒ…æŸ¥è¯¢é€»è¾‘ã€‚

### ğŸ”´ å†³ç­–8ï¼šç«ä»·é€šçŸ¥æ¨é€åˆ°å…¬å‘Šï¼ŒPhase 2 ä¸€èµ·åš

**ç»“è®ºï¼šé€‰é¡¹ A â€” éœ€è¦æ¨é€ï¼ŒPhase 2 ä¸€èµ·åšã€‚æ¨é€åˆ°å…¬å‘Šç³»ç»Ÿã€‚**

- æ¨é€åœºæ™¯ï¼š
  1. **å‡ºä»·è¢«è¶…è¿‡**ï¼šé€šçŸ¥å‰æœ€é«˜å‡ºä»·è€…"æ‚¨åœ¨ XXX ç«ä»·ä¸­çš„å‡ºä»·å·²è¢«è¶…è¿‡ï¼Œå½“å‰æœ€é«˜ä»· XXX"ã€‚
  2. **ç«ä»·ç»“æŸ â€” ä¸­æ ‡**ï¼šé€šçŸ¥ä¸­æ ‡è€…"æ­å–œï¼æ‚¨ä»¥ XXX çš„ä»·æ ¼æˆåŠŸç«å¾— XXXï¼Œå•†å“å·²æ”¾å…¥èƒŒåŒ…"ã€‚
  3. **ç«ä»·ç»“æŸ â€” è½é€‰**ï¼šé€šçŸ¥è½é€‰è€…"XXX ç«ä»·å·²ç»“æŸï¼Œæ‚¨çš„å†»ç»“èµ„äº§å·²å…¨éƒ¨è¿”è¿˜"ã€‚
- æ¨é€æ¸ é“ï¼šé€šè¿‡ç°æœ‰ `NotificationService` æ¨é€åˆ°**å…¬å‘Š/é€šçŸ¥ä¸­å¿ƒ**ã€‚
- å®æ–½è¦æ±‚ï¼š
  - `BidService.placeBid()` ä¸­å‡ºä»·æˆåŠŸåï¼Œè°ƒç”¨ `NotificationService` é€šçŸ¥å‰æœ€é«˜å‡ºä»·è€…ã€‚
  - `BidService.settleBidProduct()` ç»“ç®—å®Œæˆåï¼Œåˆ†åˆ«é€šçŸ¥ä¸­æ ‡è€…å’Œæ‰€æœ‰è½é€‰è€…ã€‚
  - é€šçŸ¥ç±»å‹æ–°å¢ï¼š`bid_outbid`ï¼ˆè¢«è¶…ä»·ï¼‰ã€`bid_won`ï¼ˆä¸­æ ‡ï¼‰ã€`bid_lost`ï¼ˆè½é€‰ï¼‰ã€‚

### ğŸ”´ å†³ç­–9ï¼šç«ä»·èµ„äº§ç™½åå•æ”¹ä¸ºåŠ¨æ€æŸ¥è¯¢

**ç»“è®ºï¼šé€‰é¡¹ A â€” ç™½åå•ä» `material_asset_types` åŠ¨æ€åŠ è½½ï¼Œä¸ç¡¬ç¼–ç ã€‚**

- ç™½åå•æŸ¥è¯¢é€»è¾‘ï¼š
  ```sql
  SELECT asset_code FROM material_asset_types
  WHERE is_tradable = 1 AND asset_code NOT IN ('POINTS', 'BUDGET_POINTS')
  ```
- `MATERIAL_001` æš‚ä¸çº³å…¥ç™½åå•ï¼ˆ`material_asset_types` ä¸­æ— è®°å½•ï¼‰ï¼Œæœªæ¥æ–°å¢èµ„äº§åªéœ€åœ¨ `material_asset_types` ä¸­é…ç½® `is_tradable = 1` å³å¯è‡ªåŠ¨çº³å…¥ã€‚
- é»‘åå• `['POINTS', 'BUDGET_POINTS']` ä»ç„¶ç¡¬ç¼–ç ï¼ˆç»å¯¹ç¦æ­¢ï¼Œä¸ä¾èµ–æ•°æ®åº“é…ç½®ï¼‰ã€‚
- ç™½åå•ç»“æœç¼“å­˜ 5 åˆ†é’Ÿï¼ˆRedis æˆ–å†…å­˜ï¼‰ï¼Œé¿å…æ¯æ¬¡å‡ºä»·éƒ½æŸ¥åº“ã€‚
- å®æ–½è¦æ±‚ï¼š
  - `BidService` ä¸­åˆ é™¤ç¡¬ç¼–ç çš„ `BID_ALLOWED_ASSETS` å¸¸é‡ã€‚
  - æ–°å¢ `BidService._getAllowedBidAssets()` æ–¹æ³•ï¼Œä» `material_asset_types` åŠ¨æ€æŸ¥è¯¢ã€‚
  - ä¿ç•™ç¡¬ç¼–ç çš„ `BID_FORBIDDEN_ASSETS = ['POINTS', 'BUDGET_POINTS']`ã€‚

### ğŸ”´ å†³ç­–10ï¼šexchange_records å’Œ item_instances æ–°å¢ source å­—æ®µ

**ç»“è®ºï¼šé€‰é¡¹ A â€” æ–°å¢ `source` å­—æ®µï¼Œè¿ç§»æ–‡ä»¶ä¸€èµ·æã€‚**

- `exchange_records` æ–°å¢ï¼š`source VARCHAR(20) NOT NULL DEFAULT 'exchange'`
  - å–å€¼ï¼š`'exchange'`ï¼ˆæ™®é€šå…‘æ¢ï¼‰ã€`'bid'`ï¼ˆç«ä»·ä¸­æ ‡ï¼‰
- `item_instances` æ–°å¢ï¼š`source VARCHAR(20) DEFAULT NULL`
  - å–å€¼ï¼š`NULL`ï¼ˆå†å²æ•°æ®ï¼‰ã€`'exchange'`ã€`'bid_settlement'`ã€`'lottery'` ç­‰
- å­˜é‡æ•°æ®å›å¡«ï¼š
  - `exchange_records`ï¼šå…¨éƒ¨ 0 æ¡ï¼Œæ— éœ€å›å¡«ã€‚
  - `item_instances`ï¼šå­˜é‡è®°å½• `source` ä¿æŒ `NULL`ï¼Œä¸åšå›å¡«ï¼ˆå†å²æ•°æ®æ— æ³•ç¡®å®šæ¥æºï¼‰ã€‚
- æ–°å¢è¿ç§»æ–‡ä»¶ï¼š`migrations/YYYYMMDDHHMMSS-add-source-to-exchange-records-and-item-instances.js`
- ç´¢å¼•ï¼š`exchange_records` ä¸Šæ–°å¢ `idx_source` â†’ `(source)` ä¾¿äºæŒ‰æ¥æºç»Ÿè®¡ã€‚

### ğŸ”´ å†³ç­–11ï¼šåŒä¸€å•†å“åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªæ´»è·ƒç«ä»·ï¼ˆä¸€ç‰©ä¸€æ‹ï¼‰+ batch_no æ‰©å±•

**ç»“è®ºï¼šé€‰é¡¹ A â€” ä¸€ç‰©ä¸€æ‹ã€‚åŒä¸€ `exchange_item_id` åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ª `active` æˆ– `pending` çŠ¶æ€çš„ç«ä»·ã€‚**

- è¡Œä¸šåˆ†æç»“è®ºï¼š
  - **å¤§å‚ï¼ˆeBay/é—²é±¼/è½¬è½¬ï¼‰**ï¼šä¸€ç‰©ä¸€æ‹ï¼Œä¸€ä¸ª listing å¯¹åº”ä¸€åœºæ‹å–ã€‚
  - **æ¸¸æˆå…¬å¸ï¼ˆæš´é›ª/ç½‘æ˜“/Steamï¼‰**ï¼šä¸€ç‰©ä¸€æ‹ï¼Œæ‹å–è¡Œä¸­ä¸€ä¸ªç‰©å“ä¸€ä¸ªæ‹å–æ§½ã€‚
  - **æ´»åŠ¨ç­–åˆ’**ï¼šä¸€ç‰©ä¸€æ‹ï¼Œæ¯è½®ç«æ‹ç‹¬ç«‹ã€‚
  - é€‚åˆæœ¬é¡¹ç›®ï¼šå•†å“æ˜¯å…·ä½“çš„ã€æœ‰é™çš„ï¼Œç«ä»·ç›®çš„æ˜¯äº‰å¤ºå”¯ä¸€å•†å“ï¼Œè¿è¥æ§åˆ¶èŠ‚å¥ã€‚
- ä»£ç å±‚æ ¡éªŒï¼š`BidService` åˆ›å»ºç«ä»·æ—¶æ£€æŸ¥ï¼š
  ```sql
  SELECT COUNT(*) FROM bid_products
  WHERE exchange_item_id = ? AND status IN ('pending', 'active')
  ```
  å¦‚æœ > 0ï¼Œè¿”å› `BID_ALREADY_EXISTS` é”™è¯¯ã€‚
- æ‰¹æ¬¡ç«ä»·æ‰©å±•é¢„ç•™ï¼š`bid_products` è¡¨æ–°å¢ `batch_no VARCHAR(50) DEFAULT NULL` å­—æ®µã€‚
  - å½“å‰ä¸å¼ºåˆ¶ä½¿ç”¨ï¼ŒDEFAULT NULLã€‚
  - æœªæ¥å¦‚éœ€"åŒä¸€å•†å“å¤šæ‰¹æ¬¡ç«ä»·"ï¼ˆå¦‚æ¯å‘¨ä¸€è½®ï¼‰ï¼Œè¿è¥å¯å¡«å†™ `batch_no` åŒºåˆ†æ‰¹æ¬¡ã€‚
  - ç´¢å¼•ï¼š`idx_item_batch` â†’ `(exchange_item_id, batch_no)` ä¾¿äºæŒ‰æ‰¹æ¬¡æŸ¥è¯¢ã€‚
- æ–°å¢é”™è¯¯ç ï¼š`BID_ALREADY_EXISTS`ï¼ˆHTTP 409ï¼‰â€” "è¯¥å•†å“å·²æœ‰è¿›è¡Œä¸­çš„ç«ä»·"ã€‚

### ğŸ”´ å†³ç­–12ï¼šexchange_items å±•ç¤ºå­—æ®µç²¾ç®€ï¼ˆç  4 ç•™ 9ï¼‰

**ç»“è®ºï¼šç æ‰ `discount`ã€`rating`ã€`sales`ã€`seller_info` 4 ä¸ªå­—æ®µï¼Œä¿ç•™ 9 ä¸ªæ–°å­—æ®µã€‚**

- **ç æ‰ç†ç”±ï¼š**
  - `discount`ï¼šå†—ä½™è®¡ç®—å­—æ®µï¼Œå‰ç«¯å¯è‡ªè¡Œè®¡ç®— `(original_price - cost_amount) / original_price`ï¼Œæ— éœ€åç«¯å­˜å‚¨ã€‚
  - `rating`ï¼šé¡¹ç›®æ— è¯„ä»·ç³»ç»Ÿï¼Œè¿è¥æ‰‹å¡«è¯„åˆ†æ— æ„ä¹‰ï¼Œæœªæ¥æœ‰è¯„ä»·ç³»ç»Ÿå†åŠ ã€‚
  - `sales`ï¼šä¸å·²æœ‰ `sold_count` å®Œå…¨é‡å¤ï¼Œç›´æ¥å¤ç”¨ `sold_count` å³å¯ã€‚
  - `seller_info`ï¼šé¡¹ç›®æ˜¯è‡ªè¥å•†åŸï¼Œéå¤šå•†å®¶å…¥é©»å¹³å°ï¼Œå•†å®¶ä¿¡æ¯å­—æ®µå®Œå…¨ç”¨ä¸åˆ°ã€‚
- **ä¿ç•™ 9 ä¸ªå­—æ®µï¼š** `space`ï¼ˆæ ¸å¿ƒï¼‰ã€`original_price`ï¼ˆåˆ’çº¿ä»·ï¼‰ã€`tags`ï¼ˆJSONæ ‡ç­¾ï¼‰ã€`is_new`ï¼ˆæ–°å“è§’æ ‡ï¼‰ã€`is_hot`ï¼ˆçƒ­é—¨è§’æ ‡ï¼‰ã€`is_lucky`ï¼ˆå¹¸è¿æ ‡è®°ï¼‰ã€`has_warranty`ï¼ˆè´¨ä¿ï¼‰ã€`free_shipping`ï¼ˆåŒ…é‚®ï¼‰ã€`sell_point`ï¼ˆå–ç‚¹æ–‡æ¡ˆï¼‰ã€‚
- è¡Œä¸šå‚è€ƒï¼šç§¯åˆ†å•†åŸï¼ˆç¾å›¢/æ”¯ä»˜å®ï¼‰é€šå¸¸ 10-15 ä¸ªå­—æ®µï¼Œæ¸¸æˆå•†åŸï¼ˆSteam/æš´é›ªï¼‰8-12 ä¸ªå­—æ®µã€‚ç²¾ç®€åç¬¦åˆé¡¹ç›®ä½“é‡ã€‚

### ğŸ”´ å†³ç­–13ï¼šç«ä»·ç»“ç®—åæ‰£å‡ exchange_items.stock

**ç»“è®ºï¼šç«ä»·ä¸­æ ‡ = æ¶ˆè€—ä¸€ä¸ªåº“å­˜ï¼Œç»“ç®—æ—¶ `stock -= 1`ã€`sold_count += 1`ã€‚**

- è¡Œä¸šä¸€è‡´ç»“è®ºï¼šeBay/é—²é±¼/Steam/æš´é›ªæ‹å–è¡Œ/é“¶è¡Œç§¯åˆ†å•†åŸç«æ‹â€”â€”æ‰€æœ‰å¹³å°çš„æ‹å–æˆäº¤éƒ½æ‰£åº“å­˜ã€‚
- åŸå› ï¼šå•†å“æ¨¡æ¿çš„ `stock` ä»£è¡¨å®é™…å¯å‘æ”¾æ•°é‡ï¼Œç«ä»·å’Œæ™®é€šå…‘æ¢å…±äº«åŒä¸€åº“å­˜æ± ã€‚
- å®æ–½è¦æ±‚ï¼š
  - `BidService.settleBidProduct()` ç»“ç®—äº‹åŠ¡ä¸­æ–°å¢ï¼š`ExchangeItem.update({ stock: literal('stock - 1'), sold_count: literal('sold_count + 1') })`ã€‚
  - è¿è¥åˆ›å»ºç«ä»·æ—¶æ ¡éªŒ `stock > 0`ï¼Œå¦åˆ™è¿”å› `INSUFFICIENT_STOCK` é”™è¯¯ã€‚
  - ç»“ç®—æ—¶å†æ¬¡æ ¡éªŒ `stock > 0`ï¼ˆé˜²æ­¢ç»“ç®—æœŸé—´åº“å­˜è¢«æ™®é€šå…‘æ¢æ¶ˆè€—å®Œï¼‰ã€‚

### ğŸ”´ å†³ç­–14ï¼šç«ä»·å•†å“åˆ—è¡¨éœ€è¦ç™»å½•æ‰èƒ½æŸ¥çœ‹

**ç»“è®ºï¼šä¿æŒå½“å‰æ–¹æ¡ˆï¼Œç«ä»·åˆ—è¡¨åœ¨ `backpack` åŸŸä¸‹ï¼Œéœ€è¦ JWT è®¤è¯ã€‚**

- å¾®ä¿¡å°ç¨‹åºç”¨æˆ·è¿›å…¥æ—¶é€šå¸¸å·²é™é»˜ç™»å½•ï¼ˆ`wx.login` â†’ JWTï¼‰ï¼Œç™»å½•è¦æ±‚å¯¹ç”¨æˆ·ä½“éªŒæ— å½±å“ã€‚
- ç«ä»·åˆ—è¡¨éœ€è¦è¿”å›ä¸ªæ€§åŒ–å­—æ®µï¼ˆ`my_highest_bid`ã€`is_my_winning`ï¼‰ï¼Œå¿…é¡»çŸ¥é“å½“å‰ç”¨æˆ·èº«ä»½ã€‚
- ä¸éœ€è¦æ”¹ä¸­é—´ä»¶ï¼Œä¿æŒæ¶æ„ç®€å•ã€‚

### ğŸ”´ å†³ç­–15ï¼špending â†’ active ç”±å®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ¿€æ´»

**ç»“è®ºï¼šæ–¹æ¡ˆ A â€” å®šæ—¶ä»»åŠ¡æ¯åˆ†é’Ÿæ£€æŸ¥ï¼Œè‡ªåŠ¨å°†åˆ°è¾¾ `start_time` çš„ `pending` ç«ä»·æ¿€æ´»ä¸º `active`ã€‚**

- ä¸ç«ä»·ç»“ç®—åˆå¹¶åœ¨åŒä¸€ä¸ª cron jobï¼ˆ`bidSettlementJob.js`ï¼‰ä¸­ï¼Œé›¶é¢å¤–æˆæœ¬ã€‚
- æ•°æ®åº“çŠ¶æ€ä¸å®é™…ä¸€è‡´ï¼Œæ–¹ä¾¿åå°ç®¡ç†æŸ¥çœ‹å’Œç»Ÿè®¡ã€‚
- Â±1 åˆ†é’Ÿå»¶è¿Ÿå¯¹ç«ä»·åœºæ™¯å®Œå…¨å¯æ¥å—ï¼ˆç«ä»·æ—¶é•¿ä¸ºå°æ—¶/å¤©çº§åˆ«ï¼‰ã€‚
- è¡Œä¸šå‚è€ƒï¼šæ·˜å®æ‹å–/äº¬ä¸œæ‹å–å‡é‡‡ç”¨å®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ¿€æ´»ã€‚
- å®æ–½è¦æ±‚ï¼š
  - `bidSettlementJob.js` æ‰§è¡Œé€»è¾‘æ–°å¢æ­¥éª¤ 0ï¼š
    ```sql
    UPDATE bid_products SET status = 'active' WHERE status = 'pending' AND start_time <= NOW()
    ```
  - åœ¨ç»“ç®—é€»è¾‘ä¹‹å‰æ‰§è¡Œï¼Œç¡®ä¿å…ˆæ¿€æ´»å†ç»“ç®—ã€‚

### ğŸ”´ å†³ç­–16ï¼šé›¶å‡ºä»·ç«ä»·æ ‡è®°ä¸º `no_bid`ï¼ˆæµæ‹ï¼‰ç‹¬ç«‹çŠ¶æ€

**ç»“è®ºï¼šæ–¹æ¡ˆ B â€” æ–°å¢ `no_bid` çŠ¶æ€ï¼ŒçŠ¶æ€æœºä» 6 æ€æ‰©å±•ä¸º 7 æ€ã€‚**

- è¡Œä¸šä¸€è‡´ç»“è®ºï¼šeBayï¼ˆ`ended_no_bids`ï¼‰ã€æ·˜å®/äº¬ä¸œæ‹å–ï¼ˆ"æµæ‹"ï¼‰ã€æš´é›ªæ‹å–è¡Œï¼ˆ`expired`ï¼‰â€”â€”æ‰€æœ‰å¹³å°éƒ½ç”¨ç‹¬ç«‹çŠ¶æ€åŒºåˆ†æµæ‹ã€‚
- è¿è¥éœ€è¦åŒºåˆ†ï¼šå“ªäº›å•†å“å–å‡ºå»äº†ï¼ˆ`settled`ï¼‰ã€å“ªäº›æ²¡äººè¦ï¼ˆ`no_bid`ï¼Œå¯èƒ½éœ€è°ƒæ•´èµ·æ‹ä»·ï¼‰ã€å“ªäº›è¢«å–æ¶ˆäº†ï¼ˆ`cancelled`ï¼Œäººä¸ºæ“ä½œï¼‰ã€‚
- å®æ–½è¦æ±‚ï¼š
  - `bid_products.status` ENUM æ–°å¢ `'no_bid'` å€¼ï¼ˆ7 æ€ï¼‰ã€‚
  - ç»“ç®—å®šæ—¶ä»»åŠ¡ä¸­ï¼š`if (bid_count === 0) â†’ status = 'no_bid'`ï¼Œä¸åšä»»ä½•èµ„äº§æ“ä½œã€‚
  - `no_bid` çŠ¶æ€çš„ç«ä»·ä¸æ‰£å‡ `exchange_items.stock`ï¼ˆå•†å“æœªå”®å‡ºï¼‰ã€‚

---

## 1. é¡¹ç›®ç°çŠ¶åˆ†æï¼ˆåŸºäºçœŸå®æ•°æ®åº“æŸ¥è¯¢ 2026-02-15ï¼‰

### 1.1 æ•°æ®åº“ç°çŠ¶

| è¡¨å | è®°å½•æ•° | è¯´æ˜ |
|------|--------|------|
| `exchange_items` | 77ï¼ˆactive 32 / inactive 45ï¼‰ | å…‘æ¢å•†å“è¡¨ï¼Œ`cost_asset_code` + `cost_amount` ææ–™æ”¯ä»˜ï¼›å…¨éƒ¨ `category = NULL` |
| `exchange_records` | 0 | å…‘æ¢è®¢å•è¡¨ï¼ˆæ–°ç³»ç»Ÿå°šæ— è®¢å•ï¼‰ |
| `user_premium_status` | 1 | é«˜çº§ç©ºé—´è§£é”çŠ¶æ€ï¼ˆuser_id=31ï¼Œå·²è¿‡æœŸï¼Œtotal_unlock_count=3ï¼‰ |
| `account_asset_balances` | â€” | ç»Ÿä¸€èµ„äº§ä½™é¢ï¼ˆ`available_amount` + `frozen_amount`ï¼‰ï¼Œå« `lottery_campaign_key` åˆ†åŒº |
| `asset_transactions` | 24837 | èµ„äº§æµæ°´ï¼Œå…¶ä¸­ `exchange_debit` 2424æ¡ã€`lottery_consume` 5011æ¡ã€`order_freeze_buyer` 1928æ¡ç­‰ |
| `material_asset_types` | 4 | ææ–™ç±»å‹å®šä¹‰è¡¨ï¼ˆå« `is_tradable` + `is_enabled` æ§åˆ¶å­—æ®µï¼‰ |
| `item_instances` | 6107 | ç‰©å“å®ä¾‹ï¼ˆproduct 1494 / voucher 4413 / tradable_item 112 / prize 41 / null 47ï¼‰ |
| `bid_*` | ä¸å­˜åœ¨ | ç«ä»·ç›¸å…³è¡¨å°šæœªåˆ›å»º |
| `space` åˆ— | ä¸å­˜åœ¨ | `exchange_items` è¡¨å°šæ—  `space` å­—æ®µ |
| `source` åˆ— | ä¸å­˜åœ¨ | `exchange_records` å’Œ `item_instances` å‡æ—  `source` å­—æ®µ |

**exchange_items ç°æœ‰æ”¯ä»˜èµ„äº§åˆ†å¸ƒï¼š**

| cost_asset_code | æ•°é‡ | å¤‡æ³¨ |
|-----------------|------|------|
| `red_shard` | 71 | ä¸»è¦æ”¯ä»˜æ–¹å¼ |
| `DIAMOND` | 4 | é’»çŸ³æ”¯ä»˜ |
| `POINTS` | 2 | âš ï¸ æœ‰ 2 æ¡å†å²å•†å“ä»ç”¨ç§¯åˆ†æ”¯ä»˜ï¼Œè¿ç§»æ—¶éœ€å…³æ³¨ |

### 1.2 ç°æœ‰èµ„äº§ä½“ç³»

`material_asset_types` è¡¨å®é™…æ•°æ®ï¼ˆ2026-02-15 æŸ¥è¯¢ï¼‰ï¼š

| asset_code | display_name | is_tradable | is_enabled | group_code | form | tier |
|------------|-------------|-------------|------------|------------|------|------|
| `red_shard` | çº¢è‰²ç¢ç‰‡ | âœ… 1 | âœ… 1 | red | shard | 1 |
| `DIAMOND` | é’»çŸ³ | âœ… 1 | âœ… 1 | currency | currency | 10 |
| `POINTS` | æ™®é€šç§¯åˆ† | âŒ 0 | âŒ 0 | points | crystal | 0 |
| `BUDGET_POINTS` | é¢„ç®—ç§¯åˆ† | âŒ 0 | âœ… 1 | points | crystal | 0 |

**ç«ä»·èµ„äº§ç™½åå•æ¨å¯¼**ï¼ˆåŸºäºå†³ç­–1 + å†³ç­–9ï¼‰ï¼š

```sql
-- åŠ¨æ€ç™½åå•æŸ¥è¯¢ï¼ˆå®é™…ç»“æœï¼šred_shard, DIAMONDï¼‰
SELECT asset_code FROM material_asset_types
WHERE is_tradable = 1 AND asset_code NOT IN ('POINTS', 'BUDGET_POINTS')
-- ç»“æœï¼šred_shard, DIAMOND
```

`account_asset_balances` ä¸­å®é™…æµé€šçš„ asset_codeï¼ˆå«å†å²æ•°æ®ï¼‰ï¼š

| asset_code | ç”¨é€” | frozen æ”¯æŒ | åœ¨ material_asset_types ä¸­ |
|------------|------|-----------|--------------------------|
| `POINTS` | ç§¯åˆ†ï¼ˆè§£é”é«˜çº§ç©ºé—´ç­‰ï¼‰ | âœ… | âœ…ï¼ˆis_tradable=0, is_enabled=0ï¼‰ |
| `DIAMOND` | é’»çŸ³ï¼ˆC2Cå¸‚åœºäº¤æ˜“è´§å¸ï¼‰ | âœ… | âœ…ï¼ˆis_tradable=1ï¼‰ |
| `red_shard` | çº¢è‰²ç¢ç‰‡ï¼ˆå…‘æ¢å•†å“ä¸»è¦æ”¯ä»˜æ–¹å¼ï¼‰ | âœ… | âœ…ï¼ˆis_tradable=1ï¼‰ |
| `BUDGET_POINTS` | é¢„ç®—ç§¯åˆ†ï¼ˆç³»ç»Ÿå†…éƒ¨ï¼‰ | â€” | âœ…ï¼ˆis_tradable=0ï¼‰ |
| `MATERIAL_001` | ææ–™001ï¼ˆä»…åœ¨ä½™é¢è¡¨ä¸­æœ‰å°‘é‡è®°å½•ï¼‰ | â€” | âŒ ä¸åœ¨ material_asset_types ä¸­ |

### 1.3 ä¸å‰ç«¯éœ€æ±‚æ–‡æ¡£çš„å…³é”®å·®å¼‚

| ç»´åº¦ | å‰ç«¯æ–‡æ¡£å‡è®¾ | åç«¯çœŸå®ç°çŠ¶ | å®æ–½å†³ç­– | å†³ç­–ç¼–å· |
|------|-------------|-------------|---------|---------|
| å•†å“è¡¨å | `exchange_products` | `exchange_items` | **æ²¿ç”¨** `exchange_items` | æŠ€æœ¯å†³ç­– |
| å•†å“ä¸»é”® | `id` (INT) | `exchange_item_id` (BIGINT) | **æ²¿ç”¨** BIGINTä¸»é”® | æŠ€æœ¯å†³ç­– |
| æ”¯ä»˜æ–¹å¼ | `exchange_points`ï¼ˆç§¯åˆ†ï¼‰ | `cost_asset_code` + `cost_amount`ï¼ˆææ–™èµ„äº§ï¼‰ | **æ²¿ç”¨** ææ–™èµ„äº§æ”¯ä»˜ä½“ç³» | æŠ€æœ¯å†³ç­– |
| ç«ä»·èµ„äº§ | ç§¯åˆ†ç«ä»· | å¤šèµ„äº§ä½“ç³» | **ç¦æ­¢ POINTS/BUDGET_POINTS**ï¼Œä»…å…è®¸ DIAMOND/red_shard ç­‰ | **å†³ç­–1** |
| ç©ºé—´åŒºåˆ† | `space` å­—æ®µ (lucky/premium) | æ—  `space` å­—æ®µ | **æ–°å¢** `space` å­—æ®µï¼Œå­˜é‡å•†å“é»˜è®¤ `lucky` | **å†³ç­–4** |
| é«˜çº§ç©ºé—´è¡¨ | `premium_unlock_records`ï¼ˆæ–°è¡¨ï¼‰ | `user_premium_status`ï¼ˆå·²æœ‰ï¼‰ | **å¤ç”¨** å·²æœ‰è¡¨å’ŒæœåŠ¡ | æŠ€æœ¯å†³ç­– |
| é«˜çº§ç©ºé—´è·¯ç”± | æœªæŒ‡å®š | `/api/v4/shop/premium/*`ï¼ˆshop/index.js L57+L95 æŒ‚è½½ï¼‰ | **è¿ç§»**åˆ° `/api/v4/backpack/exchange/` åŸŸ | **å†³ç­–2** |
| è§£é”è´¹ç”¨ | 1000ç§¯åˆ† | 100ç§¯åˆ† (POINTS) | **ä»¥åç«¯ç°æœ‰ 100 ä¸ºå‡†**ï¼Œå‰ç«¯é€‚é… | **å†³ç­–3** |
| æœ‰æ•ˆæ—¶é•¿ | 48å°æ—¶ | 24å°æ—¶ | **ä»¥åç«¯ç°æœ‰ 24h ä¸ºå‡†**ï¼Œå‰ç«¯é€‚é… | **å†³ç­–3** |
| è§£é”é—¨æ§› | ç´¯è®¡ç§¯åˆ†â‰¥10000, å¯ç”¨â‰¥1000 | `history_total_points` â‰¥ 100000, POINTSä½™é¢ â‰¥ 100 | **ä»¥åç«¯ç°æœ‰ 10ä¸‡ ä¸ºå‡†** | **å†³ç­–3** |
| ç«ä»·ä¸­æ ‡äº¤ä»˜ | æœªæ˜ç¡® | `ItemInstance` èƒŒåŒ…ä½“ç³» | **ä¸­æ ‡å•†å“æ”¾å…¥ç”¨æˆ·èƒŒåŒ…** | **å†³ç­–5** |
| ç«ä»·ç»“ç®—é¢‘ç‡ | æœªæ˜ç¡® | â€” | **æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡**ï¼ŒÂ±1åˆ†é’Ÿç²¾åº¦ | **å†³ç­–6** |
| ç«ä»·ä¸­æ ‡å…¥èƒŒåŒ…æ–¹å¼ | æœªæ˜ç¡® | ç°æœ‰1494æ¡productç±»å‹å…¨éƒ¨`item_template_id=NULL` | `item_type='product'` + `meta` JSONå¿«ç…§ï¼Œä¸ä¾èµ–æ¨¡æ¿ | **å†³ç­–7** |
| ç«ä»·é€šçŸ¥æ¨é€ | æœªæ˜ç¡® | å·²æœ‰ `NotificationService` | è¢«è¶…ä»·/ä¸­æ ‡/è½é€‰æ¨é€åˆ°å…¬å‘Šï¼ŒPhase 2 ä¸€èµ·åš | **å†³ç­–8** |
| ç«ä»·èµ„äº§ç™½åå• | æœªæ˜ç¡® | `material_asset_types` å·²æœ‰ `is_tradable` å­—æ®µ | åŠ¨æ€æŸ¥è¯¢ç™½åå• + ç¡¬ç¼–ç é»‘åå•ï¼ˆPOINTS/BUDGET_POINTSï¼‰ | **å†³ç­–9** |
| æ¥æºè¿½è¸ª | æœªæ˜ç¡® | `exchange_records`/`item_instances` æ—  `source` å­—æ®µ | **æ–°å¢** `source` å­—æ®µï¼Œè¿ç§»æ–‡ä»¶ä¸€èµ·æ | **å†³ç­–10** |
| å¹¶å‘ç«ä»·ç­–ç•¥ | æœªæ˜ç¡® | â€” | ä¸€ç‰©ä¸€æ‹ï¼ˆä»£ç æ ¡éªŒï¼‰+ `batch_no` é¢„ç•™æ‰©å±• | **å†³ç­–11** |
| å›¾ç‰‡ | `image` (URLå­—æ®µ) | `primary_image_id` (å…³è” `image_resources` è¡¨) | **æ²¿ç”¨** å›¾ç‰‡èµ„æºç³»ç»Ÿ | æŠ€æœ¯å†³ç­– |

---

## 2. å¯å¤ç”¨ç»„ä»¶æ¸…å•ï¼ˆåŸºäºä»£ç èµ°æŸ¥éªŒè¯ 2026-02-15ï¼‰

### 2.1 å®Œå…¨å¯å¤ç”¨ï¼ˆé›¶æ”¹åŠ¨ï¼‰

| ç»„ä»¶ | è·¯å¾„ | å¤ç”¨åœºæ™¯ | éªŒè¯çŠ¶æ€ |
|------|------|---------|---------|
| `PremiumService` | `services/PremiumService.js` | é«˜çº§ç©ºé—´è§£é” + çŠ¶æ€æŸ¥è¯¢ã€‚å¸¸é‡ `UNLOCK_COST=100`, `VALIDITY_HOURS=24`, `HISTORY_POINTS_THRESHOLD=100000`ã€‚æ–¹æ³• `unlockPremium(user_id, {transaction})` + `getPremiumStatus(user_id)` | âœ… ä»£ç ç¡®è®¤ |
| `UserPremiumStatus` æ¨¡å‹ | `models/UserPremiumStatus.js` | é«˜çº§ç©ºé—´æ•°æ®å±‚ï¼Œå·²æœ‰ 1 æ¡çœŸå®è®°å½•ï¼ˆuser_id=31ï¼‰ | âœ… æ•°æ®åº“ç¡®è®¤ |
| `BalanceService` | `services/asset/BalanceService.js` | æä¾› `freeze(params, options)` / `unfreeze(params, options)` / `settleFromFrozen(params, options)` ä¸‰ä¸ªç‹¬ç«‹æ–¹æ³•ï¼Œå‚æ•°å‡ä¸º `{ user_id, asset_code, amount, business_type, idempotency_key, meta }` + `{ transaction }`ã€‚`user_id` å’Œ `system_code` äºŒé€‰ä¸€ | âœ… ä»£ç ç¡®è®¤ï¼ˆL451/L638/L825ï¼‰ |
| `TransactionManager` | `utils/TransactionManager.js` | `execute(async (transaction) => {...}, options)` å…¥å£ï¼Œæ”¯æŒæ™ºèƒ½é‡è¯•ç­–ç•¥ï¼ˆæ­»é”é‡è¯•3æ¬¡ã€ä¸šåŠ¡é”™è¯¯ä¸é‡è¯•ï¼‰ | âœ… ä»£ç ç¡®è®¤ |
| `ApiResponse` | `utils/ApiResponse.js` | `res.apiSuccess(data, message)` / `res.apiError(message, code, data, httpStatus)` ä¸­é—´ä»¶ | âœ… è·¯ç”±å±‚ç»Ÿä¸€ä½¿ç”¨ |
| `IdempotencyService` | `services/IdempotencyService.js` | å…¥å£å¹‚ç­‰æœåŠ¡ v2.0ï¼ŒTTL 7å¤©ï¼ŒçŠ¶æ€æœº `processing â†’ completed/failed` | âœ… ä»£ç ç¡®è®¤ |
| `authenticateToken` | `middleware/auth.js` | JWTè®¤è¯ä¸­é—´ä»¶ï¼Œ`req.user.user_id` è·å–å½“å‰ç”¨æˆ· | âœ… æ‰€æœ‰è·¯ç”±ç»Ÿä¸€ä½¿ç”¨ |
| `BeijingTimeHelper` | `utils/timeHelper.js` | åŒ—äº¬æ—¶é—´å…¨é“¾è·¯ï¼Œ`createBeijingTime()` / `apiTimestamp()` ç­‰ | âœ… ä»£ç ç¡®è®¤ |
| `DataSanitizer` | `services/DataSanitizer.js` | ç»Ÿä¸€æ•°æ®è„±æ•ï¼ŒæŒ‰ dataLevelï¼ˆ`full`/`public`ï¼‰è¿”å›ä¸åŒçº§åˆ«æ•°æ® | âœ… ä»£ç ç¡®è®¤ï¼ˆ1399è¡Œï¼‰ |
| `ServiceManager` | `services/index.js` | `req.app.locals.services.getService('service_key')` æ³¨å…¥æ¨¡å¼ï¼Œsnake_case å‘½å | âœ… ä»£ç ç¡®è®¤ï¼ˆ809è¡Œï¼‰ |

### 2.2 éœ€æ‰©å±•æ”¹é€ 

| ç»„ä»¶ | å½“å‰çŠ¶æ€ | æ”¹åŠ¨å†…å®¹ |
|------|---------|---------|
| `ExchangeItem` æ¨¡å‹ (`models/ExchangeItem.js`, 177è¡Œ) | å·²æœ‰å­—æ®µï¼š`exchange_item_id`, `item_name`, `description`, `primary_image_id`, `cost_asset_code`, `cost_amount`, `cost_price`, `stock`, `sold_count`, `category`, `status`, `sort_order`ã€‚ç°æœ‰ç´¢å¼•ï¼š`status`, `category`, `cost_asset_code` | æ–°å¢ **9** ä¸ªå­—æ®µï¼ˆå†³ç­–12ï¼Œç æ‰ `discount`/`rating`/`sales`/`seller_info`ï¼‰ï¼š`space`ã€`original_price`ã€`tags`ã€`is_new`ã€`is_hot`ã€`is_lucky`ã€`has_warranty`ã€`free_shipping`ã€`sell_point` |
| `exchange/QueryService` (`services/exchange/QueryService.js`, 548è¡Œ) | å·²æœ‰ `getMarketItems(options)` æ”¯æŒå‚æ•°ï¼š`status`, `asset_code`, `page`, `page_size`, `sort_by`, `sort_order`, `refresh`ã€‚ä½¿ç”¨ `BusinessCacheHelper` Redisç¼“å­˜ã€‚è§†å›¾å¸¸é‡ `EXCHANGE_MARKET_ATTRIBUTES.marketItemView` æ§åˆ¶è¿”å›å­—æ®µ | æ‰©å±• `getMarketItems`ï¼šæ–°å¢ `space`/`keyword`/`min_cost`/`max_cost`/`stock_status` å‚æ•°ï¼›æ–°å¢ `getSpaceStats(space)` æ–¹æ³•ï¼›æ›´æ–° `marketItemView` å¸¸é‡è¿½åŠ æ–°å­—æ®µ |
| `routes/v4/backpack/exchange.js` (381è¡Œ) | å·²æœ‰ 3 ä¸ªç«¯ç‚¹ï¼š`GET /items`ã€`GET /items/:exchange_item_id`ã€`POST /`ï¼ˆæ‰§è¡Œå…‘æ¢ï¼‰ | æ‰©å±• `GET /items` æŸ¥è¯¢å‚æ•°ï¼›æ–°å¢ `/space-stats`ã€`/premium-status`ã€`/unlock-premium` è·¯ç”± |
| `routes/v4/shop/premium.js` (206è¡Œ) | å½“å‰æŒ‚è½½åœ¨ `shop/index.js` L57+L95ï¼š`router.use('/premium', premiumRoutes)` | **åˆ é™¤æ­¤æ–‡ä»¶**ï¼ŒåŒæ—¶ç§»é™¤ `shop/index.js` ä¸­çš„ `require('./premium')` å’Œ `router.use('/premium', ...)` ä¸¤è¡Œ |

### 2.3 éœ€æ‰©å±•ï¼ˆå­—æ®µçº§æ”¹åŠ¨ï¼‰

| ç»„ä»¶ | å½“å‰çŠ¶æ€ | æ”¹åŠ¨å†…å®¹ |
|------|---------|---------|
| `ExchangeRecord` æ¨¡å‹ (`models/ExchangeRecord.js`, 230è¡Œ) | å·²æœ‰å­—æ®µå« `pay_asset_code`, `pay_amount`, `business_id`(UNIQUE), `idempotency_key`(UNIQUE), `status` ENUM('pending','completed','shipped','cancelled')ã€‚0æ¡è®°å½• | æ–°å¢ `source VARCHAR(20) NOT NULL DEFAULT 'exchange'` å­—æ®µ + ç´¢å¼•ï¼ˆå†³ç­–10ï¼‰ |
| `ItemInstance` æ¨¡å‹ (`models/ItemInstance.js`, 556è¡Œ) | Classç»§æ‰¿Modelæ¨¡å¼ï¼ˆéfunctionæ¨¡å¼ï¼‰ï¼Œå·²æœ‰ `meta` JSONå­—æ®µã€å¤šçº§é”å®šæœºåˆ¶ `locks` JSONã€çŠ¶æ€æœº `available/locked/transferred/used/expired`ã€‚6107æ¡è®°å½• | æ–°å¢ `source VARCHAR(20) DEFAULT NULL` å­—æ®µï¼ˆå†³ç­–10ï¼‰ï¼Œå­˜é‡ä¿æŒNULL |
| `NotificationService` (`services/NotificationService.js`, ~1000è¡Œ) | å·²æœ‰ `send(user_id, {type, title, content, data})` æ–¹æ³•ï¼Œé€šè¿‡å®¢æœèŠå¤©ç³»ç»Ÿ + WebSocketæ¨é€ | æ–°å¢é€šçŸ¥ç±»å‹ï¼š`bid_outbid`ï¼ˆè¢«è¶…ä»·ï¼‰ã€`bid_won`ï¼ˆä¸­æ ‡ï¼‰ã€`bid_lost`ï¼ˆè½é€‰ï¼‰ï¼ˆå†³ç­–8ï¼‰ |

### 2.4 éœ€æ–°å»º

| ç»„ä»¶ | è¯´æ˜ | å‚è€ƒç°æœ‰æ¨¡å¼ |
|------|------|-------------|
| `models/BidProduct.js` | ç«ä»·å•†å“è¡¨æ¨¡å‹ï¼ˆå« `batch_no` é¢„ç•™å­—æ®µï¼Œå†³ç­–11ï¼‰ | å‚è€ƒ `models/ExchangeItem.js` functionæ¨¡å¼ + `models/MarketListing.js` çŠ¶æ€æœº |
| `models/BidRecord.js` | ç«ä»·å‡ºä»·è®°å½•è¡¨æ¨¡å‹ | å‚è€ƒ `models/ExchangeRecord.js` functionæ¨¡å¼ + `idempotency_key` UNIQUE |
| `services/exchange/BidService.js` | ç«ä»·æ ¸å¿ƒæœåŠ¡ï¼ˆå‡ºä»· + åŠ¨æ€ç™½åå• + å†»ç»“/è§£å†» + ç»“ç®— + é€šçŸ¥ï¼‰ | å‚è€ƒ `services/exchange/CoreService.js` äº‹åŠ¡è¾¹ç•Œæ¨¡å¼ |
| `services/exchange/BidQueryService.js` | ç«ä»·æŸ¥è¯¢æœåŠ¡ï¼ˆåˆ—è¡¨ã€è¯¦æƒ…ã€å†å²ï¼‰ | å‚è€ƒ `services/exchange/QueryService.js` ç¼“å­˜ + è§†å›¾å¸¸é‡æ¨¡å¼ |
| `routes/v4/backpack/bid.js` | ç«ä»·è·¯ç”±ï¼ˆ4ä¸ªç«¯ç‚¹ï¼‰ï¼ŒæŒ‚è½½åˆ° `backpack/index.js` | å‚è€ƒ `routes/v4/backpack/exchange.js` asyncHandler + ServiceManageræ¨¡å¼ |
| è¿ç§»æ–‡ä»¶ Ã—4 | åŸºäºæœ€æ–°è¿ç§»ç¼–å· `20260215100000` é€’å¢ã€‚â‘  `exchange_items` å­—æ®µæ‰©å±• â‘¡ `bid_products` å»ºè¡¨ â‘¢ `bid_records` å»ºè¡¨ â‘£ `source` å­—æ®µè¿ç§» | å‚è€ƒ `migrations/20260206000000-baseline-v3.0.0-squashed.js` è¿ç§»æ¨¡å¼ |
| `jobs/bidSettlementJob.js` | ç«ä»·å®šæ—¶ä»»åŠ¡ï¼ˆæ¯åˆ†é’Ÿï¼Œ`node-cron`ï¼‰ï¼šé˜¶æ®µA pendingâ†’active è‡ªåŠ¨æ¿€æ´»ï¼ˆå†³ç­–15ï¼‰+ é˜¶æ®µB åˆ°æœŸç»“ç®—/æµæ‹ï¼ˆå†³ç­–13/16ï¼‰ | å‚è€ƒ `jobs/hourly-expire-fungible-asset-listings.js` å·²æœ‰çš„å®šæ—¶ä»»åŠ¡æ¨¡å¼ |

---

## 3. æ•°æ®åº“å˜æ›´æ–¹æ¡ˆ

### 3.1 è¿ç§»1ï¼šexchange_items è¡¨å­—æ®µæ‰©å±•

> æ–‡ä»¶åï¼š`migrations/YYYYMMDDHHMMSS-add-space-and-display-fields-to-exchange-items.js`

**æ–°å¢å­—æ®µï¼ˆ9 ä¸ªï¼Œè§å†³ç­–12ï¼‰ï¼š**

```
ALTER TABLE exchange_items ADD COLUMN space VARCHAR(20) NOT NULL DEFAULT 'lucky' COMMENT 'æ‰€å±ç©ºé—´ï¼šlucky/premium/both';
ALTER TABLE exchange_items ADD COLUMN original_price BIGINT DEFAULT NULL COMMENT 'åŸä»·ï¼ˆææ–™æ•°é‡ï¼‰ï¼Œç”¨äºå±•ç¤ºåˆ’çº¿ä»·å¯¹æ¯”';
ALTER TABLE exchange_items ADD COLUMN tags JSON DEFAULT NULL COMMENT 'å•†å“æ ‡ç­¾æ•°ç»„ï¼Œå¦‚ ["é™é‡","æ–°å“"]';
ALTER TABLE exchange_items ADD COLUMN is_new TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦æ–°å“';
ALTER TABLE exchange_items ADD COLUMN is_hot TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦çƒ­é—¨';
ALTER TABLE exchange_items ADD COLUMN is_lucky TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦å¹¸è¿å•†å“ï¼ˆç‰¹æ®Šæ ‡è¯†ï¼‰';
ALTER TABLE exchange_items ADD COLUMN has_warranty TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦æœ‰è´¨ä¿';
ALTER TABLE exchange_items ADD COLUMN free_shipping TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦åŒ…é‚®';
ALTER TABLE exchange_items ADD COLUMN sell_point VARCHAR(200) DEFAULT NULL COMMENT 'è¥é”€å–ç‚¹æ–‡æ¡ˆ';
ALTER TABLE exchange_items ADD INDEX idx_space (space);
ALTER TABLE exchange_items ADD INDEX idx_space_status (space, status);
```

> âŒ å·²ç æ‰ 4 ä¸ªå­—æ®µï¼ˆå†³ç­–12ï¼‰ï¼š`discount`ï¼ˆå‰ç«¯å¯ç®—ï¼‰ã€`rating`ï¼ˆæ— è¯„ä»·ç³»ç»Ÿï¼‰ã€`sales`ï¼ˆä¸ `sold_count` é‡å¤ï¼‰ã€`seller_info`ï¼ˆè‡ªè¥éå¤šå•†å®¶ï¼‰ã€‚

**å­˜é‡æ•°æ®å¤„ç†ï¼š**

```sql
-- ç°æœ‰77æ¡å•†å“é»˜è®¤å½’å…¥ lucky ç©ºé—´ï¼ˆDEFAULT 'lucky' å·²å¤„ç†ï¼Œæ­¤ UPDATE ä¸ºæ˜¾å¼ç¡®è®¤ï¼‰
UPDATE exchange_items SET space = 'lucky' WHERE space = 'lucky';
```

### 3.2 è¿ç§»2ï¼šbid_products ç«ä»·å•†å“è¡¨

> æ–‡ä»¶åï¼š`migrations/YYYYMMDDHHMMSS-create-bid-products.js`

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| `bid_product_id` | BIGINT | PK, AUTO_INCREMENT | ä¸»é”® |
| `exchange_item_id` | BIGINT | FK â†’ exchange_items, NOT NULL | å…³è”å…‘æ¢å•†å“ |
| `start_price` | BIGINT | NOT NULL | èµ·æ‹ä»·ï¼ˆææ–™èµ„äº§æ•°é‡ï¼‰ |
| `price_asset_code` | VARCHAR(50) | NOT NULL, DEFAULT 'DIAMOND' | ç«ä»·ä½¿ç”¨çš„èµ„äº§ç±»å‹ï¼ˆç¦æ­¢ POINTS/BUDGET_POINTSï¼Œè§å†³ç­–1ï¼‰ |
| `current_price` | BIGINT | DEFAULT 0 | å½“å‰æœ€é«˜å‡ºä»·ï¼ˆå†—ä½™å­—æ®µï¼‰ |
| `min_bid_increment` | BIGINT | NOT NULL, DEFAULT 10 | æœ€å°åŠ ä»·å¹…åº¦ |
| `start_time` | DATETIME | NOT NULL | ç«ä»·å¼€å§‹æ—¶é—´ |
| `end_time` | DATETIME | NOT NULL | ç«ä»·ç»“æŸæ—¶é—´ |
| `winner_user_id` | INT | DEFAULT NULL, FK â†’ users | ä¸­æ ‡ç”¨æˆ·ID |
| `winner_bid_id` | BIGINT | DEFAULT NULL | ä¸­æ ‡å‡ºä»·è®°å½•ID |
| `status` | ENUM('pending','active','ended','cancelled','settled','settlement_failed','no_bid') | DEFAULT 'pending' | 7æ€çŠ¶æ€æœºï¼ˆè§å†³ç­–6 + å†³ç­–16ï¼‰ |
| `bid_count` | INT | DEFAULT 0 | æ€»å‡ºä»·æ¬¡æ•° |
| `batch_no` | VARCHAR(50) | DEFAULT NULL | æ‰¹æ¬¡å·ï¼ˆé¢„ç•™ï¼Œæœªæ¥å¤šæ‰¹æ¬¡ç«ä»·æ‰©å±•ç”¨ï¼Œè§å†³ç­–11ï¼‰ |
| `created_by` | INT | NOT NULL, FK â†’ users | åˆ›å»ºäººï¼ˆç®¡ç†å‘˜ï¼‰ |
| `created_at` | DATETIME | NOT NULL | åˆ›å»ºæ—¶é—´ |
| `updated_at` | DATETIME | NOT NULL | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•ï¼š**

- `idx_status_end` â†’ `(status, end_time)` â€” æŸ¥è¯¢è¿›è¡Œä¸­ç«ä»·
- `idx_exchange_item` â†’ `(exchange_item_id)` â€” å…³è”æŸ¥è¯¢
- `uk_active_item` â†’ `(exchange_item_id, status)` â€” ä¸€ç‰©ä¸€æ‹çº¦æŸï¼ˆä»£ç å±‚æ ¡éªŒ active/pending åªèƒ½å­˜åœ¨ä¸€ä¸ªï¼Œè§å†³ç­–11ï¼‰
- `idx_item_batch` â†’ `(exchange_item_id, batch_no)` â€” æŒ‰æ‰¹æ¬¡æŸ¥è¯¢ï¼ˆé¢„ç•™ï¼‰

**çŠ¶æ€æœºæµè½¬ï¼ˆ7 æ€ï¼Œè§å†³ç­–15 + å†³ç­–16ï¼‰ï¼š**

```
pending â†’ active (åˆ°è¾¾ start_timeï¼Œå®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ¿€æ´»ï¼Œè§å†³ç­–15)
active â†’ ended (åˆ°è¾¾ end_timeï¼Œå®šæ—¶ä»»åŠ¡æ£€æµ‹)
ended â†’ settled (æœ‰å‡ºä»·ï¼Œç»“ç®—å®Œæˆï¼šä¸­æ ‡è€…æ‰£é™¤ + å…¥èƒŒåŒ… + stockæ‰£å‡ã€è½é€‰è€…è§£å†»)
ended â†’ settlement_failed (æœ‰å‡ºä»·ï¼Œç»“ç®—å¼‚å¸¸ï¼Œäººå·¥å¤„ç†)
ended â†’ no_bid (æ— å‡ºä»·ï¼Œæµæ‹ï¼Œä¸åšä»»ä½•èµ„äº§/åº“å­˜æ“ä½œï¼Œè§å†³ç­–16)
pending/active â†’ cancelled (ç®¡ç†å‘˜å–æ¶ˆï¼Œæ‰€æœ‰å‡ºä»·è€…è§£å†»è¿”è¿˜)
```

### 3.3 è¿ç§»3ï¼šbid_records ç«ä»·å‡ºä»·è®°å½•è¡¨

> æ–‡ä»¶åï¼š`migrations/YYYYMMDDHHMMSS-create-bid-records.js`

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| `bid_record_id` | BIGINT | PK, AUTO_INCREMENT | ä¸»é”® |
| `bid_product_id` | BIGINT | FK â†’ bid_products, NOT NULL | å…³è”ç«ä»·å•†å“ |
| `user_id` | INT | FK â†’ users, NOT NULL | å‡ºä»·ç”¨æˆ· |
| `bid_amount` | BIGINT | NOT NULL | å‡ºä»·é‡‘é¢ |
| `previous_highest` | BIGINT | DEFAULT 0 | å‡ºä»·æ—¶çš„å‰æœ€é«˜ä»·ï¼ˆå®¡è®¡ç”¨ï¼‰ |
| `is_winning` | TINYINT(1) | DEFAULT 0 | æ˜¯å¦å½“å‰æœ€é«˜ä»· |
| `is_final_winner` | TINYINT(1) | DEFAULT 0 | æ˜¯å¦æœ€ç»ˆä¸­æ ‡ |
| `freeze_transaction_id` | BIGINT | DEFAULT NULL | å†»ç»“æµæ°´IDï¼ˆå¯¹è´¦ç”¨ï¼‰ |
| `idempotency_key` | VARCHAR(100) | UNIQUE, NOT NULL | å¹‚ç­‰é”® |
| `created_at` | DATETIME | NOT NULL | å‡ºä»·æ—¶é—´ |

**ç´¢å¼•ï¼š**

- `idx_bid_product_amount` â†’ `(bid_product_id, bid_amount DESC)` â€” æŸ¥è¯¢æœ€é«˜å‡ºä»·
- `idx_user_bid` â†’ `(user_id, bid_product_id)` â€” æŸ¥è¯¢ç”¨æˆ·å‡ºä»·è®°å½•
- `uk_idempotency` â†’ `(idempotency_key)` UNIQUE â€” å¹‚ç­‰æ§åˆ¶

### 3.4 è¿ç§»4ï¼šexchange_records å’Œ item_instances æ–°å¢ source å­—æ®µï¼ˆå†³ç­–10ï¼‰

> æ–‡ä»¶åï¼š`migrations/YYYYMMDDHHMMSS-add-source-to-exchange-records-and-item-instances.js`

**å˜æ›´å†…å®¹ï¼š**

```sql
ALTER TABLE exchange_records ADD COLUMN source VARCHAR(20) NOT NULL DEFAULT 'exchange' COMMENT 'æ¥æºï¼šexchange=æ™®é€šå…‘æ¢, bid=ç«ä»·ä¸­æ ‡';
ALTER TABLE exchange_records ADD INDEX idx_source (source);

ALTER TABLE item_instances ADD COLUMN source VARCHAR(20) DEFAULT NULL COMMENT 'æ¥æºï¼šexchange, bid_settlement, lottery ç­‰';
```

**å­˜é‡æ•°æ®å¤„ç†ï¼š**

- `exchange_records`ï¼šå½“å‰ 0 æ¡è®°å½•ï¼Œæ— éœ€å›å¡«ã€‚
- `item_instances`ï¼šå­˜é‡è®°å½• `source` ä¿æŒ `NULL`ï¼ˆå†å²æ•°æ®æ— æ³•ç¡®å®šæ¥æºï¼Œä¸åšå›å¡«ï¼‰ã€‚

---

## 4. APIæ¥å£æ–¹æ¡ˆ

### 4.1 è·¯ç”±åŸŸè§„åˆ’

æ‰€æœ‰å…‘æ¢ç›¸å…³æ¥å£ç»Ÿä¸€å½’å…¥ **backpack åŸŸ**ï¼ˆç¬¦åˆé¡¹ç›®å·²æœ‰çš„åŸŸç»“æ„è¿ç§»å†³ç­–ï¼‰ï¼š

```
/api/v4/backpack/exchange/items              GET   â€” å•†å“åˆ—è¡¨ï¼ˆæ‰©å±•ï¼‰
/api/v4/backpack/exchange/items/:id          GET   â€” å•†å“è¯¦æƒ…ï¼ˆå·²æœ‰ï¼‰
/api/v4/backpack/exchange                    POST  â€” æ‰§è¡Œå…‘æ¢ï¼ˆå·²æœ‰ï¼‰
/api/v4/backpack/exchange/space-stats        GET   â€” ç©ºé—´ç»Ÿè®¡ï¼ˆæ–°å¢ï¼‰
/api/v4/backpack/exchange/premium-status     GET   â€” é«˜çº§ç©ºé—´çŠ¶æ€ï¼ˆè¿ç§»ï¼‰
/api/v4/backpack/exchange/unlock-premium     POST  â€” è§£é”é«˜çº§ç©ºé—´ï¼ˆè¿ç§»ï¼‰
/api/v4/backpack/bid/products                GET   â€” ç«ä»·å•†å“åˆ—è¡¨ï¼ˆæ–°å¢ï¼‰
/api/v4/backpack/bid/products/:id            GET   â€” ç«ä»·å•†å“è¯¦æƒ…ï¼ˆæ–°å¢ï¼‰
/api/v4/backpack/bid                         POST  â€” æäº¤å‡ºä»·ï¼ˆæ–°å¢ï¼‰
/api/v4/backpack/bid/history                 GET   â€” ç«ä»·è®°å½•ï¼ˆæ–°å¢ï¼‰
```

### 4.2 ã€æ‰©å±•ã€‘GET /api/v4/backpack/exchange/items

**æ–°å¢è¯·æ±‚å‚æ•°ï¼š**

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `space` | string | ç©ºé—´ç­›é€‰ï¼š`lucky` / `premium`ï¼Œä¸ä¼ è¿”å›å…¨éƒ¨ |
| `keyword` | string | æ¨¡ç³Šæœç´¢ï¼ˆåŒ¹é… `item_name`ï¼‰ |
| `category` | string | åˆ†ç±»ç­›é€‰ |
| `min_cost` | int | æœ€ä½ä»·æ ¼ |
| `max_cost` | int | æœ€é«˜ä»·æ ¼ |
| `sort_by` | string | æ’åºå­—æ®µï¼š`sort_order`(é»˜è®¤) / `cost_amount` / `rating` / `sales` / `created_at` |
| `stock_status` | string | åº“å­˜çŠ¶æ€ï¼š`in_stock`(>5) / `low_stock`(1-5) |

**è¿”å›å­—æ®µæ–°å¢ï¼ˆ9 ä¸ªï¼Œè§å†³ç­–12ï¼‰ï¼š**

åœ¨å·²æœ‰çš„ `marketItemView` åŸºç¡€ä¸Šè¿½åŠ ï¼š`space`, `original_price`, `tags`, `is_new`, `is_hot`, `is_lucky`, `has_warranty`, `free_shipping`, `sell_point`

> âŒ å·²ç æ‰ï¼š`discount`ï¼ˆå‰ç«¯ç®—ï¼‰ã€`rating`ï¼ˆæ— è¯„ä»·ç³»ç»Ÿï¼‰ã€`sales`ï¼ˆå¤ç”¨ `sold_count`ï¼‰ã€`seller_info`ï¼ˆè‡ªè¥éå¤šå•†å®¶ï¼‰ã€‚æŠ˜æ‰£å±•ç¤ºç”±å‰ç«¯æ ¹æ® `original_price` å’Œ `cost_amount` è‡ªè¡Œè®¡ç®—ã€‚

**å“åº”æ ¼å¼**ï¼ˆæ²¿ç”¨é¡¹ç›®ç»Ÿä¸€ `res.apiSuccess()` æ ¼å¼ï¼‰ï¼š

```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "è·å–å•†å“åˆ—è¡¨æˆåŠŸ",
  "data": {
    "items": [
      {
        "exchange_item_id": 17,
        "item_name": "æ˜Ÿå·´å…‹50å…ƒä»£é‡‘åˆ¸",
        "description": "...",
        "cost_asset_code": "red_shard",
        "cost_amount": 500,
        "original_price": 650,
        "stock": 15,
        "sold_count": 128,
        "category": "ä¼˜æƒ åˆ¸",
        "space": "lucky",
        "tags": ["é™é‡", "çƒ­é”€"],
        "is_hot": true,
        "is_new": false,
        "is_lucky": true,
        "has_warranty": false,
        "free_shipping": true,
        "sell_point": "é™æ—¶ç‰¹æƒ ",
        "primary_image_id": 42,
        "primary_image_url": "https://...",
        "created_at": "2026-02-01 08:00:00"
      }
    ],
    "pagination": {
      "total": 56,
      "page": 1,
      "page_size": 20,
      "total_pages": 3
    }
  },
  "timestamp": "2026-02-15 14:30:00",
  "version": "v4.0",
  "request_id": "req_xxx"
}
```

### 4.3 ã€æ–°å¢ã€‘GET /api/v4/backpack/exchange/premium-status

**å¤ç”¨** `PremiumService.getPremiumStatus(user_id)` å·²æœ‰é€»è¾‘ã€‚

**å“åº”æ ¼å¼ï¼š**

```json
{
  "success": true,
  "code": "SUCCESS",
  "data": {
    "unlocked": false,
    "is_expired": true,
    "can_unlock": true,
    "unlock_cost": 100,
    "validity_hours": 24,
    "conditions": {
      "condition_1": {
        "name": "å†å²ç´¯è®¡ç§¯åˆ†",
        "required": 100000,
        "current": 150000,
        "satisfied": true
      },
      "condition_2": {
        "name": "å½“å‰ç§¯åˆ†ä½™é¢",
        "required": 100,
        "current": 3500,
        "satisfied": true
      }
    }
  }
}
```

> **å‰ç«¯é€‚é…è¯´æ˜**ï¼šå‰ç«¯æ–‡æ¡£ä¸­çš„ `unlock_cost: 1000` å’Œ `unlock_duration: 48` éœ€è¦é€‚é…ä¸ºåç«¯å®é™…å€¼ `100` å’Œ `24`ã€‚å­—æ®µåæ˜ å°„å·²åœ¨å“åº”ä¸­å¯¹é½ã€‚

### 4.4 ã€æ–°å¢ã€‘POST /api/v4/backpack/exchange/unlock-premium

**å¤ç”¨** `PremiumService.unlockPremium(user_id, {transaction})` + `TransactionManager.execute()`ã€‚

**å“åº”æ ¼å¼ï¼š**

```json
{
  "success": true,
  "code": "SUCCESS",
  "data": {
    "unlocked": true,
    "is_first_unlock": false,
    "unlock_cost": 100,
    "remaining_points": 2500,
    "unlock_time": "2026-02-15 10:30:00",
    "expires_at": "2026-02-16 10:30:00",
    "validity_hours": 24,
    "total_unlock_count": 3
  }
}
```

**é”™è¯¯ç ï¼š**

| code | HTTP | è¯´æ˜ |
|------|------|------|
| `ALREADY_UNLOCKED` | 409 | åœ¨æœ‰æ•ˆæœŸå†…ï¼Œæ— éœ€é‡å¤è§£é” |
| `INSUFFICIENT_HISTORY_POINTS` | 403 | å†å²ç´¯è®¡ç§¯åˆ†ä¸è¶³ |
| `INSUFFICIENT_BALANCE` | 403 | å½“å‰POINTSä½™é¢ä¸è¶³ |
| `USER_NOT_FOUND` | 404 | ç”¨æˆ·ä¸å­˜åœ¨ |

### 4.5 ã€æ–°å¢ã€‘GET /api/v4/backpack/exchange/space-stats

**è¯·æ±‚å‚æ•°ï¼š**

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `space` | string | æ˜¯ | `lucky` / `premium` |

**å®ç°æ–¹å¼ï¼š** åœ¨ `exchange/QueryService.js` æ–°å¢ `getSpaceStats(space)` æ–¹æ³•ï¼ŒåŸºäº `exchange_items` è¡¨èšåˆç»Ÿè®¡ã€‚

**å“åº”ï¼š**

```json
{
  "success": true,
  "data": {
    "space": "lucky",
    "total_products": 56,
    "new_count": 12,
    "hot_count": 8,
    "asset_code_distribution": { "red_shard": 50, "DIAMOND": 6 }
  }
}
```

### 4.6 ã€æ–°å¢ã€‘GET /api/v4/backpack/bid/products

**è¯·æ±‚å‚æ•°ï¼š**

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `status` | string | å¦ | `active`(é»˜è®¤) / `pending` / `ended` / `settled` / `no_bid` |
| `page` | int | å¦ | é»˜è®¤ 1 |
| `page_size` | int | å¦ | é»˜è®¤ 10ï¼Œæœ€å¤§ 50 |

**å®ç°æ–¹å¼ï¼š** æ–°å»º `exchange/BidQueryService.js` â†’ æŸ¥è¯¢ `bid_products` JOIN `exchange_items`ï¼Œé™„åŠ å½“å‰ç”¨æˆ·çš„å‡ºä»·ä¿¡æ¯ã€‚

**å“åº”ï¼š**

```json
{
  "success": true,
  "data": {
    "bid_products": [
      {
        "bid_product_id": 1,
        "exchange_item": {
          "exchange_item_id": 42,
          "item_name": "Apple AirPods Pro 2",
          "primary_image_url": "https://...",
          "description": "ä¸»åŠ¨é™å™ª",
          "category": "å®ç‰©å•†å“"
        },
        "price_asset_code": "DIAMOND",
        "start_price": 1000,
        "current_price": 2350,
        "min_bid_increment": 50,
        "bid_count": 18,
        "start_time": "2026-02-15 08:00:00",
        "end_time": "2026-02-16 20:00:00",
        "status": "active",
        "my_highest_bid": 2100,
        "is_my_winning": false
      }
    ],
    "pagination": { "total": 5, "page": 1, "page_size": 10, "total_pages": 1 }
  }
}
```

### 4.7 ã€æ–°å¢ã€‘POST /api/v4/backpack/bid

**è¯·æ±‚å¤´ï¼š** `Idempotency-Key: bid_<timestamp>_<random>` ï¼ˆå¿…å¡«ï¼‰

**è¯·æ±‚ä½“ï¼š**

```json
{
  "bid_product_id": 1,
  "bid_amount": 2400
}
```

**æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆåœ¨ `TransactionManager.execute()` äº‹åŠ¡ä¸­æ‰§è¡Œï¼‰ï¼š**

1. æ ¡éªŒ `price_asset_code` ä¸åœ¨é»‘åå• + åœ¨åŠ¨æ€ç™½åå•å†…ï¼ˆå†³ç­–1 + å†³ç­–9ï¼‰
2. æ ¡éªŒç«ä»·å•†å“çŠ¶æ€ = `active` ä¸” `end_time > NOW()`
3. `SELECT ... FOR UPDATE` é”å®š `bid_products` è¡Œï¼ˆé˜²å¹¶å‘ï¼‰
4. æ ¡éªŒ `bid_amount >= current_price + min_bid_increment`
5. æ ¡éªŒç”¨æˆ·èµ„äº§ä½™é¢ â‰¥ `bid_amount`ï¼ˆé€šè¿‡ `BalanceService.getBalance()`ï¼‰
6. å¦‚æœç”¨æˆ·ä¹‹å‰æœ‰å‡ºä»· â†’ **è§£å†»**ä¹‹å‰çš„å†»ç»“é‡‘é¢ï¼ˆ`BalanceService.unfreeze()`ï¼‰
7. **å†»ç»“**æ–°å‡ºä»·é‡‘é¢ï¼ˆ`BalanceService.freeze()`ï¼Œ`business_type: 'bid_freeze'`ï¼‰
8. æ›´æ–°ä¹‹å‰æœ€é«˜å‡ºä»·è®°å½•çš„ `is_winning = false`
9. å†™å…¥ `bid_records` æ–°è®°å½•ï¼ˆ`is_winning = true`ï¼‰
10. æ›´æ–° `bid_products.current_price` å’Œ `bid_count`
11. **é€šçŸ¥å‰æœ€é«˜å‡ºä»·è€…è¢«è¶…ä»·**ï¼ˆå†³ç­–8ï¼‰ï¼š`NotificationService.notify(prev_highest_user_id, 'bid_outbid', { item_name, new_highest: bid_amount })`
12. è¿”å›å‡ºä»·ç»“æœ

**å“åº”ï¼š**

```json
{
  "success": true,
  "data": {
    "bid_record_id": 156,
    "bid_product_id": 1,
    "bid_amount": 2400,
    "is_highest": true,
    "previous_highest": 2350,
    "remaining_available": 1100,
    "bid_count": 19,
    "message": "å‡ºä»·æˆåŠŸï¼Œæ‚¨å½“å‰ä¸ºæœ€é«˜å‡ºä»·è€…ï¼"
  }
}
```

**é”™è¯¯ç ï¼š**

| code | HTTP | è¯´æ˜ |
|------|------|------|
| `ASSET_NOT_ALLOWED` | 400 | è¯¥èµ„äº§ç±»å‹ä¸å…è®¸ç”¨äºç«ä»·ï¼ˆPOINTS/BUDGET_POINTS ç¦æ­¢ï¼Œè§å†³ç­–1ï¼‰ |
| `BID_TOO_LOW` | 400 | å‡ºä»·ä½äº current_price + min_bid_increment |
| `INSUFFICIENT_BALANCE` | 403 | èµ„äº§ä½™é¢ä¸è¶³ |
| `BID_NOT_ACTIVE` | 400 | ç«ä»·ä¸åœ¨è¿›è¡Œä¸­ |
| `SELF_OUTBID` | 409 | å·²æ˜¯æœ€é«˜å‡ºä»·è€… |
| `CONCURRENT_CONFLICT` | 409 | å¹¶å‘å†²çªï¼Œå»ºè®®é‡è¯• |
| `MISSING_IDEMPOTENCY_KEY` | 400 | ç¼ºå°‘å¹‚ç­‰é”® |

### 4.8 ã€æ–°å¢ã€‘GET /api/v4/backpack/bid/history

**è¯·æ±‚å‚æ•°ï¼š**

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `status` | string | `all` / `winning` / `outbid` / `ended` |
| `page` | int | é¡µç  |
| `page_size` | int | æ¯é¡µæ•°é‡ |

### 4.9 ã€æ–°å¢ã€‘GET /api/v4/backpack/bid/products/:bid_product_id

è¿”å›ç«ä»·è¯¦æƒ… + ç”¨æˆ·çš„å‡ºä»·è®°å½• + Top N å‡ºä»·æ’è¡Œã€‚

---

## 5. æœåŠ¡å±‚è®¾è®¡

### 5.1 æœåŠ¡æ‹†åˆ†æ–¹æ¡ˆï¼ˆéµå¾ªé¡¹ç›®å·²æœ‰çš„å¤§æ–‡ä»¶æ‹†åˆ†è§„èŒƒï¼‰

```
services/exchange/
â”œâ”€â”€ CoreService.js          # å·²æœ‰ â€” å…‘æ¢æ ¸å¿ƒæ“ä½œ
â”œâ”€â”€ QueryService.js         # å·²æœ‰ â€” æ‰©å±•ï¼šç©ºé—´ç­›é€‰/æœç´¢/ç»Ÿè®¡
â”œâ”€â”€ AdminService.js         # å·²æœ‰ â€” åå°ç®¡ç†æ“ä½œ
â”œâ”€â”€ index.js                # å·²æœ‰ â€” å…¥å£æ–‡ä»¶ï¼ˆå½“å‰å¯¼å‡º CoreService/QueryService/AdminServiceï¼‰
â”œâ”€â”€ BidService.js           # æ–°å¢ â€” ç«ä»·æ ¸å¿ƒï¼ˆå‡ºä»·/ç»“ç®—/å†»ç»“è§£å†»ï¼‰
â””â”€â”€ BidQueryService.js      # æ–°å¢ â€” ç«ä»·æŸ¥è¯¢ï¼ˆåˆ—è¡¨/è¯¦æƒ…/å†å²ï¼‰
```

### 5.2 ServiceManager æ³¨å†Œ

**æ­¥éª¤ A**ï¼šåœ¨ `services/exchange/index.js` ä¸­æ–°å¢å¯¼å‡ºï¼š

```javascript
// ç°æœ‰ï¼ˆå·²å­˜åœ¨ï¼‰
const CoreService = require('./CoreService')
const QueryService = require('./QueryService')
const AdminService = require('./AdminService')

// æ–°å¢
const BidService = require('./BidService')
const BidQueryService = require('./BidQueryService')

module.exports = {
  CoreService,
  QueryService,
  AdminService,
  BidService,          // æ–°å¢
  BidQueryService      // æ–°å¢
}
```

**æ­¥éª¤ B**ï¼šåœ¨ `services/index.js` ä¸­ï¼ˆçº¦L90å¤„ï¼Œ`require('./exchange')` è§£æ„åï¼‰æ–°å¢æ³¨å†Œï¼š

```javascript
// ç°æœ‰è§£æ„ï¼ˆL90-L94ï¼‰ï¼š
const {
  CoreService: ExchangeCoreService,
  QueryService: ExchangeQueryService,
  AdminService: ExchangeAdminService,
  BidService: ExchangeBidService,         // æ–°å¢
  BidQueryService: ExchangeBidQueryService // æ–°å¢
} = require('./exchange')

// åœ¨ ServiceManager registerServices() ä¸­æ–°å¢ï¼ˆçº¦L400+ï¼‰ï¼š
// exchange_bid_core  â†’ ExchangeBidService
// exchange_bid_query â†’ ExchangeBidQueryService
```

### 5.3 BidService æ ¸å¿ƒæ–¹æ³•è®¾è®¡

| æ–¹æ³• | è¯´æ˜ | äº‹åŠ¡è¦æ±‚ |
|------|------|---------|
| `placeBid(user_id, bid_product_id, bid_amount, options)` | æäº¤å‡ºä»·ï¼ˆ**æ ¡éªŒèµ„äº§ç™½åå•** â†’ å†»ç»“èµ„äº§ + è®°å½•ï¼‰ | âœ… å¤–éƒ¨äº‹åŠ¡ |
| `settleBidProduct(bid_product_id, options)` | ç»“ç®—ç«ä»·ï¼ˆä¸­æ ‡è€…æ‰£é™¤å†»ç»“ + è½é€‰è€…è§£å†» + **åˆ›å»º ExchangeRecord + ItemInstance å…¥èƒŒåŒ… + stockæ‰£å‡**ï¼Œè§å†³ç­–13ï¼‰ | âœ… å¤–éƒ¨äº‹åŠ¡ |
| `cancelBidProduct(bid_product_id, reason, options)` | å–æ¶ˆç«ä»·ï¼ˆå…¨éƒ¨è§£å†»ï¼‰ | âœ… å¤–éƒ¨äº‹åŠ¡ |

**ç«ä»·èµ„äº§ç™½åå•ï¼ˆå†³ç­–1 + å†³ç­–9 â€” åŠ¨æ€æŸ¥è¯¢ï¼‰ï¼š**

```javascript
// BidService å†…éƒ¨
const BID_FORBIDDEN_ASSETS = ['POINTS', 'BUDGET_POINTS']  // ç»å¯¹ç¦æ­¢ï¼ˆç¡¬ç¼–ç ï¼Œä¸ä¾èµ–æ•°æ®åº“ï¼‰

// åŠ¨æ€ç™½åå•æ–¹æ³•ï¼ˆç¼“å­˜ 5 åˆ†é’Ÿï¼‰
async _getAllowedBidAssets() {
  // SELECT asset_code FROM material_asset_types
  // WHERE is_tradable = 1 AND asset_code NOT IN ('POINTS', 'BUDGET_POINTS')
  // ç»“æœç¼“å­˜åˆ° Redis/å†…å­˜ï¼ŒTTL = 5min
}
```

`placeBid()` ç¬¬ä¸€æ­¥ï¼š
1. æ£€æŸ¥ `price_asset_code` ä¸åœ¨ `BID_FORBIDDEN_ASSETS` ä¸­ï¼ˆç¡¬ç¼–ç é»‘åå•ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼‰ã€‚
2. æ£€æŸ¥ `price_asset_code` åœ¨ `_getAllowedBidAssets()` è¿”å›çš„åŠ¨æ€ç™½åå•ä¸­ã€‚
3. ä»»ä¸€ä¸é€šè¿‡è¿”å› `ASSET_NOT_ALLOWED` é”™è¯¯ã€‚

**å†»ç»“/è§£å†»æµç¨‹ï¼ˆå¤ç”¨ BalanceService å·²æœ‰æ–¹æ³•ï¼‰ï¼š**

> âœ… å·²ç¡®è®¤ `BalanceService` æä¾› `freeze(params, options)`ã€`unfreeze(params, options)`ã€`settleFromFrozen(params, options)` ä¸‰ä¸ªç‹¬ç«‹æ–¹æ³•ï¼ˆL451/L638/L825ï¼‰ï¼Œç›´æ¥å¤ç”¨ï¼Œæ— éœ€æ‰©å±•ã€‚
> âš ï¸ å‚æ•°è¯´æ˜ï¼š`user_id` å’Œ `system_code` äºŒé€‰ä¸€ï¼ˆç«ä»·åœºæ™¯ä½¿ç”¨ `user_id`ï¼‰ï¼Œ`business_type` å’Œ `idempotency_key` ä¸ºå¿…å¡«å‚æ•°ï¼Œ`meta` ä¸ºå¯é€‰ JSON æ‰©å±•ä¿¡æ¯ã€‚

```
å‡ºä»·æ—¶ï¼ˆå†»ç»“æ–°å‡ºä»·é‡‘é¢ï¼‰ï¼š
  BalanceService.freeze({
    user_id, asset_code: price_asset_code,
    amount: bid_amount,
    business_type: 'bid_freeze',
    idempotency_key: `bid_freeze_${bid_record_id}`,
    meta: { reference_type: 'bid_record', reference_id: bid_record_id }
  }, { transaction })

ä¹‹å‰å‡ºä»·çš„è§£å†»ï¼ˆå¦‚æœç”¨æˆ·ä¹‹å‰æœ‰å‡ºä»·ï¼‰ï¼š
  BalanceService.unfreeze({
    user_id, asset_code: price_asset_code,
    amount: previous_amount,
    business_type: 'bid_unfreeze',
    idempotency_key: `bid_unfreeze_${previous_bid_record_id}`,
    meta: { reference_type: 'bid_record', reference_id: previous_bid_record_id }
  }, { transaction })

ç»“ç®—ä¸­æ ‡è€…ï¼ˆä»å†»ç»“ä¸­æ‰£é™¤ï¼Œå†»ç»“â†’å·²æ¶ˆè´¹ï¼‰ï¼š
  BalanceService.settleFromFrozen({
    user_id: winner_id, asset_code: price_asset_code,
    amount: winning_amount,
    business_type: 'bid_settle_winner',
    idempotency_key: `bid_settle_winner_${bid_product_id}`,
    meta: { reference_type: 'bid_product', reference_id: bid_product_id }
  }, { transaction })

ä¸­æ ‡è€…å•†å“å…¥èƒŒåŒ…ï¼ˆå†³ç­–5ï¼‰ï¼š
  ExchangeRecord.create({
    user_id: winner_id,
    exchange_item_id,
    source: 'bid',                     // æ ‡è¯†æ¥æºä¸ºç«ä»·ï¼ˆå†³ç­–10ï¼‰
    status: 'completed',
    pay_asset_code: price_asset_code,
    pay_amount: winning_amount,
    business_id: `bid_settle_${bid_product_id}`
  }, { transaction })

  // ä¸­æ ‡å•†å“è¿›èƒŒåŒ…ï¼ˆå†³ç­–7ï¼šmeta å¿«ç…§æ–¹å¼ï¼Œä¸ä¾èµ–æ¨¡æ¿ï¼‰
  ItemInstance.create({
    owner_user_id: winner_id,
    item_type: 'product',
    item_template_id: null,            // product ç±»å‹ä¸å…³è”æ¨¡æ¿
    source: 'bid_settlement',          // æ¥æºæ ‡è¯†ï¼ˆå†³ç­–10ï¼‰
    status: 'available',
    meta: {
      source: 'bid_settlement',
      bid_product_id, exchange_item_id,
      item_name, description, primary_image_id, category,
      original_cost_asset_code, original_cost_amount,
      bid_winning_amount, bid_asset_code,
      settled_at: BeijingTime.now()
    }
  }, { transaction })

  // æ‰£å‡åº“å­˜ï¼ˆå†³ç­–13ï¼šç«ä»·ä¸­æ ‡ = æ¶ˆè€—ä¸€ä¸ªåº“å­˜ï¼‰
  ExchangeItem.update({
    stock: sequelize.literal('stock - 1'),
    sold_count: sequelize.literal('sold_count + 1')
  }, {
    where: { exchange_item_id, stock: { [Op.gt]: 0 } },  // ä¹è§‚é”é˜²è¶…å–
    transaction
  })
  // å¦‚æœ affected rows = 0ï¼Œè¯´æ˜åº“å­˜å·²è¢«æ™®é€šå…‘æ¢æ¶ˆè€—å®Œï¼ŒæŠ›å‡º INSUFFICIENT_STOCK é”™è¯¯

  // é€šçŸ¥ä¸­æ ‡è€…ï¼ˆå†³ç­–8ï¼‰
  NotificationService.notify(winner_id, 'bid_won', { item_name, bid_winning_amount })

ç»“ç®—è½é€‰è€…ï¼ˆè§£å†»è¿”è¿˜ï¼‰ï¼š
  BalanceService.unfreeze({
    user_id: loser_id, asset_code: price_asset_code,
    amount: frozen_amount,
    business_type: 'bid_settle_refund',
    idempotency_key: `bid_settle_refund_${bid_record_id}`,
    meta: { reference_type: 'bid_record', reference_id: bid_record_id }
  }, { transaction })

  // é€šçŸ¥è½é€‰è€…ï¼ˆå†³ç­–8ï¼‰
  NotificationService.notify(loser_id, 'bid_lost', { item_name, refund_amount: frozen_amount })
```

### 5.4 å®šæ—¶ä»»åŠ¡ï¼ˆç«ä»·æ¿€æ´» + ç»“ç®— + æµæ‹ï¼‰

åœ¨ `jobs/` ç›®å½•æ–°å¢ç«ä»·å®šæ—¶ä»»åŠ¡ï¼Œä½¿ç”¨å·²æœ‰çš„ `node-cron` ä¾èµ–ï¼š

```
jobs/bidSettlementJob.js
```

æ‰§è¡Œé€»è¾‘ï¼ˆæ¯åˆ†é’Ÿæ‰§è¡Œï¼Œcron: `'* * * * *'`ï¼Œè§å†³ç­–6ï¼‰ï¼š

**é˜¶æ®µ A â€” pendingâ†’active è‡ªåŠ¨æ¿€æ´»ï¼ˆå†³ç­–15ï¼‰ï¼š**
1. æŸ¥è¯¢ `bid_products` ä¸­ `status = 'pending' AND start_time <= NOW()`
2. æ‰¹é‡æ›´æ–°ä¸º `status = 'active'`ï¼ˆæ— éœ€äº‹åŠ¡ï¼Œå¹‚ç­‰æ“ä½œï¼‰
3. è®°å½•æ—¥å¿—ï¼š`æ¿€æ´» N æ¡ç«ä»·å•†å“`

**é˜¶æ®µ B â€” åˆ°æœŸç«ä»·ç»“ç®— / æµæ‹ï¼š**
1. æŸ¥è¯¢ `bid_products` ä¸­ `status = 'active' AND end_time <= NOW()`ï¼Œ**æ¯æ¬¡æœ€å¤šå¤„ç† 10 æ¡**
2. é€æ¡åœ¨ `TransactionManager.execute()` äº‹åŠ¡ä¸­å¤„ç†ï¼š

   **åˆ†æ”¯ B1 â€” æœ‰å‡ºä»·ï¼ˆbid_count > 0ï¼‰â†’ æ­£å¸¸ç»“ç®—ï¼š**
   a. æ›´æ–° `bid_products.status = 'ended'`
   b. æŸ¥æ‰¾æœ€é«˜å‡ºä»·è®°å½• â†’ æ ‡è®° `is_final_winner = true`
   c. ä¸­æ ‡è€…ï¼šå†»ç»“èµ„äº§æ­£å¼æ‰£é™¤ï¼ˆ`BalanceService.settleFromFrozen()`ï¼‰
   d. è½é€‰è€…ï¼šå†»ç»“èµ„äº§å…¨éƒ¨è§£å†»è¿”è¿˜ï¼ˆ`BalanceService.unfreeze()`ï¼‰
   e. ä¸ºä¸­æ ‡è€…åˆ›å»º `ExchangeRecord`ï¼ˆ`source = 'bid'`, `status = 'completed'`ï¼Œè§å†³ç­–10ï¼‰
   f. åˆ›å»º `ItemInstance`ï¼ˆ`item_type = 'product'`, `meta` å­˜å•†å“å¿«ç…§ï¼Œè§å†³ç­–7ï¼‰â€” å•†å“è¿›å…¥ç”¨æˆ·èƒŒåŒ…
   g. æ‰£å‡åº“å­˜ `ExchangeItem.stock -= 1, sold_count += 1`ï¼ˆå†³ç­–13ï¼Œä¹è§‚é”é˜²è¶…å–ï¼‰
   h. æ›´æ–° `bid_products.status = 'settled'`ï¼Œå†™å…¥ `winner_user_id` å’Œ `winner_bid_id`
   i. é€šçŸ¥ä¸­æ ‡è€…ï¼ˆ`bid_won`ï¼‰å’Œæ‰€æœ‰è½é€‰è€…ï¼ˆ`bid_lost`ï¼‰ï¼Œæ¨é€åˆ°å…¬å‘Šï¼ˆè§å†³ç­–8ï¼‰

   **åˆ†æ”¯ B2 â€” æ— å‡ºä»·ï¼ˆbid_count = 0ï¼‰â†’ æµæ‹ï¼ˆå†³ç­–16ï¼‰ï¼š**
   a. æ›´æ–° `bid_products.status = 'no_bid'`ï¼ˆæµæ‹çŠ¶æ€ï¼‰
   b. ä¸åšä»»ä½•èµ„äº§/åº“å­˜æ“ä½œ
   c. è®°å½•æ—¥å¿—ï¼š`ç«ä»· #{bid_product_id} æµæ‹ï¼Œæ— äººå‡ºä»·`

3. ç»“ç®—å¤±è´¥çš„ç«ä»·æ ‡è®°ä¸º `settlement_failed`ï¼Œè®°å½•é”™è¯¯æ—¥å¿—ï¼Œä¸é˜»å¡å…¶ä»–ç«ä»·ç»“ç®—

---

## 6. è¿ç§»æ–‡ä»¶ä¸æ¨¡å‹å˜æ›´

### 6.1 ExchangeItem æ¨¡å‹å˜æ›´è¦ç‚¹

åœ¨ `models/ExchangeItem.js` çš„ `sequelize.define('ExchangeItem', {...})` ä¸­ï¼ˆL119 `sort_order` å®šä¹‰åã€`}` é—­åˆå‰ï¼‰ï¼Œæ–°å¢ **9 ä¸ª**å­—æ®µå®šä¹‰ï¼ˆä¸è¿ç§»æ–‡ä»¶å¯¹é½ï¼Œå†³ç­–12 å·²ç æ‰ `discount`/`rating`/`sales`/`seller_info`ï¼‰ï¼š

```javascript
// === ä»¥ä¸‹ä¸ºæ–°å¢å­—æ®µï¼ˆè‡»é€‰ç©ºé—´/å¹¸è¿ç©ºé—´/ç«ä»·åŠŸèƒ½éœ€æ±‚ï¼Œå…± 9 ä¸ª â€” å†³ç­–12ï¼‰ ===

// ç©ºé—´å½’å±ï¼ˆæ ¸å¿ƒä¸šåŠ¡å­—æ®µï¼‰
space: {
  type: DataTypes.ENUM('lucky', 'premium', 'both'),
  allowNull: false,
  defaultValue: 'lucky',
  comment: 'æ‰€å±ç©ºé—´ï¼šlucky=å¹¸è¿ç©ºé—´, premium=è‡»é€‰ç©ºé—´, both=ä¸¤è€…éƒ½å±•ç¤º'
},

// å±•ç¤ºä¿¡æ¯å¢å¼º
original_price: {
  type: DataTypes.BIGINT,
  allowNull: true,
  comment: 'åŸä»·ï¼ˆææ–™æ•°é‡ï¼‰ï¼Œç”¨äºå±•ç¤ºåˆ’çº¿ä»·å¯¹æ¯”'
},
tags: { type: DataTypes.JSON, allowNull: true, comment: 'å•†å“æ ‡ç­¾æ•°ç»„ï¼Œå¦‚ ["é™é‡","æ–°å“"]' },
is_new: { type: DataTypes.BOOLEAN, allowNull: false, defaultValue: false, comment: 'æ˜¯å¦æ–°å“' },
is_hot: { type: DataTypes.BOOLEAN, allowNull: false, defaultValue: false, comment: 'æ˜¯å¦çƒ­é—¨' },
is_lucky: { type: DataTypes.BOOLEAN, allowNull: false, defaultValue: false, comment: 'æ˜¯å¦å¹¸è¿å•†å“ï¼ˆç‰¹æ®Šæ ‡è¯†ï¼‰' },
has_warranty: { type: DataTypes.BOOLEAN, allowNull: false, defaultValue: false, comment: 'æ˜¯å¦æœ‰è´¨ä¿' },
free_shipping: { type: DataTypes.BOOLEAN, allowNull: false, defaultValue: false, comment: 'æ˜¯å¦åŒ…é‚®' },
sell_point: { type: DataTypes.STRING(200), allowNull: true, comment: 'è¥é”€å–ç‚¹æ–‡æ¡ˆ' }

// âŒ å·²ç æ‰ï¼ˆå†³ç­–12ï¼‰ï¼šdiscountï¼ˆå‰ç«¯ç®—ï¼‰ã€ratingï¼ˆæ— è¯„ä»·ç³»ç»Ÿï¼‰ã€salesï¼ˆå¤ç”¨sold_countï¼‰ã€seller_infoï¼ˆè‡ªè¥éå¤šå•†å®¶ï¼‰
```

åŒæ—¶åœ¨ `indexes` æ•°ç»„ï¼ˆL127ï¼‰ä¸­è¿½åŠ ï¼š

```javascript
{ fields: ['space'], name: 'idx_space' },
{ fields: ['space', 'status'], name: 'idx_space_status' }
```

### 6.2 æ–°å¢ BidProduct æ¨¡å‹

`models/BidProduct.js` â€” éµå¾ª `ExchangeItem.js` function æ¨¡å¼ï¼ˆ`module.exports = sequelize => {...}`ï¼‰ï¼š

- ä¸»é”® `bid_product_id` (BIGINT, AUTO_INCREMENT)
- å¤–é”® `exchange_item_id` â†’ `exchange_items`ï¼Œ`winner_user_id` â†’ `users`ï¼Œ`created_by` â†’ `users`
- `associate()` æ–¹æ³•å®šä¹‰å…³è”ï¼š`BidProduct.belongsTo(models.ExchangeItem)` + `BidProduct.hasMany(models.BidRecord)`
- `status` ENUM('pending','active','ended','cancelled','settled','settlement_failed','no_bid')ï¼ˆ7 æ€ï¼Œè§å†³ç­–15/16ï¼‰
- `underscored: true`, `timestamps: true`, `tableName: 'bid_products'`

### 6.3 æ–°å¢ BidRecord æ¨¡å‹

`models/BidRecord.js` â€” function æ¨¡å¼ï¼š

- ä¸»é”® `bid_record_id` (BIGINT, AUTO_INCREMENT)
- å¤–é”® `bid_product_id` â†’ `bid_products`ï¼Œ`user_id` â†’ `users`
- `idempotency_key` VARCHAR(100) UNIQUE NOT NULL â€” å¹‚ç­‰æ§åˆ¶
- `associate()` æ–¹æ³•ï¼š`BidRecord.belongsTo(models.BidProduct)` + `BidRecord.belongsTo(models.User)`
- ç´¢å¼•ï¼š`(bid_product_id, bid_amount DESC)`, `(user_id, bid_product_id)`, `(idempotency_key)` UNIQUE

### 6.4 models/index.js æ³¨å†Œ

`models/index.js` ä½¿ç”¨**æ‰‹åŠ¨ require** æ¨¡å¼ï¼ˆéè‡ªåŠ¨æ‰«æï¼‰ï¼Œæ¯ä¸ªæ¨¡å‹éœ€è¦æ˜¾å¼å¯¼å…¥å’Œæ³¨å†Œã€‚éœ€åœ¨é€‚å½“ä½ç½®ï¼ˆå»ºè®®åœ¨å…‘æ¢ç›¸å…³æ¨¡å‹é™„è¿‘ï¼‰æ–°å¢ï¼š

```javascript
// ğŸ”´ ç«ä»·ç³»ç»Ÿæ¨¡å‹ï¼ˆè‡»é€‰ç©ºé—´/å¹¸è¿ç©ºé—´/ç«ä»·åŠŸèƒ½ï¼‰
models.BidProduct = require('./BidProduct')(sequelize, DataTypes)
/*
 * âœ… BidProductï¼šç«ä»·å•†å“è¡¨
 *    - ç”¨é€”ï¼šç®¡ç†ç«ä»·æ´»åŠ¨ï¼ˆå…³è” exchange_itemsï¼Œå«çŠ¶æ€æœº + æ—¶é—´æ§åˆ¶ï¼‰
 *    - ç‰¹ç‚¹ï¼š7æ€çŠ¶æ€æœºï¼ˆpending/active/ended/cancelled/settled/settlement_failed/no_bidï¼Œè§å†³ç­–15/16ï¼‰
 *    - è¡¨åï¼šbid_productsï¼Œä¸»é”®ï¼šbid_product_id
 */

models.BidRecord = require('./BidRecord')(sequelize, DataTypes)
/*
 * âœ… BidRecordï¼šç«ä»·å‡ºä»·è®°å½•è¡¨
 *    - ç”¨é€”ï¼šè®°å½•ç”¨æˆ·å‡ºä»·ï¼ˆå«å†»ç»“æµæ°´å¯¹è´¦ã€å¹‚ç­‰æ€§æ§åˆ¶ï¼‰
 *    - ç‰¹ç‚¹ï¼šidempotency_key UNIQUEã€is_winning æ ‡è®°å½“å‰æœ€é«˜å‡ºä»·
 *    - è¡¨åï¼šbid_recordsï¼Œä¸»é”®ï¼šbid_record_id
 */
```

å¹¶ç¡®ä¿åœ¨ `associate()` å¾ªç¯ä¸­ï¼ˆ`models/index.js` åº•éƒ¨ï¼‰æ–°æ¨¡å‹çš„å…³è”èƒ½è¢«æ­£ç¡®è°ƒç”¨ã€‚

---

## 7. æ‰§è¡Œæ­¥éª¤ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰

> è¿ç§»æ–‡ä»¶ç¼–å·åŸºäºå½“å‰æœ€æ–°è¿ç§» `20260215100000` é€’å¢ã€‚
> `npm run db:migrate` æ‰§è¡Œå‰ä¼šè‡ªåŠ¨è¿è¡Œ `prestart` â†’ `npm run migration:verify` æ ¡éªŒã€‚

### Phase 1 â€” P0ï¼šå¹¸è¿/è‡»é€‰ç©ºé—´åŸºç¡€ + é«˜çº§ç©ºé—´è¿ç§»ï¼ˆé¢„ä¼° 2 å¤©ï¼‰

| æ­¥éª¤ | ä»»åŠ¡ | æ¶‰åŠæ–‡ä»¶ | å…·ä½“æ“ä½œ |
|------|------|---------|---------|
| 1.1 | åˆ›å»ºè¿ç§»æ–‡ä»¶ï¼š`exchange_items` æ–°å¢ 9 ä¸ªå­—æ®µ + 2 ä¸ªç´¢å¼•ï¼ˆå†³ç­–12ï¼‰ | `migrations/20260216000001-add-space-and-display-fields-to-exchange-items.js` | è§ Â§3.1 DDL |
| 1.2 | æ‰§è¡Œè¿ç§»ï¼Œå­˜é‡æ•°æ®å¡«å…… | `npm run db:migrate` | `space='lucky'`ï¼ˆ77æ¡ï¼‰, `sales=sold_count`ï¼ˆ77æ¡ï¼‰ |
| 1.3 | æ›´æ–° `ExchangeItem` æ¨¡å‹ | `models/ExchangeItem.js`ï¼ˆåœ¨ L119 `sort_order` å®šä¹‰åè¿½åŠ  9 ä¸ªå­—æ®µï¼Œå†³ç­–12ï¼‰ | è§ Â§6.1 å­—æ®µå®šä¹‰ |
| 1.4 | æ‰©å±• `getMarketItems()` | `services/exchange/QueryService.js`ï¼ˆL140 `getMarketItems` æ–¹æ³•å†…ï¼‰ | æ–°å¢å‚æ•°ï¼š`space`/`keyword`/`min_cost`/`max_cost`/`sort_by`æ‰©å±•/`stock_status`ï¼›`where` æ¡ä»¶æ„å»º |
| 1.5 | æ–°å¢ `getSpaceStats(space)` | `services/exchange/QueryService.js`ï¼ˆæ–°å¢æ–¹æ³•ï¼‰ | `SELECT space, COUNT(*)... GROUP BY space` èšåˆæŸ¥è¯¢ |
| 1.6 | æ›´æ–° `marketItemView` å¸¸é‡ | `services/exchange/QueryService.js`ï¼ˆL36 `marketItemView` æ•°ç»„ï¼‰ | è¿½åŠ  9 ä¸ªå­—æ®µï¼ˆå†³ç­–12ï¼‰ï¼š`'space', 'original_price', 'tags', 'is_new', 'is_hot', 'is_lucky', 'has_warranty', 'free_shipping', 'sell_point'` |
| 1.7 | æ‰©å±• `GET /items` è·¯ç”± | `routes/v4/backpack/exchange.js`ï¼ˆL64 `router.get('/items', ...)` å†…ï¼‰ | ä» `req.query` è§£æ„æ–°å¢å‚æ•°ï¼Œä¼ å…¥ `ExchangeQueryService.getMarketItems()` |
| 1.8 | æ–°å¢ `GET /space-stats` è·¯ç”± | `routes/v4/backpack/exchange.js`ï¼ˆæ–°å¢è·¯ç”±å—ï¼‰ | è°ƒç”¨ `ExchangeQueryService.getSpaceStats(space)` |
| 1.9 | æ–°å¢ `GET /premium-status` è·¯ç”± | `routes/v4/backpack/exchange.js`ï¼ˆæ–°å¢è·¯ç”±å—ï¼‰ | `const PremiumService = req.app.locals.services.getService('premium')` â†’ `PremiumService.getPremiumStatus(user_id)` |
| 1.10 | æ–°å¢ `POST /unlock-premium` è·¯ç”± | `routes/v4/backpack/exchange.js`ï¼ˆæ–°å¢è·¯ç”±å—ï¼‰ | `TransactionManager.execute(async t => PremiumService.unlockPremium(user_id, {transaction: t}))` |
| 1.11 | DataSanitizer æ›´æ–° | `services/DataSanitizer.js` | â‘  æ–°å­—æ®µåŠ å…¥ `sanitizeExchangeMarketItems()` è„±æ•æ–¹æ³• â‘¡ `BUDGET_POINTS` åŠ å…¥å…¨å±€æ•æ„Ÿå­—æ®µé»‘åå•ï¼ˆæ‰€æœ‰é¢å‘å‰ç«¯çš„å“åº”è‡ªåŠ¨è¿‡æ»¤ï¼‰ |
| 1.12 | åˆ é™¤æ—§ premium è·¯ç”± | `routes/v4/shop/premium.js`ï¼ˆåˆ é™¤æ•´ä¸ªæ–‡ä»¶ï¼‰ + `routes/v4/shop/index.js`ï¼ˆåˆ é™¤ L57 `require('./premium')` + L95 `router.use('/premium', ...)` ä¸¤è¡Œï¼‰ | åŒæ—¶ç¡®è®¤ `services/index.js` ä¸­ `premium` æœåŠ¡é”®ä¸å—å½±å“ï¼ˆä»æ³¨å†Œåœ¨ ServiceManagerï¼‰ |

### Phase 2 â€” P1ï¼šç«ä»·æ ¸å¿ƒåŠŸèƒ½ï¼ˆé¢„ä¼° 3 å¤©ï¼‰

| æ­¥éª¤ | ä»»åŠ¡ | æ¶‰åŠæ–‡ä»¶ | å…·ä½“æ“ä½œ |
|------|------|---------|---------|
| 2.1 | åˆ›å»ºè¿ç§»ï¼š`bid_products` å»ºè¡¨ | `migrations/20260216000002-create-bid-products.js` | è§ Â§3.2 è¡¨ç»“æ„ï¼Œå« `batch_no` å­—æ®µï¼ˆå†³ç­–11ï¼‰ |
| 2.2 | åˆ›å»ºè¿ç§»ï¼š`bid_records` å»ºè¡¨ | `migrations/20260216000003-create-bid-records.js` | è§ Â§3.3 è¡¨ç»“æ„ |
| 2.3 | åˆ›å»ºè¿ç§»ï¼š`source` å­—æ®µ | `migrations/20260216000004-add-source-to-exchange-records-and-item-instances.js` | è§ Â§3.4ï¼Œ`exchange_records` + `item_instances` å„æ–°å¢ `source` åˆ—ï¼ˆå†³ç­–10ï¼‰ |
| 2.4 | æ‰§è¡Œå…¨éƒ¨è¿ç§» | `npm run db:migrate` | ä¸€æ¬¡æ€§æ‰§è¡Œ 4 ä¸ªè¿ç§»æ–‡ä»¶ |
| 2.5 | æ–°å¢ `BidProduct` æ¨¡å‹ | `models/BidProduct.js` | functionæ¨¡å¼ï¼ˆå‚è€ƒ ExchangeItem.jsï¼‰ï¼Œ`define('BidProduct', {...})`, `associate()` å®šä¹‰å¤–é”® |
| 2.6 | æ–°å¢ `BidRecord` æ¨¡å‹ | `models/BidRecord.js` | functionæ¨¡å¼ï¼Œ`idempotency_key` UNIQUEçº¦æŸ |
| 2.7 | æ›´æ–° `ExchangeRecord` æ¨¡å‹ | `models/ExchangeRecord.js`ï¼ˆåœ¨ L177 `shipped_at` åè¿½åŠ  `source` å­—æ®µå®šä¹‰ï¼‰ | `source: { type: DataTypes.STRING(20), allowNull: false, defaultValue: 'exchange' }` |
| 2.8 | æ›´æ–° `ItemInstance` æ¨¡å‹ | `models/ItemInstance.js`ï¼ˆåœ¨ L526 `updated_at` å‰è¿½åŠ  `source` å­—æ®µå®šä¹‰ï¼‰ | âš ï¸ æ³¨æ„ï¼šItemInstance ä½¿ç”¨ Class ç»§æ‰¿ Model çš„æ¨¡å¼ï¼ˆé functionï¼‰ï¼Œéœ€åœ¨ `ItemInstance.init({...})` çš„å­—æ®µå¯¹è±¡ä¸­æ·»åŠ  |
| 2.9 | æ³¨å†Œæ¨¡å‹ | `models/index.js` | æ–°å¢ `require('./BidProduct')` + `require('./BidRecord')` å¯¼å…¥è¡Œ |
| 2.10 | æ–°å¢ `BidService.js` | `services/exchange/BidService.js` | ç«ä»·æ ¸å¿ƒï¼š`placeBid()` + `_getAllowedBidAssets()` åŠ¨æ€ç™½åå• + `BID_FORBIDDEN_ASSETS` ç¡¬ç¼–ç é»‘åå• |
| 2.11 | æ–°å¢ `BidQueryService.js` | `services/exchange/BidQueryService.js` | ç«ä»·æŸ¥è¯¢ï¼šåˆ—è¡¨/è¯¦æƒ…/å†å²ï¼Œè§†å›¾å¸¸é‡ `BID_ATTRIBUTES` |
| 2.12 | æ³¨å†ŒæœåŠ¡ | `services/exchange/index.js`ï¼ˆè¿½åŠ å¯¼å‡ºï¼‰ + `services/index.js`ï¼ˆè¿½åŠ è§£æ„ + registerServicesï¼‰ | æœåŠ¡é”®ï¼š`exchange_bid_core` + `exchange_bid_query` |
| 2.13 | æ–°å¢ç«ä»·è·¯ç”± | `routes/v4/backpack/bid.js` | 4ä¸ªç«¯ç‚¹ï¼š`GET /products`, `GET /products/:bid_product_id`, `POST /`, `GET /history` |
| 2.14 | æŒ‚è½½å­è·¯ç”± | `routes/v4/backpack/index.js`ï¼ˆåœ¨ L372 `router.use('/exchange', exchangeRoutes)` åè¿½åŠ ï¼‰ | `const bidRoutes = require('./bid'); router.use('/bid', bidRoutes)` |

### Phase 3 â€” P2ï¼šç«ä»·ç»“ç®— + é€šçŸ¥ + ç®¡ç†åå°ï¼ˆé¢„ä¼° 2 å¤©ï¼‰

| æ­¥éª¤ | ä»»åŠ¡ | æ¶‰åŠæ–‡ä»¶ | å…·ä½“æ“ä½œ |
|------|------|---------|---------|
| 3.1 | ç»“ç®—æ–¹æ³•å®ç° | `services/exchange/BidService.js` | `settleBidProduct(bid_product_id, options)` â€” äº‹åŠ¡å†…æ‰§è¡Œï¼šå†»ç»“æ‰£é™¤ + è½é€‰è§£å†» + åˆ›å»º ExchangeRecord(`source='bid'`) + åˆ›å»º ItemInstance(`meta`å¿«ç…§) + **stockæ‰£å‡ï¼ˆå†³ç­–13ï¼‰** + é€šçŸ¥ï¼ˆå†³ç­–5/7/8/10ï¼‰ï¼›é›¶å‡ºä»·â†’`no_bid`æµæ‹ï¼ˆå†³ç­–16ï¼‰ |
| 3.2 | å–æ¶ˆæ–¹æ³•å®ç° | `services/exchange/BidService.js` | `cancelBidProduct(bid_product_id, reason, options)` â€” å…¨éƒ¨å‡ºä»·è€…è§£å†»è¿”è¿˜ + çŠ¶æ€æ”¹ `cancelled` |
| 3.3 | èƒŒåŒ…å…¥åº“ç§æœ‰æ–¹æ³• | `services/exchange/BidService.js` | `_createBidSettlementItem(winner_id, exchangeItem, bidProduct, options)` â€” `ItemInstance.create({item_type:'product', item_template_id:null, source:'bid_settlement', meta:{...å¿«ç…§}})` |
| 3.4 | é€šçŸ¥ç±»å‹æ‰©å±• | `services/NotificationService.js` | æ–°å¢ `bid_outbid`/`bid_won`/`bid_lost` ç±»å‹çš„æ¶ˆæ¯æ¨¡æ¿å’Œè°ƒç”¨å…¥å£ |
| 3.5 | å®šæ—¶ä»»åŠ¡æ–°å¢ | `jobs/bidSettlementJob.js` | `node-cron` æ¯åˆ†é’Ÿï¼ˆ`'* * * * *'`ï¼‰ï¼š**é˜¶æ®µA** pendingâ†’active è‡ªåŠ¨æ¿€æ´»ï¼ˆå†³ç­–15ï¼‰â†’ **é˜¶æ®µB** åˆ°æœŸç«ä»·ç»“ç®—ï¼ˆæœ‰å‡ºä»·â†’settled + stockæ‰£å‡ï¼Œé›¶å‡ºä»·â†’no_bid æµæ‹ï¼Œå†³ç­–16ï¼‰â†’ å¤±è´¥æ ‡è®° `settlement_failed`ã€‚å‚è€ƒ `jobs/daily-asset-reconciliation.js` ä»»åŠ¡å®ç°æ¨¡å¼ |
| 3.6 | æ³¨å†Œå®šæ—¶ä»»åŠ¡ | `scripts/maintenance/scheduled_tasks.js`ï¼ˆé›†ä¸­ç®¡ç†æ‰€æœ‰å®šæ—¶ä»»åŠ¡ï¼‰ | åœ¨ `initialize()` æ–¹æ³•ä¸­æ–°å¢ç«ä»·ç»“ç®—ä»»åŠ¡æ³¨å†Œï¼š`cron.schedule('* * * * *', bidSettlementJob.execute)`ã€‚å½“å‰æ–‡ä»¶çº¦3340è¡Œï¼Œæ–°å¢ Task 31 |
| 3.7 | ç®¡ç†åå°ç«ä»·æ¥å£ | `routes/v4/console/`ï¼ˆæ–°å¢ç«ä»·ç®¡ç†è·¯ç”±ï¼‰ | åˆ›å»ºç«ä»·ï¼ˆå«ä¸€ç‰©ä¸€æ‹æ ¡éªŒï¼Œå†³ç­–11ï¼‰ã€æŸ¥çœ‹ç«ä»·åˆ—è¡¨ã€æ‰‹åŠ¨ç»“ç®—/å–æ¶ˆ |
| 3.8 | AdminService æ‰©å±• | `services/exchange/AdminService.js` | æ–°å¢ `space` å­—æ®µçš„ç®¡ç†æ–¹æ³•ï¼ˆæ‰¹é‡è®¾ç½®ç©ºé—´ã€æŸ¥è¯¢ç©ºé—´åˆ†å¸ƒç­‰ï¼‰ |

---

## 8. å…³é”®æŠ€æœ¯å†³ç­–æ€»ç»“

| å†³ç­– | ç†ç”± | å†³ç­–æ¥æº |
|------|------|---------|
| **ç¦æ­¢ POINTS/BUDGET_POINTS ç«ä»·** | BUDGET_POINTS ä¸ºç³»ç»Ÿå†…éƒ¨èµ„äº§ï¼Œç»å¯¹ä¸å¯æš´éœ²ç»™å‰ç«¯ï¼›POINTS ä¿ç•™ç”¨äºé«˜çº§ç©ºé—´è§£é”ç­‰æ ¸å¿ƒæ¶ˆè´¹ | äº§å“æ‹æ¿ï¼ˆå†³ç­–1ï¼‰ |
| **BUDGET_POINTS å…¨å±€å‰ç«¯é»‘åå•** | ä»»ä½•é¢å‘å‰ç«¯çš„ API å“åº”ä¸­ç¦æ­¢å‡ºç° BUDGET_POINTS å­—æ®µä¿¡æ¯ | äº§å“æ‹æ¿ï¼ˆå†³ç­–1ï¼‰ |
| **é«˜çº§ç©ºé—´è·¯ç”±è¿ç§»åˆ° backpack åŸŸ** | ç»Ÿä¸€å…‘æ¢åŸŸè·¯ç”±ï¼ŒåºŸå¼ƒæ—§ `/shop/premium` è·¯å¾„ | äº§å“æ‹æ¿ï¼ˆå†³ç­–2ï¼‰ |
| **é«˜çº§ç©ºé—´å‚æ•°ï¼š100ç§¯åˆ†/24h/10ä¸‡é—¨æ§›** | ä»¥åç«¯ç°æœ‰æˆç†Ÿé…ç½®ä¸ºå‡†ï¼Œå‰ç«¯åŠ¨æ€é€‚é… | äº§å“æ‹æ¿ï¼ˆå†³ç­–3ï¼‰ |
| **77æ¡å•†å“å…¨éƒ¨é»˜è®¤å½’å…¥å¹¸è¿ç©ºé—´** | è‡»é€‰ç©ºé—´ç”±è¿è¥æ‰‹åŠ¨é…ç½®ï¼Œä¿æŒçµæ´»æ€§ | äº§å“æ‹æ¿ï¼ˆå†³ç­–4ï¼‰ |
| **ç«ä»·ä¸­æ ‡å•†å“æ”¾å…¥ç”¨æˆ·èƒŒåŒ…** | åˆ›å»º ExchangeRecord + ItemInstanceï¼Œèµ°ç°æœ‰èƒŒåŒ…ä½“ç³» | äº§å“æ‹æ¿ï¼ˆå†³ç­–5ï¼‰ |
| **ç«ä»·ç»“ç®—æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡** | ç²¾åº¦ Â±1 åˆ†é’Ÿï¼Œç®€å•å¯é ï¼Œæ¯æ¬¡æœ€å¤šå¤„ç† 10 æ¡ | äº§å“æ‹æ¿ï¼ˆå†³ç­–6ï¼‰ |
| **ä¸­æ ‡å•†å“ä»¥ meta å¿«ç…§æ–¹å¼è¿›èƒŒåŒ…** | ç°æœ‰ 1494 æ¡ product ç±»å‹å·²å…¨éƒ¨ç”¨ meta JSONï¼Œä¸ä¾èµ–æ¨¡æ¿ | äº§å“æ‹æ¿ï¼ˆå†³ç­–7ï¼‰ |
| **ç«ä»·é€šçŸ¥æ¨é€åˆ°å…¬å‘Šï¼ŒPhase 2 ä¸€èµ·åš** | è¢«è¶…ä»·/ä¸­æ ‡/è½é€‰ä¸‰ç§é€šçŸ¥ï¼Œå¤ç”¨ NotificationService | äº§å“æ‹æ¿ï¼ˆå†³ç­–8ï¼‰ |
| **ç«ä»·èµ„äº§ç™½åå•ä» material_asset_types åŠ¨æ€åŠ è½½** | æœªæ¥æ–°å¢èµ„äº§è‡ªåŠ¨çº³å…¥ï¼Œä¸éœ€è¦æ”¹ä»£ç  | äº§å“æ‹æ¿ï¼ˆå†³ç­–9ï¼‰ |
| **exchange_records å’Œ item_instances æ–°å¢ source å­—æ®µ** | æŸ¥è¯¢å¿«ï¼ˆç´¢å¼•å‹å¥½ï¼‰ã€ä»£ç æ¸…æ™°ã€SQL ç»Ÿè®¡æ–¹ä¾¿ | äº§å“æ‹æ¿ï¼ˆå†³ç­–10ï¼‰ |
| **ä¸€ç‰©ä¸€æ‹ + batch_no é¢„ç•™æ‰©å±•** | è¡Œä¸šä¸»æµï¼ˆeBay/é—²é±¼/æ¸¸æˆï¼‰ï¼Œé€‚åˆæœ‰é™å•†å“ç«ä»·åœºæ™¯ | äº§å“æ‹æ¿ï¼ˆå†³ç­–11ï¼‰ |
| **å¤ç”¨ `exchange_items` è¡¨ + æ–°å¢å­—æ®µ** | é¿å…æ–°å»ºè¡¨å¸¦æ¥çš„æ•°æ®è¿ç§»æˆæœ¬ï¼Œ`space` å­—æ®µç»Ÿä¸€åˆ†åŒº | æŠ€æœ¯å†³ç­– |
| **å¤ç”¨ `user_premium_status` + `PremiumService`** | å·²æœ‰å®Œæ•´çš„è§£é”/æŸ¥è¯¢/è¿‡æœŸé€»è¾‘ï¼Œä»£ç æˆç†Ÿåº¦é«˜ | æŠ€æœ¯å†³ç­– |
| **ç«ä»·èµ„äº§å†»ç»“è€Œéæ‰£é™¤** | å¤ç”¨ `AccountAssetBalance.frozen_amount` å·²æœ‰èƒ½åŠ› | æŠ€æœ¯å†³ç­– |
| **ç«ä»·ä½¿ç”¨ `price_asset_code` å­—æ®µ** | ä¿æŒçµæ´»æ€§ï¼Œæ”¯æŒ DIAMOND/red_shard/å…¶ä»–ææ–™èµ„äº§ç«ä»· | æŠ€æœ¯å†³ç­– |
| **`BidProduct.status` ä¸ƒæ€çŠ¶æ€æœº** | `pendingâ†’activeâ†’endedâ†’settled`ï¼ŒåŒºåˆ† `ended`ï¼ˆæ—¶é—´åˆ°æœŸï¼‰å’Œ `settled`ï¼ˆç»“ç®—å®Œæˆï¼‰ï¼Œå« `cancelled`ã€`settlement_failed`ã€`no_bid`ï¼ˆæµæ‹ï¼Œå†³ç­–16ï¼‰ | æŠ€æœ¯å†³ç­– |
| **å¹‚ç­‰é”® `idempotency_key` åœ¨ `bid_records`** | å¤ç”¨é¡¹ç›®å·²æœ‰çš„å¹‚ç­‰æ€§æ¶æ„ï¼Œé˜²æ­¢é‡å¤å‡ºä»· | æŠ€æœ¯å†³ç­– |
| **è·¯ç”±å½’å…¥ `/backpack` åŸŸ** | éµå¾ªé¡¹ç›®å·²æœ‰çš„åŸŸè¿ç§»å†³ç­–ï¼ˆå…‘æ¢=ç”¨æˆ·åŸŸï¼‰ | æŠ€æœ¯å†³ç­– |
| **ä¸å…¼å®¹æ—§æ¥å£ï¼Œä¸€æ­¥åˆ°ä½** | é¡¹ç›®æœªä¸Šçº¿ï¼Œå¯ä¸€æ¬¡æ€§æŠ•å…¥ï¼Œé™ä½é•¿æœŸç»´æŠ¤æˆæœ¬ | æŠ€æœ¯å†³ç­– |
| **`res.apiSuccess()` / `res.apiError()` ç»Ÿä¸€å“åº”** | éµå¾ªé¡¹ç›®å·²æœ‰çš„ `ApiResponse.middleware()` æ ‡å‡† | æŠ€æœ¯å†³ç­– |
| **äº‹åŠ¡ç»Ÿä¸€ç”± `TransactionManager.execute()` ç®¡ç†** | éµå¾ªé¡¹ç›®äº‹åŠ¡è¾¹ç•Œæ²»ç†å†³ç­– | æŠ€æœ¯å†³ç­– |

