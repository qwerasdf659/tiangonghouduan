# èµ„äº§åŸŸç»Ÿä¸€æ¶æ„å†³ç­–ä¸è¿ç§»æ–¹æ¡ˆ

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2025-12-29  
**çŠ¶æ€**: å¾…å®æ–½

---

## ä¸€ã€æ¶æ„å†³ç­–ï¼šé€‰æ‹©èµ„äº§åŸŸä½œä¸ºå”¯ä¸€çœŸç›¸æº

### 1.1 å½“å‰ç³»ç»Ÿç°çŠ¶åˆ†æ

#### åŒè½¨å¹¶å­˜é—®é¢˜

é¡¹ç›®ä¸­åŒæ—¶å­˜åœ¨ä¸¤å¥—ç§¯åˆ†/èµ„äº§ç®¡ç†ä½“ç³»ï¼š

**æ—§ç§¯åˆ†åŸŸæ¨¡å‹**ï¼š

- æ¨¡å‹ï¼š`UserPointsAccount`ã€`PointsTransaction`
- æœåŠ¡ï¼š`PointsService`
- è·¯ç”±ï¼š`/api/v4/lottery/user-points/*`
- å­—æ®µï¼š`available_points`ã€`frozen_points`ã€`budget_points`

**æ–°èµ„äº§åŸŸæ¨¡å‹**ï¼š

- æ¨¡å‹ï¼š`Account`ã€`AccountAssetBalance`ã€`AssetTransaction`
- æœåŠ¡ï¼š`AssetService`
- è·¯ç”±ï¼š`/api/v4/shop/assets/*`
- èµ„äº§ç±»å‹ï¼š`POINTS`ã€`DIAMOND`ã€ææ–™ç­‰

#### çœŸå®æ•°æ®åˆ†å‰è¯æ®ï¼ˆ2025-12-29 æ•°æ®åº“æŸ¥è¯¢ç»“æœï¼‰

```sql
-- èµ„äº§åŸŸ POINTS æ€»é¢
SELECT COUNT(*), SUM(available_amount)
FROM account_asset_balances WHERE asset_code='POINTS';
-- ç»“æœ: 6æ¡è®°å½•, æ€»é¢ 43,652

-- æ—§ç§¯åˆ†åŸŸæ€»é¢
SELECT COUNT(*), SUM(available_points)
FROM user_points_accounts;
-- ç»“æœ: 3æ¡è®°å½•, æ€»é¢ 13,000

-- ä¸¥é‡åˆ†å‰æ¡ˆä¾‹
user_id=31:
  - user_points_accounts.available_points = 10,000
  - account_asset_balances(POINTS).available_amount = 43,652
  - å·®å¼‚: -33,652 (è´¦å¯¹ä¸ä¸Š)
```

#### ä¸šåŠ¡é€»è¾‘æ··ä¹±

**æŠ½å¥–ç³»ç»Ÿå·²åœ¨ä½¿ç”¨èµ„äº§åŸŸ**ï¼š

- `BasicGuaranteeStrategy.js` â†’ `AssetService.changeBalance(asset_code='POINTS')`
- å®é™…æ‰£å‡/å‘æ”¾éƒ½èµ° `account_asset_balances`

**ä½†å‰ç«¯æŸ¥è¯¢ä»åœ¨è¯»æ—§è¡¨**ï¼š

- `/api/v4/lottery/user-points/:user_id` â†’ `UserService.getUserWithPoints()` â†’ `user_points_accounts`

**é¢„ç®—æ§åˆ¶ç¼ºå¤±**ï¼š

- `user_points_accounts.budget_points` å­—æ®µå­˜åœ¨ä½†æ— æ´»åŠ¨ç»´åº¦
- `account_asset_balances` å·²æœ‰ `campaign_id` å­—æ®µå’Œå”¯ä¸€ç´¢å¼•è®¾è®¡
- ä½†æ•°æ®åº“ä¸­ `BUDGET_POINTS` èµ„äº§ä¸ºç©ºï¼ˆæœªçœŸæ­£å¯ç”¨ï¼‰

### 1.2 æ¶æ„å†³ç­–ï¼šç»Ÿä¸€åˆ°èµ„äº§åŸŸ

#### æ ¸å¿ƒå†³ç­–

**æ‰€æœ‰ä½™é¢ç±»èµ„äº§ï¼ˆç§¯åˆ†ã€é¢„ç®—ã€é’»çŸ³ã€ææ–™ï¼‰ç»Ÿä¸€æ”¶å£åˆ°èµ„äº§åŸŸæ¨¡å‹**

#### å†³ç­–ç†ç”±

| ç»´åº¦             | èµ„äº§åŸŸä¼˜åŠ¿                                     | æ—§ç§¯åˆ†åŸŸé—®é¢˜                       |
| ---------------- | ---------------------------------------------- | ---------------------------------- |
| **çœŸç›¸æºä¸€è‡´æ€§** | å•ä¸€çœŸç›¸æº `account_asset_balances`            | åŒå†™åŒè¯»ï¼Œå·²å‡ºç°æ•°æ®åˆ†å‰           |
| **é¢„ç®—æ§åˆ¶**     | `BUDGET_POINTS` + `campaign_id` æ”¯æŒå¤šæ´»åŠ¨éš”ç¦» | `budget_points` å­—æ®µæ— æ´»åŠ¨ç»´åº¦     |
| **å®¡è®¡è¿½æº¯**     | `asset_transactions` ä¸å¯å˜æµæ°´ + å¹‚ç­‰é”®       | `points_transactions` ç¼ºå°‘å¹‚ç­‰æœºåˆ¶ |
| **ä¸šåŠ¡æ‰©å±•æ€§**   | ç»Ÿä¸€æ¨¡å‹æ”¯æŒé’»çŸ³/ææ–™/æœªæ¥èµ„äº§                 | ä»…æ”¯æŒç§¯åˆ†ï¼Œæ‰©å±•éœ€é‡å¤å»ºè¡¨         |
| **å½“å‰ä½¿ç”¨æƒ…å†µ** | æŠ½å¥–æ ¸å¿ƒé€»è¾‘å·²åœ¨ä½¿ç”¨                           | ä»…å‰ç«¯æŸ¥è¯¢æ¥å£åœ¨ç”¨                 |

#### ä¸šç•Œå¯¹æ ‡

**å¤§å‚/æ¸¸æˆ/äº¤æ˜“å¹³å°é€šç”¨æ¨¡å¼**ï¼š

- **ç»Ÿä¸€è´¦æˆ·ä½™é¢è¡¨**ï¼šæŒ‰ `(account, asset_code, dimension)` å­˜å‚¨æ‰€æœ‰ä½™é¢
- **ä¸å¯å˜æµæ°´è¡¨**ï¼šå¹‚ç­‰é”® + before/after + ä¸šåŠ¡ç±»å‹
- **é¢„ç®—/æ´»åŠ¨æ§åˆ¶**ï¼šç‹¬ç«‹èµ„äº§ç±»å‹æˆ–å¹³å°è´¦æˆ·ï¼ˆåŒä¸€å¥—è´¦æœ¬æ¨¡å‹ï¼‰

ä½ çš„èµ„äº§åŸŸè®¾è®¡ï¼ˆ`accounts`/`account_asset_balances`/`asset_transactions`/å¹‚ç­‰é”®ï¼‰ç¬¦åˆä¸»æµæœ€ä½³å®è·µã€‚

---

## äºŒã€ç›®æ ‡æ¶æ„è®¾è®¡

### 2.1 èµ„äº§ç±»å‹å®šä¹‰

```javascript
// èµ„äº§åŸŸç»Ÿä¸€ç®¡ç†çš„èµ„äº§ç±»å‹
const ASSET_TYPES = {
  POINTS: {
    code: 'POINTS',
    name: 'ç”¨æˆ·å¯è§ç§¯åˆ†',
    campaign_id: null,  // ç”¨æˆ·å…¨å±€ç§¯åˆ†ä¸ç»‘å®šæ´»åŠ¨
    description: 'ç”¨æˆ·é€šè¿‡æŠ½å¥–ã€ä»»åŠ¡ç­‰è·å¾—çš„å¯æ¶ˆè´¹ç§¯åˆ†'
  },

  BUDGET_POINTS: {
    code: 'BUDGET_POINTS',
    name: 'æ´»åŠ¨é¢„ç®—ç§¯åˆ†',
    campaign_id: 'required',  // å¿…é¡»ç»‘å®šå…·ä½“æ´»åŠ¨
    description: 'è¿è¥ä¸ºç‰¹å®šæ´»åŠ¨åˆ†é…çš„é¢„ç®—ï¼Œç”¨äºæ§åˆ¶å‘å¥–æˆæœ¬'
  },

  DIAMOND: {
    code: 'DIAMOND',
    name: 'é’»çŸ³',
    campaign_id: null,
    description: 'é«˜çº§è´§å¸ï¼Œå¯å…‘æ¢ç¨€æœ‰ç‰©å“'
  },

  // ææ–™èµ„äº§ï¼ˆå¯å åŠ ï¼‰
  MATERIAL_*: {
    code: 'MATERIAL_<asset_id>',
    name: 'ææ–™åç§°',
    campaign_id: null,
    description: 'å¯å åŠ çš„ææ–™èµ„äº§'
  }
};
```

### 2.2 æ•°æ®æ¨¡å‹

#### æ ¸å¿ƒè¡¨ç»“æ„

**accountsï¼ˆè´¦æˆ·ä¸»è¡¨ï¼‰**

```sql
CREATE TABLE accounts (
  account_id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT UNIQUE,  -- ç”¨æˆ·è´¦æˆ·
  account_type ENUM('user', 'system', 'campaign') DEFAULT 'user',
  status ENUM('active', 'frozen', 'closed') DEFAULT 'active',
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

**account_asset_balancesï¼ˆä½™é¢è¡¨ - å”¯ä¸€çœŸç›¸æºï¼‰**

```sql
CREATE TABLE account_asset_balances (
  balance_id INT PRIMARY KEY AUTO_INCREMENT,
  account_id INT NOT NULL,
  asset_code VARCHAR(50) NOT NULL,  -- 'POINTS', 'BUDGET_POINTS', 'DIAMOND', 'MATERIAL_*'
  campaign_id INT DEFAULT NULL,     -- ä»… BUDGET_POINTS å¿…å¡«
  available_amount DECIMAL(20,4) DEFAULT 0,
  frozen_amount DECIMAL(20,4) DEFAULT 0,
  created_at TIMESTAMP,
  updated_at TIMESTAMP,

  UNIQUE KEY uk_account_asset_campaign (account_id, asset_code, campaign_id),
  INDEX idx_asset_code (asset_code),
  INDEX idx_campaign_id (campaign_id)
);
```

**asset_transactionsï¼ˆæµæ°´è¡¨ - ä¸å¯å˜å®¡è®¡æ—¥å¿—ï¼‰**

```sql
CREATE TABLE asset_transactions (
  transaction_id BIGINT PRIMARY KEY AUTO_INCREMENT,
  account_id INT NOT NULL,
  asset_code VARCHAR(50) NOT NULL,
  campaign_id INT DEFAULT NULL,
  change_amount DECIMAL(20,4) NOT NULL,  -- æ­£æ•°=å¢åŠ ï¼Œè´Ÿæ•°=æ‰£å‡
  before_amount DECIMAL(20,4) NOT NULL,
  after_amount DECIMAL(20,4) NOT NULL,
  transaction_type VARCHAR(50) NOT NULL,  -- 'lottery_deduct', 'lottery_reward', 'admin_adjust'
  idempotency_key VARCHAR(100) UNIQUE,
  lottery_session_id VARCHAR(100),
  business_id VARCHAR(100),
  metadata JSON,
  created_at TIMESTAMP,
  -- updatedAt: false (ä»…è¿½åŠ ï¼Œä¸æ›´æ–°)

  INDEX idx_account_asset (account_id, asset_code),
  INDEX idx_idempotency (idempotency_key),
  INDEX idx_lottery_session (lottery_session_id)
);
```

### 2.3 é¢„ç®—æ§åˆ¶æ¶æ„

#### BUDGET_POINTS è®¾è®¡åŸåˆ™

**1. æ´»åŠ¨ç»´åº¦éš”ç¦»**

```javascript
// æ´»åŠ¨Açš„é¢„ç®—è´¦æˆ·
{
  account_id: 1,  // ç³»ç»Ÿè´¦æˆ·æˆ–æ´»åŠ¨ä¸“ç”¨è´¦æˆ·
  asset_code: 'BUDGET_POINTS',
  campaign_id: 101,  // æ´»åŠ¨A
  available_amount: 1000000  // æ´»åŠ¨Aé¢„ç®—100ä¸‡
}

// æ´»åŠ¨Bçš„é¢„ç®—è´¦æˆ·ï¼ˆå®Œå…¨ç‹¬ç«‹ï¼‰
{
  account_id: 1,
  asset_code: 'BUDGET_POINTS',
  campaign_id: 102,  // æ´»åŠ¨B
  available_amount: 500000  // æ´»åŠ¨Bé¢„ç®—50ä¸‡
}
```

**2. æŠ½å¥–é¢„ç®—æ‰£å‡æµç¨‹**

```javascript
// ä¼ªä»£ç 
async function executeGuaranteeAward(userId, campaignId) {
  const transaction = await sequelize.transaction()

  try {
    // 1. æ‰£å‡ç”¨æˆ· POINTSï¼ˆç”¨æˆ·å¯è§ç§¯åˆ†ï¼‰
    await AssetService.changeBalance({
      userId: userId,
      assetCode: 'POINTS',
      amount: -10, // æ‰£10ç§¯åˆ†
      transactionType: 'lottery_deduct',
      idempotencyKey: `lottery_${sessionId}_deduct`,
      transaction
    })

    // 2. æ‰£å‡æ´»åŠ¨é¢„ç®— BUDGET_POINTSï¼ˆè¿è¥æˆæœ¬æ§åˆ¶ï¼‰
    await AssetService.changeBalance({
      userId: SYSTEM_USER_ID, // ç³»ç»Ÿè´¦æˆ·
      assetCode: 'BUDGET_POINTS',
      campaignId: campaignId, // å…³é”®ï¼šæŒ‡å®šæ´»åŠ¨
      amount: -100, // æ‰£å‡é¢„ç®—100
      transactionType: 'lottery_budget_consume',
      idempotencyKey: `lottery_${sessionId}_budget`,
      transaction
    })

    // 3. å‘æ”¾å¥–åŠ±ï¼ˆDIAMOND æˆ–ææ–™ï¼‰
    await AssetService.changeBalance({
      userId: userId,
      assetCode: 'DIAMOND',
      amount: 50,
      transactionType: 'lottery_reward',
      idempotencyKey: `lottery_${sessionId}_reward`,
      transaction
    })

    await transaction.commit()
  } catch (error) {
    await transaction.rollback()
    throw error
  }
}
```

**3. é¢„ç®—ä¸è¶³æ—¶çš„ç­–ç•¥**

```javascript
// æŠ½å¥–å‰æ£€æŸ¥é¢„ç®—
const budgetBalance = await AssetService.getBalance({
  userId: SYSTEM_USER_ID,
  assetCode: 'BUDGET_POINTS',
  campaignId: campaignId
})

if (budgetBalance.available < requiredBudget) {
  // ç­–ç•¥1: é™çº§åˆ°ä½æˆæœ¬å¥–æ± 
  return await executeLowCostPool(userId)

  // ç­–ç•¥2: æ‹’ç»æŠ½å¥–å¹¶æç¤º
  throw new Error('æ´»åŠ¨é¢„ç®—ä¸è¶³ï¼Œè¯·è”ç³»è¿è¥')

  // ç­–ç•¥3: è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æ´»åŠ¨
  return await switchToCampaign(userId, FALLBACK_CAMPAIGN_ID)
}
```

### 2.4 æœåŠ¡å±‚æ¶æ„

#### AssetService æ ¸å¿ƒæ–¹æ³•ï¼ˆéœ€è¡¥å…… campaign_id æ”¯æŒï¼‰

```javascript
class AssetService {
  /**
   * å˜æ›´ä½™é¢ï¼ˆæ ¸å¿ƒæ–¹æ³•ï¼Œæ”¯æŒå¹‚ç­‰ï¼‰
   * @param {Object} params
   * @param {number} params.userId - ç”¨æˆ·ID
   * @param {string} params.assetCode - èµ„äº§ç±»å‹
   * @param {number} [params.campaignId] - æ´»åŠ¨IDï¼ˆBUDGET_POINTSå¿…å¡«ï¼‰
   * @param {number} params.amount - å˜æ›´é‡‘é¢ï¼ˆæ­£æ•°=å¢åŠ ï¼Œè´Ÿæ•°=æ‰£å‡ï¼‰
   * @param {string} params.transactionType - ä¸šåŠ¡ç±»å‹
   * @param {string} [params.idempotencyKey] - å¹‚ç­‰é”®
   * @param {string} [params.lotterySessionId] - æŠ½å¥–ä¼šè¯ID
   * @param {Transaction} [params.transaction] - Sequelizeäº‹åŠ¡
   */
  static async changeBalance({
    userId,
    assetCode,
    campaignId = null, // æ–°å¢å‚æ•°
    amount,
    transactionType,
    idempotencyKey,
    lotterySessionId,
    transaction
  }) {
    // 1. å¹‚ç­‰æ€§æ£€æŸ¥
    if (idempotencyKey) {
      const existing = await AssetTransaction.findOne({
        where: { idempotency_key: idempotencyKey },
        transaction
      })
      if (existing) {
        return { success: true, transaction: existing, idempotent: true }
      }
    }

    // 2. è·å–æˆ–åˆ›å»ºè´¦æˆ·
    const account = await this.getOrCreateAccount(userId, transaction)

    // 3. è·å–æˆ–åˆ›å»ºä½™é¢è®°å½•ï¼ˆæ”¯æŒ campaign_idï¼‰
    const balance = await this.getOrCreateBalance({
      accountId: account.account_id,
      assetCode,
      campaignId, // ä¼ é€’æ´»åŠ¨ID
      transaction
    })

    // 4. æ‚²è§‚é”é”å®šä½™é¢è¡Œ
    await balance.reload({
      lock: transaction.LOCK.UPDATE,
      transaction
    })

    // 5. è®¡ç®—æ–°ä½™é¢
    const beforeAmount = balance.available_amount
    const afterAmount = beforeAmount + amount

    if (afterAmount < 0) {
      throw new Error(`ä½™é¢ä¸è¶³: ${assetCode}, å½“å‰=${beforeAmount}, éœ€è¦=${Math.abs(amount)}`)
    }

    // 6. æ›´æ–°ä½™é¢
    await balance.update({ available_amount: afterAmount }, { transaction })

    // 7. è®°å½•æµæ°´
    const txRecord = await AssetTransaction.create(
      {
        account_id: account.account_id,
        asset_code: assetCode,
        campaign_id: campaignId, // è®°å½•æ´»åŠ¨ID
        change_amount: amount,
        before_amount: beforeAmount,
        after_amount: afterAmount,
        transaction_type: transactionType,
        idempotency_key: idempotencyKey,
        lottery_session_id: lotterySessionId
      },
      { transaction }
    )

    return { success: true, transaction: txRecord }
  }

  /**
   * è·å–æˆ–åˆ›å»ºä½™é¢è®°å½•ï¼ˆæ–°å¢ campaign_id æ”¯æŒï¼‰
   */
  static async getOrCreateBalance({
    accountId,
    assetCode,
    campaignId = null, // æ–°å¢å‚æ•°
    transaction
  }) {
    const [balance] = await AccountAssetBalance.findOrCreate({
      where: {
        account_id: accountId,
        asset_code: assetCode,
        campaign_id: campaignId // å”¯ä¸€ç´¢å¼•çš„ä¸€éƒ¨åˆ†
      },
      defaults: {
        available_amount: 0,
        frozen_amount: 0
      },
      transaction
    })
    return balance
  }

  /**
   * æŸ¥è¯¢ä½™é¢ï¼ˆæ–°å¢ campaign_id æ”¯æŒï¼‰
   */
  static async getBalance({
    userId,
    assetCode,
    campaignId = null // æ–°å¢å‚æ•°
  }) {
    const account = await Account.findOne({
      where: { user_id: userId, account_type: 'user' }
    })

    if (!account) {
      return { available: 0, frozen: 0 }
    }

    const balance = await AccountAssetBalance.findOne({
      where: {
        account_id: account.account_id,
        asset_code: assetCode,
        campaign_id: campaignId // æŸ¥è¯¢æ¡ä»¶
      }
    })

    return {
      available: balance?.available_amount || 0,
      frozen: balance?.frozen_amount || 0
    }
  }
}
```

---

## ä¸‰ã€è¿ç§»å®æ–½æ–¹æ¡ˆ

### 3.1 è¿ç§»ç­–ç•¥ï¼šæœ€å°é£é™©å››é˜¶æ®µ

```
é˜¶æ®µ1: åˆ‡è¯»ï¼ˆ1-2å¤©ï¼‰
  â†“
é˜¶æ®µ2: æ•°æ®å›å¡«ä¸å¯¹è´¦ï¼ˆ2-3å¤©ï¼‰
  â†“
é˜¶æ®µ3: åˆ‡å†™ï¼ˆ1å¤©ï¼‰
  â†“
é˜¶æ®µ4: æ¸…ç†æ—§è¡¨ï¼ˆ1å‘¨åï¼‰
```

### 3.2 é˜¶æ®µ1ï¼šåˆ‡è¯»ï¼ˆ1-2å¤©ï¼‰

#### ç›®æ ‡

æ‰€æœ‰æŸ¥è¯¢ç§¯åˆ†çš„æ¥å£æ”¹ä¸ºè¯»å– `account_asset_balances(POINTS)`ï¼Œä½†å†™å…¥ä»ä¿æŒåŒå†™ã€‚

#### å®æ–½æ­¥éª¤

**Step 1: ä¿®æ”¹ PointsService ä¸ºå…¼å®¹å±‚**

```javascript
// services/PointsService.jsï¼ˆæ”¹é€ ä¸º AssetService çš„ä»£ç†ï¼‰
class PointsService {
  /**
   * è·å–ç”¨æˆ·ç§¯åˆ†ä½™é¢ï¼ˆæ”¹ä¸ºè¯»èµ„äº§åŸŸï¼‰
   */
  static async getPointsBalance(userId) {
    // æ—§å®ç°ï¼ˆåºŸå¼ƒï¼‰ï¼š
    // const account = await UserPointsAccount.findOne({ where: { user_id: userId } });
    // return account?.available_points || 0;

    // æ–°å®ç°ï¼ˆè¯»èµ„äº§åŸŸï¼‰ï¼š
    const balance = await AssetService.getBalance({
      userId: userId,
      assetCode: 'POINTS',
      campaignId: null
    })
    return balance.available
  }

  /**
   * è·å–ç”¨æˆ·ç§¯åˆ†è¯¦æƒ…ï¼ˆæ”¹ä¸ºè¯»èµ„äº§åŸŸï¼‰
   */
  static async getUserPointsAccount(userId) {
    const balance = await AssetService.getBalance({
      userId: userId,
      assetCode: 'POINTS'
    })

    // è¿”å›å…¼å®¹æ—§æ ¼å¼çš„æ•°æ®ç»“æ„
    return {
      user_id: userId,
      available_points: balance.available,
      frozen_points: balance.frozen,
      total_earned: 0, // å¯ä» asset_transactions èšåˆè®¡ç®—
      total_consumed: 0 // å¯ä» asset_transactions èšåˆè®¡ç®—
    }
  }

  /**
   * è·å–ç§¯åˆ†å†å²ï¼ˆæ”¹ä¸ºè¯»èµ„äº§åŸŸæµæ°´ï¼‰
   */
  static async getPointsHistory(userId, { limit = 20, offset = 0 } = {}) {
    const account = await Account.findOne({
      where: { user_id: userId, account_type: 'user' }
    })

    if (!account) return []

    const transactions = await AssetTransaction.findAll({
      where: {
        account_id: account.account_id,
        asset_code: 'POINTS'
      },
      order: [['created_at', 'DESC']],
      limit,
      offset
    })

    // è½¬æ¢ä¸ºå…¼å®¹æ—§æ ¼å¼
    return transactions.map(tx => ({
      transaction_id: tx.transaction_id,
      user_id: userId,
      amount: tx.change_amount,
      transaction_type: tx.transaction_type,
      balance_after: tx.after_amount,
      created_at: tx.created_at
    }))
  }
}
```

**Step 2: ä¿®æ”¹å‰ç«¯æŸ¥è¯¢æ¥å£**

```javascript
// routes/v4/lottery/user-points.js
router.get('/points/:user_id', async (req, res) => {
  try {
    const userId = parseInt(req.params.user_id)

    // æ—§å®ç°ï¼ˆåºŸå¼ƒï¼‰ï¼š
    // const user = await UserService.getUserWithPoints(userId);

    // æ–°å®ç°ï¼ˆè¯»èµ„äº§åŸŸï¼‰ï¼š
    const pointsBalance = await PointsService.getPointsBalance(userId)
    const pointsHistory = await PointsService.getPointsHistory(userId, { limit: 10 })

    return res.apiSuccess({
      user_id: userId,
      available_points: pointsBalance,
      recent_transactions: pointsHistory
    })
  } catch (error) {
    logger.error('æŸ¥è¯¢ç”¨æˆ·ç§¯åˆ†å¤±è´¥', { error: error.message, user_id: req.params.user_id })
    return res.apiError('æŸ¥è¯¢å¤±è´¥', 'QUERY_FAILED', null, 500)
  }
})
```

**Step 3: éªŒè¯åˆ‡è¯»æ•ˆæœ**

```bash
# æµ‹è¯•è„šæœ¬
curl http://localhost:3000/api/v4/lottery/user-points/31
# é¢„æœŸè¿”å› available_points=43652ï¼ˆæ¥è‡ª account_asset_balancesï¼‰
# è€Œä¸æ˜¯ 10000ï¼ˆæ¥è‡ª user_points_accountsï¼‰
```

#### å›æ»šæ–¹æ¡ˆ

å¦‚æœåˆ‡è¯»åå‘ç°é—®é¢˜ï¼Œåªéœ€æ¢å¤ `PointsService` çš„æ—§å®ç°å³å¯ï¼ˆå†™å…¥æœªå˜æ›´ï¼Œæ— æ•°æ®é£é™©ï¼‰ã€‚

### 3.3 é˜¶æ®µ2ï¼šæ•°æ®å›å¡«ä¸å¯¹è´¦ï¼ˆ2-3å¤©ï¼‰

#### ç›®æ ‡

ä¿®å¤ `user_points_accounts` ä¸ `account_asset_balances(POINTS)` çš„æ•°æ®åˆ†å‰ã€‚

#### å®æ–½æ­¥éª¤

**Step 1: ç”Ÿæˆå¯¹è´¦æŠ¥å‘Š**

```javascript
// scripts/reconcile-points-migration.js
const { sequelize } = require('../config/database')
const logger = require('../utils/logger')

async function generateReconciliationReport() {
  const [mismatches] = await sequelize.query(`
    SELECT 
      a.user_id,
      upa.available_points AS old_balance,
      COALESCE(bal.available_amount, 0) AS new_balance,
      (COALESCE(upa.available_points, 0) - COALESCE(bal.available_amount, 0)) AS diff,
      CASE 
        WHEN upa.available_points IS NULL THEN 'missing_in_old'
        WHEN bal.available_amount IS NULL THEN 'missing_in_new'
        WHEN upa.available_points <> bal.available_amount THEN 'mismatch'
      END AS issue_type
    FROM accounts a
    LEFT JOIN user_points_accounts upa ON upa.user_id = a.user_id
    LEFT JOIN account_asset_balances bal 
      ON bal.account_id = a.account_id 
      AND bal.asset_code='POINTS' 
      AND bal.campaign_id IS NULL
    WHERE a.account_type='user'
      AND (
        upa.user_id IS NOT NULL 
        OR bal.balance_id IS NOT NULL
      )
      AND (
        upa.available_points IS NULL 
        OR bal.available_amount IS NULL 
        OR upa.available_points <> bal.available_amount
      )
    ORDER BY ABS(COALESCE(upa.available_points,0) - COALESCE(bal.available_amount,0)) DESC;
  `)

  logger.info('å¯¹è´¦æŠ¥å‘Šç”Ÿæˆå®Œæˆ', { total_mismatches: mismatches.length })

  // è¾“å‡ºåˆ°æ–‡ä»¶
  const fs = require('fs')
  fs.writeFileSync('./logs/points-reconciliation-report.json', JSON.stringify(mismatches, null, 2))

  return mismatches
}

async function main() {
  const mismatches = await generateReconciliationReport()

  console.log('\n=== å¯¹è´¦æŠ¥å‘Šæ‘˜è¦ ===')
  console.log(`æ€»åˆ†å‰ç”¨æˆ·æ•°: ${mismatches.length}`)
  console.log(`æœ€å¤§å·®å¼‚: user_id=${mismatches[0]?.user_id}, diff=${mismatches[0]?.diff}`)

  process.exit(0)
}

main().catch(err => {
  console.error(err)
  process.exit(1)
})
```

**Step 2: æ•°æ®ä¿®å¤ç­–ç•¥**

æ ¹æ®å¯¹è´¦æŠ¥å‘Šçš„ `issue_type` åˆ†ç±»å¤„ç†ï¼š

```javascript
// scripts/fix-points-mismatches.js
async function fixPointsMismatches() {
  const transaction = await sequelize.transaction()

  try {
    const mismatches = JSON.parse(
      fs.readFileSync('./logs/points-reconciliation-report.json', 'utf8')
    )

    for (const mismatch of mismatches) {
      const { user_id, old_balance, new_balance, issue_type } = mismatch

      switch (issue_type) {
        case 'missing_in_new':
          // æ—§è¡¨æœ‰æ•°æ®ï¼Œæ–°è¡¨æ²¡æœ‰ â†’ å›å¡«åˆ°æ–°è¡¨
          logger.info('å›å¡«ç”¨æˆ·ç§¯åˆ†åˆ°èµ„äº§åŸŸ', { user_id, amount: old_balance })
          await AssetService.changeBalance({
            userId: user_id,
            assetCode: 'POINTS',
            amount: old_balance,
            transactionType: 'migration_backfill',
            idempotencyKey: `migration_backfill_${user_id}`,
            transaction
          })
          break

        case 'mismatch':
          // ä¸¤è¾¹éƒ½æœ‰ä½†ä¸ä¸€è‡´ â†’ ä»¥èµ„äº§åŸŸä¸ºå‡†ï¼ˆå› ä¸ºæŠ½å¥–å·²åœ¨ç”¨ï¼‰
          logger.warn('æ£€æµ‹åˆ°æ•°æ®åˆ†å‰ï¼Œä»¥èµ„äº§åŸŸä¸ºå‡†', {
            user_id,
            old_balance,
            new_balance,
            action: 'keep_new_balance'
          })
          // ä¸åšä¿®å¤ï¼Œé˜¶æ®µ3åˆ‡å†™åæ—§è¡¨ä¼šè¢«åºŸå¼ƒ
          break

        case 'missing_in_old':
          // æ–°è¡¨æœ‰æ•°æ®ï¼Œæ—§è¡¨æ²¡æœ‰ â†’ æ­£å¸¸æƒ…å†µï¼ˆæ–°ç”¨æˆ·ï¼‰
          logger.info('æ–°ç”¨æˆ·ï¼Œæ— éœ€å›å¡«', { user_id })
          break
      }
    }

    await transaction.commit()
    logger.info('æ•°æ®ä¿®å¤å®Œæˆ')
  } catch (error) {
    await transaction.rollback()
    logger.error('æ•°æ®ä¿®å¤å¤±è´¥', { error: error.message })
    throw error
  }
}
```

**Step 3: æ‰§è¡Œä¿®å¤å¹¶éªŒè¯**

```bash
# 1. ç”Ÿæˆå¯¹è´¦æŠ¥å‘Š
node scripts/reconcile-points-migration.js

# 2. äººå·¥å®¡æ ¸æŠ¥å‘Š
cat logs/points-reconciliation-report.json

# 3. æ‰§è¡Œä¿®å¤ï¼ˆéœ€äººå·¥ç¡®è®¤ï¼‰
node scripts/fix-points-mismatches.js

# 4. å†æ¬¡å¯¹è´¦éªŒè¯
node scripts/reconcile-points-migration.js
# é¢„æœŸ: total_mismatches=0 æˆ–ä»…å‰© 'mismatch' ç±»å‹ï¼ˆä»¥æ–°è¡¨ä¸ºå‡†ï¼‰
```

### 3.4 é˜¶æ®µ3ï¼šåˆ‡å†™ï¼ˆ1å¤©ï¼‰

#### ç›®æ ‡

æ‰€æœ‰ç§¯åˆ†å˜æ›´æ“ä½œæ”¹ä¸ºä»…å†™å…¥ `account_asset_balances(POINTS)`ï¼Œåœæ­¢å†™å…¥ `user_points_accounts`ã€‚

#### å®æ–½æ­¥éª¤

**Step 1: ä¿®æ”¹ PointsService å†™å…¥æ–¹æ³•**

```javascript
// services/PointsService.js
class PointsService {
  /**
   * å¢åŠ ç§¯åˆ†ï¼ˆæ”¹ä¸ºå†™èµ„äº§åŸŸï¼‰
   */
  static async addPoints({ userId, amount, transactionType, idempotencyKey, transaction }) {
    // æ—§å®ç°ï¼ˆåºŸå¼ƒï¼‰ï¼š
    // await UserPointsAccount.increment('available_points', { by: amount, where: { user_id: userId } });
    // await PointsTransaction.create({ user_id: userId, amount, transaction_type: transactionType });

    // æ–°å®ç°ï¼ˆå†™èµ„äº§åŸŸï¼‰ï¼š
    return await AssetService.changeBalance({
      userId,
      assetCode: 'POINTS',
      amount,
      transactionType,
      idempotencyKey,
      transaction
    })
  }

  /**
   * æ‰£å‡ç§¯åˆ†ï¼ˆæ”¹ä¸ºå†™èµ„äº§åŸŸï¼‰
   */
  static async consumePoints({ userId, amount, transactionType, idempotencyKey, transaction }) {
    // æ–°å®ç°ï¼ˆå†™èµ„äº§åŸŸï¼‰ï¼š
    return await AssetService.changeBalance({
      userId,
      assetCode: 'POINTS',
      amount: -amount, // è´Ÿæ•°è¡¨ç¤ºæ‰£å‡
      transactionType,
      idempotencyKey,
      transaction
    })
  }
}
```

**Step 2: éªŒè¯å†™å…¥åˆ‡æ¢**

```bash
# æµ‹è¯•è„šæœ¬ï¼šæ¨¡æ‹Ÿç”¨æˆ·æŠ½å¥–
curl -X POST http://localhost:3000/api/v4/lottery/draw \
  -H "Authorization: Bearer <token>" \
  -d '{"user_id": 31, "draw_count": 1}'

# éªŒè¯ï¼šæ£€æŸ¥æ˜¯å¦ä»…å†™å…¥èµ„äº§åŸŸ
mysql> SELECT * FROM asset_transactions WHERE account_id=(SELECT account_id FROM accounts WHERE user_id=31) ORDER BY created_at DESC LIMIT 1;
# é¢„æœŸï¼šæœ‰æ–°è®°å½•

mysql> SELECT * FROM points_transactions WHERE user_id=31 ORDER BY created_at DESC LIMIT 1;
# é¢„æœŸï¼šæ— æ–°è®°å½•ï¼ˆæˆ–æ—¶é—´æˆ³æ—©äºä¸Šé¢çš„è®°å½•ï¼‰
```

#### å›æ»šæ–¹æ¡ˆ

å¦‚æœåˆ‡å†™åå‘ç°é—®é¢˜ï¼Œæ¢å¤ `PointsService` çš„æ—§å®ç°ï¼Œå¹¶æ‰§è¡Œæ•°æ®å›æ»šè„šæœ¬ï¼ˆä» `asset_transactions` åå‘åŒæ­¥åˆ° `user_points_accounts`ï¼‰ã€‚

### 3.5 é˜¶æ®µ4ï¼šæ¸…ç†æ—§è¡¨ï¼ˆ1å‘¨åï¼‰

#### ç›®æ ‡

ç¡®è®¤ç³»ç»Ÿç¨³å®šè¿è¡Œ1å‘¨åï¼Œåˆ é™¤æ—§ç§¯åˆ†åŸŸç›¸å…³ä»£ç å’Œæ•°æ®åº“è¡¨ã€‚

#### å®æ–½æ­¥éª¤

**Step 1: ä»£ç æ¸…ç†æ¸…å•**

```bash
# åˆ é™¤æ—§æ¨¡å‹
rm models/UserPointsAccount.js
rm models/PointsTransaction.js

# åˆ é™¤æ—§æœåŠ¡ï¼ˆå¦‚æœå®Œå…¨ä¸éœ€è¦å…¼å®¹å±‚ï¼‰
# rm services/PointsService.js  # æˆ–ä¿ç•™ä½œä¸º AssetService çš„è¯­ä¹‰åŒ…è£…

# åˆ é™¤æ—§æµ‹è¯•
rm tests/services/PointsService.test.js

# åˆ é™¤æ—§è·¯ç”±ï¼ˆå¦‚æœå‰ç«¯å·²åˆ‡æ¢åˆ°æ–°æ¥å£ï¼‰
# æˆ–ä¿ç•™ä½†å†…éƒ¨å®ç°æ”¹ä¸ºè°ƒç”¨ AssetService
```

**Step 2: æ•°æ®åº“è¡¨æ¸…ç†**

```sql
-- å¤‡ä»½æ—§è¡¨ï¼ˆä¿ç•™1ä¸ªæœˆç”¨äºåº”æ€¥æ¢å¤ï¼‰
CREATE TABLE user_points_accounts_backup_20251229 AS SELECT * FROM user_points_accounts;
CREATE TABLE points_transactions_backup_20251229 AS SELECT * FROM points_transactions;

-- åˆ é™¤æ—§è¡¨
DROP TABLE user_points_accounts;
DROP TABLE points_transactions;
```

**Step 3: æ›´æ–°æ–‡æ¡£**

- æ›´æ–° API æ–‡æ¡£ï¼Œæ ‡è®°æ—§æ¥å£ä¸º `deprecated`
- æ›´æ–°æ•°æ®åº“è®¾è®¡æ–‡æ¡£ï¼Œç§»é™¤æ—§è¡¨è¯´æ˜
- æ›´æ–°å¼€å‘è€…æŒ‡å—ï¼Œè¯´æ˜ç§¯åˆ†æ“ä½œç»Ÿä¸€ä½¿ç”¨ `AssetService`

---

## å››ã€é¢„ç®—æ§åˆ¶å®æ–½æ–¹æ¡ˆ

### 4.1 BUDGET_POINTS åˆå§‹åŒ–

#### ä¸ºç°æœ‰æ´»åŠ¨åˆ›å»ºé¢„ç®—è´¦æˆ·

```javascript
// scripts/init-campaign-budgets.js
const { AssetService } = require('../services/AssetService')

async function initCampaignBudgets() {
  const campaigns = [
    { campaign_id: 101, name: 'æ˜¥èŠ‚æ´»åŠ¨', budget: 1000000 },
    { campaign_id: 102, name: 'å‘¨å¹´åº†', budget: 500000 },
    { campaign_id: 103, name: 'æ–°ç”¨æˆ·ç¦åˆ©', budget: 200000 }
  ]

  const SYSTEM_USER_ID = 1 // ç³»ç»Ÿè´¦æˆ·

  for (const campaign of campaigns) {
    try {
      await AssetService.changeBalance({
        userId: SYSTEM_USER_ID,
        assetCode: 'BUDGET_POINTS',
        campaignId: campaign.campaign_id,
        amount: campaign.budget,
        transactionType: 'admin_budget_init',
        idempotencyKey: `budget_init_${campaign.campaign_id}`
      })

      console.log(
        `âœ… æ´»åŠ¨ ${campaign.name} (ID=${campaign.campaign_id}) é¢„ç®—åˆå§‹åŒ–æˆåŠŸ: ${campaign.budget}`
      )
    } catch (error) {
      console.error(`âŒ æ´»åŠ¨ ${campaign.campaign_id} é¢„ç®—åˆå§‹åŒ–å¤±è´¥:`, error.message)
    }
  }
}

initCampaignBudgets().then(() => process.exit(0))
```

### 4.2 æŠ½å¥–ç­–ç•¥é›†æˆé¢„ç®—æ§åˆ¶

#### ä¿®æ”¹ BasicGuaranteeStrategy

```javascript
// services/UnifiedLotteryEngine/strategies/BasicGuaranteeStrategy.js
class BasicGuaranteeStrategy {
  async execute(userId, drawCount, campaignId) {
    const transaction = await sequelize.transaction()

    try {
      // 1. æ£€æŸ¥æ´»åŠ¨é¢„ç®—æ˜¯å¦å……è¶³
      const budgetBalance = await AssetService.getBalance({
        userId: SYSTEM_USER_ID,
        assetCode: 'BUDGET_POINTS',
        campaignId: campaignId
      })

      const requiredBudget = this.calculateRequiredBudget(drawCount)

      if (budgetBalance.available < requiredBudget) {
        logger.warn('æ´»åŠ¨é¢„ç®—ä¸è¶³ï¼Œé™çº§åˆ°ä½æˆæœ¬å¥–æ± ', {
          campaign_id: campaignId,
          available_budget: budgetBalance.available,
          required_budget: requiredBudget
        })

        // é™çº§ç­–ç•¥ï¼šä½¿ç”¨ä½æˆæœ¬å¥–æ± 
        return await this.executeLowCostPool(userId, drawCount, transaction)
      }

      // 2. æ‰£å‡ç”¨æˆ·ç§¯åˆ†
      await AssetService.changeBalance({
        userId: userId,
        assetCode: 'POINTS',
        amount: -10 * drawCount,
        transactionType: 'lottery_deduct',
        idempotencyKey: `lottery_${sessionId}_deduct`,
        lotterySessionId: sessionId,
        transaction
      })

      // 3. æ‰£å‡æ´»åŠ¨é¢„ç®—
      await AssetService.changeBalance({
        userId: SYSTEM_USER_ID,
        assetCode: 'BUDGET_POINTS',
        campaignId: campaignId,
        amount: -requiredBudget,
        transactionType: 'lottery_budget_consume',
        idempotencyKey: `lottery_${sessionId}_budget`,
        lotterySessionId: sessionId,
        transaction
      })

      // 4. æ‰§è¡ŒæŠ½å¥–å¹¶å‘æ”¾å¥–åŠ±
      const rewards = await this.drawRewards(userId, drawCount)

      for (const reward of rewards) {
        await AssetService.changeBalance({
          userId: userId,
          assetCode: reward.assetCode,
          amount: reward.amount,
          transactionType: 'lottery_reward',
          idempotencyKey: `lottery_${sessionId}_reward_${reward.id}`,
          lotterySessionId: sessionId,
          transaction
        })
      }

      await transaction.commit()
      return { success: true, rewards }
    } catch (error) {
      await transaction.rollback()
      logger.error('æŠ½å¥–æ‰§è¡Œå¤±è´¥', { error: error.message, user_id: userId })
      throw error
    }
  }

  calculateRequiredBudget(drawCount) {
    // æ ¹æ®å¥–æ± é…ç½®è®¡ç®—æœŸæœ›æˆæœ¬
    return drawCount * 100 // ç¤ºä¾‹ï¼šæ¯æ¬¡æŠ½å¥–æœŸæœ›æˆæœ¬100é¢„ç®—ç§¯åˆ†
  }

  async executeLowCostPool(userId, drawCount, transaction) {
    // ä½æˆæœ¬å¥–æ± é€»è¾‘ï¼ˆä¿åº•å¥–åŠ±ï¼‰
    // ...
  }
}
```

### 4.3 é¢„ç®—ç›‘æ§ä¸å‘Šè­¦

#### é¢„ç®—ç›‘æ§ Job

```javascript
// jobs/monitor-campaign-budgets.js
const cron = require('node-cron')
const { AssetService } = require('../services/AssetService')
const logger = require('../utils/logger')

// æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡æ´»åŠ¨é¢„ç®—
cron.schedule('0 * * * *', async () => {
  try {
    const [campaigns] = await sequelize.query(`
      SELECT 
        campaign_id,
        available_amount AS remaining_budget,
        (SELECT SUM(ABS(change_amount)) 
         FROM asset_transactions 
         WHERE asset_code='BUDGET_POINTS' 
           AND campaign_id=bal.campaign_id 
           AND change_amount < 0
        ) AS consumed_budget
      FROM account_asset_balances bal
      WHERE asset_code='BUDGET_POINTS'
      ORDER BY available_amount ASC;
    `)

    for (const campaign of campaigns) {
      const usageRate =
        campaign.consumed_budget / (campaign.consumed_budget + campaign.remaining_budget)

      // é¢„ç®—å‘Šè­¦é˜ˆå€¼
      if (campaign.remaining_budget < 10000) {
        logger.error('æ´»åŠ¨é¢„ç®—ä¸¥é‡ä¸è¶³', {
          campaign_id: campaign.campaign_id,
          remaining_budget: campaign.remaining_budget,
          alert_level: 'CRITICAL'
        })

        // å‘é€å‘Šè­¦é€šçŸ¥ï¼ˆé’‰é’‰/é‚®ä»¶/çŸ­ä¿¡ï¼‰
        await sendAlert({
          level: 'CRITICAL',
          message: `æ´»åŠ¨ ${campaign.campaign_id} é¢„ç®—ä¸è¶³ ${campaign.remaining_budget}ï¼Œè¯·ç«‹å³å……å€¼`
        })
      } else if (usageRate > 0.9) {
        logger.warn('æ´»åŠ¨é¢„ç®—å³å°†è€—å°½', {
          campaign_id: campaign.campaign_id,
          remaining_budget: campaign.remaining_budget,
          usage_rate: `${(usageRate * 100).toFixed(1)}%`,
          alert_level: 'WARNING'
        })
      }
    }
  } catch (error) {
    logger.error('é¢„ç®—ç›‘æ§Jobæ‰§è¡Œå¤±è´¥', { error: error.message })
  }
})
```

---

## äº”ã€é£é™©æ§åˆ¶ä¸å›æ»šé¢„æ¡ˆ

### 5.1 é£é™©è¯„ä¼°

| é£é™©é¡¹             | é£é™©ç­‰çº§ | å½±å“èŒƒå›´      | ç¼“è§£æªæ–½                    |
| ------------------ | -------- | ------------- | --------------------------- |
| æ•°æ®è¿ç§»é”™è¯¯       | ğŸ”´ é«˜    | ç”¨æˆ·ä½™é¢é”™è¯¯  | é˜¶æ®µ2å……åˆ†å¯¹è´¦ï¼Œä¿ç•™æ—§è¡¨å¤‡ä»½ |
| åˆ‡è¯»åæŸ¥è¯¢æ€§èƒ½ä¸‹é™ | ğŸŸ¡ ä¸­    | ç”¨æˆ·ä½“éªŒ      | æå‰æ·»åŠ ç´¢å¼•ï¼Œå‹æµ‹éªŒè¯      |
| åˆ‡å†™åå¹‚ç­‰å¤±æ•ˆ     | ğŸ”´ é«˜    | é‡å¤æ‰£æ¬¾/å‘å¥– | å¼ºåˆ¶ä½¿ç”¨ idempotency_key    |
| é¢„ç®—æ§åˆ¶é€»è¾‘é”™è¯¯   | ğŸŸ¡ ä¸­    | è¿è¥æˆæœ¬å¤±æ§  | ç°åº¦å‘å¸ƒï¼Œå®æ—¶ç›‘æ§          |
| æ—§æ¥å£å…¼å®¹æ€§é—®é¢˜   | ğŸŸ¢ ä½    | å‰ç«¯æŠ¥é”™      | ä¿ç•™å…¼å®¹å±‚ï¼Œé€æ­¥åºŸå¼ƒ        |

### 5.2 å›æ»šé¢„æ¡ˆ

#### é˜¶æ®µ1å›æ»šï¼ˆåˆ‡è¯»å¤±è´¥ï¼‰

```javascript
// æ¢å¤ PointsService è¯»å–æ—§è¡¨
static async getPointsBalance(userId) {
  const account = await UserPointsAccount.findOne({ where: { user_id: userId } });
  return account?.available_points || 0;
}
```

#### é˜¶æ®µ3å›æ»šï¼ˆåˆ‡å†™å¤±è´¥ï¼‰

```javascript
// 1. æ¢å¤ PointsService å†™å…¥æ—§è¡¨
// 2. æ‰§è¡Œæ•°æ®å›æ»šè„šæœ¬
async function rollbackAssetTransactions(startTime) {
  const [transactions] = await sequelize.query(`
    SELECT * FROM asset_transactions 
    WHERE asset_code='POINTS' 
      AND created_at >= '${startTime}'
    ORDER BY created_at ASC;
  `)

  for (const tx of transactions) {
    // åå‘åŒæ­¥åˆ° user_points_accounts
    await sequelize.query(`
      UPDATE user_points_accounts 
      SET available_points = available_points + ${tx.change_amount}
      WHERE user_id = (SELECT user_id FROM accounts WHERE account_id=${tx.account_id});
    `)
  }
}
```

### 5.3 ç°åº¦å‘å¸ƒç­–ç•¥

#### æŒ‰ç”¨æˆ·IDç°åº¦

```javascript
// ç°åº¦å¼€å…³é…ç½®
const MIGRATION_CONFIG = {
  enabled: true,
  grayUserIds: [31, 45, 67],  // ç°åº¦ç”¨æˆ·ç™½åå•
  grayPercentage: 10  // 10%ç”¨æˆ·ç°åº¦
};

// åˆ¤æ–­ç”¨æˆ·æ˜¯å¦åœ¨ç°åº¦èŒƒå›´
function isInGrayRelease(userId) {
  if (!MIGRATION_CONFIG.enabled) return false;

  // ç™½åå•ç”¨æˆ·
  if (MIGRATION_CONFIG.grayUserIds.includes(userId)) return true;

  // æŒ‰ç™¾åˆ†æ¯”ç°åº¦
  return (userId % 100) < MIGRATION_CONFIG.grayPercentage;
}

// åœ¨ PointsService ä¸­ä½¿ç”¨
static async getPointsBalance(userId) {
  if (isInGrayRelease(userId)) {
    // æ–°é€»è¾‘ï¼šè¯»èµ„äº§åŸŸ
    return await AssetService.getBalance({ userId, assetCode: 'POINTS' });
  } else {
    // æ—§é€»è¾‘ï¼šè¯»æ—§è¡¨
    const account = await UserPointsAccount.findOne({ where: { user_id: userId } });
    return account?.available_points || 0;
  }
}
```

---

## å…­ã€éªŒæ”¶æ ‡å‡†ä¸ç›‘æ§æŒ‡æ ‡

### 6.1 è¿ç§»å®ŒæˆéªŒæ”¶æ ‡å‡†

#### åŠŸèƒ½éªŒæ”¶

- [ ] æ‰€æœ‰ç§¯åˆ†æŸ¥è¯¢æ¥å£è¿”å›èµ„äº§åŸŸæ•°æ®
- [ ] æ‰€æœ‰ç§¯åˆ†å˜æ›´æ“ä½œå†™å…¥èµ„äº§åŸŸ
- [ ] æ—§è¡¨ `user_points_accounts` æ— æ–°å¢å†™å…¥
- [ ] é¢„ç®—æ§åˆ¶åŠŸèƒ½æ­£å¸¸ï¼ˆBUDGET_POINTS æŒ‰æ´»åŠ¨éš”ç¦»ï¼‰
- [ ] å¹‚ç­‰æ€§éªŒè¯é€šè¿‡ï¼ˆé‡å¤è¯·æ±‚ä¸é‡å¤æ‰£æ¬¾ï¼‰

#### æ•°æ®éªŒæ”¶

- [ ] å¯¹è´¦æŠ¥å‘Šæ˜¾ç¤º 0 æ¡æ•°æ®åˆ†å‰
- [ ] `account_asset_balances(POINTS)` æ€»é¢ = æ—§è¡¨è¿ç§»å‰æ€»é¢
- [ ] `asset_transactions` æµæ°´å®Œæ•´ï¼ˆæ‰€æœ‰å˜æ›´æœ‰è®°å½•ï¼‰
- [ ] `BUDGET_POINTS` æŒ‰ `campaign_id` æ­£ç¡®éš”ç¦»

#### æ€§èƒ½éªŒæ”¶

- [ ] ç§¯åˆ†æŸ¥è¯¢æ¥å£ P99 å»¶è¿Ÿ < 100ms
- [ ] æŠ½å¥–æ¥å£ P99 å»¶è¿Ÿ < 500ms
- [ ] æ•°æ®åº“æ…¢æŸ¥è¯¢ 0 æ¡ï¼ˆ> 1sï¼‰
- [ ] å¯¹è´¦ Job æ‰§è¡Œæ—¶é—´ < 5åˆ†é’Ÿ

### 6.2 ç›‘æ§æŒ‡æ ‡

#### ä¸šåŠ¡æŒ‡æ ‡

```javascript
// ç›‘æ§æŒ‡æ ‡å®šä¹‰
const MONITORING_METRICS = {
  // èµ„äº§åŸŸå¥åº·åº¦
  asset_domain_health: {
    metric: 'account_asset_balances.total_accounts',
    alert_threshold: '< ä¸Šå‘¨åŒæœŸ * 0.95'
  },

  // æ•°æ®ä¸€è‡´æ€§
  data_consistency: {
    metric: 'reconciliation_mismatches_count',
    alert_threshold: '> 0'
  },

  // é¢„ç®—æ¶ˆè€—é€Ÿç‡
  budget_consumption_rate: {
    metric: 'budget_points_consumed_per_hour',
    alert_threshold: '> é¢„æœŸå€¼ * 1.5'
  },

  // å¹‚ç­‰å¤±æ•ˆç‡
  idempotency_failure_rate: {
    metric: 'duplicate_idempotency_key_errors / total_requests',
    alert_threshold: '> 0.01'
  }
}
```

#### å‘Šè­¦è§„åˆ™

```yaml
# Prometheus å‘Šè­¦è§„åˆ™ç¤ºä¾‹
groups:
  - name: asset_domain_alerts
    rules:
      - alert: DataInconsistency
        expr: reconciliation_mismatches_count > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: 'èµ„äº§åŸŸæ•°æ®ä¸ä¸€è‡´'
          description: 'æ£€æµ‹åˆ° {{ $value }} æ¡æ•°æ®åˆ†å‰'

      - alert: BudgetExhausted
        expr: campaign_budget_remaining < 10000
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: 'æ´»åŠ¨é¢„ç®—ä¸è¶³'
          description: 'æ´»åŠ¨ {{ $labels.campaign_id }} é¢„ç®—å‰©ä½™ {{ $value }}'

      - alert: HighIdempotencyFailureRate
        expr: rate(idempotency_key_duplicate_errors[5m]) > 0.01
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: 'å¹‚ç­‰å¤±æ•ˆç‡è¿‡é«˜'
          description: 'å¹‚ç­‰å¤±æ•ˆç‡ {{ $value | humanizePercentage }}'
```

---

## ä¸ƒã€FAQä¸æœ€ä½³å®è·µ

### 7.1 å¸¸è§é—®é¢˜

**Q1: ä¸ºä»€ä¹ˆä¸èƒ½åœ¨ `user_points_accounts` é‡ŒåŒæ—¶å­˜å‚¨ POINTS å’Œ BUDGET_POINTSï¼Ÿ**

A: æŠ€æœ¯ä¸Šå¯ä»¥ï¼Œä½†ä¼šå¯¼è‡´ï¼š

1. **è¯­ä¹‰æ··ä¹±**ï¼šç”¨æˆ·å¯è§ç§¯åˆ† vs è¿è¥é¢„ç®—ï¼Œæ€§è´¨å®Œå…¨ä¸åŒ
2. **æ— æ³•æŒ‰æ´»åŠ¨éš”ç¦»**ï¼š`budget_points` å­—æ®µæ—  `campaign_id` ç»´åº¦
3. **åŒå†™åŒè¯»é£é™©**ï¼šå½“å‰ç³»ç»Ÿå·²å‡ºç°æ•°æ®åˆ†å‰ï¼ˆuser_id=31: 10000 vs 43652ï¼‰
4. **æ‰©å±•æ€§å·®**ï¼šæœªæ¥æ–°å¢èµ„äº§ç±»å‹éœ€é‡å¤å»ºè¡¨

**Q2: è¿ç§»æœŸé—´å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ**

A: å››é˜¶æ®µè¿ç§»ç­–ç•¥ï¼š

1. é˜¶æ®µ1ï¼ˆåˆ‡è¯»ï¼‰ï¼šè¯»æ–°è¡¨ï¼Œå†™ä»åŒå†™ â†’ æ— æ•°æ®é£é™©
2. é˜¶æ®µ2ï¼ˆå¯¹è´¦ï¼‰ï¼šä¿®å¤å†å²åˆ†å‰ â†’ ç¡®ä¿èµ·ç‚¹ä¸€è‡´
3. é˜¶æ®µ3ï¼ˆåˆ‡å†™ï¼‰ï¼šåœæ­¢å†™æ—§è¡¨ â†’ æ–°è¡¨æˆä¸ºå”¯ä¸€çœŸç›¸æº
4. é˜¶æ®µ4ï¼ˆæ¸…ç†ï¼‰ï¼š1å‘¨ååˆ é™¤æ—§è¡¨ â†’ ç•™è¶³è§‚å¯ŸæœŸ

**Q3: å¦‚æœè¿ç§»åå‘ç°æ€§èƒ½é—®é¢˜æ€ä¹ˆåŠï¼Ÿ**

A: æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µï¼š

- **ç´¢å¼•ä¼˜åŒ–**ï¼š`account_asset_balances` å·²æœ‰ `uk_account_asset_campaign` å”¯ä¸€ç´¢å¼•
- **æŸ¥è¯¢ä¼˜åŒ–**ï¼šé¿å… N+1 æŸ¥è¯¢ï¼Œä½¿ç”¨æ‰¹é‡æŸ¥è¯¢
- **ç¼“å­˜ç­–ç•¥**ï¼šé«˜é¢‘æŸ¥è¯¢ï¼ˆå¦‚ç”¨æˆ·ä½™é¢ï¼‰åŠ  Redis ç¼“å­˜
- **è¯»å†™åˆ†ç¦»**ï¼šæŸ¥è¯¢èµ°ä»åº“ï¼Œå†™å…¥èµ°ä¸»åº“

**Q4: BUDGET_POINTS å¦‚ä½•å……å€¼ï¼Ÿ**

A: è¿è¥åå°æ¥å£ï¼š

```javascript
// ç®¡ç†å‘˜ä¸ºæ´»åŠ¨å……å€¼é¢„ç®—
router.post('/admin/campaigns/:campaign_id/budget/recharge', async (req, res) => {
  const { campaign_id } = req.params
  const { amount } = req.body

  await AssetService.changeBalance({
    userId: SYSTEM_USER_ID,
    assetCode: 'BUDGET_POINTS',
    campaignId: campaign_id,
    amount: amount,
    transactionType: 'admin_budget_recharge',
    idempotencyKey: `budget_recharge_${campaign_id}_${Date.now()}`
  })

  return res.apiSuccess({ message: 'é¢„ç®—å……å€¼æˆåŠŸ' })
})
```

### 7.2 æœ€ä½³å®è·µ

#### 1. å¼ºåˆ¶ä½¿ç”¨å¹‚ç­‰é”®

```javascript
// âŒ é”™è¯¯ï¼šæ— å¹‚ç­‰é”®
await AssetService.changeBalance({
  userId: userId,
  assetCode: 'POINTS',
  amount: -10,
  transactionType: 'lottery_deduct'
})

// âœ… æ­£ç¡®ï¼šå¸¦å¹‚ç­‰é”®
await AssetService.changeBalance({
  userId: userId,
  assetCode: 'POINTS',
  amount: -10,
  transactionType: 'lottery_deduct',
  idempotencyKey: `lottery_${sessionId}_deduct`, // å¿…éœ€
  lotterySessionId: sessionId
})
```

#### 2. é¢„ç®—æ‰£å‡å‰æ£€æŸ¥

```javascript
// âœ… æ­£ç¡®ï¼šå…ˆæ£€æŸ¥é¢„ç®—ï¼Œå†æ‰§è¡ŒæŠ½å¥–
const budgetBalance = await AssetService.getBalance({
  userId: SYSTEM_USER_ID,
  assetCode: 'BUDGET_POINTS',
  campaignId: campaignId
})

if (budgetBalance.available < requiredBudget) {
  // é™çº§æˆ–æ‹’ç»
  return await executeLowCostPool(userId)
}

// ç»§ç»­æ­£å¸¸æŠ½å¥–æµç¨‹
```

#### 3. äº‹åŠ¡å†…æ“ä½œ

```javascript
// âœ… æ­£ç¡®ï¼šæ‰€æœ‰ä½™é¢å˜æ›´åœ¨åŒä¸€äº‹åŠ¡å†…
const transaction = await sequelize.transaction()
try {
  await AssetService.changeBalance({ userId, assetCode: 'POINTS', amount: -10, transaction })
  await AssetService.changeBalance({
    userId: SYSTEM_USER_ID,
    assetCode: 'BUDGET_POINTS',
    campaignId,
    amount: -100,
    transaction
  })
  await AssetService.changeBalance({ userId, assetCode: 'DIAMOND', amount: 50, transaction })
  await transaction.commit()
} catch (error) {
  await transaction.rollback()
  throw error
}
```

#### 4. å®šæœŸå¯¹è´¦

```javascript
// æ¯æ—¥å¯¹è´¦ Jobï¼ˆå·²æœ‰ daily-asset-reconciliation.jsï¼‰
cron.schedule('0 2 * * *', async () => {
  const report = await reconcileAssetBalances()
  if (report.mismatches.length > 0) {
    await sendAlert({ level: 'CRITICAL', message: 'èµ„äº§å¯¹è´¦å‘ç°ä¸ä¸€è‡´' })
  }
})
```

---

## å…«ã€æ€»ç»“ä¸åç»­è§„åˆ’

### 8.1 è¿ç§»æ”¶ç›Š

**æŠ€æœ¯æ”¶ç›Š**ï¼š

- âœ… æ¶ˆé™¤åŒçœŸç›¸æºï¼Œæ•°æ®ä¸€è‡´æ€§æœ‰ä¿éšœ
- âœ… ç»Ÿä¸€èµ„äº§æ¨¡å‹ï¼Œä»£ç å¤æ‚åº¦é™ä½ 30%
- âœ… å®Œæ•´å®¡è®¡æµæ°´ï¼Œæ»¡è¶³åˆè§„è¦æ±‚
- âœ… é¢„ç®—æŒ‰æ´»åŠ¨éš”ç¦»ï¼Œè¿è¥æˆæœ¬å¯æ§

**ä¸šåŠ¡æ”¶ç›Š**ï¼š

- âœ… æ”¯æŒå¤šæ´»åŠ¨å¹¶è¡Œï¼Œé¢„ç®—ç‹¬ç«‹æ ¸ç®—
- âœ… å¹‚ç­‰æ€§ä¿è¯ï¼Œæœç»é‡å¤æ‰£æ¬¾/å‘å¥–
- âœ… å®æ—¶å¯¹è´¦èƒ½åŠ›ï¼Œè´¢åŠ¡é£é™©å¯æ§
- âœ… æ‰©å±•æ€§å¼ºï¼Œæ–°å¢èµ„äº§ç±»å‹æˆæœ¬ä½

### 8.2 åç»­ä¼˜åŒ–æ–¹å‘

#### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰

- [ ] å®Œæˆç§¯åˆ†åŸŸè¿ç§»ï¼ˆæœ¬æ–‡æ¡£æ–¹æ¡ˆï¼‰
- [ ] è¡¥å…… `AssetService` å•å…ƒæµ‹è¯•ï¼ˆè¦†ç›–ç‡ > 90%ï¼‰
- [ ] ä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼ˆç›®æ ‡ï¼šæ‰€æœ‰æŸ¥è¯¢ < 100msï¼‰

#### ä¸­æœŸï¼ˆ1-2ä¸ªæœˆï¼‰

- [ ] å®ç°å†»ç»“/è§£å†»èµ„äº§åŠŸèƒ½ï¼ˆæ”¯æŒé¢„æ‰£æ¬¾åœºæ™¯ï¼‰
- [ ] æ¥å…¥ Redis ç¼“å­˜ï¼ˆé«˜é¢‘æŸ¥è¯¢æ€§èƒ½æå‡ 10å€ï¼‰
- [ ] å»ºç«‹é¢„ç®—é¢„è­¦æœºåˆ¶ï¼ˆé’‰é’‰/é‚®ä»¶é€šçŸ¥ï¼‰

#### é•¿æœŸï¼ˆ3-6ä¸ªæœˆï¼‰

- [ ] å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆæ”¯æŒè·¨æœåŠ¡èµ„äº§è½¬ç§»ï¼‰
- [ ] å»ºç«‹èµ„äº§æ¸…ç®—ç³»ç»Ÿï¼ˆT+1 å¯¹è´¦ï¼‰
- [ ] æ¥å…¥é£æ§ç³»ç»Ÿï¼ˆå¼‚å¸¸äº¤æ˜“æ£€æµ‹ï¼‰

---

## é™„å½•

### A. æ•°æ®åº“è¿ç§» SQL

```sql
-- 1. ç¡®ä¿ account_asset_balances è¡¨ç»“æ„æ­£ç¡®
ALTER TABLE account_asset_balances
  ADD COLUMN IF NOT EXISTS campaign_id INT DEFAULT NULL COMMENT 'æ´»åŠ¨IDï¼ˆä»…BUDGET_POINTSä½¿ç”¨ï¼‰',
  ADD UNIQUE INDEX IF NOT EXISTS uk_account_asset_campaign (account_id, asset_code, campaign_id);

-- 2. åˆ›å»ºç³»ç»Ÿè´¦æˆ·ï¼ˆç”¨äºå­˜å‚¨é¢„ç®—ï¼‰
INSERT INTO accounts (user_id, account_type, status, created_at, updated_at)
VALUES (1, 'system', 'active', NOW(), NOW())
ON DUPLICATE KEY UPDATE account_type='system';

-- 3. å›å¡«ç”¨æˆ·ç§¯åˆ†åˆ°èµ„äº§åŸŸï¼ˆä»… missing_in_new çš„ç”¨æˆ·ï¼‰
INSERT INTO account_asset_balances (account_id, asset_code, campaign_id, available_amount, frozen_amount, created_at, updated_at)
SELECT
  a.account_id,
  'POINTS' AS asset_code,
  NULL AS campaign_id,
  upa.available_points AS available_amount,
  upa.frozen_points AS frozen_amount,
  NOW() AS created_at,
  NOW() AS updated_at
FROM user_points_accounts upa
JOIN accounts a ON a.user_id = upa.user_id AND a.account_type = 'user'
LEFT JOIN account_asset_balances bal
  ON bal.account_id = a.account_id
  AND bal.asset_code = 'POINTS'
  AND bal.campaign_id IS NULL
WHERE bal.balance_id IS NULL;  -- ä»…å›å¡«ç¼ºå¤±çš„è®°å½•

-- 4. éªŒè¯å›å¡«ç»“æœ
SELECT
  (SELECT COUNT(*) FROM user_points_accounts) AS old_count,
  (SELECT COUNT(*) FROM account_asset_balances WHERE asset_code='POINTS' AND campaign_id IS NULL) AS new_count,
  (SELECT SUM(available_points) FROM user_points_accounts) AS old_sum,
  (SELECT SUM(available_amount) FROM account_asset_balances WHERE asset_code='POINTS' AND campaign_id IS NULL) AS new_sum;
```

### B. ç›‘æ§è„šæœ¬

```javascript
// scripts/monitor-asset-domain.js
const { sequelize } = require('../config/database')
const logger = require('../utils/logger')

async function monitorAssetDomain() {
  // 1. æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
  const [mismatches] = await sequelize.query(`
    SELECT COUNT(*) AS mismatch_count
    FROM accounts a
    LEFT JOIN user_points_accounts upa ON upa.user_id = a.user_id
    LEFT JOIN account_asset_balances bal 
      ON bal.account_id = a.account_id AND bal.asset_code='POINTS' AND bal.campaign_id IS NULL
    WHERE a.account_type='user'
      AND (upa.available_points IS NOT NULL OR bal.available_amount IS NOT NULL)
      AND (upa.available_points IS NULL OR bal.available_amount IS NULL OR upa.available_points <> bal.available_amount);
  `)

  if (mismatches[0].mismatch_count > 0) {
    logger.error('èµ„äº§åŸŸæ•°æ®ä¸ä¸€è‡´', { mismatch_count: mismatches[0].mismatch_count })
  }

  // 2. æ£€æŸ¥é¢„ç®—ä½™é¢
  const [budgets] = await sequelize.query(`
    SELECT campaign_id, available_amount
    FROM account_asset_balances
    WHERE asset_code='BUDGET_POINTS'
    ORDER BY available_amount ASC
    LIMIT 5;
  `)

  for (const budget of budgets) {
    if (budget.available_amount < 10000) {
      logger.warn('æ´»åŠ¨é¢„ç®—ä¸è¶³', {
        campaign_id: budget.campaign_id,
        remaining: budget.available_amount
      })
    }
  }

  // 3. æ£€æŸ¥å¹‚ç­‰å¤±æ•ˆ
  const [duplicates] = await sequelize.query(`
    SELECT idempotency_key, COUNT(*) AS dup_count
    FROM asset_transactions
    WHERE idempotency_key IS NOT NULL
    GROUP BY idempotency_key
    HAVING dup_count > 1;
  `)

  if (duplicates.length > 0) {
    logger.error('æ£€æµ‹åˆ°å¹‚ç­‰é”®é‡å¤', { duplicate_count: duplicates.length })
  }

  logger.info('èµ„äº§åŸŸç›‘æ§å®Œæˆ', {
    mismatch_count: mismatches[0].mismatch_count,
    low_budget_campaigns: budgets.filter(b => b.available_amount < 10000).length,
    duplicate_idempotency_keys: duplicates.length
  })
}

// æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
setInterval(monitorAssetDomain, 5 * 60 * 1000)
```

### C. å‚è€ƒèµ„æ–™

- [Sequelize äº‹åŠ¡æ–‡æ¡£](https://sequelize.org/docs/v6/other-topics/transactions/)
- [æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–æœ€ä½³å®è·µ](https://use-the-index-luke.com/)
- [å¹‚ç­‰æ€§è®¾è®¡æ¨¡å¼](https://martinfowler.com/articles/idempotency.html)
- [è´¦æœ¬ç³»ç»Ÿè®¾è®¡](https://developer.alipay.com/docs/ledger-design)

---

**æ–‡æ¡£ç»´æŠ¤**: æœ¬æ–‡æ¡£åº”éšè¿ç§»è¿›åº¦å®æ—¶æ›´æ–°ï¼Œæ¯ä¸ªé˜¶æ®µå®Œæˆåæ›´æ–°å¯¹åº”ç« èŠ‚çš„å®æ–½çŠ¶æ€ã€‚

**è”ç³»æ–¹å¼**: å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»æ¶æ„ç»„æˆ–åœ¨é¡¹ç›® Wiki æé—®ã€‚
