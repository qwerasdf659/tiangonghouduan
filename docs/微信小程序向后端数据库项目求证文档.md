# 微信小程序前端 → 后端数据库项目求证文档

**求证日期**: 2026-02-18
**数据来源**: 后端代码仓库实际代码 + 真实数据库 `restaurant_points_dev` 实时查询
**权威性**: 以后端数据库和代码为唯一权威，前端直接使用后端字段名，不做映射

---

## 一、项目整体技术架构（实际代码确认）

### 1.1 技术栈

| 层级 | 技术 | 说明 |
|------|------|------|
| 后端框架 | Express.js (Node.js) | 路由前缀 `/api/v4/` |
| ORM | Sequelize v6 | 79个模型文件 |
| 数据库 | MySQL (Sealos托管) | `dbconn.sealosbja.site:42569` |
| 缓存 | Redis | 用于限流、缓存、验证码存储 |
| 对象存储 | Sealos S3 | 图片等静态资源 |
| 认证 | JWT (双Token) | access_token + refresh_token |
| 幂等控制 | Header Idempotency-Key | 写操作统一幂等键 |
| 服务层 | ServiceManager (snake_case key) | 依赖注入，事务外部管理 |

### 1.2 核心业务模式

```
消费返积分(POINTS) → 抽奖消耗POINTS → 奖励材料(red_shard等)和物品(item_instance)
                                    → 材料可分解为DIAMOND(转换规则)
                                    → 材料/物品可在C2C市场挂牌交易(DIAMOND/red_shard定价)
                                    → 材料可兑换B2C商品(exchange_items)
```

### 1.3 资产体系（数据库 `material_asset_types` 表实际数据）

| asset_code | display_name | group_code | form | tier | is_enabled | is_tradable |
|------------|-------------|------------|------|------|------------|-------------|
| red_shard | 红水晶碎片 | red | shard | 1 | 1 | 1 |
| DIAMOND | 钻石 | currency | currency | 10 | 1 | 1 |
| POINTS | 普通积分 | points | crystal | 0 | 0 | 0 |
| BUDGET_POINTS | 预算积分 | points | crystal | 0 | 1 | 0 |

### 1.4 账户体系（统一资产账本）

```
User → Account (account_type: 'user'/'system')
         → AccountAssetBalance (asset_code + available_amount + frozen_amount)
              → AssetTransaction (delta_amount + business_type 流水记录)
```

用户31实际余额（数据库实时查询）：

| asset_code | available_amount | frozen_amount |
|------------|-----------------|---------------|
| POINTS | 802,571 | 4,640 |
| red_shard | 60,243 | 3,290 |
| DIAMOND | 1,744 | 2,000 |
| BUDGET_POINTS | 5,187 | 0 |

---

## 二、问题逐项求证结果

### 问题1: USER_UUID_MISSING（已解决）

**数据库实查结果**: 用户31的 `user_uuid` = `d11c0772-cd11-46d0-9eef-d0775112632b`，**非NULL**。
全库60个用户，**0个用户**的 `user_uuid` 为 NULL。

**结论**: 该问题已不存在。所有用户均有 `user_uuid`。`user_uuid` 在用户创建时由 `User` 模型的 `beforeCreate` hook 自动生成 UUID v4。

**前端行动**: 无需操作，此问题已关闭。

---

### 问题2: 定价币种列表（前端硬编码问题）

**后端实际状态**:

1. **已有配置**: `system_settings` 表中 `allowed_settlement_assets` = `["DIAMOND","red_shard"]`（setting_id=31）
2. **已有管理API**: `GET /api/v4/console/marketplace/tradable-assets`（需 admin 权限，role_level >= 100）
3. **无用户端API**: 目前没有面向普通用户的定价币种列表API

**后端sell路由实际行为**: `POST /api/v4/market/list` 和 `POST /api/v4/market/fungible-assets/list` 的 `price_asset_code` 是**必填参数**，在 Service 层通过 `allowed_settlement_assets` 白名单校验。

**方案（后端可复用部分）**:
- `system_settings.allowed_settlement_assets` 已存储白名单配置，可复用
- `material_asset_types` 表的 `display_name` 可复用
- 只需新增一个用户端路由，查询 `allowed_settlement_assets` 配置 + 关联 `material_asset_types.display_name`
- 建议路径: `GET /api/v4/market/settlement-currencies`（无需 admin 权限）
- 响应直接使用后端字段名：

```json
{
  "success": true,
  "data": {
    "currencies": [
      { "asset_code": "DIAMOND", "display_name": "钻石" },
      { "asset_code": "red_shard", "display_name": "红水晶碎片" }
    ]
  }
}
```

**前端行动**: 移除硬编码 `['DIAMOND', 'red_shard']`，调用新API获取。前端直接使用 `asset_code` 和 `display_name` 字段名。

---

### 问题3: 我的挂单列表 API

**后端实际状态**: `/api/v4/market/manage/my-listings` 路由**不存在**。后端当前市场路由模块只有:

| 路由 | 方法 | 说明 |
|------|------|------|
| `/api/v4/market/listings` | GET | 市场公开挂牌列表（所有卖家） |
| `/api/v4/market/listings/:market_listing_id` | GET | 挂牌详情 |
| `/api/v4/market/listing-status` | GET | 当前用户上架数量/剩余额度 |
| `/api/v4/market/list` | POST | 上架物品实例 |
| `/api/v4/market/fungible-assets/list` | POST | 挂牌可叠加资产 |
| `/api/v4/market/listings/:id/withdraw` | POST | 撤回物品挂牌 |
| `/api/v4/market/fungible-assets/:id/withdraw` | POST | 撤回资产挂牌 |
| `/api/v4/market/listings/:id/purchase` | POST | 购买 |

**后端可复用部分**:
- `market_listings` 表已有完整字段支持按 `seller_user_id` 筛选
- `MarketListingQueryService` 已有列表查询逻辑（分页、筛选、排序），可扩展
- 用户31当前数据: on_sale=3, sold=16, withdrawn=232, locked=7

**方案**: 需要新增路由 `GET /api/v4/market/my-listings`（注意：不加 `/manage/` 前缀，保持用户端路由简洁）

前端直接使用 `market_listings` 表的实际字段名：

| 字段 | 类型 | 说明 |
|------|------|------|
| `market_listing_id` | BIGINT | 挂单主键 |
| `listing_kind` | ENUM | `item_instance` / `fungible_asset` |
| `offer_item_display_name` | VARCHAR | 物品显示名（item_instance类型） |
| `offer_asset_display_name` | VARCHAR | 资产显示名（fungible_asset类型） |
| `offer_asset_code` | VARCHAR | 资产代码（fungible_asset类型） |
| `offer_amount` | BIGINT | 上架数量（fungible_asset类型） |
| `offer_item_rarity` | VARCHAR | 物品稀有度（item_instance类型） |
| `price_asset_code` | VARCHAR | 定价币种 |
| `price_amount` | BIGINT | 售价 |
| `status` | ENUM | `on_sale`/`locked`/`sold`/`withdrawn`/`admin_withdrawn` |
| `created_at` | DATETIME | 创建时间 |

**前端行动**: 前端代码直接使用上述后端字段名，**不做字段映射**。`display_name` 由 `listing_kind` 决定读取哪个字段:
- `item_instance` → 使用 `offer_item_display_name`
- `fungible_asset` → 使用 `offer_asset_display_name`

---

### 问题4: "今日获得/今日消费"数据显示为0

**后端实际状态**:

`GET /api/v4/lottery/points` 路由存在（`routes/v4/lottery/user-points.js`），但返回的是 `UserService.getUserWithPoints()` 的结果，结构为：

```json
{
  "success": true,
  "data": {
    "account_id": 5,
    "user_id": 31,
    "available_points": 802571,
    "frozen_points": 4640,
    "total_points": 807211,
    "is_active": true
  }
}
```

**关键发现**: 返回数据中**没有 `asset_summary`、`today_earned`、`today_consumed` 字段**。前端期望的 `data.asset_summary.today_earned` 路径在后端不存在，所以 `?.today_earned ?? 0` 始终返回 0。

**数据库实查**: 用户31今日确实有交易流水（`asset_transactions` 表），包括材料转换获得 DIAMOND 780、red_shard 消耗 339 等。数据存在但后端不提供汇总。

**后端所有实际 business_type 枚举值**（数据库实查）:

收入类: `lottery_reward`, `material_convert_credit`, `consumption_reward`, `merchant_points_reward`, `admin_adjustment`, `opening_balance`
支出类: `lottery_consume`, `exchange_debit`, `material_convert_debit`, `order_freeze_buyer`, `order_settle_buyer_debit`, `market_listing_freeze`, `premium_unlock`
中性类: `order_unfreeze_buyer`, `market_listing_withdraw_unfreeze`, `order_timeout_unfreeze`

**方案**: 需要后端新增"今日资产变动汇总"逻辑。两个可行路径：

- **方案A（推荐）**: 扩展现有 `GET /api/v4/lottery/points` 响应，在返回数据中增加 `today_summary` 字段
- **方案B**: 新增独立 API `GET /api/v4/assets/daily-summary`

前端直接使用后端返回的字段名（后端决定叫什么，前端直接用），不自行定义 `asset_summary` 等结构。

---

### 问题5: 客服微信号

**数据库实查**: `system_settings` 表中存在 `customer_phone`（值: `400-999-8888`）和 `customer_email`（值: `support@example.com`），但**不存在 `customer_wechat` 配置项**。

**后端可复用部分**: `system_settings` 表和 `GET /api/v4/system/config` API 已有完整的配置读取机制。

**方案**: 只需在 `system_settings` 表 INSERT 一条记录:

```sql
INSERT INTO system_settings (category, setting_key, setting_value, value_type, description, is_visible, is_readonly)
VALUES ('basic', 'customer_wechat', '实际微信号', 'string', '客服微信号（显示在小程序联系页面）', 1, 0);
```

前端通过现有 `GET /api/v4/system/config` 接口获取 `customer_wechat` 字段值。

**运营确认事项**: 实际客服微信号是什么？当前前端硬编码为 `tg15818387910`。

---

### 问题6: 短信验证码服务

**后端实际状态**:
- `POST /api/v4/auth/send-code` 路由已存在（`routes/v4/auth/login.js`）
- 开发环境支持万能验证码 `123456`（通过 `SmsService.verifyCode()` 逻辑）
- `.env` 中 SMS 配置为占位值: `SMS_ACCESS_KEY=your_aliyun_sms_access_key`

**结论**: 短信发送接口已实现，验证码验证逻辑已实现。但阿里云短信SDK的 access_key/secret_key 尚未配置真实值。上线前需替换 `.env` 中 SMS 相关配置。开发阶段使用万能码 `123456` 不影响功能测试。

**前端行动**: 无需修改。短信功能后端已就绪，仅差运营配置真实密钥。

---

### 问题7: API路径一致性（conversion-rules）

**后端实际状态**: 两条路径都存在且功能等价：

| 路径 | 路由文件 | 说明 |
|------|---------|------|
| `/api/v4/shop/assets/conversion-rules` | `routes/v4/shop/assets/rules.js` | shop域下 |
| `/api/v4/assets/conversion-rules` | `routes/v4/assets/conversion-rules.js` | assets域下 |

两者都调用同一个 `AssetConversionService.getConversionRules()` 方法。

**数据库实查**: 当前仅1条启用的转换规则:
- `red_shard → DIAMOND`，比率 1:20，手续费率 0，启用中

**方案**: 前端统一使用 `/api/v4/assets/conversion-rules`（assets域更符合语义）。后端后续可考虑废弃 `/api/v4/shop/assets/conversion-rules`。

---

### 问题8: `price_asset_code` 字段保证

**后端实际状态**:
- `market_listings` 表中 `price_asset_code` 列定义: `VARCHAR(50) NOT NULL DEFAULT 'DIAMOND'`
- 数据库约束保证非NULL
- `bid_products` 表中 `price_asset_code` 同样 `DEFAULT 'DIAMOND'`

**结论**: 后端数据库层面保证 `price_asset_code` 始终非空。前端可移除 `|| 'DIAMOND'` 降级逻辑。

---

### 问题9: 资产转换（分解）API

**后端实际状态**: `POST /api/v4/shop/assets/convert` 已实现（`routes/v4/shop/assets/convert.js`）

请求参数:
- `from_asset_code`: 源资产代码（如 `red_shard`）
- `to_asset_code`: 目标资产代码（如 `DIAMOND`）
- `amount`: 转换数量
- Header: `Idempotency-Key`（必填）

当前唯一启用的转换规则: `red_shard → DIAMOND` (1:20)

**前端行动**: 如需接入材料分解功能，直接调用此API即可。后端已就绪。

---

### 问题10: 奖品字段名标准化

**后端实际状态**: 需确认 `DataSanitizer` 服务的实际输出字段名。后端 `services/DataSanitizer.js` 负责统一数据格式。

**方案**: 前端直接使用后端API实际返回的字段名。如果后端返回 `lottery_prize_id`/`prize_name`/`prize_type`，前端就直接用这些字段名，不做 normalize。消除前端 `normalizePrize()` 兼容代码，直接对齐后端。

---

### 问题11: enableFieldMapping 配置标志

**结论**: 此为前端配置，与后端无关。既然前端无代码读取此配置，可直接删除。

---

### 问题12: market_listings 中的名称不一致

**数据库实查发现**:
- `material_asset_types.display_name` = **"红水晶碎片"**（权威数据源）
- `market_listings.offer_asset_display_name` = **"红色碎片"**（历史快照，未同步更新）

**根因**: `market_listings` 存储的是挂牌时刻的快照名称。早期挂牌记录使用了旧名称"红色碎片"，后来 `material_asset_types` 表更新为"红水晶碎片"，但已创建的挂牌记录快照未同步。

**方案**:
1. 新挂牌会自动使用最新的 `material_asset_types.display_name`（已在 Service 层实现）
2. 历史数据可通过迁移脚本批量更新:

```sql
UPDATE market_listings
SET offer_asset_display_name = '红水晶碎片'
WHERE offer_asset_code = 'red_shard' AND offer_asset_display_name = '红色碎片';
```

3. 前端显示以API返回值为准，不硬编码名称

---

## 三、后端已有完整API清单（前端可直接使用）

### 3.1 认证域 `/api/v4/auth/`

| 方法 | 路径 | 说明 | 状态 |
|------|------|------|------|
| POST | `/auth/send-code` | 发送短信验证码 | ✅ 已实现 |
| POST | `/auth/login` | 登录（支持自动注册） | ✅ 已实现 |
| POST | `/auth/token` | 刷新Token | ✅ 已实现 |
| GET | `/auth/profile` | 获取用户资料 | ✅ 已实现 |
| GET | `/auth/permissions` | 获取用户权限 | ✅ 已实现 |

### 3.2 资产域 `/api/v4/assets/`

| 方法 | 路径 | 说明 | 状态 |
|------|------|------|------|
| GET | `/assets/balance` | 获取单资产余额 | ✅ 已实现 |
| GET | `/assets/balances` | 获取所有资产余额 | ✅ 已实现 |
| GET | `/assets/transactions` | 资产流水记录 | ✅ 已实现 |
| GET | `/assets/conversion-rules` | 转换规则列表 | ✅ 已实现 |

### 3.3 抽奖域 `/api/v4/lottery/`

| 方法 | 路径 | 说明 | 状态 |
|------|------|------|------|
| GET | `/lottery/campaigns` | 活动列表 | ✅ 已实现 |
| GET | `/lottery/campaigns/:code/prizes` | 活动奖品列表 | ✅ 已实现 |
| POST | `/lottery/campaigns/:code/draw` | 执行抽奖 | ✅ 已实现 |
| GET | `/lottery/history` | 抽奖历史 | ✅ 已实现 |
| GET | `/lottery/points` | 用户积分信息 | ✅ 已实现（不含today汇总） |
| GET | `/lottery/statistics` | 用户抽奖统计 | ✅ 已实现 |

### 3.4 C2C交易市场 `/api/v4/market/`

| 方法 | 路径 | 说明 | 状态 |
|------|------|------|------|
| GET | `/market/listings` | 市场挂牌列表 | ✅ 已实现 |
| GET | `/market/listings/facets` | 筛选面板 | ✅ 已实现 |
| GET | `/market/listings/:id` | 挂牌详情 | ✅ 已实现 |
| GET | `/market/listing-status` | 用户上架状态 | ✅ 已实现 |
| POST | `/market/list` | 上架物品实例 | ✅ 已实现 |
| POST | `/market/fungible-assets/list` | 挂牌可叠加资产 | ✅ 已实现 |
| POST | `/market/listings/:id/purchase` | 购买 | ✅ 已实现 |
| POST | `/market/listings/:id/withdraw` | 撤回物品挂牌 | ✅ 已实现 |
| POST | `/market/fungible-assets/:id/withdraw` | 撤回资产挂牌 | ✅ 已实现 |
| GET | `/market/my-listings` | 我的挂单列表 | ❌ **需新增** |
| GET | `/market/settlement-currencies` | 结算币种列表 | ❌ **需新增** |

### 3.5 B2C兑换商城 `/api/v4/backpack/` 和 `/api/v4/shop/`

| 方法 | 路径 | 说明 | 状态 |
|------|------|------|------|
| GET | `/backpack/exchange/items` | 兑换商品列表 | ✅ 已实现 |
| GET | `/backpack/exchange/items/:id` | 兑换商品详情 | ✅ 已实现 |
| POST | `/backpack/exchange` | 执行兑换 | ✅ 已实现 |
| GET | `/backpack/exchange/premium-status` | 臻选空间状态 | ✅ 已实现 |
| POST | `/backpack/exchange/unlock-premium` | 解锁臻选空间 | ✅ 已实现 |
| GET | `/backpack/bid` | 竞拍商品列表 | ✅ 已实现 |
| POST | `/backpack/bid` | 提交竞拍 | ✅ 已实现 |
| POST | `/shop/assets/convert` | 材料转换（分解） | ✅ 已实现 |

### 3.6 消费相关 `/api/v4/shop/consumption/`

| 方法 | 路径 | 说明 | 状态 |
|------|------|------|------|
| GET | `/shop/consumption/qrcode` | 消费二维码 | ✅ 已实现 |
| POST | `/shop/consumption/submit` | 提交消费记录 | ✅ 已实现 |
| GET | `/shop/consumption/query` | 查询消费记录 | ✅ 已实现 |

### 3.7 系统配置 `/api/v4/system/`

| 方法 | 路径 | 说明 | 状态 |
|------|------|------|------|
| GET | `/system/config` | 系统配置 | ✅ 已实现 |
| GET | `/system/popup-banners` | 弹窗公告 | ✅ 已实现 |
| GET | `/system/announcements` | 系统公告 | ✅ 已实现 |
| GET | `/system/feedback` | 反馈配置 | ✅ 已实现 |
| GET | `/system/dictionaries` | 数据字典 | ✅ 已实现 |

---

## 四、前端需适配的后端字段名对照（直接使用，不做映射）

### 4.1 市场挂牌字段（market_listings 表）

前端代码中直接使用以下字段名：

```
market_listing_id    -- 挂单ID（非 listing_id）
listing_kind         -- 类型: 'item_instance' | 'fungible_asset'
seller_user_id       -- 卖家用户ID
offer_item_display_name    -- 物品显示名（item_instance 类型）
offer_item_rarity          -- 物品稀有度（item_instance 类型）
offer_asset_display_name   -- 资产显示名（fungible_asset 类型）
offer_asset_code           -- 资产代码（fungible_asset 类型）
offer_amount               -- 挂卖数量（fungible_asset 类型）
price_asset_code           -- 定价币种: 'DIAMOND' | 'red_shard'
price_amount               -- 售价
status                     -- 状态: 'on_sale'|'locked'|'sold'|'withdrawn'|'admin_withdrawn'
created_at                 -- 创建时间（ISO 8601）
```

### 4.2 资产余额字段（account_asset_balances 表）

```
asset_code           -- 资产代码: 'POINTS' | 'red_shard' | 'DIAMOND' | 'BUDGET_POINTS'
available_amount     -- 可用余额（非 available_points / balance）
frozen_amount        -- 冻结余额
```

### 4.3 积分接口返回字段（GET /lottery/points 实际返回）

```
account_id           -- 账户ID
user_id              -- 用户ID
available_points     -- 可用POINTS余额
frozen_points        -- 冻结POINTS余额
total_points         -- 总POINTS (available + frozen)
is_active            -- 账户是否活跃
```

注意: **不存在** `asset_summary`、`today_earned`、`today_consumed` 字段。

### 4.4 兑换商品字段（exchange_items 表）

```
exchange_item_id     -- 商品ID
item_name            -- 商品名称
cost_asset_code      -- 支付资产代码: 'red_shard' | 'DIAMOND' | 'POINTS'
cost_amount          -- 支付数量
cost_price           -- 参考价格
stock                -- 库存
sold_count           -- 已售数量
space                -- 空间: 'lucky' | 'premium' | 'both'
status               -- 状态: 'active' | 'inactive'
```

### 4.5 交易订单字段（trade_orders 表）

```
trade_order_id       -- 订单ID
market_listing_id    -- 关联挂牌ID
buyer_user_id        -- 买家
seller_user_id       -- 卖家
asset_code           -- 结算币种
gross_amount         -- 总金额
fee_amount           -- 手续费
net_amount           -- 卖家到手金额
status               -- 状态: 'created'|'frozen'|'completed'|'cancelled'|'failed'
```

---

## 五、待办事项汇总（按责任方和优先级排序）

### 5.0 后端已有能力盘点（代码实查结果）

> 以下是对后端代码仓库的实际检查结果。很多能力 Service 层已经实现，只差路由层暴露或数据脚本执行。

| # | 能力 | Service 层 | 路由层 | 差距 |
|---|------|-----------|--------|------|
| 1 | 查询指定用户的挂牌列表 | ✅ `MarketListingQueryService.getUserListings({ seller_user_id, status, page, page_size })` 已完整实现（含分页、状态筛选、include offerItem、attachDisplayNames） | ❌ 无用户端路由。仅 `GET /listing-status` 内部调用了它（只取 total 计数） | **差一个路由文件**，Service 零改动 |
| 2 | 获取允许结算币种白名单 | ✅ `TradeOrderService.getAllowedSettlementAssets()` 已从 `system_settings.allowed_settlement_assets` 读取并解析 | ❌ 无用户端路由。仅 `sell.js` 内部做白名单校验用 | **差一个路由**，Service 零改动，需额外关联 `material_asset_types.display_name` |
| 3 | 管理员查看可交易资产完整配置 | ✅ `GET /api/v4/console/marketplace/tradable-assets`（含 is_tradable、in_blacklist、effective_tradable）| ✅ 已有，但需 admin 权限（requireRoleLevel(100)） | 管理端已有，用户端需要一个精简版 |
| 4 | 今日收支汇总 | ⚠️ `DataSanitizer.sanitizePointsData()` 有 `today_earned` 字段定义，但 `GET /lottery/points` 的 `UserService.getUserWithPoints()` 并未查询/传入该数据 | ❌ API 不返回 | **差聚合查询逻辑** |
| 5 | customer_wechat | ❌ 数据库 `system_settings` 表中无此记录 | N/A（现有 `GET /system/config` 会自动返回所有配置） | **差一条 INSERT** |
| 6 | market_listings 旧名称修复 | ✅ 迁移脚本 `20260218000001-unify-material-asset-display-names.js` **已编写完成** | ❌ 未执行。数据库仍有 234 条 `offer_asset_display_name = '红色碎片'` | **差执行 `npx sequelize-cli db:migrate`** |

---

### 5.1 后端数据库项目工作（5项）

> 以下全部是后端数据库项目的开发/运维工作，前端不参与。

#### P0 - 后端新增路由（Service 已就绪，只差路由层暴露）

| # | 责任方 | 事项 | 实际工作量 | 说明 |
|---|--------|------|-----------|------|
| 1 | **后端** | 新增 `GET /api/v4/market/my-listings` 用户端路由 | **极小** | `MarketListingQueryService.getUserListings()` 已完整实现（分页、状态筛选、include关联、中文显示名）。只需在 `routes/v4/market/listings.js` 新增一个路由，从 `req.user.user_id` 取 seller_user_id 传入现有 Service 方法。零 Service 层改动。 |
| 2 | **后端** | 新增 `GET /api/v4/market/settlement-currencies` 用户端路由 | **小** | `getAllowedSettlementAssets()` 已能读取白名单。路由层调用它获取 asset_code 数组，再关联查询 `material_asset_types` 获取 display_name。参考 `console/marketplace.js` 中 tradable-assets 的实现模式。 |

#### P1 - 后端扩展功能

| # | 责任方 | 事项 | 实际工作量 | 说明 |
|---|--------|------|-----------|------|
| 3 | **后端** | 扩展 `GET /lottery/points` 增加今日收支汇总 | **中** | 需在路由层或 Service 层追加聚合查询：用户 `account_id` + 当天北京时间范围 + `asset_transactions` 表，`SUM(CASE WHEN delta_amount > 0 THEN delta_amount ELSE 0 END)` 为 earned，`SUM(CASE WHEN delta_amount < 0 THEN ABS(delta_amount) ELSE 0 END)` 为 consumed。`DataSanitizer` 已预留 `today_earned` 字段。 |
| 4 | **后端** | `system_settings` 表插入 `customer_wechat` 记录 | **极小** | 写一个迁移脚本执行 INSERT，现有 `GET /api/v4/system/config` 会自动返回，零代码改动。运营需确认实际微信号（当前前端硬编码为 `tg15818387910`）。 |

#### P2 - 后端数据维护（脚本已写好，只差执行）

| # | 责任方 | 事项 | 实际工作量 | 说明 |
|---|--------|------|-----------|------|
| 5 | **后端** | 执行 `20260218000001-unify-material-asset-display-names.js` 迁移 | **零开发** | 迁移脚本已编写完成（修复 `material_asset_types`、`material_conversion_rules`、新增 `system_dictionaries` 字典条目），但数据库中 `market_listings` 表仍有 234 条 `offer_asset_display_name = '红色碎片'`。需补充一条 UPDATE 语句覆盖 `market_listings` 历史快照，然后执行 `npx sequelize-cli db:migrate`。 |

---

### 5.2 前端适配工作（后端完成后才开始）

> 以下是前端的适配工作，全部依赖后端先完成对应接口。

| # | 责任方 | 事项 | 前置条件 |
|---|--------|------|---------|
| A | **前端** | 对接 `GET /market/my-listings`，直接使用后端字段名渲染页面 | 后端完成 P0-1 |
| B | **前端** | 移除定价币种硬编码，改为调用 `GET /market/settlement-currencies` | 后端完成 P0-2 |
| C | **前端** | 修改 `loadPointsTrend()` 函数，对齐后端实际返回的字段名 | 后端完成 P1-3 |
| D | **前端** | 修改客服微信号为动态读取 `system_settings.customer_wechat` | 后端完成 P1-4 |
| E | **前端** | 移除 `price_asset_code` 的 `|| 'DIAMOND'` 降级逻辑 | 无前置条件（已确认数据库 NOT NULL） |
| F | **前端** | 移除 `normalizePrize()` 多格式兼容代码，直接使用后端字段名 | 需后端确认奖品API实际字段名 |
| G | **前端** | 删除 `enableFieldMapping` 配置 | 无前置条件 |

---

### 5.3 已确认无需任何方处理

| 事项 | 原因 |
|------|------|
| ~~USER_UUID_MISSING~~ | 数据库实查60用户全员有值，问题已不存在 |
| ~~短信验证码服务~~ | 后端已实现，仅差运营配置阿里云真实密钥 |
| ~~API路径冲突 (conversion-rules)~~ | 两路径功能等价，前端统一用 `/assets/conversion-rules` |
| ~~材料分解 API~~ | `POST /shop/assets/convert` 已实现可用 |

---

## 六、可扩展性分析

### 6.1 资产体系扩展

当前 `material_asset_types` 仅有4种资产。新增资产只需:
1. `material_asset_types` 表 INSERT 新记录
2. 如需交易: 设置 `is_tradable = 1` 并在 `allowed_settlement_assets` 配置中添加
3. 如需转换: `material_conversion_rules` 表 INSERT 转换规则
4. 前端无需改代码（动态读取资产列表）

### 6.2 角色权限扩展

后端已有完整角色体系（`roles` 表，10个角色，role_level 分层）:
- admin(100), regional_manager(80), business_manager(60), merchant_manager(40), sales_staff(40), ops(30), merchant_staff(20), user(0)
- 权限通过 `requireRoleLevel()` 中间件控制
- 新增角色只需 INSERT `roles` 表

### 6.3 B2C商品扩展

`exchange_items` 表支持:
- 多种支付资产（`cost_asset_code`: red_shard / DIAMOND / POINTS）
- 空间分类（`space`: lucky / premium / both）
- 标签系统（`tags`: JSON数组）
- 图片关联（`primary_image_id` → image_resources）
- 数据库中当前有 89 个商品（44个active）

### 6.4 竞拍系统扩展

`bid_products` + `bid_records` 表已就绪，支持多币种竞拍。当前数据库中无活跃竞拍数据，功能已实现但未投入使用。

---

*本文档基于后端代码仓库和真实数据库查询编写，以后端为唯一权威。前端适配后端字段名，不做映射。*
*求证日期: 2026-02-18*
