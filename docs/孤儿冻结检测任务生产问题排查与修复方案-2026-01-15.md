# å­¤å„¿å†»ç»“æ£€æµ‹ä»»åŠ¡ç”Ÿäº§é—®é¢˜æ’æŸ¥ä¸ä¿®å¤æ–¹æ¡ˆ

**åˆ›å»ºæ—¶é—´**ï¼š2026-01-15  
**æœ€åæ›´æ–°**ï¼š2026-01-15ï¼ˆå·²æ‹æ¿å†³ç­–ï¼‰  
**é—®é¢˜çº§åˆ«**ï¼šP0ï¼ˆç”Ÿäº§ç¯å¢ƒæ¯å¤©å‡Œæ™¨2ç‚¹ä»»åŠ¡ä¼šå´©æºƒï¼‰  
**å½±å“èŒƒå›´**ï¼šå­¤å„¿å†»ç»“æ— æ³•è‡ªåŠ¨æ¸…ç†ï¼Œç”¨æˆ·èµ„äº§è¢«é”™è¯¯é”å®š  
**æ’æŸ¥æ–¹å¼**ï¼šåŸºäºå½“å‰å®é™…ä»£ç çŠ¶æ€ + çœŸå®æ•°æ®åº“æ•°æ®éªŒè¯  
**å†³ç­–çŠ¶æ€**ï¼šâœ… å·²æ‹æ¿

---

## ğŸ“‹ ç›®å½•

1. [é—®é¢˜èƒŒæ™¯](#é—®é¢˜èƒŒæ™¯)
2. [æ’æŸ¥ç»“è®º](#æ’æŸ¥ç»“è®º)
3. [çœŸå®æ•°æ®åº“éªŒè¯ç»“æœ](#çœŸå®æ•°æ®åº“éªŒè¯ç»“æœ)
4. [æ ¸å¿ƒé—®é¢˜åˆ†æ](#æ ¸å¿ƒé—®é¢˜åˆ†æ)
5. [å·²æ‹æ¿çš„å†³ç­–](#å·²æ‹æ¿çš„å†³ç­–)ï¼ˆâœ… å·²å®Œæˆï¼‰
6. [ä¿®å¤æ–¹æ¡ˆ](#ä¿®å¤æ–¹æ¡ˆ)
7. [éªŒè¯æ­¥éª¤](#éªŒè¯æ­¥éª¤)
8. [é™„å½•ï¼šä¸šåŠ¡é€»è¾‘è¯´æ˜](#é™„å½•ä¸šåŠ¡é€»è¾‘è¯´æ˜)

---

## é—®é¢˜èƒŒæ™¯

### åŸå§‹é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šç§° `jobs/daily-orphan-frozen-check.js` ç¬¬ 53 è¡Œå­˜åœ¨ camelCase è°ƒç”¨ï¼š

```javascript
// âŒ ç”¨æˆ·è®¤ä¸ºçš„é—®é¢˜
const orphanFrozenService = serviceManager.getService('orphanFrozenCleanup')
```

é¢„æœŸä¼šåœ¨æ¯å¤©å‡Œæ™¨ 2 ç‚¹å®šæ—¶ä»»åŠ¡è¿è¡Œæ—¶æŠ›å‡ºé”™è¯¯ï¼š

```
Service 'orphanFrozenCleanup' not found. Did you mean 'orphan_frozen_cleanup'?
```

### å®šæ—¶ä»»åŠ¡è°ƒç”¨é“¾è·¯

```
node-cron (0 2 * * *)
  â†“
app.js è¿›ç¨‹å¯åŠ¨
  â†“
ScheduledTasks.initialize()
  â†“
ScheduledTasks.scheduleDailyOrphanFrozenCheck()
  â†“
DailyOrphanFrozenCheck.execute({ dryRun: false, sendNotification: true })
  â†“
serviceManager.getService('orphan_frozen_cleanup')  // å®é™…è°ƒç”¨ç‚¹
  â†“
OrphanFrozenCleanupService.detectOrphanFrozen()
  â†“
OrphanFrozenCleanupService.cleanupOrphanFrozen()
```

---

## æ’æŸ¥ç»“è®º

### âœ… camelCase é—®é¢˜å·²ä¸å­˜åœ¨ï¼ˆå½“å‰ä»£ç çŠ¶æ€ï¼‰

**å®é™…ä»£ç ï¼ˆç¬¬ 53 è¡Œï¼‰**ï¼š

```javascript
// âœ… å½“å‰å®é™…ä»£ç ï¼ˆsnake_caseï¼‰
const orphanFrozenService = serviceManager.getService('orphan_frozen_cleanup')
```

**æœåŠ¡æ³¨å†Œï¼ˆservices/index.js ç¬¬ 272 è¡Œï¼‰**ï¼š

```javascript
this._services.set('orphan_frozen_cleanup', OrphanFrozenCleanupService)
```

**ç»“è®º**ï¼šç”¨æˆ·æè¿°çš„ camelCase è°ƒç”¨é—®é¢˜åœ¨å½“å‰ä»£ç ä¸­å·²ä¸å­˜åœ¨ã€‚

---

### ğŸ”´ å‘ç°æ›´ä¸¥é‡çš„ç”Ÿäº§é—®é¢˜ï¼ˆJob/Service å¥‘çº¦ä¸ä¸€è‡´ï¼‰

è™½ç„¶ camelCase é—®é¢˜ä¸å­˜åœ¨ï¼Œä½†åœ¨çœŸå®æ•°æ®åº“éªŒè¯æ—¶å‘ç° **Job ä¸ Service çš„æ¥å£å¥‘çº¦ä¸ä¸€è‡´**ï¼Œå¯¼è‡´ä»»åŠ¡ä¼šåœ¨æ£€æµ‹åˆ°å­¤å„¿å†»ç»“æ—¶å´©æºƒã€‚

---

## çœŸå®æ•°æ®åº“éªŒè¯ç»“æœ

### éªŒè¯ç¯å¢ƒ

- **æ•°æ®åº“è¿æ¥**ï¼šä½¿ç”¨é¡¹ç›®æ ¹ç›®å½• `.env` é…ç½®çš„çœŸå® MySQL æ•°æ®åº“
- **éªŒè¯æ–¹å¼**ï¼šé€šè¿‡ Node.js + Sequelize ç›´è¿æ•°æ®åº“ï¼ˆä¸ä¾èµ– mysql å®¢æˆ·ç«¯ï¼‰
- **æ‰§è¡Œæ¨¡å¼**ï¼šdry-runï¼ˆåªè¯»æ¼”ç»ƒï¼Œä¸ä¿®æ”¹æ•°æ®åº“ï¼Œä¸å‘é€é€šçŸ¥ï¼‰

### éªŒè¯å‘½ä»¤

```bash
cd /home/devbox/project && \
DOTENV_CONFIG_PATH=/home/devbox/project/.env \
node -r dotenv/config -e "
(async()=>{
  const services=require('./services');
  await services.initialize();
  const Job=require('./jobs/daily-orphan-frozen-check');
  const report=await Job.execute({dryRun:true, sendNotification:false});
  console.log(JSON.stringify({
    status:report.status,
    orphan_count:report.detection?.orphan_count,
    total_orphan_amount:report.detection?.total_orphan_amount
  }, null, 2));
  process.exit(report.status==='OK'?0:1);
})().catch(e=>{
  console.error('JOB_FAILED', e && e.message);
  process.exit(2);
});
"
```

### éªŒè¯ç»“æœ

#### 1. æœåŠ¡åˆå§‹åŒ–æˆåŠŸ

```
âœ… V4æœåŠ¡ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆï¼ˆP1-9 snake_case keyï¼‰
ğŸ“Š å·²æ³¨å†ŒæœåŠ¡ï¼ˆå…±45ä¸ªï¼‰: ..., orphan_frozen_cleanup, ...
```

#### 2. çœŸå®æ•°æ®åº“æŸ¥è¯¢æˆåŠŸ

```sql
-- æŸ¥è¯¢æœ‰å†»ç»“ä½™é¢çš„è´¦æˆ·
SELECT `AccountAssetBalance`.`balance_id`, ...
FROM `account_asset_balances` AS `AccountAssetBalance`
INNER JOIN `accounts` AS `account`
WHERE `AccountAssetBalance`.`frozen_amount` > 0;

-- æŸ¥è¯¢æ´»è·ƒæŒ‚ç‰Œæ±‡æ€»
SELECT `seller_user_id`, `offer_asset_code`, SUM(`offer_amount`) AS `total_listed`
FROM `market_listings` AS `MarketListing`
WHERE `MarketListing`.`status` = 'on_sale'
GROUP BY `seller_user_id`, `offer_asset_code`;
```

#### 3. æ£€æµ‹åˆ°çœŸå®å­¤å„¿å†»ç»“

```
[å­¤å„¿å†»ç»“æ£€æµ‹] æ£€æµ‹å®Œæˆï¼Œå‘ç° 1 æ¡å­¤å„¿å†»ç»“
{
  "total_checked": 1,
  "orphan_count": 1
}
```

#### 4. ä»»åŠ¡å´©æºƒï¼ˆTypeErrorï¼‰

```
TypeError: Cannot read properties of undefined (reading 'slice')
    at DailyOrphanFrozenCheck.execute (/home/devbox/project/jobs/daily-orphan-frozen-check.js:70:51)
```

**è¯´æ˜**ï¼šçœŸå®æ•°æ®åº“ä¸­ç¡®å®å­˜åœ¨ 1 æ¡å­¤å„¿å†»ç»“è®°å½•ï¼Œä½†ä»»åŠ¡åœ¨å°è¯•å¤„ç†æ—¶å› æ¥å£ä¸ä¸€è‡´è€Œå´©æºƒã€‚

---

## æ ¸å¿ƒé—®é¢˜åˆ†æ

### é—®é¢˜ 1ï¼š`detectOrphanFrozen()` è¿”å›ç±»å‹ä¸ä¸€è‡´

#### Service å®é™…è¿”å›ï¼ˆæ•°ç»„ï¼‰

**æ–‡ä»¶**ï¼š`services/OrphanFrozenCleanupService.js` ç¬¬ 50-160 è¡Œ

```javascript
static async detectOrphanFrozen(options = {}) {
  // ... æ£€æµ‹é€»è¾‘ ...

  const orphanFrozenList = []

  for (const balance of frozenBalances) {
    if (frozenAmount > listedAmount) {
      orphanFrozenList.push({
        user_id: userId,
        account_id: balance.account_id,
        asset_code: balance.asset_code,
        frozen_amount: frozenAmount,
        listed_amount: listedAmount,
        orphan_amount: orphanAmount,
        available_amount: parseInt(balance.available_amount, 10),
        description: `å†»ç»“ ${frozenAmount}ï¼Œæ´»è·ƒæŒ‚ç‰Œ ${listedAmount}ï¼Œå­¤å„¿é¢ ${orphanAmount}`
      })
    }
  }

  logger.info(`[å­¤å„¿å†»ç»“æ£€æµ‹] æ£€æµ‹å®Œæˆï¼Œå‘ç° ${orphanFrozenList.length} æ¡å­¤å„¿å†»ç»“`)

  return orphanFrozenList  // âœ… è¿”å›æ•°ç»„
}
```

#### Job æœŸæœ›çš„è¿”å›ï¼ˆå¯¹è±¡ï¼‰

**æ–‡ä»¶**ï¼š`jobs/daily-orphan-frozen-check.js` ç¬¬ 60-70 è¡Œ

```javascript
// 1. å…ˆæ£€æµ‹å­¤å„¿å†»ç»“
const detectResult = await orphanFrozenService.detectOrphanFrozen({
  limit: 1000
})

const report = {
  timestamp: new Date().toISOString(),
  dryRun,
  detection: {
    orphan_count: detectResult.orphan_count, // âŒ undefined
    total_orphan_amount: detectResult.total_orphan_amount, // âŒ undefined
    orphan_items: detectResult.orphan_items.slice(0, 10) // âŒ TypeError: Cannot read properties of undefined (reading 'slice')
  }
  // ...
}
```

**é—®é¢˜**ï¼š

- Service è¿”å›çš„æ˜¯ `Array`ï¼ˆå­¤å„¿å†»ç»“è®°å½•åˆ—è¡¨ï¼‰
- Job æŠŠè¿”å›å€¼å½“æˆ `Object`ï¼Œè®¿é—® `.orphan_count`ã€`.total_orphan_amount`ã€`.orphan_items`
- å¯¼è‡´ `detectResult.orphan_items` ä¸º `undefined`ï¼Œè°ƒç”¨ `.slice()` æ—¶æŠ›å‡º `TypeError`

---

### é—®é¢˜ 2ï¼š`cleanupOrphanFrozen()` å‚æ•°åä¸ä¸€è‡´

#### Service æœŸæœ›çš„å‚æ•°ï¼ˆsnake_caseï¼‰

**æ–‡ä»¶**ï¼š`services/OrphanFrozenCleanupService.js` ç¬¬ 176-188 è¡Œ

```javascript
static async cleanupOrphanFrozen(options = {}) {
  const {
    dry_run = true,        // âœ… snake_case
    user_id,
    asset_code,
    operator_id,           // âœ… å¿…å¡«ï¼ˆé dry_run æ—¶ï¼‰
    reason = 'å­¤å„¿å†»ç»“è‡ªåŠ¨æ¸…ç†ï¼ˆäº§å“å†³ç­–ï¼šç”¨æˆ·ä½“éªŒä¼˜å…ˆï¼‰'
  } = options

  // å‚æ•°éªŒè¯
  if (!dry_run && !operator_id) {
    throw new Error('å®é™…æ¸…ç†æ“ä½œéœ€è¦æä¾› operator_id')
  }
  // ...
}
```

#### Job ä¼ é€’çš„å‚æ•°ï¼ˆcamelCase + null operator_idï¼‰

**æ–‡ä»¶**ï¼š`jobs/daily-orphan-frozen-check.js` ç¬¬ 85-91 è¡Œ

```javascript
if (!dryRun) {
  // æ‰§è¡Œå®é™…æ¸…ç†
  const cleanupResult = await orphanFrozenService.cleanupOrphanFrozen({
    reason: 'æ¯æ—¥å®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ¸…ç†',
    operator_id: null, // âŒ nullï¼ˆä¼šè§¦å‘æ ¡éªŒå¤±è´¥ï¼‰
    operator_name: 'SYSTEM_DAILY_JOB',
    dryRun: false, // âŒ camelCaseï¼ˆService è¯»å–çš„æ˜¯ dry_runï¼‰
    limit: 100
  })
}
```

**é—®é¢˜**ï¼š

1. Job ä¼  `dryRun`ï¼ˆcamelCaseï¼‰ï¼ŒService è¯»å– `dry_run`ï¼ˆsnake_caseï¼‰â†’ Service ä¼šè®¤ä¸º `dry_run=undefined`ï¼ˆé»˜è®¤ `true`ï¼‰ï¼Œå¯¼è‡´å³ä½¿ Job æƒ³æ¸…ç†ä¹Ÿåªä¼šèµ°æ¼”ç»ƒåˆ†æ”¯
2. Job ä¼  `operator_id: null`ï¼ŒService æ ¡éªŒä¼šæŠ›é”™ï¼š`å®é™…æ¸…ç†æ“ä½œéœ€è¦æä¾› operator_id`

---

### é—®é¢˜ 3ï¼š`cleanupOrphanFrozen()` è¿”å›å­—æ®µä¸ä¸€è‡´

#### Service å®é™…è¿”å›

```javascript
const result = {
  detected: orphanList.length,     // âœ… Service è¿”å›
  cleaned: 0,                      // âœ… Service è¿”å›
  failed: 0,                       // âœ… Service è¿”å›
  total_amount: orphanList.reduce(...),
  details: [],
  dry_run
}
return result
```

#### Job æœŸæœ›çš„è¿”å›

```javascript
report.cleanup = {
  cleaned_count: cleanupResult.cleaned_count, // âŒ undefinedï¼ˆService è¿”å›çš„æ˜¯ cleanedï¼‰
  total_unfrozen_amount: cleanupResult.total_unfrozen_amount, // âŒ undefinedï¼ˆService è¿”å›çš„æ˜¯ total_amountï¼‰
  failed_count: cleanupResult.failed_count, // âŒ undefinedï¼ˆService è¿”å›çš„æ˜¯ failedï¼‰
  skipped_count: cleanupResult.skipped_count // âŒ undefinedï¼ˆService æ²¡æœ‰è¿™ä¸ªå­—æ®µï¼‰
}
```

---

## å·²æ‹æ¿çš„å†³ç­–

> **å†³ç­–æ—¶é—´**ï¼š2026-01-15  
> **å†³ç­–çŠ¶æ€**ï¼šâœ… å·²æ‹æ¿

---

### å†³ç­– 1ï¼šæƒå¨å¥‘çº¦ âœ… å·²æ‹æ¿

#### æ‹æ¿ç»“æœï¼š**Service ä¸ºæƒå¨ï¼ˆé¢†åŸŸå¥‘çº¦ï¼‰ï¼ŒJob é€‚é… Service**

**æ ¸å¿ƒåŸåˆ™**ï¼š

- **Serviceï¼ˆé¢†åŸŸæœåŠ¡ï¼‰**ï¼šè´Ÿè´£"å­¤å„¿å†»ç»“"çš„ä¸šåŠ¡å®šä¹‰ã€è®¡ç®—å£å¾„ã€é”/äº‹åŠ¡ã€èµ„äº§å˜æ›´å…¥å£ã€å®¡è®¡æµæ°´ã€‚æ˜¯ç³»ç»Ÿé‡Œå”¯ä¸€å¯ä¿¡çš„"èµ„äº§çœŸç›¸å£å¾„"æä¾›è€…ã€‚
- **Jobï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰**ï¼šæœ¬è´¨æ˜¯ç¼–æ’å™¨ï¼Œè´Ÿè´£"ä»€ä¹ˆæ—¶å€™è·‘ã€è·‘å“ªäº›èŒƒå›´ã€dry-run/å‘Šè­¦ã€é™é¢é˜ˆå€¼ã€è¾“å‡ºæŠ¥å‘Š"ã€‚ä¸åº”è¯¥å®šä¹‰å£å¾„ï¼Œä¸åº”è¯¥å’Œå¤šä¸ªåœ°æ–¹å„è‡ªç®—ä¸€å¥—å£å¾„ã€‚

**å®æ–½è¦ç‚¹**ï¼š

1. **å¼ºåˆ¶åˆ‡æ¢**ï¼šæŠŠ `detectOrphanFrozen()` ä»è¿”å›è£¸æ•°ç»„æ”¹æˆè¿”å›**ç¨³å®š DTO å¯¹è±¡**
2. **ä¸€æ¬¡æ€§æ”¹å®Œæ‰€æœ‰è°ƒç”¨ç‚¹**ï¼šdetect/cleanup çš„å¥‘çº¦åŒä¸€ä¸ªå‘å¸ƒåŒ…é‡Œå®Œæˆ
3. **ç‰ˆæœ¬åŒ–/å…¼å®¹æ€§**ï¼šæŠŠå¥‘çº¦å†™æ­»åœ¨ Service è¾“å‡ºä¸Šï¼Œä¸é "å¤§å®¶è®°å¾—æ•°ç»„/å¯¹è±¡æ˜¯ä»€ä¹ˆ"

#### DTO å¥‘çº¦å®šä¹‰ï¼ˆdetect è¿”å›ï¼‰

| å­—æ®µ                  | ç±»å‹                | å¿…å¡« | è¯´æ˜                                            |
| --------------------- | ------------------- | ---- | ----------------------------------------------- |
| `orphan_count`        | `number`            | âœ…   | å­¤å„¿å†»ç»“æ˜ç»†æ¡æ•°                                |
| `total_orphan_amount` | `number`            | âœ…   | å­¤å„¿å†»ç»“æ€»é¢ï¼ˆå„èµ„äº§å£å¾„ï¼Œä¸ç­‰å€¼æ¢ç®—ï¼‰          |
| `orphan_items`        | `Array<OrphanItem>` | âœ…   | å­¤å„¿å†»ç»“æ˜ç»†åˆ—è¡¨                                |
| `checked_count`       | `number`            | âœ…   | æœ¬æ¬¡æ£€æµ‹çš„è´¦æˆ·æ•°                                |
| `generated_at`        | `string`            | âœ…   | DTO ç”Ÿæˆæ—¶é—´ï¼ˆISO8601ï¼‰                         |
| `affected_user_count` | `number`            | âœ…   | å—å½±å“ç”¨æˆ·æ•°ï¼ˆé£æ§/å‘Šè­¦é‡è¦ï¼‰                   |
| `items_truncated`     | `boolean`           | âœ…   | æ˜ç»†æ˜¯å¦è¢«æˆªæ–­ï¼ˆJob/é€šçŸ¥åªå–å‰ N æ¡æ—¶å¿…é¡»æ ‡æ˜ï¼‰ |

#### orphan_items æœ€å°å­—æ®µé›†ï¼ˆOrphanItemï¼‰

| å­—æ®µ            | ç±»å‹     | å¿…å¡« | è¯´æ˜                          |
| --------------- | -------- | ---- | ----------------------------- |
| `user_id`       | `number` | âœ…   | ç”¨æˆ· ID                       |
| `asset_code`    | `string` | âœ…   | èµ„äº§ä»£ç                       |
| `frozen_amount` | `number` | âœ…   | å½“å‰å†»ç»“é‡‘é¢                  |
| `listed_amount` | `number` | âœ…   | æ´»è·ƒæŒ‚ç‰Œé‡‘é¢                  |
| `orphan_amount` | `number` | âœ…   | å­¤å„¿é‡‘é¢ï¼ˆ= frozen - listedï¼‰ |

#### cleanup å¥‘çº¦åŒæ­¥ä¿®æ­£

**å‚æ•°å¥‘çº¦**ï¼š

- ç»Ÿä¸€ä½¿ç”¨ `dry_run`ï¼ˆsnake_caseï¼‰ï¼Œä¸å†ä¼  `dryRun`
- `operator_id` å¿…å¡«ï¼ˆé dry_run æ—¶ï¼‰

**è¿”å›å¥‘çº¦**ï¼š

| å­—æ®µ                    | ç±»å‹      | è¯´æ˜                 |
| ----------------------- | --------- | -------------------- |
| `cleaned_count`         | `number`  | æˆåŠŸæ¸…ç†æ¡æ•°         |
| `failed_count`          | `number`  | æ¸…ç†å¤±è´¥æ¡æ•°         |
| `total_unfrozen_amount` | `number`  | æ€»è§£å†»é‡‘é¢           |
| `detected_count`        | `number`  | æ£€æµ‹åˆ°çš„å­¤å„¿å†»ç»“æ€»æ•° |
| `details`               | `Array`   | æ¸…ç†æ˜ç»†             |
| `dry_run`               | `boolean` | æ˜¯å¦ä¸ºæ¼”ç»ƒæ¨¡å¼       |

#### è°ƒç”¨ç‚¹ç›˜ç‚¹è¦æ±‚

å…¨ä»“æœ `detectOrphanFrozen(` æŠŠæ‰€æœ‰è°ƒç”¨ç‚¹åˆ†ä¸‰ç±»ï¼š

1. **åªéœ€è¦æ˜ç»†**ï¼šä»¥å‰æ‹¿æ•°ç»„ â†’ ç°åœ¨æ”¹æˆ `dto.orphan_items`
2. **åªè¦æ•°é‡/é‡‘é¢**ï¼šä»¥å‰ `list.length/sum` â†’ ç°åœ¨ç›´æ¥è¯» `dto.orphan_count/total_orphan_amount`
3. **ä¾èµ–æ—§æ•°ç»„è¯­ä¹‰åšå¾ªç¯å¤„ç†**ï¼šæ”¹æˆå¾ªç¯ `dto.orphan_items`

---

### å†³ç­– 2ï¼šoperator_id ç­–ç•¥ âœ… å·²æ‹æ¿

#### æ‹æ¿ç»“æœï¼š**ç³»ç»Ÿæ‰§è¡Œè€…è´¦å·ï¼ˆSYSTEM_DAILY_JOB_USER_IDï¼‰**

**é…ç½®è¦æ±‚**ï¼š

- **ç¯å¢ƒå˜é‡**ï¼š`SYSTEM_DAILY_JOB_USER_ID`
- **ç‹¬ç«‹è§’è‰²**ï¼š`system_job`
- **æƒé™èŒƒå›´**ï¼šåªå…è®¸åšå­¤å„¿å†»ç»“æ¸…ç†ç›¸å…³çš„"è§£å†»/å†™å®¡è®¡"åŠ¨ä½œ

**æ²»ç†è§„åˆ™**ï¼ˆè¡¥å……ï¼‰ï¼š

1. **é™é¢/é™æ¡æ•°**ï¼šè¶…è¿‡é˜ˆå€¼åªå‘Šè­¦ä¸è‡ªåŠ¨æ¸…ç†ï¼ˆé¿å…æç«¯æƒ…å†µä¸‹è¯¯æ¸…ç†æ‰©å¤§åŒ–ï¼‰
2. **å¯è¿½è¸ª run_id + å¹‚ç­‰é”®**ï¼šç¡®ä¿ä¸€æ¬¡å®šæ—¶ä»»åŠ¡çš„æ‰€æœ‰å˜æ›´å¯èšåˆæŸ¥è¯¢ã€å¯å›æ”¾ã€å¯å›æ»š

**å®æ–½æ­¥éª¤**ï¼š

1. åˆ›å»º/æŒ‡å®šç³»ç»Ÿè´¦å·
2. åˆ†é…ç‹¬ç«‹è§’è‰² `system_job`
3. é…ç½® `.env`ï¼š
   ```bash
   SYSTEM_DAILY_JOB_USER_ID=<ç³»ç»Ÿè´¦å·ID>
   ```

---

### å†³ç­– 3ï¼šå®šæ—¶ä»»åŠ¡åŠ¨ä½œç­–ç•¥ âœ… å·²æ‹æ¿

#### æ‹æ¿ç»“æœï¼š**åªæ£€æµ‹ + å‘Šè­¦ + å¤„ç½®å»ºè®®ï¼ˆä¸æ”¹åº“ï¼‰ï¼Œä¿®å¤èµ°äººå·¥/å—æ§å·¥å…·**

**Jobï¼ˆå‡Œæ™¨2ç‚¹ï¼‰èŒè´£**ï¼š

- âœ… è®¡ç®—å·®å¼‚ã€åˆ—å‡ºæ˜ç»†ã€æ±‡æ€»é‡‘é¢
- âœ… æ‰“æ ‡ç­¾ï¼ˆä¸¥é‡ç­‰çº§ï¼‰
- âœ… å‘Šè­¦é€šçŸ¥ç®¡ç†å‘˜/å€¼ç­
- âœ… **å¯é€‰æ­¢æŸ**ï¼ˆä¸æ¶‰åŠä½™é¢å˜åŒ–ï¼‰ï¼šå¯¹"å·®å¼‚å¾ˆå¤§/é‡å¤å‡ºç°"çš„è´¦å·ï¼Œä¸´æ—¶é™åˆ¶ä¸Šæ¶/äº¤æ˜“

**ä¿®å¤å…¥å£ï¼ˆåå°ï¼‰**ï¼š

- æä¾›"ç”Ÿæˆä¿®å¤å•/æ‰§è¡Œä¿®å¤"çš„ç®¡ç†æ¥å£æˆ–åå°é¡µé¢
- å¿…é¡»åŒ…å«ï¼š`operator_id`ã€`reason`ã€å®¡æ‰¹/å¤æ ¸ï¼ˆè‡³å°‘"äºŒæ¬¡ç¡®è®¤+é˜ˆå€¼åˆ†çº§"ï¼‰

**äººå·¥ä¿®å¤æµç¨‹ç­‰çº§**ï¼š

- å•äººå¯æ‰§è¡Œï¼ˆä½†å¼ºåˆ¶è®°å½•å®¡è®¡ï¼‰

---

### å†³ç­– 4ï¼šå‘Šè­¦åˆ†çº§é˜ˆå€¼ç­–ç•¥ âœ… å·²æ‹æ¿

#### æ‹æ¿ç»“æœï¼š**ä¸‰ç»´é˜ˆå€¼ï¼ˆå½±å“é¢ + ä¸¥é‡åº¦ + è¶‹åŠ¿/å¤å‘ï¼‰**

**é˜ˆå€¼ç»´åº¦å®šä¹‰**ï¼š

| ç»´åº¦                      | æŒ‡æ ‡                   | è¯´æ˜                                                     |
| ------------------------- | ---------------------- | -------------------------------------------------------- |
| **å½±å“é¢**ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰    | `affected_users`       | å½±å“ç”¨æˆ·æ•°                                               |
|                           | `affected_asset_codes` | å½±å“èµ„äº§ç§ç±»æ•°                                           |
|                           | `orphan_items_count`   | å­¤å„¿å†»ç»“æ˜ç»†æ¡æ•°                                         |
| **ä¸¥é‡åº¦**ï¼ˆå¯é€‰ï¼‰        | `total_orphan_amount`  | æ€»å­¤å„¿é¢ï¼ˆæŒ‰æ¯ä¸ª asset_code å„è‡ªå£å¾„ï¼Œä¸å¿…å¼ºè¡Œç­‰å€¼æ¢ç®—ï¼‰ |
| **è¶‹åŠ¿/å¤å‘**ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰ | è¿ç»­ N å¤©å‡ºç°          | æˆ– 1 å°æ—¶å†…æ¿€å¢ã€æˆ–åŒä¸€ asset_code åå¤å‡ºç°              |

#### å‘Šè­¦åˆ†çº§æ ‡å‡†

| çº§åˆ«   | å“åº”æ—¶é—´ | è§¦å‘æ¡ä»¶ï¼ˆæ»¡è¶³ä»»ä¸€ï¼‰                                                                                                                                                   | åŠ¨ä½œ                                                                          |
| ------ | -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------- |
| **P0** | 1å°æ—¶å†…  | `affected_asset_codes >= 3`ï¼ˆå¤šèµ„äº§åŒæ—¶å¼‚å¸¸ï¼Œå¼ºçƒˆåƒç³»ç»Ÿ bugï¼‰<br>æˆ– `affected_users >= 5`<br>æˆ– `orphan_items_count >= 20`<br>æˆ– "è¿ç»­ 2 æ¬¡è°ƒåº¦éƒ½å‘ç°å­¤å„¿å†»ç»“"ï¼ˆå¤å‘ï¼‰ | ç«‹åˆ»å‘Šè­¦åˆ°å€¼ç­<br>**å¯é€‰æ­¢æŸ**ï¼šæš‚åœç›¸å…³ asset_code çš„ä¸Šæ¶/æ–°æŒ‚å•ï¼ˆä¸æ”¹ä½™é¢ï¼‰ |
| **P1** | 4å°æ—¶å†…  | `affected_asset_codes == 2`<br>æˆ– `affected_users` 2~4<br>æˆ– `orphan_items_count` 5~19                                                                                 | å‘Šè­¦ + è‡ªåŠ¨ç”Ÿæˆå¤„ç†æ¸…å•ï¼ˆæŒ‰ user_id/asset_code æ’åºï¼‰                         |
| **P2** | 24å°æ—¶å†… | `affected_asset_codes == 1`<br>ä¸” `affected_users == 1`<br>ä¸” `orphan_items_count < 5`                                                                                 | ä½ä¼˜å…ˆçº§å‘Šè­¦ï¼ˆå¯åˆå¹¶æ—¥æŠ¥ï¼‰                                                    |

#### ç®€åŒ–ç‰ˆé˜ˆå€¼ï¼ˆä»…æŒ‰èµ„äº§ç§ç±»æ•°ï¼‰

å¦‚æœå¸Œæœ›"å®Œå…¨æŒ‰èµ„äº§ç§ç±»æ•°ç›®æ¥å®š"ï¼š

- `>= 3`ï¼šP0
- `== 2`ï¼šP1
- `== 1`ï¼šP2

> âš ï¸ **å¼ºçƒˆå»ºè®®ä¿ç•™ `affected_users` è¿™ä¸€æ¡**ï¼Œå¦åˆ™"ä¸€ç§èµ„äº§å½±å“ 100 äºº"ä¼šè¢«è¯¯åˆ¤ä¸ºä½çº§ã€‚

#### æ­¢æŸç­–ç•¥ï¼ˆä¸æ”¹ä½™é¢ï¼‰

**å…è®¸çš„æ­¢æŸåŠ¨ä½œ**ï¼ˆP0 æ—¶å¯è‡ªåŠ¨æ‰§è¡Œï¼‰ï¼š

- âœ… æš‚åœç›¸å…³ `asset_code` çš„æ–°æŒ‚å•
- âœ… æš‚åœç›¸å…³ `asset_code` çš„äº¤æ˜“å…¥å£
- âœ… é™åˆ¶å¼‚å¸¸è´¦å·çš„ä¸Šæ¶æƒé™
- âŒ **ä¸å…è®¸**è‡ªåŠ¨è§£å†»/æ”¹ä½™é¢

---

## ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆæ€»è§ˆï¼ˆåŸºäºå·²æ‹æ¿å†³ç­–ï¼‰

| ä¿®å¤é¡¹                   | æ–‡ä»¶                                     | æ”¹åŠ¨ç±»å‹ | ä¼˜å…ˆçº§ | è¯´æ˜                 |
| ------------------------ | ---------------------------------------- | -------- | ------ | -------------------- |
| 1. Service è¿”å› DTO å¯¹è±¡ | `services/OrphanFrozenCleanupService.js` | é‡æ„     | P0     | detect è¿”å›ç¨³å®š DTO  |
| 2. å…¨å±€ç›˜ç‚¹å¹¶åˆ‡æ¢è°ƒç”¨ç‚¹  | å…¨ä»“ `detectOrphanFrozen(`               | ä¿®æ”¹     | P0     | ä¸€æ¬¡æ€§æ”¹å®Œæ‰€æœ‰è°ƒç”¨ç‚¹ |
| 3. cleanup å¥‘çº¦ç»Ÿä¸€      | `services/OrphanFrozenCleanupService.js` | ä¿®æ”¹     | P0     | å‚æ•°/è¿”å›å­—æ®µç»Ÿä¸€    |
| 4. Job æ”¹ä¸ºåªæ£€æµ‹+å‘Šè­¦   | `jobs/daily-orphan-frozen-check.js`      | é‡æ„     | P0     | ä¸å†è‡ªåŠ¨æ¸…ç†         |
| 5. å‘Šè­¦åˆ†çº§é€»è¾‘          | `jobs/daily-orphan-frozen-check.js`      | æ–°å¢     | P0     | P0/P1/P2 åˆ†çº§        |
| 6. æ­¢æŸèƒ½åŠ›ï¼ˆå¯é€‰ï¼‰      | `services/MarketListingService.js`       | æ–°å¢     | P1     | æš‚åœæŒ‚å•/äº¤æ˜“        |
| 7. åå°ä¿®å¤å…¥å£          | `routes/v4/console/orphan-frozen.js`     | æ–°å¢     | P1     | äººå·¥ä¿®å¤æ¥å£         |
| 8. é…ç½®ç³»ç»Ÿæ‰§è¡Œè€…è´¦å·    | `.env` + æ•°æ®åº“                          | é…ç½®     | P0     | system_job è§’è‰²      |

---

### ä¿®å¤ 1ï¼šService è¿”å› DTO å¯¹è±¡ï¼ˆP0ï¼‰

**æ–‡ä»¶**ï¼š`services/OrphanFrozenCleanupService.js`

**ä¿®æ”¹ä½ç½®**ï¼š`detectOrphanFrozen()` æ–¹æ³•

**ä¿®æ”¹å‰**ï¼ˆè¿”å›è£¸æ•°ç»„ï¼‰ï¼š

```javascript
static async detectOrphanFrozen(options = {}) {
  // ... æ£€æµ‹é€»è¾‘ ...

  const orphanFrozenList = []
  // ... æ„å»ºåˆ—è¡¨ ...

  return orphanFrozenList  // âŒ è¿”å›è£¸æ•°ç»„
}
```

**ä¿®æ”¹å**ï¼ˆè¿”å›ç¨³å®š DTOï¼‰ï¼š

```javascript
/**
 * æ£€æµ‹å­¤å„¿å†»ç»“
 *
 * @param {Object} options - é€‰é¡¹
 * @param {number} options.user_id - æŒ‡å®šç”¨æˆ·IDï¼ˆå¯é€‰ï¼‰
 * @param {string} options.asset_code - æŒ‡å®šèµ„äº§ä»£ç ï¼ˆå¯é€‰ï¼‰
 * @param {number} options.limit - æœ€å¤§è¿”å›æ¡æ•°ï¼ˆé»˜è®¤ 1000ï¼‰
 * @returns {Promise<OrphanFrozenDetectDTO>} ç¨³å®š DTO å¯¹è±¡
 */
static async detectOrphanFrozen(options = {}) {
  const { user_id, asset_code, limit = 1000 } = options
  const startTime = Date.now()

  // ... æ£€æµ‹é€»è¾‘ä¿æŒä¸å˜ ...

  const orphanFrozenList = []
  const affectedUserIds = new Set()
  const affectedAssetCodes = new Set()

  for (const balance of frozenBalances) {
    // ... åŸæœ‰æ£€æµ‹é€»è¾‘ ...
    if (frozenAmount > listedAmount) {
      const orphanItem = {
        user_id: userId,
        account_id: balance.account_id,
        asset_code: balance.asset_code,
        frozen_amount: frozenAmount,
        listed_amount: listedAmount,
        orphan_amount: orphanAmount,
        available_amount: parseInt(balance.available_amount, 10),
        description: `å†»ç»“ ${frozenAmount}ï¼Œæ´»è·ƒæŒ‚ç‰Œ ${listedAmount}ï¼Œå­¤å„¿é¢ ${orphanAmount}`
      }
      orphanFrozenList.push(orphanItem)
      affectedUserIds.add(userId)
      affectedAssetCodes.add(balance.asset_code)
    }
  }

  // âœ… è¿”å›ç¨³å®š DTO å¯¹è±¡
  const dto = {
    // å¿…å¡«å­—æ®µ
    orphan_count: orphanFrozenList.length,
    total_orphan_amount: orphanFrozenList.reduce((sum, item) => sum + item.orphan_amount, 0),
    orphan_items: orphanFrozenList.slice(0, limit),
    checked_count: frozenBalances.length,
    generated_at: new Date().toISOString(),

    // æ–°å¢å­—æ®µï¼ˆé£æ§/å‘Šè­¦é‡è¦ï¼‰
    affected_user_count: affectedUserIds.size,
    affected_asset_codes: Array.from(affectedAssetCodes),
    items_truncated: orphanFrozenList.length > limit,

    // å…ƒæ•°æ®
    _meta: {
      query_options: { user_id, asset_code, limit },
      execution_time_ms: Date.now() - startTime
    }
  }

  logger.info('[å­¤å„¿å†»ç»“æ£€æµ‹] æ£€æµ‹å®Œæˆ', {
    orphan_count: dto.orphan_count,
    affected_user_count: dto.affected_user_count,
    affected_asset_codes: dto.affected_asset_codes.length,
    items_truncated: dto.items_truncated
  })

  return dto
}
```

---

### ä¿®å¤ 2ï¼šå…¨å±€ç›˜ç‚¹å¹¶åˆ‡æ¢è°ƒç”¨ç‚¹ï¼ˆP0ï¼‰

**æ‰§è¡Œå‘½ä»¤**ï¼š

```bash
grep -rn "detectOrphanFrozen(" --include="*.js" /home/devbox/project
```

**è°ƒç”¨ç‚¹åˆ†ç±»å’Œä¿®æ”¹**ï¼š

| è°ƒç”¨ç‚¹                                                          | åŸä»£ç                                    | ä¿®æ”¹å                                   |
| --------------------------------------------------------------- | ---------------------------------------- | ---------------------------------------- |
| `jobs/daily-orphan-frozen-check.js`                             | `detectResult.orphan_count`              | `dto.orphan_count`                       |
|                                                                 | `detectResult.total_orphan_amount`       | `dto.total_orphan_amount`                |
|                                                                 | `detectResult.orphan_items.slice(0, 10)` | `dto.orphan_items.slice(0, 10)`          |
| `services/OrphanFrozenCleanupService.js` (cleanupOrphanFrozen)  | `orphanList.length`                      | `dto.orphan_count`                       |
|                                                                 | `orphanList.reduce(...)`                 | `dto.total_orphan_amount`                |
|                                                                 | `for (const orphan of orphanList)`       | `for (const orphan of dto.orphan_items)` |
| `services/OrphanFrozenCleanupService.js` (getOrphanFrozenStats) | `orphanList.length`                      | `dto.orphan_count`                       |
|                                                                 | `orphanList.reduce(...)`                 | `dto.total_orphan_amount`                |
| å…¶ä»–è°ƒç”¨ç‚¹                                                      | æŒ‰å®é™…æƒ…å†µè°ƒæ•´                           | ç»Ÿä¸€ä½¿ç”¨ DTO å­—æ®µ                        |

---

### ä¿®å¤ 3ï¼šcleanup å¥‘çº¦ç»Ÿä¸€ï¼ˆP0ï¼‰

**æ–‡ä»¶**ï¼š`services/OrphanFrozenCleanupService.js`

**å‚æ•°å¥‘çº¦ä¿®æ”¹**ï¼š

```javascript
static async cleanupOrphanFrozen(options = {}) {
  const {
    dry_run = true,           // âœ… snake_case
    user_id,
    asset_code,
    operator_id,              // âœ… å¿…å¡«ï¼ˆé dry_run æ—¶ï¼‰
    reason = 'å­¤å„¿å†»ç»“æ¸…ç†',
    limit = 100
  } = options

  // å‚æ•°éªŒè¯
  if (!dry_run && !operator_id) {
    throw new Error('å®é™…æ¸…ç†æ“ä½œéœ€è¦æä¾› operator_id')
  }

  // ...
}
```

**è¿”å›å¥‘çº¦ä¿®æ”¹**ï¼š

```javascript
const result = {
  cleaned_count: cleanedCount, // âœ… ç»Ÿä¸€å­—æ®µå
  failed_count: failedCount, // âœ… ç»Ÿä¸€å­—æ®µå
  total_unfrozen_amount: totalUnfrozen, // âœ… ç»Ÿä¸€å­—æ®µå
  detected_count: orphanList.length, // âœ… æ–°å¢
  details: cleanupDetails,
  dry_run: dry_run
}
return result
```

---

### ä¿®å¤ 4ï¼šJob æ”¹ä¸ºåªæ£€æµ‹+å‘Šè­¦ï¼ˆP0ï¼‰

**æ–‡ä»¶**ï¼š`jobs/daily-orphan-frozen-check.js`

**æ ¸å¿ƒå˜æ›´**ï¼šJob ä¸å†è°ƒç”¨ `cleanupOrphanFrozen()`ï¼Œåªåšæ£€æµ‹å’Œå‘Šè­¦

**ä¿®æ”¹å**ï¼š

```javascript
static async execute(options = {}) {
  const { sendNotification = true } = options
  const startTime = Date.now()

  logger.info('å¼€å§‹æ¯æ—¥å­¤å„¿å†»ç»“æ£€æµ‹ä»»åŠ¡')

  try {
    const orphanFrozenService = serviceManager.getService('orphan_frozen_cleanup')

    // 1. æ£€æµ‹å­¤å„¿å†»ç»“ï¼ˆè¿”å› DTOï¼‰
    const dto = await orphanFrozenService.detectOrphanFrozen({
      limit: 1000
    })

    // 2. æ„å»ºæŠ¥å‘Š
    const report = {
      timestamp: new Date().toISOString(),
      detection: {
        orphan_count: dto.orphan_count,
        total_orphan_amount: dto.total_orphan_amount,
        affected_user_count: dto.affected_user_count,
        affected_asset_codes: dto.affected_asset_codes,
        orphan_items: dto.orphan_items.slice(0, 10),  // æŠ¥å‘Šåªå–å‰ 10 æ¡
        items_truncated: dto.items_truncated
      },
      alert_level: null,  // å‘Šè­¦çº§åˆ«
      actions: [],        // å»ºè®®åŠ¨ä½œ
      duration_ms: 0,
      status: 'OK'
    }

    // 3. å‘Šè­¦åˆ†çº§ï¼ˆä¸è‡ªåŠ¨æ¸…ç†ï¼‰
    if (dto.orphan_count > 0) {
      report.alert_level = this._determineAlertLevel(dto)
      report.actions = this._generateActionSuggestions(dto, report.alert_level)
      report.status = report.alert_level === 'P0' ? 'CRITICAL' :
                      report.alert_level === 'P1' ? 'WARNING' : 'INFO'

      logger.warn(`æ£€æµ‹åˆ°å­¤å„¿å†»ç»“ [${report.alert_level}]`, {
        orphan_count: dto.orphan_count,
        affected_users: dto.affected_user_count,
        affected_assets: dto.affected_asset_codes.length
      })

      // 4. å‘é€åˆ†çº§å‘Šè­¦ï¼ˆä¸æ‰§è¡Œæ¸…ç†ï¼‰
      if (sendNotification) {
        await this._sendAlertNotification(report)
      }

      // 5. å¯é€‰æ­¢æŸï¼ˆP0 çº§åˆ«æ—¶ï¼‰
      if (report.alert_level === 'P0') {
        await this._executeStopLoss(dto)
      }
    } else {
      logger.info('æœªæ£€æµ‹åˆ°å­¤å„¿å†»ç»“ï¼Œç³»ç»ŸçŠ¶æ€è‰¯å¥½')
    }

    report.duration_ms = Date.now() - startTime
    this._outputReport(report)

    return report
  } catch (error) {
    logger.error('æ¯æ—¥å­¤å„¿å†»ç»“æ£€æµ‹ä»»åŠ¡å¤±è´¥', { error: error.message })
    if (sendNotification) {
      await this._sendErrorNotification(error)
    }
    throw error
  }
}
```

---

### ä¿®å¤ 5ï¼šå‘Šè­¦åˆ†çº§é€»è¾‘ï¼ˆP0ï¼‰

**æ–‡ä»¶**ï¼š`jobs/daily-orphan-frozen-check.js`

**æ–°å¢æ–¹æ³•**ï¼š

```javascript
/**
 * åˆ¤æ–­å‘Šè­¦çº§åˆ«
 *
 * P0ï¼ˆ1å°æ—¶å†…å“åº”ï¼‰ï¼š
 * - affected_asset_codes >= 3ï¼ˆå¤šèµ„äº§åŒæ—¶å¼‚å¸¸ï¼‰
 * - æˆ– affected_users >= 5
 * - æˆ– orphan_items_count >= 20
 * - æˆ– è¿ç»­ 2 æ¬¡è°ƒåº¦éƒ½å‘ç°å­¤å„¿å†»ç»“ï¼ˆå¤å‘ï¼‰
 *
 * P1ï¼ˆ4å°æ—¶å†…å“åº”ï¼‰ï¼š
 * - affected_asset_codes == 2
 * - æˆ– affected_users 2~4
 * - æˆ– orphan_items_count 5~19
 *
 * P2ï¼ˆ24å°æ—¶å†…å“åº”ï¼‰ï¼š
 * - affected_asset_codes == 1 ä¸” affected_users == 1 ä¸” orphan_items_count < 5
 */
static _determineAlertLevel(dto) {
  const { orphan_count, affected_user_count, affected_asset_codes } = dto
  const assetCount = affected_asset_codes.length

  // P0 åˆ¤å®š
  if (assetCount >= 3 || affected_user_count >= 5 || orphan_count >= 20) {
    return 'P0'
  }

  // TODO: æ£€æŸ¥æ˜¯å¦å¤å‘ï¼ˆéœ€è¦æŒä¹…åŒ–ä¸Šæ¬¡æ£€æµ‹ç»“æœï¼‰
  // if (this._isRecurring()) return 'P0'

  // P1 åˆ¤å®š
  if (assetCount === 2 ||
      (affected_user_count >= 2 && affected_user_count <= 4) ||
      (orphan_count >= 5 && orphan_count < 20)) {
    return 'P1'
  }

  // P2ï¼ˆé»˜è®¤ï¼‰
  return 'P2'
}

/**
 * ç”Ÿæˆå¤„ç½®å»ºè®®
 */
static _generateActionSuggestions(dto, alertLevel) {
  const actions = []

  switch (alertLevel) {
    case 'P0':
      actions.push('âš ï¸ ç«‹åˆ»é€šçŸ¥å€¼ç­äººå‘˜')
      actions.push('ğŸ”’ å»ºè®®æš‚åœç›¸å…³èµ„äº§çš„æ–°æŒ‚å•')
      actions.push('ğŸ” æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç³»ç»Ÿçº§ bug')
      actions.push('ğŸ“‹ ç™»å½•åå°æ‰§è¡Œäººå·¥ä¿®å¤ï¼šæ§åˆ¶å° > å­¤å„¿å†»ç»“ç®¡ç†')
      break
    case 'P1':
      actions.push('ğŸ“‹ è¯·åœ¨ 4 å°æ—¶å†…å¤„ç†')
      actions.push('ğŸ“‹ ç™»å½•åå°æŸ¥çœ‹å¤„ç†æ¸…å•')
      break
    case 'P2':
      actions.push('ğŸ“‹ å¯åˆå¹¶è‡³æ—¥æŠ¥å¤„ç†')
      break
  }

  return actions
}

/**
 * æ‰§è¡Œæ­¢æŸï¼ˆä¸æ”¹ä½™é¢ï¼‰
 */
static async _executeStopLoss(dto) {
  try {
    const MarketListingService = serviceManager.getService('market_listing')

    // æš‚åœç›¸å…³èµ„äº§çš„æ–°æŒ‚å•
    for (const assetCode of dto.affected_asset_codes) {
      await MarketListingService.pauseListingForAsset(assetCode, {
        reason: 'å­¤å„¿å†»ç»“å¼‚å¸¸æ­¢æŸ',
        duration_hours: 24  // æš‚åœ 24 å°æ—¶
      })
      logger.warn(`[æ­¢æŸ] å·²æš‚åœèµ„äº§ ${assetCode} çš„æ–°æŒ‚å•`, { duration: '24h' })
    }
  } catch (error) {
    logger.error('[æ­¢æŸ] æ‰§è¡Œæ­¢æŸå¤±è´¥', { error: error.message })
    // æ­¢æŸå¤±è´¥ä¸é˜»æ–­ä¸»æµç¨‹
  }
}
```

---

### ä¿®å¤ 6ï¼šåå°ä¿®å¤å…¥å£ï¼ˆP1ï¼‰

**æ–‡ä»¶**ï¼š`routes/v4/console/orphan-frozen.js`

**æ–°å¢æ¥å£**ï¼š

```javascript
/**
 * POST /api/v4/console/orphan-frozen/cleanup
 *
 * äººå·¥ä¿®å¤å­¤å„¿å†»ç»“ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
 *
 * Body:
 * - user_id: æŒ‡å®šç”¨æˆ·ï¼ˆå¯é€‰ï¼‰
 * - asset_code: æŒ‡å®šèµ„äº§ï¼ˆå¯é€‰ï¼‰
 * - reason: ä¿®å¤åŸå› ï¼ˆå¿…å¡«ï¼‰
 * - dry_run: æ˜¯å¦æ¼”ç»ƒï¼ˆé»˜è®¤ trueï¼‰
 */
router.post('/cleanup', adminAuth, async (req, res) => {
  try {
    const { user_id, asset_code, reason, dry_run = true } = req.body
    const operator_id = req.user.user_id

    if (!reason) {
      return res.apiError('ä¿®å¤åŸå› ä¸èƒ½ä¸ºç©º', 'MISSING_REASON', null, 400)
    }

    const OrphanFrozenCleanupService = req.app.locals.services.getService('orphan_frozen_cleanup')

    const result = await OrphanFrozenCleanupService.cleanupOrphanFrozen({
      user_id,
      asset_code,
      reason,
      operator_id,
      dry_run
    })

    // å®¡è®¡æ—¥å¿—
    await AuditLogService.log({
      operator_id,
      action: 'orphan_frozen_manual_cleanup',
      target_type: 'orphan_frozen',
      details: {
        user_id,
        asset_code,
        reason,
        dry_run,
        result: {
          cleaned_count: result.cleaned_count,
          failed_count: result.failed_count,
          total_unfrozen_amount: result.total_unfrozen_amount
        }
      }
    })

    return res.apiSuccess(result, dry_run ? 'æ¼”ç»ƒå®Œæˆ' : 'ä¿®å¤å®Œæˆ')
  } catch (error) {
    return res.apiError(error.message, 'CLEANUP_FAILED', null, 500)
  }
})
```

---

### ä¿®å¤ 7ï¼šé…ç½®ç³»ç»Ÿæ‰§è¡Œè€…è´¦å·ï¼ˆP0ï¼‰âœ… å·²æ‹æ¿ä¸€æ­¥åˆ°ä½

> **æ‹æ¿å†³ç­–**ï¼šä¸€æ­¥åˆ°ä½åˆ›å»º `system_job` è§’è‰² + ä¸“ç”¨ç³»ç»Ÿç”¨æˆ·  
> **å·²ç¡®è®¤å‚æ•°**ï¼ˆ2026-01-15 æ‹æ¿ï¼‰ï¼š
>
> - `assigned_by` = **31**ï¼ˆç®¡ç†å‘˜ç”¨æˆ·ï¼‰
> - `mobile` = **00000000001**ï¼ˆå…è®¸ä½¿ç”¨ï¼‰
>
> **æ•°æ®åº“ç°çŠ¶**ï¼ˆ2026-01-15 çœŸå®æŸ¥è¯¢ç»“æœï¼‰ï¼š
>
> - `users` è¡¨æ—  `username` å­—æ®µï¼Œç”¨ `mobile` + `nickname` æ ‡è¯†ç”¨æˆ·
> - æƒé™ç³»ç»Ÿä¸º RBACï¼š`roles` + `user_roles` å…³è”è¡¨
> - ç°æœ‰ admin ç”¨æˆ·ï¼šuser_id=31ï¼ˆç®¡ç†å‘˜ç”¨æˆ·ï¼‰ã€user_id=135ï¼ˆæµ‹è¯•ç”¨æˆ·2ï¼‰
> - ç°æœ‰ 9 ä¸ªè§’è‰²ï¼Œæ—  `system_job` è§’è‰²

---

#### æ­¥éª¤ 1ï¼šåˆ›å»º `system_job` è§’è‰²

**æ‰§è¡Œ SQL**ï¼ˆåŸºäºçœŸå® `roles` è¡¨ç»“æ„ï¼‰ï¼š

```sql
-- åˆ›å»º system_job è§’è‰²
-- role_level è®¾ä¸º 5ï¼ˆä½äº user=0 ä¹‹ä¸Šï¼Œä½†ä½äº ops=30ï¼Œè¡¨ç¤ºæœ€å°æƒé™ç³»ç»Ÿè§’è‰²ï¼‰
INSERT INTO roles (
  role_uuid,
  role_name,
  role_level,
  permissions,
  description,
  is_active,
  created_at,
  updated_at
) VALUES (
  UUID(),                               -- è‡ªåŠ¨ç”Ÿæˆ UUID
  'system_job',                         -- è§’è‰²åç§°
  5,                                    -- è§’è‰²çº§åˆ«ï¼ˆä½äºæ™®é€šè¿è¥è§’è‰²ï¼‰
  JSON_OBJECT(
    'orphan_frozen', JSON_ARRAY('detect', 'cleanup'),
    'audit_log', JSON_ARRAY('write'),
    'asset_balance', JSON_ARRAY('read', 'unfreeze')
  ),                                    -- æœ€å°æƒé™ï¼šå­¤å„¿å†»ç»“æ£€æµ‹/æ¸…ç† + å®¡è®¡å†™å…¥ + èµ„äº§è¯»å–/è§£å†»
  'ç³»ç»Ÿå®šæ—¶ä»»åŠ¡æ‰§è¡Œè€…ï¼ˆå­¤å„¿å†»ç»“æ¸…ç†ä¸“ç”¨ï¼‰',
  1,                                    -- å¯ç”¨
  NOW(),
  NOW()
);

-- éªŒè¯åˆ›å»ºç»“æœ
SELECT role_id, role_uuid, role_name, role_level, permissions
FROM roles
WHERE role_name = 'system_job';
```

**é¢„æœŸç»“æœ**ï¼š

```
+----------+--------------------------------------+-------------+------------+------------------------------------------+
| role_id  | role_uuid                            | role_name   | role_level | permissions                              |
+----------+--------------------------------------+-------------+------------+------------------------------------------+
| <æ–°ID>   | <UUID>                               | system_job  | 5          | {"orphan_frozen":["detect","cleanup"],...}|
+----------+--------------------------------------+-------------+------------+------------------------------------------+
```

---

#### æ­¥éª¤ 2ï¼šåˆ›å»ºç³»ç»Ÿä¸“ç”¨ç”¨æˆ·

**æ‰§è¡Œ SQL**ï¼ˆåŸºäºçœŸå® `users` è¡¨ç»“æ„ï¼‰ï¼š

```sql
-- åˆ›å»ºç³»ç»Ÿå®šæ—¶ä»»åŠ¡ä¸“ç”¨ç”¨æˆ·
-- ä½¿ç”¨è™šæ‹Ÿæ‰‹æœºå· 00000000001ï¼Œnickname æ ‡è¯†ç”¨é€”
INSERT INTO users (
  user_uuid,
  mobile,
  nickname,
  status,
  consecutive_fail_count,
  history_total_points,
  login_count,
  created_at,
  updated_at
) VALUES (
  UUID(),                               -- è‡ªåŠ¨ç”Ÿæˆ UUID
  '00000000001',                        -- è™šæ‹Ÿæ‰‹æœºå·ï¼ˆç³»ç»Ÿä¸“ç”¨ï¼Œä¸å¯ç™»å½•ï¼‰
  'SYSTEM_DAILY_JOB',                   -- æ˜µç§°æ ‡è¯†ç”¨é€”
  'active',                             -- çŠ¶æ€ï¼šæ¿€æ´»
  0,                                    -- è¿ç»­æœªä¸­å¥–æ¬¡æ•°ï¼ˆæ— æ„ä¹‰ï¼‰
  0,                                    -- å†å²ç§¯åˆ†ï¼ˆæ— æ„ä¹‰ï¼‰
  0,                                    -- ç™»å½•æ¬¡æ•°ï¼ˆç³»ç»Ÿç”¨æˆ·ä¸ç™»å½•ï¼‰
  NOW(),
  NOW()
);

-- è·å–æ–°åˆ›å»ºçš„ user_id
SELECT user_id, user_uuid, mobile, nickname, status
FROM users
WHERE mobile = '00000000001';
```

**é¢„æœŸç»“æœ**ï¼š

```
+---------+--------------------------------------+-------------+-------------------+--------+
| user_id | user_uuid                            | mobile      | nickname          | status |
+---------+--------------------------------------+-------------+-------------------+--------+
| <æ–°ID>  | <UUID>                               | 00000000001 | SYSTEM_DAILY_JOB  | active |
+---------+--------------------------------------+-------------+-------------------+--------+
```

> **è®°å½•è¿™ä¸ª `user_id`**ï¼Œä¸‹ä¸€æ­¥è¦ç”¨ã€‚å‡è®¾ä¸º `<SYSTEM_USER_ID>`ã€‚

---

#### æ­¥éª¤ 3ï¼šç»‘å®šç”¨æˆ·ä¸è§’è‰²

**æ‰§è¡Œ SQL**ï¼ˆåŸºäºçœŸå® `user_roles` è¡¨ç»“æ„ï¼‰ï¼š

```sql
-- è·å– system_job è§’è‰²çš„ role_id
SET @system_job_role_id = (SELECT role_id FROM roles WHERE role_name = 'system_job');

-- è·å–ç³»ç»Ÿç”¨æˆ·çš„ user_id
SET @system_user_id = (SELECT user_id FROM users WHERE mobile = '00000000001');

-- ç»‘å®šç”¨æˆ·ä¸è§’è‰²
INSERT INTO user_roles (
  user_id,
  role_id,
  assigned_at,
  assigned_by,
  is_active,
  created_at,
  updated_at
) VALUES (
  @system_user_id,
  @system_job_role_id,
  NOW(),
  31,                                   -- ç”±ç®¡ç†å‘˜(user_id=31)åˆ†é…
  1,                                    -- æ¿€æ´»
  NOW(),
  NOW()
);

-- éªŒè¯ç»‘å®šç»“æœ
SELECT
  u.user_id, u.nickname, r.role_name, r.role_level, ur.is_active
FROM users u
JOIN user_roles ur ON ur.user_id = u.user_id
JOIN roles r ON r.role_id = ur.role_id
WHERE u.mobile = '00000000001';
```

**é¢„æœŸç»“æœ**ï¼š

```
+---------+-------------------+-------------+------------+-----------+
| user_id | nickname          | role_name   | role_level | is_active |
+---------+-------------------+-------------+------------+-----------+
| <ID>    | SYSTEM_DAILY_JOB  | system_job  | 5          | 1         |
+---------+-------------------+-------------+------------+-----------+
```

---

#### æ­¥éª¤ 4ï¼šé…ç½®ç¯å¢ƒå˜é‡

**æ–‡ä»¶**ï¼š`.env`

```bash
# ========== ç³»ç»Ÿå®šæ—¶ä»»åŠ¡é…ç½® ==========

# ç³»ç»Ÿå®šæ—¶ä»»åŠ¡æ‰§è¡Œè€…è´¦å·IDï¼ˆç”¨äºå®¡è®¡è¿½è¸ªï¼‰
# è¯´æ˜ï¼š
# - ä¸“ç”¨ç³»ç»Ÿç”¨æˆ·ï¼Œmobile='00000000001'ï¼Œnickname='SYSTEM_DAILY_JOB'
# - ç‹¬ç«‹è§’è‰² system_jobï¼ˆrole_level=5ï¼‰ï¼Œæœ€å°æƒé™
# - åªå…è®¸åšå­¤å„¿å†»ç»“æ£€æµ‹/æ¸…ç† + å®¡è®¡å†™å…¥ + èµ„äº§è§£å†»
# - ä¸å¯ç”¨äºç™»å½•ï¼ˆè™šæ‹Ÿæ‰‹æœºå·ï¼‰
SYSTEM_DAILY_JOB_USER_ID=<æ­¥éª¤2è·å–çš„user_id>
```

---

#### æ­¥éª¤ 5ï¼šéªŒè¯é…ç½®ç”Ÿæ•ˆ

**éªŒè¯å‘½ä»¤**ï¼š

```bash
cd /home/devbox/project && \
node -e "require('dotenv').config(); console.log('SYSTEM_DAILY_JOB_USER_ID:', process.env.SYSTEM_DAILY_JOB_USER_ID);"
```

**æ•°æ®åº“éªŒè¯**ï¼š

```sql
-- éªŒè¯ç³»ç»Ÿç”¨æˆ·åŠå…¶è§’è‰²
SELECT
  u.user_id,
  u.mobile,
  u.nickname,
  r.role_name,
  r.role_level,
  r.permissions,
  ur.is_active
FROM users u
JOIN user_roles ur ON ur.user_id = u.user_id
JOIN roles r ON r.role_id = ur.role_id
WHERE u.user_id = <SYSTEM_DAILY_JOB_USER_ID>;
```

---

#### æƒé™è¾¹ç•Œè¯´æ˜

| æƒé™èµ„æº        | å…è®¸æ“ä½œ            | è¯´æ˜                   |
| --------------- | ------------------- | ---------------------- |
| `orphan_frozen` | `detect`, `cleanup` | æ£€æµ‹å’Œæ¸…ç†å­¤å„¿å†»ç»“     |
| `audit_log`     | `write`             | å†™å…¥å®¡è®¡æ—¥å¿—           |
| `asset_balance` | `read`, `unfreeze`  | è¯»å–èµ„äº§ä½™é¢ã€æ‰§è¡Œè§£å†» |

**ç¦æ­¢çš„æ“ä½œ**ï¼ˆä¸åœ¨ permissions ä¸­ï¼‰ï¼š

- âŒ ç”¨æˆ·ç®¡ç†ï¼ˆ`users:*`ï¼‰
- âŒ è§’è‰²ç®¡ç†ï¼ˆ`roles:*`ï¼‰
- âŒ æŠ½å¥–ç³»ç»Ÿï¼ˆ`lottery:*`ï¼‰
- âŒ äº¤æ˜“å¸‚åœºï¼ˆ`market:*`ï¼‰
- âŒ ä»»æ„èµ„äº§å˜æ›´ï¼ˆåªå…è®¸ unfreezeï¼‰

---

#### å›æ»šæ–¹æ¡ˆï¼ˆå¦‚éœ€æ’¤é”€ï¼‰

```sql
-- 1. åˆ é™¤ç”¨æˆ·è§’è‰²ç»‘å®š
DELETE FROM user_roles WHERE user_id = (SELECT user_id FROM users WHERE mobile = '00000000001');

-- 2. åˆ é™¤ç³»ç»Ÿç”¨æˆ·
DELETE FROM users WHERE mobile = '00000000001';

-- 3. åˆ é™¤ system_job è§’è‰²
DELETE FROM roles WHERE role_name = 'system_job';
```

---

### æ—§æ–¹æ¡ˆå†…å®¹ï¼ˆå·²åºŸå¼ƒï¼‰

> ä»¥ä¸‹å†…å®¹ä¸ºåŸæ¨èæ–¹æ¡ˆï¼Œç°å·²æ ¹æ®æ‹æ¿å†³ç­–åºŸå¼ƒã€‚ä¿ç•™ä¾›å†å²å‚è€ƒã€‚

<details>
<summary>ç‚¹å‡»å±•å¼€å·²åºŸå¼ƒçš„åŸæ–¹æ¡ˆ</summary>

#### åŸä¿®å¤ 1ï¼šJob é€‚é… Service è¿”å›å€¼ï¼ˆå·²åºŸå¼ƒï¼‰

**æ–‡ä»¶**ï¼š`jobs/daily-orphan-frozen-check.js`

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬ 60-75 è¡Œ

**ä¿®æ”¹å‰**ï¼š

```javascript
// 1. å…ˆæ£€æµ‹å­¤å„¿å†»ç»“
const detectResult = await orphanFrozenService.detectOrphanFrozen({
  limit: 1000
})

const report = {
  timestamp: new Date().toISOString(),
  dryRun,
  detection: {
    orphan_count: detectResult.orphan_count, // âŒ undefined
    total_orphan_amount: detectResult.total_orphan_amount, // âŒ undefined
    orphan_items: detectResult.orphan_items.slice(0, 10) // âŒ TypeError
  },
  cleanup: null,
  duration_ms: 0,
  status: 'OK'
}
```

**ä¿®æ”¹å**ï¼š

```javascript
// 1. å…ˆæ£€æµ‹å­¤å„¿å†»ç»“
const orphanList = await orphanFrozenService.detectOrphanFrozen({
  limit: 1000
})

// 2. è®¡ç®—æ±‡æ€»æ•°æ®
const orphan_count = orphanList.length
const total_orphan_amount = orphanList.reduce((sum, item) => sum + item.orphan_amount, 0)

const report = {
  timestamp: new Date().toISOString(),
  dryRun,
  detection: {
    orphan_count: orphan_count, // âœ… ä»æ•°ç»„è®¡ç®—
    total_orphan_amount: total_orphan_amount, // âœ… ä»æ•°ç»„è®¡ç®—
    orphan_items: orphanList.slice(0, 10) // âœ… ç›´æ¥ä½¿ç”¨æ•°ç»„
  },
  cleanup: null,
  duration_ms: 0,
  status: 'OK'
}
```

</details>
```

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬ 78-112 è¡Œï¼ˆåŒæ­¥ä¿®æ”¹åç»­å¼•ç”¨ï¼‰

**ä¿®æ”¹å‰**ï¼š

```javascript
if (detectResult.orphan_count > 0) {
  logger.warn(`æ£€æµ‹åˆ° ${detectResult.orphan_count} ä¸ªå­¤å„¿å†»ç»“èµ„äº§`, {
    total_amount: detectResult.total_orphan_amount
  })
  // ...
}
```

**ä¿®æ”¹å**ï¼š

```javascript
if (orphan_count > 0) {
  logger.warn(`æ£€æµ‹åˆ° ${orphan_count} ä¸ªå­¤å„¿å†»ç»“èµ„äº§`, {
    total_amount: total_orphan_amount
  })
  // ...
}
```

---

---

> ä»¥ä¸‹ä¸ºæ—§ä¿®å¤æ–¹æ¡ˆï¼Œç°å·²æ ¹æ®æ‹æ¿å†³ç­–åºŸå¼ƒï¼Œè¯·å‚è€ƒä¸Šæ–¹"ä¿®å¤æ–¹æ¡ˆ"ç« èŠ‚ã€‚

<details>
<summary>ç‚¹å‡»å±•å¼€å·²åºŸå¼ƒçš„æ—§ä¿®å¤ 2-4 æ–¹æ¡ˆ</summary>

### æ—§ä¿®å¤ 2ï¼šç»Ÿä¸€å‚æ•°å‘½åï¼ˆå·²åºŸå¼ƒï¼‰

æ­¤æ–¹æ¡ˆåŸºäº"Job è‡ªåŠ¨æ¸…ç†"è®¾è®¡ï¼Œç°å·²åºŸå¼ƒã€‚æ–°æ–¹æ¡ˆä¸­ Job ä¸å†è°ƒç”¨ `cleanupOrphanFrozen()`ã€‚

### æ—§ä¿®å¤ 3ï¼šé…ç½®ç³»ç»Ÿæ‰§è¡Œè€…è´¦å·ï¼ˆå·²æ•´åˆï¼‰

å·²æ•´åˆåˆ°æ–°æ–¹æ¡ˆçš„"ä¿®å¤ 7ï¼šé…ç½®ç³»ç»Ÿæ‰§è¡Œè€…è´¦å·"ä¸­ã€‚

### æ—§ä¿®å¤ 4ï¼šå¢åŠ é™é¢ä¿æŠ¤é€»è¾‘ï¼ˆå·²æ•´åˆä¸ºå‘Šè­¦é˜ˆå€¼ï¼‰

åŸé™é¢ä¿æŠ¤é€»è¾‘å·²æ”¹ä¸º"å‘Šè­¦åˆ†çº§é˜ˆå€¼"ï¼Œä¸å†ç”¨äºæ§åˆ¶è‡ªåŠ¨æ¸…ç†ï¼Œè€Œæ˜¯ç”¨äºå‘Šè­¦åˆ†çº§å’Œæ­¢æŸå†³ç­–ã€‚

</details>

    logger.info('å­¤å„¿å†»ç»“æ¸…ç†å®Œæˆ', {
      cleaned_count: cleanupResult.cleaned,
      failed_count: cleanupResult.failed
    })

} else {
// dryRun æ¨¡å¼
report.cleanup = {
skipped: true,
reason: 'dryRunæ¨¡å¼ï¼Œæœªæ‰§è¡Œå®é™…æ¸…ç†'
}
report.status = 'WARNING'
}
}

````

**æ–°å¢è¶…é™å‘Šè­¦æ–¹æ³•**ï¼š

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬ 240 è¡Œåæ–°å¢

```javascript
/**
 * å‘é€è¶…é™å‘Šè­¦é€šçŸ¥
 *
 * @param {Object} report - æ‰§è¡ŒæŠ¥å‘Š
 * @returns {Promise<void>} æ— è¿”å›å€¼
 * @private
 */
static async _sendOverLimitNotification(report) {
  try {
    await NotificationService.sendToAdmins({
      type: 'orphan_frozen_over_limit',
      title: 'âš ï¸ å­¤å„¿å†»ç»“è¶…é™å‘Šè­¦',
      content: `æ£€æµ‹åˆ°å¤§é‡å­¤å„¿å†»ç»“ï¼Œè¶…å‡ºè‡ªåŠ¨æ¸…ç†é™é¢ï¼Œéœ€äººå·¥ä»‹å…¥å¤„ç†ã€‚\n\n` +
               `æ£€æµ‹åˆ°å­¤å„¿å†»ç»“æ•°é‡ï¼š${report.detection.orphan_count} æ¡\n` +
               `æ£€æµ‹åˆ°å­¤å„¿å†»ç»“æ€»é¢ï¼š${report.detection.total_orphan_amount}\n` +
               `å•æ¬¡æ¸…ç†é™é¢ï¼ˆæ¡æ•°ï¼‰ï¼š${report.cleanup.limit_exceeded.count_limit}\n` +
               `å•æ¬¡æ¸…ç†é™é¢ï¼ˆé‡‘é¢ï¼‰ï¼š${report.cleanup.limit_exceeded.amount_limit}\n\n` +
               `è¯·ç™»å½•ç®¡ç†åå°æ‰‹åŠ¨å¤„ç†ï¼šæ§åˆ¶å° > å­¤å„¿å†»ç»“ç®¡ç†`,
      data: {
        orphan_count: report.detection.orphan_count,
        total_orphan_amount: report.detection.total_orphan_amount,
        limit_exceeded: report.cleanup.limit_exceeded,
        timestamp: report.timestamp
      }
    })
    logger.info('å­¤å„¿å†»ç»“è¶…é™å‘Šè­¦å·²å‘é€')
  } catch (notifyError) {
    logger.error('å‘é€è¶…é™å‘Šè­¦å¤±è´¥', { error: notifyError.message })
  }
}
````

**é…ç½®æ–‡ä»¶æ–°å¢**ï¼š

**æ–‡ä»¶**ï¼š`.env`

```bash
# å­¤å„¿å†»ç»“è‡ªåŠ¨æ¸…ç†é™é¢é…ç½®
# å•æ¬¡æœ€å¤§æ¸…ç†é‡‘é¢ï¼ˆé»˜è®¤ 10000ï¼‰
MAX_ORPHAN_CLEANUP_AMOUNT=10000

# å•æ¬¡æœ€å¤§æ¸…ç†æ¡æ•°ï¼ˆé»˜è®¤ 100ï¼‰
MAX_ORPHAN_CLEANUP_COUNT=100
```

---

### ä¿®å¤ 5ï¼šå®Œå–„é”™è¯¯å¤„ç†ï¼ˆP2ï¼‰

**æ–‡ä»¶**ï¼š`jobs/daily-orphan-frozen-check.js`

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬ 132-144 è¡Œ

**ä¿®æ”¹å‰**ï¼š

```javascript
} catch (error) {
  logger.error('æ¯æ—¥å­¤å„¿å†»ç»“æ£€æµ‹ä»»åŠ¡å¤±è´¥', {
    error_message: error.message,
    error_stack: error.stack
  })

  // å‘é€é”™è¯¯é€šçŸ¥
  if (sendNotification) {
    await this._sendErrorNotification(error)
  }

  throw error
}
```

**ä¿®æ”¹å**ï¼š

```javascript
} catch (error) {
  logger.error('æ¯æ—¥å­¤å„¿å†»ç»“æ£€æµ‹ä»»åŠ¡å¤±è´¥', {
    error_message: error.message,
    error_stack: error.stack,
    error_code: error.code || 'UNKNOWN_ERROR'
  })

  // âœ… åŒºåˆ†é”™è¯¯ç±»å‹
  let errorType = 'UNKNOWN_ERROR'
  if (error.message.includes('æœåŠ¡ç®¡ç†å™¨å°šæœªåˆå§‹åŒ–')) {
    errorType = 'SERVICE_NOT_INITIALIZED'
  } else if (error.message.includes('operator_id')) {
    errorType = 'MISSING_OPERATOR_ID'
  } else if (error.message.includes('Failed to acquire lock')) {
    errorType = 'LOCK_ACQUISITION_FAILED'
  } else if (error.message.includes('ECONNREFUSED') || error.message.includes('ETIMEDOUT')) {
    errorType = 'DATABASE_CONNECTION_ERROR'
  }

  // å‘é€é”™è¯¯é€šçŸ¥ï¼ˆåŒ…å«é”™è¯¯ç±»å‹ï¼‰
  if (sendNotification) {
    await this._sendErrorNotification(error, errorType)
  }

  // âœ… æ ¹æ®é”™è¯¯ç±»å‹å†³å®šæ˜¯å¦æŠ›å‡º
  if (errorType === 'LOCK_ACQUISITION_FAILED') {
    // é”è·å–å¤±è´¥ï¼ˆå…¶ä»–å®ä¾‹æ­£åœ¨æ‰§è¡Œï¼‰ä¸æŠ›å‡ºé”™è¯¯
    logger.warn('å…¶ä»–å®ä¾‹æ­£åœ¨æ‰§è¡Œå­¤å„¿å†»ç»“æ¸…ç†ï¼Œæœ¬æ¬¡è·³è¿‡')
    return {
      status: 'SKIPPED',
      reason: 'LOCK_ACQUISITION_FAILED',
      timestamp: new Date().toISOString()
    }
  }

  throw error
}
```

**ä¿®æ”¹é”™è¯¯é€šçŸ¥æ–¹æ³•**ï¼š

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬ 253-268 è¡Œ

**ä¿®æ”¹å‰**ï¼š

```javascript
static async _sendErrorNotification(error) {
  try {
    await NotificationService.sendToAdmins({
      type: 'orphan_frozen_error',
      title: 'å­¤å„¿å†»ç»“æ£€æµ‹ä»»åŠ¡å¤±è´¥',
      content: `æ¯æ—¥å­¤å„¿å†»ç»“æ£€æµ‹ä»»åŠ¡æ‰§è¡Œå¤±è´¥: ${error.message}`,
      data: {
        error_message: error.message,
        timestamp: new Date().toISOString()
      }
    })
    logger.info('å­¤å„¿å†»ç»“ä»»åŠ¡é”™è¯¯é€šçŸ¥å·²å‘é€')
  } catch (notifyError) {
    logger.error('å‘é€é”™è¯¯é€šçŸ¥å¤±è´¥', { error: notifyError.message })
  }
}
```

**ä¿®æ”¹å**ï¼š

```javascript
static async _sendErrorNotification(error, errorType = 'UNKNOWN_ERROR') {
  try {
    // âœ… æ ¹æ®é”™è¯¯ç±»å‹ç”Ÿæˆä¸åŒçš„é€šçŸ¥å†…å®¹
    let title = 'å­¤å„¿å†»ç»“æ£€æµ‹ä»»åŠ¡å¤±è´¥'
    let content = `æ¯æ—¥å­¤å„¿å†»ç»“æ£€æµ‹ä»»åŠ¡æ‰§è¡Œå¤±è´¥\n\n`

    switch (errorType) {
      case 'SERVICE_NOT_INITIALIZED':
        title = 'âš ï¸ æœåŠ¡åˆå§‹åŒ–å¤±è´¥'
        content += `é”™è¯¯ç±»å‹ï¼šæœåŠ¡ç®¡ç†å™¨æœªåˆå§‹åŒ–\n` +
                  `é”™è¯¯ä¿¡æ¯ï¼š${error.message}\n\n` +
                  `å»ºè®®ï¼šæ£€æŸ¥åº”ç”¨å¯åŠ¨æ—¥å¿—ï¼Œç¡®è®¤æœåŠ¡åˆå§‹åŒ–æ˜¯å¦æˆåŠŸ`
        break
      case 'MISSING_OPERATOR_ID':
        title = 'âš ï¸ é…ç½®ç¼ºå¤±'
        content += `é”™è¯¯ç±»å‹ï¼šç¼ºå°‘ç³»ç»Ÿæ‰§è¡Œè€…è´¦å·é…ç½®\n` +
                  `é”™è¯¯ä¿¡æ¯ï¼š${error.message}\n\n` +
                  `å»ºè®®ï¼šåœ¨ .env ä¸­é…ç½® SYSTEM_DAILY_JOB_USER_ID`
        break
      case 'DATABASE_CONNECTION_ERROR':
        title = 'ğŸ”´ æ•°æ®åº“è¿æ¥å¤±è´¥'
        content += `é”™è¯¯ç±»å‹ï¼šæ•°æ®åº“è¿æ¥å¼‚å¸¸\n` +
                  `é”™è¯¯ä¿¡æ¯ï¼š${error.message}\n\n` +
                  `å»ºè®®ï¼šæ£€æŸ¥æ•°æ®åº“æœåŠ¡çŠ¶æ€å’Œç½‘ç»œè¿æ¥`
        break
      default:
        content += `é”™è¯¯ç±»å‹ï¼š${errorType}\n` +
                  `é”™è¯¯ä¿¡æ¯ï¼š${error.message}\n\n` +
                  `å †æ ˆä¿¡æ¯ï¼š\n${error.stack?.substring(0, 500) || 'N/A'}`
    }

    await NotificationService.sendToAdmins({
      type: 'orphan_frozen_error',
      title: title,
      content: content,
      data: {
        error_type: errorType,
        error_message: error.message,
        error_stack: error.stack,
        timestamp: new Date().toISOString()
      }
    })
    logger.info('å­¤å„¿å†»ç»“ä»»åŠ¡é”™è¯¯é€šçŸ¥å·²å‘é€', { error_type: errorType })
  } catch (notifyError) {
    logger.error('å‘é€é”™è¯¯é€šçŸ¥å¤±è´¥', { error: notifyError.message })
  }
}
```

---

## éªŒè¯æ­¥éª¤

> **æ³¨æ„**ï¼šä»¥ä¸‹éªŒè¯æ­¥éª¤åŸºäºå·²æ‹æ¿çš„å†³ç­–ï¼ˆService è¿”å› DTOï¼ŒJob åªæ£€æµ‹å‘Šè­¦ä¸æ¸…ç†ï¼‰

### éªŒè¯ç¯å¢ƒè¦æ±‚

- âœ… ä½¿ç”¨çœŸå®æ•°æ®åº“ï¼ˆé€šè¿‡ `.env` é…ç½®è¿æ¥ï¼‰
- âœ… ä¸ä¾èµ– mysql å®¢æˆ·ç«¯ï¼ˆé€šè¿‡ Node.js + Sequelize è¿æ¥ï¼‰
- âœ… æŒ‰é˜¶æ®µéªŒè¯ï¼ˆDTO éªŒè¯ â†’ å‘Šè­¦åˆ†çº§éªŒè¯ â†’ åå°ä¿®å¤éªŒè¯ â†’ å…¨æµç¨‹éªŒè¯ï¼‰

---

### é˜¶æ®µ 1ï¼šDTO è¿”å›ç»“æ„éªŒè¯

**ç›®æ ‡**ï¼šéªŒè¯ä¿®å¤åçš„ `detectOrphanFrozen()` è¿”å›ç¨³å®š DTO å¯¹è±¡ï¼ŒåŒ…å«æ‰€æœ‰å¿…å¡«å­—æ®µã€‚

**éªŒè¯è„šæœ¬**ï¼š

```bash
cd /home/devbox/project && \
DOTENV_CONFIG_PATH=/home/devbox/project/.env \
node -r dotenv/config -e "
(async()=>{
  const services=require('./services');
  await services.initialize();

  const orphanService = services.getService('orphan_frozen_cleanup');
  const dto = await orphanService.detectOrphanFrozen({ limit: 1000 });

  // éªŒè¯ DTO ç»“æ„
  const requiredFields = [
    'orphan_count', 'total_orphan_amount', 'orphan_items',
    'checked_count', 'generated_at', 'affected_user_count', 'items_truncated'
  ];

  console.log('=== DTO ç»“æ„éªŒè¯ ===');

  const missingFields = requiredFields.filter(f => !(f in dto));
  if (missingFields.length > 0) {
    console.error('âŒ ç¼ºå°‘å¿…å¡«å­—æ®µ:', missingFields);
    process.exit(1);
  }

  console.log('âœ… æ‰€æœ‰å¿…å¡«å­—æ®µå­˜åœ¨');
  console.log('');
  console.log('=== DTO å†…å®¹ ===');
  console.log('  orphan_count:', dto.orphan_count);
  console.log('  total_orphan_amount:', dto.total_orphan_amount);
  console.log('  checked_count:', dto.checked_count);
  console.log('  affected_user_count:', dto.affected_user_count);
  console.log('  affected_asset_codes:', dto.affected_asset_codes);
  console.log('  items_truncated:', dto.items_truncated);
  console.log('  generated_at:', dto.generated_at);
  console.log('');

  // éªŒè¯ orphan_items æœ€å°å­—æ®µé›†
  if (dto.orphan_items.length > 0) {
    const item = dto.orphan_items[0];
    const itemRequiredFields = ['user_id', 'asset_code', 'frozen_amount', 'listed_amount', 'orphan_amount'];
    const itemMissingFields = itemRequiredFields.filter(f => !(f in item));

    if (itemMissingFields.length > 0) {
      console.error('âŒ orphan_items ç¼ºå°‘å­—æ®µ:', itemMissingFields);
      process.exit(1);
    }
    console.log('âœ… orphan_items å­—æ®µå®Œæ•´');
    console.log('  å‰1æ¡æ˜ç»†:', JSON.stringify(item, null, 2));
  } else {
    console.log('â„¹ï¸ æ— å­¤å„¿å†»ç»“æ•°æ®');
  }

  process.exit(0);
})().catch(e=>{
  console.error('éªŒè¯å¤±è´¥:', e.message);
  process.exit(1);
});
"
```

**é¢„æœŸè¾“å‡º**ï¼š

```
=== DTO ç»“æ„éªŒè¯ ===
âœ… æ‰€æœ‰å¿…å¡«å­—æ®µå­˜åœ¨

=== DTO å†…å®¹ ===
  orphan_count: 1
  total_orphan_amount: <å®é™…é‡‘é¢>
  checked_count: <æ£€æµ‹è´¦æˆ·æ•°>
  affected_user_count: 1
  affected_asset_codes: ['<èµ„äº§ä»£ç >']
  items_truncated: false
  generated_at: 2026-01-15T...

âœ… orphan_items å­—æ®µå®Œæ•´
  å‰1æ¡æ˜ç»†: {
    "user_id": <ç”¨æˆ·ID>,
    "asset_code": "<èµ„äº§ä»£ç >",
    "frozen_amount": <å†»ç»“é‡‘é¢>,
    "listed_amount": <æŒ‚ç‰Œé‡‘é¢>,
    "orphan_amount": <å­¤å„¿é‡‘é¢>
  }
```

**éªŒè¯è¦ç‚¹**ï¼š

- âœ… è¿”å› DTO å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰
- âœ… æ‰€æœ‰å¿…å¡«å­—æ®µå­˜åœ¨ä¸”ç±»å‹æ­£ç¡®
- âœ… `orphan_items` åŒ…å«æœ€å°å­—æ®µé›†
- âœ… `affected_user_count` å’Œ `items_truncated` æ–°å¢å­—æ®µå­˜åœ¨

---

### é˜¶æ®µ 2ï¼šå‘Šè­¦åˆ†çº§é€»è¾‘éªŒè¯

**ç›®æ ‡**ï¼šéªŒè¯ Job èƒ½æ­£ç¡®åˆ¤æ–­å‘Šè­¦çº§åˆ«ï¼ˆP0/P1/P2ï¼‰å¹¶ç”Ÿæˆå¯¹åº”çš„å¤„ç½®å»ºè®®ã€‚

**éªŒè¯è„šæœ¬**ï¼š

```bash
cd /home/devbox/project && \
DOTENV_CONFIG_PATH=/home/devbox/project/.env \
node -r dotenv/config -e "
(async()=>{
  const services=require('./services');
  await services.initialize();

  const Job = require('./jobs/daily-orphan-frozen-check');

  // æµ‹è¯•ä¸åŒåœºæ™¯çš„å‘Šè­¦åˆ†çº§
  const testCases = [
    { orphan_count: 25, affected_user_count: 3, affected_asset_codes: ['A'], expected: 'P0' },
    { orphan_count: 10, affected_user_count: 3, affected_asset_codes: ['A', 'B', 'C'], expected: 'P0' },
    { orphan_count: 10, affected_user_count: 3, affected_asset_codes: ['A', 'B'], expected: 'P1' },
    { orphan_count: 3, affected_user_count: 1, affected_asset_codes: ['A'], expected: 'P2' },
  ];

  console.log('=== å‘Šè­¦åˆ†çº§æµ‹è¯• ===');

  for (const tc of testCases) {
    const mockDto = {
      orphan_count: tc.orphan_count,
      affected_user_count: tc.affected_user_count,
      affected_asset_codes: tc.affected_asset_codes,
    };

    const level = Job._determineAlertLevel(mockDto);
    const pass = level === tc.expected ? 'âœ…' : 'âŒ';

    console.log(pass, 'orphan=' + tc.orphan_count,
                'users=' + tc.affected_user_count,
                'assets=' + tc.affected_asset_codes.length,
                '-> æœŸæœ›:', tc.expected, 'å®é™…:', level);
  }

  process.exit(0);
})().catch(e=>{
  console.error('æµ‹è¯•å¤±è´¥:', e.message);
  process.exit(1);
});
"
```

**éªŒè¯è¦ç‚¹**ï¼š

- âœ… å¤šèµ„äº§ï¼ˆ>=3ï¼‰è§¦å‘ P0
- âœ… å¤šç”¨æˆ·ï¼ˆ>=5ï¼‰è§¦å‘ P0
- âœ… æ˜ç»†æ•°å¤šï¼ˆ>=20ï¼‰è§¦å‘ P0
- âœ… ä¸­ç­‰æƒ…å†µè§¦å‘ P1
- âœ… å°è§„æ¨¡è§¦å‘ P2

---

### é˜¶æ®µ 3ï¼šJob å®Œæ•´æµç¨‹éªŒè¯ï¼ˆåªæ£€æµ‹+å‘Šè­¦ï¼Œä¸æ¸…ç†ï¼‰

**ç›®æ ‡**ï¼šéªŒè¯ä¿®å¤åçš„ Job å®Œæ•´æ‰§è¡Œæ£€æµ‹å’Œå‘Šè­¦æµç¨‹ï¼Œç¡®è®¤ä¸æ‰§è¡Œè‡ªåŠ¨æ¸…ç†ã€‚

**éªŒè¯è„šæœ¬**ï¼š

```bash
cd /home/devbox/project && \
DOTENV_CONFIG_PATH=/home/devbox/project/.env \
node -r dotenv/config -e "
(async()=>{
  const services=require('./services');
  await services.initialize();

  const Job = require('./jobs/daily-orphan-frozen-check');

  console.log('=== æ‰§è¡Œ Jobï¼ˆä¸å‘é€é€šçŸ¥ï¼‰===');

  const report = await Job.execute({
    sendNotification: false  // æµ‹è¯•æ—¶ä¸å‘é€çœŸå®å‘Šè­¦
  });

  console.log('');
  console.log('=== æ‰§è¡ŒæŠ¥å‘Š ===');
  console.log(JSON.stringify(report, null, 2));

  // éªŒè¯æŠ¥å‘Šç»“æ„
  console.log('');
  console.log('=== éªŒè¯ç‚¹ ===');
  console.log('âœ… æŠ¥å‘ŠåŒ…å« detection:', 'detection' in report);
  console.log('âœ… æŠ¥å‘ŠåŒ…å« alert_level:', 'alert_level' in report);
  console.log('âœ… æŠ¥å‘ŠåŒ…å« actions:', 'actions' in report);
  console.log('âœ… ä¸åŒ…å« cleanup æ‰§è¡Œç»“æœ:', !('cleanup' in report) || report.cleanup === null);

  process.exit(0);
})().catch(e=>{
  console.error('æ‰§è¡Œå¤±è´¥:', e.message);
  process.exit(1);
});
"
```

**é¢„æœŸè¾“å‡º**ï¼š

```
=== æ‰§è¡Œ Jobï¼ˆä¸å‘é€é€šçŸ¥ï¼‰===
å¼€å§‹æ¯æ—¥å­¤å„¿å†»ç»“æ£€æµ‹ä»»åŠ¡
[å­¤å„¿å†»ç»“æ£€æµ‹] æ£€æµ‹å®Œæˆ

=== æ‰§è¡ŒæŠ¥å‘Š ===
{
  "timestamp": "2026-01-15T...",
  "detection": {
    "orphan_count": 1,
    "total_orphan_amount": <é‡‘é¢>,
    "affected_user_count": 1,
    "affected_asset_codes": ["<èµ„äº§ä»£ç >"],
    "orphan_items": [...],
    "items_truncated": false
  },
  "alert_level": "P2",
  "actions": [
    "ğŸ“‹ å¯åˆå¹¶è‡³æ—¥æŠ¥å¤„ç†"
  ],
  "status": "INFO",
  "duration_ms": <æ¯«ç§’>
}

=== éªŒè¯ç‚¹ ===
âœ… æŠ¥å‘ŠåŒ…å« detection: true
âœ… æŠ¥å‘ŠåŒ…å« alert_level: true
âœ… æŠ¥å‘ŠåŒ…å« actions: true
âœ… ä¸åŒ…å« cleanup æ‰§è¡Œç»“æœ: true
```

**éªŒè¯è¦ç‚¹**ï¼š

- âœ… ä¸æŠ›å‡º TypeError
- âœ… ä½¿ç”¨ DTO å­—æ®µï¼ˆä¸æ˜¯ array.lengthï¼‰
- âœ… æœ‰å‘Šè­¦çº§åˆ«åˆ¤å®š
- âœ… æœ‰å¤„ç½®å»ºè®®ç”Ÿæˆ
- âœ… **ä¸æ‰§è¡Œè‡ªåŠ¨æ¸…ç†**ï¼ˆè¿™æ˜¯å…³é”®éªŒè¯ç‚¹ï¼‰

---

### é˜¶æ®µ 4ï¼šåå°äººå·¥ä¿®å¤æ¥å£éªŒè¯

**ç›®æ ‡**ï¼šéªŒè¯åå°ä¿®å¤æ¥å£èƒ½æ­£ç¡®æ‰§è¡Œæ¸…ç†æ“ä½œï¼ŒåŒ…å«å®¡è®¡è®°å½•ã€‚

**å‰ç½®æ¡ä»¶**ï¼š

1. âœ… å·²é…ç½® `SYSTEM_DAILY_JOB_USER_ID`
2. âœ… åå°æ¥å£ `/api/v4/console/orphan-frozen/cleanup` å·²å®ç°

**éªŒè¯è„šæœ¬ï¼ˆdry_run æ¨¡å¼ï¼‰**ï¼š

```bash
cd /home/devbox/project && \
DOTENV_CONFIG_PATH=/home/devbox/project/.env \
node -r dotenv/config -e "
(async()=>{
  const services=require('./services');
  await services.initialize();

  const orphanService = services.getService('orphan_frozen_cleanup');
  const operatorId = parseInt(process.env.SYSTEM_DAILY_JOB_USER_ID);

  console.log('=== æ¼”ç»ƒæ¨¡å¼æ¸…ç†ï¼ˆdry_run=trueï¼‰===');
  console.log('operator_id:', operatorId);

  const result = await orphanService.cleanupOrphanFrozen({
    dry_run: true,  // âœ… snake_case
    operator_id: operatorId,
    reason: 'åå°äººå·¥ä¿®å¤æµ‹è¯•ï¼ˆæ¼”ç»ƒï¼‰',
    limit: 10
  });

  console.log('');
  console.log('=== æ¸…ç†ç»“æœ ===');
  console.log(JSON.stringify(result, null, 2));

  // éªŒè¯è¿”å›å¥‘çº¦
  console.log('');
  console.log('=== è¿”å›å¥‘çº¦éªŒè¯ ===');
  const requiredFields = ['cleaned_count', 'failed_count', 'total_unfrozen_amount', 'dry_run'];
  const missingFields = requiredFields.filter(f => !(f in result));

  if (missingFields.length > 0) {
    console.error('âŒ ç¼ºå°‘å­—æ®µ:', missingFields);
    process.exit(1);
  }

  console.log('âœ… æ‰€æœ‰è¿”å›å­—æ®µå­˜åœ¨');
  console.log('âœ… dry_run æ¨¡å¼ç¡®è®¤:', result.dry_run === true);

  process.exit(0);
})().catch(e=>{
  console.error('æ¸…ç†å¤±è´¥:', e.message);
  process.exit(1);
});
"
```

**å°æµé‡çœŸå®æ¸…ç†éªŒè¯**ï¼ˆä»…åœ¨ç¡®è®¤æ— è¯¯åæ‰§è¡Œï¼‰ï¼š

```bash
# âš ï¸ æ­¤å‘½ä»¤ä¼šçœŸå®ä¿®æ”¹æ•°æ®åº“ï¼Œè¯·è°¨æ…æ‰§è¡Œ
cd /home/devbox/project && \
DOTENV_CONFIG_PATH=/home/devbox/project/.env \
node -r dotenv/config -e "
(async()=>{
  const services=require('./services');
  await services.initialize();

  const orphanService = services.getService('orphan_frozen_cleanup');
  const operatorId = parseInt(process.env.SYSTEM_DAILY_JOB_USER_ID);

  // æŒ‡å®šå•ä¸ªç”¨æˆ·è¿›è¡Œå°æµé‡æµ‹è¯•
  const testUserId = <æµ‹è¯•ç”¨æˆ·ID>;  // æ›¿æ¢ä¸ºå®é™…ç”¨æˆ·ID

  console.log('=== çœŸå®æ¸…ç†ï¼ˆå•ç”¨æˆ·ï¼‰===');
  console.log('operator_id:', operatorId);
  console.log('target_user_id:', testUserId);

  const result = await orphanService.cleanupOrphanFrozen({
    user_id: testUserId,
    dry_run: false,  // âœ… snake_case
    operator_id: operatorId,
    reason: 'åå°äººå·¥ä¿®å¤æµ‹è¯•ï¼ˆå°æµé‡ï¼‰',
    limit: 10
  });

  console.log('');
  console.log('=== æ¸…ç†ç»“æœ ===');
  console.log(JSON.stringify(result, null, 2));

  process.exit(0);
})().catch(e=>{
  console.error('æ¸…ç†å¤±è´¥:', e.message);
  process.exit(1);
});
"
```

**éªŒè¯è¦ç‚¹ï¼ˆçœŸå®æ¸…ç†åï¼‰**ï¼š

```sql
-- éªŒè¯å®¡è®¡æµæ°´æ˜¯å¦è®°å½•
SELECT * FROM asset_transactions
WHERE business_type = 'orphan_frozen_cleanup'
AND operator_id = <SYSTEM_DAILY_JOB_USER_ID>
ORDER BY created_at DESC
LIMIT 5;
```

- âœ… `operator_id` ä¸ºé…ç½®çš„ç³»ç»Ÿè´¦å·ID
- âœ… `business_type` ä¸º `orphan_frozen_cleanup`
- âœ… `reason` åŒ…å«ä¿®å¤åŸå› 
- âœ… é‡‘é¢å˜åŠ¨æ­£ç¡®

---

### é˜¶æ®µ 5ï¼šå…¨æµç¨‹é›†æˆéªŒè¯

**ç›®æ ‡**ï¼šéªŒè¯å®Œæ•´çš„å­¤å„¿å†»ç»“æ£€æµ‹-å‘Šè­¦-äººå·¥ä¿®å¤æµç¨‹ã€‚

**éªŒè¯æµç¨‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®šæ—¶ä»»åŠ¡è§¦å‘   â”‚ --> â”‚   æ£€æµ‹+å‘Šè­¦      â”‚ --> â”‚   äººå·¥ç¡®è®¤       â”‚
â”‚   (å‡Œæ™¨2ç‚¹)      â”‚     â”‚   (ä¸æ”¹åº“)       â”‚     â”‚   (æŸ¥çœ‹æŠ¥å‘Š)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                          â”‚
                                                          v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¡è®¡å®Œæ•´       â”‚ <-- â”‚   æ‰§è¡Œä¿®å¤       â”‚ <-- â”‚   åå°æ“ä½œ       â”‚
â”‚   (å¯è¿½æº¯)       â”‚     â”‚   (æ”¹åº“)         â”‚     â”‚   (äºŒæ¬¡ç¡®è®¤)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**éªŒè¯æ­¥éª¤**ï¼š

1. æ‰§è¡Œ Jobï¼ˆä¸å‘é€é€šçŸ¥ï¼‰ï¼Œè·å–æ£€æµ‹æŠ¥å‘Š
2. ç¡®è®¤å‘Šè­¦çº§åˆ«å’Œå¤„ç½®å»ºè®®
3. é€šè¿‡åå°æ¥å£æ‰§è¡Œ dry_run æ¼”ç»ƒ
4. ç¡®è®¤æ— è¯¯åæ‰§è¡ŒçœŸå®ä¿®å¤
5. æ£€æŸ¥å®¡è®¡æµæ°´å®Œæ•´æ€§

```bash
cd /home/devbox/project && \
DOTENV_CONFIG_PATH=/home/devbox/project/.env \
node -r dotenv/config -e "
(async()=>{
  const ScheduledTasks = require('./scripts/maintenance/scheduled_tasks');
  await ScheduledTasks.initializeServices();

  console.log('æ‰‹åŠ¨è§¦å‘å­¤å„¿å†»ç»“æ£€æµ‹ä»»åŠ¡...');
  const report = await ScheduledTasks.manualOrphanFrozenCheck({
    dryRun: false,  // çœŸå®æ‰§è¡Œ
    sendNotification: true  // å‘é€é€šçŸ¥
  });

  console.log('ä»»åŠ¡æ‰§è¡Œå®Œæˆ:', JSON.stringify(report, null, 2));
  process.exit(0);
})().catch(e=>{
  console.error('ä»»åŠ¡æ‰§è¡Œå¤±è´¥:', e.message);
  process.exit(1);
});
"
```

**éªŒè¯æ–¹å¼ 2ï¼šç­‰å¾…å®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ‰§è¡Œ**

1. **æŸ¥çœ‹å®šæ—¶ä»»åŠ¡æ—¥å¿—**ï¼ˆç¬¬äºŒå¤©å‡Œæ™¨ 2 ç‚¹åï¼‰ï¼š

   ```bash
   # æŸ¥çœ‹åº”ç”¨æ—¥å¿—
   tail -f logs/app.log | grep "å­¤å„¿å†»ç»“"

   # æˆ–ä½¿ç”¨ PM2 æ—¥å¿—
   pm2 logs | grep "å­¤å„¿å†»ç»“"
   ```

2. **é¢„æœŸæ—¥å¿—è¾“å‡º**ï¼š

   ```
   [å®šæ—¶ä»»åŠ¡] è·å–åˆ†å¸ƒå¼é”æˆåŠŸï¼Œå¼€å§‹æ‰§è¡Œå­¤å„¿å†»ç»“æ£€æµ‹...
   [å­¤å„¿å†»ç»“æ£€æµ‹] å¼€å§‹æ£€æµ‹...
   [å­¤å„¿å†»ç»“æ£€æµ‹] æ£€æµ‹å®Œæˆï¼Œå‘ç° X æ¡å­¤å„¿å†»ç»“
   [å­¤å„¿å†»ç»“æ¸…ç†] å¼€å§‹æ¸…ç†...
   [å­¤å„¿å†»ç»“æ¸…ç†] æˆåŠŸè·å–åˆ†å¸ƒå¼é”ï¼Œå¼€å§‹æ‰§è¡Œæ¸…ç†
   [å­¤å„¿å†»ç»“æ¸…ç†] æ¸…ç†å®Œæˆï¼ŒæˆåŠŸ X æ¡ï¼Œå¤±è´¥ 0 æ¡
   [å®šæ—¶ä»»åŠ¡] å­¤å„¿å†»ç»“æ£€æµ‹å®Œæˆï¼šå‘ç° X æ¡å­¤å„¿å†»ç»“
   [å®šæ—¶ä»»åŠ¡] åˆ†å¸ƒå¼é”å·²é‡Šæ”¾
   ```

3. **éªŒè¯æ•°æ®åº“å˜åŒ–**ï¼š

   ```sql
   -- æŸ¥è¯¢æœ€è¿‘çš„å­¤å„¿å†»ç»“æ¸…ç†è®°å½•
   SELECT * FROM asset_transactions
   WHERE business_type = 'orphan_frozen_cleanup'
   AND created_at >= CURDATE()
   ORDER BY created_at DESC;

   -- éªŒè¯å½“å‰æ˜¯å¦è¿˜æœ‰å­¤å„¿å†»ç»“
   SELECT
     aab.user_id,
     aab.asset_code,
     aab.frozen_amount,
     COALESCE(SUM(ml.offer_amount), 0) AS total_listed,
     aab.frozen_amount - COALESCE(SUM(ml.offer_amount), 0) AS orphan_amount
   FROM account_asset_balances aab
   LEFT JOIN accounts a ON aab.account_id = a.account_id
   LEFT JOIN market_listings ml ON a.user_id = ml.seller_user_id
     AND aab.asset_code = ml.offer_asset_code
     AND ml.status = 'on_sale'
   WHERE aab.frozen_amount > 0
     AND a.account_type = 'user'
   GROUP BY aab.user_id, aab.asset_code, aab.frozen_amount
   HAVING orphan_amount > 0;
   ```

**éªŒè¯è¦ç‚¹**ï¼š

- âœ… å®šæ—¶ä»»åŠ¡ä¸æŠ›å‡ºé”™è¯¯
- âœ… èƒ½æ­£å¸¸è·å–å’Œé‡Šæ”¾åˆ†å¸ƒå¼é”
- âœ… å­¤å„¿å†»ç»“è¢«æ­£ç¡®æ¸…ç†
- âœ… å®¡è®¡æµæ°´å®Œæ•´
- âœ… å‘Šè­¦é€šçŸ¥æ­£å¸¸å‘é€

---

### é˜¶æ®µ 5ï¼šé™é¢ä¿æŠ¤éªŒè¯

**ç›®æ ‡**ï¼šéªŒè¯é™é¢ä¿æŠ¤æœºåˆ¶èƒ½æ­£ç¡®è§¦å‘ã€‚

**æµ‹è¯•åœºæ™¯ 1ï¼šæ¨¡æ‹Ÿè¶…é™æƒ…å†µ**

```bash
# ä¸´æ—¶é™ä½é™é¢è§¦å‘è¶…é™å‘Šè­¦
cd /home/devbox/project && \
MAX_ORPHAN_CLEANUP_AMOUNT=1 \
MAX_ORPHAN_CLEANUP_COUNT=1 \
DOTENV_CONFIG_PATH=/home/devbox/project/.env \
node -r dotenv/config jobs/daily-orphan-frozen-check.js --no-notify
```

**é¢„æœŸè¾“å‡º**ï¼š

```
âš ï¸ å­¤å„¿å†»ç»“è¶…é™ï¼Œä»…å‘Šè­¦ä¸æ¸…ç† {
  "orphan_count": <å®é™…æ•°é‡>,
  "total_orphan_amount": <å®é™…é‡‘é¢>,
  "max_count": 1,
  "max_amount": 1
}

æ¸…ç†ç»“æœ:
  - è·³è¿‡æ¸…ç†: æ˜¯
  - è·³è¿‡åŸå› : è¶…å‡ºå•æ¬¡æ¸…ç†é™é¢ï¼Œéœ€äººå·¥ä»‹å…¥
  - é™é¢ä¿¡æ¯:
    - æ¡æ•°é™é¢: 1
    - é‡‘é¢é™é¢: 1
    - å®é™…æ¡æ•°: <å®é™…æ•°é‡>
    - å®é™…é‡‘é¢: <å®é™…é‡‘é¢>
```

**éªŒè¯è¦ç‚¹**ï¼š

- âœ… è¶…é™æ—¶ä¸æ‰§è¡Œæ¸…ç†
- âœ… ç”Ÿæˆè¶…é™å‘Šè­¦æŠ¥å‘Š
- âœ… æ•°æ®åº“æœªè¢«ä¿®æ”¹

---

### éªŒè¯é€šè¿‡æ ‡å‡†

æ‰€æœ‰é˜¶æ®µéªŒè¯é€šè¿‡åï¼Œç¡®è®¤ä»¥ä¸‹æ ‡å‡†ï¼š

| éªŒè¯é¡¹            | æ ‡å‡†                     | çŠ¶æ€ |
| ----------------- | ------------------------ | ---- |
| 1. æ£€æµ‹é€»è¾‘æ­£ç¡®   | èƒ½æ­£ç¡®è¯»å–æ•°ç»„å¹¶è®¡ç®—æ±‡æ€» | â¬œ   |
| 2. æ¼”ç»ƒæ¨¡å¼æ­£å¸¸   | dry-run ä¸ä¿®æ”¹æ•°æ®åº“     | â¬œ   |
| 3. å°æµé‡æ¸…ç†æˆåŠŸ | å•ç”¨æˆ·æ¸…ç†æ­£ç¡®ï¼Œå®¡è®¡å®Œæ•´ | â¬œ   |
| 4. å®šæ—¶ä»»åŠ¡ç¨³å®š   | è¿ç»­ 7 å¤©æ— é”™è¯¯          | â¬œ   |
| 5. é™é¢ä¿æŠ¤æœ‰æ•ˆ   | è¶…é™æ—¶æ­£ç¡®å‘Šè­¦ä¸æ¸…ç†     | â¬œ   |
| 6. åˆ†å¸ƒå¼é”æ­£å¸¸   | å¤šå®ä¾‹ä¸å†²çª             | â¬œ   |
| 7. é€šçŸ¥æœºåˆ¶æ­£å¸¸   | å‘Šè­¦å’Œé”™è¯¯é€šçŸ¥æ­£å¸¸å‘é€   | â¬œ   |

---

## é™„å½•ï¼šä¸šåŠ¡é€»è¾‘è¯´æ˜

### ä¸šåŠ¡èƒŒæ™¯

**é¡¹ç›®å®šä½**ï¼šé¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ V4.0

**æ ¸å¿ƒä¸šåŠ¡æ¨¡å—**ï¼š

1. **ç§¯åˆ†ä½“ç³»**ï¼šç”¨æˆ·é€šè¿‡æ¶ˆè´¹è·å¾—ç§¯åˆ†ï¼Œå¯ç”¨äºæŠ½å¥–ã€å…‘æ¢å•†å“
2. **æŠ½å¥–ç³»ç»Ÿ**ï¼šæ´»åŠ¨/å¥–å“/ä¿åº•ç­–ç•¥ï¼Œæ”¯æŒç®¡ç†å‘˜å¹²é¢„
3. **äº¤æ˜“å¸‚åœº**ï¼šC2C æŒ‚ç‰Œäº¤æ˜“ï¼Œç”¨æˆ·å¯å°†èµ„äº§ï¼ˆææ–™ã€é“å…·ç­‰ï¼‰æŒ‚ç‰Œå‡ºå”®

### å­¤å„¿å†»ç»“äº§ç”ŸåŸå› 

**æ­£å¸¸æµç¨‹**ï¼š

1. ç”¨æˆ·åœ¨äº¤æ˜“å¸‚åœºæŒ‚ç‰Œå‡ºå”®èµ„äº§
2. ç³»ç»Ÿå†»ç»“å¯¹åº”æ•°é‡çš„èµ„äº§ï¼ˆ`frozen_amount` å¢åŠ ï¼‰
3. æŒ‚ç‰ŒçŠ¶æ€ä¸º `on_sale`ï¼ˆæ´»è·ƒæŒ‚ç‰Œï¼‰
4. æŒ‚ç‰Œæ’¤é”€/å”®å‡ºåï¼Œç³»ç»Ÿè§£å†»èµ„äº§ï¼ˆ`frozen_amount` å‡å°‘ï¼‰

**å¼‚å¸¸æƒ…å†µï¼ˆå¯¼è‡´å­¤å„¿å†»ç»“ï¼‰**ï¼š

1. **æŒ‚ç‰ŒçŠ¶æ€å¼‚å¸¸**ï¼šæŒ‚ç‰Œè®°å½•è¢«åˆ é™¤æˆ–çŠ¶æ€å¼‚å¸¸ï¼Œä½†å†»ç»“æœªè§£é™¤
2. **æ•°æ®ä¸ä¸€è‡´**ï¼šå†»ç»“é‡‘é¢ > å®é™…æ´»è·ƒæŒ‚ç‰Œæ±‡æ€»é‡‘é¢
3. **å†å²é—ç•™**ï¼šæ—©æœŸç‰ˆæœ¬çš„æ•°æ®è¿ç§»é—®é¢˜
4. **ç³»ç»Ÿæ•…éšœ**ï¼šæŒ‚ç‰Œ/æ’¤é”€æµç¨‹ä¸­æ–­ï¼Œäº‹åŠ¡æœªå®Œæ•´æ‰§è¡Œ

**å½±å“**ï¼š

- ç”¨æˆ·èµ„äº§è¢«é”™è¯¯é”å®šï¼Œæ— æ³•ä½¿ç”¨
- å½±å“ç”¨æˆ·ä½“éªŒå’Œä¿¡ä»»åº¦
- å¯èƒ½æ¶‰åŠåˆè§„é£é™©

### å­¤å„¿å†»ç»“æ£€æµ‹é€»è¾‘

**æ£€æµ‹ SQLï¼ˆç®€åŒ–ç‰ˆï¼‰**ï¼š

```sql
-- 1. æŸ¥è¯¢æ‰€æœ‰æœ‰å†»ç»“ä½™é¢çš„è´¦æˆ·
SELECT
  aab.user_id,
  aab.asset_code,
  aab.frozen_amount
FROM account_asset_balances aab
INNER JOIN accounts a ON aab.account_id = a.account_id
WHERE aab.frozen_amount > 0
  AND a.account_type = 'user';

-- 2. æŸ¥è¯¢æ‰€æœ‰æ´»è·ƒæŒ‚ç‰Œçš„å†»ç»“æ€»é¢
SELECT
  ml.seller_user_id,
  ml.offer_asset_code,
  SUM(ml.offer_amount) AS total_listed
FROM market_listings ml
WHERE ml.status = 'on_sale'
GROUP BY ml.seller_user_id, ml.offer_asset_code;

-- 3. å¯¹æ¯”å†»ç»“é‡‘é¢å’ŒæŒ‚ç‰Œé‡‘é¢
-- å¦‚æœ frozen_amount > total_listedï¼Œåˆ™å­˜åœ¨å­¤å„¿å†»ç»“
-- orphan_amount = frozen_amount - total_listed
```

### æ¸…ç†ç­–ç•¥

**äº§å“å†³ç­–**ï¼šç”¨æˆ·ä½“éªŒä¼˜å…ˆï¼Œè‡ªåŠ¨è§£å†»å­¤å„¿å†»ç»“

**æ¸…ç†æµç¨‹**ï¼š

1. æ£€æµ‹å­¤å„¿å†»ç»“
2. æ£€æŸ¥é™é¢ä¿æŠ¤ï¼ˆé˜²æ­¢å¼‚å¸¸æƒ…å†µä¸‹å¤§é‡æ¸…ç†ï¼‰
3. ä½¿ç”¨åˆ†å¸ƒå¼é”é˜²æ­¢å¹¶å‘æ¸…ç†
4. è°ƒç”¨ `AssetService.unfreeze()` è§£å†»èµ„äº§
5. è®°å½•å®¡è®¡æµæ°´ï¼ˆ`business_type = 'orphan_frozen_cleanup'`ï¼‰
6. å‘é€å‘Šè­¦é€šçŸ¥

**å®¡è®¡è¦æ±‚**ï¼š

- æ‰€æœ‰æ¸…ç†æ“ä½œå¿…é¡»è®°å½• `operator_id`ï¼ˆæ‰§è¡Œè€…ï¼‰
- å®¡è®¡æµæ°´åŒ…å«å®Œæ•´çš„å…ƒæ•°æ®ï¼ˆåŸå§‹å†»ç»“ã€æŒ‚ç‰Œã€å­¤å„¿é‡‘é¢ç­‰ï¼‰
- æ”¯æŒè¿½æº¯å’Œå›æ»š

### æŠ€æœ¯æ¶æ„

**æŠ€æœ¯æ ˆ**ï¼š

- **åç«¯**ï¼šNode.js (>=20) + Express
- **æ•°æ®åº“**ï¼šMySQL + Sequelize ORM (mysql2)
- **ç¼“å­˜/é”**ï¼šRedis (ioredis)
- **å®šæ—¶ä»»åŠ¡**ï¼šnode-cronï¼ˆåœ¨åº”ç”¨è¿›ç¨‹å†…è°ƒåº¦ï¼‰
- **æ—¥å¿—**ï¼šWinstonï¼ˆç»“æ„åŒ–æ—¥å¿—ï¼‰

**å®šæ—¶ä»»åŠ¡æ¶æ„**ï¼š

- å®šæ—¶ä»»åŠ¡åœ¨ `app.js` è¿›ç¨‹å†…è¿è¡Œï¼ˆéç‹¬ç«‹è¿›ç¨‹ï¼‰
- ä½¿ç”¨ Redis åˆ†å¸ƒå¼é”é˜²æ­¢å¤šå®ä¾‹å¹¶å‘æ‰§è¡Œ
- æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼ˆé€šè¿‡ `ScheduledTasks.manualOrphanFrozenCheck()`ï¼‰

**æœåŠ¡å±‚æ¶æ„**ï¼š

- ç»Ÿä¸€æœåŠ¡ç®¡ç†å™¨ï¼ˆServiceManagerï¼‰
- æ‰€æœ‰æœåŠ¡ä½¿ç”¨ snake_case å‘½åï¼ˆE2-Strict è§„èŒƒï¼‰
- æœåŠ¡é—´é€šè¿‡ä¾èµ–æ³¨å…¥è§£è€¦

---

## æ€»ç»“

### é—®é¢˜æ ¹å› 

1. âœ… åŸå§‹æŠ¥å‘Šçš„ camelCase é—®é¢˜å·²ä¸å­˜åœ¨
2. ğŸ”´ å®é™…å­˜åœ¨æ›´ä¸¥é‡çš„ Job/Service å¥‘çº¦ä¸ä¸€è‡´é—®é¢˜
3. ğŸ”´ ç¼ºå°‘ç³»ç»Ÿæ‰§è¡Œè€…è´¦å·é…ç½®
4. âš ï¸ åŸè®¾è®¡"è‡ªåŠ¨æ¸…ç†"å­˜åœ¨é£é™©

### æ•°æ®åº“ç°çŠ¶æ ¸å®ï¼ˆ2026-01-15 çœŸå®æŸ¥è¯¢ï¼‰

> ä»¥ä¸‹ä¿¡æ¯åŸºäº Node.js/Sequelize ç›´è¿ `.env` æŒ‡å‘çš„çœŸå®æ•°æ®åº“æŸ¥è¯¢å¾—åˆ°ï¼Œä¸æ˜¯çŒœæµ‹æˆ–å†å²æ–‡æ¡£ã€‚

**`users` è¡¨ç»“æ„**ï¼š

- âŒ æ—  `username` å­—æ®µï¼ˆåŸæ–¹æ¡ˆä¸­ `INSERT INTO users (username, ...)` éœ€ä¿®æ­£ï¼‰
- âœ… æœ‰ `user_id`, `mobile`, `nickname`, `status`, `user_uuid` ç­‰å­—æ®µ

**æƒé™ç³»ç»Ÿ**ï¼š

- âœ… ä½¿ç”¨ RBACï¼š`roles` + `user_roles` å…³è”è¡¨
- âŒ ä¸æ˜¯ `users.role` å­—æ®µ

**ç°æœ‰è§’è‰²**ï¼ˆ9ä¸ªï¼‰ï¼š
| role_name | role_level | è¯´æ˜ |
|-----------|------------|------|
| admin | 100 | è¶…çº§ç®¡ç†å‘˜ |
| regional_manager | 80 | åŒºåŸŸç»ç† |
| business_manager | 60 | ä¸šåŠ¡ç»ç† |
| sales_staff | 40 | é”€å”®äººå‘˜ |
| merchant_manager | 40 | å•†æˆ·ç®¡ç†å‘˜ |
| ops | 30 | è¿è¥ |
| merchant_staff | 20 | å•†æˆ·å‘˜å·¥ |
| campaign_2 | 10 | æ´»åŠ¨è§’è‰² |
| user | 0 | æ™®é€šç”¨æˆ· |

**ç°æœ‰ admin ç”¨æˆ·**ï¼š

- user_id=31ï¼ˆnickname: ç®¡ç†å‘˜ç”¨æˆ·ï¼Œmobile: 136...ï¼‰
- user_id=135ï¼ˆnickname: æµ‹è¯•ç”¨æˆ·2ï¼Œmobile: 138...ï¼‰

**`system_job` è§’è‰²**ï¼šâŒ ä¸å­˜åœ¨ï¼Œéœ€æ–°å»º

### å·²æ‹æ¿å†³ç­–æ‘˜è¦

| å†³ç­–é¡¹               | æ‹æ¿ç»“æœ                                           | è¦ç‚¹                                                                                                                             |
| -------------------- | -------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------- |
| **æƒå¨å¥‘çº¦**         | Service ä¸ºæƒå¨ï¼ŒJob é€‚é…                           | `detectOrphanFrozen()` è¿”å›ç¨³å®š DTO å¯¹è±¡ï¼Œä¸€æ¬¡æ€§æ”¹å®Œæ‰€æœ‰è°ƒç”¨ç‚¹                                                                   |
| **DTO å­—æ®µ**         | 7ä¸ªå¿…å¡« + 2ä¸ªæ–°å¢                                  | `orphan_count`, `total_orphan_amount`, `orphan_items`, `checked_count`, `generated_at`, `affected_user_count`, `items_truncated` |
| **orphan_items**     | 5ä¸ªæœ€å°å­—æ®µ                                        | `user_id`, `asset_code`, `frozen_amount`, `listed_amount`, `orphan_amount`                                                       |
| **operator_id ç­–ç•¥** | âœ… ä¸€æ­¥åˆ°ä½ï¼šæ–°å»º `system_job` è§’è‰² + ä¸“ç”¨ç³»ç»Ÿç”¨æˆ· | è§"ä¿®å¤ 7"è¯¦ç»†æ–¹æ¡ˆ                                                                                                               |
| **å®šæ—¶ä»»åŠ¡åŠ¨ä½œ**     | åªæ£€æµ‹+å‘Šè­¦ï¼Œä¸æ”¹åº“                                | ä¿®å¤èµ°äººå·¥/åå°å—æ§å·¥å…·                                                                                                          |
| **å‘Šè­¦åˆ†çº§**         | ä¸‰ç»´é˜ˆå€¼ P0/P1/P2                                  | å½±å“é¢ + ä¸¥é‡åº¦ + è¶‹åŠ¿/å¤å‘                                                                                                      |
| **P0 é˜ˆå€¼**          | ä»»ä¸€æ»¡è¶³å³ P0                                      | `affected_asset_codes >= 3` æˆ– `affected_users >= 5` æˆ– `orphan_items_count >= 20` æˆ– è¿ç»­å¤å‘                                   |
| **æ­¢æŸç­–ç•¥**         | å…è®¸ï¼ˆä¸æ”¹ä½™é¢ï¼‰                                   | P0 æ—¶å¯æš‚åœç›¸å…³èµ„äº§çš„æ–°æŒ‚å•/äº¤æ˜“å…¥å£                                                                                             |
| **å¤å‘æ£€æµ‹å­˜å‚¨**     | Redis                                              | Key: `orphan_frozen:last_run`ï¼ŒTTL: 48h                                                                                          |

### system_job è§’è‰²å®æ–½æ–¹æ¡ˆæ‘˜è¦

> **å·²ç¡®è®¤å‚æ•°**ï¼ˆ2026-01-15 æ‹æ¿ï¼‰ï¼š
>
> - `assigned_by` = **31**ï¼ˆç®¡ç†å‘˜ç”¨æˆ·ï¼‰
> - `mobile` = **00000000001**ï¼ˆå…è®¸ä½¿ç”¨ï¼‰

| æ­¥éª¤ | å†…å®¹                                                                  | çŠ¶æ€      |
| ---- | --------------------------------------------------------------------- | --------- |
| 1    | åˆ›å»º `system_job` è§’è‰²ï¼ˆrole_level=5ï¼Œæœ€å°æƒé™ï¼‰                      | â¬œ å¾…æ‰§è¡Œ |
| 2    | åˆ›å»ºç³»ç»Ÿä¸“ç”¨ç”¨æˆ·ï¼ˆmobile=`00000000001`ï¼Œnickname=`SYSTEM_DAILY_JOB`ï¼‰ | â¬œ å¾…æ‰§è¡Œ |
| 3    | ç»‘å®šç”¨æˆ·ä¸è§’è‰²ï¼ˆ`user_roles` è¡¨ï¼Œ`assigned_by=31`ï¼‰                   | â¬œ å¾…æ‰§è¡Œ |
| 4    | é…ç½® `.env`ï¼š`SYSTEM_DAILY_JOB_USER_ID=<æ–°ç”¨æˆ·ID>`                    | â¬œ å¾…æ‰§è¡Œ |
| 5    | éªŒè¯é…ç½®ç”Ÿæ•ˆ                                                          | â¬œ å¾…æ‰§è¡Œ |

**æƒé™è¾¹ç•Œ**ï¼š

- âœ… `orphan_frozen:detect,cleanup`
- âœ… `audit_log:write`
- âœ… `asset_balance:read,unfreeze`
- âŒ å…¶ä»–æ‰€æœ‰æƒé™

### å¤å‘æ£€æµ‹å­˜å‚¨æ–¹æ¡ˆ

> åŸºäºé¡¹ç›®å·²æœ‰æŠ€æœ¯æ ˆï¼ˆRedis æ˜¯ç¡¬ä¾èµ–ï¼Œ`UnifiedRedisClient` å¼ºåˆ¶è¦æ±‚ `REDIS_URL`ï¼‰

| é…ç½®é¡¹    | å€¼                       | è¯´æ˜                                                                                             |
| --------- | ------------------------ | ------------------------------------------------------------------------------------------------ |
| **å­˜å‚¨**  | Redis                    | ä¸é¡¹ç›®æŠ€æœ¯è·¯çº¿ä¸€è‡´                                                                               |
| **Key**   | `orphan_frozen:last_run` | å¯æ‰©å±•ä¸º `orphan_frozen:last_run:{env}`                                                          |
| **TTL**   | 48h                      | è¶³å¤Ÿè¦†ç›–"è¿ç»­ 2 æ¬¡è°ƒåº¦"åˆ¤æ–­                                                                      |
| **Value** | JSON                     | `{ generated_at, orphan_count, affected_user_count, affected_asset_codes, total_orphan_amount }` |

### ä¿®å¤ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | ä¿®å¤é¡¹                                    | çŠ¶æ€      |
| ------ | ----------------------------------------- | --------- |
| P0     | Service è¿”å› DTO å¯¹è±¡                     | â¬œ å¾…å®æ–½ |
| P0     | å…¨å±€ç›˜ç‚¹å¹¶åˆ‡æ¢è°ƒç”¨ç‚¹                      | â¬œ å¾…å®æ–½ |
| P0     | cleanup å¥‘çº¦ç»Ÿä¸€                          | â¬œ å¾…å®æ–½ |
| P0     | Job æ”¹ä¸ºåªæ£€æµ‹+å‘Šè­¦                       | â¬œ å¾…å®æ–½ |
| P0     | å‘Šè­¦åˆ†çº§é€»è¾‘                              | â¬œ å¾…å®æ–½ |
| **P0** | **é…ç½®ç³»ç»Ÿæ‰§è¡Œè€…è´¦å·ï¼ˆsystem_job æ–¹æ¡ˆï¼‰** | â¬œ å¾…å®æ–½ |
| P1     | æ­¢æŸèƒ½åŠ›ï¼ˆå¯é€‰ï¼‰                          | â¬œ å¾…å®æ–½ |
| P1     | åå°ä¿®å¤å…¥å£                              | â¬œ å¾…å®æ–½ |
| P1     | å¤å‘æ£€æµ‹å­˜å‚¨                              | â¬œ å¾…å®æ–½ |

### é¢„æœŸæ•ˆæœ

ä¿®å¤åï¼Œå­¤å„¿å†»ç»“å¤„ç†æµç¨‹å°†å˜ä¸ºï¼š

1. âœ… å®šæ—¶ä»»åŠ¡æ­£å¸¸æ£€æµ‹å­¤å„¿å†»ç»“ï¼ˆè¿”å› DTOï¼‰
2. âœ… æ ¹æ®ä¸‰ç»´é˜ˆå€¼åˆ†çº§å‘Šè­¦ï¼ˆP0/P1/P2ï¼‰
3. âœ… **ä¸è‡ªåŠ¨æ¸…ç†**ï¼ˆæ”¹ä¸ºäººå·¥å—æ§ä¿®å¤ï¼‰
4. âœ… P0 çº§åˆ«å¯è§¦å‘æ­¢æŸï¼ˆæš‚åœæŒ‚å•ï¼Œä¸æ”¹ä½™é¢ï¼‰
5. âœ… åå°æä¾›äººå·¥ä¿®å¤æ¥å£ï¼ˆéœ€å®¡è®¡ï¼‰
6. âœ… æ‰€æœ‰ä¿®å¤æ“ä½œå¯è¿½æº¯ï¼ˆ`operator_id` = ä¸“ç”¨ç³»ç»Ÿç”¨æˆ·ï¼‰
7. âœ… æ”¯æŒå¤šå®ä¾‹éƒ¨ç½²ï¼ˆåˆ†å¸ƒå¼é”ï¼‰
8. âœ… å¤å‘æ£€æµ‹ï¼ˆRedis å­˜å‚¨ä¸Šæ¬¡æ£€æµ‹æ‘˜è¦ï¼‰

### åç»­ä¼˜åŒ–å»ºè®®

1. **å¤å‘æ£€æµ‹å®ç°**ï¼šåŸºäº Redis `orphan_frozen:last_run` å®ç°è¿ç»­å¤å‘åˆ¤æ–­
2. **æ ¹å› åˆ†æ**ï¼šåˆ†æå­¤å„¿å†»ç»“äº§ç”Ÿçš„æ ¹æœ¬åŸå› ï¼Œä»æºå¤´å‡å°‘äº§ç”Ÿ
3. **è‡ªåŠ¨åŒ–æµ‹è¯•**ï¼šå¢åŠ é›†æˆæµ‹è¯•ï¼Œè¦†ç›– DTO å¥‘çº¦å’Œå‘Šè­¦åˆ†çº§é€»è¾‘
4. **ç®¡ç†åå°**ï¼šæä¾›å¯è§†åŒ–ç•Œé¢ï¼Œæ”¯æŒæŸ¥è¯¢ã€å®¡æ‰¹ã€æ‰¹é‡ä¿®å¤

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv3.0ï¼ˆsystem_job æ–¹æ¡ˆç¡®å®šç‰ˆï¼‰  
**æœ€åæ›´æ–°**ï¼š2026-01-15  
**å†³ç­–çŠ¶æ€**ï¼šâœ… å·²æ‹æ¿ï¼ˆæƒå¨å¥‘çº¦ + operator_id + åŠ¨ä½œç­–ç•¥ + å‘Šè­¦é˜ˆå€¼ + å¤å‘å­˜å‚¨ï¼‰  
**ä¸‹ä¸€æ­¥**ï¼šæŒ‰"ä¿®å¤ 7"æ‰§è¡Œ DB å˜æ›´ï¼Œåˆ›å»º system_job è§’è‰²å’Œä¸“ç”¨ç”¨æˆ·  
**ç»´æŠ¤è€…**ï¼šæŠ€æœ¯å›¢é˜Ÿ
