# é¢„é˜²æ€§æ£€æŸ¥å·¥å…·ä½¿ç”¨è¯´æ˜

**åˆ›å»ºæ—¶é—´**ï¼š2025å¹´11æœˆ23æ—¥ 22:15:00  
**ç‰ˆæœ¬**ï¼šV1.0

---

## ğŸ¯ å¿«é€Ÿå¼€å§‹

### ä¸€é”®è¿è¡Œæ‰€æœ‰æ£€æŸ¥

```bash
# æ–¹å¼1ï¼šä½¿ç”¨è„šæœ¬
bash scripts/quality-check-complete.sh

# æ–¹å¼2ï¼šä½¿ç”¨npmå‘½ä»¤
npm run check:prevention
```

---

## ğŸ“‹ å¯ç”¨çš„æ£€æŸ¥å·¥å…·

### 1ï¸âƒ£ é…ç½®å†²çªæ£€æµ‹

**ç”¨é€”**ï¼šæ£€æµ‹æ•°æ®åº“é…ç½®å’Œä»£ç é…ç½®æ˜¯å¦é‡å¤å®šä¹‰

```bash
# è¿è¡Œæ£€æŸ¥
npm run check:config-conflicts

# æˆ–
node scripts/check-config-conflicts.js
```

**æ£€æŸ¥å†…å®¹**ï¼š
- æ‰«æ`system_settings`è¡¨ä¸­çš„æ‰€æœ‰é…ç½®
- æ‰«æ`config/business.config.js`ä¸­çš„æ‰€æœ‰é…ç½®
- æ£€æµ‹æ˜¯å¦å­˜åœ¨é‡å¤å®šä¹‰

**é€šè¿‡æ ‡å‡†**ï¼š0ä¸ªå†²çª

---

### 2ï¸âƒ£ éªŒè¯å™¨å®Œæ•´æ€§æ£€æŸ¥

**ç”¨é€”**ï¼šç¡®ä¿æ‰€æœ‰APIä½¿ç”¨çš„éªŒè¯å™¨éƒ½å·²å®ç°

```bash
# è¿è¡Œæ£€æŸ¥
npm run check:validators

# æˆ–
node scripts/check-validators.js
```

**æ£€æŸ¥å†…å®¹**ï¼š
- æ‰«ææ‰€æœ‰è·¯ç”±æ–‡ä»¶ä¸­çš„`validators.xxx()`è°ƒç”¨
- æ£€æŸ¥`shared/middleware.js`ä¸­çš„éªŒè¯å™¨å®ç°
- è¯†åˆ«ç¼ºå¤±çš„éªŒè¯å™¨

**é€šè¿‡æ ‡å‡†**ï¼šæ‰€æœ‰ä½¿ç”¨çš„éªŒè¯å™¨éƒ½å·²å®ç°

---

### 3ï¸âƒ£ ModelConverterå·¥å…·

**ç”¨é€”**ï¼šå®‰å…¨è½¬æ¢Sequelizeæ¨¡å‹ä¸ºæ™®é€šå¯¹è±¡

```javascript
// å¯¼å…¥å·¥å…·
const ModelConverter = require('../utils/model-converter')

// ä½¿ç”¨ç¤ºä¾‹
const prizes = await LotteryPrize.findAll()

// âŒ é”™è¯¯ï¼šç›´æ¥å±•å¼€ä¼šä¸¢å¤±å­—æ®µ
const wrong = prizes.map(p => ({ ...p, custom_field: 'value' }))

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ModelConverter
const correct = prizes.map(p => {
  const plain = ModelConverter.toPlainObject(p)
  return { ...plain, custom_field: 'value' }
})

// âœ… æ‰¹é‡è½¬æ¢
const plains = ModelConverter.bulkConvert(prizes)

// âœ… å­—æ®µè¿‡æ»¤
const filtered = ModelConverter.toPlainObject(prize, {
  fields: ['prize_id', 'prize_name', 'win_probability']
})
```

---

## ğŸ”„ é›†æˆåˆ°å¼€å‘æµç¨‹

### æäº¤å‰æ£€æŸ¥

```bash
# gitæäº¤å‰è¿è¡Œ
bash scripts/quality-check-complete.sh

# å¦‚æœé€šè¿‡
git add .
git commit -m "feat: å®ç°ä¸ªæ€§åŒ–æ¦‚ç‡åŠŸèƒ½"

# å¦‚æœå¤±è´¥
# æ ¹æ®æç¤ºä¿®å¤é—®é¢˜ï¼Œå†æ¬¡æ£€æŸ¥
```

### CI/CDé›†æˆ

```yaml
# .github/workflows/quality-check.yml
name: Quality Check

on: [push, pull_request]

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install dependencies
        run: npm install
      - name: Run quality checks
        run: bash scripts/quality-check-complete.sh
```

---

## ğŸ“Š æ£€æŸ¥ç»“æœè¯´æ˜

### âœ… å…¨éƒ¨é€šè¿‡

```
==========================================
ğŸ‰ æ‰€æœ‰è´¨é‡æ£€æŸ¥é€šè¿‡ï¼
==========================================

å¯ä»¥å®‰å…¨æäº¤ä»£ç æˆ–éƒ¨ç½²æœåŠ¡ï¼
```

### âŒ å‘ç°é—®é¢˜

#### é…ç½®å†²çª

```
âš ï¸ å‘ç°å¯èƒ½çš„é…ç½®å†²çª:

  - æ•°æ®åº“: base_win_rate (lottery)
    ä»£ç ä¸­ç›¸ä¼¼: lottery.base_win_rate

ğŸ’¡ å»ºè®®:
  - è¿è¥é…ç½® â†’ ä¿ç•™åœ¨æ•°æ®åº“
  - æŠ€æœ¯é…ç½® â†’ ç§»è‡³ä»£ç æ–‡ä»¶
  - ç®—æ³•å‚æ•° â†’ ç¦æ­¢æ”¾æ•°æ®åº“
```

**è§£å†³**ï¼š
1. åˆ†æé…ç½®æ€§è´¨ï¼ˆè¿è¥ vs æŠ€æœ¯ï¼‰
2. åˆ é™¤é‡å¤é…ç½®
3. å‚è€ƒ`docs/ç³»ç»Ÿæ€§é—®é¢˜é¢„é˜²æ–¹æ¡ˆ-é…ç½®ç®¡ç†å’Œä¸ªæ€§åŒ–åŠŸèƒ½.md`

#### éªŒè¯å™¨ç¼ºå¤±

```
âŒ å‘ç°ç¼ºå¤±çš„éªŒè¯å™¨:

   - validateCampaignId

ğŸ’¡ è§£å†³æ–¹æ¡ˆ:
   1. åœ¨ routes/v4/unified-engine/admin/shared/middleware.js ä¸­æ·»åŠ 
   2. å‚è€ƒ validateUserId çš„å®ç°æ–¹å¼
   3. æ·»åŠ å®Œæ•´çš„JSDocæ³¨é‡Š
```

**è§£å†³**ï¼š
```javascript
// åœ¨validatorså¯¹è±¡ä¸­æ·»åŠ 
validateCampaignId: campaign_id => {
  if (!campaign_id || isNaN(parseInt(campaign_id))) {
    throw new Error('æ— æ•ˆçš„æ´»åŠ¨ID')
  }
  return parseInt(campaign_id)
}
```

---

## ğŸ› ï¸ å¸¸è§é—®é¢˜

### Q1ï¼šé…ç½®åº”è¯¥æ”¾åœ¨å“ªé‡Œï¼Ÿ

**å†³ç­–æ ‘**ï¼š
```
é…ç½®å‚æ•° â†’ æ˜¯å¦ç»å¸¸å˜åŠ¨ï¼Ÿ
  â”œâ”€â”€ æ˜¯ â†’ æ˜¯å¦éœ€è¦æŠ€æœ¯å®¡æ ¸ï¼Ÿ
  â”‚   â”œâ”€â”€ æ˜¯ â†’ config/business.config.jsï¼ˆé…ç½®æ–‡ä»¶ï¼‰
  â”‚   â””â”€â”€ å¦ â†’ system_settingsè¡¨ï¼ˆæ•°æ®åº“ï¼‰
  â””â”€â”€ å¦ â†’ æ˜¯å¦ç»ä¸èƒ½å˜ï¼Ÿ
      â”œâ”€â”€ æ˜¯ â†’ ä»£ç å¸¸é‡ï¼ˆIMMUTABLE_CONFIGï¼‰
      â””â”€â”€ å¦ â†’ config/business.config.js
```

### Q2ï¼šå¦‚ä½•é¿å…Sequelizeå­—æ®µä¸¢å¤±ï¼Ÿ

**ç»Ÿä¸€ä½¿ç”¨ModelConverter**ï¼š
```javascript
const ModelConverter = require('../utils/model-converter')

// âœ… è½¬æ¢å‰æ£€æŸ¥
if (ModelConverter.isSequelizeModel(object)) {
  object = ModelConverter.toPlainObject(object)
}
```

### Q3ï¼šå¦‚ä½•ç¡®ä¿éªŒè¯å™¨å®Œæ•´ï¼Ÿ

**å¼€å‘æµç¨‹**ï¼š
1. æ–°å¢APIå‰å…ˆæ£€æŸ¥éªŒè¯å™¨
2. ä¸å­˜åœ¨åˆ™å…ˆæ·»åŠ åˆ°`validators`
3. è¿è¡Œ`npm run check:validators`éªŒè¯

---

## ğŸ“ æœ€ä½³å®è·µ

1. **æ¯æ¬¡æäº¤å‰**ï¼šè¿è¡Œ`bash scripts/quality-check-complete.sh`
2. **æ‰©å±•APIå‰**ï¼šæ£€æŸ¥å¹¶æ·»åŠ æ‰€éœ€éªŒè¯å™¨
3. **ä¿®æ”¹é…ç½®å‰**ï¼šç¡®è®¤é…ç½®å±‚çº§ï¼ˆæ•°æ®åº“/ä»£ç ï¼‰
4. **è½¬æ¢æ¨¡å‹æ—¶**ï¼šç»Ÿä¸€ä½¿ç”¨`ModelConverter`
5. **å‰ç«¯å¼€å‘å**ï¼šç§»é™¤"åŠŸèƒ½æš‚æœªå®ç°"æç¤º

---

**ç»´æŠ¤**ï¼šå‘ç°æ–°çš„ç³»ç»Ÿæ€§é—®é¢˜æ—¶ï¼Œæ›´æ–°`docs/ç³»ç»Ÿæ€§é—®é¢˜é¢„é˜²æ–¹æ¡ˆ-é…ç½®ç®¡ç†å’Œä¸ªæ€§åŒ–åŠŸèƒ½.md`

