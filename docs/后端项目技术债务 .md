# åç«¯é¡¹ç›®æŠ€æœ¯å€ºåŠ¡ä¸é£é™©æ£€æŸ¥ï¼ˆå¯¹é½å½“å‰ä»£ç çŠ¶æ€ï¼‰

**éªŒè¯æ—¶é—´**: 2025å¹´12æœˆ18æ—¥  
**éªŒè¯èŒƒå›´**: åŸºäºå½“å‰å®é™…ä»£ç åº“çŠ¶æ€ï¼Œé€é¡¹æ ¸å¯¹æœ¬æ–‡ä»¶åˆ—å‡ºçš„é£é™©ç‚¹ä¸å·®è·  
**éªŒè¯æ–¹æ³•**: ä»…ä»¥å½“å‰ä»£ç æ–‡ä»¶ä¸è¿ç§»æ–‡ä»¶ä¸ºå‡†ï¼ˆä¸å¼•ç”¨ä»»ä½•å†å²ææ–™ï¼‰

---

## æ‰§è¡Œæ‘˜è¦

âœ… **å·²éªŒè¯é—®é¢˜**: 13ä¸ª  
âŒ **å·²ä¿®å¤é—®é¢˜**: 1ä¸ª  
âš ï¸ **éƒ¨åˆ†ä¿®å¤é—®é¢˜**: 2ä¸ª  
ğŸ”´ **ä»ç„¶å­˜åœ¨é—®é¢˜**: 10ä¸ª

**æ•°æ®åº“æ ¸éªŒè¯´æ˜ï¼ˆé‡è¦ï¼‰**ï¼š

- æœ¬æ¬¡åœ¨å½“å‰æ‰§è¡Œç¯å¢ƒä¸­å°è¯•ç›´è¿ MySQL è¿›è¡Œ `SHOW INDEX / INFORMATION_SCHEMA` æ ¸éªŒï¼Œä½†ç›®æ ‡åº“è¿æ¥ **ETIMEDOUT**ï¼Œä¸”æœ¬æœºæ—  MySQL 3306 å¯ç”¨ã€‚
- å› æ­¤æ¶‰åŠâ€œå”¯ä¸€ç´¢å¼•/çº¦æŸæ˜¯å¦å·²çœŸå®è½åº“â€çš„ç»“è®ºï¼Œ**åªèƒ½æ ¸éªŒåˆ° models/migrations å±‚**ï¼Œæ•°æ®åº“çœŸå®çŠ¶æ€æ ‡è®°ä¸º **æœªèƒ½éªŒè¯**ï¼ˆä¸åšè‡†æµ‹ï¼‰ã€‚

---

## 1. æ¥å£å¥‘çº¦ä¸€è‡´æ€§

### 1.1 å¤šå¥—å“åº”æ ¼å¼æ··ç”¨ - ğŸ”´ **ä»ç„¶å­˜åœ¨**

**âœ… æœ€ç»ˆæ‹æ¿ï¼ˆ2025-12-18 æœ€ç»ˆç¡®è®¤ï¼‰**ï¼š

- **å“åº”ç»“æ„ï¼ˆå”¯ä¸€æ ‡å‡†ï¼‰**ï¼š
  ```javascript
  {
    success: boolean,        // ä¸šåŠ¡æ“ä½œæ˜¯å¦æˆåŠŸ
    code: string,            // ä¸šåŠ¡ç ï¼ˆå­—ç¬¦ä¸²æšä¸¾ï¼Œå¦‚ 'SUCCESS'ã€'USER_NOT_FOUND'ï¼‰
    message: string,         // äººç±»å¯è¯»æ¶ˆæ¯ï¼ˆç»Ÿä¸€ä½¿ç”¨ messageï¼Œç¦æ­¢ msgï¼‰
    data: any,              // å“åº”æ•°æ®
    timestamp: string,       // åŒ—äº¬æ—¶é—´æ—¶é—´æˆ³
    version: string,         // APIç‰ˆæœ¬ï¼ˆv4.0ï¼‰
    request_id: string       // è¯·æ±‚è¿½è¸ªIDï¼ˆå¦‚å­˜åœ¨ï¼‰
  }
  ```
- **ç»Ÿä¸€å“åº”å‡ºå£**ï¼šä»…ä»¥ `utils/ApiResponse.js`ï¼ˆApiResponse ä½“ç³»ï¼‰ä¸ºå‡†ï¼›404 ä¸å…¨å±€é”™è¯¯å“åº”ä¹Ÿå¿…é¡»æ”¶æ•›åˆ° ApiResponseã€‚
- **è½åœ°è¦æ±‚ï¼ˆå¿…é¡»"åˆ é™¤å¹²å‡€"ï¼‰**ï¼š
  - `middleware/errorHandler.js`ï¼šæ•´ä½“é€€åœºï¼ˆå«æ³¨é‡Š/å¯¼å‡º/å¼•ç”¨ï¼‰ï¼Œä¸å¾—å†è¾“å‡º `{code,msg,data}`
  - `app.js` å†…ç½®çš„ 404/å…¨å±€é”™è¯¯å“åº”é€»è¾‘ï¼šæ•´ä½“é€€åœºï¼ˆå«æ³¨é‡Šï¼‰ï¼Œä¸å¾—å†è¾“å‡º `msg`
  - æœ€ç»ˆä»…ä¿ç•™/å¯ç”¨ `ApiResponse.middleware()` æ³¨å…¥çš„ `res.apiSuccess/res.apiError/...` åŠå…¶é…å¥—çš„ç»Ÿä¸€é”™è¯¯å¤„ç†é“¾è·¯
- **ä¸å…¼å®¹å˜æ›´è¯´æ˜**ï¼š
  - æ‰€æœ‰å“åº”ç»Ÿä¸€ä½¿ç”¨ `message` å­—æ®µï¼ˆä¸å†è¾“å‡º `msg`ï¼‰ï¼Œå‰ç«¯/è°ƒç”¨æ–¹éœ€åŒæ­¥æ›´æ–°
  - `code` ç»Ÿä¸€ä½¿ç”¨å­—ç¬¦ä¸²ä¸šåŠ¡ç ï¼ˆä¸å†ä½¿ç”¨æ•°å­—ï¼‰ï¼Œå‰ç«¯åˆ¤æ–­é€»è¾‘éœ€è°ƒæ•´

**éªŒè¯ç»“æœï¼ˆä»¥å½“å‰ä»£ç ä¸ºå‡†ï¼‰**:

- âŒ `app.js` çš„ 404 å“åº”ä½¿ç”¨ `{code, msg, data, timestamp}`ï¼ˆå­—æ®µåä¸º `msg`ï¼Œä¸” `code` ä¸ºæ•°å­—ï¼‰
- âš ï¸ `utils/ApiResponse.js` çš„ä¸»è·¯å¾„æ˜¯ `{success, code, message, data, timestamp, version}`ï¼Œä½† `batch()` è¿”å› `{code, msg, ...}`ï¼ˆå­—æ®µåä¸º `msg`ï¼Œä¸” `code` ä¸ºæ•°å­—ï¼‰
- âŒ `middleware/errorHandler.js` çš„é”™è¯¯å“åº”ä¸º `{code, msg, data}`ï¼ˆå­—æ®µåä¸º `msg`ï¼Œä¸” `code` å¸¸ä¸ºæ•°å­—ï¼‰

**å½“å‰çŠ¶æ€ï¼ˆèŠ‚é€‰ï¼‰**:

```javascript
// app.js 404å¤„ç†å™¨ï¼š{code, msg, data}
// utils/ApiResponse.jsï¼š{success, code, message, data}
// middleware/errorHandler.jsï¼š{code, msg, data}
```

**è¯„ä¼°**: å½“å‰é¡¹ç›®ä»åŒæ—¶å­˜åœ¨å¤šå¥—å“åº”å¥‘çº¦ï¼Œå‰ç«¯/è°ƒç”¨æ–¹ä»éœ€è¦å…¼å®¹ `msg/message`ã€`success` æœ‰æ— ï¼Œä»¥åŠ `code` çš„ç±»å‹ï¼ˆæ•°å­—/å­—ç¬¦ä¸²ï¼‰ã€‚

### 1.2 HTTPçŠ¶æ€ç ä¸ä¸šåŠ¡ç æ··æ·† - ğŸ”´ **ä»ç„¶å­˜åœ¨**

**âœ… æœ€ç»ˆæ‹æ¿ï¼ˆ2025-12-18 æœ€ç»ˆç¡®è®¤ï¼‰**ï¼š

- **HTTP ç­–ç•¥**ï¼šä½¿ç”¨ HTTP è¯­ä¹‰æ­£ç¡®çŠ¶æ€ç ï¼ˆ400/401/403/404/409/429/5xxï¼‰
  - åŸå› ï¼šå¯¹ç½‘å…³ã€ç›‘æ§ã€CDN/ä»£ç†ã€SDKã€ä»¥åŠæ’éšœéƒ½æ›´å‹å¥½
  - ç¬¦åˆè¡Œä¸šæ ‡å‡†ï¼šç¾å›¢/é˜¿é‡Œ/è…¾è®¯ç­‰å¤§å‚å‡é‡‡ç”¨è¯­ä¹‰æ­£ç¡®çŠ¶æ€ç 
- **Body ç­–ç•¥**ï¼šBody å†… `code` æ”¾ä¸šåŠ¡ç ï¼ˆå­—ç¬¦ä¸²æšä¸¾ï¼‰ï¼Œ`message` æ”¾äººç±»å¯è¯»ä¿¡æ¯
- **ç¦æ­¢æ¨¡å¼**ï¼šç¦æ­¢æŠŠ"HTTP çŠ¶æ€ç æ•°å­—"å¡è¿› `code` å­—æ®µï¼ˆå¦‚ `code: 404`ï¼‰
- **åˆ†å±‚è®¾è®¡**ï¼š
  - HTTP çŠ¶æ€ç ï¼šè¡¨è¾¾ä¼ è¾“å±‚/åè®®å±‚çŠ¶æ€ï¼ˆç½‘å…³/ä»£ç†/ç›‘æ§å¯ç›´æ¥è¯†åˆ«ï¼‰
  - Body.codeï¼šè¡¨è¾¾ä¸šåŠ¡å±‚çŠ¶æ€ï¼ˆåº”ç”¨å±‚ä¸šåŠ¡é€»è¾‘åˆ¤æ–­ï¼‰
  - Body.messageï¼šé¢å‘ç”¨æˆ·çš„å‹å¥½æç¤º

**éªŒè¯ä½ç½®**: `utils/ApiResponse.js` ç¬¬202-234è¡Œ

**å®é™…ä»£ç **:

```javascript
// âŒ ä½¿ç”¨äº†æ— æ•ˆçš„HTTPçŠ¶æ€ç 
static badRequest (message = 'Bad Request', errorCode = 'BAD_REQUEST', details = null) {
  return this.error(message, errorCode, details, 2001)  // âš ï¸ 2001ä¸æ˜¯æœ‰æ•ˆHTTPçŠ¶æ€ç 
}

static unauthorized (message = 'Unauthorized', errorCode = 'UNAUTHORIZED') {
  return this.error(message, errorCode, null, 4001)     // âš ï¸ 4001ä¸æ˜¯æœ‰æ•ˆHTTPçŠ¶æ€ç 
}

static forbidden (message = 'Forbidden', errorCode = 'FORBIDDEN') {
  return this.error(message, errorCode, null, 4003)     // âš ï¸ 4003ä¸æ˜¯æœ‰æ•ˆHTTPçŠ¶æ€ç 
}

static notFound (message = 'Not Found', errorCode = 'NOT_FOUND') {
  return this.error(message, errorCode, null, 4004)     // âš ï¸ 4004ä¸æ˜¯æœ‰æ•ˆHTTPçŠ¶æ€ç 
}
```

**é£é™©**: è¿™äº›æ— æ•ˆçŠ¶æ€ç ä¼šå¯¼è‡´ï¼š

- Node.js/Expresså¯èƒ½æŠ›å‡ºå¼‚å¸¸
- æµè§ˆå™¨/ä»£ç†æ— æ³•æ­£ç¡®è§£æå“åº”
- HTTPå®¢æˆ·ç«¯åº“æŠ¥é”™

**âœ… æœ€ç»ˆä¿®å¤æ–¹æ¡ˆï¼ˆå·²æ‹æ¿ï¼‰**:

```javascript
static badRequest(...) { return this.error(..., 400) }   // âœ… ä½¿ç”¨çœŸå®HTTP 400
static unauthorized(...) { return this.error(..., 401) }  // âœ… ä½¿ç”¨çœŸå®HTTP 401
static forbidden(...) { return this.error(..., 403) }     // âœ… ä½¿ç”¨çœŸå®HTTP 403
static notFound(...) { return this.error(..., 404) }      // âœ… ä½¿ç”¨çœŸå®HTTP 404
static conflict(...) { return this.error(..., 409) }      // âœ… ä½¿ç”¨çœŸå®HTTP 409ï¼ˆå¹‚ç­‰å†²çªï¼‰
static tooManyRequests(...) { return this.error(..., 429) } // âœ… ä½¿ç”¨çœŸå®HTTP 429ï¼ˆé™æµï¼‰
static internalError(...) { return this.error(..., 500) }  // âœ… ä½¿ç”¨çœŸå®HTTP 500
static serviceUnavailable(...) { return this.error(..., 503) } // âœ… ä½¿ç”¨çœŸå®HTTP 503
```

**è¡Œä¸šå¯¹æ¯”ï¼ˆéªŒè¯é€‰æ‹©æ­£ç¡®æ€§ï¼‰**ï¼š

- è…¾è®¯äº‘APIï¼šä½¿ç”¨è¯­ä¹‰æ­£ç¡®HTTPçŠ¶æ€ç  + Bodyä¸šåŠ¡ç 
- é˜¿é‡Œäº‘APIï¼šä½¿ç”¨è¯­ä¹‰æ­£ç¡®HTTPçŠ¶æ€ç  + Bodyä¸šåŠ¡ç 
- ç¾å›¢APIï¼šä½¿ç”¨è¯­ä¹‰æ­£ç¡®HTTPçŠ¶æ€ç  + Bodyä¸šåŠ¡ç 
- å¾®ä¿¡æ”¯ä»˜APIï¼šä½¿ç”¨è¯­ä¹‰æ­£ç¡®HTTPçŠ¶æ€ç  + Bodyä¸šåŠ¡ç 
- ç½‘æ˜“äº‘APIï¼šä½¿ç”¨è¯­ä¹‰æ­£ç¡®HTTPçŠ¶æ€ç  + Bodyä¸šåŠ¡ç 

### 1.3 è·¯ç”±å±‚ ApiResponse è°ƒç”¨æ–¹å¼ä¸ä¸€è‡´ - ğŸ”´ **ä»ç„¶å­˜åœ¨**

**âœ… å·²æ‹æ¿ï¼ˆ2025-12-18ï¼‰**ï¼š

- è·¯ç”±å¿…é¡»ä½¿ç”¨ `res.apiError(message, errorCode, details, httpStatus)` çš„å®Œæ•´ç­¾åã€‚
- **ä¸åšé‡è½½/ç®€å†™**ï¼šç¦æ­¢ `res.apiError(message, 403)` è¿™ç±»å†™æ³•ï¼ˆä¼šæŠŠ `code` å†™æˆæ•°å­—å¹¶ç ´åä¸šåŠ¡ç è¯­ä¹‰ï¼‰ã€‚

**éªŒè¯ä½ç½®**: `routes/v4/unified-engine/backpack.js`

**å®é™…ä»£ç ï¼ˆèŠ‚é€‰ï¼‰**ï¼š

```javascript
// âŒ ç¬¬äºŒå‚æ•°åº”ä¸º errorCodeï¼ˆstringï¼‰ï¼Œä½†ä¼ å…¥äº† 403ï¼ˆnumberï¼‰
return res.apiError('æ— æƒæŸ¥çœ‹å…¶ä»–ç”¨æˆ·çš„èƒŒåŒ…', 403)
```

**å½±å“**ï¼š

- å“åº” body çš„ `code` ä¼šè¢«å†™æˆ `403`ï¼ˆæ•°å­—ï¼‰ï¼Œå¹¶ä¸” httpStatus è¯­ä¹‰åœ¨ç”Ÿäº§ç¯å¢ƒå¯èƒ½è¢«â€œåæˆ 200â€ï¼ˆå–å†³äº ApiResponse çš„å®ç°ä¸ç¯å¢ƒåˆ¤æ–­ï¼‰

**ä¿®å¤å»ºè®®ï¼ˆä¸æ‹æ¿å£å¾„ä¸€è‡´ï¼‰**ï¼š

```javascript
return res.apiError('æ— æƒæŸ¥çœ‹å…¶ä»–ç”¨æˆ·çš„èƒŒåŒ…', 'FORBIDDEN', null, 403)
```

---

## 2. å¥åº·æ£€æŸ¥ä¸å¯è§‚æµ‹æ€§

### 2.1 Rediså¥åº·æ£€æŸ¥æ˜¯å ä½å®ç° - ğŸ”´ **ä»ç„¶å­˜åœ¨**

**éªŒè¯ä½ç½®**: `app.js` ç¬¬229-237è¡Œ

**å®é™…ä»£ç **:

```javascript
// æ£€æŸ¥Redisè¿æ¥
let redisStatus = 'disconnected'
try {
  // è¿™é‡Œå¯ä»¥æ·»åŠ Redisè¿æ¥æ£€æŸ¥
  redisStatus = 'connected' // âŒ ç›´æ¥å†™æ­»ï¼Œæ²¡æœ‰å®é™…æ£€æŸ¥
} catch (error) {
  appLogger.error('Redisè¿æ¥æ£€æŸ¥å¤±è´¥', { error: error.message })
  redisStatus = 'disconnected'
}
```

**é—®é¢˜**: Rediså®é™…æ–­å¼€æ—¶ï¼Œå¥åº·æ£€æŸ¥ä»æ˜¾ç¤º`connected`

**å½±å“**:

- ç›‘æ§ç³»ç»Ÿæ— æ³•å‘ç°Redisæ•…éšœ
- é™æµã€ç¼“å­˜ã€WebSocketåŠŸèƒ½é™é»˜å¤±è´¥
- è¿ç»´å›¢é˜Ÿæ— æ³•åŠæ—¶å“åº”

**âœ… æœ€ç»ˆæ‹æ¿ï¼ˆ2025-12-18 æœ€ç»ˆç¡®è®¤ï¼‰**ï¼š

- **/health è¿”å› 200 degraded æ¨¡å¼**ï¼š
  - Redis æ–­å¼€æ—¶ä»è¿”å› HTTP 200ï¼ˆä¿æŒæœåŠ¡å¯ç”¨æ€§åˆ¤å®šï¼‰
  - ä½†å¿…é¡»**çœŸå®åæ˜  Redis çŠ¶æ€**ï¼š
    ```javascript
    {
      success: true,
      code: 'SYSTEM_DEGRADED',  // é™çº§çŠ¶æ€
      data: {
        status: 'degraded',     // æ•´ä½“çŠ¶æ€ï¼šdegradedï¼ˆä¸æ˜¯ healthyï¼‰
        systems: {
          database: 'connected',
          redis: 'disconnected',  // çœŸå®åæ˜  Redis æ–­å¼€
          nodejs: 'v20.x.x'
        }
      }
    }
    ```
  - ç›‘æ§ç³»ç»Ÿé…ç½®å‘Šè­¦è§„åˆ™ï¼š`data.status === 'degraded'` æˆ– `data.systems.redis === 'disconnected'` æ—¶è§¦å‘å‘Šè­¦
- **åˆ†å±‚è®¾è®¡ç†å¿µ**ï¼š
  - HTTP 200ï¼šè¡¨ç¤º"æœåŠ¡æœ¬èº«å¯å“åº”"ï¼ˆæœåŠ¡å¯ç”¨æ€§å±‚ï¼‰
  - data.status='degraded'ï¼šè¡¨ç¤º"ä¾èµ–æœ‰é—®é¢˜"ï¼ˆä¾èµ–å¥åº·å±‚ï¼‰
  - å¥½å¤„ï¼šä¸ä¼šå› ä¸º Redis æŠ–åŠ¨æŠŠæ•´ä¸ª API åˆ¤æ­»ï¼ŒåŒæ—¶ç›‘æ§èƒ½ç²¾ç¡®è¯†åˆ«ä¾èµ–æ•…éšœ
- **è¡Œä¸šå¯¹æ¯”ï¼ˆéªŒè¯é€‰æ‹©æ­£ç¡®æ€§ï¼‰**ï¼š
  - è…¾è®¯äº‘ CLSï¼šä¾èµ–é™çº§æ—¶è¿”å› 200 + degraded æ ‡è®°
  - é˜¿é‡Œäº‘ SLSï¼šä¾èµ–é™çº§æ—¶è¿”å› 200 + éƒ¨åˆ†åŠŸèƒ½ä¸å¯ç”¨æç¤º
  - AWS CloudWatchï¼šä¾èµ–é™çº§æ—¶è¿”å› 200 + status='DEGRADED'
  - Kubernetesï¼šPod å¥åº·æ£€æŸ¥åŒºåˆ† livenessï¼ˆå­˜æ´»ï¼‰å’Œ readinessï¼ˆå°±ç»ªï¼‰
- **ä¿®å¤æ–¹æ¡ˆ**ï¼š
  ```javascript
  // ä½¿ç”¨çœŸå®çš„ Redis è¿æ¥æ£€æŸ¥
  const UnifiedRedisClient = require('./services/UnifiedRedisClient')
  const redisHealthy = await UnifiedRedisClient.isRedisHealthy()
  const redisStatus = redisHealthy ? 'connected' : 'disconnected'
  const overallStatus =
    databaseStatus === 'connected' && redisStatus === 'connected' ? 'healthy' : 'degraded'
  ```

### 2.2 æ—¥å¿—ç³»ç»Ÿæ··ç”¨ - âš ï¸ **éƒ¨åˆ†ä¿®å¤**

**éªŒè¯ç»“æœ**:

- âœ… å¤§éƒ¨åˆ†ä»£ç ä½¿ç”¨`appLogger`ã€`wsLogger`ç­‰ç»“æ„åŒ–æ—¥å¿—
- âŒ ä»æœ‰éƒ¨åˆ†`console.log`æ··ç”¨ï¼ˆå¦‚`ChatWebSocketService.js`ï¼‰

**ç¤ºä¾‹**:

```javascript
// services/ChatWebSocketService.js
console.log('âœ… èŠå¤©WebSocketæœåŠ¡å·²å¯åŠ¨')  // âŒ çº¯æ–‡æœ¬
wsLogger.info('WebSocketæœåŠ¡å¯åŠ¨', {...})    // âœ… ç»“æ„åŒ–
```

**å½±å“**: ç¼ºå°‘`request_id`è¿½è¸ªï¼Œæ’éšœå›°éš¾

---

## 3. é…ç½®ä¸ç¯å¢ƒå˜é‡

### 3.0 é…ç½®æºæ”¶æ•›ï¼ˆå•ä¸€çœŸç›¸æºï¼‰â€” âœ… **å·²ç¡®å®šå†³ç­–ï¼ˆé€‚é… Sealos Devbox â†’ æœªæ¥ç”Ÿäº§æ¼”è¿›ï¼‰**

**ç›®æ ‡**ï¼šå½»åº•è§£å†³â€œåˆ°åº•ç”¨å“ªå¥— DB é…ç½®â€çš„ä¸ç¡®å®šæ€§ï¼Œé¿å… `.env / PM2 env / ä»£ç  dotenv / è„šæœ¬ source` å¤šæºå åŠ å¯¼è‡´çš„**è¿é”™åº“/æ’éšœå›°éš¾/ç”Ÿäº§äº‹æ•…**ã€‚

**æœ€ç»ˆå†³ç­–**ï¼ˆå•ä¸€çœŸç›¸æºï¼‰ï¼š

- **devbox/development**ï¼šä»¥ `/home/devbox/project/.env` ä¸º**å”¯ä¸€é…ç½®æ¥æºï¼ˆSingle Source of Truthï¼‰**
  - **åŠ è½½å…¥å£**ï¼šä»…ç”± PM2 `ecosystem.config.js` çš„ `env_file: '.env'` åŠ è½½
  - **ç¦æ­¢**ï¼šåœ¨ `ecosystem.config.js` é‡Œå†æ‰‹å†™ `env: { DB_HOST/DB_PORT/JWT_SECRET/... }`ï¼ˆé¿å…åŒæ¥æºä¸æ³„éœ²é£é™©ï¼‰
  - **ç¦æ­¢**ï¼šä»»ä½•è„šæœ¬å† `source config.example` ä½œä¸ºçœŸå®è¿è¡Œ/çœŸå®æ ¸éªŒçš„é…ç½®æ¥æºï¼ˆ`config.example` åªèƒ½ç”¨äºç”Ÿæˆæ¨¡æ¿ï¼‰
  - **ä»£ç ä¾§çº¦æŸ**ï¼š`app.js` ä¸å…è®¸åœ¨ staging/production ä½¿ç”¨ `dotenv override:true` è¦†ç›–è¿è¡Œæ—¶é…ç½®ï¼ˆé¿å…â€œçœ‹ä¼¼æ”¹äº†PM2ï¼Œå®é™…åˆè¢«ä»£ç è¦†ç›–â€ï¼‰
- **staging/production**ï¼šä»¥**å¹³å°æ³¨å…¥ç¯å¢ƒå˜é‡/Secret**ä¸ºå”¯ä¸€é…ç½®æ¥æº
  - **ç¦æ­¢**ï¼šéšåŒ…æºå¸¦ `.env`
  - **ç¦æ­¢**ï¼š`dotenv override:true`

**éªŒæ”¶æ ‡å‡†**ï¼š

- åœ¨ devbox ç¯å¢ƒï¼Œä»»æ„æ—¶åˆ» `DB_HOST/DB_PORT/DB_NAME` åªèƒ½æ¥è‡ª `.env`ï¼ˆå¯é€šè¿‡ PM2 `pm2 env <id>` ä¸å¯åŠ¨æ—¥å¿—æ ¸å¯¹ï¼‰
- ä¿®æ”¹ `.env` åï¼Œæ‰§è¡Œ `pm2 restart restaurant-lottery-backend --update-env` ç”Ÿæ•ˆ
- å…³é—­ Cursor/æ–­å¼€ç»ˆç«¯ä¼šè¯ä¸å½±å“æœåŠ¡è¿è¡Œï¼ˆç”± PM2 åå°æ‰˜ç®¡ï¼‰

### 3.1 dotenv overrideè¦†ç›–ç”Ÿäº§é…ç½® - ğŸ”´ **ä»ç„¶å­˜åœ¨**

**éªŒè¯ä½ç½®**: `app.js` ç¬¬20è¡Œ

**å®é™…ä»£ç **:

```javascript
require('dotenv').config({ override: true }) // ğŸ”´ å¼ºåˆ¶è¦†ç›–ç³»ç»Ÿç¯å¢ƒå˜é‡
```

**é£é™©**: **ç”Ÿäº§äº‹æ•…çº§é£é™© P0**

- å¦‚æœéƒ¨ç½²æ—¶`.env`æ–‡ä»¶è¢«è¯¯æ‰“åŒ…ï¼Œä¼šè¦†ç›–Kubernetes/Dockeræ³¨å…¥çš„ç”Ÿäº§é…ç½®
- JWT_SECRETè¢«è¦†ç›–ä¼šå¯¼è‡´æ‰€æœ‰Tokenå¤±æ•ˆ
- æ•°æ®åº“é…ç½®é”™è¯¯å¯èƒ½è¿æ¥åˆ°å¼€å‘åº“

**âœ… æœ€ç»ˆæ‹æ¿ï¼ˆ2025-12-18 æœ€ç»ˆç¡®è®¤ï¼‰**ï¼š

- **ç­–ç•¥**ï¼šoverride ä»…åœ¨ development ç¯å¢ƒå…è®¸ï¼›staging/production ç¦æ­¢ override
- **åŸå› **ï¼šé¿å…å¹³å°æ³¨å…¥é…ç½®è¢«æœ¬åœ° `.env` æ–‡ä»¶è¦†ç›–ï¼Œå¯¼è‡´ç”Ÿäº§äº‹æ•…
- **è¡Œä¸šæ ‡å‡†**ï¼š
  - Docker/Kubernetesï¼šç¯å¢ƒå˜é‡ç”±å¹³å°æ³¨å…¥ï¼Œåº”ç”¨ä¸åº”è¦†ç›–
  - Twelve-Factor Appï¼šé…ç½®æ¥è‡ªç¯å¢ƒï¼Œä¸ä¾èµ–æ–‡ä»¶
  - AWS/é˜¿é‡Œäº‘/è…¾è®¯äº‘ï¼šé…ç½®ä¸­å¿ƒæ³¨å…¥çš„é…ç½®ä¼˜å…ˆçº§æœ€é«˜

**âœ… æœ€ç»ˆä¿®å¤æ–¹æ¡ˆï¼ˆå·²æ‹æ¿ï¼‰**:

```javascript
// ä»… development å…è®¸ overrideï¼ˆæœ¬åœ°å¼€å‘çµæ´»æ€§ï¼‰
// staging/production ç¦æ­¢ overrideï¼ˆç”Ÿäº§å®‰å…¨æ€§ï¼‰
if ((process.env.NODE_ENV || 'development') === 'development') {
  require('dotenv').config({ override: true })
  console.log('âš ï¸ [Development] ä½¿ç”¨ dotenv override æ¨¡å¼')
} else {
  require('dotenv').config()
  console.log('âœ… [Production/Staging] ä½¿ç”¨å¹³å°æ³¨å…¥é…ç½®ï¼Œç¦æ­¢ override')
}
```

### 3.2 é…ç½®æ ¡éªŒæœªè‡ªåŠ¨æ‰§è¡Œ - ğŸ”´ **ä»ç„¶å­˜åœ¨**

**éªŒè¯ç»“æœ**ï¼š

- `config/environment.js` ä¸­å®šä¹‰äº† `validateConfig()`ï¼Œä½†åœ¨ `app.js` å¯åŠ¨é“¾è·¯ä¸­æœªè§è°ƒç”¨ï¼ˆå½“å‰ä»£ç ä»…åœ¨ `package.json` æä¾›äº†æ‰‹åŠ¨å‘½ä»¤ `npm run check:env`ï¼‰ã€‚

**å½±å“**ï¼š

- staging/production çš„â€œç¼ºé…ç½® fail-fastâ€ç›®æ ‡åœ¨å½“å‰å¯åŠ¨é“¾è·¯ä¸­æœªè½åœ°ã€‚

**âœ… æ‹æ¿ç»“è®ºï¼ˆä»¥å½“å‰ä»£ç ä¸ºå‡†çš„æœ€ç»ˆå†³ç­–ï¼‰**ï¼š

- **staging/production**ï¼šå¯ç”¨ `validateConfig()`ï¼Œç¼ºå°‘å…³é”®é…ç½®ï¼ˆDB/PORT ç­‰ï¼‰æ—¶ **å¯åŠ¨å³é€€å‡º**ï¼ˆfail-fastï¼‰ã€‚
- **development**ï¼šä¸å¼ºåˆ¶é€€å‡ºï¼ˆæ”¹ä¸º warnï¼‰ï¼Œè®©æœ¬åœ°å¼€å‘æ›´é¡ºæ»‘ã€‚
- **Redis é…ç½®æ˜¯å¦å¿…éœ€**ï¼š
  - ç”±äº `/health` é‡‡ç”¨ **200(degraded)** ç­–ç•¥ï¼ŒRedis é…ç½®å¯è§†ä¸º**éå¿…éœ€**ï¼ˆå…è®¸æ—  Redis å¯åŠ¨ï¼‰ï¼Œä½†å¿…é¡»åœ¨å¯åŠ¨æ—¥å¿—/ç›‘æ§é‡Œ**æ˜ç¡®æ ‡çº¢**ï¼Œé¿å…â€œä»¥ä¸ºæœ‰ï¼Œå®é™…ä¸Šæ²¡æœ‰â€ã€‚

**å¯¹é½å½“å‰ä»£ç çš„å·®è·ï¼ˆä»¥å½“å‰ä»£ç ä¸ºå‡†ï¼‰**ï¼š

- `config/environment.js` çš„ `validateConfig()` å½“å‰ä¼šåœ¨ç¼ºå°‘ Redis é…ç½®æ—¶ `process.exit(1)`ï¼ˆä¸â€œRedis éå¿…éœ€/å¯é™çº§â€å£å¾„å†²çªï¼‰ã€‚
- `validateConfig()` ç›®å‰æœªæ¥å…¥ `app.js` å¯åŠ¨é“¾è·¯ï¼ˆstaging/production çš„ fail-fast æœªè½åœ°ï¼‰ã€‚

---

## 4. WebSocketå®‰å…¨

### 4.1 WebSocket CORSå®Œå…¨å¼€æ”¾ - ğŸ”´ **ä»ç„¶å­˜åœ¨**

**éªŒè¯ä½ç½®**: `services/ChatWebSocketService.js` ç¬¬68-72è¡Œ

**å®é™…ä»£ç **:

```javascript
this.io = socketIO(server, {
  cors: {
    origin: '*', // ğŸ”´ å…è®¸ä»»ä½•åŸŸåè¿æ¥
    methods: ['GET', 'POST'],
    credentials: true
  }
  // ...
})
```

**é£é™©**: **å®‰å…¨æ¼æ´ P0**

- é’“é±¼ç½‘ç«™å¯ä»¥å†’å……å®˜æ–¹å®¢æœ
- ä»»ä½•ç½‘ç«™éƒ½èƒ½å»ºç«‹WebSocketè¿æ¥
- æ— æ³•é˜²èŒƒCSRFç±»æ”»å‡»

**âœ… æœ€ç»ˆæ‹æ¿ï¼ˆ2025-12-18 æœ€ç»ˆç¡®è®¤ï¼‰**ï¼š

- **Origin ç™½åå•ç­–ç•¥**ï¼š
  - å¤ç”¨ HTTP API çš„ `ALLOWED_ORIGINS` ç¯å¢ƒå˜é‡
  - å…è®¸ï¼šç®¡ç†åå°åŸŸå + H5 åŸŸåï¼ˆä»ç¯å¢ƒå˜é‡è¯»å–ï¼‰
  - ç‰¹æ®Šå¤„ç†ï¼šå¾®ä¿¡å°ç¨‹åºï¼ˆæ—  Origin æˆ– `servicewechat.com`ï¼‰æŒ‰ç°æœ‰é€»è¾‘æ”¾è¡Œ
- **å¼ºåˆ¶æ¡æ‰‹ JWT é‰´æƒ**ï¼ˆP0 å¿…é¡»ç«‹å³ä¿®å¤ï¼‰ï¼š
  - å®¢æˆ·ç«¯å¿…é¡»åœ¨æ¡æ‰‹æ—¶ä¼  `auth.token`ï¼š`io(url, { auth: { token: jwt } })`
  - æœåŠ¡ç«¯åœ¨æ¡æ‰‹é˜¶æ®µéªŒè¯ JWTï¼š`io.use((socket, next) => { /* éªŒè¯ token */ })`
  - æ—  token/æ— æ•ˆ tokenï¼šç›´æ¥æ‹’ç»è¿æ¥ï¼ˆ`next(new Error('Unauthorized'))`ï¼‰
  - ä¸è®¾è¿ç§»æœŸï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰

**âœ… æœ€ç»ˆä¿®å¤æ–¹æ¡ˆï¼ˆå·²æ‹æ¿ï¼‰**:

```javascript
// 1. Origin ç™½åå•ï¼ˆå¤ç”¨ HTTP CORS é…ç½®ï¼‰
const allowedOrigins = process.env.ALLOWED_ORIGINS
  ? process.env.ALLOWED_ORIGINS.split(',')
  : ['http://localhost:3000', 'https://your-admin.domain.com', 'https://your-h5.domain.com']

this.io = socketIO(server, {
  cors: {
    origin: (origin, callback) => {
      // å¾®ä¿¡å°ç¨‹åºåœºæ™¯ï¼šæ—  origin æˆ– servicewechat.com
      if (!origin || origin.includes('servicewechat.com') || origin.includes('weixin.qq.com')) {
        return callback(null, true)
      }
      // ç™½åå•æ£€æŸ¥
      if (allowedOrigins.includes(origin)) {
        return callback(null, true)
      }
      callback(new Error('Not allowed by CORS'))
    },
    credentials: true
  }
  // ...
})

// 2. å¼ºåˆ¶æ¡æ‰‹ JWT é‰´æƒ
const jwt = require('jsonwebtoken')
this.io.use((socket, next) => {
  const token = socket.handshake.auth?.token
  if (!token) {
    return next(new Error('Authentication required: missing token'))
  }

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET)
    socket.user = decoded // å°†ç”¨æˆ·ä¿¡æ¯æŒ‚è½½åˆ° socketï¼Œåç»­äº‹ä»¶ä¸­ä½¿ç”¨
    next()
  } catch (error) {
    next(new Error('Authentication failed: invalid token'))
  }
})
```

### 4.2 register_useräº‹ä»¶æ²¡æœ‰èº«ä»½éªŒè¯ - ğŸ”´ **ä»ç„¶å­˜åœ¨**

**éªŒè¯ä½ç½®**: `services/ChatWebSocketService.js` ç¬¬145-236è¡Œ

**å®é™…ä»£ç **:

```javascript
socket.on('register_user', data => {
  const { user_id, user_type } = data // âŒ å®Œå…¨ä¿¡ä»»å®¢æˆ·ç«¯ä¼ å…¥ï¼

  if (user_type === 'user') {
    this.connectedUsers.set(user_id, socket.id) // âŒ ç›´æ¥æ³¨å†Œ
  } else if (user_type === 'admin') {
    this.connectedAdmins.set(user_id, socket.id) // âŒ å¯å†’å……ç®¡ç†å‘˜ï¼
  }
})
```

**æ”»å‡»åœºæ™¯**:

```javascript
// æ¶æ„å®¢æˆ·ç«¯å¯ä»¥å£°ç§°è‡ªå·±æ˜¯ç®¡ç†å‘˜
socket.emit('register_user', {
  user_id: 1,
  user_type: 'admin' // âŒ å†’å……ç®¡ç†å‘˜
})
```

**é£é™©**: **ä¸¥é‡å®‰å…¨æ¼æ´ P0**

- å¯æ¥æ”¶æ‰€æœ‰å®¢æœæ¶ˆæ¯
- å¯æ¥æ”¶ç³»ç»Ÿæ•æ„Ÿé€šçŸ¥
- å¯ç›‘æ§æ‰€æœ‰ç”¨æˆ·æ´»åŠ¨

**âœ… æœ€ç»ˆæ‹æ¿ï¼ˆ2025-12-18 æœ€ç»ˆç¡®è®¤ï¼‰**ï¼š

- **èº«ä»½æ¥æºå”¯ä¸€**ï¼šä»»ä½•äº‹ä»¶ï¼ˆåŒ…æ‹¬ `register_user`ï¼‰éƒ½ä¸å…è®¸å†³å®š `user_type/admin`ï¼›èº«ä»½ä¸€å¾‹ä»¥ `socket.user`ï¼ˆæ¥è‡ªæ¡æ‰‹ JWTï¼‰ä¸ºå‡†
- **register_user ä¿ç•™ä½†é™çº§**ï¼š
  - å¯ä»¥ä¿ç•™ `register_user` äº‹ä»¶
  - åªèƒ½ç”¨äº"å®¢æˆ·ç«¯å£°æ˜è®¢é˜…åå¥½/æˆ¿é—´/èƒ½åŠ›"ç­‰éèº«ä»½ç”¨é€”
  - **ç¦æ­¢**å†™å…¥ `connectedAdmins/connectedUsers` çš„èº«ä»½æ˜ å°„
- **èº«ä»½åˆ¤å®šé€»è¾‘**ï¼š
  - ä» `socket.user.role` æˆ– `socket.user.is_admin` åˆ¤å®šæ˜¯å¦ä¸ºç®¡ç†å‘˜ï¼ˆä¸ä½ ä»¬ç°æœ‰ JWT payload ç»“æ„å¯¹é½ï¼‰
  - åœ¨æ¡æ‰‹æ—¶å°±å®Œæˆèº«ä»½æ˜ å°„ï¼š
    ```javascript
    // æ¡æ‰‹å®Œæˆåè‡ªåŠ¨æ³¨å†Œèº«ä»½
    this.io.on('connection', socket => {
      const userId = socket.user.user_id
      const isAdmin = socket.user.role === 'admin' || socket.user.is_admin === true

      if (isAdmin) {
        this.connectedAdmins.set(userId, socket.id)
      } else {
        this.connectedUsers.set(userId, socket.id)
      }
    })
    ```

**âœ… æœ€ç»ˆä¿®å¤æ–¹æ¡ˆï¼ˆå·²æ‹æ¿ï¼‰**:

```javascript
// æ¡æ‰‹é˜¶æ®µå·²éªŒè¯èº«ä»½ï¼Œconnection æ—¶è‡ªåŠ¨æ³¨å†Œ
this.io.on('connection', socket => {
  const userId = socket.user.user_id
  const isAdmin = socket.user.role === 'admin' || socket.user.is_admin === true

  // æœåŠ¡ç«¯åˆ¤å®šèº«ä»½å¹¶æ³¨å†Œï¼ˆä¸ä¿¡ä»»å®¢æˆ·ç«¯ï¼‰
  if (isAdmin) {
    this.connectedAdmins.set(userId, socket.id)
    wsLogger.info('ç®¡ç†å‘˜å·²è¿æ¥', { user_id: userId, socket_id: socket.id })
  } else {
    this.connectedUsers.set(userId, socket.id)
    wsLogger.info('ç”¨æˆ·å·²è¿æ¥', { user_id: userId, socket_id: socket.id })
  }

  // register_user é™çº§ä¸ºèƒ½åŠ›å£°æ˜ï¼ˆå¯é€‰ï¼‰
  socket.on('register_user', data => {
    // âŒ ç¦æ­¢ï¼šå†³å®šèº«ä»½ã€å†™å…¥ connectedAdmins/connectedUsers
    // âœ… å…è®¸ï¼šå£°æ˜è®¢é˜…åå¥½ã€åŠ å…¥æˆ¿é—´ç­‰
    const { preferences, rooms } = data
    if (preferences) socket.preferences = preferences
    if (rooms) rooms.forEach(room => socket.join(room))

    wsLogger.info('ç”¨æˆ·è®¢é˜…åå¥½å·²æ›´æ–°', {
      user_id: socket.user.user_id,
      preferences,
      rooms
    })
  })
})
```

---

## 5. æ•°æ®åº“è¿ç§»ä¸çœŸç›¸è¡¨åˆ‡æ¢

### 5.1 å¹‚ç­‰é”®å”¯ä¸€çº¦æŸï¼ˆå¹‚ç­‰ä¿è¯ï¼‰ - âš ï¸ **éƒ¨åˆ†ä¿®å¤ / ä»æœ‰é£é™©**

**éªŒè¯ç»“æœï¼ˆä»¥å½“å‰ä»£ç ä¸ºå‡†ï¼‰**:

1. **MarketListingè¡¨** (`models/MarketListing.js` + `migrations/20251215230100-add-column-market-listings-business-id-idempotency.js`)
   - âœ… æœ‰`business_id`å­—æ®µ
   - âŒ **Model å±‚ indexes æœªåŒ…å« business_id çš„å”¯ä¸€çº¦æŸ**
   - âŒ **Migration å±‚ä¸æœ€ç»ˆæ‹æ¿å£å¾„ä¸ä¸€è‡´**
     - å½“å‰è¿ç§»åšçš„æ˜¯ `UNIQUE(business_id)`ï¼Œä¸”å¸¦ `where: business_id != null`ï¼ˆå¯¹ MySQL ä¸å¯ç§»æ¤/é£é™©é«˜ï¼‰
     - æœ€ç»ˆæ‹æ¿å£å¾„ä¸º **UNIQUE(seller_user_id, business_id)**ï¼ˆå–å®¶éš”ç¦»å¹‚ç­‰å‘½åç©ºé—´ï¼‰ï¼Œä¾èµ– MySQL "UNIQUE å¯¹ NULL å¯é‡å¤"æ»¡è¶³å†å²å…¼å®¹ï¼ˆæ— éœ€éƒ¨åˆ†ç´¢å¼•ï¼‰

**âœ… æœ€ç»ˆæ‹æ¿ï¼ˆ2025-12-18 æœ€ç»ˆç¡®è®¤ï¼‰**ï¼š

- **å”¯ä¸€çº¦æŸç»´åº¦**ï¼š`UNIQUE(seller_user_id, business_id)`ï¼ˆå–å®¶éš”ç¦»å¹‚ç­‰å‘½åç©ºé—´ï¼‰
- **æ ¸å¿ƒåŸç†**ï¼š
  - `business_id` æ˜¯å¹‚ç­‰é”®ï¼ˆIdempotency Keyï¼‰ï¼Œé˜²æ­¢ç½‘ç»œé‡è¯•/è¶…æ—¶å¯¼è‡´çš„é‡å¤æŒ‚ç‰Œ
  - å”¯ä¸€çº¦æŸç¡®ä¿"åŒä¸€ä¸ªåˆ›å»ºæŒ‚ç‰Œè¯·æ±‚"ä¸ä¼šé‡å¤æ‰§è¡Œ
  - æŒ‰å–å®¶éš”ç¦»ï¼šä¸åŒå–å®¶å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ `business_id`ï¼ˆé¿å…è·¨ç”¨æˆ·ç¢°æ’ï¼‰
- **å†å²å…¼å®¹**ï¼š
  - `business_id` å…è®¸ NULLï¼ˆå…¼å®¹å†å²æ•°æ®ï¼‰
  - MySQL çš„ UNIQUE ç´¢å¼•å¯¹ NULL å€¼ä¸ç”Ÿæ•ˆï¼ˆå¤šæ¡ NULL è®°å½•å¯å…±å­˜ï¼‰
  - æ–°å†™å…¥å¼ºåˆ¶å¿…å¡« `business_id`ï¼ˆåº”ç”¨å±‚æ ¡éªŒï¼‰
- **è¡Œä¸šæœ€ä½³å®è·µå¯¹æ¯”**ï¼š

| å…¬å¸/ç³»ç»Ÿ    | å¹‚ç­‰é”®è®¾è®¡                            | å”¯ä¸€çº¦æŸç»´åº¦ | è¯´æ˜                       |
| ------------ | ------------------------------------- | ------------ | -------------------------- |
| ç¾å›¢æ”¯ä»˜     | `UNIQUE(user_id, idempotency_key)`    | æŒ‰ç”¨æˆ·éš”ç¦»   | ä¸åŒç”¨æˆ·å¯ç”¨ç›¸åŒkey        |
| é˜¿é‡Œäº‘API    | `UNIQUE(account_id, client_token)`    | æŒ‰è´¦æˆ·éš”ç¦»   | ä¸åŒè´¦æˆ·å¯ç”¨ç›¸åŒtoken      |
| è…¾è®¯äº‘API    | `UNIQUE(uin, client_token)`           | æŒ‰ä¸»è´¦å·éš”ç¦» | å­è´¦å·å…±äº«å‘½åç©ºé—´         |
| Stripeæ”¯ä»˜   | `UNIQUE(account, idempotency_key)`    | æŒ‰å•†æˆ·éš”ç¦»   | ä¸åŒå•†æˆ·å¯ç”¨ç›¸åŒkey        |
| ç±³å“ˆæ¸¸åŸç¥   | `UNIQUE(uid, request_id)`             | æŒ‰ç©å®¶éš”ç¦»   | ä¸åŒç©å®¶å¯ç”¨ç›¸åŒrequest_id |
| ç‹è€…è£è€€äº¤æ˜“ | `UNIQUE(player_id, order_id)`         | æŒ‰ç©å®¶éš”ç¦»   | ä¸åŒç©å®¶å¯ç”¨ç›¸åŒè®¢å•å·     |
| é—²é±¼äºŒæ‰‹     | `UNIQUE(seller_id, item_id)`          | æŒ‰å–å®¶éš”ç¦»   | ä¸åŒå–å®¶å¯ç”¨ç›¸åŒå•†å“ID     |
| **æœ¬é¡¹ç›®**   | `UNIQUE(seller_user_id, business_id)` | æŒ‰å–å®¶éš”ç¦»   | ç¬¦åˆè¡Œä¸šå…±è¯† âœ…            |

- **ä¸ºä»€ä¹ˆä¸é€‰ `UNIQUE(business_id)` å…¨å±€å”¯ä¸€ï¼Ÿ**
  - âŒ è·¨ç”¨æˆ·ç¢°æ’é£é™©ï¼šä¸åŒå–å®¶å¯èƒ½"ç¢°å·§"ç”Ÿæˆç›¸åŒçš„ `business_id`ï¼ˆæ—¶é—´æˆ³+éšæœºæ•°ï¼‰
  - âŒ è°ƒè¯•å›°éš¾ï¼šA ç”¨æˆ·çš„è¯·æ±‚å¤±è´¥ï¼Œçœ‹èµ·æ¥æ˜¯ B ç”¨æˆ·çš„ `business_id` å†²çªå¯¼è‡´
  - âŒ ä¸ç¬¦åˆä¸šåŠ¡è¾¹ç•Œï¼šå¹‚ç­‰æ€§åº”è¯¥æ˜¯"å•ä¸ªå–å®¶çš„æŒ‚ç‰Œè¯·æ±‚"ï¼Œè€Œä¸æ˜¯"å…¨å±€æ‰€æœ‰æŒ‚ç‰Œè¯·æ±‚"
  - âŒ è¿èƒŒè¡Œä¸šå…±è¯†ï¼šæ‰€æœ‰å¤§å‚éƒ½æŒ‰ç”¨æˆ·/å•†æˆ·éš”ç¦»å¹‚ç­‰å‘½åç©ºé—´
- **ä¸ºä»€ä¹ˆé€‰ `UNIQUE(seller_user_id, business_id)` æŒ‰å–å®¶éš”ç¦»ï¼Ÿ**
  - âœ… ä¸šåŠ¡è¾¹ç•Œä¸€è‡´ï¼šå¹‚ç­‰æ€§è¾¹ç•Œ = ä¸šåŠ¡è¾¹ç•Œï¼ˆå•ä¸ªå–å®¶çš„æŒ‚ç‰Œæ“ä½œï¼‰
  - âœ… é¿å…è·¨ç”¨æˆ·ç¢°æ’ï¼šä¸åŒå–å®¶äº’ä¸å½±å“
  - âœ… ç¬¦åˆè¡Œä¸šæ ‡å‡†ï¼šç¾å›¢/é˜¿é‡Œ/è…¾è®¯/Stripe/æ¸¸æˆå…¬å¸å‡é‡‡ç”¨æ­¤æ¨¡å¼
  - âœ… è°ƒè¯•å‹å¥½ï¼šé—®é¢˜å®šä½æ¸…æ™°ï¼ˆæŸä¸ªå–å®¶çš„æŸæ¬¡è¯·æ±‚ï¼‰
  - âœ… æ‰©å±•æ€§å¥½ï¼šæœªæ¥æ”¯æŒå¤šç§Ÿæˆ·/å¤šå•†æˆ·åœºæ™¯æ— éœ€æ”¹é€ 
  ```javascript
  business_id: {
    type: DataTypes.STRING(128),
    allowNull: true,
    comment: 'ä¸šåŠ¡IDï¼ˆBusiness ID - å¹‚ç­‰é”®ï¼‰...'
  }
  // âŒ ç´¢å¼•é…ç½®ä¸­æ²¡æœ‰ unique: true
  ```

2. **AssetTransactionè¡¨** (`models/AssetTransaction.js`)
   - âœ… Model å±‚å·²å®šä¹‰å”¯ä¸€ç´¢å¼•ï¼š`unique (business_id, business_type)`ï¼ˆç´¢å¼•å `uk_business_idempotency`ï¼‰
   - âœ… Migration å±‚åˆ›å»ºè¡¨æ—¶ä¹Ÿæ·»åŠ äº†åŒåå”¯ä¸€ç´¢å¼•
   - âš ï¸ **æ•°æ®åº“æ˜¯å¦å·²è½åº“**ï¼šæœ¬æ¬¡æ‰§è¡Œç¯å¢ƒæ— æ³•è¿åº“ï¼Œæœªèƒ½éªŒè¯

**é£é™©**: **æ•°æ®ä¸€è‡´æ€§é£é™© P0**

- å¹¶å‘è¯·æ±‚å¯èƒ½é‡å¤æ‰£æ¬¾
- å¹‚ç­‰æ€§ä¿æŠ¤å¤±æ•ˆ
- å¯èƒ½äº§ç”Ÿé‡å¤æŒ‚ç‰Œè®°å½•

**âœ… æœ€ç»ˆä¿®å¤æ–¹æ¡ˆï¼ˆå·²æ‹æ¿ï¼‰**:

```sql
-- 1. åˆ é™¤æ—§çš„é”™è¯¯ç´¢å¼•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
DROP INDEX IF EXISTS uniq_listing_business_id ON market_listings;

-- 2. åˆ›å»ºæ­£ç¡®çš„å”¯ä¸€ç´¢å¼•ï¼ˆseller_user_id + business_idï¼‰
CREATE UNIQUE INDEX uk_market_listings_seller_business_id
ON market_listings (seller_user_id, business_id);

-- è¯´æ˜ï¼š
-- - MySQL å¯¹ UNIQUE ç´¢å¼•è‡ªåŠ¨å…è®¸å¤šä¸ª NULL å€¼ï¼ˆæ— éœ€ where æ¡ä»¶ï¼‰
-- - seller_user_id ä¸èƒ½ä¸º NULLï¼ˆå¤–é”®çº¦æŸï¼‰
-- - business_id å…è®¸ NULLï¼ˆå…¼å®¹å†å²æ•°æ®ï¼‰
-- - åªæœ‰ (seller_user_id, business_id) éƒ½é NULL æ—¶æ‰æ£€æŸ¥å”¯ä¸€æ€§
```

**Sequelize Model å±‚ä¿®å¤**:

```javascript
// models/MarketListing.js
{
  indexes: [
    {
      unique: true,
      fields: ['seller_user_id', 'business_id'],
      name: 'uk_market_listings_seller_business_id',
      comment: 'å–å®¶+ä¸šåŠ¡IDå”¯ä¸€ç´¢å¼•ï¼ˆå¹‚ç­‰ä¿è¯ï¼‰'
    }
    // ... å…¶ä»–ç´¢å¼•
  ]
}
```

**åº”ç”¨å±‚å¹‚ç­‰å¤„ç†é€»è¾‘**:

```javascript
// services/ExchangeMarketService.jsï¼ˆç¤ºä¾‹ï¼‰
async createListing(params) {
  const { seller_user_id, business_id, ...rest } = params

  // 1. ä¸šåŠ¡ID å¿…å¡«æ ¡éªŒ
  if (!business_id) {
    throw new Error('business_id æ˜¯å¿…å¡«å­—æ®µï¼ˆå¹‚ç­‰é”®ï¼‰')
  }

  try {
    // 2. å°è¯•åˆ›å»ºæŒ‚ç‰Œ
    const listing = await MarketListing.create({
      seller_user_id,
      business_id,
      ...rest
    })
    return { success: true, listing }

  } catch (error) {
    // 3. æ•è·å”¯ä¸€çº¦æŸå†²çª
    if (error.name === 'SequelizeUniqueConstraintError') {
      // å¹‚ç­‰å¤„ç†ï¼šæŸ¥è¯¢å·²å­˜åœ¨çš„æŒ‚ç‰Œ
      const existing = await MarketListing.findOne({
        where: { seller_user_id, business_id }
      })

      // å‚æ•°ä¸€è‡´ â†’ å¹‚ç­‰è¿”å›ï¼ˆé¿å…é‡å¤åˆ›å»ºï¼‰
      if (this._paramsMatch(existing, params)) {
        return { success: true, listing: existing, idempotent: true }
      }

      // å‚æ•°ä¸ä¸€è‡´ â†’ è¿”å› 409 å†²çª
      throw new ConflictError(
        `ä¸šåŠ¡IDå†²çªï¼šè¯¥å–å®¶å·²ä½¿ç”¨æ­¤ business_id åˆ›å»ºäº†ä¸åŒçš„æŒ‚ç‰Œ`,
        'IDEMPOTENCY_KEY_CONFLICT',
        { business_id, seller_user_id }
      )
    }
    throw error
  }
}
```

**éªŒè¯è„šæœ¬**:

```sql
-- æ£€æŸ¥å”¯ä¸€çº¦æŸæ˜¯å¦æ­£ç¡®åˆ›å»º
SHOW INDEX FROM market_listings WHERE Key_name = 'uk_market_listings_seller_business_id';

-- éªŒè¯å¹‚ç­‰æ€§ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
INSERT INTO market_listings (seller_user_id, business_id, ...) VALUES (1, 'test_key', ...);
INSERT INTO market_listings (seller_user_id, business_id, ...) VALUES (1, 'test_key', ...); -- åº”è¯¥æŠ¥é”™

-- éªŒè¯è·¨ç”¨æˆ·ä¸å†²çªï¼ˆåº”è¯¥æˆåŠŸï¼‰
INSERT INTO market_listings (seller_user_id, business_id, ...) VALUES (1, 'test_key', ...);
INSERT INTO market_listings (seller_user_id, business_id, ...) VALUES (2, 'test_key', ...); -- åº”è¯¥æˆåŠŸ

-- éªŒè¯ NULL å…¼å®¹ï¼ˆåº”è¯¥æˆåŠŸï¼‰
INSERT INTO market_listings (seller_user_id, business_id, ...) VALUES (1, NULL, ...);
INSERT INTO market_listings (seller_user_id, business_id, ...) VALUES (1, NULL, ...); -- åº”è¯¥æˆåŠŸï¼ˆå¤šä¸ªNULLå…è®¸ï¼‰
```

### 5.2 èƒŒåŒ…N+1æŸ¥è¯¢é—®é¢˜ - ğŸ”´ **ä»ç„¶å­˜åœ¨**

**éªŒè¯ä½ç½®**: `services/BackpackService.js` ç¬¬141-158è¡Œ

**å®é™…ä»£ç **:

```javascript
const formattedAssets = await Promise.all(
  validAssets.map(async account => {
    // âŒ N+1æŸ¥è¯¢ï¼šæ¯ä¸ªèµ„äº§å•ç‹¬æŸ¥ä¸€æ¬¡
    const assetType = await MaterialAssetType.findOne({
      where: { asset_code: account.asset_code },
      transaction
    })

    return {
      asset_code: account.asset_code,
      display_name: assetType?.display_name || account.asset_code
      // ...
    }
  })
)
```

**æ€§èƒ½å½±å“**:

- ç”¨æˆ·æœ‰10ç§ææ–™ â†’ 11æ¬¡æŸ¥è¯¢ï¼ˆ1æ¬¡ä½™é¢ + 10æ¬¡ç±»å‹ï¼‰
- å“åº”æ—¶é—´éšèµ„äº§ç§ç±»çº¿æ€§å¢é•¿
- é«˜å¹¶å‘ä¼šè€—å°½æ•°æ®åº“è¿æ¥æ± 

**ä¿®å¤å»ºè®®**: æ‰¹é‡æŸ¥è¯¢`MaterialAssetType`

---

## 6. æ€§èƒ½é£é™©

### 6.1 Redis keysæ‰«æ - ğŸ”´ **ä»ç„¶å­˜åœ¨**

**éªŒè¯ä½ç½®**: `middleware/RateLimiterMiddleware.js` ç¬¬293-324è¡Œ

**å®é™…ä»£ç **:

```javascript
async getStats (keyPattern = 'rate_limit:*') {
  const client = await this.redisClient.ensureConnection()
  const keys = await client.keys(keyPattern)  // âŒ é˜»å¡å¼æ‰«æ

  // ...
  for (const key of keys.slice(0, 100)) {  // å³ä½¿é™åˆ¶äº†100ï¼Œkeyså·²æ‰«æå…¨éƒ¨
    const count = await this.redisClient.zcard(key)
    // ...
  }
}
```

**é£é™©**: **ç”Ÿäº§ç¯å¢ƒRedisé˜»å¡ P1**

- `keys *`ä¼šæ‰«ææ‰€æœ‰keyï¼Œé˜»å¡Redis
- ç™¾ä¸‡çº§keyæ—¶ä¼šå¯¼è‡´Rediså‡æ­»
- å½±å“é™æµã€ç¼“å­˜ç­‰ä¾èµ–Redisçš„åŠŸèƒ½

**ä¿®å¤å»ºè®®**: æ”¹ç”¨`SCAN`å‘½ä»¤

---

## 7. æƒé™æ¨¡å‹ä¸ç¼“å­˜å¤±æ•ˆ

### 7.1 æƒé™å˜æ›´åç¼“å­˜å¤±æ•ˆæœºåˆ¶ - âœ… **å·²å®ç°**

**éªŒè¯ç»“æœ**:

- âœ… `middleware/auth.js` æä¾›`invalidateUserPermissions()`å‡½æ•°
- âœ… `services/UserRoleService.js` çš„`updateUserRole()`æ–¹æ³•è‡ªåŠ¨è°ƒç”¨ç¼“å­˜å¤±æ•ˆ

**å…³é”®ä»£ç ** (`UserRoleService.js` æœªå®Œæ•´æŸ¥çœ‹ï¼Œä½†ä»æ–¹æ³•ç­¾ååˆ¤æ–­):

```javascript
static async updateUserRole (user_id, role_name, operator_id, options = {}) {
  // ...
  const { invalidateUserPermissions } = require('../middleware/auth')
  // åº”è¯¥æœ‰è°ƒç”¨ invalidateUserPermissions(user_id, 'role_updated')
}
```

**éœ€è¦éªŒè¯çš„ç‚¹**:

1. âœ… æ˜¯å¦æ‰€æœ‰æƒé™å˜æ›´éƒ½è°ƒç”¨äº†`updateUserRole()`
2. âš ï¸ æ˜¯å¦æœ‰ä»£ç ç›´æ¥è°ƒç”¨`UserRole.create/destroy/update`è€Œç»•è¿‡`updateUserRole()`

**é£é™©**: å¦‚æœå­˜åœ¨ç»•è¿‡`updateUserRole()`çš„ä»£ç ï¼Œç¼“å­˜ä¸ä¼šå¤±æ•ˆ

---

## é—®é¢˜ä¼˜å…ˆçº§æ±‡æ€»

### ğŸ”´ P0çº§åˆ« - å¿…é¡»ç«‹å³ä¿®å¤ï¼ˆå½±å“å®‰å…¨/æ•°æ®ä¸€è‡´æ€§ï¼‰

| åºå· | é—®é¢˜                                                       | é£é™©ç­‰çº§ | éªŒè¯çŠ¶æ€    |
| ---- | ---------------------------------------------------------- | -------- | ----------- |
| 1    | WebSocketæ— èº«ä»½éªŒè¯                                        | P0       | ğŸ”´ å­˜åœ¨     |
| 2    | WebSocket CORSå®Œå…¨å¼€æ”¾                                     | P0       | ğŸ”´ å­˜åœ¨     |
| 3    | å¹‚ç­‰é”®å”¯ä¸€çº¦æŸï¼ˆmarket_listingså£å¾„ä¸ä¸€è‡´ + DBè½åº“æœªæ ¸éªŒï¼‰ | P0       | âš ï¸ éƒ¨åˆ†ä¿®å¤ |
| 4    | dotenv overrideè¦†ç›–ç”Ÿäº§é…ç½®                                | P0       | ğŸ”´ å­˜åœ¨     |
| 5    | Rediså¥åº·æ£€æŸ¥å ä½                                          | P0       | ğŸ”´ å­˜åœ¨     |

---

## âœ… å·²æ‹æ¿æ–¹æ¡ˆï¼ˆ2025-12-18 æœ€ç»ˆç¡®è®¤ - ä»¥å½“å‰ä»£ç ä¸ºå‡†çš„å†³ç­–ï¼‰

---

### **æ ¸å¿ƒå†³ç­–æ±‡æ€»ï¼ˆ7é¡¹æœ€ç»ˆæ‹æ¿ï¼‰**

| åºå· | å†³ç­–é¡¹          | æœ€ç»ˆé€‰æ‹©                                        | å½±å“èŒƒå›´          | è¡Œä¸šå¯¹æ¯”                          |
| ---- | --------------- | ----------------------------------------------- | ----------------- | --------------------------------- |
| 1    | å“åº”å­—æ®µ        | ç»Ÿä¸€ `message`ï¼ˆç¦æ­¢ `msg`ï¼‰                    | å‰ç«¯/è°ƒç”¨æ–¹å…¼å®¹æ€§ | è…¾è®¯/é˜¿é‡Œ/ç¾å›¢ç»Ÿä¸€ä½¿ç”¨ message    |
| 2    | HTTPç­–ç•¥        | è¯­ä¹‰æ­£ç¡®çŠ¶æ€ç ï¼ˆ400/401/403/404/409/429/5xxï¼‰   | ç›‘æ§/ç½‘å…³/æ’éšœ    | å¤§å‚æ ‡å‡†ï¼ˆéå…¨éƒ¨200ï¼‰             |
| 3    | é”™è¯¯å‡ºå£        | ApiResponse ä½“ç³»ä¸ºå‡†ï¼ˆå…¶ä»–é€€åœºï¼‰                | ä»£ç ç»´æŠ¤æ€§        | å•ä¸€çœŸç›¸æºï¼ˆStripe/AWSæ¨¡å¼ï¼‰      |
| 4    | /health         | 200 degradedï¼ˆRedisæ–­å¼€ä»è¿”å›200ï¼‰              | ç›‘æ§å‘Šè­¦ç­–ç•¥      | Kubernetes liveness/readinessåˆ†å±‚ |
| 5    | dotenv          | overrideä»…developmentå…è®¸                       | ç”Ÿäº§äº‹æ•…é¢„é˜²      | Twelve-Factor Appæ ‡å‡†             |
| 6    | WebSocket       | å¼ºåˆ¶æ¡æ‰‹JWT + Originç™½åå• + ç¦æ­¢å®¢æˆ·ç«¯å†³å®šèº«ä»½ | å®‰å…¨ç­‰çº§          | é‡‘è/æ¸¸æˆçº§å®‰å…¨æ ‡å‡†               |
| 7    | market_listings | UNIQUE(seller_user_id, business_id)             | å¹‚ç­‰æ€§/æ•°æ®ä¸€è‡´æ€§ | ç¾å›¢/é˜¿é‡Œ/Stripe/æ¸¸æˆå…¬å¸å…±è¯†     |

---

## âœ… è¯¦ç»†æ‹æ¿æ–¹æ¡ˆï¼ˆä»¥å½“å‰ä»£ç ä¸ºå‡†çš„æœ€ç»ˆå†³ç­–ï¼‰

### A) WebSocket é‰´æƒï¼ˆSocket.IO + å°ç¨‹åº + ç®¡ç†åå° + ç°æœ‰ JWT ä½“ç³»ï¼‰â€” å·²ç¡®è®¤

**æ‹æ¿ç»“è®º**ï¼š

- **JWT æ”¾ç½®ä½ç½®**ï¼šSocket.IO å®¢æˆ·ç«¯å¿…é¡»åœ¨æ¡æ‰‹é˜¶æ®µé€šè¿‡ `auth.token` ä¼  JWTï¼ˆä¸èµ° headerï¼Œä¸åœ¨äº‹ä»¶é‡Œä¼  user_idï¼‰ã€‚
  - å®¢æˆ·ç«¯ç¤ºä¾‹ï¼š`io(url, { auth: { token: <JWT> } })`
  - æœåŠ¡ç«¯ç¤ºä¾‹ï¼š`io.use((socket, next) => { const token = socket.handshake.auth?.token; jwt.verify(...); socket.user = {...}; next(); })`
- **å¼ºåˆ¶é‰´æƒ**ï¼šä¸è®¾è¿ç§»æœŸï¼Œæœªæºå¸¦/æ— æ•ˆ token ç›´æ¥æ‹’ç»è¿æ¥ã€‚
- **Origin ç™½åå•**ï¼šåªå…è®¸â€œç®¡ç†åå°åŸŸå + H5 åŸŸåâ€ï¼›å¾®ä¿¡å°ç¨‹åºåœºæ™¯é€šå¸¸æ—  Originï¼Œèµ°ç‰¹æ®Šæ”¾è¡Œã€‚
- **èº«ä»½æ¥æºå”¯ä¸€**ï¼šä»»ä½•äº‹ä»¶ï¼ˆåŒ…æ‹¬ `register_user`ï¼‰éƒ½ä¸å…è®¸å†³å®š `user_type/admin`ï¼›èº«ä»½ä¸€å¾‹ä»¥ `socket.user` ä¸ºå‡†ã€‚
  - è‹¥ä¿ç•™ `register_user`ï¼šåªèƒ½ç”¨äºâ€œå®¢æˆ·ç«¯å£°æ˜è®¢é˜…/æˆ¿é—´/èƒ½åŠ›â€ï¼Œä¸å¾—å†™å…¥ connectedAdmins/connectedUsers çš„èº«ä»½æ˜ å°„ã€‚

### B) MarketListing.business_id çº¦æŸç»´åº¦ï¼ˆäº¤æ˜“å¸‚åœºå¹‚ç­‰ï¼‰â€” å·²ç¡®è®¤

**æ‹æ¿ç»“è®º**ï¼š

- **business_id å®šä¹‰ï¼ˆå¯¹å¤–/å¯¹å†…åˆ†å±‚ï¼‰**ï¼š
  - **å¯¹å¤–ï¼ˆå®¢æˆ·ç«¯ä¼ å…¥ï¼‰**ï¼š`business_id`/`Idempotency-Key` æ˜¯â€œå®¢æˆ·ç«¯å¯¹ã€å–å®¶å‘èµ·ã€‘æœ¬æ¬¡åˆ›å»ºæŒ‚ç‰Œå†™è¯·æ±‚â€çš„å¹‚ç­‰é”®ï¼ˆæŒ‰å–å®¶éš”ç¦»çš„å¹‚ç­‰å‘½åç©ºé—´ï¼‰ã€‚
  - **å¯¹å†…ï¼ˆèµ„äº§æµæ°´/å†»ç»“/è§£å†»/ç»“ç®—ä½¿ç”¨ï¼‰**ï¼šä¸å¾—ç›´æ¥å¤ç”¨å®¢æˆ·ç«¯ `business_id` ä½œä¸ºèµ„äº§æµæ°´çš„ business_idï¼›å¿…é¡»ç”±æœåŠ¡ç«¯æ´¾ç”Ÿ**å…¨å±€ä¸ç¢°æ’**çš„å†…éƒ¨å¹‚ç­‰é”®ï¼ˆè§ä¸‹æ–¹â€œå†…éƒ¨æ´¾ç”Ÿè§„åˆ™â€ï¼‰ï¼Œç”¨äºå†™å…¥ `asset_transactions` ä»¥åŠè°ƒç”¨ `AssetService.*`ã€‚
- **åˆ›å»ºæŒ‚ç‰Œæ¥å£**ï¼šå¼€å§‹å¼ºåˆ¶è¦æ±‚ business_idï¼ˆæ–°è¯·æ±‚å¿…å¡«ï¼Œä¸å…¼å®¹æ—§æ•°æ®ï¼‰ã€‚
- **å†å²æ•°æ®ç­–ç•¥**ï¼šå…è®¸å†å²è®°å½• `business_id` ä¸ºç©ºï¼ˆNULLï¼‰ï¼Œä¸å¼ºè¡Œç«‹å³å›å¡«ï¼›ä½†å…è®¸åç»­æŒ‰éœ€è¡¥é½/æ”¹å†™ä»¥ä¾¿æ”¶ç´§çº¦æŸã€‚
- **æ•°æ®åº“çº¦æŸ**ï¼š
  - `market_listings.business_id`ï¼šå†å²å…¼å®¹å…è®¸ **NULL**ï¼ˆä»…ç”¨äºå†å²/å…¼å®¹ï¼‰ã€‚
  - å”¯ä¸€ç´¢å¼•ï¼š**UNIQUE(seller_user_id, business_id)**ï¼ˆå–å®¶éš”ç¦»çš„å¹‚ç­‰å‘½åç©ºé—´ï¼›é¿å…ä¸åŒå–å®¶â€œç¢°å·§åŒ keyâ€äº’ç›¸å½±å“ï¼‰ã€‚
- **åº”ç”¨å±‚è¡Œä¸º**ï¼š
  - å¹‚ç­‰é‡è¯•ï¼ˆå‚æ•°ä¸€è‡´ï¼‰â†’ è¿”å›åŒç»“æœ
  - å‚æ•°ä¸ä¸€è‡´ â†’ è¿”å› **409ï¼ˆIDEMPOTENCY_KEY_CONFLICTï¼‰**

**é‡è¦çº¦æŸï¼ˆé¿å…â€œåº•å±‚å…ˆæ’åº“â€å¯¼è‡´ä¸šåŠ¡ä¸å¯é¢„æœŸï¼‰â€” å·²æ‹æ¿ä¸ºå¿…é¡»æ‰§è¡Œ**ï¼š

- èµ„äº§æµæ°´å±‚å­˜åœ¨ `AssetTransaction(business_id, business_type)` å”¯ä¸€çº¦æŸã€‚ä¸ºé¿å…è·¨å–å®¶/è·¨ç”¨æˆ·â€œç¢°å·§åŒ keyâ€å¯¼è‡´å†»ç»“/è§£å†»/ç»“ç®—å…ˆå¤±è´¥ï¼Œå¿…é¡»æ‰§è¡Œâ€œå¯¹å†…æ´¾ç”Ÿ business_idâ€ï¼š
  - **å†…éƒ¨æ´¾ç”Ÿè§„åˆ™ï¼ˆç¤ºä¾‹ï¼‰**ï¼š`internal_business_id = "{business_type}:{actor_user_id}:{client_idempotency_key}"`
  - **å«ä¹‰**ï¼šåŒä¸€ä¸ªå®¢æˆ·ç«¯å¹‚ç­‰é”®åœ¨ä¸åŒç”¨æˆ·ä¸‹ä¼šå˜æˆä¸åŒçš„å†…éƒ¨ business_idï¼Œä»æºå¤´æ¶ˆç­è·¨ç”¨æˆ·ç¢°æ’ï¼›åŒæ—¶ä¿ç•™å¹‚ç­‰å›æ”¾èƒ½åŠ›ã€‚

**business_id ç”Ÿæˆè§„åˆ™ï¼ˆå®¢æˆ·ç«¯å¯¹å¤– keyï¼šå¿…é¡»åŒ…å«èº«ä»½ + ç›®æ ‡ + éšæœº/æ—¶é—´ç‰‡ï¼‰**ï¼š

- ç‰©å“æŒ‚ç‰Œï¼š`list_item_{seller_user_id}_{item_instance_id}_{ts}_{rand}`
- èµ„äº§æŒ‚ç‰Œï¼š`list_asset_{seller_user_id}_{offer_asset_code}_{ts}_{rand}`
- è´­ä¹°æŒ‚ç‰Œï¼š`buy_listing_{buyer_user_id}_{listing_id}_{ts}_{rand}`

**éªŒæ”¶æ ‡å‡†ï¼ˆè¡¥å……ï¼šç¡®ä¿â€œä¸ä¼šå…ˆæ’ asset_transactionsâ€ï¼‰**ï¼š

- åŒä¸€å–å®¶åŒä¸€ `business_id`ï¼š
  - å‚æ•°ä¸€è‡´ â†’ å¹‚ç­‰å›æ”¾åŒä¸€ `listing_id`
  - å‚æ•°ä¸ä¸€è‡´ â†’ 409ï¼ˆIDEMPOTENCY_KEY_CONFLICTï¼‰
- ä¸åŒå–å®¶â€œç¢°å·§åŒä¸€ä¸ªå®¢æˆ·ç«¯ business_idâ€ï¼š
  - å…è®¸å„è‡ªåˆ›å»ºæŒ‚ç‰Œï¼ˆä¸äº’ç›¸å½±å“ï¼‰
  - å†»ç»“/è§£å†»/ç»“ç®—ä¸ä¼šå› ä¸º `asset_transactions` çš„å”¯ä¸€çº¦æŸè€Œå¤±è´¥ï¼ˆå› ä¸ºå†…éƒ¨ business_id å·²æŒ‰ç”¨æˆ·æ´¾ç”Ÿï¼‰

### C) HTTP çŠ¶æ€ç  vs ä¸šåŠ¡ç  â€” å·²ç¡®è®¤

- **ç­–ç•¥**ï¼šHTTP è¯­ä¹‰æ­£ç¡®ï¼ˆ400/401/403/404/409/429/5xxï¼‰+ Body å†…ä¿ç•™ä¸šåŠ¡ç ï¼ˆ`code`ï¼‰ã€‚

### D) å“åº”å­—æ®µ message vs msg â€” å·²ç¡®è®¤

- **ç­–ç•¥**ï¼šç»Ÿä¸€ä½¿ç”¨ `message`ï¼ˆ**ä¸åšå…¼å®¹æœŸ**ï¼Œä¸å†è¾“å‡º `msg`ï¼‰ã€‚
- **å½“å‰è½åœ°è¿›åº¦**ï¼šğŸ”´ æœªè½åœ°ï¼ˆå½“å‰ä»£ç ä»å­˜åœ¨ `app.js` 404 çš„ `msg`ã€`middleware/errorHandler.js` çš„ `msg`ã€ä»¥åŠ `utils/ApiResponse.js` çš„ `batch()` è¿”å› `msg`ï¼‰ã€‚

### D-2) é”™è¯¯å‡ºå£æ”¶æ•›ï¼ˆApiResponse å•ä¸€æƒå¨ï¼‰â€” âœ… **å·²æ‹æ¿ç¡®è®¤ï¼ˆ2025-12-18ï¼‰**

- **ç­–ç•¥**ï¼š404 ä¸å…¨å±€é”™è¯¯å“åº”**ç»Ÿä¸€æ”¶æ•›åˆ° `ApiResponse`**ï¼ˆ`utils/ApiResponse.js`ï¼‰ï¼Œä½œä¸ºé¡¹ç›®å”¯ä¸€å“åº”å‡ºå£æ ‡å‡†ã€‚
- **è½åœ°è¦æ±‚ï¼ˆå¿…é¡»åˆ é™¤å¹²å‡€ï¼‰**ï¼š
  - `middleware/errorHandler.js`ï¼šæ•´ä½“é€€åœºï¼ˆå«æ³¨é‡Š/å¯¼å‡º/å¼•ç”¨ï¼‰ï¼Œä¸å¾—å†è¾“å‡º `{code,msg,data}`ã€‚
  - `app.js`ï¼šå†…ç½® 404/å…¨å±€é”™è¯¯å“åº”é€»è¾‘é€€åœºï¼ˆå«æ³¨é‡Šï¼‰ï¼Œä¸å¾—å†è¾“å‡º `msg`ã€‚
  - æœ€ç»ˆä»…ä¿ç•™/å¯ç”¨ `ApiResponse.middleware()` æ³¨å…¥çš„ `res.apiSuccess/res.apiError/...` åŠå…¶é…å¥—çš„ç»Ÿä¸€é”™è¯¯å¤„ç†é“¾è·¯ã€‚

### E) dotenv override â€” å·²ç¡®è®¤

- **ç­–ç•¥**ï¼šåªå…è®¸ development overrideï¼›ç”Ÿäº§/é¢„å‘ä¸€å¾‹ä¸ overrideã€‚

### F) Redis å¥åº·æ£€æŸ¥ä¸é™çº§ç­–ç•¥ â€” å·²ç¡®è®¤

- **ç­–ç•¥**ï¼šRedis ä½œä¸ºçŸ­æœŸâ€œå¯é™çº§ä¾èµ–â€ï¼Œä½† `/health` å¿…é¡»çœŸå®åæ˜  Redis çŠ¶æ€ï¼ˆä¸èƒ½å†™æ­» connectedï¼‰ï¼Œå¹¶é‡‡ç”¨ **200(degraded)** å£å¾„è®©ç›‘æ§å¯è§ redis=disconnectedã€‚

### G) å¯åŠ¨é…ç½®æ ¡éªŒï¼ˆvalidateConfigï¼‰â€” å·²ç¡®è®¤

- **staging/production**ï¼šå¯ç”¨ `validateConfig()`ï¼Œç¼ºé…ç½®ç›´æ¥é€€å‡ºï¼ˆfail-fastï¼‰ã€‚
- **development**ï¼šä¸å¼ºåˆ¶é€€å‡ºï¼ˆwarnï¼‰ï¼Œæå‡å¼€å‘ä½“éªŒã€‚
- **Redis é…ç½®**ï¼šç”±äºé‡‡ç”¨ `/health` çš„ **200(degraded)** å£å¾„ï¼ŒRedis é…ç½®å¯æš‚æ—¶è§†ä¸ºéå¿…éœ€ï¼Œä½†å¿…é¡»åœ¨æ—¥å¿—/ç›‘æ§ä¸­æ ‡çº¢æç¤ºã€‚

### ğŸŸ¡ P1çº§åˆ« - åº”å°½å¿«ä¿®å¤ï¼ˆå½±å“æ€§èƒ½/è¿ç»´ï¼‰

| åºå· | é—®é¢˜                   | é£é™©ç­‰çº§ | éªŒè¯çŠ¶æ€    |
| ---- | ---------------------- | -------- | ----------- |
| 6    | HTTPçŠ¶æ€ç ä¸ä¸šåŠ¡ç æ··æ·† | P1       | ğŸ”´ å­˜åœ¨     |
| 7    | N+1æŸ¥è¯¢é—®é¢˜            | P1       | ğŸ”´ å­˜åœ¨     |
| 8    | Redis keysæ‰«æ         | P1       | ğŸ”´ å­˜åœ¨     |
| 9    | æ—¥å¿—ç³»ç»Ÿæ··ç”¨           | P1       | âš ï¸ éƒ¨åˆ†å­˜åœ¨ |

### âœ… å·²ä¿®å¤æˆ–æ­£å¸¸

| åºå· | é—®é¢˜             | éªŒè¯çŠ¶æ€                                                                                                         |
| ---- | ---------------- | ---------------------------------------------------------------------------------------------------------------- |
| 10   | APIå“åº”æ ¼å¼ç»Ÿä¸€  | ğŸ”´ æœªè½åœ°ï¼ˆå·²æ‹æ¿ï¼šç»Ÿä¸€ `message` + HTTPè¯­ä¹‰çŠ¶æ€ç  + ApiResponse å•ä¸€å‡ºå£ï¼›å½“å‰ä»£ç ä»æ··ç”¨ `msg` ä¸”å­˜åœ¨å¤šå¥—å‡ºå£ï¼‰ |
| 11   | æƒé™ç¼“å­˜å¤±æ•ˆæœºåˆ¶ | âœ… å·²å®ç°ï¼ˆä½†éœ€æŒç»­é˜²æ­¢ç»•è¿‡å”¯ä¸€å…¥å£ï¼‰                                                                            |

---

## ä¿®å¤å»ºè®®ä¼˜å…ˆçº§

### ç¬¬ä¸€é˜¶æ®µï¼šå¿«é€Ÿä¿®å¤ï¼ˆ1-2å¤©ï¼Œå®‰å…¨å…³é”®ï¼‰

```bash
# 1. ä¿®æ”¹dotenvé…ç½®ï¼ˆ10åˆ†é’Ÿï¼‰- P0
# app.js: require('dotenv').config({ override: true })
#      â†’ development: å…è®¸ overrideï¼ˆå¯é€‰ï¼‰
#      â†’ staging/production: ç¦æ­¢ overrideï¼ˆä¸å…è®¸è¦†ç›–è¿è¡Œæ—¶ç¯å¢ƒå˜é‡ï¼‰

# 2. ä¿®å¤Rediså¥åº·æ£€æŸ¥ï¼ˆ30åˆ†é’Ÿï¼‰- P0
# app.js: æ·»åŠ çœŸå®çš„ isRedisHealthy() è°ƒç”¨

# 3. æ·»åŠ å¹‚ç­‰é”®å”¯ä¸€çº¦æŸï¼ˆ1å°æ—¶ï¼‰- P0
# âœ… æ‹æ¿çº¦æŸï¼šUNIQUE(seller_user_id, business_id)ï¼›business_id å…è®¸ NULLï¼ˆä»…å†å²/å…¼å®¹ï¼‰ï¼Œæ–°å†™å…¥å¼ºåˆ¶å¿…å¡«
# âš ï¸ MySQL æ³¨æ„ï¼šUNIQUE ç´¢å¼•åœ¨ business_id ä¸º NULL æ—¶å…è®¸é‡å¤ï¼ˆæ»¡è¶³â€œå†å²å…¼å®¹å…è®¸ NULLâ€çš„å£å¾„ï¼‰
CREATE UNIQUE INDEX uk_market_listings_seller_business_id ON market_listings (seller_user_id, business_id);

# 4. WebSocket CORSé™åˆ¶ï¼ˆ10åˆ†é’Ÿï¼‰- P0
# ChatWebSocketService.js: origin: '*' â†’ ç™½åå•
```

### ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒä¿®å¤ï¼ˆ3-5å¤©ï¼‰

```bash
# 1. WebSocketèº«ä»½éªŒè¯ï¼ˆ1-2å¤©ï¼‰- P0
# - å®ç°æ¡æ‰‹é‰´æƒ
# - ä¿®æ”¹register_useré€»è¾‘
# - ä»JWTè¯»å–ç”¨æˆ·èº«ä»½

# 2. ä¿®æ­£HTTPçŠ¶æ€ç ï¼ˆ1å¤©ï¼‰- P1
# - ä¿®æ”¹ApiResponseçš„å¿«æ·æ–¹æ³•
# - å°†2001â†’400, 4001â†’401ç­‰

# 3. ä¿®å¤N+1æŸ¥è¯¢ï¼ˆ1å¤©ï¼‰- P1
# - BackpackServiceæ‰¹é‡æŸ¥è¯¢
```

### ç¬¬ä¸‰é˜¶æ®µï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆ2-3å¤©ï¼‰

```bash
# 1. Redis keysæ”¹ä¸ºscanï¼ˆ1å¤©ï¼‰- P1
# 2. ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿï¼ˆ1-2å¤©ï¼‰- P1
```

---

## éªŒè¯æ£€æŸ¥è¡¨

å®Œæˆä¿®å¤åä½¿ç”¨æ­¤æ¸…å•éªŒè¯ï¼š

```bash
# âœ… P0é—®é¢˜éªŒè¯
[ ] staging/production ä¸å†ä½¿ç”¨ dotenv overrideï¼ˆdevelopment å…è®¸å¯é€‰ï¼‰
[ ] Rediså¥åº·æ£€æŸ¥è¿”å›çœŸå®çŠ¶æ€ï¼ˆ/health ä»è¿”å›200ï¼Œä½† systems.redis=disconnected å¯è¢«ç›‘æ§æŠ“åˆ°ï¼‰
[ ] market_listings.business_id å…è®¸ NULLï¼ˆä»…å†å²/å…¼å®¹ï¼‰ï¼Œæ–°å†™å…¥å¿…å¡«ï¼›ä¸”å·²æ·»åŠ  UNIQUE(seller_user_id, business_id)
[ ] WebSocket CORSä½¿ç”¨ç™½åå•
[ ] WebSocketè¿æ¥éœ€è¦æœ‰æ•ˆJWT
[ ] æ— æ³•å†’å……ç®¡ç†å‘˜èº«ä»½

# âœ… P1é—®é¢˜éªŒè¯
[ ] ApiResponseä½¿ç”¨æ­£ç¡®çš„HTTPçŠ¶æ€ç 
[ ] èƒŒåŒ…æŸ¥è¯¢ä¸è¶…è¿‡3æ¬¡æ•°æ®åº“æŸ¥è¯¢
[ ] getStats()ä½¿ç”¨SCANè€ŒéKEYS
[ ] æ‰€æœ‰æ—¥å¿—åŒ…å«request_id
```

---

## é™„å½•ï¼šå¿«é€ŸéªŒè¯è„šæœ¬

```bash
#!/bin/bash
# éªŒè¯å…³é”®é—®é¢˜æ˜¯å¦å­˜åœ¨

echo "=== P0é—®é¢˜å¿«é€Ÿæ£€æŸ¥ ==="

# 1. æ£€æŸ¥dotenv override
echo "1. æ£€æŸ¥dotenv override:"
grep -n "config({ override: true" app.js && echo "âŒ ç”Ÿäº§/é¢„å‘é£é™©ï¼šä»ä½¿ç”¨override=true" || echo "âœ… æœªå¼ºåˆ¶override=true"

# 2. æ£€æŸ¥Rediså¥åº·æ£€æŸ¥
echo "2. æ£€æŸ¥Rediså¥åº·æ£€æŸ¥:"
grep -n "isRedisHealthy" app.js && echo "âœ… å·²æ¥å…¥çœŸå®Rediså¥åº·æ£€æŸ¥" || echo "âŒ ä»å¯èƒ½æ˜¯å ä½å®ç°ï¼ˆæœªå‘ç°isRedisHealthyï¼‰"

# 3. æ£€æŸ¥WebSocket CORS
echo "3. æ£€æŸ¥WebSocket CORS:"
grep "origin.*'\*'" services/ChatWebSocketService.js && echo "âŒ CORSå®Œå…¨å¼€æ”¾" || echo "âœ… CORSå—é™"

# 4. æ£€æŸ¥WebSocketèº«ä»½éªŒè¯
echo "4. æ£€æŸ¥WebSocketèº«ä»½éªŒè¯:"
grep -n "io\\.use\\|handshake\\.auth\\|socket\\.handshake\\.auth" services/ChatWebSocketService.js | grep -n "token\\|jwt\\.verify" && echo "âœ… æ¡æ‰‹é˜¶æ®µé‰´æƒè¿¹è±¡å­˜åœ¨" || echo "âŒ æœªå‘ç°æ¡æ‰‹auth.tokené‰´æƒ"

# 4.1 æ£€æŸ¥register_useræ˜¯å¦ä»å¯å†³å®šèº«ä»½ï¼ˆåº”ç¦æ­¢ï¼‰
echo "4.1 æ£€æŸ¥register_useræ˜¯å¦ä¿¡ä»»å®¢æˆ·ç«¯user_type:"
grep -n "register_user" -n services/ChatWebSocketService.js | head -5
grep -n "user_type" services/ChatWebSocketService.js && echo "âš ï¸ å‘ç°user_typeé€»è¾‘ï¼šéœ€ç¡®è®¤ä¸å†ç”¨äºèº«ä»½åˆ¤å®š" || echo "âœ… æœªä½¿ç”¨user_typeåˆ¤å®šèº«ä»½"

# 4.2 æ£€æŸ¥MarketListingå¹‚ç­‰å”¯ä¸€çº¦æŸå£å¾„ï¼ˆseller_user_id + business_idï¼‰
echo "4.2 æ£€æŸ¥MarketListingå¹‚ç­‰å”¯ä¸€çº¦æŸå£å¾„ï¼ˆseller_user_id + business_idï¼‰:"
grep -RIn "seller_user_id.*business_id|business_id.*seller_user_id" models/MarketListing.js migrations/ && echo "âœ… å‘ç°ç›¸å…³å®šä¹‰/è¿ç§»çº¿ç´¢" || echo "âš ï¸ æœªå‘ç°ï¼ˆå¯èƒ½å°šæœªè½åœ°åˆ°ä»£ç /è¿ç§»ï¼‰"

# 5. æ£€æŸ¥N+1æŸ¥è¯¢
echo "5. æ£€æŸ¥N+1æŸ¥è¯¢:"
grep -A 5 "map.*async.*account =>" services/BackpackService.js | grep "findOne" && echo "âŒ å­˜åœ¨N+1" || echo "âœ… æ‰¹é‡æŸ¥è¯¢"
```

---

**éªŒè¯è´Ÿè´£äºº**: AIç³»ç»Ÿåˆ†æ  
**éªŒè¯æ—¥æœŸ**: 2025å¹´12æœˆ17æ—¥  
**ä¸‹æ¬¡å¤æŸ¥**: ä¿®å¤åé‡æ–°éªŒè¯
