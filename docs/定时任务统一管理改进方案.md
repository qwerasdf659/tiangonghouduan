# 定时任务统一管理改进方案

**创建日期**：2026年1月30日  
**问题来源**：后端项目技术债务排查  
**当前状态**：待实施  
**最后更新**：2026年1月30日（基于代码实际扫描结果修订）

---

## 0. 项目技术架构概述

### 0.1 技术栈

| 层面 | 技术选型 |
|------|----------|
| 后端框架 | Node.js 20+ + Express |
| 数据库 | MySQL + Sequelize ORM（连接池 max=40, min=5）|
| 缓存/锁 | Redis（ioredis）+ 分布式锁（SET NX 模式）|
| 定时调度 | node-cron（cron 表达式调度）|
| 日志系统 | Winston（分级日志：error/warn/info/debug/trace）|
| 实时通信 | Socket.io |
| 认证 | JWT + RBAC 角色系统 |
| 服务管理 | ServiceManager（统一服务依赖注入）|

### 0.2 业务模式

- **核心业务**：餐厅积分抽奖系统
- **用户积分**：消费获得积分 → 抽奖/兑换/交易
- **C2C市场**：材料交易（挂牌→购买→交割）
- **商家体系**：门店管理、员工权限、审批流程
- **高级空间**：100积分解锁24小时特权

### 0.3 现有定时任务架构模式

项目已有成熟的定时任务架构，迁移方案需遵循以下模式：

#### 目录结构

```
scripts/maintenance/scheduled_tasks.js   # 定时任务调度中心（node-cron）
jobs/                                    # 独立任务处理器目录
├── hourly-*.js                          # 小时级任务处理器
├── daily-*.js                           # 日级任务处理器
└── ...
```

#### 任务注册模式

```javascript
// 1. 导入任务处理器（jobs/ 目录）
const HourlyCleanupUnboundImages = require('../../jobs/hourly-cleanup-unbound-images')

// 2. 在 ScheduledTasks 类中定义调度方法
static scheduleHourlyCleanupUnboundImages() {
  cron.schedule('30 * * * *', async () => {
    // 3. 使用 Redis 分布式锁（防止多实例重复执行）
    const lockKey = 'lock:cleanup_unbound_images'
    const { getRawClient } = require('../../utils/UnifiedRedisClient')
    const acquired = await redisClient.set(lockKey, lockValue, 'EX', 600, 'NX')
    
    if (!acquired) {
      logger.info('[定时任务] 其他实例正在执行，跳过')
      return
    }
    
    // 4. 执行任务逻辑
    await HourlyCleanupUnboundImages.run()
    
    // 5. 释放分布式锁
    await redisClient.del(lockKey)
  })
}

// 6. 在 initialize() 中注册
static initialize() {
  this.scheduleHourlyCleanupUnboundImages()
}
```

#### 服务依赖获取（ServiceManager）

```javascript
// 通过 ServiceManager 获取服务（snake_case key）
static async initializeServices() {
  const serviceManager = require('../../services/index')
  await serviceManager.initialize()
  
  this.ExchangeService = serviceManager.getService('exchange_market')
  this.AdminLotteryService = serviceManager.getService('admin_lottery')
  // ...
}
```

#### 日志规范（Winston）

```javascript
const logger = require('../../utils/logger')

// 任务开始
logger.info('[定时任务] 开始执行未绑定图片清理...')

// 调试信息
logger.debug('[定时任务] 限流记录清理完成')

// 错误处理
logger.error('[定时任务] 限流记录清理失败:', error.message)
```

### 0.4 任务类型分类

| 类型 | 特点 | 是否需要分布式锁 | 示例 |
|------|------|------------------|------|
| **数据库级任务** | 操作数据库，多实例需防重 | ✅ 需要 | 会话清理、图片清理 |
| **内存级任务** | 操作进程内存，各实例独立 | ❌ 不需要 | 限流记录清理、缓存清理 |
| **Redis级任务** | 操作共享 Redis，多实例需防重 | ✅ 需要 | 分布式锁监控 |

### 0.5 数据库连接方式

项目使用 Sequelize ORM 连接 MySQL，配置从 `.env` 环境变量读取：

```bash
# 数据库连接验证命令（无需 MySQL 客户端）
npm run db:check
node -e "require('./config/database').testConnection()"

# 查看 Redis 连接状态
node -e "require('./utils/UnifiedRedisClient').testConnection()"
```

---

## 1. 现状分析

### 1.1 已有的定时任务框架

项目已有完善的定时任务管理类：

**文件位置**：`scripts/maintenance/scheduled_tasks.js` (89KB)

**框架特点**：
- 使用 `node-cron` 进行调度
- `ScheduledTasks` 类统一管理
- 已注册 21 个定时任务
- 有完整的日志和错误处理
- 通过 ServiceManager 获取服务依赖

**已注册的任务列表**：

| 序号 | 任务名称 | 执行频率 | 添加时间 |
|------|----------|----------|----------|
| 1 | 超时订单告警 | 每小时 | 2025-10-10 |
| 2 | 数据一致性检查 | 每天凌晨3点 | 2025-10-10 |
| 3 | 抽奖管理设置过期清理 | 每小时 | 2025-11-08 |
| 4 | 抽奖管理缓存自动清理 | 每30秒 | 2025-11-08 |
| 5 | 数据库性能监控 | 每5分钟 | 2025-11-09 |
| 6 | 抽奖奖品每日中奖次数重置 | 每天凌晨0点 | 2025-12-11 |
| 7 | 抽奖活动状态同步 | 每小时 | 2025-12-11 |
| 8 | 交易市场锁超时解锁 | 每5分钟 | 2025-12-15 |
| 9 | 核销码过期清理 | 每天凌晨2点 | 2025-12-17 |
| 10 | 商家审核超时告警 | 每小时 | 2025-12-29 |
| 11 | 交易市场超时解锁 | 每小时 | 2025-12-29 |
| 12 | 业务记录关联对账 | 每小时第5分钟 | 2026-01-05 |
| 13 | 未绑定图片清理 | 每小时第30分钟 | 2026-01-08 |
| 14 | 可叠加资产挂牌过期 | 每小时第15分钟 | 2026-01-08 |
| 15 | 市场挂牌异常监控 | 每小时第45分钟 | 2026-01-08 |
| 16 | 孤儿冻结检测与清理 | 每天凌晨2点 | 2026-01-09 |
| 17 | 商家审计日志180天清理 | 每天凌晨3点 | 2026-01-12 |
| 18 | 图片资源数据质量检查 | 每天凌晨4点 | 2026-01-14 |
| 19 | 定价配置定时生效 | 每小时 | 2026-01-19 |
| 20 | 抽奖策略引擎监控-小时级 | 每小时 | 2026-01-23 |
| 21 | 抽奖策略引擎监控-日报级 | 每天 | 2026-01-23 |

### 1.2 分散的 setInterval 调用（代码实际扫描结果）

通过 `grep -r "setInterval" --include="*.js"` 扫描，共发现 **18个文件** 使用 setInterval：

#### ✅ 需要迁移的（7处，在主服务进程内）

| 文件 | 数量 | 用途 | 频率 | 迁移建议 |
|------|------|------|------|----------|
| `services/ChatRateLimitService.js` | 3 | 限流时间戳清理 | 每1分钟 | 合并为1个cron任务 |
| `models/AuthenticationSession.js` | 1 | 过期会话清理 | 每30分钟 | 迁移到ScheduledTasks |
| `services/UnifiedLotteryEngine/utils/CacheManager.js` | 1 | 抽奖引擎缓存清理 | 每10分钟 | 迁移到ScheduledTasks |
| `services/UnifiedLotteryEngine/strategies/ManagementStrategy.js` | 1 | 策略缓存清理 | 动态 | 合并到CacheManager任务 |
| `utils/BusinessCacheHelper.js` | 1 | 缓存命中率监控 | 每5分钟 | 迁移到ScheduledTasks |

#### ⚠️ 不需要迁移的

| 文件 | 原因 |
|------|------|
| `utils/UnifiedDistributedLock.js` | **动态定时器**：每次获取锁时按需创建续期定时器，释放锁时自动清除（`clearInterval`）。这是正确的设计模式，不是周期性任务，**不应迁移**。 |
| `app.js` | 连接池健康检查，与服务启动强绑定，不宜分离 |
| `scripts/monitoring/pool_monitor.js` | 独立监控脚本，通过 `npm run monitor:pool` 单独运行 |
| `scripts/monitoring/lightweight_monitor.js` | 独立监控脚本，通过 `npm run monitor:system` 单独运行 |
| `tests/chaos/memory_leak_detection.test.js` | 测试代码 |
| `tests/helpers/test-setup.js` | 测试辅助代码 |

#### 前端页面（无需迁移）

| 文件 | 数量 | 用途 |
|------|------|------|
| `admin/src/alpine/components/sidebar-nav.js` | 1 | 告警数量刷新 |
| `admin/src/modules/analytics/pages/dashboard.js` | 1 | 仪表板刷新 |
| `admin/src/modules/system/pages/risk-alerts.js` | 2 | 告警列表刷新 |
| `admin/src/modules/content/pages/customer-service.js` | 2 | 客服消息轮询 |
| `admin/src/main.js` | 1 | 页面定时刷新 |

**说明**：前端页面的 `setInterval` 是浏览器端用户界面自动刷新，属于正常用法，无需迁移。

### 1.3 原文档错误更正

| 原文档内容 | 实际情况 |
|------------|----------|
| `UnifiedDistributedLock.js` 锁续期需迁移（P0高优先级） | ❌ 这是**动态定时器**（每次获取锁创建，释放锁清除），不是周期性任务，**不应迁移** |
| `services/UnifiedLotteryEngine/utils/PerformanceMonitor.js` 有 setInterval | ❌ 只有示例注释（`@example`），无实际 setInterval 调用 |
| `scripts/maintenance/database_performance_monitor.js` 有 setInterval | ❌ 实际未发现 setInterval，监控已集成到 ScheduledTasks |
| 文档列出15处 setInterval | 实际后端需迁移的只有5-6处（合并后4个任务） |

---

## 2. 问题影响

### 2.1 当前问题

1. **难以全局查看**：不知道系统里有多少定时任务在运行
2. **启停不可控**：服务重启时，分散任务的状态不确定
3. **资源监控困难**：无法统计定时任务的资源消耗
4. **调试困难**：出问题时不知道是哪个定时任务导致的
5. **可能重复执行**：某些清理任务可能与 ScheduledTasks 中的任务重复

### 2.2 风险评估（修订版）

| 风险点 | 严重程度 | 说明 |
|--------|----------|------|
| 限流记录堆积 | **中** | 可能导致内存泄漏（ChatRateLimitService 3个定时器） |
| 认证会话堆积 | 中 | 过期会话残留，占用数据库空间 |
| 抽奖缓存未清理 | 低 | 可能占用过多内存 |
| ~~分布式锁续期失败~~ | ~~高~~ | ❌ **已排除**：动态定时器设计正确，无需迁移 |

---

## 3. 解决方案

### 3.1 方案：扩展现有 ScheduledTasks（推荐）

将分散的 `setInterval` 迁移到现有的 `ScheduledTasks` 类中，完全遵循项目已有的架构模式。

**优点**：
- 复用现有框架，改动最小
- 统一日志和错误处理（Winston）
- 便于监控和管理
- 自动支持多实例部署（分布式锁）

**新增任务列表**：

| 任务编号 | 任务名称 | 频率 | 原位置 | 任务类型 | 分布式锁 |
|----------|----------|------|--------|----------|----------|
| 25 | 限流记录清理 | 每分钟 | `ChatRateLimitService.js` | 内存级 | ❌ 不需要 |
| 26 | 认证会话清理 | 每30分钟 | `AuthenticationSession.js` | 数据库级 | ✅ 需要 |
| 27 | 抽奖引擎缓存清理 | 每10分钟 | `CacheManager.js` | 内存级 | ❌ 不需要 |
| 28 | 业务缓存监控 | 每5分钟 | `BusinessCacheHelper.js` | 内存级 | ❌ 不需要 |

**说明**：任务编号从 25 开始，因为现有 ScheduledTasks 已注册到任务 24（日报级抽奖指标聚合）。

---

## 4. 迁移计划（修订版 - 遵循项目架构）

### 4.1 阶段划分

| 阶段 | 任务 | 工作量 | 优先级 | 任务类型 |
|------|------|--------|--------|----------|
| Phase 1 | 迁移 `ChatRateLimitService.js` 的3个任务 → 任务25 | 0.5天 | **P1** | 内存级 |
| Phase 2 | 迁移 `AuthenticationSession.js` 会话清理 → 任务26 | 0.5天 | P1 | 数据库级 |
| Phase 3 | 迁移 `CacheManager.js` + `ManagementStrategy.js` → 任务27 | 0.5天 | P2 | 内存级 |
| Phase 4 | 迁移 `BusinessCacheHelper.js` 监控任务 → 任务28 | 0.5天 | P2 | 内存级 |
| Phase 5 | 清理原文件中的 setInterval 代码并测试 | 0.5天 | P2 | - |

**总工作量**：约 2.5 天

### 4.2 迁移优先级（修订版）

| 优先级 | 任务编号 | 原文件 | 原因 | 分布式锁 |
|--------|----------|--------|------|----------|
| **P1** | 任务25 | `ChatRateLimitService.js` | 3个定时器需合并，影响内存 | ❌ 不需要 |
| **P1** | 任务26 | `AuthenticationSession.js` | 影响数据库空间 | ✅ 需要 |
| P2 | 任务27 | `CacheManager.js` | 影响抽奖系统性能 | ❌ 不需要 |
| P2 | 任务28 | `BusinessCacheHelper.js` | 影响较小 | ❌ 不需要 |
| ~~P0~~ | - | ~~`UnifiedDistributedLock.js`~~ | ❌ **已排除**：动态定时器，无需迁移 | - |

### 4.3 迁移步骤模板（遵循项目架构）

#### 模板A：内存级任务迁移（无需分布式锁）

以 `ChatRateLimitService.js` 为例（内存级任务，各实例独立清理）：

**Step 1**：在 `ChatRateLimitService` 中新增合并清理方法

```javascript
/**
 * 合并清理所有过期记录（供定时任务调用）
 * 
 * 说明：此方法由 ScheduledTasks 统一调度，替代原有的3个 setInterval
 * 
 * @static
 * @since 2026-01-30
 */
static cleanupAllExpiredRecords() {
  const now = Date.now()
  let cleanedCount = 0
  
  // 清理用户消息时间戳
  this.userMessageTimestamps.forEach((timestamps, userId) => {
    const recent = timestamps.filter(ts => now - ts < this.CLEANUP_THRESHOLD)
    if (recent.length === 0) {
      this.userMessageTimestamps.delete(userId)
      cleanedCount++
    } else {
      this.userMessageTimestamps.set(userId, recent)
    }
  })

  // 清理管理员消息时间戳
  this.adminMessageTimestamps.forEach((timestamps, adminId) => {
    const recent = timestamps.filter(ts => now - ts < this.CLEANUP_THRESHOLD)
    if (recent.length === 0) {
      this.adminMessageTimestamps.delete(adminId)
      cleanedCount++
    } else {
      this.adminMessageTimestamps.set(adminId, recent)
    }
  })

  // 清理创建会话时间戳
  this.createSessionTimestamps.forEach((timestamps, userId) => {
    const recent = timestamps.filter(ts => now - ts < this.CLEANUP_THRESHOLD)
    if (recent.length === 0) {
      this.createSessionTimestamps.delete(userId)
      cleanedCount++
    } else {
      this.createSessionTimestamps.set(userId, recent)
    }
  })

  return cleanedCount
}
```

**Step 2**：在 `ScheduledTasks` 中添加新任务（遵循项目命名规范）

```javascript
/**
 * 任务25: 限流记录清理（每分钟）
 * 
 * 类型：内存级任务（无需分布式锁，各实例独立清理自己的内存）
 * 原位置: services/ChatRateLimitService.js 的 initCleanup() 方法
 * 
 * @since 2026-01-30
 */
static scheduleMinutelyRateLimitCleanup() {
  cron.schedule('* * * * *', async () => {
    try {
      const ChatRateLimitService = require('../../services/ChatRateLimitService')
      const cleanedCount = ChatRateLimitService.cleanupAllExpiredRecords()
      
      // 仅在有清理时记录日志（避免日志膨胀）
      if (cleanedCount > 0) {
        logger.debug('[定时任务] 限流记录清理完成', { cleaned_count: cleanedCount })
      }
    } catch (error) {
      logger.error('[定时任务] 限流记录清理失败:', { error: error.message })
    }
  })
  logger.info('[定时任务] 限流记录清理任务已注册（每分钟）')
}
```

**Step 3**：修改 `ScheduledTasks.initialize()` 调用新任务

```javascript
static initialize() {
  // ... 现有24个任务 ...
  
  // 任务25: 限流记录清理（2026-01-30迁移 - 内存级，无需分布式锁）
  this.scheduleMinutelyRateLimitCleanup()
}
```

**Step 4**：删除 `ChatRateLimitService.js` 中的自动初始化代码

```javascript
// 删除文件末尾的这一行
// ChatRateLimitService.initCleanup()

// 删除 initCleanup() 方法中的3个 setInterval
```

**Step 5**：测试验证
- 验证清理任务正常执行
- 验证限流功能不受影响
- 检查日志输出：`grep "限流记录清理" logs/*.log`

---

#### 模板B：数据库级任务迁移（需要分布式锁）

以 `AuthenticationSession.js` 为例（数据库级任务，需防止多实例重复执行）：

**Step 1**：在 `ScheduledTasks` 中添加新任务（使用分布式锁）

```javascript
/**
 * 任务26: 认证会话清理（每30分钟）
 * 
 * 类型：数据库级任务（需要分布式锁，防止多实例重复执行）
 * 原位置: models/AuthenticationSession.js 的 scheduleCleanup() 方法
 * 
 * @since 2026-01-30
 */
static scheduleHalfHourlyAuthSessionCleanup() {
  cron.schedule('0,30 * * * *', async () => {
    const lockKey = 'lock:auth_session_cleanup'
    const lockValue = `${process.pid}_${Date.now()}`
    let redisClient = null

    try {
      // 获取 Redis 客户端（遵循项目现有模式）
      const { getRawClient } = require('../../utils/UnifiedRedisClient')
      redisClient = getRawClient()

      // 尝试获取分布式锁（5分钟过期）
      const acquired = await redisClient.set(lockKey, lockValue, 'EX', 300, 'NX')

      if (!acquired) {
        logger.info('[定时任务] 其他实例正在执行认证会话清理，跳过')
        return
      }

      logger.info('[定时任务] 获取分布式锁成功，开始执行认证会话清理...')

      // 执行清理逻辑
      const { AuthenticationSession } = require('../../models')
      const result = await AuthenticationSession.cleanupExpiredSessions()

      logger.info('[定时任务] 认证会话清理完成', { deleted_count: result })

    } catch (error) {
      logger.error('[定时任务] 认证会话清理失败:', { error: error.message })
    } finally {
      // 释放分布式锁（验证锁归属后删除）
      if (redisClient) {
        try {
          const currentValue = await redisClient.get(lockKey)
          if (currentValue === lockValue) {
            await redisClient.del(lockKey)
          }
        } catch (unlockError) {
          logger.warn('[定时任务] 释放分布式锁失败:', { error: unlockError.message })
        }
      }
    }
  })
  logger.info('[定时任务] 认证会话清理任务已注册（每30分钟）')
}
```

**Step 2**：删除 `AuthenticationSession.js` 中的 `scheduleCleanup()` 方法

```javascript
// 删除以下代码块
// AuthenticationSession.scheduleCleanup = function () {
//   const interval = 30 * 60 * 1000
//   setInterval(async () => {
//     ...
//   }, interval)
// }
```

---

#### 模板C：抽奖引擎缓存清理迁移

以 `CacheManager.js` 为例（内存级任务，通过 ServiceManager 获取实例）：

**Step 1**：在 `ScheduledTasks` 中添加新任务

```javascript
/**
 * 任务27: 抽奖引擎缓存清理（每10分钟）
 * 
 * 类型：内存级任务（无需分布式锁）
 * 原位置: services/UnifiedLotteryEngine/utils/CacheManager.js 构造函数
 * 
 * @since 2026-01-30
 */
static scheduleTenMinutelyLotteryEngineCacheCleanup() {
  cron.schedule('*/10 * * * *', async () => {
    try {
      const CacheManager = require('../../services/UnifiedLotteryEngine/utils/CacheManager')
      const instance = CacheManager.getInstance()
      
      if (instance && typeof instance.cleanup === 'function') {
        instance.cleanup()
        logger.debug('[定时任务] 抽奖引擎缓存清理完成')
      }
    } catch (error) {
      logger.error('[定时任务] 抽奖引擎缓存清理失败:', { error: error.message })
    }
  })
  logger.info('[定时任务] 抽奖引擎缓存清理任务已注册（每10分钟）')
}
```

**Step 2**：修改 `CacheManager.js` 构造函数，移除 setInterval

```javascript
// 删除构造函数中的以下代码
// if (process.env.NODE_ENV !== 'test' && typeof jest === 'undefined') {
//   this.cleanupInterval = setInterval(() => this.cleanup(), 10 * 60 * 1000)
// }
```

---

## 5. 验收标准（遵循项目规范）

### 5.1 功能验收

- [ ] `ChatRateLimitService.js` 中的 `initCleanup()` 方法和3个 setInterval 已删除
- [ ] `ChatRateLimitService.js` 末尾的 `ChatRateLimitService.initCleanup()` 自动调用已删除
- [ ] `AuthenticationSession.js` 中的 `scheduleCleanup()` 方法已删除
- [ ] `CacheManager.js` 构造函数中的 `this.cleanupInterval = setInterval(...)` 已删除
- [ ] `ManagementStrategy.js` 中的 `startCacheCleanup()` 方法已删除
- [ ] `BusinessCacheHelper.js` 中的监控 setInterval 已删除
- [ ] 所有任务迁移到 `ScheduledTasks` 并在 `initialize()` 中注册
- [ ] 任务执行有 Winston 日志记录（使用 `logger.info/debug/error`）

### 5.2 代码验收

```bash
# 验证后端服务层只剩下动态定时器和健康检查
grep -r "setInterval" services/ models/ utils/ --include="*.js" | grep -v node_modules

# 预期结果（只有以下2处）：
# utils/UnifiedDistributedLock.js:273:  extendTimer = setInterval(...)  # 动态定时器，保留
# app.js:1034:  setInterval(...)  # 连接池健康检查，保留

# 验证新任务已注册
grep -E "scheduleMinutely|scheduleHalfHourly|scheduleTenMinutely" scripts/maintenance/scheduled_tasks.js

# 预期结果：
# static scheduleMinutelyRateLimitCleanup()
# static scheduleHalfHourlyAuthSessionCleanup()
# static scheduleTenMinutelyLotteryEngineCacheCleanup()
# static scheduleFiveMinutelyBusinessCacheMonitor()
```

### 5.3 日志验收

```bash
# 查看定时任务注册日志（服务启动时）
grep "任务已注册" logs/*.log | tail -10

# 预期输出：
# [定时任务] 限流记录清理任务已注册（每分钟）
# [定时任务] 认证会话清理任务已注册（每30分钟）
# [定时任务] 抽奖引擎缓存清理任务已注册（每10分钟）
# [定时任务] 业务缓存监控任务已注册（每5分钟）

# 查看任务执行日志
grep -E "限流记录清理|认证会话清理|抽奖引擎缓存清理|业务缓存监控" logs/*.log | tail -20
```

### 5.4 分布式锁验收（仅数据库级任务）

```bash
# 验证分布式锁正常工作（任务26：认证会话清理）
# 启动两个实例，观察日志，只有一个实例执行任务

# 实例1日志预期：
# [定时任务] 获取分布式锁成功，开始执行认证会话清理...
# [定时任务] 认证会话清理完成

# 实例2日志预期：
# [定时任务] 其他实例正在执行认证会话清理，跳过
```

### 5.5 性能验收

- [ ] 服务内存使用稳定，无定时器泄漏
- [ ] Redis 连接正常，分布式锁获取/释放正常
- [ ] 日志文件大小合理（debug 日志有条件输出）

---

## 6. 附录

### 6.1 node-cron 时间表达式

```
 ┌────────────── 秒 (可选，0-59)
 │ ┌──────────── 分钟 (0-59)
 │ │ ┌────────── 小时 (0-23)
 │ │ │ ┌──────── 日期 (1-31)
 │ │ │ │ ┌────── 月份 (1-12)
 │ │ │ │ │ ┌──── 星期 (0-7，0和7都是周日)
 │ │ │ │ │ │
 * * * * * *
```

**本次迁移使用的表达式**：
| 任务 | 表达式 | 说明 |
|------|--------|------|
| 任务25：限流记录清理 | `* * * * *` | 每分钟 |
| 任务26：认证会话清理 | `0,30 * * * *` | 每30分钟（整点和半点）|
| 任务27：抽奖缓存清理 | `*/10 * * * *` | 每10分钟 |
| 任务28：业务缓存监控 | `*/5 * * * *` | 每5分钟 |

### 6.2 项目架构对齐清单

```
# 定时任务架构
scripts/maintenance/scheduled_tasks.js    # 定时任务调度中心（已有24个任务）
jobs/                                     # 独立任务处理器目录（11个处理器）
├── hourly-*.js                           # 小时级任务
└── daily-*.js                            # 日级任务

# 服务层架构
services/index.js                         # ServiceManager（服务注册中心）
services/ChatRateLimitService.js          # 待迁移：限流服务
services/UnifiedLotteryEngine/            # 待迁移：抽奖引擎

# 工具层架构
utils/logger.js                           # Winston 日志系统
utils/UnifiedRedisClient.js               # Redis 客户端（分布式锁）
utils/BusinessCacheHelper.js              # 待迁移：业务缓存

# 模型层
models/AuthenticationSession.js           # 待迁移：认证会话
```

### 6.3 迁移文件清单

| 文件 | 迁移内容 | 目标任务 | 分布式锁 |
|------|----------|----------|----------|
| `services/ChatRateLimitService.js` | 删除 `initCleanup()` 和末尾调用 | 任务25 | ❌ |
| `models/AuthenticationSession.js` | 删除 `scheduleCleanup()` 方法 | 任务26 | ✅ |
| `services/UnifiedLotteryEngine/utils/CacheManager.js` | 删除构造函数中的 setInterval | 任务27 | ❌ |
| `services/UnifiedLotteryEngine/strategies/ManagementStrategy.js` | 删除 `startCacheCleanup()` | 合并到任务27 | ❌ |
| `utils/BusinessCacheHelper.js` | 删除监控 setInterval | 任务28 | ❌ |

### 6.4 不迁移文件说明

| 文件 | 原因 | 保留理由 |
|------|------|----------|
| `utils/UnifiedDistributedLock.js` | 动态定时器 | 每次获取锁时创建续期定时器，释放锁时清除。这是正确的锁续期设计，不是周期性任务。 |
| `app.js` | 健康检查 | 连接池监控与服务启动强绑定，用于 `/health` 端点响应。 |
| `scripts/monitoring/pool_monitor.js` | 独立脚本 | 通过 `npm run monitor:pool` 独立运行，不在主服务进程中。 |
| `scripts/monitoring/lightweight_monitor.js` | 独立脚本 | 通过 `npm run monitor:system` 独立运行，不在主服务进程中。 |

### 6.5 验证命令集

```bash
# ========== 数据库验证 ==========
npm run db:check
node -e "require('./config/database').testConnection()"

# ========== Redis 验证 ==========
node -e "require('./utils/UnifiedRedisClient').testConnection()"

# ========== 定时任务日志 ==========
# 查看任务注册日志
grep "任务已注册" logs/*.log | tail -10

# 查看任务执行日志
grep "定时任务" logs/*.log | tail -50

# 查看分布式锁日志
grep "分布式锁" logs/*.log | tail -20

# ========== setInterval 残留检查 ==========
# 后端服务层（预期只有2处：动态锁续期 + 健康检查）
grep -r "setInterval" services/ models/ utils/ --include="*.js" | grep -v node_modules | wc -l
# 预期结果：2

# 详细查看
grep -r "setInterval" services/ models/ utils/ --include="*.js" | grep -v node_modules
```

### 6.6 回滚方案

如果迁移后出现问题，可按以下步骤回滚：

1. **恢复原文件**：从 Git 恢复 `ChatRateLimitService.js`、`AuthenticationSession.js` 等文件
2. **删除新任务**：注释掉 `ScheduledTasks.initialize()` 中新增的任务调用
3. **重启服务**：`npm run pm:restart`
4. **验证回滚**：检查原有 setInterval 是否恢复工作

```bash
# 快速回滚命令
git checkout services/ChatRateLimitService.js
git checkout models/AuthenticationSession.js
git checkout services/UnifiedLotteryEngine/utils/CacheManager.js
git checkout services/UnifiedLotteryEngine/strategies/ManagementStrategy.js
git checkout utils/BusinessCacheHelper.js
npm run pm:restart
```

---

**文档版本**：v3.0（遵循项目技术架构修订）  
**创建时间**：2026-01-30  
**修订时间**：2026-01-30  
**负责人**：待分配  
**预计完成**：2.5天工作量
