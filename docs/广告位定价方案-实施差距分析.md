# 广告位定价方案 — 实施差距分析

> 排查日期：2026-03-01
> 数据来源：项目代码 + 数据库真实数据（restaurant_points_dev）
> 对照文档：docs/首页广告位定价方案.md

---

## 一、项目实际状态快照

### 业务数据

| 指标 | 实际值 |
|------|--------|
| 用户数 | 68 |
| 合作门店 | 5 家 |
| 消费记录 | 48 条（33 pending / 15 approved） |
| 抽奖次数 | 3,330 次 |
| 物品产出 | 7,084 个 |
| 账本流水 | 17,876 条（item_ledger 双录记账） |
| 市场挂单 | 302 个 |
| 广告竞价日志 | 116 条 |
| 广告计费记录 | **0 条**（尚未产生广告收入） |
| 商业广告计划 | 2 个（均为 draft 状态） |

### 技术栈

| 层级 | 技术选型 |
|------|---------|
| 后端框架 | Express ^4.18.2 |
| ORM | Sequelize ^6.35.2 |
| 数据库驱动 | mysql2 ^3.6.5 |
| 数据库 | MySQL（Sealos 云托管） |
| 缓存 | Redis（ioredis ^5.7.0） |
| WebSocket | socket.io ^4.8.1 |
| 认证 | jsonwebtoken ^9.0.2（JWT + RBAC） |
| 文件存储 | aws-sdk ^2.1691.0（Sealos 对象存储） |
| 图片处理 | sharp ^0.34.5 |
| 日志 | winston ^3.11.0 |
| 定时任务 | node-cron ^3.0.3（30+ 任务） |
| 校验 | joi ^17.11.0 |
| 前端管理 | Alpine.js ^3.15.4 + Tailwind ^3.4.19 + Vite ^6.4.1（47 个管理页面） |

### 数据库资产类型（account_asset_balances 实际数据）

| asset_code | 记录数 | 含义 |
|------------|--------|------|
| POINTS | 14 | 可用积分（消费获得，用于抽奖） |
| BUDGET_POINTS | 6 | 预算积分（控制实物/券/水晶发放） |
| DIAMOND | 36 | 钻石（虚拟用途货币：虚拟奖品 + 广告投放） |
| red_shard | 13 | 红水晶碎片 |
| red_crystal | 7 | 红水晶 |
| orange_shard | 7 | 橙水晶碎片 |
| MATERIAL_001 | 3 | 物料资产 |

material_asset_types 表定义了 15 种资产（5 色水晶 × 碎片/水晶 + POINTS + BUDGET_POINTS + DIAMOND）。

---

## 二、已实现清单

### 2.1 货币体系

| 定价方案描述 | 实现状态 | 验证依据 |
|-------------|---------|---------|
| 积分(POINTS) → 抽奖 → 水晶类 + 钻石 双产出 | ✅ 已实现 | asset_code 中存在 POINTS、DIAMOND、red_shard 等 |
| 预算积分(BUDGET_POINTS) 控制实物/券/水晶发放 | ✅ 已实现 | BuildPrizePoolStage._filterByBudget 按 prize_value_points 过滤 |
| 钻石(DIAMOND) 用于虚拟奖品 + 广告投放 | ✅ 已实现 | DIAMOND 资产 36 条记录；AdBillingService 操作 DIAMOND |
| 汇率兑换（碎片 → 水晶等） | ✅ 已实现 | ExchangeRateService + ExchangeRate 模型 |
| 市场交易 + 手续费 | ✅ 已实现 | 302 个挂单 + FeeCalculator |

### 2.2 抽奖引擎

| 定价方案描述 | 实现状态 | 验证依据 |
|-------------|---------|---------|
| Budget Tier 分层（B0-B3） | ✅ 已实现 | BudgetTierCalculator，阈值 threshold_high=1000 / mid=500 / low=100 |
| reward_tier 分组（high/mid/low/fallback） | ✅ 已实现 | BuildPrizePoolStage._groupByTier |
| B0 只能抽 fallback，B3 可抽全部 | ✅ 已实现 | _filterByAllowedTiers 方法 |
| win_weight 加权随机选奖 | ✅ 已实现 | PrizePickStage |
| max_daily_wins 每日中奖上限 | ✅ 已实现 | _filterByAvailability 检查 |
| stock_quantity 库存控制 | ✅ 已实现 | _filterByAvailability 检查 |
| prize_value_points 预算成本 | ✅ 已实现 | 奖品表字段存在，_filterByBudget 使用 |
| 保底/pity 机制 | ✅ 已实现 | GuaranteeStage + PityCalculator |
| 防连空 / 防连高 | ✅ 已实现 | AntiEmptyStreakHandler / AntiHighStreakHandler |
| 统一管线（11 级 Stage） | ✅ 已实现 | NormalDrawPipeline |

抽奖引擎管线顺序：
```
LoadCampaign → Eligibility → LoadDecisionSource → BudgetContext → Pricing
→ BuildPrizePool → Guarantee → TierPick → PrizePick → DecisionSnapshot → Settle
```

### 2.3 三表账本

| 定价方案描述 | 实现状态 | 验证依据 |
|-------------|---------|---------|
| items（当前状态快照） | ✅ 已实现 | 7,084 条记录 |
| item_ledger（双录记账本） | ✅ 已实现 | 17,876 条记录，每次操作写两条（出方 -1 + 入方 +1） |
| item_holds（锁定控制） | ✅ 已实现 | 表已建立，支持 trade/redemption/security |

### 2.4 广告系统基础

| 定价方案描述 | 实现状态 | 验证依据 |
|-------------|---------|---------|
| 广告位（AdSlot）定义 | ✅ 已实现 | 7 个广告位（含 home_popup / home_carousel / home_announcement） |
| billing_mode: fixed_daily / bidding / free | ✅ 已实现 | AdCampaign 模型 VALID_BILLING_MODES |
| campaign_category: commercial / operational / system | ✅ 已实现 | AdCampaign 模型 |
| 三层优先级出队 system > operational > commercial | ✅ 已实现 | AdBiddingService.selectWinners |
| 广告素材审核 | ✅ 已实现 | AdCreative.review_status |
| 钻石冻结/扣款/退款 | ✅ 已实现 | AdBillingService 通过 BalanceService 操作 |
| 广告投放 API | ✅ 已实现 | /api/v4/system/ad-delivery |
| 管理端 UI | ✅ 已实现 | ad-management.html |

### 2.5 广告位实际数据（ad_slots 表）

| ad_slot_id | slot_key | 名称 | 类型 | 日价(钻石) | 竞价底价 | 最低预算 | 状态 |
|---|---|---|---|---|---|---|---|
| 11 | home_popup | 首页弹窗位 | popup | 100 | 50 | 500 | 启用 |
| 12 | home_carousel | 首页轮播位 | carousel | 60 | 50 | 500 | 启用 |
| 13 | home_announcement | 首页公告位 | announcement | 0 | 0 | 0 | 启用(免费) |
| 3 | lottery_popup | 抽奖页弹窗位 | popup | 80 | 50 | 500 | 启用 |
| 7 | lottery_popup_ad | 抽奖页弹窗 | popup | 200 | 50 | 300 | 启用 |
| 4 | profile_popup | 个人中心弹窗位 | popup | 50 | 50 | 500 | 启用 |
| 8 | profile_carousel | 个人中心轮播 | carousel | 100 | 20 | 200 | 未启用 |

### 2.6 消费/门店

| 定价方案描述 | 实现状态 | 验证依据 |
|-------------|---------|---------|
| 用户到店消费 → 提交消费记录 → 审核 | ✅ 已实现 | 48 条消费记录（33 pending / 15 approved） |
| 平台收商家营业额 10% | ✅ 商业模型层面，佣金比例可配 | config/fee_rules.js |
| 门店/商户管理 | ✅ 已实现 | Store / Merchant / StoreStaff 模型 |
| 行政区划 | ✅ 已实现 | AdministrativeRegion 模型 |

---

## 三、未实现清单

### P0 — 定价方案核心机制，代码零实现

#### 3.1 钻石产出配额（DIAMOND_QUOTA）

**定价方案描述**：第十节"钻石产出配额控制"，双池隔离的第二条轨道。消费审核通过时按 1:1 发放钻石配额，抽中钻石奖品扣配额，耗尽则降档到小额钻石。

**实际状态**：全项目代码搜索 `DIAMOND_QUOTA` 和 `diamond_quota`，仅在定价方案文档中出现，无任何代码实现。

**具体缺失**：
- `account_asset_balances` 中不存在 `DIAMOND_QUOTA` 资产类型
- `material_asset_types` 中未定义 `DIAMOND_QUOTA`
- 消费审核通过逻辑中没有按比例发放配额的代码
- BuildPrizePoolStage 没有"钻石配额检查"步骤
- `lottery_strategy_config` 中不存在 `diamond_quota_enabled` / `diamond_quota_ratio` / `quota_exhausted_action` 配置项

**影响**：钻石奖品不受配额限制，可以无限产出。定价方案中"预算积分管实物、钻石配额管钻石"的双池隔离只有前半套（预算积分管实物）在运作，后半套（钻石配额管钻石）完全缺失。无法实现 1:1 锚定目标。

#### 3.2 单人限中次数（max_user_wins）

**定价方案描述**：第十四节"奖品级别精细化控制"，三层控制的第三层。每个奖品设 max_user_wins 字段，中够了从奖品池里踢掉。

**实际状态**：`lottery_prizes` 表的实际字段列表中无 `max_user_wins`。全项目搜索该关键词，仅出现在定价方案文档中。

**具体缺失**：
- 数据库字段不存在
- 抽奖引擎没有"查询用户对某奖品的历史总中奖次数"逻辑
- 当前只有 `max_daily_wins`（每日上限），没有跨日的总上限

**影响**：同一用户可以跨天反复中同一奖品，无法实现定价方案中"红水晶每人最多中 2 个"的精细化控制。

### P1 — 广告经济核心逻辑，框架在但关键机制缺失

#### 3.3 广告钻石销毁

**定价方案描述**：广告消耗的钻石直接从流通中永久移除（销毁），持续减少钻石总供给。

**实际状态**：AdBillingService 竞价日扣款（`processDailyBidding`）和固定包天扣款（`deductFrozenDiamonds`）的 `counterpart_account_id` 指向 `SYSTEM_PLATFORM_FEE`（平台手续费账户）。钻石扣减后进入平台账户，而非直接进入 `SYSTEM_BURN`（销毁黑洞账户）。0 条计费记录意味着此流程尚未在真实场景中验证过。

**业务决策（已确认）**：
- 广告扣除的钻石 **先归集到 `SYSTEM_PLATFORM_FEE`**（当前代码已满足）
- **不做自动销毁**，由运营在管理后台手动操作销毁
- 运营点击"销毁"按钮时，将指定数量的钻石从 `SYSTEM_PLATFORM_FEE` 转入 `SYSTEM_BURN`（永久不可逆）

**待实现**：
- 管理后台新增"平台钻石管理"页面，展示 `SYSTEM_PLATFORM_FEE` 账户的钻石余额
- 提供"销毁"操作按钮，运营输入销毁数量 → 二次确认 → 执行转账（`SYSTEM_PLATFORM_FEE` → `SYSTEM_BURN`）
- 销毁操作记录审计日志（操作人、时间、数量、销毁前后余额）
- 销毁动作不可撤回，`SYSTEM_BURN` 账户的钻石不会通过任何业务流程转出

#### 3.4 DAU 系数定价

**定价方案描述**：第六节核心公式 `日价 = 基础价 × DAU 系数`，DAU 区间 <500 / 500-2000 / 2000-10000 / >10000 对应系数 0.375 / 1.0 / 2.5 / 6.25。

**大白话**：用户少的时候便宜卖，用户多的时候贵卖，让广告价格跟着平台实际价值走。

**实际状态**：零实现。代码中无 DAU 跟踪、无系数计算、无动态定价逻辑。广告位价格是 `ad_slots` 表中的静态值。

**实施要求**：DAU 系数表必须由运营在后台动态配置，不允许硬编码。

**方案**：

1. DAU 统计：每日定时任务统计前一天的日活用户数（基于登录/访问记录），写入统计表
2. DAU 系数配置存储在 `system_configs` 中，运营可随时增删改档位：

```
配置键：ad_dau_coefficient_tiers
配置值示例：
[
  { "max_dau": 500,   "coefficient": 0.375, "label": "冷启动期" },
  { "max_dau": 2000,  "coefficient": 1.0,   "label": "成长期" },
  { "max_dau": 10000, "coefficient": 2.5,   "label": "规模期" },
  { "max_dau": null,  "coefficient": 6.25,  "label": "成熟期" }
]
```

3. 运营可调整的维度：
   - 档位数量（不限于 4 档）
   - 每档的 DAU 上限（max_dau，null 表示无上限）
   - 每档的系数值（coefficient）
   - 总开关：`ad_dau_pricing_enabled`（true/false），关闭则使用 `ad_slots` 表中的静态日价
4. 计算逻辑：
   - 包天模式：`实际日价 = ad_slots.daily_price_diamond × 当前 DAU 系数`
   - 竞价模式：DAU 系数影响竞价底价（见 3.5 动态底价）
5. 基础价（`ad_slots.daily_price_diamond`）由运营在广告位管理页面直接编辑

#### 3.5 动态竞价底价

**定价方案描述**：`底价 = 该广告位过去 7 天平均成交价 × 50%`，无成交时用最低保底价。

**大白话**：竞价广告的最低出价门槛自动跟着市场走。热门广告位底价自然上涨（防低价抢占），冷门广告位底价自然下降（鼓励参与），不需要运营手动调。

**实际状态**：零实现。`min_bid_diamond` 是数据库中的静态值，无自动调节逻辑。

**实施要求**：动态底价参数由运营配置，公式中的比例系数和保底价可调。

**方案**：

1. 底价公式配置存储在 `system_configs` 中：

```
配置键：ad_dynamic_floor_price_config
配置值示例：
{
  "enabled": true,
  "lookback_days": 7,
  "floor_ratio": 0.5,
  "fallback_prices": {
    "home_popup": 50,
    "home_carousel": 20,
    "lottery_popup": 30,
    "profile_popup": 20
  }
}
```

2. 运营可调整的维度：
   - 总开关（enabled）：关闭后竞价底价使用 `ad_slots.min_bid_diamond` 静态值
   - 回看天数（lookback_days）：计算平均成交价的时间窗口
   - 底价比例（floor_ratio）：乘以平均成交价的系数（0.5 即 50%）
   - 各广告位的保底价（fallback_prices）：无成交记录时的兜底底价
3. 计算逻辑（定时任务每日凌晨执行）：
   - 查询每个广告位过去 N 天的 `ad_billing_records`（billing_type = daily_deduct 或 deduct）
   - 有成交 → `动态底价 = 平均成交额 × floor_ratio`
   - 无成交 → `动态底价 = fallback_prices[slot_key]`
   - 计算结果写入 `ad_slots.min_bid_diamond`（覆盖旧值）
4. 运营也可以随时在广告位管理页面手动覆盖某个广告位的底价（手动值优先于自动计算）

#### 3.6 阶梯折扣（包天连投）

**定价方案描述**：连续投放天数越多折扣越大，鼓励长期投放锁定钻石消耗。

**实际状态**：零实现。无连续投放天数检测、无折扣计算逻辑。

**实施要求**：折扣档位和比例必须由运营通过后台动态配置，不允许硬编码。

**大白话**：买得久打折多，锁定长期消耗。鼓励广告主长期投放，一次性锁定更多钻石消耗，对平台来说钻石归集量更大更稳定。

**方案**：在 `system_configs` 中存储折扣规则，格式为 JSON 数组，运营可随时在管理后台增删改档位：

```
配置键：ad_consecutive_discount_tiers
配置值示例：
[
  { "min_days": 7,  "discount": 0.95, "label": "周投95折" },
  { "min_days": 14, "discount": 0.85, "label": "双周85折" },
  { "min_days": 30, "discount": 0.75, "label": "月投75折" }
]
```

运营可调整的维度：
- 档位数量（可加可删，不限于 3 档）
- 每档的最低连续天数门槛（min_days）
- 每档的折扣比例（discount，0-1 之间）
- 每档的展示标签（label，前端展示用）
- 可按广告位类型差异化配置（弹窗和轮播各一套折扣规则）
- 总开关：`ad_discount_enabled`（true/false），关闭则所有包天均原价

计算逻辑（伪码）：
```
用户选择连续投放 N 天
→ 从折扣规则中找到 min_days <= N 的最大档位
→ 总价 = 日价 × N × discount
→ 无匹配档位则原价（discount = 1.0）
```

管理后台界面需求：折扣规则的增删改表格 + 实时预览（输入天数即时显示折后价）。

#### 3.6.1 广告两种模式与定价机制的关系（业务决策已确认）

广告有两种计费模式，由运营决定每个广告位启用哪一种：

| 模式 | 说明 | 默认 | 定价机制 |
|------|------|------|----------|
| **固定包天**（fixed_daily） | 固定日价，先买先得 | ✅ 默认模式 | `实际日价 = 基础价 × DAU系数`，连投享阶梯折扣 |
| **竞价**（bidding） | 多广告主出价竞争，高价者优先展示 | — | 出价 ≥ 动态底价才能参与，每日按出价排序结算 |

运营可配置的控制点：
- **模式切换**：每个广告位可在管理后台切换 fixed_daily / bidding（当前 `ad_slots` 表已有 `billing_mode` 概念，需将其变为广告位级别的默认模式配置）
- **基础日价**：运营可随时在广告位管理页面调整 `daily_price_diamond`（按天模式的基础价）
- **每天最低钻石数**：运营可设置包天模式的最低日价下限，DAU 系数计算结果不得低于此值

三个定价机制各管一件事：
- **DAU 系数**管"广告位值多少钱"（按天和竞价都受影响）
- **动态底价**管"竞价至少出多少"（仅竞价模式）
- **阶梯折扣**管"买久了便宜多少"（仅按天模式）

广告主看到的最终价格：
```
按天模式：总价 = max(基础价 × DAU系数, 最低日价) × 天数 × 阶梯折扣
竞价模式：出价 ≥ 动态底价（动态底价本身受 DAU 系数和市场成交价影响）
```

#### 3.7 包天坑位锁定

**定价方案描述**：包天广告主先占坑（先买先得），剩余坑位开放竞价。同一广告位同一天只有一个包天广告主独占该坑位。

**实际状态**：零实现。AdBiddingService 的 selectWinners 是实时选择逻辑，没有"包天优先占坑 + 剩余竞价"的分配机制。

#### 3.8 竞价日结算

**定价方案描述**：每日结算一次（次日凌晨扣费），按出价排序，前 N 名获展示权，扣除钻石并销毁。

**实际状态**：基础框架已实现，竞争排名机制未实现。

已实现部分：
- `ad-cron-jobs.js` 每日 01:00 执行 `runDailyBiddingSettlement` → 调用 `AdBillingService.processDailyBidding()`
- `processDailyBidding()` 遍历所有 active 竞价计划（`daily_bid_diamond > 0`），逐个创建 `billing_type = 'daily_deduct'` 记录
- 幂等控制：同一计划同一天不重复扣款
- 预算耗尽自动标记 `completed`
- 资金流向：广告主 → `SYSTEM_PLATFORM_FEE`

未实现部分（定价方案要求但缺失）：
- 无**竞争排名**：当前对所有 active bidding 计划均扣款，缺少同一广告位内按 `daily_bid_diamond` 排序、取前 N 名的逻辑
- 无**坑位容量限制**：未检查当日某广告位已有多少竞价计划在展示
- 无**落选不扣费**：所有参与者都被扣费，而非仅中标者扣费
- 0 条 `ad_billing_records` 说明此流程从未在真实场景中执行过

**注意**：`bid-settlement-job.js` 处理的是**商品竞拍结算**（BidProduct），非广告竞价结算。广告竞价结算在 `ad-cron-jobs.js`。

### P2 — 规模期功能，当前冷启动阶段可暂缓

#### 3.9 商圈分区广告

**定价方案描述**：广告位按商圈分区投放，企业主投放所在商圈的广告位。100 个商圈 × 3 坑位/商圈 = 大量库存。

**大白话**：现在所有广告全站所有用户看到同一批。等将来有几十上百个商圈，广告位就按商圈拆分，比如"朝阳区弹窗位"和"海淀区弹窗位"是不同的广告位，企业主只投自己所在商圈。这样广告库存从全站 3 个坑变成 100 个商圈 × 3 个坑 = 300 个坑，能容纳更多广告主。

**实际状态**：Store 模型有行政区划（administrative_region）但无"商圈"概念。广告位无按商圈分区字段。当前全部为全站级别，符合文档中"冷启动期暂按全站统一"的描述。

**业务决策（已确认）**：现在实施。

**方案**：

**广告地域定向体系 — 两级分类：商圈 + 区域**

大白话：广告投放有两种地域维度。"商圈"是精准的，比如"望京商圈"就那几条街的用户能看到；"区域"是粗的，比如"朝阳区"整个区的用户都能看到。商圈优先级最高——如果用户同时属于望京商圈和朝阳区，先匹配商圈广告，商圈没有广告了再匹配区域广告。运营可以随时调优先级。

| 层级 | 说明 | 粒度 | 举例 | 默认优先级 |
|------|------|------|------|-----------|
| 商圈 | 精准投放，覆盖特定商圈的用户 | 小（几条街） | 望京商圈、五道口商圈 | 1（最高） |
| 区域 | 泛投放，覆盖整个行政区的用户 | 大（整个区/市） | 朝阳区、海淀区 | 2 |
| 全站 | 所有用户都能看到 | 全部 | — | 3（最低） |

实现方式：

1. 新建 `ad_target_zones` 表（统一地域定向表）：
   - `zone_id`：主键
   - `zone_type`：`district`（商圈）/ `region`（区域）
   - `zone_name`：名称（如"望京商圈"、"朝阳区"）
   - `priority`：优先级数字，越小越优先，运营可调
   - `parent_zone_id`：上级区域（商圈可挂在区域下面，如望京商圈 → 朝阳区）
   - `geo_scope`：覆盖范围描述（关联门店列表 / 行政区划 ID 等）
   - `status`：启用/停用

2. `ad_slots` 表新增 `zone_id` 字段（替代原 `business_district_id`，NULL 表示全站级别）

3. 广告分发优先级匹配逻辑：
```
用户打开首页 → 获取用户所在位置
→ 第 1 步：查用户属于哪个商圈（zone_type = district）→ 有商圈广告 → 展示
→ 第 2 步：商圈无广告 → 查用户属于哪个区域（zone_type = region）→ 有区域广告 → 展示
→ 第 3 步：区域也无广告 → 展示全站广告（zone_id = NULL）
```

4. 运营可调整的维度：
   - 商圈和区域的增删改（名称、覆盖范围、关联门店）
   - **优先级动态调整**：运营可在后台拖拽排序或直接修改 priority 数字，改变匹配顺序（比如某个区域搞大促时临时提升到商圈同级）
   - 每个商圈/区域的广告位数量和类型
   - 商圈与区域的父子关系（一个商圈属于哪个区域）
   - 全站级别广告位始终保留作为兜底

5. 冷启动期可先只建 1 个全站区域，后续按需拆分商圈和区域
6. **联合投放**：运营可将多个商圈和/或区域打包成一个"联合广告组"，广告主一次投放覆盖多个地域

**联合投放方案**：

大白话：比如望京商圈、五道口商圈、中关村商圈三个商圈单独卖广告位没人买。运营把这三个商圈打包成"海淀朝阳核心圈"联合广告组，广告主买一次就同时在三个商圈展示，价格比单独买三个便宜。也可以把商圈和区域混合打包（比如"望京商圈 + 整个丰台区"）。等某个商圈火了，运营随时可以把它拆出来单独卖。

实现方式：
- 新建 `ad_zone_groups` 表（联合广告组）：group_id、group_name、status、pricing_mode
- 新建 `ad_zone_group_members` 关联表：group_id、zone_id（关联 ad_target_zones，商圈和区域都可以加入）
- 运营在管理后台操作：
  - 创建联合广告组 → 选择要打包的商圈和/或区域 → 设置联合组名称
  - 随时增删成员（把某个商圈或区域加入或移出联合组）
  - 设置联合组的定价方式：
    - `sum`：各成员单价之和（无折扣）
    - `discount`：各成员单价之和 × 联合折扣（如 0.8 = 八折）
    - `fixed`：运营直接设定一个固定联合价
  - 联合组总开关（启用/停用）
- 广告主投放时：可以选单个商圈/区域投放，也可以选联合广告组一键投放多个地域
- 广告分发时：联合组内的广告在所有成员地域的对应广告位展示

#### 3.10 分阶段调价触发

**定价方案描述**：第十二节，DAU 连续 7 天处于新区间时触发调价，提前 7 天公告通知。

**大白话**：DAU 系数定价（3.4）已经实现了"根据 DAU 自动算价格"的能力。这个功能是在此基础上加一个自动化触发器：DAU 连续 7 天稳定在新区间 → 系统自动调价 + 提前 7 天在公告位通知用户。

**实际状态**：零实现。无 DAU 监控、无区间判断、无调价触发逻辑。

**业务决策（已确认）**：现在实施，作为 DAU 系数定价（3.4）的配套自动化机制。

**方案**：

1. 依赖 3.4 的 DAU 每日统计数据
2. `system_configs` 新增调价触发配置：

```
配置键：ad_price_adjustment_trigger
配置值示例：
{
  "enabled": true,
  "consecutive_days": 7,
  "advance_notice_days": 7,
  "auto_apply": false
}
```

3. 定时任务每日检查：过去 N 天（consecutive_days）的 DAU 是否连续处于新区间
   - 是 → 生成调价建议（新系数、影响的广告位、价格变化）
   - `auto_apply = false`：仅通知运营，由运营确认后手动执行调价
   - `auto_apply = true`：自动执行调价 + 在首页公告位自动发布调价公告（提前 N 天）
4. 运营可调整的维度：
   - 连续天数门槛（consecutive_days）
   - 提前公告天数（advance_notice_days）
   - 是否自动执行（auto_apply），建议初期关闭，运营手动确认
5. 管理后台：调价历史记录 + 待确认调价建议列表

#### 3.11 信息流广告 / CPM 计费

**定价方案描述**：C 级信息流广告按曝光计费（CPM = Cost Per Mille，每千次曝光的价格），不限量。

**大白话**：跟首页弹窗/轮播是两种完全不同的广告。弹窗/轮播是稀缺显眼的黄金位置，按天/竞价收费；信息流广告是夹在内容列表中间的小卡片广告（比如商家列表第 3 条和第 8 条之间插一条），不限量、不稀缺、容易划走，按"被多少人看到了"收费更合理。

两种广告的区别：

| 类型 | 位置 | 特点 | 收费 |
|------|------|------|------|
| 弹窗/轮播 | 首页一打开就看到 | 稀缺、显眼、强制曝光 | 按天/竞价（当前方案） |
| 信息流小广告 | 夹在列表内容中间 | 不限量、容易划走 | CPM 按曝光次数 |

CPM 举例：定价 10 钻石/千次曝光，被 3000 人看到 → 广告主付 30 钻石；没人看到 → 不付钱。风险在平台（没人看就没收入），适合日活高的时候。

**实际状态**：billing_mode 只有 fixed_daily / bidding / free，无 CPM 模式。小程序当前也没有内容列表场景可以插入信息流广告。

**业务决策（已确认）**：现在实施。先建好 CPM 计费能力，等有列表场景时可立即投入使用。

**方案**：

1. `AdCampaign.billing_mode` 新增 `cpm` 选项（现有：fixed_daily / bidding / free）
2. `ad_slots` 表新增 CPM 相关字段：
   - `cpm_price_diamond`：每千次曝光价格（钻石），运营可配
   - `slot_category`：广告位分类，新增 `feed`（信息流），区分于现有的 `popup` / `carousel` / `announcement`
3. 曝光计数服务：
   - 每次广告展示时记录一条曝光日志（ad_campaign_id、user_id、timestamp）
   - Redis 实时计数 + 每日定时任务归档到数据库
4. CPM 计费逻辑：
   - 每日凌晨定时任务：统计每个 CPM 广告计划的前日曝光次数
   - `扣费 = 曝光次数 / 1000 × cpm_price_diamond`（向上取整到最小单位）
   - 曝光为 0 → 不扣费
   - 通过 AdBillingService 创建 billing_type = `cpm_deduct` 的计费记录
5. 运营可调整的维度：
   - 每个信息流广告位的 CPM 价格
   - CPM 广告的每日预算上限（广告主设置，花完当天停止展示）
   - CPM 广告位的创建和管理（在广告位管理页面）
6. 前端对接（等有列表场景时）：
   - 内容列表中按间隔插入广告卡片（如每 5 条内容插 1 条广告）
   - 广告卡片样式与普通内容一致，标注"广告"标签
   - 插入位置和频率由运营配置

#### 3.12 僵尸账户钻石清零

**定价方案描述**：365 天零活跃才清零钻石，仅清理彻底流失的用户。

**业务决策（已确认）**：不实现。不清除僵尸账户钻石，用户资产永久保留。

---

## 四、数据库与定价方案的价格差异

定价方案第十三节建议了冷启动期的价格调整，以下是当前值与建议值的对比：

| 广告位 | 字段 | 当前值 | 方案建议值 | 状态 |
|--------|------|--------|-----------|------|
| home_popup | daily_price_diamond | 100 | 100 | ✅ 一致 |
| home_popup | min_bid_diamond | 50 | 50 | ✅ 一致 |
| home_popup | min_budget_diamond | 500 | **300** | ❌ 未调整 |
| home_carousel | daily_price_diamond | 60 | **40** | ❌ 未调整 |
| home_carousel | min_bid_diamond | 50 | **20** | ❌ 未调整 |
| home_carousel | min_budget_diamond | 500 | **120** | ❌ 未调整 |
| home_announcement | 全部 | 0 | 0 | ✅ 一致 |

---

## 五、lottery_strategy_config 实际配置

| config_key | config_value | 定价方案对应概念 |
|------------|-------------|-----------------|
| threshold_high | 1000 | B3 门槛（预算 >= 1000 可抽 high+mid+low+fallback） |
| threshold_mid | 500 | B2 门槛 |
| threshold_low | 100 | B1 门槛 |
| hard_guarantee_threshold | 10 | 保底触发阈值 |
| min_non_empty_cost | 10 | 最低非空奖成本 |
| empty_streak_threshold | 3 | 连空保底阈值 |
| high_streak_threshold | 2 | 连高限制阈值 |
| pity_percentage | 52 | 保底介入比例 |
| luck_debt_percentage | 100 | 运气债务介入比例 |
| anti_empty_percentage | 100 | 防连空介入比例 |
| anti_high_percentage | 100 | 防连高介入比例 |

注意：不存在 `diamond_quota_enabled`、`diamond_quota_ratio`、`quota_exhausted_action`、`category_pick_enabled`、`physical_probability` 等定价方案中描述的运营开关。

---

## 六、实施路线建议

### 第一步：补齐钻石配额（P0，影响经济平衡）

- `material_asset_types` 添加 DIAMOND_QUOTA 资产类型
- 消费审核通过时，同步向用户 account_asset_balances 发放钻石配额（复用 BalanceService）
- BuildPrizePoolStage 新增钻石配额过滤：抽中钻石奖品前检查配额余量，不够则降档或过滤
- `lottery_strategy_config` 新增 diamond_quota_enabled / diamond_quota_ratio / quota_exhausted_action
- 迁移脚本：为现有 15 条已审核消费记录补发配额

### 第二步：补齐 max_user_wins（P0，影响公平性）

- `lottery_prizes` 表添加 max_user_wins 字段（INTEGER, nullable, 默认 NULL 表示不限制）
- BuildPrizePoolStage 新增过滤：查询 lottery_draws 统计用户对每个奖品的历史中奖总次数，超过 max_user_wins 则排除

### 第三步：调整冷启动期广告位价格（P1，降低投放门槛）

- 更新 ad_slots 表：home_popup.min_budget_diamond → 300；home_carousel 日价 → 40、底价 → 20、最低预算 → 120

### 第四步：实现广告定价三大机制（P1，现在实施）

> DAU 系数 + 动态底价 + 阶梯折扣是广告定价的核心，不再延后。

**4a. DAU 系数定价**
- 每日定时任务统计前日 DAU，写入统计表
- `system_configs` 新增 `ad_dau_coefficient_tiers`（JSON 数组，运营可配）
- `system_configs` 新增 `ad_dau_pricing_enabled` 总开关
- 广告提交/展示时：读取当前 DAU 对应系数 → 乘以基础价得到实际日价
- 管理后台：DAU 系数配置页面（增删改档位 + 当前 DAU 状态展示）

**4b. 动态竞价底价**
- `system_configs` 新增 `ad_dynamic_floor_price_config`（回看天数、比例、各广告位保底价）
- 每日凌晨定时任务：查询各广告位过去 N 天成交均价 → 计算动态底价 → 写入 `ad_slots.min_bid_diamond`
- 运营可手动覆盖某广告位底价（手动值优先）
- 管理后台：底价配置页面 + 各广告位当前底价展示

**4c. 阶梯折扣**
- `system_configs` 新增 `ad_consecutive_discount_tiers`（JSON 数组）+ `ad_discount_enabled` 总开关
- 广告主选择连投天数时：实时匹配折扣档位 → 显示折后总价
- 管理后台：折扣规则增删改表格 + 实时价格预览

**4d. 广告位模式管理**
- 每个广告位可配置默认计费模式（fixed_daily / bidding），运营在广告位管理页面切换
- 运营可动态调整每个广告位的基础日价（`daily_price_diamond`）和最低日价下限
- 按天模式日价不得低于运营设置的最低值

### 第五步：完善广告计费闭环（P1，让商业广告跑通）

- 广告钻石先归集到 `SYSTEM_PLATFORM_FEE`（当前代码已满足），运营手动销毁到 `SYSTEM_BURN`
- 实现包天坑位锁定：ad_campaigns 增加日期级别排他检查
- 实现竞价日结算定时任务：每日凌晨扫描当天竞价广告 → 按出价排序 → 扣费
- 管理后台新增"平台钻石管理"页面（余额展示 + 手动销毁按钮）

### 第六步：商圈分区 + CPM 计费 + 调价触发（现在实施）

**6a. 地域定向体系（商圈 + 区域 + 联合投放）**
- 新建 `ad_target_zones` 表，统一管理商圈（district）和区域（region）两级地域分类
- `ad_slots` 新增 `zone_id` 字段，广告位绑定到具体商圈/区域/全站
- 广告分发按优先级匹配：商圈（最高）→ 区域 → 全站（兜底），运营可动态调整优先级
- 联合投放：新建 `ad_zone_groups` + `ad_zone_group_members` 表，运营可将多个商圈和/或区域打包成联合广告组，支持三种定价方式（求和/折扣/固定价）
- 冷启动期先建 1 个全站区域，后续按需拆分

**6b. 信息流 CPM 广告**
- `billing_mode` 新增 `cpm` 选项
- `ad_slots` 新增 `cpm_price_diamond`（运营可配）和 `slot_category = feed`
- 曝光计数服务（Redis 实时计数 + 每日归档）
- 每日定时任务按曝光次数计费扣款
- 前端列表插入广告卡片（等有列表场景时对接）

**6c. 分阶段调价触发器**
- 依赖第四步的 DAU 每日统计数据
- 定时任务检查 DAU 连续 N 天是否处于新区间
- 生成调价建议 → 运营确认后执行（初期关闭自动执行）
- 调价前提前 N 天在公告位自动通知

---

## 七、代码审查纠正与补充（2026-03-01 实际代码 + 数据库验证）

> 以下内容基于后端项目实际代码审查 + 连接真实数据库（restaurant_points_dev）验证，纠正原文档中与实际状态不符的部分，并补充遗漏的已有基础设施。

### 7.1 section 3.8 竞价日结算纠正

原文档标注"零实现"，已纠正为"基础框架已实现，竞争排名未实现"。详见 3.8 节更新内容。

### 7.2 文档未提及的已有广告基础设施

以下组件已存在于后端项目中，对后续功能实现有直接复用价值：

| 组件 | 文件位置 | 复用价值 |
|------|---------|---------|
| AdReportService | services/AdReportService.js | 广告报表服务，日报快照定时任务（每日 04:00），CPM 报表可直接扩展 |
| AdTagAggregationService | services/AdTagAggregationService.js | 用户标签聚合（每日 03:00），targeting_rules 匹配已实现 |
| AdImpressionLog 模型 | models/AdImpressionLog.js | 曝光日志模型已建立，CPM 计数的数据库归档可直接复用 |
| AdClickLog 模型 | models/AdClickLog.js | 点击日志模型已建立 |
| AdAntifraudService | services/AdAntifraudService.js | 反作弊框架已建立 |
| AdAttributionService | services/AdAttributionService.js | 归因服务框架已建立 |
| UserAdTag 模型 | models/UserAdTag.js | 用户广告标签，支持 targeting_rules JSON 匹配 |
| AdReportDailySnapshot | models/AdReportDailySnapshot.js | 日报快照模型，每日 04:00 自动生成 |
| ad_billing_records 表 | 10 列，billing_type 支持 freeze/deduct/refund/daily_deduct | CPM 结算新增 billing_type = 'cpm_deduct' 即可 |
| ConsumptionAuditCallback | callbacks/ConsumptionAuditCallback.js | 消费审核回调架构占位符（当前空实现），DIAMOND_QUOTA 发放的天然插入点 |

### 7.3 数据库真实状态确认（102 张表）

| 验证项 | 实际数据库状态 |
|--------|-------------|
| ad_slots | 7 行，13 列。无 zone_id、cpm_price_diamond、slot_category、min_daily_price_diamond、floor_price_override |
| ad_campaigns | 6 行（2 commercial/draft + 2 operational/completed + 1 operational/paused + 1 system/paused），27 列。billing_mode 实际值只有 fixed_daily 和 free |
| lottery_prizes | 30 列。**确认 max_user_wins 字段不存在**，仅有 max_daily_wins |
| material_asset_types | 15 行。**确认 DIAMOND_QUOTA 不存在** |
| account_asset_balances | 7 种 asset_code 在用：POINTS/BUDGET_POINTS/DIAMOND/red_shard/red_crystal/orange_shard/MATERIAL_001 |
| system_configs | **无任何 ad_ 前缀的配置键**，无 DAU/discount/floor_price/quota/cpm 相关配置 |
| ad_billing_records | **0 条记录** |
| ad_bid_logs | 表存在（文档中称 ad_bidding_logs 有 116 条，实际表名为 ad_bid_logs） |
| ad_target_zones | **表不存在** |
| ad_zone_groups | **表不存在** |
| ad_zone_group_members | **表不存在** |
| DAU 统计表 | **不存在任何 DAU 相关表** |
| lottery_strategy_config | 120 行，跨 4 个活动。**确认无 diamond_quota_enabled / diamond_quota_ratio / quota_exhausted_action** |

### 7.4 广告系统 ad_slots.slot_type 枚举确认

后端模型 `AdSlot.VALID_SLOT_TYPES = ['popup', 'carousel', 'announcement']`，不包含 `feed`（信息流）。新增 CPM 需扩展此枚举。

---

## 八、后端可复用资产与扩展点分析

### 8.1 可直接复用的后端基础设施

| 基础设施 | 当前实现 | 复用场景 |
|---------|---------|---------|
| **SystemConfigService** | JSON config_value + Redis 缓存（5 分钟 TTL）+ getByKey/getValue/upsert/mergeValue | DAU 系数档位、折扣规则、底价配置、调价触发配置 → 全部存为 system_configs 记录 |
| **BalanceService.changeBalance** | 支持 counterpart_account_id 双录记账 | 钻石销毁 = changeBalance(SYSTEM_PLATFORM_FEE 账户, -N, counterpart: SYSTEM_BURN 账户) |
| **BalanceService.freeze/settleFromFrozen** | 冻结 → 结算/退款完整流程 | 包天广告冻结/扣款已在用 |
| **node-cron 集中调度** | scheduled_tasks.js，30+ 定时任务 | 新增 DAU 统计、动态底价计算、调价检查、CPM 结算任务 |
| **AdBillingService** | freeze/deduct/refund/processDailyBidding 四个方法 | 扩展 processDailyCPM 方法 + 重构 processDailyBidding 增加竞争排名 |
| **AdImpressionLog** | 曝光日志模型 + 表 | CPM 曝光归档直接写入 |
| **ServiceManager** | snake_case key 注册/获取服务 | 新服务（AdPricingService、AdTargetZoneService）按同样模式注册 |
| **TransactionManager.execute()** | 事务包装 + 自动回滚 | 所有写操作（销毁、结算、配额发放）使用 |
| **IdempotencyService** | business_id 幂等控制 | 日结算、配额发放的幂等保证 |
| **BeijingTimeHelper** | 北京时间统一 | 所有日期计算（DAU 统计日期、结算日期）使用 |
| **ConsumptionAuditCallback.approved** | 空实现的回调架构 | DIAMOND_QUOTA 发放的天然插入点 |
| **AdministrativeRegion 模型** | 省/市/区/街道四级行政区划 | 地域定向"区域"层级可关联 |

### 8.2 需要新建的后端组件

| 组件 | 类型 | 说明 |
|------|------|------|
| AdPricingService | 新服务 | 聚合 DAU 系数计算、动态底价计算、阶梯折扣计算 |
| AdTargetZoneService | 新服务 | 地域管理 CRUD + 联合组管理 |
| AdCPMService | 新服务（或扩展 AdBillingService） | CPM 曝光计数（Redis）+ 日归档 + 日结算 |
| daily-dau-stats.js | 新定时任务 | 每日统计前日 DAU，写入 ad_dau_daily_stats 表 |
| daily-price-adjustment-check.js | 新定时任务 | 检查 DAU 连续 N 天是否进入新区间，生成调价建议 |
| ad_dau_daily_stats | 新表 | stat_date + dau_count + dau_coefficient + created_at |
| ad_target_zones | 新表 | 统一地域定向（商圈 + 区域） |
| ad_zone_groups + ad_zone_group_members | 新表 | 联合广告组 |
| ad_price_adjustment_logs | 新表 | 调价历史记录（旧系数 → 新系数、操作人、时间） |

### 8.3 Web 管理端技术栈适配确认

| 层 | 当前实现 | 新增功能适配性 |
|----|---------|-------------|
| UI 框架 | Alpine.js 3.15.4 x-data/x-init/x-for | ✅ 新 Tab/页面按现有模式添加 composable |
| 样式 | Tailwind CSS 3.4.19 | ✅ 表格/表单/按钮组件已有统一风格 |
| 构建 | Vite 6.4.1 多页面模式 | ✅ 新增 HTML 入口自动纳入构建 |
| API 调用 | request() + ENDPOINTS 常量 + $api magic | ✅ 新增 endpoint 常量即可 |
| 图表 | ECharts 6.0（懒加载） | ✅ DAU 趋势图、定价变化图复用 |
| 页面组织 | admin/src/modules/{domain}/pages/ + composables/ | ✅ 新 composable 放 content/ 或新建 pricing/ 模块 |
| 表单验证 | Alpine.js 内联验证 | ✅ 新表单字段按同样模式 |

**不需要引入新的前端依赖**。所有新增 UI 均可用现有 Alpine.js + Tailwind + ECharts 实现。

---

## 九、各项目工作量分解

### 9.1 后端数据库项目（核心权威，优先实施）

#### P0 — 经济平衡 + 公平性

| # | 任务 | 涉及文件 | 工作量 |
|---|------|---------|--------|
| B1 | material_asset_types INSERT DIAMOND_QUOTA（asset_code='DIAMOND_QUOTA', group_code='currency', form='quota'） | 新迁移文件 | 小 |
| B2 | lottery_strategy_config 新增 3 个配置键：diamond_quota_enabled / diamond_quota_ratio / quota_exhausted_action | 新迁移文件（INSERT 到相关活动） | 小 |
| B3 | 消费审核通过时发放 DIAMOND_QUOTA：在 `ConsumptionAuditCallback.approved` 或 `ConsumptionService.approveConsumption` 中调用 `BalanceService.changeBalance` | ConsumptionAuditCallback.js 或 services/consumption/CoreService.js | 中 |
| B4 | BuildPrizePoolStage 新增 `_filterByDiamondQuota`：查询用户 DIAMOND_QUOTA 余额，钻石类奖品（material_asset_code='DIAMOND'）需要配额足够才进入池 | services/UnifiedLotteryEngine/pipeline/stages/BuildPrizePoolStage.js | 中 |
| B5 | SettleStage 扣减 DIAMOND_QUOTA：抽中钻石奖品时扣减对应配额 | services/UnifiedLotteryEngine/pipeline/stages/SettleStage.js | 中 |
| B6 | lottery_prizes ADD COLUMN max_user_wins INT NULL DEFAULT NULL | 新迁移文件 | 小 |
| B7 | BuildPrizePoolStage 新增 `_filterByUserWins`：查询 lottery_draws 统计用户对每个奖品的历史总中奖次数，超过 max_user_wins 则排除 | BuildPrizePoolStage.js | 中 |
| B8 | 数据修复迁移：为已 approved 的消费记录按比例补发 DIAMOND_QUOTA | 一次性迁移脚本 | 小 |

#### P1a — 广告定价三大机制

| # | 任务 | 涉及文件 | 工作量 |
|---|------|---------|--------|
| B9 | 新建 ad_dau_daily_stats 表（stat_date DATE UNIQUE, dau_count INT, dau_coefficient DECIMAL, created_at） | 新迁移 + 新模型 | 小 |
| B10 | 新建 daily-dau-stats.js 定时任务（每日 00:30）：统计前日 DAU（基于 users.last_login_at 或 user_behavior_tracks），写入 ad_dau_daily_stats | 新 job + scheduled_tasks.js 注册 | 中 |
| B11 | system_configs INSERT 4 个配置键：ad_dau_pricing_enabled / ad_dau_coefficient_tiers / ad_dynamic_floor_price_config / ad_consecutive_discount_tiers + ad_discount_enabled | 新迁移种子数据 | 小 |
| B12 | 新建 AdPricingService：getDauCoefficient() / calculateDynamicFloorPrice(slotKey) / calculateDiscount(days) / calculateFinalPrice(slotId, days) | 新服务 + ServiceManager 注册 | 中 |
| B13 | ad_slots ADD COLUMN min_daily_price_diamond INT DEFAULT 0, floor_price_override INT NULL | 新迁移 | 小 |
| B14 | ad-cron-jobs.js 新增动态底价计算任务（每日 01:30）：调用 AdPricingService → 更新 ad_slots.min_bid_diamond | ad-cron-jobs.js 扩展 | 中 |
| B15 | 管理端 API：GET/PUT /api/v4/console/system-configs/ad-pricing（DAU 系数/折扣/底价配置 CRUD）| 新路由或 system-data.js 扩展 | 中 |
| B16 | 管理端 API：GET /api/v4/console/ad-stats/dau（DAU 趋势数据） | 新路由 | 小 |

#### P1b — 广告计费闭环

| # | 任务 | 涉及文件 | 工作量 |
|---|------|---------|--------|
| B17 | 包天坑位排他检查：创建/审核 fixed_daily 计划时，检查 start_date ~ end_date 内同 ad_slot_id 是否已有 active 的 fixed_daily 计划 | AdCampaignService 或路由校验逻辑 | 中 |
| B18 | 竞价日结算重构：processDailyBidding 改为按 ad_slot_id 分组 → 每组按 daily_bid_diamond DESC 排序 → 取前 max_display_count 名为中标 → 仅中标者创建 daily_deduct 记录 | AdBillingService.js | 大 |
| B19 | 管理端 API：GET /api/v4/console/platform-diamond（查询 SYSTEM_PLATFORM_FEE 账户 DIAMOND 余额） | 新路由 | 小 |
| B20 | 管理端 API：POST /api/v4/console/platform-diamond/burn（从 SYSTEM_PLATFORM_FEE → SYSTEM_BURN 转账 + 审计日志） | 新路由 | 中 |
| B21 | ad_slots 价格调整：home_popup.min_budget_diamond → 300; home_carousel.daily_price_diamond → 40, min_bid_diamond → 20, min_budget_diamond → 120 | 数据迁移 | 小 |

#### P1c — 商圈 + CPM + 调价

| # | 任务 | 涉及文件 | 工作量 |
|---|------|---------|--------|
| B22 | 新建 ad_target_zones 表 + AdTargetZone 模型 | 新迁移 + 新模型 | 中 |
| B23 | 新建 ad_zone_groups + ad_zone_group_members 表 + 模型 | 新迁移 + 新模型 | 中 |
| B24 | ad_slots ADD COLUMN zone_id INT NULL REFERENCES ad_target_zones, slot_category ENUM('display','feed') DEFAULT 'display', cpm_price_diamond INT DEFAULT 0 | 新迁移 + AdSlot 模型更新 | 小 |
| B25 | AdCampaign.VALID_BILLING_MODES 新增 'cpm' | AdCampaign.js 常量 + 迁移修改 ENUM | 小 |
| B26 | AdSlot.VALID_SLOT_TYPES 新增 'feed' | AdSlot.js 常量 | 小 |
| B27 | 新建 AdTargetZoneService（CRUD + 联合组管理） | 新服务 | 中 |
| B28 | AdBiddingService.selectWinners 增加地域匹配：根据用户关联门店 → 推断 zone → 优先匹配商圈广告 → 区域 → 全站 | AdBiddingService.js 扩展 | 大 |
| B29 | CPM 曝光计数：Redis INCR `ad_impression:{campaign_id}:{date}` + 每日凌晨归档到 ad_impression_logs 汇总 | 新方法在 AdImpressionLogService 或 AdCPMService | 中 |
| B30 | CPM 日结算：ad-cron-jobs.js 新增 01:15 任务，读取前日各 CPM 计划曝光数 → 按 cpm_price_diamond 计费 → AdBillingService 创建 billing_type='cpm_deduct' 记录 | ad-cron-jobs.js + AdBillingService 扩展 | 中 |
| B31 | 新建 ad_price_adjustment_logs 表（记录调价历史） | 新迁移 + 新模型 | 小 |
| B32 | system_configs INSERT ad_price_adjustment_trigger 配置键 | 迁移种子数据 | 小 |
| B33 | 新建 daily-price-adjustment-check.js 定时任务（每日 02:00）：检查 DAU 连续 N 天在新区间 → 生成调价建议记录 | 新 job | 中 |
| B34 | 管理端 API：ad_target_zones CRUD + ad_zone_groups CRUD | 新路由 | 中 |
| B35 | 管理端 API：调价历史列表 + 确认执行调价 | 新路由 | 中 |

### 9.2 Web 管理后台前端项目

> 所有字段名直接使用后端数据库字段名（snake_case），不做映射。

#### 现有页面扩展

| # | 任务 | 涉及文件 | 说明 |
|---|------|---------|------|
| F1 | ad-management.html 新增"定价配置"子页面 Tab | ad-management.html + ad-management.js | 在现有 subPages 数组中增加 'pricing' |
| F2 | 新建 composable：admin/src/modules/content/composables/ad-pricing.js | 新文件 | DAU 系数档位表格（增删改）、折扣规则表格、底价配置表单、DAU 趋势图（ECharts） |
| F3 | ad-management.js slotForm 增加字段 | ad-management.js | 增加 min_daily_price_diamond、slot_category、cpm_price_diamond、zone_id 下拉选择 |
| F4 | ad-management.js campaignForm 增加 billing_mode 选项 | ad-management.js | BILLING_MAP 增加 'cpm': 'CPM曝光计费' |
| F5 | ad-management.js SLOT_TYPE_MAP 增加 'feed' | ad-management.js | SLOT_TYPE_MAP.feed = '信息流' |
| F6 | lottery-management 奖品表单增加 max_user_wins | lottery-management.js / prize 相关 composable | 在 prizeForm 中增加字段，标签"每人总中奖上限"，NULL=不限 |
| F7 | system/admin.js 或 system/index.js 新增 endpoint 常量 | API 模块 | AD_PRICING_CONFIG、AD_DAU_STATS、PLATFORM_DIAMOND、PLATFORM_DIAMOND_BURN、AD_ZONES、AD_ZONE_GROUPS、AD_PRICE_ADJUSTMENTS |

#### 新增页面

| # | 任务 | 涉及文件 | 说明 |
|---|------|---------|------|
| F8 | 新建 platform-diamond.html — 平台钻石管理 | 新 HTML + 新 JS | 展示 SYSTEM_PLATFORM_FEE 的 DIAMOND 余额；销毁按钮（输入数量 → 二次确认 → 调用 burn API）；销毁历史表格 |
| F9 | 新建 zone-management.html — 地域管理 | 新 HTML + 新 JS | 商圈 CRUD 表格 + 区域 CRUD 表格 + 联合组管理（创建组 → 选择成员 → 设定价方式） |
| F10 | ad-management 调价历史 Tab（或嵌入定价配置 Tab） | ad-management.js 扩展 | 调价建议列表 + 确认/拒绝按钮 + 历史记录 |

### 9.3 微信小程序前端项目

| # | 任务 | 前置条件 | 说明 |
|---|------|---------|------|
| W1 | 广告展示接口响应新增 zone 信息 | B24, B28 完成 | 如果后端 ad-delivery 响应格式变化，小程序需适配 |
| W2 | 曝光上报接口对接 | B29 完成 | 广告展示时调用 POST /api/v4/system/ad-events/impression（**已有路由**，检查是否需要扩展） |
| W3 | 信息流广告展示组件 | B24, B25, B26 完成 | 需要有内容列表场景才能插入；如无列表场景则暂不需要 |
| W4 | 用户位置/门店上报（如启用商圈匹配） | 决策 D4 确认 | 如采用方案 B（基于门店推断），小程序无需额外开发 |

**小程序工作量最小**：核心逻辑在后端，小程序主要是适配后端接口变化。曝光上报路由 `/api/v4/system/ad-events` 已存在。

---

## 十、需要用户拍板的决策项

| # | 决策项 | 选项 | 建议 | 影响范围 |
|---|--------|------|------|---------|
| D1 | **钻石配额发放比例** | A: 固定 1:1（1 元消费 = 1 配额）<br>B: 可配比例，存 system_configs（如 1:0.5） | **B**：在 lottery_strategy_config 中加 diamond_quota_ratio，初始值 1.0，运营可调 | B3 后端 |
| D2 | **配额耗尽行为** | A: 直接过滤掉所有钻石奖品<br>B: 降档到最小额钻石（如 1 钻石）<br>C: 可配，存 lottery_strategy_config | **C**：quota_exhausted_action = 'filter' / 'downgrade'，默认 'filter' | B4 后端 |
| D3 | **DAU 统计数据源** | A: users.last_login_at（有 JWT 即算活跃）<br>B: user_behavior_tracks 表<br>C: 两者取并集 | **A**：后端已有 users.last_login_at，最简单可靠。后续可升级到 B | B10 后端 |
| D4 | **用户位置获取方式（商圈匹配）** | A: 小程序获取 GPS 定位<br>B: 基于用户绑定/常去门店的行政区划推断<br>C: 冷启动期不获取，全站投放 | **B**：用户关联门店 → 门店关联 administrative_region → 推断所在区域/商圈。无需 GPS | B28 后端 |
| D5 | **竞价排名坑位数** | A: 每个广告位每天 1 个赢家<br>B: 取 ad_slots.max_display_count 个赢家 | **B**：复用现有字段，灵活性更高 | B18 后端 |
| D6 | **包天锁定时间颗粒度** | A: 自然日（北京时间 0:00-24:00）<br>B: 从投放开始算 24 小时 | **A**：与 DAU 统计周期、日结算周期一致，简单 | B17 后端 |
| D7 | **CPM 计费精度** | A: 按比例（曝光数 ÷ 1000 × 单价，精确到小数再取整）<br>B: 不足 1000 次不计费<br>C: 向上取整到千次 | **A**：公平，Math.ceil(impressions / 1000 * cpm_price_diamond) | B30 后端 |
| D8 | **竞价落选者是否扣费** | A: 仅中标者扣费（行业标准）<br>B: 所有参与者按出价扣费（当前代码逻辑） | **A**：仅中标者扣费。当前代码需重构 processDailyBidding | B18 后端 |
| D9 | **调价是否自动执行** | A: 初期手动确认（auto_apply = false）<br>B: 直接自动执行 | **A**：初期手动确认，运营熟练后再开自动 | B33 后端 |
| D10 | **联合投放定价方式** | A: 成员单价求和<br>B: 求和 × 联合折扣<br>C: 运营直接设固定价<br>D: 三种都支持，运营选择 | **D**：在 ad_zone_groups 中加 pricing_mode ENUM('sum','discount','fixed')，最灵活 | B23 后端 |

---

## 十一、实施步骤（基于后端实际技术栈）

### 技术规范

所有实施遵循后端项目现有技术规范：

| 规范项 | 后端项目现有做法 | 新增代码遵循 |
|--------|---------------|------------|
| 服务注册 | ServiceManager.register('snake_case_key', ServiceClass) | 新服务按同样模式注册 |
| 事务 | TransactionManager.execute(async (transaction) => {...}) | 所有写操作使用 |
| 幂等 | business_id 唯一键 + IdempotencyService | 日结算/配额发放使用 |
| 时间 | BeijingTimeHelper.today() / .apiTimestamp() | 日期计算、日志时间使用 |
| 配置读取 | SystemConfigService.getValue('config_key', defaultValue) | DAU 系数/折扣/底价读取使用 |
| 数据库迁移 | Sequelize CLI `npx sequelize-cli migration:generate` | 所有 DDL 变更使用 |
| 定时任务 | node-cron 在 scheduled_tasks.js 集中注册 | 新任务注册到同一调度器 |
| API 响应 | ApiResponse.success(data) / ApiResponse.error(msg, code) | 新路由使用统一响应 |
| 日志 | winston logger（logger.info/warn/error） | 新代码使用 |
| 前端 API | SYSTEM_ENDPOINTS 常量 + request({url, method, params/data}) | 新 endpoint 按同样模式 |
| 前端页面 | Alpine.js x-data + composable 函数 + createPageMixin | 新页面/Tab 按同样模式 |

### 第一批：钻石配额 + max_user_wins（P0，预计 3-5 天）

**数据库迁移：**
1. material_asset_types 新增 DIAMOND_QUOTA 行（asset_code='DIAMOND_QUOTA', display_name='钻石配额', group_code='currency', form='quota', tier=0, is_enabled=1, is_tradable=0）
2. lottery_prizes ADD COLUMN max_user_wins INT NULL DEFAULT NULL COMMENT '每人总中奖上限，NULL不限'
3. lottery_strategy_config INSERT 到各活动：diamond_quota_enabled=true, diamond_quota_ratio=1.0, quota_exhausted_action='filter'

**后端服务修改：**
4. ConsumptionService.approveConsumption（或 ConsumptionAuditCallback.approved）：审核通过时，调用 BalanceService.changeBalance 向用户发放 DIAMOND_QUOTA（amount = 消费金额 × diamond_quota_ratio）
5. BuildPrizePoolStage.execute 中新增两个过滤步骤：
   - `_filterByDiamondQuota(prizes, userId, transaction)`：查询用户 DIAMOND_QUOTA 余额 → 钻石类奖品（material_asset_code='DIAMOND'）需配额 ≥ material_amount
   - `_filterByUserWins(prizes, userId, transaction)`：查询 lottery_draws GROUP BY lottery_prize_id WHERE user_id = ? → 对比 max_user_wins，超限则排除
6. SettleStage：抽中钻石奖品时，除了发放钻石，同时扣减 DIAMOND_QUOTA（amount = 发放的钻石数量）

**Web 管理端：**
7. lottery 相关的奖品表单 composable 增加 max_user_wins 字段输入框

**数据修复：**
8. 一次性迁移脚本：查询所有 status='approved' 的消费记录 → 按金额 × ratio 补发 DIAMOND_QUOTA

### 第二批：广告定价三大机制（P1a，预计 5-7 天）

**数据库迁移：**
1. CREATE TABLE ad_dau_daily_stats（stat_date DATE UNIQUE, dau_count INT, dau_coefficient DECIMAL(10,4), source VARCHAR(50), created_at DATETIME）
2. ad_slots ADD COLUMN min_daily_price_diamond INT DEFAULT 0, floor_price_override INT NULL
3. system_configs INSERT 种子数据：
   - config_key='ad_dau_pricing_enabled', config_value='false', config_category='ad'
   - config_key='ad_dau_coefficient_tiers', config_value='[{"max_dau":500,"coefficient":0.375,"label":"冷启动期"},...]', config_category='ad'
   - config_key='ad_dynamic_floor_price_config', config_value='{"enabled":false,"lookback_days":7,"floor_ratio":0.5,"fallback_prices":{...}}', config_category='ad'
   - config_key='ad_consecutive_discount_tiers', config_value='[{"min_days":7,"discount":0.95,"label":"周投95折"},...]', config_category='ad'
   - config_key='ad_discount_enabled', config_value='false', config_category='ad'

**后端服务：**
4. 新建 services/AdPricingService.js，注册到 ServiceManager：
   - getCurrentDauCoefficient()：读 ad_dau_daily_stats 最新记录 → 匹配 ad_dau_coefficient_tiers 档位
   - calculateDynamicFloorPrice(slotKey)：查 ad_billing_records 最近 N 天均价 × floor_ratio
   - calculateDiscount(days)：匹配 ad_consecutive_discount_tiers 中 min_days ≤ days 的最大档位
   - calculateFinalDailyPrice(slotId, days)：综合 DAU 系数 × 基础价，取 max(计算价, min_daily_price_diamond) × 折扣
5. 新建 jobs/daily-dau-stats.js：每日 00:30，统计 users WHERE last_login_at >= 昨日 00:00 AND < 今日 00:00 的 COUNT → INSERT ad_dau_daily_stats
6. ad-cron-jobs.js 新增 01:30 任务：调用 AdPricingService.calculateDynamicFloorPrice 对每个竞价广告位 → 更新 ad_slots.min_bid_diamond（仅 floor_price_override IS NULL 时）
7. 新增管理端 API 路由（建议新建 routes/v4/console/ad-pricing.js）：
   - GET /api/v4/console/ad-pricing/config — 返回 4 个配置键的值
   - PUT /api/v4/console/ad-pricing/config/:config_key — 更新配置
   - GET /api/v4/console/ad-pricing/dau-stats — DAU 趋势数据（最近 30/90 天）
   - GET /api/v4/console/ad-pricing/preview?slot_id=X&days=N — 实时计算并返回最终价格预览

**Web 管理端：**
8. ad-management.html subPages 增加 'pricing' Tab
9. 新建 admin/src/modules/content/composables/ad-pricing.js：
   - DAU 系数档位管理表格（读写 ad_dau_coefficient_tiers）
   - 阶梯折扣管理表格（读写 ad_consecutive_discount_tiers）
   - 动态底价配置表单（读写 ad_dynamic_floor_price_config）
   - DAU 趋势折线图（ECharts）
   - 价格预览计算器（输入广告位 + 天数 → 显示折后总价）
10. ad-management.js slotForm 增加 min_daily_price_diamond 字段
11. admin/src/api/system/admin.js 新增 endpoint 常量

### 第三批：广告计费闭环（P1b，预计 5-7 天）

**后端服务：**
1. 包天坑位排他检查：在创建/审核 fixed_daily 计划时，查询同 ad_slot_id、日期范围重叠、status IN ('active','approved') 的 fixed_daily 计划 → 有则拒绝
2. AdBillingService.processDailyBidding 重构：
   - 按 ad_slot_id 分组查询当日 active bidding 计划
   - 每组按 daily_bid_diamond DESC 排序
   - 取前 N 名（N = ad_slots.max_display_count）为中标
   - 仅对中标者创建 daily_deduct 记录
   - 落选者不扣费（但仍保持 active 状态，次日继续参与竞价）
3. 新增路由 routes/v4/console/platform-diamond.js：
   - GET /balance — 查询 Account(owner_type='SYSTEM', owner_id='SYSTEM_PLATFORM_FEE') 的 DIAMOND 余额
   - POST /burn — 输入 amount → TransactionManager 事务内：BalanceService.changeBalance(platform_fee_account, -amount, DIAMOND, counterpart: burn_account) + 审计日志
4. ad_slots 价格数据更新迁移

**Web 管理端：**
5. 新建 admin/platform-diamond.html + admin/src/modules/content/pages/platform-diamond.js
6. workspace.html 侧边栏增加"平台钻石"入口

### 第四批：商圈 + CPM + 调价（P1c，预计 7-10 天）

**数据库迁移：**
1. CREATE TABLE ad_target_zones（zone_id INT AUTO_INCREMENT PK, zone_type ENUM('district','region'), zone_name VARCHAR(100), priority INT DEFAULT 10, parent_zone_id INT NULL, geo_scope JSON, status ENUM('active','inactive') DEFAULT 'active', created_at, updated_at）
2. CREATE TABLE ad_zone_groups（group_id INT AUTO_INCREMENT PK, group_name VARCHAR(100), pricing_mode ENUM('sum','discount','fixed') DEFAULT 'sum', discount_rate DECIMAL(3,2) DEFAULT 1.00, fixed_price INT NULL, status ENUM('active','inactive'), created_at, updated_at）
3. CREATE TABLE ad_zone_group_members（id INT AUTO_INCREMENT PK, group_id INT REFERENCES ad_zone_groups, zone_id INT REFERENCES ad_target_zones, created_at）
4. ad_slots ADD COLUMN zone_id INT NULL REFERENCES ad_target_zones, slot_category ENUM('display','feed') DEFAULT 'display', cpm_price_diamond INT DEFAULT 0
5. ad_campaigns MODIFY billing_mode ENUM('fixed_daily','bidding','free','cpm')
6. AdSlot.VALID_SLOT_TYPES 扩展：在模型中增加 'feed'
7. CREATE TABLE ad_price_adjustment_logs（id INT AUTO_INCREMENT PK, trigger_type ENUM('dau_shift','manual'), old_coefficient DECIMAL, new_coefficient DECIMAL, affected_slots JSON, status ENUM('pending','confirmed','rejected','applied'), confirmed_by INT NULL, created_at, applied_at DATETIME NULL）
8. system_configs INSERT ad_price_adjustment_trigger 配置键

**后端服务：**
9. 新建 services/AdTargetZoneService.js（CRUD + 联合组 CRUD）
10. AdBiddingService.selectWinners 扩展地域匹配：用户 → 关联门店 → 门店的 administrative_region → 匹配 ad_target_zones → 按 priority 排序匹配广告位
11. CPM 曝光计数：广告展示时 Redis INCR `ad_cpm_count:{campaign_id}:{date}` + ad-cron-jobs.js 新增 01:15 每日归档任务
12. CPM 日结算：读取前日各 CPM 计划 Redis 计数 → Math.ceil(count / 1000 * cpm_price_diamond) → AdBillingService 创建 billing_type='cpm_deduct'
13. 调价触发任务（daily-price-adjustment-check.js，每日 02:00）：读 ad_dau_daily_stats 最近 N 天 → 是否连续处于新区间 → 写 ad_price_adjustment_logs（status='pending'）
14. 管理端 API：ad_target_zones CRUD + ad_zone_groups CRUD + ad_price_adjustment_logs 列表/确认/执行
15. INSERT ad_target_zones 初始数据：zone_type='region', zone_name='全站', priority=999（全站兜底）

**Web 管理端：**
16. 新建 admin/zone-management.html + JS（商圈/区域管理 + 联合组管理）
17. ad-management.js：slotForm 增加 zone_id 下拉、slot_category 选择、cpm_price_diamond 输入
18. ad-management.js：BILLING_MAP 增加 'cpm':'CPM曝光计费'，campaignForm 增加 CPM 相关字段
19. 调价历史 Tab（嵌入 ad-management 定价配置页或独立 Tab）

**小程序适配：**
20. 检查 /api/v4/system/ad-delivery 响应格式是否需要增加 zone 信息
21. 确认 /api/v4/system/ad-events 曝光上报接口是否满足 CPM 计数需求（已有路由，可能仅需确认字段）
