# ğŸ° é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ - æŠ€æœ¯æ–‡æ¡£

> **ç”Ÿæˆæ—¶é—´**: 2026å¹´1æœˆ28æ—¥  
> **æ•°æ®åº“**: dbconn.sealosbja.site:42569/restaurant_points_dev  
> **å¼•æ“ç‰ˆæœ¬**: UnifiedLotteryEngine V4.6

---

## ç›®å½•

1. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ä¸€ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
2. [æ ¸å¿ƒç®—æ³•æ¨¡å—](#äºŒæ ¸å¿ƒç®—æ³•æ¨¡å—)
3. [å®é™…è¿è¥æ•°æ®åˆ†æ](#ä¸‰å®é™…è¿è¥æ•°æ®åˆ†æ)
4. [æŠ€æœ¯æ¶æ„ç‰¹ç‚¹](#å››æŠ€æœ¯æ¶æ„ç‰¹ç‚¹)
5. [å•†ä¸šæ¨¡å¼æ€»ç»“](#äº”å•†ä¸šæ¨¡å¼æ€»ç»“)
6. [é¢„è®¾ä¸å¹²é¢„æœºåˆ¶](#å…­é¢„è®¾ä¸å¹²é¢„æœºåˆ¶-presetoverride)
7. [èµ„äº§ç³»ç»Ÿ](#ä¸ƒèµ„äº§ç³»ç»Ÿ-assetservice)
8. [å¥–å“å‘æ”¾æµç¨‹](#å…«å¥–å“å‘æ”¾æµç¨‹)
9. [é”™è¯¯å¤„ç†ä¸å›æ»šæœºåˆ¶](#ä¹é”™è¯¯å¤„ç†ä¸å›æ»šæœºåˆ¶)
10. [Redisç¼“å­˜å±‚](#åredis-ç¼“å­˜å±‚)
11. [APIæ¥å£è¯´æ˜](#åä¸€api-æ¥å£è¯´æ˜)
12. [è®¡ç®—å¼•æ“ç»„ä»¶è¯¦è§£](#åäºŒè®¡ç®—å¼•æ“ç»„ä»¶è¯¦è§£)
13. [çŠ¶æ€ç®¡ç†å™¨](#åä¸‰çŠ¶æ€ç®¡ç†å™¨)
14. [é¢„ç®—æä¾›è€…æ¨¡å¼](#åå››é¢„ç®—æä¾›è€…æ¨¡å¼)
15. [æœåŠ¡å±‚ç»„ä»¶](#åäº”æœåŠ¡å±‚ç»„ä»¶)
16. [é™„å½•](#é™„å½•)

---

## ä¸€ã€ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### 1.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UnifiedLotteryEngine V4.6                     â”‚
â”‚                      (ç»Ÿä¸€æŠ½å¥–å¼•æ“)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ServiceManagerâ”‚â”€â”€â”€â–¶â”‚        NormalDrawPipeline           â”‚  â”‚
â”‚  â”‚  (æœåŠ¡ç®¡ç†å™¨)  â”‚    â”‚         (ç»Ÿä¸€æµæ°´çº¿)                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                                      â”‚  â”‚
â”‚                      â”‚  Stage 1: LoadCampaignStage (åŠ è½½æ´»åŠ¨)â”‚  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  Stage 2: EligibilityStage (èµ„æ ¼æ£€æŸ¥) â”‚  â”‚
â”‚  â”‚DrawOrchestratorâ”‚â”€â”€â–¶â”‚  Stage 3: LoadDecisionSourceStage   â”‚  â”‚
â”‚  â”‚  (æŠ½å¥–ç¼–æ’å™¨)  â”‚    â”‚           (åŠ è½½å†³ç­–æº)              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  Stage 4: BudgetContextStage(é¢„ç®—ä¸Šä¸‹æ–‡)â”‚
â”‚                      â”‚  Stage 5: PricingStage (å®šä»·è®¡ç®—)     â”‚  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  Stage 6: BuildPrizePoolStage(æ„å»ºå¥–æ± )â”‚  â”‚
â”‚  â”‚ComputeEngine â”‚â”€â”€â”€â”€â–¶â”‚  Stage 7: GuaranteeStage (ä¿åº•æ£€æŸ¥)  â”‚  â”‚
â”‚  â”‚  (è®¡ç®—å¼•æ“)   â”‚    â”‚  Stage 8: TierPickStage (æ¡£ä½æŠ½å–)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  Stage 9: PrizePickStage (å¥–å“æŠ½å–)   â”‚  â”‚
â”‚                      â”‚  Stage 10: DecisionSnapshotStage     â”‚  â”‚
â”‚                      â”‚            (å†³ç­–å¿«ç…§)                â”‚  â”‚
â”‚                      â”‚  Stage 11: SettleStage (ç»“ç®—-å”¯ä¸€å†™)  â”‚  â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 Pipeline é˜¶æ®µä¸­è‹±å¯¹ç…§è¡¨

| åºå· | è‹±æ–‡åç§° | ä¸­æ–‡åç§° | è¯»/å†™ | åŠŸèƒ½æè¿° |
|------|----------|----------|-------|----------|
| 1 | LoadCampaignStage | åŠ è½½æ´»åŠ¨é˜¶æ®µ | è¯» | åŠ è½½æ´»åŠ¨é…ç½®ã€å¥–å“åˆ—è¡¨ã€æ¡£ä½è§„åˆ™ |
| 2 | EligibilityStage | èµ„æ ¼æ ¡éªŒé˜¶æ®µ | è¯» | æ£€æŸ¥ç”¨æˆ·èµ„æ ¼ï¼ˆç§¯åˆ†ã€é…é¢ã€çŠ¶æ€ï¼‰ |
| 3 | LoadDecisionSourceStage | å†³ç­–æ¥æºé˜¶æ®µ | è¯» | æ£€æŸ¥æ˜¯å¦æœ‰é¢„è®¾/å¹²é¢„ï¼ˆpreset/overrideï¼‰ |
| 4 | BudgetContextStage | é¢„ç®—è®¡ç®—é˜¶æ®µ | è¯» | è®¡ç®—ç”¨æˆ· Budget Tier (B0-B3) |
| 5 | PricingStage | ä»·æ ¼è®¡ç®—é˜¶æ®µ | è¯» | è®¡ç®—æŠ½å¥–æˆæœ¬ï¼ˆå•æŠ½/è¿æŠ½/æŠ˜æ‰£ï¼‰ |
| 6 | BuildPrizePoolStage | å¥–æ± æ„å»ºé˜¶æ®µ | è¯» | æ„å»ºå¯ç”¨å¥–å“æ± ï¼Œè®¡ç®— Pressure Tier |
| 7 | GuaranteeStage | ä¿åº•æœºåˆ¶é˜¶æ®µ | è¯» | æ£€æŸ¥ç¡¬ä¿åº•è§¦å‘æ¡ä»¶ï¼ˆNæ¬¡å¿…ä¸­ï¼‰ |
| 8 | TierPickStage | æ¡£ä½é€‰æ‹©é˜¶æ®µ | è¯» | åº”ç”¨ BxPx çŸ©é˜µ + ä½“éªŒå¹³æ»‘ â†’ æŠ½å–æ¡£ä½ |
| 9 | PrizePickStage | å¥–å“é€‰æ‹©é˜¶æ®µ | è¯» | æ¡£ä½å†…æŒ‰æƒé‡æŠ½å–å…·ä½“å¥–å“ |
| 10 | DecisionSnapshotStage | å†³ç­–è®°å½•é˜¶æ®µ | è¯» | è®°å½•å®Œæ•´å†³ç­–å¿«ç…§ï¼ˆå®¡è®¡ç”¨ï¼‰ |
| 11 | SettleStage | ç»“ç®—æ‰§è¡Œé˜¶æ®µ | **å†™** | æ‰£ç§¯åˆ†ã€å‘å¥–å“ã€æ›´æ–°çŠ¶æ€ã€è®°å½•æŒ‡æ ‡ |

> âš ï¸ **é‡è¦**: åªæœ‰ SettleStage æ˜¯å†™æ“ä½œï¼Œå…¶ä»– 10 ä¸ªé˜¶æ®µéƒ½æ˜¯åªè¯»æ“ä½œï¼Œç¡®ä¿äº‹åŠ¡ä¸€è‡´æ€§ã€‚

### 1.3 æ ¸å¿ƒæ–‡ä»¶ç»“æ„

```
services/
â”œâ”€â”€ index.js                           # ServiceManager æœåŠ¡ç®¡ç†å™¨
â”œâ”€â”€ UnifiedLotteryEngine/
â”‚   â”œâ”€â”€ UnifiedLotteryEngine.js        # ç»Ÿä¸€æŠ½å¥–å¼•æ“å…¥å£
â”‚   â”œâ”€â”€ DrawOrchestrator.js            # æŠ½å¥–ç¼–æ’å™¨
â”‚   â”œâ”€â”€ pipeline/
â”‚   â”‚   â”œâ”€â”€ NormalDrawPipeline.js      # ç»Ÿä¸€æŠ½å¥–æµæ°´çº¿
â”‚   â”‚   â”œâ”€â”€ PipelineRunner.js          # æµæ°´çº¿è¿è¡Œå™¨
â”‚   â”‚   â”œâ”€â”€ stages/
â”‚   â”‚   â”‚   â”œâ”€â”€ LoadCampaignStage.js       # åŠ è½½æ´»åŠ¨é…ç½®ï¼ˆåŠ è½½æ´»åŠ¨é˜¶æ®µï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ EligibilityStage.js        # èµ„æ ¼æ£€æŸ¥ï¼ˆèµ„æ ¼æ ¡éªŒé˜¶æ®µï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ LoadDecisionSourceStage.js # åŠ è½½å†³ç­–æºï¼ˆå†³ç­–æ¥æºé˜¶æ®µï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ BudgetContextStage.js      # é¢„ç®—ä¸Šä¸‹æ–‡ï¼ˆé¢„ç®—è®¡ç®—é˜¶æ®µï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ PricingStage.js            # å®šä»·è®¡ç®—ï¼ˆä»·æ ¼è®¡ç®—é˜¶æ®µï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ BuildPrizePoolStage.js     # æ„å»ºå¥–å“æ± ï¼ˆå¥–æ± æ„å»ºé˜¶æ®µï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ GuaranteeStage.js          # ä¿åº•æ£€æŸ¥ï¼ˆä¿åº•æœºåˆ¶é˜¶æ®µï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ TierPickStage.js           # æ¡£ä½æŠ½å–ï¼ˆæ¡£ä½é€‰æ‹©é˜¶æ®µï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ PrizePickStage.js          # å¥–å“æŠ½å–ï¼ˆå¥–å“é€‰æ‹©é˜¶æ®µï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ DecisionSnapshotStage.js   # å†³ç­–å¿«ç…§ï¼ˆå†³ç­–è®°å½•é˜¶æ®µï¼‰
â”‚   â”‚   â”‚   â””â”€â”€ SettleStage.js             # ç»“ç®—ï¼ˆç»“ç®—æ‰§è¡Œé˜¶æ®µ-å”¯ä¸€å†™æ“ä½œï¼‰
â”‚   â”‚   â””â”€â”€ budget/
â”‚   â”‚       â””â”€â”€ UserBudgetProvider.js  # ç”¨æˆ·é¢„ç®—æä¾›è€…
â”‚   â””â”€â”€ compute/
â”‚       â”œâ”€â”€ LotteryComputeEngine.js    # è®¡ç®—å¼•æ“ï¼ˆFacadeï¼‰
â”‚       â”œâ”€â”€ calculators/
â”‚       â”‚   â”œâ”€â”€ BudgetTierCalculator.js
â”‚       â”‚   â”œâ”€â”€ PressureTierCalculator.js
â”‚       â”‚   â”œâ”€â”€ TierMatrixCalculator.js
â”‚       â”‚   â””â”€â”€ PityCalculator.js
â”‚       â”œâ”€â”€ handlers/
â”‚       â”‚   â”œâ”€â”€ AntiEmptyStreakHandler.js
â”‚       â”‚   â””â”€â”€ AntiHighStreakHandler.js
â”‚       â””â”€â”€ state/
â”‚           â”œâ”€â”€ ExperienceStateManager.js
â”‚           â””â”€â”€ GlobalStateManager.js
â””â”€â”€ lottery/
    â”œâ”€â”€ LotteryQuotaService.js         # é…é¢æœåŠ¡
    â””â”€â”€ LotteryPricingService.js       # å®šä»·æœåŠ¡
```

---

## äºŒã€æ ¸å¿ƒç®—æ³•æ¨¡å—

### 2.1 æ¡£ä½æŠ½å–ç®—æ³• (TierPickStage)

#### é€‰å¥–æ–¹æ³•
- **æ–¹æ³•å**: `tier_first` (å…ˆæŠ½æ¡£ä½ï¼Œå†æŠ½å¥–å“)
- **æƒé‡ç³»ç»Ÿ**: æ•´æ•°æƒé‡åˆ¶ (SCALE = 1,000,000)

#### æ¡£ä½ä½“ç³»

| æ¡£ä½ | é»˜è®¤æƒé‡ | é»˜è®¤æ¦‚ç‡ | æè¿° |
|------|----------|----------|------|
| high | 50,000 | 5% | é«˜ä»·å€¼å¥–å“ |
| mid | 150,000 | 15% | ä¸­ç­‰ä»·å€¼å¥–å“ |
| low | 300,000 | 30% | ä½ä»·å€¼å¥–å“ |
| fallback | 500,000 | 50% | ä¿åº•/ç©ºå¥– |

#### ç”¨æˆ·åˆ†ç¾¤é…ç½® (å®é™…æ•°æ®åº“æ•°æ®)

```
æ´»åŠ¨#1 - åˆ†ç¾¤: default
    low        | æƒé‡:   800000 (80.00%)
    mid        | æƒé‡:   150000 (15.00%)
    high       | æƒé‡:    50000 (5.00%)

æ´»åŠ¨#1 - åˆ†ç¾¤: new_user
    low        | æƒé‡:   700000 (70.00%)
    mid        | æƒé‡:   200000 (20.00%)
    high       | æƒé‡:   100000 (10.00%)  â† æ–°ç”¨æˆ·é«˜æ¡£ä½æ¦‚ç‡ç¿»å€

æ´»åŠ¨#1 - åˆ†ç¾¤: vip_user
    low        | æƒé‡:   700000 (70.00%)
    mid        | æƒé‡:   220000 (22.00%)
    high       | æƒé‡:    80000 (8.00%)   â† VIPç”¨æˆ·ä¸­é«˜æ¡£ä½æå‡
```

#### é™çº§è·¯å¾„

å½“é€‰ä¸­æ¡£ä½æ— å¯ç”¨å¥–å“æ—¶ï¼Œè‡ªåŠ¨æŒ‰ä»¥ä¸‹è·¯å¾„é™çº§ï¼š

```
high â†’ mid â†’ low â†’ fallback
```

#### æ ¸å¿ƒç®—æ³•ä»£ç 

```javascript
// services/UnifiedLotteryEngine/pipeline/stages/TierPickStage.js

const WEIGHT_SCALE = 1000000
const TIER_DOWNGRADE_PATH = ['high', 'mid', 'low', 'fallback']

_pickTier(weights, random_value) {
  let cumulative = 0
  for (const tier of TIER_DOWNGRADE_PATH) {
    const weight = weights[tier] || 0
    cumulative += weight
    if (random_value < cumulative) {
      return tier
    }
  }
  return 'fallback'
}
```

---

### 2.2 BxPx é¢„ç®—å‹åŠ›çŸ©é˜µ (LotteryComputeEngine)

ç³»ç»Ÿæ ¹æ®ç”¨æˆ·é¢„ç®—çŠ¶æ€(B)å’Œæ´»åŠ¨é¢„ç®—å‹åŠ›(P)åŠ¨æ€è°ƒæ•´æ¦‚ç‡åˆ†å¸ƒã€‚

#### Budget Tier (é¢„ç®—åˆ†å±‚)

| åˆ†å±‚ | æ¡ä»¶ | æè¿° |
|------|------|------|
| B0 | balance < 100 | é¢„ç®—è€—å°½ |
| B1 | 100 â‰¤ balance < 500 | ä½é¢„ç®— |
| B2 | 500 â‰¤ balance < 1000 | ä¸­é¢„ç®— |
| B3 | balance â‰¥ 1000 | å……è¶³é¢„ç®— |

**é…ç½®æ¥æº** (lottery_strategy_config):
```
[budget_tier]
threshold_high: 1000
threshold_mid: 500
threshold_low: 100
```

#### Pressure Tier (å‹åŠ›åˆ†å±‚)

| åˆ†å±‚ | æ¡ä»¶ | æè¿° |
|------|------|------|
| P0 | å‰©ä½™é¢„ç®— > 50% | ä½å‹åŠ› |
| P1 | 20% < å‰©ä½™é¢„ç®— â‰¤ 50% | ä¸­å‹åŠ› |
| P2 | å‰©ä½™é¢„ç®— â‰¤ 20% | é«˜å‹åŠ› |

**é…ç½®æ¥æº** (lottery_strategy_config):
```
[pressure_tier]
threshold_high: 0.8
threshold_low: 0.5
```

#### çŸ©é˜µé…ç½® (å®é™…æ•°æ®åº“æ•°æ®)

```
         |    P0           |    P1           |    P2
---------+-----------------+-----------------+------------------
B0       | 10.00x / 0cap   | 10.00x / 0cap   | 10.00x / 0.3cap
B1       | 1.20x / 1cap    | 1.00x / 1cap    | 0.80x / 0.8cap
B2       | 1.00x / 1cap    | 0.90x / 1.3cap  | 0.70x / 0.9cap
B3       | 0.80x / 1cap    | 0.70x / 1cap    | 0.60x / 1cap
```

**å­—æ®µè¯´æ˜**:
- `empty_weight_multiplier`: ç©ºå¥–æƒé‡ä¹˜æ•° (è¶Šå¤§è¶Šå®¹æ˜“ç©ºå¥–)
- `cap_multiplier`: é«˜ä»·å€¼æ¡£ä½ä¸Šé™ä¹˜æ•°

**è§£è¯»ç¤ºä¾‹**:
- B0ç”¨æˆ·é¢„ç®—è€—å°½æ—¶ï¼Œç©ºå¥–æƒé‡ä¹˜10å€ï¼ŒåŸºæœ¬ä¸å¯èƒ½ä¸­é«˜ä»·å€¼å¥–å“
- B3ç”¨æˆ·é¢„ç®—å……è¶³æ—¶ï¼Œåœ¨P2é«˜å‹åŠ›ä¸‹ç©ºå¥–æƒé‡ä»…0.6å€ï¼Œæ›´å®¹æ˜“ä¸­å¥–

---

### 2.3 ä½“éªŒå¹³æ»‘æœºåˆ¶ (Experience Smoothing)

æ‰€æœ‰æœºåˆ¶å‡å·²**å…¨é‡å¯ç”¨** (rollout_percentage = 100%)

#### 2.3.1 Pity è½¯ä¿åº•ç³»ç»Ÿ

**åŠŸèƒ½**: è¿ç»­ç©ºå¥–æ¬¡æ•°è¶Šå¤šï¼Œéç©ºå¥–æ¦‚ç‡ä¹˜æ•°è¶Šé«˜

**é…ç½®** (lottery_strategy_config):
```javascript
[pity]
enabled: true
hard_guarantee_threshold: 10    // ç¡¬ä¿åº•é˜ˆå€¼ï¼ˆ10æ¬¡å¿…ä¸­ï¼‰
min_non_empty_cost: 10
multiplier_table: {
  "0": 1.0,   // 0æ¬¡ç©ºå¥–ï¼šæ­£å¸¸æ¦‚ç‡
  "1": 1.0,
  "2": 1.2,   // 2æ¬¡ç©ºå¥–ï¼šæ¦‚ç‡Ã—1.2
  "3": 1.5,
  "4": 1.8,
  "5": 2.2,
  "6": 2.8,
  "7": 3.5,
  "8": 4.5,
  "9": 6.0   // 9æ¬¡ç©ºå¥–ï¼šæ¦‚ç‡Ã—6
}
```

**è§¦å‘é€»è¾‘**:
```javascript
// services/UnifiedLotteryEngine/compute/calculators/PityCalculator.js
calculatePityMultiplier(emptyStreak) {
  const table = this.config.multiplier_table
  return table[Math.min(emptyStreak, 9)] || 1
}
```

#### 2.3.2 Anti-Empty Streak (é˜²è¿ç»­ç©ºå¥–)

**åŠŸèƒ½**: è¿ç»­ç©ºå¥–è¾¾åˆ°é˜ˆå€¼åï¼Œå¼ºåˆ¶è§¦å‘éç©ºå¥–

**é…ç½®**:
```javascript
[anti_empty]
enabled: true
empty_streak_threshold: 3  // è¿ç»­3æ¬¡ç©ºå¥–åå¼ºåˆ¶éç©º
```

**è§¦å‘é€»è¾‘**:
```javascript
// services/UnifiedLotteryEngine/compute/handlers/AntiEmptyStreakHandler.js
shouldForceNonEmpty(context) {
  return context.empty_streak >= this.threshold
}
```

#### 2.3.3 Anti-High Streak (é˜²è¿ç»­é«˜ä»·å€¼)

**åŠŸèƒ½**: æœ€è¿‘Næ¬¡æŠ½å¥–ä¸­é«˜ä»·å€¼è¶…è¿‡é˜ˆå€¼ï¼Œé™ä½é«˜ä»·å€¼æ¦‚ç‡

**é…ç½®**:
```javascript
[anti_high]
enabled: true
high_streak_threshold: 2    // é«˜ä»·å€¼æ¬¡æ•°é˜ˆå€¼
recent_draw_window: 5       // è§‚å¯Ÿçª—å£ï¼ˆæœ€è¿‘5æ¬¡ï¼‰
```

**è§¦å‘é€»è¾‘**:
```javascript
// services/UnifiedLotteryEngine/compute/handlers/AntiHighStreakHandler.js
shouldCapHighTier(context) {
  const recentHighCount = context.recent_high_count
  return recentHighCount >= this.high_streak_threshold
}
```

#### 2.3.4 Luck Debt (è¿æ°”å€ºåŠ¡)

**åŠŸèƒ½**: å†å²ç©ºå¥–ç‡é«˜äºæœŸæœ›å€¼æ—¶ï¼Œç´¯ç§¯è¿æ°”å€ºåŠ¡ï¼Œæé«˜éç©ºå¥–æ¦‚ç‡è¡¥å¿

**é…ç½®**:
```javascript
[luck_debt]
enabled: true
expected_empty_rate: 0.3    // æœŸæœ›ç©ºå¥–ç‡30%
min_draw_count: 10          // æœ€å°‘10æ¬¡æŠ½å¥–åç”Ÿæ•ˆ
```

**è®¡ç®—é€»è¾‘**:
```javascript
// services/UnifiedLotteryEngine/compute/LotteryComputeEngine.js
getLuckDebtMultiplier(params) {
  const { historical_empty_rate, expected_rate } = params
  if (historical_empty_rate > expected_rate) {
    // ç©ºå¥–ç‡è¶Šé«˜äºæœŸæœ›ï¼Œè¡¥å¿ä¹˜æ•°è¶Šå¤§
    const debt_ratio = historical_empty_rate / expected_rate
    return 1 + (debt_ratio - 1) * 0.5  // çº¿æ€§è¡¥å¿
  }
  return 1
}
```

---

### 2.4 å®šä»·ç³»ç»Ÿ (PricingStage)

#### å®šä»·é…ç½®ç»“æ„

```json
{
  "base_cost": 10,           // åŸºç¡€å•æŠ½æˆæœ¬
  "draw_buttons": [
    {
      "count": 1,
      "label": "å•æŠ½",
      "discount": 1,         // æ— æŠ˜æ‰£
      "enabled": true,
      "sort_order": 1
    },
    {
      "count": 3,
      "label": "3è¿æŠ½",
      "discount": 1,
      "enabled": true,
      "sort_order": 3
    },
    {
      "count": 5,
      "label": "5è¿æŠ½",
      "discount": 1,
      "enabled": true,
      "sort_order": 5
    },
    {
      "count": 10,
      "label": "10è¿æŠ½(8æŠ˜)",
      "discount": 0.8,       // 8æŠ˜ä¼˜æƒ 
      "enabled": true,
      "sort_order": 10
    }
  ]
}
```

#### è®¡ç®—å…¬å¼

```
å®é™…æˆæœ¬ = base_cost Ã— count Ã— discount

ç¤ºä¾‹ï¼ˆæ´»åŠ¨#1ï¼‰:
- å•æŠ½:   10 Ã— 1 Ã— 1.0 = 10 ç§¯åˆ†
- 3è¿æŠ½:  10 Ã— 3 Ã— 1.0 = 30 ç§¯åˆ†
- 5è¿æŠ½:  10 Ã— 5 Ã— 1.0 = 50 ç§¯åˆ†
- 10è¿æŠ½: 10 Ã— 10 Ã— 0.8 = 80 ç§¯åˆ† (èŠ‚çœ20ç§¯åˆ†)
```

---

### 2.5 é…é¢æ§åˆ¶ç³»ç»Ÿ (LotteryQuotaService)

#### å››ç»´åº¦ä¼˜å…ˆçº§é“¾

```
ç”¨æˆ·çº§ (priority=100) > è§’è‰²çº§ (priority=80) > æ´»åŠ¨çº§ (priority=50) > å…¨å±€ (priority=10)
```

#### å®é™…é…ç½® (lottery_draw_quota_rules)

| èŒƒå›´ç±»å‹ | èŒƒå›´ID | çª—å£ç±»å‹ | é™åˆ¶å€¼ | ä¼˜å…ˆçº§ |
|----------|--------|----------|--------|--------|
| campaign | 1 | daily | 20,000 | 50 |
| campaign | 27 | daily | 20,000 | 50 |
| global | global | daily | 20,000 | 10 |

#### é…é¢æ£€æŸ¥æµç¨‹

```javascript
// services/lottery/LotteryQuotaService.js
async checkAndDeductQuota(user_id, campaign_id, draw_count) {
  // 1. æŒ‰ä¼˜å…ˆçº§æŸ¥æ‰¾é€‚ç”¨çš„é…é¢è§„åˆ™
  const rule = await this.findApplicableRule(user_id, campaign_id)
  
  // 2. è·å–æˆ–åˆå§‹åŒ–ç”¨æˆ·å½“æ—¥é…é¢
  const quota = await this.getOrInitDailyQuota(user_id, campaign_id)
  
  // 3. åŸå­æ‰£å‡é…é¢ (UPDATE ... WHERE remaining >= draw_count)
  const result = await this.atomicDeduct(quota, draw_count)
  
  return result
}
```

---

### 2.6 å†³ç­–æµç¨‹å›¾

```
ç”¨æˆ·å‘èµ·æŠ½å¥–è¯·æ±‚
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1: LoadCampaignStage (åŠ è½½æ´»åŠ¨) â”‚
â”‚ åŠ è½½æ´»åŠ¨é…ç½®ã€å¥–å“åˆ—è¡¨ã€æ¡£ä½è§„åˆ™       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 2: EligibilityStage (èµ„æ ¼æ£€æŸ¥)  â”‚
â”‚ æ£€æŸ¥ç”¨æˆ·èµ„æ ¼ï¼ˆç§¯åˆ†ã€é…é¢ã€çŠ¶æ€ï¼‰       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 3: LoadDecisionSourceStage (å†³ç­–æº) â”‚
â”‚ æ£€æŸ¥æ˜¯å¦æœ‰é¢„è®¾/å¹²é¢„ï¼ˆpreset/overrideï¼‰     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚ å†³ç­–æº? â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚
   â”Œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”
   â–¼     â–¼     â–¼
preset override normal
   â”‚     â”‚     â”‚
   â”‚     â”‚     â–¼
   â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚     â”‚  â”‚ Stage 4: BudgetContextStage (é¢„ç®—ä¸Šä¸‹æ–‡)â”‚
   â”‚     â”‚  â”‚ è®¡ç®— Budget Tier (B0-B3)               â”‚
   â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚     â”‚                   â–¼
   â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚     â”‚  â”‚ Stage 5: PricingStage (å®šä»·è®¡ç®—)        â”‚
   â”‚     â”‚  â”‚ è®¡ç®—æŠ½å¥–æˆæœ¬                           â”‚
   â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚     â”‚                   â–¼
   â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚     â”‚  â”‚ Stage 6: BuildPrizePoolStage (æ„å»ºå¥–æ± ) â”‚
   â”‚     â”‚  â”‚ æ„å»ºå¯ç”¨å¥–å“æ± ï¼Œè®¡ç®— Pressure Tier     â”‚
   â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚     â”‚                   â–¼
   â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚     â”‚  â”‚ Stage 7: GuaranteeStage (ä¿åº•æ£€æŸ¥)      â”‚
   â”‚     â”‚  â”‚ æ£€æŸ¥ç¡¬ä¿åº•è§¦å‘æ¡ä»¶                     â”‚
   â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚     â”‚                   â–¼
   â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚     â”‚  â”‚ Stage 8: TierPickStage (æ¡£ä½æŠ½å–)       â”‚
   â”‚     â”‚  â”‚ åº”ç”¨ BxPx çŸ©é˜µ + ä½“éªŒå¹³æ»‘ â†’ æŠ½å–æ¡£ä½   â”‚
   â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚     â”‚                   â–¼
   â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚     â”‚  â”‚ Stage 9: PrizePickStage (å¥–å“æŠ½å–)      â”‚
   â”‚     â”‚  â”‚ æ¡£ä½å†…æŒ‰æƒé‡æŠ½å–å…·ä½“å¥–å“               â”‚
   â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚     â”‚           â”‚
   â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Stage 10: DecisionSnapshotStage (å†³ç­–å¿«ç…§)â”‚
         â”‚ è®°å½•å®Œæ•´å†³ç­–å¿«ç…§ï¼ˆå®¡è®¡ç”¨ï¼‰                â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Stage 11: SettleStage (ç»“ç®—)ã€å”¯ä¸€å†™æ“ä½œã€‘â”‚
         â”‚ - æ‰£å‡ç”¨æˆ·ç§¯åˆ†                           â”‚
         â”‚ - åˆ›å»ºæŠ½å¥–è®°å½•                           â”‚
         â”‚ - æ‰£å‡å¥–å“åº“å­˜                           â”‚
         â”‚ - å‘æ”¾å¥–å“                               â”‚
         â”‚ - æ›´æ–°ä½“éªŒçŠ¶æ€                           â”‚
         â”‚ - è®°å½•ç›‘æ§æŒ‡æ ‡                           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€å®é™…è¿è¥æ•°æ®åˆ†æ

### 3.1 æ´»åŠ¨é…ç½®æ¦‚è§ˆ

| æ´»åŠ¨ID | æ´»åŠ¨åç§° | æ´»åŠ¨ä»£ç  | é¢„ç®—æ¨¡å¼ | å•æŠ½æˆæœ¬ | æ¯æ—¥é™åˆ¶ |
|--------|----------|----------|----------|----------|----------|
| 1 | é¤å…ç§¯åˆ†æŠ½å¥– | BASIC_LOTTERY | none | 100 | 20,000 |
| 25 | èµ°èµ°èµ° | CAMP_1769298977641_853LKG | user | 10 | 3 |
| 26 | å†æ‰¾æ‰¾ | CAMP_1769299553926_MRXZNB | user | 10 | 3 |
| 27 | 12312 | CAMP_1769347406486_TUS05A | user | 10 | 3 |

### 3.2 å¥–å“é…ç½® (æ´»åŠ¨#1)

| æ¡£ä½ | å¥–å“æ•° | æƒé‡æ€»å’Œ | å¹³å‡ä»·å€¼(ç§¯åˆ†) |
|------|--------|----------|----------------|
| high | 4 | 1,000,000 | 188 |
| mid | 4 | 1,000,000 | 40 |
| low | 7 | 1,000,000 | 0 |

**å¥–å“è¯¦æƒ… (Top 10)**:

| å¥–å“ID | åç§° | æ¡£ä½ | æƒé‡ | ä»·å€¼ | åº“å­˜ |
|--------|------|------|------|------|------|
| 6 | 500ç§¯åˆ†åˆ¸ | high | 700,000 | 400 | 247 |
| 2 | 100ç§¯åˆ† | mid | 400,000 | 80 | 501 |
| 3 | ç”œå“1ä»½ | mid | 350,000 | 60 | 696 |
| 4 | é’èœ1ä»½ | low | 240,000 | 0 | 9,929 |
| 9 | ä¹å…«æŠ˜åˆ¸ | high | 200,000 | 100 | 360 |
| 7 | ç²¾å“é¦–é¥°ä¸€ä¸ª | mid | 150,000 | 10 | 9,995 |
| 114 | ç¥ç§˜å½©è›‹ | low | 130,000 | 0 | 49,969 |
| 118 | ä¸‹æ¬¡å¥½è¿ | low | 130,000 | 0 | 49,949 |
| 5 | 2000ç§¯åˆ†åˆ¸ | high | 90,000 | 150 | 9,953 |
| 1 | å…«å…«æŠ˜ | high | 10,000 | 100 | 9,859 |

### 3.3 æœ€è¿‘30å¤©ç»Ÿè®¡

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| æ€»æŠ½å¥–æ¬¡æ•° | 2,380 æ¬¡ |
| ç‹¬ç«‹ç”¨æˆ·æ•° | 1 äºº |
| ä¿åº•è§¦å‘æ¬¡æ•° | 258 æ¬¡ |
| æ€»æ¶ˆè€—ç§¯åˆ† | 36,210 |
| æ€»å¥–å“ä»·å€¼ | 243,080 |
| **æŠ•å…¥äº§å‡ºæ¯”** | **671%** |

### 3.4 æ¡£ä½åˆ†å¸ƒ

| æ¡£ä½ | æ¬¡æ•° | å æ¯” |
|------|------|------|
| fallback | 1,411 | 59.29% |
| high | 907 | 38.11% |
| mid | 51 | 2.14% |
| low | 11 | 0.46% |

### 3.5 åŠŸèƒ½å¼€å…³çŠ¶æ€

| åŠŸèƒ½ | çŠ¶æ€ | ç°åº¦æ¯”ä¾‹ |
|------|------|----------|
| lottery_pity_system | âœ… å¯ç”¨ | 100% |
| lottery_luck_debt | âœ… å¯ç”¨ | 100% |
| lottery_anti_empty_streak | âœ… å¯ç”¨ | 100% |
| lottery_anti_high_streak | âœ… å¯ç”¨ | 100% |
| lottery_bxpx_matrix | âœ… å¯ç”¨ | 100% |
| lottery_budget_tier | âœ… å¯ç”¨ | 100% |
| lottery_pressure_tier | âœ… å¯ç”¨ | 100% |

### 3.6 ç”¨æˆ·ä½“éªŒçŠ¶æ€

**æ´»åŠ¨#1**:
- ç”¨æˆ·æ•°: 1
- å¹³å‡ç©ºå¥–è¿å‡»: 0.00
- æœ€å¤§ç©ºå¥–è¿å‡»: 6
- Pityè§¦å‘æ€»æ¬¡æ•°: 0

**å…¨å±€ç»Ÿè®¡**:
- ç”¨æˆ·æ€»æ•°: 1
- å¹³å‡å†å²ç©ºå¥–ç‡: 0.00%
- å¹³å‡è¿æ°”å€ºåŠ¡ä¹˜æ•°: 1.0000

### 3.7 ç›‘æ§æŒ‡æ ‡æ±‡æ€»

**æ´»åŠ¨#1 å†å²æ±‡æ€»**:
- æ€»æŠ½å¥–: 2,419 æ¬¡
- æ¡£ä½åˆ†å¸ƒ: high=940, mid=52, low=0, fallback=1,427
- æœºåˆ¶è§¦å‘: Pity=0, AntiEmpty=0, AntiHigh=0

---

## å››ã€æŠ€æœ¯æ¶æ„ç‰¹ç‚¹

### 4.1 Pipeline æ¶æ„

æ‰€æœ‰æŠ½å¥–é€»è¾‘é€šè¿‡ Stage ä¸²è”æ‰§è¡Œï¼ŒèŒè´£åˆ†ç¦»æ¸…æ™°ï¼š

```javascript
// services/UnifiedLotteryEngine/pipeline/NormalDrawPipeline.js
class NormalDrawPipeline extends PipelineRunner {
  _initializeStages() {
    this.addStage(new LoadCampaignStage())
    this.addStage(new EligibilityStage())
    this.addStage(new LoadDecisionSourceStage())
    this.addStage(new BudgetContextStage())
    this.addStage(new PricingStage())
    this.addStage(new BuildPrizePoolStage())
    this.addStage(new GuaranteeStage())
    this.addStage(new TierPickStage())
    this.addStage(new PrizePickStage())
    this.addStage(new DecisionSnapshotStage())
    this.addStage(new SettleStage())  // å”¯ä¸€å†™æ“ä½œ
  }
}
```

### 4.2 Single Writer Principle

åªæœ‰ `SettleStage` æ‰§è¡Œå†™æ“ä½œï¼Œä¿è¯äº‹åŠ¡ä¸€è‡´æ€§ï¼š

```javascript
// services/UnifiedLotteryEngine/pipeline/stages/SettleStage.js
class SettleStage extends BaseStage {
  constructor() {
    super('SettleStage', {
      is_writer: true,  // æ ‡è®°ä¸ºå†™æ“ä½œ Stage
      required: true
    })
  }
  
  async execute(context) {
    // æ‰€æœ‰å†™æ“ä½œåœ¨åŒä¸€äº‹åŠ¡ä¸­æ‰§è¡Œ
    const transaction = context.transaction || await sequelize.transaction()
    
    try {
      await this._deductPrizeStock(prize, transaction)
      await this._deductBudget(budget_provider, amount, { transaction })
      await this._distributePrize(user_id, prize, { transaction })
      await this._createDrawRecord({ ..., transaction })
      await this._createDecisionRecord({ ..., transaction })
      await this._updateUserQuota(user_id, campaign_id, transaction)
      await this._updateExperienceState({ ..., transaction })
      await this._recordHourlyMetrics({ ..., transaction })
      
      await transaction.commit()
    } catch (error) {
      await transaction.rollback()
      throw error
    }
  }
}
```

### 4.3 å¹‚ç­‰æ€§è®¾è®¡

é€šè¿‡ `idempotency_key` é˜²æ­¢é‡å¤æŠ½å¥–ï¼š

```javascript
// å¹‚ç­‰é”®æ´¾ç”Ÿè§„åˆ™
const idempotency_key = `lottery_${user_id}_${session_id}_${timestamp}`

// æ¶ˆè€—ç§¯åˆ†å¹‚ç­‰é”®
const consume_idempotency_key = `${idempotency_key}:consume`

// å¥–å“å‘æ”¾å¹‚ç­‰é”®
const reward_idempotency_key = `${idempotency_key}:reward_${index}`
```

### 4.4 Feature Flag ç°åº¦

æ‰€æœ‰ä½“éªŒå¹³æ»‘æœºåˆ¶æ”¯æŒç°åº¦å‘å¸ƒï¼š

```javascript
// services/UnifiedLotteryEngine/compute/LotteryComputeEngine.js
async checkFeatureWithFeatureFlag(feature, user_id, options = {}) {
  const FeatureFlagService = require('../../FeatureFlagService')
  return await FeatureFlagService.isEnabled(feature, {
    user_id,
    ...options
  })
}
```

### 4.5 ç›‘æ§åŸ‹ç‚¹

- **å°æ—¶çº§èšåˆ**: `lottery_hourly_metrics` è¡¨
- **Redis å®æ—¶å±‚**: ä½å»¶è¿ŸæŸ¥è¯¢

```javascript
// SettleStage ä¸­çš„ç›‘æ§è®°å½•
await this._recordHourlyMetrics({
  campaign_id,
  draw_tier,
  prize_value,
  budget_tier,
  mechanisms,
  transaction
})

// å¼‚æ­¥è®°å½•åˆ° Redis
this._recordRealtimeMetrics({
  campaign_id,
  user_id,
  selected_tier,
  prize_value,
  budget_tier,
  triggers
})
```

### 4.6 åŒ—äº¬æ—¶é—´æ ‡å‡†åŒ–

å…¨ç³»ç»Ÿç»Ÿä¸€ä½¿ç”¨ `Asia/Shanghai` æ—¶åŒºï¼š

```javascript
// config/database.js
const dbConfig = {
  timezone: '+08:00',
  dialectOptions: {
    timezone: '+08:00'
  }
}

// utils/timeHelper.js
class BeijingTimeHelper {
  static createBeijingTime() {
    return new Date().toLocaleString('zh-CN', { 
      timeZone: 'Asia/Shanghai' 
    })
  }
}
```

---

## äº”ã€å•†ä¸šæ¨¡å¼æ€»ç»“

### 5.1 æ ¸å¿ƒä¸šåŠ¡æµç¨‹

```
ç”¨æˆ·æ¶ˆè´¹ â†’ ç§¯ç´¯ç§¯åˆ† â†’ ç§¯åˆ†æŠ½å¥– â†’ è·å¾—å¥–å“ â†’ å…‘æ¢/ä½¿ç”¨
    â†‘                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  ä¿ƒè¿›å†æ¬¡æ¶ˆè´¹
```

### 5.2 æŠ½å¥–æ¶ˆè´¹æ¨¡å‹

| æŠ½å¥–æ–¹å¼ | æˆæœ¬ | æŠ˜æ‰£ | å®é™…æ”¯ä»˜ |
|----------|------|------|----------|
| å•æŠ½ | 10ç§¯åˆ† | æ—  | 10ç§¯åˆ† |
| 3è¿æŠ½ | 30ç§¯åˆ† | æ—  | 30ç§¯åˆ† |
| 5è¿æŠ½ | 50ç§¯åˆ† | æ—  | 50ç§¯åˆ† |
| 10è¿æŠ½ | 100ç§¯åˆ† | 8æŠ˜ | 80ç§¯åˆ† |

### 5.3 æ¦‚ç‡è°ƒæ§æœºåˆ¶

é€šè¿‡ BxPx çŸ©é˜µ + ä½“éªŒå¹³æ»‘æœºåˆ¶ï¼Œå®ç°ï¼š

1. **é¢„ç®—ä¿æŠ¤**: ç”¨æˆ·/æ´»åŠ¨é¢„ç®—ç´§å¼ æ—¶ï¼Œæé«˜ç©ºå¥–æ¦‚ç‡
2. **ç”¨æˆ·ä½“éªŒ**: Pity ç³»ç»Ÿç¡®ä¿ä¸ä¼šè¿ç»­å¤ªå¤šæ¬¡ç©ºå¥–
3. **é£é™©æ§åˆ¶**: Anti-High é˜²æ­¢è¿ç»­ä¸­é«˜ä»·å€¼å¥–å“
4. **å…¬å¹³è¡¥å¿**: Luck Debt å¯¹å†å²ç©ºå¥–ç‡é«˜çš„ç”¨æˆ·è¿›è¡Œè¡¥å¿

### 5.4 é¢„ç®—æ¨¡å¼

| æ¨¡å¼ | æè¿° | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| none | æ— é¢„ç®—æ§åˆ¶ | å›ºå®šæˆæœ¬æ´»åŠ¨ |
| user | ç”¨æˆ·é¢„ç®— | ä¸ªäººè´¦æˆ·é¢„ç®— |
| pool_quota | é…é¢æ±  | æ´»åŠ¨æ€»é…é¢é™åˆ¶ |

### 5.5 å¥–å“ç±»å‹

| ç±»å‹ | æè¿° | å‘æ”¾æ–¹å¼ |
|------|------|----------|
| points | ç§¯åˆ†å¥–å“ | å¢åŠ ç”¨æˆ·ç§¯åˆ†ä½™é¢ |
| coupon | ä¼˜æƒ åˆ¸ | å†™å…¥ item_instances |
| physical | å®ç‰©å•†å“ | å†™å…¥ item_instances |
| virtual | è™šæ‹Ÿèµ„äº§ | å¢åŠ ææ–™èµ„äº§ä½™é¢ |

---

## å…­ã€é¢„è®¾ä¸å¹²é¢„æœºåˆ¶ (Preset/Override)

### 6.1 å†³ç­–ä¼˜å…ˆçº§ä½“ç³»

ç³»ç»Ÿæ”¯æŒ 4 ç§å†³ç­–æ¥æºï¼ŒæŒ‰ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼š

| ä¼˜å…ˆçº§ | å†³ç­–ç±»å‹ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|--------|----------|------|----------|
| 1 | **Presetï¼ˆé¢„è®¾ï¼‰** | è¿è¥é¢„å…ˆæŒ‡å®šç”¨æˆ·å¿…ä¸­æŸå¥–å“ | VIPç¤¼é‡ã€æ´»åŠ¨è¡¥å¿ã€æ–°ç”¨æˆ·å¼•å¯¼ |
| 2 | **Overrideï¼ˆå¹²é¢„ï¼‰** | ç®¡ç†å‘˜ä¸´æ—¶æŒ‡å®šç»“æœ | é—®é¢˜ç”¨æˆ·å¤„ç†ã€ç‰¹æ®Šæƒ…å†µå¹²é¢„ |
| 3 | **Guaranteeï¼ˆä¿åº•ï¼‰** | è¾¾åˆ°é˜ˆå€¼è‡ªåŠ¨è§¦å‘ä¿åº• | Næ¬¡å¿…ä¸­æœºåˆ¶ |
| 4 | **Normalï¼ˆæ­£å¸¸ï¼‰** | èµ°æ­£å¸¸æ¦‚ç‡è®¡ç®— | å¸¸è§„æŠ½å¥– |

### 6.2 é¢„è®¾æœºåˆ¶ (Preset)

**æ•°æ®è¡¨**: `lottery_presets`

```sql
-- é¢„è®¾è®°å½•ç¤ºä¾‹
INSERT INTO lottery_presets 
  (user_id, campaign_id, prize_id, status, created_by)
VALUES 
  (12345, 1, 5, 'pending', 'admin_001');

-- status: pending(å¾…ä½¿ç”¨) / used(å·²ä½¿ç”¨) / expired(å·²è¿‡æœŸ)
```

**å·¥ä½œæµç¨‹**:
```
è¿è¥åå°è®¾ç½®é¢„è®¾ â†’ ç”¨æˆ·æŠ½å¥–æ—¶æ£€æµ‹ â†’ å‘½ä¸­åˆ™è·³è¿‡æ¦‚ç‡è®¡ç®— â†’ ç›´æ¥è¿”å›é¢„è®¾å¥–å“ â†’ æ ‡è®°é¢„è®¾ä¸ºå·²ä½¿ç”¨
```

### 6.3 ç®¡ç†å¹²é¢„ (Override)

**æ•°æ®è¡¨**: `lottery_management_settings`

**å¹²é¢„ç±»å‹**:

| ç±»å‹ | è¯´æ˜ |
|------|------|
| `force_win` | å¼ºåˆ¶ä¸­å¥–ï¼ˆæŒ‡å®šæ¡£ä½æˆ–å¥–å“ï¼‰ |
| `force_lose` | å¼ºåˆ¶ä¸ä¸­ï¼ˆè¿”å›fallbackï¼‰ |
| `probability_adjust` | æ¦‚ç‡è°ƒæ•´ï¼ˆä¹˜æ•°ä¿®æ­£ï¼‰ |
| `user_queue` | ç”¨æˆ·é˜Ÿåˆ—æ§åˆ¶ |

**ç®¡ç†åå°æ¥å£**:
- `POST /api/v4/console/lottery-management/force-control` - è®¾ç½®å¼ºåˆ¶ä¸­å¥–/ä¸ä¸­
- `POST /api/v4/console/lottery-management/adjustment` - æ¦‚ç‡è°ƒæ•´
- `GET /api/v4/console/lottery-management/user-status` - æŸ¥çœ‹ç”¨æˆ·å¹²é¢„çŠ¶æ€

---

## ä¸ƒã€èµ„äº§ç³»ç»Ÿ (AssetService)

### 7.1 æ ¸å¿ƒèƒ½åŠ›

| æ–¹æ³• | åŠŸèƒ½ | è¯´æ˜ |
|------|------|------|
| `getOrCreateAccount` | è·å–/åˆ›å»ºè´¦æˆ· | æ”¯æŒç”¨æˆ·è´¦æˆ·å’Œç³»ç»Ÿè´¦æˆ· |
| `getOrCreateBalance` | è·å–/åˆ›å»ºèµ„äº§ä½™é¢ | æŒ‰èµ„äº§ç±»å‹ç®¡ç† |
| `changeBalance` | æ”¹å˜å¯ç”¨ä½™é¢ | æ”¯æŒå¹‚ç­‰æ€§ã€äº‹åŠ¡ä¿æŠ¤ |
| `freeze` | å†»ç»“èµ„äº§ | äº¤æ˜“å¸‚åœºè´­ä¹°ã€èµ„äº§æŒ‚ç‰Œ |
| `unfreeze` | è§£å†»èµ„äº§ | è®¢å•å–æ¶ˆã€è¶…æ—¶è§£é” |
| `settleFromFrozen` | ä»å†»ç»“ç»“ç®— | è®¢å•å®Œæˆæ—¶ä½¿ç”¨ |
| `mintItem` | å‘æ”¾ç‰©å“ | å†™å…¥ item_instances è¡¨ |

### 7.2 èµ„äº§ç±»å‹

| èµ„äº§ä»£ç  | è¯´æ˜ | ç”¨é€” |
|----------|------|------|
| `POINTS` | ç”¨æˆ·ç§¯åˆ† | æŠ½å¥–æ¶ˆè€—ã€å¥–åŠ±å‘æ”¾ |
| `BUDGET_POINTS` | é¢„ç®—ç§¯åˆ† | æ´»åŠ¨é¢„ç®—æ§åˆ¶ |
| `DIAMOND` | é’»çŸ³ | é«˜çº§è™šæ‹Ÿè´§å¸ |
| ææ–™ç±» | å„ç±»ææ–™èµ„äº§ | å…‘æ¢ã€åˆæˆ |

### 7.3 äº‹åŠ¡è¾¹ç•Œæ²»ç†

**å¼ºåˆ¶è§„åˆ™**: æ‰€æœ‰èµ„äº§æ“ä½œå¿…é¡»åœ¨äº‹åŠ¡å†…æ‰§è¡Œ

```javascript
// âœ… æ­£ç¡®ç”¨æ³•
await TransactionManager.execute(async (transaction) => {
  await AssetService.changeBalance({
    user_id,
    asset_code: 'POINTS',
    delta_amount: -100,
    idempotency_key: 'xxx'
  }, { transaction })
})

// âŒ é”™è¯¯ç”¨æ³• - ä¼šæŠ›å‡º TRANSACTION_REQUIRED é”™è¯¯
await AssetService.changeBalance({ ... })  // ç¼ºå°‘ transaction
```

---

## å…«ã€å¥–å“å‘æ”¾æµç¨‹

### 8.1 SettleStage ä¸­çš„å‘æ”¾é€»è¾‘

```javascript
async _distributePrize(user_id, prize, options) {
  const { idempotency_key, lottery_session_id, transaction } = options

  switch (prize.prize_type) {
    case 'points':
      // ç§¯åˆ†å¥–å“ï¼šå¢åŠ ç”¨æˆ·ç§¯åˆ†
      await AssetService.changeBalance({
        user_id,
        asset_code: 'POINTS',
        delta_amount: parseInt(prize.prize_value),
        idempotency_key: `${idempotency_key}:points`,
        business_type: 'lottery_reward'
      }, { transaction })
      break

    case 'coupon':
    case 'physical':
      // ä¼˜æƒ åˆ¸/å®ç‰©ï¼šå†™å…¥ item_instances
      await AssetService.mintItem({
        user_id,
        item_type: prize.prize_type === 'coupon' ? 'voucher' : 'product',
        source_type: 'lottery',
        source_id: `${idempotency_key}:item`,
        meta: { name: prize.prize_name, ... }
      }, { transaction })
      break

    case 'virtual':
      // è™šæ‹Ÿèµ„äº§ï¼šå¢åŠ ææ–™ä½™é¢
      await AssetService.changeBalance({
        user_id,
        asset_code: prize.material_asset_code,
        delta_amount: prize.material_amount,
        idempotency_key: `${idempotency_key}:material`
      }, { transaction })
      break
  }
}
```

### 8.2 å¥–å“å‘æ”¾ç±»å‹æ±‡æ€»

| å¥–å“ç±»å‹ | å‘æ”¾æ–¹æ³• | ç›®æ ‡è¡¨ | å¹‚ç­‰é”® |
|----------|----------|--------|--------|
| points | `changeBalance` | account_asset_balances | `{key}:points` |
| coupon | `mintItem` | item_instances | `{key}:item` |
| physical | `mintItem` | item_instances | `{key}:item` |
| virtual | `changeBalance` | account_asset_balances | `{key}:material` |

---

## ä¹ã€é”™è¯¯å¤„ç†ä¸å›æ»šæœºåˆ¶

### 9.1 äº‹åŠ¡ä¿æŠ¤

æ‰€æœ‰å†™æ“ä½œåœ¨ SettleStage ä¸­é€šè¿‡ **å•ä¸€äº‹åŠ¡** æ‰§è¡Œï¼š

```javascript
const transaction = context.transaction || await sequelize.transaction()

try {
  // 1. æ‰£å‡ç”¨æˆ·ç§¯åˆ†
  // 2. æ‰£å‡å¥–å“åº“å­˜
  // 3. æ‰£å‡æ´»åŠ¨é¢„ç®—
  // 4. å‘æ”¾å¥–å“
  // 5. åˆ›å»ºæŠ½å¥–è®°å½•
  // 6. æ›´æ–°ç”¨æˆ·é…é¢
  // 7. æ›´æ–°ä½“éªŒçŠ¶æ€
  // 8. è®°å½•ç›‘æ§æŒ‡æ ‡
  
  await transaction.commit()
} catch (error) {
  await transaction.rollback()  // ä»»ä¸€å¤±è´¥ï¼Œå…¨éƒ¨å›æ»š
  throw error
}
```

### 9.2 å¹‚ç­‰æ€§ä¿æŠ¤

**é˜²æ­¢é‡å¤æŠ½å¥–**:

```javascript
// å…¥å£æ£€æŸ¥
const existing_draw = await this._checkIdempotency(idempotency_key)
if (existing_draw) {
  return { is_duplicate: true, data: existing_draw }
}

// å¹‚ç­‰é”®æ´¾ç”Ÿï¼ˆæ¯æ¡æµæ°´ç‹¬ç«‹ï¼‰
const consume_key = `${idempotency_key}:consume`      // ç§¯åˆ†æ‰£å‡
const reward_key = `${idempotency_key}:reward_${i}`   // å¥–å“å‘æ”¾
```

### 9.3 é”™è¯¯ç±»å‹ä¸å¤„ç†

| é”™è¯¯ç±»å‹ | é”™è¯¯ç  | å¤„ç†æ–¹å¼ |
|----------|--------|----------|
| ç§¯åˆ†ä¸è¶³ | `INSUFFICIENT_BALANCE` | ç›´æ¥æ‹’ç»ï¼Œè¿”å›400 |
| åº“å­˜ä¸è¶³ | `INSUFFICIENT_STOCK` | å›æ»šäº‹åŠ¡ï¼Œé™çº§é€‰æ‹© |
| é…é¢è¶…é™ | `QUOTA_EXCEEDED` | ç›´æ¥æ‹’ç»ï¼Œè¿”å›400 |
| å¹‚ç­‰å†²çª | `IDEMPOTENCY_CONFLICT` | è¿”å›409ï¼Œæç¤ºkeyå†²çª |
| äº‹åŠ¡è¾¹ç•Œ | `TRANSACTION_REQUIRED` | å†…éƒ¨é”™è¯¯ï¼Œ500 |

---

## åã€Redis ç¼“å­˜å±‚

### 10.1 ç¼“å­˜æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åº”ç”¨å±‚                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  L1 å†…å­˜ç¼“å­˜     â”‚    â”‚  L2 Redis ç¼“å­˜  â”‚                â”‚
â”‚  â”‚  (è¿›ç¨‹å†…)        â”‚    â”‚  (åˆ†å¸ƒå¼)       â”‚                â”‚
â”‚  â”‚  TTL: 5åˆ†é’Ÿ      â”‚    â”‚  TTL: 60ç§’      â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚           â”‚                       â”‚                          â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                       â–¼                                      â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚              â”‚    MySQL æ•°æ®åº“  â”‚                            â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.2 ç¼“å­˜ä½¿ç”¨åœºæ™¯

| ç¼“å­˜ç±»å‹ | æ•°æ®å†…å®¹ | TTL | ä½¿ç”¨ä½ç½® |
|----------|----------|-----|----------|
| **æ´»åŠ¨é…ç½®ç¼“å­˜** | campaign + prizes + tier_rules | 60ç§’ | `UnifiedLotteryEngine.getCampaignConfig()` |
| **ç­–ç•¥é…ç½®ç¼“å­˜** | lottery_strategy_config | 5åˆ†é’Ÿ | `DynamicConfigLoader` |
| **çŸ©é˜µé…ç½®ç¼“å­˜** | lottery_tier_matrix_config | 5åˆ†é’Ÿ | `DynamicConfigLoader` |
| **ç®¡ç†è®¾ç½®ç¼“å­˜** | ç”¨æˆ·å¹²é¢„çŠ¶æ€ | 5åˆ†é’Ÿ | `ManagementStrategy` |
| **å®æ—¶æŒ‡æ ‡** | æŠ½å¥–ç»Ÿè®¡ | 25å°æ—¶ | `LotteryMetricsCollector` |

### 10.3 BusinessCacheHelper

```javascript
// utils/BusinessCacheHelper.js
class BusinessCacheHelper {
  // è·å–æ´»åŠ¨é…ç½®ï¼ˆä¼˜å…ˆ Redisï¼‰
  static async getLotteryCampaign(campaign_id) {
    const key = `lottery:campaign:${campaign_id}`
    const cached = await redis.get(key)
    return cached ? JSON.parse(cached) : null
  }

  // å†™å…¥æ´»åŠ¨é…ç½®ï¼ˆ60ç§’ TTLï¼‰
  static async setLotteryCampaign(campaign_id, config) {
    const key = `lottery:campaign:${campaign_id}`
    await redis.setex(key, 60, JSON.stringify(config))
  }
}
```

### 10.4 Redis å®æ—¶æŒ‡æ ‡

```javascript
// SettleStage ä¸­å¼‚æ­¥è®°å½•
this._recordRealtimeMetrics({
  campaign_id,
  user_id,
  selected_tier,
  prize_value,
  budget_tier,
  mechanisms
}).catch(error => {
  // Redis å¤±è´¥ä¸å½±å“ä¸»ä¸šåŠ¡ï¼ˆfire-and-forgetï¼‰
  this.log('warn', 'Redis å®æ—¶æŒ‡æ ‡è®°å½•å¤±è´¥', { error })
})
```

---

## åä¸€ã€API æ¥å£è¯´æ˜

### 11.1 æŠ½å¥–æ‰§è¡Œæ¥å£

```
POST /api/v4/lottery/draw
```

**è¯·æ±‚å¤´**:
| Header | å¿…å¡« | è¯´æ˜ |
|--------|------|------|
| `Authorization` | âœ… | Bearer Token |
| `Idempotency-Key` | âœ… | å¹‚ç­‰é”®ï¼ˆå®¢æˆ·ç«¯ç”Ÿæˆï¼‰ |

**è¯·æ±‚ä½“**:
```json
{
  "campaign_code": "BASIC_LOTTERY",
  "draw_count": 1
}
```

**å“åº”**:
```json
{
  "success": true,
  "code": "SUCCESS",
  "data": {
    "draws": [{
      "draw_id": "draw_20260128_12345_abc123",
      "prize": {
        "prize_id": 5,
        "prize_name": "100ç§¯åˆ†",
        "reward_tier": "mid"
      },
      "cost": 10
    }],
    "summary": {
      "total_draws": 1,
      "total_cost": 10,
      "remaining_points": 990
    }
  }
}
```

### 11.2 ä¸»è¦ API åˆ—è¡¨

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/v4/lottery/draw` | POST | æ‰§è¡ŒæŠ½å¥– |
| `/api/v4/lottery/campaigns` | GET | è·å–æ´»åŠ¨åˆ—è¡¨ |
| `/api/v4/lottery/campaigns/:id` | GET | è·å–æ´»åŠ¨è¯¦æƒ… |
| `/api/v4/lottery/history` | GET | è·å–æŠ½å¥–å†å² |
| `/api/v4/lottery/user-points` | GET | è·å–ç”¨æˆ·ç§¯åˆ† |

### 11.3 ç®¡ç†åå° API

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/v4/console/lottery-configs` | GET/POST | æ´»åŠ¨é…ç½®ç®¡ç† |
| `/api/v4/console/lottery-presets` | GET/POST | é¢„è®¾ç®¡ç† |
| `/api/v4/console/lottery-tier-rules` | GET/POST | æ¡£ä½è§„åˆ™ç®¡ç† |
| `/api/v4/console/lottery-quota` | GET/POST | é…é¢è§„åˆ™ç®¡ç† |
| `/api/v4/console/lottery-monitoring` | GET | å®æ—¶ç›‘æ§æ•°æ® |
| `/api/v4/console/lottery-strategy-stats` | GET | ç­–ç•¥ç»Ÿè®¡ |
| `/api/v4/console/lottery-management/force-control` | POST | å¼ºåˆ¶å¹²é¢„ |
| `/api/v4/console/lottery-management/interventions` | GET | å¹²é¢„è®°å½• |

### 11.4 å¹¶å‘æ§åˆ¶

| æœºåˆ¶ | é…ç½® | è¯´æ˜ |
|------|------|------|
| **è¯·æ±‚å»é‡** | 5ç§’çª—å£ | ç›¸åŒè¯·æ±‚è¿”å›"å¤„ç†ä¸­" |
| **é™æµä¿æŠ¤** | 20æ¬¡/åˆ†é’Ÿ/ç”¨æˆ· | è¶…é™è¿”å› 429 |
| **å¹‚ç­‰ä¿æŠ¤** | Header å¿…å¡« | ç¼ºå¤±è¿”å› 400 |

---

## åäºŒã€è®¡ç®—å¼•æ“ç»„ä»¶è¯¦è§£

### 12.1 LotteryComputeEngine æ¶æ„

è®¡ç®—å¼•æ“æ˜¯æ‰€æœ‰ç­–ç•¥è®¡ç®—çš„ **Facadeï¼ˆé—¨é¢ï¼‰**ï¼Œæ•´åˆ 7 ä¸ªç‹¬ç«‹è®¡ç®—å™¨ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   LotteryComputeEngine                      â”‚
â”‚                      (è®¡ç®—å¼•æ“é—¨é¢)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚BudgetTierCalculatorâ”‚ â”‚PressureTierCalculatorâ”‚            â”‚
â”‚  â”‚  (é¢„ç®—åˆ†å±‚è®¡ç®—)    â”‚  â”‚  (æ´»åŠ¨å‹åŠ›åˆ†å±‚)    â”‚              â”‚
â”‚  â”‚  B0/B1/B2/B3      â”‚  â”‚  P0/P1/P2         â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚           â”‚                      â”‚                         â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                      â–¼                                      â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚           â”‚ TierMatrixCalculator â”‚                          â”‚
â”‚           â”‚  (BxPxçŸ©é˜µæƒé‡è®¡ç®—)   â”‚                          â”‚
â”‚           â”‚  12ç§ç»„åˆæƒé‡è°ƒæ•´     â”‚                          â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                      â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚                   â”‚                   â”‚                 â”‚
â”‚  â–¼                   â–¼                   â–¼                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚ â”‚PityCalculatorâ”‚ â”‚LuckDebtCalc  â”‚ â”‚AntiEmptyHandler â”‚      â”‚
â”‚ â”‚ (Pityä¿åº•)   â”‚ â”‚ (è¿æ°”å€ºåŠ¡)   â”‚ â”‚ (é˜²ç©ºå¥–è¿å‡»)    â”‚      â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                         â”‚                   â”‚
â”‚                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚                               â”‚AntiHighHandler  â”‚          â”‚
â”‚                               â”‚ (é˜²é«˜ä»·å€¼è¿å‡»)  â”‚          â”‚
â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.2 ä¸ƒå¤§è®¡ç®—å™¨èŒè´£

| è®¡ç®—å™¨ | åŠŸèƒ½ | è¾“å…¥ | è¾“å‡º |
|--------|------|------|------|
| **BudgetTierCalculator** | é¢„ç®—åˆ†å±‚è®¡ç®— | ç”¨æˆ·é¢„ç®—ä½™é¢ | B0/B1/B2/B3 |
| **PressureTierCalculator** | æ´»åŠ¨å‹åŠ›åˆ†å±‚ | æ´»åŠ¨é¢„ç®—æ¶ˆè€—ç‡ | P0/P1/P2 |
| **TierMatrixCalculator** | BxPxçŸ©é˜µæƒé‡ | Budget+Pressure Tier | æƒé‡è°ƒæ•´ç³»æ•° |
| **PityCalculator** | è½¯ä¿åº•/ç¡¬ä¿åº• | ç©ºå¥–è¿å‡»æ¬¡æ•° | ä¿åº•ä¹˜æ•°/è§¦å‘æ ‡è®° |
| **LuckDebtCalculator** | è¿æ°”å€ºåŠ¡è¡¥å¿ | å†å²ç©ºå¥–ç‡ | å€ºåŠ¡ä¹˜æ•° |
| **AntiEmptyStreakHandler** | é˜²ç©ºå¥–è¿å‡» | è¿ç»­ç©ºå¥–æ¬¡æ•° | å¼ºåˆ¶é«˜tieræ ‡è®° |
| **AntiHighStreakHandler** | é˜²é«˜ä»·å€¼è¿å‡» | è¿ç»­é«˜ä»·å€¼æ¬¡æ•° | å¼ºåˆ¶é™tieræ ‡è®° |

### 12.3 è®¡ç®—å™¨ä»£ç ä½ç½®

```
services/UnifiedLotteryEngine/compute/
â”œâ”€â”€ calculators/
â”‚   â”œâ”€â”€ BudgetTierCalculator.js
â”‚   â”œâ”€â”€ PressureTierCalculator.js
â”‚   â”œâ”€â”€ TierMatrixCalculator.js
â”‚   â”œâ”€â”€ PityCalculator.js
â”‚   â”œâ”€â”€ LuckDebtCalculator.js
â”‚   â”œâ”€â”€ AntiEmptyStreakHandler.js
â”‚   â””â”€â”€ AntiHighStreakHandler.js
â”œâ”€â”€ config/
â”‚   â””â”€â”€ StrategyConfig.js          # ç­–ç•¥é…ç½®åŠ è½½å™¨
â”œâ”€â”€ state/
â”‚   â”œâ”€â”€ ExperienceStateManager.js  # ç”¨æˆ·ä½“éªŒçŠ¶æ€ç®¡ç†
â”‚   â””â”€â”€ GlobalStateManager.js      # ç”¨æˆ·å…¨å±€çŠ¶æ€ç®¡ç†
â””â”€â”€ LotteryComputeEngine.js        # è®¡ç®—å¼•æ“é—¨é¢
```

---

## åä¸‰ã€çŠ¶æ€ç®¡ç†å™¨

### 13.1 ExperienceStateManagerï¼ˆä½“éªŒçŠ¶æ€ç®¡ç†å™¨ï¼‰

**æ•°æ®è¡¨**: `lottery_user_experience_state`

**ç®¡ç†å­—æ®µ**:

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `empty_streak` | INT | å½“å‰ç©ºå¥–è¿å‡»è®¡æ•° |
| `high_streak` | INT | å½“å‰é«˜ä»·å€¼è¿å‡»è®¡æ•° |
| `max_empty_streak` | INT | å†å²æœ€å¤§ç©ºå¥–è¿å‡» |
| `pity_trigger_count` | INT | Pity è§¦å‘æ€»æ¬¡æ•° |
| `pity_progress` | DECIMAL | Pity è¿›åº¦å€¼ |
| `last_high_tier_at` | DATETIME | æœ€è¿‘ä¸€æ¬¡é«˜ä»·å€¼å¥–å“æ—¶é—´ |
| `last_draw_at` | DATETIME | æœ€è¿‘ä¸€æ¬¡æŠ½å¥–æ—¶é—´ |

**æ›´æ–°æ—¶æœº**: SettleStage ç»“ç®—æ—¶è°ƒç”¨

```javascript
// SettleStage ä¸­æ›´æ–°ä½“éªŒçŠ¶æ€
await this._updateExperienceState({
  user_id,
  campaign_id,
  selected_tier,      // æœ¬æ¬¡ä¸­å¥–æ¡£ä½
  is_high_tier,       // æ˜¯å¦é«˜ä»·å€¼
  pity_triggered,     // Pity æ˜¯å¦è§¦å‘
  anti_empty_triggered,
  anti_high_triggered,
  transaction
})
```

### 13.2 GlobalStateManagerï¼ˆå…¨å±€çŠ¶æ€ç®¡ç†å™¨ï¼‰

**æ•°æ®è¡¨**: `lottery_user_global_state`

**ç®¡ç†å­—æ®µ**:

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `global_draw_count` | INT | å…¨å±€æŠ½å¥–æ€»æ¬¡æ•°ï¼ˆè·¨æ´»åŠ¨ï¼‰ |
| `global_empty_count` | INT | å…¨å±€ç©ºå¥–æ€»æ¬¡æ•° |
| `historical_empty_rate` | DECIMAL | å†å²ç©ºå¥–ç‡ |
| `luck_debt_level` | VARCHAR | è¿æ°”å€ºåŠ¡ç­‰çº§ (none/low/medium/high) |
| `luck_debt_multiplier` | DECIMAL | è¿æ°”å€ºåŠ¡è¡¥å¿ä¹˜æ•° |

**Luck Debt è®¡ç®—å…¬å¼**:

```javascript
// è¿æ°”å€ºåŠ¡è®¡ç®—é€»è¾‘
const expected_empty_rate = 0.3  // æœŸæœ›ç©ºå¥–ç‡ 30%
const historical_empty_rate = global_empty_count / global_draw_count
const debt_ratio = historical_empty_rate / expected_empty_rate

// å€ºåŠ¡ç­‰çº§åˆ¤å®š
if (debt_ratio > 1.5) luck_debt_level = 'high'      // è¡¥å¿ 1.3x
else if (debt_ratio > 1.2) luck_debt_level = 'medium' // è¡¥å¿ 1.15x
else if (debt_ratio > 1.0) luck_debt_level = 'low'    // è¡¥å¿ 1.05x
else luck_debt_level = 'none'                         // æ— è¡¥å¿
```

---

## åå››ã€é¢„ç®—æä¾›è€…æ¨¡å¼

### 14.1 é¢„ç®—æ¨¡å¼åˆ†ç±»

ç³»ç»Ÿæ”¯æŒ 4 ç§é¢„ç®—æ¨¡å¼ï¼Œé€šè¿‡ `BudgetProviderFactory` å·¥å‚åˆ›å»ºï¼š

| æ¨¡å¼ | ç±»å | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| `user` | UserBudgetProvider | ç”¨æˆ·ä¸ªäººé¢„ç®— | ç”¨æˆ·è‡ªä¸»å……å€¼æŠ½å¥– |
| `pool` | PoolBudgetProvider | æ´»åŠ¨å¥–æ± é¢„ç®— | å•†å®¶æ´»åŠ¨é¢„ç®—æ§åˆ¶ |
| `pool_quota` | PoolQuotaBudgetProvider | å¥–æ± +ä¸ªäººé…é¢ | é™å®šæ¯äººæŠ½å¥–æ¬¡æ•° |
| `none` | BudgetProvider | æ— é¢„ç®—é™åˆ¶ | å…è´¹æ´»åŠ¨ |

### 14.2 é¢„ç®—æä¾›è€…æ¥å£

```javascript
// BudgetProvider åŸºç±»æ¥å£
class BudgetProvider {
  // è·å–å¯ç”¨é¢„ç®—
  async getAvailableBudget({ user_id, campaign_id }) { }
  
  // æ‰£å‡é¢„ç®—
  async deductBudget({ user_id, campaign_id, amount, reason, reference_id }, { transaction }) { }
  
  // é¢„ç®—å›æ»šï¼ˆå–æ¶ˆæŠ½å¥–æ—¶ï¼‰
  async rollbackBudget({ user_id, campaign_id, amount, reference_id }, { transaction }) { }
}
```

### 14.3 é¢„ç®—æ¨¡å¼å·¥ä½œæµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     BudgetProviderFactory                        â”‚
â”‚                                                                  â”‚
â”‚  campaign.budget_mode = ?                                        â”‚
â”‚         â”‚                                                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚    â–¼         â–¼            â–¼                â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚user â”‚  â”‚pool â”‚    â”‚pool_quotaâ”‚    â”‚    none     â”‚           â”‚
â”‚  â””â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚     â”‚        â”‚             â”‚                 â”‚                   â”‚
â”‚     â–¼        â–¼             â–¼                 â–¼                   â”‚
â”‚  ç”¨æˆ·è´¦æˆ·  æ´»åŠ¨å¥–æ±      å¥–æ± +é…é¢          æ— é™åˆ¶               â”‚
â”‚  ä½™é¢æ‰£å‡  é¢„ç®—æ‰£å‡     åŒé‡æ‰£å‡          ç›´æ¥é€šè¿‡              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åäº”ã€æœåŠ¡å±‚ç»„ä»¶

### 15.1 æŠ½å¥–ç›¸å…³æœåŠ¡æ¸…å•

| æœåŠ¡ç±» | èŒè´£ | è·¯å¾„ |
|--------|------|------|
| **UnifiedLotteryEngine** | ç»Ÿä¸€æŠ½å¥–å¼•æ“å…¥å£ | `services/UnifiedLotteryEngine/` |
| **LotteryQuotaService** | é…é¢ç®¡ç† | `services/lottery/LotteryQuotaService.js` |
| **LotteryPricingService** | å®šä»·è®¡ç®— | `services/lottery/LotteryPricingService.js` |
| **LotteryHistoryService** | å†å²è®°å½•æŸ¥è¯¢ | `services/lottery/LotteryHistoryService.js` |
| **LotteryUserService** | ç”¨æˆ·æŠ½å¥–æ•°æ® | `services/lottery/LotteryUserService.js` |
| **LotteryPresetService** | é¢„è®¾ç®¡ç† | `services/LotteryPresetService.js` |
| **LotteryConfigService** | æ´»åŠ¨é…ç½®ç®¡ç† | `services/LotteryConfigService.js` |
| **LotteryTierRuleService** | æ¡£ä½è§„åˆ™ç®¡ç† | `services/LotteryTierRuleService.js` |
| **LotteryAnalyticsService** | æ•°æ®åˆ†æ | `services/LotteryAnalyticsService.js` |
| **LotteryMetricsCollector** | Redis å®æ—¶æŒ‡æ ‡é‡‡é›† | `services/LotteryMetricsCollector.js` |
| **AdminLotteryService** | ç®¡ç†åå°æœåŠ¡ | `services/AdminLotteryService.js` |
| **PrizePoolService** | å¥–å“æ± ç®¡ç† | `services/PrizePoolService.js` |

### 15.2 æœåŠ¡é—´è°ƒç”¨å…³ç³»

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ UnifiedLotteryEngine â”‚
                    â”‚    (ç»Ÿä¸€å…¥å£)        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                    â”‚                    â”‚
          â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LotteryQuotaServiceâ”‚ â”‚LotteryPricingServiceâ”‚ â”‚AssetService    â”‚
â”‚  (é…é¢æ£€æŸ¥/æ‰£å‡)   â”‚ â”‚  (æˆæœ¬è®¡ç®—)        â”‚ â”‚ (ç§¯åˆ†æ‰£å‡/å‘æ”¾)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                    â”‚                    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                    â”‚                    â”‚
          â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚LotteryHistoryServiceâ”‚ â”‚LotteryMetricsCollectorâ”‚ â”‚LotteryPresetServiceâ”‚
â”‚  (å†å²è®°å½•)        â”‚ â”‚  (Redis å®æ—¶æŒ‡æ ‡)   â”‚ â”‚  (é¢„è®¾ç®¡ç†)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é™„å½•

### A. å®Œæ•´æ•°æ®è¡¨æ¸…å•ï¼ˆ19å¼ æŠ½å¥–ç›¸å…³è¡¨ï¼‰

| è¡¨å | æè¿° | ç±»å‹ |
|------|------|------|
| **lottery_campaigns** | æŠ½å¥–æ´»åŠ¨é…ç½® | é…ç½®è¡¨ |
| **lottery_prizes** | å¥–å“é…ç½® | é…ç½®è¡¨ |
| **lottery_tier_rules** | æ¡£ä½è§„åˆ™ | é…ç½®è¡¨ |
| **lottery_campaign_pricing_config** | å®šä»·é…ç½® | é…ç½®è¡¨ |
| **lottery_draw_quota_rules** | é…é¢è§„åˆ™ | é…ç½®è¡¨ |
| **lottery_tier_matrix_config** | BxPxçŸ©é˜µé…ç½® | é…ç½®è¡¨ |
| **lottery_strategy_config** | ç­–ç•¥å¼•æ“é…ç½® | é…ç½®è¡¨ |
| **lottery_draws** | æŠ½å¥–è®°å½• | ä¸šåŠ¡è¡¨ |
| **lottery_draw_decisions** | å†³ç­–å¿«ç…§ | ä¸šåŠ¡è¡¨ |
| **lottery_presets** | é¢„è®¾é˜Ÿåˆ— | ä¸šåŠ¡è¡¨ |
| **lottery_management_settings** | ç®¡ç†å¹²é¢„è®¾ç½® | ä¸šåŠ¡è¡¨ |
| **lottery_clear_setting_records** | æ¸…ç†è®¾ç½®è®°å½• | ä¸šåŠ¡è¡¨ |
| **lottery_user_daily_draw_quota** | ç”¨æˆ·æ¯æ—¥é…é¢ | çŠ¶æ€è¡¨ |
| **lottery_campaign_user_quota** | æ´»åŠ¨ç”¨æˆ·é…é¢ | çŠ¶æ€è¡¨ |
| **lottery_campaign_quota_grants** | é…é¢æˆäºˆè®°å½• | çŠ¶æ€è¡¨ |
| **lottery_user_experience_state** | ç”¨æˆ·ä½“éªŒçŠ¶æ€ | çŠ¶æ€è¡¨ |
| **lottery_user_global_state** | ç”¨æˆ·å…¨å±€çŠ¶æ€ | çŠ¶æ€è¡¨ |
| **lottery_hourly_metrics** | å°æ—¶çº§ç›‘æ§æŒ‡æ ‡ | ç»Ÿè®¡è¡¨ |
| **lottery_daily_metrics** | æ—¥çº§ç›‘æ§æŒ‡æ ‡ | ç»Ÿè®¡è¡¨ |

### B. æ ¸å¿ƒé…ç½®è¡¨

#### lottery_strategy_config

| config_group | config_key | config_value | è¯´æ˜ |
|--------------|------------|--------------|------|
| anti_empty | empty_streak_threshold | 3 | ç©ºå¥–è¿å‡»é˜ˆå€¼ |
| anti_empty | enabled | true | é˜²ç©ºå¥–å¼€å…³ |
| anti_high | enabled | true | é˜²é«˜ä»·å€¼è¿å‡»å¼€å…³ |
| anti_high | high_streak_threshold | 2 | é«˜ä»·å€¼è¿å‡»é˜ˆå€¼ |
| anti_high | recent_draw_window | 5 | æ£€æŸ¥çª—å£å¤§å° |
| budget_tier | threshold_high | 1000 | B3 é˜ˆå€¼ï¼ˆâ‰¥1000ï¼‰ |
| budget_tier | threshold_mid | 500 | B2 é˜ˆå€¼ï¼ˆ500-999ï¼‰ |
| budget_tier | threshold_low | 100 | B1 é˜ˆå€¼ï¼ˆ100-499ï¼‰ |
| luck_debt | enabled | true | è¿æ°”å€ºåŠ¡å¼€å…³ |
| luck_debt | expected_empty_rate | 0.3 | æœŸæœ›ç©ºå¥–ç‡ 30% |
| luck_debt | min_draw_count | 10 | æœ€å°æŠ½å¥–æ¬¡æ•°è§¦å‘ |
| pity | enabled | true | Pity ä¿åº•å¼€å…³ |
| pity | hard_guarantee_threshold | 10 | ç¡¬ä¿åº•é˜ˆå€¼ï¼ˆ10æ¬¡å¿…ä¸­ï¼‰ |
| pressure_tier | threshold_high | 0.8 | P2 é˜ˆå€¼ï¼ˆæ¶ˆè€—>80%ï¼‰ |
| pressure_tier | threshold_low | 0.5 | P1 é˜ˆå€¼ï¼ˆæ¶ˆè€—>50%ï¼‰ |

### C. å…³é”®æ¨¡å‹å…³è”å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ•°æ®æ¨¡å‹å…³è”                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚    User      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   Account    â”‚                          â”‚
â”‚  â”‚   (ç”¨æˆ·)     â”‚  1:1    â”‚   (è´¦æˆ·)     â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚         â”‚                        â”‚                                   â”‚
â”‚         â”‚ 1:N                    â”‚ 1:N                               â”‚
â”‚         â–¼                        â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ LotteryDraw  â”‚         â”‚AccountAssetBalanceâ”‚                      â”‚
â”‚  â”‚ (æŠ½å¥–è®°å½•)   â”‚         â”‚  (èµ„äº§ä½™é¢)       â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚         â”‚                                                            â”‚
â”‚         â”‚ 1:1                                                        â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚  â”‚ LotteryDrawDecision â”‚                                             â”‚
â”‚  â”‚   (å†³ç­–å¿«ç…§)        â”‚                                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚             â”‚                                                        â”‚
â”‚             â”‚ N:1                                                    â”‚
â”‚             â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  LotteryCampaign â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   LotteryPrize   â”‚                  â”‚
â”‚  â”‚    (æ´»åŠ¨é…ç½®)    â”‚   1:N   â”‚    (å¥–å“é…ç½®)    â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚         â”‚                                                            â”‚
â”‚         â”‚ 1:N                                                        â”‚
â”‚         â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚  LotteryTierRule â”‚                                               â”‚
â”‚  â”‚   (æ¡£ä½è§„åˆ™)     â”‚                                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### D. æ ¸å¿ƒä»£ç å…¥å£

| åŠŸèƒ½ | æ–‡ä»¶è·¯å¾„ |
|------|----------|
| **æŠ½å¥–å¼•æ“ä¸»å…¥å£** | `services/UnifiedLotteryEngine/UnifiedLotteryEngine.js` |
| **Pipeline æµæ°´çº¿** | `services/UnifiedLotteryEngine/pipeline/NormalDrawPipeline.js` |
| **æŠ½å¥–ç¼–æ’å™¨** | `services/UnifiedLotteryEngine/pipeline/DrawOrchestrator.js` |
| **è®¡ç®—å¼•æ“** | `services/UnifiedLotteryEngine/compute/LotteryComputeEngine.js` |
| **ç­–ç•¥é…ç½®** | `services/UnifiedLotteryEngine/compute/config/StrategyConfig.js` |
| **ç»“ç®—Stage** | `services/UnifiedLotteryEngine/pipeline/stages/SettleStage.js` |
| **æ¡£ä½æŠ½å–Stage** | `services/UnifiedLotteryEngine/pipeline/stages/TierPickStage.js` |
| **å¥–å“æŠ½å–Stage** | `services/UnifiedLotteryEngine/pipeline/stages/PrizePickStage.js` |
| **æœåŠ¡ç®¡ç†å™¨** | `services/index.js` |
| **æŠ½å¥–APIè·¯ç”±** | `routes/v4/lottery/draw.js` |

### E. é…ç½®å¸¸é‡

```javascript
// æ¡£ä½æƒé‡æ¯”ä¾‹ï¼ˆä¸‡åˆ†æ¯”ï¼‰
const WEIGHT_SCALE = 10000

// Budget Tier é˜ˆå€¼
const BUDGET_TIER_THRESHOLDS = {
  B3: 1000,  // é«˜é¢„ç®—
  B2: 500,   // ä¸­é¢„ç®—
  B1: 100    // ä½é¢„ç®—
  // B0: < 100 é¢„ç®—è€—å°½
}

// Pressure Tier é˜ˆå€¼ï¼ˆæ¶ˆè€—æ¯”ä¾‹ï¼‰
const PRESSURE_TIER_THRESHOLDS = {
  P2: 0.8,   // é«˜å‹åŠ›ï¼ˆæ¶ˆè€—>80%ï¼‰
  P1: 0.5    // ä¸­å‹åŠ›ï¼ˆæ¶ˆè€—>50%ï¼‰
  // P0: < 50% ä½å‹åŠ›
}

// ä½“éªŒæœºåˆ¶é»˜è®¤é…ç½®
const EXPERIENCE_DEFAULTS = {
  pity_hard_threshold: 10,      // 10æ¬¡ç¡¬ä¿åº•
  empty_streak_threshold: 3,    // 3æ¬¡ç©ºå¥–è§¦å‘
  high_streak_threshold: 2,     // 2æ¬¡é«˜ä»·å€¼è§¦å‘
  expected_empty_rate: 0.3,     // æœŸæœ›30%ç©ºå¥–
  luck_debt_min_draws: 10       // 10æ¬¡åå¯ç”¨å€ºåŠ¡
}

// ç¼“å­˜ TTL
const CACHE_TTL = {
  L1_MEMORY: 5 * 60 * 1000,     // 5åˆ†é’Ÿ
  L2_REDIS: 60,                  // 60ç§’
  STRATEGY_CONFIG: 5 * 60 * 1000 // 5åˆ†é’Ÿ
}
```

---

*æŠ¥å‘Šç”Ÿæˆå·¥å…·: `scripts/analyze-algorithm-system.js`*  
*æœ€åæ›´æ–°: 2026å¹´1æœˆ28æ—¥*

