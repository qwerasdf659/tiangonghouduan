# 抽奖平台统一架构设计方案

> **文档版本**: V1.0  
> **创建时间**: 2026-01-16  
> **状态**: 架构设计（可直接进入开发）

---

## 一、文档目的

本文档将以下四份需求文档的核心诉求统一到一套 **Pipeline（管线）架构** 中：

| 来源文档                          | 核心需求                                   |
| --------------------------------- | ------------------------------------------ |
| `奖品配置与抽奖关系.md`           | 预算过滤、概率抽取、成本控制、保底机制     |
| `抽奖概率归一化与档位设计方案.md` | 解决概率缺口、归一化/显式缺口/先档位后奖品 |
| `预算模型-总池配额方案.md`        | pool+quota 双层预算、白名单预授权、预留池  |
| `预设强制发放-系统垫付方案.md`    | 预设奖品强制发放、库存/预算欠账记录        |

**最终目标**：用一套统一的架构覆盖所有场景，避免功能割裂、逻辑冲突、维护困难。

---

## 二、架构总览

### 2.1 核心设计原则

| 原则                                 | 说明                                                                  |
| ------------------------------------ | --------------------------------------------------------------------- |
| **管线化（Pipeline）**               | 不同玩法/场景对应不同管线，共享 80% 能力，差异部分通过 Stage 组合实现 |
| **单点写入（Single Writer）**        | 只有 `SettleStage` 允许执行扣减/发放/落库，其它 Stage 只产出"决策"    |
| **强一致事务（Strong Consistency）** | 扣积分/扣预算/扣库存/发奖/写记录 全部在同一 DB 事务内完成             |
| **幂等保障（Idempotency）**          | 每次抽奖有唯一 `idempotency_key`，重复请求返回同一结果                |
| **可审计（Auditable）**              | 每次抽奖的决策过程（过滤/归一化/档位/回退）落库为快照，可回放排查     |

### 2.2 模块架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API Layer（路由/鉴权/参数校验）                   │
│                     POST /api/v4/lottery/draw                               │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DrawOrchestrator（抽奖编排器）                        │
│  - 组装上下文（user_id, campaign_id, idempotency_key）                       │
│  - 选择 Pipeline（根据 campaign_type / 是否有预设）                          │
│  - 调用 PipelineRunner                                                      │
│  - 格式化响应                                                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                    ┌─────────────────┴─────────────────┐
                    ▼                                   ▼
┌───────────────────────────────────┐   ┌───────────────────────────────────┐
│     NormalDrawPipeline            │   │     PresetAwardPipeline           │
│     （正常抽奖管线）               │   │     （预设强制发放管线）           │
├───────────────────────────────────┤   ├───────────────────────────────────┤
│ 1. LoadCampaignStage              │   │ 1. LoadPresetStage                │
│ 2. EligibilityStage               │   │ 2. LoadCampaignStage              │
│ 3. BudgetContextStage             │   │ 3. PickPrizeStage（直接指定）      │
│ 4. BuildPrizePoolStage            │   │ 4. SettleStage（强制变体）         │
│ 5. GuaranteeStage（可选）          │   │ 5. MarkPresetUsedStage            │
│ 6. TierPickStage（可选，方案3）    │   │ 6. DecisionSnapshotStage          │
│ 7. PrizePickStage                 │   └───────────────────────────────────┘
│ 8. SettleStage                    │
│ 9. DecisionSnapshotStage          │
└───────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Domain Services（领域服务）                        │
├──────────────────┬──────────────────┬──────────────────┬────────────────────┤
│  BudgetProvider  │  InventoryService│  PrizeService    │  LedgerService     │
│  （预算提供者）   │  （库存服务）     │  （奖品服务）     │  （账本服务）       │
├──────────────────┼──────────────────┼──────────────────┼────────────────────┤
│ • UserBudget     │ • 库存扣减       │ • 奖品配置查询   │ • POINTS 扣减      │
│ • PoolBudget     │ • 日限额计数     │ • 权重计算       │ • BUDGET 扣减      │
│ • PoolQuotaBudget│ • 欠账记录       │ • 档位映射       │ • 奖励发放         │
└──────────────────┴──────────────────┴──────────────────┴────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Data Layer（数据层）                            │
├───────────────────────────────────────────────────────────────────────────── ┤
│  lottery_campaigns          lottery_prizes           lottery_draws          │
│  lottery_tier_rules         lottery_presets          asset_transactions     │
│  account_asset_balances     lottery_campaign_user_quota                     │
│  lottery_campaign_quota_grants    preset_inventory_debt    preset_budget_debt│
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、核心管线设计

### 3.1 NormalDrawPipeline（正常抽奖管线）

适用于：普通用户随机抽奖、保底触发、档位抽取等"公平随机"场景。

#### Stage 列表与职责

| 序号 | Stage 名称            | 职责                                           | 可写入 | 输入                            | 输出                                 |
| ---- | --------------------- | ---------------------------------------------- | ------ | ------------------------------- | ------------------------------------ |
| 1    | LoadCampaignStage     | 加载活动配置                                   | ❌     | campaign_id                     | campaign 对象                        |
| 2    | EligibilityStage      | 资格校验（次数/时间窗/黑白名单）               | ❌     | user_id, campaign               | eligible: boolean, reason            |
| 3    | BudgetContextStage    | 计算本次可用预算视图                           | ❌     | user_id, campaign               | budget_view: { available, source }   |
| 4    | BuildPrizePoolStage   | 构建候选奖品池（状态/库存/日限额/预算过滤）    | ❌     | campaign, budget_view           | candidate_prizes[], filtered_reasons |
| 5    | GuaranteeStage        | 检查保底/累计触发条件（可选）                  | ❌     | user_id, campaign               | guarantee_prize_id \| null           |
| 6    | TierPickStage         | 先抽档位 reward_tier（可选，方案3）            | ❌     | user_id, campaign, budget_view  | selected_tier, tier_probability      |
| 7    | PrizePickStage        | 在候选池/档位内抽具体奖品                      | ❌     | candidate_prizes, selected_tier | picked_prize, pick_method            |
| 8    | SettleStage           | **唯一写入点**：扣积分/扣预算/扣库存/发奖/落库 | ✅     | picked_prize, budget_view       | draw_record, ledger_entries          |
| 9    | DecisionSnapshotStage | 记录决策快照（审计）                           | ✅     | 全部中间结果                    | decision_snapshot_id                 |

#### 事务边界

```
┌─────────────────────────────────────────────────────────────────┐
│                    SettleStage（单一 DB 事务）                   │
├─────────────────────────────────────────────────────────────────┤
│  BEGIN TRANSACTION                                              │
│    1. 扣用户 POINTS（抽奖成本）                                  │
│    2. 扣预算（按 BudgetProvider：user/pool/pool+quota）          │
│    3. 扣库存（UPDATE ... WHERE stock > 0）                       │
│    4. 更新日限额计数                                             │
│    5. 发放奖品（points/coupon/virtual/physical）                 │
│    6. 写 lottery_draws（含 budget_before/after、tier、幂等键）   │
│    7. 写 asset_transactions（账本流水）                          │
│  COMMIT                                                         │
└─────────────────────────────────────────────────────────────────┘
```

---

### 3.2 PresetAwardPipeline（预设强制发放管线）

适用于：运营预设中奖、管理干预、定向发放等"必须发放"场景。

#### Stage 列表与职责

| 序号 | Stage 名称              | 职责                               | 可写入 | 输入                   | 输出                      |
| ---- | ----------------------- | ---------------------------------- | ------ | ---------------------- | ------------------------- |
| 1    | LoadPresetStage         | 加载用户的待使用预设               | ❌     | user_id, campaign_id   | preset 对象               |
| 2    | LoadCampaignStage       | 加载活动配置                       | ❌     | campaign_id            | campaign 对象             |
| 3    | PickPrizeStage          | 直接使用预设指定的奖品（不走概率） | ❌     | preset                 | picked_prize              |
| 4    | SettleStage（强制变体） | **尽力扣减 + 记债 + 永远发放**     | ✅     | picked_prize, campaign | draw_record, debt_records |
| 5    | MarkPresetUsedStage     | 标记预设为已使用                   | ✅     | preset                 | preset.status = 'used'    |
| 6    | DecisionSnapshotStage   | 记录决策快照（审计）               | ✅     | 全部中间结果           | decision_snapshot_id      |

#### SettleStage（强制变体）的特殊逻辑

```
┌─────────────────────────────────────────────────────────────────┐
│              SettleStage（强制变体 - 单一 DB 事务）              │
├─────────────────────────────────────────────────────────────────┤
│  BEGIN TRANSACTION                                              │
│    1. 扣用户 POINTS（可配置是否扣）                              │
│                                                                 │
│    2. 尝试扣库存                                                │
│       ├─ 成功 → 正常扣减                                        │
│       └─ 失败 → 写 preset_inventory_debt（库存欠账）             │
│                                                                 │
│    3. 尝试扣预算（按 budget_mode）                               │
│       ├─ 成功 → 正常扣减                                        │
│       └─ 失败 → 写 preset_budget_debt（预算欠账）                │
│                                                                 │
│    4. 发放奖品（永远执行，不受上述结果影响）                      │
│    5. 写 lottery_draws（标记 is_preset=true, debt 关联）         │
│    6. 写 asset_transactions                                     │
│  COMMIT                                                         │
└─────────────────────────────────────────────────────────────────┘
```

---

## 四、统一预算域（BudgetProvider）

### 4.1 抽象接口

```javascript
// 统一预算提供者接口（概念定义）
interface BudgetProvider {
  /**
   * 获取本次可用预算视图（用于过滤候选奖品）
   * @returns { available: number, source: string, details: object }
   */
  getBudgetView(context: DrawContext): Promise<BudgetView>

  /**
   * 事务内扣减预算（强一致）
   * @returns { success: boolean, deducted: number, remaining: number }
   */
  deduct(context: DrawContext, amount: number, tx: Transaction): Promise<DeductResult>

  /**
   * 尝试扣减（不抛异常版，用于预设强制发放）
   * @returns { success: boolean, deducted: number, debt: number }
   */
  tryDeduct(context: DrawContext, amount: number, tx: Transaction): Promise<TryDeductResult>
}
```

### 4.2 三种实现

| 实现类                      | 对应 budget_mode | 预算来源                                                   | 扣减逻辑                          |
| --------------------------- | ---------------- | ---------------------------------------------------------- | --------------------------------- |
| **UserBudgetProvider**      | `user`           | 用户的 `BUDGET_POINTS`（按 `allowed_campaign_ids` 筛选桶） | 扣用户账本                        |
| **PoolBudgetProvider**      | `pool`           | 活动的 `pool_budget_remaining`                             | 扣活动池                          |
| **PoolQuotaBudgetProvider** | `pool` + 配额    | 活动池 + 用户配额（双扣）                                  | 先扣 quota，再扣 pool（同一事务） |

### 4.3 PoolQuotaBudgetProvider 详细设计（对应预算模型文档）

```
┌─────────────────────────────────────────────────────────────────┐
│              PoolQuotaBudgetProvider 扣减流程                    │
├─────────────────────────────────────────────────────────────────┤
│  1. 获取用户配额（按需创建，或命中白名单预授权）                   │
│     └─ getOrCreateUserQuota(campaign_id, user_id)               │
│                                                                 │
│  2. 计算可用预算 = min(quota_remaining, pool_remaining)          │
│                                                                 │
│  3. 扣减（同一事务）                                             │
│     ├─ UPDATE lottery_campaign_user_quota                       │
│     │   SET quota_remaining = quota_remaining - ?               │
│     │   WHERE ... AND quota_remaining >= ?                      │
│     │                                                           │
│     └─ UPDATE lottery_campaigns                                 │
│         SET pool_budget_remaining = pool_budget_remaining - ?   │
│         WHERE ... AND pool_budget_remaining >= ?                │
│                                                                 │
│  4. 如选"预留池"方案                                             │
│     ├─ VIP 用户优先扣 reserved_pool_remaining                   │
│     └─ 普通用户只能扣 public_pool_remaining                      │
└─────────────────────────────────────────────────────────────────┘
```

---

## 五、奖品选择策略（PrizePickStage）

### 5.1 三种做法支持

| 做法                    | 配置标识                    | 实现逻辑                           | 适用场景                 |
| ----------------------- | --------------------------- | ---------------------------------- | ------------------------ |
| **做法1：归一化**       | `pick_method: 'normalize'`  | 过滤后对剩余奖品概率按总和缩放到 1 | 快速止血、接受"动态放大" |
| **做法2：显式缺口**     | `pick_method: 'fallback'`   | 缺口概率绑定到 `fallback_prize_id` | 成本严格可控、规则透明   |
| **做法3：先档位后奖品** | `pick_method: 'tier_first'` | 先抽 tier，再在 tier 内归一化      | 长期运营、分层体验       |

### 5.2 做法3（先档位后奖品）详细流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    TierPickStage（先抽档位）                     │
├─────────────────────────────────────────────────────────────────┤
│  1. 查询 lottery_tier_rules（按用户预算区间匹配规则）             │
│     SELECT * FROM lottery_tier_rules                            │
│     WHERE campaign_id = ? AND budget_min <= ? AND budget_max >= ?│
│                                                                 │
│  2. 获取档位概率                                                 │
│     例如：low=0.80, mid=0.18, high=0.02                         │
│                                                                 │
│  3. 随机抽取一个 tier                                           │
│     randomValue ∈ [0, 1) → 命中 low/mid/high                    │
│                                                                 │
│  4. 输出 selected_tier                                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    PrizePickStage（档位内抽奖品）                │
├─────────────────────────────────────────────────────────────────┤
│  1. 从候选池筛选 reward_tier = selected_tier 的奖品             │
│                                                                 │
│  2. 如果该档位没有可抽奖品                                       │
│     └─ 降级策略：退到 low 档 / 给固定 fallback                   │
│                                                                 │
│  3. 在档位内做归一化抽取                                         │
│     例如：mid 档剩 2 个奖品 (0.2, 0.3) → 归一化为 (0.4, 0.6)     │
│                                                                 │
│  4. 输出 picked_prize, pick_method                              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 六、预设强制发放与系统垫付

### 6.1 核心原则

```
预设发奖 = 强约束（永远要发）
扣减     = 尽力而为（能扣就扣，扣不了记债）
```

### 6.2 库存欠账处理

| 场景     | 处理方式                                              |
| -------- | ----------------------------------------------------- |
| 库存足够 | 正常扣减 `stock_quantity -= 1`                        |
| 库存不足 | 强行发放 + 写 `preset_inventory_debt`（待补货后冲销） |

### 6.3 预算欠账处理

| 场景                           | 处理方式                                        |
| ------------------------------ | ----------------------------------------------- |
| budget_mode=pool，池够         | 正常扣减 `pool_budget_remaining`                |
| budget_mode=pool，池不够       | 强行发放 + 写 `preset_budget_debt`（type=pool） |
| budget_mode=user，用户预算够   | 正常扣减用户 `BUDGET_POINTS`                    |
| budget_mode=user，用户预算不够 | 强行发放 + 写 `preset_budget_debt`（type=user） |

### 6.4 用户侧体验保证

无论库存/预算是否充足，**用户永远看到"正常中奖"**，不会收到"库存不足"或"预算不足"的错误提示。

---

## 七、数据模型设计

### 7.1 需要新增的表

#### 1) lottery_tier_rules（档位规则表）

```sql
CREATE TABLE lottery_tier_rules (
  rule_id INT AUTO_INCREMENT PRIMARY KEY,
  campaign_id INT NOT NULL COMMENT '关联活动ID',
  budget_min INT NOT NULL COMMENT '用户预算下限',
  budget_max INT NOT NULL COMMENT '用户预算上限',
  low_probability DECIMAL(5,4) NOT NULL COMMENT 'low档概率',
  mid_probability DECIMAL(5,4) NOT NULL COMMENT 'mid档概率',
  high_probability DECIMAL(5,4) NOT NULL COMMENT 'high档概率',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_campaign_budget (campaign_id, budget_min, budget_max),
  CONSTRAINT chk_tier_prob_sum CHECK (low_probability + mid_probability + high_probability = 1.0000)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='抽奖档位规则表';
```

#### 2) lottery_campaign_user_quota（用户配额表）

```sql
CREATE TABLE lottery_campaign_user_quota (
  id INT AUTO_INCREMENT PRIMARY KEY,
  campaign_id INT NOT NULL COMMENT '关联活动ID',
  user_id INT NOT NULL COMMENT '关联用户ID',
  quota_total DECIMAL(12,2) NOT NULL DEFAULT 0 COMMENT '分配的配额总量',
  quota_remaining DECIMAL(12,2) NOT NULL DEFAULT 0 COMMENT '剩余配额',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_campaign_user (campaign_id, user_id),
  INDEX idx_user_id (user_id),
  INDEX idx_campaign_id (campaign_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='活动用户配额表';
```

#### 3) lottery_campaign_quota_grants（白名单预授权表）

```sql
CREATE TABLE lottery_campaign_quota_grants (
  id INT AUTO_INCREMENT PRIMARY KEY,
  campaign_id INT NOT NULL COMMENT '关联活动ID',
  identity_type ENUM('mobile', 'openid', 'unionid', 'user_id') NOT NULL COMMENT '身份类型',
  identity_value VARCHAR(100) NOT NULL COMMENT '身份值',
  quota_total DECIMAL(12,2) NOT NULL DEFAULT 0 COMMENT '预授权配额',
  status ENUM('active', 'used', 'expired') NOT NULL DEFAULT 'active' COMMENT '状态',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_campaign_identity (campaign_id, identity_type, identity_value),
  INDEX idx_campaign_id (campaign_id),
  INDEX idx_identity (identity_type, identity_value)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='活动配额白名单预授权表';
```

#### 4) preset_inventory_debt（库存欠账表）

```sql
CREATE TABLE preset_inventory_debt (
  debt_id VARCHAR(50) PRIMARY KEY COMMENT '欠货记录ID',
  preset_id VARCHAR(50) NOT NULL COMMENT '关联预设ID',
  draw_id VARCHAR(100) NOT NULL COMMENT '关联抽奖记录ID',
  prize_id INT NOT NULL COMMENT '欠货奖品ID',
  user_id INT NOT NULL COMMENT '发给的用户ID',
  quantity INT NOT NULL DEFAULT 1 COMMENT '欠货数量',
  status ENUM('pending', 'settled') NOT NULL DEFAULT 'pending' COMMENT '状态',
  settled_at DATETIME NULL COMMENT '冲销时间',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  INDEX idx_prize_status (prize_id, status),
  INDEX idx_preset_id (preset_id),
  INDEX idx_draw_id (draw_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='预设发放库存欠账表';
```

#### 5) preset_budget_debt（预算欠账表）

```sql
CREATE TABLE preset_budget_debt (
  debt_id VARCHAR(50) PRIMARY KEY COMMENT '欠账记录ID',
  preset_id VARCHAR(50) NOT NULL COMMENT '关联预设ID',
  draw_id VARCHAR(100) NOT NULL COMMENT '关联抽奖记录ID',
  campaign_id INT NOT NULL COMMENT '关联活动ID',
  user_id INT NOT NULL COMMENT '关联用户ID',
  debt_type ENUM('pool', 'user') NOT NULL COMMENT '欠账类型',
  amount DECIMAL(12,2) NOT NULL COMMENT '欠账金额',
  deduct_campaign_id VARCHAR(50) NULL COMMENT '原应扣的桶（user模式）',
  status ENUM('pending', 'settled') NOT NULL DEFAULT 'pending' COMMENT '状态',
  settled_at DATETIME NULL COMMENT '冲销时间',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  INDEX idx_campaign_status (campaign_id, status),
  INDEX idx_user_status (user_id, status),
  INDEX idx_preset_id (preset_id),
  INDEX idx_draw_id (draw_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='预设发放预算欠账表';
```

#### 6) lottery_draw_decisions（决策快照表，可选但推荐）

```sql
CREATE TABLE lottery_draw_decisions (
  decision_id VARCHAR(100) PRIMARY KEY COMMENT '决策ID（与 draw_id 关联）',
  draw_id VARCHAR(100) NOT NULL COMMENT '关联抽奖记录ID',
  campaign_id INT NOT NULL COMMENT '活动ID',
  user_id INT NOT NULL COMMENT '用户ID',
  pipeline_type VARCHAR(50) NOT NULL COMMENT '管线类型（normal/preset）',
  budget_view JSON COMMENT '预算视图快照',
  candidate_prizes JSON COMMENT '候选奖品池快照',
  filtered_reasons JSON COMMENT '过滤原因',
  tier_selection JSON COMMENT '档位选择详情（如使用方案3）',
  pick_method VARCHAR(50) COMMENT '选奖方法（normalize/fallback/tier_first）',
  picked_prize_id INT COMMENT '最终选中奖品ID',
  guarantee_triggered BOOLEAN DEFAULT FALSE COMMENT '是否触发保底',
  debt_info JSON COMMENT '欠账信息（预设场景）',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_draw_id (draw_id),
  INDEX idx_campaign_user (campaign_id, user_id),
  INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='抽奖决策快照表';
```

### 7.2 需要调整的现有表

#### lottery_campaigns 新增字段

```sql
ALTER TABLE lottery_campaigns ADD COLUMN (
  -- 档位选择方法
  pick_method VARCHAR(50) DEFAULT 'normalize' COMMENT '选奖方法：normalize/fallback/tier_first',
  fallback_prize_id INT NULL COMMENT '缺口奖品ID（pick_method=fallback时使用）',

  -- 配额相关（pool+quota 模式）
  default_quota DECIMAL(12,2) DEFAULT 0 COMMENT '默认用户配额（按需初始化时使用）',
  quota_init_mode VARCHAR(20) DEFAULT 'on_demand' COMMENT '配额初始化模式：on_demand/pre_allocated',

  -- 预留池（可选）
  public_pool_remaining DECIMAL(12,2) NULL COMMENT '公共池剩余（普通用户可用）',
  reserved_pool_remaining DECIMAL(12,2) NULL COMMENT '预留池剩余（白名单专用）'
);
```

#### lottery_prizes 新增字段

```sql
ALTER TABLE lottery_prizes ADD COLUMN (
  -- 档位标记（方案3使用）
  reward_tier VARCHAR(20) DEFAULT 'low' COMMENT '奖品档位：low/mid/high',

  -- 预留控制（可选）
  reserved_for_vip BOOLEAN DEFAULT FALSE COMMENT '是否仅白名单可抽'
);
```

#### lottery_draws 新增字段

```sql
ALTER TABLE lottery_draws ADD COLUMN (
  -- 管线与策略标记
  pipeline_type VARCHAR(50) DEFAULT 'normal' COMMENT '管线类型：normal/preset',
  pick_method VARCHAR(50) NULL COMMENT '选奖方法',
  tier_selected VARCHAR(20) NULL COMMENT '选中的档位（方案3）',

  -- 预设相关
  is_preset BOOLEAN DEFAULT FALSE COMMENT '是否为预设发放',
  preset_id VARCHAR(50) NULL COMMENT '关联预设ID',

  -- 欠账标记
  inventory_debt_id VARCHAR(50) NULL COMMENT '关联库存欠账ID',
  budget_debt_id VARCHAR(50) NULL COMMENT '关联预算欠账ID',

  -- 决策快照关联
  decision_id VARCHAR(100) NULL COMMENT '关联决策快照ID'
);
```

---

## 八、现有功能覆盖对照表

| 现有功能                               | 新架构落点                                       | 说明                                  |
| -------------------------------------- | ------------------------------------------------ | ------------------------------------- |
| 预算过滤（budget_mode=user/pool/none） | BudgetContextStage + BuildPrizePoolStage         | 统一由 BudgetProvider 提供可用视图    |
| allowed_campaign_ids 桶限制            | UserBudgetProvider                               | 作为"可用桶范围"规则输入              |
| 概率抽取（win_probability）            | PrizePickStage                                   | 支持归一化/显式缺口/档位内归一化      |
| 库存扣减 / 日限额                      | BuildPrizePoolStage（过滤）+ SettleStage（扣减） | 过滤与扣减分离                        |
| 保底机制（guarantee）                  | GuaranteeStage                                   | 只做决策输出，扣减由 SettleStage 完成 |
| 预设奖品（preset）                     | PresetAwardPipeline                              | 独立管线，结算走强制变体              |
| 管理干预（force_win/force_lose）       | OverrideStage（可选）或 PresetAwardPipeline      | 统一收口                              |
| 记账与抽奖记录                         | SettleStage                                      | 全部收口在同一事务                    |
| 幂等                                   | idempotency_key 唯一约束                         | 重复请求返回同一结果                  |

---

## 九、管线选择逻辑

```javascript
// DrawOrchestrator 中的管线选择逻辑（伪代码）
async selectPipeline(context) {
  const { user_id, campaign_id } = context

  // 1. 检查是否有待使用的预设
  const preset = await LotteryPreset.findOne({
    where: { user_id, campaign_id, status: 'active' },
    order: [['queue_order', 'ASC']]
  })

  if (preset) {
    return {
      pipeline: PresetAwardPipeline,
      preset: preset
    }
  }

  // 2. 检查是否有管理干预（force_win/force_lose）
  const override = await LotteryManagementSetting.findOne({
    where: { user_id, campaign_id, setting_type: ['force_win', 'force_lose'], status: 'active' }
  })

  if (override) {
    // 可以用 PresetAwardPipeline 或专门的 OverridePipeline
    return {
      pipeline: PresetAwardPipeline,
      override: override
    }
  }

  // 3. 默认走正常抽奖管线
  return {
    pipeline: NormalDrawPipeline
  }
}
```

---

## 十、实施路线图

### 10.1 Phase 1：核心骨架（建议 1-2 周）

- [ ] 新建 `PipelineRunner` 基础框架
- [ ] 实现 `NormalDrawPipeline` 的核心 Stage：
  - LoadCampaignStage
  - BudgetContextStage
  - BuildPrizePoolStage
  - PrizePickStage（先只支持 normalize）
  - SettleStage
- [ ] 建表：`lottery_draw_decisions`
- [ ] 迁移现有 `BasicGuaranteeStrategy` 逻辑到 Stage

### 10.2 Phase 2：预算域统一（建议 1 周）

- [ ] 实现 `BudgetProvider` 抽象和三种实现
- [ ] 建表：`lottery_campaign_user_quota`、`lottery_campaign_quota_grants`
- [ ] 实现配额按需初始化 + 白名单预授权
- [ ] 实现预留池逻辑（可选）

### 10.3 Phase 3：档位与选奖策略（建议 1 周）

- [ ] 建表：`lottery_tier_rules`
- [ ] 实现 `TierPickStage`
- [ ] 扩展 `PrizePickStage` 支持三种做法（normalize/fallback/tier_first）
- [ ] 实现降级策略

### 10.4 Phase 4：预设强制发放（建议 1 周）

- [ ] 实现 `PresetAwardPipeline`
- [ ] 建表：`preset_inventory_debt`、`preset_budget_debt`
- [ ] 实现 SettleStage 强制变体（尽力扣减 + 记债）
- [ ] 实现欠账冲销后台功能

### 10.5 Phase 5：审计与监控（建议 0.5 周）

- [ ] 完善 `DecisionSnapshotStage`
- [ ] 实现欠账看板
- [ ] 实现成本/库存/档位命中率监控

---

## 十一、总结

### 11.1 这套架构解决的核心问题

| 问题                               | 解决方式                                         |
| ---------------------------------- | ------------------------------------------------ |
| 多种预算模式难统一                 | BudgetProvider 抽象，统一接口                    |
| 概率缺口导致分布失真               | PrizePickStage 支持三种做法，可配置              |
| 预设发放绕过扣减导致账目失控       | PresetAwardPipeline + 欠账表，强制发放但账目清楚 |
| pool+quota 双层扣减复杂            | PoolQuotaBudgetProvider 封装，单事务双扣         |
| 多种入口（普通/预设/保底）逻辑分散 | 统一收口到 SettleStage，只有一个写入点           |
| 决策过程不可追溯                   | DecisionSnapshotStage，每次抽奖可回放            |

### 11.2 一句话总结

**Pipeline + BudgetProvider + SettleStage = 一套架构覆盖所有场景，扩展灵活、强一致、可审计。**

---

## 附录：相关文件

- 原需求文档：
  - `docs/奖品配置与抽奖关系.md`
  - `docs/抽奖概率归一化与档位设计方案.md`
  - `docs/预算模型-总池配额方案.md`
  - `docs/预设强制发放-系统垫付方案.md`
- 现有代码：
  - `services/UnifiedLotteryEngine/UnifiedLotteryEngine.js`
  - `services/UnifiedLotteryEngine/strategies/BasicGuaranteeStrategy.js`
  - `models/LotteryCampaign.js`
  - `models/LotteryPrize.js`
  - `models/LotteryDraw.js`
