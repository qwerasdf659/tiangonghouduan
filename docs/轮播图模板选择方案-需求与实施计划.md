# 轮播图模板选择方案 — 需求与实施计划

> **创建日期**：2026-02-08  
> **决策人**：项目负责人  
> **状态**：待实施

---

## 一、需求背景

### 1.1 当前问题

小程序端已实现"根据图片宽高自动判断展示方式"（通过 `<image bindload>` 事件实时检测），但存在以下不足：

| 问题 | 说明 |
|------|------|
| 程序只能算比例，不知道运营意图 | 800×750 的图，程序判定为"方图"，但运营可能想要横图效果 |
| 图片下载完成前容器高度未知 | 必须等图片加载后才能设置容器，导致布局抖动 |
| "纯图模式"无法自动判断 | 运营上传的完整设计稿（文字按钮都做在图里），程序无法区分是否需要去掉白色卡片壳 |
| 运营缺乏上传指导 | 不知道该传什么尺寸的图，传完才发现效果不对 |

### 1.2 设计理念

> **不是程序"算"，而是人"选"。**

运营在管理后台上传图片时，先选择弹窗模板，模板自带比例推荐。后端存储 `display_mode` 字段，小程序直接读取该字段决定布局方式，无需实时检测。

### 1.3 命名决策

| 决策项 | 结论 | 理由 |
|-------|------|------|
| 字段名 | `display_mode`（非 `template_type`） | 字段本质是"告诉前端用哪种模式显示"，且小程序前端已按此命名实现 |
| 值命名风格 | 全部 snake_case | 项目规范：前后端统一 snake_case |
| 方图值 | `square`（非 `medium`） | `wide`/`horizontal`/`square`/`tall`/`slim` 同属"形状"语义，`medium` 是"大小"语义，不一致 |
| 横版值 | `horizontal`（新增） | 3:2 标准横版照片比例，与 `wide`（16:9 宽屏）区分 |
| 窄长图值 | `slim`（新增） | 9:16 竖屏全幅比例，同属形状语义体系 |
| 纯图值 | `full_image`（非 `fullImage`） | 遵循 snake_case 规范 |
| 文件大小限制 | 400KB | 控制加载速度，尤其小程序端移动网络场景 |

---

## 二、项目现有技术栈对齐（实际代码审查结果）

### 2.1 后端技术栈现状

| 层 | 技术 | 关键文件 | 说明 |
|---|------|---------|------|
| 运行时 | Node.js 20+ / Express 4.18 | `app.js` | API 路径统一 `/api/v4/` |
| ORM | Sequelize 6.35 + mysql2 3.6 | `config/database.js` | timezone: `+08:00`，`underscored: true` 全局 snake_case |
| 图片处理 | sharp 0.34 | `services/PopupBannerService.js` | 已用于上传时 `metadata()` 读取宽高 |
| 对象存储 | Sealos S3 兼容 | `services/sealosStorage.js` | 数据库只存 object key，API 层用 `getImageUrl()` 转完整 URL |
| 校验 | Joi 17 | `config/validator.js` | 路由层参数校验 |
| 文件上传 | multer（内存模式） | `routes/v4/console/popup-banners.js` | `upload.single('image')`，当前限 5MB |
| 服务管理 | ServiceManager 单例 | `services/index.js` | 路由层 `req.app.locals.services.getService('popup_banner')` |
| 字典中文化 | `displayNameHelper` + `SystemDictionary` 表 | `utils/displayNameHelper.js` | `attachDisplayNames()` 自动将枚举码映射为中文名 + 颜色 |
| 迁移 | sequelize-cli | `migrations/` | `npm run migration:create` → `npm run migration:up` |
| 日志 | winston | `utils/logger.js` | `logger.info()` / `logger.error()` |
| 时间 | BeijingTimeHelper | `utils/timeHelper.js` | 全系统北京时间 |

### 2.2 Web 管理端技术栈现状

| 层 | 技术 | 说明 |
|---|------|------|
| 构建 | Vite 6.4 | 多页 MPA，自动扫描 `admin/*.html` 入口 |
| 框架 | Alpine.js 3.15 | 声明式响应框架，`x-data` / `x-model` / `x-show` |
| 样式 | Tailwind CSS 3.4 | 原子化 CSS，暗色模式支持 |
| API 调用 | 原生 `fetch` + `FormData` | 图片上传走 `FormData`，JSON 请求走 `request()` 封装 |
| 模块化 | Composable 模式 | 每个业务域拆为 `composables/xxx.js`（状态 + 方法），由 `pages/xxx.js` 整合 |
| 端点管理 | `api/system/admin.js` | `SYSTEM_ADMIN_ENDPOINTS.POPUP_BANNER_*` 统一管理 |
| 图表 | ECharts 6 | 数据可视化（此需求不涉及） |
| EJS 模板 | vite-plugin-ejs | HTML 布局复用 |

### 2.3 数据库现状（真实数据）

**popup_banners 表当前字段：**

| 字段 | 类型 | 说明 |
|------|------|------|
| `popup_banner_id` | INT (PK, AI) | 主键 |
| `title` | VARCHAR(100) | 标题 |
| `image_url` | VARCHAR(500) | Sealos 对象 key |
| `link_url` | VARCHAR(500) | 跳转链接 |
| `link_type` | ENUM('none','page','miniprogram','webview') | 跳转类型 |
| `position` | VARCHAR(50) | 显示位置 |
| `is_active` | TINYINT(1) | 是否启用 |
| `display_order` | INT | 排序 |
| `start_time` | DATETIME | 开始时间 |
| `end_time` | DATETIME | 结束时间 |
| `created_by` | INT (FK→users) | 创建人 |
| `created_at` / `updated_at` | DATETIME | 时间戳 |

> ⚠️ **当前不存在** `display_mode`、`image_width`、`image_height` 字段。

**现有记录：5 条**（全部 `position='home'`，`is_active=1`），均为测试数据。

**已有字典类型：**
- `banner_position`（home/lottery/activity/profile）
- `banner_link_type`（none/page/miniprogram/webview）
- ❌ 不存在 `banner_display_mode` 类型

### 2.4 可复用组件清单

| 组件 | 位置 | 可复用方式 |
|------|------|----------|
| `sharp` 图片元数据 | `PopupBannerService.uploadBannerImage()` | **已使用** `sharp(fileBuffer).metadata()` 读取宽高，直接复用 |
| `multer` 内存上传 | `routes/v4/console/popup-banners.js` | 已配置，需改 `fileSize` 限制和 `fileFilter` |
| `attachDisplayNames()` | `utils/displayNameHelper.js` | 已在 `getAdminBannerList()` 中使用，新增 `display_mode` 映射即可 |
| `DICT_TYPES` 常量 | `utils/displayNameHelper.js` | 新增 `BANNER_DISPLAY_MODE: 'banner_display_mode'` |
| `Sequelize Migration` | `scripts/database/migration_toolkit.js` | `npm run migration:create` 标准流程 |
| Alpine.js Composable 模式 | `admin/src/modules/content/composables/banners.js` | 在现有 `useBannersState()` / `useBannersMethods()` 中扩展 |
| `FormData` 上传 | `banners.js` 的 `saveBanner()` | 已有 `formData.append()` 模式，新增 `display_mode` 字段 |
| `getImageUrl()` | `utils/ImageUrlHelper.js` | 已用于 object key → CDN URL 转换 |

### 2.5 需新增 / 不可复用的部分

| 内容 | 原因 |
|------|------|
| `display_mode` 字段定义 + ENUM 约束 | 数据库新增列 |
| 比例校验函数 `validateImageRatio()` | 新业务逻辑，无现有可复用 |
| 前端模板选择器 UI | 新交互组件，现有表单无此模式 |
| 前端比例警告提示 | 新 UI 提示 |
| 字典数据 seed | 新 dict_type |

---

## 三、小程序端已实现能力

### 3.1 双层显示策略（v1.2.0 已实现）

```
后端 API 返回 banner 数据
       │
       ▼
display_mode 字段存在？
  ├─ 是 → 直接用后端指定的模式（零延迟，无容器跳动）
  │
  └─ 否 → 降级为前端自动检测
           <image bindload> 获取原始宽高
           计算宽高比 → 自动选择容器
```

### 3.2 六种显示模式

| display_mode | 名称 | 推荐比例 | 容器高度 | image mode | 说明 |
|-------------|------|---------|---------|-----------|------|
| `wide` | 宽屏模式 | 16:9 | 350rpx | aspectFill | 视频封面、宽幅横幅 |
| `horizontal` | 横版模式 | 3:2 | 400rpx | aspectFill | 标准横版照片、活动横幅 |
| `square` | 方图模式 | 1:1 | 450rpx | aspectFill | 产品展示、通知卡片 |
| `tall` | 竖图模式 | 3:4 | 550rpx | aspectFill | 活动海报、促销长图 |
| `slim` | 窄长图模式 | 9:16 | 700rpx | aspectFill | 竖屏全幅海报、故事/短视频风格 |
| `full_image` | 纯图模式 | 不限 | 自适应 | widthFix | 整张图即弹窗，无白色卡片壳 |

### 3.3 上传限制（严格执行，不可跳过）

| 限制项 | 规则 | 超限行为 |
|-------|------|---------|
| 文件大小 | **≤ 400KB** | 直接拒绝上传，提示"图片大小 xxxKB，超过 400KB 限制，请压缩后重新上传" |
| 文件格式 | **仅 JPG（JPEG）或 PNG** | 直接拒绝上传，提示"仅支持 JPG、PNG 格式，当前格式为 xxx" |

### 3.4 小程序端剩余改动

后端实施完成后，小程序端需要同步更新命名：

| 改动 | 说明 |
|------|------|
| `medium` → `square` | 方图模式值统一为 `square` |
| `fullImage` → `full_image` | 纯图模式值统一为 snake_case |

约 3 个文件（popup-banner.js / .wxml / .wxss），查找替换即可。

---

## 四、方案设计

### 4.1 模板类型定义

| display_mode | 名称 | 推荐比例 | 推荐尺寸 | 小程序容器高度 | 说明 |
|-------------|------|---------|---------|--------------|------|
| `wide` | 宽屏模式 | 16:9 | 750×420px | 350rpx | 视频封面、宽幅横幅 |
| `horizontal` | 横版模式 | 3:2 | 750×500px | 400rpx | 标准横版照片、活动横幅 |
| `square` | 方图模式 | 1:1 | 750×750px | 450rpx | 产品展示、通知卡片 |
| `tall` | 竖图模式 | 3:4 | 750×1000px | 550rpx | 活动海报、促销长图 |
| `slim` | 窄长图模式 | 9:16 | 420×750px | 700rpx | 竖屏全幅海报、故事/短视频风格 |
| `full_image` | 纯图模式 | 不限 | 不限 | 自适应 | 整张图就是弹窗，无白色卡片壳 |

> **所有模式统一限制：文件大小 ≤ 400KB，格式仅 JPG/PNG（严格执行，超限直接拒绝）**

### 4.2 运营后台交互流程

```
运营后台（Web 管理端）：

┌─────────────────────────────────────────────┐
│                                             │
│  请选择弹窗模板：                             │
│                                             │
│  ○ 模板A - 宽屏模式（16:9）                    │
│  ○ 模板B - 横版模式（3:2）                     │
│  ● 模板C - 方图模式（1:1）  ← 选了这个        │
│  ○ 模板D - 竖图模式（3:4）                    │
│  ○ 模板E - 窄长图模式（9:16）                  │
│  ○ 模板F - 纯图模式（无文字区）                │
│                                             │
│  上传图片：[选择文件]                          │
│  ⚠ 请上传接近 1:1 比例的图片                   │
│  推荐尺寸：750×750px                          │
│                                             │
│  [预览效果]                                   │
│  ┌───────────┐                               │
│  │           │                               │
│  │ 750×750   │  ← 按所选模板模拟手机端效果     │
│  │           │                               │
│  └───────────┘                               │
│                                             │
└─────────────────────────────────────────────┘
```

### 4.3 上传校验逻辑

| 场景 | 系统行为 |
|------|---------|
| 选了"方图模式"，上传了 750×750 图 | ✅ 完美匹配，直接通过 |
| 选了"方图模式"，上传了 800×750 图（比例 1.07:1） | ⚠️ 提示"当前图片比例 1.07:1，与模板 1:1 有偏差，建议调整"，允许继续 |
| 选了"横图模式"，上传了 750×1000 竖图 | ⚠️ 提示"当前图片是竖版(3:4)，与横图模板(16:9)不匹配，展示时会被裁切"，允许继续 |
| 选了"纯图模式"，上传任意图片 | ⚠️ 二次确认弹窗："纯图模式不校验比例，图片将直接作为弹窗展示（无标题栏、无白色卡片壳），请确认图片已包含所有设计元素。确定继续？"，确认后通过 |

**原则：警告但不阻止。** 运营有最终决定权。

### 4.4 数据流转

```
Web管理端                    后端                         小程序端

选择模板 ──────→ 存储 display_mode ──────→ 读取 display_mode
上传图片 ──────→ sharp 检测宽高            │
               存储 image_width            │    display_mode 存在？
               存储 image_height           │    ├─ 是 → 直接设置容器（零延迟）
               校验比例是否匹配模板         │    └─ 否 → bindload 自动检测（兜底）
               返回警告或通过              │
                                          ↓
                                   根据 display_mode
                                   直接设置容器高度
                                   （无需等图片加载）
```

---

## 五、执行步骤（对齐项目实际技术栈）

### 步骤 1：数据库迁移

**工具**：`npm run migration:create` → 生成迁移文件到 `migrations/`

**迁移文件内容**（`YYYYMMDDHHMMSS-add-display-mode-to-popup-banners.js`）：

```javascript
'use strict'

module.exports = {
  async up(queryInterface, Sequelize) {
    // 1. 新增 display_mode 列（ENUM）
    await queryInterface.addColumn('popup_banners', 'display_mode', {
      type: Sequelize.ENUM('wide', 'horizontal', 'square', 'tall', 'slim', 'full_image'),
      allowNull: false,
      defaultValue: 'wide',
      comment: '显示模式：wide=宽屏16:9, horizontal=横版3:2, square=方图1:1, tall=竖图3:4, slim=窄长图9:16, full_image=纯图模式',
      after: 'image_url'
    })

    // 2. 新增 image_width 列
    await queryInterface.addColumn('popup_banners', 'image_width', {
      type: Sequelize.INTEGER.UNSIGNED,
      allowNull: true,
      defaultValue: null,
      comment: '原图宽度(px)，上传时 sharp 自动存储',
      after: 'display_mode'
    })

    // 3. 新增 image_height 列
    await queryInterface.addColumn('popup_banners', 'image_height', {
      type: Sequelize.INTEGER.UNSIGNED,
      allowNull: true,
      defaultValue: null,
      comment: '原图高度(px)，上传时 sharp 自动存储',
      after: 'image_width'
    })
  },

  async down(queryInterface) {
    await queryInterface.removeColumn('popup_banners', 'image_height')
    await queryInterface.removeColumn('popup_banners', 'image_width')
    await queryInterface.removeColumn('popup_banners', 'display_mode')
  }
}
```

**执行**：`npm run migration:up`

### 步骤 2：字典数据 seed

向 `system_dictionaries` 表插入 6 条记录：

```sql
INSERT INTO system_dictionaries (dict_type, dict_code, dict_name, dict_color, sort_order, is_enabled, version) VALUES
  ('banner_display_mode', 'wide',        '宽屏模式（16:9）',     'bg-blue-500',   1, 1, 1),
  ('banner_display_mode', 'horizontal',  '横版模式（3:2）',      'bg-cyan-500',   2, 1, 1),
  ('banner_display_mode', 'square',      '方图模式（1:1）',      'bg-green-500',  3, 1, 1),
  ('banner_display_mode', 'tall',        '竖图模式（3:4）',      'bg-orange-500', 4, 1, 1),
  ('banner_display_mode', 'slim',        '窄长图模式（9:16）',   'bg-purple-500', 5, 1, 1),
  ('banner_display_mode', 'full_image',  '纯图模式（无文字区）', 'bg-pink-500',   6, 1, 1);
```

> 建议在迁移文件的 `up()` 中用 `queryInterface.bulkInsert('system_dictionaries', [...])` 一起完成。

### 步骤 3：后端 Model 更新

**文件**：`models/PopupBanner.js`

在 `image_url` 字段之后新增 3 个字段定义：

```javascript
// 显示模式（运营选择的模板类型）
display_mode: {
  type: DataTypes.ENUM('wide', 'horizontal', 'square', 'tall', 'slim', 'full_image'),
  allowNull: false,
  defaultValue: 'wide',
  validate: {
    isIn: {
      args: [['wide', 'horizontal', 'square', 'tall', 'slim', 'full_image']],
      msg: '显示模式必须是：wide, horizontal, square, tall, slim, full_image 之一'
    }
  },
  comment: '显示模式'
},

// 原图宽度（上传时 sharp 自动存储）
image_width: {
  type: DataTypes.INTEGER.UNSIGNED,
  allowNull: true,
  defaultValue: null,
  comment: '原图宽度(px)'
},

// 原图高度（上传时 sharp 自动存储）
image_height: {
  type: DataTypes.INTEGER.UNSIGNED,
  allowNull: true,
  defaultValue: null,
  comment: '原图高度(px)'
},
```

同时更新以下位置：
- `getActiveBanners()` 的 `attributes` 数组：增加 `'display_mode'`, `'image_width'`, `'image_height'`
- `getBannersByStatus()` 的 `attributes` 数组：增加以上三字段

### 步骤 4：后端 Service 更新

**文件**：`services/PopupBannerService.js`

**4a. 新增比例校验常量和函数**（文件顶部，紧接 `MAX_IMAGE_DIMENSION` 之后）：

```javascript
// 弹窗Banner专属：文件限制（严格执行）
const BANNER_MAX_FILE_SIZE = 400 * 1024 // 400KB
const BANNER_ALLOWED_MIME_TYPES = ['image/jpeg', 'image/png'] // 仅 JPG、PNG

// 模板对应的期望比例范围（ratio = width / height）
const DISPLAY_MODE_RATIO_RANGES = {
  wide:       { min: 1.6, max: 2.0, label: '16:9 宽屏' },
  horizontal: { min: 1.3, max: 1.6, label: '3:2 横版' },
  square:     { min: 0.85, max: 1.3, label: '1:1 方图' },
  tall:       { min: 0.5, max: 0.85, label: '3:4 竖图' },
  slim:       { min: 0.4, max: 0.6, label: '9:16 窄长图' },
  full_image: null // 不校验
}

/**
 * 校验图片比例与模板的匹配度
 * @returns {{ status: 'match'|'warning', message?: string }}
 */
function validateImageRatio(displayMode, width, height) {
  const range = DISPLAY_MODE_RATIO_RANGES[displayMode]
  if (!range) return { status: 'match' }

  const ratio = width / height
  if (ratio >= range.min && ratio <= range.max) {
    return { status: 'match' }
  }

  return {
    status: 'warning',
    message: `当前图片比例 ${ratio.toFixed(2)}:1，与${range.label}模板有偏差，展示时可能被裁切`
  }
}
```

**4b. 修改 `uploadBannerImage()`**：增加 `mimeType` 和 `fileSize` 参数，加入 400KB / JPG+PNG 校验：

```javascript
static async uploadBannerImage(fileBuffer, originalName, mimeType, fileSize) {
  // 弹窗图片专属限制：400KB + 仅 JPG/PNG
  if (!BANNER_ALLOWED_MIME_TYPES.includes(mimeType)) {
    throw new Error(`仅支持 JPG、PNG 格式，当前格式为 ${mimeType}`)
  }
  if (fileSize > BANNER_MAX_FILE_SIZE) {
    const sizeKB = Math.round(fileSize / 1024)
    throw new Error(`图片大小 ${sizeKB}KB，超过 400KB 限制，请压缩后重新上传`)
  }

  // ... 其余逻辑不变（sharp 检测尺寸 + Sealos 上传）
  // uploadBannerImage 已返回 dimensions: { width, height }
}
```

**4c. 修改 `createBanner()`**：接收 `display_mode`、`image_width`、`image_height` 并存入数据库。

**4d. 修改 `updateBanner()`**：`allowedFields` 数组增加 `'display_mode'`, `'image_width'`, `'image_height'`。

**4e. 修改 `getAdminBannerList()` 的 `attachDisplayNames()`**：增加 `display_mode` 映射：

```javascript
await attachDisplayNames(bannersWithStatus, [
  { field: 'position', dictType: DICT_TYPES.BANNER_POSITION },
  { field: 'link_type', dictType: DICT_TYPES.BANNER_LINK_TYPE },
  { field: 'display_mode', dictType: DICT_TYPES.BANNER_DISPLAY_MODE }  // 新增
])
```

### 步骤 5：后端 DICT_TYPES 常量更新

**文件**：`utils/displayNameHelper.js`

在 `DICT_TYPES` 对象中增加：

```javascript
BANNER_DISPLAY_MODE: 'banner_display_mode',
```

### 步骤 6：后端 Route 更新

**文件**：`routes/v4/console/popup-banners.js`

**6a. 修改 `multer` 配置**：收紧文件限制。

```javascript
const upload = multer({
  storage: multer.memoryStorage(),
  limits: {
    fileSize: 400 * 1024, // 400KB（从 5MB 收紧）
    files: 1
  },
  fileFilter: (_req, file, cb) => {
    const allowedTypes = ['image/jpeg', 'image/png'] // 仅 JPG/PNG（去掉 GIF/WebP）
    if (allowedTypes.includes(file.mimetype)) {
      cb(null, true)
    } else {
      cb(new Error('仅支持 JPG、PNG 格式的图片'), false)
    }
  }
})
```

**6b. 修改 POST `/` 创建弹窗**：

- 从 `req.body` 解构新增 `display_mode`
- 必填校验：`display_mode` 不在 ENUM 范围内时返回 400
- 传 `req.file.mimetype` 和 `req.file.size` 给 `uploadBannerImage()`
- 将返回的 `dimensions.width`/`height` 存入 `image_width`/`image_height`
- 调用 `validateImageRatio()` 返回比例校验警告
- 响应增加 `ratio_warning` 字段

**6c. 修改 PUT `/:id` 更新弹窗**：同理支持 `display_mode` + 新图片时校验比例。

**6d. 修改小程序端接口**（`routes/v4/system/popup-banners.js`）：在返回的 `attributes` 中增加 `display_mode`。

### 步骤 7：Web 管理端 — HTML 表单

**文件**：`admin/content-management.html`

在轮播图表单 Modal 中（`x-ref="bannerModal"` 内），标题输入框之后、显示位置之前，新增模板选择区：

```html
<!-- 显示模式选择 -->
<div>
  <label class="block text-sm font-medium themed-text-secondary mb-2">显示模式</label>
  <div class="grid grid-cols-2 gap-2">
    <template x-for="mode in displayModes" :key="mode.value">
      <label class="flex items-center p-2 border rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"
             :class="bannerForm.display_mode === mode.value ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/20' : ''">
        <input type="radio" name="display_mode" :value="mode.value"
               x-model="bannerForm.display_mode" class="mr-2">
        <div>
          <span class="text-sm font-medium" x-text="mode.label"></span>
          <span class="text-xs themed-text-muted block" x-text="mode.hint"></span>
        </div>
      </label>
    </template>
  </div>
  <!-- 比例警告 -->
  <div x-show="ratioWarning" class="mt-2 p-2 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded text-sm text-yellow-700 dark:text-yellow-300">
    ⚠️ <span x-text="ratioWarning"></span>
  </div>
</div>
```

同时在列表卡片中增加显示模式标签：

```html
<span class="text-xs px-2 py-0.5 rounded"
      :class="banner.display_mode_color || 'bg-gray-200'"
      x-text="banner.display_mode_display || banner.display_mode || '未设置'"></span>
<span class="text-xs themed-text-muted" x-show="banner.image_width"
      x-text="banner.image_width + '×' + banner.image_height"></span>
```

### 步骤 8：Web 管理端 — JS Composable

**文件**：`admin/src/modules/content/composables/banners.js`

**8a. 扩展 `useBannersState()`**：

```javascript
// 新增状态字段
displayModes: [
  { value: 'wide',       label: '宽屏模式',   hint: '16:9 · 推荐 750×420', ratio: '16:9' },
  { value: 'horizontal', label: '横版模式',   hint: '3:2 · 推荐 750×500',  ratio: '3:2' },
  { value: 'square',     label: '方图模式',   hint: '1:1 · 推荐 750×750',  ratio: '1:1' },
  { value: 'tall',       label: '竖图模式',   hint: '3:4 · 推荐 750×1000', ratio: '3:4' },
  { value: 'slim',       label: '窄长图模式', hint: '9:16 · 推荐 420×750', ratio: '9:16' },
  { value: 'full_image', label: '纯图模式',   hint: '不限比例 · 图片即弹窗', ratio: '不限' }
],
ratioWarning: '',
```

**8b. 扩展 `bannerForm` 默认值**：增加 `display_mode: 'wide'`

**8c. 修改 `selectBannerImage()`**：

- 收紧 `allowedTypes` 为 `['image/jpeg', 'image/png']`
- 收紧大小限制为 `400 * 1024`（400KB）
- 读取上传图片的宽高（通过 `new Image()` + `onload`），计算比例，与当前 `display_mode` 对比并设置 `ratioWarning`

**8d. 修改 `saveBanner()`**：`formData.append('display_mode', ...)` 增加 display_mode 字段。

**8e. 修改 `editBanner()`**：从 banner 数据中读取 `display_mode`。

### 步骤 9：Web 管理端构建

```bash
cd admin && npm run build
```

构建产物输出到 `admin/dist/`，Express 静态文件服务自动生效。

### 步骤 10：小程序端命名统一

在以下 3 个文件中查找替换：

| 文件 | 操作 |
|------|------|
| `components/popup-banner/popup-banner.js` | `medium` → `square`，`fullImage` → `full_image` |
| `components/popup-banner/popup-banner.wxml` | 同上 |
| `components/popup-banner/popup-banner.wxss` | 同上 |

---

## 六、技术对齐检查清单

### 后端对齐 ✅

| 检查项 | 对齐状态 | 说明 |
|-------|---------|------|
| Sequelize Migration 标准流程 | ✅ | 使用 `npm run migration:create` + `queryInterface.addColumn` |
| Model 字段定义 + validate | ✅ | 遵循现有 `PopupBanner.js` 的 `DataTypes.ENUM` + `isIn` 验证模式 |
| Service 层业务逻辑 | ✅ | 扩展现有 `PopupBannerService`，不新增 Service 类 |
| `sharp` 复用 | ✅ | `uploadBannerImage()` 已使用 `sharp(fileBuffer).metadata()` 读取宽高 |
| `attachDisplayNames()` 中文化 | ✅ | 复用现有字典映射机制，新增 `BANNER_DISPLAY_MODE` 字典类型 |
| `getImageUrl()` 存储架构 | ✅ | 数据库只存 object key，API 层动态转 URL（不变） |
| 路由 `multer` + `asyncHandler` | ✅ | 复用现有路由模式，仅修改限制参数 |
| `ServiceManager.getService()` | ✅ | 路由层通过 `req.app.locals.services.getService('popup_banner')` 获取 |
| `BeijingTimeHelper` 时间处理 | ✅ | 所有时间字段继续使用 `BeijingTimeHelper.createBeijingTime()` |
| winston 结构化日志 | ✅ | `logger.info()` / `logger.error()` 格式不变 |

### Web 管理端对齐 ✅

| 检查项 | 对齐状态 | 说明 |
|-------|---------|------|
| Alpine.js Composable 模式 | ✅ | 在 `banners.js` 的 `useBannersState()` / `useBannersMethods()` 中扩展 |
| Tailwind CSS 原子化样式 | ✅ | 新增 UI 使用 Tailwind class，无自定义 CSS |
| `FormData` 上传 | ✅ | 复用 `saveBanner()` 现有 `FormData` 模式 |
| `SYSTEM_ENDPOINTS` 端点管理 | ✅ | API 端点不变，仅请求参数新增 `display_mode` |
| `content-management.html` MPA 模板 | ✅ | 在现有 bannerModal 中扩展，不新增 HTML 文件 |
| Vite 构建 | ✅ | `npm run build` 自动扫描 HTML 入口，不需改 `vite.config.js` |
| 暗色模式兼容 | ✅ | 使用 `themed-*` CSS class 和 `dark:` Tailwind 变体 |

---

## 七、实施顺序汇总

| 步骤 | 改动位置 | 涉及文件 | 工作量 |
|------|---------|---------|-------|
| 1 | 数据库迁移 | `migrations/YYYYMMDD-add-display-mode-to-popup-banners.js` | 10 分钟 |
| 2 | 字典数据 | 同上迁移文件中 `bulkInsert` | 5 分钟 |
| 3 | 后端 Model | `models/PopupBanner.js` | 10 分钟 |
| 4 | 后端 Service | `services/PopupBannerService.js` | 30 分钟 |
| 5 | 后端 DICT_TYPES | `utils/displayNameHelper.js` | 2 分钟 |
| 6 | 后端 Route | `routes/v4/console/popup-banners.js` + `routes/v4/system/popup-banners.js` | 20 分钟 |
| 7 | Web HTML | `admin/content-management.html` | 30 分钟 |
| 8 | Web JS | `admin/src/modules/content/composables/banners.js` | 25 分钟 |
| 9 | Web 构建 | `cd admin && npm run build` | 1 分钟 |
| 10 | 小程序端 | 3 个 popup-banner 文件查找替换 | 10 分钟 |
| **合计** | | | **约 2.5 小时** |

---

## 八、验收标准

| 序号 | 验收项 | 预期结果 |
|------|-------|---------|
| 1 | Web 管理端创建轮播图时可选择模板 | 6 个模板单选，选中后显示推荐尺寸 |
| 2 | 上传图片后自动校验比例匹配度 | 匹配 → 无提示；不匹配 → 黄色警告，不阻止提交 |
| 3 | 上传超过 400KB 图片时被拒绝 | 前端 + 后端双重拦截 |
| 4 | 上传非 JPG/PNG 格式图片时被拒绝 | 前端 + 后端双重拦截 |
| 5 | 轮播图列表卡片显示模板类型和尺寸 | 如"方图模式（1:1） · 750×750" |
| 6 | API 返回包含 `display_mode` 字段 | 管理端和小程序端接口均返回 |
| 7 | `display_mode` 中文名通过字典映射 | 管理端列表显示 `display_mode_display` 中文标签 |
| 8 | 小程序弹窗根据 `display_mode` 设置容器 | 无需等图片加载，容器高度立即正确 |
| 9 | 纯图模式去掉白色卡片壳 | 图片即弹窗，无额外边框 |
| 10 | 小程序端命名统一 | `medium`→`square`、`fullImage`→`full_image` 已替换 |
