# è·¨ç»„ææ–™è½¬æ¢è§„åˆ™æ”¾å®½æ–¹æ¡ˆ

> **æ–‡æ¡£ç‰ˆæœ¬**: V2.3ï¼ˆçº¯åç«¯å®ç°ï¼‰  
> **æ–‡æ¡£èŒƒå›´**: ğŸ”´ ä»…åç«¯æ•°æ®åº“ï¼Œä¸æ¶‰åŠå¾®ä¿¡å°ç¨‹åº/Webç®¡ç†åå°å‰ç«¯  
> **åˆ›å»ºæ—¥æœŸ**: 2026-01-25  
> **æ›´æ–°æ—¥æœŸ**: 2026-01-26  
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²æ‹æ¿ï¼Œä»£ç å®ç°å·²å®Œæˆ  
> **è´Ÿè´£äºº**: åç«¯å¼€å‘  
> **ç›®æ ‡æ–‡ä»¶**: `utils/materialConversionValidator.js`

---

## ğŸ“Œ å†³ç­–è®°å½•ï¼ˆå·²æ‹æ¿ï¼‰

| å†³ç­–é¡¹ | å†³ç­–ç»“æœ | è¯´æ˜ |
|--------|----------|------|
| **æ–¹æ¡ˆé€‰æ‹©** | âœ… æ–¹æ¡ˆ Cï¼šå…¨å±€å¥—åˆ©æ£€æµ‹ | ç§»é™¤è·¨ç»„é™åˆ¶ + ä¿ç•™å…¨å±€é£æ§ |
| **è½¬æ¢æ–¹å‘** | âœ… ä»…å•å‘ | åªå…è®¸ `red_shard â†’ DIAMOND` |
| **é’»çŸ³æµå‡º** | ğŸ”´ **ç»å¯¹ç¦æ­¢** | DIAMOND ä½œä¸ºç»ˆç‚¹è´§å¸ï¼Œç¦æ­¢è½¬åŒ–ä¸ºä»»ä½•ææ–™ |

### ğŸ”´ ç¡¬çº¦æŸï¼šé’»çŸ³ï¼ˆDIAMONDï¼‰ç¦æ­¢æµå‡ºè§„åˆ™

**ä¸šåŠ¡è§„åˆ™**ï¼šé’»çŸ³æ˜¯ç³»ç»Ÿçš„ã€Œç»ˆç‚¹è´§å¸ã€ï¼Œåªè¿›ä¸å‡ºã€‚

| å…è®¸ | ç¦æ­¢ |
|------|------|
| âœ… `red_shard` â†’ `DIAMOND` | âŒ `DIAMOND` â†’ `red_shard` |
| âœ… `å…¶ä»–ææ–™` â†’ `DIAMOND` | âŒ `DIAMOND` â†’ `å…¶ä»–ææ–™` |
| âœ… `DIAMOND` ç”¨äºæ¶ˆè´¹/å…‘æ¢ | âŒ `DIAMOND` â†’ `ä»»ä½• asset_code` |

**æŠ€æœ¯å®ç°**ï¼šåœ¨é£æ§æ ¡éªŒå™¨ä¸­å¢åŠ ã€Œç»ˆç‚¹è´§å¸ã€æ£€æŸ¥ï¼Œå½“ `from_asset_code = 'DIAMOND'` æ—¶ç›´æ¥æ‹’ç»ã€‚

---

## ä¸€ã€é¡¹ç›®ç°çŠ¶åˆ†æï¼ˆåŸºäºå®é™…æ•°æ®åº“æ•°æ®ï¼‰

### 1.1 åç«¯é¡¹ç›®å®šä½
| é¡¹ç›® | è¯´æ˜ |
|------|------|
| é¡¹ç›®åç§° | é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ V4 **åç«¯** |
| æ ¸å¿ƒä¸šåŠ¡ | ç§¯åˆ†æŠ½å¥– + ææ–™æ”¶é›† + èµ„äº§è½¬æ¢ + C2Cäº¤æ˜“ï¼ˆåç«¯ API æœåŠ¡ï¼‰ |
| æŠ€æœ¯æ¶æ„ | Node.js 20+ / Express / Sequelize / MySQL / Redis |
| æ•°æ®åº“ç”¨æˆ· | å½“å‰ 31 ç”¨æˆ·è®°å½• |
| ä¸šåŠ¡è¡¨æ•°é‡ | 67+ å¼ æ ¸å¿ƒä¸šåŠ¡è¡¨ |

### 1.2 å½“å‰èµ„äº§ä½“ç³»ï¼ˆmaterial_asset_types å®é™…æ•°æ®ï¼‰

| asset_code | display_name | group_code | form | tier | æµé€šé‡ |
|------------|--------------|------------|------|------|--------|
| `DIAMOND` | é’»çŸ³ | `currency` | currency | 10 | 287,000 |
| `red_shard` | çº¢è‰²ç¢ç‰‡ | `red` | shard | 1 | 97,160 |
| `BUDGET_POINTS` | é¢„ç®—ç§¯åˆ† | `points` | crystal | 0 | 6,580 |
| `POINTS` | æ™®é€šç§¯åˆ† | `points` | crystal | 0 | 57,182 |

### 1.3 å½“å‰è½¬æ¢è§„åˆ™ï¼ˆmaterial_conversion_rules å®é™…æ•°æ®ï¼‰

| rule_id | è½¬æ¢è·¯å¾„ | æ¯”ä¾‹ | çŠ¶æ€ | ç±»å‹ |
|---------|----------|------|------|------|
| 1 | `red_shard` â†’ `DIAMOND` | 1:20 | âŒ ç¦ç”¨ | è·¨ç»„ (redâ†’currency) |

**é—®é¢˜ç¡®è®¤**ï¼šè§„åˆ™å·²åˆ›å»ºä½†è¢«ç¦ç”¨ï¼ŒåŸå› æ˜¯é£æ§ç³»ç»Ÿæ‹’ç»è·¨ç»„è½¬æ¢ã€‚

---

## äºŒã€éœ€æ±‚èƒŒæ™¯

### ä¸šåŠ¡åœºæ™¯
éœ€è¦å¯ç”¨ã€Œçº¢è‰²ç¢ç‰‡ (red_shard)ã€ä¸ã€Œé’»çŸ³ (DIAMOND)ã€ä¹‹é—´çš„è½¬æ¢è§„åˆ™ã€‚

### å½“å‰é˜»ç¢ï¼šåç«¯é£æ§ç³»ç»Ÿç¦æ­¢è·¨ç»„è½¬æ¢

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| `red_shard` | å±äº `red` ææ–™ç»„ |
| `DIAMOND` | å±äº `currency` è´§å¸ç»„ |
| æ‹¦æˆªä½ç½® | é£æ§æ ¡éªŒå™¨ (`utils/materialConversionValidator.js`) ç¬¬254-261è¡Œ |
| æ‹¦æˆªé€»è¾‘ | å¼ºåˆ¶æ‹’ç»ä¸åŒ `group_code` ä¹‹é—´çš„è½¬æ¢è§„åˆ™ |

### ç¡®è®¤ç»“è®º
**å¦‚æœä¸ä¿®æ”¹é£æ§è§„åˆ™ï¼Œå°†æ— æ³•å¯ç”¨ä»»ä½•è·¨ç»„è½¬æ¢è§„åˆ™ï¼ˆåŒ…æ‹¬é’»çŸ³â†”çº¢ç¢ç‰‡ï¼‰ã€‚**

---

## ä¸‰ã€è¡Œä¸šæ–¹æ¡ˆå¯¹æ¯”åˆ†æ

### 3.1 å¤§å‚æ–¹æ¡ˆï¼ˆè…¾è®¯/é˜¿é‡Œ/ç¾å›¢ï¼‰

| å…¬å¸ | è™šæ‹Ÿç‰©å“ä½“ç³» | è·¨ç±»å‹è½¬æ¢ç­–ç•¥ | é£æ§æœºåˆ¶ | ç‰¹ç‚¹ |
|------|-------------|----------------|----------|------|
| **è…¾è®¯æ¸¸æˆ** | Qå¸â†’ç‚¹åˆ¸â†’æ¸¸æˆè´§å¸ å¤šå±‚ä½“ç³» | å•å‘è½¬æ¢ä¸ºä¸»ï¼Œé€†å‘éœ€å®¡æ‰¹ | å…¨å±€å®æ—¶é£æ§ + å¤§æ•°æ®åˆ†æ | ä¸¥æ ¼éš”ç¦»ï¼Œé˜²æ­¢æ´—é’± |
| **é˜¿é‡Œé—²é±¼** | æ·˜é‡‘å¸/é—²é±¼å¸ | ç¦æ­¢ç›´æ¥äº’è½¬ï¼Œéœ€é€šè¿‡æ³•å¸æ¡¥æ¥ | äº¤æ˜“é™é¢ + å®åè®¤è¯ | åˆè§„ä¼˜å…ˆ |
| **ç¾å›¢** | ç¾å›¢å¸/çº¢åŒ… | ä»…æ¶ˆè´¹åœºæ™¯å•å‘ä½¿ç”¨ | ä½¿ç”¨åœºæ™¯é™åˆ¶ | ä¸šåŠ¡éš”ç¦» |

**å¤§å‚ç‰¹ç‚¹**ï¼š
- âœ… ä¸¥æ ¼çš„èµ„äº§éš”ç¦»ï¼Œä¸åŒç±»å‹èµ„äº§ä¸å¯ç›´æ¥äº’è½¬
- âœ… å®Œå–„çš„å®¡è®¡å’Œç›‘æ§ç³»ç»Ÿ
- âŒ å®ç°æˆæœ¬é«˜ï¼Œéœ€è¦ä¸“ä¸šé£æ§å›¢é˜Ÿ
- âŒ å¯¹ä¸­å°é¡¹ç›®è¿‡äºå¤æ‚

### 3.2 æ¸¸æˆå…¬å¸æ–¹æ¡ˆ

| ç±»å‹ | ä»£è¡¨äº§å“ | è´§å¸ä½“ç³» | è·¨ç±»å‹è½¬æ¢ | é£æ§ |
|------|----------|----------|------------|------|
| **MMOç«¯æ¸¸** | é­”å…½ä¸–ç•Œ/å‰‘ç½‘ä¸‰ | é‡‘å¸+ç‚¹å¡+ç»‘å®šè´§å¸ | æœ‰é™è·¨ç±»å‹ï¼ˆå¦‚é‡‘å¸â†’æœˆå¡ï¼‰ | äº¤æ˜“è¡Œé™ä»· + ç»‘å®šæœºåˆ¶ |
| **æ‰‹æ¸¸** | åŸç¥/ç‹è€…è£è€€ | åŸçŸ³/ç‚¹åˆ¸ + ä½“åŠ› + ææ–™ | ææ–™â†’è´§å¸å•å‘åˆ†è§£ | å®˜æ–¹å®šä»·ï¼Œæ— ç©å®¶äº¤æ˜“ |
| **äºŒæ¬¡å…ƒ** | æ˜æ—¥æ–¹èˆŸ/ç¢§è“èˆªçº¿ | åˆæˆç‰ + ææ–™ä½“ç³» | ææ–™å¯åˆ†è§£ä¸ºé€šç”¨è´§å¸ | å›ºå®šæ¯”ä¾‹ï¼Œæ— å¥—åˆ©ç©ºé—´ |

**æ¸¸æˆå…¬å¸ç‰¹ç‚¹**ï¼š
- âœ… ææ–™â†’è´§å¸ å•å‘åˆ†è§£æ˜¯å¸¸è§æ¨¡å¼
- âœ… å›ºå®šå®˜æ–¹æ¯”ä¾‹ï¼Œæ— å¥—åˆ©é£é™©
- âœ… é€‚åˆæ‚¨é¡¹ç›®çš„ `red_shard â†’ DIAMOND (1:20)` åœºæ™¯
- âš ï¸ éœ€ç¡®ä¿è½¬æ¢æ¯”ä¾‹ä¸å¯è¢«åˆ©ç”¨

### 3.3 å°å…¬å¸ / æ´»åŠ¨ç­–åˆ’å…¬å¸æ–¹æ¡ˆ

| ç±»å‹ | ç‰¹ç‚¹ | è·¨ç±»å‹è½¬æ¢ | é£æ§ |
|------|------|------------|------|
| **ç§¯åˆ†å•†åŸ** | å•ä¸€ç§¯åˆ†ä½“ç³» | æ— éœ€è·¨ç±»å‹ | ç®€å•é™é¢ |
| **æ´»åŠ¨å¹³å°** | æ´»åŠ¨å¸+å¥–å“ | æ´»åŠ¨å¸â†’å¥–å“å•å‘ | æ´»åŠ¨ç»“æŸæ¸…é›¶ |
| **å°å‹æ¸¸æˆ** | é‡‘å¸+é’»çŸ³ | äººæ°‘å¸â†’é’»çŸ³â†’é‡‘å¸ å•å‘é“¾ | æç°å®¡æ ¸ |

**å°å…¬å¸ç‰¹ç‚¹**ï¼š
- âœ… å®ç°ç®€å•ï¼Œé£æ§è½»é‡
- âœ… ä¸šåŠ¡çµæ´»ï¼Œå¿«é€Ÿè¿­ä»£
- âŒ é£æ§ä¸å®Œå–„ï¼Œå­˜åœ¨æ¼æ´é£é™©

### 3.4 äºŒæ‰‹äº¤æ˜“å¹³å°æ–¹æ¡ˆï¼ˆé—²é±¼/è½¬è½¬/å¾—ç‰©ï¼‰

| å¹³å° | è™šæ‹Ÿç‰©å“å¤„ç† | è½¬æ¢ç­–ç•¥ | é£æ§ |
|------|-------------|----------|------|
| **é—²é±¼** | å•†å“äº¤æ˜“ï¼Œæ— è™šæ‹Ÿè´§å¸è½¬æ¢ | N/A | æ”¯ä»˜å®æ‹…ä¿ |
| **å¾—ç‰©** | ç§¯åˆ†+ä¼˜æƒ åˆ¸ | ç§¯åˆ†â†’æŠµæ‰£åˆ¸ å•å‘ | ä½¿ç”¨é™åˆ¶ |
| **Steam** | é’±åŒ…ä½™é¢ | æ³•å¸â†’é’±åŒ… å•å‘ï¼Œä¸å¯æç° | äº¤æ˜“å†·å´æœŸ |

---

## å››ã€æœ€é€‚åˆæœ¬é¡¹ç›®çš„æ–¹æ¡ˆåˆ†æ

### 4.1 åç«¯é¡¹ç›®ç‰¹å¾åŒ¹é…

| ç»´åº¦ | åç«¯ç°çŠ¶ | æœ€ä½³åŒ¹é…æ¨¡å¼ |
|------|----------|--------------|
| æ•°æ®è§„æ¨¡ | 31ç”¨æˆ·è®°å½•ï¼Œä¸­å°å‹æ•°æ®åº“ | å°å…¬å¸/æ¸¸æˆå…¬å¸æ¨¡å¼ |
| åç«¯æŠ€æœ¯æ ˆ | Node.js + Sequelize + MySQL | è½»é‡çº§é£æ§ |
| ä¸šåŠ¡æ¨¡å¼ | ç§¯åˆ†æŠ½å¥– + ææ–™æ”¶é›†ï¼ˆåç«¯é€»è¾‘ï¼‰ | ç±»ä¼¼æ‰‹æ¸¸ææ–™ä½“ç³» |
| è½¬æ¢éœ€æ±‚ | ææ–™â†’è´§å¸ å•å‘åˆ†è§£ | æ¸¸æˆå…¬å¸åˆ†è§£æ¨¡å¼ |
| åç«¯é£æ§ç°çŠ¶ | å·²æœ‰å¾ªç¯æ£€æµ‹ + å¥—åˆ©æ£€æµ‹ç®—æ³• | å·²å…·å¤‡æ ¸å¿ƒèƒ½åŠ› |

### 4.2 æ¨èæ–¹æ¡ˆï¼šæ¸¸æˆå…¬å¸æ¨¡å¼ + å…¨å±€å¥—åˆ©æ£€æµ‹

**æ ¸å¿ƒç†å¿µ**ï¼šå€Ÿé‰´æ‰‹æ¸¸çš„ã€Œææ–™åˆ†è§£ã€æœºåˆ¶ï¼Œå…è®¸ `red_shard â†’ DIAMOND` å•å‘è½¬æ¢ï¼ŒåŒæ—¶ä¿ç•™å…¨å±€å¥—åˆ©æ£€æµ‹é˜²æ­¢é—­ç¯å¥—åˆ©ã€‚

| å¯¹æ¯”ç»´åº¦ | å¤§å‚æ–¹æ¡ˆ | æ¸¸æˆå…¬å¸æ–¹æ¡ˆ | å°å…¬å¸æ–¹æ¡ˆ | **æœ¬é¡¹ç›®æ¨è** |
|----------|----------|--------------|------------|----------------|
| å®ç°å¤æ‚åº¦ | â­â­â­â­â­ | â­â­â­ | â­ | â­â­â­ |
| é£æ§å¼ºåº¦ | â­â­â­â­â­ | â­â­â­â­ | â­â­ | â­â­â­â­ |
| ä¸šåŠ¡çµæ´»æ€§ | â­â­ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |
| é€‚é…ç¨‹åº¦ | âŒ è¿‡åº¦è®¾è®¡ | âœ… é«˜åº¦é€‚é… | âš ï¸ é£æ§ä¸è¶³ | âœ… æœ€ä½³å¹³è¡¡ |

---

## äº”ã€æŠ€æœ¯æ–¹æ¡ˆé€‰é¡¹å¯¹æ¯”

åŸºäºè¡Œä¸šåˆ†æï¼Œç»“åˆæœ¬é¡¹ç›®å®é™…æŠ€æœ¯æ ˆï¼š

| æ–¹æ¡ˆ | æè¿° | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
|------|------|------|------|--------|
| **A. å®Œå…¨ç§»é™¤è·¨ç»„é™åˆ¶** | åˆ é™¤ç¬¬254-261è¡Œçš„è·¨ç»„æ ¡éªŒ | å®ç°æœ€ç®€å•ï¼Œ1åˆ†é’Ÿå®Œæˆ | å¯èƒ½å¼•å…¥è·¨ç»„å¥—åˆ©é£é™© | â­â­ |
| **B. ç™½åå•æœºåˆ¶** | åªå…è®¸ç‰¹å®šç»„å¯¹ä¹‹é—´çš„è·¨ç»„è½¬æ¢ | ç²¾ç»†æ§åˆ¶ï¼Œé£é™©å¯æ§ | éœ€è¦ç»´æŠ¤ç™½åå•é…ç½® | â­â­â­â­ |
| **C. å…¨å±€å¥—åˆ©æ£€æµ‹** | ç§»é™¤è·¨ç»„é™åˆ¶ï¼Œå°†å¥—åˆ©æ£€æµ‹æ‰©å¤§åˆ°å…¨å±€ | ä¿ç•™å¥—åˆ©é˜²æŠ¤ï¼Œå…è®¸è·¨ç»„ | å®ç°å¤æ‚åº¦ä¸­ç­‰ | â­â­â­â­â­ |

### æ–¹æ¡ˆ C è¯¦è§£ï¼ˆæ¨èï¼‰

**æ ¸å¿ƒæ€è·¯**ï¼š

1. **ç§»é™¤è·¨ç»„é™åˆ¶**ï¼šåˆ é™¤ `group_code` ä¸ä¸€è‡´æ—¶çš„å¼ºåˆ¶æ‹’ç»é€»è¾‘
2. **æ‰©å¤§å¥—åˆ©æ£€æµ‹èŒƒå›´**ï¼šå°†å¾ªç¯æ£€æµ‹å’Œè´Ÿç¯æ£€æµ‹çš„èŒƒå›´ä»"åŒç»„å†…"æ‰©å¤§åˆ°"å…¨å±€æ‰€æœ‰å¯ç”¨è§„åˆ™"
3. **ä¿ç•™æ ¸å¿ƒé£æ§**ï¼šä»ç„¶æ‹¦æˆªé—­ç¯è·¯å¾„å’Œå¥—åˆ©é—­ç¯ï¼Œåªæ˜¯ä¸å†æŒ‰ç»„éš”ç¦»

**ä¸ºä»€ä¹ˆé€‚åˆæœ¬åç«¯é¡¹ç›®**ï¼š

| åŸå›  | è¯´æ˜ |
|------|------|
| åç«¯æŠ€æœ¯æ ˆå…¼å®¹ | é£æ§ç®—æ³•ï¼ˆDFS + Bellman-Fordï¼‰å·²åœ¨åç«¯å®ç°ï¼Œåªéœ€è°ƒæ•´æ£€æµ‹èŒƒå›´ |
| ä¸šåŠ¡åŒ¹é… | ç¬¦åˆæ¸¸æˆå…¬å¸ã€Œææ–™åˆ†è§£ã€æ¨¡å¼ |
| é£é™©å¯æ§ | å…¨å±€å¥—åˆ©æ£€æµ‹ä»èƒ½é˜²æ­¢ Aâ†’Bâ†’Câ†’A é—­ç¯ |
| åç«¯æ”¹åŠ¨æœ€å° | ä»…éœ€ä¿®æ”¹ 1 ä¸ªæ–‡ä»¶çš„çº¦ 30 è¡Œä»£ç  |

---

## å…­ã€ä¿®æ”¹ä½ç½®ä¸å†…å®¹

### ä¿®æ”¹æ–‡ä»¶
```
utils/materialConversionValidator.js
```

### ä¿®æ”¹å†…å®¹

| æ“ä½œ | ä»£ç ä½ç½® | è¯´æ˜ |
|------|----------|------|
| **æ–°å¢** | ç¬¬254è¡Œå‰ | ğŸ”´ æ–°å¢ã€Œç»ˆç‚¹è´§å¸ç¦æ­¢æµå‡ºã€æ£€æŸ¥ï¼ˆDIAMOND ç¦æ­¢ä½œä¸ºæºèµ„äº§ï¼‰ |
| åˆ é™¤ | ç¬¬254-261è¡Œ | ç§»é™¤è·¨ç»„æ ¡éªŒä»£ç å— |
| ä¿®æ”¹ | ç¬¬269-285è¡Œ | è§„åˆ™æŸ¥è¯¢é€»è¾‘ç§»é™¤ `group_code` è¿‡æ»¤æ¡ä»¶ |
| ä¿ç•™ | å¾ªç¯æ£€æµ‹é€»è¾‘ (detectCycle) | å·²ç»æ˜¯å…¨å±€æœ‰æ•ˆçš„ï¼Œæ— éœ€ä¿®æ”¹ |
| ä¿ç•™ | è´Ÿç¯æ£€æµ‹é€»è¾‘ (detectNegativeCycle) | å·²ç»æ˜¯å…¨å±€æœ‰æ•ˆçš„ï¼Œæ— éœ€ä¿®æ”¹ |

### ğŸ”´ æ–°å¢ä»£ç ï¼šç»ˆç‚¹è´§å¸ç¦æ­¢æµå‡º

```javascript
// ğŸ”´ ç¡¬çº¦æŸï¼šç»ˆç‚¹è´§å¸ï¼ˆå¦‚ DIAMONDï¼‰ç¦æ­¢ä½œä¸ºè½¬æ¢æº
const TERMINAL_CURRENCIES = ['DIAMOND']  // åªè¿›ä¸å‡ºçš„ç»ˆç‚¹è´§å¸

if (TERMINAL_CURRENCIES.includes(newRule.from_asset_code)) {
  errors.push(
    `è½¬æ¢è§„åˆ™è¢«æ‹’ç»ï¼š${newRule.from_asset_code} æ˜¯ç»ˆç‚¹è´§å¸ï¼Œç¦æ­¢è½¬åŒ–ä¸ºå…¶ä»–èµ„äº§`
  )
  return { valid: false, errors }
}
```

### é£é™©è¯„ä¼°

| çŠ¶æ€ | é£é™©é¡¹ | è¯´æ˜ |
|------|--------|------|
| âœ… | é—­ç¯è·¯å¾„æ‹¦æˆª | ä»ç„¶æ‹¦æˆª Aâ†’Bâ†’Câ†’A ç±»å‹çš„é—­ç¯è·¯å¾„ |
| âœ… | å¥—åˆ©é—­ç¯æ‹¦æˆª | ä»ç„¶æ‹¦æˆªå¥—åˆ©é—­ç¯ï¼ˆæ²¿ç¯è·¯è½¬æ¢å¯å¢åŠ èµ„äº§æ€»é‡ï¼‰ |
| âœ… | ğŸ”´ é’»çŸ³æµå‡ºæ‹¦æˆª | **æ–°å¢**ï¼šDIAMOND ä½œä¸ºç»ˆç‚¹è´§å¸ï¼Œç¦æ­¢ä½œä¸ºè½¬æ¢æº |
| âš ï¸ | è®¡ç®—é‡å¢åŠ  | å…¨å±€è§„åˆ™é‡å¢å¤§åï¼Œæ£€æµ‹è®¡ç®—é‡ç•¥æœ‰å¢åŠ ï¼ˆå½“å‰ä»…1æ¡è§„åˆ™ï¼Œå¯æ¥å—ï¼‰ |

---

## ä¸ƒã€åç«¯å®æ–½æ­¥éª¤

| æ­¥éª¤ | åç«¯æ“ä½œ | é¢„è®¡è€—æ—¶ |
|------|----------|----------|
| 1 | å¤‡ä»½ `utils/materialConversionValidator.js` | 1åˆ†é’Ÿ |
| 2 | ğŸ”´ æ–°å¢ã€Œç»ˆç‚¹è´§å¸ç¦æ­¢æµå‡ºã€æ£€æŸ¥ä»£ç  | 2åˆ†é’Ÿ |
| 3 | ç§»é™¤è·¨ç»„é™åˆ¶ä»£ç ï¼ˆç¬¬254-261è¡Œï¼‰ | 2åˆ†é’Ÿ |
| 4 | ä¿®æ”¹è§„åˆ™æŸ¥è¯¢é€»è¾‘ï¼Œç§»é™¤ `group_code` è¿‡æ»¤ | 3åˆ†é’Ÿ |
| 5 | é‡å¯åç«¯æœåŠ¡ï¼ˆPM2 / nodemonï¼‰ | 1åˆ†é’Ÿ |
| 6 | æ›´æ–°æ•°æ®åº“ï¼š`UPDATE material_conversion_rules SET is_enabled=1 WHERE rule_id=1` | 1åˆ†é’Ÿ |

**æ€»é¢„è®¡è€—æ—¶ï¼š10åˆ†é’Ÿï¼ˆçº¯åç«¯æ“ä½œï¼‰**

---

## å…«ã€å›æ»šæ–¹æ¡ˆ

å¦‚æœå‘ç°é—®é¢˜ï¼Œå¯é€šè¿‡ä»¥ä¸‹æ–¹å¼å›æ»šï¼š

1. æ¢å¤å¤‡ä»½çš„ `materialConversionValidator.js` æ–‡ä»¶
2. é‡å¯åç«¯æœåŠ¡

---

## ä¹ã€åç»­å»ºè®®

### 9.1 è§„åˆ™åˆ›å»ºå‰è¯„ä¼°
è·¨ç»„è§„åˆ™åˆ›å»ºæ—¶ï¼Œå»ºè®®äººå·¥è¯„ä¼°è½¬æ¢æ¯”ä¾‹æ˜¯å¦åˆç†ã€‚

### 9.2 ç›‘æ§æ—¥å¿—
å…³æ³¨é£æ§æ ¡éªŒæ—¥å¿—ï¼Œè§‚å¯Ÿæ˜¯å¦æœ‰å¼‚å¸¸çš„é—­ç¯å°è¯•ã€‚

### 9.3 å®šæœŸå®¡è®¡
å»ºè®®æ¯æœˆå®¡æŸ¥ä¸€æ¬¡æ‰€æœ‰è½¬æ¢è§„åˆ™ï¼Œç¡®ä¿æ— å¥—åˆ©æ¼æ´ã€‚

### 9.4 æœªæ¥æ‰©å±•å»ºè®®

| é˜¶æ®µ | å»ºè®® |
|------|------|
| çŸ­æœŸ | å®æ–½æ–¹æ¡ˆ Cï¼Œå¯ç”¨ red_shard â†’ DIAMOND è§„åˆ™ |
| ä¸­æœŸ | å¦‚éœ€æ·»åŠ æ›´å¤šææ–™ç»„ï¼Œè€ƒè™‘å®æ–½ç™½åå•æœºåˆ¶ |
| é•¿æœŸ | éšç”¨æˆ·è§„æ¨¡å¢é•¿ï¼Œå¯å¼•å…¥äº¤æ˜“é™é¢å’Œå†·å´æœŸæœºåˆ¶ |

---

## åã€è¡Œä¸šæ–¹æ¡ˆå¯¹æ¯”æ€»ç»“

| æ–¹æ¡ˆç±»å‹ | ä»£è¡¨å…¬å¸ | è·¨ç»„è½¬æ¢ç­–ç•¥ | é€‚ç”¨åœºæ™¯ | æœ¬é¡¹ç›®é€‚é…åº¦ |
|----------|----------|--------------|----------|--------------|
| å¤§å‚ä¸¥æ ¼éš”ç¦» | è…¾è®¯/é˜¿é‡Œ | ç¦æ­¢æˆ–éœ€å®¡æ‰¹ | å¤§è§„æ¨¡ã€åˆè§„è¦æ±‚é«˜ | âŒ è¿‡åº¦è®¾è®¡ |
| æ¸¸æˆåˆ†è§£æ¨¡å¼ | åŸç¥/ç‹è€… | ææ–™â†’è´§å¸å•å‘ | æ¸¸æˆ/ç§¯åˆ†ç³»ç»Ÿ | âœ… é«˜åº¦é€‚é… |
| å°å…¬å¸ç®€æ˜“æ¨¡å¼ | å„ç±»å°å¹³å° | æ— é™åˆ¶æˆ–ç®€å•é™é¢ | å¿«é€Ÿä¸Šçº¿ | âš ï¸ é£æ§ä¸è¶³ |
| **æ¨èï¼šå…¨å±€å¥—åˆ©æ£€æµ‹** | - | å…è®¸è·¨ç»„+å…¨å±€é£æ§ | ä¸­å°å‹ç³»ç»Ÿ | âœ… **æœ€ä½³å¹³è¡¡** |

---

## é™„å½•Aï¼šè¯¦ç»†ä»£ç æ‰§è¡Œæ­¥éª¤

### åç«¯æŠ€æœ¯æ ˆç¡®è®¤

| å±‚çº§ | æŠ€æœ¯ | ç‰ˆæœ¬ |
|------|------|------|
| è¿è¡Œæ—¶ | Node.js | >=20.18.0 |
| APIæ¡†æ¶ | Express | ^4.21.2 |
| ORM | Sequelize | ^6.37.5 |
| æ•°æ®åº“ | MySQL (mysql2) | ^3.11.5 |
| ç›®æ ‡æ–‡ä»¶ | `utils/materialConversionValidator.js` | 327è¡Œ |

> âš ï¸ **æœ¬æ–‡æ¡£ä»…æ¶‰åŠåç«¯ä»£ç ä¿®æ”¹ï¼Œä¸æ¶‰åŠä»»ä½•å‰ç«¯é¡¹ç›®ã€‚**

---

### æ­¥éª¤1ï¼šå¤‡ä»½åŸæ–‡ä»¶

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
cp utils/materialConversionValidator.js utils/materialConversionValidator.js.backup
```

---

### æ­¥éª¤2ï¼šå®šä½ä¿®æ”¹ä½ç½®

**æ–‡ä»¶**: `/home/devbox/project/utils/materialConversionValidator.js`

| ä¿®æ”¹ç±»å‹ | ä»£ç è¡Œå· | å½“å‰çŠ¶æ€ |
|----------|----------|----------|
| ğŸ”´ æ–°å¢ | ç¬¬253è¡Œå | æ–°å¢ç»ˆç‚¹è´§å¸æ£€æŸ¥ |
| âŒ åˆ é™¤ | ç¬¬254-261è¡Œ | è·¨ç»„æ ¡éªŒä»£ç å— |
| ğŸ”§ ä¿®æ”¹ | ç¬¬269-285è¡Œ | è§„åˆ™æŸ¥è¯¢é€»è¾‘ |

---

### æ­¥éª¤3ï¼šå®Œæ•´ä»£ç å˜æ›´

#### 3.1 ä¿®æ”¹ `validate` æ–¹æ³•ï¼ˆç¬¬225-324è¡Œï¼‰

**ä¿®æ”¹å‰**ï¼ˆç¬¬244-285è¡Œï¼Œå…³é”®éƒ¨åˆ†ï¼‰:

```javascript
      if (!toMaterial) {
        errors.push(`ç›®æ ‡ææ–™ ${newRule.to_asset_code} ä¸å­˜åœ¨äº material_asset_types è¡¨ä¸­`)
        return { valid: false, errors }
      }

      // ğŸ”´ P1-1 é˜²å‘†ï¼šå¼ºåˆ¶æ ¡éªŒæºææ–™å’Œç›®æ ‡ææ–™å¿…é¡»å±äºåŒä¸€ group_code
      if (fromMaterial.group_code !== toMaterial.group_code) {
        errors.push(
          `è·¨ç»„è½¬æ¢è§„åˆ™è¢«æ‹’ç»ï¼šæºææ–™ ${newRule.from_asset_code} (${fromMaterial.group_code}ç»„) ` +
            `ä¸ç›®æ ‡ææ–™ ${newRule.to_asset_code} (${toMaterial.group_code}ç»„) ä¸å±äºåŒä¸€ææ–™ç»„`
        )
        return { valid: false, errors }
      }

      const targetGroupCode = fromMaterial.group_code

      /*
       * ğŸ”´ P1-1 æ ¸å¿ƒä¿®å¤ï¼šæŸ¥è¯¢è§„åˆ™æ—¶æŒ‰ group_code é™å®šèŒƒå›´
       * åªæŸ¥è¯¢ä¸æ–°è§„åˆ™åŒä¸€ group_code çš„å·²ç”Ÿæ•ˆä¸”å¯ç”¨çš„è§„åˆ™
       */
      const effectiveRules = await MaterialConversionRule.findAll({
        where: {
          is_enabled: true,
          effective_at: {
            [Op.lte]: new Date()
          }
        },
        include: [
          {
            model: MaterialAssetType,
            as: 'fromMaterial',
            where: { group_code: targetGroupCode },
            attributes: ['asset_code', 'group_code']
          }
        ],
        transaction: options.transaction
      })
```

**ä¿®æ”¹å**:

```javascript
      if (!toMaterial) {
        errors.push(`ç›®æ ‡ææ–™ ${newRule.to_asset_code} ä¸å­˜åœ¨äº material_asset_types è¡¨ä¸­`)
        return { valid: false, errors }
      }

      // ğŸ”´ V2.1 ç¡¬çº¦æŸï¼šç»ˆç‚¹è´§å¸ï¼ˆå¦‚ DIAMONDï¼‰ç¦æ­¢ä½œä¸ºè½¬æ¢æº
      // ä¸šåŠ¡è§„åˆ™ï¼šé’»çŸ³æ˜¯ç³»ç»Ÿã€Œç»ˆç‚¹è´§å¸ã€ï¼Œåªè¿›ä¸å‡º
      const TERMINAL_CURRENCIES = ['DIAMOND']
      if (TERMINAL_CURRENCIES.includes(newRule.from_asset_code)) {
        errors.push(
          `è½¬æ¢è§„åˆ™è¢«æ‹’ç»ï¼š${newRule.from_asset_code} æ˜¯ç»ˆç‚¹è´§å¸ï¼ˆåªè¿›ä¸å‡ºï¼‰ï¼Œç¦æ­¢è½¬åŒ–ä¸ºå…¶ä»–èµ„äº§ã€‚` +
            `å¦‚éœ€è°ƒæ•´æ­¤è§„åˆ™ï¼Œè¯·ä¿®æ”¹ TERMINAL_CURRENCIES é…ç½®ã€‚`
        )
        return { valid: false, errors }
      }

      // ğŸ”´ V2.1 ç§»é™¤è·¨ç»„é™åˆ¶ï¼šå…è®¸ä¸åŒ group_code ä¹‹é—´çš„è½¬æ¢
      // åŸè·¨ç»„æ ¡éªŒä»£ç å·²åˆ é™¤ï¼Œç°åœ¨ä¾èµ–å…¨å±€å¥—åˆ©æ£€æµ‹è¿›è¡Œé£æ§

      /*
       * ğŸ”´ V2.1 æ ¸å¿ƒä¿®æ”¹ï¼šå…¨å±€èŒƒå›´æŸ¥è¯¢è§„åˆ™
       * æŸ¥è¯¢æ‰€æœ‰å·²ç”Ÿæ•ˆä¸”å¯ç”¨çš„è§„åˆ™ï¼ˆä¸å†æŒ‰ group_code è¿‡æ»¤ï¼‰
       * è¿™æ ·å¯ä»¥æ£€æµ‹è·¨ç»„è§„åˆ™ç»„åˆå½¢æˆçš„é—­ç¯å’Œå¥—åˆ©è·¯å¾„
       */
      const effectiveRules = await MaterialConversionRule.findAll({
        where: {
          is_enabled: true,
          effective_at: {
            [Op.lte]: new Date()
          }
        },
        include: [
          {
            model: MaterialAssetType,
            as: 'fromMaterial',
            // ğŸ”´ ç§»é™¤ where: { group_code: targetGroupCode } æ¡ä»¶
            attributes: ['asset_code', 'group_code']
          }
        ],
        transaction: options.transaction
      })
```

---

#### 3.2 ä¿®æ”¹é”™è¯¯æç¤ºä¿¡æ¯ï¼ˆç¬¬293-310è¡Œï¼‰

**ä¿®æ”¹å‰**:

```javascript
      // 1. å¾ªç¯æ‹¦æˆªæ£€æµ‹ï¼ˆç»„å†…ç‹¬ç«‹æ£€æµ‹ï¼‰
      const cycleResult = this.detectCycle(graph)
      if (cycleResult.hasCycle) {
        const cyclePath = cycleResult.cycle.join(' â†’ ')
        errors.push(
          `æ£€æµ‹åˆ°å¾ªç¯è½¬æ¢è·¯å¾„ï¼ˆ${targetGroupCode}ç»„å†…ï¼‰ï¼š${cyclePath}ã€‚` +
            'ç¦æ­¢å‡ºç°å¯å›åˆ°è‡ªèº«çš„è½¬æ¢é—­ç¯ã€‚'
        )
      }

      // 2. å¥—åˆ©é—­ç¯æ£€æµ‹ï¼ˆè´Ÿç¯æ£€æµ‹ï¼Œç»„å†…ç‹¬ç«‹æ£€æµ‹ï¼‰
      const negativeCycleResult = this.detectNegativeCycle(graph)
      if (negativeCycleResult.hasNegativeCycle) {
        const cyclePath = negativeCycleResult.cycle.join(' â†’ ')
        errors.push(
          `æ£€æµ‹åˆ°å¥—åˆ©é—­ç¯ï¼ˆ${targetGroupCode}ç»„å†…ï¼‰ï¼š${cyclePath}ã€‚` +
            'æ²¿æ­¤ç¯è·¯è½¬æ¢ä¸€åœˆå¯å¢åŠ èµ„äº§æ€»é‡ï¼Œå­˜åœ¨å¥—åˆ©é£é™©ã€‚'
        )
      }
```

**ä¿®æ”¹å**:

```javascript
      // 1. å¾ªç¯æ‹¦æˆªæ£€æµ‹ï¼ˆå…¨å±€èŒƒå›´æ£€æµ‹ï¼‰
      const cycleResult = this.detectCycle(graph)
      if (cycleResult.hasCycle) {
        const cyclePath = cycleResult.cycle.join(' â†’ ')
        errors.push(
          `æ£€æµ‹åˆ°å¾ªç¯è½¬æ¢è·¯å¾„ï¼ˆå…¨å±€ï¼‰ï¼š${cyclePath}ã€‚` +
            'ç¦æ­¢å‡ºç°å¯å›åˆ°è‡ªèº«çš„è½¬æ¢é—­ç¯ã€‚'
        )
      }

      // 2. å¥—åˆ©é—­ç¯æ£€æµ‹ï¼ˆè´Ÿç¯æ£€æµ‹ï¼Œå…¨å±€èŒƒå›´æ£€æµ‹ï¼‰
      const negativeCycleResult = this.detectNegativeCycle(graph)
      if (negativeCycleResult.hasNegativeCycle) {
        const cyclePath = negativeCycleResult.cycle.join(' â†’ ')
        errors.push(
          `æ£€æµ‹åˆ°å¥—åˆ©é—­ç¯ï¼ˆå…¨å±€ï¼‰ï¼š${cyclePath}ã€‚` +
            'æ²¿æ­¤ç¯è·¯è½¬æ¢ä¸€åœˆå¯å¢åŠ èµ„äº§æ€»é‡ï¼Œå­˜åœ¨å¥—åˆ©é£é™©ã€‚'
        )
      }
```

---

#### 3.3 åˆ é™¤æ— ç”¨å˜é‡ï¼ˆç¬¬263è¡Œï¼‰

**åˆ é™¤**:
```javascript
const targetGroupCode = fromMaterial.group_code
```

---

### æ­¥éª¤4ï¼šä¿®æ”¹æ–‡ä»¶å¤´éƒ¨æ³¨é‡Š

**ä¿®æ”¹å‰**ï¼ˆç¬¬11-16è¡Œï¼‰:

```javascript
 * ç¡¬çº¦æŸï¼ˆæ¥è‡ªæ–‡æ¡£ï¼‰ï¼š
 * - **å¾ªç¯æ‹¦æˆªï¼ˆå¿…æ‹¦æˆªï¼‰**ï¼šæ–°å¢/å¯ç”¨è§„åˆ™åï¼Œå­˜åœ¨ä»æŸä¸ª asset_code å‡ºå‘å¯å›åˆ°è‡ªèº«çš„è·¯å¾„
 * - **å¥—åˆ©é—­ç¯æ‹¦æˆªï¼ˆå¿…æ‹¦æˆªï¼‰**ï¼šå­˜åœ¨ä»»æ„é—­ç¯ä½¿å¾—"æ²¿ç¯è·¯æ¢ä¸€åœˆèµ„äº§æ•°é‡ä¸å‡åå¢"
 *   - åˆ¤å®šæ–¹æ³•ï¼šå°†æ¯æ¡è§„åˆ™å€ç‡ r=to_amount/from_amount å¯¹æ•°åŒ–ä¸ºè¾¹æƒ w=-log(r)ï¼Œåšæœ‰å‘å›¾è´Ÿç¯æ£€æµ‹ï¼ˆBellman-Fordï¼‰
 *   - èŒƒå›´é™å®šï¼šåŒä¸€ group_code + å·²ç”Ÿæ•ˆï¼ˆeffective_at <= NOW()ï¼‰+ is_enabled=true çš„è§„åˆ™é›†åˆå†…
 *
 * åˆ›å»ºæ—¶é—´ï¼š2025-12-15
```

**ä¿®æ”¹å**:

```javascript
 * ç¡¬çº¦æŸï¼ˆæ¥è‡ªæ–‡æ¡£ï¼‰ï¼š
 * - **å¾ªç¯æ‹¦æˆªï¼ˆå¿…æ‹¦æˆªï¼‰**ï¼šæ–°å¢/å¯ç”¨è§„åˆ™åï¼Œå­˜åœ¨ä»æŸä¸ª asset_code å‡ºå‘å¯å›åˆ°è‡ªèº«çš„è·¯å¾„
 * - **å¥—åˆ©é—­ç¯æ‹¦æˆªï¼ˆå¿…æ‹¦æˆªï¼‰**ï¼šå­˜åœ¨ä»»æ„é—­ç¯ä½¿å¾—"æ²¿ç¯è·¯æ¢ä¸€åœˆèµ„äº§æ•°é‡ä¸å‡åå¢"
 *   - åˆ¤å®šæ–¹æ³•ï¼šå°†æ¯æ¡è§„åˆ™å€ç‡ r=to_amount/from_amount å¯¹æ•°åŒ–ä¸ºè¾¹æƒ w=-log(r)ï¼Œåšæœ‰å‘å›¾è´Ÿç¯æ£€æµ‹ï¼ˆBellman-Fordï¼‰
 *   - èŒƒå›´é™å®šï¼šå…¨å±€æ‰€æœ‰å·²ç”Ÿæ•ˆï¼ˆeffective_at <= NOW()ï¼‰+ is_enabled=true çš„è§„åˆ™é›†åˆå†…
 * - **ç»ˆç‚¹è´§å¸ç¦æ­¢æµå‡ºï¼ˆå¿…æ‹¦æˆªï¼‰**ï¼šDIAMOND ç­‰ç»ˆç‚¹è´§å¸ç¦æ­¢ä½œä¸º from_asset_code
 *
 * åˆ›å»ºæ—¶é—´ï¼š2025-12-15
 * æ›´æ–°æ—¶é—´ï¼š2026-01-26ï¼ˆV2.1 æ”¯æŒè·¨ç»„è½¬æ¢ + ç»ˆç‚¹è´§å¸é™åˆ¶ï¼‰
```

---

### æ­¥éª¤5ï¼šé‡å¯æœåŠ¡

```bash
# ä½¿ç”¨ PM2
pm2 restart restaurant-lottery-backend

# æˆ–ä½¿ç”¨ nodemonï¼ˆå¼€å‘ç¯å¢ƒï¼‰
# ä¿å­˜æ–‡ä»¶åè‡ªåŠ¨é‡å¯
```

---

### æ­¥éª¤6ï¼šéªŒè¯ä¿®æ”¹

```bash
# 1. æµ‹è¯•åˆ›å»ºè§„åˆ™ API
curl -X POST http://localhost:3000/api/v4/admin/material-conversion-rules \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "from_asset_code": "red_shard",
    "to_asset_code": "DIAMOND",
    "from_amount": 1,
    "to_amount": 20,
    "is_enabled": true
  }'

# 2. æµ‹è¯•ç»ˆç‚¹è´§å¸ç¦æ­¢æµå‡ºï¼ˆåº”è¿”å›é”™è¯¯ï¼‰
curl -X POST http://localhost:3000/api/v4/admin/material-conversion-rules \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "from_asset_code": "DIAMOND",
    "to_asset_code": "red_shard",
    "from_amount": 20,
    "to_amount": 1,
    "is_enabled": true
  }'
# é¢„æœŸè¿”å›ï¼šè½¬æ¢è§„åˆ™è¢«æ‹’ç»ï¼šDIAMOND æ˜¯ç»ˆç‚¹è´§å¸...
```

---

## é™„å½•Bï¼šå®Œæ•´ä¿®æ”¹åçš„ validate æ–¹æ³•ä»£ç 

```javascript
  /**
   * å®Œæ•´é£æ§æ ¡éªŒï¼ˆå¾ªç¯æ‹¦æˆª + å¥—åˆ©é—­ç¯æ£€æµ‹ + ç»ˆç‚¹è´§å¸é™åˆ¶ï¼‰
   *
   * ğŸ”´ V2.1 æ›´æ–°ï¼š
   * - ç§»é™¤è·¨ç»„é™åˆ¶ï¼Œå…è®¸ä¸åŒ group_code ä¹‹é—´çš„è½¬æ¢
   * - æ–°å¢ç»ˆç‚¹è´§å¸ï¼ˆDIAMONDï¼‰ç¦æ­¢æµå‡ºæ£€æŸ¥
   * - å¥—åˆ©æ£€æµ‹èŒƒå›´ä»"ç»„å†…"æ‰©å¤§åˆ°"å…¨å±€"
   *
   * @param {MaterialConversionRule} newRule - æ–°å¢çš„è§„åˆ™ï¼ˆæˆ–å¾…å¯ç”¨çš„è§„åˆ™ï¼‰
   * @param {Object} options - é€‰é¡¹å‚æ•°
   * @param {Sequelize.Transaction} options.transaction - äº‹åŠ¡å¯¹è±¡ï¼ˆå¯é€‰ï¼‰
   * @returns {Promise<Object>} { valid: boolean, errors: Array<string> }
   */
  static async validate(newRule, options = {}) {
    const errors = []

    try {
      const { MaterialAssetType } = require('../models')

      // æŸ¥è¯¢æºææ–™å’Œç›®æ ‡ææ–™ä¿¡æ¯
      const [fromMaterial, toMaterial] = await Promise.all([
        MaterialAssetType.findOne({
          where: { asset_code: newRule.from_asset_code },
          transaction: options.transaction
        }),
        MaterialAssetType.findOne({
          where: { asset_code: newRule.to_asset_code },
          transaction: options.transaction
        })
      ])

      if (!fromMaterial) {
        errors.push(`æºææ–™ ${newRule.from_asset_code} ä¸å­˜åœ¨äº material_asset_types è¡¨ä¸­`)
        return { valid: false, errors }
      }

      if (!toMaterial) {
        errors.push(`ç›®æ ‡ææ–™ ${newRule.to_asset_code} ä¸å­˜åœ¨äº material_asset_types è¡¨ä¸­`)
        return { valid: false, errors }
      }

      // ğŸ”´ V2.1 ç¡¬çº¦æŸï¼šç»ˆç‚¹è´§å¸ï¼ˆå¦‚ DIAMONDï¼‰ç¦æ­¢ä½œä¸ºè½¬æ¢æº
      const TERMINAL_CURRENCIES = ['DIAMOND']
      if (TERMINAL_CURRENCIES.includes(newRule.from_asset_code)) {
        errors.push(
          `è½¬æ¢è§„åˆ™è¢«æ‹’ç»ï¼š${newRule.from_asset_code} æ˜¯ç»ˆç‚¹è´§å¸ï¼ˆåªè¿›ä¸å‡ºï¼‰ï¼Œç¦æ­¢è½¬åŒ–ä¸ºå…¶ä»–èµ„äº§ã€‚` +
            `å¦‚éœ€è°ƒæ•´æ­¤è§„åˆ™ï¼Œè¯·ä¿®æ”¹ TERMINAL_CURRENCIES é…ç½®ã€‚`
        )
        return { valid: false, errors }
      }

      // ğŸ”´ V2.1 å…¨å±€èŒƒå›´æŸ¥è¯¢è§„åˆ™ï¼ˆä¸å†æŒ‰ group_code è¿‡æ»¤ï¼‰
      const effectiveRules = await MaterialConversionRule.findAll({
        where: {
          is_enabled: true,
          effective_at: {
            [Op.lte]: new Date()
          }
        },
        include: [
          {
            model: MaterialAssetType,
            as: 'fromMaterial',
            attributes: ['asset_code', 'group_code']
          }
        ],
        transaction: options.transaction
      })

      // å°†æ–°è§„åˆ™åŠ å…¥è§„åˆ™é›†åˆï¼ˆæ¨¡æ‹Ÿæ–°è§„åˆ™å¯ç”¨åçš„å›¾ç»“æ„ï¼‰
      const allRules = [...effectiveRules, newRule]

      // æ„å»ºè§„åˆ™æœ‰å‘å›¾ï¼ˆå…¨å±€è§„åˆ™ï¼‰
      const graph = this.buildRuleGraph(allRules)

      // 1. å¾ªç¯æ‹¦æˆªæ£€æµ‹ï¼ˆå…¨å±€èŒƒå›´æ£€æµ‹ï¼‰
      const cycleResult = this.detectCycle(graph)
      if (cycleResult.hasCycle) {
        const cyclePath = cycleResult.cycle.join(' â†’ ')
        errors.push(
          `æ£€æµ‹åˆ°å¾ªç¯è½¬æ¢è·¯å¾„ï¼ˆå…¨å±€ï¼‰ï¼š${cyclePath}ã€‚` +
            'ç¦æ­¢å‡ºç°å¯å›åˆ°è‡ªèº«çš„è½¬æ¢é—­ç¯ã€‚'
        )
      }

      // 2. å¥—åˆ©é—­ç¯æ£€æµ‹ï¼ˆè´Ÿç¯æ£€æµ‹ï¼Œå…¨å±€èŒƒå›´æ£€æµ‹ï¼‰
      const negativeCycleResult = this.detectNegativeCycle(graph)
      if (negativeCycleResult.hasNegativeCycle) {
        const cyclePath = negativeCycleResult.cycle.join(' â†’ ')
        errors.push(
          `æ£€æµ‹åˆ°å¥—åˆ©é—­ç¯ï¼ˆå…¨å±€ï¼‰ï¼š${cyclePath}ã€‚` +
            'æ²¿æ­¤ç¯è·¯è½¬æ¢ä¸€åœˆå¯å¢åŠ èµ„äº§æ€»é‡ï¼Œå­˜åœ¨å¥—åˆ©é£é™©ã€‚'
        )
      }

      return {
        valid: errors.length === 0,
        errors
      }
    } catch (error) {
      console.error('é£æ§æ ¡éªŒå¤±è´¥:', error)
      return {
        valid: false,
        errors: [`é£æ§æ ¡éªŒå¤±è´¥ï¼š${error.message}`]
      }
    }
  }
```

---

## é™„å½•Cï¼šå…¨å±€å¥—åˆ©æ£€æµ‹åŸç†è¯´æ˜

### C.1 ä¸ºä»€ä¹ˆç§»é™¤è·¨ç»„é™åˆ¶åä»ç„¶å®‰å…¨ï¼Ÿ

| é£æ§å±‚çº§ | æ£€æµ‹æœºåˆ¶ | é˜²æŠ¤ç›®æ ‡ | æ˜¯å¦å—å½±å“ |
|----------|----------|----------|------------|
| **ç¬¬1å±‚** | ç»ˆç‚¹è´§å¸æ£€æŸ¥ | ğŸ”´ DIAMOND ç¦æ­¢æµå‡º | âœ… æ–°å¢ä¿æŠ¤ |
| **ç¬¬2å±‚** | å¾ªç¯æ£€æµ‹ (DFS) | Aâ†’Bâ†’Câ†’A é—­ç¯ | âœ… ä¸å—å½±å“ |
| **ç¬¬3å±‚** | è´Ÿç¯æ£€æµ‹ (Bellman-Ford) | å¥—åˆ©é—­ç¯ | âœ… èŒƒå›´æ‰©å¤§åˆ°å…¨å±€ |

### C.2 å¥—åˆ©æ£€æµ‹ç®—æ³•åŸç†

**è¾¹æƒè®¡ç®—**:
```
weight = -log(to_amount / from_amount)
```

**ç¤ºä¾‹**ï¼ˆå½“å‰è§„åˆ™ red_shard â†’ DIAMOND 1:20ï¼‰:
```
rate = 20 / 1 = 20
weight = -log(20) â‰ˆ -2.996
```

**è´Ÿç¯å«ä¹‰**:
- å¦‚æœå­˜åœ¨ä¸€æ¡ç¯è·¯ï¼Œè¾¹æƒä¹‹å’Œ < 0
- è¯´æ˜æ²¿ç¯è·¯è½¬æ¢ä¸€åœˆï¼Œèµ„äº§æ€»é‡ä¼šå¢åŠ ï¼ˆå¥—åˆ©æœºä¼šï¼‰
- Bellman-Ford ç®—æ³•èƒ½åœ¨ O(V*E) æ—¶é—´å†…æ£€æµ‹è´Ÿç¯

### C.3 å½“å‰ç³»ç»Ÿé£é™©è¯„ä¼°

| æ¡ä»¶ | å½“å‰çŠ¶æ€ | é£é™©ç­‰çº§ |
|------|----------|----------|
| è§„åˆ™æ•°é‡ | 1æ¡ï¼ˆred_shardâ†’DIAMONDï¼‰ | âœ… æä½ |
| åå‘è§„åˆ™ | ç¦æ­¢ï¼ˆç»ˆç‚¹è´§å¸é™åˆ¶ï¼‰ | âœ… æ— é£é™© |
| é—­ç¯å¯èƒ½ | æ— ï¼ˆå•å‘è§„åˆ™ï¼‰ | âœ… æ— é£é™© |
| æœªæ¥æ‰©å±• | å…¨å±€æ£€æµ‹è‡ªåŠ¨è¦†ç›– | âœ… å·²é¢„é˜² |

---

**æ–‡æ¡£ç»“æŸ**
