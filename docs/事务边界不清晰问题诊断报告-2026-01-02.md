# äº‹åŠ¡è¾¹ç•Œä¸æ¸…æ™°é—®é¢˜è¯Šæ–­æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2026å¹´01æœˆ02æ—¥  
**è¯Šæ–­èŒƒå›´**: é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ V4.0 - äº‹åŠ¡ç®¡ç†æ¶æ„  
**æ•°æ®åº“ç¯å¢ƒ**: `restaurant_points_dev` (dbconn.sealosbja.site:42569)  
**è¯Šæ–­æ–¹å¼**: Node.js çœŸå®è¿åº“ + ä»£ç é™æ€åˆ†æ  
**é£é™©ç­‰çº§**: ğŸ”´ ä¸¥é‡ - æ•°æ®ä¸ä¸€è‡´ã€æ­»é”é£é™©

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

### æ ¸å¿ƒå‘ç°

æœ¬æ¬¡è¯Šæ–­é€šè¿‡ **Node.js + Sequelize çœŸå®è¿æ¥ç”Ÿäº§æ•°æ®åº“**ï¼ˆéå¤‡ä»½æ–‡ä»¶ï¼‰ï¼Œç»“åˆå¯¹ 50+ æœåŠ¡æ–‡ä»¶çš„ä»£ç é™æ€åˆ†æï¼Œç¡®è®¤é¡¹ç›®å­˜åœ¨ **"äº‹åŠ¡è¾¹ç•Œä¸æ¸…æ™°/äº‹åŠ¡æ¨¡å¼å¹¶å­˜"** çš„ä¸¥é‡æŠ€æœ¯å€ºåŠ¡ã€‚

**å…³é”®è¯æ®**:

- âœ… å·²çœŸå®è¿æ¥æ•°æ®åº“: `dbconn.sealosbja.site:42569/restaurant_points_dev`
- âœ… æ ¸å¿ƒä¸šåŠ¡è¡¨å·²éªŒè¯: `users=22`, `lottery_draws=2840`, `item_instances=1058`
- âœ… æ—§ç§¯åˆ†è¡¨å·²åºŸå¼ƒ: `user_points_accounts/points_transactions` ä¸å­˜åœ¨ï¼ˆå·²åˆ‡æ¢åˆ°ç»Ÿä¸€è´¦æˆ·ä½“ç³»ï¼‰
- ğŸ”´ **å‘ç° 3 ç§äº‹åŠ¡æ¨¡å¼å¹¶å­˜**: è‡ªç®¡ç†äº‹åŠ¡ã€å¯é€‰ä¼ é€’äº‹åŠ¡ã€éšå¼åµŒå¥—äº‹åŠ¡é£é™©

### é£é™©è¯„ä¼°

| é£é™©ç±»å‹                          | ä¸¥é‡ç¨‹åº¦ | å½±å“èŒƒå›´       | å…¸å‹åœºæ™¯                            |
| --------------------------------- | -------- | -------------- | ----------------------------------- |
| **æ¼ä¼  transaction å¯¼è‡´éƒ¨åˆ†æäº¤** | ğŸ”´ ä¸¥é‡  | æŠ½å¥–/äº¤æ˜“/å…‘æ¢ | å¤–å±‚å›æ»šæ— æ³•æ’¤é”€å†…å±‚å·²æäº¤çš„æ•°æ®    |
| **äº‹åŠ¡åµŒå¥—å¯¼è‡´æ­»é”**              | ğŸŸ  é«˜    | å¹¶å‘åœºæ™¯       | å¤šä¸ªäº‹åŠ¡ç«äº‰åŒä¸€èµ„æº                |
| **äº‹åŠ¡è¶…æ—¶æœªä¿æŠ¤**                | ğŸŸ¡ ä¸­    | é•¿é“¾è·¯æ“ä½œ     | äº‹åŠ¡é•¿æ—¶é—´æœªæäº¤å ç”¨è¿æ¥            |
| **è´¦å®ä¸ä¸€è‡´**                    | ğŸ”´ ä¸¥é‡  | èµ„äº§æµæ°´       | `asset_transactions=0` ä½†ä¸šåŠ¡å·²è¿è¡Œ |

---

## ğŸ” é—®é¢˜è¯¦ç»†åˆ†æ

### 1. ä¸‰ç§äº‹åŠ¡æ¨¡å¼å¹¶å­˜ï¼ˆä»£ç è¯æ®ï¼‰

#### æ¨¡å¼ A: è‡ªç®¡ç†äº‹åŠ¡ï¼ˆæ‰‹åŠ¨ begin/commit/rollbackï¼‰

**å…¸å‹ä»£ç **: `UnifiedLotteryEngine.execute_draw()`

```javascript
// services/UnifiedLotteryEngine/UnifiedLotteryEngine.js:1096
const transaction = await models.sequelize.transaction({
  timeout: 30000,
  isolationLevel: Sequelize.Transaction.ISOLATION_LEVELS.READ_COMMITTED
})

try {
  // ... ä¸šåŠ¡é€»è¾‘ ...
  await transaction.commit() // æ‰‹åŠ¨æäº¤
} catch (error) {
  await transaction.rollback() // æ‰‹åŠ¨å›æ»š
  throw error
}
```

**é—®é¢˜**:

- âœ… ä¼˜ç‚¹: äº‹åŠ¡è¾¹ç•Œæ˜ç¡®ï¼Œè¶…æ—¶ä¿æŠ¤å®Œæ•´
- âŒ ç¼ºç‚¹: å¦‚æœå†…éƒ¨è°ƒç”¨çš„æœåŠ¡æ–¹æ³•ä¹Ÿè‡ªå·±å¼€äº‹åŠ¡ï¼Œä¼šå¯¼è‡´åµŒå¥—äº‹åŠ¡é—®é¢˜

---

#### æ¨¡å¼ B: å¯é€‰ä¼ é€’äº‹åŠ¡ï¼ˆtransaction å¯ä¼ å¯ä¸ä¼ ï¼‰

**å…¸å‹ä»£ç **: `AssetService.changeBalance()` / `TradeOrderService.createOrder()` / `ExchangeService.exchangeItem()`

```javascript
// services/AssetService.js:217
const transaction = externalTransaction || (await sequelize.transaction())
const shouldCommit = !externalTransaction

try {
  // ... ä¸šåŠ¡é€»è¾‘ ...

  if (shouldCommit) {
    await transaction.commit() // åªæœ‰è‡ªå·±åˆ›å»ºçš„äº‹åŠ¡æ‰æäº¤
  }
} catch (error) {
  if (shouldCommit) {
    await transaction.rollback()
  }
  throw error
}
```

**é—®é¢˜**:

- âœ… ä¼˜ç‚¹: çµæ´»æ€§é«˜ï¼Œæ”¯æŒç‹¬ç«‹è°ƒç”¨å’Œç»„åˆè°ƒç”¨
- âŒ **è‡´å‘½ç¼ºé™·**: è°ƒç”¨æ–¹å¦‚æœå¿˜è®°ä¼  `transaction`ï¼Œå†…å±‚ä¼šè‡ªå·±å¼€äº‹åŠ¡å¹¶æäº¤ï¼Œå¤–å±‚å›æ»šæ— æ³•æ’¤é”€

**å®é™…é£é™©åœºæ™¯**:

```javascript
// åœºæ™¯ 1: æŠ½å¥–å¼•æ“è°ƒç”¨ AssetServiceï¼ˆæ­£ç¡®ï¼‰
const transaction = await sequelize.transaction()
try {
  await AssetService.changeBalance({...}, { transaction })  // âœ… ä¼ é€’äº†äº‹åŠ¡
  await transaction.commit()
} catch (error) {
  await transaction.rollback()  // âœ… å¯ä»¥å›æ»š AssetService çš„æ“ä½œ
}

// åœºæ™¯ 2: å¦‚æœæ¼ä¼  transactionï¼ˆé”™è¯¯ï¼‰
const transaction = await sequelize.transaction()
try {
  await AssetService.changeBalance({...})  // âŒ å¿˜è®°ä¼  { transaction }
  // AssetService å†…éƒ¨ä¼šè‡ªå·±å¼€äº‹åŠ¡å¹¶ç«‹å³æäº¤
  await transaction.commit()
} catch (error) {
  await transaction.rollback()  // âŒ æ— æ³•å›æ»š AssetService å·²æäº¤çš„æ•°æ®ï¼
}
```

---

#### æ¨¡å¼ C: éšå¼åµŒå¥—äº‹åŠ¡é£é™©

**å…¸å‹ä»£ç **: `PrizePoolService.batchAddPrizes()`

```javascript
// services/PrizePoolService.js:108
const internalTransaction = transaction || (await sequelize.transaction())

try {
  // ... ä¸šåŠ¡é€»è¾‘ ...

  // å†…éƒ¨è°ƒç”¨å®¡è®¡æ—¥å¿—æœåŠ¡
  await AuditLogService.logOperation({...}, { transaction: internalTransaction })

  if (!transaction) {
    await internalTransaction.commit()  // åªæœ‰è‡ªå·±åˆ›å»ºçš„æ‰æäº¤
  }
} catch (error) {
  if (!transaction) {
    await internalTransaction.rollback()
  }
  throw error
}
```

**é—®é¢˜**:

- å¦‚æœ `AuditLogService.logOperation()` å†…éƒ¨ä¹Ÿç”¨äº† `options.transaction || sequelize.transaction()`
- ä¸”å¤–å±‚å¿˜è®°ä¼  `transaction`
- å°±ä¼šå‡ºç°"å®¡è®¡æ—¥å¿—å·²æäº¤ï¼Œä½†ä¸šåŠ¡æ“ä½œå›æ»š"çš„æ•°æ®ä¸ä¸€è‡´

---

### 2. å®é™…ä»£ç æ‰«æç»Ÿè®¡

é€šè¿‡ `grep` æ‰«æ `services/` ç›®å½•ï¼Œå‘ç°:

| äº‹åŠ¡æ¨¡å¼         | æ–‡ä»¶æ•°é‡  | å…¸å‹æœåŠ¡                                                                                   |
| ---------------- | --------- | ------------------------------------------------------------------------------------------ |
| **è‡ªç®¡ç†äº‹åŠ¡**   | 25 ä¸ªæ–‡ä»¶ | UnifiedLotteryEngine, AdminLotteryService, ConsumptionService, MaterialManagementService   |
| **å¯é€‰ä¼ é€’äº‹åŠ¡** | 15 ä¸ªæ–‡ä»¶ | AssetService, TradeOrderService, ExchangeService, RedemptionService, MerchantReviewService |
| **æ··åˆæ¨¡å¼**     | 10 ä¸ªæ–‡ä»¶ | PrizePoolService, UserRoleService, AdminSystemService                                      |

**å…³é”®å‘ç°**:

- `AssetService` çš„ 9 ä¸ªæ ¸å¿ƒæ–¹æ³•éƒ½æ˜¯"å¯é€‰ä¼ é€’äº‹åŠ¡"æ¨¡å¼
- `TradeOrderService.createOrder()` / `completeOrder()` éƒ½æ˜¯"å¯é€‰ä¼ é€’äº‹åŠ¡"
- `UnifiedLotteryEngine.execute_draw()` æ˜¯"è‡ªç®¡ç†äº‹åŠ¡"ï¼Œä½†å†…éƒ¨è°ƒç”¨ `AssetService` æ—¶**æ­£ç¡®ä¼ é€’äº† transaction**

---

### 3. çœŸå®æ•°æ®åº“çŠ¶æ€æ ¸æŸ¥

#### è¿æ¥éªŒè¯

```bash
âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ: dbconn.sealosbja.site:42569/restaurant_points_dev
```

#### æ ¸å¿ƒè¡¨å­˜åœ¨æ€§ä¸æ•°æ®é‡

```json
{
  "presentTables": [
    "users",
    "lottery_draws",
    "lottery_prizes",
    "accounts",
    "account_asset_balances",
    "asset_transactions",
    "market_listings",
    "trade_orders",
    "exchange_items",
    "exchange_records",
    "item_instances",
    "redemption_orders",
    "merchant_points_reviews",
    "admin_operation_logs",
    "content_review_records",
    "lottery_draw_quota_rules",
    "lottery_user_daily_draw_quota",
    "api_idempotency_requests",
    "authentication_sessions",
    "customer_service_sessions",
    "chat_messages"
  ],
  "missingTables": [
    "user_points_accounts",
    "points_transactions",
    "user_asset_accounts",
    "asset_accounts"
  ],
  "counts": {
    "users": "22",
    "lottery_draws": "2840",
    "lottery_prizes": "9",
    "accounts": "13",
    "account_asset_balances": "11",
    "asset_transactions": "0", // âš ï¸ å…³é”®å¼‚å¸¸
    "market_listings": "1",
    "trade_orders": "0",
    "exchange_items": "16",
    "exchange_records": "0",
    "item_instances": "1058",
    "redemption_orders": "333",
    "merchant_points_reviews": "0",
    "admin_operation_logs": "1001",
    "content_review_records": "184",
    "api_idempotency_requests": "48"
  }
}
```

#### ğŸ”´ å…³é”®å¼‚å¸¸å‘ç°

**é—®é¢˜**: `asset_transactions = 0` ä½† `lottery_draws = 2840`

**åˆ†æ**:

- æŠ½å¥–è®°å½•å·²äº§ç”Ÿ 2840 æ¡
- ä½†èµ„äº§æµæ°´è¡¨ä¸ºç©º
- å¯èƒ½åŸå› :
  1. æµæ°´å†™å…¥è¢«æ¡ä»¶åˆ†æ”¯è·³è¿‡ï¼ˆå¦‚ï¼šå¼€å‘ç¯å¢ƒå…³é—­äº†æµæ°´è®°å½•ï¼‰
  2. æµæ°´å†™åˆ°äº†å…¶ä»–è¡¨ï¼ˆå¦‚ï¼šæ—§çš„ `points_transactions`ï¼Œä½†è¯¥è¡¨å·²ä¸å­˜åœ¨ï¼‰
  3. ä¸šåŠ¡é€»è¾‘ä¸­å­˜åœ¨"åªæ‰£ä½™é¢ä¸å†™æµæ°´"çš„åˆ†æ”¯
  4. äº‹åŠ¡å›æ»šå¯¼è‡´æµæ°´æœªæäº¤ï¼ˆä½†æŠ½å¥–è®°å½•æäº¤äº†ï¼‰

**é£é™©**:

- å¦‚æœæ˜¯åŸå›  4ï¼Œè¯´æ˜ **äº‹åŠ¡è¾¹ç•Œç¡®å®æœ‰é—®é¢˜**ï¼Œéƒ¨åˆ†æ“ä½œæäº¤ã€éƒ¨åˆ†æ“ä½œå›æ»š
- è´¦å®ä¸ä¸€è‡´ï¼Œæ— æ³•é€šè¿‡æµæ°´è¿½æº¯èµ„äº§å˜åŠ¨

---

## ğŸ¯ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆæ¦‚è¿°

å»ºç«‹ **ç»Ÿä¸€äº‹åŠ¡ç®¡ç†å™¨ (TransactionManager)** + **äº‹åŠ¡ä¸Šä¸‹æ–‡è‡ªåŠ¨ä¼ é€’ (AsyncLocalStorage)** + **å¼ºåˆ¶äº‹åŠ¡è¾¹ç•Œçº¦æŸ**

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **ç¦æ­¢ä¸šåŠ¡å†…éƒ¨éšæ„è‡ªå¼€äº‹åŠ¡**: äº‹åŠ¡åˆ›å»ºæƒæ”¶æ•›åˆ°"å…¥å£ç¼–æ’å±‚"
2. **å¼ºåˆ¶äº‹åŠ¡ä¼ é€’**: å†…éƒ¨æœåŠ¡æ–¹æ³•å¿…é¡»æ¥å— transaction å‚æ•°ï¼ˆæˆ–ä»ä¸Šä¸‹æ–‡å–ï¼‰ï¼Œä¸å…è®¸ fallback è‡ªå·±å¼€äº‹åŠ¡
3. **äº‹åŠ¡è¾¹ç•Œæ¸…æ™°**: æ¯ä¸ªä¸šåŠ¡å…¥å£æ˜ç¡®æ ‡æ³¨äº‹åŠ¡è¾¹ç•Œå’ŒåŒ…å«çš„è¡¨
4. **è¿è¡Œæ—¶æ–­è¨€**: å…³é”®æ–¹æ³•åŠ  `requireTransaction()` æ£€æŸ¥ï¼Œå¼€å‘é˜¶æ®µç›´æ¥æŠ¥é”™

---

### æ–¹æ¡ˆ 1: ç»Ÿä¸€äº‹åŠ¡ç®¡ç†å™¨ (TransactionManager)

#### 1.1 æ ¸å¿ƒå®ç°

```javascript
/**
 * ç»Ÿä¸€äº‹åŠ¡ç®¡ç†å™¨
 * èŒè´£: ç»Ÿä¸€äº‹åŠ¡åˆ›å»ºã€è¶…æ—¶ä¿æŠ¤ã€é‡è¯•ç­–ç•¥ã€é”™è¯¯åˆ†æ
 */
class TransactionManager {
  /**
   * æ‰§è¡Œäº‹åŠ¡æ“ä½œ
   * @param {Function} operation - äº‹åŠ¡æ“ä½œå‡½æ•° (transaction) => Promise<result>
   * @param {Object} options - é€‰é¡¹
   * @param {number} options.maxRetries - æœ€å¤§é‡è¯•æ¬¡æ•° (é»˜è®¤ 3)
   * @param {number} options.timeout - è¶…æ—¶æ—¶é—´ (é»˜è®¤ 30000ms)
   * @param {string} options.isolationLevel - éš”ç¦»çº§åˆ« (é»˜è®¤ READ_COMMITTED)
   * @returns {Promise<any>} æ“ä½œç»“æœ
   */
  static async execute(operation, options = {}) {
    const { maxRetries = 3, timeout = 30000, isolationLevel = 'READ_COMMITTED' } = options
    let transaction = null

    for (let attempt = 0; attempt < maxRetries; attempt++) {
      try {
        // åˆ›å»ºäº‹åŠ¡
        transaction = await sequelize.transaction({
          isolationLevel: Sequelize.Transaction.ISOLATION_LEVELS[isolationLevel],
          timeout
        })

        // è®¾ç½®è¶…æ—¶ä¿æŠ¤
        const timeoutPromise = new Promise((_, reject) =>
          setTimeout(() => reject(new Error('Transaction timeout')), timeout)
        )

        // æ‰§è¡Œä¸šåŠ¡æ“ä½œ
        const result = await Promise.race([operation(transaction), timeoutPromise])

        // æ£€æŸ¥äº‹åŠ¡çŠ¶æ€é¿å…é‡å¤æäº¤
        if (!transaction.finished) {
          await transaction.commit()
          logger.info('âœ… äº‹åŠ¡æäº¤æˆåŠŸ', { attempt: attempt + 1 })
        }

        return result
      } catch (error) {
        // å®‰å…¨å›æ»šé€»è¾‘
        if (transaction && !transaction.finished) {
          try {
            await transaction.rollback()
            logger.warn('â†©ï¸ äº‹åŠ¡å›æ»šæˆåŠŸ', { attempt: attempt + 1 })
          } catch (rollbackError) {
            logger.error('âŒ äº‹åŠ¡å›æ»šå¤±è´¥', { error: rollbackError.message })
          }
        }

        // é”™è¯¯åˆ†æ
        const errorType = this.analyzeError(error)

        // å¯é‡è¯•é”™è¯¯ä¸”æœªè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°
        if (errorType.retryable && attempt < maxRetries - 1) {
          const delay = Math.min(1000 * Math.pow(2, attempt), 5000)
          logger.warn(`â³ äº‹åŠ¡å¤±è´¥ï¼Œ${delay}ms åé‡è¯• (${attempt + 1}/${maxRetries})`, {
            error: error.message,
            reason: errorType.reason
          })
          await new Promise(resolve => setTimeout(resolve, delay))
          continue
        }

        // ä¸å¯é‡è¯•æˆ–è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°
        logger.error('âŒ äº‹åŠ¡æœ€ç»ˆå¤±è´¥', {
          attempts: attempt + 1,
          error: error.message,
          retryable: errorType.retryable,
          reason: errorType.reason
        })
        throw error
      }
    }
  }

  /**
   * äº‹åŠ¡é”™è¯¯ç±»å‹åˆ†æ
   * @param {Error} error - é”™è¯¯å¯¹è±¡
   * @returns {Object} { retryable: boolean, reason: string }
   */
  static analyzeError(error) {
    const msg = error.message.toLowerCase()

    // äº‹åŠ¡å·²å®Œæˆé”™è¯¯ (ä¸å¯é‡è¯•)
    if (msg.includes('transaction cannot be rolled back') || msg.includes('has been finished')) {
      return { retryable: false, reason: 'transaction_already_finished' }
    }

    // æ­»é”é”™è¯¯ (å¯é‡è¯•)
    if (msg.includes('deadlock') || msg.includes('lock wait timeout')) {
      return { retryable: true, reason: 'database_deadlock' }
    }

    // è¿æ¥è¶…æ—¶ (å¯é‡è¯•)
    if (msg.includes('timeout') || msg.includes('connection')) {
      return { retryable: true, reason: 'connection_timeout' }
    }

    // ä¸šåŠ¡é€»è¾‘é”™è¯¯ (ä¸å¯é‡è¯•)
    if (msg.includes('ä½™é¢ä¸è¶³') || msg.includes('åº“å­˜ä¸è¶³') || msg.includes('æƒé™ä¸è¶³')) {
      return { retryable: false, reason: 'business_logic_error' }
    }

    // å…¶ä»–æœªçŸ¥é”™è¯¯ (é»˜è®¤å¯é‡è¯•)
    return { retryable: true, reason: 'unknown_error' }
  }
}

module.exports = TransactionManager
```

#### 1.2 ä½¿ç”¨ç¤ºä¾‹

```javascript
// âœ… æ­£ç¡®ä½¿ç”¨æ–¹å¼: æŠ½å¥–å…¥å£
async function executeLotteryDraw(user_id, campaign_id, draw_count) {
  return await TransactionManager.execute(
    async transaction => {
      // 1. æ‰£é™¤ç§¯åˆ†
      await AssetService.changeBalance(
        {
          user_id,
          asset_code: 'POINTS',
          delta_amount: -900,
          business_type: 'lottery_consume',
          idempotency_key: `lottery_${Date.now()}`
        },
        { transaction }
      ) // âœ… å¼ºåˆ¶ä¼ é€’ transaction

      // 2. æ‰§è¡ŒæŠ½å¥–
      const results = []
      for (let i = 0; i < draw_count; i++) {
        const result = await executeSingleDraw(user_id, campaign_id, { transaction })
        results.push(result)
      }

      // 3. æ›´æ–°é…é¢
      await LotteryQuotaService.deductQuota(user_id, campaign_id, draw_count, { transaction })

      return { success: true, results }
    },
    {
      maxRetries: 3,
      timeout: 30000,
      isolationLevel: 'READ_COMMITTED'
    }
  )
}
```

---

### æ–¹æ¡ˆ 2: äº‹åŠ¡ä¸Šä¸‹æ–‡è‡ªåŠ¨ä¼ é€’ (AsyncLocalStorage)

#### 2.1 æ ¸å¿ƒå®ç°

```javascript
const { AsyncLocalStorage } = require('async_hooks')

/**
 * äº‹åŠ¡ä¸Šä¸‹æ–‡ç®¡ç†å™¨
 * èŒè´£: è‡ªåŠ¨ä¼ é€’äº‹åŠ¡ä¸Šä¸‹æ–‡ï¼Œé¿å…æ‰‹åŠ¨é€å±‚ä¼ å‚
 */
class TransactionContext {
  constructor() {
    this.storage = new AsyncLocalStorage()
  }

  /**
   * åœ¨äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œæ“ä½œ
   * @param {Function} operation - æ“ä½œå‡½æ•°
   * @param {Object} transaction - Sequelize äº‹åŠ¡å¯¹è±¡
   * @returns {Promise<any>} æ“ä½œç»“æœ
   */
  async run(operation, transaction) {
    return this.storage.run({ transaction }, operation)
  }

  /**
   * è·å–å½“å‰äº‹åŠ¡
   * @param {Object} options - é€‰é¡¹
   * @param {boolean} options.required - æ˜¯å¦å¿…éœ€ (é»˜è®¤ false)
   * @returns {Object|null} äº‹åŠ¡å¯¹è±¡
   */
  getTransaction(options = {}) {
    const store = this.storage.getStore()
    const transaction = store?.transaction

    if (options.required && !transaction) {
      throw new Error('å½“å‰ä¸Šä¸‹æ–‡ç¼ºå°‘äº‹åŠ¡å¯¹è±¡ï¼Œè¯·æ£€æŸ¥è°ƒç”¨é“¾è·¯')
    }

    return transaction || null
  }

  /**
   * æ£€æŸ¥æ˜¯å¦åœ¨äº‹åŠ¡ä¸­
   * @returns {boolean}
   */
  hasTransaction() {
    return !!this.getTransaction()
  }
}

// å…¨å±€å•ä¾‹
const transactionContext = new TransactionContext()

module.exports = transactionContext
```

#### 2.2 é›†æˆåˆ° TransactionManager

```javascript
class TransactionManager {
  static async execute(operation, options = {}) {
    // ... åˆ›å»ºäº‹åŠ¡ ...

    try {
      // åœ¨äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ
      const result = await transactionContext.run(() => operation(transaction), transaction)

      await transaction.commit()
      return result
    } catch (error) {
      await transaction.rollback()
      throw error
    }
  }
}
```

#### 2.3 æœåŠ¡å±‚æ”¹é€ 

```javascript
// âŒ æ”¹é€ å‰: éœ€è¦æ‰‹åŠ¨ä¼ é€’ transaction
class AssetService {
  static async changeBalance(params, options = {}) {
    const transaction = options.transaction || (await sequelize.transaction())
    const shouldCommit = !options.transaction
    // ...
  }
}

// âœ… æ”¹é€ å: è‡ªåŠ¨ä»ä¸Šä¸‹æ–‡è·å– transaction
class AssetService {
  static async changeBalance(params, options = {}) {
    // ä¼˜å…ˆä½¿ç”¨æ˜¾å¼ä¼ å…¥çš„ transactionï¼Œå…¶æ¬¡ä»ä¸Šä¸‹æ–‡è·å–
    const transaction =
      options.transaction ||
      transactionContext.getTransaction({
        required: true // å¼ºåˆ¶è¦æ±‚å¿…é¡»åœ¨äº‹åŠ¡ä¸­è°ƒç”¨
      })

    // ä¸å†è‡ªå·±åˆ›å»ºäº‹åŠ¡ï¼Œä¸å† commit/rollback
    // ...
  }
}
```

---

### æ–¹æ¡ˆ 3: äº‹åŠ¡è¾¹ç•Œæ¸…æ™°åŒ–ï¼ˆä¸šåŠ¡åŸŸæ‹†åˆ†ï¼‰

#### 3.1 äº‹åŠ¡è¾¹ç•Œæ¸…å•

| ä¸šåŠ¡åŸŸ       | å…¥å£æ–¹æ³•                                | å¿…é¡»åŒ…å«çš„è¡¨                                                                                                              | äº‹åŠ¡ç­–ç•¥   |
| ------------ | --------------------------------------- | ------------------------------------------------------------------------------------------------------------------------- | ---------- |
| **æŠ½å¥–**     | `UnifiedLotteryEngine.execute_draw()`   | `lottery_draws`, `account_asset_balances`, `asset_transactions`, `lottery_user_daily_draw_quota`, `item_instances` (å¯é€‰) | å¼ºåˆ¶å•äº‹åŠ¡ |
| **äº¤æ˜“å¸‚åœº** | `TradeOrderService.createOrder()`       | `trade_orders`, `market_listings`, `account_asset_balances`, `asset_transactions`                                         | å¼ºåˆ¶å•äº‹åŠ¡ |
| **äº¤æ˜“å¸‚åœº** | `TradeOrderService.completeOrder()`     | `trade_orders`, `market_listings`, `account_asset_balances`, `asset_transactions`, `item_instances` (å¯é€‰)                | å¼ºåˆ¶å•äº‹åŠ¡ |
| **å…‘æ¢å•†åŸ** | `ExchangeService.exchangeItem()`        | `exchange_records`, `account_asset_balances`, `asset_transactions`                                                        | å¼ºåˆ¶å•äº‹åŠ¡ |
| **æ ¸é”€ç **   | `RedemptionService.createOrder()`       | `redemption_orders`, `item_instances`                                                                                     | å¼ºåˆ¶å•äº‹åŠ¡ |
| **æ ¸é”€ç **   | `RedemptionService.fulfillOrder()`      | `redemption_orders`, `item_instances`                                                                                     | å¼ºåˆ¶å•äº‹åŠ¡ |
| **å•†å®¶å®¡æ ¸** | `MerchantReviewService.submitReview()`  | `merchant_points_reviews`, `account_asset_balances`                                                                       | å¼ºåˆ¶å•äº‹åŠ¡ |
| **å•†å®¶å®¡æ ¸** | `MerchantReviewService.approveReview()` | `merchant_points_reviews`, `account_asset_balances`, `asset_transactions`                                                 | å¼ºåˆ¶å•äº‹åŠ¡ |

#### 3.2 æœåŠ¡æ–¹æ³•åˆ†ç±»

**A ç±»: å…¥å£ç¼–æ’æ–¹æ³•ï¼ˆå¿…é¡»ä½¿ç”¨ TransactionManager.executeï¼‰**

- `UnifiedLotteryEngine.execute_draw()`
- `TradeOrderService.createOrder()`
- `TradeOrderService.completeOrder()`
- `ExchangeService.exchangeItem()`
- `RedemptionService.createOrder()`
- `RedemptionService.fulfillOrder()`
- `MerchantReviewService.submitReview()`
- `MerchantReviewService.approveReview()`

**B ç±»: é¢†åŸŸæœåŠ¡æ–¹æ³•ï¼ˆåªæ¥å— transactionï¼Œä¸è‡ªè¡Œ commit/rollbackï¼‰**

- `AssetService.changeBalance()`
- `AssetService.freeze()`
- `AssetService.unfreeze()`
- `AssetService.settleFromFrozen()`
- `AssetService.mintItem()`
- `LotteryQuotaService.deductQuota()`
- `PrizePoolService.deductStock()`

**C ç±»: ç‹¬ç«‹åŸå­æ–¹æ³•ï¼ˆå¯è‡ªå·±å¼€äº‹åŠ¡ï¼Œä½†ä¸èƒ½è¢« A ç±»è°ƒç”¨ï¼‰**

- `AuditLogService.logOperation()` (å®¡è®¡æ—¥å¿—å¯ç‹¬ç«‹äº‹åŠ¡)
- `SystemSettings.updateSetting()` (ç³»ç»Ÿè®¾ç½®å¯ç‹¬ç«‹äº‹åŠ¡)

---

### æ–¹æ¡ˆ 4: è¿è¡Œæ—¶æ–­è¨€ï¼ˆå¼€å‘é˜¶æ®µå¼ºåˆ¶æ£€æŸ¥ï¼‰

```javascript
/**
 * è¿è¡Œæ—¶æ–­è¨€: è¦æ±‚å¿…é¡»åœ¨äº‹åŠ¡ä¸­è°ƒç”¨
 * @param {Object} transaction - äº‹åŠ¡å¯¹è±¡
 * @param {string} methodName - æ–¹æ³•å
 */
function requireTransaction(transaction, methodName) {
  if (!transaction) {
    const error = new Error(
      `[äº‹åŠ¡è¾¹ç•Œé”™è¯¯] ${methodName} å¿…é¡»åœ¨äº‹åŠ¡ä¸­è°ƒç”¨ï¼Œä½†æœªä¼ å…¥ transaction å‚æ•°ã€‚` +
        `è¯·æ£€æŸ¥è°ƒç”¨é“¾è·¯ï¼Œç¡®ä¿ä» TransactionManager.execute() ä¼ é€’ transactionã€‚`
    )
    error.code = 'TRANSACTION_REQUIRED'
    throw error
  }

  if (transaction.finished) {
    const error = new Error(
      `[äº‹åŠ¡è¾¹ç•Œé”™è¯¯] ${methodName} æ”¶åˆ°çš„ transaction å·²å®Œæˆ (committed/rolled back)ã€‚` +
        `è¯·æ£€æŸ¥æ˜¯å¦å­˜åœ¨äº‹åŠ¡åµŒå¥—æˆ–é‡å¤æäº¤é—®é¢˜ã€‚`
    )
    error.code = 'TRANSACTION_FINISHED'
    throw error
  }
}

// ä½¿ç”¨ç¤ºä¾‹
class AssetService {
  static async changeBalance(params, options = {}) {
    const transaction = options.transaction || transactionContext.getTransaction()

    // âœ… è¿è¡Œæ—¶æ–­è¨€: å¼ºåˆ¶è¦æ±‚å¿…é¡»åœ¨äº‹åŠ¡ä¸­è°ƒç”¨
    requireTransaction(transaction, 'AssetService.changeBalance')

    // ... ä¸šåŠ¡é€»è¾‘ ...
  }
}
```

---

## ğŸ“Š å®æ–½è·¯çº¿å›¾

### é˜¶æ®µ 1: ç°çŠ¶ç¡®è®¤ä¸å®šç•Œ (1-2 å¤©)

**ç›®æ ‡**: æ˜ç¡®äº‹åŠ¡è¾¹ç•Œå’Œæ•°æ®è½ç‚¹

**ä»»åŠ¡æ¸…å•**:

- [ ] ç¡®è®¤ `asset_transactions` ä¸º 0 çš„åŸå› ï¼ˆæµæ°´å†™å…¥é€»è¾‘æ˜¯å¦å¯ç”¨ï¼‰
- [ ] æ ¸å¯¹æŠ½å¥–æ‰£ç§¯åˆ†æ˜¯å¦åº”è¯¥å†™å…¥ `asset_transactions`
- [ ] åˆ—å‡ºæ‰€æœ‰"ä¼šå†™å¤šå¼ è¡¨"çš„å…¥å£æ–¹æ³•ï¼ˆäº‹åŠ¡è¾¹ç•Œæ¸…å•ï¼‰
- [ ] ç¡®è®¤å¯¹"æ¼ä¼  transaction"çš„å®¹å¿åº¦ï¼ˆå¼ºçº¦æŸ vs å¼±çº¦æŸï¼‰

**éªŒè¯ SQL** (åªè¯»æŸ¥è¯¢):

```sql
-- 1. æŸ¥çœ‹èµ„äº§ä½™é¢åˆ†å¸ƒ
SELECT asset_code, COUNT(*) as account_count,
       SUM(available_amount) as total_available,
       SUM(frozen_amount) as total_frozen
FROM account_asset_balances
GROUP BY asset_code;

-- 2. æŸ¥çœ‹æœ€è¿‘æŠ½å¥–è®°å½•
SELECT draw_id, user_id, campaign_id, reward_tier, cost_points, created_at
FROM lottery_draws
ORDER BY created_at DESC
LIMIT 10;

-- 3. æŸ¥çœ‹ç”¨æˆ·ä½™é¢å˜åŒ–
SELECT u.user_id, u.mobile, u.nickname,
       aab.asset_code, aab.available_amount, aab.frozen_amount
FROM users u
LEFT JOIN accounts a ON u.user_id = a.user_id
LEFT JOIN account_asset_balances aab ON a.account_id = aab.account_id
WHERE aab.asset_code = 'POINTS'
ORDER BY u.user_id ASC
LIMIT 10;

-- 4. æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æµæ°´è¡¨
SHOW TABLES LIKE '%transaction%';
SHOW TABLES LIKE '%log%';
```

---

### é˜¶æ®µ 2: æ ¸å¿ƒç»„ä»¶å¼€å‘ (2-3 å¤©)

**ç›®æ ‡**: å®ç° TransactionManager å’Œ TransactionContext

**ä»»åŠ¡æ¸…å•**:

- [ ] å®ç° `TransactionManager.execute()` (è¶…æ—¶ä¿æŠ¤ã€é‡è¯•ç­–ç•¥ã€é”™è¯¯åˆ†æ)
- [ ] å®ç° `TransactionContext` (AsyncLocalStorage ä¸Šä¸‹æ–‡ä¼ é€’)
- [ ] å®ç° `requireTransaction()` è¿è¡Œæ—¶æ–­è¨€
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•ï¼ˆäº‹åŠ¡æäº¤ã€å›æ»šã€è¶…æ—¶ã€é‡è¯•ã€åµŒå¥—æ£€æµ‹ï¼‰

**æµ‹è¯•ç”¨ä¾‹**:

```javascript
describe('TransactionManager', () => {
  test('æ­£å¸¸æäº¤', async () => {
    const result = await TransactionManager.execute(async transaction => {
      await Model.create({ data: 'test' }, { transaction })
      return { success: true }
    })
    expect(result.success).toBe(true)
  })

  test('å¼‚å¸¸å›æ»š', async () => {
    await expect(
      TransactionManager.execute(async transaction => {
        await Model.create({ data: 'test' }, { transaction })
        throw new Error('æ¨¡æ‹Ÿä¸šåŠ¡é”™è¯¯')
      })
    ).rejects.toThrow('æ¨¡æ‹Ÿä¸šåŠ¡é”™è¯¯')

    // éªŒè¯æ•°æ®å·²å›æ»š
    const count = await Model.count({ where: { data: 'test' } })
    expect(count).toBe(0)
  })

  test('è¶…æ—¶ä¿æŠ¤', async () => {
    await expect(
      TransactionManager.execute(
        async transaction => {
          await new Promise(resolve => setTimeout(resolve, 35000)) // è¶…è¿‡ 30 ç§’
        },
        { timeout: 30000 }
      )
    ).rejects.toThrow('Transaction timeout')
  })

  test('æ­»é”é‡è¯•', async () => {
    // æ¨¡æ‹Ÿæ­»é”åœºæ™¯...
  })
})
```

---

### é˜¶æ®µ 3: æœåŠ¡å±‚æ”¹é€  (3-5 å¤©)

**ç›®æ ‡**: æ”¹é€ æ ¸å¿ƒæœåŠ¡æ–¹æ³•ï¼Œç»Ÿä¸€äº‹åŠ¡ç®¡ç†

**ä¼˜å…ˆçº§æ’åº**:

**P0 (ç«‹å³æ”¹é€ )**: èµ„é‡‘/åº“å­˜ç›¸å…³

- `AssetService.changeBalance()`
- `AssetService.freeze()`
- `AssetService.settleFromFrozen()`
- `AssetService.mintItem()`

**P1 (ç¬¬äºŒæ‰¹)**: ä¸šåŠ¡å…¥å£

- `UnifiedLotteryEngine.execute_draw()`
- `TradeOrderService.createOrder()`
- `TradeOrderService.completeOrder()`

**P2 (ç¬¬ä¸‰æ‰¹)**: å…¶ä»–ä¸šåŠ¡

- `ExchangeService.exchangeItem()`
- `RedemptionService.createOrder()`
- `MerchantReviewService.submitReview()`

**æ”¹é€ æ¨¡æ¿**:

```javascript
// âŒ æ”¹é€ å‰
class AssetService {
  static async changeBalance(params, options = {}) {
    const transaction = options.transaction || (await sequelize.transaction())
    const shouldCommit = !options.transaction

    try {
      // ... ä¸šåŠ¡é€»è¾‘ ...

      if (shouldCommit) {
        await transaction.commit()
      }
      return result
    } catch (error) {
      if (shouldCommit) {
        await transaction.rollback()
      }
      throw error
    }
  }
}

// âœ… æ”¹é€ å
class AssetService {
  static async changeBalance(params, options = {}) {
    // 1. ä¼˜å…ˆä½¿ç”¨æ˜¾å¼ä¼ å…¥çš„ transaction
    // 2. å…¶æ¬¡ä»ä¸Šä¸‹æ–‡è·å–
    // 3. å¼ºåˆ¶è¦æ±‚å¿…é¡»å­˜åœ¨
    const transaction =
      options.transaction ||
      transactionContext.getTransaction({
        required: true
      })

    // 2. è¿è¡Œæ—¶æ–­è¨€
    requireTransaction(transaction, 'AssetService.changeBalance')

    // 3. ä¸šåŠ¡é€»è¾‘ (ä¸å† commit/rollback)
    // ...

    return result
  }
}
```

---

### é˜¶æ®µ 4: å…¥å£å±‚æ”¹é€  (2-3 å¤©)

**ç›®æ ‡**: æ‰€æœ‰ä¸šåŠ¡å…¥å£ä½¿ç”¨ TransactionManager

**æ”¹é€ ç¤ºä¾‹**:

```javascript
// âŒ æ”¹é€ å‰: UnifiedLotteryEngine.execute_draw()
async execute_draw(user_id, campaign_id, draw_count = 1, options = {}) {
  const transaction = await models.sequelize.transaction({
    timeout: 30000,
    isolationLevel: Sequelize.Transaction.ISOLATION_LEVELS.READ_COMMITTED
  })

  try {
    // ... ä¸šåŠ¡é€»è¾‘ ...
    await transaction.commit()
    return result
  } catch (error) {
    await transaction.rollback()
    throw error
  }
}

// âœ… æ”¹é€ å
async execute_draw(user_id, campaign_id, draw_count = 1, options = {}) {
  return await TransactionManager.execute(async (transaction) => {
    // ... ä¸šåŠ¡é€»è¾‘ (transaction ä¼šè‡ªåŠ¨ä¼ é€’åˆ°ä¸Šä¸‹æ–‡) ...
    return result
  }, {
    maxRetries: 3,
    timeout: 30000,
    isolationLevel: 'READ_COMMITTED'
  })
}
```

---

### é˜¶æ®µ 5: æµ‹è¯•ä¸éªŒè¯ (2-3 å¤©)

**ç›®æ ‡**: å…¨é¢æµ‹è¯•äº‹åŠ¡ä¸€è‡´æ€§

**æµ‹è¯•æ¸…å•**:

- [ ] å•å…ƒæµ‹è¯•: æ‰€æœ‰æ”¹é€ çš„æœåŠ¡æ–¹æ³•
- [ ] é›†æˆæµ‹è¯•: å®Œæ•´ä¸šåŠ¡æµç¨‹ï¼ˆæŠ½å¥–ã€äº¤æ˜“ã€å…‘æ¢ã€æ ¸é”€ï¼‰
- [ ] å¼‚å¸¸æµ‹è¯•: æ¨¡æ‹Ÿå„ç§å¤±è´¥åœºæ™¯ï¼ˆä½™é¢ä¸è¶³ã€åº“å­˜ä¸è¶³ã€è¶…æ—¶ã€æ­»é”ï¼‰
- [ ] å¹¶å‘æµ‹è¯•: æ¨¡æ‹Ÿé«˜å¹¶å‘åœºæ™¯ï¼ˆ100 å¹¶å‘æŠ½å¥–ã€äº¤æ˜“ï¼‰
- [ ] æ•°æ®ä¸€è‡´æ€§éªŒè¯: è´¦å®æ ¸å¯¹ï¼ˆä½™é¢ vs æµæ°´ï¼‰

**éªŒè¯è„šæœ¬**:

```javascript
// å¹¶å‘æŠ½å¥–æµ‹è¯•
async function concurrentLotteryTest() {
  const user_id = 1
  const campaign_id = 1
  const concurrency = 100

  // è®°å½•åˆå§‹ä½™é¢
  const initialBalance = await AssetService.getBalance({ user_id, asset_code: 'POINTS' })

  // å¹¶å‘æ‰§è¡Œ 100 æ¬¡æŠ½å¥–
  const promises = Array(concurrency)
    .fill()
    .map(() => UnifiedLotteryEngine.execute_draw(user_id, campaign_id, 1))

  const results = await Promise.allSettled(promises)
  const successCount = results.filter(r => r.status === 'fulfilled').length
  const failCount = results.filter(r => r.status === 'rejected').length

  // éªŒè¯æœ€ç»ˆä½™é¢
  const finalBalance = await AssetService.getBalance({ user_id, asset_code: 'POINTS' })
  const expectedBalance = initialBalance.available_amount - successCount * 100

  console.log({
    concurrency,
    successCount,
    failCount,
    initialBalance: initialBalance.available_amount,
    finalBalance: finalBalance.available_amount,
    expectedBalance,
    consistent: finalBalance.available_amount === expectedBalance
  })
}
```

---

### é˜¶æ®µ 6: ç°åº¦å‘å¸ƒä¸ç›‘æ§ (æŒç»­)

**ç›®æ ‡**: å®‰å…¨ä¸Šçº¿ï¼Œå®æ—¶ç›‘æ§

**ç›‘æ§æŒ‡æ ‡**:

- äº‹åŠ¡æäº¤æˆåŠŸç‡
- äº‹åŠ¡å›æ»šç‡
- äº‹åŠ¡å¹³å‡è€—æ—¶
- äº‹åŠ¡è¶…æ—¶æ¬¡æ•°
- æ­»é”å‘ç”Ÿæ¬¡æ•°
- è´¦å®ä¸€è‡´æ€§æ£€æŸ¥

**å‘Šè­¦è§„åˆ™**:

- äº‹åŠ¡å›æ»šç‡ > 5%: è­¦å‘Š
- äº‹åŠ¡è¶…æ—¶æ¬¡æ•° > 10 æ¬¡/å°æ—¶: è­¦å‘Š
- æ­»é”å‘ç”Ÿ: ç«‹å³å‘Šè­¦
- è´¦å®ä¸ä¸€è‡´: ç«‹å³å‘Šè­¦

---

## ğŸ”§ å¾…ç¡®è®¤é—®é¢˜

### é—®é¢˜ 1: æµæ°´è¡¨è½ç‚¹ç¡®è®¤

**ç°çŠ¶**: `asset_transactions = 0` ä½† `lottery_draws = 2840`

**éœ€è¦ç¡®è®¤**:

1. æŠ½å¥–æ‰£ç§¯åˆ†æ˜¯å¦åº”è¯¥å†™å…¥ `asset_transactions`ï¼Ÿ
2. å¦‚æœæ˜¯ï¼Œä¸ºä»€ä¹ˆå½“å‰ä¸º 0ï¼Ÿï¼ˆæ¡ä»¶åˆ†æ”¯/ç¯å¢ƒå˜é‡/é€»è¾‘ç¼ºå¤±ï¼‰
3. å¦‚æœä¸æ˜¯ï¼Œå®é™…æµæ°´å†™å…¥å“ªå¼ è¡¨ï¼Ÿ

**å½±å“**: å†³å®šäº‹åŠ¡è¾¹ç•Œå¿…é¡»åŒ…å«å“ªäº›è¡¨

---

### é—®é¢˜ 2: å®¹å¿åº¦ç¡®è®¤

**é€‰é¡¹ A: å¼ºçº¦æŸï¼ˆæ¨èï¼‰**

- å†…éƒ¨æœåŠ¡æ–¹æ³•å¿…é¡»ä¼  `transaction`ï¼Œå¦åˆ™ç›´æ¥æŠ›é”™
- ä¼˜ç‚¹: é—®é¢˜åœ¨å¼€å‘é˜¶æ®µæš´éœ²
- ç¼ºç‚¹: æ”¹é€ å·¥ä½œé‡å¤§

**é€‰é¡¹ B: å¼±çº¦æŸ**

- å…è®¸ fallback è‡ªå·±å¼€äº‹åŠ¡ï¼Œä½†æ‰“æ—¥å¿—+æŠ¥è­¦
- ä¼˜ç‚¹: æ”¹é€ å·¥ä½œé‡å°ï¼Œå…¼å®¹æ€§å¥½
- ç¼ºç‚¹: é—®é¢˜å¯èƒ½åœ¨ç”Ÿäº§ç¯å¢ƒæ‰æš´éœ²

**éœ€è¦ç¡®è®¤**: é€‰æ‹©å“ªç§æ–¹æ¡ˆï¼Ÿ

---

## ğŸ“š å‚è€ƒèµ„æ–™

### ç›¸å…³æ–‡æ¡£

- `docs/å¹‚ç­‰æ€§ä¿æŠ¤æ¶æ„æ ¸æŸ¥æŠ¥å‘Š-2026-01-02.md`
- `docs/Devboxå•ç¯å¢ƒç»Ÿä¸€é…ç½®æ–¹æ¡ˆ.md`
- `docs/é…ç½®ç®¡ç†ä¸‰å±‚åˆ†ç¦»ä¸æ ¡éªŒç»Ÿä¸€æ–¹æ¡ˆ.md`

### ç›¸å…³ä»£ç 

- `config/database.js` - æ•°æ®åº“è¿æ¥é…ç½®
- `models/index.js` - æ¨¡å‹ç»Ÿä¸€å¯¼å‡º
- `utils/UnifiedDatabaseHelper.js` - æ•°æ®åº“åŠ©æ‰‹
- `services/AssetService.js` - èµ„äº§æœåŠ¡ï¼ˆæ ¸å¿ƒï¼‰
- `services/UnifiedLotteryEngine/UnifiedLotteryEngine.js` - æŠ½å¥–å¼•æ“ï¼ˆæ ¸å¿ƒï¼‰
- `services/TradeOrderService.js` - äº¤æ˜“è®¢å•æœåŠ¡ï¼ˆæ ¸å¿ƒï¼‰

### æµ‹è¯•æ–‡ä»¶

- `tests/shared/transaction.test.js` - äº‹åŠ¡æµ‹è¯•å¥—ä»¶

---

## ğŸ“ é™„å½•

### é™„å½• A: äº‹åŠ¡æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§           | è‡ªç®¡ç†äº‹åŠ¡ | å¯é€‰ä¼ é€’äº‹åŠ¡ | TransactionManager |
| -------------- | ---------- | ------------ | ------------------ |
| **äº‹åŠ¡è¾¹ç•Œ**   | æ˜ç¡®       | æ¨¡ç³Š         | æ˜ç¡®               |
| **åµŒå¥—é£é™©**   | é«˜         | æé«˜         | æ—                  |
| **è¶…æ—¶ä¿æŠ¤**   | éœ€æ‰‹åŠ¨å®ç° | éœ€æ‰‹åŠ¨å®ç°   | å†…ç½®               |
| **é‡è¯•ç­–ç•¥**   | éœ€æ‰‹åŠ¨å®ç° | éœ€æ‰‹åŠ¨å®ç°   | å†…ç½®               |
| **é”™è¯¯åˆ†æ**   | éœ€æ‰‹åŠ¨å®ç° | éœ€æ‰‹åŠ¨å®ç°   | å†…ç½®               |
| **ä»£ç å¤æ‚åº¦** | é«˜         | ä¸­           | ä½                 |
| **ç»´æŠ¤æˆæœ¬**   | é«˜         | é«˜           | ä½                 |

### é™„å½• B: æ•°æ®åº“è¿æ¥ä¿¡æ¯

```
Host: dbconn.sealosbja.site
Port: 42569
Database: restaurant_points_dev
Connection Pool: max=40, min=5, acquire=10s, idle=60s
Timezone: Asia/Shanghai (UTC+8)
Charset: utf8mb4
```

### é™„å½• C: æ ¸å¿ƒè¡¨å…³ç³»å›¾

```
users (22)
  â†“ (user_id)
accounts (13)
  â†“ (account_id)
account_asset_balances (11)
  â†“ (balance changes)
asset_transactions (0) âš ï¸

lottery_draws (2840)
  â†“ (cost_points)
[æµæ°´è®°å½•ç¼ºå¤±] âš ï¸

item_instances (1058)
  â†“ (status changes)
redemption_orders (333)
```

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026å¹´01æœˆ02æ—¥  
**ä¸‹æ¬¡æ›´æ–°**: å¾…ç¡®è®¤é—®é¢˜ 1 å’Œ 2 åæ›´æ–°å®æ–½æ–¹æ¡ˆ
