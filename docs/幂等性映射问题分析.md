# 幂等性映射问题分析报告

> **生成时间**：2026年01月19日  
> **数据来源**：真实数据库 `restaurant_points_dev` + 当前代码仓库  
> **聚焦问题**：🎯 **IdempotencyService 中存在幽灵映射（映射了不存在的路径）**  
> **问题性质**：技术债务，独立于"路径双轨清理"任务  
> **决策状态**：✅ 已拍板（2026-01-19）  
> **执行策略**：🚀 **项目未上线，一次性修复全部 33 个，不保留兼容路径**

---

## 一、问题背景

在完成"路径双轨清理"（29 个 deprecated 路径删除）后，发现 IdempotencyService 中存在另一类问题：

**幽灵映射**：`CANONICAL_OPERATION_MAP` 中映射了不存在的 API 路径，导致幂等性保护实际上不生效。

---

## 二、当前状态总结

| 指标 | 数量 | 说明 |
|------|------|------|
| IdempotencyService 映射总数 | 105 | 已完成路径双轨清理 |
| 实际有流量的路径 | 5 | 数据库中有幂等记录 |
| **幽灵映射（路径不存在）** | **33** | ⚠️ 本文档重点 |
| 写路由总数 | 124 | 项目中所有 POST/PUT/DELETE 路由 |
| 需要幂等性保护的操作 | 32 | 资产/订单/支付/核销类 |

---

## 三、数据库流量验证（2026-01-19）

### 3.1 幂等表实际使用情况

```
数据库：restaurant_points_dev
表名：api_idempotency_requests
总记录：594 条
```

| api_path | 调用次数 | 说明 |
|----------|---------|------|
| `/api/v4/shop/exchange/exchange` | 486 | ❌ deprecated（已清理映射） |
| `/api/v4/shop/exchange` | 42 | ✅ canonical |
| `/api/v4/lottery/draw` | 41 | ✅ canonical |
| `/api/v4/shop/consumption/submit` | 23 | ✅ canonical |
| `/api/v4/shop/assets/convert` | 2 | ✅ canonical |

### 3.2 关键发现

- 只有 5 个路径有实际的幂等请求记录
- 105 个映射中，100 个从未被使用
- 33 个映射指向不存在的路径（幽灵映射）

---

## 四、幽灵映射问题分析

### 4.1 问题根源

实际路由结构采用子模块挂载：
```
/api/v4/console/{子模块}/{操作}
```

但 IdempotencyService 中映射了短路径：
```
/api/v4/console/{操作}
```

### 4.2 验证结果

```bash
# 错误映射（返回 404）
/api/v4/console/adjust → NOT_FOUND
/api/v4/console/login → NOT_FOUND
/api/v4/console/cleanup → NOT_FOUND
/api/v4/console/transfer → NOT_FOUND

# 实际路由（返回 401 需要认证）
/api/v4/console/asset-adjustment/adjust → UNAUTHORIZED
/api/v4/console/auth/login → MOBILE_REQUIRED
/api/v4/console/audit-logs/cleanup → UNAUTHORIZED
/api/v4/console/staff/transfer → UNAUTHORIZED
```

---

## 五、33 个幽灵映射完整清单

以下映射在 IdempotencyService 中存在，但实际 API 路由不存在：

### 5.1 认证相关（1 个）

| 错误映射 | Operation | 预期实际路径 |
|---------|-----------|-------------|
| `/api/v4/console/login` | ADMIN_AUTH_LOGIN | `/api/v4/console/auth/login` |

### 5.2 资产调整相关（2 个）

| 错误映射 | Operation | 预期实际路径 |
|---------|-----------|-------------|
| `/api/v4/console/adjust` | ADMIN_ASSET_ADJUST | `/api/v4/console/asset-adjustment/adjust` |
| `/api/v4/console/batch-adjust` | ADMIN_ASSET_BATCH_ADJUST | `/api/v4/console/asset-adjustment/batch-adjust` |

### 5.3 审计日志相关（1 个）

| 错误映射 | Operation | 预期实际路径 |
|---------|-----------|-------------|
| `/api/v4/console/cleanup` | ADMIN_AUDIT_LOG_CLEANUP | `/api/v4/console/audit-logs/cleanup` |

### 5.4 活动管理相关（1 个）

| 错误映射 | Operation | 预期实际路径 |
|---------|-----------|-------------|
| `/api/v4/console/campaigns/:id` | ADMIN_CAMPAIGN_UPDATE | 需确认实际路径 |

### 5.5 配置管理相关（2 个）

| 错误映射 | Operation | 预期实际路径 |
|---------|-----------|-------------|
| `/api/v4/console/config` | ADMIN_CONFIG_UPDATE | `/api/v4/console/config/config` 或子路径 |
| `/api/v4/console/test/simulate` | ADMIN_CONFIG_TEST | 需确认实际路径 |

### 5.6 消费审核相关（2 个）

| 错误映射 | Operation | 预期实际路径 |
|---------|-----------|-------------|
| `/api/v4/console/approve/:id` | ADMIN_CONSUMPTION_APPROVE | `/api/v4/console/consumption/approve/:id` |
| `/api/v4/console/reject/:id` | ADMIN_CONSUMPTION_REJECT | `/api/v4/console/consumption/reject/:id` |

### 5.7 图片管理相关（2 个）

| 错误映射 | Operation | 预期实际路径 |
|---------|-----------|-------------|
| `/api/v4/console/upload` | ADMIN_IMAGE_UPLOAD | `/api/v4/console/images/upload` |
| `/api/v4/console/:id/bind` | ADMIN_IMAGE_BIND | `/api/v4/console/images/:id/bind` |

### 5.8 孤儿清理相关（1 个）

| 错误映射 | Operation | 预期实际路径 |
|---------|-----------|-------------|
| `/api/v4/console/order` | ADMIN_ORPHAN_CLEANUP | `/api/v4/console/orphan-frozen/order` |

### 5.9 奖品管理相关（1 个）

| 错误映射 | Operation | 预期实际路径 |
|---------|-----------|-------------|
| `/api/v4/console/prize/:id` | ADMIN_PRIZE_UPDATE | 需确认实际路径 |

### 5.10 抽奖配额相关（1 个）

| 错误映射 | Operation | 预期实际路径 |
|---------|-----------|-------------|
| `/api/v4/console/rules` | ADMIN_LOTTERY_QUOTA_CREATE | `/api/v4/console/lottery-quota/rules` |

### 5.11 材料系统相关（2 个）

| 错误映射 | Operation | 预期实际路径 |
|---------|-----------|-------------|
| `/api/v4/console/conversion-rules` | ADMIN_MATERIAL_RULE_CREATE | `/api/v4/console/material/conversion-rules` |
| `/api/v4/console/asset-types` | ADMIN_MATERIAL_TYPE_CREATE | `/api/v4/console/material/asset-types` |

### 5.12 系统设置相关（1 个）

| 错误映射 | Operation | 预期实际路径 |
|---------|-----------|-------------|
| `/api/v4/console/settings/:id` | ADMIN_SETTINGS_UPDATE | 需确认实际路径 |

### 5.13 用户层级相关（2 个）

| 错误映射 | Operation | 预期实际路径 |
|---------|-----------|-------------|
| `/api/v4/console/:id/deactivate` | ADMIN_USER_HIERARCHY_DEACTIVATE | `/api/v4/console/user-hierarchy/:id/deactivate` |
| `/api/v4/console/:id/activate` | ADMIN_USER_HIERARCHY_ACTIVATE | `/api/v4/console/user-hierarchy/:id/activate` |

### 5.14 员工管理相关（4 个）

| 错误映射 | Operation | 预期实际路径 |
|---------|-----------|-------------|
| `/api/v4/console/transfer` | ADMIN_STAFF_TRANSFER | `/api/v4/console/staff/transfer` |
| `/api/v4/console/disable/:id` | ADMIN_STAFF_DISABLE | `/api/v4/console/staff/disable/:id` |
| `/api/v4/console/enable` | ADMIN_STAFF_ENABLE | `/api/v4/console/staff/enable` |
| `/api/v4/console/:id/role` | ADMIN_STAFF_UPDATE_ROLE | `/api/v4/console/user-management/users/:id/role` |

### 5.15 通用资源相关（3 个）

| 错误映射 | Operation | 预期实际路径 |
|---------|-----------|-------------|
| `/api/v4/console/:id` | ADMIN_RESOURCE_UPDATE | 需确认实际路径 |
| `/api/v4/console/:id/toggle` | ADMIN_RESOURCE_TOGGLE | 需确认实际路径 |
| `/api/v4/console/` | ADMIN_RESOURCE_CREATE | 需确认实际路径 |

### 5.16 门店管理相关（1 个）

| 错误映射 | Operation | 预期实际路径 |
|---------|-----------|-------------|
| `/api/v4/console/batch-import` | ADMIN_STORE_BATCH_IMPORT | 需确认实际路径 |

### 5.17 商户积分相关（2 个）

| 错误映射 | Operation | 预期实际路径 |
|---------|-----------|-------------|
| `/api/v4/console/:id/approve` | ADMIN_MERCHANT_APPROVE | `/api/v4/console/merchant-points/:id/approve` |
| `/api/v4/console/:id/reject` | ADMIN_MERCHANT_REJECT | `/api/v4/console/merchant-points/:id/reject` |

### 5.18 风险告警相关（1 个）

| 错误映射 | Operation | 预期实际路径 |
|---------|-----------|-------------|
| `/api/v4/console/:id/review` | ADMIN_RISK_ALERT_REVIEW | 需确认实际路径 |

### 5.19 系统管理相关（2 个）

| 错误映射 | Operation | 预期实际路径 |
|---------|-----------|-------------|
| `/api/v4/console/system/` | ADMIN_SYSTEM_CREATE | 需确认实际路径 |
| `/api/v4/console/system/:id` | ADMIN_SYSTEM_UPDATE | 需确认实际路径 |

### 5.20 其他（2 个）

| 错误映射 | Operation | 预期实际路径 |
|---------|-----------|-------------|
| `/api/v4/console/validate` | ADMIN_REGION_VALIDATE | 需确认实际路径 |
| `/api/v4/console/batch-add` | ADMIN_BATCH_ADD | 需确认实际路径 |

---

## 六、解决方案

### ✅ 方案 A：修复幽灵映射（已选择）

**目标**：将 33 个错误映射更新为正确的实际路由路径

**执行步骤**：
1. 逐一确认每个操作的实际路由路径
2. 更新 `IdempotencyService.js` 中的 `CANONICAL_OPERATION_MAP`
3. 保持 operation 名称不变，只更新路径

**工作量**：约 33 个映射需要更新

**执行范围**：全部 33 个（一次性修复）

### ~~方案 B：删除无效映射~~（未选择）

**目标**：删除所有指向不存在路径的映射

**风险**：如果未来路由被创建，需要重新添加映射

**适用场景**：确认这些功能不再使用

### ~~方案 C：按需修复~~（未选择）

**目标**：只修复有实际业务需求的映射

**优先级**：
1. P0 - 资产调整相关（涉及资金）
2. P1 - 员工管理相关
3. P2 - 其他管理操作

---

## 七、执行检查清单

### Step 1：确认实际路由路径 ✅ 已完成

- [x] 认证相关（1 个）
- [x] 资产调整相关（2 个）
- [x] 审计日志相关（1 个）
- [x] 消费审核相关（2 个）
- [x] 图片管理相关（2 个）
- [x] 材料系统相关（2 个）
- [x] 用户层级相关（2 个）
- [x] 员工管理相关（4 个）
- [x] 商户积分相关（2 个）
- [x] 其他（15 个）

### Step 2：更新 IdempotencyService ✅ 已完成

- [x] 修改 `CANONICAL_OPERATION_MAP` 中的路径映射
- [x] 保持 operation 名称不变
- [x] 运行 ESLint 检查

### Step 3：验证 ✅ 已完成

- [x] 验证所有映射路径返回非 404
- [x] 运行功能测试（9个测试全部通过）
- [x] 确认无 `CANONICAL_OPERATION_NOT_MAPPED` 错误日志

---

## 八、关联文档

- [路径双轨清理方案](./路径双轨清理.md) - 已完成的 29 个 deprecated 路径清理
- [IdempotencyService 技术文档](./idempotency-service.md) - 幂等性服务设计

---

## 九、决策记录

### 2026-01-19 决策拍板

| 决策项 | 决定 | 理由 |
|--------|------|------|
| **方案选择** | 方案 A（修复幽灵映射） | 修复成本不高，一次性解决 |
| **执行范围** | 全部 33 个 | 项目未上线，不需要分批处理 |
| **兼容策略** | 不保留兼容路径 | 从长期维护成本、降低技术债务角度出发 |
| **优先级** | P1 | 应在上线前完成 |

### 决策原则

1. **项目未上线**：可以一次性投入，不需要考虑线上兼容
2. **降低技术债务**：彻底修复比临时方案更有价值
3. **长期维护成本**：正确的映射关系便于后续维护和排查问题

### 问题发现

- **发现时间**：2026-01-19
- **问题数量**：33 个幽灵映射
- **影响范围**：幂等性保护对这些路径不生效

### 2026-01-19 第二次决策拍板（23个未映射路由）

| 决策项 | 决定 | 理由 |
|--------|------|------|
| **23个未映射路由** | 方案 A（全部添加幂等性映射） | 完整的幂等性保护，降低技术债务 |
| **执行时机** | 立即执行 | 一并处理23个未映射 + 33个幽灵映射 |
| **JSDoc注释** | 顺手修正 | 和幂等性映射一起修正 |
| **预计工作量** | ~2小时 | 含测试验证 |

### 最终执行范围

| 任务类型 | 数量 | 状态 |
|----------|------|------|
| 幽灵映射修复（错误路径→正确路径） | 12个 | ✅ 已完成（2026-01-19） |
| 未映射路由添加 | 14个 | ✅ 已完成（2026-01-19） |
| JSDoc注释修正 | 0处 | ✅ 无需修复（已正确） |
| **合计** | **26项** | ✅ 已完成 |

> 📝 **执行说明**：经重新验证，实际需修复数量少于文档初始估计（33+23=56），因为部分映射在先前的修复中已处理。

### 预期效果

- `CANONICAL_OPERATION_MAP` 覆盖率：~85% → **100%**
- 所有写操作路由都有幂等性保护
- 消除所有幽灵映射技术债务
- 文档与代码保持一致

---

## 十、待处理问题清单（2026-01-19 验证后更新）

### 10.1 幂等性映射未覆盖（23个写操作路由）

这些路由缺少 `CANONICAL_OPERATION_MAP` 映射，可能影响幂等性保护：

#### 1. popup-banners 模块（5个）

| 路由 | 说明 |
|------|------|
| `POST /api/v4/console/popup-banners` | 创建弹窗Banner |
| `PUT /api/v4/console/popup-banners/:id` | 更新弹窗Banner |
| `DELETE /api/v4/console/popup-banners/:id` | 删除弹窗Banner |
| `PUT /api/v4/console/popup-banners/:id/toggle` | 切换Banner状态 |
| `PUT /api/v4/console/popup-banners/order` | 排序Banner |

#### 2. staff 模块 - 总后台员工管理（6个）

| 路由 | 说明 |
|------|------|
| `POST /api/v4/console/staff` | 创建员工 |
| `POST /api/v4/console/staff/transfer` | 员工转移 |
| `POST /api/v4/console/staff/disable/:id` | 禁用员工 |
| `POST /api/v4/console/staff/enable` | 启用员工 |
| `PUT /api/v4/console/staff/:id/role` | 更新员工角色 |
| `PUT /api/v4/console/staff/:id` | 更新员工信息 |

#### 3. stores 模块（4个）

| 路由 | 说明 |
|------|------|
| `POST /api/v4/console/stores` | 创建门店 |
| `POST /api/v4/console/stores/batch-import` | 批量导入门店 |
| `PUT /api/v4/console/stores/:id` | 更新门店 |
| `PUT /api/v4/console/stores/:id/toggle` | 切换门店状态 |

#### 4. user-hierarchy 模块（4个）

| 路由 | 说明 |
|------|------|
| `POST /api/v4/console/user-hierarchy` | 创建用户层级 |
| `PUT /api/v4/console/user-hierarchy/:id` | 更新用户层级 |
| `PUT /api/v4/console/user-hierarchy/:id/deactivate` | 停用层级 |
| `PUT /api/v4/console/user-hierarchy/:id/activate` | 激活层级 |

#### 5. system/announcements 模块（2个）

| 路由 | 说明 |
|------|------|
| `POST /api/v4/console/system/announcements` | 创建公告 |
| `PUT /api/v4/console/system/announcements/:id` | 更新公告 |

#### 6. system/feedbacks 模块（2个）

| 路由 | 说明 |
|------|------|
| `POST /api/v4/console/system/feedbacks/:id/reply` | 回复反馈 |
| `PUT /api/v4/console/system/feedbacks/:id/status` | 更新反馈状态 |

---

### 10.2 数据库历史记录（无需手动处理）

| 问题 | 数量 | 处理方式 |
|------|------|----------|
| deprecated路径 `/api/v4/shop/exchange/exchange` 记录 | 243条 | 7天TTL自动清理（最晚2026-01-26） |

---

### 10.3 其他潜在问题 ✅ 已验证

| 问题 | 文件位置 | 状态 |
|------|----------|------|
| JSDoc注释路径与实际路径不一致 | `routes/v4/console/system/feedbacks.js` | ✅ 经验证，JSDoc注释已正确，无需修复 |

---

### 10.4 问题统计 ✅ 已全部解决

| 类别 | 原数量 | 状态 |
|------|--------|------|
| 幂等性映射缺失 | 23个 | ✅ 已全部添加映射 |
| 数据库历史记录 | 243条 | ✅ TTL自动清理中（无需处理） |
| JSDoc注释不一致 | 0处 | ✅ 经验证已正确 |

---

### 10.5 处理结果

1. ✅ **已完成**：所有写操作路由已添加到 `CANONICAL_OPERATION_MAP`
2. ✅ **无需处理**：`feedbacks.js` 的 JSDoc 注释已经正确
3. ✅ **自动处理**：数据库历史记录由 TTL 自动清理

---

**文档状态**：✅ 已完成执行  
**最后更新**：2026-01-19（执行完成：幽灵映射修复 + 未映射路由添加）  
**执行验证**：ESLint ✅ | 幂等性测试 ✅ | 项目测试 660 passed | 健康检查 ✅

---

## 十一、执行计划总览

### 11.1 已完成任务汇总

| 序号 | 任务类型 | 数量 | 状态 | 完成时间 |
|------|----------|------|--------|----------|
| 1 | 幽灵映射修复 | 12个 | ✅ 已完成 | 2026-01-19 |
| 2 | 未映射路由添加 | 14个 | ✅ 已完成 | 2026-01-19 |
| 3 | JSDoc注释修正 | 0处 | ✅ 无需修复 | 2026-01-19 |
| 4 | 验证测试 | 9个 | ✅ 全部通过 | 2026-01-19 |
| **合计** | - | **26项** | ✅ | **已完成** |

### 11.2 决策原则（已确认）

1. ✅ 项目未上线，可以一次性投入
2. ✅ 不兼容旧接口，不保留兼容路径
3. ✅ 从长期维护成本、降低技术债务角度出发
4. ✅ 幂等性覆盖率目标：100%

