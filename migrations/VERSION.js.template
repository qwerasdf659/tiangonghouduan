/**
 * æ•°æ®åº“ç‰ˆæœ¬ç®¡ç†æ–‡ä»¶
 *
 * ç”¨é€”ï¼šè®°å½•æ•°æ®åº“ç‰ˆæœ¬ä¿¡æ¯å’Œè¿ç§»å†å²
 *
 * âš ï¸ é‡è¦è¯´æ˜:
 * 1. æ­¤æ–‡ä»¶ç”± create-migration.js è‡ªåŠ¨æ›´æ–°
 * 2. è¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹ lastMigration å’Œ lastUpdated
 * 3. å¦‚éœ€æ‰‹åŠ¨ä¿®æ”¹ï¼Œè¯·ç¡®ä¿ç†è§£å½±å“
 *
 * åˆ›å»ºæ—¶é—´ï¼š2025å¹´10æœˆ12æ—¥
 */

module.exports = {
  // ==================== ç‰ˆæœ¬ä¿¡æ¯ ====================

  // å½“å‰ç‰ˆæœ¬
  current: 'V1.0.0-explicit',

  // åŸºå‡†ç‰ˆæœ¬ï¼ˆé‡æ„èµ·ç‚¹ï¼‰ - âœ… ä½¿ç”¨æ˜¾å¼å®šä¹‰çš„åŸºå‡†è¿ç§»
  baseline: '20251014000000-baseline-v1.0.0-explicit.js',

  // æœ€åæ›´æ–°æ—¶é—´ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰
  lastUpdated: '2025-10-14 20:00:00',

  // æœ€åä¸€æ¬¡è¿ç§»æ–‡ä»¶ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰
  lastMigration: '20251014000000-baseline-v1.0.0-explicit.js',

  // è¡¨æ•°é‡
  tableCount: 21, // 21ä¸ªä¸šåŠ¡è¡¨ï¼ˆåŸºäºå®é™…models/ç›®å½•ï¼‰

  // ==================== å†å²è®°å½• ====================

  history: {
    // V1.0.0-explicit - æ˜¾å¼å®šä¹‰åŸºå‡†ç‰ˆæœ¬ï¼ˆä¿®å¤sync()é—®é¢˜ï¼‰
    'V1.0.0-explicit': {
      createdAt: '2025-10-14',
      description: 'âœ… å®Œå…¨æ˜¾å¼å®šä¹‰ï¼šåˆ é™¤sync()é”™è¯¯è¿ç§»ï¼Œå»ºç«‹æ­£ç¡®åŸºå‡†',
      migrations: 1,
      tables: 4, // æ ¸å¿ƒ4ä¸ªè¡¨ï¼ˆroles, users, user_roles, user_sessionsï¼‰
      method: 'æ˜¾å¼å®šä¹‰ï¼ˆqueryInterface.createTableï¼‰',
      changes: [
        'âŒ åˆ é™¤ä½¿ç”¨sync()çš„é”™è¯¯åŸºå‡†è¿ç§»',
        'âœ… åˆ›å»ºå®Œå…¨æ˜¾å¼å®šä¹‰çš„åŸºå‡†è¿ç§»',
        'âœ… user_rolesè¡¨åŒ…å«å®Œæ•´çš„7ä¸ªå­—æ®µï¼ˆå«3ä¸ªä¸šåŠ¡å­—æ®µï¼‰',
        'âœ… æ‰€æœ‰å­—æ®µã€ç´¢å¼•ã€å¤–é”®éƒ½æ˜¾å¼å®šä¹‰',
        'âœ… åŒ…å«å®Œæ•´çš„æ•°æ®éªŒè¯å’Œå›æ»šæ–¹æ³•',
        'ğŸ›¡ï¸ å»ºç«‹é˜²æ­¢sync()çš„æ£€æŸ¥è„šæœ¬',
        'ğŸ“š æ›´æ–°æœ€ä½³å®è·µæ–‡æ¡£'
      ],
      important: 'âš ï¸ ä¿®å¤äº†sync()å¯¼è‡´çš„å­—æ®µç¼ºå¤±é—®é¢˜'
    }

    // æœªæ¥ç‰ˆæœ¬ä¼šè‡ªåŠ¨è¿½åŠ åˆ°è¿™é‡Œ
    // 'V1.0.1': { ... }
    // 'V1.1.0': { ... }
  },

  // ==================== è¡¨æ¸…å• ====================

  tables: {
    // ç”¨æˆ·è®¤è¯ç³»ç»Ÿ (4ä¸ªè¡¨)
    users: { version: 'V1.0.0', description: 'ç”¨æˆ·åŸºç¡€ä¿¡æ¯è¡¨' },
    roles: { version: 'V1.0.0', description: 'è§’è‰²è¡¨ï¼ˆUUIDè§’è‰²ç³»ç»Ÿï¼‰' },
    user_roles: { version: 'V1.0.0', description: 'ç”¨æˆ·è§’è‰²å…³è”è¡¨' },
    user_sessions: { version: 'V1.0.0', description: 'ç”¨æˆ·ç™»å½•ä¼šè¯è¡¨' },

    // ç§¯åˆ†ç³»ç»Ÿ (3ä¸ªè¡¨)
    user_points_accounts: { version: 'V1.0.0', description: 'ç”¨æˆ·ç§¯åˆ†è´¦æˆ·è¡¨' },
    points_transactions: { version: 'V1.0.0', description: 'ç§¯åˆ†äº¤æ˜“æµæ°´è¡¨' },
    exchange_records: { version: 'V1.0.0', description: 'ç§¯åˆ†å…‘æ¢è®°å½•è¡¨' },

    // æŠ½å¥–ç³»ç»Ÿ (4ä¸ªè¡¨)
    lottery_campaigns: { version: 'V1.0.0', description: 'æŠ½å¥–æ´»åŠ¨è¡¨' },
    lottery_prizes: { version: 'V1.0.0', description: 'å¥–å“é…ç½®è¡¨' },
    lottery_draws: { version: 'V1.0.0', description: 'æŠ½å¥–è®°å½•è¡¨ï¼ˆå«ä¸­å¥–ï¼‰' },
    lottery_presets: { version: 'V1.0.0', description: 'æŠ½å¥–æ´»åŠ¨é¢„è®¾æ¨¡æ¿è¡¨' },

    // å•†å“äº¤æ˜“ç³»ç»Ÿ (3ä¸ªè¡¨)
    products: { version: 'V1.0.0', description: 'å•†å“ç®¡ç†è¡¨' },
    trade_records: { version: 'V1.0.0', description: 'äº¤æ˜“è®°å½•è¡¨' },
    user_inventory: { version: 'V1.0.0', description: 'ç”¨æˆ·åº“å­˜è¡¨' },

    // å®¢æœç³»ç»Ÿ (3ä¸ªè¡¨)
    customer_sessions: { version: 'V1.0.0', description: 'å®¢æœä¼šè¯è¡¨' },
    chat_messages: { version: 'V1.0.0', description: 'èŠå¤©æ¶ˆæ¯è¡¨' },
    feedbacks: { version: 'V1.0.0', description: 'ç”¨æˆ·åé¦ˆè¡¨' },

    // å®¡è®¡ç³»ç»Ÿ (2ä¸ªè¡¨)
    audit_logs: { version: 'V1.0.0', description: 'æ“ä½œå®¡è®¡æ—¥å¿—è¡¨' },
    audit_records: { version: 'V1.0.0', description: 'å†…å®¹å®¡æ ¸è®°å½•è¡¨' },

    // ç³»ç»Ÿç®¡ç† (2ä¸ªè¡¨)
    system_announcements: { version: 'V1.0.0', description: 'ç³»ç»Ÿå…¬å‘Šè¡¨' },
    image_resources: { version: 'V1.0.0', description: 'å›¾ç‰‡èµ„æºè¡¨' }
  },

  // ==================== å‘½åè§„èŒƒ ====================

  namingStandard: {
    // è¿ç§»æ–‡ä»¶å‘½åæ ¼å¼
    migrationFormat: '{YYYYMMDD}{HHMMSS}-{action}-{target}.js',

    // å…è®¸çš„Actionç±»å‹
    allowedActions: [
      'create-table', 'alter-table', 'drop-table', 'rename-table',
      'add-column', 'alter-column', 'drop-column', 'rename-column',
      'create-index', 'alter-index', 'drop-index',
      'add-constraint', 'drop-constraint',
      'migrate-data', 'seed-data',
      'baseline'
    ],

    // ç¤ºä¾‹
    examples: [
      '20251012120000-create-table-users.js',
      '20251012130000-add-column-users-vip-level.js',
      '20251012140000-create-index-users-mobile.js',
      '20251012150000-migrate-data-merge-user-roles.js'
    ]
  },

  // ==================== è‡ªéªŒè¯æ–¹æ³• ====================

  validate: function () {
    const errors = []

    // éªŒè¯åŸºæœ¬å­—æ®µå­˜åœ¨
    if (!this.current) errors.push('ç¼ºå°‘ current å­—æ®µ')
    if (!this.baseline) errors.push('ç¼ºå°‘ baseline å­—æ®µ')
    if (!this.lastUpdated) errors.push('ç¼ºå°‘ lastUpdated å­—æ®µ')
    if (!this.tableCount) errors.push('ç¼ºå°‘ tableCount å­—æ®µ')

    // éªŒè¯è¡¨æ•°é‡ä¸€è‡´æ€§
    const actualTableCount = Object.keys(this.tables).length
    if (actualTableCount !== this.tableCount) {
      errors.push(`è¡¨æ•°é‡ä¸ä¸€è‡´: tableCount=${this.tableCount}, å®é™…=${actualTableCount}`)
    }

    // éªŒè¯å†å²è®°å½•
    if (!this.history['V1.0.0']) {
      errors.push('ç¼ºå°‘ V1.0.0 åŸºå‡†ç‰ˆæœ¬å†å²è®°å½•')
    }

    if (errors.length > 0) {
      throw new Error('VERSION.js éªŒè¯å¤±è´¥:\n  ' + errors.join('\n  '))
    }

    return true
  },

  // ==================== ç‰ˆæœ¬å¯¹æ¯”æ–¹æ³• ====================

  compareVersion: function (v1, v2) {
    // æ¯”è¾ƒä¸¤ä¸ªç‰ˆæœ¬å·å¤§å°
    // è¿”å›: 1 (v1>v2), 0 (v1=v2), -1 (v1<v2)
    const parts1 = v1.replace('V', '').split('.').map(Number)
    const parts2 = v2.replace('V', '').split('.').map(Number)

    for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
      const p1 = parts1[i] || 0
      const p2 = parts2[i] || 0

      if (p1 > p2) return 1
      if (p1 < p2) return -1
    }

    return 0
  },

  // ==================== ä¿¡æ¯è·å–æ–¹æ³• ====================

  getInfo: function () {
    return {
      version: this.current,
      tableCount: this.tableCount,
      lastUpdated: this.lastUpdated,
      lastMigration: this.lastMigration,
      totalVersions: Object.keys(this.history).length
    }
  }
}
