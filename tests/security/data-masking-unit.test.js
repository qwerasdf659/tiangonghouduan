/**
 * ğŸ” æ‰‹æœºå·è„±æ•å•å…ƒæµ‹è¯•
 *
 * P0-2 ä»»åŠ¡ï¼šåˆ›å»ºæ‰‹æœºå·è„±æ•å•å…ƒæµ‹è¯•
 *
 * å®¡è®¡æ ‡å‡†ï¼š
 * - å®¡è®¡æ ‡å‡† B-1ï¼šæ‰‹æœºå·è„±æ•
 * - ã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹ç¬¬51æ¡
 * - ã€Šç½‘ç»œå®‰å…¨æ³•ã€‹ç¬¬42æ¡
 *
 * æµ‹è¯•èŒƒå›´ï¼š
 * - sanitize.mobile() å‡½æ•°å„ç§è¾“å…¥åœºæ™¯
 * - sanitizeMobile() ç›´æ¥è°ƒç”¨
 *
 * éªŒæ”¶æ ‡å‡†ï¼š
 * - npm test -- tests/security/data-masking-unit.test.js å…¨éƒ¨é€šè¿‡
 *
 * @module tests/security/data-masking-unit
 * @since 2026-01-28
 */

'use strict'

/*
 * ğŸ” ä½¿ç”¨é¡¹ç›®å·²æœ‰çš„è„±æ•å·¥å…·ï¼ˆutils/logger.jsï¼‰
 * ğŸ“Œ æ³¨æ„ï¼šsanitizeMobile ä¸ç›´æ¥å¯¼å‡ºï¼Œé€šè¿‡ sanitize.mobile æˆ– SANITIZE_RULES.mobile è®¿é—®
 */
const { sanitize, SANITIZE_RULES } = require('../../utils/logger')

describe('ğŸ” æ‰‹æœºå·è„±æ•å•å…ƒæµ‹è¯•ï¼ˆP0-2ï¼‰', () => {
  describe('sanitize.mobile() å¿«æ·æ–¹æ³•', () => {
    /**
     * P0-2-1 æ­£å¸¸æ‰‹æœºå·è„±æ•
     *
     * ä¸šåŠ¡åœºæ™¯ï¼šç”¨æˆ·ç™»å½•åæŸ¥çœ‹ä¸ªäººèµ„æ–™ï¼Œæ‰‹æœºå·éœ€è„±æ•å±•ç¤º
     * é¢„æœŸæ ¼å¼ï¼š136****7930ï¼ˆå‰3å4ï¼Œä¸­é—´4ä½ç”¨*æ›¿ä»£ï¼‰
     */
    test('P0-2-1 æ­£å¸¸æ‰‹æœºå·è„±æ•', () => {
      expect(sanitize.mobile('13612227930')).toBe('136****7930')
    })

    /**
     * P0-2-2 nullè¾“å…¥å¤„ç†
     *
     * ä¸šåŠ¡åœºæ™¯ï¼šæ•°æ®åº“ä¸­ mobile å­—æ®µä¸º NULL çš„ç”¨æˆ·
     * é¢„æœŸè¡Œä¸ºï¼šè¿”å› nullï¼Œä¸æŠ›é”™
     */
    test('P0-2-2 nullè¾“å…¥å¤„ç†', () => {
      expect(sanitize.mobile(null)).toBeNull()
    })

    /**
     * P0-2-3 undefinedè¾“å…¥å¤„ç†
     *
     * ä¸šåŠ¡åœºæ™¯ï¼šå‰ç«¯ä¼ å‚ç¼ºå¤± mobile å­—æ®µ
     * é¢„æœŸè¡Œä¸ºï¼šè¿”å› nullï¼Œä¸æŠ›é”™
     */
    test('P0-2-3 undefinedè¾“å…¥å¤„ç†', () => {
      expect(sanitize.mobile(undefined)).toBeNull()
    })

    /**
     * P0-2-4 ç©ºå­—ç¬¦ä¸²è¾“å…¥å¤„ç†
     *
     * ä¸šåŠ¡åœºæ™¯ï¼šç”¨æˆ·æ³¨å†Œæ—¶æœªå¡«å†™æ‰‹æœºå·
     * é¢„æœŸè¡Œä¸ºï¼šè¿”å› nullï¼Œä¸æŠ›é”™
     */
    test('P0-2-4 ç©ºå­—ç¬¦ä¸²è¾“å…¥å¤„ç†', () => {
      expect(sanitize.mobile('')).toBeNull()
    })

    /**
     * P0-2-5 çŸ­å·ç å¤„ç†
     *
     * ä¸šåŠ¡åœºæ™¯ï¼šéæ ‡å‡†é•¿åº¦çš„æ‰‹æœºå·ï¼ˆå¦‚4ä½çŸ­å·ï¼‰
     * é¢„æœŸè¡Œä¸ºï¼šåŸæ ·è¿”å›ï¼Œå› ä¸ºæ— æ³•æ­£å¸¸è„±æ•
     */
    test('P0-2-5 çŸ­å·ç å¤„ç†', () => {
      // çŸ­å·ç æ— æ³•æŒ‰æ ‡å‡†æ ¼å¼è„±æ•ï¼ŒåŸæ ·è¿”å›
      expect(sanitize.mobile('1234')).toBe('1234')
    })
  })

  describe('SANITIZE_RULES.mobile() ç›´æ¥è°ƒç”¨', () => {
    /**
     * é€šè¿‡ SANITIZE_RULES ç›´æ¥è®¿é—®è„±æ•å‡½æ•°
     * è¿™æ˜¯å†…éƒ¨æ¨¡å—ä½¿ç”¨çš„æ–¹å¼ï¼Œä¸ sanitize.mobile() è¡Œä¸ºä¸€è‡´
     */
    test('SANITIZE_RULES.mobile æ­£å¸¸è„±æ•', () => {
      expect(SANITIZE_RULES.mobile('18888888888')).toBe('188****8888')
    })

    test('SANITIZE_RULES.mobile å¤„ç† null', () => {
      expect(SANITIZE_RULES.mobile(null)).toBeNull()
    })

    test('SANITIZE_RULES.mobile å¤„ç† undefined', () => {
      expect(SANITIZE_RULES.mobile(undefined)).toBeNull()
    })
  })

  describe('è¾¹ç•Œåœºæ™¯æµ‹è¯•', () => {
    /**
     * ä¸åŒè¿è¥å•†å·æ®µæµ‹è¯•
     * ç¡®ä¿å„è¿è¥å•†æ‰‹æœºå·éƒ½èƒ½æ­£ç¡®è„±æ•
     */
    test('ä¸­å›½ç§»åŠ¨å·æ®µè„±æ•', () => {
      expect(sanitize.mobile('13912345678')).toBe('139****5678')
      expect(sanitize.mobile('15012345678')).toBe('150****5678')
    })

    test('ä¸­å›½è”é€šå·æ®µè„±æ•', () => {
      expect(sanitize.mobile('13012345678')).toBe('130****5678')
      expect(sanitize.mobile('18612345678')).toBe('186****5678')
    })

    test('ä¸­å›½ç”µä¿¡å·æ®µè„±æ•', () => {
      expect(sanitize.mobile('18012345678')).toBe('180****5678')
      expect(sanitize.mobile('19912345678')).toBe('199****5678')
    })

    /**
     * ç‰¹æ®Šæ ¼å¼å¤„ç†
     */
    test('å¸¦ç©ºæ ¼çš„æ‰‹æœºå·', () => {
      // åŒ…å«ç©ºæ ¼æ—¶æŒ‰åŸå­—ç¬¦ä¸²å¤„ç†ï¼ˆä¸æ»¡è¶³11ä½çº¯æ•°å­—æ ¼å¼ï¼‰
      const result = sanitize.mobile('136 1222 7930')
      // ä¸æ»¡è¶³æ ‡å‡†æ ¼å¼ï¼ŒåŸæ ·è¿”å›
      expect(result).toBe('136 1222 7930')
    })

    test('å¸¦åŒºå·çš„æ‰‹æœºå·', () => {
      /*
       * ğŸ“Œ å¸¦åŒºå·çš„æ‰‹æœºå·ä¼šè¢«éƒ¨åˆ†è„±æ•ï¼ˆæ­£åˆ™åŒ¹é…ä»»æ„ä½ç½®çš„3-4-4æ•°å­—æ¨¡å¼ï¼‰
       * å®é™…è¡Œä¸ºï¼š+8613612227930 â†’ +861****227930
       */
      const result = sanitize.mobile('+8613612227930')
      // éªŒè¯ç»“æœä»ç„¶åŒ…å«è„±æ•æ˜Ÿå·ï¼ˆå®é™…ä¸šåŠ¡ä¸­å»ºè®®å…ˆå»é™¤åŒºå·å†è„±æ•ï¼‰
      expect(result).toContain('****')
    })

    /**
     * æ•°å­—ç±»å‹è¾“å…¥
     */
    test('æ•°å­—ç±»å‹è¾“å…¥å¤„ç†', () => {
      // è™½ç„¶ä¸æ¨èï¼Œä½†åº”èƒ½å¤„ç†æ•°å­—ç±»å‹
      const numericMobile = 13612227930
      const result = sanitize.mobile(numericMobile.toString())
      expect(result).toBe('136****7930')
    })
  })

  describe('å®‰å…¨æ€§éªŒè¯', () => {
    /**
     * ç¡®ä¿è„±æ•åæ— æ³•è¿˜åŸåŸå§‹æ‰‹æœºå·
     */
    test('è„±æ•ç»“æœä¸å¯é€†', () => {
      const original = '13612227930'
      const masked = sanitize.mobile(original)

      // è„±æ•ååº”è¯¥æ— æ³•è·å–å®Œæ•´ä¸­é—´4ä½
      expect(masked).not.toContain('1222')
      expect(masked).toContain('****')
    })

    /**
     * ç¡®ä¿æ•æ„Ÿæ•°æ®ä¸ä¼šæ³„éœ²åˆ°æ—¥å¿—
     */
    test('è„±æ•æ ¼å¼ç¬¦åˆæ—¥å¿—å®‰å…¨æ ‡å‡†', () => {
      const masked = sanitize.mobile('13612227930')

      // éªŒè¯æ ¼å¼ï¼šå‰3ä½ + **** + å4ä½
      expect(masked).toMatch(/^\d{3}\*{4}\d{4}$/)
    })
  })
})
