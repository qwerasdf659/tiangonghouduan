#!/bin/bash
###############################################################################
# èƒŒåŒ…åŒè½¨æ¶æ„è¿ç§» - å‡Œæ™¨è‡ªåŠ¨åŒ–æ‰§è¡Œè„šæœ¬ï¼ˆæ–¹æ¡ˆA - ä¸€åˆ€åˆ‡ï¼‰
# æ‰§è¡Œæ—¶é—´ï¼šä»Šæ™šå‡Œæ™¨ 2:00 AMï¼ˆå»ºè®®ç³»ç»Ÿè®¿é—®é‡æœ€ä½æ—¶æ®µï¼‰
# é¢„è®¡åœæœæ—¶é—´ï¼š60åˆ†é’Ÿ
# åˆ›å»ºæ—¶é—´ï¼š2025-12-17
# å†³ç­–è®°å½•ï¼šç”¨æˆ·é€‰æ‹©æ–¹æ¡ˆAï¼ˆç«‹å³ç¦ç”¨æ—§ç³»ç»Ÿï¼Œä¸€åˆ€åˆ‡è¿ç§»ï¼‰
###############################################################################

set -e  # ä»»ä½•å‘½ä»¤å¤±è´¥ç«‹å³é€€å‡º
set -u  # ä½¿ç”¨æœªå®šä¹‰å˜é‡æ—¶æŠ¥é”™
set -o pipefail  # ç®¡é“å‘½ä»¤ä¸­ä»»ä½•å¤±è´¥éƒ½ä¼šå¯¼è‡´æ•´ä¸ªç®¡é“å¤±è´¥

# ============================================================================
# é…ç½®åŒºåŸŸ
# ============================================================================
PROJECT_ROOT="/home/devbox/project"
BACKUP_DIR="/home/devbox/project/backups/migration-$(date +%Y%m%d_%H%M%S)"
LOG_FILE="/home/devbox/project/logs/migration-$(date +%Y%m%d_%H%M%S).log"
DB_NAME="restaurant_lottery"
DB_USER="root"
DB_PASS="Aa112211"
DB_HOST="localhost"

# é¢œè‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ============================================================================
# å·¥å…·å‡½æ•°
# ============================================================================
log() {
    echo -e "${GREEN}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1" | tee -a "$LOG_FILE"
}

log_error() {
    echo -e "${RED}[$(date '+%Y-%m-%d %H:%M:%S')] ERROR:${NC} $1" | tee -a "$LOG_FILE"
}

log_warn() {
    echo -e "${YELLOW}[$(date '+%Y-%m-%d %H:%M:%S')] WARN:${NC} $1" | tee -a "$LOG_FILE"
}

log_info() {
    echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')] INFO:${NC} $1" | tee -a "$LOG_FILE"
}

# æ£€æŸ¥å‘½ä»¤æ˜¯å¦æˆåŠŸ
check_status() {
    if [ $? -eq 0 ]; then
        log "âœ… $1 - æˆåŠŸ"
    else
        log_error "âŒ $1 - å¤±è´¥"
        exit 1
    fi
}

# ============================================================================
# ç¬¬ä¸€é˜¶æ®µï¼šè¿ç§»å‰å‡†å¤‡ï¼ˆé¢„è®¡10åˆ†é’Ÿï¼‰
# ============================================================================
stage1_preparation() {
    log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    log "ç¬¬ä¸€é˜¶æ®µï¼šè¿ç§»å‰å‡†å¤‡"
    log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    # 1. åˆ›å»ºå¤‡ä»½ç›®å½•
    log_info "åˆ›å»ºå¤‡ä»½ç›®å½•: $BACKUP_DIR"
    mkdir -p "$BACKUP_DIR"
    mkdir -p "$(dirname "$LOG_FILE")"
    check_status "åˆ›å»ºå¤‡ä»½ç›®å½•"
    
    # 2. åœæ­¢åç«¯æœåŠ¡
    log_info "åœæ­¢åç«¯æœåŠ¡ï¼ˆåœæœå¼€å§‹ï¼‰"
    cd "$PROJECT_ROOT"
    pm2 stop all || log_warn "PM2æœåŠ¡åœæ­¢å¤±è´¥ï¼ˆå¯èƒ½æœªå¯åŠ¨ï¼‰"
    sleep 5
    check_status "åœæ­¢åç«¯æœåŠ¡"
    
    # 3. å¤‡ä»½æ•°æ®åº“
    log_info "å¤‡ä»½æ•°æ®åº“: $DB_NAME"
    mysqldump -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" \
        --single-transaction \
        --routines \
        --triggers \
        "$DB_NAME" > "$BACKUP_DIR/database_backup.sql"
    check_status "æ•°æ®åº“å¤‡ä»½"
    
    log_info "æ•°æ®åº“å¤‡ä»½æ–‡ä»¶å¤§å°: $(du -h "$BACKUP_DIR/database_backup.sql" | cut -f1)"
    
    # 4. å¤‡ä»½å…³é”®è¡¨ï¼ˆé¢å¤–å®‰å…¨æªæ–½ï¼‰
    log_info "å¤‡ä»½å…³é”®è¡¨: user_inventory, item_instances, redemption_orders"
    mysqldump -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" \
        "$DB_NAME" \
        user_inventory \
        item_instances \
        redemption_orders \
        > "$BACKUP_DIR/critical_tables_backup.sql"
    check_status "å…³é”®è¡¨å¤‡ä»½"
    
    # 5. å¤‡ä»½ä»£ç æ–‡ä»¶
    log_info "å¤‡ä»½å…³é”®ä»£ç æ–‡ä»¶"
    cp "$PROJECT_ROOT/services/InventoryService.js" "$BACKUP_DIR/"
    cp "$PROJECT_ROOT/models/UserInventory.js" "$BACKUP_DIR/"
    cp "$PROJECT_ROOT/routes/v4/unified-engine/inventory-core.js" "$BACKUP_DIR/"
    check_status "ä»£ç æ–‡ä»¶å¤‡ä»½"
    
    log "âœ… ç¬¬ä¸€é˜¶æ®µå®Œæˆï¼šè¿ç§»å‰å‡†å¤‡"
}

# ============================================================================
# ç¬¬äºŒé˜¶æ®µï¼šæ—§ç å¤±æ•ˆå¤„ç†ï¼ˆé¢„è®¡5åˆ†é’Ÿï¼‰
# ============================================================================
stage2_invalidate_old_codes() {
    log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    log "ç¬¬äºŒé˜¶æ®µï¼šæ—§ç å¤±æ•ˆå¤„ç†"
    log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    log_info "æ‰§è¡Œæ—§ç å¤±æ•ˆè„šæœ¬: invalidate-old-codes.js"
    cd "$PROJECT_ROOT"
    node scripts/migration/invalidate-old-codes.js 2>&1 | tee -a "$LOG_FILE"
    check_status "æ—§ç å¤±æ•ˆå¤„ç†"
    
    # éªŒè¯æ—§ç æ˜¯å¦å·²å¤±æ•ˆ
    log_info "éªŒè¯æ—§ç å¤±æ•ˆæƒ…å†µ"
    local old_codes_count=$(mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" -s -N "$DB_NAME" \
        -e "SELECT COUNT(*) FROM user_inventory WHERE verification_code IS NOT NULL AND verification_code != '';")
    
    if [ "$old_codes_count" -eq 0 ]; then
        log "âœ… æ‰€æœ‰æ—§ç å·²æˆåŠŸå¤±æ•ˆï¼ˆverification_code = NULLï¼‰"
    else
        log_warn "âš ï¸ ä»æœ‰ $old_codes_count æ¡è®°å½•å­˜åœ¨æ—§ç ï¼Œä½†ä¸å½±å“è¿ç§»"
    fi
    
    log "âœ… ç¬¬äºŒé˜¶æ®µå®Œæˆï¼šæ—§ç å¤±æ•ˆå¤„ç†"
}

# ============================================================================
# ç¬¬ä¸‰é˜¶æ®µï¼šæ•°æ®è¿ç§»æ‰§è¡Œï¼ˆé¢„è®¡20-30åˆ†é’Ÿï¼‰
# ============================================================================
stage3_data_migration() {
    log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    log "ç¬¬ä¸‰é˜¶æ®µï¼šæ•°æ®è¿ç§»æ‰§è¡Œï¼ˆæ ¸å¿ƒé˜¶æ®µï¼‰"
    log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    log_info "æ‰§è¡Œæ•°æ®è¿ç§»è„šæœ¬: migrate-user-inventory-to-dual-track.js"
    cd "$PROJECT_ROOT"
    node scripts/migrate-user-inventory-to-dual-track.js 2>&1 | tee -a "$LOG_FILE"
    check_status "æ•°æ®è¿ç§»æ‰§è¡Œ"
    
    # æ£€æŸ¥è¿ç§»ç»Ÿè®¡
    log_info "æ£€æŸ¥è¿ç§»ç»Ÿè®¡"
    local total_records=$(mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" -s -N "$DB_NAME" \
        -e "SELECT COUNT(*) FROM user_inventory;")
    local item_instances=$(mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" -s -N "$DB_NAME" \
        -e "SELECT COUNT(*) FROM item_instances;")
    local asset_balances=$(mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" -s -N "$DB_NAME" \
        -e "SELECT COUNT(*) FROM account_asset_balances;")
    local redemption_orders=$(mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" -s -N "$DB_NAME" \
        -e "SELECT COUNT(*) FROM redemption_orders;")
    
    log_info "è¿ç§»ç»Ÿè®¡ï¼š"
    log_info "  åŸå§‹è®°å½•ï¼ˆuser_inventoryï¼‰: $total_records"
    log_info "  è¿ç§»åç‰©å“å®ä¾‹ï¼ˆitem_instancesï¼‰: $item_instances"
    log_info "  è¿ç§»åèµ„äº§ä½™é¢ï¼ˆaccount_asset_balancesï¼‰: $asset_balances"
    log_info "  è¿ç§»åå…‘æ¢è®¢å•ï¼ˆredemption_ordersï¼‰: $redemption_orders"
    
    log "âœ… ç¬¬ä¸‰é˜¶æ®µå®Œæˆï¼šæ•°æ®è¿ç§»æ‰§è¡Œ"
}

# ============================================================================
# ç¬¬å››é˜¶æ®µï¼šæ—§è¡¨é‡å‘½åï¼ˆé¢„è®¡2åˆ†é’Ÿï¼‰
# ============================================================================
stage4_rename_old_table() {
    log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    log "ç¬¬å››é˜¶æ®µï¼šæ—§è¡¨é‡å‘½å"
    log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    log_info "æ‰§è¡Œæ•°æ®åº“è¿ç§»: rename user_inventory to _deprecated_*"
    cd "$PROJECT_ROOT"
    npx sequelize-cli db:migrate --name 20251217160809-rename-user-inventory-to-deprecated.js 2>&1 | tee -a "$LOG_FILE"
    check_status "æ—§è¡¨é‡å‘½å"
    
    # éªŒè¯è¡¨æ˜¯å¦å·²é‡å‘½å
    log_info "éªŒè¯è¡¨é‡å‘½åç»“æœ"
    local deprecated_tables=$(mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" -s -N "$DB_NAME" \
        -e "SHOW TABLES LIKE '_deprecated_user_inventory%';" | wc -l)
    
    if [ "$deprecated_tables" -gt 0 ]; then
        log "âœ… user_inventory è¡¨å·²æˆåŠŸé‡å‘½åä¸º _deprecated_*"
    else
        log_error "âŒ user_inventory è¡¨é‡å‘½åå¤±è´¥"
        exit 1
    fi
    
    log "âœ… ç¬¬å››é˜¶æ®µå®Œæˆï¼šæ—§è¡¨é‡å‘½å"
}

# ============================================================================
# ç¬¬äº”é˜¶æ®µï¼šå¯¹è´¦éªŒè¯ï¼ˆé¢„è®¡10åˆ†é’Ÿï¼‰
# ============================================================================
stage5_reconciliation() {
    log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    log "ç¬¬äº”é˜¶æ®µï¼šå¯¹è´¦éªŒè¯"
    log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    log_info "æ‰§è¡Œå¯¹è´¦è„šæœ¬: reconcile-inventory-migration.js"
    cd "$PROJECT_ROOT"
    node scripts/reconcile-inventory-migration.js 2>&1 | tee -a "$LOG_FILE"
    
    if [ $? -eq 0 ]; then
        log "âœ… å¯¹è´¦éªŒè¯é€šè¿‡ï¼šæ•°æ®ä¸€è‡´æ€§100%"
    else
        log_error "âŒ å¯¹è´¦éªŒè¯å¤±è´¥ï¼šå­˜åœ¨æ•°æ®ä¸ä¸€è‡´"
        log_error "è¯·æ£€æŸ¥å¯¹è´¦æŠ¥å‘Šï¼Œå†³å®šæ˜¯å¦å›æ»š"
        # ä¸è‡ªåŠ¨å›æ»šï¼Œç­‰å¾…äººå·¥å†³ç­–
        read -p "æ˜¯å¦ç»§ç»­ï¼Ÿ(y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log_error "ç”¨æˆ·é€‰æ‹©ä¸­æ­¢ï¼Œå¼€å§‹å›æ»š"
            rollback_migration
            exit 1
        fi
    fi
    
    log "âœ… ç¬¬äº”é˜¶æ®µå®Œæˆï¼šå¯¹è´¦éªŒè¯"
}

# ============================================================================
# ç¬¬å…­é˜¶æ®µï¼šæœåŠ¡é‡å¯å’ŒçƒŸé›¾æµ‹è¯•ï¼ˆé¢„è®¡10åˆ†é’Ÿï¼‰
# ============================================================================
stage6_restart_and_test() {
    log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    log "ç¬¬å…­é˜¶æ®µï¼šæœåŠ¡é‡å¯å’ŒçƒŸé›¾æµ‹è¯•"
    log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    # 1. é‡å¯åç«¯æœåŠ¡
    log_info "é‡å¯åç«¯æœåŠ¡"
    cd "$PROJECT_ROOT"
    pm2 restart all 2>&1 | tee -a "$LOG_FILE"
    check_status "åç«¯æœåŠ¡é‡å¯"
    
    log_info "ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆ30ç§’ï¼‰"
    sleep 30
    
    # 2. å¥åº·æ£€æŸ¥
    log_info "æ‰§è¡Œå¥åº·æ£€æŸ¥"
    local health_status=$(curl -s http://localhost:3000/health | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
    
    if [ "$health_status" = "healthy" ]; then
        log "âœ… åç«¯æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
    else
        log_error "âŒ åç«¯æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥"
        exit 1
    fi
    
    # 3. çƒŸé›¾æµ‹è¯•ï¼šæ—§èƒŒåŒ…æ¥å£åº”è¿”å›410
    log_info "æµ‹è¯•æ—§èƒŒåŒ…æ¥å£ï¼ˆåº”è¿”å›410ï¼‰"
    local old_endpoint_status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/v4/inventory/user/1)
    
    if [ "$old_endpoint_status" = "410" ]; then
        log "âœ… æ—§èƒŒåŒ…æ¥å£å·²æ­£ç¡®ç¦ç”¨ï¼ˆè¿”å›410 Goneï¼‰"
    else
        log_warn "âš ï¸ æ—§èƒŒåŒ…æ¥å£è¿”å› $old_endpoint_statusï¼ˆé¢„æœŸ410ï¼‰"
    fi
    
    # 4. çƒŸé›¾æµ‹è¯•ï¼šæ–°èƒŒåŒ…æ¥å£åº”æ­£å¸¸å·¥ä½œ
    log_info "æµ‹è¯•æ–°èƒŒåŒ…æ¥å£ï¼ˆåº”è¿”å›200ï¼‰"
    local new_endpoint_status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/v4/backpack/user/1)
    
    if [ "$new_endpoint_status" = "200" ] || [ "$new_endpoint_status" = "401" ]; then
        log "âœ… æ–°èƒŒåŒ…æ¥å£æ­£å¸¸å·¥ä½œï¼ˆè¿”å› $new_endpoint_statusï¼‰"
    else
        log_error "âŒ æ–°èƒŒåŒ…æ¥å£å¼‚å¸¸ï¼ˆè¿”å› $new_endpoint_statusï¼‰"
    fi
    
    # 5. çƒŸé›¾æµ‹è¯•ï¼šæ—§ç ç”Ÿæˆåº”æŠ›å‡ºå¼‚å¸¸
    log_info "æµ‹è¯•æ—§ç ç”Ÿæˆï¼ˆåº”æŠ›å‡ºå¼‚å¸¸ï¼‰"
    # è¿™é‡Œéœ€è¦æ ¹æ®å®é™…APIè·¯å¾„è°ƒæ•´
    
    log "âœ… ç¬¬å…­é˜¶æ®µå®Œæˆï¼šæœåŠ¡é‡å¯å’ŒçƒŸé›¾æµ‹è¯•"
}

# ============================================================================
# å›æ»šå‡½æ•°ï¼ˆç´§æ€¥æƒ…å†µä½¿ç”¨ï¼‰
# ============================================================================
rollback_migration() {
    log_error "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    log_error "å¼€å§‹å›æ»šè¿ç§»"
    log_error "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    # 1. åœæ­¢æœåŠ¡
    log_info "åœæ­¢åç«¯æœåŠ¡"
    cd "$PROJECT_ROOT"
    pm2 stop all
    
    # 2. æ¢å¤æ•°æ®åº“
    log_info "æ¢å¤æ•°æ®åº“å¤‡ä»½"
    mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" < "$BACKUP_DIR/database_backup.sql"
    check_status "æ•°æ®åº“æ¢å¤"
    
    # 3. æ¢å¤ä»£ç æ–‡ä»¶
    log_info "æ¢å¤ä»£ç æ–‡ä»¶"
    cp "$BACKUP_DIR/InventoryService.js" "$PROJECT_ROOT/services/"
    cp "$BACKUP_DIR/UserInventory.js" "$PROJECT_ROOT/models/"
    cp "$BACKUP_DIR/inventory-core.js" "$PROJECT_ROOT/routes/v4/unified-engine/"
    check_status "ä»£ç æ–‡ä»¶æ¢å¤"
    
    # 4. é‡å¯æœåŠ¡
    log_info "é‡å¯åç«¯æœåŠ¡"
    pm2 restart all
    
    log_error "å›æ»šå®Œæˆï¼Œè¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€"
}

# ============================================================================
# ä¸»æ‰§è¡Œæµç¨‹
# ============================================================================
main() {
    log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    log "èƒŒåŒ…åŒè½¨æ¶æ„è¿ç§» - è‡ªåŠ¨åŒ–æ‰§è¡Œ"
    log "æ–¹æ¡ˆï¼šAï¼ˆä¸€åˆ€åˆ‡ï¼Œç«‹å³ç¦ç”¨æ—§ç³»ç»Ÿï¼‰"
    log "æ‰§è¡Œæ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')"
    log "é¢„è®¡åœæœæ—¶é—´ï¼š60åˆ†é’Ÿ"
    log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    log_warn "âš ï¸ è¿ç§»å³å°†å¼€å§‹ï¼Œç³»ç»Ÿå°†åœæœ60åˆ†é’Ÿ"
    log_warn "âš ï¸ å¤‡ä»½ç›®å½•: $BACKUP_DIR"
    log_warn "âš ï¸ æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
    
    # ç­‰å¾…5ç§’ç¡®è®¤
    log_info "5ç§’åå¼€å§‹è¿ç§»..."
    sleep 5
    
    # è®°å½•å¼€å§‹æ—¶é—´
    local start_time=$(date +%s)
    
    # æ‰§è¡Œå„é˜¶æ®µ
    stage1_preparation           # ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡ï¼ˆ10åˆ†é’Ÿï¼‰
    stage2_invalidate_old_codes  # ç¬¬äºŒé˜¶æ®µï¼šæ—§ç å¤±æ•ˆï¼ˆ5åˆ†é’Ÿï¼‰
    stage3_data_migration        # ç¬¬ä¸‰é˜¶æ®µï¼šæ•°æ®è¿ç§»ï¼ˆ20-30åˆ†é’Ÿï¼‰
    stage4_rename_old_table      # ç¬¬å››é˜¶æ®µï¼šæ—§è¡¨é‡å‘½åï¼ˆ2åˆ†é’Ÿï¼‰
    stage5_reconciliation        # ç¬¬äº”é˜¶æ®µï¼šå¯¹è´¦éªŒè¯ï¼ˆ10åˆ†é’Ÿï¼‰
    stage6_restart_and_test      # ç¬¬å…­é˜¶æ®µï¼šé‡å¯æµ‹è¯•ï¼ˆ10åˆ†é’Ÿï¼‰
    
    # è®¡ç®—æ€»è€—æ—¶
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    local minutes=$((duration / 60))
    local seconds=$((duration % 60))
    
    log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    log "ğŸ‰ è¿ç§»æˆåŠŸå®Œæˆï¼"
    log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    log "æ€»è€—æ—¶: ${minutes}åˆ†${seconds}ç§’"
    log "å¤‡ä»½ç›®å½•: $BACKUP_DIR"
    log "æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
    log ""
    log "ä¸‹ä¸€æ­¥æ“ä½œï¼š"
    log "1. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ç¡®è®¤æ— å¼‚å¸¸"
    log "2. é€šçŸ¥å‰ç«¯å›¢é˜Ÿæ›´æ–°æ¥å£è°ƒç”¨"
    log "3. é€šçŸ¥å•†å®¶ç«¯æ›´æ–°æ‰«ç æ¥å£"
    log "4. ç›‘æ§ç³»ç»Ÿè¿è¡Œ24å°æ—¶"
    log "5. ç¡®è®¤æ— é—®é¢˜ååˆ é™¤ _deprecated_user_inventory_* è¡¨ï¼ˆ30å¤©åï¼‰"
    log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
}

# æ‰§è¡Œä¸»æµç¨‹
main "$@"

