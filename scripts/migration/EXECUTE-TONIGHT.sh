#!/bin/bash
###############################################################################
# ä»Šæ™šå‡Œæ™¨è¿ç§»æ‰§è¡Œè„šæœ¬ - ä¸€é”®å¯åŠ¨ç‰ˆ
# 
# æ‰§è¡Œæ–¹å¼1ï¼ˆæ¨èï¼‰ï¼šè®¾ç½®ç³»ç»Ÿå®šæ—¶ä»»åŠ¡
#   - å¦‚æœæœ‰crontab: crontab -eï¼Œæ·»åŠ  0 2 * * * /path/to/this/script
#   - å¦‚æœæœ‰systemd timer: åˆ›å»ºtimerå•å…ƒ
#   - å¦‚æœæœ‰atå‘½ä»¤: at 02:00 -f /path/to/this/script
#
# æ‰§è¡Œæ–¹å¼2ï¼šæ‰‹åŠ¨æ‰§è¡Œï¼ˆå‡Œæ™¨2:00æ‰‹åŠ¨è¿è¡Œï¼‰
#   cd /home/devbox/project
#   ./scripts/migration/EXECUTE-TONIGHT.sh
#
# æ‰§è¡Œæ–¹å¼3ï¼šåå°æ‰§è¡Œï¼ˆç°åœ¨å°±å¯åŠ¨ï¼Œç­‰åˆ°å‡Œæ™¨2:00è‡ªåŠ¨æ‰§è¡Œï¼‰
#   nohup ./scripts/migration/EXECUTE-TONIGHT.sh &
#   # è„šæœ¬ä¼šè‡ªåŠ¨ç­‰åˆ°å‡Œæ™¨2:00æ‰å¼€å§‹è¿ç§»
###############################################################################

set -e

PROJECT_ROOT="/home/devbox/project"
TARGET_TIME="02:00"  # å‡Œæ™¨2ç‚¹

# é¢œè‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[$(date '+%Y-%m-%d %H:%M:%S')] WARN:${NC} $1"
}

log_error() {
    echo -e "${RED}[$(date '+%Y-%m-%d %H:%M:%S')] ERROR:${NC} $1"
}

# ============================================================================
# æ£€æŸ¥æ˜¯å¦åˆ°è¾¾æ‰§è¡Œæ—¶é—´
# ============================================================================
check_time() {
    local current_time=$(date +%H:%M)
    local current_hour=$(date +%H)
    
    if [ "$current_hour" -ge 2 ] && [ "$current_hour" -lt 3 ]; then
        log "âœ… å½“å‰æ—¶é—´ $current_time åœ¨æ‰§è¡Œçª—å£å†…ï¼ˆ02:00-03:00ï¼‰ï¼Œç«‹å³æ‰§è¡Œè¿ç§»"
        return 0
    else
        log_warn "å½“å‰æ—¶é—´ $current_timeï¼Œé¢„å®šæ‰§è¡Œæ—¶é—´ $TARGET_TIME"
        return 1
    fi
}

# ============================================================================
# ç­‰å¾…åˆ°æ‰§è¡Œæ—¶é—´
# ============================================================================
wait_until_target_time() {
    local current_hour=$(date +%H)
    local current_minute=$(date +%M)
    
    # å¦‚æœå½“å‰æ—¶é—´å·²ç»è¿‡äº†ä»Šå¤©çš„2:00ï¼Œåˆ™ç­‰åˆ°æ˜å¤©2:00
    if [ "$current_hour" -ge 2 ]; then
        local seconds_until_tomorrow_2am=$((86400 - (current_hour * 3600 + current_minute * 60) + 2 * 3600))
        log_warn "ä»Šå¤©çš„æ‰§è¡Œçª—å£å·²è¿‡ï¼Œå°†åœ¨æ˜å¤©å‡Œæ™¨2:00æ‰§è¡Œ"
        log_warn "ç­‰å¾…æ—¶é—´: $((seconds_until_tomorrow_2am / 3600))å°æ—¶ $((seconds_until_tomorrow_2am % 3600 / 60))åˆ†é’Ÿ"
    else
        local seconds_until_2am=$((2 * 3600 - (current_hour * 3600 + current_minute * 60)))
        log_warn "å°†åœ¨ä»Šå¤©å‡Œæ™¨2:00æ‰§è¡Œè¿ç§»"
        log_warn "ç­‰å¾…æ—¶é—´: $((seconds_until_2am / 3600))å°æ—¶ $((seconds_until_2am % 3600 / 60))åˆ†é’Ÿ"
        sleep "$seconds_until_2am"
    fi
}

# ============================================================================
# ä¸»æµç¨‹
# ============================================================================
main() {
    log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    log "èƒŒåŒ…åŒè½¨æ¶æ„è¿ç§» - ä»Šæ™šæ‰§è¡Œè„šæœ¬"
    log "æ–¹æ¡ˆï¼šAï¼ˆä¸€åˆ€åˆ‡ï¼Œç«‹å³ç¦ç”¨æ—§ç³»ç»Ÿï¼‰"
    log "å½“å‰æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')"
    log "é¢„å®šæ‰§è¡Œæ—¶é—´ï¼šä»Šæ™šå‡Œæ™¨ $TARGET_TIME"
    log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    # æ£€æŸ¥æ˜¯å¦åœ¨æ‰§è¡Œæ—¶é—´çª—å£å†…
    if ! check_time; then
        log_warn "â° ç­‰å¾…åˆ°æ‰§è¡Œæ—¶é—´..."
        wait_until_target_time
    fi
    
    log "ğŸš€ å¼€å§‹æ‰§è¡Œè¿ç§»..."
    
    # æ‰§è¡Œä¸»è¿ç§»è„šæœ¬
    cd "$PROJECT_ROOT"
    bash ./scripts/migration/execute-midnight-migration.sh
    
    exit_code=$?
    
    if [ $exit_code -eq 0 ]; then
        log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        log "ğŸ‰ è¿ç§»æ‰§è¡Œå®Œæˆï¼"
        log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        log ""
        log "ä¸‹ä¸€æ­¥æ“ä½œï¼š"
        log "1. æŸ¥çœ‹è¿ç§»æ—¥å¿—: tail -100 /home/devbox/project/logs/migration-*.log"
        log "2. æ‰§è¡ŒéªŒæ”¶æ£€æŸ¥: å‚è€ƒ scripts/migration/post-migration-verification.md"
        log "3. å¦‚æœéªŒæ”¶å¤±è´¥ï¼Œç«‹å³æ‰§è¡Œå›æ»š"
        log ""
        log "éªŒæ”¶æ£€æŸ¥æ¸…å•ä½ç½®: $PROJECT_ROOT/scripts/migration/post-migration-verification.md"
    else
        log_error "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        log_error "âŒ è¿ç§»æ‰§è¡Œå¤±è´¥ï¼"
        log_error "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        log_error "è¯·ç«‹å³æŸ¥çœ‹æ—¥å¿—: /home/devbox/project/logs/migration-*.log"
        log_error "å¦‚éœ€å›æ»šï¼Œè¯·æŸ¥çœ‹å¤‡ä»½ç›®å½•: /home/devbox/project/backups/migration-*"
    fi
    
    exit $exit_code
}

# æ‰§è¡Œä¸»æµç¨‹
main "$@"

