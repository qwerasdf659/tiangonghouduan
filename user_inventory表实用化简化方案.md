# user_inventory è¡¨å®ç”¨åŒ–ç®€åŒ–æ–¹æ¡ˆ

## ğŸ“‹ **ç”¨æˆ·éœ€æ±‚ç¡®è®¤**

æ‚¨éœ€è¦çš„æ ¸å¿ƒåŠŸèƒ½ï¼š
- âœ… **è™šæ‹Ÿç‰©å“ç®¡ç†**ï¼šç®¡ç†ç”¨æˆ·è·å¾—çš„å¥–å“/ä¼˜æƒ åˆ¸
- âœ… **æ ¸é”€ç ç³»ç»Ÿ**ï¼šç”Ÿæˆå’ŒéªŒè¯æ ¸é”€ç   
- âœ… **ç‰©å“è½¬è®©**ï¼šç”¨æˆ·é—´è½¬è®©ç‰©å“

**è®¾è®¡ç›®æ ‡**ï¼šä¿ç•™æ ¸å¿ƒåŠŸèƒ½ï¼Œç®€åŒ–è¿‡åº¦è®¾è®¡éƒ¨åˆ†

---

## ğŸ¯ **ç®€åŒ–å‰åå¯¹æ¯”**

### **å½“å‰è®¾è®¡ï¼ˆ18ä¸ªå­—æ®µï¼‰- è¿‡åº¦å¤æ‚**
```sql
-- å½“å‰ user_inventory è¡¨å­—æ®µ
id, user_id, name, description, type, value, status,           -- 7ä¸ªæ ¸å¿ƒ
source_type, source_id,                                         -- 2ä¸ªæ¥æºè¿½è¸ªï¼ˆå†—ä½™ï¼‰
acquired_at, expires_at, used_at,                              -- 3ä¸ªæ—¶é—´ç®¡ç†
verification_code, verification_expires_at,                    -- 2ä¸ªæ ¸é”€ç ï¼ˆéœ€è¦ï¼‰
transfer_to_user_id, transfer_at, transfer_message,           -- 3ä¸ªè½¬è®©åŠŸèƒ½
icon, metadata,                                                -- 2ä¸ªæ‰©å±•åŠŸèƒ½ï¼ˆå†—ä½™ï¼‰
created_at, updated_at                                         -- 2ä¸ªæ ‡å‡†æ—¶é—´æˆ³
```

### **ç®€åŒ–è®¾è®¡ï¼ˆ13ä¸ªå­—æ®µï¼‰- å®ç”¨ç‰ˆ**
```sql
-- ç®€åŒ–åçš„ user_inventory è¡¨
-- 1. æ ¸å¿ƒç‰©å“ä¿¡æ¯ï¼ˆ7ä¸ªå­—æ®µï¼‰
id                     VARCHAR(32)    PRIMARY KEY     -- ç‰©å“å”¯ä¸€ID
user_id                INT            NOT NULL        -- ç”¨æˆ·ID
name                   VARCHAR(100)   NOT NULL        -- ç‰©å“åç§°
description            TEXT                           -- ç‰©å“æè¿°
type                   ENUM('voucher','product','service') NOT NULL -- ç‰©å“ç±»å‹
value                  INT            DEFAULT 0       -- ç‰©å“ä»·å€¼
status                 ENUM('available','used','expired','transferred') NOT NULL -- ç‰©å“çŠ¶æ€

-- 2. æ ¸é”€ç åŠŸèƒ½ï¼ˆ2ä¸ªå­—æ®µï¼‰- æ‚¨éœ€è¦çš„
verification_code      VARCHAR(8)     UNIQUE          -- æ ¸é”€ç ï¼ˆç®€åŒ–ä¸º8ä½ï¼‰
verification_expires_at TIMESTAMP                     -- æ ¸é”€ç è¿‡æœŸæ—¶é—´

-- 3. è½¬è®©åŠŸèƒ½ï¼ˆ2ä¸ªå­—æ®µï¼‰- æ‚¨éœ€è¦çš„  
transfer_to_user_id    INT                            -- è½¬è®©ç›®æ ‡ç”¨æˆ·
transfer_at            TIMESTAMP                      -- è½¬è®©æ—¶é—´

-- 4. æ—¶é—´ç®¡ç†ï¼ˆ2ä¸ªå­—æ®µï¼‰
expires_at             TIMESTAMP                      -- ç‰©å“è¿‡æœŸæ—¶é—´
created_at             TIMESTAMP      DEFAULT NOW()   -- åˆ›å»ºæ—¶é—´
```

---

## ğŸ—‘ï¸ **åˆ é™¤çš„å­—æ®µåŠåŸå› **

### **åˆ é™¤å­—æ®µåˆ—è¡¨**
```sql
âŒ source_type          - æ¥æºç±»å‹ï¼ˆå¯é€šè¿‡ä¸šåŠ¡é€»è¾‘æ¨æ–­ï¼‰
âŒ source_id            - æ¥æºIDï¼ˆå¯é€šè¿‡å…¶ä»–è¡¨å…³è”æŸ¥è¯¢ï¼‰
âŒ acquired_at          - è·å¾—æ—¶é—´ï¼ˆä¸created_até‡å¤ï¼‰
âŒ used_at              - ä½¿ç”¨æ—¶é—´ï¼ˆå¯é€šè¿‡çŠ¶æ€å˜æ›´è®°å½•ï¼‰
âŒ transfer_message     - è½¬è®©ç•™è¨€ï¼ˆå®é™…ä½¿ç”¨ä»·å€¼ä½ï¼‰
âŒ icon                 - æ˜¾ç¤ºå›¾æ ‡ï¼ˆå‰ç«¯é…ç½®å³å¯ï¼‰
âŒ metadata             - æ‰©å±•æ•°æ®ï¼ˆYAGNIåŸåˆ™ï¼‰
âŒ updated_at           - æ›´æ–°æ—¶é—´ï¼ˆç®€å•ä¸šåŠ¡ä¸éœ€è¦ï¼‰
```

### **åˆ é™¤åŸå› åˆ†æ**
1. **å†—ä½™ä¿¡æ¯**ï¼š`acquired_at` ä¸ `created_at` é‡å¤
2. **å¯æ¨å¯¼ä¿¡æ¯**ï¼š`source_type` å¯é€šè¿‡ä¸šåŠ¡é€»è¾‘ç¡®å®š
3. **ä½ä»·å€¼åŠŸèƒ½**ï¼š`transfer_message` å®é™…ä½¿ç”¨é¢‘ç‡æä½
4. **å‰ç«¯é…ç½®**ï¼š`icon` å¯åœ¨å‰ç«¯é…ç½®æ–‡ä»¶ä¸­å®šä¹‰
5. **è¿‡åº¦æ‰©å±•**ï¼š`metadata` è¿åYAGNIåŸåˆ™

---

## âœ… **ä¿ç•™åŠŸèƒ½çš„å®ç”¨è®¾è®¡**

### **1. æ ¸é”€ç ç³»ç»Ÿ - ç®€åŒ–ä½†å®ç”¨**

#### **ç®€åŒ–ç‚¹**
- æ ¸é”€ç é•¿åº¦ï¼š32ä½ â†’ 8ä½ï¼ˆæé«˜ç”¨æˆ·ä½“éªŒï¼‰
- ç”Ÿæˆç®—æ³•ï¼šå¤æ‚éšæœº â†’ ç®€å•éšæœºï¼ˆé™ä½å¤æ‚åº¦ï¼‰

#### **å®ç”¨ä»£ç **
```javascript
// ç®€åŒ–çš„æ ¸é”€ç ç”Ÿæˆ
async generateVerificationCode() {
  const code = Math.random().toString(36).substr(2, 8).toUpperCase();
  this.verification_code = code;
  this.verification_expires_at = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000); // 7å¤©æœ‰æ•ˆ
  await this.save();
  return code;
}

// æ ¸é”€ç éªŒè¯
async verifyCode(inputCode) {
  return this.verification_code === inputCode && 
         new Date() < this.verification_expires_at &&
         this.status === 'available';
}
```

### **2. ç‰©å“è½¬è®© - ç®€åŒ–ä½†å®Œæ•´**

#### **ç®€åŒ–ç‚¹**
- åˆ é™¤è½¬è®©ç•™è¨€ï¼ˆå®é™…ä½¿ç”¨ç‡ä½ï¼‰
- ä¿ç•™æ ¸å¿ƒè½¬è®©é€»è¾‘

#### **å®ç”¨ä»£ç **
```javascript
// ç®€åŒ–çš„è½¬è®©åŠŸèƒ½
async transferTo(targetUserId) {
  if (this.status !== 'available') {
    throw new Error('ç‰©å“ä¸å¯è½¬è®©');
  }
  
  this.transfer_to_user_id = targetUserId;
  this.transfer_at = new Date();
  this.status = 'transferred';
  await this.save();
  
  // åœ¨ç›®æ ‡ç”¨æˆ·åº“å­˜ä¸­åˆ›å»ºæ–°è®°å½•
  const newItem = await UserInventory.create({
    id: generateItemId(),
    user_id: targetUserId,
    name: this.name,
    description: this.description,
    type: this.type,
    value: this.value,
    status: 'available',
    expires_at: this.expires_at
  });
  
  return newItem;
}
```

### **3. è™šæ‹Ÿç‰©å“ç®¡ç† - æ ¸å¿ƒä½†ç®€æ´**

#### **ç±»å‹å®šä¹‰**
```javascript
// ç‰©å“ç±»å‹æšä¸¾
const ITEM_TYPES = {
  voucher: 'ä¼˜æƒ åˆ¸',   // é¤å…ä¼˜æƒ åˆ¸ã€æŠ˜æ‰£åˆ¸
  product: 'å®ç‰©å•†å“', // å°ç¤¼å“ã€çºªå¿µå“  
  service: 'æœåŠ¡'      // VIPæœåŠ¡ã€ç‰¹æ®Šä½“éªŒ
};

// ç‰©å“çŠ¶æ€æšä¸¾
const ITEM_STATUS = {
  available: 'å¯ç”¨',      // å¯ä»¥ä½¿ç”¨æˆ–è½¬è®©
  used: 'å·²ä½¿ç”¨',         // å·²ç»æ ¸é”€ä½¿ç”¨
  expired: 'å·²è¿‡æœŸ',      // è¶…è¿‡æœ‰æ•ˆæœŸ
  transferred: 'å·²è½¬è®©'   // å·²è½¬è®©ç»™å…¶ä»–ç”¨æˆ·
};
```

---

## ğŸ“Š **ç®€åŒ–æ•ˆæœå¯¹æ¯”**

### **å¤æ‚åº¦å¯¹æ¯”**
```
ç®€åŒ–å‰ï¼š18ä¸ªå­—æ®µï¼Œå¤æ‚åº¦100%
ç®€åŒ–åï¼š13ä¸ªå­—æ®µï¼Œå¤æ‚åº¦72%
å‡å°‘ï¼š5ä¸ªå­—æ®µï¼Œé™ä½28%å¤æ‚åº¦
```

### **åŠŸèƒ½å®Œæ•´æ€§**
```
âœ… ç‰©å“åŸºç¡€ç®¡ç†ï¼š100%ä¿ç•™
âœ… æ ¸é”€ç ç³»ç»Ÿï¼š100%ä¿ç•™ï¼ˆç®€åŒ–å®ç°ï¼‰
âœ… è½¬è®©åŠŸèƒ½ï¼š90%ä¿ç•™ï¼ˆåˆ é™¤ç•™è¨€åŠŸèƒ½ï¼‰
âœ… æ—¶é—´ç®¡ç†ï¼š80%ä¿ç•™ï¼ˆåˆå¹¶é‡å¤å­—æ®µï¼‰
âŒ æ¥æºè¿½è¸ªï¼šåˆ é™¤ï¼ˆå¯é€šè¿‡ä¸šåŠ¡é€»è¾‘å®ç°ï¼‰
âŒ æ‰©å±•åŠŸèƒ½ï¼šåˆ é™¤ï¼ˆYAGNIåŸåˆ™ï¼‰
```

### **ç»´æŠ¤æˆæœ¬**
```
æ•°æ®åº“ç´¢å¼•ï¼šä»8ä¸ªå‡å°‘åˆ°5ä¸ª
æ¨¡å‹æ–¹æ³•ï¼šä»15ä¸ªå‡å°‘åˆ°8ä¸ª  
ä¸šåŠ¡é€»è¾‘ï¼šä»å¤æ‚å˜ä¸ºç®€å•
æµ‹è¯•ç”¨ä¾‹ï¼šä»å…¨é¢å˜ä¸ºèšç„¦
```

---

## ğŸ› ï¸ **å®æ–½å»ºè®®**

### **1. æ¸è¿›å¼ç®€åŒ–**
```sql
-- ç¬¬ä¸€æ­¥ï¼šæ·»åŠ ç®€åŒ–å­—æ®µï¼ˆå¦‚æœéœ€è¦ï¼‰
-- ç¬¬äºŒæ­¥ï¼šè¿ç§»ç°æœ‰æ•°æ®  
-- ç¬¬ä¸‰æ­¥ï¼šåˆ é™¤å†—ä½™å­—æ®µ
-- ç¬¬å››æ­¥ï¼šæ›´æ–°ç›¸å…³ä»£ç 
```

### **2. ä¿ç•™ç°æœ‰æ•°æ®**
```sql
-- å¦‚æœå½“å‰è¡¨æœ‰é‡è¦æ•°æ®ï¼Œå…ˆå¤‡ä»½
CREATE TABLE user_inventory_backup AS SELECT * FROM user_inventory;

-- ç„¶åæ‰§è¡Œç»“æ„è°ƒæ•´
ALTER TABLE user_inventory DROP COLUMN source_type;
ALTER TABLE user_inventory DROP COLUMN source_id;
-- ... å…¶ä»–åˆ é™¤æ“ä½œ
```

### **3. ä»£ç é€‚é…**
- æ›´æ–°æ¨¡å‹å®šä¹‰
- ç®€åŒ–ä¸šåŠ¡é€»è¾‘
- ä¿®æ”¹ç›¸å…³æµ‹è¯•ç”¨ä¾‹

---

## ğŸ¯ **æ ¸å¿ƒä»·å€¼**

### **ä¸ºä»€ä¹ˆè¿™ä¸ªç®€åŒ–ç‰ˆæœ¬æ›´å®ç”¨ï¼Ÿ**

1. **ä¸“æ³¨æ ¸å¿ƒåŠŸèƒ½**ï¼šä¿ç•™æ‚¨éœ€è¦çš„å…¨éƒ¨åŠŸèƒ½
2. **é™ä½å¤æ‚åº¦**ï¼šåˆ é™¤28%çš„å†—ä½™å­—æ®µ
3. **æå‡æ€§èƒ½**ï¼šæ›´å°‘çš„å­—æ®µ = æ›´å¿«çš„æŸ¥è¯¢
4. **æ˜“äºç»´æŠ¤**ï¼šç®€å•çš„ç»“æ„ = æ›´å°‘çš„bug
5. **ç”¨æˆ·å‹å¥½**ï¼š8ä½æ ¸é”€ç æ¯”32ä½æ›´å¥½è®°

### **é€‚ç”¨åœºæ™¯**
- âœ… é¤å…ä¼˜æƒ åˆ¸ç®¡ç†
- âœ… ç§¯åˆ†å•†åŸå¥–å“
- âœ… ç”¨æˆ·é—´ç¤¼å“è½¬è®©
- âœ… å®ç‰©å¥–å“æ ¸é”€
- âœ… æœåŠ¡ç±»å¥–å“ç®¡ç†

---

## ğŸ **æ€»ç»“**

**è¿™ä¸æ˜¯åˆ é™¤åŠŸèƒ½ï¼Œè€Œæ˜¯è®©åŠŸèƒ½æ›´å®ç”¨ï¼**

- **ä¿ç•™100%æ ¸å¿ƒåŠŸèƒ½**ï¼šç‰©å“ç®¡ç†ã€æ ¸é”€ç ã€è½¬è®©
- **åˆ é™¤28%å†—ä½™è®¾è®¡**ï¼šæ¥æºè¿½è¸ªã€æ‰©å±•å­—æ®µã€é‡å¤æ—¶é—´
- **æå‡ç”¨æˆ·ä½“éªŒ**ï¼š8ä½æ ¸é”€ç ã€ç®€åŒ–è½¬è®©æµç¨‹
- **é™ä½ç»´æŠ¤æˆæœ¬**ï¼šæ›´å°‘å­—æ®µã€æ›´ç®€å•é€»è¾‘

**è¿™æ˜¯ä¸€ä¸ª"å®ç”¨ä¸»ä¹‰"çš„å®Œç¾ç¤ºä¾‹ï¼šæ—¢æ»¡è¶³ä¸šåŠ¡éœ€æ±‚ï¼Œåˆé¿å…è¿‡åº¦å·¥ç¨‹åŒ–ã€‚**

---

**æ–¹æ¡ˆå®Œæˆæ—¶é—´**ï¼š2025-09-19 23:45  
**å»ºè®®ç­‰çº§**ï¼šå¼ºçƒˆæ¨è  
**é¢„æœŸæ•ˆæœ**ï¼šåŠŸèƒ½å®Œæ•´ï¼Œå¤æ‚åº¦é™ä½28% 