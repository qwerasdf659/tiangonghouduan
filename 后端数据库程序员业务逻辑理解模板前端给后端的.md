# 🛠️ 餐厅积分抽奖系统 - 后端开发业务需求文档

## 基于前端实际代码的详细业务需求规格书 v3.1

**创建时间**: 2025年01月01日  
**更新时间**: 2025-07-29 07:48:46 UTC  
**版本**: v3.1 (详细规格版)  
**使用模型**: Claude Sonnet 4  
**目标用户**: 后端开发团队 + 数据库架构师  
**文档性质**: **详细业务需求文档**（包含前端期望的具体规格）  
**开发流程**: 后端设计API → 前端适配对接  
**前端分析基础**: lottery.js(6111行)、exchange.js(4053行)、merchant.js(4092行)、api.js(1837行)、app.js(2113行)

---

## 📋 **文档说明和使用指导**

### 🎯 **文档升级说明**

本文档基于对前端22,000+行实际代码的逐行深度分析，提供**具体而详细的业务需求规格**，包括：

- **每个按钮点击的具体业务逻辑**
- **前端期望的数据结构和API格式**（作为设计参考）
- **详细的界面交互、状态管理、错误处理要求**
- **具体的业务流程和边缘案例处理**

### ⚠️ **重要使用原则**

- **前端期望vs后端设计**：文档中的API格式是"前端期望"，后端可以设计更优方案，但需要确保业务逻辑完全匹配
- **业务逻辑为准**：业务流程和功能要求必须100%实现，技术实现方式可以优化
- **数据结构参考**：提供的数据格式是前端当前期望，后端可以设计更合理的结构
- **对接文档必需**：后端完成后必须提供详细的前后端对接修改指导

---

## 🎰 **抽奖系统详细业务需求**

### **🔴 单抽按钮业务逻辑（基于lottery.js第3500-3700行）**

#### **按钮触发条件检查**

```javascript
// 🎯 前端实际检查逻辑（onDrawSingle函数）
前端检查条件: {
  基础状态检查: "!this.data.isDrawing && this.data.wheelReady",
  积分检查: "this.data.totalPoints >= this.data.costPoints",
  次数检查: "this.data.todayDrawCount < this.data.dailyLimit",
  网络状态: "网络连接正常，Token有效"
}

// 🔧 检查失败时的前端处理
失败处理: {
  积分不足: "显示'积分不足，请先上传消费小票获取积分'提示",
  次数超限: "显示'今日抽奖次数已用完，明天再来吧'提示",
  网络异常: "显示'网络连接异常，请检查网络后重试'提示"
}
```

#### **抽奖API调用需求**

```javascript
// 🎯 前端期望的API调用格式（可作为设计参考）
API调用期望: {
  请求格式: {
    method: "POST",
    url: "/api/lottery/draw", // 后端可自定义路径
    headers: { "Authorization": "Bearer {token}" },
    body: {
      draw_type: "single",    // 抽奖类型标识
      draw_count: 1,          // 抽奖次数
      cost_points: 100,       // 消耗积分（前端已知）
      user_timestamp: 1722249322 // 客户端时间戳（防重复提交）
    }
  },

  // 🌟 前端期望的响应格式（后端可优化数据结构）
  成功响应期望: {
    code: 0,
    message: "抽奖成功",
    data: {
      // 🎯 核心：用于动画控制的中奖区域索引
      winning_index: 3,        // 0-7，对应8个转盘区域

      // 🏆 奖品信息
      prize: {
        prize_id: "prize-4",   // 奖品唯一标识
        name: "甜品1份",       // 奖品名称
        type: "实物",         // 奖品类型：实物/优惠券/积分
        description: "绿茶饼或馒头", // 奖品描述
        value: "15元",        // 奖品价值
        exchange_code: "TG20240729001", // 兑换码（实物奖品）
        expire_date: "2024-08-29"  // 有效期
      },

      // 🎯 用户状态更新
      user_status: {
        remaining_points: 1500,    // 剩余积分
        today_draw_count: 5,       // 今日抽奖次数
        total_draw_count: 156,     // 总抽奖次数
        consecutive_fail_count: 2, // 连续未中奖次数（保底机制）
      },

      // 🎮 前端动画控制
      animation_config: {
        highlight_duration: 3000,  // 发亮动画持续时间(ms)
        is_guarantee: false,       // 是否保底中奖（显示特殊动画）
        celebration_level: 2       // 庆祝等级：1-普通,2-中等,3-重大
      }
    }
  },

  // ❌ 错误响应格式
  错误响应处理: {
    积分不足: { code: 1001, message: "积分不足", data: { required: 100, current: 50 } },
    次数超限: { code: 1002, message: "今日抽奖次数已达上限", data: { limit: 10, used: 10 } },
    系统维护: { code: 1003, message: "系统维护中", data: { end_time: "2024-07-30 06:00" } }
  }
}
```

#### **前端状态管理和界面更新**

```javascript
// 🎯 基于前端实际代码的状态管理需求
状态管理需求: {
  调用前状态: {
    isDrawing: true,           // 标记抽奖中，禁用按钮
    isLotteryInProgress: true, // 抽奖流程进行中
    isButtonVisible: false     // 隐藏其他操作按钮
  },

  动画播放状态: {
    highlightAnimation: true,  // 启动区域发亮动画
    currentHighlight: -1,      // 当前高亮区域索引
    winningIndex: winning_index, // 最终中奖区域
    animationCompleted: false  // 动画是否完成
  },

  结果显示状态: {
    showResult: true,          // 显示结果弹窗
    resultData: prize_data,    // 奖品详细信息
    totalPoints: remaining_points, // 更新用户积分
    todayDrawCount: today_count    // 更新今日次数
  }
}
```

### **🔴 连抽按钮业务逻辑（三连抽/五连抽/十连抽）**

#### **连抽业务规格**

```javascript
// 🎯 基于前端实际实现的连抽逻辑
连抽业务规格: {
  三连抽: {
    draw_type: "triple",
    draw_count: 3,
    cost_points: 300,
    // 🌟 特殊需求：需要返回3个抽奖结果
    response_format: {
      data: {
        results: [
          { winning_index: 2, prize: {...} }, // 第1次结果
          { winning_index: 5, prize: {...} }, // 第2次结果
          { winning_index: 1, prize: {...} }  // 第3次结果
        ],
        user_status: { remaining_points: 1200, today_draw_count: 8 },
        summary: { total_prizes: 3, best_prize: "甜品1份" }
      }
    }
  },

  五连抽: { draw_type: "five", draw_count: 5, cost_points: 500 },

  十连抽: {
    draw_type: "ten",
    draw_count: 10,
    cost_points: 1000,
    // 🎯 保底机制：十连抽必须至少包含一个非"谢谢参与"奖品
    guarantee_rule: "至少1个八八折券或更高价值奖品"
  }
}

// 🎮 前端动画播放需求
连抽动画需求: {
  播放方式: "逐个播放发亮动画（每次间隔1秒）",
  最终显示: "汇总显示所有中奖结果，按价值排序",
  特殊效果: "如果中奖数量≥5，播放彩带动画"
}
```

### **🔴 抽奖配置获取需求（转盘绘制数据）**

#### **转盘绘制数据需求**

```javascript
// 🎯 基于前端Canvas绘制的数据需求
转盘配置API需求: {
  请求: {
    method: "GET",
    url: "/api/lottery/config",
    headers: { "Authorization": "Bearer {token}" }
  },

  // 🎨 前端Canvas绘制的数据期望
  响应数据需求: {
    code: 0,
    data: {
      // 🎯 系统配置
      system_config: {
        is_active: true,          // 抽奖系统是否启用
        cost_points: 100,         // 单次抽奖消耗积分
        daily_limit: 50,          // 每日抽奖次数限制
        maintenance_mode: false   // 是否维护模式
      },

      // 🎨 转盘绘制必需的8个奖品配置
      prizes: [
        {
          position: 0,            // 转盘位置(0-7)，必须有8个
          prize_id: "prize-1",    // 奖品唯一标识
          name: "八八折券",       // 显示在转盘上的文字
          probability: 15,        // 中奖概率(0-100)
          type: "优惠券",         // 奖品类型
          color: "#FF6B35",       // 区域颜色（可选，前端有默认）
          image: "prize1.jpg",    // 奖品图片URL（可选）
          description: "全场八八折优惠",
          value: "20元优惠"
        },
        // ... 必须包含8个奖品配置
      ],

      // 🔧 数据验证信息
      validation: {
        total_probability: 100,   // 所有概率总和必须为100
        last_updated: "2024-07-29T07:48:46Z",
        updated_by: "admin_456"
      }
    }
  }
}

// 🎨 前端Canvas绘制规格
Canvas绘制规格: {
  转盘尺寸: "260x260px",
  区域数量: "固定8个扇形区域，每个45度",
  颜色方案: "['#FF6B35', '#4CAF50', '#2196F3', '#9C27B0', '#FF9800', '#607D8B', '#795548', '#E91E63']",
  文字显示: "每个区域显示奖品名称，11px粗体白色文字",
  中心圆: "半径40px，显示'开始抽奖'文字",
  动画效果: "区域轮流发亮，3秒总时长，最终停在中奖区域"
}
```

### **🔴 保底机制业务逻辑**

#### **保底机制详细规格**

```javascript
// 🎯 基于前端处理的保底机制需求
保底机制规格: {
  触发条件: {
    连续次数: "连续10次未中九八折券以上奖品",
    计数规则: "只计算单抽，连抽按单次计算",
    重置条件: "获得九八折券或更高价值奖品时重置为0"
  },

  // 🗄️ 数据存储需求
  数据存储需求: {
    用户统计表字段: {
      consecutive_fail_count: "连续未中奖次数",
      last_draw_date: "最后抽奖日期（跨日重置今日次数）",
      guarantee_triggered_count: "历史保底触发次数"
    }
  },

  // 🎯 业务逻辑实现
  实现逻辑: {
    每次抽奖检查: "如果consecutive_fail_count >= 10，强制返回九八折券",
    概率覆盖: "保底触发时忽略正常概率配置",
    记录更新: "中奖后重置consecutive_fail_count=0",
    前端标识: "返回is_guarantee: true，前端显示特殊保底动画"
  }
}
```

---

## 🛍️ **商品兑换系统详细业务需求**

### **🔴 商品列表加载业务逻辑（基于exchange.js第800-1200行）**

#### **幸运空间商品加载详细规格**

```javascript
// 🎯 前端实际调用的商品加载逻辑
商品加载API规格: {
  请求格式: {
    method: "GET",
    url: "/api/exchange/products",
    headers: { "Authorization": "Bearer {token}" },
    params: {
      space: "lucky",           // 空间类型: lucky/premium
      page: 1,                  // 分页页码
      page_size: 20,           // 每页数量（瀑布流需要）
      category: "all",         // 商品分类筛选
      sort_by: "default",      // 排序方式
      min_points: 0,           // 积分范围筛选
      max_points: 999999,
      stock_filter: "all",     // 库存筛选: all/in-stock/low-stock
      search_keyword: ""       // 搜索关键词
    }
  },

  // 🎨 前端瀑布流布局的数据需求
  响应数据需求: {
    code: 0,
    message: "获取成功",
    data: {
      products: [
        {
          id: 1,                    // 商品唯一ID
          name: "美味券50元",       // 商品名称
          description: "全场通用优惠券", // 商品描述
          image: "product1.jpg",    // 商品图片URL
          exchange_points: 500,     // 兑换所需积分
          stock: 100,              // 库存数量
          category: "优惠券",       // 商品分类

          // 🏷️ 标签和状态
          is_hot: false,           // 是否热门商品
          is_new: true,            // 是否新品
          is_limited: false,       // 是否限量商品
          status: "active",        // 商品状态: active/offline

          // 📊 统计数据
          rating: 4.8,             // 评分（可选）
          sales: 156,              // 销量
          view_count: 1205,        // 浏览次数

          // 💰 价格信息
          discount: 15,            // 折扣百分比
          original_price: 50,      // 原价（显示用）

          // 🎨 前端布局需要的字段
          estimated_height: 200,   // 预估卡片高度（瀑布流布局）
          tags: ["新品", "热销"],  // 商品标签数组

          // 📋 详细信息
          seller: "官方旗舰店",     // 销售方
          warranty: "7天无理由退换", // 售后说明
          delivery_info: "当日达",   // 配送信息

          // ⏰ 时间信息
          created_at: "2024-07-29T00:00:00Z",
          updated_at: "2024-07-29T06:00:00Z",
          expires_at: null         // 过期时间（限时商品）
        }
        // ... 更多商品
      ],

      // 📄 分页信息
      pagination: {
        current_page: 1,         // 当前页码
        total_pages: 5,          // 总页数
        total_count: 89,         // 总商品数
        has_more: true,          // 是否有更多数据
        next_page: 2             // 下一页页码
      },

      // 📊 空间统计信息
      summary: {
        total_products: 89,      // 总商品数
        new_products: 8,         // 新品数量
        hot_products: 12,        // 热门商品数量
        avg_discount: 15,        // 平均折扣
        categories: ["优惠券", "实物商品", "虚拟物品"]
      }
    }
  }
}

// 🎨 前端瀑布流布局需求
瀑布流布局需求: {
  布局算法: "双列瀑布流，根据estimated_height计算位置",
  图片处理: "图片加载失败时显示默认图片default-product.png",
  状态标识: {
    库存状态: "stock<=5显示'库存紧张'，stock=0显示'缺货'",
    新品标识: "is_new=true显示'新品'角标",
    热门标识: "is_hot=true显示'热门'角标",
    折扣显示: "discount>0显示折扣百分比"
  },
  交互效果: "点击商品卡片 → 显示兑换确认弹窗"
}
```

### **🔴 臻选空间解锁业务逻辑**

#### **解锁状态检查和解锁操作**

```javascript
// 🎯 基于前端实际实现的臻选空间逻辑
臻选空间业务规格: {
  // 🔍 解锁状态检查API
  状态检查API: {
    请求: {
      method: "GET",
      url: "/api/exchange/premium-status",
      headers: { "Authorization": "Bearer {token}" }
    },
    响应: {
      code: 0,
      data: {
        // 📊 用户积分统计
        cumulative_points: 450000,    // 历史累计积分
        current_points: 2000,         // 当前积分余额

        // 🔓 解锁状态
        is_unlocked: false,           // 当前是否已解锁
        unlock_time: null,            // 解锁时间戳
        expiry_time: null,            // 过期时间戳
        remaining_hours: 0,           // 剩余有效小时数

        // 🎯 解锁条件
        can_unlock: false,            // 是否满足解锁条件
        required_cumulative: 500000,  // 需要的累计积分
        unlock_cost: 100,            // 单次解锁消耗积分
        unlock_duration: 24,          // 解锁有效时长（小时）

        // 📈 统计信息
        unlock_history_count: 3,      // 历史解锁次数
        last_unlock_time: "2024-07-28T10:00:00Z"
      }
    }
  },

  // 🔓 执行解锁操作API
  解锁操作API: {
    请求: {
      method: "POST",
      url: "/api/exchange/unlock-premium",
      headers: { "Authorization": "Bearer {token}" },
      body: {
        confirm: true,              // 确认解锁
        cost_points: 100,          // 消耗积分
        client_timestamp: 1722249322 // 客户端时间戳
      }
    },
    响应: {
      code: 0,
      data: {
        unlocked: true,
        unlock_time: 1722249322,    // Unix时间戳
        expiry_time: 1722335722,    // 24小时后过期
        remaining_points: 1900,     // 剩余积分
        access_token: "premium_access_token" // 臻选空间访问令牌（可选）
      }
    }
  }
}

// 🎨 前端界面交互需求
界面交互需求: {
  解锁界面设计: {
    显示信息: "累计积分进度条、解锁条件说明、消费积分提示",
    解锁按钮: "满足条件时高亮显示，不满足时灰色禁用",
    倒计时显示: "已解锁时显示剩余有效时间"
  },

  解锁后体验: {
    商品展示: "轮播商品（4秒切换）+ 卡片组商品 + 详细列表",
    特殊标识: "臻选空间商品显示'臻选'标签",
    过期提醒: "剩余1小时时显示过期提醒"
  }
}
```

### **🔴 商品兑换确认业务逻辑（基于exchange.js第2200-2400行）**

#### **兑换确认弹窗详细规格**

```javascript
// 🎯 基于前端实际实现的兑换流程
兑换确认业务规格: {
  // 🔍 触发条件检查
  触发条件检查: {
    前端检查: "库存>0 && 用户积分>=所需积分 && 商品状态为active",
    库存检查: "实时检查最新库存，防止并发兑换",
    权限检查: "臻选空间商品需要验证解锁状态"
  },

  // 🎨 确认弹窗内容
  弹窗内容需求: {
    商品信息: "名称、图片、积分价格、库存状态、商品描述",
    用户状态: "当前积分、兑换后剩余积分",
    数量选择: "支持批量兑换（数量选择器）",
    风险提示: "积分扣除不可逆、兑换码有效期、使用方法说明"
  },

  // 🔄 兑换执行API
  兑换执行API: {
    请求: {
      method: "POST",
      url: "/api/exchange/redeem",
      headers: { "Authorization": "Bearer {token}" },
      body: {
        product_id: 15,             // 商品ID
        quantity: 2,                // 兑换数量
        total_points: 1000,         // 总消耗积分
        space: "lucky",             // 所属空间
        confirm_timestamp: 1722249322, // 确认时间戳
        client_version: "2.0"       // 客户端版本
      }
    },

    // 🎉 成功响应格式
    成功响应: {
      code: 0,
      message: "兑换成功",
      data: {
        // 📋 兑换记录信息
        exchange_id: "ex_1722249322",     // 兑换记录ID
        exchange_code: "EX20240729001",   // 兑换码（用户凭证）
        exchanged_at: "2024-07-29T07:48:46Z",

        // 🛍️ 商品信息快照
        product: {
          id: 15,
          name: "美味券50元",
          quantity: 2,
          unit_points: 500,
          total_points: 1000,
          total_value: "100元"
        },

        // 👤 用户状态更新
        user_status: {
          remaining_points: 1500,       // 剩余积分
          total_exchanges: 8,           // 总兑换次数
          today_exchanges: 3            // 今日兑换次数
        },

        // 📋 使用说明
        usage_info: {
          valid_until: "2024-08-29T07:48:46Z", // 有效期
          usage_method: "请到店出示兑换码",      // 使用方法
          contact_info: "客服电话：400-123-4567", // 联系方式
          store_locations: ["门店1", "门店2"]    // 可用门店
        },

        // 📦 库存更新信息
        stock_info: {
          product_id: 15,
          old_stock: 50,
          new_stock: 48,
          low_stock_warning: false      // 是否触发低库存预警
        }
      }
    },

    // ❌ 错误响应处理
    错误响应: {
      库存不足: { code: 2001, message: "商品库存不足", data: { available: 1, requested: 2 } },
      积分不足: { code: 2002, message: "积分余额不足", data: { required: 1000, current: 800 } },
      商品下架: { code: 2003, message: "商品已下架", data: { product_id: 15 } },
      权限不足: { code: 2004, message: "需要解锁臻选空间", data: { space: "premium" } }
    }
  }
}

// 🎨 前端状态管理和界面更新
前端处理需求: {
  状态更新: "setData({ totalPoints: remainingPoints, totalExchanges: total_exchanges })",
  结果展示: "显示兑换成功弹窗，包含兑换码和使用说明",
  库存同步: "等待WebSocket推送stock_updated事件，更新商品库存显示",
  记录刷新: "兑换记录页面数据自动刷新",
  用户体验: "成功后震动反馈 + 音效提示"
}
```

### **🔴 实时库存更新机制**

#### **WebSocket库存推送规格**

```javascript
// 🎯 基于前端WebSocket处理的库存更新需求
库存推送规格: {
  // 📡 WebSocket推送格式
  推送消息格式: {
    type: "stock_updated",
    data: {
      product_id: 15,              // 商品ID
      old_stock: 50,               // 原库存数量
      new_stock: 48,               // 新库存数量
      change_amount: -2,           // 变动数量（负数为减少）
      change_reason: "用户兑换",    // 变动原因
      changed_by: "user_123",      // 操作者ID
      timestamp: "2024-07-29T07:48:46Z",
      space: "lucky"               // 商品所属空间
    }
  },

  // 📊 推送策略
  推送策略: {
    目标用户: "广播给所有在线用户（兑换页面）",
    推送时机: "库存变动后立即推送",
    频率控制: "相同商品1秒内最多推送1次",
    批量处理: "管理员批量操作时合并推送"
  },

  // 🎨 前端处理逻辑
  前端处理: {
    库存更新: "更新products数组中对应商品的stock字段",
    状态判断: "重新计算库存状态（正常/低库存/缺货）",
    界面更新: "自动更新所有显示该商品的区域",
    用户提示: "库存紧张时显示Toast提示",
    按钮控制: "缺货商品禁用兑换按钮，显示灰色"
  }
}
```

---

## 🔐 **管理员系统详细业务需求**

### **🔴 照片审核业务逻辑（基于merchant.js第1000-1200行）**

#### **待审核列表加载详细规格**

```javascript
// 🎯 基于前端实际实现的审核管理逻辑
审核列表API规格: {
  请求格式: {
    method: "GET",
    url: "/api/merchant/pending-reviews",
    headers: { "Authorization": "Bearer {admin_token}" },
    params: {
      page: 1,
      page_size: 20,
      period: "week",              // 时间范围：today/week/month/all
      status: "pending",           // 审核状态：pending/approved/rejected/all
      sort_by: "upload_time_desc", // 排序：upload_time_desc/amount_desc
      keyword: "",                 // 搜索关键词（用户昵称/手机号）
      priority: "all"              // 优先级：normal/urgent/all
    }
  },

  // �� 审核列表数据需求
  响应数据需求: {
    code: 0,
    message: "获取成功",
    data: {
      reviews: [
        {
          // 📋 基础信息
          upload_id: "up_1722249322",        // 上传记录唯一ID
          user_id: 123,                      // 用户ID

          // 👤 用户信息
          user_info: {
            nickname: "张三",               // 用户昵称
            phone: "138****8000",           // 脱敏手机号
            avatar: "avatar123.jpg",        // 用户头像URL
            vip_level: 1,                   // VIP等级
            total_uploads: 15               // 历史上传次数
          },

          // 📸 照片信息
          photo_url: "photos/receipt_123.jpg", // 照片URL
          photo_size: 2048576,               // 照片大小（字节）
          upload_time: "2024-07-29T06:30:00Z", // 上传时间

          // 📊 审核信息
          status: "pending",                 // 审核状态
          priority: "normal",                // 优先级
          estimated_amount: 0,               // AI预估金额（可选）
          review_notes: "",                  // 审核备注

          // ⏰ 时间信息
          created_at: "2024-07-29T06:30:00Z",
          waiting_hours: 2.5                 // 等待时长（小时）
        }
        // ... 更多待审核项
      ],

      // 📄 分页信息
      pagination: {
        current_page: 1,
        total_pages: 3,
        total_count: 45,
        has_more: true
      },

      // 📊 统计信息
      statistics: {
        pending_count: 45,           // 待审核数量
        today_approved: 12,          // 今日通过数量
        today_rejected: 3,           // 今日拒绝数量
        total_processed: 156,        // 总处理数量
        avg_process_time: 1.2,       // 平均处理时长（小时）
        approval_rate: 85.5          // 通过率（百分比）
      }
    }
  }
}

// 🎨 前端列表展示需求
列表展示需求: {
  排列方式: "按上传时间倒序显示，支持分页加载",
  图片预览: "点击照片可放大查看，支持手势缩放",
  用户信息: "显示脱敏手机号和上传次数统计",
  状态标识: "不同状态用不同颜色标识",
  批量操作: "支持多选进行批量审核操作",
  筛选功能: "按时间范围、状态、优先级筛选"
}
```

#### **单个审核操作详细规格**

```javascript
// 🎯 基于前端实际审核操作的API需求
审核操作API规格: {
  // 📋 审核弹窗交互需求
  审核界面需求: {
    弹窗内容: {
      照片显示: "高清显示用户上传的小票照片，支持缩放",
      用户信息: "用户昵称、手机号、上传时间、历史审核记录",
      金额输入: "reviewAmount数字输入框，支持小数点",
      操作按钮: "[通过] [拒绝] 按钮，明显的颜色区分",
      备注输入: "reviewReason多行文本框，审核备注"
    },
    输入验证: {
      金额验证: "必须>0，最大999999，保留2位小数",
      备注验证: "拒绝时必须填写拒绝原因"
    }
  },

  // ✅ 审核通过API
  审核通过API: {
    请求: {
      method: "POST",
      url: "/api/merchant/review-photo",
      headers: { "Authorization": "Bearer {admin_token}" },
      body: {
        upload_id: "up_1722249322",        // 上传记录ID
        action: "approve",                 // 审核动作：approve/reject
        amount: 88.5,                      // 管理员确认的消费金额
        points: 885,                       // 计算的积分奖励(amount * 10)
        reason: "审核通过，消费金额88.5元", // 审核备注
        reviewer_id: "admin_456",          // 审核员ID（从JWT获取）
        review_time: "2024-07-29T07:48:46Z",
        client_info: "web_admin_v2.0"     // 客户端信息
      }
    },

    // 🎉 审核通过响应
    成功响应: {
      code: 0,
      message: "审核完成",
      data: {
        // 📋 审核记录信息
        review_id: "rev_1722249322",       // 审核记录ID
        upload_id: "up_1722249322",        // 上传记录ID
        status: "approved",                // 新状态

        // 💰 积分发放信息
        points_awarded: 885,               // 实际发放积分
        user_old_balance: 1500,           // 用户原积分
        user_new_balance: 2385,           // 用户新积分余额

        // ⏰ 处理信息
        processed_at: "2024-07-29T07:48:46Z",
        process_duration: 0.5,             // 处理耗时（小时）

        // 📊 统计更新
        reviewer_stats: {
          today_processed: 15,             // 审核员今日处理数量
          total_processed: 342             // 审核员总处理数量
        }
      }
    }
  },

  // ❌ 审核拒绝API
  审核拒绝API: {
    请求数据差异: {
      action: "reject",
      reason: "照片模糊无法识别消费金额",  // 拒绝原因必填
      points: 0,                         // 拒绝时不发放积分
      amount: 0                          // 拒绝时金额为0
    }
  }
}

// 📡 WebSocket通知需求
审核结果推送: {
  推送给用户: {
    type: "review_result",
    data: {
      upload_id: "up_1722249322",
      result: "approved",                // approved/rejected
      amount: 88.5,                      // 确认的消费金额
      points_awarded: 885,               // 发放积分
      reason: "审核通过，消费金额88.5元",
      reviewer: "管理员***",             // 脱敏审核员信息
      reviewed_at: "2024-07-29T07:48:46Z"
    }
  },

  积分变动推送: {
    type: "points_update",
    data: {
      user_id: 123,
      old_balance: 1500,
      new_balance: 2385,
      change_amount: 885,
      change_reason: "照片审核通过",
      related_id: "up_1722249322"
    }
  }
}
```

#### **批量审核业务规格**

```javascript
// 🎯 基于前端批量操作的API需求
批量审核规格: {
  // 🔄 批量操作UI交互
  批量操作UI: {
    选择机制: "多选复选框，selectedItems数组管理",
    批量按钮: "[批量通过] [批量拒绝] 按钮",
    确认对话框: "显示选中数量、预计发放积分总数",
    进度显示: "批量处理时显示进度条"
  },

  // 📋 批量审核API
  批量审核API: {
    请求: {
      method: "POST",
      url: "/api/merchant/batch-review",
      headers: { "Authorization": "Bearer {admin_token}" },
      body: {
        reviews: [
          {
            upload_id: "up_1722249322",
            action: "approve",
            amount: 88.5,
            points: 885,
            reason: "批量审核通过"
          },
          {
            upload_id: "up_1722249323",
            action: "approve",
            amount: 156.0,
            points: 1560,
            reason: "批量审核通过"
          }
          // ... 更多审核项
        ],
        batch_id: "batch_1722249322",        // 批次ID
        reviewer_id: "admin_456",            // 审核员ID
        review_time: "2024-07-29T07:48:46Z",
        batch_reason: "周末批量处理"        // 批次备注
      }
    },

    // 🎉 批量处理响应
    响应格式: {
      code: 0,
      message: "批量审核完成",
      data: {
        batch_id: "batch_1722249322",
        processed_count: 5,              // 成功处理数量
        failed_count: 0,                 // 失败数量
        total_points_awarded: 4230,      // 总发放积分
        processing_time: 2.5,            // 处理耗时（秒）

        // 📊 详细结果
        results: [
          {
            upload_id: "up_1722249322",
            status: "success",           // success/failed
            points_awarded: 885,
            user_new_balance: 2385,
            error_message: null
          }
          // ... 每个审核项的结果
        ],

        // 📈 统计更新
        statistics_update: {
          today_approved: 17,            // 今日新增通过数
          total_processed: 161           // 总处理数量更新
        }
      }
    }
  },

  // 🔒 事务处理要求
  事务要求: {
    原子性: "批量操作必须在数据库事务中完成",
    失败处理: "部分失败时记录详细错误信息，成功的继续生效",
    积分发放: "所有用户积分变动必须准确记录",
    推送通知: "批量完成后统一推送给相关用户"
  }
}
```

---

## 🔄 **WebSocket实时通信详细需求**

### **🔴 连接管理和心跳机制（基于app.js第1300-1500行）**

#### **WebSocket连接建立详细规格**

```javascript
// 🎯 基于前端实际WebSocket实现的连接需求
WebSocket连接规格: {
  // 🔗 连接建立
  连接参数: {
    URL: "wss://domain.com/ws",           // WebSocket服务地址
    认证方式: "?token=${encodeURIComponent(accessToken)}", // URL参数认证
    协议: "websocket",
    连接超时: 10000,                     // 10秒连接超时
    重连间隔: [2000, 4000, 8000]        // 指数退避重连
  },

  // 🔐 服务端认证需求
  服务端认证: {
    Token验证: "验证JWT Token有效性和过期时间",
    用户识别: "从Token中提取user_id、权限等级、昵称等信息",
    连接存储: "存储用户连接映射关系到内存/Redis",
    权限检查: "验证用户WebSocket连接权限",
    连接限制: "单用户最多3个并发连接"
  },

  // 📡 连接事件处理
  连接事件: {
    onOpen: {
      前端发送: "认证验证消息 + 客户端信息",
      服务端返回: "连接确认 + 用户信息 + 待推送消息数量"
    },
    onMessage: "根据消息类型分发到对应业务处理器",
    onError: "记录错误日志，触发重连机制",
    onClose: "清理连接资源，根据关闭码决定重连策略"
  }
}

// 💓 心跳机制详细规格
心跳机制规格: {
  // ⏰ 心跳配置
  心跳配置: {
    发送频率: 90000,                    // 每90秒发送一次心跳
    响应超时: 3000,                     // 3秒响应超时
    最大失败次数: 3,                    // 连续3次失败后断开重连
    心跳消息格式: {
      type: "heartbeat",
      data: {
        timestamp: 1722249322,          // Unix时间戳
        user_id: 123,                   // 用户ID
        client_info: "miniprogram_v2.0", // 客户端信息
        page_active: true               // 页面是否处于活跃状态
      }
    }
  },

  // 📡 服务端响应需求
  服务端响应: {
    响应格式: {
      type: "heartbeat_response",
      data: {
        server_time: 1722249322,        // 服务器时间
        connection_status: "active",    // 连接状态
        message_queue_count: 0,         // 待推送消息数量
        server_load: "normal"           // 服务器负载状态
      }
    },
    响应时间要求: "3秒内必须响应",
    异常处理: "超时或错误时客户端自动重连"
  }
}
```

### **🔴 消息推送业务需求（基于app.js第1400-1600行）**

#### **积分变动推送详细规格**

```javascript
// 🎯 基于前端消息处理的推送需求
积分推送规格: {
  // 📊 触发场景
  触发场景: {
    抽奖扣除: "用户抽奖成功后推送积分扣减",
    审核通过: "管理员审核通过后推送积分奖励",
    兑换扣除: "用户兑换商品后推送积分扣减",
    管理员调整: "管理员手动调整用户积分",
    系统奖励: "签到、任务完成等系统奖励"
  },

  // 📡 推送消息格式
  推送消息格式: {
    type: "points_update",
    data: {
      user_id: 123,                    // 目标用户ID
      old_balance: 2000,               // 原积分余额
      new_balance: 1500,               // 新积分余额
      change_amount: -500,             // 变动数量（负数为扣除）
      change_reason: "商品兑换",        // 变动原因
      related_id: "ex_1722249322",     // 关联记录ID
      timestamp: "2024-07-29T07:48:46Z",

      // 📋 详细信息
      operation_type: "exchange",      // 操作类型
      operator_id: null,               // 操作员ID（系统操作为null）
      description: "兑换美味券50元",   // 详细描述

      // 🎯 前端显示控制
      show_toast: true,                // 是否显示Toast提示
      toast_message: "积分-500",       // Toast显示内容
      play_sound: false                // 是否播放音效
    }
  },

  // 🎨 前端处理需求
  前端处理: {
    状态更新: "更新globalData.userInfo.total_points",
    界面刷新: "所有显示积分的页面自动更新数值",
    用户提示: "根据show_toast控制是否显示变动提示",
    数据同步: "积分记录页面数据自动刷新",
    动画效果: "积分变动时播放数字跳动动画"
  }
}
```

#### **其他关键消息推送规格**

```javascript
// 🎯 审核结果推送
审核结果推送: {
  type: "review_result",
  data: {
    upload_id: "up_1722249322",
    user_id: 123,
    result: "approved",              // approved/rejected
    amount: 88.5,                    // 消费金额
    points_awarded: 885,             // 发放积分
    reason: "审核通过，消费金额88.5元",
    reviewer: "管理员***",           // 脱敏审核员
    reviewed_at: "2024-07-29T07:48:46Z",

    // 🎨 前端交互
    show_modal: true,                // 显示审核结果弹窗
    modal_title: "审核结果通知",
    auto_dismiss: 10                 // 10秒后自动关闭
  }
}

// 📦 库存变动推送（已在前面详细描述）
库存更新推送: {
  type: "stock_updated",
  data: {
    product_id: 15,
    old_stock: 50,
    new_stock: 48,
    change_amount: -2,
    change_reason: "用户兑换",
    changed_by: "user_123",
    timestamp: "2024-07-29T07:48:46Z",
    space: "lucky",                  // 所属空间

    // 📊 库存状态
    stock_status: "normal",          // normal/low/out
    low_stock_threshold: 5,          // 低库存阈值
    restock_alert: false             // 是否触发补货提醒
  }
}

// ⚙️ 系统配置更新推送
系统配置推送: {
  type: "config_updated",
  data: {
    config_type: "lottery",          // lottery/exchange/system
    updated_fields: ["prizes", "cost_points"],
    update_reason: "管理员修改抽奖概率",
    updated_by: "admin_456",
    timestamp: "2024-07-29T07:48:46Z",

    // 🔄 前端处理指令
    refresh_config: true,            // 需要重新加载配置
    refresh_pages: ["lottery", "merchant"], // 需要刷新的页面
    show_notification: "抽奖配置已更新" // 显示通知消息
  }
}
```

---

## 📊 **数据架构和存储需求**

### **🗄️ 核心数据实体设计需求**

#### **用户相关数据需求**

```javascript
// 🎯 基于前端实际使用的用户数据需求
用户数据需求: {
  // 👤 用户基础信息表
  用户表: {
    基础字段: {
      user_id: "用户唯一ID",
      phone: "手机号（登录凭证）",
      nickname: "用户昵称",
      avatar: "头像URL",
      is_admin: "是否管理员（boolean）",
      status: "账户状态：active/inactive/banned"
    },

    业务字段: {
      total_points: "当前积分余额",
      cumulative_points: "历史累计积分（解锁臻选空间用）",
      vip_level: "VIP等级",
      register_time: "注册时间",
      last_login: "最后登录时间"
    }
  },

  // 💰 用户积分账户表
  积分账户表: {
    核心字段: {
      user_id: "用户ID",
      current_balance: "当前积分余额",
      total_earned: "总获得积分",
      total_consumed: "总消费积分",
      today_earned: "今日获得积分",
      today_consumed: "今日消费积分"
    },

    统计字段: {
      total_draws: "总抽奖次数",
      total_exchanges: "总兑换次数",
      total_uploads: "总上传次数",
      last_activity: "最后活动时间"
    }
  }
}
```

#### **业务交易数据需求**

```javascript
// 🎯 抽奖相关数据表
抽奖数据需求: {
  // 🎰 抽奖配置表
  抽奖配置表: {
    prize_id: "奖品ID（prize-1到prize-8）",
    prize_name: "奖品名称",
    probability: "中奖概率（0-100）",
    prize_type: "奖品类型：实物/优惠券/积分",
    prize_image: "奖品图片URL",
    prize_value: "奖品价值描述",
    position: "转盘位置（0-7）",
    is_active: "是否启用",
    exchange_method: "兑换方式",
    description: "奖品描述"
  },

  // 📋 抽奖记录表
  抽奖记录表: {
    record_id: "抽奖记录唯一ID",
    user_id: "用户ID",
    draw_type: "抽奖类型：single/triple/five/ten",
    draw_count: "抽奖次数",
    cost_points: "消耗总积分",
    results: "抽奖结果JSON（支持连抽）",
    winning_indexes: "中奖区域索引数组",
    prize_ids: "中奖奖品ID数组",
    is_guarantee: "是否保底中奖",
    draw_time: "抽奖时间",
    client_info: "客户端信息"
  },

  // 📊 用户抽奖统计表
  用户抽奖统计表: {
    user_id: "用户ID",
    consecutive_fail_count: "连续未中奖次数（保底机制）",
    total_draw_count: "总抽奖次数",
    today_draw_count: "今日抽奖次数",
    last_draw_date: "最后抽奖日期",
    guarantee_triggered_count: "保底触发次数",
    best_prize: "最佳奖品记录",
    draw_streak: "连续抽奖天数"
  }
}

// 🛍️ 兑换相关数据表
兑换数据需求: {
  // 🛒 商品表
  商品表: {
    基础信息: {
      product_id: "商品唯一ID",
      name: "商品名称",
      description: "商品描述",
      image: "商品图片URL",
      category: "商品分类",
      space: "所属空间：lucky/premium/both"
    },

    价格库存: {
      exchange_points: "兑换所需积分",
      stock: "库存数量",
      original_price: "原价（显示用）",
      discount: "折扣百分比",
      low_stock_threshold: "低库存预警阈值"
    },

    状态标识: {
      status: "商品状态：active/offline/deleted",
      is_hot: "是否热门商品",
      is_new: "是否新品",
      is_limited: "是否限量商品",
      sort_order: "排序权重"
    },

    业务信息: {
      sales: "销量统计",
      view_count: "浏览次数",
      rating: "评分",
      warranty: "售后说明",
      delivery_info: "配送信息",
      expires_at: "过期时间（限时商品）"
    }
  },

  // 📋 兑换记录表
  兑换记录表: {
    exchange_id: "兑换记录唯一ID",
    user_id: "用户ID",
    product_id: "商品ID",
    product_snapshot: "商品信息快照JSON",
    quantity: "兑换数量",
    total_points: "总消耗积分",
    exchange_code: "兑换码",
    status: "状态：pending/completed/used/expired",
    space: "兑换空间：lucky/premium",
    exchange_time: "兑换时间",
    expires_at: "兑换码过期时间",
    used_at: "使用时间",
    client_info: "客户端信息"
  }
}
```

#### **审核业务数据需求**

```javascript
// 📸 审核相关数据表
审核数据需求: {
  // 📋 照片上传记录表
  照片上传表: {
    upload_id: "上传记录唯一ID",
    user_id: "用户ID",
    photo_url: "照片存储URL",
    file_size: "文件大小",
    upload_time: "上传时间",
    client_info: "客户端信息",
    ip_address: "上传IP地址"
  },

  // 🔍 审核记录表
  审核记录表: {
    review_id: "审核记录唯一ID",
    upload_id: "上传记录ID",
    reviewer_id: "审核员ID",
    action: "审核动作：approve/reject",
    amount: "确认的消费金额",
    points_awarded: "发放的积分",
    review_reason: "审核备注",
    review_time: "审核时间",
    process_duration: "处理耗时（秒）",
    batch_id: "批次ID（批量操作）"
  },

  // 📊 审核统计表
  审核统计表: {
    reviewer_id: "审核员ID",
    date: "统计日期",
    total_processed: "总处理数量",
    approved_count: "通过数量",
    rejected_count: "拒绝数量",
    avg_process_time: "平均处理时长",
    points_awarded_total: "总发放积分"
  }
}
```

### **🔄 实时通信数据需求**

```javascript
// 📡 WebSocket相关数据表
实时通信数据需求: {
  // 🔗 WebSocket连接表
  连接管理表: {
    connection_id: "连接唯一ID",
    user_id: "用户ID",
    socket_id: "Socket连接ID",
    client_info: "客户端信息",
    connected_at: "连接时间",
    last_heartbeat: "最后心跳时间",
    status: "连接状态：connected/disconnected",
    ip_address: "客户端IP"
  },

  // 📬 消息推送队列表
  消息队列表: {
    message_id: "消息唯一ID",
    user_id: "目标用户ID（NULL为广播）",
    message_type: "消息类型",
    message_data: "消息内容JSON",
    priority: "优先级：1-5",
    status: "状态：pending/sent/failed",
    retry_count: "重试次数",
    created_at: "创建时间",
    sent_at: "发送时间",
    expires_at: "过期时间"
  }
}
```

---

## 🚀 **后端开发交付要求**

### **📋 开发任务清单（基于前端功能分析）**

#### **🔴 P0级任务（核心功能，系统无法运行）**

```javascript
P0级开发任务: {
  // 🎰 抽奖核心系统
  抽奖系统: {
    "POST /lottery/draw": "抽奖执行API，支持单抽和连抽",
    "GET /lottery/config": "获取转盘配置和奖品信息",
    "保底机制实现": "连续10次未中奖触发保底",
    "概率算法": "准确的概率计算和随机生成",
    "积分事务": "抽奖扣积分的原子事务操作"
  },

  // 🛍️ 兑换核心系统
  兑换系统: {
    "GET /exchange/products": "商品列表API，支持双空间",
    "POST /exchange/redeem": "商品兑换API，库存扣减",
    "GET /exchange/premium-status": "臻选空间解锁状态",
    "POST /exchange/unlock-premium": "臻选空间解锁操作",
    "库存并发控制": "防止超卖的原子操作"
  },

  // 🔐 管理员系统
  管理员系统: {
    "GET /merchant/pending-reviews": "待审核列表API",
    "POST /merchant/review-photo": "单个审核API",
    "POST /merchant/batch-review": "批量审核API",
    "积分发放事务": "审核通过后积分发放的原子操作"
  },

  // 👤 用户认证系统
  认证系统: {
    "POST /auth/login": "手机号登录API",
    "POST /auth/refresh": "Token刷新API",
    "JWT Token管理": "Token生成、验证、刷新机制",
    "权限控制": "用户和管理员权限验证"
  }
}
```

#### **🟠 P1级任务（重要功能，3天内完成）**

```javascript
P1级开发任务: {
  // 📡 实时通信系统
  WebSocket系统: {
    "WebSocket服务": "支持Token认证的WebSocket服务",
    "消息推送": "points_update/review_result/stock_updated推送",
    "心跳机制": "90秒心跳，连接管理",
    "推送队列": "消息队列和重试机制"
  },

  // 📊 数据统计系统
  统计系统: {
    "GET /merchant/statistics": "管理员统计数据API",
    "GET /user/statistics": "用户个人统计API",
    "数据报表": "抽奖、兑换、审核数据统计"
  },

  // 📸 文件上传系统
  上传系统: {
    "POST /photo/upload": "照片上传API",
    "文件存储": "对接Sealos对象存储",
    "文件管理": "上传记录、文件清理"
  }
}
```

#### **🟡 P2级任务（增强功能，1周内完成）**

```javascript
P2级开发任务: {
  // 🔧 高级功能
  高级功能: {
    "高级筛选": "商品筛选、搜索功能",
    "数据导出": "Excel导出功能",
    "批量操作": "商品批量管理",
    "系统配置": "系统参数配置管理"
  },

  // ⚡ 性能优化
  性能优化: {
    "缓存机制": "Redis缓存热点数据",
    "数据库优化": "索引优化、查询优化",
    "并发控制": "高并发场景优化",
    "API限流": "接口访问频率限制"
  }
}
```

### **📄 交付文档要求**

#### **📚 必须提供的文档**

```javascript
交付文档要求: {
  // 📋 API接口文档
  API文档: {
    格式: "Swagger/OpenAPI 3.0规范",
    内容: "所有接口的请求/响应格式、参数说明、错误码",
    示例: "每个接口提供完整的请求响应示例",
    认证: "JWT Token使用说明和权限要求"
  },

  // 🗄️ 数据库设计文档
  数据库文档: {
    ER图: "完整的数据库关系图",
    表结构: "所有表的字段说明、类型、索引",
    业务逻辑: "关键业务逻辑的SQL实现说明",
    数据字典: "字段含义和取值范围说明"
  },

  // 🔧 前后端对接文档
  对接文档: {
    接口映射: "前端现有API调用与新接口的映射关系",
    数据格式转换: "前端期望格式与实际接口格式的转换说明",
    代码修改指导: "前端需要修改的具体代码位置和修改方案",
    测试用例: "接口测试用例和测试数据"
  },

  // 🚀 部署运维文档
  部署文档: {
    环境要求: "服务器配置、软件版本要求",
    部署步骤: "详细的部署安装步骤",
    配置说明: "环境变量、配置文件说明",
    监控指标: "关键监控指标和告警设置"
  }
}
```

### **🔧 技术架构建议**

#### **推荐技术栈和架构设计**

```javascript
技术架构建议: {
  // 🏗️ 后端架构
  后端技术栈: {
    框架选择: "Node.js + Express / Java Spring Boot / Python Django",
    数据库: "MySQL 8.0+ 主库 + Redis 缓存",
    消息队列: "Redis / RabbitMQ（WebSocket推送）",
    对象存储: "继续使用Sealos或迁移到其他云存储",
    认证授权: "JWT Token + 角色权限控制"
  },

  // 📊 数据库设计
  数据库架构: {
    主数据库: "MySQL，存储业务数据",
    缓存层: "Redis，缓存热点数据和Session",
    索引策略: "为高频查询字段建立合适索引",
    分表策略: "大表（如记录表）考虑按时间分表",
    备份策略: "定期备份和主从复制"
  },

  // 🔄 实时通信
  WebSocket架构: {
    服务设计: "独立的WebSocket服务或集成到主服务",
    连接管理: "内存存储连接信息，支持集群",
    消息队列: "可靠的消息推送队列机制",
    负载均衡: "支持多实例部署和负载均衡"
  },

  // 🔒 安全考虑
  安全措施: {
    认证安全: "JWT Token + 刷新Token机制",
    数据安全: "敏感数据加密存储",
    接口安全: "防XSS、SQL注入、CSRF攻击",
    访问控制: "API限流、权限验证",
    日志审计: "操作日志记录和审计"
  }
}
```

---

## 📝 **总结**

### ✅ **本文档提供内容**

- **🔍 基于22,000+行前端代码的逐行分析**：每个按钮、每个功能的具体业务需求
- **📋 详细的API期望格式**：前端期望的请求响应格式（作为设计参考）
- **🎨 完整的界面交互需求**：状态管理、错误处理、用户体验要求
- **🗄️ 具体的数据结构需求**：基于前端实际使用的数据字段需求
- **📊 明确的开发任务清单**：P0/P1/P2优先级和具体交付要求

### 🎯 **后端团队开发指导**

1. **业务逻辑100%匹配**：确保所有业务功能与前端期望完全一致
2. **API格式可以优化**：可以设计更合理的接口格式，但需提供对接文档
3. **数据结构可以调整**：可以优化数据库设计，但需确保数据完整性
4. **技术栈自主选择**：可以选择最适合的技术方案
5. **性能和安全优先**：在满足业务需求的基础上优化性能和安全性

### 📋 **前端团队配合事项**

1. **需求确认**：与后端团队确认业务需求理解是否准确
2. **接口协商**：参与API格式的讨论，确保前端适配的可行性
3. **联调准备**：准备前端代码修改，配合后端接口联调
4. **测试配合**：提供完整的测试场景和边缘案例

**🚀 请后端开发团队基于本详细业务需求文档，设计最优的技术架构，开发完成后提供完整的前后端对接文档！**
