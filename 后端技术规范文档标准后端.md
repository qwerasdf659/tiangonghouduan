# 🏗️ 后端技术规范文档标准 - 餐厅积分抽奖系统v2.0

> **多业务线分层存储架构技术规范** - 基于Sealos云原生平台的企业级后端解决方案

## 📋 文档基本信息

### 文档定位

- **适用项目**：餐厅积分抽奖系统v2.0
- **架构版本**：多业务线分层存储架构 v2.0
- **技术栈**：Node.js + Express + MySQL + Sequelize + Sealos对象存储
- **更新时间**：2025年07月29日 23:52:11 UTC
- **使用模型**：Claude Sonnet 4
- **基于代码**：实际运行的v2.0完整业务架构代码实现（10个模型+9个业务服务）

### 🔴 核心架构特性v2.0（2025年07月29日完整实现）

- **完整业务服务层**：LotteryService、ExchangeService、TradeService、AdminReviewService、PointsService、WebSocketService
- **多业务线支持**：lottery（抽奖）、exchange（兑换）、trade（交易）、uploads（用户上传）、admin（管理员）
- **智能分层存储**：hot（热存储）、standard（标准存储）、archive（归档存储）
- **统一资源管理**：基于ImageResources统一模型的图片资源管理
- **实时通信支持**：WebSocket服务，支持积分变动、审核结果、库存更新等实时推送
- **云原生架构**：原生支持Sealos云平台部署和对象存储
- **自动化缓存**：路径生成缓存、业务配置缓存、用户分片缓存

## 🏛️ 整体架构设计

### 架构层次划分

```
┌─────────────────────────────────────────────────────────────┐
│                     API网关层 (Express)                      │
│  ┌─────────────────┬─────────────────┬─────────────────┐     │
│  │   认证中间件     │   字段转换中间件   │   错误处理中间件  │     │
│  └─────────────────┴─────────────────┴─────────────────┘     │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                     业务路由层 (v2 API)                      │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
│  │   lottery   │  exchange   │    trade    │   uploads   │   │
│  │   抽奖业务   │   兑换业务   │   交易业务   │  用户上传    │   │
│  └─────────────┴─────────────┴─────────────┴─────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              resources 统一资源管理API                   │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                  核心业务服务层 (Business Services)           │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
│  │LotteryServ  │ExchangeServ │ TradeServ   │AdminReview  │   │
│  │  抽奖服务    │  兑换服务    │  交易服务    │  审核服务    │   │
│  └─────────────┴─────────────┴─────────────┴─────────────┘   │
│  ┌─────────────┬─────────────────────────────────────────┐   │
│  │ PointsServ  │          WebSocketService              │   │
│  │  积分服务    │           实时通信服务                   │   │
│  └─────────────┴─────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                     存储服务层 (Storage Services)            │
│  ┌─────────────────┬─────────────────┬─────────────────────┐ │
│  │ImageResourceServ│MultiBusinessPhot│  SealosStorageServ │ │
│  │  图片资源服务    │   多业务存储服务  │    Sealos存储服务   │ │
│  └─────────────────┴─────────────────┴─────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                     数据层 (Models)                          │
│  ┌─────────────────┬─────────────────┬─────────────────────┐ │
│  │ ImageResources  │ BusinessConfigs │      Future         │ │
│  │  统一资源模型    │   业务配置模型   │     扩展模型        │ │
│  └─────────────────┴─────────────────┴─────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                  存储层 (Storage Layer)                      │
│  ┌─────────────────┬─────────────────┬─────────────────────┐ │
│  │   MySQL数据库    │  Sealos对象存储  │    缓存系统         │ │
│  │   元数据存储     │   文件存储       │   内存缓存          │ │
│  └─────────────────┴─────────────────┴─────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 核心设计理念v2.0

#### 1. 业务领域驱动架构

- **业务分离**：每个业务线独立API和存储策略
- **上下文边界**：明确的业务边界和数据所有权
- **统一服务**：通过统一的资源服务层实现共享逻辑

#### 2. 智能分层存储策略

- **热存储(hot)**：新上传和活跃资源，快速访问，SSD存储
- **标准存储(standard)**：中期存储，平衡性能和成本
- **归档存储(archive)**：长期存储，低成本，按年月分组

#### 3. 云原生设计原则

- **水平扩展**：支持多实例部署和负载均衡
- **配置外部化**：所有配置通过环境变量管理
- **健康检查**：完整的健康检查和监控端点
- **优雅关闭**：支持SIGTERM/SIGINT信号的优雅关闭

## 🔧 技术栈详细规范

### 核心技术栈v2.0

| 技术组件  | 版本要求     | 用途           | 配置要点         |
| --------- | ------------ | -------------- | ---------------- |
| Node.js   | >=16.0.0     | 运行时环境     | ES2021语法支持   |
| Express   | ^4.18.2      | Web框架        | 支持中间件和路由 |
| Sequelize | ^6.35.2      | ORM框架        | MySQL连接池配置  |
| MySQL     | 8.0+         | 关系数据库     | 支持JSON字段类型 |
| AWS SDK   | ^2.1691.0    | 对象存储客户端 | S3兼容API        |
| Sharp     | ^0.32.6      | 图片处理       | 高性能图片处理   |
| JWT       | ^9.0.2       | 认证令牌       | HMAC SHA256签名  |
| Multer    | ^1.4.5-lts.1 | 文件上传       | 内存存储模式     |

### 依赖管理规范

```json
{
  "engines": {
    "node": ">=16.0.0",
    "npm": ">=8.0.0"
  },
  "scripts": {
    "start": "node app.js",
    "dev": "NODE_ENV=development nodemon app.js",
    "health": "curl -f http://localhost:3000/health || exit 1"
  }
}
```

## 🗄️ 数据库设计规范v2.0

### 核心数据模型

#### ImageResources统一资源模型

```sql
CREATE TABLE `image_resources` (
  `resource_id` VARCHAR(36) NOT NULL,           -- UUID主键
  `business_type` ENUM('lottery','exchange','trade','uploads') NOT NULL,
  `category` VARCHAR(50) NOT NULL,              -- 业务分类
  `context_id` INT NOT NULL,                    -- 上下文ID（用户ID/商品ID等）
  `user_id` INT NULL,                           -- 上传用户ID
  `storage_layer` ENUM('hot','standard','archive') DEFAULT 'hot',
  `file_path` VARCHAR(500) NOT NULL,            -- 存储路径
  `cdn_url` VARCHAR(500) NOT NULL,              -- CDN访问URL
  `thumbnail_paths` JSON NULL,                  -- 缩略图路径集合
  `original_filename` VARCHAR(255) NOT NULL,    -- 原始文件名
  `file_size` INT NOT NULL,                     -- 文件大小（字节）
  `mime_type` VARCHAR(100) NOT NULL,            -- MIME类型
  `dimensions` JSON NULL,                       -- 图片尺寸
  `status` ENUM('active','archived','deleted') DEFAULT 'active',
  `access_count` INT DEFAULT 0,                 -- 访问统计
  `last_accessed_at` DATETIME NULL,             -- 最后访问时间
  `metadata` JSON NULL,                         -- 扩展元数据
  `review_status` ENUM('pending','approved','rejected') NULL,
  `reviewer_id` INT NULL,                       -- 审核员ID
  `review_reason` TEXT NULL,                    -- 审核说明
  `reviewed_at` DATETIME NULL,                  -- 审核时间
  `consumption_amount` DECIMAL(10,2) NULL,      -- 消费金额
  `points_awarded` INT NULL,                    -- 奖励积分
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted_at` DATETIME NULL,                   -- 软删除
  PRIMARY KEY (`resource_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 关键索引设计

```sql
-- 业务查询索引
CREATE INDEX `idx_business_category` ON `image_resources` (`business_type`, `category`);

-- 用户上传查询索引
CREATE INDEX `idx_user_business` ON `image_resources` (`user_id`, `business_type`, `status`);

-- 审核工作台索引
CREATE INDEX `idx_review_status` ON `image_resources` (`review_status`, `business_type`, `created_at`);

-- 存储层级索引
CREATE INDEX `idx_storage_layer` ON `image_resources` (`storage_layer`, `created_at`);

-- 上下文查询索引
CREATE INDEX `idx_context_category` ON `image_resources` (`context_id`, `category`, `status`);
```

#### BusinessConfigs业务配置模型

```sql
CREATE TABLE `business_configs` (
  `config_id` VARCHAR(36) NOT NULL,
  `business_type` ENUM('lottery','exchange','trade','uploads') NOT NULL,
  `config_key` VARCHAR(100) NOT NULL,
  `config_value` JSON NOT NULL,
  `description` TEXT NULL,
  `is_active` BOOLEAN DEFAULT TRUE,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`config_id`),
  UNIQUE KEY `uk_business_key` (`business_type`, `config_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 数据库连接配置

```javascript
// config/database.js - 基于实际代码配置
const config = {
  development: {
    host: process.env.DB_HOST || 'test-db-mysql.ns-br0za7uc.svc',
    port: process.env.DB_PORT || 3306,
    username: process.env.DB_USER || 'root',
    password: process.env.DB_PASSWORD || 'mc6r9cgb',
    database: process.env.DB_NAME || 'restaurant_points_dev',
    dialect: 'mysql',
    timezone: '+08:00',
    logging: process.env.NODE_ENV === 'development' ? console.log : false,
    pool: {
      max: 20,
      min: 0,
      acquire: 30000,
      idle: 10000
    },
    define: {
      charset: 'utf8mb4',
      collate: 'utf8mb4_unicode_ci',
      timestamps: true,
      underscored: false,
      freezeTableName: true
    }
  },
  production: {
    host: process.env.DB_HOST || 'dbconn.sealosbja.site',
    port: process.env.DB_PORT || 42182,
    username: process.env.DB_USER || 'root',
    password: process.env.DB_PASSWORD || 'mc6r9cgb',
    database: process.env.DB_NAME || 'restaurant_points_prod',
    dialect: 'mysql',
    timezone: '+08:00',
    logging: false,
    pool: {
      max: 50,
      min: 5,
      acquire: 60000,
      idle: 10000
    }
  }
}
```

## 🎯 业务服务层规范

### ImageResourceService核心服务

```javascript
class ImageResourceService {
  constructor() {
    this.storageService = new MultiBusinessPhotoStorage()
    this.cache = new Map()
  }

  /**
   * 创建图片资源
   * @param {Object} resourceData - 资源数据
   * @param {Buffer} fileBuffer - 文件缓冲区
   * @param {Object} options - 配置选项
   */
  async createResource(resourceData, fileBuffer, options = {}) {
    // 1. 文件验证
    await this.validateFile(fileBuffer, resourceData)

    // 2. 生成存储路径
    const storagePath = await this.storageService.generateStoragePath(
      resourceData.businessType,
      resourceData.category,
      resourceData.contextId,
      options
    )

    // 3. 上传到Sealos存储
    const cdnUrl = await this.storageService.uploadImage(
      fileBuffer,
      resourceData.originalFilename,
      path.dirname(storagePath)
    )

    // 4. 创建数据库记录
    const resource = await ImageResources.create({
      ...resourceData,
      file_path: storagePath,
      cdn_url: cdnUrl,
      storage_layer: this.getStorageLayer(storagePath)
    })

    return resource
  }
}
```

### MultiBusinessPhotoStorage分层存储服务

```javascript
class MultiBusinessPhotoStorage extends SealosStorageService {
  /**
   * 智能存储层选择算法
   */
  async selectStorageLayer(businessType, category, options) {
    const { uploadTime, isActive, priority } = options
    const config = await this.getBusinessConfig(businessType)

    // 高优先级数据直接使用热存储
    if (priority === 'high' || isActive === true) {
      return 'hot'
    }

    // 基于时间的智能判断
    const fileAge = (Date.now() - uploadTime) / (1000 * 60 * 60 * 24)

    // 业务特定逻辑
    if (businessType === 'uploads' && category === 'pending_review') {
      return 'hot' // 待审核图片需要快速访问
    }

    // 基于文件年龄判断存储层级
    if (fileAge <= config.hotDays) return 'hot'
    if (fileAge <= config.standardDays) return 'standard'
    return 'archive'
  }

  /**
   * 构建完整文件路径
   */
  buildFilePath(storageLayer, businessType, category, contextId, options) {
    const { uploadTime, originalName } = options
    const fileName = this.generateFileName(businessType, contextId, uploadTime, originalName)

    switch (storageLayer) {
      case 'hot':
        return `hot/${businessType}/${category}/${fileName}`

      case 'standard':
        if (businessType === 'uploads') {
          // 用户上传使用分片存储
          const userShard = this.getUserShard(contextId)
          const datePath = this.getDatePath(uploadTime)
          return `standard/users/${userShard}/u${contextId}/${datePath}/${fileName}`
        } else {
          // 业务图片使用业务分类存储
          return `standard/${businessType}/${category}/${fileName}`
        }

      case 'archive':
        const year = new Date(uploadTime).getFullYear()
        const month = (new Date(uploadTime).getMonth() + 1).toString().padStart(2, '0')
        return `archive/${year}/${month}/${businessType}/${category}/${fileName}`

      default:
        throw new Error(`未知存储层级: ${storageLayer}`)
    }
  }
}
```

## 🔐 认证授权规范v2.0

### JWT认证中间件

```javascript
const authenticateToken = async (req, res, next) => {
  try {
    const authHeader = req.headers.authorization
    const token = authHeader && authHeader.split(' ')[1] // Bearer TOKEN

    if (!token) {
      return res.status(401).json({
        code: 4001,
        msg: '缺少访问令牌',
        data: null
      })
    }

    const decoded = verifyAccessToken(token)
    if (!decoded) {
      return res.status(401).json({
        code: 4002,
        msg: '访问令牌无效或已过期',
        data: null
      })
    }

    // 从数据库获取用户信息
    const users = await sequelize.query(
      'SELECT user_id, mobile, nickname, status, is_admin FROM users WHERE user_id = ?',
      { replacements: [decoded.user_id], type: sequelize.QueryTypes.SELECT }
    )

    const user = users[0]
    if (!user || user.status === 'banned') {
      return res.status(401).json({
        code: 4003,
        msg: '用户不存在或已被禁用',
        data: null
      })
    }

    req.user = user
    req.token = decoded
    next()
  } catch (error) {
    console.error('认证中间件错误:', error)
    res.status(500).json({
      code: 5000,
      msg: '认证服务异常',
      data: null
    })
  }
}
```

### 权限级别定义

| 权限级别 | 标识字段        | 权限范围                 | 适用场景   |
| -------- | --------------- | ------------------------ | ---------- |
| 普通用户 | is_admin: false | 查看、上传自己的内容     | 用户端操作 |
| 管理员   | is_admin: true  | 全部数据的增删改查、审核 | 管理后台   |

## 🌐 API接口设计规范

### RESTful API设计原则

- **资源导向**：以资源为中心的URL设计
- **HTTP动词**：正确使用GET、POST、PUT、DELETE
- **状态码**：统一的HTTP状态码规范
- **版本控制**：/api/v2前缀进行版本管理

### 统一响应格式

```javascript
// 成功响应
{
  "code": 0,
  "msg": "success",
  "data": {...},
  "timestamp": "2025-07-28T20:15:37.000Z"
}

// 错误响应
{
  "code": 1001,
  "msg": "参数验证失败",
  "data": null,
  "timestamp": "2025-07-28T20:15:37.000Z"
}
```

### 业务API路由结构

```
/api/v2/
├── resources/              # 统一资源管理API
│   ├── POST /             # 创建资源
│   ├── GET /              # 查询资源列表
│   ├── GET /:resourceId   # 获取单个资源
│   ├── PUT /:resourceId   # 更新资源
│   └── DELETE /:resourceId # 删除资源
├── lottery/               # 抽奖业务API
│   ├── GET /prizes/:prizeId
│   ├── POST /prizes/:prizeId/images
│   ├── GET /wheels
│   └── GET /banners
├── exchange/              # 兑换业务API
│   ├── GET /products/:productId
│   ├── POST /products/:productId/images
│   └── GET /categories
├── trade/                 # 交易业务API
│   ├── GET /items/:itemId
│   ├── POST /items/:itemId/images
│   └── GET /banners
└── uploads/               # 用户上传API
    ├── POST /submit
    ├── GET /my-submissions
    └── GET /pending-reviews
```

## 🔧 中间件系统规范

### 字段转换中间件

```javascript
// 自动处理前后端字段映射
const fieldTransformMiddleware = createResponseTransformMiddleware({
  logTransformations: process.env.NODE_ENV === 'development',
  strictMode: process.env.NODE_ENV === 'production'
})

// 转换规则示例
const transformRules = {
  user_id: 'userId',
  created_at: 'createdAt',
  updated_at: 'updatedAt',
  file_size: 'fileSize',
  mime_type: 'mimeType'
}
```

### 错误处理中间件

```javascript
app.use((error, req, res, next) => {
  console.error('API错误:', {
    message: error.message,
    stack: error.stack,
    url: req.url,
    method: req.method,
    ip: req.ip
  })

  if (error.name === 'ValidationError') {
    return res.status(400).json(ApiResponse.error(error.message, 'VALIDATION_ERROR'))
  }

  if (error.name === 'UnauthorizedError') {
    return res.status(401).json(ApiResponse.unauthorized())
  }

  res.status(500).json(ApiResponse.error('服务器内部错误', 'INTERNAL_ERROR'))
})
```

## ☁️ Sealos对象存储集成

### 存储服务配置

```javascript
class SealosStorageService {
  constructor() {
    this.config = {
      endpoint: process.env.SEALOS_ENDPOINT || 'https://objectstorageapi.bja.sealos.run',
      bucket: 'br0za7uc-tiangong',
      accessKeyId: process.env.SEALOS_ACCESS_KEY || 'br0za7uc',
      secretAccessKey: process.env.SEALOS_SECRET_KEY || 'skxg8mk5gqfhf9xz'
    }

    this.s3 = new AWS.S3({
      endpoint: this.config.endpoint,
      accessKeyId: this.config.accessKeyId,
      secretAccessKey: this.config.secretAccessKey,
      region: process.env.SEALOS_REGION || 'bja',
      s3ForcePathStyle: true,
      signatureVersion: 'v4'
    })
  }
}
```

### 文件上传处理

```javascript
async uploadImage(fileBuffer, originalName, folder = 'photos') {
  try {
    const timestamp = Date.now();
    const hash = crypto.randomBytes(8).toString('hex');
    const ext = path.extname(originalName) || '.jpg';
    const fileName = `${folder}/${timestamp}_${hash}${ext}`;

    const uploadParams = {
      Bucket: this.config.bucket,
      Key: fileName,
      Body: fileBuffer,
      ContentType: this.getContentType(ext),
      ACL: 'public-read',
      CacheControl: 'max-age=31536000'
    };

    const result = await this.s3.upload(uploadParams).promise();
    return result.Location;
  } catch (error) {
    throw new Error(`文件上传失败: ${error.message}`);
  }
}
```

## 📊 缓存策略规范

### 多级缓存设计

```javascript
class CacheManager {
  constructor() {
    // 路径生成缓存 - 5分钟
    this.pathCache = new Map()
    this.pathCacheExpiry = 5 * 60 * 1000

    // 业务配置缓存 - 10分钟
    this.businessConfigCache = new Map()
    this.configCacheExpiry = 10 * 60 * 1000

    // 用户分片缓存 - 长期有效
    this.userShardCache = new Map()

    this.maxCacheSize = 1000
  }

  /**
   * 智能缓存清理
   */
  cleanExpiredCache() {
    const now = Date.now()
    let cleanedCount = 0

    // 清理过期的路径缓存
    for (const [key, value] of this.pathCache.entries()) {
      if (now - value.timestamp > this.pathCacheExpiry) {
        this.pathCache.delete(key)
        cleanedCount++
      }
    }

    if (cleanedCount > 0) {
      console.log(`🧹 清理过期缓存: ${cleanedCount}项`)
    }
  }
}
```

## 🚀 部署和运维规范

### 环境配置

```bash
# 基础环境变量
NODE_ENV=production
PORT=3000

# 数据库配置（基于实际配置）
DB_HOST=test-db-mysql.ns-br0za7uc.svc
DB_PORT=3306
DB_NAME=restaurant_points_dev
DB_USER=root
DB_PASSWORD=mc6r9cgb

# Sealos存储配置（基于实际配置）
SEALOS_ENDPOINT=https://objectstorageapi.bja.sealos.run
SEALOS_ACCESS_KEY=br0za7uc
SEALOS_SECRET_KEY=skxg8mk5gqfhf9xz
SEALOS_REGION=bja
SEALOS_BUCKET=br0za7uc-tiangong

# JWT配置（基于实际代码）
JWT_SECRET=your_jwt_secret_key_change_in_production
JWT_EXPIRES_IN=24h

# 应用配置（基于实际代码）
ALLOWED_ORIGINS=*
MAX_FILE_SIZE=20971520
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=300
```

### 健康检查端点

```javascript
app.get('/health', async (req, res) => {
  try {
    // 检查数据库连接
    await sequelize.authenticate()

    // 检查存储服务
    const storageHealth = await storageService.testConnection()

    res.json({
      status: 'healthy',
      version: '2.0.0',
      timestamp: new Date().toISOString(),
      checks: {
        database: 'connected',
        storage: storageHealth ? 'connected' : 'disconnected',
        uptime: process.uptime()
      }
    })
  } catch (error) {
    res.status(503).json({
      status: 'unhealthy',
      error: error.message,
      timestamp: new Date().toISOString()
    })
  }
})
```

### 性能监控指标

| 指标类型       | 目标值      | 监控方法       |
| -------------- | ----------- | -------------- |
| API响应时间    | <100ms      | 响应时间中间件 |
| 文件上传时间   | <2s         | 上传时间记录   |
| 数据库查询时间 | <50ms       | Sequelize日志  |
| 系统可用性     | >99.95%     | 健康检查端点   |
| 并发用户数     | 1000+       | 负载测试       |
| 存储容量       | 20M+ images | 存储统计API    |

## 🔒 安全规范v2.0

### 数据保护

- **密码加密**：BCrypt加密存储
- **文件验证**：严格的文件类型和大小限制
- **SQL注入防护**：Sequelize ORM参数化查询
- **XSS防护**：输入数据清理和输出编码
- **CORS配置**：限制跨域访问源

### 访问控制

- **JWT认证**：基于JSON Web Token的无状态认证
- **权限分级**：用户、管理员两级权限控制
- **API限流**：基于IP的请求频率限制
- **安全头**：Helmet中间件设置安全HTTP头

### 审计日志

```javascript
const auditLogger = (req, res, next) => {
  const auditInfo = {
    timestamp: new Date().toISOString(),
    method: req.method,
    url: req.originalUrl,
    ip: req.ip,
    userAgent: req.get('User-Agent'),
    userId: req.user?.user_id,
    duration: null
  }

  const startTime = Date.now()

  res.on('finish', () => {
    auditInfo.duration = Date.now() - startTime
    auditInfo.statusCode = res.statusCode

    console.log('📋 审计日志:', JSON.stringify(auditInfo))
  })

  next()
}
```

## 📈 扩展性设计

### 水平扩展支持

- **无状态设计**：应用实例间无状态共享
- **负载均衡**：支持多实例负载均衡
- **数据库连接池**：优化数据库连接管理
- **分布式缓存**：支持Redis等外部缓存

### 业务扩展能力

```javascript
// 新业务类型注册
const BusinessTypes = {
  LOTTERY: 'lottery',
  EXCHANGE: 'exchange',
  TRADE: 'trade',
  UPLOADS: 'uploads',
  // 🔴 未来可扩展
  MARKETING: 'marketing', // 营销活动
  ANALYTICS: 'analytics' // 数据分析
}

// 存储策略扩展
const StorageStrategies = {
  HOT: 'hot',
  STANDARD: 'standard',
  ARCHIVE: 'archive',
  // 🔴 未来可扩展
  COLD: 'cold', // 冷存储
  BACKUP: 'backup' // 备份存储
}
```

## 📚 开发规范总结

### 编码规范

- **ES2021语法**：使用现代JavaScript语法
- **异步处理**：统一使用async/await
- **错误处理**：完整的try-catch错误处理
- **日志记录**：结构化日志记录
- **代码注释**：关键逻辑必须注释

### 测试规范

- **单元测试**：核心业务逻辑100%覆盖
- **集成测试**：API接口端到端测试
- **性能测试**：关键接口性能基准测试
- **安全测试**：权限和数据安全测试

### 文档规范

- **API文档**：OpenAPI 3.0规范
- **代码文档**：JSDoc注释规范
- **部署文档**：详细的部署和配置指南
- **运维文档**：监控和故障排查手册

---

**核心设计理念**: 业务驱动、分层存储、云原生、可扩展、高性能、安全可靠

> 本规范基于v2.0多业务线分层存储架构的实际代码实现，确保文档与代码保持一致性，为前后端协作提供准确的技术参考。
