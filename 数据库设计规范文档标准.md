# æ•°æ®åº“è®¾è®¡è§„èŒƒæ–‡æ¡£æ ‡å‡† - v2.0å¤šä¸šåŠ¡çº¿åˆ†å±‚å­˜å‚¨æ¶æ„ç‰ˆæœ¬

**æ–‡æ¡£ç‰ˆæœ¬**: v2.4.0  
**æ›´æ–°æ—¶é—´**: 2025å¹´07æœˆ28æ—¥  
**æŠ€æœ¯æ ˆ**: Node.js + Express + MySQL + Sequelize + v2.0åˆ†å±‚å­˜å‚¨æ¶æ„  
**æ•°æ®åº“**: MySQL 8.0+ (test-db-mysql.ns-br0za7uc.svc:3306)
**ä½¿ç”¨æ¨¡å‹**: Claude Sonnet 4
**ä»£ç éªŒè¯**: åŸºäºmodels/ç›®å½•å®é™…è¿è¡Œä»£ç ï¼ˆImageResources.js 311è¡Œï¼ŒBusinessConfigs.js 196è¡Œç­‰ï¼‰
**äº§å“å¯¹æ¥**: 100%ç¬¦åˆé¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿv2.0å¤šä¸šåŠ¡çº¿åˆ†å±‚å­˜å‚¨æ¶æ„ï¼Œç¡®ä¿å‰åç«¯æ•°æ®åº“å¯¹æ¥å·¥ä½œ

## ğŸ“‹ é‡å¤§æ›´æ–°å†…å®¹ï¼ˆv2.4.0 - 2025å¹´07æœˆ28æ—¥ï¼‰

### ğŸ”´ v2.0æ¶æ„æ ¸å¿ƒå˜é©ï¼ˆ2025å¹´07æœˆ28æ—¥ï¼‰
> **ğŸ†• æ¶æ„å‡çº§**ï¼šä»ä¼ ç»Ÿå•ä¸šåŠ¡å­˜å‚¨å‡çº§ä¸ºå¤šä¸šåŠ¡çº¿åˆ†å±‚å­˜å‚¨æ¶æ„

#### v2.0æ¶æ„æ ¸å¿ƒç‰¹æ€§
```javascript
// ğŸ”´ v2.0å¤šä¸šåŠ¡çº¿åˆ†å±‚å­˜å‚¨æ¶æ„ï¼ˆåŸºäºå®é™…ä»£ç å®ç°ï¼‰
const ARCHITECTURE_V2_FEATURES = {
  // ç»Ÿä¸€èµ„æºç®¡ç†
  unifiedResourceManagement: {
    model: 'ImageResources',
    description: 'ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ä¸šåŠ¡æ¨¡å—çš„å›¾ç‰‡èµ„æº',
    keyFeatures: [
      'UUIDä¸»é”®ç¡®ä¿å…¨å±€å”¯ä¸€æ€§',
      'å¤šä¸šåŠ¡ç±»å‹æ”¯æŒï¼šlottery/exchange/trade/uploads',
      'æ™ºèƒ½åˆ†å±‚å­˜å‚¨ï¼šhot/standard/archive',
      'è‡ªåŠ¨ç¼©ç•¥å›¾ç”Ÿæˆå’Œç®¡ç†',
      'è®¿é—®ç»Ÿè®¡å’Œæ€§èƒ½ç›‘æ§',
      'å®Œæ•´çš„å®¡æ ¸æµç¨‹æ”¯æŒ'
    ]
  },
  
  // æ™ºèƒ½åˆ†å±‚å­˜å‚¨
  intelligentStorageLayers: {
    hot: {
      purpose: 'çƒ­å­˜å‚¨ - æ–°ä¸Šä¼ å’Œæ´»è·ƒèµ„æº',
      performance: 'å¿«é€Ÿè®¿é—®ï¼Œä½å»¶è¿Ÿ',
      cost: 'é«˜æˆæœ¬',
      defaultDays: 30
    },
    standard: {
      purpose: 'æ ‡å‡†å­˜å‚¨ - ä¸­æœŸå­˜å‚¨',
      performance: 'å¹³è¡¡æ€§èƒ½å’Œæˆæœ¬',
      cost: 'ä¸­ç­‰æˆæœ¬',
      defaultDays: 365
    },
    archive: {
      purpose: 'å½’æ¡£å­˜å‚¨ - é•¿æœŸå­˜å‚¨',
      performance: 'è¾ƒæ…¢è®¿é—®é€Ÿåº¦',
      cost: 'ä½æˆæœ¬',
      defaultDays: 1095 // 3å¹´
    }
  },
  
  // ä¸šåŠ¡æ¨¡å—åŒ–
  businessModularization: {
    lottery: 'æŠ½å¥–ä¸šåŠ¡ - å¥–å“ã€è½¬ç›˜ã€æ¨ªå¹…å›¾ç‰‡ç®¡ç†',
    exchange: 'å…‘æ¢ä¸šåŠ¡ - å•†å“ã€åˆ†ç±»ã€ä¿ƒé”€å›¾ç‰‡ç®¡ç†',
    trade: 'äº¤æ˜“ä¸šåŠ¡ - å•†å“ã€æ¨ªå¹…ã€äº¤æ˜“å›¾ç‰‡ç®¡ç†',
    uploads: 'ç”¨æˆ·ä¸Šä¼  - æ¶ˆè´¹å°ç¥¨å®¡æ ¸å›¾ç‰‡ç®¡ç†'
  }
};
```

### ğŸ”´ æ•°æ®åº“æ¶æ„ç®€åŒ–ï¼ˆv2.0ç¡®è®¤ç‰ˆï¼‰
> **âš ï¸ é‡è¦å˜æ›´**ï¼šæ•°æ®åº“æ¶æ„ä»å¤æ‚å¤šè¡¨è®¾è®¡ç®€åŒ–ä¸ºæ ¸å¿ƒ3è¡¨è®¾è®¡

#### å®é™…æ•°æ®åº“è¡¨ç»“æ„ï¼ˆåŸºäºmodels/ç›®å½•ï¼‰
```javascript
// âœ… v2.0æ ¸å¿ƒæ•°æ®æ¨¡å‹ï¼ˆåŸºäºå®é™…ä»£ç å®ç°ï¼‰
const DATABASE_MODELS_V2 = {
  // æ ¸å¿ƒè¡¨ï¼šç»Ÿä¸€å›¾ç‰‡èµ„æºç®¡ç†
  ImageResources: {
    file: 'models/ImageResources.js',
    lines: 311,
    description: 'ç»Ÿä¸€å›¾ç‰‡èµ„æºç®¡ç†è¡¨',
    tableName: 'image_resources'
  },
  
  // é…ç½®è¡¨ï¼šä¸šåŠ¡é…ç½®ç®¡ç†
  BusinessConfigs: {
    file: 'models/BusinessConfigs.js', 
    lines: 196,
    description: 'ä¸šåŠ¡é…ç½®ç®¡ç†è¡¨',
    tableName: 'business_configs'
  },
  
  // ç”¨æˆ·è¡¨ï¼šç”¨æˆ·ä¿¡æ¯ç®¡ç†ï¼ˆå¤–éƒ¨ä¾èµ–ï¼‰
  Users: {
    description: 'ç”¨æˆ·ä¿¡æ¯ç®¡ç†è¡¨ï¼ˆå·²å­˜åœ¨ï¼‰',
    tableName: 'users',
    keyFields: ['user_id', 'mobile', 'nickname', 'is_admin']
  }
};
```

### ğŸš§ å¼€å‘é˜¶æ®µæ•°æ®åº“é€‚é…
> **âš ï¸ é‡è¦æé†’**ï¼šå½“å‰ä¸ºå¼€å‘é˜¶æ®µï¼Œæ•°æ®åº“è®¾è®¡éœ€è¦é€‚é…ä»¥ä¸‹å¼€å‘é™åˆ¶ï¼š

- ğŸ“± **çŸ­ä¿¡éªŒè¯å­—æ®µ**: æ•°æ®åº“ä¿ç•™ç›¸å…³å­—æ®µä½†å¼€å‘é˜¶æ®µä¸å®é™…éªŒè¯
- ğŸ” **ç»Ÿä¸€ç™»å½•æ–¹å¼**: æ‰€æœ‰ç”¨æˆ·ï¼ˆåŒ…æ‹¬ç®¡ç†å‘˜ï¼‰ä½¿ç”¨æ‰‹æœºå·+éªŒè¯ç 123456ç™»å½•
- ğŸ“¸ **æ‹ç…§ä¸Šä¼ ç®€åŒ–**: ImageResourcesè¡¨é€‚é…ç”¨æˆ·ä»…ä¸Šä¼ ç…§ç‰‡çš„ç®€åŒ–ç‰ˆæœ¬
- ğŸ’¡ **æƒé™å­—æ®µ**: ç®€åŒ–ä¸ºis_adminå•ä¸€å­—æ®µï¼Œå•†å®¶ç®¡ç†åŠŸèƒ½é€šè¿‡ç®¡ç†å‘˜æƒé™ç»Ÿä¸€æ§åˆ¶

## ğŸ—ï¸ v2.0æ ¸å¿ƒæ•°æ®æ¨¡å‹è®¾è®¡

### 1. ç»Ÿä¸€å›¾ç‰‡èµ„æºè¡¨ - ImageResources

#### 1.1 è¡¨ç»“æ„è®¾è®¡ï¼ˆåŸºäºmodels/ImageResources.jså®ç°ï¼‰
```sql
-- âœ… ç»Ÿä¸€å›¾ç‰‡èµ„æºç®¡ç†è¡¨ï¼ˆå®é™…è¡¨ç»“æ„ï¼‰
CREATE TABLE `image_resources` (
  -- ä¸»é”®å’Œæ ‡è¯†
  `resource_id` VARCHAR(36) PRIMARY KEY COMMENT 'èµ„æºå”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆUUIDï¼‰',
  
  -- ä¸šåŠ¡åˆ†ç±»å­—æ®µ
  `business_type` ENUM('lottery', 'exchange', 'trade', 'uploads') NOT NULL 
    COMMENT 'ä¸šåŠ¡ç±»å‹ï¼šæŠ½å¥–/å…‘æ¢/äº¤æ˜“/ä¸Šä¼ ',
  `category` VARCHAR(50) NOT NULL 
    COMMENT 'èµ„æºåˆ†ç±»ï¼šprizes/products/items/pending_reviewç­‰',
  `context_id` INTEGER NOT NULL 
    COMMENT 'ä¸Šä¸‹æ–‡IDï¼šç”¨æˆ·ID/å¥–å“ID/å•†å“IDç­‰',
  `user_id` INTEGER 
    COMMENT 'å…³è”ç”¨æˆ·IDï¼ˆä¸Šä¼ ç”¨æˆ·ï¼‰',
  
  -- å­˜å‚¨æ¶æ„å­—æ®µ
  `storage_layer` ENUM('hot', 'standard', 'archive') NOT NULL DEFAULT 'hot' 
    COMMENT 'å­˜å‚¨å±‚çº§ï¼šçƒ­å­˜å‚¨/æ ‡å‡†å­˜å‚¨/å½’æ¡£å­˜å‚¨',
  `file_path` VARCHAR(500) NOT NULL 
    COMMENT 'æ–‡ä»¶å­˜å‚¨è·¯å¾„',
  `cdn_url` VARCHAR(500) NOT NULL 
    COMMENT 'CDNè®¿é—®URL',
  `thumbnail_paths` JSON 
    COMMENT 'ç¼©ç•¥å›¾è·¯å¾„é›†åˆï¼š{small: "", medium: "", large: ""}',
  
  -- æ–‡ä»¶ä¿¡æ¯
  `original_filename` VARCHAR(255) NOT NULL 
    COMMENT 'åŸå§‹æ–‡ä»¶å',
  `file_size` INTEGER NOT NULL 
    COMMENT 'æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰',
  `mime_type` VARCHAR(100) NOT NULL 
    COMMENT 'MIMEç±»å‹',
  `dimensions` JSON 
    COMMENT 'å›¾ç‰‡å°ºå¯¸ï¼š{width: 1920, height: 1080}',
  
  -- çŠ¶æ€ç®¡ç†
  `status` ENUM('active', 'archived', 'deleted') NOT NULL DEFAULT 'active' 
    COMMENT 'èµ„æºçŠ¶æ€',
  `access_count` INTEGER NOT NULL DEFAULT 0 
    COMMENT 'è®¿é—®æ¬¡æ•°',
  `last_accessed_at` DATETIME 
    COMMENT 'æœ€åè®¿é—®æ—¶é—´',
  
  -- æ‰©å±•å…ƒæ•°æ®
  `metadata` JSON 
    COMMENT 'æ‰©å±•å…ƒæ•°æ®ï¼šé¢œè‰²ã€æ ‡ç­¾ã€GPSç­‰',
  
  -- å®¡æ ¸ç›¸å…³ï¼ˆé’ˆå¯¹ç”¨æˆ·ä¸Šä¼ ï¼‰
  `review_status` ENUM('pending', 'approved', 'rejected') 
    COMMENT 'å®¡æ ¸çŠ¶æ€ï¼ˆä»…ç”¨æˆ·ä¸Šä¼ éœ€è¦ï¼‰',
  `reviewer_id` INTEGER 
    COMMENT 'å®¡æ ¸å‘˜ID',
  `review_reason` TEXT 
    COMMENT 'å®¡æ ¸è¯´æ˜',
  `reviewed_at` DATETIME 
    COMMENT 'å®¡æ ¸æ—¶é—´',
  
  -- ä¸šåŠ¡ç›¸å…³å­—æ®µ
  `consumption_amount` DECIMAL(10, 2) 
    COMMENT 'æ¶ˆè´¹é‡‘é¢ï¼ˆç”¨äºä¸Šä¼ å®¡æ ¸ï¼‰',
  `points_awarded` INTEGER 
    COMMENT 'å¥–åŠ±ç§¯åˆ†æ•°é‡',
  
  -- æ—¶é—´æˆ³
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP 
    COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP 
    COMMENT 'æ›´æ–°æ—¶é—´',
  `deleted_at` TIMESTAMP NULL 
    COMMENT 'è½¯åˆ é™¤æ—¶é—´',
  
  -- å¤–é”®çº¦æŸ
  FOREIGN KEY (`user_id`) REFERENCES `users`(`user_id`) ON DELETE SET NULL,
  FOREIGN KEY (`reviewer_id`) REFERENCES `users`(`user_id`) ON DELETE SET NULL,
  
  -- ç´¢å¼•è®¾è®¡ï¼ˆåŸºäºå®é™…æŸ¥è¯¢éœ€æ±‚ï¼‰
  INDEX `idx_business_category` (`business_type`, `category`),
  INDEX `idx_user_business` (`user_id`, `business_type`, `status`),
  INDEX `idx_review_status` (`review_status`, `business_type`, `created_at`),
  INDEX `idx_storage_layer` (`storage_layer`, `created_at`),
  INDEX `idx_context_category` (`context_id`, `category`, `status`),
  INDEX `idx_created_status` (`created_at`, `status`),
  INDEX `idx_access_count` (`access_count`, `last_accessed_at`)
  
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci 
  COMMENT='v2.0ç»Ÿä¸€å›¾ç‰‡èµ„æºç®¡ç†è¡¨';
```

#### 1.2 ä¸šåŠ¡åˆ†ç±»è¯´æ˜
```javascript
// ğŸ”´ ImageResourcesä¸šåŠ¡åˆ†ç±»è¯¦è§£ï¼ˆåŸºäºv2.0æ¶æ„å®é™…éœ€æ±‚ï¼‰
const BUSINESS_TYPE_MAPPING = {
  // æŠ½å¥–ä¸šåŠ¡
  lottery: {
    categories: ['prizes', 'wheels', 'banners', 'backgrounds'],
    description: 'æŠ½å¥–ç›¸å…³å›¾ç‰‡èµ„æºï¼šå¥–å“å›¾ç‰‡ã€è½¬ç›˜ç´ æã€æ¨ªå¹…ç­‰',
    storage_class: 'hot', // é«˜é¢‘è®¿é—®
    access_pattern: 'é«˜é¢‘è®¿é—®ï¼Œéœ€è¦å¿«é€Ÿå“åº”'
  },
  
  // å…‘æ¢ä¸šåŠ¡
  exchange: {
    categories: ['products', 'categories', 'promotions'],
    description: 'å…‘æ¢å•†å“å›¾ç‰‡ï¼šå•†å“ä¸»å›¾ã€åˆ†ç±»å›¾ç‰‡ã€ä¿ƒé”€ç´ æ',
    storage_class: 'standard', // ä¸­é¢‘è®¿é—®
    access_pattern: 'ä¸­é¢‘è®¿é—®ï¼Œå¹³è¡¡æ€§èƒ½å’Œæˆæœ¬'
  },
  
  // äº¤æ˜“ä¸šåŠ¡
  trade: {
    categories: ['items', 'banners', 'transactions'],
    description: 'äº¤æ˜“ç‰©å“å›¾ç‰‡ï¼šå•†å“å›¾ç‰‡ã€æ¨ªå¹…ã€äº¤æ˜“è®°å½•å›¾ç‰‡',
    storage_class: 'standard',
    access_pattern: 'ä¸­é¢‘è®¿é—®ï¼Œæ³¨é‡æˆæœ¬æ•ˆç›Š'
  },
  
  // ç”¨æˆ·ä¸Šä¼ 
  uploads: {
    categories: ['dining', 'receipts', 'reviews', 'activities'],
    description: 'ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡ï¼šç”¨é¤ç…§ç‰‡ã€æ¶ˆè´¹å°ç¥¨ã€è¯„ä»·å›¾ç‰‡',
    storage_class: 'hot', // å®¡æ ¸æœŸé—´é«˜é¢‘è®¿é—®
    access_pattern: 'å®¡æ ¸æœŸé«˜é¢‘ï¼Œé€šè¿‡åé™ä¸ºä½é¢‘'
  }
};
```

#### 1.3 ä¸‰å±‚å­˜å‚¨æ¶æ„è®¾è®¡
```javascript
// ğŸ”´ v2.0ä¸‰å±‚å­˜å‚¨æ¶æ„ï¼ˆåŸºäºSealoså¯¹è±¡å­˜å‚¨ï¼‰
const STORAGE_ARCHITECTURE = {
  // çƒ­å­˜å‚¨å±‚ï¼ˆHot Tierï¼‰
  hot: {
    description: 'é«˜é¢‘è®¿é—®æ•°æ®ï¼Œ7å¤©å†…è®¿é—®è¿‡',
    storage_type: 'SSDå­˜å‚¨',
    access_time: '<10ms',
    cost_level: 'high',
    auto_tier_rules: {
      promote_from: 'standard',
      promote_condition: 'access_count > 10 AND last_accessed_at > DATE_SUB(NOW(), INTERVAL 1 DAY)',
      demote_to: 'standard',
      demote_condition: 'last_accessed_at IS NULL OR last_accessed_at < DATE_SUB(NOW(), INTERVAL 7 DAY)'
    }
  },
  
  // æ ‡å‡†å­˜å‚¨å±‚ï¼ˆStandard Tierï¼‰
  standard: {
    description: 'ä¸­é¢‘è®¿é—®æ•°æ®ï¼Œ7-30å¤©è®¿é—®',
    storage_type: 'å¹³è¡¡å­˜å‚¨',
    access_time: '<50ms',
    cost_level: 'medium',
    auto_tier_rules: {
      promote_to: 'hot',
      promote_condition: 'access_count > 5 AND last_accessed_at > DATE_SUB(NOW(), INTERVAL 1 DAY)',
      demote_to: 'archive',
      demote_condition: 'last_accessed_at IS NULL OR last_accessed_at < DATE_SUB(NOW(), INTERVAL 30 DAY)'
    }
  },
  
  // å½’æ¡£å­˜å‚¨å±‚ï¼ˆArchive Tierï¼‰
  archive: {
    description: 'ä½é¢‘è®¿é—®æ•°æ®ï¼Œ30å¤©ä»¥ä¸Šæœªè®¿é—®',
    storage_type: 'å†·å­˜å‚¨',
    access_time: '<200ms',
    cost_level: 'low',
    auto_tier_rules: {
      promote_to: 'standard',
      promote_condition: 'access_count > 0 AND last_accessed_at > DATE_SUB(NOW(), INTERVAL 7 DAY)',
      permanent_archive: 'last_accessed_at IS NULL OR last_accessed_at < DATE_SUB(NOW(), INTERVAL 365 DAY)'
    }
  }
};
```

### 2. ä¸šåŠ¡é…ç½®ç®¡ç†è¡¨ - BusinessConfigs

#### 2.1 è¡¨ç»“æ„è®¾è®¡ï¼ˆåŸºäºmodels/BusinessConfigs.jså®ç°ï¼‰
```sql
-- ğŸ”´ ä¸šåŠ¡é…ç½®ç®¡ç†è¡¨ï¼ˆ196è¡Œå®ç°ï¼‰
CREATE TABLE `business_configs` (
  -- ä¸»é”®å’Œæ ‡è¯†
  `config_id` VARCHAR(36) PRIMARY KEY COMMENT 'é…ç½®å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆUUIDï¼‰',
  
  -- é…ç½®åˆ†ç±»
  `business_type` VARCHAR(50) NOT NULL 
    COMMENT 'ä¸šåŠ¡ç±»å‹ï¼šlottery/exchange/trade/uploads/system',
  `config_key` VARCHAR(100) NOT NULL 
    COMMENT 'é…ç½®é”®åï¼šå¦‚cost_per_draw, daily_limitç­‰',
  `config_value` JSON NOT NULL 
    COMMENT 'é…ç½®å€¼ï¼ˆJSONæ ¼å¼å­˜å‚¨å¤æ‚é…ç½®ï¼‰',
  
  -- é…ç½®æè¿°
  `description` TEXT 
    COMMENT 'é…ç½®é¡¹è¯¦ç»†æè¿°',
  `config_group` VARCHAR(50) DEFAULT 'default' 
    COMMENT 'é…ç½®åˆ†ç»„ï¼šdefault/advanced/experimental',
  
  -- é…ç½®å±æ€§
  `data_type` ENUM('string', 'number', 'boolean', 'object', 'array') NOT NULL DEFAULT 'string' 
    COMMENT 'æ•°æ®ç±»å‹æ ‡è¯†',
  `validation_rules` JSON 
    COMMENT 'éªŒè¯è§„åˆ™ï¼š{min: 1, max: 100, required: true}',
  `default_value` JSON 
    COMMENT 'é»˜è®¤å€¼',
  
  -- çŠ¶æ€æ§åˆ¶
  `is_active` BOOLEAN NOT NULL DEFAULT TRUE 
    COMMENT 'æ˜¯å¦æ¿€æ´»',
  `version` VARCHAR(10) NOT NULL DEFAULT '1.0' 
    COMMENT 'é…ç½®ç‰ˆæœ¬å·',
  `environment` ENUM('development', 'staging', 'production', 'all') DEFAULT 'all' 
    COMMENT 'é€‚ç”¨ç¯å¢ƒ',
  
  -- æƒé™æ§åˆ¶
  `access_level` ENUM('public', 'user', 'admin', 'system') NOT NULL DEFAULT 'admin' 
    COMMENT 'è®¿é—®æƒé™çº§åˆ«',
  `modify_level` ENUM('admin', 'system', 'readonly') NOT NULL DEFAULT 'admin' 
    COMMENT 'ä¿®æ”¹æƒé™çº§åˆ«',
  
  -- æ—¶é—´æˆ³
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP 
    COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP 
    COMMENT 'æ›´æ–°æ—¶é—´',
  `last_modified_by` INTEGER 
    COMMENT 'æœ€åä¿®æ”¹äººID',
  
  -- å¤–é”®çº¦æŸ
  FOREIGN KEY (`last_modified_by`) REFERENCES `users`(`user_id`) ON DELETE SET NULL,
  
  -- ç´¢å¼•è®¾è®¡
  UNIQUE KEY `uk_business_key` (`business_type`, `config_key`),
  INDEX `idx_business_type` (`business_type`, `is_active`),
  INDEX `idx_config_group` (`config_group`, `business_type`),
  INDEX `idx_access_level` (`access_level`, `environment`),
  INDEX `idx_updated_at` (`updated_at`)
  
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci 
  COMMENT='v2.0ä¸šåŠ¡é…ç½®ç®¡ç†è¡¨';
```

#### 2.2 é…ç½®é¡¹æ ‡å‡†å®šä¹‰
```javascript
// ğŸ”´ BusinessConfigsæ ‡å‡†é…ç½®é¡¹ï¼ˆåŸºäºå®é™…ä¸šåŠ¡éœ€æ±‚ï¼‰
const STANDARD_BUSINESS_CONFIGS = {
  // æŠ½å¥–ä¸šåŠ¡é…ç½®
  lottery: {
    cost_per_draw: {
      description: 'å•æ¬¡æŠ½å¥–æ¶ˆè€—ç§¯åˆ†',
      data_type: 'number',
      default_value: 10,
      validation_rules: { min: 1, max: 100 },
      access_level: 'admin'
    },
    daily_limit: {
      description: 'æ¯æ—¥æŠ½å¥–æ¬¡æ•°é™åˆ¶',
      data_type: 'number', 
      default_value: 50,
      validation_rules: { min: 1, max: 200 },
      access_level: 'admin'
    },
    guarantee_count: {
      description: 'ä¿åº•æœºåˆ¶è§¦å‘æ¬¡æ•°',
      data_type: 'number',
      default_value: 10,
      validation_rules: { min: 5, max: 50 },
      access_level: 'admin'
    },
    prize_probabilities: {
      description: 'å¥–å“æ¦‚ç‡é…ç½®',
      data_type: 'object',
      default_value: {
        "special": 0.001,
        "first": 0.01,
        "second": 0.05,
        "third": 0.1,
        "participation": 0.839
      },
      validation_rules: { sum_must_equal: 1.0 },
      access_level: 'admin'
    }
  },
  
  // å…‘æ¢ä¸šåŠ¡é…ç½®
  exchange: {
    min_points_per_item: {
      description: 'å•†å“æœ€ä½å…‘æ¢ç§¯åˆ†',
      data_type: 'number',
      default_value: 100,
      validation_rules: { min: 10, max: 10000 },
      access_level: 'admin'
    },
    delivery_methods: {
      description: 'é…é€æ–¹å¼é…ç½®',
      data_type: 'array',
      default_value: ["pickup", "express", "digital"],
      validation_rules: { min_items: 1, max_items: 10 },
      access_level: 'admin'
    }
  },
  
  // ä¸Šä¼ ä¸šåŠ¡é…ç½®
  uploads: {
    max_file_size: {
      description: 'æœ€å¤§æ–‡ä»¶ä¸Šä¼ å¤§å°ï¼ˆå­—èŠ‚ï¼‰',
      data_type: 'number',
      default_value: 10485760, // 10MB
      validation_rules: { min: 1048576, max: 52428800 }, // 1MB-50MB
      access_level: 'admin'
    },
    allowed_mime_types: {
      description: 'å…è®¸çš„æ–‡ä»¶ç±»å‹',
      data_type: 'array',
      default_value: ["image/jpeg", "image/jpg", "image/png", "image/gif", "image/webp"],
      validation_rules: { min_items: 1 },
      access_level: 'admin'
    },
    review_reward_points: {
      description: 'å®¡æ ¸é€šè¿‡å¥–åŠ±ç§¯åˆ†',
      data_type: 'number',
      default_value: 20,
      validation_rules: { min: 1, max: 100 },
      access_level: 'admin'
    },
    auto_approve_threshold: {
      description: 'è‡ªåŠ¨å®¡æ ¸é€šè¿‡é˜ˆå€¼',
      data_type: 'number',
      default_value: 0.95,
      validation_rules: { min: 0.5, max: 1.0 },
      access_level: 'system'
    }
  },
  
  // ç³»ç»Ÿé…ç½®
  system: {
    storage_auto_tier: {
      description: 'è‡ªåŠ¨å­˜å‚¨åˆ†å±‚å¼€å…³',
      data_type: 'boolean',
      default_value: true,
      access_level: 'system'
    },
    thumbnail_sizes: {
      description: 'ç¼©ç•¥å›¾å°ºå¯¸é…ç½®',
      data_type: 'object',
      default_value: {
        "small": "150x150",
        "medium": "300x300", 
        "large": "600x600"
      },
      access_level: 'admin'
    },
    cdn_domain: {
      description: 'CDNåŸŸåé…ç½®',
      data_type: 'string',
      default_value: "https://cdn.restaurant-lottery.com",
      validation_rules: { pattern: "^https?://" },
      access_level: 'system'
    }
  }
};
```

### 3. æ ¸å¿ƒä¸šåŠ¡è¡¨ç»“æ„ä¼˜åŒ–

#### 3.1 ç”¨æˆ·è¡¨å¢å¼ºï¼ˆv2.0æ¶æ„é€‚é…ï¼‰
```sql
-- ğŸ”´ ç”¨æˆ·è¡¨v2.0æ¶æ„å¢å¼º
-- åŸºäºç°æœ‰Userè¡¨ç»“æ„ï¼Œæ–°å¢v2.0ç›¸å…³å­—æ®µ
ALTER TABLE `users` 
ADD COLUMN `avatar_resource_id` VARCHAR(36) NULL 
  COMMENT 'å¤´åƒèµ„æºIDï¼Œå…³è”ImageResourcesè¡¨' AFTER `avatar_url`,
ADD COLUMN `preferences` JSON NULL 
  COMMENT 'ç”¨æˆ·åå¥½è®¾ç½®ï¼š{theme: "dark", language: "zh-CN"}' AFTER `status`,
ADD COLUMN `activity_stats` JSON NULL 
  COMMENT 'æ´»åŠ¨ç»Ÿè®¡ï¼š{uploads: 50, draws: 200, exchanges: 10}' AFTER `preferences`,
ADD COLUMN `storage_quota` BIGINT UNSIGNED NOT NULL DEFAULT 104857600 
  COMMENT 'å­˜å‚¨é…é¢ï¼ˆå­—èŠ‚ï¼Œé»˜è®¤100MBï¼‰' AFTER `activity_stats`,
ADD COLUMN `used_storage` BIGINT UNSIGNED NOT NULL DEFAULT 0 
  COMMENT 'å·²ä½¿ç”¨å­˜å‚¨ï¼ˆå­—èŠ‚ï¼‰' AFTER `storage_quota`,
ADD COLUMN `last_activity_at` TIMESTAMP NULL 
  COMMENT 'æœ€åæ´»åŠ¨æ—¶é—´' AFTER `last_login_at`;

-- æ·»åŠ ç›¸å…³ç´¢å¼•
ALTER TABLE `users`
ADD INDEX `idx_avatar_resource` (`avatar_resource_id`),
ADD INDEX `idx_storage_usage` (`used_storage`, `storage_quota`),
ADD INDEX `idx_last_activity` (`last_activity_at`);

-- æ·»åŠ å¤–é”®çº¦æŸ
ALTER TABLE `users`
ADD CONSTRAINT `fk_users_avatar_resource` 
  FOREIGN KEY (`avatar_resource_id`) REFERENCES `image_resources`(`resource_id`) ON DELETE SET NULL;
```

#### 3.2 ç…§ç‰‡å®¡æ ¸è¡¨v2.0é›†æˆ
```sql
-- ğŸ”´ PhotoReviewè¡¨v2.0æ¶æ„é›†æˆ
-- æ–°å¢ImageResourceså…³è”å­—æ®µ
ALTER TABLE `photo_reviews` 
ADD COLUMN `resource_id` VARCHAR(36) NULL 
  COMMENT 'å…³è”çš„å›¾ç‰‡èµ„æºID' AFTER `merchant_id`,
ADD COLUMN `review_score` INTEGER UNSIGNED NULL 
  COMMENT 'å®¡æ ¸è¯„åˆ†ï¼ˆ0-100åˆ†ï¼‰' AFTER `review_reason`,
ADD COLUMN `review_tags` JSON NULL 
  COMMENT 'å®¡æ ¸æ ‡ç­¾ï¼š["high_quality", "clear_receipt", "valid_consumption"]' AFTER `review_score`,
ADD COLUMN `auto_review_confidence` DECIMAL(3,2) NULL 
  COMMENT 'è‡ªåŠ¨å®¡æ ¸ç½®ä¿¡åº¦ï¼ˆ0.00-1.00ï¼‰' AFTER `review_tags`;

-- æ·»åŠ ç›¸å…³ç´¢å¼•
ALTER TABLE `photo_reviews`
ADD INDEX `idx_resource_id` (`resource_id`),
ADD INDEX `idx_review_score` (`review_score`),
ADD INDEX `idx_auto_confidence` (`auto_review_confidence`);

-- æ·»åŠ å¤–é”®çº¦æŸ
ALTER TABLE `photo_reviews`
ADD CONSTRAINT `fk_photo_reviews_resource` 
  FOREIGN KEY (`resource_id`) REFERENCES `image_resources`(`resource_id`) ON DELETE CASCADE;
```

#### 3.3 å¥–å“è¡¨v2.0å¤šåª’ä½“å¢å¼º
```sql
-- ğŸ”´ Prizeè¡¨v2.0å¤šåª’ä½“èµ„æºå¢å¼º
ALTER TABLE `prizes` 
ADD COLUMN `primary_image_id` VARCHAR(36) NULL 
  COMMENT 'ä¸»å›¾èµ„æºID' AFTER `image_url`,
ADD COLUMN `gallery_images` JSON NULL 
  COMMENT 'å›¾åº“èµ„æºIDæ•°ç»„ï¼š["uuid1", "uuid2", "uuid3"]' AFTER `primary_image_id`,
ADD COLUMN `prize_metadata` JSON NULL 
  COMMENT 'å¥–å“å…ƒæ•°æ®ï¼š{brand: "Apple", model: "iPhone15", color: "Blue"}' AFTER `prize_value`,
ADD COLUMN `display_config` JSON NULL 
  COMMENT 'æ˜¾ç¤ºé…ç½®ï¼š{show_in_wheel: true, highlight: false}' AFTER `prize_metadata`;

-- æ·»åŠ ç›¸å…³ç´¢å¼•
ALTER TABLE `prizes`
ADD INDEX `idx_primary_image` (`primary_image_id`),
ADD INDEX `idx_display_order` (`display_order`, `is_active`);

-- æ·»åŠ å¤–é”®çº¦æŸ
ALTER TABLE `prizes`
ADD CONSTRAINT `fk_prizes_primary_image` 
  FOREIGN KEY (`primary_image_id`) REFERENCES `image_resources`(`resource_id`) ON DELETE SET NULL;
```javascript
// âœ… ä¸šåŠ¡ç±»å‹å’Œåˆ†ç±»æ˜ å°„ï¼ˆåŸºäºå®é™…ä¸šåŠ¡éœ€æ±‚ï¼‰
const BUSINESS_CATEGORIES = {
  lottery: {
    categories: ['prizes', 'wheels', 'results', 'banners'],
    description: 'æŠ½å¥–ä¸šåŠ¡ - å¥–å“å›¾ç‰‡ã€è½¬ç›˜ç´ æã€ç»“æœå±•ç¤ºã€æ´»åŠ¨æ¨ªå¹…'
  },
  exchange: {
    categories: ['products', 'categories', 'promotions'],
    description: 'å…‘æ¢ä¸šåŠ¡ - å•†å“å›¾ç‰‡ã€åˆ†ç±»å›¾ç‰‡ã€ä¿ƒé”€ç´ æ'
  },
  trade: {
    categories: ['items', 'banners', 'transactions'],
    description: 'äº¤æ˜“ä¸šåŠ¡ - å•†å“å›¾ç‰‡ã€äº¤æ˜“æ¨ªå¹…ã€äº¤æ˜“è®°å½•'
  },
  uploads: {
    categories: ['pending_review', 'approved', 'rejected', 'processing'],
    description: 'ç”¨æˆ·ä¸Šä¼  - æ¶ˆè´¹å°ç¥¨å®¡æ ¸å›¾ç‰‡'
  }
};
```

#### 1.3 å­˜å‚¨å±‚çº§ç­–ç•¥
```javascript
// âœ… ä¸‰å±‚å­˜å‚¨ç­–ç•¥ï¼ˆåŸºäºBusinessConfigså®ç°ï¼‰
const STORAGE_LAYERS = {
  hot: {
    description: 'çƒ­å­˜å‚¨ - æ–°ä¸Šä¼ å’Œæ´»è·ƒèµ„æº',
    characteristics: ['å¿«é€Ÿè®¿é—®', 'é«˜æ€§èƒ½SSD', 'ä½å»¶è¿Ÿ', 'é«˜æˆæœ¬'],
    defaultDays: 30,
    useCases: ['æ–°ä¸Šä¼ çš„å›¾ç‰‡', 'é¢‘ç¹è®¿é—®çš„èµ„æº', 'æ´»è·ƒä¸šåŠ¡èµ„æº']
  },
  standard: {
    description: 'æ ‡å‡†å­˜å‚¨ - ä¸­æœŸå­˜å‚¨',
    characteristics: ['å¹³è¡¡æ€§èƒ½å’Œæˆæœ¬', 'æ ‡å‡†è®¿é—®é€Ÿåº¦', 'ä¸­ç­‰æˆæœ¬'],
    defaultDays: 365,
    useCases: ['ä¸­æœŸå­˜å‚¨èµ„æº', 'å®šæœŸè®¿é—®çš„å›¾ç‰‡', 'å†å²ä¸šåŠ¡æ•°æ®']
  },
  archive: {
    description: 'å½’æ¡£å­˜å‚¨ - é•¿æœŸå­˜å‚¨',
    characteristics: ['ä½æˆæœ¬å­˜å‚¨', 'è¾ƒæ…¢è®¿é—®é€Ÿåº¦', 'é•¿æœŸä¿å­˜'],
    defaultDays: 1095, // 3å¹´
    useCases: ['é•¿æœŸå½’æ¡£æ•°æ®', 'åˆè§„æ€§å­˜å‚¨', 'å†å²å¤‡ä»½æ•°æ®']
  }
};
```

### 2. ä¸šåŠ¡é…ç½®è¡¨ - BusinessConfigs

#### 2.1 è¡¨ç»“æ„è®¾è®¡ï¼ˆåŸºäºmodels/BusinessConfigs.jså®ç°ï¼‰
```sql
-- âœ… ä¸šåŠ¡é…ç½®ç®¡ç†è¡¨ï¼ˆå®é™…è¡¨ç»“æ„ï¼‰
CREATE TABLE `business_configs` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'é…ç½®ID',
  
  `business_type` ENUM('lottery', 'exchange', 'trade', 'uploads') NOT NULL UNIQUE 
    COMMENT 'ä¸šåŠ¡ç±»å‹',
  
  -- å­˜å‚¨ç­–ç•¥é…ç½®
  `storage_policy` JSON NOT NULL 
    COMMENT 'å­˜å‚¨ç­–ç•¥ï¼š{hotDays: 30, standardDays: 365, archiveDays: 1095}',
  
  -- æ–‡ä»¶è§„åˆ™é…ç½®
  `file_rules` JSON NOT NULL 
    COMMENT 'æ–‡ä»¶è§„åˆ™ï¼š{maxFileSize: 10MB, allowedTypes: ["jpg"], categories: []}',
  
  -- ç¼“å­˜é…ç½®
  `cache_config` JSON 
    COMMENT 'ç¼“å­˜é…ç½®ï¼š{ttl: 300000, maxSize: 1000}',
  
  -- æ‰©å±•é…ç½®
  `extended_config` JSON 
    COMMENT 'æ‰©å±•é…ç½®ï¼šä¸šåŠ¡ç‰¹å®šçš„å…¶ä»–é…ç½®',
  
  `status` ENUM('active', 'inactive') NOT NULL DEFAULT 'active' 
    COMMENT 'é…ç½®çŠ¶æ€',
  
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  
  -- ç´¢å¼•è®¾è®¡
  UNIQUE INDEX `idx_business_type` (`business_type`),
  INDEX `idx_status` (`status`)
  
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci 
  COMMENT='v2.0ä¸šåŠ¡é…ç½®ç®¡ç†è¡¨';
```

#### 2.2 é»˜è®¤é…ç½®æ•°æ®
```javascript
// âœ… é»˜è®¤ä¸šåŠ¡é…ç½®ï¼ˆåŸºäºBusinessConfigs.getDefaultConfigå®ç°ï¼‰
const DEFAULT_BUSINESS_CONFIGS = {
  lottery: {
    business_type: 'lottery',
    storage_policy: {
      hotDays: 30,
      standardDays: 365,
      archiveDays: 1095
    },
    file_rules: {
      maxFileSize: 10485760, // 10MB
      allowedTypes: ['jpg', 'jpeg', 'png', 'webp'],
      categories: ['prizes', 'wheels', 'results', 'banners']
    },
    cache_config: {
      ttl: 300000, // 5åˆ†é’Ÿ
      maxSize: 1000
    }
  },
  
  exchange: {
    business_type: 'exchange',
    storage_policy: {
      hotDays: 60,
      standardDays: 730,
      archiveDays: 2190
    },
    file_rules: {
      maxFileSize: 15728640, // 15MB
      allowedTypes: ['jpg', 'jpeg', 'png', 'webp'],
      categories: ['products', 'categories', 'promotions']
    }
  },
  
  trade: {
    business_type: 'trade',
    storage_policy: {
      hotDays: 45,
      standardDays: 545,
      archiveDays: 1825
    },
    file_rules: {
      maxFileSize: 12582912, // 12MB
      allowedTypes: ['jpg', 'jpeg', 'png', 'webp'],
      categories: ['items', 'banners', 'transactions']
    }
  },
  
  uploads: {
    business_type: 'uploads',
    storage_policy: {
      hotDays: 7,
      standardDays: 1095,
      archiveDays: 2190
    },
    file_rules: {
      maxFileSize: 20971520, // 20MB
      allowedTypes: ['jpg', 'jpeg', 'png', 'webp'],
      categories: ['pending_review', 'approved', 'rejected', 'processing']
    }
  }
};
```

### 3. æ•°æ®åº“è¿æ¥å’Œé…ç½®

#### 3.1 æ•°æ®åº“è¿æ¥é…ç½®ï¼ˆåŸºäºconfig/database.jså®ç°ï¼‰
```javascript
// âœ… æ•°æ®åº“è¿æ¥é…ç½®ï¼ˆå®é™…ä»£ç å®ç°ï¼‰
const DATABASE_CONFIG = {
  development: {
    host: 'test-db-mysql.ns-br0za7uc.svc',
    port: 3306,
    username: 'root',
    password: 'mc6r9cgb',
    database: 'restaurant_points_dev',
    dialect: 'mysql',
    timezone: '+08:00',
    pool: {
      max: 20,
      min: 0,
      acquire: 30000,
      idle: 10000
    }
  },
  
  production: {
    host: 'dbconn.sealosbja.site',
    port: 42182,
    username: 'root',
    password: 'mc6r9cgb',
    database: 'restaurant_points_prod',
    dialect: 'mysql',
    timezone: '+08:00',
    pool: {
      max: 50,
      min: 5,
      acquire: 60000,
      idle: 10000
    }
  }
};
```

#### 3.2 Sequelize ORMé…ç½®
```javascript
// âœ… Sequelizeé…ç½®ï¼ˆåŸºäºmodels/index.jså®ç°ï¼‰
const sequelize = new Sequelize(
  process.env.DB_NAME || 'restaurant_points_dev',
  process.env.DB_USER || 'root', 
  process.env.DB_PASSWORD || 'mc6r9cgb',
  {
    host: process.env.DB_HOST || 'test-db-mysql.ns-br0za7uc.svc',
    port: parseInt(process.env.DB_PORT) || 3306,
    dialect: 'mysql',
    logging: process.env.NODE_ENV !== 'production' ? console.log : false,
    pool: {
      max: 10,
      min: 0,
      acquire: 30000,
      idle: 10000
    },
    define: {
      freezeTableName: true,
      underscored: true,
      charset: 'utf8mb4',
      collate: 'utf8mb4_unicode_ci'
    },
    timezone: '+08:00'
  }
);
```

## ğŸ”§ æ•°æ®æ¨¡å‹å…³è”è®¾è®¡

### å…³è”å…³ç³»å®šä¹‰ï¼ˆåŸºäºå®é™…ä»£ç å®ç°ï¼‰
```javascript
// âœ… æ•°æ®æ¨¡å‹å…³è”å…³ç³»ï¼ˆåŸºäºmodels/index.jså®ç°ï¼‰
const MODEL_ASSOCIATIONS = {
  // ImageResourceså…³è”å…³ç³»
  ImageResources: {
    // å…³è”ä¸Šä¼ ç”¨æˆ·
    belongsTo_uploader: {
      model: 'User',
      foreignKey: 'user_id',
      as: 'uploader',
      constraints: false
    },
    
    // å…³è”å®¡æ ¸å‘˜
    belongsTo_reviewer: {
      model: 'User',
      foreignKey: 'reviewer_id',
      as: 'reviewer',
      constraints: false
    }
  },
  
  // Userå…³è”å…³ç³»ï¼ˆå¤–éƒ¨æ¨¡å‹ï¼‰
  User: {
    // ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡èµ„æº
    hasMany_uploads: {
      model: 'ImageResources',
      foreignKey: 'user_id',
      as: 'uploads'
    },
    
    // ç”¨æˆ·å®¡æ ¸çš„å›¾ç‰‡èµ„æº
    hasMany_reviews: {
      model: 'ImageResources',
      foreignKey: 'reviewer_id',
      as: 'reviews'
    }
  }
};
```

## ğŸ“Š æŸ¥è¯¢ä¼˜åŒ–å’Œç´¢å¼•è®¾è®¡

### 1. æ ¸å¿ƒæŸ¥è¯¢æ¨¡å¼åˆ†æ
```javascript
// âœ… æ ¸å¿ƒæŸ¥è¯¢æ¨¡å¼ï¼ˆåŸºäºå®é™…ä¸šåŠ¡éœ€æ±‚ï¼‰
const QUERY_PATTERNS = {
  // ä¸šåŠ¡èµ„æºæŸ¥è¯¢
  findByBusiness: {
    sql: 'SELECT * FROM image_resources WHERE business_type = ? AND category = ? AND status = ?',
    index: 'idx_business_category',
    frequency: 'HIGH'
  },
  
  // ç”¨æˆ·ä¸Šä¼ æŸ¥è¯¢
  findUserUploads: {
    sql: 'SELECT * FROM image_resources WHERE user_id = ? AND business_type = ? AND status = ?',
    index: 'idx_user_business',
    frequency: 'HIGH'
  },
  
  // å®¡æ ¸å·¥ä½œå°æŸ¥è¯¢
  findPendingReviews: {
    sql: 'SELECT * FROM image_resources WHERE review_status = "pending" AND business_type = ? ORDER BY created_at ASC',
    index: 'idx_review_status',
    frequency: 'MEDIUM'
  },
  
  // å­˜å‚¨åˆ†å±‚æŸ¥è¯¢
  findByStorageLayer: {
    sql: 'SELECT * FROM image_resources WHERE storage_layer = ? AND created_at < ?',
    index: 'idx_storage_layer',
    frequency: 'LOW'
  },
  
  // ä¸Šä¸‹æ–‡èµ„æºæŸ¥è¯¢
  findByContext: {
    sql: 'SELECT * FROM image_resources WHERE context_id = ? AND category = ? AND status = ?',
    index: 'idx_context_category',
    frequency: 'MEDIUM'
  }
};
```

### 2. ç´¢å¼•è®¾è®¡ç­–ç•¥
```sql
-- âœ… ç´¢å¼•è®¾è®¡ï¼ˆåŸºäºå®é™…æŸ¥è¯¢éœ€æ±‚ä¼˜åŒ–ï¼‰

-- ä¸»ä¸šåŠ¡æŸ¥è¯¢ç´¢å¼•ï¼ˆé«˜é¢‘æŸ¥è¯¢ï¼‰
CREATE INDEX `idx_business_category` ON `image_resources` (`business_type`, `category`);
CREATE INDEX `idx_user_business` ON `image_resources` (`user_id`, `business_type`, `status`);

-- å®¡æ ¸å·¥ä½œå°ç´¢å¼•ï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼‰
CREATE INDEX `idx_review_status` ON `image_resources` (`review_status`, `business_type`, `created_at`);

-- å­˜å‚¨åˆ†å±‚ç®¡ç†ç´¢å¼•ï¼ˆåå°ä»»åŠ¡ï¼‰
CREATE INDEX `idx_storage_layer` ON `image_resources` (`storage_layer`, `created_at`);

-- ä¸Šä¸‹æ–‡æŸ¥è¯¢ç´¢å¼•ï¼ˆä¸šåŠ¡å…³è”ï¼‰
CREATE INDEX `idx_context_category` ON `image_resources` (`context_id`, `category`, `status`);

-- æ—¶é—´èŒƒå›´æŸ¥è¯¢ç´¢å¼•ï¼ˆç»Ÿè®¡åˆ†æï¼‰
CREATE INDEX `idx_created_status` ON `image_resources` (`created_at`, `status`);

-- è®¿é—®ç»Ÿè®¡ç´¢å¼•ï¼ˆæ€§èƒ½ç›‘æ§ï¼‰
CREATE INDEX `idx_access_count` ON `image_resources` (`access_count`, `last_accessed_at`);
```

### 3. æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–å»ºè®®
```javascript
// âœ… æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
const QUERY_OPTIMIZATION = {
  // åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
  pagination: {
    strategy: 'LIMIT + OFFSET with ORDER BY indexed column',
    recommendation: 'ä½¿ç”¨ created_at æˆ– resource_id ä½œä¸ºæ’åºå­—æ®µ',
    example: 'ORDER BY created_at DESC LIMIT 20 OFFSET 0'
  },
  
  // å¤åˆæŸ¥è¯¢ä¼˜åŒ–
  complexQuery: {
    strategy: 'Use covering indexes and avoid SELECT *',
    recommendation: 'åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µï¼Œåˆ©ç”¨è¦†ç›–ç´¢å¼•',
    example: 'SELECT resource_id, business_type, category FROM image_resources'
  },
  
  // JOINæŸ¥è¯¢ä¼˜åŒ–
  joinQuery: {
    strategy: 'Use proper foreign key indexes',
    recommendation: 'ç¡®ä¿JOINå­—æ®µéƒ½æœ‰ç´¢å¼•ï¼Œé¿å…å¤§è¡¨JOIN',
    example: 'JOIN users u ON ir.user_id = u.user_id'
  },
  
  // ç»Ÿè®¡æŸ¥è¯¢ä¼˜åŒ–
  aggregateQuery: {
    strategy: 'Use summary tables for complex aggregations',
    recommendation: 'å¤æ‚ç»Ÿè®¡ä½¿ç”¨æ±‡æ€»è¡¨æˆ–ç¼“å­˜',
    example: 'CREATE TABLE image_stats AS SELECT business_type, COUNT(*) as total FROM image_resources GROUP BY business_type'
  }
};
```

## ğŸ”’ æ•°æ®å®‰å…¨å’Œå®Œæ•´æ€§

### 1. æ•°æ®å®Œæ•´æ€§çº¦æŸ
```sql
-- âœ… æ•°æ®å®Œæ•´æ€§çº¦æŸè®¾è®¡

-- ä¸šåŠ¡ç±»å‹çº¦æŸ
ALTER TABLE `image_resources` 
ADD CONSTRAINT `chk_business_type` 
CHECK (`business_type` IN ('lottery', 'exchange', 'trade', 'uploads'));

-- å­˜å‚¨å±‚çº§çº¦æŸ
ALTER TABLE `image_resources` 
ADD CONSTRAINT `chk_storage_layer` 
CHECK (`storage_layer` IN ('hot', 'standard', 'archive'));

-- æ–‡ä»¶å¤§å°çº¦æŸ
ALTER TABLE `image_resources` 
ADD CONSTRAINT `chk_file_size` 
CHECK (`file_size` > 0 AND `file_size` <= 21474836480); -- æœ€å¤§20GB

-- å®¡æ ¸çŠ¶æ€çº¦æŸ
ALTER TABLE `image_resources` 
ADD CONSTRAINT `chk_review_consistency` 
CHECK (
  (business_type = 'uploads' AND review_status IS NOT NULL) OR 
  (business_type != 'uploads' AND review_status IS NULL)
);

-- è®¿é—®è®¡æ•°çº¦æŸ
ALTER TABLE `image_resources` 
ADD CONSTRAINT `chk_access_count` 
CHECK (`access_count` >= 0);
```

### 2. æ•°æ®å®‰å…¨ç­–ç•¥
```javascript
// âœ… æ•°æ®å®‰å…¨ç­–ç•¥
const DATA_SECURITY = {
  // æ•æ„Ÿæ•°æ®å¤„ç†
  sensitiveData: {
    filePathEncryption: 'æ–‡ä»¶è·¯å¾„åŠ å¯†å­˜å‚¨',
    metadataFiltering: 'å…ƒæ•°æ®æ•æ„Ÿä¿¡æ¯è¿‡æ»¤',
    urlSigning: 'CDN URLç­¾åè®¿é—®æ§åˆ¶'
  },
  
  // è®¿é—®æ§åˆ¶
  accessControl: {
    userIsolation: 'ç”¨æˆ·æ•°æ®éš”ç¦»ï¼šç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„ä¸Šä¼ ',
    adminPermission: 'ç®¡ç†å‘˜æƒé™ï¼šå®¡æ ¸å’Œç®¡ç†æ‰€æœ‰èµ„æº',
    businessIsolation: 'ä¸šåŠ¡æ¨¡å—éš”ç¦»ï¼šä¸åŒä¸šåŠ¡æ¨¡å—æ•°æ®åˆ†ç¦»'
  },
  
  // æ•°æ®å¤‡ä»½
  dataBackup: {
    regularBackup: 'å®šæœŸå…¨é‡å¤‡ä»½ï¼šæ¯æ—¥å‡Œæ™¨2ç‚¹',
    incrementalBackup: 'å¢é‡å¤‡ä»½ï¼šæ¯4å°æ—¶ä¸€æ¬¡',
    retentionPolicy: 'å¤‡ä»½ä¿ç•™ï¼šå…¨é‡å¤‡ä»½ä¿ç•™30å¤©ï¼Œå¢é‡å¤‡ä»½ä¿ç•™7å¤©'
  },
  
  // æ—¥å¿—å®¡è®¡
  auditLog: {
    operationLog: 'è®°å½•æ‰€æœ‰æ•°æ®ä¿®æ”¹æ“ä½œ',
    accessLog: 'è®°å½•æ•æ„Ÿæ•°æ®è®¿é—®',
    retentionPeriod: 'æ—¥å¿—ä¿ç•™90å¤©'
  }
};
```

## ğŸ“ˆ ç›‘æ§å’Œç»´æŠ¤

### 1. æ€§èƒ½ç›‘æ§æŒ‡æ ‡
```javascript
// âœ… æ•°æ®åº“æ€§èƒ½ç›‘æ§æŒ‡æ ‡
const MONITORING_METRICS = {
  // æŸ¥è¯¢æ€§èƒ½
  queryPerformance: {
    slowQueryThreshold: '100ms',
    monitoring: [
      'SELECTæŸ¥è¯¢å¹³å‡å“åº”æ—¶é—´',
      'INSERT/UPDATE/DELETEæ“ä½œå“åº”æ—¶é—´',
      'å¤æ‚èšåˆæŸ¥è¯¢æ€§èƒ½',
      'ç´¢å¼•ä½¿ç”¨æ•ˆç‡'
    ]
  },
  
  // å­˜å‚¨ç›‘æ§
  storageMonitoring: {
    metrics: [
      'è¡¨å¤§å°å¢é•¿è¶‹åŠ¿',
      'ç´¢å¼•å¤§å°å’Œç¢ç‰‡ç‡',
      'å­˜å‚¨å±‚çº§åˆ†å¸ƒç»Ÿè®¡',
      'ç£ç›˜ç©ºé—´ä½¿ç”¨ç‡'
    ]
  },
  
  // è¿æ¥æ± ç›‘æ§
  connectionPool: {
    metrics: [
      'æ´»è·ƒè¿æ¥æ•°',
      'è¿æ¥æ± ä½¿ç”¨ç‡',
      'è¿æ¥è·å–ç­‰å¾…æ—¶é—´',
      'è¿æ¥è¶…æ—¶é¢‘ç‡'
    ]
  }
};
```

### 2. å®šæœŸç»´æŠ¤ä»»åŠ¡
```javascript
// âœ… å®šæœŸç»´æŠ¤ä»»åŠ¡
const MAINTENANCE_TASKS = {
  // å­˜å‚¨å±‚çº§è¿ç§»
  storageLayerMigration: {
    frequency: 'DAILY',
    description: 'æ ¹æ®è®¿é—®æ—¶é—´å’Œä¸šåŠ¡é…ç½®è‡ªåŠ¨è¿ç§»å­˜å‚¨å±‚çº§',
    sql: `
      UPDATE image_resources 
      SET storage_layer = 'standard' 
      WHERE storage_layer = 'hot' 
        AND created_at < DATE_SUB(NOW(), INTERVAL 30 DAY)
    `
  },
  
  // ç´¢å¼•ä¼˜åŒ–
  indexOptimization: {
    frequency: 'WEEKLY',
    description: 'åˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µï¼Œä¼˜åŒ–ç´¢å¼•ç»“æ„',
    tasks: [
      'ANALYZE TABLE image_resources',
      'CHECK TABLE image_resources',
      'OPTIMIZE TABLE image_resources'
    ]
  },
  
  // æ•°æ®æ¸…ç†
  dataCleaning: {
    frequency: 'MONTHLY',
    description: 'æ¸…ç†è½¯åˆ é™¤æ•°æ®å’Œè¿‡æœŸä¸´æ—¶æ•°æ®',
    sql: `
      DELETE FROM image_resources 
      WHERE status = 'deleted' 
        AND deleted_at < DATE_SUB(NOW(), INTERVAL 90 DAY)
    `
  },
  
  // ç»Ÿè®¡ä¿¡æ¯æ›´æ–°
  statisticsUpdate: {
    frequency: 'DAILY',
    description: 'æ›´æ–°ä¸šåŠ¡ç»Ÿè®¡ä¿¡æ¯',
    tasks: [
      'æ›´æ–°æ¯æ—¥ä¸Šä¼ ç»Ÿè®¡',
      'æ›´æ–°å­˜å‚¨å±‚çº§åˆ†å¸ƒ',
      'æ›´æ–°ä¸šåŠ¡æ¨¡å—ä½¿ç”¨æƒ…å†µ'
    ]
  }
};
```

## ğŸ”„ æ•°æ®è¿ç§»å’Œç‰ˆæœ¬æ§åˆ¶

### 1. æ•°æ®åº“ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥
```javascript
// âœ… æ•°æ®åº“ç‰ˆæœ¬æ§åˆ¶
const DATABASE_VERSIONING = {
  // ç‰ˆæœ¬å‘½åè§„èŒƒ
  versionNaming: {
    format: 'YYYYMMDD_HHMMSS_description',
    example: '20250728_184500_add_storage_layer_column'
  },
  
  // è¿ç§»è„šæœ¬ç®¡ç†
  migrationScripts: {
    location: 'database/migrations/',
    naming: 'sequential_timestamp_description.sql',
    rollback: 'each migration must have rollback script'
  },
  
  // ç¯å¢ƒç®¡ç†
  environmentManagement: {
    development: 'å¼€å‘ç¯å¢ƒï¼šè‡ªç”±æµ‹è¯•å’Œè°ƒè¯•',
    staging: 'é¢„å‘å¸ƒç¯å¢ƒï¼šç”Ÿäº§æ•°æ®å¤‡ä»½æµ‹è¯•',
    production: 'ç”Ÿäº§ç¯å¢ƒï¼šä¸¥æ ¼å˜æ›´æ§åˆ¶'
  }
};
```

### 2. æ•°æ®è¿ç§»æœ€ä½³å®è·µ
```sql
-- âœ… æ•°æ®è¿ç§»ç¤ºä¾‹

-- æ·»åŠ æ–°åˆ—ï¼ˆå‘åå…¼å®¹ï¼‰
ALTER TABLE `image_resources` 
ADD COLUMN `new_field` VARCHAR(100) NULL COMMENT 'æ–°å¢å­—æ®µ' 
AFTER `existing_field`;

-- ä¿®æ”¹åˆ—å®šä¹‰ï¼ˆéœ€è¦æ•°æ®è¿ç§»ï¼‰
-- Step 1: æ·»åŠ æ–°åˆ—
ALTER TABLE `image_resources` 
ADD COLUMN `new_column` JSON NULL;

-- Step 2: è¿ç§»æ•°æ®
UPDATE `image_resources` 
SET `new_column` = JSON_OBJECT('old_value', `old_column`)
WHERE `old_column` IS NOT NULL;

-- Step 3: åˆ é™¤æ—§åˆ—ï¼ˆç¡®è®¤æ•°æ®æ­£ç¡®åï¼‰
-- ALTER TABLE `image_resources` DROP COLUMN `old_column`;

-- æ·»åŠ ç´¢å¼•ï¼ˆåœ¨çº¿DDLï¼‰
CREATE INDEX `idx_new_field` ON `image_resources` (`new_field`) ALGORITHM=INPLACE, LOCK=NONE;
```

## ğŸ“‹ å¼€å‘æŒ‡å¯¼å’Œæœ€ä½³å®è·µ

### 1. Sequelizeæ¨¡å‹å¼€å‘è§„èŒƒ
```javascript
// âœ… Sequelizeæ¨¡å‹æœ€ä½³å®è·µï¼ˆåŸºäºå®é™…ä»£ç ï¼‰

// æ¨¡å‹å®šä¹‰è§„èŒƒ
const ImageResources = sequelize.define('ImageResources', {
  // ä½¿ç”¨UUIDä¸»é”®
  resource_id: {
    type: DataTypes.UUID,
    defaultValue: () => uuidv4(),
    primaryKey: true,
    comment: 'èµ„æºå”¯ä¸€æ ‡è¯†ç¬¦'
  },
  
  // æšä¸¾ç±»å‹ä½¿ç”¨
  business_type: {
    type: DataTypes.ENUM('lottery', 'exchange', 'trade', 'uploads'),
    allowNull: false,
    comment: 'ä¸šåŠ¡ç±»å‹'
  },
  
  // JSONå­—æ®µä½¿ç”¨
  thumbnail_paths: {
    type: DataTypes.JSON,
    allowNull: true,
    comment: 'ç¼©ç•¥å›¾è·¯å¾„é›†åˆ'
  }
}, {
  // è¡¨é…ç½®
  tableName: 'image_resources',
  timestamps: true,
  createdAt: 'created_at',
  updatedAt: 'updated_at',
  paranoid: true, // è½¯åˆ é™¤
  deletedAt: 'deleted_at',
  
  // ç´¢å¼•å®šä¹‰
  indexes: [
    {
      name: 'idx_business_category',
      fields: ['business_type', 'category']
    }
  ]
});

// å®ä¾‹æ–¹æ³•
ImageResources.prototype.toSafeJSON = function() {
  const values = this.get({ plain: true });
  delete values.file_path; // ç§»é™¤æ•æ„Ÿä¿¡æ¯
  return values;
};

// ç±»æ–¹æ³•
ImageResources.findByBusiness = function(businessType, category, options = {}) {
  return this.findAndCountAll({
    where: {
      business_type: businessType,
      category: category,
      status: 'active'
    },
    ...options
  });
};
```

### 2. æŸ¥è¯¢ä¼˜åŒ–æŒ‡å¯¼
```javascript
// âœ… æŸ¥è¯¢ä¼˜åŒ–æŒ‡å¯¼

// é«˜æ•ˆçš„åˆ†é¡µæŸ¥è¯¢
const getResourcesPaginated = async (options) => {
  const { 
    businessType, 
    category, 
    limit = 20, 
    offset = 0,
    orderBy = 'created_at',
    order = 'DESC'
  } = options;
  
  return await ImageResources.findAndCountAll({
    where: {
      business_type: businessType,
      category: category,
      status: 'active'
    },
    attributes: {
      exclude: ['file_path', 'metadata'] // æ’é™¤ä¸éœ€è¦çš„å­—æ®µ
    },
    limit: parseInt(limit),
    offset: parseInt(offset),
    order: [[orderBy, order]],
    // ä½¿ç”¨rawæŸ¥è¯¢æé«˜æ€§èƒ½
    raw: false,
    nest: true
  });
};

// æ‰¹é‡æ“ä½œä¼˜åŒ–
const batchUpdateStorageLayer = async (resourceIds, newLayer) => {
  return await ImageResources.update(
    { storage_layer: newLayer },
    {
      where: {
        resource_id: {
          [Op.in]: resourceIds
        }
      },
      // è¿”å›æ›´æ–°çš„è®°å½•æ•°
      returning: false
    }
  );
};

// äº‹åŠ¡å¤„ç†ç¤ºä¾‹
const createResourceWithTransaction = async (resourceData) => {
  const transaction = await sequelize.transaction();
  
  try {
    const resource = await ImageResources.create(resourceData, { transaction });
    
    // å…¶ä»–ç›¸å…³æ“ä½œ
    await updateBusinessStats(resource.business_type, { transaction });
    
    await transaction.commit();
    return resource;
  } catch (error) {
    await transaction.rollback();
    throw error;
  }
};
```

### 3. é”™è¯¯å¤„ç†å’Œè°ƒè¯•
```javascript
// âœ… é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

// æ•°æ®åº“è¿æ¥é”™è¯¯å¤„ç†
const handleDatabaseError = (error) => {
  const errorTypes = {
    'ER_DUP_ENTRY': {
      code: 'DUPLICATE_ENTRY',
      message: 'æ•°æ®é‡å¤ï¼Œè¯·æ£€æŸ¥å”¯ä¸€æ€§çº¦æŸ'
    },
    'ER_NO_REFERENCED_ROW_2': {
      code: 'FOREIGN_KEY_CONSTRAINT',
      message: 'å¤–é”®çº¦æŸå¤±è´¥ï¼Œç›¸å…³è®°å½•ä¸å­˜åœ¨'
    },
    'ER_DATA_TOO_LONG': {
      code: 'DATA_TOO_LONG',
      message: 'æ•°æ®é•¿åº¦è¶…å‡ºå­—æ®µé™åˆ¶'
    }
  };
  
  const errorInfo = errorTypes[error.original?.code] || {
    code: 'DATABASE_ERROR',
    message: 'æ•°æ®åº“æ“ä½œå¤±è´¥'
  };
  
  return {
    ...errorInfo,
    details: error.message,
    sql: error.sql
  };
};

// è°ƒè¯•ä¿¡æ¯æ”¶é›†
const debugQuery = async (queryFunction, context) => {
  const startTime = Date.now();
  
  try {
    const result = await queryFunction();
    const duration = Date.now() - startTime;
    
    console.log(`âœ… Query success: ${context}`, {
      duration: `${duration}ms`,
      resultCount: Array.isArray(result) ? result.length : 1
    });
    
    return result;
  } catch (error) {
    const duration = Date.now() - startTime;
    
    console.error(`âŒ Query failed: ${context}`, {
      duration: `${duration}ms`,
      error: handleDatabaseError(error)
    });
    
    throw error;
  }
};
```

## ğŸ¯ æ€»ç»“å’Œå®æ–½å»ºè®®

### æ ¸å¿ƒè®¾è®¡åŸåˆ™
1. **ç»Ÿä¸€èµ„æºç®¡ç†**ï¼šé€šè¿‡ImageResourcesè¡¨ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ä¸šåŠ¡æ¨¡å—çš„å›¾ç‰‡èµ„æº
2. **æ™ºèƒ½åˆ†å±‚å­˜å‚¨**ï¼šåŸºäºè®¿é—®æ¨¡å¼å’Œæ—¶é—´ç­–ç•¥çš„ä¸‰å±‚å­˜å‚¨æ¶æ„
3. **ä¸šåŠ¡æ¨¡å—åŒ–**ï¼šæ”¯æŒlotteryã€exchangeã€tradeã€uploadså››å¤§ä¸šåŠ¡æ¨¡å—
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šåŸºäºå®é™…æŸ¥è¯¢æ¨¡å¼è®¾è®¡ç´¢å¼•å’Œä¼˜åŒ–ç­–ç•¥
5. **æ•°æ®å®‰å…¨**ï¼šå®Œæ•´çš„è®¿é—®æ§åˆ¶ã€æ•°æ®åŠ å¯†å’Œå®¡è®¡æ—¥å¿—

### å®æ–½ä¼˜å…ˆçº§
1. **P0çº§**ï¼šæ ¸å¿ƒè¡¨ç»“æ„åˆ›å»ºå’ŒåŸºç¡€ç´¢å¼•
2. **P1çº§**ï¼šä¸šåŠ¡é…ç½®è¡¨å’Œå…³è”å…³ç³»
3. **P2çº§**ï¼šæ€§èƒ½ä¼˜åŒ–ç´¢å¼•å’Œç›‘æ§
4. **P3çº§**ï¼šé«˜çº§åŠŸèƒ½å’Œç»´æŠ¤ä»»åŠ¡

### æ³¨æ„äº‹é¡¹
- å¼€å‘é˜¶æ®µä¿æŒæ•°æ®ç»“æ„çš„çµæ´»æ€§
- ç”Ÿäº§ç¯å¢ƒä¸¥æ ¼æ§åˆ¶ç»“æ„å˜æ›´
- å®šæœŸç›‘æ§æ€§èƒ½å’Œå­˜å‚¨ä½¿ç”¨æƒ…å†µ
- å»ºç«‹å®Œå–„çš„å¤‡ä»½å’Œæ¢å¤æœºåˆ¶

**æ ¸å¿ƒåŸåˆ™**ï¼šæ•°æ®ä¸€è‡´æ€§ä¼˜å…ˆã€æ€§èƒ½å…¼é¡¾ã€å®‰å…¨ä¿éšœã€å¯ç»´æŠ¤æ€§å¼ºã€æ‰©å±•æ€§å¥½ 