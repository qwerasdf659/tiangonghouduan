# 数据库设计规范文档标准 - v2.0多业务线分层存储架构版本

**文档版本**: v2.4.0  
**更新时间**: 2025年07月28日  
**技术栈**: Node.js + Express + MySQL + Sequelize + v2.0分层存储架构  
**数据库**: MySQL 8.0+ (test-db-mysql.ns-br0za7uc.svc:3306)
**使用模型**: Claude Sonnet 4
**代码验证**: 基于models/目录实际运行代码（ImageResources.js 311行，BusinessConfigs.js 196行等）
**产品对接**: 100%符合餐厅积分抽奖系统v2.0多业务线分层存储架构，确保前后端数据库对接工作

## 📋 重大更新内容（v2.4.0 - 2025年07月28日）

### 🔴 v2.0架构核心变革（2025年07月28日）
> **🆕 架构升级**：从传统单业务存储升级为多业务线分层存储架构

#### v2.0架构核心特性
```javascript
// 🔴 v2.0多业务线分层存储架构（基于实际代码实现）
const ARCHITECTURE_V2_FEATURES = {
  // 统一资源管理
  unifiedResourceManagement: {
    model: 'ImageResources',
    description: '统一管理所有业务模块的图片资源',
    keyFeatures: [
      'UUID主键确保全局唯一性',
      '多业务类型支持：lottery/exchange/trade/uploads',
      '智能分层存储：hot/standard/archive',
      '自动缩略图生成和管理',
      '访问统计和性能监控',
      '完整的审核流程支持'
    ]
  },
  
  // 智能分层存储
  intelligentStorageLayers: {
    hot: {
      purpose: '热存储 - 新上传和活跃资源',
      performance: '快速访问，低延迟',
      cost: '高成本',
      defaultDays: 30
    },
    standard: {
      purpose: '标准存储 - 中期存储',
      performance: '平衡性能和成本',
      cost: '中等成本',
      defaultDays: 365
    },
    archive: {
      purpose: '归档存储 - 长期存储',
      performance: '较慢访问速度',
      cost: '低成本',
      defaultDays: 1095 // 3年
    }
  },
  
  // 业务模块化
  businessModularization: {
    lottery: '抽奖业务 - 奖品、转盘、横幅图片管理',
    exchange: '兑换业务 - 商品、分类、促销图片管理',
    trade: '交易业务 - 商品、横幅、交易图片管理',
    uploads: '用户上传 - 消费小票审核图片管理'
  }
};
```

### 🔴 数据库架构简化（v2.0确认版）
> **⚠️ 重要变更**：数据库架构从复杂多表设计简化为核心3表设计

#### 实际数据库表结构（基于models/目录）
```javascript
// ✅ v2.0核心数据模型（基于实际代码实现）
const DATABASE_MODELS_V2 = {
  // 核心表：统一图片资源管理
  ImageResources: {
    file: 'models/ImageResources.js',
    lines: 311,
    description: '统一图片资源管理表',
    tableName: 'image_resources'
  },
  
  // 配置表：业务配置管理
  BusinessConfigs: {
    file: 'models/BusinessConfigs.js', 
    lines: 196,
    description: '业务配置管理表',
    tableName: 'business_configs'
  },
  
  // 用户表：用户信息管理（外部依赖）
  Users: {
    description: '用户信息管理表（已存在）',
    tableName: 'users',
    keyFields: ['user_id', 'mobile', 'nickname', 'is_admin']
  }
};
```

### 🚧 开发阶段数据库适配
> **⚠️ 重要提醒**：当前为开发阶段，数据库设计需要适配以下开发限制：

- 📱 **短信验证字段**: 数据库保留相关字段但开发阶段不实际验证
- 🔐 **统一登录方式**: 所有用户（包括管理员）使用手机号+验证码123456登录
- 📸 **拍照上传简化**: ImageResources表适配用户仅上传照片的简化版本
- 💡 **权限字段**: 简化为is_admin单一字段，商家管理功能通过管理员权限统一控制

## 🏗️ v2.0核心数据模型设计

### 1. 统一图片资源表 - ImageResources

#### 1.1 表结构设计（基于models/ImageResources.js实现）
```sql
-- ✅ 统一图片资源管理表（实际表结构）
CREATE TABLE `image_resources` (
  -- 主键和标识
  `resource_id` VARCHAR(36) PRIMARY KEY COMMENT '资源唯一标识符（UUID）',
  
  -- 业务分类字段
  `business_type` ENUM('lottery', 'exchange', 'trade', 'uploads') NOT NULL 
    COMMENT '业务类型：抽奖/兑换/交易/上传',
  `category` VARCHAR(50) NOT NULL 
    COMMENT '资源分类：prizes/products/items/pending_review等',
  `context_id` INTEGER NOT NULL 
    COMMENT '上下文ID：用户ID/奖品ID/商品ID等',
  `user_id` INTEGER 
    COMMENT '关联用户ID（上传用户）',
  
  -- 存储架构字段
  `storage_layer` ENUM('hot', 'standard', 'archive') NOT NULL DEFAULT 'hot' 
    COMMENT '存储层级：热存储/标准存储/归档存储',
  `file_path` VARCHAR(500) NOT NULL 
    COMMENT '文件存储路径',
  `cdn_url` VARCHAR(500) NOT NULL 
    COMMENT 'CDN访问URL',
  `thumbnail_paths` JSON 
    COMMENT '缩略图路径集合：{small: "", medium: "", large: ""}',
  
  -- 文件信息
  `original_filename` VARCHAR(255) NOT NULL 
    COMMENT '原始文件名',
  `file_size` INTEGER NOT NULL 
    COMMENT '文件大小（字节）',
  `mime_type` VARCHAR(100) NOT NULL 
    COMMENT 'MIME类型',
  `dimensions` JSON 
    COMMENT '图片尺寸：{width: 1920, height: 1080}',
  
  -- 状态管理
  `status` ENUM('active', 'archived', 'deleted') NOT NULL DEFAULT 'active' 
    COMMENT '资源状态',
  `access_count` INTEGER NOT NULL DEFAULT 0 
    COMMENT '访问次数',
  `last_accessed_at` DATETIME 
    COMMENT '最后访问时间',
  
  -- 扩展元数据
  `metadata` JSON 
    COMMENT '扩展元数据：颜色、标签、GPS等',
  
  -- 审核相关（针对用户上传）
  `review_status` ENUM('pending', 'approved', 'rejected') 
    COMMENT '审核状态（仅用户上传需要）',
  `reviewer_id` INTEGER 
    COMMENT '审核员ID',
  `review_reason` TEXT 
    COMMENT '审核说明',
  `reviewed_at` DATETIME 
    COMMENT '审核时间',
  
  -- 业务相关字段
  `consumption_amount` DECIMAL(10, 2) 
    COMMENT '消费金额（用于上传审核）',
  `points_awarded` INTEGER 
    COMMENT '奖励积分数量',
  
  -- 时间戳
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP 
    COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP 
    COMMENT '更新时间',
  `deleted_at` TIMESTAMP NULL 
    COMMENT '软删除时间',
  
  -- 外键约束
  FOREIGN KEY (`user_id`) REFERENCES `users`(`user_id`) ON DELETE SET NULL,
  FOREIGN KEY (`reviewer_id`) REFERENCES `users`(`user_id`) ON DELETE SET NULL,
  
  -- 索引设计（基于实际查询需求）
  INDEX `idx_business_category` (`business_type`, `category`),
  INDEX `idx_user_business` (`user_id`, `business_type`, `status`),
  INDEX `idx_review_status` (`review_status`, `business_type`, `created_at`),
  INDEX `idx_storage_layer` (`storage_layer`, `created_at`),
  INDEX `idx_context_category` (`context_id`, `category`, `status`),
  INDEX `idx_created_status` (`created_at`, `status`),
  INDEX `idx_access_count` (`access_count`, `last_accessed_at`)
  
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci 
  COMMENT='v2.0统一图片资源管理表';
```

#### 1.2 业务分类说明
```javascript
// 🔴 ImageResources业务分类详解（基于v2.0架构实际需求）
const BUSINESS_TYPE_MAPPING = {
  // 抽奖业务
  lottery: {
    categories: ['prizes', 'wheels', 'banners', 'backgrounds'],
    description: '抽奖相关图片资源：奖品图片、转盘素材、横幅等',
    storage_class: 'hot', // 高频访问
    access_pattern: '高频访问，需要快速响应'
  },
  
  // 兑换业务
  exchange: {
    categories: ['products', 'categories', 'promotions'],
    description: '兑换商品图片：商品主图、分类图片、促销素材',
    storage_class: 'standard', // 中频访问
    access_pattern: '中频访问，平衡性能和成本'
  },
  
  // 交易业务
  trade: {
    categories: ['items', 'banners', 'transactions'],
    description: '交易物品图片：商品图片、横幅、交易记录图片',
    storage_class: 'standard',
    access_pattern: '中频访问，注重成本效益'
  },
  
  // 用户上传
  uploads: {
    categories: ['dining', 'receipts', 'reviews', 'activities'],
    description: '用户上传图片：用餐照片、消费小票、评价图片',
    storage_class: 'hot', // 审核期间高频访问
    access_pattern: '审核期高频，通过后降为低频'
  }
};
```

#### 1.3 三层存储架构设计
```javascript
// 🔴 v2.0三层存储架构（基于Sealos对象存储）
const STORAGE_ARCHITECTURE = {
  // 热存储层（Hot Tier）
  hot: {
    description: '高频访问数据，7天内访问过',
    storage_type: 'SSD存储',
    access_time: '<10ms',
    cost_level: 'high',
    auto_tier_rules: {
      promote_from: 'standard',
      promote_condition: 'access_count > 10 AND last_accessed_at > DATE_SUB(NOW(), INTERVAL 1 DAY)',
      demote_to: 'standard',
      demote_condition: 'last_accessed_at IS NULL OR last_accessed_at < DATE_SUB(NOW(), INTERVAL 7 DAY)'
    }
  },
  
  // 标准存储层（Standard Tier）
  standard: {
    description: '中频访问数据，7-30天访问',
    storage_type: '平衡存储',
    access_time: '<50ms',
    cost_level: 'medium',
    auto_tier_rules: {
      promote_to: 'hot',
      promote_condition: 'access_count > 5 AND last_accessed_at > DATE_SUB(NOW(), INTERVAL 1 DAY)',
      demote_to: 'archive',
      demote_condition: 'last_accessed_at IS NULL OR last_accessed_at < DATE_SUB(NOW(), INTERVAL 30 DAY)'
    }
  },
  
  // 归档存储层（Archive Tier）
  archive: {
    description: '低频访问数据，30天以上未访问',
    storage_type: '冷存储',
    access_time: '<200ms',
    cost_level: 'low',
    auto_tier_rules: {
      promote_to: 'standard',
      promote_condition: 'access_count > 0 AND last_accessed_at > DATE_SUB(NOW(), INTERVAL 7 DAY)',
      permanent_archive: 'last_accessed_at IS NULL OR last_accessed_at < DATE_SUB(NOW(), INTERVAL 365 DAY)'
    }
  }
};
```

### 2. 业务配置管理表 - BusinessConfigs

#### 2.1 表结构设计（基于models/BusinessConfigs.js实现）
```sql
-- 🔴 业务配置管理表（196行实现）
CREATE TABLE `business_configs` (
  -- 主键和标识
  `config_id` VARCHAR(36) PRIMARY KEY COMMENT '配置唯一标识符（UUID）',
  
  -- 配置分类
  `business_type` VARCHAR(50) NOT NULL 
    COMMENT '业务类型：lottery/exchange/trade/uploads/system',
  `config_key` VARCHAR(100) NOT NULL 
    COMMENT '配置键名：如cost_per_draw, daily_limit等',
  `config_value` JSON NOT NULL 
    COMMENT '配置值（JSON格式存储复杂配置）',
  
  -- 配置描述
  `description` TEXT 
    COMMENT '配置项详细描述',
  `config_group` VARCHAR(50) DEFAULT 'default' 
    COMMENT '配置分组：default/advanced/experimental',
  
  -- 配置属性
  `data_type` ENUM('string', 'number', 'boolean', 'object', 'array') NOT NULL DEFAULT 'string' 
    COMMENT '数据类型标识',
  `validation_rules` JSON 
    COMMENT '验证规则：{min: 1, max: 100, required: true}',
  `default_value` JSON 
    COMMENT '默认值',
  
  -- 状态控制
  `is_active` BOOLEAN NOT NULL DEFAULT TRUE 
    COMMENT '是否激活',
  `version` VARCHAR(10) NOT NULL DEFAULT '1.0' 
    COMMENT '配置版本号',
  `environment` ENUM('development', 'staging', 'production', 'all') DEFAULT 'all' 
    COMMENT '适用环境',
  
  -- 权限控制
  `access_level` ENUM('public', 'user', 'admin', 'system') NOT NULL DEFAULT 'admin' 
    COMMENT '访问权限级别',
  `modify_level` ENUM('admin', 'system', 'readonly') NOT NULL DEFAULT 'admin' 
    COMMENT '修改权限级别',
  
  -- 时间戳
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP 
    COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP 
    COMMENT '更新时间',
  `last_modified_by` INTEGER 
    COMMENT '最后修改人ID',
  
  -- 外键约束
  FOREIGN KEY (`last_modified_by`) REFERENCES `users`(`user_id`) ON DELETE SET NULL,
  
  -- 索引设计
  UNIQUE KEY `uk_business_key` (`business_type`, `config_key`),
  INDEX `idx_business_type` (`business_type`, `is_active`),
  INDEX `idx_config_group` (`config_group`, `business_type`),
  INDEX `idx_access_level` (`access_level`, `environment`),
  INDEX `idx_updated_at` (`updated_at`)
  
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci 
  COMMENT='v2.0业务配置管理表';
```

#### 2.2 配置项标准定义
```javascript
// 🔴 BusinessConfigs标准配置项（基于实际业务需求）
const STANDARD_BUSINESS_CONFIGS = {
  // 抽奖业务配置
  lottery: {
    cost_per_draw: {
      description: '单次抽奖消耗积分',
      data_type: 'number',
      default_value: 10,
      validation_rules: { min: 1, max: 100 },
      access_level: 'admin'
    },
    daily_limit: {
      description: '每日抽奖次数限制',
      data_type: 'number', 
      default_value: 50,
      validation_rules: { min: 1, max: 200 },
      access_level: 'admin'
    },
    guarantee_count: {
      description: '保底机制触发次数',
      data_type: 'number',
      default_value: 10,
      validation_rules: { min: 5, max: 50 },
      access_level: 'admin'
    },
    prize_probabilities: {
      description: '奖品概率配置',
      data_type: 'object',
      default_value: {
        "special": 0.001,
        "first": 0.01,
        "second": 0.05,
        "third": 0.1,
        "participation": 0.839
      },
      validation_rules: { sum_must_equal: 1.0 },
      access_level: 'admin'
    }
  },
  
  // 兑换业务配置
  exchange: {
    min_points_per_item: {
      description: '商品最低兑换积分',
      data_type: 'number',
      default_value: 100,
      validation_rules: { min: 10, max: 10000 },
      access_level: 'admin'
    },
    delivery_methods: {
      description: '配送方式配置',
      data_type: 'array',
      default_value: ["pickup", "express", "digital"],
      validation_rules: { min_items: 1, max_items: 10 },
      access_level: 'admin'
    }
  },
  
  // 上传业务配置
  uploads: {
    max_file_size: {
      description: '最大文件上传大小（字节）',
      data_type: 'number',
      default_value: 10485760, // 10MB
      validation_rules: { min: 1048576, max: 52428800 }, // 1MB-50MB
      access_level: 'admin'
    },
    allowed_mime_types: {
      description: '允许的文件类型',
      data_type: 'array',
      default_value: ["image/jpeg", "image/jpg", "image/png", "image/gif", "image/webp"],
      validation_rules: { min_items: 1 },
      access_level: 'admin'
    },
    review_reward_points: {
      description: '审核通过奖励积分',
      data_type: 'number',
      default_value: 20,
      validation_rules: { min: 1, max: 100 },
      access_level: 'admin'
    },
    auto_approve_threshold: {
      description: '自动审核通过阈值',
      data_type: 'number',
      default_value: 0.95,
      validation_rules: { min: 0.5, max: 1.0 },
      access_level: 'system'
    }
  },
  
  // 系统配置
  system: {
    storage_auto_tier: {
      description: '自动存储分层开关',
      data_type: 'boolean',
      default_value: true,
      access_level: 'system'
    },
    thumbnail_sizes: {
      description: '缩略图尺寸配置',
      data_type: 'object',
      default_value: {
        "small": "150x150",
        "medium": "300x300", 
        "large": "600x600"
      },
      access_level: 'admin'
    },
    cdn_domain: {
      description: 'CDN域名配置',
      data_type: 'string',
      default_value: "https://cdn.restaurant-lottery.com",
      validation_rules: { pattern: "^https?://" },
      access_level: 'system'
    }
  }
};
```

### 3. 核心业务表结构优化

#### 3.1 用户表增强（v2.0架构适配）
```sql
-- 🔴 用户表v2.0架构增强
-- 基于现有User表结构，新增v2.0相关字段
ALTER TABLE `users` 
ADD COLUMN `avatar_resource_id` VARCHAR(36) NULL 
  COMMENT '头像资源ID，关联ImageResources表' AFTER `avatar_url`,
ADD COLUMN `preferences` JSON NULL 
  COMMENT '用户偏好设置：{theme: "dark", language: "zh-CN"}' AFTER `status`,
ADD COLUMN `activity_stats` JSON NULL 
  COMMENT '活动统计：{uploads: 50, draws: 200, exchanges: 10}' AFTER `preferences`,
ADD COLUMN `storage_quota` BIGINT UNSIGNED NOT NULL DEFAULT 104857600 
  COMMENT '存储配额（字节，默认100MB）' AFTER `activity_stats`,
ADD COLUMN `used_storage` BIGINT UNSIGNED NOT NULL DEFAULT 0 
  COMMENT '已使用存储（字节）' AFTER `storage_quota`,
ADD COLUMN `last_activity_at` TIMESTAMP NULL 
  COMMENT '最后活动时间' AFTER `last_login_at`;

-- 添加相关索引
ALTER TABLE `users`
ADD INDEX `idx_avatar_resource` (`avatar_resource_id`),
ADD INDEX `idx_storage_usage` (`used_storage`, `storage_quota`),
ADD INDEX `idx_last_activity` (`last_activity_at`);

-- 添加外键约束
ALTER TABLE `users`
ADD CONSTRAINT `fk_users_avatar_resource` 
  FOREIGN KEY (`avatar_resource_id`) REFERENCES `image_resources`(`resource_id`) ON DELETE SET NULL;
```

#### 3.2 照片审核表v2.0集成
```sql
-- 🔴 PhotoReview表v2.0架构集成
-- 新增ImageResources关联字段
ALTER TABLE `photo_reviews` 
ADD COLUMN `resource_id` VARCHAR(36) NULL 
  COMMENT '关联的图片资源ID' AFTER `merchant_id`,
ADD COLUMN `review_score` INTEGER UNSIGNED NULL 
  COMMENT '审核评分（0-100分）' AFTER `review_reason`,
ADD COLUMN `review_tags` JSON NULL 
  COMMENT '审核标签：["high_quality", "clear_receipt", "valid_consumption"]' AFTER `review_score`,
ADD COLUMN `auto_review_confidence` DECIMAL(3,2) NULL 
  COMMENT '自动审核置信度（0.00-1.00）' AFTER `review_tags`;

-- 添加相关索引
ALTER TABLE `photo_reviews`
ADD INDEX `idx_resource_id` (`resource_id`),
ADD INDEX `idx_review_score` (`review_score`),
ADD INDEX `idx_auto_confidence` (`auto_review_confidence`);

-- 添加外键约束
ALTER TABLE `photo_reviews`
ADD CONSTRAINT `fk_photo_reviews_resource` 
  FOREIGN KEY (`resource_id`) REFERENCES `image_resources`(`resource_id`) ON DELETE CASCADE;
```

#### 3.3 奖品表v2.0多媒体增强
```sql
-- 🔴 Prize表v2.0多媒体资源增强
ALTER TABLE `prizes` 
ADD COLUMN `primary_image_id` VARCHAR(36) NULL 
  COMMENT '主图资源ID' AFTER `image_url`,
ADD COLUMN `gallery_images` JSON NULL 
  COMMENT '图库资源ID数组：["uuid1", "uuid2", "uuid3"]' AFTER `primary_image_id`,
ADD COLUMN `prize_metadata` JSON NULL 
  COMMENT '奖品元数据：{brand: "Apple", model: "iPhone15", color: "Blue"}' AFTER `prize_value`,
ADD COLUMN `display_config` JSON NULL 
  COMMENT '显示配置：{show_in_wheel: true, highlight: false}' AFTER `prize_metadata`;

-- 添加相关索引
ALTER TABLE `prizes`
ADD INDEX `idx_primary_image` (`primary_image_id`),
ADD INDEX `idx_display_order` (`display_order`, `is_active`);

-- 添加外键约束
ALTER TABLE `prizes`
ADD CONSTRAINT `fk_prizes_primary_image` 
  FOREIGN KEY (`primary_image_id`) REFERENCES `image_resources`(`resource_id`) ON DELETE SET NULL;
```javascript
// ✅ 业务类型和分类映射（基于实际业务需求）
const BUSINESS_CATEGORIES = {
  lottery: {
    categories: ['prizes', 'wheels', 'results', 'banners'],
    description: '抽奖业务 - 奖品图片、转盘素材、结果展示、活动横幅'
  },
  exchange: {
    categories: ['products', 'categories', 'promotions'],
    description: '兑换业务 - 商品图片、分类图片、促销素材'
  },
  trade: {
    categories: ['items', 'banners', 'transactions'],
    description: '交易业务 - 商品图片、交易横幅、交易记录'
  },
  uploads: {
    categories: ['pending_review', 'approved', 'rejected', 'processing'],
    description: '用户上传 - 消费小票审核图片'
  }
};
```

#### 1.3 存储层级策略
```javascript
// ✅ 三层存储策略（基于BusinessConfigs实现）
const STORAGE_LAYERS = {
  hot: {
    description: '热存储 - 新上传和活跃资源',
    characteristics: ['快速访问', '高性能SSD', '低延迟', '高成本'],
    defaultDays: 30,
    useCases: ['新上传的图片', '频繁访问的资源', '活跃业务资源']
  },
  standard: {
    description: '标准存储 - 中期存储',
    characteristics: ['平衡性能和成本', '标准访问速度', '中等成本'],
    defaultDays: 365,
    useCases: ['中期存储资源', '定期访问的图片', '历史业务数据']
  },
  archive: {
    description: '归档存储 - 长期存储',
    characteristics: ['低成本存储', '较慢访问速度', '长期保存'],
    defaultDays: 1095, // 3年
    useCases: ['长期归档数据', '合规性存储', '历史备份数据']
  }
};
```

### 2. 业务配置表 - BusinessConfigs

#### 2.1 表结构设计（基于models/BusinessConfigs.js实现）
```sql
-- ✅ 业务配置管理表（实际表结构）
CREATE TABLE `business_configs` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '配置ID',
  
  `business_type` ENUM('lottery', 'exchange', 'trade', 'uploads') NOT NULL UNIQUE 
    COMMENT '业务类型',
  
  -- 存储策略配置
  `storage_policy` JSON NOT NULL 
    COMMENT '存储策略：{hotDays: 30, standardDays: 365, archiveDays: 1095}',
  
  -- 文件规则配置
  `file_rules` JSON NOT NULL 
    COMMENT '文件规则：{maxFileSize: 10MB, allowedTypes: ["jpg"], categories: []}',
  
  -- 缓存配置
  `cache_config` JSON 
    COMMENT '缓存配置：{ttl: 300000, maxSize: 1000}',
  
  -- 扩展配置
  `extended_config` JSON 
    COMMENT '扩展配置：业务特定的其他配置',
  
  `status` ENUM('active', 'inactive') NOT NULL DEFAULT 'active' 
    COMMENT '配置状态',
  
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  
  -- 索引设计
  UNIQUE INDEX `idx_business_type` (`business_type`),
  INDEX `idx_status` (`status`)
  
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci 
  COMMENT='v2.0业务配置管理表';
```

#### 2.2 默认配置数据
```javascript
// ✅ 默认业务配置（基于BusinessConfigs.getDefaultConfig实现）
const DEFAULT_BUSINESS_CONFIGS = {
  lottery: {
    business_type: 'lottery',
    storage_policy: {
      hotDays: 30,
      standardDays: 365,
      archiveDays: 1095
    },
    file_rules: {
      maxFileSize: 10485760, // 10MB
      allowedTypes: ['jpg', 'jpeg', 'png', 'webp'],
      categories: ['prizes', 'wheels', 'results', 'banners']
    },
    cache_config: {
      ttl: 300000, // 5分钟
      maxSize: 1000
    }
  },
  
  exchange: {
    business_type: 'exchange',
    storage_policy: {
      hotDays: 60,
      standardDays: 730,
      archiveDays: 2190
    },
    file_rules: {
      maxFileSize: 15728640, // 15MB
      allowedTypes: ['jpg', 'jpeg', 'png', 'webp'],
      categories: ['products', 'categories', 'promotions']
    }
  },
  
  trade: {
    business_type: 'trade',
    storage_policy: {
      hotDays: 45,
      standardDays: 545,
      archiveDays: 1825
    },
    file_rules: {
      maxFileSize: 12582912, // 12MB
      allowedTypes: ['jpg', 'jpeg', 'png', 'webp'],
      categories: ['items', 'banners', 'transactions']
    }
  },
  
  uploads: {
    business_type: 'uploads',
    storage_policy: {
      hotDays: 7,
      standardDays: 1095,
      archiveDays: 2190
    },
    file_rules: {
      maxFileSize: 20971520, // 20MB
      allowedTypes: ['jpg', 'jpeg', 'png', 'webp'],
      categories: ['pending_review', 'approved', 'rejected', 'processing']
    }
  }
};
```

### 3. 数据库连接和配置

#### 3.1 数据库连接配置（基于config/database.js实现）
```javascript
// ✅ 数据库连接配置（实际代码实现）
const DATABASE_CONFIG = {
  development: {
    host: 'test-db-mysql.ns-br0za7uc.svc',
    port: 3306,
    username: 'root',
    password: 'mc6r9cgb',
    database: 'restaurant_points_dev',
    dialect: 'mysql',
    timezone: '+08:00',
    pool: {
      max: 20,
      min: 0,
      acquire: 30000,
      idle: 10000
    }
  },
  
  production: {
    host: 'dbconn.sealosbja.site',
    port: 42182,
    username: 'root',
    password: 'mc6r9cgb',
    database: 'restaurant_points_prod',
    dialect: 'mysql',
    timezone: '+08:00',
    pool: {
      max: 50,
      min: 5,
      acquire: 60000,
      idle: 10000
    }
  }
};
```

#### 3.2 Sequelize ORM配置
```javascript
// ✅ Sequelize配置（基于models/index.js实现）
const sequelize = new Sequelize(
  process.env.DB_NAME || 'restaurant_points_dev',
  process.env.DB_USER || 'root', 
  process.env.DB_PASSWORD || 'mc6r9cgb',
  {
    host: process.env.DB_HOST || 'test-db-mysql.ns-br0za7uc.svc',
    port: parseInt(process.env.DB_PORT) || 3306,
    dialect: 'mysql',
    logging: process.env.NODE_ENV !== 'production' ? console.log : false,
    pool: {
      max: 10,
      min: 0,
      acquire: 30000,
      idle: 10000
    },
    define: {
      freezeTableName: true,
      underscored: true,
      charset: 'utf8mb4',
      collate: 'utf8mb4_unicode_ci'
    },
    timezone: '+08:00'
  }
);
```

## 🔧 数据模型关联设计

### 关联关系定义（基于实际代码实现）
```javascript
// ✅ 数据模型关联关系（基于models/index.js实现）
const MODEL_ASSOCIATIONS = {
  // ImageResources关联关系
  ImageResources: {
    // 关联上传用户
    belongsTo_uploader: {
      model: 'User',
      foreignKey: 'user_id',
      as: 'uploader',
      constraints: false
    },
    
    // 关联审核员
    belongsTo_reviewer: {
      model: 'User',
      foreignKey: 'reviewer_id',
      as: 'reviewer',
      constraints: false
    }
  },
  
  // User关联关系（外部模型）
  User: {
    // 用户上传的图片资源
    hasMany_uploads: {
      model: 'ImageResources',
      foreignKey: 'user_id',
      as: 'uploads'
    },
    
    // 用户审核的图片资源
    hasMany_reviews: {
      model: 'ImageResources',
      foreignKey: 'reviewer_id',
      as: 'reviews'
    }
  }
};
```

## 📊 查询优化和索引设计

### 1. 核心查询模式分析
```javascript
// ✅ 核心查询模式（基于实际业务需求）
const QUERY_PATTERNS = {
  // 业务资源查询
  findByBusiness: {
    sql: 'SELECT * FROM image_resources WHERE business_type = ? AND category = ? AND status = ?',
    index: 'idx_business_category',
    frequency: 'HIGH'
  },
  
  // 用户上传查询
  findUserUploads: {
    sql: 'SELECT * FROM image_resources WHERE user_id = ? AND business_type = ? AND status = ?',
    index: 'idx_user_business',
    frequency: 'HIGH'
  },
  
  // 审核工作台查询
  findPendingReviews: {
    sql: 'SELECT * FROM image_resources WHERE review_status = "pending" AND business_type = ? ORDER BY created_at ASC',
    index: 'idx_review_status',
    frequency: 'MEDIUM'
  },
  
  // 存储分层查询
  findByStorageLayer: {
    sql: 'SELECT * FROM image_resources WHERE storage_layer = ? AND created_at < ?',
    index: 'idx_storage_layer',
    frequency: 'LOW'
  },
  
  // 上下文资源查询
  findByContext: {
    sql: 'SELECT * FROM image_resources WHERE context_id = ? AND category = ? AND status = ?',
    index: 'idx_context_category',
    frequency: 'MEDIUM'
  }
};
```

### 2. 索引设计策略
```sql
-- ✅ 索引设计（基于实际查询需求优化）

-- 主业务查询索引（高频查询）
CREATE INDEX `idx_business_category` ON `image_resources` (`business_type`, `category`);
CREATE INDEX `idx_user_business` ON `image_resources` (`user_id`, `business_type`, `status`);

-- 审核工作台索引（管理员功能）
CREATE INDEX `idx_review_status` ON `image_resources` (`review_status`, `business_type`, `created_at`);

-- 存储分层管理索引（后台任务）
CREATE INDEX `idx_storage_layer` ON `image_resources` (`storage_layer`, `created_at`);

-- 上下文查询索引（业务关联）
CREATE INDEX `idx_context_category` ON `image_resources` (`context_id`, `category`, `status`);

-- 时间范围查询索引（统计分析）
CREATE INDEX `idx_created_status` ON `image_resources` (`created_at`, `status`);

-- 访问统计索引（性能监控）
CREATE INDEX `idx_access_count` ON `image_resources` (`access_count`, `last_accessed_at`);
```

### 3. 查询性能优化建议
```javascript
// ✅ 查询性能优化策略
const QUERY_OPTIMIZATION = {
  // 分页查询优化
  pagination: {
    strategy: 'LIMIT + OFFSET with ORDER BY indexed column',
    recommendation: '使用 created_at 或 resource_id 作为排序字段',
    example: 'ORDER BY created_at DESC LIMIT 20 OFFSET 0'
  },
  
  // 复合查询优化
  complexQuery: {
    strategy: 'Use covering indexes and avoid SELECT *',
    recommendation: '只查询需要的字段，利用覆盖索引',
    example: 'SELECT resource_id, business_type, category FROM image_resources'
  },
  
  // JOIN查询优化
  joinQuery: {
    strategy: 'Use proper foreign key indexes',
    recommendation: '确保JOIN字段都有索引，避免大表JOIN',
    example: 'JOIN users u ON ir.user_id = u.user_id'
  },
  
  // 统计查询优化
  aggregateQuery: {
    strategy: 'Use summary tables for complex aggregations',
    recommendation: '复杂统计使用汇总表或缓存',
    example: 'CREATE TABLE image_stats AS SELECT business_type, COUNT(*) as total FROM image_resources GROUP BY business_type'
  }
};
```

## 🔒 数据安全和完整性

### 1. 数据完整性约束
```sql
-- ✅ 数据完整性约束设计

-- 业务类型约束
ALTER TABLE `image_resources` 
ADD CONSTRAINT `chk_business_type` 
CHECK (`business_type` IN ('lottery', 'exchange', 'trade', 'uploads'));

-- 存储层级约束
ALTER TABLE `image_resources` 
ADD CONSTRAINT `chk_storage_layer` 
CHECK (`storage_layer` IN ('hot', 'standard', 'archive'));

-- 文件大小约束
ALTER TABLE `image_resources` 
ADD CONSTRAINT `chk_file_size` 
CHECK (`file_size` > 0 AND `file_size` <= 21474836480); -- 最大20GB

-- 审核状态约束
ALTER TABLE `image_resources` 
ADD CONSTRAINT `chk_review_consistency` 
CHECK (
  (business_type = 'uploads' AND review_status IS NOT NULL) OR 
  (business_type != 'uploads' AND review_status IS NULL)
);

-- 访问计数约束
ALTER TABLE `image_resources` 
ADD CONSTRAINT `chk_access_count` 
CHECK (`access_count` >= 0);
```

### 2. 数据安全策略
```javascript
// ✅ 数据安全策略
const DATA_SECURITY = {
  // 敏感数据处理
  sensitiveData: {
    filePathEncryption: '文件路径加密存储',
    metadataFiltering: '元数据敏感信息过滤',
    urlSigning: 'CDN URL签名访问控制'
  },
  
  // 访问控制
  accessControl: {
    userIsolation: '用户数据隔离：用户只能访问自己的上传',
    adminPermission: '管理员权限：审核和管理所有资源',
    businessIsolation: '业务模块隔离：不同业务模块数据分离'
  },
  
  // 数据备份
  dataBackup: {
    regularBackup: '定期全量备份：每日凌晨2点',
    incrementalBackup: '增量备份：每4小时一次',
    retentionPolicy: '备份保留：全量备份保留30天，增量备份保留7天'
  },
  
  // 日志审计
  auditLog: {
    operationLog: '记录所有数据修改操作',
    accessLog: '记录敏感数据访问',
    retentionPeriod: '日志保留90天'
  }
};
```

## 📈 监控和维护

### 1. 性能监控指标
```javascript
// ✅ 数据库性能监控指标
const MONITORING_METRICS = {
  // 查询性能
  queryPerformance: {
    slowQueryThreshold: '100ms',
    monitoring: [
      'SELECT查询平均响应时间',
      'INSERT/UPDATE/DELETE操作响应时间',
      '复杂聚合查询性能',
      '索引使用效率'
    ]
  },
  
  // 存储监控
  storageMonitoring: {
    metrics: [
      '表大小增长趋势',
      '索引大小和碎片率',
      '存储层级分布统计',
      '磁盘空间使用率'
    ]
  },
  
  // 连接池监控
  connectionPool: {
    metrics: [
      '活跃连接数',
      '连接池使用率',
      '连接获取等待时间',
      '连接超时频率'
    ]
  }
};
```

### 2. 定期维护任务
```javascript
// ✅ 定期维护任务
const MAINTENANCE_TASKS = {
  // 存储层级迁移
  storageLayerMigration: {
    frequency: 'DAILY',
    description: '根据访问时间和业务配置自动迁移存储层级',
    sql: `
      UPDATE image_resources 
      SET storage_layer = 'standard' 
      WHERE storage_layer = 'hot' 
        AND created_at < DATE_SUB(NOW(), INTERVAL 30 DAY)
    `
  },
  
  // 索引优化
  indexOptimization: {
    frequency: 'WEEKLY',
    description: '分析索引使用情况，优化索引结构',
    tasks: [
      'ANALYZE TABLE image_resources',
      'CHECK TABLE image_resources',
      'OPTIMIZE TABLE image_resources'
    ]
  },
  
  // 数据清理
  dataCleaning: {
    frequency: 'MONTHLY',
    description: '清理软删除数据和过期临时数据',
    sql: `
      DELETE FROM image_resources 
      WHERE status = 'deleted' 
        AND deleted_at < DATE_SUB(NOW(), INTERVAL 90 DAY)
    `
  },
  
  // 统计信息更新
  statisticsUpdate: {
    frequency: 'DAILY',
    description: '更新业务统计信息',
    tasks: [
      '更新每日上传统计',
      '更新存储层级分布',
      '更新业务模块使用情况'
    ]
  }
};
```

## 🔄 数据迁移和版本控制

### 1. 数据库版本控制策略
```javascript
// ✅ 数据库版本控制
const DATABASE_VERSIONING = {
  // 版本命名规范
  versionNaming: {
    format: 'YYYYMMDD_HHMMSS_description',
    example: '20250728_184500_add_storage_layer_column'
  },
  
  // 迁移脚本管理
  migrationScripts: {
    location: 'database/migrations/',
    naming: 'sequential_timestamp_description.sql',
    rollback: 'each migration must have rollback script'
  },
  
  // 环境管理
  environmentManagement: {
    development: '开发环境：自由测试和调试',
    staging: '预发布环境：生产数据备份测试',
    production: '生产环境：严格变更控制'
  }
};
```

### 2. 数据迁移最佳实践
```sql
-- ✅ 数据迁移示例

-- 添加新列（向后兼容）
ALTER TABLE `image_resources` 
ADD COLUMN `new_field` VARCHAR(100) NULL COMMENT '新增字段' 
AFTER `existing_field`;

-- 修改列定义（需要数据迁移）
-- Step 1: 添加新列
ALTER TABLE `image_resources` 
ADD COLUMN `new_column` JSON NULL;

-- Step 2: 迁移数据
UPDATE `image_resources` 
SET `new_column` = JSON_OBJECT('old_value', `old_column`)
WHERE `old_column` IS NOT NULL;

-- Step 3: 删除旧列（确认数据正确后）
-- ALTER TABLE `image_resources` DROP COLUMN `old_column`;

-- 添加索引（在线DDL）
CREATE INDEX `idx_new_field` ON `image_resources` (`new_field`) ALGORITHM=INPLACE, LOCK=NONE;
```

## 📋 开发指导和最佳实践

### 1. Sequelize模型开发规范
```javascript
// ✅ Sequelize模型最佳实践（基于实际代码）

// 模型定义规范
const ImageResources = sequelize.define('ImageResources', {
  // 使用UUID主键
  resource_id: {
    type: DataTypes.UUID,
    defaultValue: () => uuidv4(),
    primaryKey: true,
    comment: '资源唯一标识符'
  },
  
  // 枚举类型使用
  business_type: {
    type: DataTypes.ENUM('lottery', 'exchange', 'trade', 'uploads'),
    allowNull: false,
    comment: '业务类型'
  },
  
  // JSON字段使用
  thumbnail_paths: {
    type: DataTypes.JSON,
    allowNull: true,
    comment: '缩略图路径集合'
  }
}, {
  // 表配置
  tableName: 'image_resources',
  timestamps: true,
  createdAt: 'created_at',
  updatedAt: 'updated_at',
  paranoid: true, // 软删除
  deletedAt: 'deleted_at',
  
  // 索引定义
  indexes: [
    {
      name: 'idx_business_category',
      fields: ['business_type', 'category']
    }
  ]
});

// 实例方法
ImageResources.prototype.toSafeJSON = function() {
  const values = this.get({ plain: true });
  delete values.file_path; // 移除敏感信息
  return values;
};

// 类方法
ImageResources.findByBusiness = function(businessType, category, options = {}) {
  return this.findAndCountAll({
    where: {
      business_type: businessType,
      category: category,
      status: 'active'
    },
    ...options
  });
};
```

### 2. 查询优化指导
```javascript
// ✅ 查询优化指导

// 高效的分页查询
const getResourcesPaginated = async (options) => {
  const { 
    businessType, 
    category, 
    limit = 20, 
    offset = 0,
    orderBy = 'created_at',
    order = 'DESC'
  } = options;
  
  return await ImageResources.findAndCountAll({
    where: {
      business_type: businessType,
      category: category,
      status: 'active'
    },
    attributes: {
      exclude: ['file_path', 'metadata'] // 排除不需要的字段
    },
    limit: parseInt(limit),
    offset: parseInt(offset),
    order: [[orderBy, order]],
    // 使用raw查询提高性能
    raw: false,
    nest: true
  });
};

// 批量操作优化
const batchUpdateStorageLayer = async (resourceIds, newLayer) => {
  return await ImageResources.update(
    { storage_layer: newLayer },
    {
      where: {
        resource_id: {
          [Op.in]: resourceIds
        }
      },
      // 返回更新的记录数
      returning: false
    }
  );
};

// 事务处理示例
const createResourceWithTransaction = async (resourceData) => {
  const transaction = await sequelize.transaction();
  
  try {
    const resource = await ImageResources.create(resourceData, { transaction });
    
    // 其他相关操作
    await updateBusinessStats(resource.business_type, { transaction });
    
    await transaction.commit();
    return resource;
  } catch (error) {
    await transaction.rollback();
    throw error;
  }
};
```

### 3. 错误处理和调试
```javascript
// ✅ 错误处理最佳实践

// 数据库连接错误处理
const handleDatabaseError = (error) => {
  const errorTypes = {
    'ER_DUP_ENTRY': {
      code: 'DUPLICATE_ENTRY',
      message: '数据重复，请检查唯一性约束'
    },
    'ER_NO_REFERENCED_ROW_2': {
      code: 'FOREIGN_KEY_CONSTRAINT',
      message: '外键约束失败，相关记录不存在'
    },
    'ER_DATA_TOO_LONG': {
      code: 'DATA_TOO_LONG',
      message: '数据长度超出字段限制'
    }
  };
  
  const errorInfo = errorTypes[error.original?.code] || {
    code: 'DATABASE_ERROR',
    message: '数据库操作失败'
  };
  
  return {
    ...errorInfo,
    details: error.message,
    sql: error.sql
  };
};

// 调试信息收集
const debugQuery = async (queryFunction, context) => {
  const startTime = Date.now();
  
  try {
    const result = await queryFunction();
    const duration = Date.now() - startTime;
    
    console.log(`✅ Query success: ${context}`, {
      duration: `${duration}ms`,
      resultCount: Array.isArray(result) ? result.length : 1
    });
    
    return result;
  } catch (error) {
    const duration = Date.now() - startTime;
    
    console.error(`❌ Query failed: ${context}`, {
      duration: `${duration}ms`,
      error: handleDatabaseError(error)
    });
    
    throw error;
  }
};
```

## 🎯 总结和实施建议

### 核心设计原则
1. **统一资源管理**：通过ImageResources表统一管理所有业务模块的图片资源
2. **智能分层存储**：基于访问模式和时间策略的三层存储架构
3. **业务模块化**：支持lottery、exchange、trade、uploads四大业务模块
4. **性能优化**：基于实际查询模式设计索引和优化策略
5. **数据安全**：完整的访问控制、数据加密和审计日志

### 实施优先级
1. **P0级**：核心表结构创建和基础索引
2. **P1级**：业务配置表和关联关系
3. **P2级**：性能优化索引和监控
4. **P3级**：高级功能和维护任务

### 注意事项
- 开发阶段保持数据结构的灵活性
- 生产环境严格控制结构变更
- 定期监控性能和存储使用情况
- 建立完善的备份和恢复机制

**核心原则**：数据一致性优先、性能兼顾、安全保障、可维护性强、扩展性好 