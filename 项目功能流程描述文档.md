# 餐厅积分抽奖系统 V4.0 - 功能流程详细描述文档

## 📋 项目概述

**系统名称**：餐厅积分抽奖系统 V4 统一引擎架构  
**版本**：V4.0.0  
**架构模式**：V4统一抽奖引擎架构  
**技术栈**：Node.js 20+ + Express + MySQL + Sequelize + Redis + JWT  
**部署环境**：支持Docker、Kubernetes、Sealos云平台  
**时区**：北京时间 (Asia/Shanghai)  

---

## 🏗️ 系统架构概览

### V4统一引擎架构图
```
┌─────────────────────────────────────────────────────────────┐
│                    前端用户界面                              │
├─────────────────────────────────────────────────────────────┤
│                    API网关层                                │
│  ┌─────────────┬─────────────┬─────────────┬──────────────┐  │
│  │  认证路由   │  抽奖路由   │  管理路由   │   权限路由   │  │
│  │   auth.js   │ lottery.js  │  admin.js   │permissions.js│  │
│  └─────────────┴─────────────┴─────────────┴──────────────┘  │
├─────────────────────────────────────────────────────────────┤
│                V4统一抽奖引擎层                              │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │            UnifiedLotteryEngine                         │  │
│  │  ┌─────────────┬──────────────┬─────────────────────┐   │  │
│  │  │ DecisionCore│ ContextBuilder│   ResultGenerator   │   │  │
│  │  │  (决策核心) │ (上下文构建器) │   (结果生成器)      │   │  │
│  │  └─────────────┴──────────────┴─────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│                    策略执行层                               │
│  ┌─────────────┬─────────────┬───────────────────────────┐  │
│  │BasicLottery │ Guarantee   │     Management            │  │
│  │Strategy     │ Strategy    │     Strategy              │  │
│  │(基础抽奖)   │ (保底策略)  │    (管理预设)             │  │
│  └─────────────┴─────────────┴───────────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│                    数据持久层                               │
│  ┌─────────────┬─────────────┬─────────────┬──────────────┐  │
│  │   MySQL     │    Redis    │   Sealos    │   文件系统   │  │
│  │  (主数据库) │   (缓存)    │ (对象存储)  │   (日志)     │  │
│  └─────────────┴─────────────┴─────────────┴──────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## 🎯 核心功能模块详解

### 1. 用户认证与权限管理模块

#### 1.1 用户认证功能
**路由位置**：`routes/v4/unified-engine/auth.js`

**核心功能**：
- **手机号验证码登录**：支持手机号+验证码认证
- **JWT Token管理**：生成访问令牌和刷新令牌
- **管理员权限验证**：区分普通用户和管理员

**业务流程**：
```
1. 用户输入手机号 + 验证码
2. 系统验证手机号格式
3. 验证码校验 (开发环境: 123456)
4. 查询用户信息并验证存在性
5. 检查管理员权限 (is_admin字段)
6. 生成JWT Token (2小时有效期)
7. 返回用户信息和Token
```

#### 1.2 权限管理功能
**路由位置**：`routes/v4/permissions.js`

**权限级别系统**：
- **super_admin** (Level 5)：所有权限
- **admin** (Level 4)：核心管理权限
- **moderator** (Level 3)：运营权限
- **viewer** (Level 2)：查看权限

### 2. V4统一抽奖引擎模块

#### 2.1 统一抽奖引擎 (UnifiedLotteryEngine)
**服务位置**：`services/UnifiedLotteryEngine/`

**核心组件**：
- **UnifiedLotteryEngine.js** (679行)：主引擎管理器
- **DecisionCore.js** (393行)：决策核心
- **ContextBuilder.js** (492行)：上下文构建器
- **ResultGenerator.js** (422行)：结果生成器

**工作流程**：
```
1. 接收抽奖请求 → UnifiedLotteryEngine
2. 构建抽奖上下文 → ContextBuilder
3. 策略决策选择 → DecisionCore
4. 执行具体策略 → Strategy执行
5. 生成结果数据 → ResultGenerator
6. 返回统一结果格式
```

#### 2.2 三大抽奖策略

##### A. 基础抽奖策略 (BasicLotteryStrategy)
**文件位置**：`services/UnifiedLotteryEngine/strategies/BasicLotteryStrategy.js` (873行)

**功能描述**：
- 固定概率抽奖机制
- 积分消耗管理 (每次100积分)
- 奖品池概率分配

**概率配置**：
```javascript
奖品概率分布：
1号 八八折券：     0% (管理员专用)
2号 100积分：      30%
3号 甜品1份：      20%
4号 青菜1份：      30%
5号 2000积分券：   1%
6号 500积分券：    18%
7号 精品首饰：     1%
8号 生腌拼盘：     0% (管理员专用)
```

##### B. 保底策略 (GuaranteeStrategy)
**文件位置**：`services/UnifiedLotteryEngine/strategies/GuaranteeStrategy.js` (400行)

**功能描述**：
- 连续未中奖统计
- 保底机制触发 (10次/20次可配置)
- 保底奖品发放 (九八折券)

**业务逻辑**：
```
1. 检查用户连续未中奖次数
2. 达到保底次数 → 触发保底奖品
3. 未达到次数 → 执行正常概率抽奖
4. 重置保底计数器
```

##### C. 管理预设策略 (ManagementStrategy)
**文件位置**：`services/UnifiedLotteryEngine/strategies/ManagementStrategy.js` (1084行)

**功能描述**：
- 管理员预设奖品功能
- 用户特定奖品队列管理
- 优先级抽奖机制

**工作流程**：
```
1. 检查 UserSpecificPrizeQueue 表
2. 存在预设奖品 → 按队列顺序发放
3. 无预设奖品 → 转向其他策略
4. 更新队列状态 (pending → distributed)
5. 记录详细抽奖日志
```

### 3. 积分管理模块

#### 3.1 积分账户管理
**模型位置**：`models/UserPointsAccount.js`

**核心字段**：
- `available_points`：可用积分
- `total_earned`：总获得积分
- `total_consumed`：总消耗积分
- `account_level`：账户等级 (bronze/silver/gold)

#### 3.2 积分交易记录
**模型位置**：`models/PointsTransaction.js`

**交易类型**：
- `earn`：获得积分
- `consume`：消耗积分
- `transfer`：转移积分
- `refund`：退款积分

### 4. 奖品管理模块

#### 4.1 奖品基础管理
**模型位置**：`models/LotteryPrize.js`

**奖品属性**：
- `prize_name`：奖品名称
- `prize_type`：奖品类型 (coupon/product/points)
- `prize_value`：奖品价值
- `stock_quantity`：库存数量

#### 4.2 奖品发放管理
**模型位置**：`models/PrizeDistribution.js`

**发放状态**：
- `pending`：待发放
- `awarded`：已发放
- `received`：已领取
- `expired`：已过期

### 5. 管理员功能模块

#### 5.1 系统监控功能
**路由位置**：`routes/v4/unified-engine/admin.js`

**监控指标**：
- 引擎性能统计
- 实时活动数据
- 系统健康状态
- 错误日志监控

#### 5.2 预设奖品管理
**核心功能**：
- 批量创建用户预设奖品队列
- 查询用户预设奖品状态
- 管理预设奖品生效/失效
- 预设奖品统计分析

**操作流程**：
```
1. 管理员选择目标用户
2. 配置预设奖品列表 (1-N个奖品)
3. 设置队列顺序和有效期
4. 插入 UserSpecificPrizeQueue 表
5. 用户抽奖时优先获得预设奖品
```

### 6. 数据存储模块

#### 6.1 数据库模型设计 (34个模型)

**核心业务表**：
- `User`：用户基础信息
- `UserPointsAccount`：用户积分账户
- `LotteryCampaign`：抽奖活动
- `LotteryPrize`：奖品信息
- `LotteryRecord`：抽奖记录
- `UserSpecificPrizeQueue`：用户预设奖品队列
- `PrizeDistribution`：奖品发放记录

**辅助功能表**：
- `AdminUser`：管理员用户
- `PointsTransaction`：积分交易记录
- `BusinessEvent`：业务事件记录
- `ImageResources`：图片资源管理
- `UploadReview`：上传审核

#### 6.2 Redis缓存策略
**使用场景**：
- 抽奖引擎状态缓存
- 用户会话状态缓存
- 概率计算结果缓存
- API响应缓存

### 7. 文件存储模块

#### 7.1 Sealos对象存储
**服务位置**：`services/sealosStorage.js`

**支持功能**：
- 文件上传 (图片/文档)
- 文件下载和访问
- 文件删除和管理
- 存储空间统计

#### 7.2 图片处理功能
**处理能力**：
- 图片格式转换 (JPEG/PNG/WebP)
- 图片尺寸调整
- 图片质量压缩
- 缩略图生成

---

## 🔄 核心业务流程详解

### 流程1：用户抽奖完整流程

```
【用户发起抽奖】
    ↓
【JWT Token验证】
    ↓
【检查用户积分】(≥100积分)
    ↓
【进入V4统一引擎】
    ↓
【ContextBuilder构建上下文】
    ├─ 用户信息
    ├─ 活动信息  
    ├─ 历史记录
    └─ 系统状态
    ↓
【DecisionCore策略决策】
    ├─ 检查管理预设奖品 → ManagementStrategy
    ├─ 检查保底机制 → GuaranteeStrategy  
    └─ 执行基础抽奖 → BasicLotteryStrategy
    ↓
【策略执行抽奖】
    ├─ 扣除100积分
    ├─ 执行抽奖逻辑
    ├─ 确定中奖结果
    └─ 更新相关状态
    ↓
【ResultGenerator生成结果】
    ├─ 标准化结果格式
    ├─ 记录抽奖日志
    └─ 更新统计数据
    ↓
【返回抽奖结果】
```

### 流程2：管理员预设奖品流程

```
【管理员登录认证】
    ↓
【选择目标用户】
    ↓
【配置预设奖品】
    ├─ 选择奖品类型
    ├─ 设置队列顺序
    ├─ 配置有效期
    └─ 添加管理备注
    ↓
【写入预设队列表】(UserSpecificPrizeQueue)
    ├─ user_id: 目标用户ID
    ├─ prize_id: 奖品ID  
    ├─ queue_order: 队列顺序
    ├─ status: 'pending'
    └─ admin_id: 操作管理员
    ↓
【用户下次抽奖】
    ↓
【ManagementStrategy检测】
    ├─ 查询pending状态记录
    ├─ 按queue_order排序
    └─ 获取下一个待发放奖品
    ↓
【直接发放预设奖品】
    ├─ 扣除100积分
    ├─ 更新status: 'distributed'
    ├─ 记录抽奖记录
    └─ 返回预设奖品
```

### 流程3：保底机制触发流程

```
【用户连续抽奖未中奖】
    ↓
【GuaranteeStrategy检查】
    ├─ 查询用户抽奖历史
    ├─ 统计连续未中奖次数
    └─ 判断是否达到保底条件
    ↓
【达到保底条件】(10次或20次)
    ↓
【触发保底奖品】
    ├─ 强制中奖: 九八折券
    ├─ 扣除100积分
    ├─ 重置保底计数器
    └─ 记录保底中奖日志
    ↓
【返回保底奖品】
```

---

## 📊 数据库关系设计

### 核心表关系图
```
User (用户)
├─ 1:1 → UserPointsAccount (积分账户)
├─ 1:N → LotteryRecord (抽奖记录)
├─ 1:N → UserSpecificPrizeQueue (预设奖品队列)
├─ 1:N → PrizeDistribution (奖品发放记录)
└─ 1:N → PointsTransaction (积分交易记录)

LotteryCampaign (抽奖活动)
├─ 1:N → LotteryPrize (奖品)
├─ 1:N → LotteryRecord (抽奖记录)
└─ 1:N → UserSpecificPrizeQueue (预设队列)

LotteryPrize (奖品)
├─ 1:N → PrizeDistribution (发放记录)
└─ 1:N → UserSpecificPrizeQueue (预设队列)

AdminUser (管理员)
├─ 1:N → UserSpecificPrizeQueue (预设队列创建)
└─ 1:N → BusinessEvent (操作日志)
```

---

## 🛡️ 安全与性能特性

### 安全特性
- **JWT认证**：Bearer Token认证机制
- **权限控制**：基于角色的权限管理 (RBAC)
- **密码加密**：BCrypt加密存储
- **API限流**：每IP 15分钟1000次请求
- **CORS配置**：跨域请求安全控制
- **Helmet防护**：HTTP安全头设置

### 性能优化
- **数据库索引**：关键字段建立索引
- **Redis缓存**：热点数据缓存
- **连接池管理**：数据库连接复用
- **压缩传输**：Gzip响应压缩
- **并发处理**：支持1000+并发用户

---

## 🔧 运维与监控

### 进程管理
**脚本位置**：`scripts/process-manager.sh`

**支持命令**：
```bash
npm run pm:status      # 查看服务状态
npm run pm:start       # 启动服务
npm run pm:start:pm2   # 使用PM2启动
npm run pm:restart     # 重启服务
npm run pm:stop        # 停止服务
npm run pm:cleanup     # 清理进程
```

### 健康检查
**端点**：`GET /health`

**检查项目**：
- 数据库连接状态
- Redis连接状态
- 系统内存使用
- 服务运行时间
- Node.js版本信息

### 日志管理
**日志类型**：
- 应用访问日志
- 抽奖引擎日志
- 错误异常日志
- 管理操作日志
- 性能监控日志

---

## 📈 业务数据统计

### 实时监控指标
- 在线用户数量
- 抽奖活动数量
- 实时中奖率
- 系统响应时间
- API调用频次

### 业务分析报告
- 每日抽奖统计
- 用户活跃度分析
- 奖品发放统计
- 积分消耗分析
- 保底机制触发率

---

## 🚀 部署配置

### 环境要求
- **Node.js**：≥ 20.18.0
- **MySQL**：≥ 8.0
- **Redis**：≥ 6.0
- **内存**：≥ 2GB
- **存储**：≥ 10GB

### 环境变量配置
```env
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=restaurant_points_dev
DB_USER=root
DB_PASSWORD=your_password

# Redis配置
REDIS_URL=redis://localhost:6379

# JWT配置
JWT_SECRET=your_jwt_secret
JWT_REFRESH_SECRET=your_refresh_secret

# Sealos存储配置
SEALOS_ACCESS_KEY=your_access_key
SEALOS_SECRET_KEY=your_secret_key
```

### Docker部署
```dockerfile
FROM node:20-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install --production
COPY . .
EXPOSE 3000
CMD ["npm", "start"]
```

---

## 📝 API接口规范

### 统一响应格式
```json
{
  "success": true,
  "code": "SUCCESS",
  "message": "操作成功",
  "data": { ... },
  "version": "v4.0",
  "request_id": "req_1234567890",
  "timestamp": "2025-01-21T19:00:00+08:00"
}
```

### 主要API端点

#### 用户认证
- `POST /api/v4/unified-engine/auth` - 用户登录认证

#### 抽奖功能
- `POST /api/v4/unified-engine/lottery/draw` - 执行抽奖
- `GET /api/v4/unified-engine/lottery/history` - 抽奖历史
- `GET /api/v4/unified-engine/lottery/campaigns` - 活动列表

#### 管理功能
- `POST /api/v4/unified-engine/admin/auth` - 管理员认证
- `GET /api/v4/unified-engine/admin/status` - 系统状态
- `POST /api/v4/unified-engine/admin/prize-queue` - 创建预设奖品
- `GET /api/v4/unified-engine/admin/analytics` - 数据分析

#### 积分管理
- `GET /api/v4/unified-engine/lottery/points/:userId` - 查询积分余额
- `GET /api/v4/unified-engine/lottery/history` - 积分交易记录

---

## 🎯 核心技术特点

### V4统一引擎优势
1. **统一管理**：三种策略统一管理和调度
2. **智能决策**：自动选择最适合的抽奖策略
3. **扩展性强**：支持新增抽奖策略
4. **性能优化**：缓存和并发优化
5. **完整审计**：详细的操作日志和统计

### 业务价值
1. **用户体验**：流畅的抽奖体验
2. **运营管理**：灵活的奖品管理机制
3. **数据驱动**：完整的数据分析能力
4. **系统稳定**：高可用的服务架构
5. **扩展便利**：模块化的系统设计

---

**文档版本**：V4.0.0  
**最后更新**：2025年01月21日 北京时间  
**维护团队**：Restaurant Lottery Development Team 