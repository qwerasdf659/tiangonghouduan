<!--pages/chat/chat.wxml - ç”¨æˆ·ç«¯èŠå¤©ä¼šè¯åˆ—è¡¨ç•Œé¢-->
<view class="chat-sessions-container">

  <!-- é¡¶éƒ¨æœç´¢æ  -->
  <view class="search-header">
    <view class="search-bar">
      <view class="search-icon">ğŸ”</view>
      <input class="search-input" placeholder="æœç´¢èŠå¤©è®°å½•" value="{{searchKeyword}}" bindinput="onSearchInput" />
      <view wx:if="{{searchKeyword}}" class="clear-search" bindtap="clearSearch">Ã—</view>
    </view>
    <view class="new-chat-btn" bindtap="startNewChat">
      <text class="new-chat-icon">âœš</text>
    </view>
  </view>

  <!-- ä¼šè¯åˆ—è¡¨ -->
  <scroll-view class="sessions-list" scroll-y="{{true}}" enhanced="{{true}}" show-scrollbar="{{false}}">

    <!-- åœ¨çº¿å®¢æœä¼šè¯ -->
    <view class="session-item active-session" bindtap="enterCustomerService">
      <view class="session-avatar customer-service-avatar">
        <view class="avatar-bg">
          <text class="avatar-icon">ğŸ§</text>
        </view>
        <view class="online-indicator"></view>
      </view>
      <view class="session-content">
        <view class="session-info">
          <text class="session-name">åœ¨çº¿å®¢æœ</text>
          <text class="session-time">åˆšåˆš</text>
        </view>
        <view class="session-preview">
          <text class="last-message">{{customerServicePreview || 'æ‚¨å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ'}}</text>
          <view wx:if="{{customerServiceUnread > 0}}" class="unread-count">{{customerServiceUnread}}</view>
        </view>
      </view>
    </view>

    <!-- ç³»ç»Ÿé€šçŸ¥ä¼šè¯ -->
    <view class="session-item" bindtap="enterSystemNotify">
      <view class="session-avatar system-avatar">
        <view class="avatar-bg system-bg">
          <text class="avatar-icon">ğŸ””</text>
        </view>
      </view>
      <view class="session-content">
        <view class="session-info">
          <text class="session-name">ç³»ç»Ÿé€šçŸ¥</text>
          <text class="session-time">{{systemNotifyTime || 'ä»Šå¤©'}}</text>
        </view>
        <view class="session-preview">
          <text class="last-message">{{systemNotifyPreview || 'æ¬¢è¿ä½¿ç”¨å¤©å·¥ç§¯åˆ†ç³»ç»Ÿ'}}</text>
          <view wx:if="{{systemNotifyUnread > 0}}" class="unread-count">{{systemNotifyUnread}}</view>
        </view>
      </view>
    </view>

    <!-- AIåŠ©æ‰‹ä¼šè¯ -->
    <view class="session-item" bindtap="enterAIAssistant">
      <view class="session-avatar ai-avatar">
        <view class="avatar-bg ai-bg">
          <text class="avatar-icon">ğŸ¤–</text>
        </view>
      </view>
      <view class="session-content">
        <view class="session-info">
          <text class="session-name">AIåŠ©æ‰‹</text>
          <text class="session-time">{{aiAssistantTime || 'æ˜¨å¤©'}}</text>
        </view>
        <view class="session-preview">
          <text class="last-message">{{aiAssistantPreview || 'æˆ‘æ˜¯æ‚¨çš„ä¸“å±AIåŠ©æ‰‹ï¼Œéšæ—¶ä¸ºæ‚¨è§£ç­”é—®é¢˜'}}</text>
          <view wx:if="{{aiAssistantUnread > 0}}" class="unread-count">{{aiAssistantUnread}}</view>
        </view>
      </view>
    </view>

    <!-- æŠ€æœ¯æ”¯æŒä¼šè¯ -->
    <view class="session-item" bindtap="enterTechSupport">
      <view class="session-avatar tech-avatar">
        <view class="avatar-bg tech-bg">
          <text class="avatar-icon">ğŸ› ï¸</text>
        </view>
      </view>
      <view class="session-content">
        <view class="session-info">
          <text class="session-name">æŠ€æœ¯æ”¯æŒ</text>
          <text class="session-time">{{techSupportTime || '2å¤©å‰'}}</text>
        </view>
        <view class="session-preview">
          <text class="last-message">{{techSupportPreview || 'æŠ€æœ¯é—®é¢˜è¯·å’¨è¯¢æˆ‘ä»¬çš„ä¸“ä¸šå›¢é˜Ÿ'}}</text>
          <view wx:if="{{techSupportUnread > 0}}" class="unread-count">{{techSupportUnread}}</view>
        </view>
      </view>
    </view>

    <!-- æ´»åŠ¨å’¨è¯¢ä¼šè¯ -->
    <view class="session-item" bindtap="enterActivityConsult">
      <view class="session-avatar activity-avatar">
        <view class="avatar-bg activity-bg">
          <text class="avatar-icon">ğŸ‰</text>
        </view>
      </view>
      <view class="session-content">
        <view class="session-info">
          <text class="session-name">æ´»åŠ¨å’¨è¯¢</text>
          <text class="session-time">{{activityConsultTime || '3å¤©å‰'}}</text>
        </view>
        <view class="session-preview">
          <text class="last-message">{{activityConsultPreview || 'æœ€æ–°æ´»åŠ¨ä¿¡æ¯å’Œä¼˜æƒ è¯¦æƒ…'}}</text>
          <view wx:if="{{activityConsultUnread > 0}}" class="unread-count">{{activityConsultUnread}}</view>
        </view>
      </view>
    </view>

    <!-- åé¦ˆå»ºè®®ä¼šè¯ -->
    <view class="session-item" bindtap="enterFeedback">
      <view class="session-avatar feedback-avatar">
        <view class="avatar-bg feedback-bg">
          <text class="avatar-icon">ğŸ’¬</text>
        </view>
      </view>
      <view class="session-content">
        <view class="session-info">
          <text class="session-name">åé¦ˆå»ºè®®</text>
          <text class="session-time">{{feedbackTime || '1å‘¨å‰'}}</text>
        </view>
        <view class="session-preview">
          <text class="last-message">{{feedbackPreview || 'æ‚¨çš„å®è´µæ„è§æ˜¯æˆ‘ä»¬æ”¹è¿›çš„åŠ¨åŠ›'}}</text>
          <view wx:if="{{feedbackUnread > 0}}" class="unread-count">{{feedbackUnread}}</view>
        </view>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view wx:if="{{loading}}" class="loading-more">
      <text class="loading-text">åŠ è½½æ›´å¤šä¼šè¯...</text>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{!hasSession && !loading}}" class="empty-sessions">
      <view class="empty-icon">ğŸ’­</view>
      <text class="empty-text">æš‚æ— èŠå¤©è®°å½•</text>
      <button class="start-chat-btn" bindtap="startNewChat">å¼€å§‹èŠå¤©</button>
    </view>

  </scroll-view>

  <!-- åº•éƒ¨å·¥å…·æ  -->
  <view class="bottom-toolbar single-tab">
    <view class="toolbar-item active" data-tab="messages">
      <text class="toolbar-icon">ğŸ’¬</text>
      <text class="toolbar-label">æ¶ˆæ¯</text>
      <view wx:if="{{totalUnreadCount > 0}}" class="total-unread">{{totalUnreadCount > 99 ? '99+' : totalUnreadCount}}
      </view>
    </view>
  </view>

</view>

<!-- èŠå¤©å¼¹çª— -->
<view class="chat-modal {{showChatModal ? 'show' : ''}}" bindtap="onModalMaskTap">
  <view class="modal-content" catchtap="onModalContentTap">

    <!-- èŠå¤©å¤´éƒ¨ -->
    <view class="chat-header">
      <view class="header-left">
        <text class="back-btn" bindtap="closeChatModal">â†</text>
        <view class="current-session-avatar">
          <view class="avatar-bg {{currentChatType}}-bg">
            <text class="avatar-icon">{{currentChatIcon}}</text>
          </view>
          <view wx:if="{{isOnline}}" class="online-indicator small"></view>
        </view>
        <view class="session-detail">
          <text class="session-name">{{currentChatName}}</text>
          <text class="session-status">{{isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}}</text>
        </view>
      </view>
      <view class="header-right">
        <text class="more-btn" bindtap="showChatMenu">â‹¯</text>
      </view>
    </view>

    <!-- æ¶ˆæ¯åˆ—è¡¨ -->
    <scroll-view class="chat-messages" scroll-y="{{true}}" scroll-into-view="{{scrollToBottom ? 'message-bottom' : ''}}"
      scroll-with-animation="{{true}}" enhanced="{{true}}" show-scrollbar="{{false}}" catchtap="onMessagesAreaTap">

      <!-- å†å²æ¶ˆæ¯åŠ è½½ -->
      <view wx:if="{{isLoadingHistory}}" class="loading-history">
        <text class="loading-text">åŠ è½½å†å²æ¶ˆæ¯...</text>
      </view>

      <!-- æ¶ˆæ¯åˆ—è¡¨ -->
      <view wx:for="{{messages}}" wx:key="id" class="message-item {{item.isOwn ? 'own-message' : 'other-message'}}">
        <!-- æ—¶é—´åˆ†å‰²çº¿ -->
        <view wx:if="{{item.showTime}}" class="time-divider">
          <text class="time-text">{{item.timeText}}</text>
        </view>

        <!-- æ¶ˆæ¯å†…å®¹ -->
        <view class="message-content">
          <!-- å¯¹æ–¹å¤´åƒ -->
          <view wx:if="{{!item.isOwn}}" class="message-avatar">
            <view class="avatar-bg {{currentChatType}}-bg">
              <text class="avatar-icon">{{currentChatIcon}}</text>
            </view>
          </view>

          <!-- æ¶ˆæ¯æ°”æ³¡ -->
          <view class="message-bubble {{item.isOwn ? 'own-bubble' : 'other-bubble'}}">
            <!-- æ–‡å­—æ¶ˆæ¯ -->
            <text wx:if="{{item.messageType === 'text'}}" class="message-text" user-select="{{true}}">
              {{item.content}}
            </text>

            <!-- å›¾ç‰‡æ¶ˆæ¯ -->
            <image wx:if="{{item.messageType === 'image'}}" class="message-image" src="{{item.attachments[0].url}}"
              mode="aspectFit" bindtap="previewImage" data-src="{{item.attachments[0].url}}"></image>

            <!-- ç³»ç»Ÿæ¶ˆæ¯ -->
            <text wx:if="{{item.messageType === 'system'}}" class="system-message">
              {{item.content}}
            </text>
          </view>

          <!-- æ¶ˆæ¯çŠ¶æ€ -->
          <view wx:if="{{item.isOwn}}" class="message-status">
            <text wx:if="{{item.status === 'sending'}}" class="status-icon sending">â³</text>
            <text wx:if="{{item.status === 'sent'}}" class="status-icon sent">âœ“</text>
            <text wx:if="{{item.status === 'delivered'}}" class="status-icon delivered">âœ“âœ“</text>
            <text wx:if="{{item.status === 'read'}}" class="status-icon read">âœ“âœ“</text>
            <text wx:if="{{item.status === 'failed'}}" class="status-icon failed">âŒ</text>
          </view>
        </view>
      </view>

      <!-- è¾“å…¥çŠ¶æ€ -->
      <view wx:if="{{showTypingIndicator}}" class="typing-indicator">
        <view class="typing-avatar">
          <view class="avatar-bg {{currentChatType}}-bg">
            <text class="avatar-icon">{{currentChatIcon}}</text>
          </view>
        </view>
        <view class="typing-bubble">
          <text class="typing-text">{{typingUser || currentChatName}} æ­£åœ¨è¾“å…¥...</text>
          <view class="typing-animation">
            <view class="typing-dot"></view>
            <view class="typing-dot"></view>
            <view class="typing-dot"></view>
          </view>
        </view>
      </view>

      <!-- æ»šåŠ¨é”šç‚¹ -->
      <view id="message-bottom"></view>
    </scroll-view>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <view class="chat-input-area" catchtap="onInputAreaTap">
      <!-- å·¥å…·æ  -->
      <view class="input-toolbar" catchtap="onInputToolbarTap">
        <view class="toolbar-actions">
          <text class="action-btn" bindtap="sendImage">ğŸ“·</text>
          <text class="action-btn" bindtap="sendLocation">ğŸ“</text>
          <text class="action-btn" bindtap="sendFile">ğŸ“</text>
        </view>

        <!-- è¾“å…¥æ¡†åŒºåŸŸ -->
        <view class="input-section" catchtap="onInputWrapperTap">
          <!-- è¾“å…¥æ¡† -->
          <view class="input-wrapper">
            <textarea class="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..." value="{{inputContent}}" bindinput="onInputChange"
              bindfocus="onInputFocus" bindblur="onInputBlur" auto-height="{{true}}" show-confirm-bar="{{false}}"
              maxlength="500" catchtap="onTextareaTap">
            </textarea>
            <!-- å†…ç½®å‘é€æŒ‰é’® -->
            <view class="inline-send-btn {{inputContent.trim() ? 'active' : 'inactive'}}" catchtap="onInlineSendTap">
              <text class="send-text">å‘é€</text>
            </view>
          </view>
        </view>

        <!-- åŸæœ‰å‘é€æŒ‰é’®ï¼ˆä¿ç•™ä½œä¸ºå¤‡ç”¨ï¼‰ -->
        <view class="send-wrapper" catchtap="onSendWrapperTap" style="display: none;">
          <button class="send-btn {{inputContent.trim() ? 'active' : 'inactive'}}" disabled="{{!inputContent.trim()}}"
            bindtap="sendMessage">
            <text class="send-icon">â¤</text>
          </button>
        </view>
      </view>
    </view>

  </view>
</view>