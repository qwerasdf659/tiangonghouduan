<!--pages/feedback/feedback.wxml - å®¢æœåé¦ˆæäº¤é¡µé¢-->
<view class="feedback-container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <view class="header-title">
      <text class="title">è”ç³»å®¢æœ</text>
      <text class="subtitle">æˆ‘ä»¬å°†åœ¨24å°æ—¶å†…å›å¤æ‚¨çš„é—®é¢˜</text>
    </view>
    <view class="header-actions">
      <button class="history-btn" bindtap="onShowHistoryModal">
        <text class="icon">ğŸ“‹</text>
        <text class="text">æˆ‘çš„åé¦ˆ</text>
      </button>
    </view>
  </view>

  <!-- åé¦ˆåˆ†ç±»é€‰æ‹© -->
  <view class="section">
    <view class="section-title">
      <text class="title">é—®é¢˜åˆ†ç±»</text>
      <text class="required">*</text>
    </view>
    <view class="category-grid">
      <view wx:for="{{categories}}" wx:key="value"
        class="category-item {{selectedCategory === item.value ? 'selected' : ''}}" data-category="{{item.value}}"
        bindtap="onCategoryChange">
        <text class="icon">{{item.icon}}</text>
        <text class="label">{{item.label}}</text>
      </view>
    </view>
  </view>

  <!-- åé¦ˆå†…å®¹ -->
  <view class="section">
    <view class="section-title">
      <text class="title">è¯¦ç»†æè¿°</text>
      <text class="required">*</text>
    </view>
    <view class="content-input-container">
      <textarea class="content-input" placeholder="è¯·è¯¦ç»†æè¿°æ‚¨é‡åˆ°çš„é—®é¢˜æˆ–å»ºè®®ï¼Œè‡³å°‘10ä¸ªå­—ç¬¦" maxlength="{{maxLength}}"
        value="{{feedbackContent}}" bindinput="onContentInput" auto-height show-confirm-bar="{{false}}"></textarea>
      <view class="input-footer">
        <text class="char-count {{currentLength >= maxLength ? 'limit' : ''}}">
          {{currentLength}}/{{maxLength}}
        </text>
      </view>
    </view>
  </view>

  <!-- å›¾ç‰‡é™„ä»¶ -->
  <view class="section">
    <view class="section-title">
      <text class="title">å›¾ç‰‡é™„ä»¶</text>
      <text class="optional">ï¼ˆé€‰å¡«ï¼Œæœ€å¤š3å¼ ï¼‰</text>
    </view>
    <view class="image-upload-container">
      <view wx:for="{{attachedImages}}" wx:key="index" class="image-item">
        <image class="image" src="{{item.path}}" mode="aspectFill" data-index="{{index}}" bindtap="onPreviewImage">
        </image>
        <view class="delete-btn" data-index="{{index}}" bindtap="onDeleteImage">
          <text class="icon">Ã—</text>
        </view>
      </view>

      <view wx:if="{{attachedImages.length < 3}}" class="add-image-btn" bindtap="onAddImage">
        <text class="icon">ğŸ“·</text>
        <text class="text">æ·»åŠ å›¾ç‰‡</text>
      </view>
    </view>
  </view>

  <!-- æäº¤æŒ‰é’® -->
  <view class="submit-section">
    <button class="submit-btn {{canSubmit ? 'enabled' : 'disabled'}}" disabled="{{!canSubmit || submitting}}"
      bindtap="onSubmitFeedback">
      <text wx:if="{{submitting}}">æäº¤ä¸­...</text>
      <text wx:else>æäº¤åé¦ˆ</text>
    </button>

    <view class="submit-tips">
      <text class="tip">ğŸ’¡ æäº¤åæ‚¨å°†æ”¶åˆ°å®æ—¶å›å¤é€šçŸ¥</text>
    </view>
  </view>

  <!-- æœ€è¿‘åé¦ˆè®°å½•é¢„è§ˆ -->
  <view class="section" wx:if="{{myFeedbacks.length > 0}}">
    <view class="section-title">
      <text class="title">æœ€è¿‘åé¦ˆ</text>
      <text class="more" bindtap="onViewHistory">æŸ¥çœ‹æ›´å¤š ></text>
    </view>
    <view class="feedback-history-preview">
      <view wx:for="{{myFeedbacks}}" wx:key="feedbackId" class="history-item" data-feedback-id="{{item.feedbackId}}"
        bindtap="onHistoryItemTap">
        <view class="item-header">
          <text class="category">{{item.category}}</text>
          <text class="status {{item.status}}">
            {{item.status === 'pending' ? 'å¾…å¤„ç†' :
            item.status === 'replied' ? 'å·²å›å¤' :
            item.status === 'closed' ? 'å·²å…³é—­' : 'å¤„ç†ä¸­'}}
          </text>
        </view>
        <text class="content">{{item.content}}</text>
        <text class="time">{{item.submittedAt}}</text>
      </view>
    </view>
  </view>
</view>

<!-- å†å²è®°å½•æ¨¡æ€æ¡† -->
<view class="modal-overlay {{showHistoryModal ? 'show' : ''}}" bindtap="onHideHistoryModal">
  <view class="modal-content" catchtap="">
    <view class="modal-header">
      <text class="modal-title">æˆ‘çš„åé¦ˆè®°å½•</text>
      <view class="close-btn" bindtap="onHideHistoryModal">Ã—</view>
    </view>

    <view class="modal-body">
      <view wx:if="{{loadingHistory}}" class="loading-state">
        <text>åŠ è½½ä¸­...</text>
      </view>

      <view wx:elif="{{myFeedbacks.length === 0}}" class="empty-state">
        <text class="icon">ğŸ“</text>
        <text class="message">æš‚æ— åé¦ˆè®°å½•</text>
      </view>

      <view wx:else class="feedback-list">
        <view wx:for="{{myFeedbacks}}" wx:key="feedbackId" class="feedback-item" data-feedback-id="{{item.feedbackId}}"
          bindtap="onHistoryItemTap">
          <view class="item-status">
            <text class="status-badge {{item.status}}">
              {{item.status === 'pending' ? 'å¾…å¤„ç†' :
              item.status === 'replied' ? 'å·²å›å¤' :
              item.status === 'closed' ? 'å·²å…³é—­' : 'å¤„ç†ä¸­'}}
            </text>
          </view>
          <view class="item-content">
            <text class="content">{{item.content}}</text>
            <text class="time">{{item.submittedAt}}</text>
          </view>
          <view class="item-arrow">></view>
        </view>
      </view>
    </view>

    <view class="modal-footer">
      <button class="view-all-btn" bindtap="onViewHistory">æŸ¥çœ‹å…¨éƒ¨è®°å½•</button>
    </view>
  </view>
</view>