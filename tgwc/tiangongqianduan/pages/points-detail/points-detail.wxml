<!--pages/points-detail/points-detail.wxml - ç§¯åˆ†è¯¦æƒ…é¡µé¢æ¨¡æ¿ï¼ˆåŸºäºæ—§é¡¹ç›®UIç»“æ„é‡æ–°å®ç°ï¼‰-->

<view class="points-detail-container">
  <!-- ğŸ”´ ç§¯åˆ†ä½™é¢å±•ç¤º - ä¸æ—§é¡¹ç›®ä¸€è‡´çš„UI -->
  <view class="points-balance-card">
    <view class="balance-header">
      <view class="balance-title">å¯ç”¨ç§¯åˆ†</view>
      <view class="balance-tips" bindtap="onBackTap">âœ•</view>
    </view>
    <view class="balance-amount">
      <text class="balance-number">{{totalPoints || 0}}</text>
      <text class="balance-unit">åˆ†</text>
    </view>
    <view class="balance-desc">ç§¯åˆ†ä½™é¢å˜åŠ¨è®°å½•</view>
  </view>

  <!-- ğŸ”´ ç­›é€‰åŠŸèƒ½ - ä¸æ—§é¡¹ç›®ä¸€è‡´çš„ç­›é€‰æ¡ä»¶ -->
  <view class="filter-section">
    <view class="filter-title">ç­›é€‰è®°å½•</view>
    <view class="filter-tabs">
      <view class="filter-tab {{pointsFilter === 'all' ? 'active' : ''}}" data-filter="all"
        bindtap="onPointsFilterChange">
        <view class="filter-icon">ğŸ“Š</view>
        <text class="filter-text">å…¨éƒ¨è®°å½•</text>
      </view>
      <view class="filter-tab {{pointsFilter === 'earn' ? 'active' : ''}}" data-filter="earn"
        bindtap="onPointsFilterChange">
        <view class="filter-icon">ğŸ’°</view>
        <text class="filter-text">ç§¯åˆ†è·å¾—</text>
      </view>
      <view class="filter-tab {{pointsFilter === 'consume' ? 'active' : ''}}" data-filter="consume"
        bindtap="onPointsFilterChange">
        <view class="filter-icon">ğŸ›’</view>
        <text class="filter-text">ç§¯åˆ†æ¶ˆè´¹</text>
      </view>
    </view>
  </view>

  <!-- ğŸ”´ ç§¯åˆ†è®°å½•åˆ—è¡¨ - ä¸æ—§é¡¹ç›®ä¸€è‡´çš„è®°å½•å±•ç¤º -->
  <view class="records-section">
    <view class="records-header">
      <view class="records-title">ç§¯åˆ†æ˜ç»†</view>
      <view class="records-count">
        å…± {{filteredPointsRecords.length || 0}} æ¡è®°å½•
      </view>
    </view>

    <!-- ğŸ”´ è®°å½•åˆ—è¡¨ -->
    <view class="records-list" wx:if="{{filteredPointsRecords.length > 0}}">
      <view class="record-item {{item.transaction_type === 'earn' ? 'earn-type' : 'consume-type'}}"
        wx:for="{{filteredPointsRecords}}" wx:key="transaction_id">

        <!-- ğŸ”´ è®°å½•å›¾æ ‡å’Œç±»å‹ -->
        <view class="record-icon">
          <view class="icon-bg {{item.transaction_type === 'earn' ? 'earn-bg' : 'consume-bg'}}">
            <text class="icon-symbol">{{item.transaction_type === 'earn' ? '+' : '-'}}</text>
          </view>
        </view>

        <!-- ğŸ”´ è®°å½•è¯¦æƒ… -->
        <view class="record-detail">
          <view class="record-main">
            <!-- ğŸ”¥ ä½¿ç”¨åç«¯è¿”å›çš„transaction_title -->
            <view class="record-title">
              {{item.displayTitle || 'ç§¯åˆ†è®°å½•'}}
            </view>
            <!-- ğŸ”¥ æ˜¾ç¤ºæ ¼å¼åŒ–åçš„é‡‘é¢ -->
            <view class="record-points {{item.transaction_type === 'earn' ? 'earn-points' : 'consume-points'}}">
              {{item.displayAmount}}
            </view>
          </view>

          <!-- ğŸ”¥ æ˜¾ç¤ºå‹å¥½çš„æ—¶é—´æ ¼å¼ -->
          <view class="record-meta">
            <view class="record-time">
              {{item.displayTime}}
            </view>
            <!-- å¯é€‰ï¼šæ˜¾ç¤ºè¯¦ç»†æè¿° -->
            <view class="record-desc" wx:if="{{item.transaction_description}}">
              {{item.transaction_description}}
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ğŸ”´ ç©ºçŠ¶æ€å±•ç¤º -->
    <view class="empty-state" wx:if="{{filteredPointsRecords.length === 0 && !loading}}">
      <view class="empty-icon">ğŸ’³</view>
      <view class="empty-title">
        {{pointsFilter === 'all' ? 'æš‚æ— ç§¯åˆ†è®°å½•' :
        (pointsFilter === 'earn' ? 'æš‚æ— ç§¯åˆ†è·å¾—è®°å½•' : 'æš‚æ— ç§¯åˆ†æ¶ˆè´¹è®°å½•')}}
      </view>
      <view class="empty-desc">
        {{pointsFilter === 'all' ? 'æ‚¨è¿˜æ²¡æœ‰ä»»ä½•ç§¯åˆ†å˜åŠ¨è®°å½•' :
        (pointsFilter === 'earn' ? 'æ‚¨è¿˜æ²¡æœ‰è·å¾—ç§¯åˆ†çš„è®°å½•' : 'æ‚¨è¿˜æ²¡æœ‰æ¶ˆè´¹ç§¯åˆ†çš„è®°å½•')}}
      </view>
      <view class="empty-actions">
        <view class="empty-btn" bindtap="onBackTap">è¿”å›ç”¨æˆ·ä¸­å¿ƒ</view>
      </view>
    </view>

    <!-- ğŸ”´ åŠ è½½æ›´å¤š -->
    <view class="load-more-section" wx:if="{{hasMoreRecords}}">
      <view class="load-more-btn" bindtap="loadMoreRecords" wx:if="{{!loading}}">
        <view class="load-more-icon">â¬‡ï¸</view>
        <text class="load-more-text">åŠ è½½æ›´å¤šè®°å½•</text>
      </view>
      <view class="loading-state" wx:if="{{loading}}">
        <view class="loading-spinner"></view>
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>
    </view>

    <!-- ğŸ”´ æ²¡æœ‰æ›´å¤šè®°å½•æç¤º -->
    <view class="no-more-section" wx:if="{{!hasMoreRecords && filteredPointsRecords.length > 0}}">
      <view class="no-more-line"></view>
      <view class="no-more-text">å·²åŠ è½½å…¨éƒ¨è®°å½•</view>
      <view class="no-more-line"></view>
    </view>
  </view>

  <!-- ğŸ”´ æœ€åæ›´æ–°æ—¶é—´ -->
  <view class="update-info" wx:if="{{lastUpdateTime}}">
    <view class="update-time">æœ€åæ›´æ–°ï¼š{{lastUpdateTime}}</view>
  </view>

  <!-- ğŸ”´ æµ‹è¯•åŠŸèƒ½æŒ‰é’®ï¼ˆå¼€å‘é˜¶æ®µï¼‰ -->
  <view class="test-section" wx:if="{{true}}">
    <view class="test-btn" bindtap="onTestPointsDetail">
      ğŸ§ª æµ‹è¯•ç§¯åˆ†è¯¦æƒ…
    </view>
    <view class="test-btn" bindtap="testApiParameterMapping"
      style="margin-top: 20rpx; background: linear-gradient(135deg, #4CAF50, #66BB6A);">
      ğŸ”§ æµ‹è¯•APIå‚æ•°æ˜ å°„
    </view>
    <view class="test-btn" bindtap="testLotteryDescriptionFormatting"
      style="margin-top: 20rpx; background: linear-gradient(135deg, #FF6B35, #F7931E);">
      ğŸ¯ æµ‹è¯•æè¿°æ ¼å¼åŒ–
    </view>
    <view class="test-btn" bindtap="testAggregationFunction"
      style="margin-top: 20rpx; background: linear-gradient(135deg, #9C27B0, #E91E63);">
      ğŸŠ æµ‹è¯•èšåˆåŠŸèƒ½
    </view>
  </view>
</view>

<!-- ğŸ”´ å…¨å±åŠ è½½çŠ¶æ€ -->
<view class="fullscreen-loading" wx:if="{{loading && filteredPointsRecords.length === 0}}">
  <view class="loading-content">
    <view class="loading-spinner-large"></view>
    <view class="loading-title">åŠ è½½ä¸­...</view>
    <view class="loading-desc">æ­£åœ¨è·å–æ‚¨çš„ç§¯åˆ†è®°å½•</view>
  </view>
</view>