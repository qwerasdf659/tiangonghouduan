<!--pages/admin/chat-management/chat-management.wxml - ç®¡ç†å‘˜èŠå¤©å·¥ä½œå°-->
<view class="chat-management-container">

  <!-- ç®¡ç†å‘˜çŠ¶æ€æ  -->
  <view class="admin-status-bar">
    <view class="status-info">
      <text class="status-text">å·¥ä½œçŠ¶æ€ï¼š</text>
      <text class="status-badge {{adminStatus}}">
        {{adminStatus === 'online' ? 'ğŸŸ¢ åœ¨çº¿æœåŠ¡' :
        adminStatus === 'busy' ? 'ğŸŸ¡ å¿™ç¢Œä¸­' : 'ğŸ”´ ç¦»çº¿'}}
      </text>
    </view>
    <view class="connection-info">
      <text class="ws-status {{wsConnected ? 'connected' : 'disconnected'}}">
        {{wsConnected ? 'ğŸ”— è¿æ¥æ­£å¸¸' : 'âŒ è¿æ¥å¼‚å¸¸'}}
      </text>
    </view>
  </view>

  <!-- èŠå¤©å·¥ä½œå°ä¸»åŒºåŸŸ -->
  <view class="chat-workspace">

    <!-- ä¼šè¯åˆ—è¡¨é¢æ¿ -->
    <view class="sessions-panel" wx:if="{{showSessionList}}">
      <view class="panel-header">
        <text class="panel-title">å¾…å¤„ç†ä¼šè¯ ({{sessions.length}})</text>
        <button class="refresh-btn" bindtap="loadSessions">åˆ·æ–°</button>
      </view>

      <scroll-view class="sessions-list" scroll-y>
        <view wx:if="{{loadingSessions}}" class="loading-sessions">
          <text class="loading-text">åŠ è½½ä¼šè¯ä¸­...</text>
        </view>

        <view wx:if="{{!loadingSessions && sessions.length === 0}}" class="empty-sessions">
          <text class="empty-text">æš‚æ— å¾…å¤„ç†ä¼šè¯</text>
        </view>

        <view wx:else class="sessions-content">
          <view wx:for="{{sessions}}" wx:key="id" class="session-item {{item.id === currentSessionId ? 'active' : ''}}"
            bindtap="selectSession" data-session="{{item}}">
            <view class="session-avatar">
              <text class="avatar-text">{{item.userName ? item.userName.substring(0, 1) : 'ç”¨'}}</text>
            </view>
            <view class="session-detail">
              <view class="session-header">
                <text class="session-name">{{item.userName || 'åŒ¿åç”¨æˆ·'}}</text>
                <text class="session-time">{{item.lastMessageTime}}</text>
              </view>
              <view class="session-preview">
                <text class="preview-text">{{item.lastMessage || 'ç‚¹å‡»å¼€å§‹å¯¹è¯'}}</text>
                <view wx:if="{{item.unreadCount > 0}}" class="unread-badge">
                  <text class="unread-count">{{item.unreadCount}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- èŠå¤©åŒºåŸŸ -->
    <view class="chat-panel">
      <!-- èŠå¤©å¤´éƒ¨ -->
      <view class="chat-header" wx:if="{{currentSessionId}}">
        <view class="current-session-info">
          <view class="current-session-avatar">
            <text class="avatar-text">ç”¨</text>
          </view>
          <view class="session-detail">
            <text class="session-name">{{currentSessionUserName || 'ç”¨æˆ·'}}</text>
            <text class="session-status">å¯¹è¯è¿›è¡Œä¸­</text>
          </view>
        </view>
        <view class="chat-actions">
          <button class="action-btn" bindtap="endSession">ç»“æŸå¯¹è¯</button>
        </view>
      </view>

      <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
      <scroll-view class="messages-container" scroll-y scroll-into-view="{{scrollToBottom ? 'message-bottom' : ''}}"
        scroll-with-animation>
        <view wx:if="{{!currentSessionId}}" class="no-session-selected">
          <text class="no-session-text">è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªä¼šè¯å¼€å§‹å¯¹è¯</text>
        </view>

        <view wx:elif="{{currentMessages.length === 0}}" class="empty-messages">
          <text class="empty-text">ä¼šè¯å¼€å§‹ï¼Œè¯·ç¤¼è²Œå›å¤ç”¨æˆ·</text>
        </view>

        <view wx:else class="messages-list">
          <view wx:for="{{currentMessages}}" wx:key="id"
            class="message-item {{item.senderType === 'admin' ? 'admin' : 'user'}}">
            <view class="message-avatar">
              <text class="avatar-text">{{item.senderType === 'admin' ? 'å®¢' : 'ç”¨'}}</text>
            </view>
            <view class="message-content">
              <view class="message-bubble">
                <text class="message-text">{{item.content}}</text>
              </view>
              <view class="message-meta">
                <text class="message-time">{{item.createdAt}}</text>
                <text wx:if="{{item.senderType === 'admin'}}" class="message-status {{item.status}}">
                  {{item.status === 'sending' ? 'å‘é€ä¸­' :
                  item.status === 'sent' ? 'å·²å‘é€' :
                  item.status === 'failed' ? 'å‘é€å¤±è´¥' : ''}}
                </text>
              </view>
            </view>
          </view>
        </view>
        <view id="message-bottom"></view>
      </scroll-view>

      <!-- èŠå¤©è¾“å…¥åŒºåŸŸ -->
      <view class="chat-input-container" wx:if="{{currentSessionId}}">
        <view class="input-toolbar">
          <view class="quick-reply-btn" bindtap="toggleQuickReplies">
            <text class="btn-icon">ğŸ’¬</text>
          </view>

          <view class="input-wrapper">
            <textarea class="message-input" value="{{inputContent}}" placeholder="è¾“å…¥å›å¤å†…å®¹..." bindinput="onInputChange"
              bindblur="stopTyping" bindfocus="startTyping" maxlength="500" auto-height>
            </textarea>
          </view>

          <button class="send-btn {{inputContent.trim() ? 'active' : ''}}" bindtap="sendMessage"
            disabled="{{!inputContent.trim()}}">
            <text class="send-icon">ğŸ“¤</text>
          </button>
        </view>

        <!-- å¿«æ·å›å¤é¢æ¿ -->
        <view class="quick-replies-panel" wx:if="{{showQuickReplies}}">
          <view class="quick-replies-header">
            <text class="panel-title">å¿«æ·å›å¤</text>
            <button class="close-btn" bindtap="toggleQuickReplies">Ã—</button>
          </view>
          <view class="quick-replies-list">
            <view wx:for="{{quickReplies}}" wx:key="id" class="quick-reply-item" bindtap="useQuickReply"
              data-content="{{item.content}}">
              <text class="reply-title">{{item.title}}</text>
              <text class="reply-content">{{item.content}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- æ— ä¼šè¯æç¤º -->
      <view class="no-session-tips" wx:if="{{!currentSessionId}}">
        <text class="tips-text">é€‰æ‹©å·¦ä¾§ä¼šè¯å¼€å§‹å®¢æœå·¥ä½œ</text>
      </view>
    </view>
  </view>

  <!-- ä»Šæ—¥ç»Ÿè®¡ -->
  <view class="stats-panel">
    <view class="stats-header">
      <text class="stats-title">ä»Šæ—¥ç»Ÿè®¡</text>
    </view>
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-number">{{todayStats.totalSessions}}</text>
        <text class="stat-label">æ€»ä¼šè¯</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{todayStats.completedSessions}}</text>
        <text class="stat-label">å·²å®Œæˆ</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{todayStats.avgResponseTime}}</text>
        <text class="stat-label">å¹³å‡å“åº”</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{todayStats.customerSatisfaction}}%</text>
        <text class="stat-label">æ»¡æ„åº¦</text>
      </view>
    </view>
  </view>
</view>