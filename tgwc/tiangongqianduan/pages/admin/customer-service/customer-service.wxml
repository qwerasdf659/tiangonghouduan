<!--pages/admin/customer-service/customer-service.wxml - ç®¡ç†å‘˜å®¢æœç®¡ç†é¡µé¢-->
<view class="customer-service-container">

  <!-- ğŸ”´ å®æ—¶èŠå¤©æ¨¡å¼ -->
  <view class="chat-mode-container">
    <!-- ç®¡ç†å‘˜çŠ¶æ€æ  -->
    <view class="admin-status-bar">
      <view class="status-info">
        <text class="status-text">å½“å‰çŠ¶æ€ï¼š</text>
        <text class="status-badge {{adminStatus}}">
          {{adminStatus === 'online' ? 'ğŸŸ¢ åœ¨çº¿' :
          adminStatus === 'busy' ? 'ğŸŸ¡ å¿™ç¢Œ' : 'ğŸ”´ ç¦»çº¿'}}
        </text>
      </view>
      <view class="connection-info">
        <text class="ws-status {{wsConnected ? 'connected' : 'disconnected'}}">
          {{wsConnected ? 'ğŸ”— å·²è¿æ¥' : 'âŒ æœªè¿æ¥'}}
        </text>
      </view>
    </view>

    <!-- èŠå¤©å·¥ä½œå°ä¸»åŒºåŸŸ -->
    <view class="chat-workspace {{chatExpanded ? 'expanded' : ''}}">
      <!-- ä¼šè¯åˆ—è¡¨ -->
      <view wx:if="{{!chatExpanded}}" class="sessions-panel">
        <view class="panel-header">
          <text class="panel-title">æ´»è·ƒä¼šè¯</text>
          <text class="session-count">({{sessions.length}})</text>
        </view>

        <view wx:if="{{loadingSessions}}" class="loading-sessions">
          <text>åŠ è½½ä¼šè¯ä¸­...</text>
        </view>

        <view wx:elif="{{sessions.length === 0}}" class="empty-sessions">
          <text class="empty-icon">ğŸ’¬</text>
          <text class="empty-text">æš‚æ— æ´»è·ƒä¼šè¯</text>
        </view>

        <view wx:else class="sessions-list">
          <view wx:for="{{sessions}}" wx:key="sessionId"
            class="session-item {{currentSessionId === item.sessionId ? 'active' : ''}}"
            data-session-id="{{item.sessionId}}" bindtap="onSelectSession">
            <view class="session-avatar">
              <text class="avatar-text">{{item.userInfo.nickname ? item.userInfo.nickname.charAt(0) : 'ç”¨'}}</text>
            </view>
            <view class="session-info">
              <view class="session-header">
                <text class="user-name">{{item.userInfo.nickname || 'ç”¨æˆ·' + item.userId}}</text>
                <text class="session-time">{{item.lastMessageTime}}</text>
              </view>
              <view class="session-preview">
                <text class="last-message">{{item.lastMessage || 'ç­‰å¾…å®¢æœå›å¤...'}}</text>
                <view wx:if="{{item.unreadCount > 0}}" class="unread-badge">{{item.unreadCount}}</view>
              </view>
              <view class="session-status">
                <text class="status-tag {{item.status}}">
                  {{item.status === 'waiting' ? 'ç­‰å¾…å›å¤' :
                  item.status === 'active' ? 'è¿›è¡Œä¸­' : 'å·²ç»“æŸ'}}
                </text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- èŠå¤©åŒºåŸŸ -->
      <view class="chat-panel {{chatExpanded ? 'expanded' : ''}}">
        <view wx:if="{{!currentSessionId}}" class="no-session-selected">
          <text class="no-session-icon">ğŸ’¬</text>
          <text class="no-session-text">è¯·é€‰æ‹©ä¸€ä¸ªä¼šè¯å¼€å§‹èŠå¤©</text>
        </view>

        <view wx:else class="chat-container">
          <!-- èŠå¤©å¤´éƒ¨ -->
          <view class="chat-header">
            <view wx:if="{{chatExpanded}}" class="back-btn" bindtap="onCloseChatExpanded">
              <text class="back-icon">â†</text>
              <text class="back-text">è¿”å›åˆ—è¡¨</text>
            </view>
            <view class="chat-user-info">
              <text class="chat-user-name">{{currentSessionUserName || 'ç”¨æˆ·'}}</text>
              <text class="chat-session-id">ä¼šè¯ID: {{currentSessionId}}</text>
            </view>
            <view class="chat-actions">
              <button class="action-btn" bindtap="onEndSession">ç»“æŸä¼šè¯</button>
            </view>
          </view>

          <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
          <scroll-view class="messages-container" scroll-y scroll-top="{{scrollToBottom ? 99999 : 0}}"
            scroll-into-view="{{scrollToBottom ? 'message-bottom' : ''}}">
            <view wx:if="{{currentMessages.length === 0}}" class="empty-messages">
              <text class="empty-text">ä¼šè¯å¼€å§‹ï¼Œè¯·ç¤¼è²Œå›å¤ç”¨æˆ·</text>
            </view>

            <view wx:else class="messages-list">
              <view wx:for="{{currentMessages}}" wx:key="id"
                class="message-item {{item.senderType === 'admin' ? 'admin' : 'user'}}">
                <view class="message-avatar">
                  <text class="avatar-text">{{item.senderType === 'admin' ? 'å®¢' : 'ç”¨'}}</text>
                </view>
                <view class="message-content">
                  <view class="message-bubble">
                    <text class="message-text">{{item.content}}</text>
                  </view>
                  <view class="message-meta">
                    <text class="message-time">{{item.createdAt}}</text>
                    <text wx:if="{{item.senderType === 'admin'}}" class="message-status {{item.status}}">
                      {{item.status === 'sending' ? 'å‘é€ä¸­' :
                      item.status === 'sent' ? 'å·²å‘é€' :
                      item.status === 'failed' ? 'å‘é€å¤±è´¥' : ''}}
                    </text>
                  </view>
                </view>
              </view>
            </view>
            <view id="message-bottom"></view>
          </scroll-view>

          <!-- èŠå¤©è¾“å…¥åŒºåŸŸ -->
          <view class="chat-input-container">
            <!-- å¿«æ·å›å¤ -->
            <view wx:if="{{showQuickReplies}}" class="quick-replies-panel">
              <view class="quick-reply-item" data-content="æ‚¨å¥½ï¼Œæˆ‘æ˜¯å®¢æœï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ" bindtap="onQuickReplySelect">
                <text>æ‚¨å¥½ï¼Œæˆ‘æ˜¯å®¢æœï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ</text>
              </view>
              <view class="quick-reply-item" data-content="æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼Œæˆ‘ä»¬ä¼šå°½å¿«å¤„ç†ã€‚" bindtap="onQuickReplySelect">
                <text>æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼Œæˆ‘ä»¬ä¼šå°½å¿«å¤„ç†ã€‚</text>
              </view>
              <view class="quick-reply-item" data-content="è¯·æ‚¨ç¨ç­‰ï¼Œæˆ‘å¸®æ‚¨æŸ¥è¯¢ä¸€ä¸‹ã€‚" bindtap="onQuickReplySelect">
                <text>è¯·æ‚¨ç¨ç­‰ï¼Œæˆ‘å¸®æ‚¨æŸ¥è¯¢ä¸€ä¸‹ã€‚</text>
              </view>
              <view class="quick-reply-item" data-content="é—®é¢˜å·²è§£å†³ï¼Œå¦‚æœ‰å…¶ä»–é—®é¢˜è¯·éšæ—¶è”ç³»ã€‚" bindtap="onQuickReplySelect">
                <text>é—®é¢˜å·²è§£å†³ï¼Œå¦‚æœ‰å…¶ä»–é—®é¢˜è¯·éšæ—¶è”ç³»ã€‚</text>
              </view>
            </view>

            <!-- è¾“å…¥æ¡†å·¥å…·æ  -->
            <view class="input-toolbar">
              <button class="toolbar-btn" bindtap="toggleQuickReplies">
                <text class="btn-icon">âš¡</text>
              </button>
              <button class="toolbar-btn debug-toggle-btn" bindtap="toggleDebugPanel">
                <text class="btn-icon">ğŸ”§</text>
              </button>
            </view>

            <!-- è¾“å…¥æ¡†å’Œå‘é€æŒ‰é’® -->
            <view class="input-area">
              <textarea class="message-input" placeholder="è¾“å…¥å›å¤å†…å®¹..." value="{{inputContent}}"
                bindinput="onChatInputChange" bindfocus="onChatInputFocus" bindblur="onChatInputBlur" maxlength="500"
                auto-height show-confirm-bar="{{false}}"></textarea>
              <button class="send-btn {{sendButtonEnabled ? 'active' : 'disabled'}}" disabled="{{!sendButtonEnabled}}"
                bindtap="sendChatMessage">
                <text class="send-icon">ğŸ“¤</text>
                <text class="send-text">å‘é€</text>
              </button>
            </view>

            <!-- è¾“å…¥çŠ¶æ€æç¤º -->
            <view wx:if="{{isTyping}}" class="typing-indicator">
              <text>æ­£åœ¨è¾“å…¥...</text>
            </view>

            <!-- ğŸ”§ èŠå¤©é¢æ¿è°ƒè¯•å·¥å…· -->
            <view wx:if="{{showDebugPanel}}" class="chat-debug-panel">
              <view class="debug-panel-header">
                <text class="debug-panel-title">ğŸ”§ èŠå¤©è°ƒè¯•å·¥å…·</text>
                <view class="debug-status-bar">
                  <text class="status-item">WS: {{wsConnected ? 'âœ…' : 'âŒ'}}</text>
                  <text class="status-item">ä¼šè¯: {{currentSessionId ? 'âœ…' : 'âŒ'}}</text>
                  <text class="status-item">è´¨é‡: {{connectionQuality === 'good' ? 'ğŸ’š' : connectionQuality === 'poor' ?
                    'ğŸ’›' : 'ğŸ’”'}}</text>
                  <text class="status-item">é‡è¿: {{reconnectAttempts}}/{{maxReconnectAttempts}}</text>
                </view>
              </view>

              <view class="debug-quick-actions">
                <!-- å¿«é€Ÿè¯Šæ–­æŒ‰é’® -->
                <button class="debug-quick-btn" bindtap="debugCheckStatus">
                  <text class="btn-icon">ğŸ“Š</text>
                  <text class="btn-text">çŠ¶æ€æ£€æŸ¥</text>
                </button>

                <button class="debug-quick-btn" bindtap="debugSendTestMessage">
                  <text class="btn-icon">ğŸ§ª</text>
                  <text class="btn-text">æµ‹è¯•å‘é€</text>
                </button>

                <button class="debug-quick-btn" bindtap="debugReconnectWebSocket">
                  <text class="btn-icon">ğŸ”„</text>
                  <text class="btn-text">é‡è¿WS</text>
                </button>

                <button class="debug-quick-btn" bindtap="debugSendHeartbeat">
                  <text class="btn-icon">ğŸ’“</text>
                  <text class="btn-text">å‘é€å¿ƒè·³</text>
                </button>

                <button class="debug-quick-btn" bindtap="debugTestAPI">
                  <text class="btn-icon">ğŸ”—</text>
                  <text class="btn-text">æµ‹è¯•API</text>
                </button>

                <button class="debug-quick-btn" bindtap="debugCheckSendButton">
                  <text class="btn-icon">ğŸ”</text>
                  <text class="btn-text">æ£€æŸ¥å‘é€æŒ‰é’®</text>
                </button>
              </view>

              <!-- è¯¦ç»†è°ƒè¯•é¢æ¿ -->
              <view class="debug-detailed-panel">
                <view class="debug-section-compact">
                  <text class="debug-section-title-compact">âš¡ WebSocketæ§åˆ¶</text>
                  <view class="debug-buttons-compact">
                    <button class="debug-btn-compact" bindtap="debugCheckWebSocket">æ£€æŸ¥WS</button>
                    <button class="debug-btn-compact" bindtap="debugSendTestWS">æµ‹è¯•WS</button>
                    <button class="debug-btn-compact" bindtap="debugCloseWebSocket">æ–­å¼€WS</button>
                  </view>
                </view>

                <view class="debug-section-compact">
                  <text class="debug-section-title-compact">ğŸ”— APIæµ‹è¯•</text>
                  <view class="debug-buttons-compact">
                    <button class="debug-btn-compact" bindtap="debugTestAPI">è¿æ¥æµ‹è¯•</button>
                    <button class="debug-btn-compact" bindtap="debugLoadSessions">é‡è½½ä¼šè¯</button>
                    <button class="debug-btn-compact" bindtap="debugCheckNetwork">ç½‘ç»œæ£€æŸ¥</button>
                  </view>
                </view>

                <view class="debug-section-compact">
                  <text class="debug-section-title-compact">ğŸ“‹ æ•°æ®æ“ä½œ</text>
                  <view class="debug-buttons-compact">
                    <button class="debug-btn-compact" bindtap="debugShowCurrentData">æŸ¥çœ‹æ•°æ®</button>
                    <button class="debug-btn-compact" bindtap="debugClearMessages">æ¸…ç©ºæ¶ˆæ¯</button>
                    <button class="debug-btn-compact" bindtap="debugExportLogs">å¯¼å‡ºæ—¥å¿—</button>
                  </view>
                </view>
              </view>

              <!-- å®æ—¶è°ƒè¯•ä¿¡æ¯ -->
              <view class="debug-info-compact">
                <text class="debug-info-title-compact">ğŸ“Š å®æ—¶çŠ¶æ€</text>
                <view class="debug-info-grid">
                  <text class="debug-info-item-compact">WebSocket: {{wsConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}}</text>
                  <text class="debug-info-item-compact">ä¼šè¯ID: {{currentSessionId || 'æ— '}}</text>
                  <text class="debug-info-item-compact">æ¶ˆæ¯æ•°: {{currentMessages.length}}</text>
                  <text class="debug-info-item-compact">é‡è¿æ¬¡æ•°: {{reconnectCount}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ä»Šæ—¥ç»Ÿè®¡ -->
    <view class="today-stats">
      <view class="stats-header">
        <text class="stats-title">ä»Šæ—¥ç»Ÿè®¡</text>
      </view>
      <view class="stats-grid">
        <view class="stat-card">
          <text class="stat-number">{{todayStats.totalSessions}}</text>
          <text class="stat-label">æ€»ä¼šè¯æ•°</text>
        </view>
        <view class="stat-card">
          <text class="stat-number">{{todayStats.completedSessions}}</text>
          <text class="stat-label">å·²å®Œæˆ</text>
        </view>
        <view class="stat-card">
          <text class="stat-number">{{todayStats.avgResponseTime}}</text>
          <text class="stat-label">å¹³å‡å“åº”</text>
        </view>
        <view class="stat-card">
          <text class="stat-number">{{todayStats.customerSatisfaction}}%</text>
          <text class="stat-label">æ»¡æ„åº¦</text>
        </view>
      </view>
    </view>


  </view>
</view>