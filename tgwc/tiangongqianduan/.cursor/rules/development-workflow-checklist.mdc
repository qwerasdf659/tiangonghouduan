# 开发工作流程检查清单 - 预防性编程实践

## 🎯 目标

建立**预防性编程**文化，从"发现问题→修复问题"转变为"预防问题→质量保证"。

---

## 📋 分阶段检查清单

### 阶段1：需求分析（开始编码前）

#### ✅ 标准符合性检查

- [ ] **查阅相关标准文档**
  - 是否涉及编码格式（Base64、URL编码等）？
  - 是否涉及加密算法（JWT、SHA256等）？
  - 是否涉及协议标准（HTTP、WebSocket等）？

- [ ] **理解标准规范**
  - RFC文档是否已阅读？
  - 标准的关键要求是什么？
  - 有哪些常见误区？

- [ ] **检查现有实现**
  - 项目中是否已有类似功能？
  - 现有代码是否符合标准？
  - 是否有可复用的工具函数？

**示例检查**：
```
需求：处理JWT Token认证

标准符合性检查：
✅ 已阅读 RFC 7519（JWT标准）
✅ 了解 Base64 URL编码要求
✅ 检查 utils/util.js 已有 decodeJWTPayload 函数
✅ 确认使用 - 和 _ 字符代替 + 和 /
```

---

### 阶段2：编码实现（编写代码时）

#### ✅ 编码规范检查

- [ ] **命名规范**
  - 变量名是否语义化？
  - 是否避免变量遮蔽？
  - 是否使用统一的命名风格（camelCase / snake_case）？

- [ ] **注释规范**
  - 是否添加了JSDoc注释？
  - 注释是否说明了"为什么"而不仅是"是什么"？
  - 是否标注了标准依据（RFC、API文档等）？

- [ ] **错误处理**
  - 是否有完整的try-catch？
  - 错误信息是否清晰？
  - 是否提供了解决建议？

**代码审查模板**：
```javascript
/**
 * ✅ 好的注释
 * JWT使用Base64 URL编码：使用 - 和 _ 代替 + 和 /（RFC 7519）
 * 这是JWT标准要求，不能使用标准Base64字符集验证
 */
const base64UrlPattern = /^[A-Za-z0-9_-]*$/

/**
 * ❌ 不好的注释
 * 检查Base64字符
 */
const base64Pattern = /^[A-Za-z0-9+/]*$/
```

---

### 阶段3：单元测试（编码完成后）

#### ✅ 测试覆盖率检查

- [ ] **基本功能测试**
  - 正常情况是否通过？
  - 返回值是否符合预期？

- [ ] **边界条件测试**
  - 空值（null、undefined、''）是否处理？
  - 极端值（超长、超短）是否处理？
  - 类型错误（数字、对象）是否处理？

- [ ] **标准符合性测试**
  - 是否测试标准要求的字符集？
  - 是否测试标准格式的数据？
  - 是否有回归测试防止问题复现？

**测试检查清单**：
```javascript
// ✅ 完整的测试套件
describe('JWT Token处理', () => {
  // 1. 基本功能
  test('✅ 解码有效Token')
  
  // 2. 标准符合性
  test('✅ 接受Base64 URL字符（- 和 _）')
  test('❌ 拒绝标准Base64字符（+ 和 /）')
  
  // 3. 边界条件
  test('❌ 拒绝null')
  test('❌ 拒绝空字符串')
  test('❌ 拒绝截断Token')
  
  // 4. 回归测试
  test('🐛 [BUG-2025-11-08] Base64 URL字符验证')
})
```

---

### 阶段4：集成测试（提交前）

#### ✅ 代码质量检查

- [ ] **ESLint检查**
  ```powershell
  npx eslint path/to/file.js --format stylish
  ```
  - 是否有错误（0 errors）？
  - 警告是否可接受？

- [ ] **Prettier格式化**
  ```powershell
  npx prettier --write path/to/file.js
  ```
  - 代码格式是否统一？

- [ ] **单元测试**
  ```powershell
  npm test path/to/test.spec.js
  ```
  - 所有测试是否通过？
  - 覆盖率是否达标（>80%）？

- [ ] **完整链路测试**
  - 在微信开发者工具中编译？
  - 实际功能是否正常？
  - 是否有控制台错误？

---

### 阶段5：代码审查（合并前）

#### ✅ 代码审查检查清单

**功能层面**：
- [ ] 代码是否解决了问题？
- [ ] 是否引入了新问题？
- [ ] 是否有性能影响？

**标准层面**：
- [ ] 是否符合相关标准（RFC、W3C等）？
- [ ] 是否查阅了标准文档？
- [ ] 是否有标准依据的注释？

**测试层面**：
- [ ] 是否有单元测试？
- [ ] 测试覆盖率是否达标？
- [ ] 是否有回归测试？

**文档层面**：
- [ ] 是否更新了相关文档？
- [ ] 是否添加了使用示例？
- [ ] 是否记录了设计决策？

---

## 🚨 高风险场景强制检查

### 场景1：处理编码/解码

**强制检查项**：
- ✅ 查阅编码标准文档（RFC、W3C）
- ✅ 明确字符集要求
- ✅ 编写字符集验证测试
- ✅ 测试边界情况（特殊字符、长度）

**检查命令**：
```powershell
# 搜索项目中所有编码相关代码
grep -r "base64\|Base64\|atob\|btoa" utils/ pages/

# 检查是否有字符集验证
grep -r "pattern\|test\|match" utils/util.js
```

---

### 场景2：处理Token/认证

**强制检查项**：
- ✅ 查阅JWT标准（RFC 7519）
- ✅ 验证Token格式（3部分、点分隔）
- ✅ 检查Base64 URL编码
- ✅ 测试Token截断情况

**检查命令**：
```powershell
# 搜索Token相关代码
grep -r "jwt\|JWT\|token\|Token" utils/ pages/

# 检查Token验证逻辑
grep -r "validateJWT\|decodeJWT\|parseJWT" utils/
```

---

### 场景3：处理API调用

**强制检查项**：
- ✅ 查阅API文档
- ✅ 验证请求格式（snake_case）
- ✅ 验证响应格式
- ✅ 测试错误情况（网络、超时、400/500）

**检查命令**：
```powershell
# 搜索API调用代码
grep -r "wx.request\|callApi\|API\." pages/

# 检查错误处理
grep -r "catch\|fail\|error" pages/ -A 3
```

---

## 📊 质量指标

### 代码质量要求

| 指标 | 目标值 | 强制要求 |
|-----|-------|---------|
| ESLint错误 | 0 | ✅ 必须 |
| 单元测试覆盖率 | >80% | ✅ 必须 |
| 关键函数覆盖率 | >90% | ✅ 必须 |
| JSDoc注释覆盖率 | >90% | ✅ 必须 |
| 代码重复率 | <5% | ⚠️ 建议 |

### 测试质量要求

| 测试类型 | 数量要求 | 强制要求 |
|--------|---------|---------|
| 正常功能测试 | ≥1个 | ✅ 必须 |
| 边界条件测试 | ≥3个 | ✅ 必须 |
| 异常情况测试 | ≥2个 | ✅ 必须 |
| 回归测试 | 每个bug ≥1个 | ✅ 必须 |
| 性能测试 | ≥1个 | ⚠️ 建议 |

---

## 🔧 工具配置

### package.json 测试脚本

```json
{
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:jwt": "jest test/utils/jwt-test.spec.js",
    "lint": "eslint . --ext .js",
    "lint:fix": "eslint . --ext .js --fix",
    "format": "prettier --write \"**/*.{js,json,md}\"",
    "quality": "npm run lint && npm run test:coverage"
  }
}
```

### 日常开发命令

```powershell
# 开发前：检查代码质量
npm run lint

# 编码中：持续测试
npm run test:watch

# 编码后：完整质量检查
npm run quality

# 提交前：格式化代码
npm run format
```

---

## 🎯 预防性编程文化

### 思维转变

**❌ 旧思维（被动修复）**：
```
编写代码 → 发现bug → 修复bug → 继续编码
```

**✅ 新思维（主动预防）**：
```
查阅标准 → 编写代码 → 编写测试 → 质量检查 → 提交代码
```

### 核心原则

1. **标准优先**：不确定时，查阅标准文档
2. **测试驱动**：代码完成前，测试必须完成
3. **文档同步**：代码变更时，文档同步更新
4. **持续改进**：每个bug都是改进规则的机会

---

## 📝 检查清单使用说明

### 新功能开发

```
✅ 步骤1：需求分析（查阅标准）
✅ 步骤2：编码实现（添加注释）
✅ 步骤3：单元测试（覆盖率>80%）
✅ 步骤4：集成测试（完整链路）
✅ 步骤5：代码审查（提交PR）
```

### Bug修复

```
✅ 步骤1：分析根因（标准层面）
✅ 步骤2：修复代码（添加注释说明）
✅ 步骤3：回归测试（防止复现）
✅ 步骤4：更新文档（记录教训）
✅ 步骤5：更新规则（预防同类问题）
```

---

**创建时间**：2025-11-08  
**适用范围**：天工小程序项目所有开发活动  
**强制执行**：所有提交必须通过检查清单验证  
**维护周期**：每月更新一次，基于新问题改进
