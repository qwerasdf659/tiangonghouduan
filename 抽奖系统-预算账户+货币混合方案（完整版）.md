# 抽奖系统：预算账户 + 货币奖品混合方案（完整版）

> **文档版本**: v1.0  
> **创建日期**: 2025年12月1日  
> **核心特点**: 预算账户后台控制成本 + 货币奖品增强用户体验 + 用户零感知预算机制

---

## 📋 目录

- [一、方案概述](#一方案概述)
- [二、核心方案对比](#二核心方案对比)
- [三、混合方案设计](#三混合方案设计)
- [四、完整技术方案](#四完整技术方案)
- [五、API设计规范](#五api设计规范)
- [六、用户界面设计](#六用户界面设计)
- [七、实施路线图](#七实施路线图)

---

## 一、方案概述

### 1.1 业务场景

```
用户消费 → 获得积分 → 抽奖 → 奖品成本由消费佣金的80%支付
```

**核心问题**：每个用户消费金额不同，如何自动化控制各自能获得的奖品总价值？

### 1.2 方案演进

```
方案5（成长期务实）
    ↓
预算账户系统（后台成本控制）
    ↓
+ 方案7（双币制）
    ↓
货币奖品系统（用户体验优化）
    ↓
= 最终方案（预算隐藏 + 货币混合）
```

---

## 二、核心方案对比

### 2.1 方案5：成长期务实（预算账户）

#### 核心思想
**为每个用户维护"奖品预算账户"，抽奖时根据剩余预算动态筛选奖品**

#### 通俗理解

```
就像银行账户：
- 消费1000元 → 账户存入80元预算
- 抽奖中30元奖品 → 账户扣30元
- 剩余50元 → 只能抽≤50元的奖品
- 预算用完 → 自动轮空
```

#### 核心优势

| 优势 | 说明 |
|-----|------|
| ✅ 成本精准 | 每个用户奖品成本严格≤预算 |
| ✅ 自动化 | 无需手动配置，系统自动控制 |
| ✅ 灵活性强 | 可抽奖品范围动态变化 |
| ✅ 数据可追溯 | 每笔预算流水清晰 |

#### 适用场景
- 用户量：1-50万
- 团队：3-10人，技术水平中等
- 综合评分：**4.4/5** ⭐⭐

---

### 2.2 方案7：双币制

#### 核心思想
**积分只能看（增强获得感），抽奖币才能用（精准成本控制）**

#### 通俗理解

```
就像游戏厅代币：
- 消费1000元 → 获得1000积分（仅展示）
              → 获得8个抽奖币（真正能用）
- 规则：1币 = 能抽最高10元成本奖品
- 用户选择：1币/3币/8币抽奖
```

#### 核心优势

| 优势 | 说明 |
|-----|------|
| ✅ 极简 | 80行代码搞定 |
| ✅ 成本100%精准 | 1币=固定成本映射 |
| ✅ 用户体验好 | 有选择权 |
| ✅ 零技术债务 | 3年后仍然清爽 |

#### 适用场景
- 用户量：0-50万
- 团队：1-10人，任何技术水平
- 综合评分：**4.9/5** ⭐⭐⭐

---

### 2.3 两方案对比

| 维度 | 方案5-预算账户 | 方案7-双币制 | 最终方案 |
|-----|--------------|------------|---------|
| 代码复杂度 | 150行 | 80行 | 250行 |
| 成本精准度 | 95% | 100% | 100% |
| 用户体验 | 灵活但不够直观 | 简单直观 | 最优 |
| 学习成本 | 2小时 | 30分钟 | 2小时 |
| 灵活性 | 高 | 中 | 极高 |
| 综合评分 | 4.4/5 ⭐⭐ | 4.9/5 ⭐⭐⭐ | **5.0/5** ⭐⭐⭐ |

---

## 三、混合方案设计

### 3.1 方案选择：主次保护制 ⭐⭐⭐ 推荐

#### 核心思想
**预算账户为主系统（成本控制），货币奖品为辅助（用户体验）**

```
消费1000元
  ↓
后端分配（用户无感知）：
├─ 奖品预算：80元（系统内部控制）
└─ 展示积分：1000分（前端可见）
  ↓
用户抽奖（消耗100积分）
  ↓
奖品池包含：
├─ 实物奖品：蓝牙耳机（成本30元）
├─ 虚拟奖品：视频会员（成本20元）
└─ 货币奖品：10个兑换币（成本10元）← 新增！
  ↓
中奖货币后：
  ↓
用户可选择：
├─ 攒币换大奖：50个币换手机
├─ 小币换小物：10个币换保温杯
└─ 混合支付：5币+50积分抽奖
```

#### 用户视角（前端）

```
用户看到的：
- 积分余额：1000分
- 兑换币：23个
- 可抽次数：10次

用户不知道的：
- 奖品预算：80元
- 剩余预算：45元
- 预算使用率：43.75%
```

#### 系统视角（后端）

```
系统控制的：
- 预算账户：精准控制成本
- 动态筛选：cost_price <= remaining_budget
- 自动轮空：预算不足时
- 双重验证：防止超支
```

---

### 3.2 混合方案优势

| 优势 | 说明 |
|-----|------|
| ✅ **成本100%可控** | 预算账户作为最终防线 |
| ✅ **用户体验最优** | 抽不到想要的？攒币兑换！ |
| ✅ **灵活性最强** | 既有随机性又有确定性 |
| ✅ **预算完全隐藏** | 用户无感知后台控制 |
| ✅ **保底机制** | 货币是"保底奖"，减少投诉 |
| ✅ **促进活跃** | 攒币机制增加用户粘性 |

---

## 四、完整技术方案

### 4.1 数据库设计

#### 用户钱包表（核心）

```sql
CREATE TABLE user_wallet (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    
    -- ========== 前端可见字段 ==========
    points_balance INT DEFAULT 0 COMMENT '积分余额（用户可见）',
    exchange_coins INT DEFAULT 0 COMMENT '兑换币余额（用户可见）',
    
    -- ========== 后端控制字段（用户不可见）==========
    total_budget DECIMAL(10,2) DEFAULT 0 COMMENT '总预算（系统内部）',
    remaining_budget DECIMAL(10,2) DEFAULT 0 COMMENT '剩余预算（系统内部）',
    used_budget DECIMAL(10,2) DEFAULT 0 COMMENT '已用预算（系统内部）',
    
    -- ========== 统计字段 ==========
    total_draw_count INT DEFAULT 0 COMMENT '总抽奖次数',
    won_count INT DEFAULT 0 COMMENT '中奖次数',
    last_draw_at DATETIME COMMENT '最后抽奖时间',
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    UNIQUE KEY uk_user_id (user_id),
    INDEX idx_remaining_budget (remaining_budget)
) COMMENT='用户钱包-预算对用户不透明（系统内部控制）';
```

#### 奖品表（扩展支持货币）

```sql
CREATE TABLE prizes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(200) NOT NULL COMMENT '奖品名称',
    
    -- ========== 奖品类型 ==========
    type ENUM('physical', 'virtual', 'currency') NOT NULL COMMENT '实物/虚拟/货币',
    
    -- ========== 实物/虚拟奖品字段 ==========
    cost_price DECIMAL(10,2) COMMENT '成本价（系统内部）',
    market_value DECIMAL(10,2) COMMENT '市场价（用户展示）',
    description TEXT COMMENT '奖品描述',
    image_url VARCHAR(500) COMMENT '奖品图片',
    stock INT DEFAULT 0 COMMENT '库存数量',
    
    -- ========== 货币奖品字段（新增）==========
    coin_amount INT COMMENT '货币数量（仅type=currency时有效）',
    coin_cost DECIMAL(10,2) COMMENT '货币成本（1个币的成本）',
    
    -- ========== 抽奖权重 ==========
    weight INT DEFAULT 100 COMMENT '抽奖权重（货币权重可以设高）',
    
    -- ========== 状态字段 ==========
    status ENUM('active', 'inactive') DEFAULT 'active',
    category VARCHAR(50) COMMENT '奖品分类',
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_type_cost (type, cost_price),
    INDEX idx_status (status),
    INDEX idx_category (category)
) COMMENT='奖品库-支持货币奖品';

-- 示例数据
INSERT INTO prizes (name, type, cost_price, market_value, description, stock, weight) VALUES
('蓝牙耳机', 'physical', 30.00, 99.00, '高品质蓝牙耳机', 500, 80),
('视频会员月卡', 'virtual', 20.00, 25.00, '主流视频平台月卡', 1000, 100),
('10个兑换币', 'currency', 10.00, NULL, '可兑换商品', 99999, 200);  -- 权重高，更容易中
```

#### 兑换商品表（新增）

```sql
CREATE TABLE exchange_items (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(200) NOT NULL COMMENT '商品名称',
    description TEXT COMMENT '商品描述',
    image_url VARCHAR(500) COMMENT '商品图片',
    
    -- ========== 兑换价格（支持多种支付方式）==========
    price_type ENUM('coin', 'points', 'mixed') NOT NULL COMMENT '支付方式',
    coin_price INT COMMENT '兑换币价格',
    points_price INT COMMENT '积分价格',
    mixed_coin INT COMMENT '混合支付-币数量',
    mixed_points INT COMMENT '混合支付-积分数量',
    
    -- ========== 商品成本和库存 ==========
    cost_price DECIMAL(10,2) NOT NULL COMMENT '实际成本（系统内部）',
    stock INT DEFAULT 0 COMMENT '库存',
    sold_count INT DEFAULT 0 COMMENT '已售数量',
    
    -- ========== 分类和状态 ==========
    category VARCHAR(50) COMMENT '分类',
    status ENUM('active', 'inactive') DEFAULT 'active',
    sort_order INT DEFAULT 0 COMMENT '排序',
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_price_type (price_type),
    INDEX idx_coin_price (coin_price),
    INDEX idx_status (status),
    INDEX idx_category (category)
) COMMENT='兑换商城商品表';

-- 示例数据
INSERT INTO exchange_items (name, price_type, coin_price, points_price, mixed_coin, mixed_points, cost_price, stock, category) VALUES
-- 纯币兑换
('保温杯', 'coin', 10, NULL, NULL, NULL, 10.00, 200, '生活用品'),
('无线鼠标', 'coin', 30, NULL, NULL, NULL, 30.00, 100, '数码产品'),
('蓝牙音箱', 'coin', 50, NULL, NULL, NULL, 50.00, 50, '数码产品'),

-- 纯积分兑换
('数据线', 'points', NULL, 300, NULL, NULL, 5.00, 500, '配件'),
('手机壳', 'points', NULL, 200, NULL, NULL, 3.00, 1000, '配件'),

-- 混合支付
('智能手表', 'mixed', NULL, NULL, 50, 500, 100.00, 20, '数码产品'),
('蓝牙耳机', 'mixed', NULL, NULL, 30, 300, 60.00, 50, '数码产品');
```

#### 抽奖记录表

```sql
CREATE TABLE lottery_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    prize_id BIGINT COMMENT '中奖奖品ID（NULL表示轮空）',
    
    -- ========== 消耗信息（前端可见）==========
    cost_points INT NOT NULL COMMENT '消耗积分',
    is_won TINYINT(1) NOT NULL COMMENT '是否中奖',
    
    -- ========== 成本信息（后端记录）==========
    actual_cost DECIMAL(10,2) DEFAULT 0 COMMENT '实际成本（系统内部）',
    budget_before DECIMAL(10,2) COMMENT '抽奖前预算',
    budget_after DECIMAL(10,2) COMMENT '抽奖后预算',
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at),
    INDEX idx_user_created (user_id, created_at)
) COMMENT='抽奖记录表';
```

#### 兑换记录表

```sql
CREATE TABLE exchange_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    item_id BIGINT NOT NULL COMMENT '兑换商品ID',
    
    -- ========== 支付信息 ==========
    payment_type ENUM('coin', 'points', 'mixed') COMMENT '支付方式',
    coin_paid INT DEFAULT 0 COMMENT '消耗兑换币',
    points_paid INT DEFAULT 0 COMMENT '消耗积分',
    
    -- ========== 成本信息（后端记录）==========
    actual_cost DECIMAL(10,2) COMMENT '实际成本（系统内部）',
    
    -- ========== 订单信息 ==========
    order_no VARCHAR(50) NOT NULL COMMENT '订单号',
    status ENUM('pending', 'completed', 'shipped', 'cancelled') DEFAULT 'pending',
    shipped_at DATETIME COMMENT '发货时间',
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    UNIQUE KEY uk_order_no (order_no),
    INDEX idx_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
) COMMENT='兑换记录表';
```

---

### 4.2 核心业务流程

#### 流程1：消费后自动分配

```javascript
/**
 * 消费审核通过 - 自动分配预算和积分
 * 用户只知道获得了积分，不知道预算
 */
async function onConsumeApproved(userId, consumeAmount) {
    // 1. 计算佣金和预算分配
    const commission = consumeAmount * 0.1;      // 10%佣金
    const prizeBudget = commission * 0.8;        // 80%奖品预算（成本价）
    const points = consumeAmount;                // 1元=1积分
    
    // 2. 数据库事务
    const transaction = await sequelize.transaction();
    
    try {
        // 3. 更新用户钱包
        await UserWallet.update({
            // 后端字段（用户不知道）
            total_budget: sequelize.literal(`total_budget + ${prizeBudget}`),
            remaining_budget: sequelize.literal(`remaining_budget + ${prizeBudget}`),
            
            // 前端字段（用户看得到）
            points_balance: sequelize.literal(`points_balance + ${points}`)
        }, {
            where: { user_id: userId },
            transaction
        });
        
        // 4. 记录消费流水
        await TransactionRecord.create({
            user_id: userId,
            consume_amount: consumeAmount,
            commission: commission,
            prize_budget: prizeBudget,
            points_granted: points,
            status: 'approved'
        }, { transaction });
        
        await transaction.commit();
        
        // 5. 🎯 发送用户通知（只说积分，不说预算）
        await sendNotification(userId, {
            title: '消费成功',
            content: `恭喜获得${points}积分，可用于抽奖！`,
            type: 'consume_approved'
        });
        
        console.log(`✅ 用户${userId}消费${consumeAmount}元审核通过`);
        console.log(`   - 发放积分: ${points}分`);
        console.log(`   - 分配预算: ${prizeBudget}元（系统内部）`);
        
        return { success: true, points, prizeBudget };
        
    } catch (error) {
        await transaction.rollback();
        console.error('❌ 消费审核处理失败:', error);
        throw error;
    }
}
```

#### 流程2：用户抽奖

```javascript
/**
 * 用户抽奖核心逻辑
 * 预算控制在后端，用户无感知
 */
async function userDrawLottery(userId, costPoints = 100) {
    // 1. 查询用户钱包
    const wallet = await UserWallet.findOne({
        where: { user_id: userId }
    });
    
    if (!wallet) {
        return {
            success: false,
            error_code: 'USER_NOT_FOUND',
            message: '用户账户不存在'
        };
    }
    
    // 2. 前端验证：积分是否充足
    if (wallet.points_balance < costPoints) {
        return {
            success: false,
            error_code: 'INSUFFICIENT_POINTS',
            message: '积分不足，无法抽奖',
            data: {
                current_points: wallet.points_balance,
                required_points: costPoints
            }
        };
    }
    
    // 3. 后端验证：预算是否充足（用户不知道）
    if (wallet.remaining_budget <= 0) {
        // 🎯 返回用户友好的提示（不说预算）
        return {
            success: false,
            error_code: 'NO_MORE_CHANCES',
            message: '本轮抽奖机会已用完',
            data: {
                wallet: {
                    points: wallet.points_balance,
                    coins: wallet.exchange_coins,
                    available_draws: 0
                },
                tips: '继续消费可获得更多抽奖机会',
                suggestion: {
                    title: `您还有${wallet.exchange_coins}个兑换币`,
                    action: {
                        text: '去商城兑换好礼',
                        url: '/exchange-mall'
                    }
                }
            }
        };
    }
    
    // 4. 动态筛选奖品池（核心逻辑！）
    const availablePrizes = await Prize.findAll({
        where: {
            // 关键！用剩余预算筛选
            cost_price: { [Op.lte]: wallet.remaining_budget },
            status: 'active',
            stock: { [Op.gt]: 0 }
        },
        order: [
            ['weight', 'DESC'],  // 按权重排序（货币权重高，更容易中）
            ['cost_price', 'DESC']
        ]
    });
    
    // 5. 判断是否轮空
    if (availablePrizes.length === 0) {
        // 扣积分但不扣预算
        await wallet.decrement({ points_balance: costPoints });
        
        await LotteryRecord.create({
            user_id: userId,
            cost_points: costPoints,
            is_won: false,
            budget_before: wallet.remaining_budget,
            budget_after: wallet.remaining_budget
        });
        
        // 🎯 用户友好的轮空提示
        return {
            success: true,
            result: 'miss',
            message: '很遗憾未中奖，继续努力！',
            data: {
                wallet: {
                    points: wallet.points_balance - costPoints,
                    coins: wallet.exchange_coins,
                    available_draws: calculateAvailableDraws(wallet)
                },
                encouragement: '再试一次，好运即将降临！'
            }
        };
    }
    
    // 6. 加权随机抽奖
    const wonPrize = weightedRandomSelect(availablePrizes);
    
    // 7. 发放奖品（事务处理）
    const transaction = await sequelize.transaction();
    
    try {
        // 扣减积分（用户可见）
        await wallet.decrement({ 
            points_balance: costPoints 
        }, { transaction });
        
        // 扣减预算（用户不可见）
        await wallet.decrement({
            remaining_budget: wonPrize.cost_price
        }, { transaction });
        
        await wallet.increment({
            used_budget: wonPrize.cost_price,
            total_draw_count: 1,
            won_count: 1
        }, { transaction });
        
        // 如果是货币奖品，发放兑换币
        if (wonPrize.type === 'currency') {
            await wallet.increment({
                exchange_coins: wonPrize.coin_amount
            }, { transaction });
        }
        
        // 扣减奖品库存
        await wonPrize.decrement({ stock: 1 }, { transaction });
        
        // 记录抽奖日志
        await LotteryRecord.create({
            user_id: userId,
            prize_id: wonPrize.id,
            cost_points: costPoints,
            actual_cost: wonPrize.cost_price,
            is_won: true,
            budget_before: wallet.remaining_budget + wonPrize.cost_price,
            budget_after: wallet.remaining_budget
        }, { transaction });
        
        await transaction.commit();
        
        // 8. 🎯 返回用户友好的结果
        const response = {
            success: true,
            result: 'won',
            data: {
                prize: {
                    id: wonPrize.id,
                    name: wonPrize.name,
                    type: wonPrize.type,
                    description: wonPrize.description,
                    image: wonPrize.image_url
                },
                wallet: {
                    points: wallet.points_balance - costPoints,
                    coins: wallet.exchange_coins,
                    available_draws: calculateAvailableDraws(wallet)
                }
            }
        };
        
        // 如果是货币奖品，添加特殊提示
        if (wonPrize.type === 'currency') {
            response.data.prize.coin_amount = wonPrize.coin_amount;
            response.message = `恭喜获得${wonPrize.coin_amount}个兑换币！`;
            response.data.coin_tips = `您现在有${wallet.exchange_coins + wonPrize.coin_amount}个兑换币，可兑换心仪商品`;
        } else {
            response.message = `恭喜中奖！${wonPrize.name}已发放到您的账户`;
        }
        
        console.log(`🎉 用户${userId}中奖: ${wonPrize.name}`);
        console.log(`   - 消耗积分: ${costPoints}`);
        console.log(`   - 实际成本: ${wonPrize.cost_price}元（系统内部）`);
        console.log(`   - 剩余预算: ${wallet.remaining_budget}元（系统内部）`);
        
        return response;
        
    } catch (error) {
        await transaction.rollback();
        console.error('❌ 抽奖处理失败:', error);
        throw error;
    }
}

/**
 * 加权随机选择
 */
function weightedRandomSelect(prizes) {
    const weights = prizes.map(p => p.weight || 100);
    const totalWeight = weights.reduce((sum, w) => sum + w, 0);
    
    let random = Math.random() * totalWeight;
    for (let i = 0; i < prizes.length; i++) {
        random -= weights[i];
        if (random <= 0) {
            return prizes[i];
        }
    }
    
    return prizes[0]; // 兜底
}

/**
 * 计算剩余抽奖次数（内部函数，用户不知道算法）
 */
function calculateAvailableDraws(wallet) {
    const drawsByPoints = Math.floor(wallet.points_balance / 100);
    const minPrizeCost = 5;  // 最便宜奖品成本
    const drawsByBudget = Math.floor(wallet.remaining_budget / minPrizeCost);
    
    // 取两者最小值
    return Math.min(drawsByPoints, drawsByBudget);
}
```

#### 流程3：兑换商品

```javascript
/**
 * 用户兑换商品
 * 注意：兑换不扣预算（在中奖货币时已经扣了）
 */
async function exchangeItem(userId, itemId, paymentType) {
    // 1. 查询商品
    const item = await ExchangeItem.findOne({
        where: { 
            id: itemId,
            status: 'active'
        }
    });
    
    if (!item) {
        return {
            success: false,
            error_code: 'ITEM_NOT_FOUND',
            message: '商品不存在或已下架'
        };
    }
    
    // 2. 检查库存
    if (item.stock <= 0) {
        return {
            success: false,
            error_code: 'OUT_OF_STOCK',
            message: '该商品已抢光啦'
        };
    }
    
    // 3. 查询用户钱包
    const wallet = await UserWallet.findOne({
        where: { user_id: userId }
    });
    
    // 4. 验证支付能力
    let coinPaid = 0, pointsPaid = 0;
    
    if (paymentType === 'coin') {
        coinPaid = item.coin_price;
        if (wallet.exchange_coins < coinPaid) {
            return {
                success: false,
                error_code: 'INSUFFICIENT_COINS',
                message: '兑换币不足',
                data: {
                    current_coins: wallet.exchange_coins,
                    required_coins: coinPaid,
                    shortage: coinPaid - wallet.exchange_coins
                }
            };
        }
    } else if (paymentType === 'points') {
        pointsPaid = item.points_price;
        if (wallet.points_balance < pointsPaid) {
            return {
                success: false,
                error_code: 'INSUFFICIENT_POINTS',
                message: '积分不足'
            };
        }
    } else if (paymentType === 'mixed') {
        coinPaid = item.mixed_coin;
        pointsPaid = item.mixed_points;
        
        if (wallet.exchange_coins < coinPaid || wallet.points_balance < pointsPaid) {
            return {
                success: false,
                error_code: 'INSUFFICIENT_BALANCE',
                message: '兑换币或积分不足'
            };
        }
    }
    
    // 5. 执行兑换（事务）
    const transaction = await sequelize.transaction();
    
    try {
        // 扣减资产
        if (coinPaid > 0) {
            await wallet.decrement({ exchange_coins: coinPaid }, { transaction });
        }
        if (pointsPaid > 0) {
            await wallet.decrement({ points_balance: pointsPaid }, { transaction });
        }
        
        // 扣减库存
        await item.decrement({ stock: 1 }, { transaction });
        await item.increment({ sold_count: 1 }, { transaction });
        
        // 生成订单号
        const orderNo = generateOrderNo();
        
        // 记录兑换记录
        await ExchangeRecord.create({
            user_id: userId,
            item_id: itemId,
            payment_type: paymentType,
            coin_paid: coinPaid,
            points_paid: pointsPaid,
            actual_cost: item.cost_price,  // 系统内部记录
            order_no: orderNo,
            status: 'pending'
        }, { transaction });
        
        await transaction.commit();
        
        // 6. 🎯 返回用户友好的结果
        return {
            success: true,
            data: {
                item: {
                    id: item.id,
                    name: item.name,
                    image: item.image_url
                },
                payment: {
                    type: paymentType,
                    coin_amount: coinPaid,
                    points_amount: pointsPaid
                },
                wallet: {
                    points: wallet.points_balance - pointsPaid,
                    coins: wallet.exchange_coins - coinPaid,
                    available_draws: calculateAvailableDraws(wallet)
                },
                order_no: orderNo
            },
            message: `兑换成功！${item.name}将在3-5天内发货`
        };
        
    } catch (error) {
        await transaction.rollback();
        console.error('❌ 兑换失败:', error);
        throw error;
    }
}

/**
 * 生成订单号
 */
function generateOrderNo() {
    const date = new Date();
    const dateStr = date.toISOString().slice(0, 10).replace(/-/g, '');
    const random = Math.random().toString(36).substr(2, 6).toUpperCase();
    return `EX${dateStr}${random}`;
}
```

---

## 五、API设计规范

### 5.1 核心原则

```
❌ 禁止出现的词汇：
- 预算、budget、cost_price
- 成本、actual_cost
- remaining_budget、used_budget
- insufficient_budget、预算不足

✅ 只使用用户理解的概念：
- 积分、兑换币、抽奖机会
- 次数、余额、可用
- 已用完、继续消费
```

### 5.2 API响应自动检测

```javascript
/**
 * API响应检测中间件
 * 确保响应中没有预算相关信息
 */
function validateAPIResponse(response) {
    const responseStr = JSON.stringify(response);
    
    // 禁止词汇列表
    const forbiddenWords = [
        'budget', 'cost_price', 'actual_cost',
        'remaining_budget', 'used_budget', 'total_budget',
        '预算', '成本', '成本价'
    ];
    
    // 检查是否包含禁止词汇
    const violations = forbiddenWords.filter(word => 
        responseStr.toLowerCase().includes(word.toLowerCase())
    );
    
    if (violations.length > 0) {
        console.error('❌ API响应包含禁止词汇:', violations);
        throw new Error('API响应不符合规范');
    }
    
    return true;
}

// Express中间件
app.use((req, res, next) => {
    const originalJson = res.json;
    res.json = function(data) {
        // 生产环境自动检查
        if (process.env.NODE_ENV === 'production') {
            validateAPIResponse(data);
        }
        return originalJson.call(this, data);
    };
    next();
});
```

### 5.3 错误码定义

```javascript
const ERROR_CODES = {
    // ✅ 用户友好的错误码
    INSUFFICIENT_POINTS: {
        message: '积分不足',
        http_code: 400
    },
    
    NO_MORE_CHANCES: {
        message: '本轮抽奖机会已用完',
        http_code: 200  // 不是错误，是正常状态
    },
    
    INSUFFICIENT_COINS: {
        message: '兑换币不足',
        http_code: 400
    },
    
    OUT_OF_STOCK: {
        message: '商品已抢光',
        http_code: 400
    },
    
    TOO_MANY_REQUESTS: {
        message: '操作太频繁，请稍后再试',
        http_code: 429
    }
};
```

### 5.4 完整API列表

#### GET /api/user/wallet - 查询用户资产

```json
Response: {
    "code": 200,
    "data": {
        "points": 1000,
        "coins": 23,
        "available_draws": 10
    }
}
```

#### POST /api/lottery/draw - 抽奖

```json
Request: {
    "cost_points": 100
}

Response (中奖): {
    "code": 200,
    "success": true,
    "data": {
        "result": "won",
        "prize": {
            "id": 1001,
            "name": "蓝牙耳机",
            "type": "physical",
            "image": "https://...",
            "description": "高品质蓝牙耳机"
        },
        "wallet": {
            "points": 900,
            "coins": 23,
            "available_draws": 9
        },
        "message": "恭喜中奖！蓝牙耳机已发放到您的账户"
    }
}

Response (轮空): {
    "code": 200,
    "success": true,
    "data": {
        "result": "miss",
        "wallet": {
            "points": 900,
            "coins": 23,
            "available_draws": 9
        },
        "message": "很遗憾未中奖，继续努力哦！"
    }
}

Response (机会用完): {
    "code": 200,
    "success": false,
    "error_code": "NO_MORE_CHANCES",
    "message": "本轮抽奖机会已用完",
    "data": {
        "wallet": {
            "points": 800,
            "coins": 23,
            "available_draws": 0
        },
        "tips": "继续消费可获得更多抽奖机会"
    }
}
```

#### GET /api/exchange/items - 兑换商城商品列表

```json
Response: {
    "code": 200,
    "data": {
        "user_coins": 23,
        "items": [
            {
                "id": 1001,
                "name": "保温杯",
                "image": "https://...",
                "price": {
                    "type": "coin",
                    "amount": 10,
                    "display": "10个兑换币"
                },
                "can_afford": true,
                "stock": 200
            }
        ]
    }
}
```

#### POST /api/exchange/redeem - 兑换商品

```json
Request: {
    "item_id": 1001,
    "payment_type": "coin"
}

Response: {
    "code": 200,
    "success": true,
    "data": {
        "item": {
            "id": 1001,
            "name": "保温杯"
        },
        "payment": {
            "type": "coin",
            "amount": 10
        },
        "wallet": {
            "points": 1000,
            "coins": 13
        },
        "order_no": "EX20250101ABC123"
    },
    "message": "兑换成功！保温杯将在3-5天内发货"
}
```

---

## 六、用户界面设计

### 6.1 钱包页面

```
┌───────────────────────────────┐
│ 💰 我的资产                    │
├───────────────────────────────┤
│ 🎯 积分余额：1000分            │
│    └─ 可用于抽奖               │
│                                │
│ 💎 兑换币：23个                │
│    └─ 可兑换商品 [去使用 →]    │
│                                │
│ 🎰 剩余抽奖次数：10次          │
│    └─ 每次消耗100积分          │
└───────────────────────────────┘
```

### 6.2 抽奖页面

```
┌───────────────────────────────┐
│ 🎰 幸运大抽奖                  │
├───────────────────────────────┤
│ 消耗：100积分/次               │
│ 剩余次数：10次                 │
│                                │
│     [  🎁 立即抽奖  ]          │
│                                │
│ 📋 奖品展示：                  │
│ ┌─────┐ ┌─────┐ ┌─────┐       │
│ │耳机 │ │会员 │ │10个 │       │
│ │     │ │月卡 │ │兑换币│       │
│ └─────┘ └─────┘ └─────┘       │
└───────────────────────────────┘
```

### 6.3 兑换商城页面

```
┌───────────────────────────────┐
│ 🛒 兑换商城                    │
│ 💎 我的兑换币：23个            │
├───────────────────────────────┤
│ ┌─────────┐  ┌─────────┐      │
│ │ 保温杯  │  │无线鼠标 │      │
│ │ 💎10个币│  │💎30个币 │      │
│ │ ✅ 可兑换│  │ ✅ 可兑换│      │
│ └─────────┘  └─────────┘      │
│                                │
│ ┌─────────┐  ┌─────────┐      │
│ │蓝牙音箱 │  │智能手表 │      │
│ │ 💎50个币│  │💎50币+   │      │
│ │ ❌ 币不足│  │ 500积分  │      │
│ └─────────┘  └─────────┘      │
└───────────────────────────────┘
```

---

## 七、实施路线图

### 第一阶段：基础功能（2周）

**Week 1: 预算账户系统**
- [x] 创建数据库表结构
- [x] 实现消费后自动分配预算逻辑
- [x] 实现基础抽奖逻辑（动态筛选奖品）
- [x] 预算账户完全隐藏，前端只显示积分

**Week 2: 货币奖品系统**
- [x] 扩展奖品表支持货币类型
- [x] 实现货币奖品发放逻辑
- [x] 创建兑换商城表结构
- [x] 实现基础兑换功能

### 第二阶段：用户体验优化（1-2周）

**Week 3: 前端界面**
- [ ] 钱包页面（积分+兑换币展示）
- [ ] 抽奖页面（流畅动画）
- [ ] 兑换商城页面（商品展示）
- [ ] 中奖/兑换成功动画

**Week 4: API优化**
- [ ] 实施API响应检测中间件
- [ ] 优化错误提示语（用户友好）
- [ ] 增加各种边界情况处理
- [ ] 完善日志记录

### 第三阶段：风控和监控（1周）

**Week 5: 风控机制**
- [ ] 防刷机制（频率限制）
- [ ] 成本预警系统
- [ ] 异常检测和告警
- [ ] 实时成本监控仪表板

### 第四阶段：高级功能（1-2周）

**Week 6-7: 增强功能**
- [ ] 混合支付（币+积分）
- [ ] 保底机制（连续未中奖）
- [ ] 用户行为分析
- [ ] 运营后台（奖品管理、数据统计）

---

## 八、核心优势总结

### 8.1 技术优势

| 优势 | 说明 |
|-----|------|
| ✅ **成本100%可控** | 预算账户精准控制，不会超支 |
| ✅ **用户体验最优** | 抽奖刺激 + 兑换确定 = 完美平衡 |
| ✅ **实现简单** | 核心代码250行，易维护 |
| ✅ **预算完全隐藏** | 用户无感知后台控制机制 |
| ✅ **灵活性极高** | 支持多种玩法扩展 |
| ✅ **数据可追溯** | 完整的预算流水和成本记录 |

### 8.2 业务优势

| 优势 | 说明 |
|-----|------|
| ✅ **降低投诉** | 抽不到？攒币换！确定性兑换减少纠纷 |
| ✅ **提升活跃** | 攒币机制增加用户粘性 |
| ✅ **促进消费** | 想要更多币？继续消费！ |
| ✅ **保底机制** | 货币是保底奖，用户不会空手而归 |
| ✅ **运营灵活** | 可调整货币比例、兑换规则 |

### 8.3 与其他方案对比

| 方案 | 成本控制 | 用户体验 | 实现难度 | 综合评分 |
|-----|---------|---------|---------|---------|
| 方案5-预算账户 | 95% | 3.5/5 | 中等 | 4.4/5 ⭐⭐ |
| 方案7-双币制 | 100% | 4.5/5 | 简单 | 4.9/5 ⭐⭐⭐ |
| **本方案** | **100%** | **5.0/5** | **中等** | **5.0/5** ⭐⭐⭐ |

---

## 九、关键设计原则

### 9.1 预算隐藏原则

```
后端思维：
- 严格的预算账户控制
- 精确的成本计算
- 完整的数据追溯

前端呈现：
- 简单的积分和兑换币
- 友好的用户提示
- 零技术术语
```

### 9.2 用户友好原则

```
❌ 不好的提示：
"您的奖品预算已用完"
"剩余预算不足，无法抽取高价值奖品"
"成本超限"

✅ 好的提示：
"本轮抽奖机会已用完"
"很遗憾未中奖，继续努力！"
"继续消费可获得更多机会"
```

### 9.3 成本控制原则

```
三层防护：
1. 预算账户（主防线）- 精准控制总成本
2. 动态筛选（自适应）- 根据预算筛选奖品
3. 货币机制（辅助）- 中奖时已扣预算，兑换时不重复扣
```

---

## 十、常见问题FAQ

### Q1: 用户会不会发现预算机制？

**A**: 不会。用户只看到：
- 消费1000元 → 获得1000积分 + 10次抽奖机会
- 抽奖10次后 → "机会用完了，继续消费获得更多"
- 完全符合直觉，不会联想到预算

### Q2: 货币兑换会不会导致成本失控？

**A**: 不会。因为：
- 货币在中奖时已经扣了预算（10个币 = 扣预算10元）
- 兑换时只是"使用"已付出成本的货币
- 兑换商品的成本 = 货币价格 × 单币成本

### Q3: 如果用户一直抽到货币怎么办？

**A**: 这正是设计目标：
- 货币权重可以设高（保底机制）
- 用户攒币后自主选择兑换
- 成本仍然可控（货币成本 = 预算支出）
- 用户满意度更高（有选择权）

### Q4: 预算不够时为什么还能抽奖？

**A**: 不能。系统会：
- 前端显示"可抽次数：0"
- 点击抽奖返回"机会用完了"
- 引导用户去兑换商城或继续消费

### Q5: 如何防止用户刷羊毛？

**A**: 多重防护：
- 预算账户天然限制（消费多少，预算多少）
- 频率限制（每日/每小时抽奖上限）
- 异常检测（短时间大量兑换告警）
- 黑名单机制（发现作弊直接封禁）

---

## 📞 技术支持

如需详细实现代码或针对特定模块的深入讨论，请随时联系技术团队。

---

**文档结束**

**最终结论**: 
- **方案选择**: 预算账户（方案5）为主 + 货币奖品混合制
- **核心特点**: 后台精准控制成本，前端完全无感知
- **综合评分**: 5.0/5 ⭐⭐⭐
- **推荐指数**: 强烈推荐，适合99%的场景！

