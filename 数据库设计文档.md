# 餐厅积分抽奖系统 - 数据库设计文档

**文档版本**: v2.0  
**创建时间**: 2025年09月19日 UTC  
**更新时间**: 2025年09月19日 20:19:01 UTC  
**数据库引擎**: MySQL  
**字符集**: utf8mb4  
**时区**: UTC+8 (北京时间)  

## 📊 数据库概览

本项目使用MySQL数据库，采用Sequelize ORM框架进行数据访问。数据库设计遵循领域驱动设计(DDD)原则，将业务功能按照领域进行模块化分离。

### 🔧 数据库配置

**数据库连接配置**:
- **主机**: 从环境变量 `DB_HOST` 读取
- **端口**: 从环境变量 `DB_PORT` 读取 (默认3306)
- **数据库名**: 从环境变量 `DB_NAME` 读取
- **用户名**: 从环境变量 `DB_USER` 读取
- **密码**: 从环境变量 `DB_PASSWORD` 读取
- **字符集**: utf8mb4_unicode_ci
- **时区**: +08:00 (北京时间)

**连接池配置**:
- **最大连接数**: 50
- **最小连接数**: 5
- **获取连接超时**: 60秒
- **空闲连接时间**: 5分钟
- **连接清理间隔**: 1分钟

**数据库特性**:
- 支持JSON字段类型
- 启用大数字支持
- 自动处理连接断开
- 开发环境启用SQL日志

### 📋 表结构总览

当前数据库包含 **35+** 个数据表，按功能模块分为以下几类：

1. **用户管理模块** (3张表)
   - `users` - 用户基本信息
   - `admin_users` - 管理员用户
   - `user_sessions` - 用户会话管理

2. **积分系统模块** (3张表)
   - `user_points_accounts` - 用户积分账户
   - `points_transactions` - 积分交易记录
   - `trade_records` - 交易记录

3. **抽奖系统模块** (6张表)
   - `lottery_campaigns` - 抽奖活动配置
   - `lottery_records` - 抽奖记录
   - `lottery_prizes` - 奖品配置
   - `lottery_draws` - 抽奖执行记录
   - `prize_distributions` - 奖品分发记录
   - `lottery_pity` - 保底机制

4. **业务功能模块** (7张表)
   - `user_inventory` - 用户库存
   - `products` - 商品管理
   - `exchange_records` - 兑换记录
   - `business_events` - 业务事件
   - `image_resources` - 图片资源
   - `upload_review` - 上传审核
   - `business_configs` - 业务配置

5. **任务系统模块** (3张表)
   - `user_tasks` - 用户任务
   - `task_templates` - 任务模板
   - `scheduled_tasks` - 定时任务

6. **客服聊天模块** (4张表)
   - `customer_sessions` - 客服会话
   - `chat_messages` - 聊天消息
   - `quick_replies` - 快捷回复
   - `admin_status` - 管理员状态

7. **统一引擎模块** (5张表)
   - `lottery_execution_logs` - 抽奖执行日志
   - `lottery_engine_configs` - 抽奖引擎配置
   - `decision_records` - 决策记录
   - `probability_logs` - 概率日志
   - `system_metrics` - 系统指标

8. **系统管理模块** (4张表)
   - `login_logs` - 登录日志
   - `user_specific_prize_queues` - 用户专属奖品队列
   - `user_pool_access` - 用户池访问
   - `task_progress_logs` - 任务进度日志

### 🔗 数据库关系特点

- **外键约束**: 使用Sequelize关联而非数据库级外键
- **级联操作**: 通过ORM配置级联删除
- **索引优化**: 核心查询字段建立复合索引
- **JSON字段**: 灵活存储配置和元数据
- **时间字段**: 统一使用UTC时间存储

### 📈 数据规模

根据当前数据统计：
- **用户数据**: 约100+用户记录
- **抽奖记录**: 约97条抽奖记录
- **积分交易**: 活跃的交易记录
- **系统配置**: 完整的业务配置数据

## 🔑 主要设计原则

1. **领域分离**: 按业务领域划分表结构
2. **数据一致性**: 关键业务数据强一致性
3. **性能优化**: 合理的索引设计和查询优化
4. **扩展性**: 支持业务功能的快速扩展
5. **安全性**: 敏感数据加密存储
6. **监控性**: 完整的操作日志和审计跟踪

---

## 👥 用户管理模块

### 1. users - 用户基本信息表

**表名**: `users`  
**模型**: `User`  
**主要功能**: 存储用户的基本信息、登录状态和偏好设置

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `user_id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 用户唯一标识 |
| `mobile` | VARCHAR(20) | NOT NULL, UNIQUE | - | 手机号码 |
| `nickname` | VARCHAR(50) | NULL | - | 用户昵称 |
| `is_admin` | BOOLEAN | NOT NULL | false | 是否为管理员 |
| `history_total_points` | INTEGER | NOT NULL | 0 | 历史累计总积分（用于臻选空间解锁） |
| `status` | ENUM | NOT NULL | 'active' | 用户状态：active/inactive/banned |
| `last_login` | DATETIME | NULL | - | 最后登录时间 |
| `login_count` | INTEGER | NOT NULL | 0 | 登录次数统计 |
| `registration_date` | DATETIME | NOT NULL | NOW() | 注册时间 |
| `preferences` | JSON | NULL | - | 用户偏好设置 |
| `consecutive_fail_count` | INTEGER | NOT NULL | 0 | 连续未中奖次数（保底机制） |
| `created_at` | TIMESTAMP | NOT NULL | - | 记录创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL | - | 记录更新时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `user_id` | 主键索引 |
| `mobile` | 唯一 | `mobile` | 手机号唯一索引 |
| `idx_status_admin` | 普通 | `status`, `is_admin` | 状态和权限组合索引 |
| `idx_history_points` | 普通 | `history_total_points` | 历史积分索引 |
| `idx_last_login` | 普通 | `last_login` | 最后登录时间索引 |

#### 关联关系

- **一对一**: `UserPointsAccount` (积分账户)
- **一对多**: `PointsTransaction` (积分交易记录)
- **一对多**: `LotteryRecord` (抽奖记录)
- **一对多**: `PrizeDistribution` (奖品分发记录)
- **一对多**: `UserInventory` (用户库存)
- **一对多**: `UserTask` (用户任务)
- **一对多**: `LoginLog` (登录日志)
- **一对多**: `UserSession` (用户会话)

### 2. admin_users - 管理员用户表

**表名**: `admin_users`  
**模型**: `AdminUser`  
**主要功能**: 管理员账户管理，支持密码加密、账号锁定、MFA等安全功能

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `id` | BIGINT | PRIMARY KEY, AUTO_INCREMENT | - | 管理员ID |
| `username` | VARCHAR(50) | NOT NULL, UNIQUE | - | 管理员用户名 |
| `password_hash` | VARCHAR(255) | NOT NULL | - | BCrypt密码哈希 |
| `phone` | VARCHAR(11) | NULL | - | 绑定手机号 |
| `email` | VARCHAR(100) | NULL | - | 邮箱地址 |
| `role` | ENUM | NOT NULL | 'admin' | 角色：admin/super_admin |
| `status` | ENUM | NOT NULL | 'active' | 状态：active/inactive/banned |
| `mfa_enabled` | TINYINT | NOT NULL | 0 | 二次验证启用状态 |
| `mfa_secret` | VARCHAR(32) | NULL | - | MFA密钥 |
| `last_sms_time` | DATETIME | NULL | - | 最后发送短信时间 |
| `login_fail_count` | TINYINT | NOT NULL | 0 | 登录失败次数 |
| `locked_until` | DATETIME | NULL | - | 锁定到期时间 |
| `last_login_at` | DATETIME | NULL | - | 最后登录时间 |
| `last_login_ip` | VARCHAR(45) | NULL | - | 最后登录IP |
| `password_changed_at` | DATETIME | NULL | - | 密码最后修改时间 |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL | - | 更新时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `id` | 主键索引 |
| `username` | 唯一 | `username` | 用户名唯一索引 |
| `idx_status_role` | 普通 | `status`, `role` | 状态和角色组合索引 |
| `idx_locked_until` | 普通 | `locked_until` | 锁定时间索引 |

#### 安全特性

- **密码策略**: BCrypt加密，至少8位包含大小写字母、数字、特殊字符
- **账号锁定**: 失败3次锁定30分钟
- **MFA支持**: 二次验证功能
- **操作审计**: 完整的登录和操作日志

#### 关联关系

- **一对一**: `AdminStatus` (管理员状态)
- **一对多**: `LoginLog` (登录日志)
- **一对多**: `UserSession` (会话管理)

### 3. user_sessions - 用户会话管理表

**表名**: `user_sessions`  
**模型**: `UserSession`  
**主要功能**: 管理用户登录会话状态和安全控制

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `session_id` | VARCHAR(128) | PRIMARY KEY | - | 会话唯一标识 |
| `user_id` | INTEGER | NOT NULL | - | 用户ID |
| `user_type` | ENUM | NOT NULL | 'user' | 用户类型：user/admin |
| `token` | VARCHAR(255) | NOT NULL | - | 会话Token |
| `refresh_token` | VARCHAR(255) | NULL | - | 刷新Token |
| `ip_address` | VARCHAR(45) | NULL | - | 登录IP地址 |
| `user_agent` | TEXT | NULL | - | 用户代理信息 |
| `login_time` | DATETIME | NOT NULL | - | 登录时间 |
| `last_activity` | DATETIME | NOT NULL | - | 最后活动时间 |
| `expires_at` | DATETIME | NOT NULL | - | 会话过期时间 |
| `is_active` | BOOLEAN | NOT NULL | true | 是否活跃 |
| `logout_time` | DATETIME | NULL | - | 登出时间 |
| `device_info` | JSON | NULL | - | 设备信息 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `session_id` | 主键索引 |
| `idx_user_active` | 普通 | `user_id`, `is_active` | 用户活跃会话索引 |
| `idx_expires_at` | 普通 | `expires_at` | 过期时间索引 |
| `idx_token` | 普通 | `token` | Token索引 |

#### 会话管理特性

- **自动过期**: 支持会话自动过期
- **设备追踪**: 记录登录设备信息
- **安全控制**: IP地址和用户代理验证
- **Token刷新**: 支持Token刷新机制

---

## 🎰 抽奖系统模块

### 1. lottery_campaigns - 抽奖活动配置表

**表名**: `lottery_campaigns`  
**模型**: `LotteryCampaign`  
**主要功能**: 管理抽奖活动的完整配置，支持多种抽奖类型和概率算法

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `campaign_id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 活动唯一标识 |
| `campaign_name` | VARCHAR(255) | NOT NULL | - | 活动名称 |
| `campaign_code` | VARCHAR(100) | NOT NULL, UNIQUE | - | 活动代码（唯一） |
| `campaign_type` | ENUM | NOT NULL | - | 活动类型：daily/weekly/event/permanent |
| `cost_per_draw` | DECIMAL(10,2) | NOT NULL | - | 每次抽奖消耗积分 |
| `max_draws_per_user_daily` | INTEGER | NOT NULL | 1 | 每用户每日最大抽奖次数 |
| `max_draws_per_user_total` | INTEGER | NULL | - | 每用户总最大抽奖次数 |
| `total_prize_pool` | DECIMAL(15,2) | NOT NULL | 0.0 | 总奖池价值 |
| `remaining_prize_pool` | DECIMAL(15,2) | NOT NULL | 0.0 | 剩余奖池价值 |
| `prize_distribution_config` | JSON | NOT NULL | - | 奖品分布配置 |
| `start_time` | DATETIME | NOT NULL | - | 活动开始时间 |
| `end_time` | DATETIME | NOT NULL | - | 活动结束时间 |
| `daily_reset_time` | TIME | NOT NULL | '00:00:00' | 每日重置时间 |
| `banner_image_url` | VARCHAR(500) | NULL | - | 活动横幅图片 |
| `description` | TEXT | NULL | - | 活动描述 |
| `rules_text` | TEXT | NULL | - | 活动规则说明 |
| `status` | ENUM | NOT NULL | 'draft' | 活动状态：draft/active/paused/ended/cancelled |
| `is_featured` | BOOLEAN | NOT NULL | false | 是否为特色活动 |
| `total_participants` | INTEGER | NOT NULL | 0 | 总参与人数 |
| `total_draws` | INTEGER | NOT NULL | 0 | 总抽奖次数 |
| `total_prizes_awarded` | INTEGER | NOT NULL | 0 | 总中奖次数 |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL | - | 更新时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `campaign_id` | 主键索引 |
| `unique_campaign_code` | 唯一 | `campaign_code` | 活动代码唯一索引 |
| `idx_lc_status` | 普通 | `status` | 状态索引 |
| `idx_lc_campaign_type` | 普通 | `campaign_type` | 活动类型索引 |
| `idx_lc_time_range` | 普通 | `start_time`, `end_time` | 时间范围索引 |
| `idx_lc_is_featured` | 普通 | `is_featured` | 特色活动索引 |

#### 业务方法

- **状态检查**: `isActive()`, `isUpcoming()`, `isEnded()`
- **参与验证**: `canUserParticipate()`, `checkDrawCost()`
- **统计信息**: `getPrizePoolStats()`, `getParticipationStats()`
- **健康检查**: `getHealthStatus()`

#### 关联关系

- **一对多**: `LotteryPrize` (活动奖品)
- **一对多**: `LotteryRecord` (抽奖记录)
- **一对多**: `LotteryDraw` (抽奖执行记录)

### 2. lottery_records - 抽奖记录表

**表名**: `lottery_records`  
**模型**: `LotteryRecord`  
**主要功能**: 记录用户的抽奖活动历史和结果

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `draw_id` | VARCHAR(50) | PRIMARY KEY | - | 抽奖记录唯一ID |
| `user_id` | INTEGER | NOT NULL | - | 参与抽奖的用户ID |
| `prize_id` | INTEGER | NULL | - | 获得的奖品ID |
| `prize_name` | VARCHAR(100) | NULL | - | 奖品名称 |
| `prize_type` | ENUM | NULL | - | 奖品类型：points/product/coupon/special |
| `prize_value` | INTEGER | NULL | - | 奖品价值（积分数量或商品价值） |
| `draw_type` | ENUM | NULL | - | 抽奖类型：single/triple/five/ten |
| `draw_sequence` | INTEGER | NULL | - | 在批次中的抽奖序号 |
| `is_pity` | BOOLEAN | NOT NULL | false | 是否触发保底机制 |
| `cost_points` | INTEGER | NULL | - | 本次抽奖消耗的积分 |
| `stop_angle` | DECIMAL(5,2) | NULL | - | 转盘停止角度（转盘抽奖使用） |
| `batch_id` | VARCHAR(50) | NULL | - | 批次抽奖的批次ID |
| `draw_count` | INTEGER | NULL | - | 本次抽奖包含的次数（连抽使用） |
| `prize_description` | TEXT | NULL | - | 奖品详细描述 |
| `prize_image` | VARCHAR(500) | NULL | - | 奖品图片URL |
| `is_winner` | BOOLEAN | NULL | false | **是否中奖（核心业务字段）** |
| `guarantee_triggered` | BOOLEAN | NULL | false | 是否触发了保底 |
| `remaining_guarantee` | INTEGER | NULL | - | 抽奖后剩余的保底次数 |
| `draw_config` | JSON | NULL | - | 抽奖时的配置参数 |
| `result_metadata` | JSON | NULL | - | 抽奖结果的元数据 |
| `ip_address` | VARCHAR(45) | NULL | - | 用户IP地址 |
| `user_agent` | TEXT | NULL | - | 用户浏览器信息 |
| `lottery_id` | CHAR(36) | NOT NULL | - | 关联的抽奖活动ID |
| `created_at` | DATETIME | NOT NULL | NOW() | 抽奖时间 |
| `updated_at` | DATETIME | NOT NULL | NOW() | 记录更新时间 |

#### 核心业务字段说明

**`is_winner` 字段** - 抽奖成功标准：
- **true**: 本次抽奖获得有价值奖品（非空奖、非谢谢参与）
- **false**: 本次抽奖未中奖或获得无价值奖励
- **业务逻辑**: 中奖判断标准为获得的奖品具有实际价值
- **使用场景**: 中奖统计、中奖率计算、保底机制触发、奖品发放流程

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `draw_id` | 主键索引 |
| `idx_user_id` | 普通 | `user_id` | 用户ID索引 |
| `idx_prize_id` | 普通 | `prize_id` | 奖品ID索引 |
| `idx_prize_type` | 普通 | `prize_type` | 奖品类型索引 |
| `idx_draw_type` | 普通 | `draw_type` | 抽奖类型索引 |
| `idx_is_pity` | 普通 | `is_pity` | 保底索引 |
| `idx_batch_id` | 普通 | `batch_id` | 批次ID索引 |
| `idx_created_at` | 普通 | `created_at` | 创建时间索引 |
| `idx_user_created` | 普通 | `user_id`, `created_at` | 用户时间组合索引 |

#### 统计方法

- **用户记录**: `getUserRecords()` - 获取用户抽奖记录
- **用户统计**: `getUserLotteryStats()` - 获取用户抽奖统计
- **创建记录**: `createRecord()` - 创建抽奖记录

#### 关联关系

- **属于**: `User` (抽奖用户)
- **属于**: `LotteryPrize` (中奖奖品)
- **属于**: `LotteryCampaign` (抽奖活动)
- **一对多**: `PrizeDistribution` (奖品分发记录)

### 3. lottery_prizes - 奖品配置表

**表名**: `lottery_prizes`  
**模型**: `LotteryPrize`  
**主要功能**: 管理抽奖活动中的奖品配置、库存和中奖概率

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `prize_id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 奖品唯一标识 |
| `campaign_id` | INTEGER | NOT NULL | - | 所属活动ID |
| `prize_name` | VARCHAR(255) | NOT NULL | - | 奖品名称 |
| `prize_type` | ENUM | NOT NULL | - | 奖品类型：points/physical/virtual/coupon/service |
| `prize_value` | DECIMAL(10,2) | NOT NULL | - | 奖品价值 |
| `win_probability` | DECIMAL(8,6) | NOT NULL | - | 中奖概率（0-1之间） |
| `stock_quantity` | INTEGER | NULL | - | 库存数量（NULL表示无限） |
| `max_daily_wins` | INTEGER | NULL | - | 每日最大中奖次数 |
| `daily_win_count` | INTEGER | NOT NULL | 0 | 当日中奖次数 |
| `total_win_count` | INTEGER | NOT NULL | 0 | 总中奖次数 |
| `description` | TEXT | NULL | - | 奖品描述 |
| `image_url` | VARCHAR(500) | NULL | - | 奖品图片URL |
| `image_id` | INTEGER | NULL | - | 关联图片资源ID |
| `sort_order` | INTEGER | NOT NULL | 0 | 显示排序 |
| `status` | ENUM | NOT NULL | 'active' | 状态：active/inactive/out_of_stock/expired |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL | - | 更新时间 |

#### 业务方法

- **可用性检查**: `isAvailable()`, `isOutOfStock()`
- **概率计算**: `getWinProbabilityPercent()`
- **库存管理**: `updateStock()`, `incrementWinCount()`
- **数据验证**: `validatePrize()`

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `prize_id` | 主键索引 |
| `idx_campaign_active` | 普通 | `campaign_id`, `status` | 活动状态组合索引 |
| `idx_prize_type` | 普通 | `prize_type` | 奖品类型索引 |
| `idx_sort_order` | 普通 | `sort_order` | 排序索引 |

#### 关联关系

- **属于**: `LotteryCampaign` (抽奖活动)
- **属于**: `ImageResources` (图片资源)
- **一对多**: `LotteryRecord` (中奖记录)
- **一对多**: `PrizeDistribution` (奖品分发记录)

### 4. lottery_draws - 抽奖执行记录表

**表名**: `lottery_draws`  
**模型**: `LotteryDraw`  
**主要功能**: 记录抽奖的执行过程和算法细节

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `draw_id` | VARCHAR(50) | PRIMARY KEY | - | 抽奖执行ID |
| `user_id` | INTEGER | NOT NULL | - | 执行抽奖的用户ID |
| `campaign_id` | INTEGER | NOT NULL | - | 抽奖活动ID |
| `prize_id` | INTEGER | NULL | - | 中奖奖品ID |
| `algorithm_type` | ENUM | NOT NULL | - | 算法类型：random/weighted/guarantee |
| `draw_parameters` | JSON | NOT NULL | - | 抽奖参数配置 |
| `probability_data` | JSON | NULL | - | 概率计算数据 |
| `execution_time_ms` | INTEGER | NOT NULL | - | 执行时间（毫秒） |
| `status` | ENUM | NOT NULL | 'completed' | 状态：pending/running/completed/failed |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |

#### 关联关系

- **属于**: `User` (执行用户)
- **属于**: `LotteryCampaign` (抽奖活动)
- **属于**: `LotteryPrize` (中奖奖品)

### 5. prize_distributions - 奖品分发记录表

**表名**: `prize_distributions`  
**模型**: `PrizeDistribution`  
**主要功能**: 管理奖品的分发状态和流程跟踪

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `distribution_id` | VARCHAR(50) | PRIMARY KEY | - | 分发记录ID |
| `draw_id` | VARCHAR(50) | NOT NULL | - | 关联抽奖记录ID |
| `user_id` | INTEGER | NOT NULL | - | 获奖用户ID |
| `prize_id` | INTEGER | NOT NULL | - | 奖品ID |
| `prize_snapshot` | TEXT | NOT NULL | - | 奖品信息快照（JSON） |
| `distribution_type` | ENUM | NOT NULL | 'auto' | 分发类型：auto/manual/batch |
| `distribution_status` | ENUM | NOT NULL | 'pending' | 分发状态：pending/processing/distributed/failed/cancelled |
| `distribution_method` | ENUM | NOT NULL | - | 分发方式：points/inventory/voucher/manual |
| `verification_code` | VARCHAR(32) | NULL | - | 兑换验证码 |
| `distributed_at` | DATETIME | NULL | - | 分发完成时间 |
| `expires_at` | DATETIME | NULL | - | 过期时间 |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |

#### 关联关系

- **属于**: `LotteryRecord` (抽奖记录)
- **属于**: `User` (获奖用户)
- **属于**: `LotteryPrize` (奖品)

### 6. lottery_pity - 保底机制配置表

**表名**: `lottery_pity`  
**模型**: `LotteryPity`  
**主要功能**: 管理抽奖保底机制的配置和状态

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `pity_id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 保底配置ID |
| `campaign_id` | INTEGER | NOT NULL | - | 关联活动ID |
| `user_id` | INTEGER | NOT NULL | - | 用户ID |
| `pity_threshold` | INTEGER | NOT NULL | - | 保底触发阈值 |
| `current_count` | INTEGER | NOT NULL | 0 | 当前未中奖次数 |
| `guaranteed_prize_id` | INTEGER | NULL | - | 保底奖品ID |
| `is_triggered` | BOOLEAN | NOT NULL | false | 是否已触发保底 |
| `triggered_at` | DATETIME | NULL | - | 触发时间 |
| `reset_at` | DATETIME | NULL | - | 重置时间 |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |

---

## 💰 积分系统模块

### 1. user_points_accounts - 用户积分账户表

**表名**: `user_points_accounts`  
**模型**: `UserPointsAccount`  
**主要功能**: 管理用户积分余额、等级、行为评分和个性化偏好

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `account_id` | BIGINT | PRIMARY KEY, AUTO_INCREMENT | - | 账户唯一标识 |
| `user_id` | INTEGER | NOT NULL, UNIQUE | - | 关联用户ID |
| `current_balance` | DECIMAL(15,2) | NOT NULL | 0.00 | 当前积分余额 |
| `total_earned` | DECIMAL(15,2) | NOT NULL | 0.00 | 历史总获得积分 |
| `total_spent` | DECIMAL(15,2) | NOT NULL | 0.00 | 历史总消费积分 |
| `account_level` | ENUM | NOT NULL | 'bronze' | 账户等级：bronze/silver/gold/diamond |
| `behavior_score` | INTEGER | NOT NULL | 50 | 行为评分（0-100） |
| `activity_level` | ENUM | NOT NULL | 'low' | 活跃度：low/medium/high/premium |
| `preference_tags` | JSON | NULL | - | 偏好标签 |
| `last_activity_time` | DATETIME | NULL | - | 最后活动时间 |
| `last_behavior_time` | DATETIME | NULL | - | 最后行为记录时间 |
| `is_active` | BOOLEAN | NOT NULL | true | 账户是否活跃 |
| `freeze_reason` | VARCHAR(255) | NULL | - | 冻结原因 |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL | - | 更新时间 |

#### 业务方法

- **等级管理**: `getLevelInfo()`, `getPointsToNextLevel()`, `checkForLevelUp()`
- **积分计算**: `calculatePointsBonus()`
- **行为评分**: `updateBehaviorScore()`, `updateActivityLevel()`
- **健康检查**: `checkAccountHealth()`

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `account_id` | 主键索引 |
| `user_id` | 唯一 | `user_id` | 用户ID唯一索引 |
| `idx_level_active` | 普通 | `account_level`, `is_active` | 等级活跃度索引 |
| `idx_balance` | 普通 | `current_balance` | 余额索引 |

#### 关联关系

- **属于**: `User` (关联用户)
- **一对多**: `PointsTransaction` (积分交易记录)

### 2. points_transactions - 积分交易记录表

**表名**: `points_transactions`  
**模型**: `PointsTransaction`  
**主要功能**: 记录所有积分变动的详细历史

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `transaction_id` | BIGINT | PRIMARY KEY, AUTO_INCREMENT | - | 交易ID |
| `account_id` | BIGINT | NOT NULL | - | 账户ID |
| `user_id` | INTEGER | NOT NULL | - | 用户ID |
| `transaction_type` | ENUM | NOT NULL | - | 交易类型：earn/spend/transfer/adjustment |
| `amount` | DECIMAL(15,2) | NOT NULL | - | 变动金额（正数为收入，负数为支出） |
| `balance_before` | DECIMAL(15,2) | NOT NULL | - | 交易前余额 |
| `balance_after` | DECIMAL(15,2) | NOT NULL | - | 交易后余额 |
| `source_type` | VARCHAR(50) | NOT NULL | - | 来源类型：lottery/task/purchase/admin等 |
| `source_id` | VARCHAR(50) | NULL | - | 来源记录ID |
| `description` | VARCHAR(255) | NULL | - | 交易描述 |
| `metadata` | JSON | NULL | - | 交易元数据 |
| `status` | ENUM | NOT NULL | 'completed' | 状态：pending/completed/failed/cancelled |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `transaction_id` | 主键索引 |
| `idx_account_time` | 普通 | `account_id`, `created_at` | 账户时间索引 |
| `idx_user_type` | 普通 | `user_id`, `transaction_type` | 用户类型索引 |
| `idx_source` | 普通 | `source_type`, `source_id` | 来源索引 |

### 3. trade_records - 交易记录表

**表名**: `trade_records`  
**模型**: `TradeRecord`  
**主要功能**: 记录用户的各类交易行为和结果

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `trade_id` | VARCHAR(50) | PRIMARY KEY | - | 交易唯一标识 |
| `user_id` | INTEGER | NOT NULL | - | 交易用户ID |
| `trade_type` | ENUM | NOT NULL | - | 交易类型：lottery/exchange/reward/penalty |
| `amount` | DECIMAL(15,2) | NOT NULL | - | 交易金额 |
| `currency_type` | ENUM | NOT NULL | 'points' | 货币类型：points/virtual_currency |
| `related_id` | VARCHAR(50) | NULL | - | 关联业务ID |
| `trade_status` | ENUM | NOT NULL | 'pending' | 交易状态：pending/completed/failed/cancelled |
| `is_successful` | BOOLEAN | NOT NULL | false | **交易是否成功（核心业务字段）** |
| `description` | VARCHAR(255) | NULL | - | 交易描述 |
| `metadata` | JSON | NULL | - | 交易元数据 |
| `processed_at` | DATETIME | NULL | - | 处理完成时间 |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `trade_id` | 主键索引 |
| `idx_user_type` | 普通 | `user_id`, `trade_type` | 用户交易类型索引 |
| `idx_status_success` | 普通 | `trade_status`, `is_successful` | 状态成功索引 |

---

## 📦 业务功能模块

### 1. user_inventory - 用户库存表

**表名**: `user_inventory`  
**模型**: `UserInventory`  
**主要功能**: 管理用户获得的奖品、商品和优惠券

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `id` | VARCHAR(32) | PRIMARY KEY | - | 库存物品唯一标识 |
| `user_id` | INTEGER | NOT NULL | - | 用户ID |
| `name` | VARCHAR(100) | NOT NULL | - | 物品名称 |
| `description` | TEXT | NULL | - | 物品描述 |
| `type` | ENUM | NOT NULL | - | 物品类型：voucher/product/service |
| `value` | INTEGER | NOT NULL | 0 | 物品价值（积分等价值） |
| `status` | ENUM | NOT NULL | 'available' | 状态：available/pending/used/expired/transferred |
| `source_type` | VARCHAR(50) | NOT NULL | - | 获得来源类型 |
| `source_id` | VARCHAR(32) | NULL | - | 来源记录ID |
| `acquired_at` | DATETIME | NOT NULL | NOW() | 获得时间 |
| `expires_at` | DATETIME | NULL | - | 过期时间 |
| `used_at` | DATETIME | NULL | - | 使用时间 |
| `verification_code` | VARCHAR(32) | NULL | - | 核销码 |
| `transfer_info` | JSON | NULL | - | 转让信息 |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL | - | 更新时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `id` | 主键索引 |
| `idx_user_status` | 普通 | `user_id`, `status` | 用户状态索引 |
| `idx_verification` | 普通 | `verification_code` | 核销码索引 |
| `idx_expires` | 普通 | `expires_at` | 过期时间索引 |

#### 关联关系

- **属于**: `User` (物品拥有者)

### 2. products - 商品管理表

**表名**: `products`  
**模型**: `Product`  
**主要功能**: 管理系统中的商品信息和兑换配置

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `product_id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 商品ID |
| `name` | VARCHAR(255) | NOT NULL | - | 商品名称 |
| `description` | TEXT | NULL | - | 商品描述 |
| `category` | VARCHAR(100) | NOT NULL | - | 商品分类 |
| `points_required` | INTEGER | NOT NULL | - | 兑换所需积分 |
| `stock_quantity` | INTEGER | NULL | - | 库存数量 |
| `image_url` | VARCHAR(500) | NULL | - | 商品图片 |
| `status` | ENUM | NOT NULL | 'active' | 状态：active/inactive/out_of_stock |
| `sort_order` | INTEGER | NOT NULL | 0 | 排序权重 |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL | - | 更新时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `product_id` | 主键索引 |
| `idx_category_status` | 普通 | `category`, `status` | 分类状态索引 |
| `idx_points` | 普通 | `points_required` | 积分需求索引 |

### 3. exchange_records - 兑换记录表

**表名**: `exchange_records`  
**模型**: `ExchangeRecords`  
**主要功能**: 记录用户使用积分兑换商品的详细信息

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 兑换记录ID |
| `exchange_id` | VARCHAR(50) | NOT NULL, UNIQUE | - | 兑换记录业务ID |
| `user_id` | INTEGER | NOT NULL | - | 用户ID |
| `product_id` | INTEGER | NOT NULL | - | 商品ID |
| `product_snapshot` | JSON | NOT NULL | - | 商品信息快照 |
| `quantity` | INTEGER | NOT NULL | 1 | 兑换数量 |
| `total_points` | INTEGER | NOT NULL | - | 总消耗积分 |
| `exchange_code` | VARCHAR(50) | NOT NULL, UNIQUE | - | 兑换码 |
| `status` | ENUM | NOT NULL | 'distributed' | 状态：pending/distributed/used/expired/cancelled |
| `is_successful` | BOOLEAN | NOT NULL | false | **兑换是否成功（核心业务字段）** |
| `used_at` | DATETIME | NULL | - | 使用时间 |
| `expires_at` | DATETIME | NULL | - | 过期时间 |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `id` | 主键索引 |
| `exchange_id` | 唯一 | `exchange_id` | 业务ID唯一索引 |
| `exchange_code` | 唯一 | `exchange_code` | 兑换码唯一索引 |
| `idx_user_status` | 普通 | `user_id`, `status` | 用户状态索引 |

### 4. business_events - 业务事件表

**表名**: `business_events`  
**模型**: `BusinessEvent`  
**主要功能**: 记录系统中的重要业务事件和操作

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `event_id` | VARCHAR(50) | PRIMARY KEY | - | 事件唯一标识 |
| `event_type` | VARCHAR(100) | NOT NULL | - | 事件类型 |
| `user_id` | INTEGER | NULL | - | 关联用户ID |
| `entity_type` | VARCHAR(50) | NULL | - | 实体类型 |
| `entity_id` | VARCHAR(50) | NULL | - | 实体ID |
| `event_data` | JSON | NULL | - | 事件数据 |
| `severity` | ENUM | NOT NULL | 'info' | 严重程度：debug/info/warning/error/critical |
| `status` | ENUM | NOT NULL | 'active' | 状态：active/archived/deleted |
| `created_at` | TIMESTAMP | NOT NULL | - | 事件发生时间 |

### 5. image_resources - 图片资源表

**表名**: `image_resources`  
**模型**: `ImageResources`  
**主要功能**: 管理系统中使用的图片资源

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `image_id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 图片资源ID |
| `original_name` | VARCHAR(255) | NOT NULL | - | 原始文件名 |
| `stored_name` | VARCHAR(255) | NOT NULL | - | 存储文件名 |
| `file_path` | VARCHAR(500) | NOT NULL | - | 文件路径 |
| `file_size` | INTEGER | NOT NULL | - | 文件大小（字节） |
| `mime_type` | VARCHAR(100) | NOT NULL | - | MIME类型 |
| `width` | INTEGER | NULL | - | 图片宽度 |
| `height` | INTEGER | NULL | - | 图片高度 |
| `upload_user_id` | INTEGER | NULL | - | 上传用户ID |
| `usage_type` | ENUM | NOT NULL | 'general' | 用途类型：general/avatar/prize/product/banner |
| `status` | ENUM | NOT NULL | 'active' | 状态：active/deleted/processing |
| `created_at` | TIMESTAMP | NOT NULL | - | 上传时间 |

### 6. upload_review - 图片上传审核表

**表名**: `upload_review`  
**模型**: `UploadReview`  
**主要功能**: 管理用户上传图片的审核流程和状态

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 审核记录唯一ID |
| `user_id` | INTEGER | NOT NULL | - | 上传用户ID |
| `image_id` | INTEGER | NOT NULL | - | 图片资源ID |
| `review_status` | ENUM | NOT NULL | 'pending' | 审核状态：pending/approved/rejected/reviewing |
| `reviewer_id` | INTEGER | NULL | - | 审核员用户ID |
| `review_time` | DATETIME | NULL | - | 审核时间 |
| `review_notes` | TEXT | NULL | - | 审核备注 |
| `image_url` | VARCHAR(500) | NOT NULL | - | 图片URL |
| `image_type` | ENUM | NOT NULL | 'photo' | 图片类型：photo/document/other |
| `file_size` | INTEGER | NULL | - | 文件大小（字节） |
| `file_hash` | VARCHAR(64) | NULL | - | 文件哈希值（防重复） |
| `points_awarded` | INTEGER | NOT NULL | 0 | 奖励积分 |
| `reject_reason` | ENUM | NULL | - | 拒绝原因：inappropriate/duplicate/quality/spam/other |
| `auto_review` | BOOLEAN | NOT NULL | false | 是否自动审核 |
| `client_info` | VARCHAR(200) | NULL | - | 客户端信息 |
| `metadata` | JSON | NULL | - | 审核元数据 |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL | - | 更新时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `id` | 主键索引 |
| `idx_user_status` | 普通 | `user_id`, `review_status` | 用户状态索引 |
| `idx_reviewer` | 普通 | `reviewer_id` | 审核员索引 |
| `idx_review_time` | 普通 | `review_time` | 审核时间索引 |
| `idx_file_hash` | 普通 | `file_hash` | 文件哈希索引 |

#### 关联关系

- **属于**: `User` (上传用户)
- **属于**: `ImageResources` (图片资源)
- **属于**: `AdminUser` (审核员)

### 7. business_configs - 业务配置表

**表名**: `business_configs`  
**模型**: `BusinessConfigs`  
**主要功能**: 管理系统各业务模块的配置参数

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `id` | BIGINT | PRIMARY KEY, AUTO_INCREMENT | - | 配置ID |
| `business_type` | ENUM | NOT NULL, UNIQUE | - | 业务类型：lottery/exchange/trade/uploads |
| `storage_policy` | JSON | NOT NULL | 存储策略默认值 | 存储策略配置 |
| `file_rules` | JSON | NOT NULL | 文件规则默认值 | 文件规则配置 |
| `cache_config` | JSON | NULL | - | 缓存配置 |
| `extended_config` | JSON | NULL | - | 扩展配置 |
| `status` | ENUM | NOT NULL | 'active' | 配置状态：active/inactive |
| `created_at` | TIMESTAMP | NOT NULL | NOW() | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL | NOW() | 更新时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `id` | 主键索引 |
| `idx_business_type` | 唯一 | `business_type` | 业务类型唯一索引 |
| `idx_status` | 普通 | `status` | 状态索引 |

#### 业务配置说明

- **存储策略**: 热数据30天，标准数据365天，归档数据1095天
- **文件规则**: 最大10MB，支持jpg/jpeg/png/webp格式
- **缓存配置**: TTL 5分钟，最大1000条记录
- **扩展配置**: 业务特定的其他配置参数

---

## 💬 客服聊天模块

### 1. customer_sessions - 客服会话表

**表名**: `customer_sessions`  
**模型**: `CustomerSession`  
**主要功能**: 管理用户与客服的会话状态

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `session_id` | VARCHAR(50) | PRIMARY KEY | - | 会话唯一标识 |
| `user_id` | INTEGER | NOT NULL | - | 用户ID |
| `admin_id` | INTEGER | NULL | - | 处理的管理员ID |
| `status` | ENUM | NOT NULL | 'pending' | 会话状态：pending/active/resolved/closed |
| `priority` | ENUM | NOT NULL | 'normal' | 优先级：low/normal/high/urgent |
| `subject` | VARCHAR(255) | NULL | - | 会话主题 |
| `initial_message` | TEXT | NULL | - | 初始消息 |
| `resolution_notes` | TEXT | NULL | - | 解决方案备注 |
| `satisfaction_rating` | INTEGER | NULL | - | 满意度评分（1-5） |
| `started_at` | DATETIME | NOT NULL | NOW() | 会话开始时间 |
| `ended_at` | DATETIME | NULL | - | 会话结束时间 |
| `last_activity_at` | DATETIME | NOT NULL | NOW() | 最后活动时间 |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL | - | 更新时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `session_id` | 主键索引 |
| `idx_user_status` | 普通 | `user_id`, `status` | 用户状态索引 |
| `idx_admin_active` | 普通 | `admin_id`, `status` | 管理员状态索引 |
| `idx_priority_time` | 普通 | `priority`, `started_at` | 优先级时间索引 |

### 2. chat_messages - 聊天消息表

**表名**: `chat_messages`  
**模型**: `ChatMessage`  
**主要功能**: 存储聊天会话中的所有消息

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `message_id` | VARCHAR(50) | PRIMARY KEY | - | 消息唯一标识 |
| `session_id` | VARCHAR(50) | NOT NULL | - | 所属会话ID |
| `sender_id` | INTEGER | NOT NULL | - | 发送者ID |
| `sender_type` | ENUM | NOT NULL | - | 发送者类型：user/admin/system |
| `message_type` | ENUM | NOT NULL | 'text' | 消息类型：text/image/file/system |
| `content` | TEXT | NOT NULL | - | 消息内容 |
| `attachments` | JSON | NULL | - | 附件信息 |
| `metadata` | JSON | NULL | - | 消息元数据 |
| `is_read` | BOOLEAN | NOT NULL | false | 是否已读 |
| `read_at` | DATETIME | NULL | - | 已读时间 |
| `created_at` | TIMESTAMP | NOT NULL | - | 发送时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `message_id` | 主键索引 |
| `idx_session_time` | 普通 | `session_id`, `created_at` | 会话时间索引 |
| `idx_sender` | 普通 | `sender_id`, `sender_type` | 发送者索引 |

### 3. quick_replies - 快速回复模板表

**表名**: `quick_replies`  
**模型**: `QuickReply`  
**主要功能**: 管理客服快速回复模板

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `id` | BIGINT | PRIMARY KEY, AUTO_INCREMENT | - | 模板ID |
| `admin_id` | INTEGER | NULL | - | 管理员ID(NULL表示公共模板) |
| `title` | VARCHAR(100) | NOT NULL | - | 模板标题 |
| `content` | TEXT | NOT NULL | - | 回复内容 |
| `category` | VARCHAR(50) | NULL | - | 分类 |
| `usage_count` | INTEGER | NOT NULL | 0 | 使用次数 |
| `is_active` | BOOLEAN | NOT NULL | true | 是否启用 |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL | - | 更新时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `id` | 主键索引 |
| `idx_admin_id` | 普通 | `admin_id` | 管理员索引 |
| `idx_category` | 普通 | `category` | 分类索引 |
| `idx_is_active` | 普通 | `is_active` | 启用状态索引 |

#### 业务方法

- **权限检查**: `isPublic()`, `belongsToAdmin()`
- **使用统计**: `incrementUsage()`
- **状态管理**: `toggleActive()`

#### 关联关系

- **属于**: `AdminUser` (模板创建者)

### 4. admin_status - 管理员状态表

**表名**: `admin_status`  
**模型**: `AdminStatus`  
**主要功能**: 管理客服管理员的在线状态和会话负载

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `id` | BIGINT | PRIMARY KEY, AUTO_INCREMENT | - | 状态记录ID |
| `admin_id` | INTEGER | NOT NULL, UNIQUE | - | 管理员ID |
| `status` | ENUM | NOT NULL | 'offline' | 状态：online/busy/offline |
| `current_sessions` | INTEGER | NOT NULL | 0 | 当前处理会话数 |
| `max_sessions` | INTEGER | NOT NULL | 9999999 | 最大处理会话数 |
| `last_active_at` | DATETIME | NOT NULL | NOW() | 最后活跃时间 |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL | - | 更新时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `id` | 主键索引 |
| `idx_admin_id` | 唯一 | `admin_id` | 管理员ID唯一索引 |
| `idx_status` | 普通 | `status` | 状态索引 |
| `idx_last_active_at` | 普通 | `last_active_at` | 最后活跃时间索引 |

#### 业务方法

- **状态检查**: `isOnline()`, `isBusy()`, `isAvailable()`
- **会话管理**: `canTakeNewSession()`
- **活跃度更新**: `updateActivity()`

#### 关联关系

- **属于**: `AdminUser` (管理员)

---

## 📋 任务系统模块

### 1. user_tasks - 用户任务表

**表名**: `user_tasks`  
**模型**: `UserTask`  
**主要功能**: 管理用户的任务进度和完成状态

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `task_id` | VARCHAR(50) | PRIMARY KEY | - | 任务实例ID |
| `user_id` | INTEGER | NOT NULL | - | 用户ID |
| `template_id` | VARCHAR(50) | NOT NULL | - | 任务模板ID |
| `task_name` | VARCHAR(255) | NOT NULL | - | 任务名称 |
| `task_type` | ENUM | NOT NULL | - | 任务类型：daily/weekly/achievement/special |
| `description` | TEXT | NULL | - | 任务描述 |
| `target_value` | INTEGER | NOT NULL | - | 目标值 |
| `current_progress` | INTEGER | NOT NULL | 0 | 当前进度 |
| `status` | ENUM | NOT NULL | 'active' | 状态：active/completed/expired/cancelled |
| `reward_points` | INTEGER | NOT NULL | 0 | 奖励积分 |
| `reward_items` | JSON | NULL | - | 奖励物品 |
| `started_at` | DATETIME | NOT NULL | NOW() | 开始时间 |
| `expires_at` | DATETIME | NULL | - | 过期时间 |
| `completed_at` | DATETIME | NULL | - | 完成时间 |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL | - | 更新时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `task_id` | 主键索引 |
| `idx_user_status` | 普通 | `user_id`, `status` | 用户状态索引 |
| `idx_template_type` | 普通 | `template_id`, `task_type` | 模板类型索引 |
| `idx_expires` | 普通 | `expires_at` | 过期时间索引 |

### 2. task_templates - 任务模板表

**表名**: `task_templates`  
**模型**: `TaskTemplate`  
**主要功能**: 定义任务的模板配置和规则

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `template_id` | VARCHAR(50) | PRIMARY KEY | - | 任务模板ID |
| `template_name` | VARCHAR(255) | NOT NULL | - | 模板名称 |
| `task_type` | ENUM | NOT NULL | - | 任务类型：daily/weekly/achievement/special |
| `description` | TEXT | NULL | - | 任务描述 |
| `target_value` | INTEGER | NOT NULL | - | 目标值 |
| `reward_points` | INTEGER | NOT NULL | 0 | 奖励积分 |
| `reward_items` | JSON | NULL | - | 奖励物品配置 |
| `conditions` | JSON | NULL | - | 完成条件配置 |
| `duration_days` | INTEGER | NULL | - | 任务持续天数 |
| `is_repeatable` | BOOLEAN | NOT NULL | false | 是否可重复 |
| `is_active` | BOOLEAN | NOT NULL | true | 是否激活 |
| `sort_order` | INTEGER | NOT NULL | 0 | 排序权重 |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |

### 3. scheduled_tasks - 定时任务表

**表名**: `scheduled_tasks`  
**模型**: `ScheduledTask`  
**主要功能**: 管理系统的定时任务配置和执行状态

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `task_id` | VARCHAR(50) | PRIMARY KEY | - | 定时任务ID |
| `task_name` | VARCHAR(255) | NOT NULL | - | 任务名称 |
| `task_type` | ENUM | NOT NULL | - | 任务类型：cron/interval/once |
| `schedule_expression` | VARCHAR(100) | NOT NULL | - | 调度表达式 |
| `handler_name` | VARCHAR(255) | NOT NULL | - | 处理器名称 |
| `parameters` | JSON | NULL | - | 任务参数 |
| `status` | ENUM | NOT NULL | 'active' | 状态：active/paused/disabled |
| `last_execution` | DATETIME | NULL | - | 最后执行时间 |
| `next_execution` | DATETIME | NULL | - | 下次执行时间 |
| `execution_count` | INTEGER | NOT NULL | 0 | 执行次数 |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |

---

## 🔧 系统管理模块

### 1. login_logs - 登录日志表

**表名**: `login_logs`  
**模型**: `LoginLog`  
**主要功能**: 记录用户和管理员的登录历史

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `log_id` | BIGINT | PRIMARY KEY, AUTO_INCREMENT | - | 日志ID |
| `user_id` | INTEGER | NOT NULL | - | 用户ID |
| `user_type` | ENUM | NOT NULL | 'user' | 用户类型：user/admin |
| `login_type` | ENUM | NOT NULL | 'mobile' | 登录方式：mobile/password/sms |
| `ip_address` | VARCHAR(45) | NULL | - | 登录IP |
| `user_agent` | TEXT | NULL | - | 用户代理 |
| `login_status` | ENUM | NOT NULL | 'success' | 登录状态：success/failed/blocked |
| `failure_reason` | VARCHAR(255) | NULL | - | 失败原因 |
| `session_id` | VARCHAR(128) | NULL | - | 会话ID |
| `login_time` | DATETIME | NOT NULL | NOW() | 登录时间 |
| `logout_time` | DATETIME | NULL | - | 登出时间 |
| `created_at` | TIMESTAMP | NOT NULL | - | 记录创建时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `log_id` | 主键索引 |
| `idx_user_time` | 普通 | `user_id`, `login_time` | 用户时间索引 |
| `idx_ip_status` | 普通 | `ip_address`, `login_status` | IP状态索引 |
| `idx_session` | 普通 | `session_id` | 会话索引 |

### 2. user_specific_prize_queues - 用户专属奖品队列表

**表名**: `user_specific_prize_queues`  
**模型**: `UserSpecificPrizeQueue`  
**主要功能**: 支持管理员为特定用户设置预定义的奖品序列

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `queue_id` | VARCHAR(50) | PRIMARY KEY | 自动生成 | 队列记录唯一ID |
| `user_id` | INTEGER | NOT NULL | - | 目标用户ID |
| `campaign_id` | INTEGER | NOT NULL | - | 关联的抽奖活动ID |
| `prize_id` | INTEGER | NOT NULL | - | 预设奖品ID |
| `prize_number` | INTEGER | NOT NULL | - | 奖品编号（1-10号） |
| `queue_order` | INTEGER | NOT NULL | - | 在用户队列中的顺序 |
| `status` | ENUM | NOT NULL | 'pending' | 队列状态：pending/distributed/expired/cancelled |
| `distributed_at` | DATETIME | NULL | - | 实际分发时间 |
| `admin_id` | INTEGER | NOT NULL | - | 创建管理员ID |
| `admin_notes` | TEXT | NULL | - | 管理员备注 |
| `priority_level` | INTEGER | NOT NULL | 1 | 优先级等级（1-10） |
| `expires_at` | DATETIME | NULL | - | 过期时间 |
| `metadata` | JSON | NULL | - | 队列元数据 |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL | - | 更新时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `queue_id` | 主键索引 |
| `idx_user_order` | 普通 | `user_id`, `queue_order` | 用户队列顺序索引 |
| `idx_campaign_status` | 普通 | `campaign_id`, `status` | 活动状态索引 |
| `idx_admin_created` | 普通 | `admin_id`, `created_at` | 管理员创建时间索引 |
| `idx_expires_at` | 普通 | `expires_at` | 过期时间索引 |

#### 业务方法

- **队列管理**: `getNextInQueue()`, `markAsDistributed()`
- **状态检查**: `isExpired()`, `isPending()`
- **优先级管理**: `updatePriority()`

#### 关联关系

- **属于**: `User` (目标用户)
- **属于**: `LotteryCampaign` (抽奖活动)
- **属于**: `LotteryPrize` (预设奖品)
- **属于**: `AdminUser` (创建管理员)

### 3. user_pool_access - 用户池访问记录表

**表名**: `user_pool_access`  
**模型**: `UserPoolAccess`  
**主要功能**: 记录用户对奖品池的访问和使用情况

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 访问记录ID |
| `user_id` | INTEGER | NOT NULL | - | 用户ID |
| `pool_id` | VARCHAR(50) | NOT NULL | - | 池ID |
| `access_date` | DATE | NOT NULL | - | 访问日期 |
| `daily_draws` | INTEGER | NOT NULL | 0 | 当日抽取次数 |
| `total_draws` | INTEGER | NOT NULL | 0 | 总抽取次数 |
| `total_spent` | INTEGER | NOT NULL | 0 | 总消耗积分 |
| `total_rewards` | INTEGER | NOT NULL | 0 | 总获得奖励 |
| `last_draw_time` | DATETIME | NULL | - | 最后抽取时间 |
| `access_level` | ENUM | NOT NULL | 'basic' | 访问等级：basic/premium/vip/unlimited |
| `created_at` | TIMESTAMP | NOT NULL | NOW() | 首次访问时间 |
| `updated_at` | TIMESTAMP | NOT NULL | NOW() | 更新时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `id` | 主键索引 |
| `idx_user_date` | 普通 | `user_id`, `access_date` | 用户日期索引 |
| `idx_pool_level` | 普通 | `pool_id`, `access_level` | 池等级索引 |
| `idx_last_draw` | 普通 | `last_draw_time` | 最后抽取时间索引 |

#### 关联关系

- **属于**: `User` (用户)

### 4. task_progress_logs - 任务进度记录表

**表名**: `task_progress_logs`  
**模型**: `TaskProgressLog`  
**主要功能**: 记录用户任务进度的变化历史

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 进度记录ID |
| `task_id` | VARCHAR(50) | NOT NULL | - | 任务ID |
| `user_id` | INTEGER | NOT NULL | - | 用户ID |
| `action_type` | ENUM | NOT NULL | - | 操作类型：progress/bonus/penalty/reset/complete |
| `progress_before` | INTEGER | NOT NULL | - | 操作前进度 |
| `progress_after` | INTEGER | NOT NULL | - | 操作后进度 |
| `change_amount` | INTEGER | NOT NULL | - | 变化量 |
| `trigger_source` | VARCHAR(100) | NULL | - | 触发来源 |
| `description` | TEXT | NULL | - | 变化描述 |
| `metadata` | JSON | NULL | - | 相关元数据 |
| `created_at` | TIMESTAMP | NOT NULL | NOW() | 记录时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `id` | 主键索引 |
| `idx_task_time` | 普通 | `task_id`, `created_at` | 任务时间索引 |
| `idx_user_action` | 普通 | `user_id`, `action_type` | 用户操作索引 |
| `idx_trigger_source` | 普通 | `trigger_source` | 触发来源索引 |

#### 关联关系

- **属于**: `UserTask` (用户任务)
- **属于**: `User` (用户)

---

## 🔍 统一引擎模块

### 1. lottery_execution_logs - 抽奖执行日志表

**表名**: `lottery_execution_logs`  
**模型**: `LotteryExecutionLog`  
**主要功能**: 记录抽奖引擎的详细执行日志

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `log_id` | BIGINT | PRIMARY KEY, AUTO_INCREMENT | - | 日志ID |
| `execution_id` | VARCHAR(50) | NOT NULL | - | 执行批次ID |
| `user_id` | INTEGER | NOT NULL | - | 用户ID |
| `campaign_id` | INTEGER | NOT NULL | - | 活动ID |
| `engine_version` | VARCHAR(20) | NOT NULL | - | 引擎版本 |
| `execution_type` | ENUM | NOT NULL | - | 执行类型：single/batch/test |
| `input_parameters` | JSON | NOT NULL | - | 输入参数 |
| `algorithm_used` | VARCHAR(100) | NOT NULL | - | 使用的算法 |
| `probability_data` | JSON | NULL | - | 概率数据 |
| `decision_process` | JSON | NULL | - | 决策过程 |
| `execution_result` | JSON | NOT NULL | - | 执行结果 |
| `performance_metrics` | JSON | NULL | - | 性能指标 |
| `execution_time_ms` | INTEGER | NOT NULL | - | 执行时间（毫秒） |
| `status` | ENUM | NOT NULL | 'completed' | 状态：pending/running/completed/failed |
| `error_details` | JSON | NULL | - | 错误详情 |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `log_id` | 主键索引 |
| `idx_execution_id` | 普通 | `execution_id` | 执行ID索引 |
| `idx_user_campaign` | 普通 | `user_id`, `campaign_id` | 用户活动索引 |
| `idx_created_at` | 普通 | `created_at` | 创建时间索引 |

### 2. lottery_engine_configs - 抽奖引擎配置表

**表名**: `lottery_engine_configs`  
**模型**: `LotteryEngineConfig`  
**主要功能**: 管理抽奖引擎的配置参数和算法设置

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 配置ID |
| `config_name` | VARCHAR(100) | NOT NULL, UNIQUE | - | 配置名称 |
| `config_type` | ENUM | NOT NULL | - | 配置类型：algorithm/probability/performance/validation |
| `engine_version` | VARCHAR(20) | NOT NULL | - | 引擎版本 |
| `algorithm_config` | JSON | NOT NULL | - | 算法配置参数 |
| `probability_settings` | JSON | NOT NULL | - | 概率设置 |
| `performance_limits` | JSON | NOT NULL | - | 性能限制配置 |
| `validation_rules` | JSON | NOT NULL | - | 验证规则配置 |
| `fallback_config` | JSON | NULL | - | 降级配置 |
| `is_active` | BOOLEAN | NOT NULL | true | 是否启用 |
| `priority_level` | INTEGER | NOT NULL | 1 | 优先级等级 |
| `environment` | ENUM | NOT NULL | 'production' | 环境：development/testing/production |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL | - | 更新时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `id` | 主键索引 |
| `idx_config_name` | 唯一 | `config_name` | 配置名称唯一索引 |
| `idx_type_active` | 普通 | `config_type`, `is_active` | 类型状态索引 |
| `idx_version_env` | 普通 | `engine_version`, `environment` | 版本环境索引 |

#### 业务方法

- **配置验证**: `validateConfig()`, `testAlgorithm()`
- **配置切换**: `switchConfig()`, `rollbackConfig()`
- **性能监控**: `getPerformanceStats()`

### 3. decision_records - 决策记录表

**表名**: `decision_records`  
**模型**: `DecisionRecord`  
**主要功能**: 记录抽奖引擎的决策过程和理由

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 决策记录ID |
| `execution_id` | VARCHAR(50) | NOT NULL | - | 执行批次ID |
| `decision_point` | VARCHAR(100) | NOT NULL | - | 决策点 |
| `decision_type` | ENUM | NOT NULL | - | 决策类型：algorithm_choice/probability_calc/prize_selection/validation_check |
| `input_data` | JSON | NOT NULL | - | 输入数据 |
| `decision_logic` | JSON | NOT NULL | - | 决策逻辑 |
| `decision_result` | JSON | NOT NULL | - | 决策结果 |
| `confidence_score` | DECIMAL(5,3) | NOT NULL | 1.000 | 置信度分数（0-1） |
| `execution_time_ms` | INTEGER | NOT NULL | - | 决策耗时（毫秒） |
| `alternative_options` | JSON | NULL | - | 备选方案 |
| `decision_reason` | TEXT | NULL | - | 决策理由 |
| `metadata` | JSON | NULL | - | 决策元数据 |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `id` | 主键索引 |
| `idx_execution_point` | 普通 | `execution_id`, `decision_point` | 执行决策点索引 |
| `idx_decision_type` | 普通 | `decision_type` | 决策类型索引 |
| `idx_confidence` | 普通 | `confidence_score` | 置信度索引 |

#### 业务方法

- **决策分析**: `analyzeDecision()`, `getDecisionTree()`
- **性能评估**: `evaluatePerformance()`
- **决策回放**: `replayDecision()`

### 4. probability_logs - 概率日志表

**表名**: `probability_logs`  
**模型**: `ProbabilityLog`  
**主要功能**: 记录概率计算的详细过程和结果

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 概率日志ID |
| `execution_id` | VARCHAR(50) | NOT NULL | - | 执行批次ID |
| `calculation_step` | VARCHAR(100) | NOT NULL | - | 计算步骤 |
| `calculation_type` | ENUM | NOT NULL | - | 计算类型：base_probability/weighted_probability/adjusted_probability/final_probability |
| `input_probabilities` | JSON | NOT NULL | - | 输入概率数据 |
| `calculation_method` | VARCHAR(100) | NOT NULL | - | 计算方法 |
| `adjustment_factors` | JSON | NULL | - | 调整因子 |
| `calculation_result` | JSON | NOT NULL | - | 计算结果 |
| `probability_distribution` | JSON | NOT NULL | - | 概率分布 |
| `normalization_factor` | DECIMAL(10,6) | NULL | - | 归一化因子 |
| `validation_status` | ENUM | NOT NULL | 'valid' | 验证状态：valid/invalid/warning |
| `validation_errors` | JSON | NULL | - | 验证错误 |
| `calculation_time_ms` | INTEGER | NOT NULL | - | 计算耗时（毫秒） |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `id` | 主键索引 |
| `idx_execution_step` | 普通 | `execution_id`, `calculation_step` | 执行步骤索引 |
| `idx_calculation_type` | 普通 | `calculation_type` | 计算类型索引 |
| `idx_validation_status` | 普通 | `validation_status` | 验证状态索引 |

#### 业务方法

- **概率验证**: `validateProbabilities()`, `checkDistribution()`
- **分布分析**: `analyzeProbabilityDistribution()`
- **趋势监控**: `trackProbabilityTrends()`

### 5. system_metrics - 系统指标表

**表名**: `system_metrics`  
**模型**: `SystemMetrics`  
**主要功能**: 记录系统运行的关键性能指标

#### 字段结构

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|-------|---------|-----|-------|------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 指标记录ID |
| `metric_name` | VARCHAR(100) | NOT NULL | - | 指标名称 |
| `metric_category` | ENUM | NOT NULL | - | 指标分类：performance/business/system/security |
| `metric_type` | ENUM | NOT NULL | - | 指标类型：counter/gauge/histogram/timer |
| `metric_value` | DECIMAL(15,6) | NOT NULL | - | 指标值 |
| `metric_unit` | VARCHAR(20) | NOT NULL | - | 指标单位 |
| `aggregation_period` | ENUM | NOT NULL | 'realtime' | 聚合周期：realtime/minute/hour/day |
| `dimensions` | JSON | NULL | - | 指标维度 |
| `tags` | JSON | NULL | - | 指标标签 |
| `threshold_config` | JSON | NULL | - | 阈值配置 |
| `alert_level` | ENUM | NOT NULL | 'normal' | 告警级别：normal/warning/critical |
| `source_system` | VARCHAR(50) | NOT NULL | - | 来源系统 |
| `collection_time` | DATETIME | NOT NULL | - | 采集时间 |
| `created_at` | TIMESTAMP | NOT NULL | - | 创建时间 |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|-----|------|------|
| PRIMARY | 主键 | `id` | 主键索引 |
| `idx_metric_category` | 普通 | `metric_category`, `metric_name` | 分类名称索引 |
| `idx_collection_time` | 普通 | `collection_time` | 采集时间索引 |
| `idx_alert_level` | 普通 | `alert_level` | 告警级别索引 |
| `idx_source_period` | 普通 | `source_system`, `aggregation_period` | 来源周期索引 |

#### 业务方法

- **指标聚合**: `aggregateMetrics()`, `calculateTrends()`
- **告警检查**: `checkThresholds()`, `triggerAlerts()`
- **性能分析**: `analyzePerformance()`, `generateReports()`

#### 关联关系

- **关联**: `LotteryExecutionLog` (系统执行日志)
- **关联**: `DecisionRecord` (决策记录)

---

## 🔗 数据库关系总结

### 核心实体关系图

```
User (用户)
├── UserPointsAccount (一对一: 积分账户)
├── UserInventory (一对多: 用户库存)
├── LotteryRecord (一对多: 抽奖记录)
├── UserTask (一对多: 用户任务)
├── LoginLog (一对多: 登录日志)
└── CustomerSession (一对多: 客服会话)

LotteryCampaign (抽奖活动)
├── LotteryPrize (一对多: 活动奖品)
├── LotteryRecord (一对多: 抽奖记录)
└── LotteryExecutionLog (一对多: 执行日志)

AdminUser (管理员)
├── AdminStatus (一对一: 管理员状态)
├── CustomerSession (一对多: 处理的会话)
└── ChatMessage (一对多: 发送的消息)
```

### 业务流程关系

1. **用户注册流程**: `User` → `UserPointsAccount` → `UserSession`
2. **抽奖流程**: `LotteryCampaign` → `LotteryRecord` → `PrizeDistribution` → `UserInventory`
3. **积分流程**: `PointsTransaction` → `UserPointsAccount` → `User.history_total_points`
4. **客服流程**: `CustomerSession` → `ChatMessage` → `AdminUser`
5. **任务流程**: `TaskTemplate` → `UserTask` → `PointsTransaction`

### 索引优化策略

1. **时间范围查询**: 所有包含时间字段的表都建立时间索引
2. **用户关联查询**: 所有用户相关表建立 `user_id` 索引
3. **状态筛选查询**: 状态字段与其他常用字段的组合索引
4. **业务关联查询**: 外键字段的索引优化
5. **统计分析查询**: 支持报表和分析的组合索引

### 性能优化建议

1. **分表策略**: 日志类表考虑按月分表
2. **缓存策略**: 热点数据使用Redis缓存
3. **读写分离**: 读多写少的表使用读写分离
4. **归档策略**: 历史数据定期归档
5. **索引监控**: 定期分析慢查询和索引使用情况

---

## 📝 维护和扩展

### 数据库维护

1. **定期备份**: 每日全量备份，每小时增量备份
2. **性能监控**: 慢查询日志分析和索引优化
3. **空间管理**: 定期清理过期数据和无用索引
4. **版本控制**: 数据库结构变更通过Migration管理

### 扩展规划

1. **水平扩展**: 支持分库分表
2. **垂直扩展**: 硬件资源升级
3. **功能扩展**: 新业务模块的表设计
4. **性能扩展**: 查询优化和缓存策略

### 安全管理

1. **访问控制**: 数据库用户权限管理
2. **数据加密**: 敏感字段加密存储
3. **审计日志**: 重要操作审计跟踪
4. **备份安全**: 备份数据加密和异地存储

---

**文档完成时间**: 2025年09月19日 20:19:01 UTC  
**数据库设计版本**: v2.0  
**技术栈**: MySQL 8.0 + Sequelize ORM + Node.js 