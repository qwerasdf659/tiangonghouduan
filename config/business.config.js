/**
 * 餐厅积分抽奖系统 - 统一业务配置（代码层固定规则）
 *
 * @description 集中管理代码层固定的业务规则，配置即文档
 * @version 2.0.0
 * @created 2025-10-21
 * @updated 2025-12-30 配置管理三层分离方案实施
 *
 * 配置管理三层分离原则：
 * ┌─────────────────────────────────────────────────────────────────────┐
 * │ 层级            │ 存储位置           │ 特点                          │
 * ├─────────────────────────────────────────────────────────────────────┤
 * │ 环境变量层      │ .env               │ 密钥/连接信息/部署差异        │
 * │ 数据库配置层    │ system_settings    │ 运营可调参数（需启动预检）    │
 * │ 代码配置层      │ 本文件             │ 固定业务规则（改动需重新部署）│
 * └─────────────────────────────────────────────────────────────────────┘
 *
 * 本文件仅包含【代码层固定规则】，不包含运营可调参数。
 * 运营可调参数已迁移到 DB system_settings，由 AdminSystemService 读取。
 *
 * @see docs/配置管理三层分离与校验统一方案.md
 */

module.exports = {
  // ====================================
  // 🎰 抽奖系统配置（代码层固定规则）
  // ====================================
  lottery: {
    /**
     * 连抽折扣配置
     *
     * @description 定义不同抽奖类型的抽奖次数和折扣率
     * @业务规则
     * - 单抽/3连抽/5连抽：无折扣（discount=1.0）
     * - 10连抽：九折优惠（discount=0.9）
     *
     * @重要说明
     * - 单抽价格（lottery_cost_points）从 DB system_settings 读取
     * - 连抽总价 = 单抽价格 × count × discount
     * - 价格相关字段（total_cost/per_draw）由业务层动态计算
     *
     * @see AdminSystemService.getSettingValue('points', 'lottery_cost_points')
     */
    draw_types: {
      single: {
        count: 1, // 抽奖次数
        discount: 1.0, // 折扣率（1.0=无折扣）
        label: '单抽' // 前端显示名称
      },
      triple: {
        count: 3, // 抽奖次数
        discount: 1.0, // 无折扣
        label: '3连抽' // 前端显示名称
      },
      five: {
        count: 5, // 抽奖次数
        discount: 1.0, // 无折扣
        label: '5连抽' // 前端显示名称
      },
      ten: {
        count: 10, // 抽奖次数
        discount: 0.9, // 九折优惠
        label: '10连抽(九折)' // 前端显示名称
      }
    },

    /**
     * 每日重置时间（固定规则）
     *
     * @description 每日抽奖次数重置时间点
     * @业务规则 每日0点重置（北京时间 Asia/Shanghai）
     *
     * @重要说明
     * - 每日抽奖上限（daily_lottery_limit）从 DB system_settings 读取
     * - 本配置仅定义重置时间点，不定义上限数值
     *
     * @see AdminSystemService.getSettingValue('points', 'daily_lottery_limit')
     */
    daily_reset_time: '00:00:00', // 每日0点重置（北京时间）

    /**
     * 免费抽奖控制（固定规则）
     *
     * @description 是否允许免费抽奖（cost_per_draw=0）
     * @业务规则 禁止免费抽奖，所有抽奖必须消耗积分
     * @安全考量 防止刷奖行为，保护积分经济体系
     */
    free_draw_allowed: false // false=禁止免费抽奖
  },

  // ====================================
  // 💰 积分系统配置
  // ====================================
  points: {
    /**
     * 积分余额限制
     *
     * @description 用户可持有的积分上下限
     * @数据库支持 DECIMAL(10,2) 最大值：99,999,999.99
     * @业务规则
     * - 上限：99,999,999.99（数据库技术上限）
     * - 下限：0（不能为负数）
     */
    max_balance: 99999999.99, // 积分上限（约1亿积分）
    min_balance: 0, // 积分下限（不能为负）

    /**
     * 积分显示名称
     *
     * @description 前端统一显示名称
     * @业务规则 统一显示为"积分"，不可调整
     */
    display_name: '积分',

    /**
     * 积分操作验证规则
     *
     * @description 所有积分操作必须遵守的规则
     */
    validation: {
      allow_negative: false, // 禁止负数积分
      allow_zero_balance: true, // 允许余额为0
      enforce_transaction: true // 强制事务保护
    }
  },

  // ====================================
  // 👤 用户系统配置
  // ====================================
  user: {
    /**
     * 昵称长度限制
     *
     * @description 前后端统一验证规则
     * @业务规则 2-50个字符（中文、字母、数字、下划线）
     */
    nickname: {
      min_length: 2, // 最小2个字符
      max_length: 50, // 最大50个字符
      pattern: /^[\u4e00-\u9fa5a-zA-Z0-9_]+$/ // 允许的字符
    },

    /**
     * 验证码有效期
     *
     * @description 短信验证码/邮箱验证码有效期
     * @业务规则 前后端统一300秒（5分钟）
     */
    verification_code: {
      expiry_seconds: 300, // 300秒（5分钟）
      resend_interval: 60 // 60秒后才能重新发送
    }
  },

  // ====================================
  // 📤 文件上传配置
  // ====================================
  upload: {
    /**
     * 图片上传限制
     *
     * @description 拍照功能的文件类型和大小限制
     * @业务规则
     * - 普通用户和管理员权限相同
     * - 仅支持图片类型
     * - 单次上传1张
     */
    image: {
      max_size_mb: 10, // 最大10MB
      max_size_bytes: 10485760, // 10MB = 10 * 1024 * 1024
      max_count: 1, // 单次上传1张
      allowed_types: ['image/*'], // 允许所有图片格式
      allowed_extensions: ['.jpg', '.jpeg', '.png', '.gif', '.webp']
    }
  },

  // ====================================
  // 📄 分页配置
  // ====================================
  pagination: {
    /**
     * 普通用户分页配置
     *
     * @description 列表查询的默认和最大分页数
     * @业务规则 默认20条，最大50条
     */
    user: {
      default: 20, // 默认每页20条
      max: 50 // 最大每页50条
    },

    /**
     * 管理员分页配置
     *
     * @description 管理员可查看更多数据
     * @业务规则 默认20-50条可配置，最大100-200条
     */
    admin: {
      default: 50, // 默认每页50条
      max: 200 // 最大每页200条
    }
  },

  // ====================================
  // 💬 聊天系统配置
  // ====================================
  chat: {
    /**
     * 消息内容限制
     *
     * @description 聊天消息的长度限制
     * @业务规则
     * - 最小长度：1字符（不能为空）
     * - 最大长度：5000字符
     * - 空白字符：不允许
     */
    message: {
      min_length: 1, // 最小1字符
      max_length: 5000, // 最大5000字符
      allow_blank: false // 不允许空白字符
    },

    /**
     * 消息频率限制（防止消息轰炸）
     *
     * @description 限制用户/管理员的消息发送频率
     * @业务规则
     * - 普通用户：每分钟最多20条消息
     * - 管理员：每分钟最多30条消息
     * - 时间窗口：60秒滚动窗口
     * @实施方式 内存Map存储（滑动窗口算法）
     */
    rate_limit: {
      user: {
        max_messages_per_minute: 20, // 普通用户每分钟最多20条
        time_window_seconds: 60 // 时间窗口60秒
      },
      admin: {
        max_messages_per_minute: 30, // 管理员每分钟最多30条
        time_window_seconds: 60 // 时间窗口60秒
      }
    },

    /**
     * 创建会话频率限制（防止并发重复创建）
     *
     * @description 限制用户创建聊天会话的频率，防止并发创建导致重复会话
     * @业务规则
     * - 所有用户：每10秒最多创建3次会话
     * - 时间窗口：10秒滚动窗口
     * - 超过限制返回429错误
     * @实施方式 内存Map存储（滑动窗口算法）+ 悲观锁事务
     * @并发控制 采用方案C（悲观锁事务）替代方案A（部分唯一索引，MySQL版本不支持）
     */
    create_session_limit: {
      max_creates_per_window: 3, // 10秒内最多3次创建
      time_window_seconds: 10 // 时间窗口10秒
    },

    /**
     * 敏感词过滤配置
     *
     * @description 内容安全过滤规则
     * @业务规则
     * - 包含敏感词的消息将被拒绝发送
     * - 建议定期更新敏感词库
     * - 生产环境建议接入专业内容审核服务（如阿里云内容安全）
     * @维护建议
     * - 定期审查敏感词列表
     * - 根据实际业务调整敏感词
     * - 考虑接入第三方内容审核API
     */
    content_filter: {
      enabled: true, // 是否启用敏感词过滤
      sensitive_words: [
        // 示例敏感词（实际使用时应根据业务需求配置）
        '测试敏感词1',
        '测试敏感词2'
        // 生产环境建议从数据库或外部配置文件加载
        // 或接入专业的内容审核服务
      ],
      reject_on_match: true // true=拒绝发送，false=仅记录日志
    },

    /**
     * XSS防护配置
     *
     * @description HTML内容转义规则
     * @业务规则 所有用户输入的内容必须进行HTML转义
     * @安全级别 高（强制启用）
     */
    xss_protection: {
      enabled: true, // 强制启用XSS防护
      escape_html: true, // 转义HTML特殊字符
      allowed_tags: [] // 不允许任何HTML标签
    }
  }
}
